{"pr_number": 56841, "pr_title": "Create plugin for yamlTest task", "pr_createdAt": "2020-05-15T18:37:54Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/56841", "timeline": [{"oid": "6fb168df6bfb1f5892946d45f84bf3427a6cb391", "url": "https://github.com/elastic/elasticsearch/commit/6fb168df6bfb1f5892946d45f84bf3427a6cb391", "message": "introduce plugin", "committedDate": "2020-05-15T17:58:28Z", "type": "commit"}, {"oid": "87ae3626e09dee4d480dd7c2f579f85fdcb62f90", "url": "https://github.com/elastic/elasticsearch/commit/87ae3626e09dee4d480dd7c2f579f85fdcb62f90", "message": "clean up", "committedDate": "2020-05-15T18:26:01Z", "type": "commit"}, {"oid": "9baf83902291653bd8e3236cec33ec309a71e1a0", "url": "https://github.com/elastic/elasticsearch/commit/9baf83902291653bd8e3236cec33ec309a71e1a0", "message": "add another todo", "committedDate": "2020-05-15T18:32:21Z", "type": "commit"}, {"oid": "76cf101efa53bea1b161340e493df1a8663bf8d0", "url": "https://github.com/elastic/elasticsearch/commit/76cf101efa53bea1b161340e493df1a8663bf8d0", "message": "clean up comment", "committedDate": "2020-05-15T18:36:44Z", "type": "commit"}, {"oid": "7e92d812bf3d55e0159adfd7081c05d415c50139", "url": "https://github.com/elastic/elasticsearch/commit/7e92d812bf3d55e0159adfd7081c05d415c50139", "message": "fix runner setup", "committedDate": "2020-05-15T19:03:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg5OTUwOQ==", "url": "https://github.com/elastic/elasticsearch/pull/56841#discussion_r426899509", "bodyText": "FWIW, there's an open issue for this. Perhaps we can link it here.\n#47804", "author": "mark-vieira", "createdAt": "2020-05-18T21:20:37Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/RestIntegTestTask.java", "diffHunk": "@@ -36,6 +36,8 @@\n     private static final String TESTS_CLUSTER = \"tests.cluster\";\n     private static final String TESTS_CLUSTER_NAME = \"tests.clustername\";\n \n+    // TODO: refactor this so that work is not done in constructor and find usages and register them, not create them\n+    // See: https://docs.gradle.org/current/userguide/task_configuration_avoidance.html", "originalCommit": "7e92d812bf3d55e0159adfd7081c05d415c50139", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAwMzU0Mg==", "url": "https://github.com/elastic/elasticsearch/pull/56841#discussion_r437003542", "bodyText": "done.", "author": "jakelandis", "createdAt": "2020-06-08T21:11:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg5OTUwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "84939b2672c408b2f64ef39bb94456e8798ca967", "chunk": "diff --git a/buildSrc/src/main/java/org/elasticsearch/gradle/test/RestIntegTestTask.java b/buildSrc/src/main/java/org/elasticsearch/gradle/test/RestIntegTestTask.java\nindex b0f79053307..5bc252e5858 100644\n--- a/buildSrc/src/main/java/org/elasticsearch/gradle/test/RestIntegTestTask.java\n+++ b/buildSrc/src/main/java/org/elasticsearch/gradle/test/RestIntegTestTask.java\n\n@@ -38,6 +38,7 @@ public class RestIntegTestTask extends DefaultTask {\n \n     // TODO: refactor this so that work is not done in constructor and find usages and register them, not create them\n     // See: https://docs.gradle.org/current/userguide/task_configuration_avoidance.html\n+    // See: https://github.com/elastic/elasticsearch/issues/47804\n     public RestIntegTestTask() {\n         Project project = getProject();\n         String name = getName();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg5OTkzNw==", "url": "https://github.com/elastic/elasticsearch/pull/56841#discussion_r426899937", "bodyText": "We should use orElseThrow() here and supply an exception with an appropriate message.", "author": "mark-vieira", "createdAt": "2020-05-18T21:21:38Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/CopyRestApiTask.java", "diffHunk": "@@ -109,7 +111,8 @@ public FileTree getInputDir() {\n \n     @OutputDirectory\n     public File getOutputDir() {\n-        return new File(getTestSourceSet().getOutput().getResourcesDir(), REST_API_PREFIX);\n+        assert Util.getTestSourceSet(getProject()).isPresent();", "originalCommit": "7e92d812bf3d55e0159adfd7081c05d415c50139", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAwNjAxMg==", "url": "https://github.com/elastic/elasticsearch/pull/56841#discussion_r437006012", "bodyText": "I added a message to the assert\nEDIT: after testing .. the assert did not fire as expected, so removed it in favor of orElseThrow", "author": "jakelandis", "createdAt": "2020-06-08T21:16:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg5OTkzNw=="}], "type": "inlineReview", "revised_code": {"commit": "84939b2672c408b2f64ef39bb94456e8798ca967", "chunk": "diff --git a/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/CopyRestApiTask.java b/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/CopyRestApiTask.java\nindex 04ac8dd46e0..28388d010cc 100644\n--- a/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/CopyRestApiTask.java\n+++ b/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/CopyRestApiTask.java\n\n@@ -111,8 +119,8 @@ public class CopyRestApiTask extends DefaultTask {\n \n     @OutputDirectory\n     public File getOutputDir() {\n-        assert Util.getTestSourceSet(getProject()).isPresent();\n-        return new File(Util.getTestSourceSet(getProject()).get().getOutput().getResourcesDir(), REST_API_PREFIX);\n+        assert getSourceSetWithJavaTestFallback().isPresent() : \"could not find source set [\" + sourceSetName + \"]\";\n+        return new File(getSourceSetWithJavaTestFallback().get().getOutput().getResourcesDir(), REST_API_PREFIX);\n     }\n \n     @TaskAction\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwMTI2MQ==", "url": "https://github.com/elastic/elasticsearch/pull/56841#discussion_r426901261", "bodyText": "As mentioned in my comment, I don't think we need to support this case. We should require that all YAML tests live in the appropriate source set. This awkward conditional stuff is a great example of why.\nAlso, what happens if a project has both tests types? Which source set should this method return? As part of splitting these types of tests up there is no longer a canonical \"test source set\", as any given project might (and likely will) have several.", "author": "mark-vieira", "createdAt": "2020-05-18T21:24:38Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/util/Util.java", "diffHunk": "@@ -129,15 +129,39 @@ public static FileTree getJavaTestAndMainSourceResources(Project project, Action\n     }\n \n     /**\n+     * Returns the source set for either the YamlTests or the standard test source set. Preference goes to YamlTest source set if it exists.\n+     *\n      * @param project The project to look for test Java resources.\n      * @return An Optional that contains the Java test SourceSet if it exists.\n      */\n+    public static Optional<SourceSet> getTestSourceSet(Project project) {", "originalCommit": "7e92d812bf3d55e0159adfd7081c05d415c50139", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUyNDMyNw==", "url": "https://github.com/elastic/elasticsearch/pull/56841#discussion_r427524327", "bodyText": "Discussed in person. Since this is used primarily for copy around of REST resources, I will remove this method in favor of having the REST resources be explicit about which source set they will use dependent on the application (or not) of the new YAML test task.\nAlso, this PR updated to use this with test conventions task, but that isn't needed for custom test source sets.\nThere will still be a todo to circle back around and remove the conditional aspect of which test source set is used for copying around REST resources, but that can only be done after all existing usages of the java test source set have been addressed. This includes ensuring that the clients teams won't break on moving tests around, as well all internal usages where YAML tests can live in the java test source set. While plugin developers may be non-passively impacted by requiring the new YAML plugin, the migration path is pretty simple and would only impact those that leverage YAML testing (suspected to be very few).", "author": "jakelandis", "createdAt": "2020-05-19T18:48:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwMTI2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAwNzI2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/56841#discussion_r437007266", "bodyText": "done ... will add summary to main comment.", "author": "jakelandis", "createdAt": "2020-06-08T21:18:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwMTI2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "84939b2672c408b2f64ef39bb94456e8798ca967", "chunk": "diff --git a/buildSrc/src/main/java/org/elasticsearch/gradle/util/Util.java b/buildSrc/src/main/java/org/elasticsearch/gradle/util/Util.java\nindex f82df3631ce..94cbc6b53db 100644\n--- a/buildSrc/src/main/java/org/elasticsearch/gradle/util/Util.java\n+++ b/buildSrc/src/main/java/org/elasticsearch/gradle/util/Util.java\n\n@@ -129,39 +129,15 @@ public class Util {\n     }\n \n     /**\n-     * Returns the source set for either the YamlTests or the standard test source set. Preference goes to YamlTest source set if it exists.\n-     *\n      * @param project The project to look for test Java resources.\n      * @return An Optional that contains the Java test SourceSet if it exists.\n      */\n-    public static Optional<SourceSet> getTestSourceSet(Project project) {\n-        if (getYamlTestSourceSet(project).isPresent()) {\n-            return getYamlTestSourceSet(project);\n-        } else {\n-            return getJavaTestSourceSet(project);\n-        }\n-    }\n-\n-    /**\n-     * @param project The project to look for test Java sources.\n-     * @return An Optional that contains the Java test SourceSet if it exists.\n-     */\n     public static Optional<SourceSet> getJavaTestSourceSet(Project project) {\n         return project.getConvention().findPlugin(JavaPluginConvention.class) == null\n             ? Optional.empty()\n             : Optional.ofNullable(GradleUtils.getJavaSourceSets(project).findByName(SourceSet.TEST_SOURCE_SET_NAME));\n     }\n \n-    /**\n-     * @param project The project to look for yaml test sources.\n-     * @return An Optional that contains the yaml test SourceSet if it exists.\n-     */\n-    public static Optional<SourceSet> getYamlTestSourceSet(Project project) {\n-        return project.getConvention().findPlugin(JavaPluginConvention.class) == null\n-            ? Optional.empty()\n-            : Optional.ofNullable(GradleUtils.getJavaSourceSets(project).findByName(\"yamlTest\"));\n-    }\n-\n     /**\n      * @param project The project to look for main Java resources.\n      * @return An Optional that contains the Java main SourceSet if it exists.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwMjA0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/56841#discussion_r426902049", "bodyText": "We shouldn't have to do this. Let's just apply the correct plugin here, which is going to be the ElasticsearchJavaPlugin most likely. We don't want to have users have to worry about this.", "author": "mark-vieira", "createdAt": "2020-05-18T21:26:25Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlTestPlugin.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.test.rest;\n+\n+import org.elasticsearch.gradle.plugin.PluginPropertiesExtension;\n+import org.elasticsearch.gradle.test.RestIntegTestTask;\n+import org.elasticsearch.gradle.testclusters.RestTestRunnerTask;\n+import org.elasticsearch.gradle.testclusters.TestClustersPlugin;\n+import org.elasticsearch.gradle.util.GradleUtils;\n+import org.gradle.api.InvalidUserDataException;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.Task;\n+import org.gradle.api.plugins.JavaBasePlugin;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.SourceSetContainer;\n+import org.gradle.api.tasks.bundling.Zip;\n+\n+/**\n+ * Apply this plugin to run the YAML based REST tests. This will adda\n+ */\n+public class YamlTestPlugin implements Plugin<Project> {\n+\n+    public static final String SOURCE_SET_NAME = \"yamlTest\";\n+\n+    @Override\n+    public void apply(Project project) {\n+\n+        if (project.getPluginManager().hasPlugin(\"elasticsearch.build\") == false", "originalCommit": "7e92d812bf3d55e0159adfd7081c05d415c50139", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAwNjE1Mw==", "url": "https://github.com/elastic/elasticsearch/pull/56841#discussion_r437006153", "bodyText": "done", "author": "jakelandis", "createdAt": "2020-06-08T21:16:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwMjA0OQ=="}], "type": "inlineReview", "revised_code": {"commit": "84939b2672c408b2f64ef39bb94456e8798ca967", "chunk": "diff --git a/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlTestPlugin.java b/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestTestPlugin.java\nsimilarity index 69%\nrename from buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlTestPlugin.java\nrename to buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestTestPlugin.java\nindex bcbb22abfc8..ebb4248167f 100644\n--- a/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlTestPlugin.java\n+++ b/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestTestPlugin.java\n\n@@ -19,12 +19,14 @@\n \n package org.elasticsearch.gradle.test.rest;\n \n+import org.elasticsearch.gradle.ElasticsearchJavaPlugin;\n+import org.elasticsearch.gradle.VersionProperties;\n+import org.elasticsearch.gradle.info.BuildParams;\n import org.elasticsearch.gradle.plugin.PluginPropertiesExtension;\n import org.elasticsearch.gradle.test.RestIntegTestTask;\n import org.elasticsearch.gradle.testclusters.RestTestRunnerTask;\n import org.elasticsearch.gradle.testclusters.TestClustersPlugin;\n import org.elasticsearch.gradle.util.GradleUtils;\n-import org.gradle.api.InvalidUserDataException;\n import org.gradle.api.Plugin;\n import org.gradle.api.Project;\n import org.gradle.api.Task;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwNDQxMQ==", "url": "https://github.com/elastic/elasticsearch/pull/56841#discussion_r426904411", "bodyText": "For now we need to check if BuildParams.isInternal here and use an artifact dependency if not.", "author": "mark-vieira", "createdAt": "2020-05-18T21:31:47Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlTestPlugin.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.test.rest;\n+\n+import org.elasticsearch.gradle.plugin.PluginPropertiesExtension;\n+import org.elasticsearch.gradle.test.RestIntegTestTask;\n+import org.elasticsearch.gradle.testclusters.RestTestRunnerTask;\n+import org.elasticsearch.gradle.testclusters.TestClustersPlugin;\n+import org.elasticsearch.gradle.util.GradleUtils;\n+import org.gradle.api.InvalidUserDataException;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.Task;\n+import org.gradle.api.plugins.JavaBasePlugin;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.SourceSetContainer;\n+import org.gradle.api.tasks.bundling.Zip;\n+\n+/**\n+ * Apply this plugin to run the YAML based REST tests. This will adda\n+ */\n+public class YamlTestPlugin implements Plugin<Project> {\n+\n+    public static final String SOURCE_SET_NAME = \"yamlTest\";\n+\n+    @Override\n+    public void apply(Project project) {\n+\n+        if (project.getPluginManager().hasPlugin(\"elasticsearch.build\") == false\n+            && project.getPluginManager().hasPlugin(\"elasticsearch.standalone-rest-test\") == false) {\n+            throw new InvalidUserDataException(\n+                \"elasticsearch.build or elasticsearch.standalone-rest-test plugin \" + \"must be applied before the YAML test plugin\"\n+            );\n+        }\n+\n+        // to spin up the external cluster\n+        project.getPluginManager().apply(TestClustersPlugin.class);\n+        // to copy around the yaml tests and json spec\n+        project.getPluginManager().apply(RestResourcesPlugin.class);\n+\n+        // note - source sets are not created via org.elasticsearch.gradle.util.GradleUtils.addTestSourceSet since unlike normal tests\n+        // we only want the yamlTestSourceSet on the classpath by default. The yaml tests should be pure black box testing over HTTP and\n+        // such it should not need the main class on the class path. Also, there are some special setup steps unique to YAML tests.\n+\n+        // create source set\n+        SourceSetContainer sourceSets = project.getExtensions().getByType(SourceSetContainer.class);\n+        SourceSet yamlTestSourceSet = sourceSets.create(SOURCE_SET_NAME);\n+\n+        // create task - note can not use .register due to the work in RestIntegTestTask's constructor :(\n+        RestIntegTestTask yamlTestTask = project.getTasks()\n+            .create(\n+                SOURCE_SET_NAME,\n+                RestIntegTestTask.class,\n+                task -> { task.dependsOn(project.getTasks().getByName(\"copyRestApiSpecsTask\")); }\n+            );\n+        yamlTestTask.setGroup(JavaBasePlugin.VERIFICATION_GROUP);\n+        yamlTestTask.setDescription(\"Runs the YAML based REST tests against an external cluster\");\n+\n+        // setup task dependency\n+        project.getDependencies().add(SOURCE_SET_NAME + \"Compile\", project.project(\":test:framework\"));", "originalCommit": "7e92d812bf3d55e0159adfd7081c05d415c50139", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAwNjI3NA==", "url": "https://github.com/elastic/elasticsearch/pull/56841#discussion_r437006274", "bodyText": "done", "author": "jakelandis", "createdAt": "2020-06-08T21:16:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwNDQxMQ=="}], "type": "inlineReview", "revised_code": {"commit": "84939b2672c408b2f64ef39bb94456e8798ca967", "chunk": "diff --git a/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlTestPlugin.java b/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestTestPlugin.java\nsimilarity index 69%\nrename from buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlTestPlugin.java\nrename to buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestTestPlugin.java\nindex bcbb22abfc8..ebb4248167f 100644\n--- a/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlTestPlugin.java\n+++ b/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestTestPlugin.java\n\n@@ -19,12 +19,14 @@\n \n package org.elasticsearch.gradle.test.rest;\n \n+import org.elasticsearch.gradle.ElasticsearchJavaPlugin;\n+import org.elasticsearch.gradle.VersionProperties;\n+import org.elasticsearch.gradle.info.BuildParams;\n import org.elasticsearch.gradle.plugin.PluginPropertiesExtension;\n import org.elasticsearch.gradle.test.RestIntegTestTask;\n import org.elasticsearch.gradle.testclusters.RestTestRunnerTask;\n import org.elasticsearch.gradle.testclusters.TestClustersPlugin;\n import org.elasticsearch.gradle.util.GradleUtils;\n-import org.gradle.api.InvalidUserDataException;\n import org.gradle.api.Plugin;\n import org.gradle.api.Project;\n import org.gradle.api.Task;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwNDczNg==", "url": "https://github.com/elastic/elasticsearch/pull/56841#discussion_r426904736", "bodyText": "Shouldn't the PluginBuildPlugin be doing this?", "author": "mark-vieira", "createdAt": "2020-05-18T21:32:32Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlTestPlugin.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.test.rest;\n+\n+import org.elasticsearch.gradle.plugin.PluginPropertiesExtension;\n+import org.elasticsearch.gradle.test.RestIntegTestTask;\n+import org.elasticsearch.gradle.testclusters.RestTestRunnerTask;\n+import org.elasticsearch.gradle.testclusters.TestClustersPlugin;\n+import org.elasticsearch.gradle.util.GradleUtils;\n+import org.gradle.api.InvalidUserDataException;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.Task;\n+import org.gradle.api.plugins.JavaBasePlugin;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.SourceSetContainer;\n+import org.gradle.api.tasks.bundling.Zip;\n+\n+/**\n+ * Apply this plugin to run the YAML based REST tests. This will adda\n+ */\n+public class YamlTestPlugin implements Plugin<Project> {\n+\n+    public static final String SOURCE_SET_NAME = \"yamlTest\";\n+\n+    @Override\n+    public void apply(Project project) {\n+\n+        if (project.getPluginManager().hasPlugin(\"elasticsearch.build\") == false\n+            && project.getPluginManager().hasPlugin(\"elasticsearch.standalone-rest-test\") == false) {\n+            throw new InvalidUserDataException(\n+                \"elasticsearch.build or elasticsearch.standalone-rest-test plugin \" + \"must be applied before the YAML test plugin\"\n+            );\n+        }\n+\n+        // to spin up the external cluster\n+        project.getPluginManager().apply(TestClustersPlugin.class);\n+        // to copy around the yaml tests and json spec\n+        project.getPluginManager().apply(RestResourcesPlugin.class);\n+\n+        // note - source sets are not created via org.elasticsearch.gradle.util.GradleUtils.addTestSourceSet since unlike normal tests\n+        // we only want the yamlTestSourceSet on the classpath by default. The yaml tests should be pure black box testing over HTTP and\n+        // such it should not need the main class on the class path. Also, there are some special setup steps unique to YAML tests.\n+\n+        // create source set\n+        SourceSetContainer sourceSets = project.getExtensions().getByType(SourceSetContainer.class);\n+        SourceSet yamlTestSourceSet = sourceSets.create(SOURCE_SET_NAME);\n+\n+        // create task - note can not use .register due to the work in RestIntegTestTask's constructor :(\n+        RestIntegTestTask yamlTestTask = project.getTasks()\n+            .create(\n+                SOURCE_SET_NAME,\n+                RestIntegTestTask.class,\n+                task -> { task.dependsOn(project.getTasks().getByName(\"copyRestApiSpecsTask\")); }\n+            );\n+        yamlTestTask.setGroup(JavaBasePlugin.VERIFICATION_GROUP);\n+        yamlTestTask.setDescription(\"Runs the YAML based REST tests against an external cluster\");\n+\n+        // setup task dependency\n+        project.getDependencies().add(SOURCE_SET_NAME + \"Compile\", project.project(\":test:framework\"));\n+\n+        // setup the runner\n+        RestTestRunnerTask runner = (RestTestRunnerTask) project.getTasks().getByName(yamlTestTask.getName() + \"Runner\");\n+        runner.setTestClassesDirs(yamlTestSourceSet.getOutput().getClassesDirs());\n+        runner.setClasspath(yamlTestSourceSet.getRuntimeClasspath());\n+\n+        // if this a module or plugin, it may have an associated zip file with it's contents, add that to the test cluster", "originalCommit": "7e92d812bf3d55e0159adfd7081c05d415c50139", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ0OTM1Nw==", "url": "https://github.com/elastic/elasticsearch/pull/56841#discussion_r427449357", "bodyText": "I'm not sure I follow ?\nThis section of code is the magic that adds only the required modules/plugins to the test clusters for the OSS YAML tests. This is mostly a copy for how it currently works.", "author": "jakelandis", "createdAt": "2020-05-19T16:47:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwNDczNg=="}], "type": "inlineReview", "revised_code": {"commit": "84939b2672c408b2f64ef39bb94456e8798ca967", "chunk": "diff --git a/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlTestPlugin.java b/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestTestPlugin.java\nsimilarity index 69%\nrename from buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlTestPlugin.java\nrename to buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestTestPlugin.java\nindex bcbb22abfc8..ebb4248167f 100644\n--- a/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlTestPlugin.java\n+++ b/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestTestPlugin.java\n\n@@ -19,12 +19,14 @@\n \n package org.elasticsearch.gradle.test.rest;\n \n+import org.elasticsearch.gradle.ElasticsearchJavaPlugin;\n+import org.elasticsearch.gradle.VersionProperties;\n+import org.elasticsearch.gradle.info.BuildParams;\n import org.elasticsearch.gradle.plugin.PluginPropertiesExtension;\n import org.elasticsearch.gradle.test.RestIntegTestTask;\n import org.elasticsearch.gradle.testclusters.RestTestRunnerTask;\n import org.elasticsearch.gradle.testclusters.TestClustersPlugin;\n import org.elasticsearch.gradle.util.GradleUtils;\n-import org.gradle.api.InvalidUserDataException;\n import org.gradle.api.Plugin;\n import org.gradle.api.Project;\n import org.gradle.api.Task;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwNTU2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/56841#discussion_r426905566", "bodyText": "Let's remove this. I don't think it should go here, plus using findByName is going to eagerly realize the task.", "author": "mark-vieira", "createdAt": "2020-05-18T21:34:27Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlTestPlugin.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.test.rest;\n+\n+import org.elasticsearch.gradle.plugin.PluginPropertiesExtension;\n+import org.elasticsearch.gradle.test.RestIntegTestTask;\n+import org.elasticsearch.gradle.testclusters.RestTestRunnerTask;\n+import org.elasticsearch.gradle.testclusters.TestClustersPlugin;\n+import org.elasticsearch.gradle.util.GradleUtils;\n+import org.gradle.api.InvalidUserDataException;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.Task;\n+import org.gradle.api.plugins.JavaBasePlugin;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.SourceSetContainer;\n+import org.gradle.api.tasks.bundling.Zip;\n+\n+/**\n+ * Apply this plugin to run the YAML based REST tests. This will adda\n+ */\n+public class YamlTestPlugin implements Plugin<Project> {\n+\n+    public static final String SOURCE_SET_NAME = \"yamlTest\";\n+\n+    @Override\n+    public void apply(Project project) {\n+\n+        if (project.getPluginManager().hasPlugin(\"elasticsearch.build\") == false\n+            && project.getPluginManager().hasPlugin(\"elasticsearch.standalone-rest-test\") == false) {\n+            throw new InvalidUserDataException(\n+                \"elasticsearch.build or elasticsearch.standalone-rest-test plugin \" + \"must be applied before the YAML test plugin\"\n+            );\n+        }\n+\n+        // to spin up the external cluster\n+        project.getPluginManager().apply(TestClustersPlugin.class);\n+        // to copy around the yaml tests and json spec\n+        project.getPluginManager().apply(RestResourcesPlugin.class);\n+\n+        // note - source sets are not created via org.elasticsearch.gradle.util.GradleUtils.addTestSourceSet since unlike normal tests\n+        // we only want the yamlTestSourceSet on the classpath by default. The yaml tests should be pure black box testing over HTTP and\n+        // such it should not need the main class on the class path. Also, there are some special setup steps unique to YAML tests.\n+\n+        // create source set\n+        SourceSetContainer sourceSets = project.getExtensions().getByType(SourceSetContainer.class);\n+        SourceSet yamlTestSourceSet = sourceSets.create(SOURCE_SET_NAME);\n+\n+        // create task - note can not use .register due to the work in RestIntegTestTask's constructor :(\n+        RestIntegTestTask yamlTestTask = project.getTasks()\n+            .create(\n+                SOURCE_SET_NAME,\n+                RestIntegTestTask.class,\n+                task -> { task.dependsOn(project.getTasks().getByName(\"copyRestApiSpecsTask\")); }\n+            );\n+        yamlTestTask.setGroup(JavaBasePlugin.VERIFICATION_GROUP);\n+        yamlTestTask.setDescription(\"Runs the YAML based REST tests against an external cluster\");\n+\n+        // setup task dependency\n+        project.getDependencies().add(SOURCE_SET_NAME + \"Compile\", project.project(\":test:framework\"));\n+\n+        // setup the runner\n+        RestTestRunnerTask runner = (RestTestRunnerTask) project.getTasks().getByName(yamlTestTask.getName() + \"Runner\");\n+        runner.setTestClassesDirs(yamlTestSourceSet.getOutput().getClassesDirs());\n+        runner.setClasspath(yamlTestSourceSet.getRuntimeClasspath());\n+\n+        // if this a module or plugin, it may have an associated zip file with it's contents, add that to the test cluster\n+        boolean isModule = project.getPath().startsWith(\":modules:\");\n+        Zip bundle = (Zip) project.getTasks().findByName(\"bundlePlugin\");\n+        if (bundle != null) {\n+            yamlTestTask.dependsOn(bundle);\n+            if (isModule) {\n+                runner.getClusters().forEach(c -> c.module(bundle.getArchiveFile()));\n+            } else {\n+                runner.getClusters().forEach(c -> c.plugin(project.getObjects().fileProperty().value(bundle.getArchiveFile())));\n+            }\n+        }\n+\n+        // es-plugins may declare dependencies on additional modules, add those to the test cluster too.\n+        project.afterEvaluate(p -> {\n+            PluginPropertiesExtension pluginPropertiesExtension = project.getExtensions().findByType(PluginPropertiesExtension.class);\n+            if (pluginPropertiesExtension != null) { // not all projects are defined as plugins\n+                pluginPropertiesExtension.getExtendedPlugins().forEach(pluginName -> {\n+                    Project extensionProject = project.getProject().findProject(\":modules:\" + pluginName);\n+                    if (extensionProject != null) { // extension plugin may be defined, but not required to be a module\n+                        Zip extensionBundle = (Zip) extensionProject.getTasks().getByName(\"bundlePlugin\");\n+                        yamlTestTask.dependsOn(extensionBundle);\n+                        runner.getClusters().forEach(c -> c.module(extensionBundle.getArchiveFile()));\n+                    }\n+                });\n+            }\n+        });\n+\n+        // setup IDE\n+        GradleUtils.setupIdeForTestSourceSet(project, yamlTestSourceSet);\n+\n+        // run test tasks first if they exist since they are presumably faster and less resources intensive\n+        Task testTask = project.getTasks().findByName(\"test\");", "originalCommit": "7e92d812bf3d55e0159adfd7081c05d415c50139", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAwNjY4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/56841#discussion_r437006685", "bodyText": "updated it to be inline with #57016", "author": "jakelandis", "createdAt": "2020-06-08T21:17:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwNTU2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "84939b2672c408b2f64ef39bb94456e8798ca967", "chunk": "diff --git a/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlTestPlugin.java b/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestTestPlugin.java\nsimilarity index 69%\nrename from buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlTestPlugin.java\nrename to buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestTestPlugin.java\nindex bcbb22abfc8..ebb4248167f 100644\n--- a/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlTestPlugin.java\n+++ b/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestTestPlugin.java\n\n@@ -19,12 +19,14 @@\n \n package org.elasticsearch.gradle.test.rest;\n \n+import org.elasticsearch.gradle.ElasticsearchJavaPlugin;\n+import org.elasticsearch.gradle.VersionProperties;\n+import org.elasticsearch.gradle.info.BuildParams;\n import org.elasticsearch.gradle.plugin.PluginPropertiesExtension;\n import org.elasticsearch.gradle.test.RestIntegTestTask;\n import org.elasticsearch.gradle.testclusters.RestTestRunnerTask;\n import org.elasticsearch.gradle.testclusters.TestClustersPlugin;\n import org.elasticsearch.gradle.util.GradleUtils;\n-import org.gradle.api.InvalidUserDataException;\n import org.gradle.api.Plugin;\n import org.gradle.api.Project;\n import org.gradle.api.Task;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwNTgxMQ==", "url": "https://github.com/elastic/elasticsearch/pull/56841#discussion_r426905811", "bodyText": "What's creating the precommit task in this scenario? Is it some other plugin we're applying?", "author": "mark-vieira", "createdAt": "2020-05-18T21:35:03Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlTestPlugin.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.test.rest;\n+\n+import org.elasticsearch.gradle.plugin.PluginPropertiesExtension;\n+import org.elasticsearch.gradle.test.RestIntegTestTask;\n+import org.elasticsearch.gradle.testclusters.RestTestRunnerTask;\n+import org.elasticsearch.gradle.testclusters.TestClustersPlugin;\n+import org.elasticsearch.gradle.util.GradleUtils;\n+import org.gradle.api.InvalidUserDataException;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.Task;\n+import org.gradle.api.plugins.JavaBasePlugin;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.SourceSetContainer;\n+import org.gradle.api.tasks.bundling.Zip;\n+\n+/**\n+ * Apply this plugin to run the YAML based REST tests. This will adda\n+ */\n+public class YamlTestPlugin implements Plugin<Project> {\n+\n+    public static final String SOURCE_SET_NAME = \"yamlTest\";\n+\n+    @Override\n+    public void apply(Project project) {\n+\n+        if (project.getPluginManager().hasPlugin(\"elasticsearch.build\") == false\n+            && project.getPluginManager().hasPlugin(\"elasticsearch.standalone-rest-test\") == false) {\n+            throw new InvalidUserDataException(\n+                \"elasticsearch.build or elasticsearch.standalone-rest-test plugin \" + \"must be applied before the YAML test plugin\"\n+            );\n+        }\n+\n+        // to spin up the external cluster\n+        project.getPluginManager().apply(TestClustersPlugin.class);\n+        // to copy around the yaml tests and json spec\n+        project.getPluginManager().apply(RestResourcesPlugin.class);\n+\n+        // note - source sets are not created via org.elasticsearch.gradle.util.GradleUtils.addTestSourceSet since unlike normal tests\n+        // we only want the yamlTestSourceSet on the classpath by default. The yaml tests should be pure black box testing over HTTP and\n+        // such it should not need the main class on the class path. Also, there are some special setup steps unique to YAML tests.\n+\n+        // create source set\n+        SourceSetContainer sourceSets = project.getExtensions().getByType(SourceSetContainer.class);\n+        SourceSet yamlTestSourceSet = sourceSets.create(SOURCE_SET_NAME);\n+\n+        // create task - note can not use .register due to the work in RestIntegTestTask's constructor :(\n+        RestIntegTestTask yamlTestTask = project.getTasks()\n+            .create(\n+                SOURCE_SET_NAME,\n+                RestIntegTestTask.class,\n+                task -> { task.dependsOn(project.getTasks().getByName(\"copyRestApiSpecsTask\")); }\n+            );\n+        yamlTestTask.setGroup(JavaBasePlugin.VERIFICATION_GROUP);\n+        yamlTestTask.setDescription(\"Runs the YAML based REST tests against an external cluster\");\n+\n+        // setup task dependency\n+        project.getDependencies().add(SOURCE_SET_NAME + \"Compile\", project.project(\":test:framework\"));\n+\n+        // setup the runner\n+        RestTestRunnerTask runner = (RestTestRunnerTask) project.getTasks().getByName(yamlTestTask.getName() + \"Runner\");\n+        runner.setTestClassesDirs(yamlTestSourceSet.getOutput().getClassesDirs());\n+        runner.setClasspath(yamlTestSourceSet.getRuntimeClasspath());\n+\n+        // if this a module or plugin, it may have an associated zip file with it's contents, add that to the test cluster\n+        boolean isModule = project.getPath().startsWith(\":modules:\");\n+        Zip bundle = (Zip) project.getTasks().findByName(\"bundlePlugin\");\n+        if (bundle != null) {\n+            yamlTestTask.dependsOn(bundle);\n+            if (isModule) {\n+                runner.getClusters().forEach(c -> c.module(bundle.getArchiveFile()));\n+            } else {\n+                runner.getClusters().forEach(c -> c.plugin(project.getObjects().fileProperty().value(bundle.getArchiveFile())));\n+            }\n+        }\n+\n+        // es-plugins may declare dependencies on additional modules, add those to the test cluster too.\n+        project.afterEvaluate(p -> {\n+            PluginPropertiesExtension pluginPropertiesExtension = project.getExtensions().findByType(PluginPropertiesExtension.class);\n+            if (pluginPropertiesExtension != null) { // not all projects are defined as plugins\n+                pluginPropertiesExtension.getExtendedPlugins().forEach(pluginName -> {\n+                    Project extensionProject = project.getProject().findProject(\":modules:\" + pluginName);\n+                    if (extensionProject != null) { // extension plugin may be defined, but not required to be a module\n+                        Zip extensionBundle = (Zip) extensionProject.getTasks().getByName(\"bundlePlugin\");\n+                        yamlTestTask.dependsOn(extensionBundle);\n+                        runner.getClusters().forEach(c -> c.module(extensionBundle.getArchiveFile()));\n+                    }\n+                });\n+            }\n+        });\n+\n+        // setup IDE\n+        GradleUtils.setupIdeForTestSourceSet(project, yamlTestSourceSet);\n+\n+        // run test tasks first if they exist since they are presumably faster and less resources intensive\n+        Task testTask = project.getTasks().findByName(\"test\");\n+        if (testTask != null) {\n+            yamlTestTask.mustRunAfter(testTask);\n+        }\n+\n+        // validation of the rest specification is wired to precommit, so ensure that runs first\n+        yamlTestTask.mustRunAfter(project.getTasks().getByName(\"precommit\"));", "originalCommit": "7e92d812bf3d55e0159adfd7081c05d415c50139", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkyNjU3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/56841#discussion_r426926571", "bodyText": "Note #56926 will make this easier, you shouldn't have to worry about it. Currently that we already have:\nproject.getTasks().named(JavaPlugin.TEST_TASK_NAME).configure(t -> t.mustRunAfter(precommit));\n\nBut we can change that to all Test tasks.", "author": "rjernst", "createdAt": "2020-05-18T22:28:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwNTgxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAwNzA1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/56841#discussion_r437007055", "bodyText": "I removed this line since #56926 addressed all Test tasks", "author": "jakelandis", "createdAt": "2020-06-08T21:18:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwNTgxMQ=="}], "type": "inlineReview", "revised_code": {"commit": "84939b2672c408b2f64ef39bb94456e8798ca967", "chunk": "diff --git a/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlTestPlugin.java b/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestTestPlugin.java\nsimilarity index 69%\nrename from buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlTestPlugin.java\nrename to buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestTestPlugin.java\nindex bcbb22abfc8..ebb4248167f 100644\n--- a/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlTestPlugin.java\n+++ b/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestTestPlugin.java\n\n@@ -19,12 +19,14 @@\n \n package org.elasticsearch.gradle.test.rest;\n \n+import org.elasticsearch.gradle.ElasticsearchJavaPlugin;\n+import org.elasticsearch.gradle.VersionProperties;\n+import org.elasticsearch.gradle.info.BuildParams;\n import org.elasticsearch.gradle.plugin.PluginPropertiesExtension;\n import org.elasticsearch.gradle.test.RestIntegTestTask;\n import org.elasticsearch.gradle.testclusters.RestTestRunnerTask;\n import org.elasticsearch.gradle.testclusters.TestClustersPlugin;\n import org.elasticsearch.gradle.util.GradleUtils;\n-import org.gradle.api.InvalidUserDataException;\n import org.gradle.api.Plugin;\n import org.gradle.api.Project;\n import org.gradle.api.Task;\n"}}, {"oid": "d6ef96f8e18d723852d0bb3cf660254e03959fef", "url": "https://github.com/elastic/elasticsearch/commit/d6ef96f8e18d723852d0bb3cf660254e03959fef", "message": "Merge remote-tracking branch 'upstream/master' into yamlTest_part1", "committedDate": "2020-06-08T17:38:25Z", "type": "commit"}, {"oid": "84939b2672c408b2f64ef39bb94456e8798ca967", "url": "https://github.com/elastic/elasticsearch/commit/84939b2672c408b2f64ef39bb94456e8798ca967", "message": "review changes and move core tests", "committedDate": "2020-06-08T19:38:11Z", "type": "commit"}, {"oid": "b815cce6ebafe8773685694f708ea8cab342e08d", "url": "https://github.com/elastic/elasticsearch/commit/b815cce6ebafe8773685694f708ea8cab342e08d", "message": "checkstlyle and spotless", "committedDate": "2020-06-08T19:44:39Z", "type": "commit"}, {"oid": "d3a71bc27fd0e07f4d6b095465d84bedb9f95375", "url": "https://github.com/elastic/elasticsearch/commit/d3a71bc27fd0e07f4d6b095465d84bedb9f95375", "message": "minor text changes", "committedDate": "2020-06-08T21:15:12Z", "type": "commit"}, {"oid": "7fc8f3ec4c3b18286f4c2cf4bfa57c25cda112b8", "url": "https://github.com/elastic/elasticsearch/commit/7fc8f3ec4c3b18286f4c2cf4bfa57c25cda112b8", "message": "remove temp code infavor explicit config", "committedDate": "2020-06-08T21:58:59Z", "type": "commit"}, {"oid": "3ccd5d836e1cb8665676b36f56d51bbc8b7f1337", "url": "https://github.com/elastic/elasticsearch/commit/3ccd5d836e1cb8665676b36f56d51bbc8b7f1337", "message": "remove rest-resources from build plugin", "committedDate": "2020-06-08T22:56:45Z", "type": "commit"}, {"oid": "35f37365198e7922d45da8c103f19c9547586b92", "url": "https://github.com/elastic/elasticsearch/commit/35f37365198e7922d45da8c103f19c9547586b92", "message": "update the example projects", "committedDate": "2020-06-08T23:26:23Z", "type": "commit"}, {"oid": "282c160455db466f000c1ff6873836f2b0b41113", "url": "https://github.com/elastic/elasticsearch/commit/282c160455db466f000c1ff6873836f2b0b41113", "message": "more missed locations", "committedDate": "2020-06-08T23:43:03Z", "type": "commit"}, {"oid": "a97896f6a33fcfdeff11f0cb71b346f4fee1c17e", "url": "https://github.com/elastic/elasticsearch/commit/a97896f6a33fcfdeff11f0cb71b346f4fee1c17e", "message": "fix docker tests", "committedDate": "2020-06-09T00:09:31Z", "type": "commit"}, {"oid": "a43d3e753e31c2019c5e9f0621526375f58400ba", "url": "https://github.com/elastic/elasticsearch/commit/a43d3e753e31c2019c5e9f0621526375f58400ba", "message": "fix s3 tests", "committedDate": "2020-06-09T13:27:47Z", "type": "commit"}, {"oid": "4b11a424ccdaf0b2140702dc36598d193ba7310e", "url": "https://github.com/elastic/elasticsearch/commit/4b11a424ccdaf0b2140702dc36598d193ba7310e", "message": "fix some x-pack tests", "committedDate": "2020-06-09T15:02:53Z", "type": "commit"}, {"oid": "c7b21891409963ad32e81698b6004ad2aef6e6f7", "url": "https://github.com/elastic/elasticsearch/commit/c7b21891409963ad32e81698b6004ad2aef6e6f7", "message": "Merge branch 'master' into yamlTest_part1", "committedDate": "2020-06-23T16:34:08Z", "type": "commit"}, {"oid": "53ae3934de8355acd70ad66a53636ca6188849cb", "url": "https://github.com/elastic/elasticsearch/commit/53ae3934de8355acd70ad66a53636ca6188849cb", "message": "Merge branch 'master' into yamlTest_part1", "committedDate": "2020-06-23T21:29:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg5MTU4OA==", "url": "https://github.com/elastic/elasticsearch/pull/56841#discussion_r447891588", "bodyText": "Do we have to define this here and in each of the task implementations? Can we have this default just defined on place?", "author": "mark-vieira", "createdAt": "2020-06-30T18:24:14Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/RestResourcesExtension.java", "diffHunk": "@@ -32,6 +32,7 @@\n \n     final RestResourcesSpec restApi;\n     final RestResourcesSpec restTests;\n+    private String sourceSetName = \"yamlRestTest\";", "originalCommit": "53ae3934de8355acd70ad66a53636ca6188849cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA1Mzk0MA==", "url": "https://github.com/elastic/elasticsearch/pull/56841#discussion_r448053940", "bodyText": "I ended up removing this entirely from the rest resource extension. The which source set to use is now decided by if the YamlRestTestPlugin has been applied. 6289b00 (#56841)", "author": "jakelandis", "createdAt": "2020-07-01T00:40:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg5MTU4OA=="}], "type": "inlineReview", "revised_code": {"commit": "6289b00b7fb71856968e2a6fa543202f4aa8cf7d", "chunk": "diff --git a/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/RestResourcesExtension.java b/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/RestResourcesExtension.java\nindex 9f06f1c1da7..2865963bdb3 100644\n--- a/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/RestResourcesExtension.java\n+++ b/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/RestResourcesExtension.java\n\n@@ -32,7 +32,6 @@ public class RestResourcesExtension {\n \n     final RestResourcesSpec restApi;\n     final RestResourcesSpec restTests;\n-    private String sourceSetName = \"yamlRestTest\";\n \n     @Inject\n     public RestResourcesExtension(ObjectFactory objects) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg5NDY0OA==", "url": "https://github.com/elastic/elasticsearch/pull/56841#discussion_r447894648", "bodyText": "The compile configuration is deprecated, please use \"implementation\" instead. Also, no need to construct the configuration name, you can request it via SourceSet.getImplementationConfigurationName().", "author": "mark-vieira", "createdAt": "2020-06-30T18:29:13Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestTestPlugin.java", "diffHunk": "@@ -0,0 +1,122 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.test.rest;\n+\n+import org.elasticsearch.gradle.ElasticsearchJavaPlugin;\n+import org.elasticsearch.gradle.VersionProperties;\n+import org.elasticsearch.gradle.info.BuildParams;\n+import org.elasticsearch.gradle.plugin.PluginPropertiesExtension;\n+import org.elasticsearch.gradle.test.RestIntegTestTask;\n+import org.elasticsearch.gradle.testclusters.RestTestRunnerTask;\n+import org.elasticsearch.gradle.testclusters.TestClustersPlugin;\n+import org.elasticsearch.gradle.util.GradleUtils;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.plugins.JavaBasePlugin;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.SourceSetContainer;\n+import org.gradle.api.tasks.bundling.Zip;\n+\n+/**\n+ * Apply this plugin to run the YAML based REST tests.\n+ */\n+public class YamlRestTestPlugin implements Plugin<Project> {\n+\n+    public static final String SOURCE_SET_NAME = \"yamlRestTest\";\n+\n+    @Override\n+    public void apply(Project project) {\n+\n+        // yaml Rest tests require a Java test runner\n+        project.getPluginManager().apply(ElasticsearchJavaPlugin.class);\n+        // to spin up the external cluster\n+        project.getPluginManager().apply(TestClustersPlugin.class);\n+        // to copy around the yaml tests and json spec\n+        project.getPluginManager().apply(RestResourcesPlugin.class);\n+\n+        // note - source sets are not created via org.elasticsearch.gradle.util.GradleUtils.addTestSourceSet since unlike normal tests\n+        // we only want the yamlRestTestSourceSet on the classpath by default. The yaml tests should be pure black box testing over HTTP and\n+        // such it should not need the main class on the class path. Also, there are some special setup steps unique to YAML REST tests.\n+\n+        // create source set\n+        SourceSetContainer sourceSets = project.getExtensions().getByType(SourceSetContainer.class);\n+        SourceSet yamlTestSourceSet = sourceSets.create(SOURCE_SET_NAME);\n+\n+        // create task - note can not use .register due to the work in RestIntegTestTask's constructor :(\n+        // see: https://github.com/elastic/elasticsearch/issues/47804\n+        RestIntegTestTask yamlRestTestTask = project.getTasks()\n+            .create(\n+                SOURCE_SET_NAME,\n+                RestIntegTestTask.class,\n+                task -> { task.dependsOn(project.getTasks().getByName(\"copyRestApiSpecsTask\")); }\n+            );\n+        yamlRestTestTask.setGroup(JavaBasePlugin.VERIFICATION_GROUP);\n+        yamlRestTestTask.setDescription(\"Runs the YAML based REST tests against an external cluster\");\n+\n+        // setup task dependency\n+        if (BuildParams.isInternal()) {", "originalCommit": "53ae3934de8355acd70ad66a53636ca6188849cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA1NDE4OA==", "url": "https://github.com/elastic/elasticsearch/pull/56841#discussion_r448054188", "bodyText": "done 6289b00 (#56841) and 02afa30 (#56841)", "author": "jakelandis", "createdAt": "2020-07-01T00:40:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg5NDY0OA=="}], "type": "inlineReview", "revised_code": {"commit": "6289b00b7fb71856968e2a6fa543202f4aa8cf7d", "chunk": "diff --git a/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestTestPlugin.java b/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestTestPlugin.java\nindex 71d95999f1c..48e59b531ce 100644\n--- a/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestTestPlugin.java\n+++ b/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestTestPlugin.java\n\n@@ -64,22 +64,25 @@ public class YamlRestTestPlugin implements Plugin<Project> {\n         RestIntegTestTask yamlRestTestTask = project.getTasks()\n             .create(\n                 SOURCE_SET_NAME,\n-                RestIntegTestTask.class,\n-                task -> { task.dependsOn(project.getTasks().getByName(\"copyRestApiSpecsTask\")); }\n+                RestIntegTestTask.class\n+                //the dependency on copyRestApiSpecsTask is added in RestResourcePlugin to avoid propagating the eagerness of create :(\n             );\n         yamlRestTestTask.setGroup(JavaBasePlugin.VERIFICATION_GROUP);\n         yamlRestTestTask.setDescription(\"Runs the YAML based REST tests against an external cluster\");\n \n         // setup task dependency\n         if (BuildParams.isInternal()) {\n-            project.getDependencies().add(SOURCE_SET_NAME + \"Compile\", project.project(\":test:framework\"));\n+            project.getDependencies().add(yamlTestSourceSet.getImplementationConfigurationName(), project.project(\":test:framework\"));\n         } else {\n             project.getDependencies()\n                 .add(SOURCE_SET_NAME + \"Compile\", \"org.elasticsearch.test:framework:\" + VersionProperties.getElasticsearch());\n         }\n \n+        // make the new test run after unit tests\n+        yamlRestTestTask.mustRunAfter(project.getTasks().named(\"test\"));\n+\n         // setup the runner\n-        RestTestRunnerTask runner = (RestTestRunnerTask) project.getTasks().getByName(yamlRestTestTask.getName() + \"Runner\");\n+        RestTestRunnerTask runner = yamlRestTestTask.getRunner();\n         runner.setTestClassesDirs(yamlTestSourceSet.getOutput().getClassesDirs());\n         runner.setClasspath(yamlTestSourceSet.getRuntimeClasspath());\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg5NTI3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/56841#discussion_r447895273", "bodyText": "We should use RestIntegTestTask.runner() method to configure the test runner task rather than fetch it by name.", "author": "mark-vieira", "createdAt": "2020-06-30T18:30:19Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestTestPlugin.java", "diffHunk": "@@ -0,0 +1,122 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.test.rest;\n+\n+import org.elasticsearch.gradle.ElasticsearchJavaPlugin;\n+import org.elasticsearch.gradle.VersionProperties;\n+import org.elasticsearch.gradle.info.BuildParams;\n+import org.elasticsearch.gradle.plugin.PluginPropertiesExtension;\n+import org.elasticsearch.gradle.test.RestIntegTestTask;\n+import org.elasticsearch.gradle.testclusters.RestTestRunnerTask;\n+import org.elasticsearch.gradle.testclusters.TestClustersPlugin;\n+import org.elasticsearch.gradle.util.GradleUtils;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.plugins.JavaBasePlugin;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.SourceSetContainer;\n+import org.gradle.api.tasks.bundling.Zip;\n+\n+/**\n+ * Apply this plugin to run the YAML based REST tests.\n+ */\n+public class YamlRestTestPlugin implements Plugin<Project> {\n+\n+    public static final String SOURCE_SET_NAME = \"yamlRestTest\";\n+\n+    @Override\n+    public void apply(Project project) {\n+\n+        // yaml Rest tests require a Java test runner\n+        project.getPluginManager().apply(ElasticsearchJavaPlugin.class);\n+        // to spin up the external cluster\n+        project.getPluginManager().apply(TestClustersPlugin.class);\n+        // to copy around the yaml tests and json spec\n+        project.getPluginManager().apply(RestResourcesPlugin.class);\n+\n+        // note - source sets are not created via org.elasticsearch.gradle.util.GradleUtils.addTestSourceSet since unlike normal tests\n+        // we only want the yamlRestTestSourceSet on the classpath by default. The yaml tests should be pure black box testing over HTTP and\n+        // such it should not need the main class on the class path. Also, there are some special setup steps unique to YAML REST tests.\n+\n+        // create source set\n+        SourceSetContainer sourceSets = project.getExtensions().getByType(SourceSetContainer.class);\n+        SourceSet yamlTestSourceSet = sourceSets.create(SOURCE_SET_NAME);\n+\n+        // create task - note can not use .register due to the work in RestIntegTestTask's constructor :(\n+        // see: https://github.com/elastic/elasticsearch/issues/47804\n+        RestIntegTestTask yamlRestTestTask = project.getTasks()\n+            .create(\n+                SOURCE_SET_NAME,\n+                RestIntegTestTask.class,\n+                task -> { task.dependsOn(project.getTasks().getByName(\"copyRestApiSpecsTask\")); }\n+            );\n+        yamlRestTestTask.setGroup(JavaBasePlugin.VERIFICATION_GROUP);\n+        yamlRestTestTask.setDescription(\"Runs the YAML based REST tests against an external cluster\");\n+\n+        // setup task dependency\n+        if (BuildParams.isInternal()) {\n+            project.getDependencies().add(SOURCE_SET_NAME + \"Compile\", project.project(\":test:framework\"));\n+        } else {\n+            project.getDependencies()\n+                .add(SOURCE_SET_NAME + \"Compile\", \"org.elasticsearch.test:framework:\" + VersionProperties.getElasticsearch());\n+        }\n+\n+        // setup the runner\n+        RestTestRunnerTask runner = (RestTestRunnerTask) project.getTasks().getByName(yamlRestTestTask.getName() + \"Runner\");", "originalCommit": "53ae3934de8355acd70ad66a53636ca6188849cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA1NDM0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/56841#discussion_r448054343", "bodyText": "done 6289b00 (#56841) (had to add a getter with @Internal)", "author": "jakelandis", "createdAt": "2020-07-01T00:41:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg5NTI3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "6289b00b7fb71856968e2a6fa543202f4aa8cf7d", "chunk": "diff --git a/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestTestPlugin.java b/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestTestPlugin.java\nindex 71d95999f1c..48e59b531ce 100644\n--- a/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestTestPlugin.java\n+++ b/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestTestPlugin.java\n\n@@ -64,22 +64,25 @@ public class YamlRestTestPlugin implements Plugin<Project> {\n         RestIntegTestTask yamlRestTestTask = project.getTasks()\n             .create(\n                 SOURCE_SET_NAME,\n-                RestIntegTestTask.class,\n-                task -> { task.dependsOn(project.getTasks().getByName(\"copyRestApiSpecsTask\")); }\n+                RestIntegTestTask.class\n+                //the dependency on copyRestApiSpecsTask is added in RestResourcePlugin to avoid propagating the eagerness of create :(\n             );\n         yamlRestTestTask.setGroup(JavaBasePlugin.VERIFICATION_GROUP);\n         yamlRestTestTask.setDescription(\"Runs the YAML based REST tests against an external cluster\");\n \n         // setup task dependency\n         if (BuildParams.isInternal()) {\n-            project.getDependencies().add(SOURCE_SET_NAME + \"Compile\", project.project(\":test:framework\"));\n+            project.getDependencies().add(yamlTestSourceSet.getImplementationConfigurationName(), project.project(\":test:framework\"));\n         } else {\n             project.getDependencies()\n                 .add(SOURCE_SET_NAME + \"Compile\", \"org.elasticsearch.test:framework:\" + VersionProperties.getElasticsearch());\n         }\n \n+        // make the new test run after unit tests\n+        yamlRestTestTask.mustRunAfter(project.getTasks().named(\"test\"));\n+\n         // setup the runner\n-        RestTestRunnerTask runner = (RestTestRunnerTask) project.getTasks().getByName(yamlRestTestTask.getName() + \"Runner\");\n+        RestTestRunnerTask runner = yamlRestTestTask.getRunner();\n         runner.setTestClassesDirs(yamlTestSourceSet.getOutput().getClassesDirs());\n         runner.setClasspath(yamlTestSourceSet.getRuntimeClasspath());\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg5Njc2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/56841#discussion_r447896765", "bodyText": "We should key this off the application of PluginBuildPlugin, not by a particular task. For example.", "author": "mark-vieira", "createdAt": "2020-06-30T18:33:18Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestTestPlugin.java", "diffHunk": "@@ -0,0 +1,122 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.test.rest;\n+\n+import org.elasticsearch.gradle.ElasticsearchJavaPlugin;\n+import org.elasticsearch.gradle.VersionProperties;\n+import org.elasticsearch.gradle.info.BuildParams;\n+import org.elasticsearch.gradle.plugin.PluginPropertiesExtension;\n+import org.elasticsearch.gradle.test.RestIntegTestTask;\n+import org.elasticsearch.gradle.testclusters.RestTestRunnerTask;\n+import org.elasticsearch.gradle.testclusters.TestClustersPlugin;\n+import org.elasticsearch.gradle.util.GradleUtils;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.plugins.JavaBasePlugin;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.SourceSetContainer;\n+import org.gradle.api.tasks.bundling.Zip;\n+\n+/**\n+ * Apply this plugin to run the YAML based REST tests.\n+ */\n+public class YamlRestTestPlugin implements Plugin<Project> {\n+\n+    public static final String SOURCE_SET_NAME = \"yamlRestTest\";\n+\n+    @Override\n+    public void apply(Project project) {\n+\n+        // yaml Rest tests require a Java test runner\n+        project.getPluginManager().apply(ElasticsearchJavaPlugin.class);\n+        // to spin up the external cluster\n+        project.getPluginManager().apply(TestClustersPlugin.class);\n+        // to copy around the yaml tests and json spec\n+        project.getPluginManager().apply(RestResourcesPlugin.class);\n+\n+        // note - source sets are not created via org.elasticsearch.gradle.util.GradleUtils.addTestSourceSet since unlike normal tests\n+        // we only want the yamlRestTestSourceSet on the classpath by default. The yaml tests should be pure black box testing over HTTP and\n+        // such it should not need the main class on the class path. Also, there are some special setup steps unique to YAML REST tests.\n+\n+        // create source set\n+        SourceSetContainer sourceSets = project.getExtensions().getByType(SourceSetContainer.class);\n+        SourceSet yamlTestSourceSet = sourceSets.create(SOURCE_SET_NAME);\n+\n+        // create task - note can not use .register due to the work in RestIntegTestTask's constructor :(\n+        // see: https://github.com/elastic/elasticsearch/issues/47804\n+        RestIntegTestTask yamlRestTestTask = project.getTasks()\n+            .create(\n+                SOURCE_SET_NAME,\n+                RestIntegTestTask.class,\n+                task -> { task.dependsOn(project.getTasks().getByName(\"copyRestApiSpecsTask\")); }\n+            );\n+        yamlRestTestTask.setGroup(JavaBasePlugin.VERIFICATION_GROUP);\n+        yamlRestTestTask.setDescription(\"Runs the YAML based REST tests against an external cluster\");\n+\n+        // setup task dependency\n+        if (BuildParams.isInternal()) {\n+            project.getDependencies().add(SOURCE_SET_NAME + \"Compile\", project.project(\":test:framework\"));\n+        } else {\n+            project.getDependencies()\n+                .add(SOURCE_SET_NAME + \"Compile\", \"org.elasticsearch.test:framework:\" + VersionProperties.getElasticsearch());\n+        }\n+\n+        // setup the runner\n+        RestTestRunnerTask runner = (RestTestRunnerTask) project.getTasks().getByName(yamlRestTestTask.getName() + \"Runner\");\n+        runner.setTestClassesDirs(yamlTestSourceSet.getOutput().getClassesDirs());\n+        runner.setClasspath(yamlTestSourceSet.getRuntimeClasspath());\n+\n+        // if this a module or plugin, it may have an associated zip file with it's contents, add that to the test cluster\n+        boolean isModule = project.getPath().startsWith(\":modules:\");\n+        Zip bundle = (Zip) project.getTasks().findByName(\"bundlePlugin\");\n+        if (bundle != null) {", "originalCommit": "53ae3934de8355acd70ad66a53636ca6188849cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk3NDQ5NA==", "url": "https://github.com/elastic/elasticsearch/pull/56841#discussion_r447974494", "bodyText": "Unfortunately, PluginBuildPlugin is in groovy, and this is in Java which can not reference the groovy side of things.", "author": "jakelandis", "createdAt": "2020-06-30T20:57:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg5Njc2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk4NjYzNA==", "url": "https://github.com/elastic/elasticsearch/pull/56841#discussion_r447986634", "bodyText": "No worries, we can do the same by referencing it by id.\nproject.getPluginManager().withPlugin(\"elasticsearch.esplugin\", plugin -> {\n    // do stuff\n});", "author": "mark-vieira", "createdAt": "2020-06-30T21:21:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg5Njc2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA1NDY5MA==", "url": "https://github.com/elastic/elasticsearch/pull/56841#discussion_r448054690", "bodyText": "done 02afa30 (#56841) , thanks even think about using the ID.", "author": "jakelandis", "createdAt": "2020-07-01T00:42:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg5Njc2NQ=="}], "type": "inlineReview", "revised_code": {"commit": "6289b00b7fb71856968e2a6fa543202f4aa8cf7d", "chunk": "diff --git a/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestTestPlugin.java b/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestTestPlugin.java\nindex 71d95999f1c..48e59b531ce 100644\n--- a/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestTestPlugin.java\n+++ b/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestTestPlugin.java\n\n@@ -64,22 +64,25 @@ public class YamlRestTestPlugin implements Plugin<Project> {\n         RestIntegTestTask yamlRestTestTask = project.getTasks()\n             .create(\n                 SOURCE_SET_NAME,\n-                RestIntegTestTask.class,\n-                task -> { task.dependsOn(project.getTasks().getByName(\"copyRestApiSpecsTask\")); }\n+                RestIntegTestTask.class\n+                //the dependency on copyRestApiSpecsTask is added in RestResourcePlugin to avoid propagating the eagerness of create :(\n             );\n         yamlRestTestTask.setGroup(JavaBasePlugin.VERIFICATION_GROUP);\n         yamlRestTestTask.setDescription(\"Runs the YAML based REST tests against an external cluster\");\n \n         // setup task dependency\n         if (BuildParams.isInternal()) {\n-            project.getDependencies().add(SOURCE_SET_NAME + \"Compile\", project.project(\":test:framework\"));\n+            project.getDependencies().add(yamlTestSourceSet.getImplementationConfigurationName(), project.project(\":test:framework\"));\n         } else {\n             project.getDependencies()\n                 .add(SOURCE_SET_NAME + \"Compile\", \"org.elasticsearch.test:framework:\" + VersionProperties.getElasticsearch());\n         }\n \n+        // make the new test run after unit tests\n+        yamlRestTestTask.mustRunAfter(project.getTasks().named(\"test\"));\n+\n         // setup the runner\n-        RestTestRunnerTask runner = (RestTestRunnerTask) project.getTasks().getByName(yamlRestTestTask.getName() + \"Runner\");\n+        RestTestRunnerTask runner = yamlRestTestTask.getRunner();\n         runner.setTestClassesDirs(yamlTestSourceSet.getOutput().getClassesDirs());\n         runner.setClasspath(yamlTestSourceSet.getRuntimeClasspath());\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg5NzA5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/56841#discussion_r447897099", "bodyText": "Can we move this up where we configure other aspects of this task?", "author": "mark-vieira", "createdAt": "2020-06-30T18:33:57Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestTestPlugin.java", "diffHunk": "@@ -0,0 +1,122 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.test.rest;\n+\n+import org.elasticsearch.gradle.ElasticsearchJavaPlugin;\n+import org.elasticsearch.gradle.VersionProperties;\n+import org.elasticsearch.gradle.info.BuildParams;\n+import org.elasticsearch.gradle.plugin.PluginPropertiesExtension;\n+import org.elasticsearch.gradle.test.RestIntegTestTask;\n+import org.elasticsearch.gradle.testclusters.RestTestRunnerTask;\n+import org.elasticsearch.gradle.testclusters.TestClustersPlugin;\n+import org.elasticsearch.gradle.util.GradleUtils;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.plugins.JavaBasePlugin;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.SourceSetContainer;\n+import org.gradle.api.tasks.bundling.Zip;\n+\n+/**\n+ * Apply this plugin to run the YAML based REST tests.\n+ */\n+public class YamlRestTestPlugin implements Plugin<Project> {\n+\n+    public static final String SOURCE_SET_NAME = \"yamlRestTest\";\n+\n+    @Override\n+    public void apply(Project project) {\n+\n+        // yaml Rest tests require a Java test runner\n+        project.getPluginManager().apply(ElasticsearchJavaPlugin.class);\n+        // to spin up the external cluster\n+        project.getPluginManager().apply(TestClustersPlugin.class);\n+        // to copy around the yaml tests and json spec\n+        project.getPluginManager().apply(RestResourcesPlugin.class);\n+\n+        // note - source sets are not created via org.elasticsearch.gradle.util.GradleUtils.addTestSourceSet since unlike normal tests\n+        // we only want the yamlRestTestSourceSet on the classpath by default. The yaml tests should be pure black box testing over HTTP and\n+        // such it should not need the main class on the class path. Also, there are some special setup steps unique to YAML REST tests.\n+\n+        // create source set\n+        SourceSetContainer sourceSets = project.getExtensions().getByType(SourceSetContainer.class);\n+        SourceSet yamlTestSourceSet = sourceSets.create(SOURCE_SET_NAME);\n+\n+        // create task - note can not use .register due to the work in RestIntegTestTask's constructor :(\n+        // see: https://github.com/elastic/elasticsearch/issues/47804\n+        RestIntegTestTask yamlRestTestTask = project.getTasks()\n+            .create(\n+                SOURCE_SET_NAME,\n+                RestIntegTestTask.class,\n+                task -> { task.dependsOn(project.getTasks().getByName(\"copyRestApiSpecsTask\")); }\n+            );\n+        yamlRestTestTask.setGroup(JavaBasePlugin.VERIFICATION_GROUP);\n+        yamlRestTestTask.setDescription(\"Runs the YAML based REST tests against an external cluster\");\n+\n+        // setup task dependency\n+        if (BuildParams.isInternal()) {\n+            project.getDependencies().add(SOURCE_SET_NAME + \"Compile\", project.project(\":test:framework\"));\n+        } else {\n+            project.getDependencies()\n+                .add(SOURCE_SET_NAME + \"Compile\", \"org.elasticsearch.test:framework:\" + VersionProperties.getElasticsearch());\n+        }\n+\n+        // setup the runner\n+        RestTestRunnerTask runner = (RestTestRunnerTask) project.getTasks().getByName(yamlRestTestTask.getName() + \"Runner\");\n+        runner.setTestClassesDirs(yamlTestSourceSet.getOutput().getClassesDirs());\n+        runner.setClasspath(yamlTestSourceSet.getRuntimeClasspath());\n+\n+        // if this a module or plugin, it may have an associated zip file with it's contents, add that to the test cluster\n+        boolean isModule = project.getPath().startsWith(\":modules:\");\n+        Zip bundle = (Zip) project.getTasks().findByName(\"bundlePlugin\");\n+        if (bundle != null) {\n+            yamlRestTestTask.dependsOn(bundle);\n+            if (isModule) {\n+                runner.getClusters().forEach(c -> c.module(bundle.getArchiveFile()));\n+            } else {\n+                runner.getClusters().forEach(c -> c.plugin(project.getObjects().fileProperty().value(bundle.getArchiveFile())));\n+            }\n+        }\n+\n+        // es-plugins may declare dependencies on additional modules, add those to the test cluster too.\n+        project.afterEvaluate(p -> {\n+            PluginPropertiesExtension pluginPropertiesExtension = project.getExtensions().findByType(PluginPropertiesExtension.class);\n+            if (pluginPropertiesExtension != null) { // not all projects are defined as plugins\n+                pluginPropertiesExtension.getExtendedPlugins().forEach(pluginName -> {\n+                    Project extensionProject = project.getProject().findProject(\":modules:\" + pluginName);\n+                    if (extensionProject != null) { // extension plugin may be defined, but not required to be a module\n+                        Zip extensionBundle = (Zip) extensionProject.getTasks().getByName(\"bundlePlugin\");\n+                        yamlRestTestTask.dependsOn(extensionBundle);\n+                        runner.getClusters().forEach(c -> c.module(extensionBundle.getArchiveFile()));\n+                    }\n+                });\n+            }\n+        });\n+\n+        // setup IDE\n+        GradleUtils.setupIdeForTestSourceSet(project, yamlTestSourceSet);\n+\n+        // make the new test run after unit tests\n+        yamlRestTestTask.mustRunAfter(project.getTasks().named(\"test\"));", "originalCommit": "53ae3934de8355acd70ad66a53636ca6188849cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA1NDc0OA==", "url": "https://github.com/elastic/elasticsearch/pull/56841#discussion_r448054748", "bodyText": "done 6289b00 (#56841)", "author": "jakelandis", "createdAt": "2020-07-01T00:43:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg5NzA5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "6289b00b7fb71856968e2a6fa543202f4aa8cf7d", "chunk": "diff --git a/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestTestPlugin.java b/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestTestPlugin.java\nindex 71d95999f1c..48e59b531ce 100644\n--- a/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestTestPlugin.java\n+++ b/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestTestPlugin.java\n\n@@ -64,22 +64,25 @@ public class YamlRestTestPlugin implements Plugin<Project> {\n         RestIntegTestTask yamlRestTestTask = project.getTasks()\n             .create(\n                 SOURCE_SET_NAME,\n-                RestIntegTestTask.class,\n-                task -> { task.dependsOn(project.getTasks().getByName(\"copyRestApiSpecsTask\")); }\n+                RestIntegTestTask.class\n+                //the dependency on copyRestApiSpecsTask is added in RestResourcePlugin to avoid propagating the eagerness of create :(\n             );\n         yamlRestTestTask.setGroup(JavaBasePlugin.VERIFICATION_GROUP);\n         yamlRestTestTask.setDescription(\"Runs the YAML based REST tests against an external cluster\");\n \n         // setup task dependency\n         if (BuildParams.isInternal()) {\n-            project.getDependencies().add(SOURCE_SET_NAME + \"Compile\", project.project(\":test:framework\"));\n+            project.getDependencies().add(yamlTestSourceSet.getImplementationConfigurationName(), project.project(\":test:framework\"));\n         } else {\n             project.getDependencies()\n                 .add(SOURCE_SET_NAME + \"Compile\", \"org.elasticsearch.test:framework:\" + VersionProperties.getElasticsearch());\n         }\n \n+        // make the new test run after unit tests\n+        yamlRestTestTask.mustRunAfter(project.getTasks().named(\"test\"));\n+\n         // setup the runner\n-        RestTestRunnerTask runner = (RestTestRunnerTask) project.getTasks().getByName(yamlRestTestTask.getName() + \"Runner\");\n+        RestTestRunnerTask runner = yamlRestTestTask.getRunner();\n         runner.setTestClassesDirs(yamlTestSourceSet.getOutput().getClassesDirs());\n         runner.setClasspath(yamlTestSourceSet.getRuntimeClasspath());\n \n"}}, {"oid": "6289b00b7fb71856968e2a6fa543202f4aa8cf7d", "url": "https://github.com/elastic/elasticsearch/commit/6289b00b7fb71856968e2a6fa543202f4aa8cf7d", "message": "review changes", "committedDate": "2020-07-01T00:23:17Z", "type": "commit"}, {"oid": "02afa305711b7118a64ced93df1607097a5defcb", "url": "https://github.com/elastic/elasticsearch/commit/02afa305711b7118a64ced93df1607097a5defcb", "message": "minor review comments", "committedDate": "2020-07-01T00:34:48Z", "type": "commit"}, {"oid": "ceaeca383ab4f2d64acea598beb49e35528a4cc3", "url": "https://github.com/elastic/elasticsearch/commit/ceaeca383ab4f2d64acea598beb49e35528a4cc3", "message": "Merge branch 'master' into yamlTest_part1", "committedDate": "2020-07-01T01:14:15Z", "type": "commit"}, {"oid": "a7a6f9eca711ba0895c204a1bbd4ae4cce6e16c2", "url": "https://github.com/elastic/elasticsearch/commit/a7a6f9eca711ba0895c204a1bbd4ae4cce6e16c2", "message": "ensure core specs are copied for x-pack", "committedDate": "2020-07-01T02:17:39Z", "type": "commit"}, {"oid": "22c55da58d856a92002362e20fc1815e7f322a25", "url": "https://github.com/elastic/elasticsearch/commit/22c55da58d856a92002362e20fc1815e7f322a25", "message": "remove gymnastics", "committedDate": "2020-07-01T16:27:50Z", "type": "commit"}, {"oid": "db94130fe326558b89706d5ec5052973295be1ff", "url": "https://github.com/elastic/elasticsearch/commit/db94130fe326558b89706d5ec5052973295be1ff", "message": "fix checkstyle", "committedDate": "2020-07-01T16:51:04Z", "type": "commit"}, {"oid": "b20a16662a871b3e557391e2a1c5b379733c50a0", "url": "https://github.com/elastic/elasticsearch/commit/b20a16662a871b3e557391e2a1c5b379733c50a0", "message": "fix newly introduced project", "committedDate": "2020-07-01T17:50:14Z", "type": "commit"}, {"oid": "01990fa3d659d0ea932c94f7f9181b6c4e15add9", "url": "https://github.com/elastic/elasticsearch/commit/01990fa3d659d0ea932c94f7f9181b6c4e15add9", "message": "Merge branch 'master' into yamlTest_part1", "committedDate": "2020-07-01T18:49:49Z", "type": "commit"}, {"oid": "07ddee5b062cc1fcd8f8460214e1487e57e26d16", "url": "https://github.com/elastic/elasticsearch/commit/07ddee5b062cc1fcd8f8460214e1487e57e26d16", "message": "Merge remote-tracking branch 'upstream/master' into yamlTest_part1", "committedDate": "2020-07-06T13:46:26Z", "type": "commit"}]}