{"pr_number": 65996, "pr_title": "Track in-progress indexing operations", "pr_createdAt": "2020-12-08T05:12:44Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/65996", "timeline": [{"oid": "caa36c61ad9df69b126499a9bb755bb76c683be4", "url": "https://github.com/elastic/elasticsearch/commit/caa36c61ad9df69b126499a9bb755bb76c683be4", "message": "Changes", "committedDate": "2020-11-18T01:05:15Z", "type": "commit"}, {"oid": "e12489a6e9271177d1b604cbc00c791337e5309b", "url": "https://github.com/elastic/elasticsearch/commit/e12489a6e9271177d1b604cbc00c791337e5309b", "message": "Merge remote-tracking branch 'upstream/master' into indexing_queue_lag", "committedDate": "2020-11-23T22:07:43Z", "type": "commit"}, {"oid": "6ef19b84e1c6d26c1e334f3f2ddcc6f8c322bcb0", "url": "https://github.com/elastic/elasticsearch/commit/6ef19b84e1c6d26c1e334f3f2ddcc6f8c322bcb0", "message": "Add ops", "committedDate": "2020-11-24T17:06:25Z", "type": "commit"}, {"oid": "dd2e0039b3e4c52133269634b89161cf5f21bdf1", "url": "https://github.com/elastic/elasticsearch/commit/dd2e0039b3e4c52133269634b89161cf5f21bdf1", "message": "Merge remote-tracking branch 'upstream/master' into indexing_queue_lag", "committedDate": "2020-12-01T23:46:16Z", "type": "commit"}, {"oid": "6430e5f178d371ac035d8ec16e163eae7eaa67db", "url": "https://github.com/elastic/elasticsearch/commit/6430e5f178d371ac035d8ec16e163eae7eaa67db", "message": "Changes", "committedDate": "2020-12-02T01:13:32Z", "type": "commit"}, {"oid": "618de9c04894a1c2d43512569a0c1b6f543ebd74", "url": "https://github.com/elastic/elasticsearch/commit/618de9c04894a1c2d43512569a0c1b6f543ebd74", "message": "Merge remote-tracking branch 'upstream/master' into indexing_queue_lag", "committedDate": "2020-12-08T00:01:26Z", "type": "commit"}, {"oid": "5c2eb2bbba5c86c73e07a9962e7e789fcd947880", "url": "https://github.com/elastic/elasticsearch/commit/5c2eb2bbba5c86c73e07a9962e7e789fcd947880", "message": "Changes", "committedDate": "2020-12-08T01:01:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQ0MTE2MA==", "url": "https://github.com/elastic/elasticsearch/pull/65996#discussion_r538441160", "bodyText": "This and its counterpart below looks unused.", "author": "henningandersen", "createdAt": "2020-12-08T14:36:22Z", "path": "server/src/main/java/org/elasticsearch/action/support/replication/TransportWriteAction.java", "diffHunk": "@@ -172,9 +182,11 @@ public static Location locationToSync(Location current, Location next) {\n     @Override\n     protected void shardOperationOnPrimary(\n             Request request, IndexShard primary, ActionListener<PrimaryResult<ReplicaRequest, Response>> listener) {\n+        final long enqueueTime = System.nanoTime();\n         threadPool.executor(executorFunction.apply(primary)).execute(new ActionRunnable<>(listener) {\n             @Override\n             protected void doRun() {\n+                final long queuedNanos = System.nanoTime() - enqueueTime;", "originalCommit": "5c2eb2bbba5c86c73e07a9962e7e789fcd947880", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9ef80c139829afce165122c00899f7d516ac3548", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/support/replication/TransportWriteAction.java b/server/src/main/java/org/elasticsearch/action/support/replication/TransportWriteAction.java\nindex d38abd084eb..77a1e21f37c 100644\n--- a/server/src/main/java/org/elasticsearch/action/support/replication/TransportWriteAction.java\n+++ b/server/src/main/java/org/elasticsearch/action/support/replication/TransportWriteAction.java\n\n@@ -182,11 +182,9 @@ public abstract class TransportWriteAction<\n     @Override\n     protected void shardOperationOnPrimary(\n             Request request, IndexShard primary, ActionListener<PrimaryResult<ReplicaRequest, Response>> listener) {\n-        final long enqueueTime = System.nanoTime();\n         threadPool.executor(executorFunction.apply(primary)).execute(new ActionRunnable<>(listener) {\n             @Override\n             protected void doRun() {\n-                final long queuedNanos = System.nanoTime() - enqueueTime;\n                 dispatchedShardOperationOnPrimary(request, primary, listener);\n             }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQ3NzE4NA==", "url": "https://github.com/elastic/elasticsearch/pull/65996#discussion_r538477184", "bodyText": "Can we remove this overload? Looks unused.", "author": "henningandersen", "createdAt": "2020-12-08T15:08:45Z", "path": "server/src/main/java/org/elasticsearch/index/stats/IndexingPressureStats.java", "diffHunk": "@@ -84,6 +100,22 @@ public IndexingPressureStats(long totalCombinedCoordinatingAndPrimaryBytes, long\n         this.primaryRejections = primaryRejections;\n         this.replicaRejections = replicaRejections;\n         this.memoryLimit = memoryLimit;\n+\n+        this.totalCoordinatingOps = totalCoordinatingOps;\n+        this.totalPrimaryOps = totalPrimaryOps;\n+        this.totalReplicaOps = totalReplicaOps;\n+        this.currentCoordinatingOps = currentCoordinatingOps;\n+        this.currentPrimaryOps = currentPrimaryOps;\n+        this.currentReplicaOps = currentReplicaOps;\n+    }\n+\n+    public IndexingPressureStats(long totalCombinedCoordinatingAndPrimaryBytes, long totalCoordinatingBytes, long totalPrimaryBytes,", "originalCommit": "5c2eb2bbba5c86c73e07a9962e7e789fcd947880", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9ef80c139829afce165122c00899f7d516ac3548", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/index/stats/IndexingPressureStats.java b/server/src/main/java/org/elasticsearch/index/stats/IndexingPressureStats.java\nindex 8964292c769..28ca2c7cbda 100644\n--- a/server/src/main/java/org/elasticsearch/index/stats/IndexingPressureStats.java\n+++ b/server/src/main/java/org/elasticsearch/index/stats/IndexingPressureStats.java\n\n@@ -109,15 +110,6 @@ public class IndexingPressureStats implements Writeable, ToXContentFragment {\n         this.currentReplicaOps = currentReplicaOps;\n     }\n \n-    public IndexingPressureStats(long totalCombinedCoordinatingAndPrimaryBytes, long totalCoordinatingBytes, long totalPrimaryBytes,\n-                                 long totalReplicaBytes, long currentCombinedCoordinatingAndPrimaryBytes, long currentCoordinatingBytes,\n-                                 long currentPrimaryBytes, long currentReplicaBytes, long coordinatingRejections, long primaryRejections,\n-                                 long replicaRejections, long memoryLimit) {\n-        this(totalCombinedCoordinatingAndPrimaryBytes, totalCoordinatingBytes, totalPrimaryBytes, totalReplicaBytes,\n-            currentCombinedCoordinatingAndPrimaryBytes, currentCoordinatingBytes, currentPrimaryBytes, currentReplicaBytes,\n-            coordinatingRejections, primaryRejections, replicaRejections, memoryLimit, 0, 0, 0, 0, 0, 0);\n-    }\n-\n     @Override\n     public void writeTo(StreamOutput out) throws IOException {\n         out.writeVLong(totalCombinedCoordinatingAndPrimaryBytes);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQ4MDU0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/65996#discussion_r538480549", "bodyText": "Perhaps add a comment on these that we intend to expose these or something similar in the future in the x-content after experimentation.", "author": "henningandersen", "createdAt": "2020-12-08T15:11:45Z", "path": "server/src/main/java/org/elasticsearch/index/stats/IndexingPressureStats.java", "diffHunk": "@@ -46,6 +46,13 @@\n     private final long replicaRejections;\n     private final long memoryLimit;\n \n+    private final long totalCoordinatingOps;", "originalCommit": "5c2eb2bbba5c86c73e07a9962e7e789fcd947880", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9ef80c139829afce165122c00899f7d516ac3548", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/index/stats/IndexingPressureStats.java b/server/src/main/java/org/elasticsearch/index/stats/IndexingPressureStats.java\nindex 8964292c769..28ca2c7cbda 100644\n--- a/server/src/main/java/org/elasticsearch/index/stats/IndexingPressureStats.java\n+++ b/server/src/main/java/org/elasticsearch/index/stats/IndexingPressureStats.java\n\n@@ -46,6 +46,7 @@ public class IndexingPressureStats implements Writeable, ToXContentFragment {\n     private final long replicaRejections;\n     private final long memoryLimit;\n \n+    // These fields will be used for additional back-pressure and metrics in the future\n     private final long totalCoordinatingOps;\n     private final long totalPrimaryOps;\n     private final long totalReplicaOps;\n"}}, {"oid": "9ef80c139829afce165122c00899f7d516ac3548", "url": "https://github.com/elastic/elasticsearch/commit/9ef80c139829afce165122c00899f7d516ac3548", "message": "review", "committedDate": "2020-12-08T17:24:24Z", "type": "commit"}, {"oid": "0c6590be2ab15198a2650cd3efd7b90dabdd12e1", "url": "https://github.com/elastic/elasticsearch/commit/0c6590be2ab15198a2650cd3efd7b90dabdd12e1", "message": "Merge remote-tracking branch 'upstream/master' into indexing_queue_lag", "committedDate": "2020-12-08T18:47:39Z", "type": "commit"}]}