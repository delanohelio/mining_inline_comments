{"pr_number": 55544, "pr_title": "Change default hashing algorithm for FIPS 140", "pr_createdAt": "2020-04-21T16:25:51Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55544", "timeline": [{"oid": "6fecfb5647262e65229f6b28697bbc28566a5a0e", "url": "https://github.com/elastic/elasticsearch/commit/6fecfb5647262e65229f6b28697bbc28566a5a0e", "message": "Change default hashing algorithm for FIPS 140\n\nCurrently we disallow(via a startup check) any algorithm families\nother than PBKDF2 when we expect Elasticsearch to run in a JVM in\nFIPS 140 approved mode. However we do not change the default\nhashing algorithm, which remains BCRYPT and that means that the\nuser needs to explicitly set the password hashing algorithm to\nsomething compliant.\nWe know though, via the use of fips_mode.enabled, whether we\nexpect to run on a FIPS 140 JVM and we can change the default\nhashing algorithm to one from the PBKDF family in that case.\n\nThis commit changes our default behavior and sets the password\nhashing algorithm to PBKDF2 with a cost factor(no of iters)of 10000\nwhen `fips_mode.enabled` is set to true.", "committedDate": "2020-04-21T16:15:43Z", "type": "commit"}, {"oid": "9be3c6eb2aaab7707d930328e690c82b95e94a20", "url": "https://github.com/elastic/elasticsearch/commit/9be3c6eb2aaab7707d930328e690c82b95e94a20", "message": "unused import", "committedDate": "2020-04-21T16:36:40Z", "type": "commit"}, {"oid": "db98a546850b6ef79e8fa10416914e5b35e122b3", "url": "https://github.com/elastic/elasticsearch/commit/db98a546850b6ef79e8fa10416914e5b35e122b3", "message": "Merge branch 'master' into default-hashing-algo-fips", "committedDate": "2020-04-21T17:58:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjY2MDg3MA==", "url": "https://github.com/elastic/elasticsearch/pull/55544#discussion_r412660870", "bodyText": "Why do we check both existence and actual value here? This is necessary when we want check something like \"security is explicitly enabled, not implicilty enabled\". Is this a similar situation here?", "author": "ywangd", "createdAt": "2020-04-22T04:29:07Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/XPackSettings.java", "diffHunk": "@@ -170,20 +170,29 @@ private XPackSettings() {\n      * Do not allow insecure hashing algorithms to be used for password hashing\n      */\n     public static final Setting<String> PASSWORD_HASHING_ALGORITHM = new Setting<>(\n-        \"xpack.security.authc.password_hashing.algorithm\", \"bcrypt\", Function.identity(), v -> {\n-        if (Hasher.getAvailableAlgoStoredHash().contains(v.toLowerCase(Locale.ROOT)) == false) {\n-            throw new IllegalArgumentException(\"Invalid algorithm: \" + v + \". Valid values for password hashing are \" +\n-                Hasher.getAvailableAlgoStoredHash().toString());\n-        } else if (v.regionMatches(true, 0, \"pbkdf2\", 0, \"pbkdf2\".length())) {\n-            try {\n-                SecretKeyFactory.getInstance(\"PBKDF2withHMACSHA512\");\n-            } catch (NoSuchAlgorithmException e) {\n-                throw new IllegalArgumentException(\n-                    \"Support for PBKDF2WithHMACSHA512 must be available in order to use any of the \" +\n-                        \"PBKDF2 algorithms for the [xpack.security.authc.password_hashing.algorithm] setting.\", e);\n+        new Setting.SimpleKey(\"xpack.security.authc.password_hashing.algorithm\"),\n+        (s) -> {\n+            if (XPackSettings.FIPS_MODE_ENABLED.exists(s) && XPackSettings.FIPS_MODE_ENABLED.get(s)) {", "originalCommit": "db98a546850b6ef79e8fa10416914e5b35e122b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjgwNTMyMA==", "url": "https://github.com/elastic/elasticsearch/pull/55544#discussion_r412805320", "bodyText": "Thanks, that is indeed unnecessary here. fips_mode is implicitly disabled and in any case we shouldn't differentiate between this having a default value or explicitly set to true.", "author": "jkakavas", "createdAt": "2020-04-22T09:03:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjY2MDg3MA=="}], "type": "inlineReview", "revised_code": {"commit": "3f1c0bf615510fd22a349a046d0edbd726c744e8", "chunk": "diff --git a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/XPackSettings.java b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/XPackSettings.java\nindex aca3293da16..a7a5c139b12 100644\n--- a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/XPackSettings.java\n+++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/XPackSettings.java\n\n@@ -172,7 +172,7 @@ public class XPackSettings {\n     public static final Setting<String> PASSWORD_HASHING_ALGORITHM = new Setting<>(\n         new Setting.SimpleKey(\"xpack.security.authc.password_hashing.algorithm\"),\n         (s) -> {\n-            if (XPackSettings.FIPS_MODE_ENABLED.exists(s) && XPackSettings.FIPS_MODE_ENABLED.get(s)) {\n+            if (XPackSettings.FIPS_MODE_ENABLED.get(s)) {\n                 return \"PBKDF2\";\n             } else {\n                 return \"BCRYPT\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjY2NTMwNw==", "url": "https://github.com/elastic/elasticsearch/pull/55544#discussion_r412665307", "bodyText": "Why is this check necessary? Is this our own requirement or imposed by JDK?", "author": "ywangd", "createdAt": "2020-04-22T04:43:02Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/XPackSettings.java", "diffHunk": "@@ -170,20 +170,29 @@ private XPackSettings() {\n      * Do not allow insecure hashing algorithms to be used for password hashing\n      */\n     public static final Setting<String> PASSWORD_HASHING_ALGORITHM = new Setting<>(\n-        \"xpack.security.authc.password_hashing.algorithm\", \"bcrypt\", Function.identity(), v -> {\n-        if (Hasher.getAvailableAlgoStoredHash().contains(v.toLowerCase(Locale.ROOT)) == false) {\n-            throw new IllegalArgumentException(\"Invalid algorithm: \" + v + \". Valid values for password hashing are \" +\n-                Hasher.getAvailableAlgoStoredHash().toString());\n-        } else if (v.regionMatches(true, 0, \"pbkdf2\", 0, \"pbkdf2\".length())) {\n-            try {\n-                SecretKeyFactory.getInstance(\"PBKDF2withHMACSHA512\");\n-            } catch (NoSuchAlgorithmException e) {\n-                throw new IllegalArgumentException(\n-                    \"Support for PBKDF2WithHMACSHA512 must be available in order to use any of the \" +\n-                        \"PBKDF2 algorithms for the [xpack.security.authc.password_hashing.algorithm] setting.\", e);\n+        new Setting.SimpleKey(\"xpack.security.authc.password_hashing.algorithm\"),\n+        (s) -> {\n+            if (XPackSettings.FIPS_MODE_ENABLED.exists(s) && XPackSettings.FIPS_MODE_ENABLED.get(s)) {\n+                return \"PBKDF2\";\n+            } else {\n+                return \"BCRYPT\";\n             }\n-        }\n-    }, Setting.Property.NodeScope);\n+        },\n+        Function.identity(),\n+        v -> {\n+            if (Hasher.getAvailableAlgoStoredHash().contains(v.toLowerCase(Locale.ROOT)) == false) {\n+                throw new IllegalArgumentException(\"Invalid algorithm: \" + v + \". Valid values for password hashing are \" +\n+                    Hasher.getAvailableAlgoStoredHash().toString());\n+            } else if (v.regionMatches(true, 0, \"pbkdf2\", 0, \"pbkdf2\".length())) {\n+                try {\n+                    SecretKeyFactory.getInstance(\"PBKDF2withHMACSHA512\");", "originalCommit": "db98a546850b6ef79e8fa10416914e5b35e122b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjY5MDUwMw==", "url": "https://github.com/elastic/elasticsearch/pull/55544#discussion_r412690503", "bodyText": "We use PBKDF2WithHMACSHA512 in  \n  \n    \n      elasticsearch/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/support/Hasher.java\n    \n    \n         Line 511\n      in\n      00b4d3d\n    \n    \n    \n    \n\n        \n          \n           SecretKeyFactory secretKeyFactory = SecretKeyFactory.getInstance(\"PBKDF2withHMACSHA512\"); \n        \n    \n  \n\n so we would like to be sure that the security provider that is used has this implementation up front ,rather than failing when we actually get to hash the first password. See #31234 (comment) also", "author": "jkakavas", "createdAt": "2020-04-22T05:55:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjY2NTMwNw=="}], "type": "inlineReview", "revised_code": {"commit": "3f1c0bf615510fd22a349a046d0edbd726c744e8", "chunk": "diff --git a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/XPackSettings.java b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/XPackSettings.java\nindex aca3293da16..a7a5c139b12 100644\n--- a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/XPackSettings.java\n+++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/XPackSettings.java\n\n@@ -172,7 +172,7 @@ public class XPackSettings {\n     public static final Setting<String> PASSWORD_HASHING_ALGORITHM = new Setting<>(\n         new Setting.SimpleKey(\"xpack.security.authc.password_hashing.algorithm\"),\n         (s) -> {\n-            if (XPackSettings.FIPS_MODE_ENABLED.exists(s) && XPackSettings.FIPS_MODE_ENABLED.get(s)) {\n+            if (XPackSettings.FIPS_MODE_ENABLED.get(s)) {\n                 return \"PBKDF2\";\n             } else {\n                 return \"BCRYPT\";\n"}}, {"oid": "3f1c0bf615510fd22a349a046d0edbd726c744e8", "url": "https://github.com/elastic/elasticsearch/commit/3f1c0bf615510fd22a349a046d0edbd726c744e8", "message": "Address feedback", "committedDate": "2020-04-22T09:05:11Z", "type": "commit"}, {"oid": "e4a7fe388415fdb840aaec07ef96a9c072debed7", "url": "https://github.com/elastic/elasticsearch/commit/e4a7fe388415fdb840aaec07ef96a9c072debed7", "message": "Merge remote-tracking branch 'origin/master' into default-hashing-algo-fips", "committedDate": "2020-04-22T09:48:37Z", "type": "commit"}]}