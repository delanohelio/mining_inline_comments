{"pr_number": 57700, "pr_title": "Move async task maintenance service to core plugin", "pr_createdAt": "2020-06-04T20:56:29Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57700", "timeline": [{"oid": "cc05e1b98cb417dc5f62207ad3adbc9eac4f164e", "url": "https://github.com/elastic/elasticsearch/commit/cc05e1b98cb417dc5f62207ad3adbc9eac4f164e", "message": "Move async task maintenance service to core plugin\n\nThe async task task maintenance service is used by both async search plugin\nas well as EQL plugin. So it needs to reside in the core.\n\nRelates to #49638", "committedDate": "2020-06-04T20:54:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYxMTUzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/57700#discussion_r437611531", "bodyText": "This makes me wonder if we should make the index a system index first ? This way, we could start the maintenance service in the system index plugin. I don't think it will cause issue to move the index into a system index since we have all the protection in place with the async search user ?", "author": "jimczi", "createdAt": "2020-06-09T17:49:40Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/XPackPlugin.java", "diffHunk": "@@ -248,6 +253,16 @@ public Settings additionalSettings() {\n         components.add(getLicenseService());\n         components.add(getLicenseState());\n \n+        if (DiscoveryNode.isDataNode(environment.settings())) {", "originalCommit": "cc05e1b98cb417dc5f62207ad3adbc9eac4f164e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYyNDk4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/57700#discussion_r437624987", "bodyText": "Do you want me to convert AsyncSearch plugin into SystemIndexPlugin or should I create a separate \"Async\" plugin for that?", "author": "imotov", "createdAt": "2020-06-09T18:13:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYxMTUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYyOTgzMA==", "url": "https://github.com/elastic/elasticsearch/pull/57700#discussion_r437629830", "bodyText": "I think we can have a dedicated plugin since the goal is to start the service for all users of the index ?", "author": "jimczi", "createdAt": "2020-06-09T18:21:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYxMTUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYzNDIxNA==", "url": "https://github.com/elastic/elasticsearch/pull/57700#discussion_r437634214", "bodyText": "\ud83d\udc4d", "author": "imotov", "createdAt": "2020-06-09T18:28:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYxMTUzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "ef16b7555d7b7acb95e03c558adf98f7f300008e", "chunk": "diff --git a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/XPackPlugin.java b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/XPackPlugin.java\nindex 816a247f8fa..edfb48e7de1 100644\n--- a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/XPackPlugin.java\n+++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/XPackPlugin.java\n\n@@ -253,16 +248,6 @@ public class XPackPlugin extends XPackClientPlugin implements ExtensiblePlugin,\n         components.add(getLicenseService());\n         components.add(getLicenseState());\n \n-        if (DiscoveryNode.isDataNode(environment.settings())) {\n-            // only data nodes should be eligible to run the maintenance service.\n-            AsyncTaskIndexService<AsyncSearchResponse> indexService =\n-                new AsyncTaskIndexService<>(XPackPlugin.ASYNC_RESULTS_INDEX, clusterService, threadPool.getThreadContext(), client,\n-                    ASYNC_SEARCH_ORIGIN, AsyncSearchResponse::new, namedWriteableRegistry);\n-            AsyncTaskMaintenanceService maintenanceService =\n-                new AsyncTaskMaintenanceService(clusterService, nodeEnvironment.nodeId(), settings, threadPool, indexService);\n-            components.add(maintenanceService);\n-        }\n-\n         return components;\n     }\n \n"}}, {"oid": "e89efc071b1809e3aa244b1066ca83ddc00a0f9b", "url": "https://github.com/elastic/elasticsearch/commit/e89efc071b1809e3aa244b1066ca83ddc00a0f9b", "message": "Make async-search a system index", "committedDate": "2020-06-09T22:43:21Z", "type": "commit"}, {"oid": "510fc6496af78b5637b8ae229dc1cf9056cd4123", "url": "https://github.com/elastic/elasticsearch/commit/510fc6496af78b5637b8ae229dc1cf9056cd4123", "message": "Merge remote-tracking branch 'elastic/feature/async-eql' into move-async-cleanup-service", "committedDate": "2020-06-10T14:42:35Z", "type": "commit"}, {"oid": "ef16b7555d7b7acb95e03c558adf98f7f300008e", "url": "https://github.com/elastic/elasticsearch/commit/ef16b7555d7b7acb95e03c558adf98f7f300008e", "message": "Move AsyncTaskMaintenanceService to AsyncPlugin", "committedDate": "2020-06-10T18:26:54Z", "type": "commit"}, {"oid": "5e2ed92cd86d2acb6ca773a31bedf03d1f0a3e06", "url": "https://github.com/elastic/elasticsearch/commit/5e2ed92cd86d2acb6ca773a31bedf03d1f0a3e06", "message": "Rename AsyncPlugin to AsyncResultsIndexPlugin", "committedDate": "2020-06-11T13:41:57Z", "type": "commit"}]}