{"pr_number": 58834, "pr_title": "Simplify Repository.finalizeSnapshot Signature", "pr_createdAt": "2020-07-01T13:00:57Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/58834", "timeline": [{"oid": "cb96c3a4d40c15c11bf1d414efa0e498a28fd6c7", "url": "https://github.com/elastic/elasticsearch/commit/cb96c3a4d40c15c11bf1d414efa0e498a28fd6c7", "message": "Simplify Repository.finalizeSnapshot Signature\n\nMany of the parameters we pass into this method were only used to\nbuild the `SnapshotInfo` instance to write.\nThis change simplifies the signature. Also, it seems less error prone to build\n`SnapshotInfo` in `SnapshotsService` isntead of relying on the fact that each repository\nimplementation will build the correct `SnapshotInfo`.", "committedDate": "2020-07-01T12:59:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODgxMDYwOQ==", "url": "https://github.com/elastic/elasticsearch/pull/58834#discussion_r448810609", "bodyText": "Are we using a Supplier here so that the SnapshotInfo end time is updated when it is built?", "author": "tlrx", "createdAt": "2020-07-02T07:44:58Z", "path": "plugins/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3Repository.java", "diffHunk": "@@ -240,16 +238,15 @@\n     private final AtomicReference<Scheduler.Cancellable> finalizationFuture = new AtomicReference<>();\n \n     @Override\n-    public void finalizeSnapshot(SnapshotId snapshotId, ShardGenerations shardGenerations, long startTime, String failure, int totalShards,\n-                                 List<SnapshotShardFailure> shardFailures, long repositoryStateId, boolean includeGlobalState,\n-                                 Metadata clusterMetadata, Map<String, Object> userMetadata, Version repositoryMetaVersion,\n+    public void finalizeSnapshot(SnapshotId snapshotId, ShardGenerations shardGenerations, long repositoryStateId, Metadata clusterMetadata,\n+                                 Supplier<SnapshotInfo> buildSnapshotInfo, Version repositoryMetaVersion,", "originalCommit": "cb96c3a4d40c15c11bf1d414efa0e498a28fd6c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg0MDc1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/58834#discussion_r448840751", "bodyText": "Exactly that's why. Now that you're asking I wonder if that's even necessary ... the actual finalisation step on the repository is super parallelised these days anyway and will take a trivial amount of time. Could also just pass in the full SnapshotInfo I guess ... but then again, it gets all weird if someone actually finds a way of creating a situation where finalisation is slow (huge number of indices could maybe cause this).\n... I think for now I like this best because it doesn't change behaviour :)", "author": "original-brownbear", "createdAt": "2020-07-02T08:37:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODgxMDYwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg2MDA4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/58834#discussion_r448860089", "bodyText": "What do you think of passing a SnapshotInfo instance to the finalizeSnapshot() but update the end time of this one right before it's written to the repository?\nexecutor.execute(ActionRunnable.supply(allMetaListener, () -> {\n                final SnapshotInfo finalSnapshotInfo = SnapshotInfoBuilder.builder(snapshotInfo)\n                                .withEndTime(threadPool.absoluteTimeInMillis())\n                                .build();\n                snapshotFormat.write(snapshotInfo, blobContainer(), snapshotId.getUUID(), false);\n                return snapshotInfo;\n            }));", "author": "tlrx", "createdAt": "2020-07-02T09:08:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODgxMDYwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg2Mzc4OA==", "url": "https://github.com/elastic/elasticsearch/pull/58834#discussion_r448863788", "bodyText": "Hmm, then we still have some of the responsibility for setting up the correct SnapshotInfo in the blob store and repository implementations in general which I tried to avoid. But :)\nI just realized that my above comment doesn't make 100% sense these days ...  we are writing the SnapshotInfo concurrently to index metadata and global metadata blobs with no defined order so the timestamp in it isn't really 100% correct in the first place. And, even if we were to write it last it wouldn't be because we still have to do two CS updates and the write of the new index-N in between those afterwards.\n=> how about we just pass SnapshotInfo and not care about the precision of this timestamp since it can never be 100% correct anyway?", "author": "original-brownbear", "createdAt": "2020-07-02T09:14:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODgxMDYwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg2NDU5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/58834#discussion_r448864592", "bodyText": "Sold!", "author": "tlrx", "createdAt": "2020-07-02T09:16:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODgxMDYwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk2MTI3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/58834#discussion_r448961271", "bodyText": "Alrighty did this now :) Constructing SnapshotInfo in the snapshots service simplified things massively it turns out. See 123a0dd", "author": "original-brownbear", "createdAt": "2020-07-02T12:21:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODgxMDYwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "123a0dd73aa8e079d6373492a0c1cbcd70ed7082", "chunk": "diff --git a/plugins/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3Repository.java b/plugins/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3Repository.java\nindex a73c6d40d8f..58d3bf21594 100644\n--- a/plugins/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3Repository.java\n+++ b/plugins/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3Repository.java\n\n@@ -238,14 +236,14 @@ class S3Repository extends BlobStoreRepository {\n     private final AtomicReference<Scheduler.Cancellable> finalizationFuture = new AtomicReference<>();\n \n     @Override\n-    public void finalizeSnapshot(SnapshotId snapshotId, ShardGenerations shardGenerations, long repositoryStateId, Metadata clusterMetadata,\n-                                 Supplier<SnapshotInfo> buildSnapshotInfo, Version repositoryMetaVersion,\n+    public void finalizeSnapshot(ShardGenerations shardGenerations, long repositoryStateId, Metadata clusterMetadata,\n+                                 SnapshotInfo snapshotInfo, Version repositoryMetaVersion,\n                                  Function<ClusterState, ClusterState> stateTransformer,\n-                                 ActionListener<Tuple<RepositoryData, SnapshotInfo>> listener) {\n+                                 ActionListener<RepositoryData> listener) {\n         if (SnapshotsService.useShardGenerations(repositoryMetaVersion) == false) {\n             listener = delayedListener(listener);\n         }\n-        super.finalizeSnapshot(snapshotId, shardGenerations, repositoryStateId, clusterMetadata, buildSnapshotInfo, repositoryMetaVersion,\n+        super.finalizeSnapshot(shardGenerations, repositoryStateId, clusterMetadata, snapshotInfo, repositoryMetaVersion,\n             stateTransformer, listener);\n     }\n \n"}}, {"oid": "2ffc7d8e2f10910f87cf2ca202269b2b61295446", "url": "https://github.com/elastic/elasticsearch/commit/2ffc7d8e2f10910f87cf2ca202269b2b61295446", "message": "Merge remote-tracking branch 'elastic/master' into simplify-snapshot-finalization", "committedDate": "2020-07-02T09:51:23Z", "type": "commit"}, {"oid": "123a0dd73aa8e079d6373492a0c1cbcd70ed7082", "url": "https://github.com/elastic/elasticsearch/commit/123a0dd73aa8e079d6373492a0c1cbcd70ed7082", "message": "much simpler", "committedDate": "2020-07-02T12:20:43Z", "type": "commit"}]}