{"pr_number": 53803, "pr_title": "[ML] adds multi-class feature importance support", "pr_createdAt": "2020-03-19T14:42:06Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53803", "timeline": [{"oid": "15ae0c6859d4f117347cb419062438c8d2c17909", "url": "https://github.com/elastic/elasticsearch/commit/15ae0c6859d4f117347cb419062438c8d2c17909", "message": "[ML] adjusts feature importance format and adds multi-class importance support", "committedDate": "2020-03-19T13:06:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI0MzIwNA==", "url": "https://github.com/elastic/elasticsearch/pull/53803#discussion_r395243204", "bodyText": "I am not 100% convinced this should be abs.\nWe don't write the feature importance value on the native side by looking at the norm of the vector.\nDo we want to make this the norm too? Or do we thing abs is good enough?\n@tveasey @valeriy42", "author": "benwtrent", "createdAt": "2020-03-19T18:42:34Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/results/FeatureImportance.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.core.ml.inference.results;\n+\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+import org.elasticsearch.common.io.stream.Writeable;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+public class FeatureImportance implements Writeable {\n+\n+    private final Map<String, Double> classImportance;\n+    private final double importance;\n+    private final String featureName;\n+    private static final String IMPORTANCE = \"importance\";\n+    private static final String FEATURE_NAME = \"feature_name\";\n+\n+    public static FeatureImportance forRegression(String featureName, double importance) {\n+        return new FeatureImportance(featureName, importance, null);\n+    }\n+\n+    public static FeatureImportance forClassification(String featureName, Map<String, Double> classImportance) {\n+        return new FeatureImportance(featureName, classImportance.values().stream().mapToDouble(Math::abs).sum(), classImportance);", "originalCommit": "15ae0c6859d4f117347cb419062438c8d2c17909", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTU5NjY2OA==", "url": "https://github.com/elastic/elasticsearch/pull/53803#discussion_r395596668", "bodyText": "Can you please provide more context. What are you calculating here?", "author": "valeriy42", "createdAt": "2020-03-20T12:13:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI0MzIwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTYwOTI3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/53803#discussion_r395609273", "bodyText": "@valeriy42 @tveasey this is calculating the \"overall importance\" of all the classes combined for a given feature. This is so we can measure \"most important feature\" independent of the classes.", "author": "benwtrent", "createdAt": "2020-03-20T12:40:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI0MzIwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg2NzIwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/53803#discussion_r395867205", "bodyText": "norm would make it an L2 norm, abs makes it an L1 norm. Either way is suitable. I think, abs is better, since norm over-treats larger importances and ignores smaller once.", "author": "valeriy42", "createdAt": "2020-03-20T20:10:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI0MzIwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYyNTM4MQ==", "url": "https://github.com/elastic/elasticsearch/pull/53803#discussion_r396625381", "bodyText": "+1 abs", "author": "tveasey", "createdAt": "2020-03-23T17:25:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI0MzIwNA=="}], "type": "inlineReview", "revised_code": {"commit": "2adfbaf292f1501e8ebaf9970fe405542440be22", "chunk": "diff --git a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/results/FeatureImportance.java b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/results/FeatureImportance.java\nindex 02d888a3837..a6576a25e31 100644\n--- a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/results/FeatureImportance.java\n+++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/results/FeatureImportance.java\n\n@@ -41,7 +41,7 @@ public class FeatureImportance implements Writeable {\n         this.featureName = in.readString();\n         this.importance = in.readDouble();\n         if (in.readBoolean()) {\n-            this.classImportance = in.readLinkedHashMap(StreamInput::readString, StreamInput::readDouble);\n+            this.classImportance = in.readMap(StreamInput::readString, StreamInput::readDouble);\n         } else {\n             this.classImportance = null;\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUxMDM1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/53803#discussion_r396510351", "bodyText": "Is the abs necessary when the score is a norm? If the score can be -ve why is it wrong to use the -ve value?", "author": "davidkyle", "createdAt": "2020-03-23T14:52:51Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/results/SingleValueInferenceResults.java", "diffHunk": "@@ -8,45 +8,46 @@\n import org.elasticsearch.Version;\n import org.elasticsearch.common.io.stream.StreamInput;\n import org.elasticsearch.common.io.stream.StreamOutput;\n-import org.elasticsearch.xpack.core.ml.utils.ExceptionsHelper;\n \n import java.io.IOException;\n import java.util.Collections;\n-import java.util.LinkedHashMap;\n-import java.util.Map;\n+import java.util.List;\n+import java.util.stream.Collectors;\n \n public abstract class SingleValueInferenceResults implements InferenceResults {\n \n     private final double value;\n-    private final Map<String, Double> featureImportance;\n+    private final List<FeatureImportance> featureImportance;\n \n-    static Map<String, Double> takeTopFeatureImportances(Map<String, Double> unsortedFeatureImportances, int numTopFeatures) {\n-        return unsortedFeatureImportances.entrySet()\n-            .stream()\n-            .sorted((l, r)-> Double.compare(Math.abs(r.getValue()), Math.abs(l.getValue())))\n+    static List<FeatureImportance> takeTopFeatureImportances(List<FeatureImportance> unsortedFeatureImportances, int numTopFeatures) {\n+        if (unsortedFeatureImportances == null || unsortedFeatureImportances.isEmpty()) {\n+            return unsortedFeatureImportances;\n+        }\n+        return unsortedFeatureImportances.stream()\n+            .sorted((l, r)-> Double.compare(Math.abs(r.getImportance()), Math.abs(l.getImportance())))", "originalCommit": "15ae0c6859d4f117347cb419062438c8d2c17909", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYyMTAyMg==", "url": "https://github.com/elastic/elasticsearch/pull/53803#discussion_r396621022", "bodyText": "@davidkyle\nScore is not absolutely the norm. Additionally, we want to have the MOST influential values, regardless of direction. We could have feature importances like this:\n{\nA: -1.2,\nB: -0.2,\nC: 0.5\n}\n\nIf we want the top two influential features, we want A and C.\nThe getImportance is only the norm when it comes to multi-class. This is not the case for (logistic) regression.", "author": "benwtrent", "createdAt": "2020-03-23T17:19:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUxMDM1MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUxNDEzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/53803#discussion_r396514139", "bodyText": "// If the classificationLabels exist, the X better\nMissing word?", "author": "davidkyle", "createdAt": "2020-03-23T14:57:32Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/InferenceHelpers.java", "diffHunk": "@@ -100,18 +102,46 @@ public static Double toDouble(Object value) {\n         return null;\n     }\n \n-    public static Map<String, Double> decodeFeatureImportances(Map<String, String> processedFeatureToOriginalFeatureMap,\n-                                                               Map<String, Double> featureImportances) {\n+    public static Map<String, double[]> decodeFeatureImportances(Map<String, String> processedFeatureToOriginalFeatureMap,\n+                                                                 Map<String, double[]> featureImportances) {\n         if (processedFeatureToOriginalFeatureMap == null || processedFeatureToOriginalFeatureMap.isEmpty()) {\n             return featureImportances;\n         }\n \n-        Map<String, Double> originalFeatureImportance = new HashMap<>();\n+        Map<String, double[]> originalFeatureImportance = new HashMap<>();\n         featureImportances.forEach((feature, importance) -> {\n             String featureName = processedFeatureToOriginalFeatureMap.getOrDefault(feature, feature);\n-            originalFeatureImportance.compute(featureName, (f, v1) -> v1 == null ? importance : v1 + importance);\n+            originalFeatureImportance.compute(featureName, (f, v1) -> v1 == null ? importance : sumDoubleArrays(importance, v1));\n         });\n-\n         return originalFeatureImportance;\n     }\n+\n+    public static List<FeatureImportance> transformFeatureImportance(Map<String, double[]> featureImportance,\n+                                                                     @Nullable List<String> classificationLabels) {\n+        List<FeatureImportance> importances = new ArrayList<>(featureImportance.size());\n+        featureImportance.forEach((k, v) -> {\n+            // This indicates regression, or logistic regression\n+            // If the length > 1, we assume multi-class classification.\n+            if (v.length == 1) {\n+                importances.add(FeatureImportance.forRegression(k, v[0]));\n+            } else {\n+                Map<String, Double> classImportance = new LinkedHashMap<>(v.length, 1.0f);\n+                // If the classificationLabels exist, the better be the same length as the leaf values", "originalCommit": "15ae0c6859d4f117347cb419062438c8d2c17909", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYzMzk4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/53803#discussion_r396633983", "bodyText": "Def, this comment makes no sense :D", "author": "benwtrent", "createdAt": "2020-03-23T17:38:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUxNDEzOQ=="}], "type": "inlineReview", "revised_code": {"commit": "5fd61c2e782d003bb855c9a49dc8a49b91a40c28", "chunk": "diff --git a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/InferenceHelpers.java b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/InferenceHelpers.java\nindex 1ee1c0ef6f5..05b0693ac04 100644\n--- a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/InferenceHelpers.java\n+++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/InferenceHelpers.java\n\n@@ -126,7 +126,7 @@ public final class InferenceHelpers {\n                 importances.add(FeatureImportance.forRegression(k, v[0]));\n             } else {\n                 Map<String, Double> classImportance = new LinkedHashMap<>(v.length, 1.0f);\n-                // If the classificationLabels exist, the better be the same length as the leaf values\n+                // If the classificationLabels exist, their length must match leaf_value length\n                 assert classificationLabels == null || classificationLabels.size() == v.length;\n                 for (int i = 0; i < v.length; i++) {\n                     classImportance.put(classificationLabels == null ? String.valueOf(i) : classificationLabels.get(i), v[i]);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU0NTQ5NQ==", "url": "https://github.com/elastic/elasticsearch/pull/53803#discussion_r396545495", "bodyText": "I'm not sure why this has to be a linked hash map? I'm assuming to preserve insertion order but why? If this was ever serialisable to xcontent the ordering could not be guaranteed", "author": "davidkyle", "createdAt": "2020-03-23T15:38:23Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/results/FeatureImportance.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.core.ml.inference.results;\n+\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+import org.elasticsearch.common.io.stream.Writeable;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+public class FeatureImportance implements Writeable {\n+\n+    private final Map<String, Double> classImportance;\n+    private final double importance;\n+    private final String featureName;\n+    private static final String IMPORTANCE = \"importance\";\n+    private static final String FEATURE_NAME = \"feature_name\";\n+\n+    public static FeatureImportance forRegression(String featureName, double importance) {\n+        return new FeatureImportance(featureName, importance, null);\n+    }\n+\n+    public static FeatureImportance forClassification(String featureName, Map<String, Double> classImportance) {\n+        return new FeatureImportance(featureName, classImportance.values().stream().mapToDouble(Math::abs).sum(), classImportance);\n+    }\n+\n+    private FeatureImportance(String featureName, double importance, Map<String, Double> classImportance) {\n+        this.featureName = Objects.requireNonNull(featureName);\n+        this.importance = importance;\n+        this.classImportance = classImportance == null ? null : Collections.unmodifiableMap(classImportance);\n+    }\n+\n+    public FeatureImportance(StreamInput in) throws IOException {\n+        this.featureName = in.readString();\n+        this.importance = in.readDouble();\n+        if (in.readBoolean()) {\n+            this.classImportance = in.readLinkedHashMap(StreamInput::readString, StreamInput::readDouble);", "originalCommit": "15ae0c6859d4f117347cb419062438c8d2c17909", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYyMTc1OA==", "url": "https://github.com/elastic/elasticsearch/pull/53803#discussion_r396621758", "bodyText": "ToXContent does not factor here. We are concerned about the order when the values are written to the ingest document.", "author": "benwtrent", "createdAt": "2020-03-23T17:20:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU0NTQ5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY4MzkzNg==", "url": "https://github.com/elastic/elasticsearch/pull/53803#discussion_r396683936", "bodyText": "FWIW, this sort of thing is already done with Object maps. Just cannot do it with specific stream inputs.", "author": "benwtrent", "createdAt": "2020-03-23T18:55:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU0NTQ5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcxNzkwNg==", "url": "https://github.com/elastic/elasticsearch/pull/53803#discussion_r396717906", "bodyText": "Thinking about it more and looking more into the ingest doc code. I agree with you. This seems superfluous for now. If ordering becomes a concern for usability, we can add it in the future. The reading from the wire for both LinkedHashMap and HashMap would be exactly the same, so BWC is not a concern.", "author": "benwtrent", "createdAt": "2020-03-23T19:52:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU0NTQ5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "2adfbaf292f1501e8ebaf9970fe405542440be22", "chunk": "diff --git a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/results/FeatureImportance.java b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/results/FeatureImportance.java\nindex 02d888a3837..a6576a25e31 100644\n--- a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/results/FeatureImportance.java\n+++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/results/FeatureImportance.java\n\n@@ -41,7 +41,7 @@ public class FeatureImportance implements Writeable {\n         this.featureName = in.readString();\n         this.importance = in.readDouble();\n         if (in.readBoolean()) {\n-            this.classImportance = in.readLinkedHashMap(StreamInput::readString, StreamInput::readDouble);\n+            this.classImportance = in.readMap(StreamInput::readString, StreamInput::readDouble);\n         } else {\n             this.classImportance = null;\n         }\n"}}, {"oid": "5fd61c2e782d003bb855c9a49dc8a49b91a40c28", "url": "https://github.com/elastic/elasticsearch/commit/5fd61c2e782d003bb855c9a49dc8a49b91a40c28", "message": "Update InferenceHelpers.java", "committedDate": "2020-03-23T17:45:42Z", "type": "commit"}, {"oid": "263220583fd80213e5ea13affee9915bb9114f89", "url": "https://github.com/elastic/elasticsearch/commit/263220583fd80213e5ea13affee9915bb9114f89", "message": "Merge branch 'master' into feature/ml-inference-multi-class-feature-importance", "committedDate": "2020-03-23T19:32:09Z", "type": "commit"}, {"oid": "2adfbaf292f1501e8ebaf9970fe405542440be22", "url": "https://github.com/elastic/elasticsearch/commit/2adfbaf292f1501e8ebaf9970fe405542440be22", "message": "removing the read in linked hashmap", "committedDate": "2020-03-23T19:38:16Z", "type": "commit"}, {"oid": "47b42255921d1b668f9e9caabbe64d74419ed119", "url": "https://github.com/elastic/elasticsearch/commit/47b42255921d1b668f9e9caabbe64d74419ed119", "message": "Merge branch 'feature/ml-inference-multi-class-feature-importance' of github.com:benwtrent/elasticsearch into feature/ml-inference-multi-class-feature-importance", "committedDate": "2020-03-23T19:38:29Z", "type": "commit"}, {"oid": "fcf853aa383aa990244d4ea7a32359fcb6cdee90", "url": "https://github.com/elastic/elasticsearch/commit/fcf853aa383aa990244d4ea7a32359fcb6cdee90", "message": "Merge branch 'master' into feature/ml-inference-multi-class-feature-importance", "committedDate": "2020-03-23T19:51:26Z", "type": "commit"}]}