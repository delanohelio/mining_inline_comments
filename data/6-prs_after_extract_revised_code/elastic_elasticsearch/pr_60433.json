{"pr_number": 60433, "pr_title": "Enhance the ingest node simulate verbose output ", "pr_createdAt": "2020-07-29T22:45:49Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/60433", "timeline": [{"oid": "a8a9d877ff8cc54e239d5a7d261b88f6d814e6d8", "url": "https://github.com/elastic/elasticsearch/commit/a8a9d877ff8cc54e239d5a7d261b88f6d814e6d8", "message": "Per processor description for verbose simulate\n\nFor ingest node processors a per processor description\nwas recently added. This commit displays that description\nin the verbose output of the pipeline simulation.\n\nrelated #57906", "committedDate": "2020-06-16T22:27:45Z", "type": "commit"}, {"oid": "6078c45258af12bcaf8e561333b25b0de67909df", "url": "https://github.com/elastic/elasticsearch/commit/6078c45258af12bcaf8e561333b25b0de67909df", "message": "wip", "committedDate": "2020-06-17T22:48:34Z", "type": "commit"}, {"oid": "aacbf21ed5524202d3b07562322689191d8bcc20", "url": "https://github.com/elastic/elasticsearch/commit/aacbf21ed5524202d3b07562322689191d8bcc20", "message": "Merge branch 'master' into show_conditional", "committedDate": "2020-07-21T16:55:58Z", "type": "commit"}, {"oid": "c5498e030298de271f7928ef3943500bb54d485d", "url": "https://github.com/elastic/elasticsearch/commit/c5498e030298de271f7928ef3943500bb54d485d", "message": "Merge remote-tracking branch 'upstream/master' into show_conditional", "committedDate": "2020-07-21T19:52:16Z", "type": "commit"}, {"oid": "12979f669592f5020eb77f520ad769e3dd644a41", "url": "https://github.com/elastic/elasticsearch/commit/12979f669592f5020eb77f520ad769e3dd644a41", "message": "tests pass", "committedDate": "2020-07-29T15:57:57Z", "type": "commit"}, {"oid": "0e991b4171bc989bb10cf9f84dc9a790fb684d26", "url": "https://github.com/elastic/elasticsearch/commit/0e991b4171bc989bb10cf9f84dc9a790fb684d26", "message": "Merge branch 'master' into show_conditional", "committedDate": "2020-07-29T15:59:47Z", "type": "commit"}, {"oid": "cf599eef92243257e9518e5217ebcc9701e33bb3", "url": "https://github.com/elastic/elasticsearch/commit/cf599eef92243257e9518e5217ebcc9701e33bb3", "message": "serialization fixes", "committedDate": "2020-07-29T17:22:28Z", "type": "commit"}, {"oid": "fbfc56644ad3050df5cd1648f221321de3c8a95b", "url": "https://github.com/elastic/elasticsearch/commit/fbfc56644ad3050df5cd1648f221321de3c8a95b", "message": "test status", "committedDate": "2020-07-29T17:40:30Z", "type": "commit"}, {"oid": "4441ff3ebf4909b014891ca3807dad9cbccb5937", "url": "https://github.com/elastic/elasticsearch/commit/4441ff3ebf4909b014891ca3807dad9cbccb5937", "message": "minor clean up", "committedDate": "2020-07-29T17:55:20Z", "type": "commit"}, {"oid": "5a581610df20e36112db4d75bddfc26d05a6f91f", "url": "https://github.com/elastic/elasticsearch/commit/5a581610df20e36112db4d75bddfc26d05a6f91f", "message": "minor testing", "committedDate": "2020-07-29T18:42:56Z", "type": "commit"}, {"oid": "db354e4ceafec487f2c14bc75df2b099ae8f76f5", "url": "https://github.com/elastic/elasticsearch/commit/db354e4ceafec487f2c14bc75df2b099ae8f76f5", "message": "fix showing of pipeline processor", "committedDate": "2020-07-29T21:34:55Z", "type": "commit"}, {"oid": "c97e5ab6bfe26dbc7a361ef6446a9bebcf43da65", "url": "https://github.com/elastic/elasticsearch/commit/c97e5ab6bfe26dbc7a361ef6446a9bebcf43da65", "message": "precomit", "committedDate": "2020-07-29T21:41:50Z", "type": "commit"}, {"oid": "e1a65e5fa499a6279c9800ce15a7dfbd890f5b00", "url": "https://github.com/elastic/elasticsearch/commit/e1a65e5fa499a6279c9800ce15a7dfbd890f5b00", "message": "handle non-existant pipeline", "committedDate": "2020-07-29T22:41:01Z", "type": "commit"}, {"oid": "2b1f3da8c848ae0ce9a6822dc2de3057c8228b17", "url": "https://github.com/elastic/elasticsearch/commit/2b1f3da8c848ae0ce9a6822dc2de3057c8228b17", "message": "fix existing yaml tests", "committedDate": "2020-07-30T00:12:39Z", "type": "commit"}, {"oid": "79bb3fbb19a33ffa6aed17a8d7051625c5d6c680", "url": "https://github.com/elastic/elasticsearch/commit/79bb3fbb19a33ffa6aed17a8d7051625c5d6c680", "message": "add no pipeline test", "committedDate": "2020-07-30T00:30:09Z", "type": "commit"}, {"oid": "a829e38df52bef36497550af524255a4d72e925f", "url": "https://github.com/elastic/elasticsearch/commit/a829e38df52bef36497550af524255a4d72e925f", "message": "add a bit of coverage", "committedDate": "2020-07-30T00:56:02Z", "type": "commit"}, {"oid": "374b7ae44efc0149a08094d749a85c6ce92baba9", "url": "https://github.com/elastic/elasticsearch/commit/374b7ae44efc0149a08094d749a85c6ce92baba9", "message": "Merge remote-tracking branch 'upstream/master' into show_conditional", "committedDate": "2020-07-30T00:56:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY3MzYyNQ==", "url": "https://github.com/elastic/elasticsearch/pull/60433#discussion_r462673625", "bodyText": "I think we never added the pipeline processor in the past because there would have been nothing to display, but now that we always show the type (pipeline) and status (i.e. success) there is something to display, so this line is what adds this to the output. The addition of this output caused a few tests to need to be updated", "author": "jakelandis", "createdAt": "2020-07-30T01:02:02Z", "path": "server/src/main/java/org/elasticsearch/ingest/TrackingResultProcessor.java", "diffHunk": "@@ -58,24 +65,32 @@ public void execute(IngestDocument ingestDocument, BiConsumer<IngestDocument, Ex\n             Pipeline pipeline = pipelineProcessor.getPipeline(ingestDocument);\n             //runtime check for cycles against a copy of the document. This is needed to properly handle conditionals around pipelines\n             IngestDocument ingestDocumentCopy = new IngestDocument(ingestDocument);\n-            ingestDocumentCopy.executePipeline(pipelineProcessor.getPipeline(ingestDocument), (result, e) -> {\n+            Pipeline pipelineToCall = pipelineProcessor.getPipeline(ingestDocument);\n+            if (pipelineToCall == null) {\n+                throw new IllegalArgumentException(\"Pipeline processor configured for non-existent pipeline [\" +\n+                    pipelineProcessor.getPipelineToCallName(ingestDocument) + ']');\n+            }\n+            ingestDocumentCopy.executePipeline(pipelineToCall, (result, e) -> {\n                 // do nothing, let the tracking processors throw the exception while recording the path up to the failure\n                 if (e instanceof ElasticsearchException) {\n                     ElasticsearchException elasticsearchException = (ElasticsearchException) e;\n                     //else do nothing, let the tracking processors throw the exception while recording the path up to the failure\n                     if (elasticsearchException.getCause() instanceof IllegalStateException) {\n                         if (ignoreFailure) {\n-                            processorResultList.add(new SimulateProcessorResult(pipelineProcessor.getTag(),\n-                                pipelineProcessor.getDescription(), new IngestDocument(ingestDocument), e));\n+                            processorResultList.add(new SimulateProcessorResult(pipelineProcessor.getType(), pipelineProcessor.getTag(),\n+                                pipelineProcessor.getDescription(), new IngestDocument(ingestDocument), e, conditionalWithResult));\n                         } else {\n-                            processorResultList.add(new SimulateProcessorResult(pipelineProcessor.getTag(),\n-                                pipelineProcessor.getDescription(), e));\n+                            processorResultList.add(new SimulateProcessorResult(pipelineProcessor.getType(), pipelineProcessor.getTag(),\n+                                pipelineProcessor.getDescription(), e, conditionalWithResult));\n                         }\n                         handler.accept(null, elasticsearchException);\n                     }\n                 } else {\n                     //now that we know that there are no cycles between pipelines, decorate the processors for this pipeline and execute it\n                     CompoundProcessor verbosePipelineProcessor = decorate(pipeline.getCompoundProcessor(), null, processorResultList);\n+                    //add the pipeline process to the results\n+                    processorResultList.add(new SimulateProcessorResult(actualProcessor.getType(), actualProcessor.getTag(),\n+                        actualProcessor.getDescription(), conditionalWithResult));", "originalCommit": "374b7ae44efc0149a08094d749a85c6ce92baba9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5c26a6b13ffe2500ce1fb8054a7fd97417e984e4", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/ingest/TrackingResultProcessor.java b/server/src/main/java/org/elasticsearch/ingest/TrackingResultProcessor.java\nindex df1873c25af..b819230a74b 100644\n--- a/server/src/main/java/org/elasticsearch/ingest/TrackingResultProcessor.java\n+++ b/server/src/main/java/org/elasticsearch/ingest/TrackingResultProcessor.java\n\n@@ -48,16 +47,19 @@ public final class TrackingResultProcessor implements Processor {\n \n     @Override\n     public void execute(IngestDocument ingestDocument, BiConsumer<IngestDocument, Exception> handler) {\n-        if (conditionalProcessor != null ) {\n+        Tuple<String, Boolean> conditionalWithResult;\n+        if (conditionalProcessor != null) {\n             if (conditionalProcessor.evaluate(ingestDocument) == false) {\n                 conditionalWithResult = new Tuple<>(conditionalProcessor.getCondition(), Boolean.FALSE);\n                 processorResultList.add(new SimulateProcessorResult(actualProcessor.getType(), actualProcessor.getTag(),\n                     actualProcessor.getDescription(), conditionalWithResult));\n                 handler.accept(ingestDocument, null);\n                 return;\n-            } else{\n+            } else {\n                 conditionalWithResult = new Tuple<>(conditionalProcessor.getCondition(), Boolean.TRUE);\n             }\n+        } else {\n+            conditionalWithResult = null; //no condition\n         }\n \n         if (actualProcessor instanceof PipelineProcessor) {\n"}}, {"oid": "cb3d4a02d9210e466c067a3d36fde9cd03e3b4bb", "url": "https://github.com/elastic/elasticsearch/commit/cb3d4a02d9210e466c067a3d36fde9cd03e3b4bb", "message": "fix doc test", "committedDate": "2020-07-30T01:29:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTExMTc3Ng==", "url": "https://github.com/elastic/elasticsearch/pull/60433#discussion_r465111776", "bodyText": "Seems like this could be a local variable in the execute function?", "author": "jbaiera", "createdAt": "2020-08-04T14:53:31Z", "path": "server/src/main/java/org/elasticsearch/ingest/TrackingResultProcessor.java", "diffHunk": "@@ -35,6 +36,7 @@\n     private final ConditionalProcessor conditionalProcessor;\n     private final List<SimulateProcessorResult> processorResultList;\n     private final boolean ignoreFailure;\n+    private Tuple<String, Boolean> conditionalWithResult = null; //null = no conditional", "originalCommit": "cb3d4a02d9210e466c067a3d36fde9cd03e3b4bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTE3MzQ0Mg==", "url": "https://github.com/elastic/elasticsearch/pull/60433#discussion_r465173442", "bodyText": "thanks @jbaiera , indeed. updated 5c26a6b", "author": "jakelandis", "createdAt": "2020-08-04T16:22:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTExMTc3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "5c26a6b13ffe2500ce1fb8054a7fd97417e984e4", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/ingest/TrackingResultProcessor.java b/server/src/main/java/org/elasticsearch/ingest/TrackingResultProcessor.java\nindex df1873c25af..b819230a74b 100644\n--- a/server/src/main/java/org/elasticsearch/ingest/TrackingResultProcessor.java\n+++ b/server/src/main/java/org/elasticsearch/ingest/TrackingResultProcessor.java\n\n@@ -36,7 +36,6 @@ public final class TrackingResultProcessor implements Processor {\n     private final ConditionalProcessor conditionalProcessor;\n     private final List<SimulateProcessorResult> processorResultList;\n     private final boolean ignoreFailure;\n-    private Tuple<String, Boolean> conditionalWithResult = null; //null = no conditional\n \n     TrackingResultProcessor(boolean ignoreFailure, Processor actualProcessor, ConditionalProcessor conditionalProcessor,\n                             List<SimulateProcessorResult> processorResultList) {\n"}}, {"oid": "5c26a6b13ffe2500ce1fb8054a7fd97417e984e4", "url": "https://github.com/elastic/elasticsearch/commit/5c26a6b13ffe2500ce1fb8054a7fd97417e984e4", "message": "use local variable", "committedDate": "2020-08-04T16:20:58Z", "type": "commit"}, {"oid": "dc93ec3b83485991293287185b9c6c0720b61228", "url": "https://github.com/elastic/elasticsearch/commit/dc93ec3b83485991293287185b9c6c0720b61228", "message": "Merge remote-tracking branch 'upstream/master' into show_conditional", "committedDate": "2020-08-04T16:21:15Z", "type": "commit"}]}