{"pr_number": 55328, "pr_title": "Add geo_bounds aggregation support for geo_shape", "pr_createdAt": "2020-04-16T16:42:14Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55328", "timeline": [{"oid": "f953e1a67414000d967606d1c8b35f5bf06826b1", "url": "https://github.com/elastic/elasticsearch/commit/f953e1a67414000d967606d1c8b35f5bf06826b1", "message": "add geo_bounds for shapes", "committedDate": "2020-04-16T16:30:49Z", "type": "commit"}, {"oid": "1ef925cd78cf4cb4cba69b59527fe102d3282cc7", "url": "https://github.com/elastic/elasticsearch/commit/1ef925cd78cf4cb4cba69b59527fe102d3282cc7", "message": "add yaml tests", "committedDate": "2020-04-17T00:49:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkzNDE4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/55328#discussion_r409934189", "bodyText": "@iverase I really dislike this hack, but I am also weary of editing GeoBoundsAggregator to be more generic just for this extension. I might take another pass at this tomorrow", "author": "talevy", "createdAt": "2020-04-17T01:04:55Z", "path": "x-pack/plugin/spatial/src/main/java/org/elasticsearch/xpack/spatial/aggregations/metrics/GeoShapeBoundsAggregator.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.spatial.aggregations.metrics;\n+\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.elasticsearch.common.util.BigArrays;\n+import org.elasticsearch.search.aggregations.Aggregator;\n+import org.elasticsearch.search.aggregations.LeafBucketCollector;\n+import org.elasticsearch.search.aggregations.LeafBucketCollectorBase;\n+import org.elasticsearch.search.aggregations.metrics.GeoBoundsAggregator;\n+import org.elasticsearch.search.aggregations.support.ValuesSource;\n+import org.elasticsearch.search.internal.SearchContext;\n+import org.elasticsearch.xpack.spatial.index.mapper.GeoShapeValuesSource;\n+import org.elasticsearch.xpack.spatial.index.mapper.MultiGeoShapeValues;\n+\n+import java.io.IOException;\n+import java.util.Map;\n+\n+public final class GeoShapeBoundsAggregator extends GeoBoundsAggregator {\n+    private final GeoShapeValuesSource valuesSource;\n+\n+    public GeoShapeBoundsAggregator(String name, SearchContext aggregationContext, Aggregator parent,\n+                             GeoShapeValuesSource valuesSource, boolean wrapLongitude, Map<String, Object> metadata) throws IOException {\n+        // the valuesSource as GeoPoint passed to GeoBoundsAggregator is not used\n+        super(name, aggregationContext, parent, ValuesSource.GeoPoint.EMPTY, wrapLongitude, metadata);", "originalCommit": "1ef925cd78cf4cb4cba69b59527fe102d3282cc7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDA5Mjk4NA==", "url": "https://github.com/elastic/elasticsearch/pull/55328#discussion_r410092984", "bodyText": "Yes, it seems that GeoBoundsAggregator should be an abstract class and then having two implementations one for points and one for shapes?\nAnother thing I notice is that there is special logic when valueSource == null, cannot we have an empty bounds aggregation that is returned in that case when calling the register?", "author": "iverase", "createdAt": "2020-04-17T09:07:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkzNDE4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTA4NDYwMw==", "url": "https://github.com/elastic/elasticsearch/pull/55328#discussion_r411084603", "bodyText": "I believe what will need to happen is that I make ValuesSource.GEOPOINT abstract as was done in  the previous branch. but it is not needed for the GeoBounds aggregator. may happen for the GeoGrid. to help resolve the CellIdSource work. For now, I prefer to have duplicate code and inherit from MetricsAggregator instead of GeoShapeAggregator and undo this hack", "author": "talevy", "createdAt": "2020-04-20T04:27:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkzNDE4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU1MzIyMA==", "url": "https://github.com/elastic/elasticsearch/pull/55328#discussion_r411553220", "bodyText": "For now, I prefer to have duplicate code and inherit from MetricsAggregator\n\nHaving duplicate code seems to increase the likelihood these diverge, which would mean inconsistent behavior across oss and default distributions right? IMO in order to keep the behavior consistent, modeling all the default distribution overrides as pure subclasses of oss will minimize the possibility the implementations diverge.", "author": "rjernst", "createdAt": "2020-04-20T17:19:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkzNDE4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU2MDk4NA==", "url": "https://github.com/elastic/elasticsearch/pull/55328#discussion_r411560984", "bodyText": "hmmm. OK. I have been a little resistant to introducing abstractions in server that only have one implementation in server. I'll overcome this and re-introduce the generic valuessource type. This should re-enable more proper inheritance here.", "author": "talevy", "createdAt": "2020-04-20T17:31:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkzNDE4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTcxNjc2Mw==", "url": "https://github.com/elastic/elasticsearch/pull/55328#discussion_r411716763", "bodyText": "after speaking with Ryan on videochat, we realized that we were misunderstanding one another. We are not duplicating the whole aggregation, but instead just the aggregator logic. We decided that this is acceptable and I'll continue with this approach. There will be some boilerplate that can be shared between, but that does not warrant any hackery", "author": "talevy", "createdAt": "2020-04-20T21:51:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkzNDE4OQ=="}], "type": "inlineReview", "revised_code": {"commit": "20ec976b71ead310369f1cf3dcb56c18d8bacb79", "chunk": "diff --git a/x-pack/plugin/spatial/src/main/java/org/elasticsearch/xpack/spatial/aggregations/metrics/GeoShapeBoundsAggregator.java b/x-pack/plugin/spatial/src/main/java/org/elasticsearch/xpack/spatial/aggregations/metrics/GeoShapeBoundsAggregator.java\nindex 3da126b4524..0911cbfc2d2 100644\n--- a/x-pack/plugin/spatial/src/main/java/org/elasticsearch/xpack/spatial/aggregations/metrics/GeoShapeBoundsAggregator.java\n+++ b/x-pack/plugin/spatial/src/main/java/org/elasticsearch/xpack/spatial/aggregations/metrics/GeoShapeBoundsAggregator.java\n\n@@ -7,12 +7,15 @@\n package org.elasticsearch.xpack.spatial.aggregations.metrics;\n \n import org.apache.lucene.index.LeafReaderContext;\n+import org.elasticsearch.common.lease.Releasables;\n import org.elasticsearch.common.util.BigArrays;\n+import org.elasticsearch.common.util.DoubleArray;\n import org.elasticsearch.search.aggregations.Aggregator;\n+import org.elasticsearch.search.aggregations.InternalAggregation;\n import org.elasticsearch.search.aggregations.LeafBucketCollector;\n import org.elasticsearch.search.aggregations.LeafBucketCollectorBase;\n-import org.elasticsearch.search.aggregations.metrics.GeoBoundsAggregator;\n-import org.elasticsearch.search.aggregations.support.ValuesSource;\n+import org.elasticsearch.search.aggregations.metrics.InternalGeoBounds;\n+import org.elasticsearch.search.aggregations.metrics.MetricsAggregator;\n import org.elasticsearch.search.internal.SearchContext;\n import org.elasticsearch.xpack.spatial.index.mapper.GeoShapeValuesSource;\n import org.elasticsearch.xpack.spatial.index.mapper.MultiGeoShapeValues;\n"}}, {"oid": "9e723014e3ba15e503fdc8db89cb11b9feb256e2", "url": "https://github.com/elastic/elasticsearch/commit/9e723014e3ba15e503fdc8db89cb11b9feb256e2", "message": "fix", "committedDate": "2020-04-17T01:13:32Z", "type": "commit"}, {"oid": "0491b5f6b4b896405980f3e1f366b987e3f5edd5", "url": "https://github.com/elastic/elasticsearch/commit/0491b5f6b4b896405980f3e1f366b987e3f5edd5", "message": "Merge remote-tracking branch 'elastic/master' into geo_bounds2", "committedDate": "2020-04-17T22:37:24Z", "type": "commit"}, {"oid": "20ec976b71ead310369f1cf3dcb56c18d8bacb79", "url": "https://github.com/elastic/elasticsearch/commit/20ec976b71ead310369f1cf3dcb56c18d8bacb79", "message": "inherit from MetricsAggregator and fix tests", "committedDate": "2020-04-20T05:25:00Z", "type": "commit"}, {"oid": "2548f967d151ddcc1acb73baf290ae496fd8d113", "url": "https://github.com/elastic/elasticsearch/commit/2548f967d151ddcc1acb73baf290ae496fd8d113", "message": "revert the upgraded cluster skipping tests", "committedDate": "2020-04-20T22:08:58Z", "type": "commit"}, {"oid": "968a0846cbf2f5bb8c15d484aa6f62362d4ed23f", "url": "https://github.com/elastic/elasticsearch/commit/968a0846cbf2f5bb8c15d484aa6f62362d4ed23f", "message": "Merge remote-tracking branch 'elastic/master' into geo_bounds2", "committedDate": "2020-04-20T23:14:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjc2NjQyMA==", "url": "https://github.com/elastic/elasticsearch/pull/55328#discussion_r412766420", "bodyText": "Does it need to be public?", "author": "iverase", "createdAt": "2020-04-22T08:09:47Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/metrics/GeoBoundsAggregator.java", "diffHunk": "@@ -36,20 +36,20 @@\n import java.io.IOException;\n import java.util.Map;\n \n-final class GeoBoundsAggregator extends MetricsAggregator {\n+public class GeoBoundsAggregator extends MetricsAggregator {", "originalCommit": "968a0846cbf2f5bb8c15d484aa6f62362d4ed23f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzAwMDczMA==", "url": "https://github.com/elastic/elasticsearch/pull/55328#discussion_r413000730", "bodyText": "no. this was left from when I tried to inherit from GeoBoundsAggregator.\nI've reverted this file to how it was in master, and fixed some other protected instance variables to be private. good catch. thanks!", "author": "talevy", "createdAt": "2020-04-22T13:50:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjc2NjQyMA=="}], "type": "inlineReview", "revised_code": {"commit": "e4b30d44529596cb4212d45c957d1209ac5248f0", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/search/aggregations/metrics/GeoBoundsAggregator.java b/server/src/main/java/org/elasticsearch/search/aggregations/metrics/GeoBoundsAggregator.java\nindex dfde53a719d..9a76873aaea 100644\n--- a/server/src/main/java/org/elasticsearch/search/aggregations/metrics/GeoBoundsAggregator.java\n+++ b/server/src/main/java/org/elasticsearch/search/aggregations/metrics/GeoBoundsAggregator.java\n\n@@ -36,20 +36,20 @@ import org.elasticsearch.search.internal.SearchContext;\n import java.io.IOException;\n import java.util.Map;\n \n-public class GeoBoundsAggregator extends MetricsAggregator {\n+final class GeoBoundsAggregator extends MetricsAggregator {\n \n-    public static final ParseField WRAP_LONGITUDE_FIELD = new ParseField(\"wrap_longitude\");\n+    static final ParseField WRAP_LONGITUDE_FIELD = new ParseField(\"wrap_longitude\");\n \n     private final ValuesSource.GeoPoint valuesSource;\n     private final boolean wrapLongitude;\n-    protected DoubleArray tops;\n-    protected DoubleArray bottoms;\n-    protected DoubleArray posLefts;\n-    protected DoubleArray posRights;\n-    protected DoubleArray negLefts;\n-    protected DoubleArray negRights;\n+    DoubleArray tops;\n+    DoubleArray bottoms;\n+    DoubleArray posLefts;\n+    DoubleArray posRights;\n+    DoubleArray negLefts;\n+    DoubleArray negRights;\n \n-    public GeoBoundsAggregator(String name, SearchContext aggregationContext, Aggregator parent,\n+    GeoBoundsAggregator(String name, SearchContext aggregationContext, Aggregator parent,\n             ValuesSource.GeoPoint valuesSource, boolean wrapLongitude, Map<String, Object> metadata) throws IOException {\n         super(name, aggregationContext, parent, metadata);\n         this.valuesSource = valuesSource;\n"}}, {"oid": "e4b30d44529596cb4212d45c957d1209ac5248f0", "url": "https://github.com/elastic/elasticsearch/commit/e4b30d44529596cb4212d45c957d1209ac5248f0", "message": "remove bwc tests to be merged in 7.x. fix scoping", "committedDate": "2020-04-22T13:49:21Z", "type": "commit"}, {"oid": "a77692c52d6393dcac55dfe3079cb252351d2705", "url": "https://github.com/elastic/elasticsearch/commit/a77692c52d6393dcac55dfe3079cb252351d2705", "message": "Merge remote-tracking branch 'elastic/master' into geo_bounds2", "committedDate": "2020-04-22T13:49:27Z", "type": "commit"}]}