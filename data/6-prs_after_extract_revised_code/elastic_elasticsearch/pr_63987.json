{"pr_number": 63987, "pr_title": "Hidden data streams", "pr_createdAt": "2020-10-21T11:34:25Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63987", "timeline": [{"oid": "d7f05a1c9e8b2388053ccc19af4837a7755282e2", "url": "https://github.com/elastic/elasticsearch/commit/d7f05a1c9e8b2388053ccc19af4837a7755282e2", "message": "Hidden data streams", "committedDate": "2020-10-21T10:54:44Z", "type": "commit"}, {"oid": "b182d368e25d0b4122f311e39ffb74407f7c3045", "url": "https://github.com/elastic/elasticsearch/commit/b182d368e25d0b4122f311e39ffb74407f7c3045", "message": "whitespace reverted", "committedDate": "2020-10-21T11:00:48Z", "type": "commit"}, {"oid": "100dba5f3c9561a2e8bc5c52bffa5881c114b6c7", "url": "https://github.com/elastic/elasticsearch/commit/100dba5f3c9561a2e8bc5c52bffa5881c114b6c7", "message": "stricter ds name", "committedDate": "2020-10-21T11:27:29Z", "type": "commit"}, {"oid": "0d778f54aa069ed0763122630dcf6d41da48ccd2", "url": "https://github.com/elastic/elasticsearch/commit/0d778f54aa069ed0763122630dcf6d41da48ccd2", "message": "Revert \"stricter ds name\"\n\nThis reverts commit 100dba5f3c9561a2e8bc5c52bffa5881c114b6c7.", "committedDate": "2020-10-21T11:30:04Z", "type": "commit"}, {"oid": "98e45c5229ed6dc52a4ad04f430c3256d8ef2c39", "url": "https://github.com/elastic/elasticsearch/commit/98e45c5229ed6dc52a4ad04f430c3256d8ef2c39", "message": "String.format removed", "committedDate": "2020-10-21T11:55:28Z", "type": "commit"}, {"oid": "cf74871a0b506ee4264a5ff3e33c27cfb2bbf113", "url": "https://github.com/elastic/elasticsearch/commit/cf74871a0b506ee4264a5ff3e33c27cfb2bbf113", "message": "fix test", "committedDate": "2020-10-21T15:00:03Z", "type": "commit"}, {"oid": "a856a8f464f82f397319fbece6c95154fca51c87", "url": "https://github.com/elastic/elasticsearch/commit/a856a8f464f82f397319fbece6c95154fca51c87", "message": "fix GetDataStream action", "committedDate": "2020-10-21T21:44:47Z", "type": "commit"}, {"oid": "4a0e20d82c30988faacead6b4eb9b7d018655a11", "url": "https://github.com/elastic/elasticsearch/commit/4a0e20d82c30988faacead6b4eb9b7d018655a11", "message": "fix test", "committedDate": "2020-10-22T10:25:43Z", "type": "commit"}, {"oid": "19af04d6bdfa19eb5fd802f44ecdb9596adaa45d", "url": "https://github.com/elastic/elasticsearch/commit/19af04d6bdfa19eb5fd802f44ecdb9596adaa45d", "message": "fix test", "committedDate": "2020-10-22T10:47:02Z", "type": "commit"}, {"oid": "5b940396e55367fa7013b2f758c2240d68b14d10", "url": "https://github.com/elastic/elasticsearch/commit/5b940396e55367fa7013b2f758c2240d68b14d10", "message": "rest test", "committedDate": "2020-10-22T11:52:09Z", "type": "commit"}, {"oid": "44415330000762b72aa94ccab65141524f75be54", "url": "https://github.com/elastic/elasticsearch/commit/44415330000762b72aa94ccab65141524f75be54", "message": "rest test", "committedDate": "2020-10-22T12:09:32Z", "type": "commit"}, {"oid": "404d3417b3a38fb52cce82a31540c4eb6a3fc4c0", "url": "https://github.com/elastic/elasticsearch/commit/404d3417b3a38fb52cce82a31540c4eb6a3fc4c0", "message": "spotless", "committedDate": "2020-10-22T14:51:34Z", "type": "commit"}, {"oid": "0059e16b4cc949c13c040a3ef2581862fdd5bfd2", "url": "https://github.com/elastic/elasticsearch/commit/0059e16b4cc949c13c040a3ef2581862fdd5bfd2", "message": "tests", "committedDate": "2020-10-22T20:23:46Z", "type": "commit"}, {"oid": "2c540befc03fd767a3efb74a56865a6e7467f211", "url": "https://github.com/elastic/elasticsearch/commit/2c540befc03fd767a3efb74a56865a6e7467f211", "message": "Merge remote-tracking branch 'origin/master' into hidden-data-streams", "committedDate": "2020-10-22T20:26:10Z", "type": "commit"}, {"oid": "54dddc4c27590407e731c7cfade5427e33d9fdcb", "url": "https://github.com/elastic/elasticsearch/commit/54dddc4c27590407e731c7cfade5427e33d9fdcb", "message": "Delete a.json", "committedDate": "2020-10-22T21:49:14Z", "type": "commit"}, {"oid": "63c0702224915b8186632c57a11976c9776626dc", "url": "https://github.com/elastic/elasticsearch/commit/63c0702224915b8186632c57a11976c9776626dc", "message": "added expand_wildcards for GetDataStream and DeleteDataStream", "committedDate": "2020-10-26T10:42:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg1Mzg4MA==", "url": "https://github.com/elastic/elasticsearch/pull/63987#discussion_r511853880", "bodyText": "I feel that reusing the index.hidden setting is adding ambiguity to the setting, since it will then be controlling whether an index is hidden or data stream depending on the context how it is being used.\nI would prefer that a data stream can be made hidden via the data_stream section of a composable index template. I think this way it is clearer what is being made hidden. Currently DataStreamTemplate is empty, but I think we will be adding more configuration options that are data stream specific later (e.g. timestamp field name).\nNote that aliases are also made hidden via a property on an alias instead of reusing the index.hidden setting. So making data stream hidden via a parameter on DataStreamTemplate is inline how aliases\ncan be made hidden.\nLet me know what you think. I think this change would be a minor change to this PR.", "author": "martijnvg", "createdAt": "2020-10-26T10:21:41Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java", "diffHunk": "@@ -156,9 +157,11 @@ static ClusterState createDataStream(MetadataCreateIndexService metadataCreateIn\n         assert firstBackingIndex != null;\n         assert firstBackingIndex.mapping() != null : \"no mapping found for backing index [\" + firstBackingIndexName + \"]\";\n \n-        String fieldName = template.getDataStreamTemplate().getTimestampField();\n+        String fieldName = composableTemplate.getDataStreamTemplate().getTimestampField();\n         DataStream.TimestampField timestampField = new DataStream.TimestampField(fieldName);\n-        DataStream newDataStream = new DataStream(request.name, timestampField, List.of(firstBackingIndex.getIndex()));\n+        Template template = composableTemplate.template();\n+        boolean hidden = template != null && template.settings() != null && IndexMetadata.INDEX_HIDDEN_SETTING.get(template.settings());", "originalCommit": "54dddc4c27590407e731c7cfade5427e33d9fdcb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg3Mzk4NA==", "url": "https://github.com/elastic/elasticsearch/pull/63987#discussion_r511873984", "bodyText": "That makes sense, I'll change it", "author": "probakowski", "createdAt": "2020-10-26T10:55:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg1Mzg4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU4NzcyNA==", "url": "https://github.com/elastic/elasticsearch/pull/63987#discussion_r512587724", "bodyText": "It's done, now it uses data_stream part of a template\n\"data_stream\": {\n    \"hidden\": true\n}", "author": "probakowski", "createdAt": "2020-10-27T10:49:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg1Mzg4MA=="}], "type": "inlineReview", "revised_code": {"commit": "4e71b539b8fe85a442af9d4f0119b97a5b92e707", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java b/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java\nindex 3e9d3497d7c..248d6dc0f73 100644\n--- a/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java\n+++ b/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java\n\n@@ -159,8 +159,7 @@ public class MetadataCreateDataStreamService {\n \n         String fieldName = composableTemplate.getDataStreamTemplate().getTimestampField();\n         DataStream.TimestampField timestampField = new DataStream.TimestampField(fieldName);\n-        Template template = composableTemplate.template();\n-        boolean hidden = template != null && template.settings() != null && IndexMetadata.INDEX_HIDDEN_SETTING.get(template.settings());\n+        boolean hidden = composableTemplate.getDataStreamTemplate().isHidden();\n         DataStream newDataStream = new DataStream(request.name, timestampField, List.of(firstBackingIndex.getIndex()), hidden);\n         Metadata.Builder builder = Metadata.builder(currentState.metadata()).put(newDataStream);\n         logger.info(\"adding data stream [{}]\", request.name);\n"}}, {"oid": "dd9afafe7a4771d76059bf306423cd843464f1fe", "url": "https://github.com/elastic/elasticsearch/commit/dd9afafe7a4771d76059bf306423cd843464f1fe", "message": "unused imports", "committedDate": "2020-10-26T10:56:46Z", "type": "commit"}, {"oid": "6152f02629d28c659b6ddb6d0faa1c0863d4a481", "url": "https://github.com/elastic/elasticsearch/commit/6152f02629d28c659b6ddb6d0faa1c0863d4a481", "message": "Merge remote-tracking branch 'origin/master' into hidden-data-streams", "committedDate": "2020-10-26T12:50:47Z", "type": "commit"}, {"oid": "4e71b539b8fe85a442af9d4f0119b97a5b92e707", "url": "https://github.com/elastic/elasticsearch/commit/4e71b539b8fe85a442af9d4f0119b97a5b92e707", "message": "add hidden setting to data stream template", "committedDate": "2020-10-26T22:28:27Z", "type": "commit"}, {"oid": "f00df2d4b67b524bf6a299b04cdc6654652d42ea", "url": "https://github.com/elastic/elasticsearch/commit/f00df2d4b67b524bf6a299b04cdc6654652d42ea", "message": "fix expand_wildcards", "committedDate": "2020-10-26T22:55:31Z", "type": "commit"}, {"oid": "b92f159f2131a48f4a07dc356231bc8f90ac48ba", "url": "https://github.com/elastic/elasticsearch/commit/b92f159f2131a48f4a07dc356231bc8f90ac48ba", "message": "Merge remote-tracking branch 'origin/master' into hidden-data-streams", "committedDate": "2020-10-26T23:04:19Z", "type": "commit"}, {"oid": "194b49291705a88efb26de18b333efff377af756", "url": "https://github.com/elastic/elasticsearch/commit/194b49291705a88efb26de18b333efff377af756", "message": "spotless", "committedDate": "2020-10-26T23:05:35Z", "type": "commit"}, {"oid": "66c8d585874dcb8197e664cae0e5d86cb5f7c86a", "url": "https://github.com/elastic/elasticsearch/commit/66c8d585874dcb8197e664cae0e5d86cb5f7c86a", "message": "fix compilation", "committedDate": "2020-10-26T23:15:38Z", "type": "commit"}, {"oid": "d0ee5e7134272be2abc1fa127376b335d603614b", "url": "https://github.com/elastic/elasticsearch/commit/d0ee5e7134272be2abc1fa127376b335d603614b", "message": "unused import", "committedDate": "2020-10-26T23:23:53Z", "type": "commit"}, {"oid": "72add9202709c615f6780c9c52c24548317bbcbf", "url": "https://github.com/elastic/elasticsearch/commit/72add9202709c615f6780c9c52c24548317bbcbf", "message": "yaml test", "committedDate": "2020-10-26T23:49:51Z", "type": "commit"}, {"oid": "cfe3b643712d0fa0f2cd3735f49292d0776a9e5b", "url": "https://github.com/elastic/elasticsearch/commit/cfe3b643712d0fa0f2cd3735f49292d0776a9e5b", "message": "fix test", "committedDate": "2020-10-26T23:56:00Z", "type": "commit"}, {"oid": "247524445b67923d0f4ce629a10b09fc73a5e7bb", "url": "https://github.com/elastic/elasticsearch/commit/247524445b67923d0f4ce629a10b09fc73a5e7bb", "message": "fix cleanup", "committedDate": "2020-10-27T09:53:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzMyODAzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/63987#discussion_r513328031", "bodyText": "I don't fully understand the purpose of this logic here. It always ensures that expressions get expanded to open data streams / indices. Why is this needed?\nAlso the rest spec for this and get data stream api only indicates that expand_wildcards is supported, but I think the way the corresponding request class and with this logic also the other indices options rest parameters are supported as well? Is the intention of this logic to only support expand_wildcards in get and delete data streams apis?", "author": "martijnvg", "createdAt": "2020-10-28T10:18:38Z", "path": "x-pack/plugin/data-streams/src/main/java/org/elasticsearch/xpack/datastreams/action/DeleteDataStreamTransportAction.java", "diffHunk": "@@ -106,9 +108,11 @@ static ClusterState removeDataStream(\n         ClusterState currentState,\n         DeleteDataStreamAction.Request request\n     ) {\n-        Set<String> dataStreams = new HashSet<>(\n-            indexNameExpressionResolver.dataStreamNames(currentState, request.indicesOptions(), request.getNames())\n-        );\n+        IndicesOptions options = request.indicesOptions();", "originalCommit": "247524445b67923d0f4ce629a10b09fc73a5e7bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDIyNjg5MA==", "url": "https://github.com/elastic/elasticsearch/pull/63987#discussion_r514226890", "bodyText": "Yes, the intention was to only support expand_wildcards but to avoid duplicating parsing parameters code.\nopen/closed has no meaning in terms of data stream (we can't close data stream, right?), but if we specify only hidden no data stream will be returned (that's the way IndexNameExpressionResolver works). This is just convenience for a user.\nOther options should be ignored as well by the get/delete data stream APIs so no harm with parsing them.", "author": "probakowski", "createdAt": "2020-10-29T12:40:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzMyODAzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDIyODg1OQ==", "url": "https://github.com/elastic/elasticsearch/pull/63987#discussion_r514228859", "bodyText": "Ok, I see. Can the logic that rewrites the indices options be extracted in a static helper method with a comment describing what you just explained?", "author": "martijnvg", "createdAt": "2020-10-29T12:44:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzMyODAzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk4Mjg1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/63987#discussion_r514982852", "bodyText": "Yes, added", "author": "probakowski", "createdAt": "2020-10-30T09:54:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzMyODAzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "ff845eb1f51de26af4aa0bb187f90fda74ff58fd", "chunk": "diff --git a/x-pack/plugin/data-streams/src/main/java/org/elasticsearch/xpack/datastreams/action/DeleteDataStreamTransportAction.java b/x-pack/plugin/data-streams/src/main/java/org/elasticsearch/xpack/datastreams/action/DeleteDataStreamTransportAction.java\nindex fc82c627136..a50c12ddc89 100644\n--- a/x-pack/plugin/data-streams/src/main/java/org/elasticsearch/xpack/datastreams/action/DeleteDataStreamTransportAction.java\n+++ b/x-pack/plugin/data-streams/src/main/java/org/elasticsearch/xpack/datastreams/action/DeleteDataStreamTransportAction.java\n\n@@ -108,11 +109,8 @@ public class DeleteDataStreamTransportAction extends AcknowledgedTransportMaster\n         ClusterState currentState,\n         DeleteDataStreamAction.Request request\n     ) {\n-        IndicesOptions options = request.indicesOptions();\n-        EnumSet<IndicesOptions.WildcardStates> expandWildcards = options.getExpandWildcards();\n-        expandWildcards.add(IndicesOptions.WildcardStates.OPEN);\n-        options = new IndicesOptions(options.getOptions(), expandWildcards);\n-        Set<String> dataStreams = new HashSet<>(indexNameExpressionResolver.dataStreamNames(currentState, options, request.getNames()));\n+        List<String> names = getDataStreamNames(indexNameExpressionResolver, currentState, request.getNames(), request.indicesOptions());\n+        Set<String> dataStreams = new HashSet<>(names);\n         Set<String> snapshottingDataStreams = SnapshotsService.snapshottingDataStreams(currentState, dataStreams);\n \n         if (dataStreams.isEmpty()) {\n"}}, {"oid": "070cbf3e27d8d504c23d24fd06112e8065cb1ade", "url": "https://github.com/elastic/elasticsearch/commit/070cbf3e27d8d504c23d24fd06112e8065cb1ade", "message": "Merge remote-tracking branch 'origin/master' into hidden-data-streams", "committedDate": "2020-10-28T12:25:15Z", "type": "commit"}, {"oid": "ff845eb1f51de26af4aa0bb187f90fda74ff58fd", "url": "https://github.com/elastic/elasticsearch/commit/ff845eb1f51de26af4aa0bb187f90fda74ff58fd", "message": "review", "committedDate": "2020-10-30T00:53:37Z", "type": "commit"}, {"oid": "b9fc82d71e4db7ac2498c011b9af3af1e1cda503", "url": "https://github.com/elastic/elasticsearch/commit/b9fc82d71e4db7ac2498c011b9af3af1e1cda503", "message": "Merge branch 'master' into hidden-data-streams", "committedDate": "2020-10-30T07:39:57Z", "type": "commit"}, {"oid": "8ffd4445f069e9d9a89c7dae00f4c7c7634aaab7", "url": "https://github.com/elastic/elasticsearch/commit/8ffd4445f069e9d9a89c7dae00f4c7c7634aaab7", "message": "compilation fix", "committedDate": "2020-10-30T07:48:11Z", "type": "commit"}, {"oid": "d3d5a6a4096b8564bf21524fd2f8e9f232601107", "url": "https://github.com/elastic/elasticsearch/commit/d3d5a6a4096b8564bf21524fd2f8e9f232601107", "message": "fix javadoc", "committedDate": "2020-10-30T07:53:29Z", "type": "commit"}, {"oid": "9a9700ad6eba31868ca8467393e268778fbd1ce5", "url": "https://github.com/elastic/elasticsearch/commit/9a9700ad6eba31868ca8467393e268778fbd1ce5", "message": "fix javadoc", "committedDate": "2020-10-30T07:57:28Z", "type": "commit"}]}