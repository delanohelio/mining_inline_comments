{"pr_number": 55010, "pr_title": "Validate global V2 templates don't set index.hidden", "pr_createdAt": "2020-04-09T12:56:28Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55010", "timeline": [{"oid": "12df4734fce6a6e203915e4477b4868a6ed1d0eb", "url": "https://github.com/elastic/elasticsearch/commit/12df4734fce6a6e203915e4477b4868a6ed1d0eb", "message": "Validate global V2 templates don't set index.hidden", "committedDate": "2020-04-09T12:55:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIzNzEzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/55010#discussion_r406237131", "bodyText": "I think we should add return here, otherwise assertion below will trip or we will have NPE if assertions are disabled", "author": "probakowski", "createdAt": "2020-04-09T14:16:42Z", "path": "server/src/main/java/org/elasticsearch/action/admin/indices/template/put/PutIndexTemplateV2Action.java", "diffHunk": "@@ -88,6 +90,17 @@ public ActionRequestValidationException validate() {\n             if (indexTemplate == null) {\n                 validationException = addValidationError(\"an index template is required\", validationException);\n             }", "originalCommit": "12df4734fce6a6e203915e4477b4868a6ed1d0eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI4NzE1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/55010#discussion_r406287151", "bodyText": "Ah you're absolutely right, great catch, my brain filled in that return statement. I think an else statement would be better as we'd likely like to fill in all the validation errors", "author": "andreidan", "createdAt": "2020-04-09T15:26:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIzNzEzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "e21a594d6ca1bdca10b9922d5dafadfaa8413308", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/admin/indices/template/put/PutIndexTemplateV2Action.java b/server/src/main/java/org/elasticsearch/action/admin/indices/template/put/PutIndexTemplateV2Action.java\nindex e90deadb6e1..19c6f9a0cab 100644\n--- a/server/src/main/java/org/elasticsearch/action/admin/indices/template/put/PutIndexTemplateV2Action.java\n+++ b/server/src/main/java/org/elasticsearch/action/admin/indices/template/put/PutIndexTemplateV2Action.java\n\n@@ -89,15 +89,14 @@ public class PutIndexTemplateV2Action extends ActionType<AcknowledgedResponse> {\n             }\n             if (indexTemplate == null) {\n                 validationException = addValidationError(\"an index template is required\", validationException);\n-            }\n-            assert indexTemplate != null : \"an index template is required\";\n-            \n-            if (indexTemplate.indexPatterns().stream().anyMatch(Regex::isMatchAllPattern)) {\n-                if (IndexMetadata.INDEX_HIDDEN_SETTING.exists(indexTemplate.template().settings())) {\n-                    validationException = addValidationError(\n-                        \"global V2 templates may not specify the setting \" + IndexMetadata.INDEX_HIDDEN_SETTING.getKey(),\n-                        validationException\n-                    );\n+            } else {\n+                if (indexTemplate.indexPatterns().stream().anyMatch(Regex::isMatchAllPattern)) {\n+                    if (IndexMetadata.INDEX_HIDDEN_SETTING.exists(indexTemplate.template().settings())) {\n+                        validationException = addValidationError(\"global V2 templates may not specify the setting \"\n+                                + IndexMetadata.INDEX_HIDDEN_SETTING.getKey(),\n+                            validationException\n+                        );\n+                    }\n                 }\n             }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIzODIwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/55010#discussion_r406238201", "bodyText": "minor nit: maybe break on + here, then there will be 2 lines instead of 4", "author": "probakowski", "createdAt": "2020-04-09T14:18:11Z", "path": "server/src/main/java/org/elasticsearch/action/admin/indices/template/put/PutIndexTemplateV2Action.java", "diffHunk": "@@ -88,6 +90,17 @@ public ActionRequestValidationException validate() {\n             if (indexTemplate == null) {\n                 validationException = addValidationError(\"an index template is required\", validationException);\n             }\n+            assert indexTemplate != null : \"an index template is required\";\n+            \n+            if (indexTemplate.indexPatterns().stream().anyMatch(Regex::isMatchAllPattern)) {\n+                if (IndexMetadata.INDEX_HIDDEN_SETTING.exists(indexTemplate.template().settings())) {\n+                    validationException = addValidationError(\n+                        \"global V2 templates may not specify the setting \" + IndexMetadata.INDEX_HIDDEN_SETTING.getKey(),", "originalCommit": "12df4734fce6a6e203915e4477b4868a6ed1d0eb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e21a594d6ca1bdca10b9922d5dafadfaa8413308", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/admin/indices/template/put/PutIndexTemplateV2Action.java b/server/src/main/java/org/elasticsearch/action/admin/indices/template/put/PutIndexTemplateV2Action.java\nindex e90deadb6e1..19c6f9a0cab 100644\n--- a/server/src/main/java/org/elasticsearch/action/admin/indices/template/put/PutIndexTemplateV2Action.java\n+++ b/server/src/main/java/org/elasticsearch/action/admin/indices/template/put/PutIndexTemplateV2Action.java\n\n@@ -89,15 +89,14 @@ public class PutIndexTemplateV2Action extends ActionType<AcknowledgedResponse> {\n             }\n             if (indexTemplate == null) {\n                 validationException = addValidationError(\"an index template is required\", validationException);\n-            }\n-            assert indexTemplate != null : \"an index template is required\";\n-            \n-            if (indexTemplate.indexPatterns().stream().anyMatch(Regex::isMatchAllPattern)) {\n-                if (IndexMetadata.INDEX_HIDDEN_SETTING.exists(indexTemplate.template().settings())) {\n-                    validationException = addValidationError(\n-                        \"global V2 templates may not specify the setting \" + IndexMetadata.INDEX_HIDDEN_SETTING.getKey(),\n-                        validationException\n-                    );\n+            } else {\n+                if (indexTemplate.indexPatterns().stream().anyMatch(Regex::isMatchAllPattern)) {\n+                    if (IndexMetadata.INDEX_HIDDEN_SETTING.exists(indexTemplate.template().settings())) {\n+                        validationException = addValidationError(\"global V2 templates may not specify the setting \"\n+                                + IndexMetadata.INDEX_HIDDEN_SETTING.getKey(),\n+                            validationException\n+                        );\n+                    }\n                 }\n             }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIzOTU5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/55010#discussion_r406239591", "bodyText": "Add test check that null template produce correct message and no NPEs", "author": "probakowski", "createdAt": "2020-04-09T14:20:09Z", "path": "server/src/test/java/org/elasticsearch/action/admin/indices/template/put/PutIndexTemplateV2RequestTests.java", "diffHunk": "@@ -44,4 +53,19 @@\n     protected PutIndexTemplateV2Action.Request mutateInstance(PutIndexTemplateV2Action.Request instance) throws IOException {\n         return randomValueOtherThan(instance, this::createTestInstance);\n     }\n+\n+    public void testPutGlobalTemplatesCannotHaveHiddenIndexSetting() {", "originalCommit": "12df4734fce6a6e203915e4477b4868a6ed1d0eb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e21a594d6ca1bdca10b9922d5dafadfaa8413308", "chunk": "diff --git a/server/src/test/java/org/elasticsearch/action/admin/indices/template/put/PutIndexTemplateV2RequestTests.java b/server/src/test/java/org/elasticsearch/action/admin/indices/template/put/PutIndexTemplateV2RequestTests.java\nindex a5a6c6c743b..125ed69984c 100644\n--- a/server/src/test/java/org/elasticsearch/action/admin/indices/template/put/PutIndexTemplateV2RequestTests.java\n+++ b/server/src/test/java/org/elasticsearch/action/admin/indices/template/put/PutIndexTemplateV2RequestTests.java\n\n@@ -68,4 +68,15 @@ public class PutIndexTemplateV2RequestTests extends AbstractWireSerializingTestC\n         String error = validationErrors.get(0);\n         assertThat(error, is(\"global V2 templates may not specify the setting \" + IndexMetadata.SETTING_INDEX_HIDDEN));\n     }\n+\n+    public void testPutIndexTemplateV2RequestMustContainTemplate() {\n+        PutIndexTemplateV2Action.Request requestWithoutTemplate = new PutIndexTemplateV2Action.Request(\"test\");\n+\n+        ActionRequestValidationException validationException = requestWithoutTemplate.validate();\n+        assertThat(validationException, is(notNullValue()));\n+        List<String> validationErrors = validationException.validationErrors();\n+        assertThat(validationErrors.size(), is(1));\n+        String error = validationErrors.get(0);\n+        assertThat(error, is(\"an index template is required\"));\n+    }\n }\n"}}, {"oid": "e21a594d6ca1bdca10b9922d5dafadfaa8413308", "url": "https://github.com/elastic/elasticsearch/commit/e21a594d6ca1bdca10b9922d5dafadfaa8413308", "message": "Handle null template properly", "committedDate": "2020-04-09T15:30:36Z", "type": "commit"}, {"oid": "a2fa7bb70f47eb5bf408546054c01800b0ae98a1", "url": "https://github.com/elastic/elasticsearch/commit/a2fa7bb70f47eb5bf408546054c01800b0ae98a1", "message": "Merge branch 'master' into global-v2template-dont-set-indexhidden", "committedDate": "2020-04-15T11:13:17Z", "type": "commit"}, {"oid": "d38ad901f2383bf521952c66ff1e6a4c8a9a1cc1", "url": "https://github.com/elastic/elasticsearch/commit/d38ad901f2383bf521952c66ff1e6a4c8a9a1cc1", "message": "Check the index template resolved settings for index.hidden\n\nThis also prevents updating the component template to add the index.hidden\nsetting if that ct is referenced by a global index template.", "committedDate": "2020-04-16T13:16:12Z", "type": "commit"}, {"oid": "09342ee8c19635c66b4f235d9e7b446b0756396a", "url": "https://github.com/elastic/elasticsearch/commit/09342ee8c19635c66b4f235d9e7b446b0756396a", "message": "Add fail statements in test", "committedDate": "2020-04-16T13:28:56Z", "type": "commit"}, {"oid": "f0ac92cfeb1efeb1dfb302d4be4649934972e357", "url": "https://github.com/elastic/elasticsearch/commit/f0ac92cfeb1efeb1dfb302d4be4649934972e357", "message": "Merge branch 'master' into global-v2template-dont-set-indexhidden", "committedDate": "2020-04-16T13:29:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM0MDcxNw==", "url": "https://github.com/elastic/elasticsearch/pull/55010#discussion_r411340717", "bodyText": "Ifs can be merged", "author": "probakowski", "createdAt": "2020-04-20T12:35:01Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -196,6 +196,29 @@ ClusterState addComponentTemplate(final ClusterState currentState, final boolean\n \n         validateTemplate(finalSettings, stringMappings, indicesService, xContentRegistry);\n \n+        // if we're updating a component template, let's check if it's part of any V2 template that will yield the CT update invalid\n+        if (create == false && finalSettings != null) {\n+            // if the CT is specifying the `index.hidden` setting it cannot be part of any global template\n+            if (IndexMetadata.INDEX_HIDDEN_SETTING.exists(finalSettings)) {", "originalCommit": "f0ac92cfeb1efeb1dfb302d4be4649934972e357", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA2MDU5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/55010#discussion_r412060592", "bodyText": "I don't think that'd be necessarily more readable (especially in the context of maybe us wanting to add more checks, this index.hidden one being just one condition we identified now). If it's ok, I'll leave it like this now", "author": "andreidan", "createdAt": "2020-04-21T10:20:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM0MDcxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA2MjAxMQ==", "url": "https://github.com/elastic/elasticsearch/pull/55010#discussion_r412062011", "bodyText": "You definitely can leave it as it is, as I said this totally my personal preference only", "author": "probakowski", "createdAt": "2020-04-21T10:22:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM0MDcxNw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU2MDA5Mw==", "url": "https://github.com/elastic/elasticsearch/pull/55010#discussion_r411560093", "bodyText": "This can be replaced with stream version, which for me is more readable:\nList<String> globalTemplatesThatUseThisComponent = currentState.metadata().templatesV2().entrySet().stream()\n                .filter(e -> e.getValue().composedOf().contains(name))\n                .filter(e -> e.getValue().indexPatterns().stream().anyMatch(Regex::isMatchAllPattern))\n                .map(Map.Entry::getKey)\n                .collect(Collectors.toList());", "author": "probakowski", "createdAt": "2020-04-20T17:29:32Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -196,6 +196,29 @@ ClusterState addComponentTemplate(final ClusterState currentState, final boolean\n \n         validateTemplate(finalSettings, stringMappings, indicesService, xContentRegistry);\n \n+        // if we're updating a component template, let's check if it's part of any V2 template that will yield the CT update invalid\n+        if (create == false && finalSettings != null) {\n+            // if the CT is specifying the `index.hidden` setting it cannot be part of any global template\n+            if (IndexMetadata.INDEX_HIDDEN_SETTING.exists(finalSettings)) {\n+                Map<String, IndexTemplateV2> existingTemplates = currentState.metadata().templatesV2();\n+                List<String> globalTemplatesThatUseThisComponent = new ArrayList<>();\n+                for (Map.Entry<String, IndexTemplateV2> entry : existingTemplates.entrySet()) {\n+                    IndexTemplateV2 templateV2 = entry.getValue();\n+                    if (templateV2.composedOf().contains(name) && templateV2.indexPatterns().stream().anyMatch(Regex::isMatchAllPattern)) {\n+                        // global templates don't support configuring the `index.hidden` setting so we don't need to resolve the settings as\n+                        // no other component template can remove this setting from the resolved settings, so just invalidate this update\n+                        globalTemplatesThatUseThisComponent.add(entry.getKey());\n+                    }\n+                }", "originalCommit": "f0ac92cfeb1efeb1dfb302d4be4649934972e357", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA2OTAzNg==", "url": "https://github.com/elastic/elasticsearch/pull/55010#discussion_r412069036", "bodyText": "I'm not sure about this, to me they're equally readable, but your option is a bit more concise.\nIn the interest of moving this rather stale PR forward I'm merging it as it is and we can refactor it later if that's ok?", "author": "andreidan", "createdAt": "2020-04-21T10:33:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU2MDA5Mw=="}], "type": "inlineReview", "revised_code": null}]}