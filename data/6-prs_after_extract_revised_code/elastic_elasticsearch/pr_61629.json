{"pr_number": 61629, "pr_title": "Implement deprecation logging using log4j", "pr_createdAt": "2020-08-27T11:25:13Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/61629", "timeline": [{"oid": "9d696dc5fb66283de7eb49b713648f458b9ea045", "url": "https://github.com/elastic/elasticsearch/commit/9d696dc5fb66283de7eb49b713648f458b9ea045", "message": "Implement deprecation logging using log4j (#61474)\n\nBackport of #61474.\n\nPart of #46106. Simplify the implementation of deprecation logging by\nrelying of log4j more completely, and implementing additional behaviour\nthrough custom appenders and filters.", "committedDate": "2020-08-27T11:22:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTk0Nzg4MA==", "url": "https://github.com/elastic/elasticsearch/pull/61629#discussion_r479947880", "bodyText": "I wonder if we need this builder in 7.x - I removed this from my backport because there will be no compatible logger in 7.x\nHowever I am thinking now that it might cause problems for future backports and we should keep it?\nWDYT?", "author": "pgomulka", "createdAt": "2020-08-31T07:30:52Z", "path": "server/src/main/java/org/elasticsearch/common/logging/DeprecationLogger.java", "diffHunk": "@@ -72,23 +82,22 @@ private static String toLoggerName(final Class<?> cls) {\n         return canonicalName != null ? canonicalName : cls.getName();\n     }\n \n-    public static void setThreadContext(ThreadContext threadContext) {\n-        HeaderWarning.setThreadContext(threadContext);\n-    }\n-\n-    public static void removeThreadContext(ThreadContext threadContext) {\n-        HeaderWarning.removeThreadContext(threadContext);\n-    }\n-\n     /**\n-     * Logs a deprecation message, adding a formatted warning message as a response header on the thread context.\n-     * The deprecation message will be throttled to deprecation log.\n+     * Logs a message at the {@link #DEPRECATION} level. The message is also sent to the header warning logger,\n+     * so that it can be returned to the client.\n      */\n-    @SuppressLoggerChecks(reason = \"Safely delegates to a deprecated message\")\n-    public void deprecate(final String key, final String msg, final Object... params) {\n-        String opaqueId = HeaderWarning.getXOpaqueId();\n-        ESLogMessage deprecationMessage = new DeprecatedMessage(opaqueId, msg, params);\n-        deprecationLogger.throttleLogAndAddWarning(key, deprecationMessage);\n+    public DeprecationLoggerBuilder deprecate(final String key, final String msg, final Object... params) {\n+        return new DeprecationLoggerBuilder().withDeprecation(key, msg, params);\n     }\n \n+    public class DeprecationLoggerBuilder {", "originalCommit": "9d696dc5fb66283de7eb49b713648f458b9ea045", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA3Mzg4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/61629#discussion_r480073885", "bodyText": "Let's keep it - we've already backported more logging changes to 7.x than we expected, and there may well be more before v8 is released.", "author": "pugnascotia", "createdAt": "2020-08-31T11:41:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTk0Nzg4MA=="}], "type": "inlineReview", "revised_code": null}]}