{"pr_number": 53139, "pr_title": "Add `allowed_warnings` to yaml tests", "pr_createdAt": "2020-03-04T21:43:59Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53139", "timeline": [{"oid": "2e4651d707032bbaeea41f11c76219bf1d65e2a3", "url": "https://github.com/elastic/elasticsearch/commit/2e4651d707032bbaeea41f11c76219bf1d65e2a3", "message": "Add `allowed_warnings` to yaml tests\n\nWhen we test backwards compatibility we often end up in a situation\nwhere we *sometimes* get a warning, and sometimes don't. Like, we won't\nget the warning if we're testing against an older version, but we will\nin a newer one. Or we won't get the warning if the request randomly\nlands on a node with an old version of the code. But we wouldn't if it\nrandomed into a node with newer code.\n\nThis adds `allowed_warnings` to our yaml test runner for those cases:\nwarnings declared this way are \"allowed\" but not \"required\".\n\nBlocks #52959", "committedDate": "2020-03-04T21:39:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk1Mjc3Mg==", "url": "https://github.com/elastic/elasticsearch/pull/53139#discussion_r387952772", "bodyText": "I removed this branch both because it made me sad and because removing it gives me a convenient real world use case for this feature that doesn't require that I really understand what is going on in #52959.", "author": "nik9000", "createdAt": "2020-03-04T21:45:20Z", "path": "test/framework/src/main/java/org/elasticsearch/test/rest/yaml/section/DoSection.java", "diffHunk": "@@ -284,19 +320,25 @@ void checkWarningHeaders(final List<String> warningHeaders, final Version master\n         final List<String> unexpected = new ArrayList<>();\n         final List<String> unmatched = new ArrayList<>();\n         final List<String> missing = new ArrayList<>();\n+        Set<String> allowed = allowedWarningHeaders.stream()\n+                .map(DeprecationLogger::escapeAndEncode)\n+                .collect(toSet());\n         // LinkedHashSet so that missing expected warnings come back in a predictable order which is nice for testing\n-        final Set<String> expected =\n-                new LinkedHashSet<>(expectedWarningHeaders.stream().map(DeprecationLogger::escapeAndEncode).collect(Collectors.toList()));\n+        final Set<String> expected = expectedWarningHeaders.stream()\n+                .map(DeprecationLogger::escapeAndEncode)\n+                .collect(toCollection(LinkedHashSet::new));\n         for (final String header : warningHeaders) {\n             final Matcher matcher = WARNING_HEADER_PATTERN.matcher(header);\n             final boolean matches = matcher.matches();\n             if (matches) {\n                 final String message = matcher.group(1);\n-                if (message.startsWith(\"[_data_frame/transforms/] is deprecated\")) {", "originalCommit": "2e4651d707032bbaeea41f11c76219bf1d65e2a3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "2eef2e58e4d47255b5063a6cc294da1534a7b138", "url": "https://github.com/elastic/elasticsearch/commit/2eef2e58e4d47255b5063a6cc294da1534a7b138", "message": "Merge branch 'master' into allowed_warnings", "committedDate": "2020-03-04T22:06:19Z", "type": "commit"}, {"oid": "f3f8ede311412985edddc4697863dec0ea55c09e", "url": "https://github.com/elastic/elasticsearch/commit/f3f8ede311412985edddc4697863dec0ea55c09e", "message": "Update rest-api-spec/src/main/resources/rest-api-spec/test/README.asciidoc\n\nCo-Authored-By: William Brafford <williamrandolphbrafford@gmail.com>", "committedDate": "2020-03-04T22:53:44Z", "type": "commit"}]}