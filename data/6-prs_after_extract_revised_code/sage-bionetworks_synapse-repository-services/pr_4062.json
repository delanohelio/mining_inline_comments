{"pr_number": 4062, "pr_title": "PLFM-6159 - Part C: New submission view entity", "pr_createdAt": "2020-05-27T23:03:14Z", "pr_url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4062", "timeline": [{"oid": "cd4ad0dd319f3062d862fe031b80ddef79adde39", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/cd4ad0dd319f3062d862fe031b80ddef79adde39", "message": "PLFM-6159: Added new entity type, submissionview", "committedDate": "2020-05-28T01:31:26Z", "type": "commit"}, {"oid": "6b6a9af6a863e6af7a4f0d693a8c8a3eada43595", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/6b6a9af6a863e6af7a4f0d693a8c8a3eada43595", "message": "PLFM-6159: Use the EntityType for the ViewScope", "committedDate": "2020-05-28T01:31:27Z", "type": "commit"}, {"oid": "e8c2f6dc375bf9d9273477e8340111fc449f305a", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/e8c2f6dc375bf9d9273477e8340111fc449f305a", "message": "PLFM-6159: Added validation for submission views", "committedDate": "2020-05-28T01:31:27Z", "type": "commit"}, {"oid": "2be22976b514dc18ce4c3bf708a6c32ac171ea0c", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/2be22976b514dc18ce4c3bf708a6c32ac171ea0c", "message": "PLFM-6159: Removed temp migration block", "committedDate": "2020-05-28T01:31:28Z", "type": "commit"}, {"oid": "1b149a92a677e247e103f6c2f587e2fd01480ad6", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/1b149a92a677e247e103f6c2f587e2fd01480ad6", "message": "Increase the timeout for long running tests", "committedDate": "2020-05-28T01:34:38Z", "type": "forcePushed"}, {"oid": "f6aff65e4e7de0246d09988bbfd3c5f27a077402", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/f6aff65e4e7de0246d09988bbfd3c5f27a077402", "message": "PLFM-6159: Submission view integration test", "committedDate": "2020-05-28T02:19:48Z", "type": "commit"}, {"oid": "6c79da6985dc06a0c63f0dcd12308ede9c7705df", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/6c79da6985dc06a0c63f0dcd12308ede9c7705df", "message": "PLFM-6159: Move type mask validation logic into provider", "committedDate": "2020-05-28T02:19:57Z", "type": "commit"}, {"oid": "a109151970ea19dbe5370342c7b87da8343813d9", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/a109151970ea19dbe5370342c7b87da8343813d9", "message": "Increase the timeout for long running tests", "committedDate": "2020-05-28T02:19:58Z", "type": "commit"}, {"oid": "a109151970ea19dbe5370342c7b87da8343813d9", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/a109151970ea19dbe5370342c7b87da8343813d9", "message": "Increase the timeout for long running tests", "committedDate": "2020-05-28T02:19:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE5Mjg0Mg==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4062#discussion_r432192842", "bodyText": "is there a way to pass the scope and get back the sub-set the user has the  passed permission.  That would be a single call instead of n calls.", "author": "john-hill", "createdAt": "2020-05-29T00:21:10Z", "path": "services/repository/src/main/java/org/sagebionetworks/repo/web/service/metadata/SubmissionViewMetadataProvider.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package org.sagebionetworks.repo.web.service.metadata;\r\n+\r\n+import java.util.List;\r\n+\r\n+import org.sagebionetworks.evaluation.manager.EvaluationPermissionsManager;\r\n+import org.sagebionetworks.repo.manager.table.TableViewManager;\r\n+import org.sagebionetworks.repo.model.ACCESS_TYPE;\r\n+import org.sagebionetworks.repo.model.DatastoreException;\r\n+import org.sagebionetworks.repo.model.EntityType;\r\n+import org.sagebionetworks.repo.model.InvalidModelException;\r\n+import org.sagebionetworks.repo.model.UnauthorizedException;\r\n+import org.sagebionetworks.repo.model.UserInfo;\r\n+import org.sagebionetworks.repo.model.table.SubmissionView;\r\n+import org.sagebionetworks.repo.model.table.ViewScope;\r\n+import org.sagebionetworks.repo.web.NotFoundException;\r\n+import org.springframework.beans.factory.annotation.Autowired;\r\n+import org.springframework.stereotype.Service;\r\n+\r\n+@Service(\"submissionViewMetadataProvider\")\r\n+public class SubmissionViewMetadataProvider extends ViewMetadataProvider<SubmissionView> implements EntityValidator<SubmissionView> {\r\n+\t\r\n+\t@Autowired\r\n+\tprivate EvaluationPermissionsManager evaluationPermissionManager;\r\n+\t\r\n+\t@Autowired\r\n+\tpublic SubmissionViewMetadataProvider(TableViewManager viewManager, EvaluationPermissionsManager evaluationPermissionManager) {\r\n+\t\tsuper(viewManager);\r\n+\t\tthis.evaluationPermissionManager = evaluationPermissionManager;\r\n+\t}\r\n+\t\r\n+\t@Override\r\n+\tpublic ViewScope createViewScope(UserInfo userInfo, SubmissionView view) {\r\n+\t\tViewScope scope = new ViewScope();\r\n+\t\t\r\n+\t\tscope.setViewEntityType(EntityType.submissionview);\r\n+\t\tscope.setScope(view.getScopeIds());\r\n+\t\tscope.setViewTypeMask(0L);\r\n+\t\t\r\n+\t\treturn scope;\r\n+\t}\r\n+\t\r\n+\t@Override\r\n+\tpublic void validateEntity(SubmissionView view, EntityEvent event)\r\n+\t\t\tthrows InvalidModelException, NotFoundException, DatastoreException, UnauthorizedException {\r\n+\t\tvalidateScopeAccess(event.getUserInfo(), view.getScopeIds());\t\t\r\n+\t}\r\n+\t\r\n+\tprivate void validateScopeAccess(UserInfo userInfo, List<String> scope) {\r\n+\t\tif (scope == null || scope.isEmpty()) {\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\t\tscope.forEach((evaluationId) -> {\r\n+\t\t\tevaluationPermissionManager.hasAccess(userInfo, evaluationId, ACCESS_TYPE.READ_PRIVATE_SUBMISSION);\r", "originalCommit": "a109151970ea19dbe5370342c7b87da8343813d9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}