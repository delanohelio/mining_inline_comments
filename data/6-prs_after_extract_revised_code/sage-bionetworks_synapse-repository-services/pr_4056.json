{"pr_number": 4056, "pr_title": "PLFM-6159 - Part B: Submission metadata index implementation", "pr_createdAt": "2020-05-26T17:30:33Z", "pr_url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4056", "timeline": [{"oid": "34a6c0c54c5e5932604a632d910e99563130bc97", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/34a6c0c54c5e5932604a632d910e99563130bc97", "message": "PLFM-6159: Added SUBMISSIONID and EVALUATIONID column types", "committedDate": "2020-05-27T00:59:49Z", "type": "commit"}, {"oid": "0612639644e6f6212ce85b95842fa51694e97795", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/0612639644e6f6212ce85b95842fa51694e97795", "message": "PLFM-6159: Added abstraction for custom default fields", "committedDate": "2020-05-27T00:59:50Z", "type": "commit"}, {"oid": "24519211b955630502fa15f93aeed32177b36110", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/24519211b955630502fa15f93aeed32177b36110", "message": "PLFM-6159: Minor refactoring on the metadata index interface", "committedDate": "2020-05-27T00:59:50Z", "type": "commit"}, {"oid": "6db498b5a96e425614f0787722fbb7d39d461d31", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/6db498b5a96e425614f0787722fbb7d39d461d31", "message": "PLFM-6159: Added method to get the default subtype for an object type", "committedDate": "2020-05-27T00:59:50Z", "type": "commit"}, {"oid": "56e44490517a9eb65e535685121aa3a03c185d3a", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/56e44490517a9eb65e535685121aa3a03c185d3a", "message": "PLFM-6159: Junit 5 test updates", "committedDate": "2020-05-27T00:59:50Z", "type": "commit"}, {"oid": "836b819e3bd5e3ab83f55abc41db5b885c8867a4", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/836b819e3bd5e3ab83f55abc41db5b885c8867a4", "message": "PLFM-6159: Improve the way the submission status is fetched", "committedDate": "2020-05-27T00:59:51Z", "type": "commit"}, {"oid": "aca8180399f4ec040de5636dde1ef1db60cefacb", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/aca8180399f4ec040de5636dde1ef1db60cefacb", "message": "PLFM-6159: Added new method to fetch the subset of existing evaluations", "committedDate": "2020-05-27T00:59:51Z", "type": "commit"}, {"oid": "5a9fe3aaea1f8c7d5e7f6eada763acbcc532d2c5", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/5a9fe3aaea1f8c7d5e7f6eada763acbcc532d2c5", "message": "PLFM-6159: Added new submission methods for replication:\n\n- Fetch id and etag of submissions for an evaluation\n- Computes sum of CRC of submissions of a list of evaluations", "committedDate": "2020-05-27T00:59:51Z", "type": "commit"}, {"oid": "a09caca6849aa6b1cb4fca6afbabf541d2863bed", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/a09caca6849aa6b1cb4fca6afbabf541d2863bed", "message": "PLFM-6159: Method to gather submission data to be indexed", "committedDate": "2020-05-27T00:59:51Z", "type": "commit"}, {"oid": "80ba902cda1b7278f2624c264a905421951ba68b", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/80ba902cda1b7278f2624c264a905421951ba68b", "message": "PLFM-6159: Remove submission annotation V1 to V2 translation code", "committedDate": "2020-05-27T01:05:05Z", "type": "forcePushed"}, {"oid": "bc31be497103cb1f6cab17296a9c18bac2c61e26", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/bc31be497103cb1f6cab17296a9c18bac2c61e26", "message": "PLFM-6159: Submission metadata index implementation", "committedDate": "2020-05-27T05:51:04Z", "type": "commit"}, {"oid": "1357a52c9e4d2261f273832cb92fa2c3f9e51274", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/1357a52c9e4d2261f273832cb92fa2c3f9e51274", "message": "PLFM-6159: Revert change to get submission status\n\n- Because reasons (and I want to sleep)", "committedDate": "2020-05-27T05:51:11Z", "type": "commit"}, {"oid": "2cc84296d360ac9abaabc9162c328b35e6fc77fb", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/2cc84296d360ac9abaabc9162c328b35e6fc77fb", "message": "PLFM-6159: Remove submission annotation V1 to V2 translation code", "committedDate": "2020-05-27T05:51:11Z", "type": "commit"}, {"oid": "bd60710ee35990b68611c154c76f5821a8d81382", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/bd60710ee35990b68611c154c76f5821a8d81382", "message": "PLFM-6159: Added submission replication integration test", "committedDate": "2020-05-27T05:51:11Z", "type": "commit"}, {"oid": "bd60710ee35990b68611c154c76f5821a8d81382", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/bd60710ee35990b68611c154c76f5821a8d81382", "message": "PLFM-6159: Added submission replication integration test", "committedDate": "2020-05-27T05:51:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUxNTcxNA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4056#discussion_r431515714", "bodyText": "I would be okay with a for loop here.", "author": "john-hill", "createdAt": "2020-05-28T00:23:43Z", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/table/metadata/DefaultColumnModel.java", "diffHunk": "@@ -37,14 +49,47 @@ public ViewObjectType getObjectType() {\n \t\treturn objectType;\r\n \t}\r\n \r\n+\t/**\r\n+\t * @return The default object fields included\r\n+\t */\r\n \tpublic List<ObjectField> getDefaultFields() {\r\n \t\treturn defaultFields;\r\n \t}\r\n \r\n+\t/**\r\n+\t * @return The custom fields included\r\n+\t */\r\n \tpublic List<ColumnModel> getCustomFields() {\r\n \t\treturn customFields;\r\n \t}\r\n \r\n+\t/**\r\n+\t * @param columnName The column name\r\n+\t * @return An optional with the column model in the custom fields that matches\r\n+\t *         the given column name\r\n+\t */\r\n+\tpublic Optional<ColumnModel> findCustomFieldByColumnName(String columnName) {\r\n+\t\treturn findCustomField(columNameMatcher(columnName));\r", "originalCommit": "bd60710ee35990b68611c154c76f5821a8d81382", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUxOTg5Ng==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4056#discussion_r431519896", "bodyText": "keep here but remove from default columns", "author": "john-hill", "createdAt": "2020-05-28T00:39:36Z", "path": "lib/jdomodels/src/main/java/org/sagebionetworks/evaluation/dao/SubmissionDAOImpl.java", "diffHunk": "@@ -254,6 +281,43 @@\n \t\t\" and acl.\"+COL_ACL_OWNER_TYPE+\"='\"+ObjectType.EVALUATION+\"'\"+\n \t\t\" and ra.\"+COL_RESOURCE_ACCESS_GROUP_ID+\" in (:\"+COL_RESOURCE_ACCESS_GROUP_ID+\") \"+\n \t\t\" and at.\"+COL_RESOURCE_ACCESS_TYPE_ELEMENT+\"=:\"+COL_RESOURCE_ACCESS_TYPE_ELEMENT;\n+\t\n+\tprivate static final String SELECT_SUBMISSION_ID_AND_ETAG = \"SELECT s.\" + COL_SUBMISSION_ID + \", r.\" + COL_SUBSTATUS_ETAG \n+\t\t\t+ BUNDLES_BY_EVALUATION_SQL;\n+\t\n+\tprivate static final String SELECT_SUM_CRC_SUBMISSIONS = \"SELECT \"+COL_SUBMISSION_EVAL_ID+\",\"\n+\t\t\t+ \" SUM(CRC32(CONCAT(s.\"+COL_SUBMISSION_ID + \",'-', r.\"+COL_SUBSTATUS_ETAG + \"))) AS \" + CRC\n+\t\t\t+ \" FROM \"+ TABLE_SUBMISSION + \" s INNER JOIN \" + TABLE_SUBSTATUS + \" r\"\n+\t\t\t+ \" ON (s.\" + COL_SUBMISSION_ID + \" = r.\"+ COL_SUBSTATUS_SUBMISSION_ID +\") \"\n+\t\t\t+ \" WHERE s.\"+ COL_SUBMISSION_EVAL_ID + \" IN (:\"+ EVAL_ID +\")\"\n+\t\t\t+ \" GROUP BY \"+COL_SUBMISSION_EVAL_ID;\n+\t\n+\tprivate static final String SELECT_SUBMISSION_DATA = \"SELECT\"\n+\t\t\t+ \" s.\" + COL_SUBMISSION_ID\n+\t\t\t+ \", s.\" + COL_SUBMISSION_NAME\n+\t\t\t+ \", r.\" + COL_SUBSTATUS_ETAG\n+\t\t\t+ \", s.\" + COL_SUBMISSION_EVAL_ID + \" AS \" + SubmissionField.evaluationid.getColumnAlias()\n+\t\t\t+ \", e.\" + COL_EVALUATION_CONTENT_SOURCE + \" AS \" + PROJECT_ID\n+\t\t\t+ \", r.\" + COL_SUBSTATUS_VERSION\n+\t\t\t+ \", s.\" + COL_SUBMISSION_CREATED_ON\n+\t\t\t+ \", s. \" + COL_SUBMISSION_USER_ID + \" AS \" + CREATED_BY\n+\t\t\t+ \", r.\" + COL_SUBSTATUS_MODIFIED_ON\n+\t\t\t// We do not store who modified a status, just use the owner of the evaluation queue\n+\t\t\t+ \", e.\" + COL_EVALUATION_OWNER_ID + \" AS \" + MODIFIED_BY", "originalCommit": "bd60710ee35990b68611c154c76f5821a8d81382", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUyMzgxNA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4056#discussion_r431523814", "bodyText": "not using these annotations.", "author": "john-hill", "createdAt": "2020-05-28T00:54:32Z", "path": "lib/jdomodels/src/test/java/org/sagebionetworks/evaluation/dao/SubmissionDAOImplTest.java", "diffHunk": "@@ -917,4 +980,255 @@ public void testIsDockerRepoNameInAnyEvaluationWithAccess() throws Exception {\n \n \n \t}\n+\t\n+\t@Test\n+\tpublic void testGetSubmissionIdAndEtag() {\n+\n+\t\tString subId1 = submissionDAO.create(submission);\n+\t\tcreateSubmissionStatus(subId1, SubmissionStatusEnum.SCORED);\n+\t\tString etag1 = submissionStatusDAO.get(subId1).getEtag();\n+\t\tString subId2 = submissionDAO.create(submission2);\n+\t\tcreateSubmissionStatus(subId2, SubmissionStatusEnum.SCORED);\n+\t\tString etag2 = submissionStatusDAO.get(subId2).getEtag();\n+\t\tString subId3 = submissionDAO.create(submission3);\n+\t\tcreateSubmissionStatus(subId3, SubmissionStatusEnum.SCORED);\n+\t\tString etag3 = submissionStatusDAO.get(subId3).getEtag();\n+\t\t\n+\t\tLong evaluationId = Long.valueOf(evalId);\n+\t\t\n+\t\tList<IdAndEtag> expected = ImmutableList.of(\n+\t\t\tnew IdAndEtag(Long.valueOf(subId1), etag1, evaluationId),\n+\t\t\tnew IdAndEtag(Long.valueOf(subId2), etag2, evaluationId),\n+\t\t\tnew IdAndEtag(Long.valueOf(subId3), etag3, evaluationId)\n+\t\t);\n+\t\t\n+\t\t// Call under test\n+\t\tList<IdAndEtag> result = submissionDAO.getSubmissionIdAndEtag(evaluationId);\n+\t\t\n+\t\tassertEquals(expected, result);\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testGetSubmissionIdAndEtagWithNullInput() {\n+\t\t\n+\t\tLong evaluationId = null;\n+\n+\t\tString errorMessage = assertThrows(IllegalArgumentException.class, () -> {\n+\t\t\t// Call under test\n+\t\t\tsubmissionDAO.getSubmissionIdAndEtag(evaluationId);\n+\t\t\t\n+\t\t}).getMessage();\n+\t\t\n+\t\tassertEquals(\"evaluationId is required.\", errorMessage);\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testGetSumOfSubmissionCRCsForEachEvaluation() {\n+\t\tLong evaluationId1 = Long.valueOf(evalId);\n+\t\tLong evaluationId2 = Long.valueOf(evalId2);\n+\t\t\n+\t\t// Creates 3 submissions for evalId\n+\t\tsubmissionDAO.create(submission);\n+\t\tcreateSubmissionStatus(SUBMISSION_ID, SubmissionStatusEnum.SCORED);\n+\t\tsubmissionDAO.create(submission2);\n+\t\tcreateSubmissionStatus(SUBMISSION_2_ID, SubmissionStatusEnum.SCORED);\n+\t\tsubmissionDAO.create(submission3);\n+\t\tcreateSubmissionStatus(SUBMISSION_3_ID, SubmissionStatusEnum.SCORED);\n+\t\t\n+\t\tList<Long> ids = ImmutableList.of(evaluationId1, evaluationId2);\n+\t\t\n+\t\tMap<Long, Long> result = submissionDAO.getSumOfSubmissionCRCsForEachEvaluation(ids);\n+\t\t\n+\t\tassertEquals(1L, result.size());\n+\t\tassertNotNull(result.get(evaluationId1));\n+\t}\n+\t\n+\t@Test\n+\tpublic void testGetSumOfSubmissionCRCsForEachEvaluationWithNullInput() {\n+\t\t\n+\t\tList<Long> ids = null;\n+\t\t\n+\t\tString errorMessage = assertThrows(IllegalArgumentException.class, () -> {\n+\t\t\tsubmissionDAO.getSumOfSubmissionCRCsForEachEvaluation(ids);\n+\t\t}).getMessage();\n+\t\t\n+\t\tassertEquals(\"evaluationIds is required.\", errorMessage);\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testGetSumOfSubmissionCRCsForEachEvaluationWithEmptyInput() {\n+\t\t\n+\t\tList<Long> ids = Collections.emptyList();\n+\t\t\n+\t\tMap<Long, Long> result = submissionDAO.getSumOfSubmissionCRCsForEachEvaluation(ids);\n+\t\t\n+\t\tassertTrue(result.isEmpty());\n+\t\t\n+\t}\n+\n+\t@Test\n+\tpublic void testGetSubmissionData() {\n+\n+\t\tAnnotations annotations = AnnotationsV2Utils.emptyAnnotations();\n+\n+\t\tAnnotationsV2TestUtils.putAnnotations(annotations, \"foo\", \"fooValue\", AnnotationsValueType.STRING);\n+\t\tAnnotationsV2TestUtils.putAnnotations(annotations, \"bar\", \"42\", AnnotationsValueType.LONG);", "originalCommit": "bd60710ee35990b68611c154c76f5821a8d81382", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUyNjAzNg==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4056#discussion_r431526036", "bodyText": "add test for the new types", "author": "john-hill", "createdAt": "2020-05-28T01:03:18Z", "path": "lib/lib-table-cluster/src/main/java/org/sagebionetworks/table/cluster/SQLTranslatorUtils.java", "diffHunk": "@@ -202,6 +202,8 @@ public static boolean isNumericType(ColumnType columnType){\n \t\tcase DATE:\r\n \t\tcase FILEHANDLEID:\r\n \t\tcase USERID:\r\n+\t\tcase SUBMISSIONID:\r", "originalCommit": "bd60710ee35990b68611c154c76f5821a8d81382", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUyNjE5Mg==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4056#discussion_r431526192", "bodyText": "tests for new types", "author": "john-hill", "createdAt": "2020-05-28T01:03:58Z", "path": "lib/lib-table-cluster/src/main/java/org/sagebionetworks/table/cluster/SQLUtils.java", "diffHunk": "@@ -1353,6 +1353,8 @@ public static String translateColumnTypeToAnnotationValueName(ColumnType type){\n \t\tcase DATE:\r\n \t\tcase INTEGER:\r\n \t\tcase ENTITYID:\r\n+\t\tcase SUBMISSIONID:\r", "originalCommit": "bd60710ee35990b68611c154c76f5821a8d81382", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUyNjI3NA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4056#discussion_r431526274", "bodyText": "test for new types", "author": "john-hill", "createdAt": "2020-05-28T01:04:17Z", "path": "lib/lib-table-cluster/src/main/java/org/sagebionetworks/table/cluster/utils/TableModelUtils.java", "diffHunk": "@@ -766,6 +766,8 @@ public static int calculateMaxSizeForType(ColumnType type, Long maxSize, Long ma\n \t\t\tcase BOOLEAN:\r\n \t\t\t\treturn ColumnConstants.MAX_BOOLEAN_BYTES_AS_STRING;\r\n \t\t\tcase INTEGER:\r\n+\t\t\tcase SUBMISSIONID:\r", "originalCommit": "bd60710ee35990b68611c154c76f5821a8d81382", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}