{"pr_number": 4041, "pr_title": "additional LIKE filter API (PLFM-6192)", "pr_createdAt": "2020-05-12T23:01:11Z", "pr_url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4041", "timeline": [{"oid": "6c7c683deead91c79b2bc827c091fd8a53f4f4fa", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/6c7c683deead91c79b2bc827c091fd8a53f4f4fa", "message": "additional like filter", "committedDate": "2020-05-12T22:59:29Z", "type": "commit"}, {"oid": "57ff0b9182ada63a6a03813480861e37969f6fe2", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/57ff0b9182ada63a6a03813480861e37969f6fe2", "message": "wire up usage of additonal filters. make additonal filters modify resulting sql", "committedDate": "2020-05-12T23:13:24Z", "type": "commit"}, {"oid": "02c2a6e5768a7f222722271b2e5beeb7826d691f", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/02c2a6e5768a7f222722271b2e5beeb7826d691f", "message": "fix NPE", "committedDate": "2020-05-12T23:19:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDExODY0MQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4041#discussion_r424118641", "bodyText": "Consider move this to the SQLTranslatorUtils and rename it to translateQueryFilters", "author": "marcomarasca", "createdAt": "2020-05-13T01:11:51Z", "path": "lib/lib-table-cluster/src/main/java/org/sagebionetworks/table/cluster/SQLUtils.java", "diffHunk": "@@ -2046,4 +2047,63 @@ public static String getViewScopeSubTypeFilter(ViewScopeFilter scopeFilter) {\n \t\t\r\n \t\treturn builder.toString();\r\n \t}\r\n+\r\n+\tpublic static String appendAdditionalFilters(List<QueryFilter> additionalFilters){\r", "originalCommit": "02c2a6e5768a7f222722271b2e5beeb7826d691f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b0b4734632919fb34d28388cfc4fb00768df763e", "chunk": "diff --git a/lib/lib-table-cluster/src/main/java/org/sagebionetworks/table/cluster/SQLUtils.java b/lib/lib-table-cluster/src/main/java/org/sagebionetworks/table/cluster/SQLUtils.java\nindex b051dfb007..55f7e9a386 100644\n--- a/lib/lib-table-cluster/src/main/java/org/sagebionetworks/table/cluster/SQLUtils.java\n+++ b/lib/lib-table-cluster/src/main/java/org/sagebionetworks/table/cluster/SQLUtils.java\n\n@@ -2048,62 +2048,4 @@ public class SQLUtils {\n \t\treturn builder.toString();\n \t}\n \n-\tpublic static String appendAdditionalFilters(List<QueryFilter> additionalFilters){\n-\t\tValidateArgument.requiredNotEmpty(additionalFilters, \"additionalFilters\");\n-\n-\t\tStringBuilder additionalSearchConditionBuilder = new StringBuilder();\n-\n-\t\tboolean firstVal = true;\n-\n-\t\tfor(QueryFilter filter : additionalFilters){\n-\t\t\tif(!firstVal){\n-\t\t\t\tadditionalSearchConditionBuilder.append(\" AND \");\n-\t\t\t}\n-\t\t\tappendAdditionalFilters(additionalSearchConditionBuilder, filter);\n-\t\t\tfirstVal=false;\n-\t\t}\n-\n-\t\treturn additionalSearchConditionBuilder.toString();\n-\t}\n-\n-\tstatic void appendAdditionalFilters(StringBuilder builder, QueryFilter filter){\n-\t\tif(filter instanceof LikeQueryFilter){\n-\t\t\tappendLikeFilter(builder, (LikeQueryFilter) filter);\n-\t\t}else{\n-\t\t\tthrow new IllegalArgumentException(\"Unknown QueryFilter type\");\n-\t\t}\n-\t}\n-\n-\tstatic void appendLikeFilter(StringBuilder builder, LikeQueryFilter filter){\n-\t\tValidateArgument.requiredNotEmpty(filter.getColumnName(), \"likeQueryFilter.columnName\");\n-\t\tValidateArgument.requiredNotEmpty(filter.getLikeValues(), \"likeQueryFilter.likeValues\");\n-\n-\t\tbuilder.append(\"(\");\n-\t\tboolean firstVal = true;\n-\t\tString columnName = filter.getColumnName();\n-\t\tfor (String likeValue: filter.getLikeValues()){\n-\t\t\tif(!firstVal){\n-\t\t\t\tbuilder.append(\" OR \");\n-\t\t\t}\n-\t\t\tbuilder.append(\"\\\"\")\n-\t\t\t\t\t.append(columnName)\n-\t\t\t\t\t.append(\"\\\"\")\n-\t\t\t\t\t.append(\" LIKE \");\n-\t\t\tappendSingleQuotedValueToStringBuilder(builder, likeValue);\n-\n-\t\t\tfirstVal = false;\n-\t\t}\n-\t\tbuilder.append(\")\");\n-\t}\n-\n-\t/**\n-\t * Appends a value to the string builder\n-\t * and places single quotes (') around it if the column type is String\n-\t */\n-\tstatic void appendSingleQuotedValueToStringBuilder(StringBuilder builder, String value){\n-\t\tbuilder.append(\"'\");\n-\t\tbuilder.append(value.replaceAll(\"'\", \"''\"));\n-\t\tbuilder.append(\"'\");\n-\t}\n-\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEyMDczOA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4041#discussion_r424120738", "bodyText": "We could probably make this method generic (maybe move it to some query/sql util class) and reuse it for facets", "author": "marcomarasca", "createdAt": "2020-05-13T01:20:16Z", "path": "lib/lib-table-cluster/src/main/java/org/sagebionetworks/table/cluster/SqlQuery.java", "diffHunk": "@@ -178,6 +182,20 @@ public SqlQuery(\n \t\t\tSelectList expandedSelectList = SQLTranslatorUtils.createSelectListFromSchema(tableSchema);\r\n \t\t\tthis.model.replaceSelectList(expandedSelectList);\r\n \t\t}\r\n+\r\n+\r\n+\t\t//Append additionalFilters onto the WHERE clause\r\n+\t\tif(additionalFilters != null && !additionalFilters.isEmpty()) {\r\n+\t\t\tString additionalFilterSearchCondition = SQLUtils.appendAdditionalFilters(additionalFilters);\r\n+\t\t\tStringBuilder whereClauseBuilder = new StringBuilder();\r\n+\t\t\tFacetUtils.appendFacetWhereClauseToStringBuilderIfNecessary(whereClauseBuilder,additionalFilterSearchCondition, this.model.getTableExpression().getWhereClause());\r", "originalCommit": "02c2a6e5768a7f222722271b2e5beeb7826d691f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b0b4734632919fb34d28388cfc4fb00768df763e", "chunk": "diff --git a/lib/lib-table-cluster/src/main/java/org/sagebionetworks/table/cluster/SqlQuery.java b/lib/lib-table-cluster/src/main/java/org/sagebionetworks/table/cluster/SqlQuery.java\nindex ac6cf7c39c..b66b2dfc82 100644\n--- a/lib/lib-table-cluster/src/main/java/org/sagebionetworks/table/cluster/SqlQuery.java\n+++ b/lib/lib-table-cluster/src/main/java/org/sagebionetworks/table/cluster/SqlQuery.java\n\n@@ -186,9 +184,9 @@ public class SqlQuery {\n \n \t\t//Append additionalFilters onto the WHERE clause\n \t\tif(additionalFilters != null && !additionalFilters.isEmpty()) {\n-\t\t\tString additionalFilterSearchCondition = SQLUtils.appendAdditionalFilters(additionalFilters);\n+\t\t\tString additionalFilterSearchCondition = SQLTranslatorUtils.translateQueryFilters(additionalFilters);\n \t\t\tStringBuilder whereClauseBuilder = new StringBuilder();\n-\t\t\tFacetUtils.appendFacetWhereClauseToStringBuilderIfNecessary(whereClauseBuilder,additionalFilterSearchCondition, this.model.getTableExpression().getWhereClause());\n+\t\t\tSqlElementUntils.appendCombinedWhereClauseToStringBuilder(whereClauseBuilder,additionalFilterSearchCondition, this.model.getTableExpression().getWhereClause());\n \t\t\ttry {\n \t\t\t\tthis.model.getTableExpression().replaceWhere(new TableQueryParser(whereClauseBuilder.toString()).whereClause());\n \t\t\t} catch (ParseException e) {\n"}}, {"oid": "b0b4734632919fb34d28388cfc4fb00768df763e", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/b0b4734632919fb34d28388cfc4fb00768df763e", "message": "move static methods to diffent classes", "committedDate": "2020-05-14T02:24:17Z", "type": "commit"}, {"oid": "891243d537c70d9be710fb1f911a83860143d224", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/891243d537c70d9be710fb1f911a83860143d224", "message": "use enum for QueryFilter operators", "committedDate": "2020-05-14T02:41:57Z", "type": "commit"}, {"oid": "44b1d4366d517e3a28c668a23cd8555013e87307", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/44b1d4366d517e3a28c668a23cd8555013e87307", "message": "fix test", "committedDate": "2020-05-14T04:25:49Z", "type": "commit"}, {"oid": "e3fb5449cca4929174e60e60b327296a3dae44c5", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/e3fb5449cca4929174e60e60b327296a3dae44c5", "message": "Merge branch 'develop' into PLFM-6192", "committedDate": "2020-05-15T23:09:23Z", "type": "commit"}]}