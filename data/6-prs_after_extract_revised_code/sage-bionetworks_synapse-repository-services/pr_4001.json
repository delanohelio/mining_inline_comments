{"pr_number": 4001, "pr_title": "validate multi-value column before schema change is accepted (PLFM-6190)", "pr_createdAt": "2020-04-15T05:07:58Z", "pr_url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4001", "timeline": [{"oid": "73b5c657d9a6747dcbb86596c082f07f1941f4ab", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/73b5c657d9a6747dcbb86596c082f07f1941f4ab", "message": "altertemp for multivalue column dao functions", "committedDate": "2020-04-15T02:38:13Z", "type": "commit"}, {"oid": "c3c71482811e8a9209a2f0ac0518148f490c491f", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/c3c71482811e8a9209a2f0ac0518148f490c491f", "message": "fix sql for update and finsihed test", "committedDate": "2020-04-15T05:07:06Z", "type": "commit"}, {"oid": "716467812d2a546710e7dcd7104c3e7899ae0446", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/716467812d2a546710e7dcd7104c3e7899ae0446", "message": "fixtests", "committedDate": "2020-04-15T05:18:55Z", "type": "commit"}, {"oid": "26cad81b6c87d74217f0a9119469e06fb5958f65", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/26cad81b6c87d74217f0a9119469e06fb5958f65", "message": "cleanup", "committedDate": "2020-04-16T03:31:26Z", "type": "commit"}, {"oid": "ace8cb7e9fa53f6a9164229e18e7f81acd1e025c", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/ace8cb7e9fa53f6a9164229e18e7f81acd1e025c", "message": "why is it deleted", "committedDate": "2020-04-16T03:56:11Z", "type": "commit"}, {"oid": "62ed53b67fd18f3debd1d556c56900640284de0f", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/62ed53b67fd18f3debd1d556c56900640284de0f", "message": "temporarily build 1 test", "committedDate": "2020-04-16T04:06:58Z", "type": "commit"}, {"oid": "ffc9f59973c46b140307d4848babdc71ad4794b2", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/ffc9f59973c46b140307d4848babdc71ad4794b2", "message": "retry build", "committedDate": "2020-04-16T04:13:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkwNjA1OQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4001#discussion_r409906059", "bodyText": "alterTemp=false;", "author": "john-hill", "createdAt": "2020-04-16T23:27:48Z", "path": "lib/lib-table-cluster/src/main/java/org/sagebionetworks/table/cluster/TableIndexDAOImpl.java", "diffHunk": "@@ -165,7 +165,7 @@ private static TransactionTemplate createTransactionTemplate(DataSourceTransacti\n \r\n \t@Override\r\n \tpublic void deleteTable(IdAndVersion tableId) {\r\n-\t\tdeleteMultiValueTablesForTable(tableId);\r\n+\t\tdeleteMultiValueTablesForTable(tableId, false);\r", "originalCommit": "ffc9f59973c46b140307d4848babdc71ad4794b2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkwNjE1MA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4001#discussion_r409906150", "bodyText": "alterTemp=false", "author": "john-hill", "createdAt": "2020-04-16T23:28:06Z", "path": "lib/lib-table-cluster/src/main/java/org/sagebionetworks/table/cluster/TableIndexDAOImpl.java", "diffHunk": "@@ -446,32 +447,32 @@ public boolean alterTableAsNeeded(IdAndVersion tableId, List<ColumnChangeDetails\n \r\n \t@Override\r\n \tpublic Set<Long> getMultivalueColumnIndexTableColumnIds(IdAndVersion tableId){\r\n-\t\treturn getMultivalueColumnIndexTableNames(tableId)\r\n+\t\treturn getMultivalueColumnIndexTableNames(tableId, false)\r", "originalCommit": "ffc9f59973c46b140307d4848babdc71ad4794b2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkwNzMwMQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4001#discussion_r409907301", "bodyText": "altertemp=false", "author": "john-hill", "createdAt": "2020-04-16T23:31:39Z", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/table/TableIndexManagerImpl.java", "diffHunk": "@@ -111,7 +111,7 @@ public void applyChangeSetToIndex(final IdAndVersion tableId, final SparseChange\n \t\t\t\t\t\t\t//once all changes to main table are applied, populate the list-type columns with the changes.\r\n \t\t\t\t\t\t\tfor(ListColumnRowChanges listColumnChange : rowset.groupListColumnChanges()){\r\n \t\t\t\t\t\t\t\ttableIndexDao.deleteFromListColumnIndexTable(tableId, listColumnChange.getColumnModel(), listColumnChange.getRowIds());\r\n-\t\t\t\t\t\t\t\ttableIndexDao.populateListColumnIndexTable(tableId, listColumnChange.getColumnModel(), listColumnChange.getRowIds());\r\n+\t\t\t\t\t\t\t\ttableIndexDao.populateListColumnIndexTable(tableId, listColumnChange.getColumnModel(), listColumnChange.getRowIds(), false);\r", "originalCommit": "ffc9f59973c46b140307d4848babdc71ad4794b2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkwNzUyMA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4001#discussion_r409907520", "bodyText": "alterTemp=false", "author": "john-hill", "createdAt": "2020-04-16T23:32:23Z", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/table/TableIndexManagerImpl.java", "diffHunk": "@@ -354,26 +356,30 @@ public void populateListColumnIndexTables(final IdAndVersion tableIdAndVersion,\n \t\tValidateArgument.required(schema, \"schema\");\r\n \t\tfor(ColumnModel column: schema) {\r\n \t\t\tif (ColumnTypeListMappings.isList(column.getColumnType())) {\r\n-\t\t\t\ttableIndexDao.populateListColumnIndexTable(tableIdAndVersion, column, rowIds);\r\n+\t\t\t\ttableIndexDao.populateListColumnIndexTable(tableIdAndVersion, column, rowIds, false);\r", "originalCommit": "ffc9f59973c46b140307d4848babdc71ad4794b2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}