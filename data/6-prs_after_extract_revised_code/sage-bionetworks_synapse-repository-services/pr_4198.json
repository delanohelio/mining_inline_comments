{"pr_number": 4198, "pr_title": "Plfm 5960", "pr_createdAt": "2020-09-16T18:30:55Z", "pr_url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4198", "timeline": [{"oid": "d9ff8948123b209c57bdf1b09240a4d87432a551", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/d9ff8948123b209c57bdf1b09240a4d87432a551", "message": " added test, added ORDER BY", "committedDate": "2020-09-16T01:01:57Z", "type": "commit"}, {"oid": "880e7f3ce593e9b8181492d670a52989187e3cc9", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/880e7f3ce593e9b8181492d670a52989187e3cc9", "message": " order by most recent", "committedDate": "2020-09-16T17:46:54Z", "type": "commit"}, {"oid": "0b318707dcef42294bb9250558b3bd7bd772a61b", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/0b318707dcef42294bb9250558b3bd7bd772a61b", "message": " minor description change", "committedDate": "2020-09-16T18:01:04Z", "type": "commit"}, {"oid": "79bfb87b7be654d668c18aba74c16244dab50db8", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/79bfb87b7be654d668c18aba74c16244dab50db8", "message": "Merge branch 'develop' of github.com:/Sage-Bionetworks/Synapse-Repository-Services into PLFM-5960", "committedDate": "2020-09-16T18:29:46Z", "type": "commit"}, {"oid": "de8cadacbaf2c9fef235480f175c3c0805c4b952", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/de8cadacbaf2c9fef235480f175c3c0805c4b952", "message": " file view information", "committedDate": "2020-09-16T20:11:24Z", "type": "commit"}, {"oid": "3534e5fbc18de59ec056e49ee375571f2fd445a0", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/3534e5fbc18de59ec056e49ee375571f2fd445a0", "message": " file view info", "committedDate": "2020-09-16T20:20:31Z", "type": "commit"}, {"oid": "df659ca5d5eaa451be389da19c1a5bec39a03bfd", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/df659ca5d5eaa451be389da19c1a5bec39a03bfd", "message": " fix", "committedDate": "2020-09-16T20:28:38Z", "type": "commit"}, {"oid": "cc914cd085ece396d19756c8f6b3ddf0553a6e02", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/cc914cd085ece396d19756c8f6b3ddf0553a6e02", "message": " fixed test", "committedDate": "2020-09-16T20:36:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc5ODI0MA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4198#discussion_r489798240", "bodyText": "This order by will effectively switch (or at least different) the order compared to the current implementation (which we can say it's undefined, but most likely ordered by the node id). An order by should still be specified when applying a limit, but to keep it \"backward compatible\" I'd probably order by the N.ID.", "author": "marcomarasca", "createdAt": "2020-09-16T22:56:15Z", "path": "lib/jdomodels/src/main/java/org/sagebionetworks/repo/model/dbo/dao/NodeDAOImpl.java", "diffHunk": "@@ -353,17 +395,16 @@\n \t\t\t+ \" DESC LIMIT :\"+LIMIT_PARAM_NAME+\" OFFSET :\"+OFFSET_PARAM_NAME;\n \n \t/**\n-\t * The max number of entity versions a MD5 string can map to. This puts a check\n-\t * to potential DDOS attacks via MD5. We retrieve at most MD5_LIMIT + 1 rows.\n-\t * If the number of rows retrieved is > MD5_LIMIT, an exception is thrown.\n+\t * A sql query returning results for entity headers with a specific MD5 value\n \t */\n \tprivate static final int NODE_VERSION_LIMIT_BY_FILE_MD5 = 200;\n \tprivate static final String SELECT_NODE_VERSION_BY_FILE_MD5 =\n \t\t\tENTITY_HEADER_SELECT\n-\t\t\t+ \" FROM \" + TABLE_REVISION + \" R, \" + TABLE_FILES + \" F, \"+TABLE_NODE+\" N\"\n-\t\t\t+ \" WHERE R.\"+COL_REVISION_OWNER_NODE+\" = N.\"+COL_NODE_ID+\" AND  R.\" + COL_REVISION_FILE_HANDLE_ID + \" = F.\" + COL_FILES_ID\n+\t\t\t+ \" FROM \" + TABLE_REVISION + \" R, \" + TABLE_FILES + \" F, \" + TABLE_NODE + \" N\"\n+\t\t\t+ \" WHERE R.\" + COL_REVISION_OWNER_NODE + \" = N.\"+COL_NODE_ID+\" AND  R.\" + COL_REVISION_FILE_HANDLE_ID + \" = F.\" + COL_FILES_ID\n \t\t\t+ \" AND F.\" + COL_FILES_CONTENT_MD5 + \" = :\" + COL_FILES_CONTENT_MD5\n-\t\t\t+ \" LIMIT \" + (NODE_VERSION_LIMIT_BY_FILE_MD5 + 1);\n+\t\t\t+ \" ORDER BY N.\" + COL_NODE_CREATED_ON + \" DESC\"", "originalCommit": "cc914cd085ece396d19756c8f6b3ddf0553a6e02", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "327581777b4509e7f3950f945e389fe5ee6c49ec", "chunk": "diff --git a/lib/jdomodels/src/main/java/org/sagebionetworks/repo/model/dbo/dao/NodeDAOImpl.java b/lib/jdomodels/src/main/java/org/sagebionetworks/repo/model/dbo/dao/NodeDAOImpl.java\nindex 0eee32c559..7a455de8fd 100644\n--- a/lib/jdomodels/src/main/java/org/sagebionetworks/repo/model/dbo/dao/NodeDAOImpl.java\n+++ b/lib/jdomodels/src/main/java/org/sagebionetworks/repo/model/dbo/dao/NodeDAOImpl.java\n\n@@ -397,14 +397,13 @@ public class NodeDAOImpl implements NodeDAO, InitializingBean {\n \t/**\n \t * A sql query returning results for entity headers with a specific MD5 value\n \t */\n-\tprivate static final int NODE_VERSION_LIMIT_BY_FILE_MD5 = 200;\n \tprivate static final String SELECT_NODE_VERSION_BY_FILE_MD5 =\n \t\t\tENTITY_HEADER_SELECT\n \t\t\t+ \" FROM \" + TABLE_REVISION + \" R, \" + TABLE_FILES + \" F, \" + TABLE_NODE + \" N\"\n \t\t\t+ \" WHERE R.\" + COL_REVISION_OWNER_NODE + \" = N.\"+COL_NODE_ID+\" AND  R.\" + COL_REVISION_FILE_HANDLE_ID + \" = F.\" + COL_FILES_ID\n \t\t\t+ \" AND F.\" + COL_FILES_CONTENT_MD5 + \" = :\" + COL_FILES_CONTENT_MD5\n-\t\t\t+ \" ORDER BY N.\" + COL_NODE_CREATED_ON + \" DESC\"\n-\t\t\t+ \" LIMIT \" + NODE_VERSION_LIMIT_BY_FILE_MD5;\n+\t\t\t+ \" ORDER BY N.\" + COL_NODE_ID\n+\t\t\t+ \" LIMIT \" + NodeDAO.NODE_VERSION_LIMIT_BY_FILE_MD5;\n \t\n \t/**\n \t * A recursive sql call to get the full path of a given entity id (?). The limit\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc5OTIxMA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4198#discussion_r489799210", "bodyText": "We can simply say that it returns at most 200 entities matching the given md5 for which the user has read access.", "author": "marcomarasca", "createdAt": "2020-09-16T22:59:28Z", "path": "services/repository/src/main/java/org/sagebionetworks/repo/web/controller/EntityController.java", "diffHunk": "@@ -1424,7 +1423,13 @@ public void filePreviewRedirectURLForVersion(\n \n \t/**\n \t * Gets all FileEntities whose file's MD5 is the same as the specified MD5\n-\t * string.\n+\t * string. NOTE: This will return a subset of at most 200 entity headers that is the\n+\t * intersection of the set of the most recently created entity headers with the specified MD5 string and", "originalCommit": "cc914cd085ece396d19756c8f6b3ddf0553a6e02", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "327581777b4509e7f3950f945e389fe5ee6c49ec", "chunk": "diff --git a/services/repository/src/main/java/org/sagebionetworks/repo/web/controller/EntityController.java b/services/repository/src/main/java/org/sagebionetworks/repo/web/controller/EntityController.java\nindex 1950fb3471..b085a75741 100644\n--- a/services/repository/src/main/java/org/sagebionetworks/repo/web/controller/EntityController.java\n+++ b/services/repository/src/main/java/org/sagebionetworks/repo/web/controller/EntityController.java\n\n@@ -1422,14 +1422,10 @@ public class EntityController {\n \t}\n \n \t/**\n-\t * Gets all FileEntities whose file's MD5 is the same as the specified MD5\n-\t * string. NOTE: This will return a subset of at most 200 entity headers that is the\n-\t * intersection of the set of the most recently created entity headers with the specified MD5 string and\n-\t * the set of entities which the user has access to. To look at MD5 values of entities\n-\t * in a specific project, create a file view.\n+\t * Gets at most 200 FileEntities matching the given MD5 string which the\n+\t * user has read access to. NOTE: Another option is to create a file view that includes MD5 values.\n \t * See <a href=\"https://docs.synapse.org/articles/views.html\">https://docs.synapse.org/articles/views.html</a>\n \t *\n-\t *\n \t * \n \t * @param md5\n \t * @param userId The user making the request\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc5OTU2NA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4198#discussion_r489799564", "bodyText": "Not necessarily for a project only, I would just mention that for more flexibility a file view that includes the MD5 can be used.", "author": "marcomarasca", "createdAt": "2020-09-16T23:00:27Z", "path": "services/repository/src/main/java/org/sagebionetworks/repo/web/controller/EntityController.java", "diffHunk": "@@ -1424,7 +1423,13 @@ public void filePreviewRedirectURLForVersion(\n \n \t/**\n \t * Gets all FileEntities whose file's MD5 is the same as the specified MD5\n-\t * string.\n+\t * string. NOTE: This will return a subset of at most 200 entity headers that is the\n+\t * intersection of the set of the most recently created entity headers with the specified MD5 string and\n+\t * the set of entities which the user has access to. To look at MD5 values of entities\n+\t * in a specific project, create a file view.", "originalCommit": "cc914cd085ece396d19756c8f6b3ddf0553a6e02", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "327581777b4509e7f3950f945e389fe5ee6c49ec", "chunk": "diff --git a/services/repository/src/main/java/org/sagebionetworks/repo/web/controller/EntityController.java b/services/repository/src/main/java/org/sagebionetworks/repo/web/controller/EntityController.java\nindex 1950fb3471..b085a75741 100644\n--- a/services/repository/src/main/java/org/sagebionetworks/repo/web/controller/EntityController.java\n+++ b/services/repository/src/main/java/org/sagebionetworks/repo/web/controller/EntityController.java\n\n@@ -1422,14 +1422,10 @@ public class EntityController {\n \t}\n \n \t/**\n-\t * Gets all FileEntities whose file's MD5 is the same as the specified MD5\n-\t * string. NOTE: This will return a subset of at most 200 entity headers that is the\n-\t * intersection of the set of the most recently created entity headers with the specified MD5 string and\n-\t * the set of entities which the user has access to. To look at MD5 values of entities\n-\t * in a specific project, create a file view.\n+\t * Gets at most 200 FileEntities matching the given MD5 string which the\n+\t * user has read access to. NOTE: Another option is to create a file view that includes MD5 values.\n \t * See <a href=\"https://docs.synapse.org/articles/views.html\">https://docs.synapse.org/articles/views.html</a>\n \t *\n-\t *\n \t * \n \t * @param md5\n \t * @param userId The user making the request\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgwMDMxNw==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4198#discussion_r489800317", "bodyText": "We can rename this to testGetEntityHeaderByMd5WithNoMatch", "author": "marcomarasca", "createdAt": "2020-09-16T23:02:51Z", "path": "lib/jdomodels/src/test/java/org/sagebionetworks/repo/model/dbo/dao/NodeDAOImplTest.java", "diffHunk": "@@ -2339,80 +2340,35 @@ public void testCreateTableNode() throws DatastoreException, InvalidModelExcepti\n \t\tassertEquals(expected, n1.getColumnModelIds());\r\n \t}\r\n \r\n+\t/**\r\n+\t * PLFM-5960\r\n+\t * @throws Exception\r\n+\t */\r\n \t@Test\r\n \tpublic void testGetEntityHeaderByMd5() throws Exception {\r", "originalCommit": "cc914cd085ece396d19756c8f6b3ddf0553a6e02", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "327581777b4509e7f3950f945e389fe5ee6c49ec", "chunk": "diff --git a/lib/jdomodels/src/test/java/org/sagebionetworks/repo/model/dbo/dao/NodeDAOImplTest.java b/lib/jdomodels/src/test/java/org/sagebionetworks/repo/model/dbo/dao/NodeDAOImplTest.java\nindex 5a882603ca..74250afd4f 100644\n--- a/lib/jdomodels/src/test/java/org/sagebionetworks/repo/model/dbo/dao/NodeDAOImplTest.java\n+++ b/lib/jdomodels/src/test/java/org/sagebionetworks/repo/model/dbo/dao/NodeDAOImplTest.java\n\n@@ -2340,35 +2340,39 @@ public class NodeDAOImplTest {\n \t\tassertEquals(expected, n1.getColumnModelIds());\n \t}\n \n+\n+\n \t/**\n \t * PLFM-5960\n \t * @throws Exception\n \t */\n \t@Test\n-\tpublic void testGetEntityHeaderByMd5() throws Exception {\n-\n-\t\t// Nothing yet\n+\tpublic void testGetEntityHeaderByMd5NoMatches() {\n+\t\t// Call under test\n \t\tList<EntityHeader> results = nodeDao.getEntityHeaderByMd5(fileHandle3.getContentMd5());\n \t\tassertNotNull(results);\n \t\tassertEquals(0, results.size());\n+\t}\n \n-\t\tfor(int i = 0; i < 202; i++) {\n+\t/**\n+\t * PLFM-5960\n+\t */\n+\t@Test\n+\tpublic void testGetEntityHeaderByMd5WithOver200Matching() {\n+\n+\t\tfor(int i = 0; i < NodeDAO.NODE_VERSION_LIMIT_BY_FILE_MD5 + 1; i++) {\n \t\t\t// Add a node with a file handle\n \t\t\tNode curr = NodeTestUtils.createNew(\"testGetEntityHeaderByMd5 node \" + i, creatorUserGroupId);\n \t\t\tcurr.setFileHandleId(fileHandle3.getId());\n-\t\t\tfinal String nodeLabel = \"\" + i;\n-\t\t\tcurr.setVersionLabel(nodeLabel);\n \t\t\tfinal String id = nodeDao.createNew(curr);\n-\t\t\tcurr = nodeDao.getNode(id);\n \t\t\tassertNotNull(id);\n \t\t\ttoDelete.add(id);\n-\t\t\tcurr.setId(id);\n \t\t}\n \n-\t\tresults = nodeDao.getEntityHeaderByMd5(fileHandle3.getContentMd5());\n+\t\t// Call under test\n+\t\tList<EntityHeader> results = nodeDao.getEntityHeaderByMd5(fileHandle3.getContentMd5());\n \t\tassertNotNull(results);\n-\t\tassertEquals(200, results.size());\n-\n+\t\tassertEquals(NodeDAO.NODE_VERSION_LIMIT_BY_FILE_MD5, results.size());\n \t}\n \t\n \t@Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgwMDQ1MA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4198#discussion_r489800450", "bodyText": "Let us separate this into its own test, e.g. testGetEntityHeaderByMd5WithOver200Macthing", "author": "marcomarasca", "createdAt": "2020-09-16T23:03:16Z", "path": "lib/jdomodels/src/test/java/org/sagebionetworks/repo/model/dbo/dao/NodeDAOImplTest.java", "diffHunk": "@@ -2339,80 +2340,35 @@ public void testCreateTableNode() throws DatastoreException, InvalidModelExcepti\n \t\tassertEquals(expected, n1.getColumnModelIds());\r\n \t}\r\n \r\n+\t/**\r\n+\t * PLFM-5960\r\n+\t * @throws Exception\r\n+\t */\r\n \t@Test\r\n \tpublic void testGetEntityHeaderByMd5() throws Exception {\r\n \r\n \t\t// Nothing yet\r\n-\t\tList<EntityHeader> results = nodeDao.getEntityHeaderByMd5(\"md5\");\r\n+\t\tList<EntityHeader> results = nodeDao.getEntityHeaderByMd5(fileHandle3.getContentMd5());\r\n \t\tassertNotNull(results);\r\n \t\tassertEquals(0, results.size());\r\n \r\n-\t\t// Add a node with a file handle\r\n-\t\tNode node1 = NodeTestUtils.createNew(\"testGetEntityHeaderByMd5 node 1\", creatorUserGroupId);\r\n-\t\tnode1.setFileHandleId(fileHandle.getId());\r\n-\t\tfinal String node1Label1 = \"1\";\r\n-\t\tnode1.setVersionLabel(node1Label1);\r\n-\t\tfinal String id1 = nodeDao.createNew(node1);\r\n-\t\tnode1 = nodeDao.getNode(id1);\r\n-\t\tassertNotNull(id1);\r\n-\t\ttoDelete.add(id1);\r\n-\t\tnode1.setId(id1);\r\n-\r\n-\t\tresults = nodeDao.getEntityHeaderByMd5(fileHandle.getContentMd5());\r\n-\t\tassertNotNull(results);\r\n-\t\tassertEquals(1, results.size());\r\n-\t\tassertEquals(id1, results.get(0).getId());\r\n-\t\tassertNotNull(results.get(0).getBenefactorId());\r\n-\t\tassertEquals(Long.valueOf(1L), results.get(0).getVersionNumber());\r\n-\t\tassertEquals(node1Label1, results.get(0).getVersionLabel());\r\n-\t\tassertEquals(node1.getCreatedByPrincipalId().toString(), results.get(0).getCreatedBy());\r\n-\t\tassertEquals(node1.getCreatedOn(), results.get(0).getCreatedOn());\r\n-\t\tassertEquals(node1.getModifiedByPrincipalId().toString(), results.get(0).getModifiedBy());\r\n-\t\tassertEquals(node1.getModifiedOn(), results.get(0).getModifiedOn());\r\n-\r\n-\t\t// Create a new version of the node of the same file\r\n-\t\tfinal String node1Label2 = \"Node 1 version label 2\";\r\n-\t\tnode1.setVersionLabel(node1Label2);\r\n-\t\tnodeDao.createNewVersion(node1);\r\n-\r\n-\t\tresults = nodeDao.getEntityHeaderByMd5(fileHandle.getContentMd5());\r\n-\t\tassertNotNull(results);\r\n-\t\tassertEquals(2, results.size());\r\n-\t\tassertEquals(id1, results.get(0).getId());\r\n-\t\tassertEquals(id1, results.get(1).getId());\r\n-\t\tassertFalse(results.get(0).getVersionNumber().equals(results.get(1).getVersionNumber()));\r\n-\r\n-\t\t// Add a new node with no file handle\r\n-\t\tNode node2 = NodeTestUtils.createNew(\"testGetEntityHeaderByMd5 node 2\", creatorUserGroupId);\r\n-\t\tfinal String node2Label1 = \"Node 2 version label 1\";\r\n-\t\tnode1.setVersionLabel(node2Label1);\r\n-\t\tfinal String id2 = nodeDao.createNew(node2);\r\n-\t\tassertNotNull(id2);\r\n-\t\ttoDelete.add(id2);\r\n-\t\tnode2.setId(id2);\r\n+\t\tfor(int i = 0; i < 202; i++) {\r", "originalCommit": "cc914cd085ece396d19756c8f6b3ddf0553a6e02", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "327581777b4509e7f3950f945e389fe5ee6c49ec", "chunk": "diff --git a/lib/jdomodels/src/test/java/org/sagebionetworks/repo/model/dbo/dao/NodeDAOImplTest.java b/lib/jdomodels/src/test/java/org/sagebionetworks/repo/model/dbo/dao/NodeDAOImplTest.java\nindex 5a882603ca..74250afd4f 100644\n--- a/lib/jdomodels/src/test/java/org/sagebionetworks/repo/model/dbo/dao/NodeDAOImplTest.java\n+++ b/lib/jdomodels/src/test/java/org/sagebionetworks/repo/model/dbo/dao/NodeDAOImplTest.java\n\n@@ -2340,35 +2340,39 @@ public class NodeDAOImplTest {\n \t\tassertEquals(expected, n1.getColumnModelIds());\n \t}\n \n+\n+\n \t/**\n \t * PLFM-5960\n \t * @throws Exception\n \t */\n \t@Test\n-\tpublic void testGetEntityHeaderByMd5() throws Exception {\n-\n-\t\t// Nothing yet\n+\tpublic void testGetEntityHeaderByMd5NoMatches() {\n+\t\t// Call under test\n \t\tList<EntityHeader> results = nodeDao.getEntityHeaderByMd5(fileHandle3.getContentMd5());\n \t\tassertNotNull(results);\n \t\tassertEquals(0, results.size());\n+\t}\n \n-\t\tfor(int i = 0; i < 202; i++) {\n+\t/**\n+\t * PLFM-5960\n+\t */\n+\t@Test\n+\tpublic void testGetEntityHeaderByMd5WithOver200Matching() {\n+\n+\t\tfor(int i = 0; i < NodeDAO.NODE_VERSION_LIMIT_BY_FILE_MD5 + 1; i++) {\n \t\t\t// Add a node with a file handle\n \t\t\tNode curr = NodeTestUtils.createNew(\"testGetEntityHeaderByMd5 node \" + i, creatorUserGroupId);\n \t\t\tcurr.setFileHandleId(fileHandle3.getId());\n-\t\t\tfinal String nodeLabel = \"\" + i;\n-\t\t\tcurr.setVersionLabel(nodeLabel);\n \t\t\tfinal String id = nodeDao.createNew(curr);\n-\t\t\tcurr = nodeDao.getNode(id);\n \t\t\tassertNotNull(id);\n \t\t\ttoDelete.add(id);\n-\t\t\tcurr.setId(id);\n \t\t}\n \n-\t\tresults = nodeDao.getEntityHeaderByMd5(fileHandle3.getContentMd5());\n+\t\t// Call under test\n+\t\tList<EntityHeader> results = nodeDao.getEntityHeaderByMd5(fileHandle3.getContentMd5());\n \t\tassertNotNull(results);\n-\t\tassertEquals(200, results.size());\n-\n+\t\tassertEquals(NodeDAO.NODE_VERSION_LIMIT_BY_FILE_MD5, results.size());\n \t}\n \t\n \t@Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgwMTI0OA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4198#discussion_r489801248", "bodyText": "This is not needed.", "author": "marcomarasca", "createdAt": "2020-09-16T23:05:50Z", "path": "lib/jdomodels/src/test/java/org/sagebionetworks/repo/model/dbo/dao/NodeDAOImplTest.java", "diffHunk": "@@ -2339,80 +2340,35 @@ public void testCreateTableNode() throws DatastoreException, InvalidModelExcepti\n \t\tassertEquals(expected, n1.getColumnModelIds());\r\n \t}\r\n \r\n+\t/**\r\n+\t * PLFM-5960\r\n+\t * @throws Exception\r\n+\t */\r\n \t@Test\r\n \tpublic void testGetEntityHeaderByMd5() throws Exception {\r\n \r\n \t\t// Nothing yet\r\n-\t\tList<EntityHeader> results = nodeDao.getEntityHeaderByMd5(\"md5\");\r\n+\t\tList<EntityHeader> results = nodeDao.getEntityHeaderByMd5(fileHandle3.getContentMd5());\r\n \t\tassertNotNull(results);\r\n \t\tassertEquals(0, results.size());\r\n \r\n-\t\t// Add a node with a file handle\r\n-\t\tNode node1 = NodeTestUtils.createNew(\"testGetEntityHeaderByMd5 node 1\", creatorUserGroupId);\r\n-\t\tnode1.setFileHandleId(fileHandle.getId());\r\n-\t\tfinal String node1Label1 = \"1\";\r\n-\t\tnode1.setVersionLabel(node1Label1);\r\n-\t\tfinal String id1 = nodeDao.createNew(node1);\r\n-\t\tnode1 = nodeDao.getNode(id1);\r\n-\t\tassertNotNull(id1);\r\n-\t\ttoDelete.add(id1);\r\n-\t\tnode1.setId(id1);\r\n-\r\n-\t\tresults = nodeDao.getEntityHeaderByMd5(fileHandle.getContentMd5());\r\n-\t\tassertNotNull(results);\r\n-\t\tassertEquals(1, results.size());\r\n-\t\tassertEquals(id1, results.get(0).getId());\r\n-\t\tassertNotNull(results.get(0).getBenefactorId());\r\n-\t\tassertEquals(Long.valueOf(1L), results.get(0).getVersionNumber());\r\n-\t\tassertEquals(node1Label1, results.get(0).getVersionLabel());\r\n-\t\tassertEquals(node1.getCreatedByPrincipalId().toString(), results.get(0).getCreatedBy());\r\n-\t\tassertEquals(node1.getCreatedOn(), results.get(0).getCreatedOn());\r\n-\t\tassertEquals(node1.getModifiedByPrincipalId().toString(), results.get(0).getModifiedBy());\r\n-\t\tassertEquals(node1.getModifiedOn(), results.get(0).getModifiedOn());\r\n-\r\n-\t\t// Create a new version of the node of the same file\r\n-\t\tfinal String node1Label2 = \"Node 1 version label 2\";\r\n-\t\tnode1.setVersionLabel(node1Label2);\r\n-\t\tnodeDao.createNewVersion(node1);\r\n-\r\n-\t\tresults = nodeDao.getEntityHeaderByMd5(fileHandle.getContentMd5());\r\n-\t\tassertNotNull(results);\r\n-\t\tassertEquals(2, results.size());\r\n-\t\tassertEquals(id1, results.get(0).getId());\r\n-\t\tassertEquals(id1, results.get(1).getId());\r\n-\t\tassertFalse(results.get(0).getVersionNumber().equals(results.get(1).getVersionNumber()));\r\n-\r\n-\t\t// Add a new node with no file handle\r\n-\t\tNode node2 = NodeTestUtils.createNew(\"testGetEntityHeaderByMd5 node 2\", creatorUserGroupId);\r\n-\t\tfinal String node2Label1 = \"Node 2 version label 1\";\r\n-\t\tnode1.setVersionLabel(node2Label1);\r\n-\t\tfinal String id2 = nodeDao.createNew(node2);\r\n-\t\tassertNotNull(id2);\r\n-\t\ttoDelete.add(id2);\r\n-\t\tnode2.setId(id2);\r\n+\t\tfor(int i = 0; i < 202; i++) {\r\n+\t\t\t// Add a node with a file handle\r\n+\t\t\tNode curr = NodeTestUtils.createNew(\"testGetEntityHeaderByMd5 node \" + i, creatorUserGroupId);\r\n+\t\t\tcurr.setFileHandleId(fileHandle3.getId());\r\n+\t\t\tfinal String nodeLabel = \"\" + i;\r\n+\t\t\tcurr.setVersionLabel(nodeLabel);\r\n+\t\t\tfinal String id = nodeDao.createNew(curr);\r\n+\t\t\tcurr = nodeDao.getNode(id);\r\n+\t\t\tassertNotNull(id);\r\n+\t\t\ttoDelete.add(id);\r\n+\t\t\tcurr.setId(id);\r", "originalCommit": "cc914cd085ece396d19756c8f6b3ddf0553a6e02", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU1MTc3Ng==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4198#discussion_r490551776", "bodyText": "must add the id to the toDelete list which deletes values in the after() section of the test", "author": "nlgilber", "createdAt": "2020-09-17T20:45:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgwMTI0OA=="}], "type": "inlineReview", "revised_code": {"commit": "327581777b4509e7f3950f945e389fe5ee6c49ec", "chunk": "diff --git a/lib/jdomodels/src/test/java/org/sagebionetworks/repo/model/dbo/dao/NodeDAOImplTest.java b/lib/jdomodels/src/test/java/org/sagebionetworks/repo/model/dbo/dao/NodeDAOImplTest.java\nindex 5a882603ca..74250afd4f 100644\n--- a/lib/jdomodels/src/test/java/org/sagebionetworks/repo/model/dbo/dao/NodeDAOImplTest.java\n+++ b/lib/jdomodels/src/test/java/org/sagebionetworks/repo/model/dbo/dao/NodeDAOImplTest.java\n\n@@ -2340,35 +2340,39 @@ public class NodeDAOImplTest {\n \t\tassertEquals(expected, n1.getColumnModelIds());\n \t}\n \n+\n+\n \t/**\n \t * PLFM-5960\n \t * @throws Exception\n \t */\n \t@Test\n-\tpublic void testGetEntityHeaderByMd5() throws Exception {\n-\n-\t\t// Nothing yet\n+\tpublic void testGetEntityHeaderByMd5NoMatches() {\n+\t\t// Call under test\n \t\tList<EntityHeader> results = nodeDao.getEntityHeaderByMd5(fileHandle3.getContentMd5());\n \t\tassertNotNull(results);\n \t\tassertEquals(0, results.size());\n+\t}\n \n-\t\tfor(int i = 0; i < 202; i++) {\n+\t/**\n+\t * PLFM-5960\n+\t */\n+\t@Test\n+\tpublic void testGetEntityHeaderByMd5WithOver200Matching() {\n+\n+\t\tfor(int i = 0; i < NodeDAO.NODE_VERSION_LIMIT_BY_FILE_MD5 + 1; i++) {\n \t\t\t// Add a node with a file handle\n \t\t\tNode curr = NodeTestUtils.createNew(\"testGetEntityHeaderByMd5 node \" + i, creatorUserGroupId);\n \t\t\tcurr.setFileHandleId(fileHandle3.getId());\n-\t\t\tfinal String nodeLabel = \"\" + i;\n-\t\t\tcurr.setVersionLabel(nodeLabel);\n \t\t\tfinal String id = nodeDao.createNew(curr);\n-\t\t\tcurr = nodeDao.getNode(id);\n \t\t\tassertNotNull(id);\n \t\t\ttoDelete.add(id);\n-\t\t\tcurr.setId(id);\n \t\t}\n \n-\t\tresults = nodeDao.getEntityHeaderByMd5(fileHandle3.getContentMd5());\n+\t\t// Call under test\n+\t\tList<EntityHeader> results = nodeDao.getEntityHeaderByMd5(fileHandle3.getContentMd5());\n \t\tassertNotNull(results);\n-\t\tassertEquals(200, results.size());\n-\n+\t\tassertEquals(NodeDAO.NODE_VERSION_LIMIT_BY_FILE_MD5, results.size());\n \t}\n \t\n \t@Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgwMTM3MQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4198#discussion_r489801371", "bodyText": "This is not used.", "author": "marcomarasca", "createdAt": "2020-09-16T23:06:14Z", "path": "lib/jdomodels/src/test/java/org/sagebionetworks/repo/model/dbo/dao/NodeDAOImplTest.java", "diffHunk": "@@ -2339,80 +2340,35 @@ public void testCreateTableNode() throws DatastoreException, InvalidModelExcepti\n \t\tassertEquals(expected, n1.getColumnModelIds());\r\n \t}\r\n \r\n+\t/**\r\n+\t * PLFM-5960\r\n+\t * @throws Exception\r\n+\t */\r\n \t@Test\r\n \tpublic void testGetEntityHeaderByMd5() throws Exception {\r\n \r\n \t\t// Nothing yet\r\n-\t\tList<EntityHeader> results = nodeDao.getEntityHeaderByMd5(\"md5\");\r\n+\t\tList<EntityHeader> results = nodeDao.getEntityHeaderByMd5(fileHandle3.getContentMd5());\r\n \t\tassertNotNull(results);\r\n \t\tassertEquals(0, results.size());\r\n \r\n-\t\t// Add a node with a file handle\r\n-\t\tNode node1 = NodeTestUtils.createNew(\"testGetEntityHeaderByMd5 node 1\", creatorUserGroupId);\r\n-\t\tnode1.setFileHandleId(fileHandle.getId());\r\n-\t\tfinal String node1Label1 = \"1\";\r\n-\t\tnode1.setVersionLabel(node1Label1);\r\n-\t\tfinal String id1 = nodeDao.createNew(node1);\r\n-\t\tnode1 = nodeDao.getNode(id1);\r\n-\t\tassertNotNull(id1);\r\n-\t\ttoDelete.add(id1);\r\n-\t\tnode1.setId(id1);\r\n-\r\n-\t\tresults = nodeDao.getEntityHeaderByMd5(fileHandle.getContentMd5());\r\n-\t\tassertNotNull(results);\r\n-\t\tassertEquals(1, results.size());\r\n-\t\tassertEquals(id1, results.get(0).getId());\r\n-\t\tassertNotNull(results.get(0).getBenefactorId());\r\n-\t\tassertEquals(Long.valueOf(1L), results.get(0).getVersionNumber());\r\n-\t\tassertEquals(node1Label1, results.get(0).getVersionLabel());\r\n-\t\tassertEquals(node1.getCreatedByPrincipalId().toString(), results.get(0).getCreatedBy());\r\n-\t\tassertEquals(node1.getCreatedOn(), results.get(0).getCreatedOn());\r\n-\t\tassertEquals(node1.getModifiedByPrincipalId().toString(), results.get(0).getModifiedBy());\r\n-\t\tassertEquals(node1.getModifiedOn(), results.get(0).getModifiedOn());\r\n-\r\n-\t\t// Create a new version of the node of the same file\r\n-\t\tfinal String node1Label2 = \"Node 1 version label 2\";\r\n-\t\tnode1.setVersionLabel(node1Label2);\r\n-\t\tnodeDao.createNewVersion(node1);\r\n-\r\n-\t\tresults = nodeDao.getEntityHeaderByMd5(fileHandle.getContentMd5());\r\n-\t\tassertNotNull(results);\r\n-\t\tassertEquals(2, results.size());\r\n-\t\tassertEquals(id1, results.get(0).getId());\r\n-\t\tassertEquals(id1, results.get(1).getId());\r\n-\t\tassertFalse(results.get(0).getVersionNumber().equals(results.get(1).getVersionNumber()));\r\n-\r\n-\t\t// Add a new node with no file handle\r\n-\t\tNode node2 = NodeTestUtils.createNew(\"testGetEntityHeaderByMd5 node 2\", creatorUserGroupId);\r\n-\t\tfinal String node2Label1 = \"Node 2 version label 1\";\r\n-\t\tnode1.setVersionLabel(node2Label1);\r\n-\t\tfinal String id2 = nodeDao.createNew(node2);\r\n-\t\tassertNotNull(id2);\r\n-\t\ttoDelete.add(id2);\r\n-\t\tnode2.setId(id2);\r\n+\t\tfor(int i = 0; i < 202; i++) {\r\n+\t\t\t// Add a node with a file handle\r\n+\t\t\tNode curr = NodeTestUtils.createNew(\"testGetEntityHeaderByMd5 node \" + i, creatorUserGroupId);\r\n+\t\t\tcurr.setFileHandleId(fileHandle3.getId());\r\n+\t\t\tfinal String nodeLabel = \"\" + i;\r\n+\t\t\tcurr.setVersionLabel(nodeLabel);\r\n+\t\t\tfinal String id = nodeDao.createNew(curr);\r\n+\t\t\tcurr = nodeDao.getNode(id);\r", "originalCommit": "cc914cd085ece396d19756c8f6b3ddf0553a6e02", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "327581777b4509e7f3950f945e389fe5ee6c49ec", "chunk": "diff --git a/lib/jdomodels/src/test/java/org/sagebionetworks/repo/model/dbo/dao/NodeDAOImplTest.java b/lib/jdomodels/src/test/java/org/sagebionetworks/repo/model/dbo/dao/NodeDAOImplTest.java\nindex 5a882603ca..74250afd4f 100644\n--- a/lib/jdomodels/src/test/java/org/sagebionetworks/repo/model/dbo/dao/NodeDAOImplTest.java\n+++ b/lib/jdomodels/src/test/java/org/sagebionetworks/repo/model/dbo/dao/NodeDAOImplTest.java\n\n@@ -2340,35 +2340,39 @@ public class NodeDAOImplTest {\n \t\tassertEquals(expected, n1.getColumnModelIds());\n \t}\n \n+\n+\n \t/**\n \t * PLFM-5960\n \t * @throws Exception\n \t */\n \t@Test\n-\tpublic void testGetEntityHeaderByMd5() throws Exception {\n-\n-\t\t// Nothing yet\n+\tpublic void testGetEntityHeaderByMd5NoMatches() {\n+\t\t// Call under test\n \t\tList<EntityHeader> results = nodeDao.getEntityHeaderByMd5(fileHandle3.getContentMd5());\n \t\tassertNotNull(results);\n \t\tassertEquals(0, results.size());\n+\t}\n \n-\t\tfor(int i = 0; i < 202; i++) {\n+\t/**\n+\t * PLFM-5960\n+\t */\n+\t@Test\n+\tpublic void testGetEntityHeaderByMd5WithOver200Matching() {\n+\n+\t\tfor(int i = 0; i < NodeDAO.NODE_VERSION_LIMIT_BY_FILE_MD5 + 1; i++) {\n \t\t\t// Add a node with a file handle\n \t\t\tNode curr = NodeTestUtils.createNew(\"testGetEntityHeaderByMd5 node \" + i, creatorUserGroupId);\n \t\t\tcurr.setFileHandleId(fileHandle3.getId());\n-\t\t\tfinal String nodeLabel = \"\" + i;\n-\t\t\tcurr.setVersionLabel(nodeLabel);\n \t\t\tfinal String id = nodeDao.createNew(curr);\n-\t\t\tcurr = nodeDao.getNode(id);\n \t\t\tassertNotNull(id);\n \t\t\ttoDelete.add(id);\n-\t\t\tcurr.setId(id);\n \t\t}\n \n-\t\tresults = nodeDao.getEntityHeaderByMd5(fileHandle3.getContentMd5());\n+\t\t// Call under test\n+\t\tList<EntityHeader> results = nodeDao.getEntityHeaderByMd5(fileHandle3.getContentMd5());\n \t\tassertNotNull(results);\n-\t\tassertEquals(200, results.size());\n-\n+\t\tassertEquals(NodeDAO.NODE_VERSION_LIMIT_BY_FILE_MD5, results.size());\n \t}\n \t\n \t@Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgwMTQ3Nw==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4198#discussion_r489801477", "bodyText": "Please add // Call under test", "author": "marcomarasca", "createdAt": "2020-09-16T23:06:35Z", "path": "lib/jdomodels/src/test/java/org/sagebionetworks/repo/model/dbo/dao/NodeDAOImplTest.java", "diffHunk": "@@ -2339,80 +2340,35 @@ public void testCreateTableNode() throws DatastoreException, InvalidModelExcepti\n \t\tassertEquals(expected, n1.getColumnModelIds());\r\n \t}\r\n \r\n+\t/**\r\n+\t * PLFM-5960\r\n+\t * @throws Exception\r\n+\t */\r\n \t@Test\r\n \tpublic void testGetEntityHeaderByMd5() throws Exception {\r\n \r\n \t\t// Nothing yet\r\n-\t\tList<EntityHeader> results = nodeDao.getEntityHeaderByMd5(\"md5\");\r\n+\t\tList<EntityHeader> results = nodeDao.getEntityHeaderByMd5(fileHandle3.getContentMd5());\r\n \t\tassertNotNull(results);\r\n \t\tassertEquals(0, results.size());\r\n \r\n-\t\t// Add a node with a file handle\r\n-\t\tNode node1 = NodeTestUtils.createNew(\"testGetEntityHeaderByMd5 node 1\", creatorUserGroupId);\r\n-\t\tnode1.setFileHandleId(fileHandle.getId());\r\n-\t\tfinal String node1Label1 = \"1\";\r\n-\t\tnode1.setVersionLabel(node1Label1);\r\n-\t\tfinal String id1 = nodeDao.createNew(node1);\r\n-\t\tnode1 = nodeDao.getNode(id1);\r\n-\t\tassertNotNull(id1);\r\n-\t\ttoDelete.add(id1);\r\n-\t\tnode1.setId(id1);\r\n-\r\n-\t\tresults = nodeDao.getEntityHeaderByMd5(fileHandle.getContentMd5());\r\n-\t\tassertNotNull(results);\r\n-\t\tassertEquals(1, results.size());\r\n-\t\tassertEquals(id1, results.get(0).getId());\r\n-\t\tassertNotNull(results.get(0).getBenefactorId());\r\n-\t\tassertEquals(Long.valueOf(1L), results.get(0).getVersionNumber());\r\n-\t\tassertEquals(node1Label1, results.get(0).getVersionLabel());\r\n-\t\tassertEquals(node1.getCreatedByPrincipalId().toString(), results.get(0).getCreatedBy());\r\n-\t\tassertEquals(node1.getCreatedOn(), results.get(0).getCreatedOn());\r\n-\t\tassertEquals(node1.getModifiedByPrincipalId().toString(), results.get(0).getModifiedBy());\r\n-\t\tassertEquals(node1.getModifiedOn(), results.get(0).getModifiedOn());\r\n-\r\n-\t\t// Create a new version of the node of the same file\r\n-\t\tfinal String node1Label2 = \"Node 1 version label 2\";\r\n-\t\tnode1.setVersionLabel(node1Label2);\r\n-\t\tnodeDao.createNewVersion(node1);\r\n-\r\n-\t\tresults = nodeDao.getEntityHeaderByMd5(fileHandle.getContentMd5());\r\n-\t\tassertNotNull(results);\r\n-\t\tassertEquals(2, results.size());\r\n-\t\tassertEquals(id1, results.get(0).getId());\r\n-\t\tassertEquals(id1, results.get(1).getId());\r\n-\t\tassertFalse(results.get(0).getVersionNumber().equals(results.get(1).getVersionNumber()));\r\n-\r\n-\t\t// Add a new node with no file handle\r\n-\t\tNode node2 = NodeTestUtils.createNew(\"testGetEntityHeaderByMd5 node 2\", creatorUserGroupId);\r\n-\t\tfinal String node2Label1 = \"Node 2 version label 1\";\r\n-\t\tnode1.setVersionLabel(node2Label1);\r\n-\t\tfinal String id2 = nodeDao.createNew(node2);\r\n-\t\tassertNotNull(id2);\r\n-\t\ttoDelete.add(id2);\r\n-\t\tnode2.setId(id2);\r\n+\t\tfor(int i = 0; i < 202; i++) {\r\n+\t\t\t// Add a node with a file handle\r\n+\t\t\tNode curr = NodeTestUtils.createNew(\"testGetEntityHeaderByMd5 node \" + i, creatorUserGroupId);\r\n+\t\t\tcurr.setFileHandleId(fileHandle3.getId());\r\n+\t\t\tfinal String nodeLabel = \"\" + i;\r\n+\t\t\tcurr.setVersionLabel(nodeLabel);\r\n+\t\t\tfinal String id = nodeDao.createNew(curr);\r\n+\t\t\tcurr = nodeDao.getNode(id);\r\n+\t\t\tassertNotNull(id);\r\n+\t\t\ttoDelete.add(id);\r\n+\t\t\tcurr.setId(id);\r\n+\t\t}\r\n \r\n-\t\tresults = nodeDao.getEntityHeaderByMd5(fileHandle.getContentMd5());\r\n+\t\tresults = nodeDao.getEntityHeaderByMd5(fileHandle3.getContentMd5());\r", "originalCommit": "cc914cd085ece396d19756c8f6b3ddf0553a6e02", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "327581777b4509e7f3950f945e389fe5ee6c49ec", "chunk": "diff --git a/lib/jdomodels/src/test/java/org/sagebionetworks/repo/model/dbo/dao/NodeDAOImplTest.java b/lib/jdomodels/src/test/java/org/sagebionetworks/repo/model/dbo/dao/NodeDAOImplTest.java\nindex 5a882603ca..74250afd4f 100644\n--- a/lib/jdomodels/src/test/java/org/sagebionetworks/repo/model/dbo/dao/NodeDAOImplTest.java\n+++ b/lib/jdomodels/src/test/java/org/sagebionetworks/repo/model/dbo/dao/NodeDAOImplTest.java\n\n@@ -2340,35 +2340,39 @@ public class NodeDAOImplTest {\n \t\tassertEquals(expected, n1.getColumnModelIds());\n \t}\n \n+\n+\n \t/**\n \t * PLFM-5960\n \t * @throws Exception\n \t */\n \t@Test\n-\tpublic void testGetEntityHeaderByMd5() throws Exception {\n-\n-\t\t// Nothing yet\n+\tpublic void testGetEntityHeaderByMd5NoMatches() {\n+\t\t// Call under test\n \t\tList<EntityHeader> results = nodeDao.getEntityHeaderByMd5(fileHandle3.getContentMd5());\n \t\tassertNotNull(results);\n \t\tassertEquals(0, results.size());\n+\t}\n \n-\t\tfor(int i = 0; i < 202; i++) {\n+\t/**\n+\t * PLFM-5960\n+\t */\n+\t@Test\n+\tpublic void testGetEntityHeaderByMd5WithOver200Matching() {\n+\n+\t\tfor(int i = 0; i < NodeDAO.NODE_VERSION_LIMIT_BY_FILE_MD5 + 1; i++) {\n \t\t\t// Add a node with a file handle\n \t\t\tNode curr = NodeTestUtils.createNew(\"testGetEntityHeaderByMd5 node \" + i, creatorUserGroupId);\n \t\t\tcurr.setFileHandleId(fileHandle3.getId());\n-\t\t\tfinal String nodeLabel = \"\" + i;\n-\t\t\tcurr.setVersionLabel(nodeLabel);\n \t\t\tfinal String id = nodeDao.createNew(curr);\n-\t\t\tcurr = nodeDao.getNode(id);\n \t\t\tassertNotNull(id);\n \t\t\ttoDelete.add(id);\n-\t\t\tcurr.setId(id);\n \t\t}\n \n-\t\tresults = nodeDao.getEntityHeaderByMd5(fileHandle3.getContentMd5());\n+\t\t// Call under test\n+\t\tList<EntityHeader> results = nodeDao.getEntityHeaderByMd5(fileHandle3.getContentMd5());\n \t\tassertNotNull(results);\n-\t\tassertEquals(200, results.size());\n-\n+\t\tassertEquals(NodeDAO.NODE_VERSION_LIMIT_BY_FILE_MD5, results.size());\n \t}\n \t\n \t@Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgwMTU5Mg==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4198#discussion_r489801592", "bodyText": "We can reuse the constant", "author": "marcomarasca", "createdAt": "2020-09-16T23:06:57Z", "path": "lib/jdomodels/src/test/java/org/sagebionetworks/repo/model/dbo/dao/NodeDAOImplTest.java", "diffHunk": "@@ -2339,80 +2340,35 @@ public void testCreateTableNode() throws DatastoreException, InvalidModelExcepti\n \t\tassertEquals(expected, n1.getColumnModelIds());\r\n \t}\r\n \r\n+\t/**\r\n+\t * PLFM-5960\r\n+\t * @throws Exception\r\n+\t */\r\n \t@Test\r\n \tpublic void testGetEntityHeaderByMd5() throws Exception {\r\n \r\n \t\t// Nothing yet\r\n-\t\tList<EntityHeader> results = nodeDao.getEntityHeaderByMd5(\"md5\");\r\n+\t\tList<EntityHeader> results = nodeDao.getEntityHeaderByMd5(fileHandle3.getContentMd5());\r\n \t\tassertNotNull(results);\r\n \t\tassertEquals(0, results.size());\r\n \r\n-\t\t// Add a node with a file handle\r\n-\t\tNode node1 = NodeTestUtils.createNew(\"testGetEntityHeaderByMd5 node 1\", creatorUserGroupId);\r\n-\t\tnode1.setFileHandleId(fileHandle.getId());\r\n-\t\tfinal String node1Label1 = \"1\";\r\n-\t\tnode1.setVersionLabel(node1Label1);\r\n-\t\tfinal String id1 = nodeDao.createNew(node1);\r\n-\t\tnode1 = nodeDao.getNode(id1);\r\n-\t\tassertNotNull(id1);\r\n-\t\ttoDelete.add(id1);\r\n-\t\tnode1.setId(id1);\r\n-\r\n-\t\tresults = nodeDao.getEntityHeaderByMd5(fileHandle.getContentMd5());\r\n-\t\tassertNotNull(results);\r\n-\t\tassertEquals(1, results.size());\r\n-\t\tassertEquals(id1, results.get(0).getId());\r\n-\t\tassertNotNull(results.get(0).getBenefactorId());\r\n-\t\tassertEquals(Long.valueOf(1L), results.get(0).getVersionNumber());\r\n-\t\tassertEquals(node1Label1, results.get(0).getVersionLabel());\r\n-\t\tassertEquals(node1.getCreatedByPrincipalId().toString(), results.get(0).getCreatedBy());\r\n-\t\tassertEquals(node1.getCreatedOn(), results.get(0).getCreatedOn());\r\n-\t\tassertEquals(node1.getModifiedByPrincipalId().toString(), results.get(0).getModifiedBy());\r\n-\t\tassertEquals(node1.getModifiedOn(), results.get(0).getModifiedOn());\r\n-\r\n-\t\t// Create a new version of the node of the same file\r\n-\t\tfinal String node1Label2 = \"Node 1 version label 2\";\r\n-\t\tnode1.setVersionLabel(node1Label2);\r\n-\t\tnodeDao.createNewVersion(node1);\r\n-\r\n-\t\tresults = nodeDao.getEntityHeaderByMd5(fileHandle.getContentMd5());\r\n-\t\tassertNotNull(results);\r\n-\t\tassertEquals(2, results.size());\r\n-\t\tassertEquals(id1, results.get(0).getId());\r\n-\t\tassertEquals(id1, results.get(1).getId());\r\n-\t\tassertFalse(results.get(0).getVersionNumber().equals(results.get(1).getVersionNumber()));\r\n-\r\n-\t\t// Add a new node with no file handle\r\n-\t\tNode node2 = NodeTestUtils.createNew(\"testGetEntityHeaderByMd5 node 2\", creatorUserGroupId);\r\n-\t\tfinal String node2Label1 = \"Node 2 version label 1\";\r\n-\t\tnode1.setVersionLabel(node2Label1);\r\n-\t\tfinal String id2 = nodeDao.createNew(node2);\r\n-\t\tassertNotNull(id2);\r\n-\t\ttoDelete.add(id2);\r\n-\t\tnode2.setId(id2);\r\n+\t\tfor(int i = 0; i < 202; i++) {\r\n+\t\t\t// Add a node with a file handle\r\n+\t\t\tNode curr = NodeTestUtils.createNew(\"testGetEntityHeaderByMd5 node \" + i, creatorUserGroupId);\r\n+\t\t\tcurr.setFileHandleId(fileHandle3.getId());\r\n+\t\t\tfinal String nodeLabel = \"\" + i;\r\n+\t\t\tcurr.setVersionLabel(nodeLabel);\r\n+\t\t\tfinal String id = nodeDao.createNew(curr);\r\n+\t\t\tcurr = nodeDao.getNode(id);\r\n+\t\t\tassertNotNull(id);\r\n+\t\t\ttoDelete.add(id);\r\n+\t\t\tcurr.setId(id);\r\n+\t\t}\r\n \r\n-\t\tresults = nodeDao.getEntityHeaderByMd5(fileHandle.getContentMd5());\r\n+\t\tresults = nodeDao.getEntityHeaderByMd5(fileHandle3.getContentMd5());\r\n \t\tassertNotNull(results);\r\n-\t\tassertEquals(2, results.size());\r\n-\t\tassertEquals(id1, results.get(0).getId());\r\n-\t\tassertEquals(id1, results.get(1).getId());\r\n+\t\tassertEquals(200, results.size());\r", "originalCommit": "cc914cd085ece396d19756c8f6b3ddf0553a6e02", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "327581777b4509e7f3950f945e389fe5ee6c49ec", "chunk": "diff --git a/lib/jdomodels/src/test/java/org/sagebionetworks/repo/model/dbo/dao/NodeDAOImplTest.java b/lib/jdomodels/src/test/java/org/sagebionetworks/repo/model/dbo/dao/NodeDAOImplTest.java\nindex 5a882603ca..74250afd4f 100644\n--- a/lib/jdomodels/src/test/java/org/sagebionetworks/repo/model/dbo/dao/NodeDAOImplTest.java\n+++ b/lib/jdomodels/src/test/java/org/sagebionetworks/repo/model/dbo/dao/NodeDAOImplTest.java\n\n@@ -2340,35 +2340,39 @@ public class NodeDAOImplTest {\n \t\tassertEquals(expected, n1.getColumnModelIds());\n \t}\n \n+\n+\n \t/**\n \t * PLFM-5960\n \t * @throws Exception\n \t */\n \t@Test\n-\tpublic void testGetEntityHeaderByMd5() throws Exception {\n-\n-\t\t// Nothing yet\n+\tpublic void testGetEntityHeaderByMd5NoMatches() {\n+\t\t// Call under test\n \t\tList<EntityHeader> results = nodeDao.getEntityHeaderByMd5(fileHandle3.getContentMd5());\n \t\tassertNotNull(results);\n \t\tassertEquals(0, results.size());\n+\t}\n \n-\t\tfor(int i = 0; i < 202; i++) {\n+\t/**\n+\t * PLFM-5960\n+\t */\n+\t@Test\n+\tpublic void testGetEntityHeaderByMd5WithOver200Matching() {\n+\n+\t\tfor(int i = 0; i < NodeDAO.NODE_VERSION_LIMIT_BY_FILE_MD5 + 1; i++) {\n \t\t\t// Add a node with a file handle\n \t\t\tNode curr = NodeTestUtils.createNew(\"testGetEntityHeaderByMd5 node \" + i, creatorUserGroupId);\n \t\t\tcurr.setFileHandleId(fileHandle3.getId());\n-\t\t\tfinal String nodeLabel = \"\" + i;\n-\t\t\tcurr.setVersionLabel(nodeLabel);\n \t\t\tfinal String id = nodeDao.createNew(curr);\n-\t\t\tcurr = nodeDao.getNode(id);\n \t\t\tassertNotNull(id);\n \t\t\ttoDelete.add(id);\n-\t\t\tcurr.setId(id);\n \t\t}\n \n-\t\tresults = nodeDao.getEntityHeaderByMd5(fileHandle3.getContentMd5());\n+\t\t// Call under test\n+\t\tList<EntityHeader> results = nodeDao.getEntityHeaderByMd5(fileHandle3.getContentMd5());\n \t\tassertNotNull(results);\n-\t\tassertEquals(200, results.size());\n-\n+\t\tassertEquals(NodeDAO.NODE_VERSION_LIMIT_BY_FILE_MD5, results.size());\n \t}\n \t\n \t@Test\n"}}, {"oid": "327581777b4509e7f3950f945e389fe5ee6c49ec", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/327581777b4509e7f3950f945e389fe5ee6c49ec", "message": " refactored tests, change description, ORDER BY node id", "committedDate": "2020-09-17T20:47:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYwMDM1Ng==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4198#discussion_r490600356", "bodyText": "You might want to add some documentation", "author": "marcomarasca", "createdAt": "2020-09-17T22:38:05Z", "path": "lib/models/src/main/java/org/sagebionetworks/repo/model/NodeDAO.java", "diffHunk": "@@ -31,7 +31,8 @@\n \t * the value to pass into the node to remove the generatedBy link between node and activity\r\n \t * \r\n \t */\r\n-\tpublic static String DELETE_ACTIVITY_VALUE = \"-1\";\r\n+\tString DELETE_ACTIVITY_VALUE = \"-1\";\r\n+\tint NODE_VERSION_LIMIT_BY_FILE_MD5 = 200;\r", "originalCommit": "327581777b4509e7f3950f945e389fe5ee6c49ec", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}