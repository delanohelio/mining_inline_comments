{"pr_number": 4117, "pr_title": "PLFM-6241 - Log the OAuth client id from the basic auth creds", "pr_createdAt": "2020-07-01T18:26:24Z", "pr_url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4117", "timeline": [{"oid": "6612f5ae35f579e1f845d504ac22a91094deae9a", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/6612f5ae35f579e1f845d504ac22a91094deae9a", "message": "Log the OAuth client id from the basic auth creds", "committedDate": "2020-07-01T18:25:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU5Njk4OA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4117#discussion_r448596988", "bodyText": "A small warning about this approach: this might not be enough since we use basic authentication in other filters that are not related to oauth and the \"username\" extracted might not actually be an OAuth client id (e.g. might be the user for docker registry or cloud mail in, a service call etc.). You might want to check for the special OAUTH_VERIFIED_CLIENT_ID_HEADER injected in the request instead (see the implementation of OAuthClientAuthFilter)", "author": "marcomarasca", "createdAt": "2020-07-01T20:23:51Z", "path": "services/repository/src/main/java/org/sagebionetworks/repo/web/AccessInterceptor.java", "diffHunk": "@@ -51,9 +51,19 @@\n \tprivate OIDCTokenHelper oidcTokenHelper;\r\n \t\r\n \tString getOAuthClientId(HttpServletRequest request) {\r\n+\t\t/*\r\n+\t\t * There are two different places the client ID might be:\r\n+\t\t *  - in the access token, if the OAuth client is acting on behalf of a user\r\n+\t\t *  - in the basic auth credentials, if using an auth code/refresh token\r\n+\t\t */\r\n \t\tString accessToken = HttpAuthUtil.getBearerTokenFromStandardAuthorizationHeader(request);\r\n-\t\tif (accessToken==null) return null;\r\n-\t\treturn oidcTokenHelper.parseJWT(accessToken).getBody().getAudience();\r\n+\t\tif (accessToken != null) {\r\n+\t\t\treturn oidcTokenHelper.parseJWT(accessToken).getBody().getAudience();\r\n+\t\t} else if (HttpAuthUtil.usesBasicAuthentication(request)) {\r", "originalCommit": "6612f5ae35f579e1f845d504ac22a91094deae9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NTQ0Ng==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4117#discussion_r448665446", "bodyText": "\"+1\".\nThe two choices I see for changing this are (1) make sure it's the oauth client credentials rather than some other client credentials or (2) add a separate field, BASIC_AUTH_USER_NAME, which can be an oauth client or a non-oauth client.", "author": "brucehoff", "createdAt": "2020-07-01T23:23:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU5Njk4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAxNjk4OQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4117#discussion_r449016989", "bodyText": "Thanks for the heads up, @marcomarasca ! It sounds like the right approach would be to use the injected header to conditionally insert the username into the OAuthClientId value, and as @brucehoff said, to log the basic auth username for all requests that include it.", "author": "nickgros", "createdAt": "2020-07-02T13:51:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU5Njk4OA=="}], "type": "inlineReview", "revised_code": {"commit": "fc5ffbd58e999fb5d7549112a26556fd0405e217", "chunk": "diff --git a/services/repository/src/main/java/org/sagebionetworks/repo/web/AccessInterceptor.java b/services/repository/src/main/java/org/sagebionetworks/repo/web/AccessInterceptor.java\nindex d128bea35d..e4cbbc4f29 100644\n--- a/services/repository/src/main/java/org/sagebionetworks/repo/web/AccessInterceptor.java\n+++ b/services/repository/src/main/java/org/sagebionetworks/repo/web/AccessInterceptor.java\n\n@@ -46,23 +46,21 @@ public class AccessInterceptor implements HandlerInterceptor, AccessIdListener{\n \t\n \t@Autowired\n \tStackConfiguration stackConfiguration;\n-\t\n+\n \t@Autowired\n \tprivate OIDCTokenHelper oidcTokenHelper;\n-\t\n+\n \tString getOAuthClientId(HttpServletRequest request) {\n \t\t/*\n \t\t * There are two different places the client ID might be:\n \t\t *  - in the access token, if the OAuth client is acting on behalf of a user\n-\t\t *  - in the basic auth credentials, if using an auth code/refresh token\n+\t\t *  - injected into the verified client ID header, if the client used basic auth\n \t\t */\n \t\tString accessToken = HttpAuthUtil.getBearerTokenFromStandardAuthorizationHeader(request);\n \t\tif (accessToken != null) {\n \t\t\treturn oidcTokenHelper.parseJWT(accessToken).getBody().getAudience();\n-\t\t} else if (HttpAuthUtil.usesBasicAuthentication(request)) {\n-\t\t\treturn HttpAuthUtil.getBasicAuthenticationCredentials(request).get().getUserName();\n \t\t} else {\n-\t\t\treturn null;\n+\t\t\treturn request.getHeader(AuthorizationConstants.OAUTH_VERIFIED_CLIENT_ID_HEADER);\n \t\t}\n \t}\n \n"}}, {"oid": "fc5ffbd58e999fb5d7549112a26556fd0405e217", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/fc5ffbd58e999fb5d7549112a26556fd0405e217", "message": "Get the OAuth client name from the header when using basic auth, log the basic auth username separately", "committedDate": "2020-07-02T15:33:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTcwNDc0Mw==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4117#discussion_r451704743", "bodyText": "why do we sleep?", "author": "brucehoff", "createdAt": "2020-07-08T17:19:07Z", "path": "services/repository/src/test/java/org/sagebionetworks/repo/web/AccessInterceptorTest.java", "diffHunk": "@@ -196,7 +199,54 @@ public void testStatusCode400() throws Exception{\n \t\tassertNotNull(result);\r\n \t\tassertTrue(result.getTimestamp() >= start);\r\n \t\tassertEquals(234L, result.getElapseMS().longValue());\r\n-\t\tassertFalse(\"400 is not a success\",result.getSuccess());\r\n+\t\tassertFalse(result.getSuccess(), \"400 is not a success\");\r\n \t\tassertEquals(new Long(400), result.getResponseStatus());\r\n \t}\r\n+\r\n+\t@Test\r\n+\tpublic void testGetOAuthClientIdFromBearerJwt() throws Exception {\r\n+\t\t// Put the client ID in the JWT access token\r\n+\t\twhen(mockRequest.getHeader(\"Authorization\")).thenReturn(BEARER_TOKEN_HEADER);\r\n+\t\tClaims claims = new DefaultClaims();\r\n+\t\tclaims.setAudience(OAUTH_CLIENT_ID);\r\n+\t\tJwt<JwsHeader,Claims> jwt = new DefaultJwt(null, claims);\r\n+\t\twhen(oidcTokenHelper.parseJWT(any())).thenReturn(jwt);\r\n+\r\n+\t\t// Start\r\n+\t\tinterceptor.preHandle(mockRequest, mockResponse, mockHandler);\r\n+\t\tinterceptor.setReturnObjectId(\"returnId\");\r\n+\t\t// Wait to add some elapse time\r\n+\t\ttestClock.sleep(234);\r", "originalCommit": "fc5ffbd58e999fb5d7549112a26556fd0405e217", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTcwNjE4Mg==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4117#discussion_r451706182", "bodyText": "// method under test", "author": "brucehoff", "createdAt": "2020-07-08T17:21:32Z", "path": "services/repository/src/test/java/org/sagebionetworks/repo/web/AccessInterceptorTest.java", "diffHunk": "@@ -196,7 +199,54 @@ public void testStatusCode400() throws Exception{\n \t\tassertNotNull(result);\r\n \t\tassertTrue(result.getTimestamp() >= start);\r\n \t\tassertEquals(234L, result.getElapseMS().longValue());\r\n-\t\tassertFalse(\"400 is not a success\",result.getSuccess());\r\n+\t\tassertFalse(result.getSuccess(), \"400 is not a success\");\r\n \t\tassertEquals(new Long(400), result.getResponseStatus());\r\n \t}\r\n+\r\n+\t@Test\r\n+\tpublic void testGetOAuthClientIdFromBearerJwt() throws Exception {\r\n+\t\t// Put the client ID in the JWT access token\r\n+\t\twhen(mockRequest.getHeader(\"Authorization\")).thenReturn(BEARER_TOKEN_HEADER);\r\n+\t\tClaims claims = new DefaultClaims();\r\n+\t\tclaims.setAudience(OAUTH_CLIENT_ID);\r\n+\t\tJwt<JwsHeader,Claims> jwt = new DefaultJwt(null, claims);\r\n+\t\twhen(oidcTokenHelper.parseJWT(any())).thenReturn(jwt);\r\n+\r\n+\t\t// Start\r\n+\t\tinterceptor.preHandle(mockRequest, mockResponse, mockHandler);\r", "originalCommit": "fc5ffbd58e999fb5d7549112a26556fd0405e217", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}