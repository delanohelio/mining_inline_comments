{"pr_number": 4106, "pr_title": "give better error message when user can't join team due to AR restriction", "pr_createdAt": "2020-06-24T22:55:11Z", "pr_url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4106", "timeline": [{"oid": "8e623e95fb623d9ef34a751701ce35c66fe91b09", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/8e623e95fb623d9ef34a751701ce35c66fe91b09", "message": "give better error message when user cant join team", "committedDate": "2020-06-24T22:43:19Z", "type": "commit"}, {"oid": "beccdf7a2d5488e9cdb8961e3e5531ff9be284a1", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/beccdf7a2d5488e9cdb8961e3e5531ff9be284a1", "message": "PR feedback - return specific message for unmet AR using AuthorizationStatus", "committedDate": "2020-07-01T20:34:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAwODU4Nw==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4106#discussion_r451008587", "bodyText": "you don't need \"TeamManagerImpl.\" on ll. 129, 130", "author": "brucehoff", "createdAt": "2020-07-07T16:54:54Z", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java", "diffHunk": "@@ -123,6 +124,11 @@\n \tpublic static final String USER_HAS_JOINED_TEAM_TEMPLATE = \"message/userHasJoinedTeamTemplate.html\";\n \tpublic static final String ADMIN_HAS_ADDED_USER_TEMPLATE = \"message/teamAdminHasAddedUserTemplate.html\";\n \tprivate static final String JOIN_TEAM_CONFIRMATION_MESSAGE_SUBJECT = \"New Member Has Joined the Team\";\n+\tprivate static final String MSG_CANNOT_ADD_TEAM_MEMBER_UNMET_AR = \"Cannot add member to team because they have not met all access restrictions. Please remove the pending request and then invite the member again. They will then be prompted to meet the requirement(s) before joining the team.\";\n+\tprivate static final String MSG_CANNOT_ADD_TEAM_MEMBER_GENERIC = \"Cannot add member to team\";\n+\tpublic static final AuthorizationStatus UNAUTHORIZED_ADD_TEAM_MEMBER_GENERIC =  AuthorizationStatus.accessDenied(TeamManagerImpl.MSG_CANNOT_ADD_TEAM_MEMBER_GENERIC);\n+\tpublic static final AuthorizationStatus UNAUTHORIZED_ADD_TEAM_MEMBER_UNMET_AR =  AuthorizationStatus.accessDenied(TeamManagerImpl.MSG_CANNOT_ADD_TEAM_MEMBER_UNMET_AR);", "originalCommit": "beccdf7a2d5488e9cdb8961e3e5531ff9be284a1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6678f1572f6b2ecde9226eb4f43352b54794b125", "chunk": "diff --git a/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java b/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java\nindex 5996781964..00b0e0f37b 100644\n--- a/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java\n+++ b/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java\n\n@@ -124,10 +124,16 @@ public class TeamManagerImpl implements TeamManager {\n \tpublic static final String USER_HAS_JOINED_TEAM_TEMPLATE = \"message/userHasJoinedTeamTemplate.html\";\n \tpublic static final String ADMIN_HAS_ADDED_USER_TEMPLATE = \"message/teamAdminHasAddedUserTemplate.html\";\n \tprivate static final String JOIN_TEAM_CONFIRMATION_MESSAGE_SUBJECT = \"New Member Has Joined the Team\";\n-\tprivate static final String MSG_CANNOT_ADD_TEAM_MEMBER_UNMET_AR = \"Cannot add member to team because they have not met all access restrictions. Please remove the pending request and then invite the member again. They will then be prompted to meet the requirement(s) before joining the team.\";\n-\tprivate static final String MSG_CANNOT_ADD_TEAM_MEMBER_GENERIC = \"Cannot add member to team\";\n-\tpublic static final AuthorizationStatus UNAUTHORIZED_ADD_TEAM_MEMBER_GENERIC =  AuthorizationStatus.accessDenied(TeamManagerImpl.MSG_CANNOT_ADD_TEAM_MEMBER_GENERIC);\n-\tpublic static final AuthorizationStatus UNAUTHORIZED_ADD_TEAM_MEMBER_UNMET_AR =  AuthorizationStatus.accessDenied(TeamManagerImpl.MSG_CANNOT_ADD_TEAM_MEMBER_UNMET_AR);\n+\n+\tpublic static final AuthorizationStatus UNAUTHORIZED_ADD_TEAM_MEMBER_MUST_BE_TEAM_MANAGER = AuthorizationStatus.accessDenied(\"You must be a team manager to perform this operation.\");\n+\tpublic static final AuthorizationStatus UNAUTHORIZED_ADD_TEAM_MEMBER_MUST_HAVE_REQUEST = AuthorizationStatus.accessDenied(\"The prospective member must request to join the team.\");\n+\tpublic static final AuthorizationStatus UNAUTHORIZED_ADD_TEAM_MEMBER_MUST_HAVE_INVITATION = AuthorizationStatus.accessDenied(\"An invitation is required to join the team.\");\n+\tpublic static final AuthorizationStatus UNAUTHORIZED_ADD_TEAM_MEMBER_UNMET_AR_SELF = AuthorizationStatus.accessDenied(\"You can't join the team until you meet the Access Requirements\");\n+\tprivate static final String MSG_CANNOT_ADD_TEAM_MEMBER_UNMET_AR = \"Cannot add member to team because they have not met all access restrictions. \" +\n+\t\t\t\"Please remove the pending request and then invite the member again. \" +\n+\t\t\t\"They will then be prompted to meet the requirement(s) before joining the team.\";\n+\tpublic static final AuthorizationStatus UNAUTHORIZED_ADD_TEAM_MEMBER_UNMET_AR_OTHER = AuthorizationStatus.accessDenied(MSG_CANNOT_ADD_TEAM_MEMBER_UNMET_AR);\n+\n \tpublic static final AuthorizationStatus AUTHORIZED_ADD_TEAM_MEMBER =  AuthorizationStatus.authorized();\n \t\n \tpublic void setTeamsToBootstrap(List<BootstrapTeam> teamsToBootstrap) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAxMDAyNw==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4106#discussion_r451010027", "bodyText": "Public team and userInfo.equals(principalUserInfo) -> \"You can't join the team until you meet the ARs\"\nPrivate team and the prospective member is calling -> \"You can't join the team until you meet the ARs\"\nPrivate team and the manager is calling AND there's no outstanding request  -> \"You can't add them to the team until they've met the ARs and requested to join the team\"\nPrivate team and the manager is calling AND there's an outstanding request -> UNAUTHORIZED_ADD_TEAM_MEMBER_UNMET_AR", "author": "brucehoff", "createdAt": "2020-07-07T16:57:14Z", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java", "diffHunk": "@@ -488,30 +494,30 @@ have MEMBERSHIP permission on Team and membership request has been created (but\n \t * @param principalId the ID of the one to be added to the team\n \t * @return\n \t */\n-\tpublic boolean canAddTeamMember(UserInfo userInfo, String teamId, UserInfo principalUserInfo, boolean alreadyInTeam) throws NotFoundException {\n-\t\tif (userInfo.isAdmin()) return true;\n-\t\tif (hasUnmetAccessRequirements(principalUserInfo, teamId)) return false;\n+\tpublic AuthorizationStatus canAddTeamMember(UserInfo userInfo, String teamId, UserInfo principalUserInfo, boolean alreadyInTeam) throws NotFoundException {\n+\t\tif (userInfo.isAdmin()) return AUTHORIZED_ADD_TEAM_MEMBER;\n+\t\tif (hasUnmetAccessRequirements(principalUserInfo, teamId)) return UNAUTHORIZED_ADD_TEAM_MEMBER_UNMET_AR;", "originalCommit": "beccdf7a2d5488e9cdb8961e3e5531ff9be284a1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6678f1572f6b2ecde9226eb4f43352b54794b125", "chunk": "diff --git a/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java b/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java\nindex 5996781964..00b0e0f37b 100644\n--- a/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java\n+++ b/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java\n\n@@ -491,34 +517,36 @@ public class TeamManagerImpl implements TeamManager {\n     \thave MEMBERSHIP permission on Team and membership request has been created (but not yet accepted) for principalId\n \t * @param userInfo\n \t * @param teamId the ID of the team\n-\t * @param principalId the ID of the one to be added to the team\n \t * @return\n \t */\n \tpublic AuthorizationStatus canAddTeamMember(UserInfo userInfo, String teamId, UserInfo principalUserInfo, boolean alreadyInTeam) throws NotFoundException {\n+\t\t// admin can always accept membership\n \t\tif (userInfo.isAdmin()) return AUTHORIZED_ADD_TEAM_MEMBER;\n-\t\tif (hasUnmetAccessRequirements(principalUserInfo, teamId)) return UNAUTHORIZED_ADD_TEAM_MEMBER_UNMET_AR;\n+\t\tif (alreadyInTeam) return AUTHORIZED_ADD_TEAM_MEMBER;\n+\n \t\tString principalId = principalUserInfo.getId().toString();\n-\t\tboolean principalIsSelf = userInfo.getId().toString().equals(principalId);\n+\t\tboolean principalIsSelf = userInfo.equals(principalUserInfo);\n \t\tboolean amTeamAdmin = authorizationManager.canAccess(userInfo, teamId, ObjectType.TEAM, ACCESS_TYPE.TEAM_MEMBERSHIP_UPDATE).isAuthorized();\n \t\tlong now = System.currentTimeMillis();\n+\t\tAuthorizationStatus hasInviteOrRequestToJoin = null;\n \t\tif (principalIsSelf) {\n-\t\t\t// trying to add myself to Team.  \n-\t\t\tif (amTeamAdmin) return AUTHORIZED_ADD_TEAM_MEMBER;\n-\t\t\t// if the team is open, I can join\n-\t\t\tTeam team = teamDAO.get(teamId);\n-\t\t\tif (team.getCanPublicJoin()!=null && team.getCanPublicJoin()==true) return AUTHORIZED_ADD_TEAM_MEMBER;\n-\t\t\t// if I'm not a team admin and the team is not open, then I need to have an open invitation\n-\t\t\tif (alreadyInTeam) return AUTHORIZED_ADD_TEAM_MEMBER;\n-\t\t\tlong openInvitationCount = membershipInvitationDAO.getOpenByTeamAndUserCount(Long.parseLong(teamId), Long.parseLong(principalId), now);\n-\t\t\treturn openInvitationCount>0L ? AUTHORIZED_ADD_TEAM_MEMBER : UNAUTHORIZED_ADD_TEAM_MEMBER_GENERIC;\n+\t\t\t// check that principalUserInfo has an invitation to this team or that this team is public\n+\t\t\thasInviteOrRequestToJoin = this.checkCanAddSelf(teamId, amTeamAdmin, principalId, now);\n \t\t} else {\n-\t\t\t// the member to be added is someone other than me\n-\t\t\tif (!amTeamAdmin) return UNAUTHORIZED_ADD_TEAM_MEMBER_GENERIC; // can't add someone unless I'm a Team administrator\n-\t\t\t// can't add someone unless they are asking to be added\n-\t\t\tif (alreadyInTeam) return AUTHORIZED_ADD_TEAM_MEMBER;\n-\t\t\tlong openRequestCount = membershipRequestDAO.getOpenByTeamAndRequesterCount(Long.parseLong(teamId), Long.parseLong(principalId), now);\n-\t\t\treturn openRequestCount>0L  ? AUTHORIZED_ADD_TEAM_MEMBER : UNAUTHORIZED_ADD_TEAM_MEMBER_GENERIC;\n+\t\t\t// check that principalUserInfo has requested to join this team\n+\t\t\thasInviteOrRequestToJoin = this.checkCanAddOther(teamId, amTeamAdmin, principalId, now);\n+\t\t}\n+\t\tif (!hasInviteOrRequestToJoin.isAuthorized()) {\n+\t\t\treturn hasInviteOrRequestToJoin;\n \t\t}\n+\t\tif (hasUnmetAccessRequirements(principalUserInfo, teamId)) {\n+\t\t\tif (userInfo.equals(principalUserInfo)) {\n+\t\t\t\treturn  UNAUTHORIZED_ADD_TEAM_MEMBER_UNMET_AR_SELF;\n+\t\t\t} else {\n+\t\t\t\treturn  UNAUTHORIZED_ADD_TEAM_MEMBER_UNMET_AR_OTHER;\n+\t\t\t}\n+\t\t};\n+\t\treturn AUTHORIZED_ADD_TEAM_MEMBER;\n \t}\n \t\n \t@Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAxMTgwOA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4106#discussion_r451011808", "bodyText": "\"An invitation is required to join the team.\"", "author": "brucehoff", "createdAt": "2020-07-07T17:00:09Z", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java", "diffHunk": "@@ -488,30 +494,30 @@ have MEMBERSHIP permission on Team and membership request has been created (but\n \t * @param principalId the ID of the one to be added to the team\n \t * @return\n \t */\n-\tpublic boolean canAddTeamMember(UserInfo userInfo, String teamId, UserInfo principalUserInfo, boolean alreadyInTeam) throws NotFoundException {\n-\t\tif (userInfo.isAdmin()) return true;\n-\t\tif (hasUnmetAccessRequirements(principalUserInfo, teamId)) return false;\n+\tpublic AuthorizationStatus canAddTeamMember(UserInfo userInfo, String teamId, UserInfo principalUserInfo, boolean alreadyInTeam) throws NotFoundException {\n+\t\tif (userInfo.isAdmin()) return AUTHORIZED_ADD_TEAM_MEMBER;\n+\t\tif (hasUnmetAccessRequirements(principalUserInfo, teamId)) return UNAUTHORIZED_ADD_TEAM_MEMBER_UNMET_AR;\n \t\tString principalId = principalUserInfo.getId().toString();\n \t\tboolean principalIsSelf = userInfo.getId().toString().equals(principalId);\n \t\tboolean amTeamAdmin = authorizationManager.canAccess(userInfo, teamId, ObjectType.TEAM, ACCESS_TYPE.TEAM_MEMBERSHIP_UPDATE).isAuthorized();\n \t\tlong now = System.currentTimeMillis();\n \t\tif (principalIsSelf) {\n \t\t\t// trying to add myself to Team.  \n-\t\t\tif (amTeamAdmin) return true;\n+\t\t\tif (amTeamAdmin) return AUTHORIZED_ADD_TEAM_MEMBER;\n \t\t\t// if the team is open, I can join\n \t\t\tTeam team = teamDAO.get(teamId);\n-\t\t\tif (team.getCanPublicJoin()!=null && team.getCanPublicJoin()==true) return true;\n+\t\t\tif (team.getCanPublicJoin()!=null && team.getCanPublicJoin()==true) return AUTHORIZED_ADD_TEAM_MEMBER;\n \t\t\t// if I'm not a team admin and the team is not open, then I need to have an open invitation\n-\t\t\tif (alreadyInTeam) return true;\n+\t\t\tif (alreadyInTeam) return AUTHORIZED_ADD_TEAM_MEMBER;\n \t\t\tlong openInvitationCount = membershipInvitationDAO.getOpenByTeamAndUserCount(Long.parseLong(teamId), Long.parseLong(principalId), now);\n-\t\t\treturn openInvitationCount>0L;\n+\t\t\treturn openInvitationCount>0L ? AUTHORIZED_ADD_TEAM_MEMBER : UNAUTHORIZED_ADD_TEAM_MEMBER_GENERIC;", "originalCommit": "beccdf7a2d5488e9cdb8961e3e5531ff9be284a1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6678f1572f6b2ecde9226eb4f43352b54794b125", "chunk": "diff --git a/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java b/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java\nindex 5996781964..00b0e0f37b 100644\n--- a/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java\n+++ b/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java\n\n@@ -491,34 +517,36 @@ public class TeamManagerImpl implements TeamManager {\n     \thave MEMBERSHIP permission on Team and membership request has been created (but not yet accepted) for principalId\n \t * @param userInfo\n \t * @param teamId the ID of the team\n-\t * @param principalId the ID of the one to be added to the team\n \t * @return\n \t */\n \tpublic AuthorizationStatus canAddTeamMember(UserInfo userInfo, String teamId, UserInfo principalUserInfo, boolean alreadyInTeam) throws NotFoundException {\n+\t\t// admin can always accept membership\n \t\tif (userInfo.isAdmin()) return AUTHORIZED_ADD_TEAM_MEMBER;\n-\t\tif (hasUnmetAccessRequirements(principalUserInfo, teamId)) return UNAUTHORIZED_ADD_TEAM_MEMBER_UNMET_AR;\n+\t\tif (alreadyInTeam) return AUTHORIZED_ADD_TEAM_MEMBER;\n+\n \t\tString principalId = principalUserInfo.getId().toString();\n-\t\tboolean principalIsSelf = userInfo.getId().toString().equals(principalId);\n+\t\tboolean principalIsSelf = userInfo.equals(principalUserInfo);\n \t\tboolean amTeamAdmin = authorizationManager.canAccess(userInfo, teamId, ObjectType.TEAM, ACCESS_TYPE.TEAM_MEMBERSHIP_UPDATE).isAuthorized();\n \t\tlong now = System.currentTimeMillis();\n+\t\tAuthorizationStatus hasInviteOrRequestToJoin = null;\n \t\tif (principalIsSelf) {\n-\t\t\t// trying to add myself to Team.  \n-\t\t\tif (amTeamAdmin) return AUTHORIZED_ADD_TEAM_MEMBER;\n-\t\t\t// if the team is open, I can join\n-\t\t\tTeam team = teamDAO.get(teamId);\n-\t\t\tif (team.getCanPublicJoin()!=null && team.getCanPublicJoin()==true) return AUTHORIZED_ADD_TEAM_MEMBER;\n-\t\t\t// if I'm not a team admin and the team is not open, then I need to have an open invitation\n-\t\t\tif (alreadyInTeam) return AUTHORIZED_ADD_TEAM_MEMBER;\n-\t\t\tlong openInvitationCount = membershipInvitationDAO.getOpenByTeamAndUserCount(Long.parseLong(teamId), Long.parseLong(principalId), now);\n-\t\t\treturn openInvitationCount>0L ? AUTHORIZED_ADD_TEAM_MEMBER : UNAUTHORIZED_ADD_TEAM_MEMBER_GENERIC;\n+\t\t\t// check that principalUserInfo has an invitation to this team or that this team is public\n+\t\t\thasInviteOrRequestToJoin = this.checkCanAddSelf(teamId, amTeamAdmin, principalId, now);\n \t\t} else {\n-\t\t\t// the member to be added is someone other than me\n-\t\t\tif (!amTeamAdmin) return UNAUTHORIZED_ADD_TEAM_MEMBER_GENERIC; // can't add someone unless I'm a Team administrator\n-\t\t\t// can't add someone unless they are asking to be added\n-\t\t\tif (alreadyInTeam) return AUTHORIZED_ADD_TEAM_MEMBER;\n-\t\t\tlong openRequestCount = membershipRequestDAO.getOpenByTeamAndRequesterCount(Long.parseLong(teamId), Long.parseLong(principalId), now);\n-\t\t\treturn openRequestCount>0L  ? AUTHORIZED_ADD_TEAM_MEMBER : UNAUTHORIZED_ADD_TEAM_MEMBER_GENERIC;\n+\t\t\t// check that principalUserInfo has requested to join this team\n+\t\t\thasInviteOrRequestToJoin = this.checkCanAddOther(teamId, amTeamAdmin, principalId, now);\n+\t\t}\n+\t\tif (!hasInviteOrRequestToJoin.isAuthorized()) {\n+\t\t\treturn hasInviteOrRequestToJoin;\n \t\t}\n+\t\tif (hasUnmetAccessRequirements(principalUserInfo, teamId)) {\n+\t\t\tif (userInfo.equals(principalUserInfo)) {\n+\t\t\t\treturn  UNAUTHORIZED_ADD_TEAM_MEMBER_UNMET_AR_SELF;\n+\t\t\t} else {\n+\t\t\t\treturn  UNAUTHORIZED_ADD_TEAM_MEMBER_UNMET_AR_OTHER;\n+\t\t\t}\n+\t\t};\n+\t\treturn AUTHORIZED_ADD_TEAM_MEMBER;\n \t}\n \t\n \t@Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAxMjI1Mw==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4106#discussion_r451012253", "bodyText": "\"You must be a team manager to perform this operation.\"", "author": "brucehoff", "createdAt": "2020-07-07T17:00:50Z", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java", "diffHunk": "@@ -488,30 +494,30 @@ have MEMBERSHIP permission on Team and membership request has been created (but\n \t * @param principalId the ID of the one to be added to the team\n \t * @return\n \t */\n-\tpublic boolean canAddTeamMember(UserInfo userInfo, String teamId, UserInfo principalUserInfo, boolean alreadyInTeam) throws NotFoundException {\n-\t\tif (userInfo.isAdmin()) return true;\n-\t\tif (hasUnmetAccessRequirements(principalUserInfo, teamId)) return false;\n+\tpublic AuthorizationStatus canAddTeamMember(UserInfo userInfo, String teamId, UserInfo principalUserInfo, boolean alreadyInTeam) throws NotFoundException {\n+\t\tif (userInfo.isAdmin()) return AUTHORIZED_ADD_TEAM_MEMBER;\n+\t\tif (hasUnmetAccessRequirements(principalUserInfo, teamId)) return UNAUTHORIZED_ADD_TEAM_MEMBER_UNMET_AR;\n \t\tString principalId = principalUserInfo.getId().toString();\n \t\tboolean principalIsSelf = userInfo.getId().toString().equals(principalId);\n \t\tboolean amTeamAdmin = authorizationManager.canAccess(userInfo, teamId, ObjectType.TEAM, ACCESS_TYPE.TEAM_MEMBERSHIP_UPDATE).isAuthorized();\n \t\tlong now = System.currentTimeMillis();\n \t\tif (principalIsSelf) {\n \t\t\t// trying to add myself to Team.  \n-\t\t\tif (amTeamAdmin) return true;\n+\t\t\tif (amTeamAdmin) return AUTHORIZED_ADD_TEAM_MEMBER;\n \t\t\t// if the team is open, I can join\n \t\t\tTeam team = teamDAO.get(teamId);\n-\t\t\tif (team.getCanPublicJoin()!=null && team.getCanPublicJoin()==true) return true;\n+\t\t\tif (team.getCanPublicJoin()!=null && team.getCanPublicJoin()==true) return AUTHORIZED_ADD_TEAM_MEMBER;\n \t\t\t// if I'm not a team admin and the team is not open, then I need to have an open invitation\n-\t\t\tif (alreadyInTeam) return true;\n+\t\t\tif (alreadyInTeam) return AUTHORIZED_ADD_TEAM_MEMBER;\n \t\t\tlong openInvitationCount = membershipInvitationDAO.getOpenByTeamAndUserCount(Long.parseLong(teamId), Long.parseLong(principalId), now);\n-\t\t\treturn openInvitationCount>0L;\n+\t\t\treturn openInvitationCount>0L ? AUTHORIZED_ADD_TEAM_MEMBER : UNAUTHORIZED_ADD_TEAM_MEMBER_GENERIC;\n \t\t} else {\n \t\t\t// the member to be added is someone other than me\n-\t\t\tif (!amTeamAdmin) return false; // can't add somone unless I'm a Team administrator\n+\t\t\tif (!amTeamAdmin) return UNAUTHORIZED_ADD_TEAM_MEMBER_GENERIC; // can't add someone unless I'm a Team administrator", "originalCommit": "beccdf7a2d5488e9cdb8961e3e5531ff9be284a1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6678f1572f6b2ecde9226eb4f43352b54794b125", "chunk": "diff --git a/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java b/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java\nindex 5996781964..00b0e0f37b 100644\n--- a/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java\n+++ b/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java\n\n@@ -491,34 +517,36 @@ public class TeamManagerImpl implements TeamManager {\n     \thave MEMBERSHIP permission on Team and membership request has been created (but not yet accepted) for principalId\n \t * @param userInfo\n \t * @param teamId the ID of the team\n-\t * @param principalId the ID of the one to be added to the team\n \t * @return\n \t */\n \tpublic AuthorizationStatus canAddTeamMember(UserInfo userInfo, String teamId, UserInfo principalUserInfo, boolean alreadyInTeam) throws NotFoundException {\n+\t\t// admin can always accept membership\n \t\tif (userInfo.isAdmin()) return AUTHORIZED_ADD_TEAM_MEMBER;\n-\t\tif (hasUnmetAccessRequirements(principalUserInfo, teamId)) return UNAUTHORIZED_ADD_TEAM_MEMBER_UNMET_AR;\n+\t\tif (alreadyInTeam) return AUTHORIZED_ADD_TEAM_MEMBER;\n+\n \t\tString principalId = principalUserInfo.getId().toString();\n-\t\tboolean principalIsSelf = userInfo.getId().toString().equals(principalId);\n+\t\tboolean principalIsSelf = userInfo.equals(principalUserInfo);\n \t\tboolean amTeamAdmin = authorizationManager.canAccess(userInfo, teamId, ObjectType.TEAM, ACCESS_TYPE.TEAM_MEMBERSHIP_UPDATE).isAuthorized();\n \t\tlong now = System.currentTimeMillis();\n+\t\tAuthorizationStatus hasInviteOrRequestToJoin = null;\n \t\tif (principalIsSelf) {\n-\t\t\t// trying to add myself to Team.  \n-\t\t\tif (amTeamAdmin) return AUTHORIZED_ADD_TEAM_MEMBER;\n-\t\t\t// if the team is open, I can join\n-\t\t\tTeam team = teamDAO.get(teamId);\n-\t\t\tif (team.getCanPublicJoin()!=null && team.getCanPublicJoin()==true) return AUTHORIZED_ADD_TEAM_MEMBER;\n-\t\t\t// if I'm not a team admin and the team is not open, then I need to have an open invitation\n-\t\t\tif (alreadyInTeam) return AUTHORIZED_ADD_TEAM_MEMBER;\n-\t\t\tlong openInvitationCount = membershipInvitationDAO.getOpenByTeamAndUserCount(Long.parseLong(teamId), Long.parseLong(principalId), now);\n-\t\t\treturn openInvitationCount>0L ? AUTHORIZED_ADD_TEAM_MEMBER : UNAUTHORIZED_ADD_TEAM_MEMBER_GENERIC;\n+\t\t\t// check that principalUserInfo has an invitation to this team or that this team is public\n+\t\t\thasInviteOrRequestToJoin = this.checkCanAddSelf(teamId, amTeamAdmin, principalId, now);\n \t\t} else {\n-\t\t\t// the member to be added is someone other than me\n-\t\t\tif (!amTeamAdmin) return UNAUTHORIZED_ADD_TEAM_MEMBER_GENERIC; // can't add someone unless I'm a Team administrator\n-\t\t\t// can't add someone unless they are asking to be added\n-\t\t\tif (alreadyInTeam) return AUTHORIZED_ADD_TEAM_MEMBER;\n-\t\t\tlong openRequestCount = membershipRequestDAO.getOpenByTeamAndRequesterCount(Long.parseLong(teamId), Long.parseLong(principalId), now);\n-\t\t\treturn openRequestCount>0L  ? AUTHORIZED_ADD_TEAM_MEMBER : UNAUTHORIZED_ADD_TEAM_MEMBER_GENERIC;\n+\t\t\t// check that principalUserInfo has requested to join this team\n+\t\t\thasInviteOrRequestToJoin = this.checkCanAddOther(teamId, amTeamAdmin, principalId, now);\n+\t\t}\n+\t\tif (!hasInviteOrRequestToJoin.isAuthorized()) {\n+\t\t\treturn hasInviteOrRequestToJoin;\n \t\t}\n+\t\tif (hasUnmetAccessRequirements(principalUserInfo, teamId)) {\n+\t\t\tif (userInfo.equals(principalUserInfo)) {\n+\t\t\t\treturn  UNAUTHORIZED_ADD_TEAM_MEMBER_UNMET_AR_SELF;\n+\t\t\t} else {\n+\t\t\t\treturn  UNAUTHORIZED_ADD_TEAM_MEMBER_UNMET_AR_OTHER;\n+\t\t\t}\n+\t\t};\n+\t\treturn AUTHORIZED_ADD_TEAM_MEMBER;\n \t}\n \t\n \t@Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAyODAxMA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4106#discussion_r451028010", "bodyText": "\"The prospective member must request to join the team.\"", "author": "brucehoff", "createdAt": "2020-07-07T17:28:00Z", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java", "diffHunk": "@@ -488,30 +494,30 @@ have MEMBERSHIP permission on Team and membership request has been created (but\n \t * @param principalId the ID of the one to be added to the team\n \t * @return\n \t */\n-\tpublic boolean canAddTeamMember(UserInfo userInfo, String teamId, UserInfo principalUserInfo, boolean alreadyInTeam) throws NotFoundException {\n-\t\tif (userInfo.isAdmin()) return true;\n-\t\tif (hasUnmetAccessRequirements(principalUserInfo, teamId)) return false;\n+\tpublic AuthorizationStatus canAddTeamMember(UserInfo userInfo, String teamId, UserInfo principalUserInfo, boolean alreadyInTeam) throws NotFoundException {\n+\t\tif (userInfo.isAdmin()) return AUTHORIZED_ADD_TEAM_MEMBER;\n+\t\tif (hasUnmetAccessRequirements(principalUserInfo, teamId)) return UNAUTHORIZED_ADD_TEAM_MEMBER_UNMET_AR;\n \t\tString principalId = principalUserInfo.getId().toString();\n \t\tboolean principalIsSelf = userInfo.getId().toString().equals(principalId);\n \t\tboolean amTeamAdmin = authorizationManager.canAccess(userInfo, teamId, ObjectType.TEAM, ACCESS_TYPE.TEAM_MEMBERSHIP_UPDATE).isAuthorized();\n \t\tlong now = System.currentTimeMillis();\n \t\tif (principalIsSelf) {\n \t\t\t// trying to add myself to Team.  \n-\t\t\tif (amTeamAdmin) return true;\n+\t\t\tif (amTeamAdmin) return AUTHORIZED_ADD_TEAM_MEMBER;\n \t\t\t// if the team is open, I can join\n \t\t\tTeam team = teamDAO.get(teamId);\n-\t\t\tif (team.getCanPublicJoin()!=null && team.getCanPublicJoin()==true) return true;\n+\t\t\tif (team.getCanPublicJoin()!=null && team.getCanPublicJoin()==true) return AUTHORIZED_ADD_TEAM_MEMBER;\n \t\t\t// if I'm not a team admin and the team is not open, then I need to have an open invitation\n-\t\t\tif (alreadyInTeam) return true;\n+\t\t\tif (alreadyInTeam) return AUTHORIZED_ADD_TEAM_MEMBER;\n \t\t\tlong openInvitationCount = membershipInvitationDAO.getOpenByTeamAndUserCount(Long.parseLong(teamId), Long.parseLong(principalId), now);\n-\t\t\treturn openInvitationCount>0L;\n+\t\t\treturn openInvitationCount>0L ? AUTHORIZED_ADD_TEAM_MEMBER : UNAUTHORIZED_ADD_TEAM_MEMBER_GENERIC;\n \t\t} else {\n \t\t\t// the member to be added is someone other than me\n-\t\t\tif (!amTeamAdmin) return false; // can't add somone unless I'm a Team administrator\n+\t\t\tif (!amTeamAdmin) return UNAUTHORIZED_ADD_TEAM_MEMBER_GENERIC; // can't add someone unless I'm a Team administrator\n \t\t\t// can't add someone unless they are asking to be added\n-\t\t\tif (alreadyInTeam) return true;\n+\t\t\tif (alreadyInTeam) return AUTHORIZED_ADD_TEAM_MEMBER;\n \t\t\tlong openRequestCount = membershipRequestDAO.getOpenByTeamAndRequesterCount(Long.parseLong(teamId), Long.parseLong(principalId), now);\n-\t\t\treturn openRequestCount>0L;\n+\t\t\treturn openRequestCount>0L  ? AUTHORIZED_ADD_TEAM_MEMBER : UNAUTHORIZED_ADD_TEAM_MEMBER_GENERIC;", "originalCommit": "beccdf7a2d5488e9cdb8961e3e5531ff9be284a1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6678f1572f6b2ecde9226eb4f43352b54794b125", "chunk": "diff --git a/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java b/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java\nindex 5996781964..00b0e0f37b 100644\n--- a/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java\n+++ b/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java\n\n@@ -491,34 +517,36 @@ public class TeamManagerImpl implements TeamManager {\n     \thave MEMBERSHIP permission on Team and membership request has been created (but not yet accepted) for principalId\n \t * @param userInfo\n \t * @param teamId the ID of the team\n-\t * @param principalId the ID of the one to be added to the team\n \t * @return\n \t */\n \tpublic AuthorizationStatus canAddTeamMember(UserInfo userInfo, String teamId, UserInfo principalUserInfo, boolean alreadyInTeam) throws NotFoundException {\n+\t\t// admin can always accept membership\n \t\tif (userInfo.isAdmin()) return AUTHORIZED_ADD_TEAM_MEMBER;\n-\t\tif (hasUnmetAccessRequirements(principalUserInfo, teamId)) return UNAUTHORIZED_ADD_TEAM_MEMBER_UNMET_AR;\n+\t\tif (alreadyInTeam) return AUTHORIZED_ADD_TEAM_MEMBER;\n+\n \t\tString principalId = principalUserInfo.getId().toString();\n-\t\tboolean principalIsSelf = userInfo.getId().toString().equals(principalId);\n+\t\tboolean principalIsSelf = userInfo.equals(principalUserInfo);\n \t\tboolean amTeamAdmin = authorizationManager.canAccess(userInfo, teamId, ObjectType.TEAM, ACCESS_TYPE.TEAM_MEMBERSHIP_UPDATE).isAuthorized();\n \t\tlong now = System.currentTimeMillis();\n+\t\tAuthorizationStatus hasInviteOrRequestToJoin = null;\n \t\tif (principalIsSelf) {\n-\t\t\t// trying to add myself to Team.  \n-\t\t\tif (amTeamAdmin) return AUTHORIZED_ADD_TEAM_MEMBER;\n-\t\t\t// if the team is open, I can join\n-\t\t\tTeam team = teamDAO.get(teamId);\n-\t\t\tif (team.getCanPublicJoin()!=null && team.getCanPublicJoin()==true) return AUTHORIZED_ADD_TEAM_MEMBER;\n-\t\t\t// if I'm not a team admin and the team is not open, then I need to have an open invitation\n-\t\t\tif (alreadyInTeam) return AUTHORIZED_ADD_TEAM_MEMBER;\n-\t\t\tlong openInvitationCount = membershipInvitationDAO.getOpenByTeamAndUserCount(Long.parseLong(teamId), Long.parseLong(principalId), now);\n-\t\t\treturn openInvitationCount>0L ? AUTHORIZED_ADD_TEAM_MEMBER : UNAUTHORIZED_ADD_TEAM_MEMBER_GENERIC;\n+\t\t\t// check that principalUserInfo has an invitation to this team or that this team is public\n+\t\t\thasInviteOrRequestToJoin = this.checkCanAddSelf(teamId, amTeamAdmin, principalId, now);\n \t\t} else {\n-\t\t\t// the member to be added is someone other than me\n-\t\t\tif (!amTeamAdmin) return UNAUTHORIZED_ADD_TEAM_MEMBER_GENERIC; // can't add someone unless I'm a Team administrator\n-\t\t\t// can't add someone unless they are asking to be added\n-\t\t\tif (alreadyInTeam) return AUTHORIZED_ADD_TEAM_MEMBER;\n-\t\t\tlong openRequestCount = membershipRequestDAO.getOpenByTeamAndRequesterCount(Long.parseLong(teamId), Long.parseLong(principalId), now);\n-\t\t\treturn openRequestCount>0L  ? AUTHORIZED_ADD_TEAM_MEMBER : UNAUTHORIZED_ADD_TEAM_MEMBER_GENERIC;\n+\t\t\t// check that principalUserInfo has requested to join this team\n+\t\t\thasInviteOrRequestToJoin = this.checkCanAddOther(teamId, amTeamAdmin, principalId, now);\n+\t\t}\n+\t\tif (!hasInviteOrRequestToJoin.isAuthorized()) {\n+\t\t\treturn hasInviteOrRequestToJoin;\n \t\t}\n+\t\tif (hasUnmetAccessRequirements(principalUserInfo, teamId)) {\n+\t\t\tif (userInfo.equals(principalUserInfo)) {\n+\t\t\t\treturn  UNAUTHORIZED_ADD_TEAM_MEMBER_UNMET_AR_SELF;\n+\t\t\t} else {\n+\t\t\t\treturn  UNAUTHORIZED_ADD_TEAM_MEMBER_UNMET_AR_OTHER;\n+\t\t\t}\n+\t\t};\n+\t\treturn AUTHORIZED_ADD_TEAM_MEMBER;\n \t}\n \t\n \t@Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAyOTE0NA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4106#discussion_r451029144", "bodyText": "canAddTeamMemberStatus.checkAuthorizationOrElseThrow();", "author": "brucehoff", "createdAt": "2020-07-07T17:29:52Z", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java", "diffHunk": "@@ -576,7 +582,8 @@ public boolean addMember(UserInfo userInfo, String teamId, UserInfo principalUse\n \t\tString principalId = principalUserInfo.getId().toString();\n \t\tSet<Long> currentMembers = groupMembersDAO.getMemberIdsForUpdate(Long.valueOf(teamId));\n \t\tboolean alreadyInTeam = currentMembers.contains(principalUserInfo.getId());\n-\t\tif (!canAddTeamMember(userInfo, teamId, principalUserInfo, alreadyInTeam)) throw new UnauthorizedException(\"Cannot add member to Team.\");\n+\t\tAuthorizationStatus canAddTeamMemberStatus = canAddTeamMember(userInfo, teamId, principalUserInfo, alreadyInTeam);\n+\t\tif (!canAddTeamMemberStatus.isAuthorized()) throw new UnauthorizedException(canAddTeamMemberStatus.getMessage());", "originalCommit": "beccdf7a2d5488e9cdb8961e3e5531ff9be284a1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6678f1572f6b2ecde9226eb4f43352b54794b125", "chunk": "diff --git a/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java b/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java\nindex 5996781964..00b0e0f37b 100644\n--- a/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java\n+++ b/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java\n\n@@ -583,7 +611,7 @@ public class TeamManagerImpl implements TeamManager {\n \t\tSet<Long> currentMembers = groupMembersDAO.getMemberIdsForUpdate(Long.valueOf(teamId));\n \t\tboolean alreadyInTeam = currentMembers.contains(principalUserInfo.getId());\n \t\tAuthorizationStatus canAddTeamMemberStatus = canAddTeamMember(userInfo, teamId, principalUserInfo, alreadyInTeam);\n-\t\tif (!canAddTeamMemberStatus.isAuthorized()) throw new UnauthorizedException(canAddTeamMemberStatus.getMessage());\n+\t\tcanAddTeamMemberStatus.checkAuthorizationOrElseThrow();\n \n \t\tif (!alreadyInTeam) {\n \t\t\tgroupMembersDAO.addMembers(teamId, Collections.singletonList(principalId));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAyOTg1Mg==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4106#discussion_r451029852", "bodyText": "TeamManagerImpl.AUTHORIZED_ADD_TEAM_MEMBER (18 times)", "author": "brucehoff", "createdAt": "2020-07-07T17:31:05Z", "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/team/TeamManagerImplTest.java", "diffHunk": "@@ -515,56 +515,55 @@ public void testCanAddTeamMemberSELF() throws Exception {\n \t\t\n \t\t// I can add myself if I'm an admin on the Team\n \t\twhen(mockAuthorizationManager.canAccess(userInfo, TEAM_ID, ObjectType.TEAM, ACCESS_TYPE.TEAM_MEMBERSHIP_UPDATE)).thenReturn(AuthorizationStatus.authorized());\n-\t\tassertTrue(teamManagerImpl.canAddTeamMember(userInfo, TEAM_ID, userInfo, false));\n+\t\tassertEquals(teamManagerImpl.canAddTeamMember(userInfo, TEAM_ID, userInfo, false), teamManagerImpl.AUTHORIZED_ADD_TEAM_MEMBER);", "originalCommit": "beccdf7a2d5488e9cdb8961e3e5531ff9be284a1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6678f1572f6b2ecde9226eb4f43352b54794b125", "chunk": "diff --git a/services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/team/TeamManagerImplTest.java b/services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/team/TeamManagerImplTest.java\nindex e998b38759..00619448d1 100644\n--- a/services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/team/TeamManagerImplTest.java\n+++ b/services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/team/TeamManagerImplTest.java\n\n@@ -515,55 +515,55 @@ public class TeamManagerImplTest {\n \t\t\n \t\t// I can add myself if I'm an admin on the Team\n \t\twhen(mockAuthorizationManager.canAccess(userInfo, TEAM_ID, ObjectType.TEAM, ACCESS_TYPE.TEAM_MEMBERSHIP_UPDATE)).thenReturn(AuthorizationStatus.authorized());\n-\t\tassertEquals(teamManagerImpl.canAddTeamMember(userInfo, TEAM_ID, userInfo, false), teamManagerImpl.AUTHORIZED_ADD_TEAM_MEMBER);\n+\t\tassertEquals(teamManagerImpl.canAddTeamMember(userInfo, TEAM_ID, userInfo, false), TeamManagerImpl.AUTHORIZED_ADD_TEAM_MEMBER);\n \n \t\t// I canNOT add myself if I'm not an admin on the Team if I haven't been invited...\n \t\twhen(mockAuthorizationManager.canAccess(userInfo, TEAM_ID, ObjectType.TEAM, ACCESS_TYPE.TEAM_MEMBERSHIP_UPDATE)).thenReturn(AuthorizationStatus.accessDenied(\"\"));\n \t\twhen(mockMembershipInvitationDAO.getOpenByTeamAndUserCount(eq(Long.parseLong(TEAM_ID)), eq(Long.parseLong(MEMBER_PRINCIPAL_ID)), anyLong())).thenReturn(0L);\n-\t\tassertEquals(teamManagerImpl.canAddTeamMember(userInfo, TEAM_ID, userInfo, false), teamManagerImpl.UNAUTHORIZED_ADD_TEAM_MEMBER_GENERIC);\n+\t\tassertEquals(teamManagerImpl.canAddTeamMember(userInfo, TEAM_ID, userInfo, false), TeamManagerImpl.UNAUTHORIZED_ADD_TEAM_MEMBER_MUST_HAVE_INVITATION);\n \t\t// ... but it returns true if I'm already on the team...\n-\t\tassertEquals(teamManagerImpl.canAddTeamMember(userInfo, TEAM_ID, userInfo, true), teamManagerImpl.AUTHORIZED_ADD_TEAM_MEMBER);\n+\t\tassertEquals(teamManagerImpl.canAddTeamMember(userInfo, TEAM_ID, userInfo, true), TeamManagerImpl.AUTHORIZED_ADD_TEAM_MEMBER);\n \t\t\n \t\t// ...or if the team is Open\n \t\tteam.setCanPublicJoin(true);\n-\t\tassertEquals(teamManagerImpl.canAddTeamMember(userInfo, TEAM_ID, userInfo, false), teamManagerImpl.AUTHORIZED_ADD_TEAM_MEMBER);\n+\t\tassertEquals(teamManagerImpl.canAddTeamMember(userInfo, TEAM_ID, userInfo, false), TeamManagerImpl.AUTHORIZED_ADD_TEAM_MEMBER);\n \t\tteam.setCanPublicJoin(false);\n \t\t\n \t\t// I can add myself if I'm not an admin on the team if I've been invited\n \t\twhen(mockMembershipInvitationDAO.getOpenByTeamAndUserCount(eq(Long.parseLong(TEAM_ID)), eq(Long.parseLong(MEMBER_PRINCIPAL_ID)), anyLong())).thenReturn(1L);\n-\t\tassertEquals(teamManagerImpl.canAddTeamMember(userInfo, TEAM_ID, userInfo, false), teamManagerImpl.AUTHORIZED_ADD_TEAM_MEMBER);\n+\t\tassertEquals(teamManagerImpl.canAddTeamMember(userInfo, TEAM_ID, userInfo, false), TeamManagerImpl.AUTHORIZED_ADD_TEAM_MEMBER);\n \t\t\n \t\t// I can't add myself if I'm invited to some other team...\n \t\twhen(mockMembershipInvitationDAO.getOpenByTeamAndUserCount(\n \t\t\t\teq(Long.parseLong(TEAM_ID)), eq(Long.parseLong(MEMBER_PRINCIPAL_ID)), anyLong())).thenReturn(1L);\n-\t\tassertEquals(teamManagerImpl.canAddTeamMember(userInfo, TEAM_ID, userInfo, false),  teamManagerImpl.AUTHORIZED_ADD_TEAM_MEMBER);\n+\t\tassertEquals(teamManagerImpl.canAddTeamMember(userInfo, TEAM_ID, userInfo, false),  TeamManagerImpl.AUTHORIZED_ADD_TEAM_MEMBER);\n \t\t\n \t\twhen(mockMembershipInvitationDAO.getOpenByTeamAndUserCount(\n \t\t\t\teq(Long.parseLong(TEAM_ID)), eq(Long.parseLong(MEMBER_PRINCIPAL_ID)), anyLong())).thenReturn(0L);\n-\t\tassertEquals(teamManagerImpl.canAddTeamMember(userInfo, TEAM_ID, userInfo, false), teamManagerImpl.UNAUTHORIZED_ADD_TEAM_MEMBER_GENERIC);\n+\t\tassertEquals(teamManagerImpl.canAddTeamMember(userInfo, TEAM_ID, userInfo, false), TeamManagerImpl.UNAUTHORIZED_ADD_TEAM_MEMBER_MUST_HAVE_INVITATION);\n \t\t// ok if I'm already in the team\n-\t\tassertEquals(teamManagerImpl.canAddTeamMember(userInfo, TEAM_ID, userInfo, true), teamManagerImpl.AUTHORIZED_ADD_TEAM_MEMBER);\n+\t\tassertEquals(teamManagerImpl.canAddTeamMember(userInfo, TEAM_ID, userInfo, true), TeamManagerImpl.AUTHORIZED_ADD_TEAM_MEMBER);\n \t\t// restore the mock\n \t\twhen(mockMembershipInvitationDAO.getOpenByTeamAndUserCount(\n \t\t\t\teq(Long.parseLong(TEAM_ID)), eq(Long.parseLong(MEMBER_PRINCIPAL_ID)), anyLong())).thenReturn(1L);\n \n-\t\tassertEquals(teamManagerImpl.canAddTeamMember(adminInfo, TEAM_ID, adminInfo, false), teamManagerImpl.AUTHORIZED_ADD_TEAM_MEMBER);\n+\t\tassertEquals(teamManagerImpl.canAddTeamMember(adminInfo, TEAM_ID, adminInfo, false), TeamManagerImpl.AUTHORIZED_ADD_TEAM_MEMBER);\n \n \t\t// Test access requirements:\n \t\t// first, the baseline\n-\t\tassertEquals(teamManagerImpl.canAddTeamMember(userInfo, TEAM_ID, userInfo, false), teamManagerImpl.AUTHORIZED_ADD_TEAM_MEMBER);\n+\t\tassertEquals(teamManagerImpl.canAddTeamMember(userInfo, TEAM_ID, userInfo, false), TeamManagerImpl.AUTHORIZED_ADD_TEAM_MEMBER);\n \t\t// now add unmet access requirement\n \t\twhen(mockRestrictionInformationManager.\n \t\t\t\tgetRestrictionInformation(userInfo, restrictionInfoRqst)).\n \t\t\t\t\tthenReturn(hasUnmetAccessRqmtResponse);\n \t\t// I can no longer join\n-\t\tassertEquals(teamManagerImpl.canAddTeamMember(userInfo, TEAM_ID, userInfo, false), teamManagerImpl.UNAUTHORIZED_ADD_TEAM_MEMBER_UNMET_AR);\n+\t\tassertEquals(teamManagerImpl.canAddTeamMember(userInfo, TEAM_ID, userInfo, false), TeamManagerImpl.UNAUTHORIZED_ADD_TEAM_MEMBER_UNMET_AR_SELF);\n \t}\n \t\n \t@Test\n \tpublic void testCanAddTeamMemberOTHER() throws Exception {\n \t\t// I can add someone else if I'm a Synapse admin\n-\t\tassertEquals(teamManagerImpl.canAddTeamMember(adminInfo, TEAM_ID, adminInfo, false), teamManagerImpl.AUTHORIZED_ADD_TEAM_MEMBER);\n+\t\tassertEquals(teamManagerImpl.canAddTeamMember(adminInfo, TEAM_ID, adminInfo, false), TeamManagerImpl.AUTHORIZED_ADD_TEAM_MEMBER);\n \t\t\n \t\t// I can't add someone else if they haven't requested it\n \t\t//\t I am an admin for the team\n"}}, {"oid": "6678f1572f6b2ecde9226eb4f43352b54794b125", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/6678f1572f6b2ecde9226eb4f43352b54794b125", "message": "Add more specific error messages to canaddteammember method", "committedDate": "2020-07-13T16:54:21Z", "type": "commit"}, {"oid": "30e915329662fe1dffe523e0da47fe450b6d6831", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/30e915329662fe1dffe523e0da47fe450b6d6831", "message": "fix test, typo, remove uneccessary throws exception statement", "committedDate": "2020-07-13T17:34:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI3NDU0Ng==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4106#discussion_r458274546", "bodyText": "// if principal is other and the caller is allowed to add then 'other' must have requested membership", "author": "brucehoff", "createdAt": "2020-07-21T17:39:59Z", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java", "diffHunk": "@@ -484,41 +490,63 @@ private boolean hasUnmetAccessRequirements(UserInfo memberUserInfo, String teamI\n \t\treturn restrictionInformationManager.getRestrictionInformation(memberUserInfo, request).getHasUnmetAccessRequirement();\n \t}\n \n+\tprivate AuthorizationStatus checkCanAddOther(String teamId, boolean amTeamAdmin, String principalId, long now) {\n+\t\t// the member to be added is someone other than me\n+\t\tif (!amTeamAdmin) return UNAUTHORIZED_ADD_TEAM_MEMBER_MUST_BE_TEAM_MANAGER; // can't add someone unless I'm a Team administrator\n+\t\t// can't add someone unless they are asking to be added\n+\t\tlong openRequestCount = membershipRequestDAO.getOpenByTeamAndRequesterCount(Long.parseLong(teamId), Long.parseLong(principalId), now);\n+\t\treturn openRequestCount>0L  ? AUTHORIZED_ADD_TEAM_MEMBER : UNAUTHORIZED_ADD_TEAM_MEMBER_MUST_HAVE_REQUEST;\n+\t}\n+\n+\tprivate AuthorizationStatus checkCanAddSelf(String teamId, boolean amTeamAdmin, String principalId, long now) {\n+\t\t// trying to add myself to Team.\n+\t\tif (amTeamAdmin) return AUTHORIZED_ADD_TEAM_MEMBER;\n+\t\t// if the team is open, I can join\n+\t\tTeam team = teamDAO.get(teamId);\n+\t\tif (team.getCanPublicJoin()!=null && team.getCanPublicJoin()==true) return AUTHORIZED_ADD_TEAM_MEMBER;\n+\t\t// if I'm not a team admin and the team is not open, then I need to have an open invitation\n+\t\tlong openInvitationCount = membershipInvitationDAO.getOpenByTeamAndUserCount(Long.parseLong(teamId), Long.parseLong(principalId), now);\n+\t\treturn openInvitationCount>0L ? AUTHORIZED_ADD_TEAM_MEMBER : UNAUTHORIZED_ADD_TEAM_MEMBER_MUST_HAVE_INVITATION;\n+\t}\n+\n+\n \t/**\n \t * Either:\n \t\tprincipalId is self and membership invitation has been extended (and not yet accepted), or\n     \tprincipalId is self and have MEMBERSHIP permission on Team, or\n     \thave MEMBERSHIP permission on Team and membership request has been created (but not yet accepted) for principalId\n \t * @param userInfo\n \t * @param teamId the ID of the team\n-\t * @param principalId the ID of the one to be added to the team\n \t * @return\n \t */\n \tpublic AuthorizationStatus canAddTeamMember(UserInfo userInfo, String teamId, UserInfo principalUserInfo, boolean alreadyInTeam) throws NotFoundException {\n+\t\t// admin can always accept membership\n \t\tif (userInfo.isAdmin()) return AUTHORIZED_ADD_TEAM_MEMBER;\n-\t\tif (hasUnmetAccessRequirements(principalUserInfo, teamId)) return UNAUTHORIZED_ADD_TEAM_MEMBER_UNMET_AR;\n+\t\tif (alreadyInTeam) return AUTHORIZED_ADD_TEAM_MEMBER;\n+\n \t\tString principalId = principalUserInfo.getId().toString();\n-\t\tboolean principalIsSelf = userInfo.getId().toString().equals(principalId);\n+\t\tboolean principalIsSelf = userInfo.equals(principalUserInfo);\n \t\tboolean amTeamAdmin = authorizationManager.canAccess(userInfo, teamId, ObjectType.TEAM, ACCESS_TYPE.TEAM_MEMBERSHIP_UPDATE).isAuthorized();\n \t\tlong now = System.currentTimeMillis();\n+\t\tAuthorizationStatus hasInviteOrRequestToJoin = null;\n \t\tif (principalIsSelf) {\n-\t\t\t// trying to add myself to Team.  \n-\t\t\tif (amTeamAdmin) return AUTHORIZED_ADD_TEAM_MEMBER;\n-\t\t\t// if the team is open, I can join\n-\t\t\tTeam team = teamDAO.get(teamId);\n-\t\t\tif (team.getCanPublicJoin()!=null && team.getCanPublicJoin()==true) return AUTHORIZED_ADD_TEAM_MEMBER;\n-\t\t\t// if I'm not a team admin and the team is not open, then I need to have an open invitation\n-\t\t\tif (alreadyInTeam) return AUTHORIZED_ADD_TEAM_MEMBER;\n-\t\t\tlong openInvitationCount = membershipInvitationDAO.getOpenByTeamAndUserCount(Long.parseLong(teamId), Long.parseLong(principalId), now);\n-\t\t\treturn openInvitationCount>0L ? AUTHORIZED_ADD_TEAM_MEMBER : UNAUTHORIZED_ADD_TEAM_MEMBER_GENERIC;\n+\t\t\t// check that principalUserInfo has an invitation to this team or that this team is public\n+\t\t\thasInviteOrRequestToJoin = this.checkCanAddSelf(teamId, amTeamAdmin, principalId, now);\n \t\t} else {\n-\t\t\t// the member to be added is someone other than me\n-\t\t\tif (!amTeamAdmin) return UNAUTHORIZED_ADD_TEAM_MEMBER_GENERIC; // can't add someone unless I'm a Team administrator\n-\t\t\t// can't add someone unless they are asking to be added\n-\t\t\tif (alreadyInTeam) return AUTHORIZED_ADD_TEAM_MEMBER;\n-\t\t\tlong openRequestCount = membershipRequestDAO.getOpenByTeamAndRequesterCount(Long.parseLong(teamId), Long.parseLong(principalId), now);\n-\t\t\treturn openRequestCount>0L  ? AUTHORIZED_ADD_TEAM_MEMBER : UNAUTHORIZED_ADD_TEAM_MEMBER_GENERIC;\n+\t\t\t// check that principalUserInfo has requested to join this team\n+\t\t\thasInviteOrRequestToJoin = this.checkCanAddOther(teamId, amTeamAdmin, principalId, now);\n+\t\t}\n+\t\tif (!hasInviteOrRequestToJoin.isAuthorized()) {\n+\t\t\treturn hasInviteOrRequestToJoin;\n \t\t}\n+\t\tif (hasUnmetAccessRequirements(principalUserInfo, teamId)) {", "originalCommit": "30e915329662fe1dffe523e0da47fe450b6d6831", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "45593b20bf88e3c850fe7eb3bd32d70b1828c77a", "chunk": "diff --git a/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java b/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java\nindex 00b0e0f37b..853e2ffc60 100644\n--- a/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java\n+++ b/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java\n\n@@ -503,7 +504,7 @@ public class TeamManagerImpl implements TeamManager {\n \t\tif (amTeamAdmin) return AUTHORIZED_ADD_TEAM_MEMBER;\n \t\t// if the team is open, I can join\n \t\tTeam team = teamDAO.get(teamId);\n-\t\tif (team.getCanPublicJoin()!=null && team.getCanPublicJoin()==true) return AUTHORIZED_ADD_TEAM_MEMBER;\n+\t\tif (BooleanUtils.isTrue(team.getCanPublicJoin())) return AUTHORIZED_ADD_TEAM_MEMBER;\n \t\t// if I'm not a team admin and the team is not open, then I need to have an open invitation\n \t\tlong openInvitationCount = membershipInvitationDAO.getOpenByTeamAndUserCount(Long.parseLong(teamId), Long.parseLong(principalId), now);\n \t\treturn openInvitationCount>0L ? AUTHORIZED_ADD_TEAM_MEMBER : UNAUTHORIZED_ADD_TEAM_MEMBER_MUST_HAVE_INVITATION;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI3NzgwMg==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4106#discussion_r458277802", "bodyText": "rename the variable, e.g. to 'canJoin'", "author": "brucehoff", "createdAt": "2020-07-21T17:45:04Z", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java", "diffHunk": "@@ -484,41 +490,63 @@ private boolean hasUnmetAccessRequirements(UserInfo memberUserInfo, String teamI\n \t\treturn restrictionInformationManager.getRestrictionInformation(memberUserInfo, request).getHasUnmetAccessRequirement();\n \t}\n \n+\tprivate AuthorizationStatus checkCanAddOther(String teamId, boolean amTeamAdmin, String principalId, long now) {\n+\t\t// the member to be added is someone other than me\n+\t\tif (!amTeamAdmin) return UNAUTHORIZED_ADD_TEAM_MEMBER_MUST_BE_TEAM_MANAGER; // can't add someone unless I'm a Team administrator\n+\t\t// can't add someone unless they are asking to be added\n+\t\tlong openRequestCount = membershipRequestDAO.getOpenByTeamAndRequesterCount(Long.parseLong(teamId), Long.parseLong(principalId), now);\n+\t\treturn openRequestCount>0L  ? AUTHORIZED_ADD_TEAM_MEMBER : UNAUTHORIZED_ADD_TEAM_MEMBER_MUST_HAVE_REQUEST;\n+\t}\n+\n+\tprivate AuthorizationStatus checkCanAddSelf(String teamId, boolean amTeamAdmin, String principalId, long now) {\n+\t\t// trying to add myself to Team.\n+\t\tif (amTeamAdmin) return AUTHORIZED_ADD_TEAM_MEMBER;\n+\t\t// if the team is open, I can join\n+\t\tTeam team = teamDAO.get(teamId);\n+\t\tif (team.getCanPublicJoin()!=null && team.getCanPublicJoin()==true) return AUTHORIZED_ADD_TEAM_MEMBER;\n+\t\t// if I'm not a team admin and the team is not open, then I need to have an open invitation\n+\t\tlong openInvitationCount = membershipInvitationDAO.getOpenByTeamAndUserCount(Long.parseLong(teamId), Long.parseLong(principalId), now);\n+\t\treturn openInvitationCount>0L ? AUTHORIZED_ADD_TEAM_MEMBER : UNAUTHORIZED_ADD_TEAM_MEMBER_MUST_HAVE_INVITATION;\n+\t}\n+\n+\n \t/**\n \t * Either:\n \t\tprincipalId is self and membership invitation has been extended (and not yet accepted), or\n     \tprincipalId is self and have MEMBERSHIP permission on Team, or\n     \thave MEMBERSHIP permission on Team and membership request has been created (but not yet accepted) for principalId\n \t * @param userInfo\n \t * @param teamId the ID of the team\n-\t * @param principalId the ID of the one to be added to the team\n \t * @return\n \t */\n \tpublic AuthorizationStatus canAddTeamMember(UserInfo userInfo, String teamId, UserInfo principalUserInfo, boolean alreadyInTeam) throws NotFoundException {\n+\t\t// admin can always accept membership\n \t\tif (userInfo.isAdmin()) return AUTHORIZED_ADD_TEAM_MEMBER;\n-\t\tif (hasUnmetAccessRequirements(principalUserInfo, teamId)) return UNAUTHORIZED_ADD_TEAM_MEMBER_UNMET_AR;\n+\t\tif (alreadyInTeam) return AUTHORIZED_ADD_TEAM_MEMBER;\n+\n \t\tString principalId = principalUserInfo.getId().toString();\n-\t\tboolean principalIsSelf = userInfo.getId().toString().equals(principalId);\n+\t\tboolean principalIsSelf = userInfo.equals(principalUserInfo);\n \t\tboolean amTeamAdmin = authorizationManager.canAccess(userInfo, teamId, ObjectType.TEAM, ACCESS_TYPE.TEAM_MEMBERSHIP_UPDATE).isAuthorized();\n \t\tlong now = System.currentTimeMillis();\n+\t\tAuthorizationStatus hasInviteOrRequestToJoin = null;", "originalCommit": "30e915329662fe1dffe523e0da47fe450b6d6831", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "45593b20bf88e3c850fe7eb3bd32d70b1828c77a", "chunk": "diff --git a/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java b/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java\nindex 00b0e0f37b..853e2ffc60 100644\n--- a/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java\n+++ b/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java\n\n@@ -503,7 +504,7 @@ public class TeamManagerImpl implements TeamManager {\n \t\tif (amTeamAdmin) return AUTHORIZED_ADD_TEAM_MEMBER;\n \t\t// if the team is open, I can join\n \t\tTeam team = teamDAO.get(teamId);\n-\t\tif (team.getCanPublicJoin()!=null && team.getCanPublicJoin()==true) return AUTHORIZED_ADD_TEAM_MEMBER;\n+\t\tif (BooleanUtils.isTrue(team.getCanPublicJoin())) return AUTHORIZED_ADD_TEAM_MEMBER;\n \t\t// if I'm not a team admin and the team is not open, then I need to have an open invitation\n \t\tlong openInvitationCount = membershipInvitationDAO.getOpenByTeamAndUserCount(Long.parseLong(teamId), Long.parseLong(principalId), now);\n \t\treturn openInvitationCount>0L ? AUTHORIZED_ADD_TEAM_MEMBER : UNAUTHORIZED_ADD_TEAM_MEMBER_MUST_HAVE_INVITATION;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI3ODExMg==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4106#discussion_r458278112", "bodyText": "use BooleanUtils.isTrue() in apache commons library", "author": "brucehoff", "createdAt": "2020-07-21T17:45:33Z", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java", "diffHunk": "@@ -484,41 +490,63 @@ private boolean hasUnmetAccessRequirements(UserInfo memberUserInfo, String teamI\n \t\treturn restrictionInformationManager.getRestrictionInformation(memberUserInfo, request).getHasUnmetAccessRequirement();\n \t}\n \n+\tprivate AuthorizationStatus checkCanAddOther(String teamId, boolean amTeamAdmin, String principalId, long now) {\n+\t\t// the member to be added is someone other than me\n+\t\tif (!amTeamAdmin) return UNAUTHORIZED_ADD_TEAM_MEMBER_MUST_BE_TEAM_MANAGER; // can't add someone unless I'm a Team administrator\n+\t\t// can't add someone unless they are asking to be added\n+\t\tlong openRequestCount = membershipRequestDAO.getOpenByTeamAndRequesterCount(Long.parseLong(teamId), Long.parseLong(principalId), now);\n+\t\treturn openRequestCount>0L  ? AUTHORIZED_ADD_TEAM_MEMBER : UNAUTHORIZED_ADD_TEAM_MEMBER_MUST_HAVE_REQUEST;\n+\t}\n+\n+\tprivate AuthorizationStatus checkCanAddSelf(String teamId, boolean amTeamAdmin, String principalId, long now) {\n+\t\t// trying to add myself to Team.\n+\t\tif (amTeamAdmin) return AUTHORIZED_ADD_TEAM_MEMBER;\n+\t\t// if the team is open, I can join\n+\t\tTeam team = teamDAO.get(teamId);\n+\t\tif (team.getCanPublicJoin()!=null && team.getCanPublicJoin()==true) return AUTHORIZED_ADD_TEAM_MEMBER;", "originalCommit": "30e915329662fe1dffe523e0da47fe450b6d6831", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "45593b20bf88e3c850fe7eb3bd32d70b1828c77a", "chunk": "diff --git a/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java b/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java\nindex 00b0e0f37b..853e2ffc60 100644\n--- a/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java\n+++ b/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java\n\n@@ -503,7 +504,7 @@ public class TeamManagerImpl implements TeamManager {\n \t\tif (amTeamAdmin) return AUTHORIZED_ADD_TEAM_MEMBER;\n \t\t// if the team is open, I can join\n \t\tTeam team = teamDAO.get(teamId);\n-\t\tif (team.getCanPublicJoin()!=null && team.getCanPublicJoin()==true) return AUTHORIZED_ADD_TEAM_MEMBER;\n+\t\tif (BooleanUtils.isTrue(team.getCanPublicJoin())) return AUTHORIZED_ADD_TEAM_MEMBER;\n \t\t// if I'm not a team admin and the team is not open, then I need to have an open invitation\n \t\tlong openInvitationCount = membershipInvitationDAO.getOpenByTeamAndUserCount(Long.parseLong(teamId), Long.parseLong(principalId), now);\n \t\treturn openInvitationCount>0L ? AUTHORIZED_ADD_TEAM_MEMBER : UNAUTHORIZED_ADD_TEAM_MEMBER_MUST_HAVE_INVITATION;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI3ODQyNg==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4106#discussion_r458278426", "bodyText": "use principalIsSelf", "author": "brucehoff", "createdAt": "2020-07-21T17:46:04Z", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java", "diffHunk": "@@ -484,41 +490,63 @@ private boolean hasUnmetAccessRequirements(UserInfo memberUserInfo, String teamI\n \t\treturn restrictionInformationManager.getRestrictionInformation(memberUserInfo, request).getHasUnmetAccessRequirement();\n \t}\n \n+\tprivate AuthorizationStatus checkCanAddOther(String teamId, boolean amTeamAdmin, String principalId, long now) {\n+\t\t// the member to be added is someone other than me\n+\t\tif (!amTeamAdmin) return UNAUTHORIZED_ADD_TEAM_MEMBER_MUST_BE_TEAM_MANAGER; // can't add someone unless I'm a Team administrator\n+\t\t// can't add someone unless they are asking to be added\n+\t\tlong openRequestCount = membershipRequestDAO.getOpenByTeamAndRequesterCount(Long.parseLong(teamId), Long.parseLong(principalId), now);\n+\t\treturn openRequestCount>0L  ? AUTHORIZED_ADD_TEAM_MEMBER : UNAUTHORIZED_ADD_TEAM_MEMBER_MUST_HAVE_REQUEST;\n+\t}\n+\n+\tprivate AuthorizationStatus checkCanAddSelf(String teamId, boolean amTeamAdmin, String principalId, long now) {\n+\t\t// trying to add myself to Team.\n+\t\tif (amTeamAdmin) return AUTHORIZED_ADD_TEAM_MEMBER;\n+\t\t// if the team is open, I can join\n+\t\tTeam team = teamDAO.get(teamId);\n+\t\tif (team.getCanPublicJoin()!=null && team.getCanPublicJoin()==true) return AUTHORIZED_ADD_TEAM_MEMBER;\n+\t\t// if I'm not a team admin and the team is not open, then I need to have an open invitation\n+\t\tlong openInvitationCount = membershipInvitationDAO.getOpenByTeamAndUserCount(Long.parseLong(teamId), Long.parseLong(principalId), now);\n+\t\treturn openInvitationCount>0L ? AUTHORIZED_ADD_TEAM_MEMBER : UNAUTHORIZED_ADD_TEAM_MEMBER_MUST_HAVE_INVITATION;\n+\t}\n+\n+\n \t/**\n \t * Either:\n \t\tprincipalId is self and membership invitation has been extended (and not yet accepted), or\n     \tprincipalId is self and have MEMBERSHIP permission on Team, or\n     \thave MEMBERSHIP permission on Team and membership request has been created (but not yet accepted) for principalId\n \t * @param userInfo\n \t * @param teamId the ID of the team\n-\t * @param principalId the ID of the one to be added to the team\n \t * @return\n \t */\n \tpublic AuthorizationStatus canAddTeamMember(UserInfo userInfo, String teamId, UserInfo principalUserInfo, boolean alreadyInTeam) throws NotFoundException {\n+\t\t// admin can always accept membership\n \t\tif (userInfo.isAdmin()) return AUTHORIZED_ADD_TEAM_MEMBER;\n-\t\tif (hasUnmetAccessRequirements(principalUserInfo, teamId)) return UNAUTHORIZED_ADD_TEAM_MEMBER_UNMET_AR;\n+\t\tif (alreadyInTeam) return AUTHORIZED_ADD_TEAM_MEMBER;\n+\n \t\tString principalId = principalUserInfo.getId().toString();\n-\t\tboolean principalIsSelf = userInfo.getId().toString().equals(principalId);\n+\t\tboolean principalIsSelf = userInfo.equals(principalUserInfo);\n \t\tboolean amTeamAdmin = authorizationManager.canAccess(userInfo, teamId, ObjectType.TEAM, ACCESS_TYPE.TEAM_MEMBERSHIP_UPDATE).isAuthorized();\n \t\tlong now = System.currentTimeMillis();\n+\t\tAuthorizationStatus hasInviteOrRequestToJoin = null;\n \t\tif (principalIsSelf) {\n-\t\t\t// trying to add myself to Team.  \n-\t\t\tif (amTeamAdmin) return AUTHORIZED_ADD_TEAM_MEMBER;\n-\t\t\t// if the team is open, I can join\n-\t\t\tTeam team = teamDAO.get(teamId);\n-\t\t\tif (team.getCanPublicJoin()!=null && team.getCanPublicJoin()==true) return AUTHORIZED_ADD_TEAM_MEMBER;\n-\t\t\t// if I'm not a team admin and the team is not open, then I need to have an open invitation\n-\t\t\tif (alreadyInTeam) return AUTHORIZED_ADD_TEAM_MEMBER;\n-\t\t\tlong openInvitationCount = membershipInvitationDAO.getOpenByTeamAndUserCount(Long.parseLong(teamId), Long.parseLong(principalId), now);\n-\t\t\treturn openInvitationCount>0L ? AUTHORIZED_ADD_TEAM_MEMBER : UNAUTHORIZED_ADD_TEAM_MEMBER_GENERIC;\n+\t\t\t// check that principalUserInfo has an invitation to this team or that this team is public\n+\t\t\thasInviteOrRequestToJoin = this.checkCanAddSelf(teamId, amTeamAdmin, principalId, now);\n \t\t} else {\n-\t\t\t// the member to be added is someone other than me\n-\t\t\tif (!amTeamAdmin) return UNAUTHORIZED_ADD_TEAM_MEMBER_GENERIC; // can't add someone unless I'm a Team administrator\n-\t\t\t// can't add someone unless they are asking to be added\n-\t\t\tif (alreadyInTeam) return AUTHORIZED_ADD_TEAM_MEMBER;\n-\t\t\tlong openRequestCount = membershipRequestDAO.getOpenByTeamAndRequesterCount(Long.parseLong(teamId), Long.parseLong(principalId), now);\n-\t\t\treturn openRequestCount>0L  ? AUTHORIZED_ADD_TEAM_MEMBER : UNAUTHORIZED_ADD_TEAM_MEMBER_GENERIC;\n+\t\t\t// check that principalUserInfo has requested to join this team\n+\t\t\thasInviteOrRequestToJoin = this.checkCanAddOther(teamId, amTeamAdmin, principalId, now);\n+\t\t}\n+\t\tif (!hasInviteOrRequestToJoin.isAuthorized()) {\n+\t\t\treturn hasInviteOrRequestToJoin;\n \t\t}\n+\t\tif (hasUnmetAccessRequirements(principalUserInfo, teamId)) {\n+\t\t\tif (userInfo.equals(principalUserInfo)) {", "originalCommit": "30e915329662fe1dffe523e0da47fe450b6d6831", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "45593b20bf88e3c850fe7eb3bd32d70b1828c77a", "chunk": "diff --git a/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java b/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java\nindex 00b0e0f37b..853e2ffc60 100644\n--- a/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java\n+++ b/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java\n\n@@ -503,7 +504,7 @@ public class TeamManagerImpl implements TeamManager {\n \t\tif (amTeamAdmin) return AUTHORIZED_ADD_TEAM_MEMBER;\n \t\t// if the team is open, I can join\n \t\tTeam team = teamDAO.get(teamId);\n-\t\tif (team.getCanPublicJoin()!=null && team.getCanPublicJoin()==true) return AUTHORIZED_ADD_TEAM_MEMBER;\n+\t\tif (BooleanUtils.isTrue(team.getCanPublicJoin())) return AUTHORIZED_ADD_TEAM_MEMBER;\n \t\t// if I'm not a team admin and the team is not open, then I need to have an open invitation\n \t\tlong openInvitationCount = membershipInvitationDAO.getOpenByTeamAndUserCount(Long.parseLong(teamId), Long.parseLong(principalId), now);\n \t\treturn openInvitationCount>0L ? AUTHORIZED_ADD_TEAM_MEMBER : UNAUTHORIZED_ADD_TEAM_MEMBER_MUST_HAVE_INVITATION;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI3ODgyNA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4106#discussion_r458278824", "bodyText": "add the method parameters principalUserInfo, alreadyInTeam", "author": "brucehoff", "createdAt": "2020-07-21T17:46:44Z", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java", "diffHunk": "@@ -484,41 +490,63 @@ private boolean hasUnmetAccessRequirements(UserInfo memberUserInfo, String teamI\n \t\treturn restrictionInformationManager.getRestrictionInformation(memberUserInfo, request).getHasUnmetAccessRequirement();\n \t}\n \n+\tprivate AuthorizationStatus checkCanAddOther(String teamId, boolean amTeamAdmin, String principalId, long now) {\n+\t\t// the member to be added is someone other than me\n+\t\tif (!amTeamAdmin) return UNAUTHORIZED_ADD_TEAM_MEMBER_MUST_BE_TEAM_MANAGER; // can't add someone unless I'm a Team administrator\n+\t\t// can't add someone unless they are asking to be added\n+\t\tlong openRequestCount = membershipRequestDAO.getOpenByTeamAndRequesterCount(Long.parseLong(teamId), Long.parseLong(principalId), now);\n+\t\treturn openRequestCount>0L  ? AUTHORIZED_ADD_TEAM_MEMBER : UNAUTHORIZED_ADD_TEAM_MEMBER_MUST_HAVE_REQUEST;\n+\t}\n+\n+\tprivate AuthorizationStatus checkCanAddSelf(String teamId, boolean amTeamAdmin, String principalId, long now) {\n+\t\t// trying to add myself to Team.\n+\t\tif (amTeamAdmin) return AUTHORIZED_ADD_TEAM_MEMBER;\n+\t\t// if the team is open, I can join\n+\t\tTeam team = teamDAO.get(teamId);\n+\t\tif (team.getCanPublicJoin()!=null && team.getCanPublicJoin()==true) return AUTHORIZED_ADD_TEAM_MEMBER;\n+\t\t// if I'm not a team admin and the team is not open, then I need to have an open invitation\n+\t\tlong openInvitationCount = membershipInvitationDAO.getOpenByTeamAndUserCount(Long.parseLong(teamId), Long.parseLong(principalId), now);\n+\t\treturn openInvitationCount>0L ? AUTHORIZED_ADD_TEAM_MEMBER : UNAUTHORIZED_ADD_TEAM_MEMBER_MUST_HAVE_INVITATION;\n+\t}\n+\n+\n \t/**\n \t * Either:\n \t\tprincipalId is self and membership invitation has been extended (and not yet accepted), or\n     \tprincipalId is self and have MEMBERSHIP permission on Team, or\n     \thave MEMBERSHIP permission on Team and membership request has been created (but not yet accepted) for principalId\n \t * @param userInfo\n \t * @param teamId the ID of the team\n-\t * @param principalId the ID of the one to be added to the team", "originalCommit": "30e915329662fe1dffe523e0da47fe450b6d6831", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "45593b20bf88e3c850fe7eb3bd32d70b1828c77a", "chunk": "diff --git a/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java b/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java\nindex 00b0e0f37b..853e2ffc60 100644\n--- a/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java\n+++ b/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java\n\n@@ -503,7 +504,7 @@ public class TeamManagerImpl implements TeamManager {\n \t\tif (amTeamAdmin) return AUTHORIZED_ADD_TEAM_MEMBER;\n \t\t// if the team is open, I can join\n \t\tTeam team = teamDAO.get(teamId);\n-\t\tif (team.getCanPublicJoin()!=null && team.getCanPublicJoin()==true) return AUTHORIZED_ADD_TEAM_MEMBER;\n+\t\tif (BooleanUtils.isTrue(team.getCanPublicJoin())) return AUTHORIZED_ADD_TEAM_MEMBER;\n \t\t// if I'm not a team admin and the team is not open, then I need to have an open invitation\n \t\tlong openInvitationCount = membershipInvitationDAO.getOpenByTeamAndUserCount(Long.parseLong(teamId), Long.parseLong(principalId), now);\n \t\treturn openInvitationCount>0L ? AUTHORIZED_ADD_TEAM_MEMBER : UNAUTHORIZED_ADD_TEAM_MEMBER_MUST_HAVE_INVITATION;\n"}}, {"oid": "45593b20bf88e3c850fe7eb3bd32d70b1828c77a", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/45593b20bf88e3c850fe7eb3bd32d70b1828c77a", "message": "make changes from pr review", "committedDate": "2020-07-21T20:05:52Z", "type": "commit"}]}