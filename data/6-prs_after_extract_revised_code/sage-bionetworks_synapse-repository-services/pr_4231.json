{"pr_number": 4231, "pr_title": "PLFM-6494 - Handle correct exception type and add autowired test", "pr_createdAt": "2020-11-16T15:11:08Z", "pr_url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4231", "timeline": [{"oid": "9917893712e6bee000489928841d64ea1cf59ef9", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/9917893712e6bee000489928841d64ea1cf59ef9", "message": "Handle correct exception type and add autowired test", "committedDate": "2020-11-13T22:50:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUxMDc4NA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4231#discussion_r524510784", "bodyText": "In the interest of strong typing I would suggest an alternative fix, something like:\nDefine a class org.sagebionetworks.DuplicateKeyException that extends IllegalArgumentException.\nIn DBOBasicDaoImpl.insert, catch org.springframework.dao.DuplicateKeyException and throw org.sagebionetworks.DuplicateKeyException.\nHere, in PersonalAccessTokenManagerImpl, catch org.sagebionetworks.DuplicateKeyException and throw an exception (either  org.sagebionetworks.DuplicateKeyException or IllegalArgumentException) with DUPLICATE_TOKEN_NAME_MSG (as currently shown at line 130).", "author": "brucehoff", "createdAt": "2020-11-16T19:14:17Z", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/authentication/PersonalAccessTokenManagerImpl.java", "diffHunk": "@@ -125,8 +125,12 @@ public AccessTokenGenerationResponse issueToken(UserInfo userInfo, String access\n \n \t\ttry {\n \t\t\trecord = personalAccessTokenDao.createTokenRecord(record);\n-\t\t} catch (DuplicateKeyException e) {\n-\t\t\tthrow new IllegalArgumentException(DUPLICATE_TOKEN_NAME_MSG, e);\n+\t\t} catch (IllegalArgumentException e) {\n+\t\t\tif (e.getMessage().contains(\"org.springframework.dao.DuplicateKeyException\")) {", "originalCommit": "9917893712e6bee000489928841d64ea1cf59ef9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ2MDUwOQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4231#discussion_r525460509", "bodyText": "I found elsewhere we're using e.getCause() instanceof org.springframework.dao.DuplicateKeyException to conditionally handle this type of error. I've switched my implementation to use this. Creating a new exception and changing the behavior of DBOBasicDaoImpl would have likely been a much larger change.", "author": "nickgros", "createdAt": "2020-11-17T19:56:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUxMDc4NA=="}], "type": "inlineReview", "revised_code": {"commit": "1aebc5402e5523220649a8bd2c3214a50f825d64", "chunk": "diff --git a/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/authentication/PersonalAccessTokenManagerImpl.java b/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/authentication/PersonalAccessTokenManagerImpl.java\nindex 0432f2571e..98ebd56db4 100644\n--- a/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/authentication/PersonalAccessTokenManagerImpl.java\n+++ b/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/authentication/PersonalAccessTokenManagerImpl.java\n\n@@ -126,7 +126,7 @@ public class PersonalAccessTokenManagerImpl implements PersonalAccessTokenManage\n \t\ttry {\n \t\t\trecord = personalAccessTokenDao.createTokenRecord(record);\n \t\t} catch (IllegalArgumentException e) {\n-\t\t\tif (e.getMessage().contains(\"org.springframework.dao.DuplicateKeyException\")) {\n+\t\t\tif (e.getCause() instanceof DuplicateKeyException) {\n \t\t\t\tthrow new IllegalArgumentException(DUPLICATE_TOKEN_NAME_MSG, e);\n \t\t\t} else {\n \t\t\t\tthrow e;\n"}}, {"oid": "1aebc5402e5523220649a8bd2c3214a50f825d64", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/1aebc5402e5523220649a8bd2c3214a50f825d64", "message": "Use instanceof e.getCause() to verify the DuplicateKeyException", "committedDate": "2020-11-17T19:48:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTUyNjk4NQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4231#discussion_r525526985", "bodyText": "I double checked that this works if e.getCause() == null", "author": "brucehoff", "createdAt": "2020-11-17T21:11:27Z", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/authentication/PersonalAccessTokenManagerImpl.java", "diffHunk": "@@ -125,8 +125,12 @@ public AccessTokenGenerationResponse issueToken(UserInfo userInfo, String access\n \n \t\ttry {\n \t\t\trecord = personalAccessTokenDao.createTokenRecord(record);\n-\t\t} catch (DuplicateKeyException e) {\n-\t\t\tthrow new IllegalArgumentException(DUPLICATE_TOKEN_NAME_MSG, e);\n+\t\t} catch (IllegalArgumentException e) {\n+\t\t\tif (e.getCause() instanceof DuplicateKeyException) {", "originalCommit": "1aebc5402e5523220649a8bd2c3214a50f825d64", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}