{"pr_number": 4003, "pr_title": "PLFM 6158 - Part A: Code review changes", "pr_createdAt": "2020-04-16T01:18:20Z", "pr_url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4003", "timeline": [{"oid": "a69ed47d5e17f009bbb54991051f1d21920d5643", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/a69ed47d5e17f009bbb54991051f1d21920d5643", "message": "PLFM-6158: Swap object_type and object_id primary and foreign keys", "committedDate": "2020-04-15T21:27:00Z", "type": "commit"}, {"oid": "20b989f9983bb72dd3f3cc88252d9536fe835c06", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/20b989f9983bb72dd3f3cc88252d9536fe835c06", "message": "PLFM-6158: Fix for index/table delta query to filter by object type", "committedDate": "2020-04-16T01:16:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkyODU3OA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4003#discussion_r409928578", "bodyText": "remove condition from on clause.", "author": "john-hill", "createdAt": "2020-04-17T00:43:02Z", "path": "lib/lib-table-cluster/src/main/java/org/sagebionetworks/table/cluster/SQLUtils.java", "diffHunk": "@@ -2010,7 +2010,7 @@ public static String insertIntoListColumnIndexTable(IdAndVersion tableIdAndVersi\n \t\t\t+ \"\t\t AND R.\"+OBJECT_REPLICATION_COL_OBJECT_ID+\" = V.\"+ROW_ID\r", "originalCommit": "20b989f9983bb72dd3f3cc88252d9536fe835c06", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "163a035a1673ba47e329471ab257df57b48ed545", "chunk": "diff --git a/lib/lib-table-cluster/src/main/java/org/sagebionetworks/table/cluster/SQLUtils.java b/lib/lib-table-cluster/src/main/java/org/sagebionetworks/table/cluster/SQLUtils.java\nindex 2788f1edbd..c8fcbb3cb6 100644\n--- a/lib/lib-table-cluster/src/main/java/org/sagebionetworks/table/cluster/SQLUtils.java\n+++ b/lib/lib-table-cluster/src/main/java/org/sagebionetworks/table/cluster/SQLUtils.java\n\n@@ -2006,10 +2006,9 @@ public class SQLUtils {\n \t\t\t\"WITH DELTAS (ID, MISSING) AS ( \" \n \t\t\t+ \"SELECT R.\"+OBJECT_REPLICATION_COL_OBJECT_ID+\", V.\"+ROW_ID+\" FROM \"+OBJECT_REPLICATION_TABLE+\" R \"\n \t\t\t+ \"   LEFT JOIN %1$s V ON (\"\n-\t\t\t+ \"      R.\"+OBJECT_REPLICATION_COL_OBJECT_TYPE+\" = :\"+OBJECT_TYPE_PARAM_NAME\n-\t\t\t+ \"\t\t AND R.\"+OBJECT_REPLICATION_COL_OBJECT_ID+\" = V.\"+ROW_ID\n+\t\t\t+ \"\t\t R.\"+OBJECT_REPLICATION_COL_OBJECT_ID+\" = V.\"+ROW_ID\n \t\t\t+ \"      AND R.\"+OBEJCT_REPLICATION_COL_ETAG+\" = V.\"+ROW_ETAG\n-\t\t\t+ \"      AND R.\"+OBJECT_REPLICATION_COL_BENEFACTOR_ID+\" = V.\"+ROW_BENEFACTOR+\")\"\n+\t\t\t+ \"      AND R.\"+OBJECT_REPLICATION_COL_BENEFACTOR_ID+\" = V.\"+ROW_BENEFACTOR+\")\" \n \t\t\t+ \"   WHERE R.\"+OBJECT_REPLICATION_COL_OBJECT_TYPE+\" = :\"+OBJECT_TYPE_PARAM_NAME+\" AND R.%2$s IN (:scopeIds) AND %3$s\" \n \t\t\t+ \" UNION ALL\"\n \t\t\t+ \" SELECT V.\"+ROW_ID+\", R.\"+OBJECT_REPLICATION_COL_OBJECT_ID+\" FROM \"+OBJECT_REPLICATION_TABLE+\" R \"\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkzMTgzNA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4003#discussion_r409931834", "bodyText": "remove condition from on clause", "author": "john-hill", "createdAt": "2020-04-17T00:55:59Z", "path": "lib/lib-table-cluster/src/test/java/org/sagebionetworks/table/cluster/SQLUtilsTest.java", "diffHunk": "@@ -2920,7 +2920,7 @@ public void testGetOutOfDateRowsForViewSqlFileView() {\n \t\t\t\t+ \"\t\t AND R.OBJECT_ID = V.ROW_ID\"\r", "originalCommit": "20b989f9983bb72dd3f3cc88252d9536fe835c06", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "163a035a1673ba47e329471ab257df57b48ed545", "chunk": "diff --git a/lib/lib-table-cluster/src/test/java/org/sagebionetworks/table/cluster/SQLUtilsTest.java b/lib/lib-table-cluster/src/test/java/org/sagebionetworks/table/cluster/SQLUtilsTest.java\nindex 0dd868516c..78cb78ebf2 100644\n--- a/lib/lib-table-cluster/src/test/java/org/sagebionetworks/table/cluster/SQLUtilsTest.java\n+++ b/lib/lib-table-cluster/src/test/java/org/sagebionetworks/table/cluster/SQLUtilsTest.java\n\n@@ -2916,8 +2916,7 @@ public class SQLUtilsTest {\n \t\tString expected = \"WITH DELTAS (ID, MISSING) AS (\"\n \t\t\t\t+ \" SELECT R.OBJECT_ID, V.ROW_ID FROM OBJECT_REPLICATION R\"\n \t\t\t\t+ \"    LEFT JOIN T999 V ON (\"\n-\t\t\t\t+ \"      R.OBJECT_TYPE = :objectType\"\n-\t\t\t\t+ \"\t\t AND R.OBJECT_ID = V.ROW_ID\"\n+\t\t\t\t+ \"\t\t R.OBJECT_ID = V.ROW_ID\"\n \t\t\t\t+ \"      AND R.ETAG = V.ROW_ETAG\"\n \t\t\t\t+ \"      AND R.BENEFACTOR_ID = V.ROW_BENEFACTOR)\"\n \t\t\t\t+ \"   WHERE R.OBJECT_TYPE = :objectType AND R.PARENT_ID IN (:scopeIds) AND R.SUBTYPE IN ('file')\"\n"}}, {"oid": "163a035a1673ba47e329471ab257df57b48ed545", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/163a035a1673ba47e329471ab257df57b48ed545", "message": "PLFM-6158: Remove condition on left join for unused key", "committedDate": "2020-04-17T01:07:21Z", "type": "commit"}]}