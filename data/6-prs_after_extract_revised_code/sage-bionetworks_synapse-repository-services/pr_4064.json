{"pr_number": 4064, "pr_title": "Plfm 6161 i", "pr_createdAt": "2020-05-28T19:38:34Z", "pr_url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4064", "timeline": [{"oid": "16678cbe21e175da57804c8093906885ba5d5e19", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/16678cbe21e175da57804c8093906885ba5d5e19", "message": "starting dao for bindnig schemas to objects", "committedDate": "2020-05-28T01:42:26Z", "type": "commit"}, {"oid": "35c125ef879e6cb0bc86541c42c3c70e76e9dbcb", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/35c125ef879e6cb0bc86541c42c3c70e76e9dbcb", "message": "handle nulls and tests", "committedDate": "2020-05-28T19:36:21Z", "type": "commit"}, {"oid": "93b5f236f208ce392bf1b7e9c0a9580bf82dfa60", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/93b5f236f208ce392bf1b7e9c0a9580bf82dfa60", "message": "test fix and hash equals and to string", "committedDate": "2020-05-28T19:51:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE4MDU3MQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4064#discussion_r432180571", "bodyText": "toString not needed", "author": "marcomarasca", "createdAt": "2020-05-28T23:36:14Z", "path": "lib/jdomodels/src/main/java/org/sagebionetworks/repo/model/dbo/schema/JsonSchemaDaoImpl.java", "diffHunk": "@@ -450,4 +483,66 @@ public int getBatchSize() {\n \t\t\t\t\t}\n \t\t\t\t});\n \t}\n+\n+\tList<DBOJsonSchemaDependency> getDependencies(String versionId) {\n+\t\tValidateArgument.required(versionId, \"versionId\");\n+\t\treturn jdbcTemplate.query(\"SELECT * FROM \" + TABLE_JSON_SCHEMA_DEPENDENCY + \" WHERE \"\n+\t\t\t\t+ COL_JSON_SCHEMA_DEPENDENCY_VERSION_ID + \" = ?\", DEPENDENCY_MAPPER, versionId);\n+\t}\n+\n+\t@WriteTransaction\n+\t@Override\n+\tpublic JsonSchemaObjectBinding bindSchemaToObject(BindSchemaRequest request) {\n+\t\tValidateArgument.required(request, \"request\");\n+\t\tValidateArgument.required(request.getSchemaId(), \"request.schemaId\");\n+\t\tValidateArgument.required(request.getObjectId(), \"request.objectId\");\n+\t\tValidateArgument.required(request.getObjectType(), \"request.objectType\");\n+\t\tValidateArgument.required(request.getCreatedBy(), \"request.createdBy\");\n+\t\t// remove any existing binding.\n+\t\tjdbcTemplate.update(\n+\t\t\t\t\"DELETE FROM \" + TABLE_JSON_SCHEMA_OBJECT_BINDING + \" WHERE \" + COL_JONS_SCHEMA_BINDING_OBJECT_ID\n+\t\t\t\t\t\t+ \" = ? AND \" + COL_JSON_SCHEMA_BINDING_OBJECT_TYPE + \" = ?\",\n+\t\t\t\trequest.getObjectId(), request.getObjectType().name());\n+\n+\t\tTimestamp now = new Timestamp(System.currentTimeMillis());\n+\t\tlong bindId = idGenerator.generateNewId(IdType.JSON_SCHEMA_BIND_OBJECT_ID);\n+\t\tjdbcTemplate.update(\n+\t\t\t\t\"INSERT INTO \" + TABLE_JSON_SCHEMA_OBJECT_BINDING + \"(\" + COL_JSON_SCHEMA_BINDING_BIND_ID + \",\"\n+\t\t\t\t\t\t+ COL_JSON_SCHEMA_BINDING_SCHEMA_ID + \",\" + COL_JSON_SCHEMA_BINDING_VERSION_ID + \",\"\n+\t\t\t\t\t\t+ COL_JONS_SCHEMA_BINDING_OBJECT_ID + \",\" + COL_JSON_SCHEMA_BINDING_OBJECT_TYPE + \",\"\n+\t\t\t\t\t\t+ COL_JSON_SCHEMA_BINDING_CREATED_BY + \",\" + COL_JSON_SCHEMA_BINDING_CREATED_ON\n+\t\t\t\t\t\t+ \") VALUES (?,?,?,?,?,?,?)\",\n+\t\t\t\tbindId, request.getSchemaId(), request.getVersionId(), request.getObjectId(),\n+\t\t\t\trequest.getObjectType().name(), request.getCreatedBy(), now);\n+\t\treturn getSchemaBindingForObject(request.getObjectId(), request.getObjectType());\n+\t}\n+\n+\t@Override\n+\tpublic JsonSchemaObjectBinding getSchemaBindingForObject(Long objectId, BoundObjectType objecType) {\n+\t\tValidateArgument.required(objectId, \"objectId\");\n+\t\tValidateArgument.required(objecType, \"objecType\");\n+\t\ttry {\n+\t\t\tDBOJsonSchemaBindObject dbo = jdbcTemplate.queryForObject(\n+\t\t\t\t\t\"SELECT * FROM \" + TABLE_JSON_SCHEMA_OBJECT_BINDING + \" WHERE \" + COL_JONS_SCHEMA_BINDING_OBJECT_ID\n+\t\t\t\t\t\t\t+ \" = ? AND \" + COL_JSON_SCHEMA_BINDING_OBJECT_TYPE + \" = ?\",\n+\t\t\t\t\tBIND_OBJECT_MAPPER, objectId, objecType.name());\n+\t\t\tString versionId = null;\n+\t\t\tif (dbo.getVersionId() == null) {\n+\t\t\t\tversionId = getLatestVersionId(dbo.getSchemaId().toString());\n+\t\t\t} else {\n+\t\t\t\tversionId = dbo.getVersionId().toString();\n+\t\t\t}\n+\t\t\tJsonSchemaVersionInfo versionInfo = getVersionInfo(versionId.toString());", "originalCommit": "93b5f236f208ce392bf1b7e9c0a9580bf82dfa60", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE4MTc5NQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4064#discussion_r432181795", "bodyText": "You can remove this (tested elsewhere)", "author": "marcomarasca", "createdAt": "2020-05-28T23:41:00Z", "path": "lib/jdomodels/src/test/java/org/sagebionetworks/repo/model/dbo/schema/JsonSchemaDaoImplTest.java", "diffHunk": "@@ -1085,8 +1122,13 @@ public void testBindDependenciesWithVersions() throws JSONObjectAdapterException\n \t\t\t\t.withDependsOnVersionId(one.getVersionId()));\n \t\tdependencies.add(new SchemaDependency().withDependsOnSchemaId(two.getSchemaId())\n \t\t\t\t.withDependsOnVersionId(two.getVersionId()));\n+\t\t// call under test\n \t\tJsonSchemaVersionInfo three = createNewSchemaVersion(\"my.org.edu/three/1.0.0\", index++, dependencies);\n \n+\t\tList<DBOJsonSchemaDependency> dependencyResults = jsonSchemaDao.getDependencies(three.getVersionId());", "originalCommit": "93b5f236f208ce392bf1b7e9c0a9580bf82dfa60", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}