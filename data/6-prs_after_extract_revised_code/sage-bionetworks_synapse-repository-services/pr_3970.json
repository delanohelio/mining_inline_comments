{"pr_number": 3970, "pr_title": "PLFM-5908: Allows to disable certification requirement for project", "pr_createdAt": "2020-03-12T19:13:53Z", "pr_url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3970", "timeline": [{"oid": "11adc92aaa35a784622cecf1fbb93016f91854d2", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/11adc92aaa35a784622cecf1fbb93016f91854d2", "message": "PLFM-5908: Added new ProjectCertificationSetting", "committedDate": "2020-03-11T19:45:43Z", "type": "commit"}, {"oid": "2c99aaef911d19e286086d1f7cdd1a187d8bd798", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/2c99aaef911d19e286086d1f7cdd1a187d8bd798", "message": "PLFM-5908: Check on ACT for enabling/disabling certification on project", "committedDate": "2020-03-11T20:47:38Z", "type": "commit"}, {"oid": "2edac53cda1f1d977a6478c15e12509c24b50127", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/2edac53cda1f1d977a6478c15e12509c24b50127", "message": "PLFM-5908: Auto-fill project setting type", "committedDate": "2020-03-11T23:17:46Z", "type": "commit"}, {"oid": "880efabc3ee5add11b86705895a8ce4bc5a42ebc", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/880efabc3ee5add11b86705895a8ce4bc5a42ebc", "message": "PLFM-5908: Add check on project certification requirement when evaluating permissions", "committedDate": "2020-03-12T00:25:08Z", "type": "commit"}, {"oid": "97974e0d019cb3dc833dcbeb72bebd1b6bda42d9", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/97974e0d019cb3dc833dcbeb72bebd1b6bda42d9", "message": "PLFM-5908: Removed dead code", "committedDate": "2020-03-12T00:53:15Z", "type": "commit"}, {"oid": "0bd9a28a9da12fc5443c9c38b79f517dd97b02be", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/0bd9a28a9da12fc5443c9c38b79f517dd97b02be", "message": "PLFM-5908: Add flag to the user entity permissions that indicates if the certification is required", "committedDate": "2020-03-12T02:19:14Z", "type": "commit"}, {"oid": "69e512b50a9480904ef4c39cbff0ae6cc7107cc6", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/69e512b50a9480904ef4c39cbff0ae6cc7107cc6", "message": "PLFM-5908: Additional testing", "committedDate": "2020-03-12T02:37:52Z", "type": "commit"}, {"oid": "9dc860733178d853e3fe30f09cfb91899a9dd899", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/9dc860733178d853e3fe30f09cfb91899a9dd899", "message": "PLFM-5908: Additional integration test", "committedDate": "2020-03-12T19:12:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk1ODU0NQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3970#discussion_r391958545", "bodyText": "If of the certified type then add the extra check but all other logic still applies.", "author": "john-hill", "createdAt": "2020-03-12T23:33:27Z", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/ProjectSettingsManagerImpl.java", "diffHunk": "@@ -111,19 +139,32 @@ public ProjectSetting createProjectSetting(UserInfo userInfo, ProjectSetting pro\n \n \t\t// make sure the project id is a project\n \t\tEntityType nodeType = nodeManager.getNodeType(userInfo, parentId);", "originalCommit": "9dc860733178d853e3fe30f09cfb91899a9dd899", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3f97c894975e53fae4e6d90d2fda958fa2352d9e", "chunk": "diff --git a/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/ProjectSettingsManagerImpl.java b/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/ProjectSettingsManagerImpl.java\nindex 4c01735006..3aa41b9340 100644\n--- a/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/ProjectSettingsManagerImpl.java\n+++ b/services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/ProjectSettingsManagerImpl.java\n\n@@ -147,15 +147,17 @@ public class ProjectSettingsManagerImpl implements ProjectSettingsManager {\n \t\t\t\tthrow new IllegalArgumentException(\"The certification setting can be applied only to projects\");\n \t\t\t}\n \t\t\tvalidateACTAccessForCertificationSetting(userInfo);\n-\t\t} else {\n-\t\t\tif (nodeClass != Project.class && nodeClass != Folder.class) {\n-\t\t\t\tthrow new IllegalArgumentException(\"The id is not the id of a project or folder entity\");\n-\t\t\t}\n-\t\t\tif (!authorizationManager.canAccess(userInfo, parentId, ObjectType.ENTITY, ACCESS_TYPE.CREATE).isAuthorized()) {\n-\t\t\t\tthrow new UnauthorizedException(\"Cannot create settings for this project\");\n-\t\t\t}\n \t\t}\n \t\t\n+\t\tif (nodeClass != Project.class && nodeClass != Folder.class) {\n+\t\t\tthrow new IllegalArgumentException(\"The id is not the id of a project or folder entity\");\n+\t\t}\n+\t\t\n+\t\tif (!authorizationManager.canAccess(userInfo, parentId, ObjectType.ENTITY, ACCESS_TYPE.CREATE).isAuthorized()) {\n+\t\t\tthrow new UnauthorizedException(\"Cannot create settings for this project\");\n+\t\t}\n+\t\n+\t\t\n \t\t// Can't create project settings if a parent has an StsStorageLocation.\n \t\tOptional<ProjectSetting> parentSetting = getProjectSettingForNode(userInfo, parentId, ProjectSettingsType.upload,\n \t\t\t\tProjectSetting.class);\n"}}, {"oid": "3f97c894975e53fae4e6d90d2fda958fa2352d9e", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/3f97c894975e53fae4e6d90d2fda958fa2352d9e", "message": "PLFM-5908: Remove branching for ACT condition check", "committedDate": "2020-03-13T00:11:06Z", "type": "commit"}]}