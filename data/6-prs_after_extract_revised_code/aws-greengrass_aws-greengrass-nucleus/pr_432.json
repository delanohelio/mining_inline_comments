{"pr_number": 432, "pr_title": "Lots and lots and lots of test fixes (See description)", "pr_createdAt": "2020-09-11T18:25:37Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/432", "timeline": [{"oid": "e92c83383e6b9f1256e059c4a45bfcab6885a387", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e92c83383e6b9f1256e059c4a45bfcab6885a387", "message": "Debug test run", "committedDate": "2020-09-11T18:28:51Z", "type": "forcePushed"}, {"oid": "25a50750c8c9508efdd68e169b8114c4b2e73714", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/25a50750c8c9508efdd68e169b8114c4b2e73714", "message": "Debug test run", "committedDate": "2020-09-11T18:35:00Z", "type": "forcePushed"}, {"oid": "7719031671eaac7f9616fe22dadaa900c1efc497", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7719031671eaac7f9616fe22dadaa900c1efc497", "message": "Debug test run", "committedDate": "2020-09-11T18:36:39Z", "type": "forcePushed"}, {"oid": "385e997c9f2a47b38039151b8760a567a5e10747", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/385e997c9f2a47b38039151b8760a567a5e10747", "message": "Debug test run", "committedDate": "2020-09-11T18:40:44Z", "type": "forcePushed"}, {"oid": "653aa3ead68d6ca90f4e8b4e0e0a31fd6961db56", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/653aa3ead68d6ca90f4e8b4e0e0a31fd6961db56", "message": "Cleanup threads in tests", "committedDate": "2020-09-11T21:25:11Z", "type": "forcePushed"}, {"oid": "9521ad8d05861f99145ece958bdbb7492e4bed00", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9521ad8d05861f99145ece958bdbb7492e4bed00", "message": "Cleanup threads in tests", "committedDate": "2020-09-11T21:28:19Z", "type": "commit"}, {"oid": "9521ad8d05861f99145ece958bdbb7492e4bed00", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9521ad8d05861f99145ece958bdbb7492e4bed00", "message": "Cleanup threads in tests", "committedDate": "2020-09-11T21:28:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzMyNDgyNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/432#discussion_r487324824", "bodyText": "Add a comment to explain why we filter that one out.", "author": "abanthiy", "createdAt": "2020-09-11T22:56:55Z", "path": "src/test/java/com/aws/iot/evergreen/testcommons/testutilities/ThreadProtector.java", "diffHunk": "@@ -27,19 +27,29 @@\n \n     @Override\n     public void afterAll(ExtensionContext context) throws Exception {\n-        Set<Thread> threadSet = Thread.getAllStackTraces().keySet();\n-        List<String> liveThreads =\n-                threadSet.stream()\n-                        .filter(Thread::isAlive)\n-                        .filter(t -> t.getThreadGroup() != null && \"main\".equals(t.getThreadGroup().getName()))\n-                        .map(Thread::getName)\n-                        .filter(Objects::nonNull)\n-                        .filter(name -> !ALLOWED_THREAD_NAMES.contains(name))\n-                        .collect(Collectors.toList());\n+        List<Thread> liveThreads = getThreads();\n         if (!liveThreads.isEmpty()) {\n-            // Don't fail tests right now. Too many things would break.\n-            // fail(\"Threads are still running: \" + liveThreads);\n             System.err.println(\"Threads are still running: \" + liveThreads);\n+\n+            /*\n+            // Wait, then try again and see if they're still running\n+            Thread.sleep(2000);\n+            liveThreads = getThreads();\n+            if (!liveThreads.isEmpty()) {\n+                fail(\"Threads are still running: \" + liveThreads);\n+            }\n+             */\n         }\n     }\n+\n+    private List<Thread> getThreads() {\n+        Set<Thread> threadSet = Thread.getAllStackTraces().keySet();\n+        return threadSet.stream()\n+                .filter(Thread::isAlive)\n+                .filter(t -> t.getThreadGroup() != null && \"main\".equals(t.getThreadGroup().getName()))\n+                .filter(t -> Objects.nonNull(t.getName()))\n+                .filter(t -> !ALLOWED_THREAD_NAMES.contains(t.getName()))\n+                .filter(t -> !t.getName().contains(\"globalEventExecutor\"))", "originalCommit": "9521ad8d05861f99145ece958bdbb7492e4bed00", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8afb81e566b21be95e0124b5c40bdda722e0aa54", "chunk": "diff --git a/src/test/java/com/aws/iot/evergreen/testcommons/testutilities/ThreadProtector.java b/src/test/java/com/aws/iot/evergreen/testcommons/testutilities/ThreadProtector.java\nindex 911c0d519..bd2896012 100644\n--- a/src/test/java/com/aws/iot/evergreen/testcommons/testutilities/ThreadProtector.java\n+++ b/src/test/java/com/aws/iot/evergreen/testcommons/testutilities/ThreadProtector.java\n\n@@ -49,6 +49,8 @@ public class ThreadProtector implements AfterAllCallback {\n                 .filter(t -> t.getThreadGroup() != null && \"main\".equals(t.getThreadGroup().getName()))\n                 .filter(t -> Objects.nonNull(t.getName()))\n                 .filter(t -> !ALLOWED_THREAD_NAMES.contains(t.getName()))\n+                // This executor is used by Netty and it will shutdown, it just shutsdown a bit slowly, so\n+                // that's why we will ignore it here\n                 .filter(t -> !t.getName().contains(\"globalEventExecutor\"))\n                 .collect(Collectors.toList());\n     }\n"}}, {"oid": "8afb81e566b21be95e0124b5c40bdda722e0aa54", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8afb81e566b21be95e0124b5c40bdda722e0aa54", "message": "Update bootstrap test to not take 2 minutes", "committedDate": "2020-09-11T23:02:27Z", "type": "commit"}, {"oid": "5dc45465a3a955050b482666f749663645ff76a4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5dc45465a3a955050b482666f749663645ff76a4", "message": "Flip endpoints", "committedDate": "2020-09-11T23:37:44Z", "type": "commit"}, {"oid": "5dc45465a3a955050b482666f749663645ff76a4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5dc45465a3a955050b482666f749663645ff76a4", "message": "Flip endpoints", "committedDate": "2020-09-11T23:37:44Z", "type": "forcePushed"}, {"oid": "652a2f5cd98c51512b3248c44c75de69c8b323ae", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/652a2f5cd98c51512b3248c44c75de69c8b323ae", "message": "Disable broken test", "committedDate": "2020-09-12T00:15:06Z", "type": "commit"}, {"oid": "652a2f5cd98c51512b3248c44c75de69c8b323ae", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/652a2f5cd98c51512b3248c44c75de69c8b323ae", "message": "Disable broken test", "committedDate": "2020-09-12T00:15:06Z", "type": "forcePushed"}, {"oid": "a574b11c6411895e58a91694ba1827d9df3a8315", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a574b11c6411895e58a91694ba1827d9df3a8315", "message": "Generic external service safer shutdown when interrupted", "committedDate": "2020-09-12T03:40:23Z", "type": "commit"}, {"oid": "a574b11c6411895e58a91694ba1827d9df3a8315", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a574b11c6411895e58a91694ba1827d9df3a8315", "message": "Generic external service safer shutdown when interrupted", "committedDate": "2020-09-12T03:40:23Z", "type": "forcePushed"}, {"oid": "c0d2f58ab0f673d77bb2d7a6c97ef57e24d54bcc", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c0d2f58ab0f673d77bb2d7a6c97ef57e24d54bcc", "message": "Fix E2E tests with updated client", "committedDate": "2020-09-12T05:41:40Z", "type": "forcePushed"}, {"oid": "feff173dbef397084325f5ae8d0b2066cfddc1cc", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/feff173dbef397084325f5ae8d0b2066cfddc1cc", "message": "Fix E2E tests with updated client", "committedDate": "2020-09-12T05:49:24Z", "type": "commit"}, {"oid": "feff173dbef397084325f5ae8d0b2066cfddc1cc", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/feff173dbef397084325f5ae8d0b2066cfddc1cc", "message": "Fix E2E tests with updated client", "committedDate": "2020-09-12T05:49:24Z", "type": "forcePushed"}]}