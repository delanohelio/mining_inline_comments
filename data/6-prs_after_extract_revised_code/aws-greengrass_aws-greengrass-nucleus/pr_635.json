{"pr_number": 635, "pr_title": "add configurable time out", "pr_createdAt": "2020-11-06T22:34:08Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/635", "timeline": [{"oid": "aaa2bbd8c6e66db35eab1d0c32e6797e4977b3e6", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/aaa2bbd8c6e66db35eab1d0c32e6797e4977b3e6", "message": "add configurable time out", "committedDate": "2020-11-06T22:32:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA0Mzc2NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/635#discussion_r519043764", "bodyText": "This is not the right timeout, it's set as configurationValidationPolicy  in deployment document - https://code.amazon.com/packages/EvergreenComponentCommon/blobs/86f6c302e2c5bc4b06fe1cf5e44298876ace8e5f/--/src/test/resources/configurations/configuration-1-component-replace.json#L36 . Needs to be extracted into a new field similar to the componentUpdatePolicy here https://github.com/aws/aws-greengrass-nucleus/blob/master/src/main/java/com/aws/greengrass/deployment/model/DeploymentDocument.java#L57 but it's not the same as componentUpdatePolicy", "author": "shaguptashaikh", "createdAt": "2020-11-06T22:50:06Z", "path": "src/main/java/com/aws/greengrass/deployment/DynamicComponentConfigurationValidator.java", "diffHunk": "@@ -160,8 +159,11 @@ private boolean willNodeChange(Object proposedConfig, Node currentConfig, long p\n                         .deepEquals(proposedConfig, currentConfig.toPOJO());\n     }\n \n-    private boolean validateOverIpc(String deploymentId, Set<ComponentToValidate> componentsToValidate,\n+    private boolean validateOverIpc(Deployment deployment, Set<ComponentToValidate> componentsToValidate,\n                                     CompletableFuture<DeploymentResult> deploymentResultFuture) {\n+        String deploymentId = deployment.getId();\n+        Integer timeOutSec = deployment.getDeploymentDocumentObj().getComponentUpdatePolicy().getTimeout();", "originalCommit": "aaa2bbd8c6e66db35eab1d0c32e6797e4977b3e6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "434b0b6b507dd42cc2a9ae04881d719b3f5001ec", "chunk": "diff --git a/src/main/java/com/aws/greengrass/deployment/DynamicComponentConfigurationValidator.java b/src/main/java/com/aws/greengrass/deployment/DynamicComponentConfigurationValidator.java\nindex b316a678b..60b00fece 100644\n--- a/src/main/java/com/aws/greengrass/deployment/DynamicComponentConfigurationValidator.java\n+++ b/src/main/java/com/aws/greengrass/deployment/DynamicComponentConfigurationValidator.java\n\n@@ -162,7 +162,7 @@ public class DynamicComponentConfigurationValidator {\n     private boolean validateOverIpc(Deployment deployment, Set<ComponentToValidate> componentsToValidate,\n                                     CompletableFuture<DeploymentResult> deploymentResultFuture) {\n         String deploymentId = deployment.getId();\n-        Integer timeOutSec = deployment.getDeploymentDocumentObj().getComponentUpdatePolicy().getTimeout();\n+        Integer timeOutSec = deployment.getDeploymentDocumentObj().getConfigurationValidationPolicy().getTimeout();\n         Long timeOutMs = Duration.ofSeconds(timeOutSec).toMillis();\n         try {\n             String failureMsg = null;\n"}}, {"oid": "434b0b6b507dd42cc2a9ae04881d719b3f5001ec", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/434b0b6b507dd42cc2a9ae04881d719b3f5001ec", "message": "add configurationValidationPolicy to the DeploymentDocumentation", "committedDate": "2020-11-07T01:02:55Z", "type": "commit"}, {"oid": "baac7f2bb2e080b0ccb5f354c8b8eaa79a0865a4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/baac7f2bb2e080b0ccb5f354c8b8eaa79a0865a4", "message": "Merge branch 'master' into configurable-depoloyment-document", "committedDate": "2020-11-07T01:11:37Z", "type": "commit"}, {"oid": "7f49134b98f856810db107825ee49f8caea13269", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7f49134b98f856810db107825ee49f8caea13269", "message": "Merge branch 'master' into configurable-depoloyment-document", "committedDate": "2020-11-09T18:36:55Z", "type": "commit"}, {"oid": "973102e335da37dc03224957585cc170fc0572be", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/973102e335da37dc03224957585cc170fc0572be", "message": "fix the failure in the integration test", "committedDate": "2020-11-09T21:13:46Z", "type": "commit"}, {"oid": "8e2154d7d898130b8271df27d35d79c24eca674b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8e2154d7d898130b8271df27d35d79c24eca674b", "message": "Merge branch 'configurable-depoloyment-document' of ssh://github.com/aws/aws-greengrass-kernel into configurable-depoloyment-document", "committedDate": "2020-11-09T21:13:57Z", "type": "commit"}, {"oid": "87115bc756bb94860c0abdfaeeb6c537a58b975d", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/87115bc756bb94860c0abdfaeeb6c537a58b975d", "message": "Merge branch 'master' into configurable-depoloyment-document", "committedDate": "2020-11-09T21:15:03Z", "type": "commit"}, {"oid": "2017b6e1ed190e3afedb3bdf134351f11a7dc2e7", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2017b6e1ed190e3afedb3bdf134351f11a7dc2e7", "message": "fix the benchMark", "committedDate": "2020-11-09T21:47:03Z", "type": "commit"}, {"oid": "c279e585004b7cea25ce9d6babc81aff3c924e10", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c279e585004b7cea25ce9d6babc81aff3c924e10", "message": "Merge branch 'configurable-depoloyment-document' of ssh://github.com/aws/aws-greengrass-kernel into configurable-depoloyment-document", "committedDate": "2020-11-09T21:47:25Z", "type": "commit"}, {"oid": "9f0513d0de73d0b529aea90071e0fb248adbc781", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9f0513d0de73d0b529aea90071e0fb248adbc781", "message": "add import for com.amazonaws.services.evergreen.model.ConfigurationValidationPolicy", "committedDate": "2020-11-09T22:20:40Z", "type": "commit"}, {"oid": "593421ed3e4353a9ecd0d8867b116f2bfed763f3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/593421ed3e4353a9ecd0d8867b116f2bfed763f3", "message": "Merge branch 'master' into configurable-depoloyment-document", "committedDate": "2020-11-09T23:48:55Z", "type": "commit"}, {"oid": "f251c4035736a82ebaa1272ab3172d6932b7cd71", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f251c4035736a82ebaa1272ab3172d6932b7cd71", "message": "Merge branch 'master' into configurable-depoloyment-document", "committedDate": "2020-11-10T00:09:31Z", "type": "commit"}, {"oid": "2427cece998d09d5e4be3e49792b3979f3af94c0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2427cece998d09d5e4be3e49792b3979f3af94c0", "message": "resolve the conflict with master", "committedDate": "2020-11-10T00:18:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI1MTg5Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/635#discussion_r520251897", "bodyText": "protect against nulls here", "author": "MikeDombo", "createdAt": "2020-11-10T02:48:45Z", "path": "src/main/java/com/aws/greengrass/deployment/DynamicComponentConfigurationValidator.java", "diffHunk": "@@ -156,8 +155,11 @@ private boolean willNodeChange(Object proposedConfig, Node currentConfig, long p\n                         .deepEquals(proposedConfig, currentConfig.toPOJO());\n     }\n \n-    private boolean validateOverIpc(String deploymentId, Set<ComponentToValidate> componentsToValidate,\n+    private boolean validateOverIpc(Deployment deployment, Set<ComponentToValidate> componentsToValidate,\n                                     CompletableFuture<DeploymentResult> deploymentResultFuture) {\n+        String deploymentId = deployment.getId();\n+        Integer timeoutSec = deployment.getDeploymentDocumentObj().getConfigurationValidationPolicy().getTimeout();\n+        Long timeoutMs = Duration.ofSeconds(timeoutSec).toMillis();", "originalCommit": "2427cece998d09d5e4be3e49792b3979f3af94c0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "daaa9ab994f8d05d6444c049cd773e9ae51d54d2", "chunk": "diff --git a/src/main/java/com/aws/greengrass/deployment/DynamicComponentConfigurationValidator.java b/src/main/java/com/aws/greengrass/deployment/DynamicComponentConfigurationValidator.java\nindex 7b635430b..4630f8fd3 100644\n--- a/src/main/java/com/aws/greengrass/deployment/DynamicComponentConfigurationValidator.java\n+++ b/src/main/java/com/aws/greengrass/deployment/DynamicComponentConfigurationValidator.java\n\n@@ -159,7 +160,10 @@ public class DynamicComponentConfigurationValidator {\n                                     CompletableFuture<DeploymentResult> deploymentResultFuture) {\n         String deploymentId = deployment.getId();\n         Integer timeoutSec = deployment.getDeploymentDocumentObj().getConfigurationValidationPolicy().getTimeout();\n-        Long timeoutMs = Duration.ofSeconds(timeoutSec).toMillis();\n+        Long timeoutMs = Duration.ofSeconds(DEFAULT_TIMEOUT_SEC).toMillis();\n+        if (timeoutSec != null) {\n+            timeoutMs = Duration.ofSeconds(timeoutSec).toMillis();\n+        }\n         try {\n             String failureMsg = null;\n             boolean validationRequested = false;\n"}}, {"oid": "daaa9ab994f8d05d6444c049cd773e9ae51d54d2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/daaa9ab994f8d05d6444c049cd773e9ae51d54d2", "message": "check whether getConfigurationValidationPolicy.getTimeout is null", "committedDate": "2020-11-10T02:49:12Z", "type": "commit"}, {"oid": "68fe3c4762b1f592070798dc1e6a859bd639cab0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/68fe3c4762b1f592070798dc1e6a859bd639cab0", "message": "rollback the change on the deploymentDocument json file", "committedDate": "2020-11-10T03:13:25Z", "type": "commit"}, {"oid": "21347f0157e5312077c5f344fbc59d3ea02525b3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/21347f0157e5312077c5f344fbc59d3ea02525b3", "message": "resolve the conflict", "committedDate": "2020-11-10T03:29:04Z", "type": "commit"}, {"oid": "675cfe8998c8246844e40519ec9903a65d6780c8", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/675cfe8998c8246844e40519ec9903a65d6780c8", "message": "Merge branch 'master' into configurable-depoloyment-document", "committedDate": "2020-11-10T05:30:31Z", "type": "commit"}, {"oid": "ca4cd993a94e49d40eed7cdec0142a94f072a90f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ca4cd993a94e49d40eed7cdec0142a94f072a90f", "message": "Merge branch 'master' into configurable-depoloyment-document", "committedDate": "2020-11-10T20:12:40Z", "type": "commit"}, {"oid": "9cc943892c2dad61c5d1afc3cd5c5d2ac0bf8635", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9cc943892c2dad61c5d1afc3cd5c5d2ac0bf8635", "message": "resovle conflict", "committedDate": "2020-11-10T20:20:51Z", "type": "commit"}, {"oid": "f489a54c81ae0db348d0cfb0109f752359d363a5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f489a54c81ae0db348d0cfb0109f752359d363a5", "message": "Merge branch 'master' into configurable-depoloyment-document", "committedDate": "2020-11-11T01:04:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAyMjA5Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/635#discussion_r521022096", "bodyText": "Nit - could reuse the constant from DynamicComponentConfigurationValidator.java", "author": "shaguptashaikh", "createdAt": "2020-11-11T02:07:57Z", "path": "src/main/java/com/aws/greengrass/deployment/converter/DeploymentDocumentConverter.java", "diffHunk": "@@ -44,6 +45,7 @@\n \n     public static final String LOCAL_DEPLOYMENT_GROUP_NAME = \"LOCAL_DEPLOYMENT\";\n     public static final Integer NO_OP_TIMEOUT = 0;\n+    private static final  Integer DEFAULT_TIMEOUT_SECOND = 20;", "originalCommit": "f489a54c81ae0db348d0cfb0109f752359d363a5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3897acc54b1276abdda0d3b2eaaf3e3665ea3362", "chunk": "diff --git a/src/main/java/com/aws/greengrass/deployment/converter/DeploymentDocumentConverter.java b/src/main/java/com/aws/greengrass/deployment/converter/DeploymentDocumentConverter.java\nindex e5a4ba04d..7db4d21df 100644\n--- a/src/main/java/com/aws/greengrass/deployment/converter/DeploymentDocumentConverter.java\n+++ b/src/main/java/com/aws/greengrass/deployment/converter/DeploymentDocumentConverter.java\n\n@@ -39,13 +39,13 @@ import javax.annotation.Nonnull;\n import javax.annotation.Nullable;\n \n import static com.amazonaws.services.evergreen.model.ComponentUpdatePolicyAction.SKIP_NOTIFY_COMPONENTS;\n+import static com.aws.greengrass.deployment.DynamicComponentConfigurationValidator.DEFAULT_TIMEOUT_SECOND;\n \n public final class DeploymentDocumentConverter {\n     private static final Logger logger = LogManager.getLogger(DeploymentDocumentConverter.class);\n \n     public static final String LOCAL_DEPLOYMENT_GROUP_NAME = \"LOCAL_DEPLOYMENT\";\n     public static final Integer NO_OP_TIMEOUT = 0;\n-    private static final  Integer DEFAULT_TIMEOUT_SECOND = 20;\n \n     public static final String ANY_VERSION = \"*\";\n \n"}}, {"oid": "3897acc54b1276abdda0d3b2eaaf3e3665ea3362", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3897acc54b1276abdda0d3b2eaaf3e3665ea3362", "message": "reuse parameter", "committedDate": "2020-11-11T02:33:28Z", "type": "commit"}, {"oid": "c91b68d2dbbc31769d5a1603f42d527df810e312", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c91b68d2dbbc31769d5a1603f42d527df810e312", "message": "Merge branch 'master' into configurable-depoloyment-document", "committedDate": "2020-11-11T02:36:15Z", "type": "commit"}, {"oid": "a71ecc1cc863994647f10c0e25392d9f720820fc", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a71ecc1cc863994647f10c0e25392d9f720820fc", "message": "Merge branch 'master' into configurable-depoloyment-document", "committedDate": "2020-11-11T06:01:23Z", "type": "commit"}]}