{"pr_number": 806, "pr_title": "fix(provision): load Nucleus recipe from build file to component store and config store", "pr_createdAt": "2020-12-30T00:56:19Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/806", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDMwMzE1NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/806#discussion_r550303154", "bodyText": "So we're moving this line in nucleus bootstrap script: echo \"{configuration:/jvmOptions}\" > \"$KERNEL_ROOT/alts/current/launch.params\"\nto here. Nice!", "author": "tilo-chen", "createdAt": "2020-12-30T19:28:31Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/Kernel.java", "diffHunk": "@@ -603,15 +612,64 @@ public Kernel parseArgs(String... args) {\n         }\n \n         // Update device configuration from commandline arguments after loading config files\n-        kernelCommandLine.updateDeviceConfiguration(getContext().get(DeviceConfiguration.class));\n+        DeviceConfiguration deviceConfiguration = getContext().get(DeviceConfiguration.class);\n+        kernelCommandLine.updateDeviceConfiguration(deviceConfiguration);\n+        // After configuration is fully loaded, initialize Nucleus service config\n+        initializeNucleusServiceConfigIfNotExist(kernelAlts, deviceConfiguration);\n+\n         setupProxy();\n+\n         return this;\n     }\n \n     private void setupProxy() {\n         ProxyUtils.setProxyProperties(context.get(DeviceConfiguration.class));\n     }\n \n+    private void initializeNucleusServiceConfigIfNotExist(KernelAlternatives kernelAlternatives,\n+                                                          DeviceConfiguration deviceConfiguration) {\n+        Topics nucleusLifecycle = getConfig().lookupTopics(DEFAULT_VALUE_TIMESTAMP, SERVICES_NAMESPACE_TOPIC,\n+                deviceConfiguration.getNucleusComponentName(), SERVICE_LIFECYCLE_NAMESPACE_TOPIC);\n+        if (nucleusLifecycle.children.size() != 0) {\n+            logger.atDebug().log(\"Nucleus lifecycle has already been initialized\");\n+            return;\n+        }\n+\n+        // Persist initial Nucleus launch parameters", "originalCommit": "2d615938828a83bddf69e05f8304b97932cee2ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDYwODEzMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/806#discussion_r550608131", "bodyText": "Yeah. The bootstrap script only gets to run in deployments. Here in provisioning I need to set it up explicitly", "author": "hui-yang", "createdAt": "2020-12-31T18:03:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDMwMzE1NA=="}], "type": "inlineReview", "revised_code": {"commit": "f42a991067a57dafb37d73aec30b75f86ce6a449", "chunk": "diff --git a/src/main/java/com/aws/greengrass/lifecyclemanager/Kernel.java b/src/main/java/com/aws/greengrass/lifecyclemanager/Kernel.java\nindex a1b91c9f0..d059a432b 100644\n--- a/src/main/java/com/aws/greengrass/lifecyclemanager/Kernel.java\n+++ b/src/main/java/com/aws/greengrass/lifecyclemanager/Kernel.java\n\n@@ -615,7 +607,7 @@ public class Kernel {\n         DeviceConfiguration deviceConfiguration = getContext().get(DeviceConfiguration.class);\n         kernelCommandLine.updateDeviceConfiguration(deviceConfiguration);\n         // After configuration is fully loaded, initialize Nucleus service config\n-        initializeNucleusServiceConfigIfNotExist(kernelAlts, deviceConfiguration);\n+        deviceConfiguration.initializedNucleusFromRecipe(kernelAlts);\n \n         setupProxy();\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDMwNTUwMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/806#discussion_r550305500", "bodyText": "Hmm why exclude -Droot?", "author": "tilo-chen", "createdAt": "2020-12-30T19:37:03Z", "path": "src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java", "diffHunk": "@@ -349,6 +354,17 @@ public Topic getRootCAFilePath() {\n                 .addValidator(deTildeValidator);\n     }\n \n+    /**\n+     * Get JVM options. Default to current JVM options input.\n+     *\n+     * @return JVM options config topic\n+     */\n+    public Topic getJvmOptions() {\n+        String jvmOptions = ManagementFactory.getRuntimeMXBean().getInputArguments().stream().sorted()\n+                .filter(s -> !s.startsWith(JVM_OPTION_ROOT_PATH)).collect(Collectors.joining(\" \"));", "originalCommit": "2d615938828a83bddf69e05f8304b97932cee2ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDYxMDUxNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/806#discussion_r550610514", "bodyText": "The loader script will pass in -Droot https://github.com/aws-greengrass/aws-greengrass-nucleus/blob/main/scripts/loader#L27\nThe Nucleus root path won't be changed even if customers configure it in jvmOptions via deployments", "author": "hui-yang", "createdAt": "2020-12-31T18:06:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDMwNTUwMA=="}], "type": "inlineReview", "revised_code": {"commit": "f42a991067a57dafb37d73aec30b75f86ce6a449", "chunk": "diff --git a/src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java b/src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java\nindex 43d6931e3..122390e91 100644\n--- a/src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java\n+++ b/src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java\n\n@@ -354,17 +454,6 @@ public class DeviceConfiguration {\n                 .addValidator(deTildeValidator);\n     }\n \n-    /**\n-     * Get JVM options. Default to current JVM options input.\n-     *\n-     * @return JVM options config topic\n-     */\n-    public Topic getJvmOptions() {\n-        String jvmOptions = ManagementFactory.getRuntimeMXBean().getInputArguments().stream().sorted()\n-                .filter(s -> !s.startsWith(JVM_OPTION_ROOT_PATH)).collect(Collectors.joining(\" \"));\n-        return getTopic(DEVICE_PARAM_JVM_OPTIONS).dflt(jvmOptions);\n-    }\n-\n     public Topic getIotDataEndpoint() {\n         return getTopic(DEVICE_PARAM_IOT_DATA_ENDPOINT).dflt(\"\");\n     }\n"}}, {"oid": "ba2f814600da797cb2c5b2f5dac040e6ecf69f9c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ba2f814600da797cb2c5b2f5dac040e6ecf69f9c", "message": "fix(provision): load Nucleus recipe from build file to component store and config store", "committedDate": "2021-01-20T16:14:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjA4MjMzNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/806#discussion_r562082334", "bodyText": "After adding getting the recipe from the build file, will we still keep the properties file as well for version? or should the version now come from the recipe?", "author": "shaguptashaikh", "createdAt": "2021-01-21T17:53:53Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/Kernel.java", "diffHunk": "@@ -603,15 +612,64 @@ public Kernel parseArgs(String... args) {\n         }\n \n         // Update device configuration from commandline arguments after loading config files\n-        kernelCommandLine.updateDeviceConfiguration(getContext().get(DeviceConfiguration.class));\n+        DeviceConfiguration deviceConfiguration = getContext().get(DeviceConfiguration.class);\n+        kernelCommandLine.updateDeviceConfiguration(deviceConfiguration);\n+        // After configuration is fully loaded, initialize Nucleus service config\n+        initializeNucleusServiceConfigIfNotExist(kernelAlts, deviceConfiguration);\n+\n         setupProxy();\n+\n         return this;\n     }\n \n     private void setupProxy() {\n         ProxyUtils.setProxyProperties(context.get(DeviceConfiguration.class));\n     }\n \n+    private void initializeNucleusServiceConfigIfNotExist(KernelAlternatives kernelAlternatives,", "originalCommit": "ba2f814600da797cb2c5b2f5dac040e6ecf69f9c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjA4NTg4Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/806#discussion_r562085883", "bodyText": "Ideally properties file can be removed. Let me see if I can get the order of the events correct", "author": "hui-yang", "createdAt": "2021-01-21T17:58:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjA4MjMzNA=="}], "type": "inlineReview", "revised_code": {"commit": "f42a991067a57dafb37d73aec30b75f86ce6a449", "chunk": "diff --git a/src/main/java/com/aws/greengrass/lifecyclemanager/Kernel.java b/src/main/java/com/aws/greengrass/lifecyclemanager/Kernel.java\nindex a1b91c9f0..d059a432b 100644\n--- a/src/main/java/com/aws/greengrass/lifecyclemanager/Kernel.java\n+++ b/src/main/java/com/aws/greengrass/lifecyclemanager/Kernel.java\n\n@@ -615,7 +607,7 @@ public class Kernel {\n         DeviceConfiguration deviceConfiguration = getContext().get(DeviceConfiguration.class);\n         kernelCommandLine.updateDeviceConfiguration(deviceConfiguration);\n         // After configuration is fully loaded, initialize Nucleus service config\n-        initializeNucleusServiceConfigIfNotExist(kernelAlts, deviceConfiguration);\n+        deviceConfiguration.initializedNucleusFromRecipe(kernelAlts);\n \n         setupProxy();\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjA4NDQ0MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/806#discussion_r562084441", "bodyText": "There's some initialization logic in DeviceConfiguration.initializeNucleusComponentConfig() for initializing version and a few more things for the Nucleus component config, is there a way we can consolidate that with this here?", "author": "shaguptashaikh", "createdAt": "2021-01-21T17:56:52Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/Kernel.java", "diffHunk": "@@ -603,15 +612,64 @@ public Kernel parseArgs(String... args) {\n         }\n \n         // Update device configuration from commandline arguments after loading config files\n-        kernelCommandLine.updateDeviceConfiguration(getContext().get(DeviceConfiguration.class));\n+        DeviceConfiguration deviceConfiguration = getContext().get(DeviceConfiguration.class);\n+        kernelCommandLine.updateDeviceConfiguration(deviceConfiguration);\n+        // After configuration is fully loaded, initialize Nucleus service config\n+        initializeNucleusServiceConfigIfNotExist(kernelAlts, deviceConfiguration);", "originalCommit": "ba2f814600da797cb2c5b2f5dac040e6ecf69f9c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjA5Nzk5Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/806#discussion_r562097996", "bodyText": "I put it here because the interpolation should happen after all configs are loaded. Let me see if this can be optimized.", "author": "hui-yang", "createdAt": "2021-01-21T18:17:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjA4NDQ0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDAwMDA4NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/806#discussion_r564000084", "bodyText": "I did some experiments. initializeNucleusComponentConfig was called in DeviceConfiguration constructor. Since I introduced ComponentStore RecipeLoader etc here in the init, changes in initializeNucleusComponentConfig will cause circular dependency issues.\nI still kept the logic here for now", "author": "hui-yang", "createdAt": "2021-01-25T19:50:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjA4NDQ0MQ=="}], "type": "inlineReview", "revised_code": {"commit": "f42a991067a57dafb37d73aec30b75f86ce6a449", "chunk": "diff --git a/src/main/java/com/aws/greengrass/lifecyclemanager/Kernel.java b/src/main/java/com/aws/greengrass/lifecyclemanager/Kernel.java\nindex a1b91c9f0..d059a432b 100644\n--- a/src/main/java/com/aws/greengrass/lifecyclemanager/Kernel.java\n+++ b/src/main/java/com/aws/greengrass/lifecyclemanager/Kernel.java\n\n@@ -615,7 +607,7 @@ public class Kernel {\n         DeviceConfiguration deviceConfiguration = getContext().get(DeviceConfiguration.class);\n         kernelCommandLine.updateDeviceConfiguration(deviceConfiguration);\n         // After configuration is fully loaded, initialize Nucleus service config\n-        initializeNucleusServiceConfigIfNotExist(kernelAlts, deviceConfiguration);\n+        deviceConfiguration.initializedNucleusFromRecipe(kernelAlts);\n \n         setupProxy();\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjA4NjE1NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/806#discussion_r562086154", "bodyText": "Should we remove the default for the jvmOptions config from the Nucleus recipe now that the default it evaluated here?", "author": "shaguptashaikh", "createdAt": "2021-01-21T17:59:15Z", "path": "src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java", "diffHunk": "@@ -355,6 +360,17 @@ public Topic getRootCAFilePath() {\n                 .addValidator(deTildeValidator);\n     }\n \n+    /**\n+     * Get JVM options. Default to current JVM options input.\n+     *\n+     * @return JVM options config topic\n+     */\n+    public Topic getJvmOptions() {\n+        String jvmOptions = ManagementFactory.getRuntimeMXBean().getInputArguments().stream().sorted()\n+                .filter(s -> !s.startsWith(JVM_OPTION_ROOT_PATH)).collect(Collectors.joining(\" \"));\n+        return getTopic(DEVICE_PARAM_JVM_OPTIONS).dflt(jvmOptions);", "originalCommit": "ba2f814600da797cb2c5b2f5dac040e6ecf69f9c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzQyNTYyNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/806#discussion_r563425625", "bodyText": "Do you mean this should be removed instead of default to empty string? https://code.amazon.com/packages/GreengrassV2ComponentsReleaseCDK/blobs/47911fb22576071ee8ec09c7bf0eef3ef421ae35/--/lib/components/greengrass-nucleus.ts#L68", "author": "hui-yang", "createdAt": "2021-01-25T01:59:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjA4NjE1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mzk5ODczMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/806#discussion_r563998730", "bodyText": "I'm keep it in mind when updating the cdk", "author": "hui-yang", "createdAt": "2021-01-25T19:47:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjA4NjE1NA=="}], "type": "inlineReview", "revised_code": {"commit": "f42a991067a57dafb37d73aec30b75f86ce6a449", "chunk": "diff --git a/src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java b/src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java\nindex b1285183f..122390e91 100644\n--- a/src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java\n+++ b/src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java\n\n@@ -360,17 +454,6 @@ public class DeviceConfiguration {\n                 .addValidator(deTildeValidator);\n     }\n \n-    /**\n-     * Get JVM options. Default to current JVM options input.\n-     *\n-     * @return JVM options config topic\n-     */\n-    public Topic getJvmOptions() {\n-        String jvmOptions = ManagementFactory.getRuntimeMXBean().getInputArguments().stream().sorted()\n-                .filter(s -> !s.startsWith(JVM_OPTION_ROOT_PATH)).collect(Collectors.joining(\" \"));\n-        return getTopic(DEVICE_PARAM_JVM_OPTIONS).dflt(jvmOptions);\n-    }\n-\n     public Topic getIotDataEndpoint() {\n         return getTopic(DEVICE_PARAM_IOT_DATA_ENDPOINT).dflt(\"\");\n     }\n"}}, {"oid": "f42a991067a57dafb37d73aec30b75f86ce6a449", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f42a991067a57dafb37d73aec30b75f86ce6a449", "message": "Add recipe template", "committedDate": "2021-01-25T04:50:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzkzNTMyMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/806#discussion_r563935323", "bodyText": "remove.", "author": "MikeDombo", "createdAt": "2021-01-25T18:08:43Z", "path": "src/test/java/com/aws/greengrass/lifecyclemanager/LogManagerHelperTest.java", "diffHunk": "@@ -168,7 +167,7 @@ void GIVEN_null_logger_config_WHEN_subscribe_THEN_correctly_reconfigures_all_log\n         NucleusPaths nucleusPaths = mock(NucleusPaths.class);\n         Topics rootConfigTopics = mock(Topics.class);\n         when(rootConfigTopics.findOrDefault(any(), anyString(), anyString(), anyString())).thenReturn(new ArrayList<>());\n-        when(configuration.lookup(anyString(), anyString())).thenReturn(mock(Topic.class));\n+        //lenient().when(configuration.lookup(anyString(), anyString())).thenReturn(mock(Topic.class));", "originalCommit": "f42a991067a57dafb37d73aec30b75f86ce6a449", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5475557adf28e410df2661faae0eefdda487282c", "chunk": "diff --git a/src/test/java/com/aws/greengrass/lifecyclemanager/LogManagerHelperTest.java b/src/test/java/com/aws/greengrass/lifecyclemanager/LogManagerHelperTest.java\nindex 2145cdde8..baa9e5e8e 100644\n--- a/src/test/java/com/aws/greengrass/lifecyclemanager/LogManagerHelperTest.java\n+++ b/src/test/java/com/aws/greengrass/lifecyclemanager/LogManagerHelperTest.java\n\n@@ -167,7 +167,6 @@ class LogManagerHelperTest {\n         NucleusPaths nucleusPaths = mock(NucleusPaths.class);\n         Topics rootConfigTopics = mock(Topics.class);\n         when(rootConfigTopics.findOrDefault(any(), anyString(), anyString(), anyString())).thenReturn(new ArrayList<>());\n-        //lenient().when(configuration.lookup(anyString(), anyString())).thenReturn(mock(Topic.class));\n         when(configuration.lookup(anyString(), anyString(), anyString())).thenReturn(mock(Topic.class));\n         when(configuration.lookup(anyString(), anyString(), anyString(), anyString())).thenReturn(mock(Topic.class));\n         when(configuration.getRoot()).thenReturn(rootConfigTopics);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzkzNjU0MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/806#discussion_r563936541", "bodyText": "We need to modify the pipeline to write the version number into the recipe now instead of properties?", "author": "MikeDombo", "createdAt": "2021-01-25T18:10:40Z", "path": "src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java", "diffHunk": "@@ -506,22 +604,19 @@ public String getNucleusVersion() {\n      *\n      * @return version from the zip file, or a default if the version can't be determined\n      */\n-    public static String getVersionFromBuildMetadataFile() {\n+    public static String getVersionFromBuildRecipeFile() {\n         try {\n-            try (InputStream is = Files\n-                    .newInputStream(locateCurrentKernelUnpackDir().resolve(NUCLEUS_BUILD_METADATA_DIRECTORY)\n-                            .resolve(NUCLEUS_BUILD_METADATA_FILENAME))) {\n-                NUCLEUS_BUILD_PROPERTIES.load(is);\n-            }\n-\n-            String version = NUCLEUS_BUILD_PROPERTIES.getProperty(NUCLEUS_VERSION_BUILD_METADATA_KEY);\n-            if (version != null) {\n-                return version;\n+            com.amazon.aws.iot.greengrass.component.common.ComponentRecipe recipe = getRecipeSerializer()\n+                    .readValue(locateCurrentKernelUnpackDir().resolve(NUCLEUS_BUILD_METADATA_DIRECTORY)\n+                                    .resolve(NUCLEUS_RECIPE_FILENAME).toFile(),", "originalCommit": "f42a991067a57dafb37d73aec30b75f86ce6a449", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mzk5MzQ5OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/806#discussion_r563993499", "bodyText": "Yes. Two options\n\nUpdate version in recipe\nKeep build.properties and here we interpolate the recipe with correct version\n\nI'm currently going with #1 but it can be changed", "author": "hui-yang", "createdAt": "2021-01-25T19:39:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzkzNjU0MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mzk0MTA1OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/806#discussion_r563941058", "bodyText": "Can you add a skip for directories? We currently get a false error that some directory is not a recipe, which we can safely ignore.", "author": "MikeDombo", "createdAt": "2021-01-25T18:17:57Z", "path": "src/main/java/com/aws/greengrass/deployment/DeploymentService.java", "diffHunk": "@@ -510,57 +511,72 @@ private void copyRecipesAndArtifacts(Deployment deployment) throws InvalidReques\n         }\n     }\n \n-    @SuppressWarnings(\"PMD.ExceptionAsFlowControl\")\n     private void copyRecipesToComponentStore(Path from) throws IOException {\n         try (Stream<Path> files = Files.walk(from)) {\n             for (Path r : files.collect(Collectors.toList())) {", "originalCommit": "f42a991067a57dafb37d73aec30b75f86ce6a449", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5475557adf28e410df2661faae0eefdda487282c", "chunk": "diff --git a/src/main/java/com/aws/greengrass/deployment/DeploymentService.java b/src/main/java/com/aws/greengrass/deployment/DeploymentService.java\nindex a7c20612c..730eaf78c 100644\n--- a/src/main/java/com/aws/greengrass/deployment/DeploymentService.java\n+++ b/src/main/java/com/aws/greengrass/deployment/DeploymentService.java\n\n@@ -514,7 +514,9 @@ public class DeploymentService extends GreengrassService {\n     private void copyRecipesToComponentStore(Path from) throws IOException {\n         try (Stream<Path> files = Files.walk(from)) {\n             for (Path r : files.collect(Collectors.toList())) {\n-                copyRecipeFileToComponentStore(componentStore, r, logger);\n+                if (!r.toFile().isDirectory()) {\n+                    copyRecipeFileToComponentStore(componentStore, r, logger);\n+                }\n             }\n         }\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mzk0MzMxOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/806#discussion_r563943318", "bodyText": "you can't put this here since in most cases this code will never execute. Put this somewhere that always executes so that we always pass the version in.", "author": "MikeDombo", "createdAt": "2021-01-25T18:21:25Z", "path": "src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java", "diffHunk": "@@ -226,6 +235,95 @@ private void initializeNucleusComponentConfig() {\n                 .dflt(mainDependencies);\n     }\n \n+    /**\n+     * Persist initial launch parameters of JVM options.\n+     *\n+     * @param kernelAlts KernelAlternatives instance\n+     */\n+    private void persistInitialLaunchParams(KernelAlternatives kernelAlts) {\n+        // Persist initial Nucleus launch parameters\n+        try {\n+            String jvmOptions = ManagementFactory.getRuntimeMXBean().getInputArguments().stream().sorted()\n+                    .filter(s -> !s.startsWith(JVM_OPTION_ROOT_PATH)).collect(Collectors.joining(\" \"));\n+            kernel.getConfig().lookup(SERVICES_NAMESPACE_TOPIC, getNucleusComponentName(), CONFIGURATION_CONFIG_KEY,\n+                    DEVICE_PARAM_JVM_OPTIONS).dflt(jvmOptions);\n+\n+            kernelAlts.writeLaunchParamsToFile(jvmOptions);\n+            logger.atInfo().log(\"Successfully setup Nucleus launch parameters\");\n+        } catch (IOException e) {\n+            logger.atError().log(\"Unable to setup Nucleus launch parameters\", e);\n+        }\n+    }\n+\n+    /**\n+     * Load Nucleus component information from build recipe.\n+     *\n+     * @param kernelAlts KernelAlternatives instance\n+     */\n+    public void initializedNucleusFromRecipe(KernelAlternatives kernelAlts) {\n+        String nucleusComponentName = getNucleusComponentName();\n+        Topics nucleusLifecycle = kernel.getConfig().lookupTopics(DEFAULT_VALUE_TIMESTAMP, SERVICES_NAMESPACE_TOPIC,\n+                nucleusComponentName, SERVICE_LIFECYCLE_NAMESPACE_TOPIC);\n+        if (nucleusLifecycle.children.size() != 0) {\n+            logger.atDebug().log(\"Nucleus lifecycle has already been initialized\");\n+            return;\n+        }\n+\n+        persistInitialLaunchParams(kernelAlts);\n+        try {\n+            Path unpackDir = locateCurrentKernelUnpackDir();\n+            Path recipePath = unpackDir.resolve(NUCLEUS_BUILD_METADATA_DIRECTORY)\n+                    .resolve(NUCLEUS_RECIPE_FILENAME);\n+\n+            // Copy recipe to component store\n+            ComponentStore componentStore = kernel.getContext().get(ComponentStore.class);\n+            DeploymentService.copyRecipeFileToComponentStore(componentStore, recipePath, logger);\n+            // Copy artifact to component store\n+            // TODO\n+\n+            // Update Nucleus in config store\n+            Optional<ComponentRecipe> resolvedRecipe = kernel.getContext().get(RecipeLoader.class)\n+                    .loadFromFile(new String(Files.readAllBytes(recipePath.toAbsolutePath()), StandardCharsets.UTF_8));\n+            if (!resolvedRecipe.isPresent()) {\n+                throw new PackageLoadingException(\"Failed to resolve Nucleus recipe\");\n+            }\n+            ComponentRecipe componentRecipe = resolvedRecipe.get();\n+            nucleusComponentName = componentRecipe.getComponentName();\n+\n+            // Add Nucleus version\n+            String componentVersion = componentRecipe.getVersion().toString();\n+            kernel.getConfig().lookup(SERVICES_NAMESPACE_TOPIC, nucleusComponentName,\n+                    VERSION_CONFIG_KEY).dflt(componentVersion);\n+\n+            kernel.getConfig().lookup(SETENV_CONFIG_NAMESPACE, GGC_VERSION_ENV).withValue(componentVersion);", "originalCommit": "f42a991067a57dafb37d73aec30b75f86ce6a449", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mzk5NDk0OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/806#discussion_r563994948", "bodyText": "Ok. I can move it back to where it was", "author": "hui-yang", "createdAt": "2021-01-25T19:42:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mzk0MzMxOA=="}], "type": "inlineReview", "revised_code": {"commit": "5475557adf28e410df2661faae0eefdda487282c", "chunk": "diff --git a/src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java b/src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java\nindex 122390e91..baf739b9a 100644\n--- a/src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java\n+++ b/src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java\n\n@@ -278,8 +288,6 @@ public class DeviceConfiguration {\n             // Copy recipe to component store\n             ComponentStore componentStore = kernel.getContext().get(ComponentStore.class);\n             DeploymentService.copyRecipeFileToComponentStore(componentStore, recipePath, logger);\n-            // Copy artifact to component store\n-            // TODO\n \n             // Update Nucleus in config store\n             Optional<ComponentRecipe> resolvedRecipe = kernel.getContext().get(RecipeLoader.class)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTYwODA0OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/806#discussion_r565608049", "bodyText": "Should this be replaceAndWait() or dflt() ? What happens when Nucleus restarts and already has lifecycle config from the tlog?", "author": "shaguptashaikh", "createdAt": "2021-01-27T20:22:10Z", "path": "src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java", "diffHunk": "@@ -226,6 +246,97 @@ private void initializeNucleusComponentConfig() {\n                 .dflt(mainDependencies);\n     }\n \n+    /**\n+     * Persist initial launch parameters of JVM options.\n+     *\n+     * @param kernelAlts KernelAlternatives instance\n+     */\n+    private void persistInitialLaunchParams(KernelAlternatives kernelAlts) {\n+        // Persist initial Nucleus launch parameters\n+        try {\n+            String jvmOptions = ManagementFactory.getRuntimeMXBean().getInputArguments().stream().sorted()\n+                    .filter(s -> !s.startsWith(JVM_OPTION_ROOT_PATH)).collect(Collectors.joining(\" \"));\n+            kernel.getConfig().lookup(SERVICES_NAMESPACE_TOPIC, getNucleusComponentName(), CONFIGURATION_CONFIG_KEY,\n+                    DEVICE_PARAM_JVM_OPTIONS).dflt(jvmOptions);\n+\n+            kernelAlts.writeLaunchParamsToFile(jvmOptions);\n+            logger.atInfo().log(\"Successfully setup Nucleus launch parameters\");\n+        } catch (IOException e) {\n+            logger.atError().log(\"Unable to setup Nucleus launch parameters\", e);\n+        }\n+    }\n+\n+    /**\n+     * Load Nucleus component information from build recipe.\n+     *\n+     * @param kernelAlts KernelAlternatives instance\n+     */\n+    public void initializedNucleusFromRecipe(KernelAlternatives kernelAlts) {\n+        String nucleusComponentName = getNucleusComponentName();\n+        Topics nucleusLifecycle = kernel.getConfig().lookupTopics(DEFAULT_VALUE_TIMESTAMP, SERVICES_NAMESPACE_TOPIC,\n+                nucleusComponentName, SERVICE_LIFECYCLE_NAMESPACE_TOPIC);\n+        if (nucleusLifecycle.children.size() != 0) {\n+            logger.atDebug().log(\"Nucleus lifecycle has already been initialized\");\n+            return;\n+        }\n+\n+        persistInitialLaunchParams(kernelAlts);\n+        try {\n+            Path unpackDir = locateCurrentKernelUnpackDir();\n+            Path recipePath = unpackDir.resolve(NUCLEUS_BUILD_METADATA_DIRECTORY)\n+                    .resolve(NUCLEUS_RECIPE_FILENAME);\n+\n+            // Copy recipe to component store\n+            ComponentStore componentStore = kernel.getContext().get(ComponentStore.class);\n+            DeploymentService.copyRecipeFileToComponentStore(componentStore, recipePath, logger);\n+\n+            // Update Nucleus in config store\n+            Optional<ComponentRecipe> resolvedRecipe = kernel.getContext().get(RecipeLoader.class)\n+                    .loadFromFile(new String(Files.readAllBytes(recipePath.toAbsolutePath()), StandardCharsets.UTF_8));\n+            if (!resolvedRecipe.isPresent()) {\n+                throw new PackageLoadingException(\"Failed to resolve Nucleus recipe\");\n+            }\n+            ComponentRecipe componentRecipe = resolvedRecipe.get();\n+            nucleusComponentName = componentRecipe.getComponentName();\n+\n+            // Add Nucleus version\n+            Semver componentVersion = componentRecipe.getVersion();\n+            kernel.getConfig().lookup(SERVICES_NAMESPACE_TOPIC, nucleusComponentName,\n+                    VERSION_CONFIG_KEY).withValue(componentVersion.toString());\n+            kernel.getConfig().lookup(SETENV_CONFIG_NAMESPACE, GGC_VERSION_ENV).withValue(componentVersion.toString());\n+\n+            // Copy unpacked artifacts to component store\n+            Path unpackArtifactPath = kernel.getContext().get(NucleusPaths.class).unarchiveArtifactPath(\n+                    new ComponentIdentifier(nucleusComponentName, componentVersion), \"aws.greengrass.nucleus\");\n+            Utils.copyFolderRecursively(unpackDir, unpackArtifactPath, REPLACE_EXISTING, NOFOLLOW_LINKS,\n+                    COPY_ATTRIBUTES);\n+            Permissions.setArtifactPermission(unpackArtifactPath, FileSystemPermission.builder()\n+                    .ownerRead(true).ownerExecute(true).groupRead(true).groupExecute(true)\n+                    .otherRead(true).otherExecute(true).build());\n+\n+            KernelConfigResolver kernelConfigResolver = kernel.getContext().get(KernelConfigResolver.class);\n+            // Add Nucleus dependencies\n+            Map<String, DependencyProperties> nucleusDependencies = componentRecipe.getDependencies();\n+            if (nucleusDependencies == null) {\n+                nucleusDependencies = Collections.emptyMap();\n+            }\n+            kernel.getConfig().lookup(DEFAULT_VALUE_TIMESTAMP, SERVICES_NAMESPACE_TOPIC,\n+                    nucleusComponentName, SERVICE_DEPENDENCIES_NAMESPACE_TOPIC)\n+                    .dflt(kernelConfigResolver.generateServiceDependencies(nucleusDependencies));\n+\n+            // Add Nucleus lifecycle (after config interpolation)\n+            Object interpolatedLifecycle = kernelConfigResolver.interpolate(componentRecipe.getLifecycle(),\n+                    new ComponentIdentifier(componentRecipe.getComponentName(), componentRecipe.getVersion()),\n+                    nucleusDependencies.keySet(),\n+                    kernel.getConfig().lookupTopics(SERVICES_NAMESPACE_TOPIC).toPOJO());\n+            nucleusLifecycle.replaceAndWait((Map<String, Object>) interpolatedLifecycle);", "originalCommit": "77b497ecff63d8fdcc1771c88d586700ab512160", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTcxOTIwMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/806#discussion_r565719201", "bodyText": "It's prevented with this check https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/806/files/77b497ecff63d8fdcc1771c88d586700ab512160#diff-3de627667101ba5b23e01542a659fd03c9a728449b99d59d0c309ccdbe5badc5R276-R281\nTopics only has updateFromMap and replaceAndWait, but no dflt", "author": "hui-yang", "createdAt": "2021-01-27T23:45:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTYwODA0OQ=="}], "type": "inlineReview", "revised_code": {"commit": "5475557adf28e410df2661faae0eefdda487282c", "chunk": "diff --git a/src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java b/src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java\nindex 28f244a8a..baf739b9a 100644\n--- a/src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java\n+++ b/src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java\n\n@@ -303,7 +302,6 @@ public class DeviceConfiguration {\n             Semver componentVersion = componentRecipe.getVersion();\n             kernel.getConfig().lookup(SERVICES_NAMESPACE_TOPIC, nucleusComponentName,\n                     VERSION_CONFIG_KEY).withValue(componentVersion.toString());\n-            kernel.getConfig().lookup(SETENV_CONFIG_NAMESPACE, GGC_VERSION_ENV).withValue(componentVersion.toString());\n \n             // Copy unpacked artifacts to component store\n             Path unpackArtifactPath = kernel.getContext().get(NucleusPaths.class).unarchiveArtifactPath(\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTYwODQ5MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/806#discussion_r565608491", "bodyText": "This is being done in initializeNucleusComponentConfig as well, is this duplicate?", "author": "shaguptashaikh", "createdAt": "2021-01-27T20:22:58Z", "path": "src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java", "diffHunk": "@@ -226,6 +246,97 @@ private void initializeNucleusComponentConfig() {\n                 .dflt(mainDependencies);\n     }\n \n+    /**\n+     * Persist initial launch parameters of JVM options.\n+     *\n+     * @param kernelAlts KernelAlternatives instance\n+     */\n+    private void persistInitialLaunchParams(KernelAlternatives kernelAlts) {\n+        // Persist initial Nucleus launch parameters\n+        try {\n+            String jvmOptions = ManagementFactory.getRuntimeMXBean().getInputArguments().stream().sorted()\n+                    .filter(s -> !s.startsWith(JVM_OPTION_ROOT_PATH)).collect(Collectors.joining(\" \"));\n+            kernel.getConfig().lookup(SERVICES_NAMESPACE_TOPIC, getNucleusComponentName(), CONFIGURATION_CONFIG_KEY,\n+                    DEVICE_PARAM_JVM_OPTIONS).dflt(jvmOptions);\n+\n+            kernelAlts.writeLaunchParamsToFile(jvmOptions);\n+            logger.atInfo().log(\"Successfully setup Nucleus launch parameters\");\n+        } catch (IOException e) {\n+            logger.atError().log(\"Unable to setup Nucleus launch parameters\", e);\n+        }\n+    }\n+\n+    /**\n+     * Load Nucleus component information from build recipe.\n+     *\n+     * @param kernelAlts KernelAlternatives instance\n+     */\n+    public void initializedNucleusFromRecipe(KernelAlternatives kernelAlts) {\n+        String nucleusComponentName = getNucleusComponentName();\n+        Topics nucleusLifecycle = kernel.getConfig().lookupTopics(DEFAULT_VALUE_TIMESTAMP, SERVICES_NAMESPACE_TOPIC,\n+                nucleusComponentName, SERVICE_LIFECYCLE_NAMESPACE_TOPIC);\n+        if (nucleusLifecycle.children.size() != 0) {\n+            logger.atDebug().log(\"Nucleus lifecycle has already been initialized\");\n+            return;\n+        }\n+\n+        persistInitialLaunchParams(kernelAlts);\n+        try {\n+            Path unpackDir = locateCurrentKernelUnpackDir();\n+            Path recipePath = unpackDir.resolve(NUCLEUS_BUILD_METADATA_DIRECTORY)\n+                    .resolve(NUCLEUS_RECIPE_FILENAME);\n+\n+            // Copy recipe to component store\n+            ComponentStore componentStore = kernel.getContext().get(ComponentStore.class);\n+            DeploymentService.copyRecipeFileToComponentStore(componentStore, recipePath, logger);\n+\n+            // Update Nucleus in config store\n+            Optional<ComponentRecipe> resolvedRecipe = kernel.getContext().get(RecipeLoader.class)\n+                    .loadFromFile(new String(Files.readAllBytes(recipePath.toAbsolutePath()), StandardCharsets.UTF_8));\n+            if (!resolvedRecipe.isPresent()) {\n+                throw new PackageLoadingException(\"Failed to resolve Nucleus recipe\");\n+            }\n+            ComponentRecipe componentRecipe = resolvedRecipe.get();\n+            nucleusComponentName = componentRecipe.getComponentName();\n+\n+            // Add Nucleus version\n+            Semver componentVersion = componentRecipe.getVersion();\n+            kernel.getConfig().lookup(SERVICES_NAMESPACE_TOPIC, nucleusComponentName,\n+                    VERSION_CONFIG_KEY).withValue(componentVersion.toString());\n+            kernel.getConfig().lookup(SETENV_CONFIG_NAMESPACE, GGC_VERSION_ENV).withValue(componentVersion.toString());", "originalCommit": "77b497ecff63d8fdcc1771c88d586700ab512160", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTY2NTk1NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/806#discussion_r565665955", "bodyText": "initializeNucleusComponentConfig only knows about the fallback version 2.0.0.\nYou have a good point though. I will move SETENV_CONFIG_NAMESPACE.GGC_VERSION_ENV setting to a common code path after version is initialized.", "author": "hui-yang", "createdAt": "2021-01-27T21:58:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTYwODQ5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "5475557adf28e410df2661faae0eefdda487282c", "chunk": "diff --git a/src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java b/src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java\nindex 28f244a8a..baf739b9a 100644\n--- a/src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java\n+++ b/src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java\n\n@@ -303,7 +302,6 @@ public class DeviceConfiguration {\n             Semver componentVersion = componentRecipe.getVersion();\n             kernel.getConfig().lookup(SERVICES_NAMESPACE_TOPIC, nucleusComponentName,\n                     VERSION_CONFIG_KEY).withValue(componentVersion.toString());\n-            kernel.getConfig().lookup(SETENV_CONFIG_NAMESPACE, GGC_VERSION_ENV).withValue(componentVersion.toString());\n \n             // Copy unpacked artifacts to component store\n             Path unpackArtifactPath = kernel.getContext().get(NucleusPaths.class).unarchiveArtifactPath(\n"}}, {"oid": "5475557adf28e410df2661faae0eefdda487282c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5475557adf28e410df2661faae0eefdda487282c", "message": "Address comments", "committedDate": "2021-01-28T00:24:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTc0MTAyNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/806#discussion_r565741026", "bodyText": "use isEmpty?", "author": "MikeDombo", "createdAt": "2021-01-28T00:41:14Z", "path": "src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java", "diffHunk": "@@ -226,6 +245,96 @@ private void initializeNucleusComponentConfig() {\n                 .dflt(mainDependencies);\n     }\n \n+    /**\n+     * Persist initial launch parameters of JVM options.\n+     *\n+     * @param kernelAlts KernelAlternatives instance\n+     */\n+    private void persistInitialLaunchParams(KernelAlternatives kernelAlts) {\n+        // Persist initial Nucleus launch parameters\n+        try {\n+            String jvmOptions = ManagementFactory.getRuntimeMXBean().getInputArguments().stream().sorted()\n+                    .filter(s -> !s.startsWith(JVM_OPTION_ROOT_PATH)).collect(Collectors.joining(\" \"));\n+            kernel.getConfig().lookup(SERVICES_NAMESPACE_TOPIC, getNucleusComponentName(), CONFIGURATION_CONFIG_KEY,\n+                    DEVICE_PARAM_JVM_OPTIONS).dflt(jvmOptions);\n+\n+            kernelAlts.writeLaunchParamsToFile(jvmOptions);\n+            logger.atInfo().log(\"Successfully setup Nucleus launch parameters\");\n+        } catch (IOException e) {\n+            logger.atError().log(\"Unable to setup Nucleus launch parameters\", e);\n+        }\n+    }\n+\n+    /**\n+     * Load Nucleus component information from build recipe.\n+     *\n+     * @param kernelAlts KernelAlternatives instance\n+     */\n+    public void initializedNucleusFromRecipe(KernelAlternatives kernelAlts) {\n+        String nucleusComponentName = getNucleusComponentName();\n+        Topics nucleusLifecycle = kernel.getConfig().lookupTopics(DEFAULT_VALUE_TIMESTAMP, SERVICES_NAMESPACE_TOPIC,\n+                nucleusComponentName, SERVICE_LIFECYCLE_NAMESPACE_TOPIC);\n+        if (nucleusLifecycle.children.size() != 0) {", "originalCommit": "5475557adf28e410df2661faae0eefdda487282c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c8e48fbe8eb57cab7736ee6cb28fd47b8cabec30", "chunk": "diff --git a/src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java b/src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java\nindex baf739b9a..9ba16d1c2 100644\n--- a/src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java\n+++ b/src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java\n\n@@ -274,7 +278,7 @@ public class DeviceConfiguration {\n         String nucleusComponentName = getNucleusComponentName();\n         Topics nucleusLifecycle = kernel.getConfig().lookupTopics(DEFAULT_VALUE_TIMESTAMP, SERVICES_NAMESPACE_TOPIC,\n                 nucleusComponentName, SERVICE_LIFECYCLE_NAMESPACE_TOPIC);\n-        if (nucleusLifecycle.children.size() != 0) {\n+        if (!nucleusLifecycle.children.isEmpty()) {\n             logger.atDebug().log(\"Nucleus lifecycle has already been initialized\");\n             return;\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTc0MTQyNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/806#discussion_r565741426", "bodyText": "validate that the path actually exists before attempting to copy it?", "author": "MikeDombo", "createdAt": "2021-01-28T00:42:29Z", "path": "src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java", "diffHunk": "@@ -226,6 +245,96 @@ private void initializeNucleusComponentConfig() {\n                 .dflt(mainDependencies);\n     }\n \n+    /**\n+     * Persist initial launch parameters of JVM options.\n+     *\n+     * @param kernelAlts KernelAlternatives instance\n+     */\n+    private void persistInitialLaunchParams(KernelAlternatives kernelAlts) {\n+        // Persist initial Nucleus launch parameters\n+        try {\n+            String jvmOptions = ManagementFactory.getRuntimeMXBean().getInputArguments().stream().sorted()\n+                    .filter(s -> !s.startsWith(JVM_OPTION_ROOT_PATH)).collect(Collectors.joining(\" \"));\n+            kernel.getConfig().lookup(SERVICES_NAMESPACE_TOPIC, getNucleusComponentName(), CONFIGURATION_CONFIG_KEY,\n+                    DEVICE_PARAM_JVM_OPTIONS).dflt(jvmOptions);\n+\n+            kernelAlts.writeLaunchParamsToFile(jvmOptions);\n+            logger.atInfo().log(\"Successfully setup Nucleus launch parameters\");\n+        } catch (IOException e) {\n+            logger.atError().log(\"Unable to setup Nucleus launch parameters\", e);\n+        }\n+    }\n+\n+    /**\n+     * Load Nucleus component information from build recipe.\n+     *\n+     * @param kernelAlts KernelAlternatives instance\n+     */\n+    public void initializedNucleusFromRecipe(KernelAlternatives kernelAlts) {\n+        String nucleusComponentName = getNucleusComponentName();\n+        Topics nucleusLifecycle = kernel.getConfig().lookupTopics(DEFAULT_VALUE_TIMESTAMP, SERVICES_NAMESPACE_TOPIC,\n+                nucleusComponentName, SERVICE_LIFECYCLE_NAMESPACE_TOPIC);\n+        if (nucleusLifecycle.children.size() != 0) {\n+            logger.atDebug().log(\"Nucleus lifecycle has already been initialized\");\n+            return;\n+        }\n+\n+        persistInitialLaunchParams(kernelAlts);\n+        try {\n+            Path unpackDir = locateCurrentKernelUnpackDir();\n+            Path recipePath = unpackDir.resolve(NUCLEUS_BUILD_METADATA_DIRECTORY)", "originalCommit": "5475557adf28e410df2661faae0eefdda487282c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c8e48fbe8eb57cab7736ee6cb28fd47b8cabec30", "chunk": "diff --git a/src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java b/src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java\nindex baf739b9a..9ba16d1c2 100644\n--- a/src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java\n+++ b/src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java\n\n@@ -274,7 +278,7 @@ public class DeviceConfiguration {\n         String nucleusComponentName = getNucleusComponentName();\n         Topics nucleusLifecycle = kernel.getConfig().lookupTopics(DEFAULT_VALUE_TIMESTAMP, SERVICES_NAMESPACE_TOPIC,\n                 nucleusComponentName, SERVICE_LIFECYCLE_NAMESPACE_TOPIC);\n-        if (nucleusLifecycle.children.size() != 0) {\n+        if (!nucleusLifecycle.children.isEmpty()) {\n             logger.atDebug().log(\"Nucleus lifecycle has already been initialized\");\n             return;\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTc0NTE1MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/806#discussion_r565745151", "bodyText": "Is this hardcoded name correct/the only way to do it?", "author": "MikeDombo", "createdAt": "2021-01-28T00:52:35Z", "path": "src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java", "diffHunk": "@@ -226,6 +245,96 @@ private void initializeNucleusComponentConfig() {\n                 .dflt(mainDependencies);\n     }\n \n+    /**\n+     * Persist initial launch parameters of JVM options.\n+     *\n+     * @param kernelAlts KernelAlternatives instance\n+     */\n+    private void persistInitialLaunchParams(KernelAlternatives kernelAlts) {\n+        // Persist initial Nucleus launch parameters\n+        try {\n+            String jvmOptions = ManagementFactory.getRuntimeMXBean().getInputArguments().stream().sorted()\n+                    .filter(s -> !s.startsWith(JVM_OPTION_ROOT_PATH)).collect(Collectors.joining(\" \"));\n+            kernel.getConfig().lookup(SERVICES_NAMESPACE_TOPIC, getNucleusComponentName(), CONFIGURATION_CONFIG_KEY,\n+                    DEVICE_PARAM_JVM_OPTIONS).dflt(jvmOptions);\n+\n+            kernelAlts.writeLaunchParamsToFile(jvmOptions);\n+            logger.atInfo().log(\"Successfully setup Nucleus launch parameters\");\n+        } catch (IOException e) {\n+            logger.atError().log(\"Unable to setup Nucleus launch parameters\", e);\n+        }\n+    }\n+\n+    /**\n+     * Load Nucleus component information from build recipe.\n+     *\n+     * @param kernelAlts KernelAlternatives instance\n+     */\n+    public void initializedNucleusFromRecipe(KernelAlternatives kernelAlts) {\n+        String nucleusComponentName = getNucleusComponentName();\n+        Topics nucleusLifecycle = kernel.getConfig().lookupTopics(DEFAULT_VALUE_TIMESTAMP, SERVICES_NAMESPACE_TOPIC,\n+                nucleusComponentName, SERVICE_LIFECYCLE_NAMESPACE_TOPIC);\n+        if (nucleusLifecycle.children.size() != 0) {\n+            logger.atDebug().log(\"Nucleus lifecycle has already been initialized\");\n+            return;\n+        }\n+\n+        persistInitialLaunchParams(kernelAlts);\n+        try {\n+            Path unpackDir = locateCurrentKernelUnpackDir();\n+            Path recipePath = unpackDir.resolve(NUCLEUS_BUILD_METADATA_DIRECTORY)\n+                    .resolve(NUCLEUS_RECIPE_FILENAME);\n+\n+            // Copy recipe to component store\n+            ComponentStore componentStore = kernel.getContext().get(ComponentStore.class);\n+            DeploymentService.copyRecipeFileToComponentStore(componentStore, recipePath, logger);\n+\n+            // Update Nucleus in config store\n+            Optional<ComponentRecipe> resolvedRecipe = kernel.getContext().get(RecipeLoader.class)\n+                    .loadFromFile(new String(Files.readAllBytes(recipePath.toAbsolutePath()), StandardCharsets.UTF_8));\n+            if (!resolvedRecipe.isPresent()) {\n+                throw new PackageLoadingException(\"Failed to resolve Nucleus recipe\");\n+            }\n+            ComponentRecipe componentRecipe = resolvedRecipe.get();\n+            nucleusComponentName = componentRecipe.getComponentName();\n+\n+            // Add Nucleus version\n+            Semver componentVersion = componentRecipe.getVersion();\n+            kernel.getConfig().lookup(SERVICES_NAMESPACE_TOPIC, nucleusComponentName,\n+                    VERSION_CONFIG_KEY).withValue(componentVersion.toString());\n+\n+            // Copy unpacked artifacts to component store\n+            Path unpackArtifactPath = kernel.getContext().get(NucleusPaths.class).unarchiveArtifactPath(\n+                    new ComponentIdentifier(nucleusComponentName, componentVersion), \"aws.greengrass.nucleus\");", "originalCommit": "5475557adf28e410df2661faae0eefdda487282c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c8e48fbe8eb57cab7736ee6cb28fd47b8cabec30", "chunk": "diff --git a/src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java b/src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java\nindex baf739b9a..9ba16d1c2 100644\n--- a/src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java\n+++ b/src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java\n\n@@ -274,7 +278,7 @@ public class DeviceConfiguration {\n         String nucleusComponentName = getNucleusComponentName();\n         Topics nucleusLifecycle = kernel.getConfig().lookupTopics(DEFAULT_VALUE_TIMESTAMP, SERVICES_NAMESPACE_TOPIC,\n                 nucleusComponentName, SERVICE_LIFECYCLE_NAMESPACE_TOPIC);\n-        if (nucleusLifecycle.children.size() != 0) {\n+        if (!nucleusLifecycle.children.isEmpty()) {\n             logger.atDebug().log(\"Nucleus lifecycle has already been initialized\");\n             return;\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTc0NTc4NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/806#discussion_r565745784", "bodyText": "this might be copying too much, if I don't unpack into a directory which contains only the zip stuff, like if I unzip into my home directory.\nWe may want to restrict the copying more. Just something to consider anyway.", "author": "MikeDombo", "createdAt": "2021-01-28T00:54:25Z", "path": "src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java", "diffHunk": "@@ -226,6 +245,96 @@ private void initializeNucleusComponentConfig() {\n                 .dflt(mainDependencies);\n     }\n \n+    /**\n+     * Persist initial launch parameters of JVM options.\n+     *\n+     * @param kernelAlts KernelAlternatives instance\n+     */\n+    private void persistInitialLaunchParams(KernelAlternatives kernelAlts) {\n+        // Persist initial Nucleus launch parameters\n+        try {\n+            String jvmOptions = ManagementFactory.getRuntimeMXBean().getInputArguments().stream().sorted()\n+                    .filter(s -> !s.startsWith(JVM_OPTION_ROOT_PATH)).collect(Collectors.joining(\" \"));\n+            kernel.getConfig().lookup(SERVICES_NAMESPACE_TOPIC, getNucleusComponentName(), CONFIGURATION_CONFIG_KEY,\n+                    DEVICE_PARAM_JVM_OPTIONS).dflt(jvmOptions);\n+\n+            kernelAlts.writeLaunchParamsToFile(jvmOptions);\n+            logger.atInfo().log(\"Successfully setup Nucleus launch parameters\");\n+        } catch (IOException e) {\n+            logger.atError().log(\"Unable to setup Nucleus launch parameters\", e);\n+        }\n+    }\n+\n+    /**\n+     * Load Nucleus component information from build recipe.\n+     *\n+     * @param kernelAlts KernelAlternatives instance\n+     */\n+    public void initializedNucleusFromRecipe(KernelAlternatives kernelAlts) {\n+        String nucleusComponentName = getNucleusComponentName();\n+        Topics nucleusLifecycle = kernel.getConfig().lookupTopics(DEFAULT_VALUE_TIMESTAMP, SERVICES_NAMESPACE_TOPIC,\n+                nucleusComponentName, SERVICE_LIFECYCLE_NAMESPACE_TOPIC);\n+        if (nucleusLifecycle.children.size() != 0) {\n+            logger.atDebug().log(\"Nucleus lifecycle has already been initialized\");\n+            return;\n+        }\n+\n+        persistInitialLaunchParams(kernelAlts);\n+        try {\n+            Path unpackDir = locateCurrentKernelUnpackDir();\n+            Path recipePath = unpackDir.resolve(NUCLEUS_BUILD_METADATA_DIRECTORY)\n+                    .resolve(NUCLEUS_RECIPE_FILENAME);\n+\n+            // Copy recipe to component store\n+            ComponentStore componentStore = kernel.getContext().get(ComponentStore.class);\n+            DeploymentService.copyRecipeFileToComponentStore(componentStore, recipePath, logger);\n+\n+            // Update Nucleus in config store\n+            Optional<ComponentRecipe> resolvedRecipe = kernel.getContext().get(RecipeLoader.class)\n+                    .loadFromFile(new String(Files.readAllBytes(recipePath.toAbsolutePath()), StandardCharsets.UTF_8));\n+            if (!resolvedRecipe.isPresent()) {\n+                throw new PackageLoadingException(\"Failed to resolve Nucleus recipe\");\n+            }\n+            ComponentRecipe componentRecipe = resolvedRecipe.get();\n+            nucleusComponentName = componentRecipe.getComponentName();\n+\n+            // Add Nucleus version\n+            Semver componentVersion = componentRecipe.getVersion();\n+            kernel.getConfig().lookup(SERVICES_NAMESPACE_TOPIC, nucleusComponentName,\n+                    VERSION_CONFIG_KEY).withValue(componentVersion.toString());\n+\n+            // Copy unpacked artifacts to component store\n+            Path unpackArtifactPath = kernel.getContext().get(NucleusPaths.class).unarchiveArtifactPath(\n+                    new ComponentIdentifier(nucleusComponentName, componentVersion), \"aws.greengrass.nucleus\");\n+            Utils.copyFolderRecursively(unpackDir, unpackArtifactPath, REPLACE_EXISTING, NOFOLLOW_LINKS,", "originalCommit": "5475557adf28e410df2661faae0eefdda487282c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjMzMjAzNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/806#discussion_r566332036", "bodyText": "If it's ok not to copy over the license files, I can explicitly copy the bin/ conf/ lib/ directories only", "author": "hui-yang", "createdAt": "2021-01-28T18:54:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTc0NTc4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjMzMzkwNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/806#discussion_r566333906", "bodyText": "Seems ok to me.\n@jbutler @philcali  any issues with this? We still distribute the licenses, we'd just not be copying them into the unzip path.", "author": "MikeDombo", "createdAt": "2021-01-28T18:57:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTc0NTc4NA=="}], "type": "inlineReview", "revised_code": {"commit": "c8e48fbe8eb57cab7736ee6cb28fd47b8cabec30", "chunk": "diff --git a/src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java b/src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java\nindex baf739b9a..9ba16d1c2 100644\n--- a/src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java\n+++ b/src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java\n\n@@ -274,7 +278,7 @@ public class DeviceConfiguration {\n         String nucleusComponentName = getNucleusComponentName();\n         Topics nucleusLifecycle = kernel.getConfig().lookupTopics(DEFAULT_VALUE_TIMESTAMP, SERVICES_NAMESPACE_TOPIC,\n                 nucleusComponentName, SERVICE_LIFECYCLE_NAMESPACE_TOPIC);\n-        if (nucleusLifecycle.children.size() != 0) {\n+        if (!nucleusLifecycle.children.isEmpty()) {\n             logger.atDebug().log(\"Nucleus lifecycle has already been initialized\");\n             return;\n         }\n"}}, {"oid": "c8e48fbe8eb57cab7736ee6cb28fd47b8cabec30", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c8e48fbe8eb57cab7736ee6cb28fd47b8cabec30", "message": "Address comments", "committedDate": "2021-01-28T20:26:25Z", "type": "forcePushed"}, {"oid": "6a4d1e3f56f21e1d2c9d7962e9ce2498a2ab6801", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6a4d1e3f56f21e1d2c9d7962e9ce2498a2ab6801", "message": "fix(provision): load Nucleus recipe from build file to component store and config store", "committedDate": "2021-02-02T18:46:26Z", "type": "forcePushed"}, {"oid": "a1bc93b7f549bf3782492e62cd51d64be425dd77", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a1bc93b7f549bf3782492e62cd51d64be425dd77", "message": "fix(provision): load Nucleus recipe from build file to component store and config store", "committedDate": "2021-02-02T23:19:28Z", "type": "forcePushed"}, {"oid": "4082851b88636490485a2801a41a7cde9d885c08", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4082851b88636490485a2801a41a7cde9d885c08", "message": "fix(provision): load Nucleus recipe from build file to component store and config store", "committedDate": "2021-02-09T03:24:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzIwMjk3Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/806#discussion_r573202972", "bodyText": "Why did you do this?", "author": "MikeDombo", "createdAt": "2021-02-09T20:10:52Z", "path": "src/main/java/software/amazon/awssdk/http/apache/internal/conn/SdkTlsSocketFactory.java", "diffHunk": "@@ -52,7 +52,7 @@ protected final void prepareSocket(final SSLSocket socket) {\n         // BEGIN GG MODIFICATIONS\n         try {\n             SSLParameters params = new SSLParameters();\n-            params.setApplicationProtocols(new String[]{\"x-amzn-http-ca\", \"http/1.1\"});\n+            //params.setApplicationProtocols(new String[]{\"x-amzn-http-ca\", \"http/1.1\"});", "originalCommit": "44175a5e78f135e96887138a0d6045a4e57d013f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzIwNDYxNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/806#discussion_r573204615", "bodyText": "It's a mistake. I'll fix it", "author": "hui-yang", "createdAt": "2021-02-09T20:13:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzIwMjk3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "5480fddcfb3d9ac6c44c864b5da7ef233efc6eec", "chunk": "diff --git a/src/main/java/software/amazon/awssdk/http/apache/internal/conn/SdkTlsSocketFactory.java b/src/main/java/software/amazon/awssdk/http/apache/internal/conn/SdkTlsSocketFactory.java\nindex 8ae30f478..03600ab94 100644\n--- a/src/main/java/software/amazon/awssdk/http/apache/internal/conn/SdkTlsSocketFactory.java\n+++ b/src/main/java/software/amazon/awssdk/http/apache/internal/conn/SdkTlsSocketFactory.java\n\n@@ -52,7 +52,7 @@ public class SdkTlsSocketFactory extends SSLConnectionSocketFactory {\n         // BEGIN GG MODIFICATIONS\n         try {\n             SSLParameters params = new SSLParameters();\n-            //params.setApplicationProtocols(new String[]{\"x-amzn-http-ca\", \"http/1.1\"});\n+            params.setApplicationProtocols(new String[]{\"x-amzn-http-ca\", \"http/1.1\"});\n             socket.setSSLParameters(params);\n         } catch (NoSuchMethodError e) {\n             log.debug(() -> \"Unable to configure socket for ALPN. Ports other than 443 may still work.\");\n"}}, {"oid": "5480fddcfb3d9ac6c44c864b5da7ef233efc6eec", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5480fddcfb3d9ac6c44c864b5da7ef233efc6eec", "message": "fix(provision): load Nucleus recipe from build file to component store and config store", "committedDate": "2021-02-09T20:20:37Z", "type": "commit"}, {"oid": "5480fddcfb3d9ac6c44c864b5da7ef233efc6eec", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5480fddcfb3d9ac6c44c864b5da7ef233efc6eec", "message": "fix(provision): load Nucleus recipe from build file to component store and config store", "committedDate": "2021-02-09T20:20:37Z", "type": "forcePushed"}]}