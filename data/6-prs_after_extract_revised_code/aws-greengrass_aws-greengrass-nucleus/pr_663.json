{"pr_number": 663, "pr_title": "Restricting config update for access control policies of a component", "pr_createdAt": "2020-11-12T00:26:48Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/663", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTczMjc5Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/663#discussion_r521732796", "bodyText": "don't you need to check both the keypath and the valueToMerge map?", "author": "MikeDombo", "createdAt": "2020-11-12T00:30:38Z", "path": "src/main/java/com/aws/greengrass/builtin/services/configstore/ConfigStoreIPCEventStreamAgent.java", "diffHunk": "@@ -312,23 +314,26 @@ private void validateRequest(UpdateConfigurationRequest request) {\n             if (request.getValueToMerge() == null) {\n                 throw new InvalidArgumentsError(\"ValueToMerge is required\");\n             }\n-\n+            String[] keyPath = new String[0];\n+            if (request.getKeyPath() != null) {\n+                keyPath = request.getKeyPath().toArray(new String[0]);\n+            }\n+            if (keyPath.length == 0 && request.getValueToMerge().keySet().stream()", "originalCommit": "d695cedb1c289156863aa3cd66f4b60dcf351306", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTczMzQxNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/663#discussion_r521733417", "bodyText": "yes, the accessControl at top level is restricted. If a key name accessControl is inside then we don't wnt to restrict that.", "author": "abanthiy", "createdAt": "2020-11-12T00:31:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTczMjc5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTczNjA5MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/663#discussion_r521736090", "bodyText": "What about changing subkeys though, accessControl.policy1.whatever?", "author": "MikeDombo", "createdAt": "2020-11-12T00:36:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTczMjc5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc0ODMzNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/663#discussion_r521748337", "bodyText": "if any key under accessControl does not get updated, LGTM.", "author": "prateek-y", "createdAt": "2020-11-12T00:57:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTczMjc5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc0OTc2Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/663#discussion_r521749767", "bodyText": "Updated PR should not allow the subkeys either.", "author": "abanthiy", "createdAt": "2020-11-12T00:59:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTczMjc5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "ffc85bba3d461a228423082947918e602cc119c6", "chunk": "diff --git a/src/main/java/com/aws/greengrass/builtin/services/configstore/ConfigStoreIPCEventStreamAgent.java b/src/main/java/com/aws/greengrass/builtin/services/configstore/ConfigStoreIPCEventStreamAgent.java\nindex b2a1a818c..52d66b6ec 100644\n--- a/src/main/java/com/aws/greengrass/builtin/services/configstore/ConfigStoreIPCEventStreamAgent.java\n+++ b/src/main/java/com/aws/greengrass/builtin/services/configstore/ConfigStoreIPCEventStreamAgent.java\n\n@@ -319,10 +320,12 @@ public class ConfigStoreIPCEventStreamAgent {\n                 keyPath = request.getKeyPath().toArray(new String[0]);\n             }\n             if (keyPath.length == 0 && request.getValueToMerge().keySet().stream()\n-                    .filter(key -> restrictedConfigurationFields.contains(key)).findAny().isPresent()) {\n+                    .filter(key -> restrictedConfigurationFields.contains(key)).findAny().isPresent()\n+            || keyPath.length != 0 && restrictedConfigurationFields.contains(request.getKeyPath().get(0))) {\n                 throw new InvalidArgumentsError(\"Config update is not allowed for following fields \"\n                         + restrictedConfigurationFields);\n             }\n+\n             Topics serviceTopics = kernel.findServiceTopic(serviceName);\n             if (serviceTopics == null) {\n                 throw new InvalidArgumentsError(\"Component config not found for component \" + serviceName);\n"}}, {"oid": "ffc85bba3d461a228423082947918e602cc119c6", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ffc85bba3d461a228423082947918e602cc119c6", "message": "Restricting config update for access control policies of a component", "committedDate": "2020-11-12T00:52:18Z", "type": "commit"}, {"oid": "ffc85bba3d461a228423082947918e602cc119c6", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ffc85bba3d461a228423082947918e602cc119c6", "message": "Restricting config update for access control policies of a component", "committedDate": "2020-11-12T00:52:18Z", "type": "forcePushed"}, {"oid": "72ab416a1e1288367e6f0b01f2c6fab71b91e72c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/72ab416a1e1288367e6f0b01f2c6fab71b91e72c", "message": "Merge branch 'master' into restrictAclUpdate", "committedDate": "2020-11-12T01:27:34Z", "type": "commit"}]}