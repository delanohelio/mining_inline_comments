{"pr_number": 235, "pr_title": "Fix and add test for config node removal", "pr_createdAt": "2020-05-12T20:57:48Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAzMzQ1Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235#discussion_r424033453", "bodyText": "What about child added or initialized?", "author": "MikeDombo", "createdAt": "2020-05-12T21:05:57Z", "path": "src/main/java/com/aws/iot/evergreen/config/ConfigurationWriter.java", "diffHunk": "@@ -94,7 +94,7 @@ public ConfigurationWriter flushImmediately(boolean fl) {\n \n     @Override\n     public synchronized void published(WhatHappened what, Topic n) {\n-        if (what == WhatHappened.childChanged) {\n+        if (what == WhatHappened.childChanged || what == WhatHappened.childRemoved) {", "originalCommit": "3d3db05555ff617cbccf55c8c410171552c8253d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU1ODc1Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235#discussion_r424558757", "bodyText": "createLeafChild() doesn't fire an event for adding new child. However when you set a value in WithNewerValue(), it fires a 'childChanged' event.", "author": "ShirleyZheng92", "createdAt": "2020-05-13T16:08:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAzMzQ1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "58b90450b183a171517efd8de385fa01ade5e741", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/config/ConfigurationWriter.java b/src/main/java/com/aws/iot/evergreen/config/ConfigurationWriter.java\nindex 20fd5c0975..c63f8bba2c 100644\n--- a/src/main/java/com/aws/iot/evergreen/config/ConfigurationWriter.java\n+++ b/src/main/java/com/aws/iot/evergreen/config/ConfigurationWriter.java\n\n@@ -93,18 +94,25 @@ public class ConfigurationWriter implements Closeable, Subscriber {\n     }\n \n     @Override\n-    public synchronized void published(WhatHappened what, Topic n) {\n-        if (what == WhatHappened.childChanged || what == WhatHappened.childRemoved) {\n+    public synchronized void childChanged(WhatHappened what, Node n) {\n+        if (closed.get()) {\n+            return;\n+        }\n+        if ((what == WhatHappened.childChanged || what == WhatHappened.childRemoved)  && n instanceof Topic) {\n+            Topic t = (Topic) n;\n             try {\n                 if (n.getName().startsWith(\"_\")) {\n                     return;  // Don't log entries whose name starts in '_'\n                 }\n-                appendLong(n.getModtime(), out);\n-                out.append(',');\n-                n.appendNameTo(out);\n-                out.append(',');\n-                Coerce.appendParseableString(n.getOnce(), out);\n-                out.append('\\n');\n+                WhatHappened action;\n+                if (what == WhatHappened.childChanged) {\n+                    action = WhatHappened.changed;\n+                } else {\n+                    action = WhatHappened.removed;\n+                }\n+\n+                Tlogline tlogline = new Tlogline(t.getModtime(), t.getFullName(), action, t.getOnce());\n+                tlogline.outputTo(out);\n             } catch (IOException ex) {\n                 logger.atError().setEventType(\"config-dump-error\").addKeyValue(\"configNode\", n.getFullName())\n                         .setCause(ex).log();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAzNDE3Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235#discussion_r424034173", "bodyText": "Why make this abstract, what was wrong with the implementation?", "author": "MikeDombo", "createdAt": "2020-05-12T21:07:25Z", "path": "src/main/java/com/aws/iot/evergreen/config/Node.java", "diffHunk": "@@ -95,49 +93,41 @@ public String toString() {\n      */\n     protected boolean addWatcher(Watcher s) {\n         if (s != null) {\n-            if (watchers == null) {\n-                watchers = new CopyOnWriteArraySet<>();\n-            }\n             return watchers.add(s);\n         }\n         return false;\n     }\n \n     /**\n-     * Remove a subscriber to stop being called for updates.\n+     * Remove a watcher to stop being called for updates.\n      *\n-     * @param s subscriber to remove\n+     * @param watcher watcher to remove\n      */\n-    public void remove(Subscriber s) {\n-        if (watchers != null) {\n-            watchers.remove(s);\n-        }\n+    public void remove(Watcher watcher) {\n+        watchers.remove(watcher);\n     }\n \n     /**\n      * Remove this node from its parent.\n      */\n-    public void remove() {\n-        if (parent != null) {\n-            parent.remove(this);\n-        }\n-    }\n+    public abstract void remove();", "originalCommit": "3d3db05555ff617cbccf55c8c410171552c8253d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU1NTU5Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235#discussion_r424555593", "bodyText": "In existing code, Topics.remove(Node) calls the below code\n        n.fire(WhatHappened.removed);\n        childChanged(WhatHappened.childRemoved, n);\n\nwhile Topic.fire(WhatHappened.removed) calls\nparent.childChanged(what, this);\n\nWhich will cause the parent being called childChanged twice, once with removed and once with childRemoved\nThe expected behavior is, when calling Node.remove() or Topics.remove(child), the child node get 'removed' event once and parent node get 'childRemoved' event once, and the node is removed from parent's children. Here I choose to let child invoke parent.childChanged(event).", "author": "ShirleyZheng92", "createdAt": "2020-05-13T16:03:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAzNDE3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "58b90450b183a171517efd8de385fa01ade5e741", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/config/Node.java b/src/main/java/com/aws/iot/evergreen/config/Node.java\nindex 146488a9ea..a855050c0e 100644\n--- a/src/main/java/com/aws/iot/evergreen/config/Node.java\n+++ b/src/main/java/com/aws/iot/evergreen/config/Node.java\n\n@@ -99,23 +101,24 @@ public abstract class Node {\n     }\n \n     /**\n-     * Remove a watcher to stop being called for updates.\n+     * Remove a subscriber to stop being called for updates.\n      *\n-     * @param watcher watcher to remove\n+     * @param s subscriber to remove\n      */\n-    public void remove(Watcher watcher) {\n-        watchers.remove(watcher);\n+    public void remove(Watcher s) {\n+        watchers.remove(s);\n     }\n \n     /**\n      * Remove this node from its parent.\n      */\n-    public abstract void remove();\n+    public void remove() {\n+        if (parent != null) {\n+            parent.remove(this);\n+        }\n+    }\n \n     protected Object validate(Object newValue, Object oldValue) {\n-        if (watchers.isEmpty()) {\n-            return newValue;\n-        }\n         boolean rewrite = true;\n         // Try to make all the validators happy, but not infinitely\n         for (int laps = 3; laps > 0 && rewrite; --laps) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAzNDc1Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235#discussion_r424034756", "bodyText": "So this isn't actually removing the node. The node will still exist; it just has a null value. That's the implementation we decided to go with?", "author": "MikeDombo", "createdAt": "2020-05-12T21:08:36Z", "path": "src/main/java/com/aws/iot/evergreen/config/Topic.java", "diffHunk": "@@ -118,19 +118,29 @@ public synchronized Topic withNewerValue(long proposedModtime, final Object prop\n         return this;\n     }\n \n+    @SuppressWarnings(\"PMD.NullAssignment\")\n     @Override\n-    public void fire(WhatHappened what) {\n+    public synchronized void remove() {\n+        modtime = System.currentTimeMillis();\n+        value = null;", "originalCommit": "3d3db05555ff617cbccf55c8c410171552c8253d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU1OTUyNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235#discussion_r424559524", "bodyText": "parent removes this node on receiving a childChanged event. when it has no other references it'll be garbage collected.", "author": "ShirleyZheng92", "createdAt": "2020-05-13T16:09:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAzNDc1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "58b90450b183a171517efd8de385fa01ade5e741", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/config/Topic.java b/src/main/java/com/aws/iot/evergreen/config/Topic.java\nindex b24f9191c0..6a7ed2a8fb 100644\n--- a/src/main/java/com/aws/iot/evergreen/config/Topic.java\n+++ b/src/main/java/com/aws/iot/evergreen/config/Topic.java\n\n@@ -118,29 +118,36 @@ public class Topic extends Node {\n         return this;\n     }\n \n-    @SuppressWarnings(\"PMD.NullAssignment\")\n-    @Override\n-    public synchronized void remove() {\n-        modtime = System.currentTimeMillis();\n-        value = null;\n-        context.runOnPublishQueueAndWait(() -> this.fire(WhatHappened.removed));\n-        watchers.clear();\n+    /**\n+     * Remove with timestamp check.\n+     * @param timestamp timestamp\n+     */\n+    public void remove(long timestamp) {\n+        if (timestamp < this.modtime) {\n+            return;\n+        }\n+        remove();\n     }\n \n-    private void fire(WhatHappened what) {\n+    @Override\n+    protected void fire(WhatHappened what) {\n         logger.atDebug().setEventType(\"config-node-update\").addKeyValue(\"configNode\", getFullName())\n                 .addKeyValue(\"reason\", what.name()).log();\n-        for (Watcher s : watchers) {\n-            if (s instanceof Subscriber) {\n-                ((Subscriber) s).published(what, this);\n+        if (watchers != null) {\n+            for (Watcher s : watchers) {\n+                if (s instanceof Subscriber) {\n+                    ((Subscriber) s).published(what, this);\n+                }\n             }\n         }\n+\n+        if (WhatHappened.removed.equals(what)) {\n+            watchers.clear();\n+            return;\n+        }\n+\n         if (parent != null && parentNeedsToKnow()) {\n-            if (what.equals(WhatHappened.changed)) {\n-                parent.childChanged(WhatHappened.childChanged, this);\n-            } else if (what.equals(WhatHappened.removed)) {\n-                parent.childChanged(WhatHappened.childRemoved, this);\n-            }\n+            parent.childChanged(WhatHappened.childChanged, this);\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAzNTM2Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235#discussion_r424035363", "bodyText": "What about the other values of WhatHappened? Who can call this fire method, and what values can it be called with.", "author": "MikeDombo", "createdAt": "2020-05-12T21:09:54Z", "path": "src/main/java/com/aws/iot/evergreen/config/Topic.java", "diffHunk": "@@ -118,19 +118,29 @@ public synchronized Topic withNewerValue(long proposedModtime, final Object prop\n         return this;\n     }\n \n+    @SuppressWarnings(\"PMD.NullAssignment\")\n     @Override\n-    public void fire(WhatHappened what) {\n+    public synchronized void remove() {\n+        modtime = System.currentTimeMillis();\n+        value = null;\n+        context.runOnPublishQueueAndWait(() -> this.fire(WhatHappened.removed));\n+        watchers.clear();\n+    }\n+\n+    private void fire(WhatHappened what) {\n         logger.atDebug().setEventType(\"config-node-update\").addKeyValue(\"configNode\", getFullName())\n                 .addKeyValue(\"reason\", what.name()).log();\n-        if (watchers != null) {\n-            for (Watcher s : watchers) {\n-                if (s instanceof Subscriber) {\n-                    ((Subscriber) s).published(what, this);\n-                }\n+        for (Watcher s : watchers) {\n+            if (s instanceof Subscriber) {\n+                ((Subscriber) s).published(what, this);\n             }\n         }\n         if (parent != null && parentNeedsToKnow()) {\n-            parent.childChanged(what, this);\n+            if (what.equals(WhatHappened.changed)) {\n+                parent.childChanged(WhatHappened.childChanged, this);\n+            } else if (what.equals(WhatHappened.removed)) {\n+                parent.childChanged(WhatHappened.childRemoved, this);\n+            }", "originalCommit": "3d3db05555ff617cbccf55c8c410171552c8253d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU2MTMyNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235#discussion_r424561324", "bodyText": "currently fire() only called in remove() and WithNewerValue() .", "author": "ShirleyZheng92", "createdAt": "2020-05-13T16:12:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAzNTM2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "58b90450b183a171517efd8de385fa01ade5e741", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/config/Topic.java b/src/main/java/com/aws/iot/evergreen/config/Topic.java\nindex b24f9191c0..6a7ed2a8fb 100644\n--- a/src/main/java/com/aws/iot/evergreen/config/Topic.java\n+++ b/src/main/java/com/aws/iot/evergreen/config/Topic.java\n\n@@ -118,29 +118,36 @@ public class Topic extends Node {\n         return this;\n     }\n \n-    @SuppressWarnings(\"PMD.NullAssignment\")\n-    @Override\n-    public synchronized void remove() {\n-        modtime = System.currentTimeMillis();\n-        value = null;\n-        context.runOnPublishQueueAndWait(() -> this.fire(WhatHappened.removed));\n-        watchers.clear();\n+    /**\n+     * Remove with timestamp check.\n+     * @param timestamp timestamp\n+     */\n+    public void remove(long timestamp) {\n+        if (timestamp < this.modtime) {\n+            return;\n+        }\n+        remove();\n     }\n \n-    private void fire(WhatHappened what) {\n+    @Override\n+    protected void fire(WhatHappened what) {\n         logger.atDebug().setEventType(\"config-node-update\").addKeyValue(\"configNode\", getFullName())\n                 .addKeyValue(\"reason\", what.name()).log();\n-        for (Watcher s : watchers) {\n-            if (s instanceof Subscriber) {\n-                ((Subscriber) s).published(what, this);\n+        if (watchers != null) {\n+            for (Watcher s : watchers) {\n+                if (s instanceof Subscriber) {\n+                    ((Subscriber) s).published(what, this);\n+                }\n             }\n         }\n+\n+        if (WhatHappened.removed.equals(what)) {\n+            watchers.clear();\n+            return;\n+        }\n+\n         if (parent != null && parentNeedsToKnow()) {\n-            if (what.equals(WhatHappened.changed)) {\n-                parent.childChanged(WhatHappened.childChanged, this);\n-            } else if (what.equals(WhatHappened.removed)) {\n-                parent.childChanged(WhatHappened.childRemoved, this);\n-            }\n+            parent.childChanged(WhatHappened.childChanged, this);\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAzNjQ0MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235#discussion_r424036441", "bodyText": "Why does this need to be on the publish queue? The other remove and fire methods don't use it.", "author": "MikeDombo", "createdAt": "2020-05-12T21:11:55Z", "path": "src/main/java/com/aws/iot/evergreen/config/Topics.java", "diffHunk": "@@ -292,6 +271,19 @@ public Topics subscribe(ChildChanged cc) {\n         return this;\n     }\n \n+    @Override\n+    public synchronized void remove() {\n+        context.runOnPublishQueueAndWait(() -> {", "originalCommit": "3d3db05555ff617cbccf55c8c410171552c8253d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU1NzEyNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235#discussion_r424557124", "bodyText": "fire() method is only invoked in Topic.withNewerValue() , where it put in runOnPublishQueue();", "author": "ShirleyZheng92", "createdAt": "2020-05-13T16:06:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAzNjQ0MQ=="}], "type": "inlineReview", "revised_code": {"commit": "58b90450b183a171517efd8de385fa01ade5e741", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/config/Topics.java b/src/main/java/com/aws/iot/evergreen/config/Topics.java\nindex 92edcb8fa1..3cb7c6db80 100644\n--- a/src/main/java/com/aws/iot/evergreen/config/Topics.java\n+++ b/src/main/java/com/aws/iot/evergreen/config/Topics.java\n\n@@ -271,19 +299,6 @@ public class Topics extends Node implements Iterable<Node> {\n         return this;\n     }\n \n-    @Override\n-    public synchronized void remove() {\n-        context.runOnPublishQueueAndWait(() -> {\n-            for (Watcher s : watchers) {\n-                if (s instanceof ChildChanged) {\n-                    ((ChildChanged) s).childChanged(WhatHappened.removed, null);\n-                }\n-            }\n-            parent.childChanged(WhatHappened.childRemoved, this);\n-        });\n-        watchers.clear();\n-    }\n-\n     @Override\n     public Map<String, Object> toPOJO() {\n         Map<String, Object> map = new TreeMap(String.CASE_INSENSITIVE_ORDER);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAzNzI3Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235#discussion_r424037277", "bodyText": "This seems really weird to have here. Makes more sense to me if this removal was actually in the remove method instead of a callback for childChanged.", "author": "MikeDombo", "createdAt": "2020-05-12T21:13:32Z", "path": "src/main/java/com/aws/iot/evergreen/config/Topics.java", "diffHunk": "@@ -244,41 +240,24 @@ public void deepForEachTopic(Consumer<Topic> f) {\n         children.values().forEach((t) -> t.deepForEachTopic(f));\n     }\n \n-    /**\n-     * Remove a node from this node's children.\n-     *\n-     * @param n node to remove\n-     */\n-    public void remove(Node n) {\n-        if (!children.remove(n.getName(), n)) {\n-            logger.atError(\"config-node-child-remove-error\").kv(\"thisNode\", toString())\n-                    .kv(\"childNode\", n.getName()).log();\n-        }\n-        n.fire(WhatHappened.removed);\n-        childChanged(WhatHappened.childRemoved, n);\n-    }\n-\n     protected void childChanged(WhatHappened what, Node child) {\n         logger.atDebug().setEventType(\"config-node-child-update\").addKeyValue(\"configNode\", getFullName())\n                 .addKeyValue(\"reason\", what.name()).log();\n-        if (watchers != null) {\n-            for (Watcher s : watchers) {\n-                if (s instanceof ChildChanged) {\n-                    ((ChildChanged) s).childChanged(what, child);\n-                }\n-                // TODO: detect if a subscriber fails. Possibly unsubscribe it if the fault is persistent\n+\n+        if (what.equals(WhatHappened.childRemoved) && children.get(child.getName()) == child) {\n+            children.remove(child.getName());\n+        }", "originalCommit": "3d3db05555ff617cbccf55c8c410171552c8253d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU2NjU0OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235#discussion_r424566549", "bodyText": "I'm not very satisfied with this part as well. The reason writing like this is I want to make all topic-change publish event run in context.runOnPublishQueue(), and make children.remove() run in sync with the remove() call.", "author": "ShirleyZheng92", "createdAt": "2020-05-13T16:20:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAzNzI3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "58b90450b183a171517efd8de385fa01ade5e741", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/config/Topics.java b/src/main/java/com/aws/iot/evergreen/config/Topics.java\nindex 92edcb8fa1..3cb7c6db80 100644\n--- a/src/main/java/com/aws/iot/evergreen/config/Topics.java\n+++ b/src/main/java/com/aws/iot/evergreen/config/Topics.java\n\n@@ -240,24 +244,48 @@ public class Topics extends Node implements Iterable<Node> {\n         children.values().forEach((t) -> t.deepForEachTopic(f));\n     }\n \n+    /**\n+     * Remove a node from this node's children.\n+     *\n+     * @param n node to remove\n+     */\n+    public void remove(Node n) {\n+        context.runOnPublishQueue(() -> {\n+            if (!children.remove(n.getName(), n)) {\n+                logger.atError(\"config-node-child-remove-error\").kv(\"thisNode\", toString())\n+                        .kv(\"childNode\", n.getName()).log();\n+            }\n+            n.fire(WhatHappened.removed);\n+            childChanged(WhatHappened.childRemoved, n);\n+        });\n+    }\n+\n     protected void childChanged(WhatHappened what, Node child) {\n         logger.atDebug().setEventType(\"config-node-child-update\").addKeyValue(\"configNode\", getFullName())\n                 .addKeyValue(\"reason\", what.name()).log();\n \n-        if (what.equals(WhatHappened.childRemoved) && children.get(child.getName()) == child) {\n-            children.remove(child.getName());\n-        }\n         for (Watcher s : watchers) {\n             if (s instanceof ChildChanged) {\n                 ((ChildChanged) s).childChanged(what, child);\n             }\n             // TODO: detect if a subscriber fails. Possibly unsubscribe it if the fault is persistent\n         }\n+\n+        if (what.equals(WhatHappened.removed)) {\n+            watchers.clear();\n+            return;\n+        }\n+\n         if (parent != null && parentNeedsToKnow()) {\n             parent.childChanged(what, child);\n         }\n     }\n \n+    @Override\n+    protected void fire(WhatHappened what) {\n+        childChanged(what, null);\n+    }\n+\n     /**\n      * Subscribe to receive updates from this node and its children.\n      *\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAzNzY2Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235#discussion_r424037662", "bodyText": "you already create a context in the beforeeach. Use that one otherwise you'll be leaking contexts.", "author": "MikeDombo", "createdAt": "2020-05-12T21:14:22Z", "path": "src/test/java/com/aws/iot/evergreen/config/TopicsTest.java", "diffHunk": "@@ -0,0 +1,103 @@\n+package com.aws.iot.evergreen.config;\n+\n+import java.io.ByteArrayInputStream;\n+import java.util.Map;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+import com.aws.iot.evergreen.dependency.Context;\n+import com.fasterxml.jackson.dataformat.yaml.YAMLFactory;\n+import com.fasterxml.jackson.jr.ob.JSON;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+public class TopicsTest {\n+\n+    private static final String TEST_TOPICS_CONTENT =\n+            \"---\\n\"\n+            + \"foo:\\n\"\n+            + \"  key1:\\n\"\n+            + \"    subkey1: val1\\n\"\n+            + \"  key2: val2\\n\";\n+    private static Map<Object, Object> testTopicsMap;\n+\n+    private Context context;\n+\n+    @BeforeAll\n+    static void setup() throws Exception {\n+        testTopicsMap = (Map) JSON.std.with(new YAMLFactory()).anyFrom(\n+            new ByteArrayInputStream(TEST_TOPICS_CONTENT.getBytes()));\n+    }\n+\n+    @BeforeEach\n+    void beforeEach() {\n+        context = new Context();\n+    }\n+\n+    @AfterEach\n+    void afterEach() throws Exception {\n+        if (context != null) {\n+            context.close();\n+        }\n+    }\n+\n+    @Test\n+    public void GIVEN_topics_WHEN_leaf_node_removed_THEN_subscribers_get_notified_successfully() throws Exception {\n+        context = new Context();", "originalCommit": "3d3db05555ff617cbccf55c8c410171552c8253d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU1NzIzMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235#discussion_r424557230", "bodyText": "ok", "author": "ShirleyZheng92", "createdAt": "2020-05-13T16:06:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAzNzY2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "58b90450b183a171517efd8de385fa01ade5e741", "chunk": "diff --git a/src/test/java/com/aws/iot/evergreen/config/TopicsTest.java b/src/test/java/com/aws/iot/evergreen/config/TopicsTest.java\ndeleted file mode 100644\nindex 533a73be34..0000000000\n--- a/src/test/java/com/aws/iot/evergreen/config/TopicsTest.java\n+++ /dev/null\n\n@@ -1,103 +0,0 @@\n-package com.aws.iot.evergreen.config;\n-\n-import java.io.ByteArrayInputStream;\n-import java.util.Map;\n-import java.util.concurrent.atomic.AtomicBoolean;\n-\n-import static org.junit.jupiter.api.Assertions.assertEquals;\n-import static org.junit.jupiter.api.Assertions.assertTrue;\n-\n-import com.aws.iot.evergreen.dependency.Context;\n-import com.fasterxml.jackson.dataformat.yaml.YAMLFactory;\n-import com.fasterxml.jackson.jr.ob.JSON;\n-import org.junit.jupiter.api.AfterEach;\n-import org.junit.jupiter.api.BeforeAll;\n-import org.junit.jupiter.api.BeforeEach;\n-import org.junit.jupiter.api.Test;\n-\n-public class TopicsTest {\n-\n-    private static final String TEST_TOPICS_CONTENT =\n-            \"---\\n\"\n-            + \"foo:\\n\"\n-            + \"  key1:\\n\"\n-            + \"    subkey1: val1\\n\"\n-            + \"  key2: val2\\n\";\n-    private static Map<Object, Object> testTopicsMap;\n-\n-    private Context context;\n-\n-    @BeforeAll\n-    static void setup() throws Exception {\n-        testTopicsMap = (Map) JSON.std.with(new YAMLFactory()).anyFrom(\n-            new ByteArrayInputStream(TEST_TOPICS_CONTENT.getBytes()));\n-    }\n-\n-    @BeforeEach\n-    void beforeEach() {\n-        context = new Context();\n-    }\n-\n-    @AfterEach\n-    void afterEach() throws Exception {\n-        if (context != null) {\n-            context.close();\n-        }\n-    }\n-\n-    @Test\n-    public void GIVEN_topics_WHEN_leaf_node_removed_THEN_subscribers_get_notified_successfully() throws Exception {\n-        context = new Context();\n-        Topics topics = new Topics(context, null, null);\n-        topics.mergeMap(System.currentTimeMillis(), testTopicsMap);\n-\n-        Topic childToRemove = topics.find(\"foo\", \"key1\", \"subkey1\");\n-\n-        AtomicBoolean childRemoved = new AtomicBoolean(false);\n-        topics.subscribe((what, child) -> {\n-            if (childToRemove == child && WhatHappened.childRemoved.equals(what)) {\n-                childRemoved.set(true);\n-            }\n-        });\n-\n-        AtomicBoolean removed = new AtomicBoolean(false);\n-        childToRemove.subscribe((what, t) -> {\n-            if (WhatHappened.removed.equals(what)) {\n-                removed.set(true);\n-            }\n-        });\n-\n-        childToRemove.remove();\n-        assertTrue(childRemoved.get());\n-        assertTrue(removed.get());\n-        assertEquals(0, topics.findTopics(\"foo\", \"key1\").size());\n-    }\n-\n-    @Test\n-    public void GIVEN_topics_WHEN_child_topics_removed_THEN_subscribers_get_notified_successfully() throws Exception {\n-        context = new Context();\n-        Topics topics = new Topics(context, null, null);\n-        topics.mergeMap(System.currentTimeMillis(), testTopicsMap);\n-\n-        Topics childToRemove = topics.findTopics(\"foo\", \"key1\");\n-\n-        AtomicBoolean childRemoved = new AtomicBoolean(false);\n-        topics.subscribe((what, child) -> {\n-            if (childToRemove == child && WhatHappened.childRemoved.equals(what)) {\n-                childRemoved.set(true);\n-            }\n-        });\n-\n-        AtomicBoolean removed = new AtomicBoolean(false);\n-        childToRemove.subscribe((what, t) -> {\n-            if (WhatHappened.removed.equals(what)) {\n-                removed.set(true);\n-            }\n-        });\n-\n-        childToRemove.remove();\n-        assertTrue(childRemoved.get());\n-        assertTrue(removed.get());\n-        assertEquals(1, topics.findTopics(\"foo\").size());\n-    }\n-}\n"}}, {"oid": "58b90450b183a171517efd8de385fa01ade5e741", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/58b90450b183a171517efd8de385fa01ade5e741", "message": "Fix and add test for config node removal. Implement remove in Tlog", "committedDate": "2020-06-11T21:04:16Z", "type": "forcePushed"}, {"oid": "18c5097df60cff028f378571282a067ff2e2c0e9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/18c5097df60cff028f378571282a067ff2e2c0e9", "message": "Fix and add test for config node removal. Implement remove in Tlog", "committedDate": "2020-06-11T21:23:12Z", "type": "forcePushed"}, {"oid": "7f6b7cb4818effd6b8085e1e79edd23bc6a3dd03", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7f6b7cb4818effd6b8085e1e79edd23bc6a3dd03", "message": "Fix and add test for config node removal. Implement remove in Tlog", "committedDate": "2020-06-11T21:28:16Z", "type": "forcePushed"}, {"oid": "f4493333a239db3f6f1e7d73e0e88553b5dd004b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f4493333a239db3f6f1e7d73e0e88553b5dd004b", "message": "Fix and add test for config node removal. Implement remove in Tlog", "committedDate": "2020-06-11T22:51:27Z", "type": "commit"}, {"oid": "f4493333a239db3f6f1e7d73e0e88553b5dd004b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f4493333a239db3f6f1e7d73e0e88553b5dd004b", "message": "Fix and add test for config node removal. Implement remove in Tlog", "committedDate": "2020-06-11T22:51:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEyMzY4Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235#discussion_r439123682", "bodyText": "wrong class, unless you did this on purpose.", "author": "MikeDombo", "createdAt": "2020-06-11T23:25:49Z", "path": "src/main/java/com/aws/iot/evergreen/config/ConfigurationReader.java", "diffHunk": "@@ -4,48 +4,67 @@\n package com.aws.iot.evergreen.config;\n \n import com.aws.iot.evergreen.dependency.Context;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n \n import java.io.BufferedReader;\n import java.io.IOException;\n import java.io.Reader;\n import java.nio.file.Files;\n import java.nio.file.Path;\n-import java.util.Iterator;\n import java.util.function.Predicate;\n \n-import static com.aws.iot.evergreen.util.Coerce.toObject;\n-import static com.aws.iot.evergreen.util.Utils.parseLong;\n-\n public final class ConfigurationReader {\n-    private static final java.util.regex.Pattern logLine =\n-            java.util.regex.Pattern.compile(\"([0-9]+),([^,]*),([^\\n]*)\\n*\");\n     private static final java.util.regex.Pattern seperator = java.util.regex.Pattern.compile(\"[./] *\");\n+    private static final Logger logger = LogManager.getLogger(Configuration.class);", "originalCommit": "f4493333a239db3f6f1e7d73e0e88553b5dd004b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8cabc1a050ff370d98412709a840d49031fc3af6", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/config/ConfigurationReader.java b/src/main/java/com/aws/iot/evergreen/config/ConfigurationReader.java\nindex c94b4f7c21..8313669f4e 100644\n--- a/src/main/java/com/aws/iot/evergreen/config/ConfigurationReader.java\n+++ b/src/main/java/com/aws/iot/evergreen/config/ConfigurationReader.java\n\n@@ -16,7 +16,7 @@ import java.util.function.Predicate;\n \n public final class ConfigurationReader {\n     private static final java.util.regex.Pattern seperator = java.util.regex.Pattern.compile(\"[./] *\");\n-    private static final Logger logger = LogManager.getLogger(Configuration.class);\n+    private static final Logger logger = LogManager.getLogger(ConfigurationReader.class);\n \n     private ConfigurationReader() {\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEyNTExMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235#discussion_r439125110", "bodyText": "not sure you should add this here, I'd prefer to let the caller do this. This could actually lead to a deadlock if this merge is running in the publish thread.", "author": "MikeDombo", "createdAt": "2020-06-11T23:30:54Z", "path": "src/main/java/com/aws/iot/evergreen/config/ConfigurationReader.java", "diffHunk": "@@ -4,48 +4,67 @@\n package com.aws.iot.evergreen.config;\n \n import com.aws.iot.evergreen.dependency.Context;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n \n import java.io.BufferedReader;\n import java.io.IOException;\n import java.io.Reader;\n import java.nio.file.Files;\n import java.nio.file.Path;\n-import java.util.Iterator;\n import java.util.function.Predicate;\n \n-import static com.aws.iot.evergreen.util.Coerce.toObject;\n-import static com.aws.iot.evergreen.util.Utils.parseLong;\n-\n public final class ConfigurationReader {\n-    private static final java.util.regex.Pattern logLine =\n-            java.util.regex.Pattern.compile(\"([0-9]+),([^,]*),([^\\n]*)\\n*\");\n     private static final java.util.regex.Pattern seperator = java.util.regex.Pattern.compile(\"[./] *\");\n+    private static final Logger logger = LogManager.getLogger(Configuration.class);\n \n     private ConfigurationReader() {\n     }\n \n     /**\n      * Merge the given transaction log into the given configuration.\n      *\n-     * @param c  configuration to merge into\n+     * @param config  configuration to merge into\n      * @param r0 reader of the transaction log to read from\n+     * @param forceTimestamp forceTimestamp\n+     * @param mergeCondition mergeCondition\n      * @throws IOException if reading fails\n      */\n-    public static void mergeTLogInto(Configuration c, Reader r0) throws IOException {\n+    public static void mergeTLogInto(Configuration config,\n+                                     Reader r0,\n+                                     boolean forceTimestamp,\n+                                     Predicate<Topic> mergeCondition) throws IOException {\n         try (BufferedReader in = r0 instanceof BufferedReader ? (BufferedReader) r0 : new BufferedReader(r0)) {\n-            String l = in.readLine();\n-            while (l != null) {\n-                java.util.regex.Matcher m = logLine.matcher(l);\n-                if (m.matches()) {\n-                    c.lookup(seperator.split(m.group(2))).withNewerValue(parseLong(m.group(1)), toObject(m.group(3)));\n+            String l;\n+\n+            for (l = in.readLine(); l != null; l = in.readLine()) {\n+                try {\n+                    Tlogline tlogline = Tlogline.fromStringInput(l);\n+                    Topic targetTopic = config.lookup(seperator.split(tlogline.topicString));\n+                    if (mergeCondition != null && !mergeCondition.test(targetTopic)) {\n+                        continue;\n+                    }\n+                    if (WhatHappened.changed.equals(tlogline.action)) {\n+                        targetTopic.withNewerValue(tlogline.timestamp, tlogline.value, forceTimestamp);\n+                    } else if (WhatHappened.removed.equals(tlogline.action)) {\n+                        if (forceTimestamp) {\n+                            targetTopic.remove();\n+                        } else {\n+                            targetTopic.remove(tlogline.timestamp);\n+                        }\n+                    }\n+                } catch (Tlogline.InvalidLogException e) {\n+                    logger.atError().setCause(e).log(\"Fail to parse log line\");\n                 }\n-                l = in.readLine();\n             }\n+\n+            // block until all changes are merged in\n+            config.context.runOnPublishQueueAndWait(() -> {});", "originalCommit": "f4493333a239db3f6f1e7d73e0e88553b5dd004b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTk4MTk0MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235#discussion_r439981941", "bodyText": "I think running merge in the publish thread isn't recommended. Since publish is triggered when config change, and it can cause a chain of config changes. I think it's natural for caller to assume that when this mergeTlogInto() returns, the config is updated.", "author": "ShirleyZheng92", "createdAt": "2020-06-15T07:33:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEyNTExMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQzNDg4Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235#discussion_r440434886", "bodyText": "I think the merge does run in the publish thread so that it isn't mixed in with other changes.", "author": "MikeDombo", "createdAt": "2020-06-15T20:42:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEyNTExMA=="}], "type": "inlineReview", "revised_code": {"commit": "8cabc1a050ff370d98412709a840d49031fc3af6", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/config/ConfigurationReader.java b/src/main/java/com/aws/iot/evergreen/config/ConfigurationReader.java\nindex c94b4f7c21..8313669f4e 100644\n--- a/src/main/java/com/aws/iot/evergreen/config/ConfigurationReader.java\n+++ b/src/main/java/com/aws/iot/evergreen/config/ConfigurationReader.java\n\n@@ -16,7 +16,7 @@ import java.util.function.Predicate;\n \n public final class ConfigurationReader {\n     private static final java.util.regex.Pattern seperator = java.util.regex.Pattern.compile(\"[./] *\");\n-    private static final Logger logger = LogManager.getLogger(Configuration.class);\n+    private static final Logger logger = LogManager.getLogger(ConfigurationReader.class);\n \n     private ConfigurationReader() {\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEyNTk3NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235#discussion_r439125974", "bodyText": "why are you hardcoding the what?", "author": "MikeDombo", "createdAt": "2020-06-11T23:34:11Z", "path": "src/main/java/com/aws/iot/evergreen/config/Topic.java", "diffHunk": "@@ -129,8 +140,14 @@ public void fire(WhatHappened what) {\n                 }\n             }\n         }\n+\n+        if (WhatHappened.removed.equals(what)) {\n+            watchers.clear();\n+            return;\n+        }\n+\n         if (parent != null && parentNeedsToKnow()) {\n-            parent.childChanged(what, this);\n+            parent.childChanged(WhatHappened.childChanged, this);", "originalCommit": "f4493333a239db3f6f1e7d73e0e88553b5dd004b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTk4NDA0MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235#discussion_r439984040", "bodyText": "The expected behavior is,\n\nwhen child node is removed, its subscribers get 'Removed' and its parent node (and all great parent node) subscribers get 'childRemoved' events.\nwhen child node is changed, its subscribers get 'Changed' and its parent node (and all great parent node) subscribers get 'childChanged' events.\n\nLeaf node only has changed/removed event. In the remove() function, parent node already sends 'childRemoved' information, so the function returns directly. Therefore I hardcode here to 'childChanged'. I can add more comment here.", "author": "ShirleyZheng92", "createdAt": "2020-06-15T07:38:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEyNTk3NA=="}], "type": "inlineReview", "revised_code": {"commit": "8759ac96091fcbafc5322dcf6c231ad20bb15761", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/config/Topic.java b/src/main/java/com/aws/iot/evergreen/config/Topic.java\nindex 6a7ed2a8fb..219df431ec 100644\n--- a/src/main/java/com/aws/iot/evergreen/config/Topic.java\n+++ b/src/main/java/com/aws/iot/evergreen/config/Topic.java\n\n@@ -141,11 +141,12 @@ public class Topic extends Node {\n             }\n         }\n \n+        // in the case of 'removed' event, parents are already notified with 'childRemoved'.\n         if (WhatHappened.removed.equals(what)) {\n-            watchers.clear();\n             return;\n         }\n \n+        // in the case of 'changed' event\n         if (parent != null && parentNeedsToKnow()) {\n             parent.childChanged(WhatHappened.childChanged, this);\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEyNjI5Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235#discussion_r439126297", "bodyText": "why are you undoing the hardcoding here? These 2 changes I commented on are confusing in how they differ.", "author": "MikeDombo", "createdAt": "2020-06-11T23:35:25Z", "path": "src/main/java/com/aws/iot/evergreen/config/Topics.java", "diffHunk": "@@ -250,27 +250,34 @@ public void deepForEachTopic(Consumer<Topic> f) {\n      * @param n node to remove\n      */\n     public void remove(Node n) {\n-        if (!children.remove(n.getName(), n)) {\n-            logger.atError(\"config-node-child-remove-error\").kv(\"thisNode\", toString())\n-                    .kv(\"childNode\", n.getName()).log();\n-        }\n-        n.fire(WhatHappened.removed);\n-        childChanged(WhatHappened.childRemoved, n);\n+        context.runOnPublishQueue(() -> {\n+            if (!children.remove(n.getName(), n)) {\n+                logger.atError(\"config-node-child-remove-error\").kv(\"thisNode\", toString())\n+                        .kv(\"childNode\", n.getName()).log();\n+            }\n+            n.fire(WhatHappened.removed);\n+            childChanged(WhatHappened.childRemoved, n);\n+        });\n     }\n \n     protected void childChanged(WhatHappened what, Node child) {\n         logger.atDebug().setEventType(\"config-node-child-update\").addKeyValue(\"configNode\", getFullName())\n                 .addKeyValue(\"reason\", what.name()).log();\n-        if (watchers != null) {\n-            for (Watcher s : watchers) {\n-                if (s instanceof ChildChanged) {\n-                    ((ChildChanged) s).childChanged(what, child);\n-                }\n-                // TODO: detect if a subscriber fails. Possibly unsubscribe it if the fault is persistent\n+\n+        for (Watcher s : watchers) {\n+            if (s instanceof ChildChanged) {\n+                ((ChildChanged) s).childChanged(what, child);\n             }\n+            // TODO: detect if a subscriber fails. Possibly unsubscribe it if the fault is persistent\n+        }\n+\n+        if (what.equals(WhatHappened.removed)) {\n+            watchers.clear();\n+            return;\n         }\n+\n         if (parent != null && parentNeedsToKnow()) {\n-            parent.childChanged(WhatHappened.childChanged, child);\n+            parent.childChanged(what, child);", "originalCommit": "f4493333a239db3f6f1e7d73e0e88553b5dd004b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTk4NDQ5OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235#discussion_r439984499", "bodyText": "what can be either childchanged/childRemoved here.", "author": "ShirleyZheng92", "createdAt": "2020-06-15T07:39:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEyNjI5Nw=="}], "type": "inlineReview", "revised_code": {"commit": "8cabc1a050ff370d98412709a840d49031fc3af6", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/config/Topics.java b/src/main/java/com/aws/iot/evergreen/config/Topics.java\nindex 3cb7c6db80..69dcae80aa 100644\n--- a/src/main/java/com/aws/iot/evergreen/config/Topics.java\n+++ b/src/main/java/com/aws/iot/evergreen/config/Topics.java\n\n@@ -273,6 +273,7 @@ public class Topics extends Node implements Iterable<Node> {\n \n         if (what.equals(WhatHappened.removed)) {\n             watchers.clear();\n+            children.forEach((k, v) -> v.fire(WhatHappened.removed));\n             return;\n         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEyNzA1Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235#discussion_r439127057", "bodyText": "use consts for lifecycle and shutdown.", "author": "MikeDombo", "createdAt": "2020-06-11T23:38:05Z", "path": "src/test/java/com/aws/iot/evergreen/config/ConfigurationReaderTest.java", "diffHunk": "@@ -56,4 +57,47 @@ public void GIVEN_tlog_with_ignored_namespace_WHEN_tlog_merged_to_config_with_no\n         assertEquals(\"TLogValue\", config.lookup(SERVICES_NAMESPACE_TOPIC, \"YellowSignal\",\n                                                 SKIP_MERGE_NAMESPACE_KEY, \"testTopic\").getOnce());\n     }\n+\n+    @Test\n+    public void GIVEN_tlog_WHEN_tlog_merged_to_config_with_forced_timestamp_THEN_topic_is_removed() throws Exception {\n+        // Create this topic with temp value\n+        config.lookup(SERVICES_NAMESPACE_TOPIC, \"YellowSignal\",\n+                      \"lifecycle\", \"shutdown\").withNewerValue(Long.MAX_VALUE, \"Test\");", "originalCommit": "f4493333a239db3f6f1e7d73e0e88553b5dd004b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8cabc1a050ff370d98412709a840d49031fc3af6", "chunk": "diff --git a/src/test/java/com/aws/iot/evergreen/config/ConfigurationReaderTest.java b/src/test/java/com/aws/iot/evergreen/config/ConfigurationReaderTest.java\nindex fbfabee393..ed7b5b9190 100644\n--- a/src/test/java/com/aws/iot/evergreen/config/ConfigurationReaderTest.java\n+++ b/src/test/java/com/aws/iot/evergreen/config/ConfigurationReaderTest.java\n\n@@ -53,7 +54,7 @@ public class ConfigurationReaderTest {\n                       SKIP_MERGE_NAMESPACE_KEY, \"testTopic\")\n                                 .withValue(\"Test\");\n         Path tlogPath = Paths.get(ConfigurationReaderTest.class.getResource(\"test.tlog\").toURI());\n-        ConfigurationReader.mergeTlogIntoConfig(config, tlogPath, true, null);\n+        ConfigurationReader.mergeTLogInto(config, tlogPath, true, null);\n         assertEquals(\"TLogValue\", config.lookup(SERVICES_NAMESPACE_TOPIC, \"YellowSignal\",\n                                                 SKIP_MERGE_NAMESPACE_KEY, \"testTopic\").getOnce());\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEyNzI4MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235#discussion_r439127281", "bodyText": "I know it is maybe silly, but can you assert not null first, then do the merge and check again?\nSame with all the other tests in this class.", "author": "MikeDombo", "createdAt": "2020-06-11T23:38:50Z", "path": "src/test/java/com/aws/iot/evergreen/config/ConfigurationReaderTest.java", "diffHunk": "@@ -56,4 +57,47 @@ public void GIVEN_tlog_with_ignored_namespace_WHEN_tlog_merged_to_config_with_no\n         assertEquals(\"TLogValue\", config.lookup(SERVICES_NAMESPACE_TOPIC, \"YellowSignal\",\n                                                 SKIP_MERGE_NAMESPACE_KEY, \"testTopic\").getOnce());\n     }\n+\n+    @Test\n+    public void GIVEN_tlog_WHEN_tlog_merged_to_config_with_forced_timestamp_THEN_topic_is_removed() throws Exception {\n+        // Create this topic with temp value\n+        config.lookup(SERVICES_NAMESPACE_TOPIC, \"YellowSignal\",\n+                      \"lifecycle\", \"shutdown\").withNewerValue(Long.MAX_VALUE, \"Test\");\n+        Path tlogPath = Paths.get(ConfigurationReaderTest.class.getResource(\"test.tlog\").toURI());\n+        ConfigurationReader.mergeTlogIntoConfig(config, tlogPath, true, null);\n+\n+        assertNull(config.find(SERVICES_NAMESPACE_TOPIC, \"YellowSignal\", \"lifecycle\", \"shutdown\"));", "originalCommit": "f4493333a239db3f6f1e7d73e0e88553b5dd004b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8cabc1a050ff370d98412709a840d49031fc3af6", "chunk": "diff --git a/src/test/java/com/aws/iot/evergreen/config/ConfigurationReaderTest.java b/src/test/java/com/aws/iot/evergreen/config/ConfigurationReaderTest.java\nindex fbfabee393..ed7b5b9190 100644\n--- a/src/test/java/com/aws/iot/evergreen/config/ConfigurationReaderTest.java\n+++ b/src/test/java/com/aws/iot/evergreen/config/ConfigurationReaderTest.java\n\n@@ -53,7 +54,7 @@ public class ConfigurationReaderTest {\n                       SKIP_MERGE_NAMESPACE_KEY, \"testTopic\")\n                                 .withValue(\"Test\");\n         Path tlogPath = Paths.get(ConfigurationReaderTest.class.getResource(\"test.tlog\").toURI());\n-        ConfigurationReader.mergeTlogIntoConfig(config, tlogPath, true, null);\n+        ConfigurationReader.mergeTLogInto(config, tlogPath, true, null);\n         assertEquals(\"TLogValue\", config.lookup(SERVICES_NAMESPACE_TOPIC, \"YellowSignal\",\n                                                 SKIP_MERGE_NAMESPACE_KEY, \"testTopic\").getOnce());\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU4MjAyOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235#discussion_r439582029", "bodyText": "Why do we clear parent node watchers here?\nHow is Topics removed? Do we remove all its children first?", "author": "hui-yang", "createdAt": "2020-06-12T18:34:03Z", "path": "src/main/java/com/aws/iot/evergreen/config/Topics.java", "diffHunk": "@@ -250,27 +250,34 @@ public void deepForEachTopic(Consumer<Topic> f) {\n      * @param n node to remove\n      */\n     public void remove(Node n) {\n-        if (!children.remove(n.getName(), n)) {\n-            logger.atError(\"config-node-child-remove-error\").kv(\"thisNode\", toString())\n-                    .kv(\"childNode\", n.getName()).log();\n-        }\n-        n.fire(WhatHappened.removed);\n-        childChanged(WhatHappened.childRemoved, n);\n+        context.runOnPublishQueue(() -> {\n+            if (!children.remove(n.getName(), n)) {\n+                logger.atError(\"config-node-child-remove-error\").kv(\"thisNode\", toString())\n+                        .kv(\"childNode\", n.getName()).log();\n+            }\n+            n.fire(WhatHappened.removed);\n+            childChanged(WhatHappened.childRemoved, n);\n+        });\n     }\n \n     protected void childChanged(WhatHappened what, Node child) {\n         logger.atDebug().setEventType(\"config-node-child-update\").addKeyValue(\"configNode\", getFullName())\n                 .addKeyValue(\"reason\", what.name()).log();\n-        if (watchers != null) {\n-            for (Watcher s : watchers) {\n-                if (s instanceof ChildChanged) {\n-                    ((ChildChanged) s).childChanged(what, child);\n-                }\n-                // TODO: detect if a subscriber fails. Possibly unsubscribe it if the fault is persistent\n+\n+        for (Watcher s : watchers) {\n+            if (s instanceof ChildChanged) {\n+                ((ChildChanged) s).childChanged(what, child);\n             }\n+            // TODO: detect if a subscriber fails. Possibly unsubscribe it if the fault is persistent\n+        }\n+\n+        if (what.equals(WhatHappened.removed)) {\n+            watchers.clear();", "originalCommit": "f4493333a239db3f6f1e7d73e0e88553b5dd004b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMzOTcwOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235#discussion_r440339709", "bodyText": "It's cleaning 'this' node watcher, not parent node. Updated to remove child.", "author": "ShirleyZheng92", "createdAt": "2020-06-15T17:39:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU4MjAyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM0MDI2Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235#discussion_r440340266", "bodyText": "Topic is removed by removing from parent's children and remove all watchers. Then this topic will be garbage collected", "author": "ShirleyZheng92", "createdAt": "2020-06-15T17:40:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU4MjAyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQzNTQwMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235#discussion_r440435401", "bodyText": "Why clear the watchers at all? This node is going away, so it should all be GC'd", "author": "MikeDombo", "createdAt": "2020-06-15T20:43:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU4MjAyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUzOTg5MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235#discussion_r440539891", "bodyText": "I still don't understand your answer to either of the questions. Will try to follow up offline directly.\n\nWhy do we clear parent node watchers here?\nHow is Topics removed? Do we remove all its children first?", "author": "hui-yang", "createdAt": "2020-06-16T01:48:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU4MjAyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "8cabc1a050ff370d98412709a840d49031fc3af6", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/config/Topics.java b/src/main/java/com/aws/iot/evergreen/config/Topics.java\nindex 3cb7c6db80..69dcae80aa 100644\n--- a/src/main/java/com/aws/iot/evergreen/config/Topics.java\n+++ b/src/main/java/com/aws/iot/evergreen/config/Topics.java\n\n@@ -273,6 +273,7 @@ public class Topics extends Node implements Iterable<Node> {\n \n         if (what.equals(WhatHappened.removed)) {\n             watchers.clear();\n+            children.forEach((k, v) -> v.fire(WhatHappened.removed));\n             return;\n         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU4NTAwOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235#discussion_r439585009", "bodyText": "Do we still plan to set null and keep the subscribers? I'm asking about the deployment rollback scenario.\nIt seems most cases the only subscriber is only added when a service is initialized. This may be a good reason that we don't have to persist subscribers. Is it safe to assume this is always the case?", "author": "hui-yang", "createdAt": "2020-06-12T18:41:00Z", "path": "src/main/java/com/aws/iot/evergreen/config/Topic.java", "diffHunk": "@@ -118,8 +118,19 @@ public synchronized Topic withNewerValue(long proposedModtime, final Object prop\n         return this;\n     }\n \n+    /**\n+     * Remove with timestamp check.\n+     * @param timestamp timestamp\n+     */\n+    public void remove(long timestamp) {\n+        if (timestamp < this.modtime) {\n+            return;\n+        }\n+        remove();", "originalCommit": "f4493333a239db3f6f1e7d73e0e88553b5dd004b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM0MTcyNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235#discussion_r440341726", "bodyText": "You can achieve the 'set null and keep subscriber' by calling WithNewerValue(time, null, forcedTimestamp=True) . No need to invoke remove()", "author": "ShirleyZheng92", "createdAt": "2020-06-15T17:43:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU4NTAwOQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU4NTk0Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235#discussion_r439585943", "bodyText": "+1 on the refactor", "author": "hui-yang", "createdAt": "2020-06-12T18:43:08Z", "path": "src/main/java/com/aws/iot/evergreen/config/Tlogline.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package com.aws.iot.evergreen.config;\n+\n+import com.aws.iot.evergreen.util.Coerce;\n+import lombok.AllArgsConstructor;\n+import lombok.Getter;\n+\n+import java.io.IOException;\n+import java.io.Writer;\n+\n+import static com.aws.iot.evergreen.util.Utils.appendLong;\n+import static com.aws.iot.evergreen.util.Utils.parseLong;\n+\n+@AllArgsConstructor\n+@Getter\n+class Tlogline {", "originalCommit": "f4493333a239db3f6f1e7d73e0e88553b5dd004b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU5MDczNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235#discussion_r439590735", "bodyText": "nit: can we use the javadoc of mergeTlogIntoConfig which has more info?\nmergeTlogIntoConfig should also be renamed to mergeTLogInto as a function overload", "author": "hui-yang", "createdAt": "2020-06-12T18:53:52Z", "path": "src/main/java/com/aws/iot/evergreen/config/ConfigurationReader.java", "diffHunk": "@@ -4,48 +4,67 @@\n package com.aws.iot.evergreen.config;\n \n import com.aws.iot.evergreen.dependency.Context;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n \n import java.io.BufferedReader;\n import java.io.IOException;\n import java.io.Reader;\n import java.nio.file.Files;\n import java.nio.file.Path;\n-import java.util.Iterator;\n import java.util.function.Predicate;\n \n-import static com.aws.iot.evergreen.util.Coerce.toObject;\n-import static com.aws.iot.evergreen.util.Utils.parseLong;\n-\n public final class ConfigurationReader {\n-    private static final java.util.regex.Pattern logLine =\n-            java.util.regex.Pattern.compile(\"([0-9]+),([^,]*),([^\\n]*)\\n*\");\n     private static final java.util.regex.Pattern seperator = java.util.regex.Pattern.compile(\"[./] *\");\n+    private static final Logger logger = LogManager.getLogger(Configuration.class);\n \n     private ConfigurationReader() {\n     }\n \n     /**\n      * Merge the given transaction log into the given configuration.\n      *\n-     * @param c  configuration to merge into\n+     * @param config  configuration to merge into\n      * @param r0 reader of the transaction log to read from\n+     * @param forceTimestamp forceTimestamp\n+     * @param mergeCondition mergeCondition", "originalCommit": "f4493333a239db3f6f1e7d73e0e88553b5dd004b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8cabc1a050ff370d98412709a840d49031fc3af6", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/config/ConfigurationReader.java b/src/main/java/com/aws/iot/evergreen/config/ConfigurationReader.java\nindex c94b4f7c21..8313669f4e 100644\n--- a/src/main/java/com/aws/iot/evergreen/config/ConfigurationReader.java\n+++ b/src/main/java/com/aws/iot/evergreen/config/ConfigurationReader.java\n\n@@ -16,7 +16,7 @@ import java.util.function.Predicate;\n \n public final class ConfigurationReader {\n     private static final java.util.regex.Pattern seperator = java.util.regex.Pattern.compile(\"[./] *\");\n-    private static final Logger logger = LogManager.getLogger(Configuration.class);\n+    private static final Logger logger = LogManager.getLogger(ConfigurationReader.class);\n \n     private ConfigurationReader() {\n     }\n"}}, {"oid": "8cabc1a050ff370d98412709a840d49031fc3af6", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8cabc1a050ff370d98412709a840d49031fc3af6", "message": "Address comments", "committedDate": "2020-06-15T08:46:09Z", "type": "commit"}, {"oid": "a9d23ea24ff2c294369f8790b00ed1751e843183", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a9d23ea24ff2c294369f8790b00ed1751e843183", "message": "Merge branch 'master' into removeConfigNode", "committedDate": "2020-06-15T20:21:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ0MTE0MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235#discussion_r440441140", "bodyText": "why don't you notify the parents here?", "author": "MikeDombo", "createdAt": "2020-06-15T20:54:44Z", "path": "src/main/java/com/aws/iot/evergreen/config/Topic.java", "diffHunk": "@@ -129,8 +140,14 @@ public void fire(WhatHappened what) {\n                 }\n             }\n         }\n+\n+        if (WhatHappened.removed.equals(what)) {\n+            watchers.clear();", "originalCommit": "a9d23ea24ff2c294369f8790b00ed1751e843183", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ1NzM2MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235#discussion_r440457361", "bodyText": "Parents are already notified in Topics.remove()", "author": "ShirleyZheng92", "createdAt": "2020-06-15T21:28:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ0MTE0MA=="}], "type": "inlineReview", "revised_code": {"commit": "8759ac96091fcbafc5322dcf6c231ad20bb15761", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/config/Topic.java b/src/main/java/com/aws/iot/evergreen/config/Topic.java\nindex 6a7ed2a8fb..219df431ec 100644\n--- a/src/main/java/com/aws/iot/evergreen/config/Topic.java\n+++ b/src/main/java/com/aws/iot/evergreen/config/Topic.java\n\n@@ -141,11 +141,12 @@ public class Topic extends Node {\n             }\n         }\n \n+        // in the case of 'removed' event, parents are already notified with 'childRemoved'.\n         if (WhatHappened.removed.equals(what)) {\n-            watchers.clear();\n             return;\n         }\n \n+        // in the case of 'changed' event\n         if (parent != null && parentNeedsToKnow()) {\n             parent.childChanged(WhatHappened.childChanged, this);\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ0MTg5Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235#discussion_r440441896", "bodyText": "use asyncAssertOnBiConsumer to ensure that it is only called exactly as many times as you expect and with the precise what that you expect.", "author": "MikeDombo", "createdAt": "2020-06-15T20:56:15Z", "path": "src/test/java/com/aws/iot/evergreen/config/ConfigurationTest.java", "diffHunk": "@@ -182,4 +183,63 @@ public void GIVEN_config_with_subscribers_WHEN_topic_updated_THEN_subscribers_no\n         assertTrue(childChangedCorrectly.await(100, TimeUnit.MILLISECONDS));\n     }\n \n+    @Test\n+    public void GIVEN_config_with_subscribers_WHEN_topic_removed_THEN_subscribers_notified() {\n+        Topic testTopic = config.lookup(\"a\", \"b\", \"c\");\n+        AtomicInteger childNotified = new AtomicInteger(0);\n+        testTopic.subscribe((what, t) -> {", "originalCommit": "a9d23ea24ff2c294369f8790b00ed1751e843183", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUwMjQ2Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235#discussion_r440502462", "bodyText": "Tried and realized Subscriber interface isn't BiConsumer. I don't want to change the subscriber interface right now", "author": "ShirleyZheng92", "createdAt": "2020-06-15T23:33:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ0MTg5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUwNDA0OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/235#discussion_r440504049", "bodyText": "ChildChanged is indeed a BiConsumer and you can cast the consumer to the childchanged, this should work.", "author": "MikeDombo", "createdAt": "2020-06-15T23:38:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ0MTg5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "8759ac96091fcbafc5322dcf6c231ad20bb15761", "chunk": "diff --git a/src/test/java/com/aws/iot/evergreen/config/ConfigurationTest.java b/src/test/java/com/aws/iot/evergreen/config/ConfigurationTest.java\nindex 7b2de7a62a..89a87ce27e 100644\n--- a/src/test/java/com/aws/iot/evergreen/config/ConfigurationTest.java\n+++ b/src/test/java/com/aws/iot/evergreen/config/ConfigurationTest.java\n\n@@ -184,26 +188,38 @@ public class ConfigurationTest {\n     }\n \n     @Test\n-    public void GIVEN_config_with_subscribers_WHEN_topic_removed_THEN_subscribers_notified() {\n+    public void GIVEN_config_with_subscribers_WHEN_topic_removed_THEN_subscribers_notified() throws Exception {\n         Topic testTopic = config.lookup(\"a\", \"b\", \"c\");\n-        AtomicInteger childNotified = new AtomicInteger(0);\n-        testTopic.subscribe((what, t) -> {\n-            if (what.equals(WhatHappened.removed)) {\n-                childNotified.incrementAndGet();\n-            }\n-        });\n-        AtomicInteger parentNotified = new AtomicInteger(0);\n-        config.findTopics(\"a\", \"b\").subscribe((what, child) -> {\n-            if (child == testTopic && what.equals(WhatHappened.childRemoved)) {\n-                parentNotified.incrementAndGet();\n-            }\n-        });\n+\n+        AtomicInteger numCalled = new AtomicInteger(0);\n+        Pair<CompletableFuture<Void>, BiConsumer<WhatHappened, Topic>> childRemoved =\n+                TestUtils.asyncAssertOnBiConsumer((what, t) -> {\n+                    if (numCalled.get() == 0) {\n+                        assertEquals(WhatHappened.initialized, what);\n+                    } else if (numCalled.get() == 1) {\n+                        assertEquals(WhatHappened.removed, what);\n+                    }\n+                    numCalled.incrementAndGet();\n+                }, 2);\n+        testTopic.subscribe((w, t) -> childRemoved.getRight().accept(w, t));\n+\n+        AtomicInteger parentNumCalled = new AtomicInteger(0);\n+        Pair<CompletableFuture<Void>, BiConsumer<WhatHappened, Node>> parentNotified =\n+                TestUtils.asyncAssertOnBiConsumer((what, t) -> {\n+                    if (parentNumCalled.get() == 0) {\n+                        assertEquals(WhatHappened.initialized, what);\n+                        parentNumCalled.incrementAndGet();\n+                    } else if (parentNumCalled.get() == 1) {\n+                        assertEquals(WhatHappened.childRemoved, what);\n+                        assertEquals(testTopic, t);\n+                    }\n+                }, 2);\n+        config.findTopics(\"a\", \"b\").subscribe((w, n) -> parentNotified.getRight().accept(w, n));\n \n         testTopic.remove();\n-        config.context.runOnPublishQueueAndWait(() -> {});\n \n-        assertEquals(1, childNotified.get());\n-        assertEquals(1, parentNotified.get());\n+        childRemoved.getLeft().get(100, TimeUnit.MILLISECONDS);\n+        parentNotified.getLeft().get(100, TimeUnit.MILLISECONDS);\n         assertNull(config.find(\"a\", \"b\", \"c\"));\n     }\n \n"}}, {"oid": "8759ac96091fcbafc5322dcf6c231ad20bb15761", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8759ac96091fcbafc5322dcf6c231ad20bb15761", "message": "Address comments", "committedDate": "2020-06-16T05:43:53Z", "type": "commit"}, {"oid": "5a80bc0b5eb92772e9a2d80b6b47cdda45b9464b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5a80bc0b5eb92772e9a2d80b6b47cdda45b9464b", "message": "Address comments", "committedDate": "2020-06-16T19:04:58Z", "type": "commit"}, {"oid": "3e43ecc004e4b7279027125666e609b872fb1f63", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3e43ecc004e4b7279027125666e609b872fb1f63", "message": "Fix tests", "committedDate": "2020-06-16T21:35:12Z", "type": "commit"}, {"oid": "3e43ecc004e4b7279027125666e609b872fb1f63", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3e43ecc004e4b7279027125666e609b872fb1f63", "message": "Fix tests", "committedDate": "2020-06-16T21:35:12Z", "type": "forcePushed"}]}