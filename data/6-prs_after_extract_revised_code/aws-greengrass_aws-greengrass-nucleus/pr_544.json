{"pr_number": 544, "pr_title": "Use Store directory.", "pr_createdAt": "2020-10-19T19:25:01Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/544", "timeline": [{"oid": "997fc5f81eab5de25031a9de26cf19ef8359d2b5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/997fc5f81eab5de25031a9de26cf19ef8359d2b5", "message": "Use Store directory.", "committedDate": "2020-10-19T19:24:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODAxMTE2MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/544#discussion_r508011161", "bodyText": "this doesn't change the logger. The logger has already been reconfigured", "author": "MikeDombo", "createdAt": "2020-10-19T19:32:10Z", "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/lifecyclemanager/FileLoggerTest.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.greengrass.integrationtests.lifecyclemanager;\n+\n+import com.aws.greengrass.integrationtests.BaseITCase;\n+import com.aws.greengrass.lifecyclemanager.GreengrassService;\n+import com.aws.greengrass.lifecyclemanager.Kernel;\n+import org.hamcrest.MatcherAssert;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+\n+import java.io.File;\n+import java.util.UUID;\n+\n+import static org.hamcrest.Matchers.equalToIgnoringCase;\n+import static org.hamcrest.io.FileMatchers.aFileNamed;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+\n+\n+class FileLoggerTest extends BaseITCase {\n+    private Kernel kernel;\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        System.setProperty(\"log.fmt\", \"JSON\");\n+        System.setProperty(\"log.file.sizeInKB\", \"10240\");\n+        System.setProperty(\"log.file.fileSizeInKB\", \"1024\");\n+        System.setProperty(\"log.store\", \"FILE\");\n+    }\n+\n+    @AfterAll\n+    static void cleanup() {\n+        System.setProperty(\"log.store\", \"CONSOLE\");", "originalCommit": "997fc5f81eab5de25031a9de26cf19ef8359d2b5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4c3945956f4097a5b46e6dfb921a25c1fb2f9648", "chunk": "diff --git a/src/integrationtests/java/com/aws/greengrass/integrationtests/lifecyclemanager/FileLoggerTest.java b/src/integrationtests/java/com/aws/greengrass/integrationtests/lifecyclemanager/FileLoggerTest.java\nindex 5c9b24c8a..53ccd7f09 100644\n--- a/src/integrationtests/java/com/aws/greengrass/integrationtests/lifecyclemanager/FileLoggerTest.java\n+++ b/src/integrationtests/java/com/aws/greengrass/integrationtests/lifecyclemanager/FileLoggerTest.java\n\n@@ -8,6 +8,9 @@ package com.aws.greengrass.integrationtests.lifecyclemanager;\n import com.aws.greengrass.integrationtests.BaseITCase;\n import com.aws.greengrass.lifecyclemanager.GreengrassService;\n import com.aws.greengrass.lifecyclemanager.Kernel;\n+import com.aws.greengrass.logging.impl.LogManager;\n+import com.aws.greengrass.logging.impl.config.LogFormat;\n+import com.aws.greengrass.logging.impl.config.LogStore;\n import org.hamcrest.MatcherAssert;\n import org.junit.jupiter.api.AfterAll;\n import org.junit.jupiter.api.AfterEach;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODAxMTI0OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/544#discussion_r508011249", "bodyText": "this doesn't change the logger because it is statically created", "author": "MikeDombo", "createdAt": "2020-10-19T19:32:21Z", "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/lifecyclemanager/FileLoggerTest.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.greengrass.integrationtests.lifecyclemanager;\n+\n+import com.aws.greengrass.integrationtests.BaseITCase;\n+import com.aws.greengrass.lifecyclemanager.GreengrassService;\n+import com.aws.greengrass.lifecyclemanager.Kernel;\n+import org.hamcrest.MatcherAssert;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+\n+import java.io.File;\n+import java.util.UUID;\n+\n+import static org.hamcrest.Matchers.equalToIgnoringCase;\n+import static org.hamcrest.io.FileMatchers.aFileNamed;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+\n+\n+class FileLoggerTest extends BaseITCase {\n+    private Kernel kernel;\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        System.setProperty(\"log.fmt\", \"JSON\");", "originalCommit": "997fc5f81eab5de25031a9de26cf19ef8359d2b5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODAyMzc3OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/544#discussion_r508023778", "bodyText": "It does take effect since the logger right now reads it from system variables. unless I misunderstood your comment.", "author": "nikkhilmuthye", "createdAt": "2020-10-19T19:55:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODAxMTI0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODAyNTA0MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/544#discussion_r508025040", "bodyText": "No, this will not work.", "author": "MikeDombo", "createdAt": "2020-10-19T19:57:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODAxMTI0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODAyNTUxMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/544#discussion_r508025512", "bodyText": "Once a logger has been created (by an earlier test), that logger will never read from system properties again. You can change them, remove them, whatever. It will have no effect. You need to use the public methods in log config instead to reconfigure the logger", "author": "MikeDombo", "createdAt": "2020-10-19T19:57:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODAxMTI0OQ=="}], "type": "inlineReview", "revised_code": {"commit": "4c3945956f4097a5b46e6dfb921a25c1fb2f9648", "chunk": "diff --git a/src/integrationtests/java/com/aws/greengrass/integrationtests/lifecyclemanager/FileLoggerTest.java b/src/integrationtests/java/com/aws/greengrass/integrationtests/lifecyclemanager/FileLoggerTest.java\nindex 5c9b24c8a..53ccd7f09 100644\n--- a/src/integrationtests/java/com/aws/greengrass/integrationtests/lifecyclemanager/FileLoggerTest.java\n+++ b/src/integrationtests/java/com/aws/greengrass/integrationtests/lifecyclemanager/FileLoggerTest.java\n\n@@ -8,6 +8,9 @@ package com.aws.greengrass.integrationtests.lifecyclemanager;\n import com.aws.greengrass.integrationtests.BaseITCase;\n import com.aws.greengrass.lifecyclemanager.GreengrassService;\n import com.aws.greengrass.lifecyclemanager.Kernel;\n+import com.aws.greengrass.logging.impl.LogManager;\n+import com.aws.greengrass.logging.impl.config.LogFormat;\n+import com.aws.greengrass.logging.impl.config.LogStore;\n import org.hamcrest.MatcherAssert;\n import org.junit.jupiter.api.AfterAll;\n import org.junit.jupiter.api.AfterEach;\n"}}, {"oid": "4c3945956f4097a5b46e6dfb921a25c1fb2f9648", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4c3945956f4097a5b46e6dfb921a25c1fb2f9648", "message": "Address PR comments.", "committedDate": "2020-10-19T20:35:11Z", "type": "commit"}, {"oid": "4c3945956f4097a5b46e6dfb921a25c1fb2f9648", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4c3945956f4097a5b46e6dfb921a25c1fb2f9648", "message": "Address PR comments.", "committedDate": "2020-10-19T20:35:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA4NTAyNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/544#discussion_r508085024", "bodyText": "not sure this does what you think it does. I'm pretty sure it doesn't check that the file exists, it is just looking at the name in the object. Use anExistingFile to check that it actually exists", "author": "MikeDombo", "createdAt": "2020-10-19T21:54:02Z", "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/lifecyclemanager/FileLoggerTest.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.greengrass.integrationtests.lifecyclemanager;\n+\n+import com.aws.greengrass.integrationtests.BaseITCase;\n+import com.aws.greengrass.lifecyclemanager.GreengrassService;\n+import com.aws.greengrass.lifecyclemanager.Kernel;\n+import com.aws.greengrass.logging.impl.LogManager;\n+import com.aws.greengrass.logging.impl.config.LogFormat;\n+import com.aws.greengrass.logging.impl.config.LogStore;\n+import org.hamcrest.MatcherAssert;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+\n+import java.io.File;\n+import java.util.UUID;\n+\n+import static org.hamcrest.Matchers.equalToIgnoringCase;\n+import static org.hamcrest.io.FileMatchers.aFileNamed;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+\n+class FileLoggerTest extends BaseITCase {\n+    private Kernel kernel;\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        LogManager.getRootLogConfiguration().setStoreType(LogStore.FILE);\n+        LogManager.getRootLogConfiguration().setFormat(LogFormat.TEXT);\n+    }\n+\n+    @AfterAll\n+    static void cleanup() {\n+        LogManager.getRootLogConfiguration().setStore(LogStore.CONSOLE);\n+    }\n+\n+    @AfterEach\n+    void afterEach() {\n+        kernel.shutdown();\n+    }\n+\n+    @Test\n+    void GIVEN_root_path_given_as_system_param_WHEN_kernel_launches_THEN_logs_written_to_correct_directory()\n+            throws Exception {\n+        // launch kernel without config arg\n+        kernel = new Kernel().parseArgs().launch();\n+\n+        GreengrassService mainService = kernel.locate(\"main\");\n+        assertNotNull(mainService);\n+\n+        // verify that log file exists are the correct location.\n+        File logFile = tempRootDir.resolve(\"logs\").resolve(\"greengrass.log\").toFile();\n+        MatcherAssert.assertThat(logFile, aFileNamed(equalToIgnoringCase(\"greengrass.log\")));\n+        assertTrue(logFile.length() > 0);\n+    }\n+\n+    @Test\n+    void GIVEN_root_path_given_as_kernel_param_WHEN_kernel_launches_THEN_logs_written_to_correct_directory()\n+            throws Exception {\n+        // launch kernel without config arg\n+        String randomDirectory = UUID.randomUUID().toString();\n+        kernel = new Kernel().parseArgs(\"-r\", tempRootDir.resolve(randomDirectory).toAbsolutePath().toString())\n+                .launch();\n+\n+        GreengrassService mainService = kernel.locate(\"main\");\n+        assertNotNull(mainService);\n+\n+        // verify that log file exists are the correct location.\n+        File logFile = tempRootDir.resolve(randomDirectory).resolve(\"logs\").resolve(\"greengrass.log\").toFile();\n+        File oldLogFile = tempRootDir.resolve(\"logs\").resolve(\"greengrass.log\").toFile();\n+        MatcherAssert.assertThat(logFile, aFileNamed(equalToIgnoringCase(\"greengrass.log\")));", "originalCommit": "4c3945956f4097a5b46e6dfb921a25c1fb2f9648", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA4NTA0NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/544#discussion_r508085044", "bodyText": "can we roll these into some other test maybe? Starting up a new kernel is slow for such a small test.", "author": "MikeDombo", "createdAt": "2020-10-19T21:54:05Z", "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/lifecyclemanager/FileLoggerTest.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.greengrass.integrationtests.lifecyclemanager;\n+\n+import com.aws.greengrass.integrationtests.BaseITCase;\n+import com.aws.greengrass.lifecyclemanager.GreengrassService;\n+import com.aws.greengrass.lifecyclemanager.Kernel;\n+import com.aws.greengrass.logging.impl.LogManager;\n+import com.aws.greengrass.logging.impl.config.LogFormat;\n+import com.aws.greengrass.logging.impl.config.LogStore;\n+import org.hamcrest.MatcherAssert;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+\n+import java.io.File;\n+import java.util.UUID;\n+\n+import static org.hamcrest.Matchers.equalToIgnoringCase;\n+import static org.hamcrest.io.FileMatchers.aFileNamed;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+\n+class FileLoggerTest extends BaseITCase {\n+    private Kernel kernel;\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        LogManager.getRootLogConfiguration().setStoreType(LogStore.FILE);\n+        LogManager.getRootLogConfiguration().setFormat(LogFormat.TEXT);\n+    }\n+\n+    @AfterAll\n+    static void cleanup() {\n+        LogManager.getRootLogConfiguration().setStore(LogStore.CONSOLE);\n+    }\n+\n+    @AfterEach\n+    void afterEach() {\n+        kernel.shutdown();\n+    }\n+\n+    @Test\n+    void GIVEN_root_path_given_as_system_param_WHEN_kernel_launches_THEN_logs_written_to_correct_directory()\n+            throws Exception {\n+        // launch kernel without config arg\n+        kernel = new Kernel().parseArgs().launch();\n+\n+        GreengrassService mainService = kernel.locate(\"main\");\n+        assertNotNull(mainService);\n+\n+        // verify that log file exists are the correct location.\n+        File logFile = tempRootDir.resolve(\"logs\").resolve(\"greengrass.log\").toFile();\n+        MatcherAssert.assertThat(logFile, aFileNamed(equalToIgnoringCase(\"greengrass.log\")));\n+        assertTrue(logFile.length() > 0);\n+    }\n+\n+    @Test\n+    void GIVEN_root_path_given_as_kernel_param_WHEN_kernel_launches_THEN_logs_written_to_correct_directory()\n+            throws Exception {\n+        // launch kernel without config arg\n+        String randomDirectory = UUID.randomUUID().toString();\n+        kernel = new Kernel().parseArgs(\"-r\", tempRootDir.resolve(randomDirectory).toAbsolutePath().toString())", "originalCommit": "4c3945956f4097a5b46e6dfb921a25c1fb2f9648", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "aa99b213b07db9a8b34dede70e3a0e3eaa96a289", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/aa99b213b07db9a8b34dede70e3a0e3eaa96a289", "message": "Merge branch 'master' into useStoreDirectory", "committedDate": "2020-10-19T22:37:29Z", "type": "commit"}]}