{"pr_number": 678, "pr_title": "Taking config snapshot on deployment status updates. Setting unproces\u2026", "pr_createdAt": "2020-11-13T05:53:03Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/678", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjY3MDk5Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/678#discussion_r522670992", "bodyText": "How are these snapshots used?", "author": "MikeDombo", "createdAt": "2020-11-13T05:57:52Z", "path": "src/main/java/com/aws/greengrass/deployment/DeploymentStatusKeeper.java", "diffHunk": "@@ -128,6 +139,12 @@ public void publishPersistedStatusUpdates(DeploymentType type) {\n                     break;\n                 }\n                 processedDeployments.remove(topics);\n+                try {\n+                    deploymentDirectoryManager.takeConfigSnapshot(deploymentDirectoryManager.getSnapshotFilePath());", "originalCommit": "6670dba2c48a1705c2a3b8147eee145e3ea8d0ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjc1NjQyNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/678#discussion_r522756427", "bodyText": "This is being used to udpate the tlog, so that if cloud status update fails and device restarts, then device has the correct series of deployment status updates for the cloud.", "author": "abanthiy", "createdAt": "2020-11-13T07:57:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjY3MDk5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzEyMTY3Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/678#discussion_r523121672", "bodyText": "Is this trying to add deployment status updates to the rollback snapshot?", "author": "hui-yang", "createdAt": "2020-11-13T17:46:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjY3MDk5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzODE0MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/678#discussion_r523238140", "bodyText": "Yes, I believe same is used when device restarts", "author": "abanthiy", "createdAt": "2020-11-13T21:20:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjY3MDk5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "aafd4f3850fcb2ed59820f5c9da6dabfca603483", "chunk": "diff --git a/src/main/java/com/aws/greengrass/deployment/DeploymentStatusKeeper.java b/src/main/java/com/aws/greengrass/deployment/DeploymentStatusKeeper.java\nindex bc722332b..b3a8c4eb1 100644\n--- a/src/main/java/com/aws/greengrass/deployment/DeploymentStatusKeeper.java\n+++ b/src/main/java/com/aws/greengrass/deployment/DeploymentStatusKeeper.java\n\n@@ -140,7 +146,11 @@ public class DeploymentStatusKeeper {\n                 }\n                 processedDeployments.remove(topics);\n                 try {\n-                    deploymentDirectoryManager.takeConfigSnapshot(deploymentDirectoryManager.getSnapshotFilePath());\n+                    // File exists only when deployment has started. For very first updates of IN_PROGRESS this is not\n+                    // needed\n+                    if (Files.exists(deploymentDirectoryManager.getSnapshotFilePath())) {\n+                        deploymentDirectoryManager.takeConfigSnapshot(deploymentDirectoryManager.getSnapshotFilePath());\n+                    }\n                 } catch (IOException e) {\n                     logger.atError().setEventType(CONFIG_SNAPSHOT_ERROR).setCause(e)\n                             .log(\"Failed to take a snapshot after deployment status update sent to consumers\");\n"}}, {"oid": "8aa846ed95ca86bc76e427a5feea854e6d5dde32", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8aa846ed95ca86bc76e427a5feea854e6d5dde32", "message": "Taking config snapshot on deployment status updates. Setting unprocessed job to 0 when empty list received from AWS iot Jobs", "committedDate": "2020-11-13T07:54:15Z", "type": "forcePushed"}, {"oid": "aafd4f3850fcb2ed59820f5c9da6dabfca603483", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/aafd4f3850fcb2ed59820f5c9da6dabfca603483", "message": "Taking config snapshot on deployment status updates. Setting unprocessed job to 0 when empty list received from AWS iot Jobs", "committedDate": "2020-11-13T08:08:47Z", "type": "forcePushed"}, {"oid": "543dfe28ed512d1bc9b301e45883a658171b1050", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/543dfe28ed512d1bc9b301e45883a658171b1050", "message": "Taking config snapshot on deployment status updates. Setting unprocessed job to 0 when empty list received from AWS iot Jobs", "committedDate": "2020-11-13T08:48:49Z", "type": "forcePushed"}, {"oid": "08a1a067a562fa37912794f75a64ab07104dbdad", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/08a1a067a562fa37912794f75a64ab07104dbdad", "message": "Taking config snapshot on deployment status updates. Setting unprocessed job to 0 when empty list received from AWS iot Jobs", "committedDate": "2020-11-13T18:31:12Z", "type": "forcePushed"}, {"oid": "f1f0b9f0314eee9413a78355b0dd02ad40234c75", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f1f0b9f0314eee9413a78355b0dd02ad40234c75", "message": "Taking config snapshot on deployment status updates. Setting unprocessed job to 0 when empty list received from AWS iot Jobs", "committedDate": "2020-11-13T19:53:53Z", "type": "forcePushed"}, {"oid": "78964b97a8423bc6d85fbf6c38e48ae801bb9759", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/78964b97a8423bc6d85fbf6c38e48ae801bb9759", "message": "Taking config snapshot on deployment status updates. Setting unprocessed job to 0 when empty list received from AWS iot Jobs", "committedDate": "2020-11-13T20:13:07Z", "type": "forcePushed"}, {"oid": "d5f1773d46e8c5617dd477fe05f1ae4fab0c2e2b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d5f1773d46e8c5617dd477fe05f1ae4fab0c2e2b", "message": "Taking config snapshot on deployment status updates. Setting unprocessed job to 0 when empty list received from AWS iot Jobs", "committedDate": "2020-11-13T20:13:28Z", "type": "commit"}, {"oid": "d5f1773d46e8c5617dd477fe05f1ae4fab0c2e2b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d5f1773d46e8c5617dd477fe05f1ae4fab0c2e2b", "message": "Taking config snapshot on deployment status updates. Setting unprocessed job to 0 when empty list received from AWS iot Jobs", "committedDate": "2020-11-13T20:13:28Z", "type": "forcePushed"}, {"oid": "175187998fff13865c0e92953582a6b510f2ab0e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/175187998fff13865c0e92953582a6b510f2ab0e", "message": "Merge branch 'master' into bugFixe", "committedDate": "2020-11-13T20:15:21Z", "type": "commit"}, {"oid": "3e167889ff24e16287507e205f92a9abfd5c4cb6", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3e167889ff24e16287507e205f92a9abfd5c4cb6", "message": "Merge branch 'master' into bugFixe", "committedDate": "2020-11-13T23:21:54Z", "type": "commit"}]}