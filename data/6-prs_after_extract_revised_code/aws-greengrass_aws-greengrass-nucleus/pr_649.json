{"pr_number": 649, "pr_title": "Pass IoT Thing Name header for TES calls", "pr_createdAt": "2020-11-10T05:03:24Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/649", "timeline": [{"oid": "a5ba2b7b20f9e84c430f241fe58caec84107ca6f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a5ba2b7b20f9e84c430f241fe58caec84107ca6f", "message": "Pass IoT Thing Name header for TES calls", "committedDate": "2020-11-10T05:04:49Z", "type": "forcePushed"}, {"oid": "cde459797b287933e95b322fa380f1b90f3f9d52", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/cde459797b287933e95b322fa380f1b90f3f9d52", "message": "Pass IoT Thing Name header for TES calls", "committedDate": "2020-11-10T05:25:44Z", "type": "forcePushed"}, {"oid": "d3b19bb0ed833ea4d67348a097359111568e34c9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d3b19bb0ed833ea4d67348a097359111568e34c9", "message": "Pass IoT Thing Name header for TES calls", "committedDate": "2020-11-10T05:30:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQyNTYxMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/649#discussion_r520425610", "bodyText": "does IoT complain if we send an empty thing name header?", "author": "rbattle", "createdAt": "2020-11-10T09:46:29Z", "path": "src/main/java/com/aws/greengrass/iot/IotCloudHelper.java", "diffHunk": "@@ -49,15 +50,21 @@\n      * Sends Http request to Iot Cloud.\n      *\n      * @param connManager underlying connection manager to use for sending requests\n+     * @param thingName   IoT Thing Name\n      * @param path        Http url to query\n      * @param verb        Http verb for the request\n      * @param body        Http body for the request\n      * @return Http response corresponding to http request for path\n      * @throws AWSIotException when unable to send the request successfully\n      */\n-    public IotCloudResponse sendHttpRequest(final IotConnectionManager connManager, final String path,\n-                                            final String verb, final byte[] body) throws AWSIotException {\n-        final HttpHeader[] headers = {new HttpHeader(\"host\", connManager.getHost())};\n+    public IotCloudResponse sendHttpRequest(final IotConnectionManager connManager, String thingName,\n+                                            final String path, final String verb, final byte[] body)\n+            throws AWSIotException {\n+        if (thingName == null) {\n+            thingName = \"\";\n+        }\n+        final HttpHeader[] headers = {new HttpHeader(\"host\", connManager.getHost()),\n+                new HttpHeader(HTTP_HEADER_THING_NAME, thingName)};", "originalCommit": "d3b19bb0ed833ea4d67348a097359111568e34c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDcyOTc2MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/649#discussion_r520729760", "bodyText": "We never sent the header at all before, so I don't se why it would care.", "author": "MikeDombo", "createdAt": "2020-11-10T17:12:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQyNTYxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgwODUwMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/649#discussion_r520808501", "bodyText": "We should probably log error if thing name is not set, as we are allowing customers to rely on it for securing access to resources in cloud.", "author": "prateek-y", "createdAt": "2020-11-10T19:07:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQyNTYxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgwOTY2Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/649#discussion_r520809662", "bodyText": "If they use it in the cloud, IAM will just reject the request.", "author": "MikeDombo", "createdAt": "2020-11-10T19:09:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQyNTYxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgwOTg1MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/649#discussion_r520809851", "bodyText": "It is set using the same mechanism that sets the role alias, so if the RA is set, so will this.", "author": "MikeDombo", "createdAt": "2020-11-10T19:10:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQyNTYxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgxNjMzNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/649#discussion_r520816337", "bodyText": "Also, this isn't only called by TES it is also used by DCM I think.", "author": "MikeDombo", "createdAt": "2020-11-10T19:21:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQyNTYxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgyMTU2OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/649#discussion_r520821569", "bodyText": "I understand its unlikely that we get into the case when thing name is empty, I will leave it up to you.", "author": "prateek-y", "createdAt": "2020-11-10T19:30:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQyNTYxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgyMjMxMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/649#discussion_r520822310", "bodyText": "Since it would fail-safe, I'm not worried about it.", "author": "MikeDombo", "createdAt": "2020-11-10T19:31:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQyNTYxMA=="}], "type": "inlineReview", "revised_code": {"commit": "6e38402ff138ccb7a768e96aed9ccfa76c2b0c27", "chunk": "diff --git a/src/main/java/com/aws/greengrass/iot/IotCloudHelper.java b/src/main/java/com/aws/greengrass/iot/IotCloudHelper.java\nindex 8dbc0104f..4a936e63e 100644\n--- a/src/main/java/com/aws/greengrass/iot/IotCloudHelper.java\n+++ b/src/main/java/com/aws/greengrass/iot/IotCloudHelper.java\n\n@@ -60,14 +63,15 @@ public class IotCloudHelper {\n     public IotCloudResponse sendHttpRequest(final IotConnectionManager connManager, String thingName,\n                                             final String path, final String verb, final byte[] body)\n             throws AWSIotException {\n-        if (thingName == null) {\n-            thingName = \"\";\n+        List<HttpHeader> headers = new ArrayList<>();\n+        headers.add(new HttpHeader(\"host\", connManager.getHost()));\n+        if (Utils.isNotEmpty(thingName)) {\n+            headers.add(new HttpHeader(HTTP_HEADER_THING_NAME, thingName));\n         }\n-        final HttpHeader[] headers = {new HttpHeader(\"host\", connManager.getHost()),\n-                new HttpHeader(HTTP_HEADER_THING_NAME, thingName)};\n \n         final HttpRequestBodyStream httpRequestBodyStream = body == null ? null : createHttpRequestBodyStream(body);\n-        final HttpRequest request = new HttpRequest(verb, path, headers, httpRequestBodyStream);\n+        final HttpRequest request = new HttpRequest(verb, path, headers.toArray(new HttpHeader[0]),\n+                httpRequestBodyStream);\n \n         try (HttpClientConnection conn = connManager.getConnection()) {\n             BaseRetryableAccessor accessor = new BaseRetryableAccessor();\n"}}, {"oid": "6e38402ff138ccb7a768e96aed9ccfa76c2b0c27", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6e38402ff138ccb7a768e96aed9ccfa76c2b0c27", "message": "Pass IoT Thing Name header for TES calls", "committedDate": "2020-11-10T18:13:05Z", "type": "commit"}, {"oid": "6e38402ff138ccb7a768e96aed9ccfa76c2b0c27", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6e38402ff138ccb7a768e96aed9ccfa76c2b0c27", "message": "Pass IoT Thing Name header for TES calls", "committedDate": "2020-11-10T18:13:05Z", "type": "forcePushed"}, {"oid": "17ee2b2d4e3a038819cdfbacf9d52ed728a9cf34", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/17ee2b2d4e3a038819cdfbacf9d52ed728a9cf34", "message": "Merge branch 'master' into pass-thingname-header", "committedDate": "2020-11-10T19:49:29Z", "type": "commit"}]}