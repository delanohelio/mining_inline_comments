{"pr_number": 109, "pr_title": "Refine deduplicating logic in lifecycle change requests.", "pr_createdAt": "2020-03-11T22:34:40Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMzMTEwNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#discussion_r391331107", "bodyText": "Why is this no longer threadsafe?", "author": "MikeDombo", "createdAt": "2020-03-11T23:43:30Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -287,30 +287,30 @@ public boolean isPeriodic() {\n     }\n \n     private Optional<State> peekOrRemoveFirstDesiredState(State activeState) {\n-        if (desiredStateList.isEmpty()) {\n-            return Optional.empty();\n-        }\n-        State first = desiredStateList.get(0);\n-        if (first == activeState) {\n-            desiredStateList.remove(first);\n-            // ignore remove() return value as it's possible that desiredStateList update\n+        synchronized (desiredStateList) {\n+            if (desiredStateList.isEmpty()) {\n+                return Optional.empty();\n+            }\n+            State first = desiredStateList.get(0);\n+            if (first == activeState) {\n+                desiredStateList.remove(first);\n+                // ignore remove() return value as it's possible that desiredStateList update\n+            }\n+            return Optional.ofNullable(first);\n         }\n-        return Optional.ofNullable(first);\n     }\n \n     // Set desiredStateList and override existing desiredStateList.\n-    // Expect to have multi-thread access\n-    private synchronized void setDesiredState(State... state) {\n-        synchronized (desiredStateList) {\n-            List<State> newStateList = Arrays.asList(state);\n-            if (newStateList.equals(desiredStateList)) {\n-                return;\n-            }\n-            desiredStateList.clear();\n-            desiredStateList.addAll(newStateList);\n-            // try insert to the queue, if queue full doesn't block.\n-            enqueueStateEvent(\"DesiredStateUpdated\");\n+    // Not thread safe.\n+    private void setDesiredState(State... state) {", "originalCommit": "f08bd5d402f5203ce975be538f8adebeb2e12ff8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMzNDM1MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#discussion_r391334351", "bodyText": "it's not synchronize on the desiredStateLIst  anymore", "author": "ShirleyZheng92", "createdAt": "2020-03-11T23:54:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMzMTEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMzNzE2NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#discussion_r391337164", "bodyText": "But why not keep it synchronizing on desiredStateList?", "author": "MikeDombo", "createdAt": "2020-03-12T00:05:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMzMTEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTg0OTcxMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#discussion_r391849712", "bodyText": "Because callers will check content on desiredStateList first before modifying it. I want to keep the check-then-modify behavior in one sync block", "author": "ShirleyZheng92", "createdAt": "2020-03-12T19:40:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMzMTEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkwMzIyNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#discussion_r391903227", "bodyText": "You can keep this as synchronized which is just extra-safe, it won't release the lock when called from inside a synchronized block.", "author": "MikeDombo", "createdAt": "2020-03-12T21:25:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMzMTEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk1MTMxOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#discussion_r391951318", "bodyText": "Since we are sync on desiredStateList in other functions that call setDesiredState we can sync here", "author": "fahadmohammed01", "createdAt": "2020-03-12T23:07:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMzMTEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQyNTAzNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#discussion_r392425035", "bodyText": "This should all be put into synchronize (desiredStateList) { ... }", "author": "MikeDombo", "createdAt": "2020-03-13T19:21:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMzMTEwNw=="}], "type": "inlineReview", "revised_code": {"commit": "f992c80775fb9e166eda0e864e146a9a8f5b2728", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java b/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\nindex 9e35677c..24db3ffc 100644\n--- a/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\n+++ b/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\n\n@@ -301,7 +305,7 @@ public class EvergreenService implements InjectionActions, Closeable {\n     }\n \n     // Set desiredStateList and override existing desiredStateList.\n-    // Not thread safe.\n+    // Not thread safe, need to be put in synchronized(desiredStateList)\n     private void setDesiredState(State... state) {\n         List<State> newStateList = Arrays.asList(state);\n         if (newStateList.equals(desiredStateList)) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMzMTI5MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#discussion_r391331290", "bodyText": "make these all final as services should not be overriding their implementations.", "author": "MikeDombo", "createdAt": "2020-03-11T23:44:04Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -332,28 +332,60 @@ private synchronized void enqueueStateEvent(Object event) {\n      * Start Service.\n      */\n     public void requestStart() {", "originalCommit": "f08bd5d402f5203ce975be538f8adebeb2e12ff8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMzNDI1Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#discussion_r391334252", "bodyText": "Sure", "author": "ShirleyZheng92", "createdAt": "2020-03-11T23:54:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMzMTI5MA=="}], "type": "inlineReview", "revised_code": {"commit": "c82c527b8644431e5f5c2227ff479cd7a7459905", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java b/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\nindex 9e35677c..03773f6e 100644\n--- a/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\n+++ b/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\n\n@@ -331,10 +330,11 @@ public class EvergreenService implements InjectionActions, Closeable {\n     /**\n      * Start Service.\n      */\n-    public void requestStart() {\n+    public final void requestStart() {\n         synchronized (this.desiredStateList) {\n             if (this.desiredStateList.isEmpty()) {\n                 this.setDesiredState(State.RUNNING);\n+                return;\n             }\n             State lastState = this.desiredStateList.get(this.desiredStateList.size() - 1);\n             if (lastState == State.RUNNING) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMzMTYwNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#discussion_r391331605", "bodyText": "Once you've set the desired state, isn't this done? Should it return from here?", "author": "MikeDombo", "createdAt": "2020-03-11T23:45:19Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -332,28 +332,60 @@ private synchronized void enqueueStateEvent(Object event) {\n      * Start Service.\n      */\n     public void requestStart() {\n-        setDesiredState(State.RUNNING);\n+        synchronized (this.desiredStateList) {\n+            if (this.desiredStateList.isEmpty()) {\n+                this.setDesiredState(State.RUNNING);\n+            }", "originalCommit": "f08bd5d402f5203ce975be538f8adebeb2e12ff8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMzNDE5MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#discussion_r391334190", "bodyText": "Ooops", "author": "ShirleyZheng92", "createdAt": "2020-03-11T23:54:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMzMTYwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "c82c527b8644431e5f5c2227ff479cd7a7459905", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java b/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\nindex 9e35677c..03773f6e 100644\n--- a/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\n+++ b/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\n\n@@ -331,10 +330,11 @@ public class EvergreenService implements InjectionActions, Closeable {\n     /**\n      * Start Service.\n      */\n-    public void requestStart() {\n+    public final void requestStart() {\n         synchronized (this.desiredStateList) {\n             if (this.desiredStateList.isEmpty()) {\n                 this.setDesiredState(State.RUNNING);\n+                return;\n             }\n             State lastState = this.desiredStateList.get(this.desiredStateList.size() - 1);\n             if (lastState == State.RUNNING) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMzNzcwNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#discussion_r391337707", "bodyText": "THEN?\nMissing the \"THEN\" clause for all these tests.", "author": "MikeDombo", "createdAt": "2020-03-12T00:07:04Z", "path": "src/test/java/com/aws/iot/evergreen/kernel/RequestLifecycleChangeTest.java", "diffHunk": "@@ -0,0 +1,176 @@\n+package com.aws.iot.evergreen.kernel;\n+\n+import java.lang.reflect.Field;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+import com.aws.iot.evergreen.config.Topic;\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.dependency.Context;\n+import com.aws.iot.evergreen.dependency.State;\n+import com.aws.iot.evergreen.testcommons.testutilities.EGServiceTestUtil;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.Assertions;\n+\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+@ExtendWith(MockitoExtension.class)\n+public class RequestLifecycleChangeTest extends EGServiceTestUtil {\n+\n+    private EvergreenService evergreenService;\n+\n+    private static Field desiredStateListField;\n+    private List<State> desiredStateList;\n+\n+    @BeforeAll\n+    public static void setup() throws Exception {\n+        desiredStateListField = EvergreenService.class.getDeclaredField(\"desiredStateList\");\n+        desiredStateListField.setAccessible(true);\n+    }\n+\n+    @BeforeEach\n+    void beforeEach() throws Exception {\n+        Topics config = initializeMockedConfig();\n+        evergreenService = new EvergreenService(config);\n+        desiredStateList = (List<State>) desiredStateListField.get(evergreenService);\n+    }\n+\n+    @Test\n+    public void GIVEN_evergreenService_WHEN_requestStart_called() {", "originalCommit": "f08bd5d402f5203ce975be538f8adebeb2e12ff8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c82c527b8644431e5f5c2227ff479cd7a7459905", "chunk": "diff --git a/src/test/java/com/aws/iot/evergreen/kernel/RequestLifecycleChangeTest.java b/src/test/java/com/aws/iot/evergreen/kernel/RequestLifecycleChangeTest.java\nindex 8fc90d59..7548973a 100644\n--- a/src/test/java/com/aws/iot/evergreen/kernel/RequestLifecycleChangeTest.java\n+++ b/src/test/java/com/aws/iot/evergreen/kernel/RequestLifecycleChangeTest.java\n\n@@ -41,7 +41,7 @@ public class RequestLifecycleChangeTest extends EGServiceTestUtil {\n     }\n \n     @Test\n-    public void GIVEN_evergreenService_WHEN_requestStart_called() {\n+    public void GIVEN_evergreenService_WHEN_requestStart_called_THEN_deduplicate_correctly() {\n         desiredStateList.clear();\n         evergreenService.requestStart();\n         assertDesiredState(State.RUNNING);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc5NjkzMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#discussion_r391796932", "bodyText": "I see you are making changes to sync strategy, can we have some documentation at the class level on the sycn strategy", "author": "fahadmohammed01", "createdAt": "2020-03-12T17:58:51Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -357,28 +332,60 @@ private synchronized void enqueueStateEvent(Object event) {\n      * Start Service.\n      */\n     public void requestStart() {\n-        setDesiredState(State.RUNNING);\n+        synchronized (this.desiredStateList) {", "originalCommit": "f08bd5d402f5203ce975be538f8adebeb2e12ff8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c82c527b8644431e5f5c2227ff479cd7a7459905", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java b/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\nindex 9e35677c..03773f6e 100644\n--- a/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\n+++ b/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\n\n@@ -331,10 +330,11 @@ public class EvergreenService implements InjectionActions, Closeable {\n     /**\n      * Start Service.\n      */\n-    public void requestStart() {\n+    public final void requestStart() {\n         synchronized (this.desiredStateList) {\n             if (this.desiredStateList.isEmpty()) {\n                 this.setDesiredState(State.RUNNING);\n+                return;\n             }\n             State lastState = this.desiredStateList.get(this.desiredStateList.size() - 1);\n             if (lastState == State.RUNNING) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTgxMDAyNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#discussion_r391810025", "bodyText": "shouldn't this be deleted?", "author": "fahadmohammed01", "createdAt": "2020-03-12T18:23:01Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/state/UpdatingKernelState.java", "diffHunk": "@@ -58,8 +60,10 @@ public void proceed() throws DeploymentFailureException {\n         }\n \n         // merge config\n-        Map<Object, Object> resolvedConfig = deploymentContext.getResolvedKernelConfig();\n+        Map<Object, Object> resolvedConfig = new HashMap<>();\n+        resolvedConfig.put(EvergreenService.SERVICES_NAMESPACE_TOPIC, deploymentContext.getResolvedKernelConfig());", "originalCommit": "f08bd5d402f5203ce975be538f8adebeb2e12ff8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTg1MDgyMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#discussion_r391850823", "bodyText": "My bad. I didn't rebase onto the latest master branch", "author": "ShirleyZheng92", "createdAt": "2020-03-12T19:43:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTgxMDAyNQ=="}], "type": "inlineReview", "revised_code": {"commit": "c82c527b8644431e5f5c2227ff479cd7a7459905", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/deployment/state/UpdatingKernelState.java b/src/main/java/com/aws/iot/evergreen/deployment/state/UpdatingKernelState.java\nindex e9390bc7..71a82730 100644\n--- a/src/main/java/com/aws/iot/evergreen/deployment/state/UpdatingKernelState.java\n+++ b/src/main/java/com/aws/iot/evergreen/deployment/state/UpdatingKernelState.java\n\n@@ -60,8 +58,7 @@ public class UpdatingKernelState extends BaseState {\n         }\n \n         // merge config\n-        Map<Object, Object> resolvedConfig = new HashMap<>();\n-        resolvedConfig.put(EvergreenService.SERVICES_NAMESPACE_TOPIC, deploymentContext.getResolvedKernelConfig());\n+        Map<Object, Object> resolvedConfig = deploymentContext.getResolvedKernelConfig();\n         logger.atInfo().addKeyValue(\"resolved_config\", resolvedConfig).log(\"Resolved config :\" + resolvedConfig);\n \n         try {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkwNTMzMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#discussion_r391905332", "bodyText": "Let's just fix the safe system update instead of putting in these hacks here. That service should either stay in running, or go to finished, or be periodic. However we do it, this is not the way to fix it.", "author": "MikeDombo", "createdAt": "2020-03-12T21:28:16Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -280,10 +282,19 @@ public Kernel launch() {\n             context.put(ShellRunner.class, context.get(ShellRunner.Dryrun.class));\n         }\n         try {\n-            EvergreenService main = getMain(); // Trigger boot  (!?!?)\n+            mainService = getMain();\n             autostart.forEach(s -> {\n                 try {\n-                    main.addDependency(EvergreenService.locate(context, s), State.RUNNING);\n+                    if (!s.contains(\"SafeSystemUpdate\")) {\n+                        mainService.addDependency(EvergreenService.locate(context, s), State.RUNNING);\n+                    } else {\n+                        // SafeSystemUpdate will reset to Installed after update.\n+                        // This is a hacky way to avoid restarting depending services.\n+                        // TODO: Find a proper way handle this situation.", "originalCommit": "f08bd5d402f5203ce975be538f8adebeb2e12ff8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQxODQ4NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#discussion_r392418484", "bodyText": "I feel it's too big change for this PR. Periodicity currently is tightly coupled with EvergreenService", "author": "ShirleyZheng92", "createdAt": "2020-03-13T19:06:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkwNTMzMg=="}], "type": "inlineReview", "revised_code": {"commit": "f992c80775fb9e166eda0e864e146a9a8f5b2728", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/kernel/Kernel.java b/src/main/java/com/aws/iot/evergreen/kernel/Kernel.java\nindex 2c59f7c0..c74c56f1 100644\n--- a/src/main/java/com/aws/iot/evergreen/kernel/Kernel.java\n+++ b/src/main/java/com/aws/iot/evergreen/kernel/Kernel.java\n\n@@ -285,14 +285,7 @@ public class Kernel extends Configuration /*implements Runnable*/ {\n             mainService = getMain();\n             autostart.forEach(s -> {\n                 try {\n-                    if (!s.contains(\"SafeSystemUpdate\")) {\n-                        mainService.addDependency(EvergreenService.locate(context, s), State.RUNNING);\n-                    } else {\n-                        // SafeSystemUpdate will reset to Installed after update.\n-                        // This is a hacky way to avoid restarting depending services.\n-                        // TODO: Find a proper way handle this situation.\n-                        mainService.addDependency(EvergreenService.locate(context, s), State.INSTALLED);\n-                    }\n+                    mainService.addDependency(EvergreenService.locate(context, s), State.RUNNING);\n                 } catch (ServiceLoadException se) {\n                     logger.atError().setCause(se).log(\"Unable to load service {}\", s);\n                 } catch (InputValidationException e) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkwNjU2Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#discussion_r391906562", "bodyText": "This should be static if possible because it should not be specific to an individual service; our config is global.", "author": "MikeDombo", "createdAt": "2020-03-12T21:29:53Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -565,6 +580,10 @@ private void addServiceSearchURL(Object url) {\n         }\n     }\n \n+    public Topics findServiceTopic(String name) {", "originalCommit": "f08bd5d402f5203ce975be538f8adebeb2e12ff8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQxNzE1NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#discussion_r392417155", "bodyText": "config isn't static though, unless we pass in config as param", "author": "ShirleyZheng92", "createdAt": "2020-03-13T19:03:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkwNjU2Mg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkwODY1NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#discussion_r391908654", "bodyText": "newly created service don't auto-start, so this todo is not true. The requestStart is required only for new services.", "author": "MikeDombo", "createdAt": "2020-03-12T21:32:27Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -597,16 +624,17 @@ private void addServiceSearchURL(Object url) {\n                 try {\n                     mergeMap(timestamp, newConfig);\n                     context.addGlobalStateChangeListener(listener);\n-\n-                    newConfig.keySet().forEach(serviceName -> {\n-                        EvergreenService eg = EvergreenService.locate(context, (String) serviceName);\n-                        if (eg == null) {\n-                            logger.error(\"Could not locate EvergreenService for modified service {}\", serviceName);\n-                        } else if (State.NEW.equals(eg.getState())) {\n+                    serviceConfig.keySet().forEach(serviceName -> {\n+                        try {\n+                            EvergreenService eg = EvergreenService.locate(context, serviceName);\n+                            // TODO: remove requestStart here as each service will handle update behavior based on", "originalCommit": "f08bd5d402f5203ce975be538f8adebeb2e12ff8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQxNjkzNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#discussion_r392416934", "bodyText": "I see. Thanks for pointing out", "author": "ShirleyZheng92", "createdAt": "2020-03-13T19:02:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkwODY1NA=="}], "type": "inlineReview", "revised_code": {"commit": "4994c3ae60f243b34371f00c7b44eef8fd3112fa", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/kernel/Kernel.java b/src/main/java/com/aws/iot/evergreen/kernel/Kernel.java\nindex 2c59f7c0..d75d19e0 100644\n--- a/src/main/java/com/aws/iot/evergreen/kernel/Kernel.java\n+++ b/src/main/java/com/aws/iot/evergreen/kernel/Kernel.java\n\n@@ -627,9 +626,6 @@ public class Kernel extends Configuration /*implements Runnable*/ {\n                     serviceConfig.keySet().forEach(serviceName -> {\n                         try {\n                             EvergreenService eg = EvergreenService.locate(context, serviceName);\n-                            // TODO: remove requestStart here as each service will handle update behavior based on\n-                            // updated fields.\n-                            eg.requestStart();\n                         } catch (ServiceLoadException e) {\n                             logger.atError().setCause(e).addKeyValue(\"serviceName\", serviceName)\n                                     .log(\"Could not locate EvergreenService for modified service\");\n"}}, {"oid": "c82c527b8644431e5f5c2227ff479cd7a7459905", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c82c527b8644431e5f5c2227ff479cd7a7459905", "message": "Refine deduplicating logic in lifecycle change requests.\n\nWhen a service receives restart and start in sequence, 'start' may override the 'restart'.\nThis can cause merge-config doesn't restart service as expected.", "committedDate": "2020-03-12T21:28:07Z", "type": "forcePushed"}, {"oid": "3cdc55b6f3a9d45eef24fd579c6a0a5b3d9ab648", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3cdc55b6f3a9d45eef24fd579c6a0a5b3d9ab648", "message": "Refine deduplicating logic in lifecycle change requests.\n\nWhen a service receives restart and start in sequence, 'start' may override the 'restart'.\nThis can cause merge-config doesn't restart service as expected.", "committedDate": "2020-03-13T18:03:41Z", "type": "forcePushed"}, {"oid": "4994c3ae60f243b34371f00c7b44eef8fd3112fa", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4994c3ae60f243b34371f00c7b44eef8fd3112fa", "message": "Refine deduplicating logic in lifecycle change requests.\n\nWhen a service receives restart and start in sequence, 'start' may override the 'restart'.\nThis can cause merge-config doesn't restart service as expected.", "committedDate": "2020-03-13T19:12:28Z", "type": "forcePushed"}, {"oid": "a9d49488a9474c8d21acf59da8c6494808b302d8", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a9d49488a9474c8d21acf59da8c6494808b302d8", "message": "Refine deduplicating logic in lifecycle change requests.\n\nWhen a service receives restart and start in sequence, 'start' may override the 'restart'.\nThis can cause merge-config doesn't restart service as expected.", "committedDate": "2020-03-13T19:15:32Z", "type": "forcePushed"}, {"oid": "f992c80775fb9e166eda0e864e146a9a8f5b2728", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f992c80775fb9e166eda0e864e146a9a8f5b2728", "message": "Refine deduplicating logic in lifecycle change requests.\n\nWhen a service receives restart and start in sequence, 'start' may override the 'restart'.\nThis can cause merge-config doesn't restart service as expected.", "committedDate": "2020-03-16T19:15:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzI1OTg5Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#discussion_r393259892", "bodyText": "How about a blocking queue instead of wait/notify? Since we have a list of actions to perform anyway.", "author": "MikeDombo", "createdAt": "2020-03-16T19:22:24Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/UpdateSystemSafelyService.java", "diffHunk": "@@ -59,8 +59,8 @@ public void removeDisruptableCheck(DisruptableCheck d) {\n     public synchronized void addUpdateAction(String tag, Crashable action) {\n         pendingActions.put(tag, action);\n         logger.atDebug().setEventType(\"register-service-update-action\").addKeyValue(\"action\", tag).log();\n-        if (!isPeriodic()) {\n-            requestStart();\n+        synchronized (pendingActions) {", "originalCommit": "f992c80775fb9e166eda0e864e146a9a8f5b2728", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "276539e1146220454e73b92355b20c3a1c0a2c91", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/276539e1146220454e73b92355b20c3a1c0a2c91", "message": "Refine deduplicating logic in lifecycle change requests.\n\nWhen a service receives restart and start in sequence, 'start' may override the 'restart'.\nThis can cause merge-config doesn't restart service as expected.", "committedDate": "2020-03-16T19:27:03Z", "type": "forcePushed"}, {"oid": "1e2f186de35b3eefa3e8ad4038d487f4f8d3d9b9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1e2f186de35b3eefa3e8ad4038d487f4f8d3d9b9", "message": "Refine deduplicating logic in lifecycle change requests.\n\nWhen a service receives restart and start in sequence, 'start' may override the 'restart'.\nThis can cause merge-config doesn't restart service as expected.", "committedDate": "2020-03-16T19:27:29Z", "type": "commit"}, {"oid": "1e2f186de35b3eefa3e8ad4038d487f4f8d3d9b9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1e2f186de35b3eefa3e8ad4038d487f4f8d3d9b9", "message": "Refine deduplicating logic in lifecycle change requests.\n\nWhen a service receives restart and start in sequence, 'start' may override the 'restart'.\nThis can cause merge-config doesn't restart service as expected.", "committedDate": "2020-03-16T19:27:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkwMDk0Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#discussion_r393900946", "bodyText": "I know EvergreenService class is special but I still think we should avoid testing with checking an private field. As Jamie said,\n\nplease don\u2019t write unit tests that are \u201cIs the code implemented this way\u201d.\n\nChecking a private field basically makes the code needs to be implemented in a very particular way.\nMoreover, changing the content of a private field during the test actually changes the logic of real code, which defeats the purpose of unit test...", "author": "leaf94", "createdAt": "2020-03-17T18:54:22Z", "path": "src/test/java/com/aws/iot/evergreen/kernel/RequestLifecycleChangeTest.java", "diffHunk": "@@ -0,0 +1,176 @@\n+package com.aws.iot.evergreen.kernel;\n+\n+import java.lang.reflect.Field;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+import com.aws.iot.evergreen.config.Topic;\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.dependency.Context;\n+import com.aws.iot.evergreen.dependency.State;\n+import com.aws.iot.evergreen.testcommons.testutilities.EGServiceTestUtil;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.Assertions;\n+\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+@ExtendWith(MockitoExtension.class)\n+public class RequestLifecycleChangeTest extends EGServiceTestUtil {\n+\n+    private EvergreenService evergreenService;\n+\n+    private static Field desiredStateListField;\n+    private List<State> desiredStateList;\n+\n+    @BeforeAll\n+    public static void setup() throws Exception {\n+        desiredStateListField = EvergreenService.class.getDeclaredField(\"desiredStateList\");\n+        desiredStateListField.setAccessible(true);\n+    }", "originalCommit": "1e2f186de35b3eefa3e8ad4038d487f4f8d3d9b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkyNDQ5MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#discussion_r393924491", "bodyText": "I agree with Ethan there. This test looks really fragile. Can we just write integration tests instead if unit tests are difficult to write. I much prefer integration tests than fragile unit tests.", "author": "fengwang666", "createdAt": "2020-03-17T19:39:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkwMDk0Ng=="}], "type": "inlineReview", "revised_code": null}]}