{"pr_number": 299, "pr_title": "Fix flaky integ test in DeploymentService mergeConfig", "pr_createdAt": "2020-07-08T20:48:19Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/299", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyMzUzMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/299#discussion_r451823533", "bodyText": "removeObsoleteServices() is blocking, by the time it returns the service removals would have taken place. why do we wait here then ?", "author": "fahadmohammed01", "createdAt": "2020-07-08T21:02:32Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentConfigMerger.java", "diffHunk": "@@ -202,8 +206,11 @@ private void rollback(String deploymentId, CompletableFuture<DeploymentResult> t\n                     waitForServicesToStart(servicesToTrackForRollback, mergeTime);\n \n                     servicesChangeManager.removeObsoleteServices();\n-                    logger.atInfo(MERGE_CONFIG_EVENT_KEY).kv(DEPLOYMENT_ID_LOG_KEY, deploymentId)\n+                    // block until service removal take place in kernel config\n+                    kernel.getContext().runOnPublishQueueAndWait(() -> {", "originalCommit": "3d7771b473fa9e5c5af790ce26f4eeec3b37836a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyNDgxMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/299#discussion_r451824812", "bodyText": "removeObsoleteServices() invokes Topics.remove(), but Topics.remove() isn't blocking. I can modify that Topics instead", "author": "ShirleyZheng92", "createdAt": "2020-07-08T21:05:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyMzUzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgzNjA5Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/299#discussion_r451836092", "bodyText": "I changed Topics.remove() so that node removal is synchronous. Node removal notification is still async and run on the publish queue", "author": "ShirleyZheng92", "createdAt": "2020-07-08T21:29:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyMzUzMw=="}], "type": "inlineReview", "revised_code": {"commit": "09525312fcc06fdadb9200a3b40ccded56f9ab78", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/deployment/DeploymentConfigMerger.java b/src/main/java/com/aws/iot/evergreen/deployment/DeploymentConfigMerger.java\nindex 959cece42..20b445a1a 100644\n--- a/src/main/java/com/aws/iot/evergreen/deployment/DeploymentConfigMerger.java\n+++ b/src/main/java/com/aws/iot/evergreen/deployment/DeploymentConfigMerger.java\n\n@@ -206,11 +202,8 @@ public class DeploymentConfigMerger {\n                     waitForServicesToStart(servicesToTrackForRollback, mergeTime);\n \n                     servicesChangeManager.removeObsoleteServices();\n-                    // block until service removal take place in kernel config\n-                    kernel.getContext().runOnPublishQueueAndWait(() -> {\n-                        logger.atInfo(MERGE_CONFIG_EVENT_KEY).kv(DEPLOYMENT_ID_LOG_KEY, deploymentId)\n+                    logger.atInfo(MERGE_CONFIG_EVENT_KEY).kv(DEPLOYMENT_ID_LOG_KEY, deploymentId)\n                             .log(\"All services rolled back\");\n-                    });\n \n                     cleanUpSnapshot(deploymentId);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyNzE2Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/299#discussion_r451827166", "bodyText": "How is this blocking on the service removal? This only waits for logging statements to finish. I think the previous tasks in the queue can be pulled out of the queue but still running.", "author": "abanthiy", "createdAt": "2020-07-08T21:10:13Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentConfigMerger.java", "diffHunk": "@@ -202,8 +206,11 @@ private void rollback(String deploymentId, CompletableFuture<DeploymentResult> t\n                     waitForServicesToStart(servicesToTrackForRollback, mergeTime);\n \n                     servicesChangeManager.removeObsoleteServices();\n-                    logger.atInfo(MERGE_CONFIG_EVENT_KEY).kv(DEPLOYMENT_ID_LOG_KEY, deploymentId)\n+                    // block until service removal take place in kernel config\n+                    kernel.getContext().runOnPublishQueueAndWait(() -> {", "originalCommit": "3d7771b473fa9e5c5af790ce26f4eeec3b37836a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "09525312fcc06fdadb9200a3b40ccded56f9ab78", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/deployment/DeploymentConfigMerger.java b/src/main/java/com/aws/iot/evergreen/deployment/DeploymentConfigMerger.java\nindex 959cece42..20b445a1a 100644\n--- a/src/main/java/com/aws/iot/evergreen/deployment/DeploymentConfigMerger.java\n+++ b/src/main/java/com/aws/iot/evergreen/deployment/DeploymentConfigMerger.java\n\n@@ -206,11 +202,8 @@ public class DeploymentConfigMerger {\n                     waitForServicesToStart(servicesToTrackForRollback, mergeTime);\n \n                     servicesChangeManager.removeObsoleteServices();\n-                    // block until service removal take place in kernel config\n-                    kernel.getContext().runOnPublishQueueAndWait(() -> {\n-                        logger.atInfo(MERGE_CONFIG_EVENT_KEY).kv(DEPLOYMENT_ID_LOG_KEY, deploymentId)\n+                    logger.atInfo(MERGE_CONFIG_EVENT_KEY).kv(DEPLOYMENT_ID_LOG_KEY, deploymentId)\n                             .log(\"All services rolled back\");\n-                    });\n \n                     cleanUpSnapshot(deploymentId);\n \n"}}, {"oid": "09525312fcc06fdadb9200a3b40ccded56f9ab78", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/09525312fcc06fdadb9200a3b40ccded56f9ab78", "message": "Fix flaky integ test in DeploymentService mergeConfig", "committedDate": "2020-07-08T21:16:51Z", "type": "forcePushed"}, {"oid": "f3980eb85b1c2f082fcfad51f060a03d85674d4b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f3980eb85b1c2f082fcfad51f060a03d85674d4b", "message": "Fix flaky integ test in DeploymentService mergeConfig", "committedDate": "2020-07-08T21:28:32Z", "type": "commit"}, {"oid": "f3980eb85b1c2f082fcfad51f060a03d85674d4b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f3980eb85b1c2f082fcfad51f060a03d85674d4b", "message": "Fix flaky integ test in DeploymentService mergeConfig", "committedDate": "2020-07-08T21:28:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgzNzY1Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/299#discussion_r451837653", "bodyText": "when can this happen?", "author": "MikeDombo", "createdAt": "2020-07-08T21:32:43Z", "path": "src/main/java/com/aws/iot/evergreen/config/Topics.java", "diffHunk": "@@ -250,12 +250,12 @@ public void deepForEachTopic(Consumer<Topic> f) {\n      * @param n node to remove\n      */\n     public void remove(Node n) {\n+        if (!children.remove(n.getName(), n)) {", "originalCommit": "f3980eb85b1c2f082fcfad51f060a03d85674d4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTg3Mjg3NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/299#discussion_r451872875", "bodyText": "This doesn't need to happen in the publish queue. Node will be removed immediately when remove() called, but publish notification is run async in the publish queue.\nIt's the similar approach in Topic.withNewerValue(), where newer value is set immediately, while fire notification is run async in the publish queue.", "author": "ShirleyZheng92", "createdAt": "2020-07-08T23:06:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgzNzY1Mw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgzNzkzNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/299#discussion_r451837936", "bodyText": "this comment doesn't seem accurate anymore.", "author": "MikeDombo", "createdAt": "2020-07-08T21:33:28Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentConfigMerger.java", "diffHunk": "@@ -189,7 +189,7 @@ private void rollback(String deploymentId, CompletableFuture<DeploymentResult> t\n             return;\n         }\n         // wait until topic listeners finished processing read changes.", "originalCommit": "f3980eb85b1c2f082fcfad51f060a03d85674d4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTg3Mzc5NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/299#discussion_r451873795", "bodyText": "The comment still applies because we run the following code in publish queue, so that we ensure it's executed after config changes are merged and listeners are triggered", "author": "ShirleyZheng92", "createdAt": "2020-07-08T23:09:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgzNzkzNg=="}], "type": "inlineReview", "revised_code": null}]}