{"pr_number": 163, "pr_title": "Transition to BROKEN if a service ERRORED three times consecutively", "pr_createdAt": "2020-04-07T18:04:42Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/163", "timeline": [{"oid": "1cafd59cb7336354073a0e14c4c00c7ce97a1e51", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1cafd59cb7336354073a0e14c4c00c7ce97a1e51", "message": "Transition to BROKEN if a service ERRORED three times consecutively\n\nThe service will be put in BROKEN state if a state transition is errored\nfor three times consecutively.`", "committedDate": "2020-04-07T17:52:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAxMDg3NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/163#discussion_r405010875", "bodyText": "this won't prove that it is restarted since this will trigger on the first time the service boots.", "author": "MikeDombo", "createdAt": "2020-04-07T18:07:40Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java", "diffHunk": "@@ -133,6 +133,74 @@ private void testGroup(int group) throws Exception {\n         }\n     }\n \n+    @Test\n+    void GIVEN_service_install_always_fail_WHEN_kernel_launches_THEN_service_go_broken_state() throws Exception {\n+        Kernel kernel = new Kernel();\n+        kernel.parseArgs(\"-i\", getClass().getResource(\"config_install_error.yaml\").toString());\n+        kernel.launch();\n+\n+        CountDownLatch serviceBroken = new CountDownLatch(1);\n+        // Check that new_service starts and then main gets restarted\n+        kernel.context.addGlobalStateChangeListener((service, oldState, newState) -> {\n+            if (service.getName().equals(\"installerror\") && newState.equals(State.BROKEN)) {\n+                serviceBroken.countDown();\n+            }\n+        });\n+        assertTrue(serviceBroken.await(60, TimeUnit.SECONDS));\n+        kernel.shutdown();\n+    }\n+\n+    @Test\n+    void GIVEN_service_install_fail_retry_succeed_WHEN_kernel_launches_THEN_service_install_succeeds() throws Exception {\n+        Kernel kernel = new Kernel();\n+        kernel.parseArgs(\"-i\", getClass().getResource(\"config_install_error_retry.yaml\").toString());\n+        kernel.launch();\n+\n+        CountDownLatch serviceRunning = new CountDownLatch(1);\n+        // Check that new_service starts and then main gets restarted\n+        kernel.context.addGlobalStateChangeListener((service, oldState, newState) -> {", "originalCommit": "1cafd59cb7336354073a0e14c4c00c7ce97a1e51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA1MTU5NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/163#discussion_r405051594", "bodyText": "First time the service boots, the install script exits 1 and the install will fail.", "author": "fengwang666", "createdAt": "2020-04-07T19:15:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAxMDg3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA1MzEwMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/163#discussion_r405053103", "bodyText": "Can you change the comment then?", "author": "MikeDombo", "createdAt": "2020-04-07T19:18:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAxMDg3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA3MzY4Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/163#discussion_r405073687", "bodyText": "My bad. I copied and pasted that comment. I'll remove it.", "author": "fengwang666", "createdAt": "2020-04-07T19:55:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAxMDg3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "6bc701651c94472d7d0167c0afbf65df27a8124f", "chunk": "diff --git a/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java b/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java\nindex ddeffb18bf..cdb397becb 100644\n--- a/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java\n+++ b/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java\n\n@@ -140,7 +140,6 @@ class KernelTest extends BaseITCase {\n         kernel.launch();\n \n         CountDownLatch serviceBroken = new CountDownLatch(1);\n-        // Check that new_service starts and then main gets restarted\n         kernel.context.addGlobalStateChangeListener((service, oldState, newState) -> {\n             if (service.getName().equals(\"installerror\") && newState.equals(State.BROKEN)) {\n                 serviceBroken.countDown();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAxMTQwNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/163#discussion_r405011406", "bodyText": "these shutdowns won't happen in the event that the assertion fails.", "author": "MikeDombo", "createdAt": "2020-04-07T18:08:33Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java", "diffHunk": "@@ -133,6 +133,74 @@ private void testGroup(int group) throws Exception {\n         }\n     }\n \n+    @Test\n+    void GIVEN_service_install_always_fail_WHEN_kernel_launches_THEN_service_go_broken_state() throws Exception {\n+        Kernel kernel = new Kernel();\n+        kernel.parseArgs(\"-i\", getClass().getResource(\"config_install_error.yaml\").toString());\n+        kernel.launch();\n+\n+        CountDownLatch serviceBroken = new CountDownLatch(1);\n+        // Check that new_service starts and then main gets restarted\n+        kernel.context.addGlobalStateChangeListener((service, oldState, newState) -> {\n+            if (service.getName().equals(\"installerror\") && newState.equals(State.BROKEN)) {\n+                serviceBroken.countDown();\n+            }\n+        });\n+        assertTrue(serviceBroken.await(60, TimeUnit.SECONDS));\n+        kernel.shutdown();\n+    }\n+\n+    @Test\n+    void GIVEN_service_install_fail_retry_succeed_WHEN_kernel_launches_THEN_service_install_succeeds() throws Exception {\n+        Kernel kernel = new Kernel();\n+        kernel.parseArgs(\"-i\", getClass().getResource(\"config_install_error_retry.yaml\").toString());\n+        kernel.launch();\n+\n+        CountDownLatch serviceRunning = new CountDownLatch(1);\n+        // Check that new_service starts and then main gets restarted\n+        kernel.context.addGlobalStateChangeListener((service, oldState, newState) -> {\n+            if (service.getName().equals(\"installErrorRetry\") && newState.equals(State.INSTALLED)) {\n+                serviceRunning.countDown();\n+            }\n+        });\n+        assertTrue(serviceRunning.await(60, TimeUnit.SECONDS));\n+        kernel.shutdown();\n+    }\n+\n+    @Test\n+    void GIVEN_service_startup_always_fail_WHEN_kernel_launches_THEN_service_go_broken_state() throws Exception {\n+        Kernel kernel = new Kernel();\n+        kernel.parseArgs(\"-i\", getClass().getResource(\"config_startup_error.yaml\").toString());\n+        kernel.launch();\n+\n+        CountDownLatch serviceBroken = new CountDownLatch(1);\n+        // Check that new_service starts and then main gets restarted\n+        kernel.context.addGlobalStateChangeListener((service, oldState, newState) -> {\n+            if (service.getName().equals(\"startupError\") && newState.equals(State.BROKEN)) {\n+                serviceBroken.countDown();\n+            }\n+        });\n+        assertTrue(serviceBroken.await(60, TimeUnit.SECONDS));\n+        kernel.shutdown();\n+    }\n+\n+    @Test\n+    void GIVEN_service_startup_fail_retry_succeed_WHEN_kernel_launches_THEN_service_startup_succeeds() throws Exception {\n+        Kernel kernel = new Kernel();\n+        kernel.parseArgs(\"-i\", getClass().getResource(\"config_startup_error_retry.yaml\").toString());\n+        kernel.launch();\n+\n+        CountDownLatch serviceRunning = new CountDownLatch(1);\n+        // Check that new_service starts and then main gets restarted\n+        kernel.context.addGlobalStateChangeListener((service, oldState, newState) -> {\n+            if (service.getName().equals(\"startupErrorRetry\") && newState.equals(State.RUNNING)) {\n+                serviceRunning.countDown();\n+            }\n+        });\n+        assertTrue(serviceRunning.await(60, TimeUnit.SECONDS));\n+        kernel.shutdown();", "originalCommit": "1cafd59cb7336354073a0e14c4c00c7ce97a1e51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA1MTkyNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/163#discussion_r405051924", "bodyText": "Sure, but does it actually matter in this case even if we don't call shutdown?", "author": "fengwang666", "createdAt": "2020-04-07T19:16:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAxMTQwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA1MzM1MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/163#discussion_r405053350", "bodyText": "Perhaps not a big deal, but there will be a running kernel sticking around AFAIK.", "author": "MikeDombo", "createdAt": "2020-04-07T19:18:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAxMTQwNg=="}], "type": "inlineReview", "revised_code": {"commit": "6bc701651c94472d7d0167c0afbf65df27a8124f", "chunk": "diff --git a/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java b/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java\nindex ddeffb18bf..cdb397becb 100644\n--- a/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java\n+++ b/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java\n\n@@ -140,7 +140,6 @@ class KernelTest extends BaseITCase {\n         kernel.launch();\n \n         CountDownLatch serviceBroken = new CountDownLatch(1);\n-        // Check that new_service starts and then main gets restarted\n         kernel.context.addGlobalStateChangeListener((service, oldState, newState) -> {\n             if (service.getName().equals(\"installerror\") && newState.equals(State.BROKEN)) {\n                 serviceBroken.countDown();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAxMjE2Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/163#discussion_r405012166", "bodyText": "I think we're going to want something smarter than this, specifically to track the time of the errors so we can say: if it errored 5 times in 10 minutes, then consider it broken. And things like that.", "author": "MikeDombo", "createdAt": "2020-04-07T18:09:49Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -67,6 +67,12 @@\n     private State prevState = State.NEW;\n     private Future<?> lifecycleFuture;\n     private final AtomicBoolean isClosed = new AtomicBoolean(false);\n+    // The number of continual occurrences from a state to ERRORED.\n+    // This is not thread safe and should only be used inside reportState().\n+    private Map<State, Integer> stateToErroredCount = new HashMap<>();", "originalCommit": "1cafd59cb7336354073a0e14c4c00c7ce97a1e51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA1MDExNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/163#discussion_r405050116", "bodyText": "I thought about that but am not sure that's desired. Using a time period as a condition wouldn't be very robust because a slow device can take much longer to transition state than a fast device. Plus we already have timeout for each steps, adding another time condition seems unnecessary.", "author": "fengwang666", "createdAt": "2020-04-07T19:13:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAxMjE2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "635b583a65e8b247e6bf8d4f5dafb27c456b6d81", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java b/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\nindex c58cc06c61..25ca07b214 100644\n--- a/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\n+++ b/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\n\n@@ -54,15 +52,23 @@ public class EvergreenService implements InjectionActions {\n     public static final String SERVICES_NAMESPACE_TOPIC = \"services\";\n     public static final String SERVICE_LIFECYCLE_NAMESPACE_TOPIC = \"lifecycle\";\n     public static final String SERVICE_NAME_KEY = \"serviceName\";\n-\n-    public final Topics config;\n+    public static final String LIFECYCLE_INSTALL_NAMESPACE_TOPIC = \"install\";\n+    public static final String LIFECYCLE_STARTUP_NAMESPACE_TOPIC = \"startup\";\n+    public static final String TIMEOUT_NAMESPACE_TOPIC = \"timeout\";\n+    public static final Integer DEFAULT_INSTALL_STAGE_TIMEOUT_IN_SEC = 120;\n+    public static final Integer DEFAULT_STARTUP_STAGE_TIMEOUT_IN_SEC = 120;\n+    private static final String CURRENT_STATE_METRIC_NAME = \"currentState\";\n+    private static final String INVALID_STATE_ERROR_EVENT = \"service-invalid-state-error\";\n+\n+    protected final Topics config;\n     public Context context;\n \n     private final Object dependencyReadyLock = new Object();\n     private final Object dependersExitedLock = new Object();\n     private final Topic state;\n     private Throwable error;\n-    private Future backingTask;\n+    private Future backingTask = CompletableFuture.completedFuture(null);\n+    private String backingTaskName;\n     private Periodicity periodicityInformation;\n     private State prevState = State.NEW;\n     private Future<?> lifecycleFuture;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA1MjcxMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/163#discussion_r405052711", "bodyText": "How is this working given that it appears to reset with any state which isn't errored? If the services goes from errored, then it will restart, so it will transition to installed (which would clear the error count), then it goes to running, then errored again.", "author": "MikeDombo", "createdAt": "2020-04-07T19:17:54Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -158,8 +164,17 @@ public synchronized void reportState(State newState) {\n             // if a service doesn't have any run logic, request stop on service to clean up DesiredStateList\n             requestStop();\n         }\n-\n-        enqueueStateEvent(newState);\n+        State currentState = getState();\n+        if (State.ERRORED.equals(newState)) {\n+            stateToErroredCount.compute(currentState, (k, v) -> (v == null) ? 1 : v + 1);\n+        } else {\n+            stateToErroredCount.put(currentState, 0);", "originalCommit": "1cafd59cb7336354073a0e14c4c00c7ce97a1e51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA1NDU0NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/163#discussion_r405054544", "bodyText": "I think I understand since \"INSTALLED\" is not reported, right? We just directly transition to it. This does seem a bit brittle though.", "author": "MikeDombo", "createdAt": "2020-04-07T19:21:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA1MjcxMQ=="}], "type": "inlineReview", "revised_code": {"commit": "6bc701651c94472d7d0167c0afbf65df27a8124f", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java b/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\nindex c58cc06c61..1c81414abe 100644\n--- a/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\n+++ b/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\n\n@@ -165,9 +166,15 @@ public class EvergreenService implements InjectionActions {\n             requestStop();\n         }\n         State currentState = getState();\n-        if (State.ERRORED.equals(newState)) {\n+        // We only need to track the ERROR for the state transition starting from NEW, INSTALLED and RUNNING because\n+        // these states impact whether the service can function as expected.\n+        List<State> statesToTrack = Arrays.asList(State.NEW, State.INSTALLED, State.RUNNING);\n+        if (State.ERRORED.equals(newState) && statesToTrack.contains(currentState)) {\n+            // If the reported state is ERRORED, we'll increase the ERROR counter for the current state.\n             stateToErroredCount.compute(currentState, (k, v) -> (v == null) ? 1 : v + 1);\n         } else {\n+            // If the reported state is a non-ERRORED state, we would like to reset the ERROR counter for the current\n+            // state. This is to avoid putting the service to BROKEN state because of transient issues.\n             stateToErroredCount.put(currentState, 0);\n         }\n         if (stateToErroredCount.get(currentState) > MAXIMUM_CONTINUAL_ERROR) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE2MTgyNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/163#discussion_r405161825", "bodyText": "Do we want to ensure that the can move to installed after it error-ed in the previous attempt\nsomething like :\nhttps://github.com/aws/aws-greengrass-kernel/blob/master/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelShutdownTest.java#L30", "author": "fahadmohammed01", "createdAt": "2020-04-07T22:57:56Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java", "diffHunk": "@@ -133,6 +133,74 @@ private void testGroup(int group) throws Exception {\n         }\n     }\n \n+    @Test\n+    void GIVEN_service_install_always_fail_WHEN_kernel_launches_THEN_service_go_broken_state() throws Exception {\n+        Kernel kernel = new Kernel();\n+        kernel.parseArgs(\"-i\", getClass().getResource(\"config_install_error.yaml\").toString());\n+        kernel.launch();\n+\n+        CountDownLatch serviceBroken = new CountDownLatch(1);\n+        // Check that new_service starts and then main gets restarted\n+        kernel.context.addGlobalStateChangeListener((service, oldState, newState) -> {\n+            if (service.getName().equals(\"installerror\") && newState.equals(State.BROKEN)) {\n+                serviceBroken.countDown();\n+            }\n+        });\n+        assertTrue(serviceBroken.await(60, TimeUnit.SECONDS));\n+        kernel.shutdown();\n+    }\n+\n+    @Test\n+    void GIVEN_service_install_fail_retry_succeed_WHEN_kernel_launches_THEN_service_install_succeeds() throws Exception {\n+        Kernel kernel = new Kernel();\n+        kernel.parseArgs(\"-i\", getClass().getResource(\"config_install_error_retry.yaml\").toString());\n+        kernel.launch();\n+\n+        CountDownLatch serviceRunning = new CountDownLatch(1);\n+        // Check that new_service starts and then main gets restarted\n+        kernel.context.addGlobalStateChangeListener((service, oldState, newState) -> {\n+            if (service.getName().equals(\"installErrorRetry\") && newState.equals(State.INSTALLED)) {", "originalCommit": "1cafd59cb7336354073a0e14c4c00c7ce97a1e51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM2NjUxOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/163#discussion_r406366519", "bodyText": "GIVEN_service_install_fail_retry_succeed_WHEN_kernel_launches_THEN_service_install_succeeds is the test case for that.", "author": "fengwang666", "createdAt": "2020-04-09T17:36:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE2MTgyNQ=="}], "type": "inlineReview", "revised_code": {"commit": "6bc701651c94472d7d0167c0afbf65df27a8124f", "chunk": "diff --git a/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java b/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java\nindex ddeffb18bf..cdb397becb 100644\n--- a/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java\n+++ b/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java\n\n@@ -140,7 +140,6 @@ class KernelTest extends BaseITCase {\n         kernel.launch();\n \n         CountDownLatch serviceBroken = new CountDownLatch(1);\n-        // Check that new_service starts and then main gets restarted\n         kernel.context.addGlobalStateChangeListener((service, oldState, newState) -> {\n             if (service.getName().equals(\"installerror\") && newState.equals(State.BROKEN)) {\n                 serviceBroken.countDown();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE2MzgwMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/163#discussion_r405163801", "bodyText": "do we want to move the service to broken state in the below scenario\nservice does not handle shutdown properly and kernel always kills the service using SIGKILL. When the service is asked to move to finished state (during shutdown), it will error and the counter is incremented. The service will be marked as broken the third time the service is shutdown.", "author": "fahadmohammed01", "createdAt": "2020-04-07T23:03:18Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -158,8 +164,17 @@ public synchronized void reportState(State newState) {\n             // if a service doesn't have any run logic, request stop on service to clean up DesiredStateList\n             requestStop();\n         }\n-\n-        enqueueStateEvent(newState);\n+        State currentState = getState();\n+        if (State.ERRORED.equals(newState)) {\n+            stateToErroredCount.compute(currentState, (k, v) -> (v == null) ? 1 : v + 1);", "originalCommit": "1cafd59cb7336354073a0e14c4c00c7ce97a1e51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM2NTE2Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/163#discussion_r406365166", "bodyText": "Good point. I exclude \"STOPPING\" from the count map.", "author": "fengwang666", "createdAt": "2020-04-09T17:34:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE2MzgwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "6bc701651c94472d7d0167c0afbf65df27a8124f", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java b/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\nindex c58cc06c61..1c81414abe 100644\n--- a/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\n+++ b/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\n\n@@ -165,9 +166,15 @@ public class EvergreenService implements InjectionActions {\n             requestStop();\n         }\n         State currentState = getState();\n-        if (State.ERRORED.equals(newState)) {\n+        // We only need to track the ERROR for the state transition starting from NEW, INSTALLED and RUNNING because\n+        // these states impact whether the service can function as expected.\n+        List<State> statesToTrack = Arrays.asList(State.NEW, State.INSTALLED, State.RUNNING);\n+        if (State.ERRORED.equals(newState) && statesToTrack.contains(currentState)) {\n+            // If the reported state is ERRORED, we'll increase the ERROR counter for the current state.\n             stateToErroredCount.compute(currentState, (k, v) -> (v == null) ? 1 : v + 1);\n         } else {\n+            // If the reported state is a non-ERRORED state, we would like to reset the ERROR counter for the current\n+            // state. This is to avoid putting the service to BROKEN state because of transient issues.\n             stateToErroredCount.put(currentState, 0);\n         }\n         if (stateToErroredCount.get(currentState) > MAXIMUM_CONTINUAL_ERROR) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4ODc5OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/163#discussion_r405188799", "bodyText": "Need a test for getting out of broken state.", "author": "MikeDombo", "createdAt": "2020-04-08T00:22:44Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java", "diffHunk": "@@ -133,6 +133,74 @@ private void testGroup(int group) throws Exception {\n         }\n     }\n \n+    @Test\n+    void GIVEN_service_install_always_fail_WHEN_kernel_launches_THEN_service_go_broken_state() throws Exception {\n+        Kernel kernel = new Kernel();\n+        kernel.parseArgs(\"-i\", getClass().getResource(\"config_install_error.yaml\").toString());\n+        kernel.launch();\n+\n+        CountDownLatch serviceBroken = new CountDownLatch(1);\n+        // Check that new_service starts and then main gets restarted\n+        kernel.context.addGlobalStateChangeListener((service, oldState, newState) -> {\n+            if (service.getName().equals(\"installerror\") && newState.equals(State.BROKEN)) {\n+                serviceBroken.countDown();\n+            }\n+        });\n+        assertTrue(serviceBroken.await(60, TimeUnit.SECONDS));\n+        kernel.shutdown();\n+    }\n+\n+    @Test\n+    void GIVEN_service_install_fail_retry_succeed_WHEN_kernel_launches_THEN_service_install_succeeds() throws Exception {\n+        Kernel kernel = new Kernel();\n+        kernel.parseArgs(\"-i\", getClass().getResource(\"config_install_error_retry.yaml\").toString());\n+        kernel.launch();\n+\n+        CountDownLatch serviceRunning = new CountDownLatch(1);\n+        // Check that new_service starts and then main gets restarted\n+        kernel.context.addGlobalStateChangeListener((service, oldState, newState) -> {\n+            if (service.getName().equals(\"installErrorRetry\") && newState.equals(State.INSTALLED)) {\n+                serviceRunning.countDown();\n+            }\n+        });\n+        assertTrue(serviceRunning.await(60, TimeUnit.SECONDS));\n+        kernel.shutdown();\n+    }\n+\n+    @Test\n+    void GIVEN_service_startup_always_fail_WHEN_kernel_launches_THEN_service_go_broken_state() throws Exception {\n+        Kernel kernel = new Kernel();\n+        kernel.parseArgs(\"-i\", getClass().getResource(\"config_startup_error.yaml\").toString());\n+        kernel.launch();\n+\n+        CountDownLatch serviceBroken = new CountDownLatch(1);\n+        // Check that new_service starts and then main gets restarted\n+        kernel.context.addGlobalStateChangeListener((service, oldState, newState) -> {\n+            if (service.getName().equals(\"startupError\") && newState.equals(State.BROKEN)) {\n+                serviceBroken.countDown();\n+            }\n+        });\n+        assertTrue(serviceBroken.await(60, TimeUnit.SECONDS));\n+        kernel.shutdown();\n+    }\n+\n+    @Test\n+    void GIVEN_service_startup_fail_retry_succeed_WHEN_kernel_launches_THEN_service_startup_succeeds() throws Exception {\n+        Kernel kernel = new Kernel();\n+        kernel.parseArgs(\"-i\", getClass().getResource(\"config_startup_error_retry.yaml\").toString());\n+        kernel.launch();\n+\n+        CountDownLatch serviceRunning = new CountDownLatch(1);\n+        // Check that new_service starts and then main gets restarted\n+        kernel.context.addGlobalStateChangeListener((service, oldState, newState) -> {\n+            if (service.getName().equals(\"startupErrorRetry\") && newState.equals(State.RUNNING)) {\n+                serviceRunning.countDown();\n+            }\n+        });\n+        assertTrue(serviceRunning.await(60, TimeUnit.SECONDS));\n+        kernel.shutdown();\n+    }\n+", "originalCommit": "1cafd59cb7336354073a0e14c4c00c7ce97a1e51", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6bc701651c94472d7d0167c0afbf65df27a8124f", "chunk": "diff --git a/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java b/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java\nindex ddeffb18bf..cdb397becb 100644\n--- a/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java\n+++ b/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java\n\n@@ -140,7 +140,6 @@ class KernelTest extends BaseITCase {\n         kernel.launch();\n \n         CountDownLatch serviceBroken = new CountDownLatch(1);\n-        // Check that new_service starts and then main gets restarted\n         kernel.context.addGlobalStateChangeListener((service, oldState, newState) -> {\n             if (service.getName().equals(\"installerror\") && newState.equals(State.BROKEN)) {\n                 serviceBroken.countDown();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIwNDE5OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/163#discussion_r405204198", "bodyText": "In the code of error handling (when currentStatus is ERROR, the error handling will restart the service by immediately transition service state to INSTALLED) , therefore service go into ERROR state consecutively is very rare", "author": "ShirleyZheng92", "createdAt": "2020-04-08T01:19:35Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -158,8 +164,17 @@ public synchronized void reportState(State newState) {\n             // if a service doesn't have any run logic, request stop on service to clean up DesiredStateList\n             requestStop();\n         }\n-\n-        enqueueStateEvent(newState);\n+        State currentState = getState();\n+        if (State.ERRORED.equals(newState)) {\n+            stateToErroredCount.compute(currentState, (k, v) -> (v == null) ? 1 : v + 1);\n+        } else {\n+            stateToErroredCount.put(currentState, 0);", "originalCommit": "1cafd59cb7336354073a0e14c4c00c7ce97a1e51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMwODU5OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/163#discussion_r406308598", "bodyText": "It's consecutively transition of State -> ERROR.", "author": "fengwang666", "createdAt": "2020-04-09T15:58:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIwNDE5OA=="}], "type": "inlineReview", "revised_code": {"commit": "6bc701651c94472d7d0167c0afbf65df27a8124f", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java b/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\nindex c58cc06c61..1c81414abe 100644\n--- a/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\n+++ b/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\n\n@@ -165,9 +166,15 @@ public class EvergreenService implements InjectionActions {\n             requestStop();\n         }\n         State currentState = getState();\n-        if (State.ERRORED.equals(newState)) {\n+        // We only need to track the ERROR for the state transition starting from NEW, INSTALLED and RUNNING because\n+        // these states impact whether the service can function as expected.\n+        List<State> statesToTrack = Arrays.asList(State.NEW, State.INSTALLED, State.RUNNING);\n+        if (State.ERRORED.equals(newState) && statesToTrack.contains(currentState)) {\n+            // If the reported state is ERRORED, we'll increase the ERROR counter for the current state.\n             stateToErroredCount.compute(currentState, (k, v) -> (v == null) ? 1 : v + 1);\n         } else {\n+            // If the reported state is a non-ERRORED state, we would like to reset the ERROR counter for the current\n+            // state. This is to avoid putting the service to BROKEN state because of transient issues.\n             stateToErroredCount.put(currentState, 0);\n         }\n         if (stateToErroredCount.get(currentState) > MAXIMUM_CONTINUAL_ERROR) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIwNDc1Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/163#discussion_r405204752", "bodyText": "I personally don't like the idea of change reported state in reportState(). In that case, every place where you need to handle ERROR you need to handle BROKEN as well", "author": "ShirleyZheng92", "createdAt": "2020-04-08T01:21:40Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -452,6 +468,8 @@ private void startStateTransition() throws InterruptedException {\n                     State reportState = getReportState().orElse(null);\n                     if (State.ERRORED.equals(reportState) || !ok) {\n                         updateStateAndBroadcast(State.ERRORED);\n+                    } else if (State.BROKEN.equals(reportState)) {", "originalCommit": "1cafd59cb7336354073a0e14c4c00c7ce97a1e51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMwOTg0Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/163#discussion_r406309846", "bodyText": "Why is that the case? reportState() is the place where we know, for each current state, how many consecutive ERROR have occurred during the state transition.", "author": "fengwang666", "createdAt": "2020-04-09T16:00:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIwNDc1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQwNjc4OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/163#discussion_r406406789", "bodyText": "You can also set the state in error handling part, where current state is ERROR.\nOne race condition I can think of, is if a service reportError multiple times while running. If the lifecycle thread doesn't process the first ERROR state and the second ERROR comes in, this will be treated as 'consecutive failures'", "author": "ShirleyZheng92", "createdAt": "2020-04-09T18:47:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIwNDc1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ1MzIzMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/163#discussion_r406453232", "bodyText": "It won't work if the error is transient and random. I put the logic in reportState() so that we can clear the error count if the retry of the transition succeeds.", "author": "fengwang666", "createdAt": "2020-04-09T20:17:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIwNDc1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "635b583a65e8b247e6bf8d4f5dafb27c456b6d81", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java b/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\nindex c58cc06c61..25ca07b214 100644\n--- a/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\n+++ b/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\n\n@@ -463,8 +390,11 @@ public class EvergreenService implements InjectionActions {\n                         }\n                     }, \"install\");\n \n-                    // TODO: Configurable timeout logic.\n-                    boolean ok = installLatch.await(120, TimeUnit.SECONDS);\n+                    Topic installTimeOutTopic = config.find(SERVICE_LIFECYCLE_NAMESPACE_TOPIC,\n+                            LIFECYCLE_INSTALL_NAMESPACE_TOPIC, TIMEOUT_NAMESPACE_TOPIC);\n+                    Integer installTimeOut = installTimeOutTopic == null\n+                            ? DEFAULT_INSTALL_STAGE_TIMEOUT_IN_SEC : (Integer) installTimeOutTopic.getOnce();\n+                    boolean ok = installLatch.await(installTimeOut, TimeUnit.SECONDS);\n                     State reportState = getReportState().orElse(null);\n                     if (State.ERRORED.equals(reportState) || !ok) {\n                         updateStateAndBroadcast(State.ERRORED);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY3MzUyMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/163#discussion_r405673521", "bodyText": "Nice, this fixes concurrent modification exceptions I saw while looking at flaky tests.", "author": "fahadmohammed01", "createdAt": "2020-04-08T16:57:25Z", "path": "src/main/java/com/aws/iot/evergreen/util/Exec.java", "diffHunk": "@@ -51,7 +51,7 @@\n     private static final File userdir = new File(System.getProperty(\"user.dir\"));\n     private static final File homedir = new File(System.getProperty(\"user.home\"));\n     @SuppressWarnings(\"PMD.LooseCoupling\")\n-    private static final LinkedList<Path> paths = new LinkedList<>();\n+    private static final ConcurrentLinkedDeque<Path> paths = new ConcurrentLinkedDeque<>();", "originalCommit": "1cafd59cb7336354073a0e14c4c00c7ce97a1e51", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "635b583a65e8b247e6bf8d4f5dafb27c456b6d81", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/util/Exec.java b/src/main/java/com/aws/iot/evergreen/util/Exec.java\nindex f6010ab543..848c351e91 100644\n--- a/src/main/java/com/aws/iot/evergreen/util/Exec.java\n+++ b/src/main/java/com/aws/iot/evergreen/util/Exec.java\n\n@@ -50,7 +50,7 @@ public final class Exec implements Closeable {\n     };\n     private static final File userdir = new File(System.getProperty(\"user.dir\"));\n     private static final File homedir = new File(System.getProperty(\"user.home\"));\n-    @SuppressWarnings(\"PMD.LooseCoupling\")\n+\n     private static final ConcurrentLinkedDeque<Path> paths = new ConcurrentLinkedDeque<>();\n     private static String[] defaultEnvironment = {\"PATH=\" + System.getenv(\"PATH\"), \"SHELL=\" + System.getenv(\"SHELL\"),\n             \"JAVA_HOME=\" + System.getProperty(\"java.home\"), \"USER=\" + System.getProperty(\"user.name\"),\n"}}, {"oid": "635b583a65e8b247e6bf8d4f5dafb27c456b6d81", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/635b583a65e8b247e6bf8d4f5dafb27c456b6d81", "message": "Merge branch 'master' into transit-error-to-broken", "committedDate": "2020-04-09T15:54:46Z", "type": "commit"}, {"oid": "b907ef3fd32f540cbdda8ab2a01461da4344529f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b907ef3fd32f540cbdda8ab2a01461da4344529f", "message": "Merge branch 'master' into transit-error-to-broken", "committedDate": "2020-04-09T18:11:53Z", "type": "commit"}, {"oid": "6bc701651c94472d7d0167c0afbf65df27a8124f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6bc701651c94472d7d0167c0afbf65df27a8124f", "message": "Get out of BROKEN state with an reinstall request`", "committedDate": "2020-04-09T18:12:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQwMTU5MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/163#discussion_r406401590", "bodyText": "This is not the merge that we use. We use kernel.mergeInNewConfig, I think you may want to use that instead since that is the code path used by a deployment.", "author": "MikeDombo", "createdAt": "2020-04-09T18:38:01Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java", "diffHunk": "@@ -133,6 +133,101 @@ private void testGroup(int group) throws Exception {\n         }\n     }\n \n+    @Test\n+    void GIVEN_service_install_always_fail_WHEN_kernel_launches_THEN_service_go_broken_state() throws Exception {\n+        Kernel kernel = new Kernel();\n+        kernel.parseArgs(\"-i\", getClass().getResource(\"config_install_error.yaml\").toString());\n+        kernel.launch();\n+\n+        CountDownLatch serviceBroken = new CountDownLatch(1);\n+        kernel.context.addGlobalStateChangeListener((service, oldState, newState) -> {\n+            if (service.getName().equals(\"installerror\") && newState.equals(State.BROKEN)) {\n+                serviceBroken.countDown();\n+            }\n+        });\n+        assertTrue(serviceBroken.await(60, TimeUnit.SECONDS));\n+        kernel.shutdown();\n+    }\n+\n+    @Test\n+    void GIVEN_service_install_broken_WHEN_kernel_launches_with_fix_THEN_service_install_succeeds() throws Exception {\n+        Kernel kernel = new Kernel();\n+        kernel.parseArgs(\"-i\", getClass().getResource(\"config_install_error.yaml\").toString());\n+        kernel.launch();\n+\n+        CountDownLatch serviceBroken = new CountDownLatch(1);\n+        kernel.context.addGlobalStateChangeListener((service, oldState, newState) -> {\n+            if (service.getName().equals(\"installerror\") && newState.equals(State.BROKEN)) {\n+                serviceBroken.countDown();\n+            }\n+        });\n+        assertTrue(serviceBroken.await(60, TimeUnit.SECONDS));\n+\n+        // merge in a new config that fixes the installation error\n+        kernel.read(kernel.deTilde(getClass().getResource(\"config_install_succeed_partial.yaml\").toString()));", "originalCommit": "6bc701651c94472d7d0167c0afbf65df27a8124f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ1NjIzMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/163#discussion_r406456232", "bodyText": "mergeInNewConfig doesn't have an interface for yaml file. I don't want to construct an object from yaml. I think the read() method is fine. We'll have a deployment test regardless.", "author": "fengwang666", "createdAt": "2020-04-09T20:24:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQwMTU5MA=="}], "type": "inlineReview", "revised_code": {"commit": "b079d870d6fa60c93054a77bce9ea9dfb4c403b7", "chunk": "diff --git a/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java b/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java\nindex cdb397becb..b51e3c6e31 100644\n--- a/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java\n+++ b/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java\n\n@@ -165,9 +165,6 @@ class KernelTest extends BaseITCase {\n \n         // merge in a new config that fixes the installation error\n         kernel.read(kernel.deTilde(getClass().getResource(\"config_install_succeed_partial.yaml\").toString()));\n-        // The above read() should already trigger a re-install through subscriber but there appears a bug in the code.\n-        // SIM: https://sim.amazon.com/issues/469c4bac-808a-4fe7-ae89-8546a55566d8\n-        kernel.context.get(EvergreenService.class, \"installerror\").requestReinstall();\n \n         CountDownLatch serviceInstalled = new CountDownLatch(1);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQwNTQ5Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/163#discussion_r406405497", "bodyText": "Bad merge, or are you adding this back explicitly?", "author": "MikeDombo", "createdAt": "2020-04-09T18:45:12Z", "path": "src/main/java/com/aws/iot/evergreen/config/Topic.java", "diffHunk": "@@ -120,10 +115,17 @@ public void fire(WhatHappened what) {\n                 .addKeyValue(\"reason\", what.name()).log();\n         if (watchers != null) {\n             for (Watcher s : watchers) {\n-                if (s instanceof Subscriber) {\n-                    ((Subscriber) s).published(what, this);\n+                try {\n+                    if (s instanceof Subscriber) {\n+                        ((Subscriber) s).published(what, this);\n+                    }\n+                } catch (Throwable ex) {", "originalCommit": "6bc701651c94472d7d0167c0afbf65df27a8124f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQyNDU5NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/163#discussion_r406424594", "bodyText": "bad merge....", "author": "fengwang666", "createdAt": "2020-04-09T19:21:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQwNTQ5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQyNTYwNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/163#discussion_r406425605", "bodyText": "Now I look again, why do we remove the try..catch?  Is it desired to skip all the rest of the watchers if one throws an exception?", "author": "fengwang666", "createdAt": "2020-04-09T19:24:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQwNTQ5Nw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQwNTk1MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/163#discussion_r406405950", "bodyText": "Extract statesToTrack as a static final, and use hashset.", "author": "MikeDombo", "createdAt": "2020-04-09T18:46:05Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -159,8 +165,23 @@ public synchronized void reportState(State newState) {\n             // if a service doesn't have any run logic, request stop on service to clean up DesiredStateList\n             requestStop();\n         }\n-\n-        enqueueStateEvent(newState);\n+        State currentState = getState();\n+        // We only need to track the ERROR for the state transition starting from NEW, INSTALLED and RUNNING because\n+        // these states impact whether the service can function as expected.\n+        List<State> statesToTrack = Arrays.asList(State.NEW, State.INSTALLED, State.RUNNING);", "originalCommit": "6bc701651c94472d7d0167c0afbf65df27a8124f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQyNjMyMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/163#discussion_r406426323", "bodyText": "I thought about using hashset but it's an array of three elements...not sure if it makes a difference. It's used locally so not sure about using static final.", "author": "fengwang666", "createdAt": "2020-04-09T19:25:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQwNTk1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQyOTU4OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/163#discussion_r406429588", "bodyText": "It is used locally which means that it will be created every time that this logic triggers. Having it be static final means that we only ever need 1 copy for all of EG.", "author": "MikeDombo", "createdAt": "2020-04-09T19:31:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQwNTk1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQzMTEzNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/163#discussion_r406431134", "bodyText": "Fair point. I'll make it constant.", "author": "fengwang666", "createdAt": "2020-04-09T19:34:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQwNTk1MA=="}], "type": "inlineReview", "revised_code": {"commit": "b2ecc9fddefa35a0386b02fc250c3696a3bb04c4", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java b/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\nindex 1c81414abe..fb61a48223 100644\n--- a/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\n+++ b/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\n\n@@ -166,10 +170,8 @@ public class EvergreenService implements InjectionActions {\n             requestStop();\n         }\n         State currentState = getState();\n-        // We only need to track the ERROR for the state transition starting from NEW, INSTALLED and RUNNING because\n-        // these states impact whether the service can function as expected.\n-        List<State> statesToTrack = Arrays.asList(State.NEW, State.INSTALLED, State.RUNNING);\n-        if (State.ERRORED.equals(newState) && statesToTrack.contains(currentState)) {\n+\n+        if (State.ERRORED.equals(newState) && STATES_TO_ERRORED.contains(currentState)) {\n             // If the reported state is ERRORED, we'll increase the ERROR counter for the current state.\n             stateToErroredCount.compute(currentState, (k, v) -> (v == null) ? 1 : v + 1);\n         } else {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQwNjg0NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/163#discussion_r406406844", "bodyText": "Did you get any understanding for why this was the way it was before?", "author": "MikeDombo", "createdAt": "2020-04-09T18:47:42Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -333,7 +355,7 @@ public final void requestRestart() {\n      */\n     public final void requestReinstall() {\n         synchronized (this.desiredStateList) {\n-            setDesiredState(State.INSTALLED, State.NEW, State.RUNNING);\n+            setDesiredState(State.NEW, State.RUNNING);", "originalCommit": "6bc701651c94472d7d0167c0afbf65df27a8124f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQyNjYzNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/163#discussion_r406426635", "bodyText": "I asked Shirley and it seems there is no reason for what it was before.", "author": "fengwang666", "createdAt": "2020-04-09T19:26:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQwNjg0NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQwODAwNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/163#discussion_r406408004", "bodyText": "doesn't this prevent the service from restarting?", "author": "MikeDombo", "createdAt": "2020-04-09T18:49:42Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -511,10 +546,7 @@ private void startStateTransition() throws InterruptedException {\n                         // in order to shutdown this thread since we were requested to stop\n                         throw e;\n                     }\n-                    //TODO: Set service to broken state if error happens too often\n-                    if (!desiredState.isPresent()) {", "originalCommit": "6bc701651c94472d7d0167c0afbf65df27a8124f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b2ecc9fddefa35a0386b02fc250c3696a3bb04c4", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java b/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\nindex 1c81414abe..fb61a48223 100644\n--- a/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\n+++ b/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\n\n@@ -547,6 +549,11 @@ public class EvergreenService implements InjectionActions {\n                         throw e;\n                     }\n \n+                    if (!desiredState.isPresent()) {\n+                        // Reset the desired state to RUNNING to retry the ERROR.\n+                        requestStart();\n+                    }\n+\n                     switch (prevState) {\n                         case RUNNING:\n                             updateStateAndBroadcast(State.STOPPING);\n"}}, {"oid": "b2ecc9fddefa35a0386b02fc250c3696a3bb04c4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b2ecc9fddefa35a0386b02fc250c3696a3bb04c4", "message": "Address comments", "committedDate": "2020-04-09T20:18:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ1ODg5OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/163#discussion_r406458899", "bodyText": "This is now fixed and merged. Please try again and remove these comments if it is working.", "author": "MikeDombo", "createdAt": "2020-04-09T20:29:27Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java", "diffHunk": "@@ -133,6 +133,101 @@ private void testGroup(int group) throws Exception {\n         }\n     }\n \n+    @Test\n+    void GIVEN_service_install_always_fail_WHEN_kernel_launches_THEN_service_go_broken_state() throws Exception {\n+        Kernel kernel = new Kernel();\n+        kernel.parseArgs(\"-i\", getClass().getResource(\"config_install_error.yaml\").toString());\n+        kernel.launch();\n+\n+        CountDownLatch serviceBroken = new CountDownLatch(1);\n+        kernel.context.addGlobalStateChangeListener((service, oldState, newState) -> {\n+            if (service.getName().equals(\"installerror\") && newState.equals(State.BROKEN)) {\n+                serviceBroken.countDown();\n+            }\n+        });\n+        assertTrue(serviceBroken.await(60, TimeUnit.SECONDS));\n+        kernel.shutdown();\n+    }\n+\n+    @Test\n+    void GIVEN_service_install_broken_WHEN_kernel_launches_with_fix_THEN_service_install_succeeds() throws Exception {\n+        Kernel kernel = new Kernel();\n+        kernel.parseArgs(\"-i\", getClass().getResource(\"config_install_error.yaml\").toString());\n+        kernel.launch();\n+\n+        CountDownLatch serviceBroken = new CountDownLatch(1);\n+        kernel.context.addGlobalStateChangeListener((service, oldState, newState) -> {\n+            if (service.getName().equals(\"installerror\") && newState.equals(State.BROKEN)) {\n+                serviceBroken.countDown();\n+            }\n+        });\n+        assertTrue(serviceBroken.await(60, TimeUnit.SECONDS));\n+\n+        // merge in a new config that fixes the installation error\n+        kernel.read(kernel.deTilde(getClass().getResource(\"config_install_succeed_partial.yaml\").toString()));\n+        // The above read() should already trigger a re-install through subscriber but there appears a bug in the code.\n+        // SIM: https://sim.amazon.com/issues/469c4bac-808a-4fe7-ae89-8546a55566d8", "originalCommit": "b2ecc9fddefa35a0386b02fc250c3696a3bb04c4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ2NjMzNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/163#discussion_r406466334", "bodyText": "works. Thanks!", "author": "fengwang666", "createdAt": "2020-04-09T20:44:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ1ODg5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "b079d870d6fa60c93054a77bce9ea9dfb4c403b7", "chunk": "diff --git a/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java b/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java\nindex cdb397becb..b51e3c6e31 100644\n--- a/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java\n+++ b/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java\n\n@@ -165,9 +165,6 @@ class KernelTest extends BaseITCase {\n \n         // merge in a new config that fixes the installation error\n         kernel.read(kernel.deTilde(getClass().getResource(\"config_install_succeed_partial.yaml\").toString()));\n-        // The above read() should already trigger a re-install through subscriber but there appears a bug in the code.\n-        // SIM: https://sim.amazon.com/issues/469c4bac-808a-4fe7-ae89-8546a55566d8\n-        kernel.context.get(EvergreenService.class, \"installerror\").requestReinstall();\n \n         CountDownLatch serviceInstalled = new CountDownLatch(1);\n \n"}}, {"oid": "190930c6090f14a227c5355a59346ca45a44c651", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/190930c6090f14a227c5355a59346ca45a44c651", "message": "Merge branch 'master' into transit-error-to-broken", "committedDate": "2020-04-09T20:35:28Z", "type": "commit"}, {"oid": "b079d870d6fa60c93054a77bce9ea9dfb4c403b7", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b079d870d6fa60c93054a77bce9ea9dfb4c403b7", "message": "Fix test failure", "committedDate": "2020-04-09T20:37:50Z", "type": "commit"}]}