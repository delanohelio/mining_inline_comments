{"pr_number": 646, "pr_title": "Fix for rolling back when the previous state also had a broken component", "pr_createdAt": "2020-11-09T22:17:11Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/646", "timeline": [{"oid": "52c13504965015f3d39e642619edd8e9a62eff2a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/52c13504965015f3d39e642619edd8e9a62eff2a", "message": "Fix for rolling back when the previous state also had a broken component", "committedDate": "2020-11-09T22:27:41Z", "type": "forcePushed"}, {"oid": "da4974b3e9fc99a70df04e5cec983d8f9f1261f1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/da4974b3e9fc99a70df04e5cec983d8f9f1261f1", "message": "Fix for rolling back when the previous state also had a broken component", "committedDate": "2020-11-09T22:49:01Z", "type": "forcePushed"}, {"oid": "334a7db66f84bc9dae0003b6697f917d0f511415", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/334a7db66f84bc9dae0003b6697f917d0f511415", "message": "Fix for rolling back when the previous state also had a broken component", "committedDate": "2020-11-09T23:04:44Z", "type": "forcePushed"}, {"oid": "a95b5212d56b173f372ad67acff3685263378e37", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a95b5212d56b173f372ad67acff3685263378e37", "message": "Fix for rolling back when the previous state also had a broken component", "committedDate": "2020-11-09T23:18:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIyNzg3NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/646#discussion_r520227875", "bodyText": "Is it worth logging that these services are already broken and that we are not going to track them for failed rollback?\nThe services to track are logged below, but it could be useful info to log as another kv there that there are services we are ignoring. If there's a ton of logs between the services breaking and the deployment it may not be obvious.", "author": "rbattle", "createdAt": "2020-11-10T01:28:46Z", "path": "src/main/java/com/aws/greengrass/deployment/activator/DefaultActivator.java", "diffHunk": "@@ -146,6 +146,10 @@ void rollback(DeploymentDocument deploymentDocument, CompletableFuture<Deploymen\n \n         try {\n             Set<GreengrassService> servicesToTrackForRollback = rollbackManager.servicesToTrack();\n+            // Don't track services if they were already broken before the rolled back deployment, because they'd\n+            // be expected to still be broken\n+            servicesToTrackForRollback.removeIf((s) ->", "originalCommit": "a95b5212d56b173f372ad67acff3685263378e37", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIzMzEyMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/646#discussion_r520233122", "bodyText": "Added log to line below", "author": "MikeDombo", "createdAt": "2020-11-10T01:45:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIyNzg3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "393da8e341c594d43591ebca3962cc4d4af8f556", "chunk": "diff --git a/src/main/java/com/aws/greengrass/deployment/activator/DefaultActivator.java b/src/main/java/com/aws/greengrass/deployment/activator/DefaultActivator.java\nindex 61d59905e..4c6d9666e 100644\n--- a/src/main/java/com/aws/greengrass/deployment/activator/DefaultActivator.java\n+++ b/src/main/java/com/aws/greengrass/deployment/activator/DefaultActivator.java\n\n@@ -150,7 +150,9 @@ public class DefaultActivator extends DeploymentActivator {\n             // be expected to still be broken\n             servicesToTrackForRollback.removeIf((s) ->\n                     rollbackManager.getAlreadyBrokenServices().contains(s.getName()));\n-            logger.atDebug(MERGE_CONFIG_EVENT_KEY).kv(\"serviceToTrackForRollback\", servicesToTrackForRollback)\n+            logger.atDebug(MERGE_CONFIG_EVENT_KEY)\n+                    .kv(\"previouslyBrokenServices\", rollbackManager.getAlreadyBrokenServices())\n+                    .kv(\"serviceToTrackForRollback\", servicesToTrackForRollback)\n                     .log(\"Applied rollback service config. Waiting for services to complete update\");\n             waitForServicesToStart(servicesToTrackForRollback, mergeTime);\n \n"}}, {"oid": "393da8e341c594d43591ebca3962cc4d4af8f556", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/393da8e341c594d43591ebca3962cc4d4af8f556", "message": "Fix for rolling back when the previous state also had a broken component", "committedDate": "2020-11-10T01:45:17Z", "type": "commit"}, {"oid": "393da8e341c594d43591ebca3962cc4d4af8f556", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/393da8e341c594d43591ebca3962cc4d4af8f556", "message": "Fix for rolling back when the previous state also had a broken component", "committedDate": "2020-11-10T01:45:17Z", "type": "forcePushed"}, {"oid": "d97cf3d844c37e7ffc9d301ce0f0167e1db9304c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d97cf3d844c37e7ffc9d301ce0f0167e1db9304c", "message": "Merge branch 'master' into rollback-broken", "committedDate": "2020-11-10T02:25:43Z", "type": "commit"}]}