{"pr_number": 612, "pr_title": "Pass kernel restart flag to component update check; Improve deployment artifact directory handling", "pr_createdAt": "2020-11-03T21:20:11Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/612", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk2NDIwMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/612#discussion_r516964202", "bodyText": "why do we ignore this!? This is what Feng hit, we had some ioexception which was logged, but it just kept going.", "author": "MikeDombo", "createdAt": "2020-11-03T21:24:56Z", "path": "src/main/java/com/aws/greengrass/deployment/DeploymentService.java", "diffHunk": "@@ -397,11 +397,11 @@ private void createNewDeployment(Deployment deployment) {\n         deploymentStatusKeeper.persistAndPublishDeploymentStatus(deployment.getId(), deployment.getDeploymentType(),\n                 JobStatus.IN_PROGRESS.toString(), new HashMap<>());\n         try {\n-            deploymentDirectoryManager.createNewDeploymentDirectoryIfNotExists(\n+            deploymentDirectoryManager.createNewDeploymentDirectory(\n                     deployment.getDeploymentDocumentObj().getDeploymentId());\n             deploymentDirectoryManager.writeDeploymentMetadata(deployment);\n         } catch (IOException ioException) {\n-            logger.atError().log(\"Unable to create deployment directory\", ioException);\n+            logger.atError().log(\"Unable to create deployment directory. Ignoring\", ioException);", "originalCommit": "85fc15ac82bd3fae8acf7830213a28f95ae6e50b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6f9412d39efa543d00d189054fbc4a5cb7002eb9", "chunk": "diff --git a/src/main/java/com/aws/greengrass/deployment/DeploymentService.java b/src/main/java/com/aws/greengrass/deployment/DeploymentService.java\nindex ac7804a46..cb1de3ed0 100644\n--- a/src/main/java/com/aws/greengrass/deployment/DeploymentService.java\n+++ b/src/main/java/com/aws/greengrass/deployment/DeploymentService.java\n\n@@ -401,7 +403,12 @@ public class DeploymentService extends GreengrassService {\n                     deployment.getDeploymentDocumentObj().getDeploymentId());\n             deploymentDirectoryManager.writeDeploymentMetadata(deployment);\n         } catch (IOException ioException) {\n-            logger.atError().log(\"Unable to create deployment directory. Ignoring\", ioException);\n+            logger.atError().log(\"Unable to create deployment directory\", ioException);\n+            CompletableFuture<DeploymentResult> process = new CompletableFuture<>();\n+            process.completeExceptionally(new NonRetryableDeploymentTaskFailureException(ioException));\n+            currentDeploymentTaskMetadata = new DeploymentTaskMetadata(deploymentTask, process, deployment.getId(),\n+                    deployment.getDeploymentType(), new AtomicInteger(1), deployment.getDeploymentDocumentObj(), false);\n+            return;\n         }\n         Future<DeploymentResult> process = executorService.submit(deploymentTask);\n         logger.atInfo().kv(\"deployment\", deployment.getId()).log(\"Started deployment execution\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk2NDM2MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/612#discussion_r516964361", "bodyText": "add the deployment ID in here too", "author": "MikeDombo", "createdAt": "2020-11-03T21:25:17Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/UpdateAction.java", "diffHunk": "@@ -0,0 +1,16 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.greengrass.lifecyclemanager;\n+\n+import com.aws.greengrass.dependency.Crashable;\n+import lombok.Value;\n+\n+@Value\n+public class UpdateAction {", "originalCommit": "85fc15ac82bd3fae8acf7830213a28f95ae6e50b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk3NTU5Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/612#discussion_r516975593", "bodyText": "Can we always assume we have one pending update action? Or do we send one PreComponentUpdateEvent for each update action?", "author": "hui-yang", "createdAt": "2020-11-03T21:49:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk2NDM2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk3NjI3MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/612#discussion_r516976271", "bodyText": "Also I just realized deploymentId is already the key in the pending actions map", "author": "hui-yang", "createdAt": "2020-11-03T21:51:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk2NDM2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk3NjU4OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/612#discussion_r516976589", "bodyText": "Just throw it in and then I'll figure it out in my change later.", "author": "MikeDombo", "createdAt": "2020-11-03T21:51:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk2NDM2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "6f9412d39efa543d00d189054fbc4a5cb7002eb9", "chunk": "diff --git a/src/main/java/com/aws/greengrass/lifecyclemanager/UpdateAction.java b/src/main/java/com/aws/greengrass/lifecyclemanager/UpdateAction.java\nindex 3be413a3f..080f7fc73 100644\n--- a/src/main/java/com/aws/greengrass/lifecyclemanager/UpdateAction.java\n+++ b/src/main/java/com/aws/greengrass/lifecyclemanager/UpdateAction.java\n\n@@ -10,6 +10,7 @@ import lombok.Value;\n \n @Value\n public class UpdateAction {\n+    String deploymentId;\n     boolean ggcRestart;\n     Integer timeout;\n     Crashable action;\n"}}, {"oid": "1a69d2da59cfb636750534afe9854fdc590b327b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1a69d2da59cfb636750534afe9854fdc590b327b", "message": "Pass kernel restart flag to component update check; Improve deployment artifact directory handling", "committedDate": "2020-11-04T00:27:19Z", "type": "commit"}, {"oid": "6f9412d39efa543d00d189054fbc4a5cb7002eb9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6f9412d39efa543d00d189054fbc4a5cb7002eb9", "message": "Address comments", "committedDate": "2020-11-04T00:27:19Z", "type": "commit"}, {"oid": "6f9412d39efa543d00d189054fbc4a5cb7002eb9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6f9412d39efa543d00d189054fbc4a5cb7002eb9", "message": "Address comments", "committedDate": "2020-11-04T00:27:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAzNzIwMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/612#discussion_r517037200", "bodyText": "will this update the job status? The job status was just updated to be in progress on L400", "author": "MikeDombo", "createdAt": "2020-11-04T00:46:35Z", "path": "src/main/java/com/aws/greengrass/deployment/DeploymentService.java", "diffHunk": "@@ -398,11 +399,16 @@ private void createNewDeployment(Deployment deployment) {\n         deploymentStatusKeeper.persistAndPublishDeploymentStatus(deployment.getId(), deployment.getDeploymentType(),\n                 JobStatus.IN_PROGRESS.toString(), new HashMap<>());\n         try {\n-            deploymentDirectoryManager.createNewDeploymentDirectoryIfNotExists(\n+            deploymentDirectoryManager.createNewDeploymentDirectory(\n                     deployment.getDeploymentDocumentObj().getDeploymentId());\n             deploymentDirectoryManager.writeDeploymentMetadata(deployment);\n         } catch (IOException ioException) {\n             logger.atError().log(\"Unable to create deployment directory\", ioException);\n+            CompletableFuture<DeploymentResult> process = new CompletableFuture<>();", "originalCommit": "6f9412d39efa543d00d189054fbc4a5cb7002eb9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAzODIzNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/612#discussion_r517038236", "bodyText": "Yes. It will be reported in finishCurrentDeployment from the main loop in DeploymentService https://github.com/aws/aws-greengrass-nucleus/blob/6f9412d39efa543d00d189054fbc4a5cb7002eb9/src/main/java/com/aws/greengrass/deployment/DeploymentService.java#L175-L178\nAlso added test https://github.com/aws/aws-greengrass-nucleus/pull/612/files#diff-7162e2dd9781fc6302332fc5f172f2e8c27c99a7db5ea57193cfe0121c9ed76a", "author": "hui-yang", "createdAt": "2020-11-04T00:50:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAzNzIwMA=="}], "type": "inlineReview", "revised_code": null}]}