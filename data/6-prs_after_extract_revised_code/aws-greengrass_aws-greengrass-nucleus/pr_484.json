{"pr_number": 484, "pr_title": "Telemetry v1 compatible aggregation type", "pr_createdAt": "2020-09-29T01:31:32Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/484", "timeline": [{"oid": "92a391335fd3038903e0381689b8c310ecff22c9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/92a391335fd3038903e0381689b8c310ecff22c9", "message": "Telemetry v1 compatible aggregation type", "committedDate": "2020-09-29T01:25:25Z", "type": "commit"}, {"oid": "1561df616320c40f22a215cbab57bda613cc0c4a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1561df616320c40f22a215cbab57bda613cc0c4a", "message": "Telemetry v1 compatible aggregation type", "committedDate": "2020-09-29T01:39:09Z", "type": "commit"}, {"oid": "82d3a85dc226b7a1bc873b41bb8525f147fb03fe", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/82d3a85dc226b7a1bc873b41bb8525f147fb03fe", "message": "Merge branch 'telemetry-fix' of github.com:/aws/aws-greengrass-kernel into telemetry-fix", "committedDate": "2020-09-29T01:39:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMyNzE5Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/484#discussion_r496327197", "bodyText": "If these aggregations don't actually make sense, then we should just disable this", "author": "MikeDombo", "createdAt": "2020-09-29T01:45:32Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/KernelMetricsEmitter.java", "diffHunk": "@@ -48,71 +48,71 @@ public void emitMetrics() {\n                 .namespace(NAMESPACE)\n                 .name(\"NumberOfComponentsStarting\")\n                 .unit(TelemetryUnit.Count)\n-                .aggregation(TelemetryAggregation.Average)\n+                .aggregation(TelemetryAggregation.Sum)\n                 .build();\n         mf.putMetricData(metric, stateCount.getOrDefault(State.STARTING, 0));\n \n         metric = Metric.builder()\n                 .namespace(NAMESPACE)\n                 .name(\"NumberOfComponentsInstalled\")\n                 .unit(TelemetryUnit.Count)\n-                .aggregation(TelemetryAggregation.Average)\n+                .aggregation(TelemetryAggregation.Sum)\n                 .build();\n         mf.putMetricData(metric, stateCount.getOrDefault(State.INSTALLED, 0));\n \n         metric = Metric.builder()\n                 .namespace(NAMESPACE)\n                 .name(\"NumberOfComponentsStateless\")\n                 .unit(TelemetryUnit.Count)\n-                .aggregation(TelemetryAggregation.Average)\n+                .aggregation(TelemetryAggregation.Sum)\n                 .build();\n         mf.putMetricData(metric, stateCount.getOrDefault(State.STATELESS, 0));\n \n         metric = Metric.builder()\n                 .namespace(NAMESPACE)\n                 .name(\"NumberOfComponentsStopping\")\n                 .unit(TelemetryUnit.Count)\n-                .aggregation(TelemetryAggregation.Average)\n+                .aggregation(TelemetryAggregation.Sum)\n                 .build();\n         mf.putMetricData(metric, stateCount.getOrDefault(State.STOPPING, 0));\n \n         metric = Metric.builder()\n                 .namespace(NAMESPACE)\n                 .name(\"NumberOfComponentsBroken\")\n                 .unit(TelemetryUnit.Count)\n-                .aggregation(TelemetryAggregation.Average)\n+                .aggregation(TelemetryAggregation.Sum)", "originalCommit": "82d3a85dc226b7a1bc873b41bb8525f147fb03fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMyNzYzMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/484#discussion_r496327632", "bodyText": "https://docs.aws.amazon.com/greengrass/latest/developerguide/telemetry.html#subscribe-for-telemetry-data", "author": "saranyailla", "createdAt": "2020-09-29T01:47:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMyNzE5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMyNzk3MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/484#discussion_r496327970", "bodyText": "Lets keep the kernel ones to average for now since they are newer metrics. System metrics have to be sum to keep parity with V1.", "author": "nikkhilmuthye", "createdAt": "2020-09-29T01:48:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMyNzE5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMzMDk3OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/484#discussion_r496330978", "bodyText": "If I keep kernel metrics to have \"Average\" then that entire message is considered as invalid payload. For the UATs to be working, it has to be Sum for now.", "author": "saranyailla", "createdAt": "2020-09-29T01:55:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMyNzE5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjM4Mzc5MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/484#discussion_r496383790", "bodyText": "The documentation is ambiguous:\n                    {\n                        \"N\": \"CpuUsage\",\n                        \"Sum\": 35.63,\n                        \"U\": \"Percent\"\n                    }\n\nImplies an average. But:\n\nThe aggregated metric value. The telemetry agent adds new values to the previous total, so the sum is an ever-increasing value. You can use the timestamp to find the value of a specific aggregation. For example, to find the latest aggregated value, subtract the previous timestamped value from the latest timestamped value.\n\nSeems like Sum is being overloaded as an \"n\" value, where Sum and Average can be calculated on the receiving end. What is the original telemetry agent doing for these system metrics?", "author": "philcali", "createdAt": "2020-09-29T04:34:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMyNzE5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQwOTkwOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/484#discussion_r496409908", "bodyText": "System metrics are an exception case in V1. We get the value when the aggregation happens fro CPU usage, number of FDs and Mem Used and add it to the aggregated data snapshot. We don't really perform any kind of aggregation on it.\nEven in v2, since the aggregation time and the system metrics emission time interval is the same, we won't perform any aggregation on these metrics.", "author": "nikkhilmuthye", "createdAt": "2020-09-29T05:10:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMyNzE5Nw=="}], "type": "inlineReview", "revised_code": {"commit": "13c9e1ae445d62a4a617a5ed2d43f52fab183e6f", "chunk": "diff --git a/src/main/java/com/aws/greengrass/lifecyclemanager/KernelMetricsEmitter.java b/src/main/java/com/aws/greengrass/lifecyclemanager/KernelMetricsEmitter.java\nindex 81a19470e..a032a403a 100644\n--- a/src/main/java/com/aws/greengrass/lifecyclemanager/KernelMetricsEmitter.java\n+++ b/src/main/java/com/aws/greengrass/lifecyclemanager/KernelMetricsEmitter.java\n\n@@ -48,7 +48,7 @@ public class KernelMetricsEmitter extends PeriodicMetricsEmitter {\n                 .namespace(NAMESPACE)\n                 .name(\"NumberOfComponentsStarting\")\n                 .unit(TelemetryUnit.Count)\n-                .aggregation(TelemetryAggregation.Sum)\n+                .aggregation(TelemetryAggregation.Average)\n                 .build();\n         mf.putMetricData(metric, stateCount.getOrDefault(State.STARTING, 0));\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMyNzMxOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/484#discussion_r496327318", "bodyText": "sums definitely don't make sense here.", "author": "MikeDombo", "createdAt": "2020-09-29T01:45:58Z", "path": "src/main/java/com/aws/greengrass/telemetry/SystemMetricsEmitter.java", "diffHunk": "@@ -40,15 +40,15 @@ public void emitMetrics() {\n                 .namespace(NAMESPACE)\n                 .name(\"TotalNumberOfFDs\")\n                 .unit(TelemetryUnit.Count)\n-                .aggregation(TelemetryAggregation.Average)\n+                .aggregation(TelemetryAggregation.Sum)\n                 .build();\n         mf.putMetricData(metric, systemInfo.getOperatingSystem().getFileSystem().getOpenFileDescriptors());\n \n         metric = Metric.builder()\n                 .namespace(NAMESPACE)\n                 .name(\"SystemMemUsage\")\n                 .unit(TelemetryUnit.Megabytes)\n-                .aggregation(TelemetryAggregation.Average)\n+                .aggregation(TelemetryAggregation.Sum)", "originalCommit": "82d3a85dc226b7a1bc873b41bb8525f147fb03fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMyOTQ5MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/484#discussion_r496329491", "bodyText": "You can't just sum the memory usage or cpu usage over time, that isn't meaningful.", "author": "MikeDombo", "createdAt": "2020-09-29T01:53:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMyNzMxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMzMjc4OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/484#discussion_r496332789", "bodyText": "@saranyailla can you add a TODO here to check with the PM? This is a breaking change if we do want to make it Average. So after consulting with the PM and the cloud team, we can make the change if necessary.", "author": "nikkhilmuthye", "createdAt": "2020-09-29T01:57:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMyNzMxOA=="}], "type": "inlineReview", "revised_code": {"commit": "13c9e1ae445d62a4a617a5ed2d43f52fab183e6f", "chunk": "diff --git a/src/main/java/com/aws/greengrass/telemetry/SystemMetricsEmitter.java b/src/main/java/com/aws/greengrass/telemetry/SystemMetricsEmitter.java\nindex 70286c811..16d06ab09 100644\n--- a/src/main/java/com/aws/greengrass/telemetry/SystemMetricsEmitter.java\n+++ b/src/main/java/com/aws/greengrass/telemetry/SystemMetricsEmitter.java\n\n@@ -40,7 +40,7 @@ public class SystemMetricsEmitter extends PeriodicMetricsEmitter {\n                 .namespace(NAMESPACE)\n                 .name(\"TotalNumberOfFDs\")\n                 .unit(TelemetryUnit.Count)\n-                .aggregation(TelemetryAggregation.Sum)\n+                .aggregation(TelemetryAggregation.Average)\n                 .build();\n         mf.putMetricData(metric, systemInfo.getOperatingSystem().getFileSystem().getOpenFileDescriptors());\n \n"}}, {"oid": "13c9e1ae445d62a4a617a5ed2d43f52fab183e6f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/13c9e1ae445d62a4a617a5ed2d43f52fab183e6f", "message": "change aggregation type to sum in final result + update tests", "committedDate": "2020-09-29T17:51:15Z", "type": "commit"}, {"oid": "d9fd3dd2eebbe624c64459b537de4b0c39fe0fb6", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d9fd3dd2eebbe624c64459b537de4b0c39fe0fb6", "message": "Merge branch 'telemetry-fix' of github.com:/aws/aws-greengrass-kernel into telemetry-fix", "committedDate": "2020-09-29T17:55:29Z", "type": "commit"}, {"oid": "d9fd3dd2eebbe624c64459b537de4b0c39fe0fb6", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d9fd3dd2eebbe624c64459b537de4b0c39fe0fb6", "message": "Merge branch 'telemetry-fix' of github.com:/aws/aws-greengrass-kernel into telemetry-fix", "committedDate": "2020-09-29T17:55:29Z", "type": "forcePushed"}, {"oid": "06cf12a8139fc862b7a3b8c5154218f8d1019e1e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/06cf12a8139fc862b7a3b8c5154218f8d1019e1e", "message": "Change aggregation type to sum only in the final result + update tests", "committedDate": "2020-09-29T17:59:31Z", "type": "commit"}, {"oid": "273b30e4b3ba1aa5e5ab950f581f1578067261ad", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/273b30e4b3ba1aa5e5ab950f581f1578067261ad", "message": "Merge branch 'telemetry-fix' of github.com:/aws/aws-greengrass-kernel into telemetry-fix", "committedDate": "2020-09-29T18:09:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1MzY2NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/484#discussion_r496953665", "bodyText": "We still need this check right?", "author": "nikkhilmuthye", "createdAt": "2020-09-29T18:33:07Z", "path": "src/main/java/com/aws/greengrass/telemetry/TelemetryAgent.java", "diffHunk": "@@ -188,10 +188,7 @@ void publishPeriodicMetrics() {\n         Map<Long, List<AggregatedNamespaceData>> metricsToPublishMap =\n                 metricsAggregator.getMetricsToPublish(lastPublish, timestamp);\n         getPeriodicPublishTimeTopic().withValue(timestamp);\n-        // Publish only if the collected metrics are not empty.", "originalCommit": "273b30e4b3ba1aa5e5ab950f581f1578067261ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk3MTQ2Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/484#discussion_r496971463", "bodyText": "If it is empty, then there are no metrics to lose even when it is considered as an invalid payload.", "author": "saranyailla", "createdAt": "2020-09-29T19:05:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1MzY2NQ=="}], "type": "inlineReview", "revised_code": {"commit": "19bd72b91ef220389031299c1328f248914d7dd8", "chunk": "diff --git a/src/main/java/com/aws/greengrass/telemetry/TelemetryAgent.java b/src/main/java/com/aws/greengrass/telemetry/TelemetryAgent.java\nindex 0b6622db4..285532adb 100644\n--- a/src/main/java/com/aws/greengrass/telemetry/TelemetryAgent.java\n+++ b/src/main/java/com/aws/greengrass/telemetry/TelemetryAgent.java\n\n@@ -188,6 +188,7 @@ public class TelemetryAgent extends GreengrassService {\n         Map<Long, List<AggregatedNamespaceData>> metricsToPublishMap =\n                 metricsAggregator.getMetricsToPublish(lastPublish, timestamp);\n         getPeriodicPublishTimeTopic().withValue(timestamp);\n+        // TODO : Do not publish if the metrics are empty.\n         publisher.publish(MetricsPayload.builder().build(), metricsToPublishMap.get(timestamp));\n     }\n \n"}}, {"oid": "19bd72b91ef220389031299c1328f248914d7dd8", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/19bd72b91ef220389031299c1328f248914d7dd8", "message": "Merge branch 'telemetry-fix' of github.com:/aws/aws-greengrass-kernel into telemetry-fix", "committedDate": "2020-09-30T04:28:21Z", "type": "commit"}, {"oid": "1d4d5d25c6fd097d2c39096772f8b2c311caacea", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1d4d5d25c6fd097d2c39096772f8b2c311caacea", "message": "Merge branch 'master' of github.com:/aws/aws-greengrass-kernel into telemetry-fix", "committedDate": "2020-09-30T04:28:36Z", "type": "commit"}, {"oid": "a7c9433bd5d02a2c7765f40d33ca521b26fb71c4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a7c9433bd5d02a2c7765f40d33ca521b26fb71c4", "message": "Merge branch 'telemetry-fix' of github.com:/aws/aws-greengrass-kernel into telemetry-fix", "committedDate": "2020-09-30T04:28:52Z", "type": "commit"}]}