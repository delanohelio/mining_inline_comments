{"pr_number": 450, "pr_title": "Improve integ tests", "pr_createdAt": "2020-09-18T06:29:26Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/450", "timeline": [{"oid": "a2d33c176f3446666fb4e4812c5b56b7487ecd95", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a2d33c176f3446666fb4e4812c5b56b7487ecd95", "message": "updated unit and integ tests", "committedDate": "2020-09-17T19:37:39Z", "type": "commit"}, {"oid": "e5062b1ec0693dc281d0de624c5ad5a07647f90b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e5062b1ec0693dc281d0de624c5ad5a07647f90b", "message": "addressed comments", "committedDate": "2020-09-17T21:50:43Z", "type": "commit"}, {"oid": "14331561d6f0c3400e3d10639e15f3905cdea652", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/14331561d6f0c3400e3d10639e15f3905cdea652", "message": "reduce integ test run time", "committedDate": "2020-09-18T06:28:48Z", "type": "commit"}, {"oid": "7dd65be2138e94666f4f72b9f17af86c3218d318", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7dd65be2138e94666f4f72b9f17af86c3218d318", "message": "Merge branch 'master' into improve-integ-tests", "committedDate": "2020-09-18T06:31:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDczNzcwNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/450#discussion_r490737707", "bodyText": "ordering is highly suspect to me.", "author": "MikeDombo", "createdAt": "2020-09-18T06:50:00Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/ipc/IPCCliTest.java", "diffHunk": "@@ -84,6 +92,7 @@\n import static org.junit.jupiter.api.Assertions.fail;\n \n @ExtendWith(EGExtension.class)\n+@TestMethodOrder(MethodOrderer.OrderAnnotation.class)", "originalCommit": "7dd65be2138e94666f4f72b9f17af86c3218d318", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "eeb76b873a16f2ecc181d56f0f1f1b5f1cee083b", "chunk": "diff --git a/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/ipc/IPCCliTest.java b/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/ipc/IPCCliTest.java\nindex 7232e50439..c7282eabbb 100644\n--- a/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/ipc/IPCCliTest.java\n+++ b/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/ipc/IPCCliTest.java\n\n@@ -96,8 +96,8 @@ import static org.junit.jupiter.api.Assertions.fail;\n class IPCCliTest {\n \n     private static Kernel kernel;\n-    private static int LOCAL_DEPLOYMENT_TIMEOUT_MINUTES = 5;\n-    private static int SERVICE_STATE_CHECK_TIMEOUT_MINUTES = 5;\n+    private static int LOCAL_DEPLOYMENT_TIMEOUT_SECONDS = 15;\n+    private static int SERVICE_STATE_CHECK_TIMEOUT_SECONDS = 15;\n     private IPCClient client;\n     private static ObjectMapper OBJECT_MAPPER =\n             new ObjectMapper().configure(DeserializationFeature.FAIL_ON_INVALID_SUBTYPE, false)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDczODE4OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/450#discussion_r490738189", "bodyText": "set the root dir in the beforeall now. Otherwise it will use ~/.evergreen.", "author": "MikeDombo", "createdAt": "2020-09-18T06:51:16Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/ipc/IPCServicesTest.java", "diffHunk": "@@ -60,23 +62,31 @@\n     @TempDir\n     static Path tempRootDir;\n \n-    private Kernel kernel;\n+    private static Kernel kernel;\n     private IPCClient client;\n \n+    @BeforeAll\n+    static void beforeAll() throws InterruptedException {\n+        kernel = prepareKernelFromConfigFile(\"ipc.yaml\", IPCServicesTest.class, TEST_SERVICE_NAME);\n+    }\n+\n+    @AfterAll\n+    static void afterAll() {\n+        kernel.shutdown();\n+    }\n+\n     @BeforeEach\n-    void beforeEach(ExtensionContext context) throws InterruptedException, IOException {\n+    void beforeEach(ExtensionContext context) throws InterruptedException {\n         System.setProperty(\"root\", tempRootDir.toAbsolutePath().toString());", "originalCommit": "7dd65be2138e94666f4f72b9f17af86c3218d318", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA5NDA2Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/450#discussion_r491094062", "bodyText": "updated", "author": "fahadmohammed01", "createdAt": "2020-09-18T17:33:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDczODE4OQ=="}], "type": "inlineReview", "revised_code": {"commit": "67465fe9d9043fffcce9858168915cbc2e3c011a", "chunk": "diff --git a/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/ipc/IPCServicesTest.java b/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/ipc/IPCServicesTest.java\nindex 25bad0c9b8..ecb3ccd596 100644\n--- a/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/ipc/IPCServicesTest.java\n+++ b/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/ipc/IPCServicesTest.java\n\n@@ -67,6 +67,7 @@ class IPCServicesTest {\n \n     @BeforeAll\n     static void beforeAll() throws InterruptedException {\n+        System.setProperty(\"root\", tempRootDir.toAbsolutePath().toString());\n         kernel = prepareKernelFromConfigFile(\"ipc.yaml\", IPCServicesTest.class, TEST_SERVICE_NAME);\n     }\n \n"}}, {"oid": "67465fe9d9043fffcce9858168915cbc2e3c011a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/67465fe9d9043fffcce9858168915cbc2e3c011a", "message": "addressed comments", "committedDate": "2020-09-18T07:16:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA5MjY3Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/450#discussion_r491092677", "bodyText": "nit: why not change LOCAL_DEPLOYMENT_TIMEOUT_MINUTES and SERVICE_STATE_CHECK_TIMEOUT_MINUTES to 15?", "author": "hui-yang", "createdAt": "2020-09-18T17:30:35Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/ipc/IPCCliTest.java", "diffHunk": "@@ -336,8 +337,8 @@ public void GIVEN_kernel_running_WHEN_change_configuration_and_deployment_THEN_k\n         String deploymentId1 = deploymentResponse.getDeploymentId();\n         CountDownLatch deploymentLatch = waitForDeploymentToBeSuccessful(deploymentId1);\n \n-        assertTrue(deploymentLatch.await(LOCAL_DEPLOYMENT_TIMEOUT_MINUTES, TimeUnit.MINUTES));\n-        assertTrue(serviceLatch.await(SERVICE_STATE_CHECK_TIMEOUT_MINUTES, TimeUnit.MINUTES));\n+        assertTrue(deploymentLatch.await(15, TimeUnit.SECONDS));", "originalCommit": "67465fe9d9043fffcce9858168915cbc2e3c011a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTEzMjAxNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/450#discussion_r491132016", "bodyText": "updated", "author": "fahadmohammed01", "createdAt": "2020-09-18T18:50:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA5MjY3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "eeb76b873a16f2ecc181d56f0f1f1b5f1cee083b", "chunk": "diff --git a/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/ipc/IPCCliTest.java b/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/ipc/IPCCliTest.java\nindex a53a50c309..c7282eabbb 100644\n--- a/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/ipc/IPCCliTest.java\n+++ b/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/ipc/IPCCliTest.java\n\n@@ -337,8 +337,8 @@ class IPCCliTest {\n         String deploymentId1 = deploymentResponse.getDeploymentId();\n         CountDownLatch deploymentLatch = waitForDeploymentToBeSuccessful(deploymentId1);\n \n-        assertTrue(deploymentLatch.await(15, TimeUnit.SECONDS));\n-        assertTrue(serviceLatch.await(15, TimeUnit.SECONDS));\n+        assertTrue(deploymentLatch.await(LOCAL_DEPLOYMENT_TIMEOUT_SECONDS, TimeUnit.SECONDS));\n+        assertTrue(serviceLatch.await(SERVICE_STATE_CHECK_TIMEOUT_SECONDS, TimeUnit.SECONDS));\n         assertTrue(stdoutLatch.await(10, TimeUnit.SECONDS));\n \n         //Get configuration in component details\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA5NDQ0MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/450#discussion_r491094441", "bodyText": "Does this test need to verify A restarts, based on the test name?", "author": "hui-yang", "createdAt": "2020-09-18T17:34:10Z", "path": "src/test/java/com/aws/iot/evergreen/kernel/EvergreenServiceTest.java", "diffHunk": "@@ -118,11 +116,5 @@ void GIVEN_service_WHEN_dependencies_change_THEN_service_restarts() {\n         assertEquals(aService.dependencies.size(), 3);\n         assertNull(aService.dependencies.get(dService));\n         assertNotNull(aService.dependencies.get(eService));\n-\n-        aService.getState();", "originalCommit": "67465fe9d9043fffcce9858168915cbc2e3c011a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTEzMTk4MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/450#discussion_r491131980", "bodyText": "renamed the test", "author": "fahadmohammed01", "createdAt": "2020-09-18T18:50:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA5NDQ0MQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "eeb76b873a16f2ecc181d56f0f1f1b5f1cee083b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/eeb76b873a16f2ecc181d56f0f1f1b5f1cee083b", "message": "minor refactoring", "committedDate": "2020-09-18T18:49:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE0OTM3NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/450#discussion_r491149374", "bodyText": "Should the name be ...THEN_service_updates()?", "author": "shaguptashaikh", "createdAt": "2020-09-18T19:28:18Z", "path": "src/test/java/com/aws/iot/evergreen/kernel/EvergreenServiceTest.java", "diffHunk": "@@ -104,10 +102,10 @@ void GIVEN_a_config_WHEN_constructor_is_called_THEN_service_is_initialized() {\n     }\n \n     @Test\n-    void GIVEN_service_WHEN_dependencies_change_THEN_service_restarts() {\n+    void GIVEN_service_WHEN_dependencies_change_THEN_service_dependencies_updates() {\n         //GIVEN service A with dependencies B,C,D", "originalCommit": "eeb76b873a16f2ecc181d56f0f1f1b5f1cee083b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE1NDgwNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/450#discussion_r491154804", "bodyText": "The test only verifies the dependencies, since kernel and lifecycle are not running nothing else updates.", "author": "fahadmohammed01", "createdAt": "2020-09-18T19:40:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE0OTM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE1NTUwOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/450#discussion_r491155508", "bodyText": "okay, but nit- there's typo in the name still", "author": "shaguptashaikh", "createdAt": "2020-09-18T19:42:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE0OTM3NA=="}], "type": "inlineReview", "revised_code": null}]}