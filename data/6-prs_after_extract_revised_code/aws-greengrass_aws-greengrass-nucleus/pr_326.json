{"pr_number": 326, "pr_title": "Fixing flaky tests. Making changes to not attempt to connect to cloud\u2026", "pr_createdAt": "2020-07-23T18:03:34Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/326", "timeline": [{"oid": "d792deca6e4f80397a8c2929028d9e004ca605f8", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d792deca6e4f80397a8c2929028d9e004ca605f8", "message": "Fixing flaky tests. Making changes to not attempt to connect to cloud if device is not configured to", "committedDate": "2020-07-23T18:05:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY1NjUyNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/326#discussion_r459656527", "bodyText": "\ud83d\udc4d\nWe can even reduce the checklist to\nnew ExpectedStateTransition(HardDependency, State.INSTALLED, State.STARTING), \nnew ExpectedStateTransition(CustomerApp, State.INSTALLED, State.STARTING),\nnew ExpectedStateTransition(\"main\", State.STOPPING, State.FINISHED)));", "author": "hui-yang", "createdAt": "2020-07-23T18:47:13Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/ServiceDependencyLifecycleTest.java", "diffHunk": "@@ -123,23 +124,23 @@ void GIVEN_hard_dependency_WHEN_dependency_goes_through_lifecycle_events_THEN_cu\n         kernel = new Kernel().parseArgs(\"-i\", configFile.toString());\n \n         // WHEN_kernel_launch_THEN_customer_app_starts_after_hard_dependency_is_running\n-        LinkedList<KernelTest.ExpectedStateTransition> expectedDuringLaunch = new LinkedList<>(\n-                Arrays.asList(new KernelTest.ExpectedStateTransition(CustomerApp, State.NEW, State.INSTALLED),\n-                        new KernelTest.ExpectedStateTransition(HardDependency, State.NEW, State.INSTALLED),\n-                        new KernelTest.ExpectedStateTransition(HardDependency, State.INSTALLED, State.STARTING),\n-                        new KernelTest.ExpectedStateTransition(HardDependency, State.STARTING, State.RUNNING),\n-                        new KernelTest.ExpectedStateTransition(CustomerApp, State.INSTALLED, State.STARTING),\n-                        new KernelTest.ExpectedStateTransition(CustomerApp, State.STARTING, State.RUNNING),\n-                        new KernelTest.ExpectedStateTransition(\"main\", State.STOPPING, State.FINISHED)));\n-        testRoutine(TEST_ROUTINE_SHORT_TIMEOUT, kernel, kernel::launch, \"kernel launch\", expectedDuringLaunch, Collections.emptySet());\n+        LinkedList<ExpectedStateTransition> expectedDuringLaunch = new LinkedList<>(\n+                Arrays.asList(\n+                        new ExpectedStateTransition(HardDependency, State.INSTALLED, State.STARTING),\n+                        new ExpectedStateTransition(HardDependency, State.STARTING, State.RUNNING),\n+                        new ExpectedStateTransition(CustomerApp, State.INSTALLED, State.STARTING),\n+                        new ExpectedStateTransition(CustomerApp, State.STARTING, State.RUNNING),\n+                        new ExpectedStateTransition(\"main\", State.STOPPING, State.FINISHED)));\n+", "originalCommit": "d792deca6e4f80397a8c2929028d9e004ca605f8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ce3484e6c524e92df35d1a25f0205f0e1eceaef3", "chunk": "diff --git a/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/ServiceDependencyLifecycleTest.java b/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/ServiceDependencyLifecycleTest.java\nindex ec25d3180..ff7346cb0 100644\n--- a/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/ServiceDependencyLifecycleTest.java\n+++ b/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/ServiceDependencyLifecycleTest.java\n\n@@ -134,7 +134,6 @@ public class ServiceDependencyLifecycleTest {\n \n         testRoutine(TEST_ROUTINE_SHORT_TIMEOUT, kernel, kernel::launch, \"kernel launched\", expectedDuringLaunch, Collections.emptySet());\n \n-\n         // WHEN_dependency_removed_THEN_customer_app_stays_running\n         LinkedList<ExpectedStateTransition> expectedDepRemoved = new LinkedList<>(\n                 Arrays.asList(new ExpectedStateTransition(HardDependency, State.RUNNING, State.STOPPING)));\n"}}, {"oid": "a9dcdb50275a493c341b81dae3819374ed3ca010", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a9dcdb50275a493c341b81dae3819374ed3ca010", "message": "Fixing flaky tests. Making changes to not attempt to connect to cloud if device is not configured to", "committedDate": "2020-07-23T19:49:02Z", "type": "forcePushed"}, {"oid": "da0c4fdaedda8671a5322c01c4034a771ca42453", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/da0c4fdaedda8671a5322c01c4034a771ca42453", "message": "Fixing flaky tests. Making changes to not attempt to connect to cloud if device is not configured to", "committedDate": "2020-07-23T22:40:10Z", "type": "forcePushed"}, {"oid": "7cbaa1778a1ac9d0337ba25f783e39793e3223b7", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7cbaa1778a1ac9d0337ba25f783e39793e3223b7", "message": "Fixing flaky tests. Making changes to not attempt to connect to cloud if device is not configured to", "committedDate": "2020-07-23T22:58:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc5NTMyMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/326#discussion_r459795321", "bodyText": "why put this here? Jobs isn't the only thing that needs a valid device config.", "author": "MikeDombo", "createdAt": "2020-07-24T00:13:06Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/IotJobsHelper.java", "diffHunk": "@@ -246,6 +247,14 @@ public void onConnectionResumed(boolean sessionPresent) {\n     @Override\n     @SuppressFBWarnings\n     public void postInject() {\n+        try {\n+            deviceConfiguration.validate();", "originalCommit": "58f1df50942847bdb1163885f6ce7acd75edcb67", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIxMTQ4Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/326#discussion_r460211486", "bodyText": "Validate is still being called in the constructor for DeviceConfiguration so everything else using it should be invoking it. No one else is using injection exception IotJobHelper.", "author": "abanthiy", "createdAt": "2020-07-24T18:10:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc5NTMyMQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "ce3484e6c524e92df35d1a25f0205f0e1eceaef3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ce3484e6c524e92df35d1a25f0205f0e1eceaef3", "message": "Increasing timeouts for tests as they fail on windows", "committedDate": "2020-07-24T17:55:07Z", "type": "forcePushed"}, {"oid": "86e5126eb82e64cdb79ffda162fe6169f39f5f69", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/86e5126eb82e64cdb79ffda162fe6169f39f5f69", "message": "Adding method in ServiceDependencyLifecycleTest to verify state transitions not in any specific order", "committedDate": "2020-07-24T20:49:04Z", "type": "forcePushed"}, {"oid": "01e7a9d73795a89d836c650e0d9ec3a8da840ff7", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/01e7a9d73795a89d836c650e0d9ec3a8da840ff7", "message": "Fixing Mqtt reconnet flakiness", "committedDate": "2020-07-25T01:45:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM0OTUzMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/326#discussion_r460349533", "bodyText": "this change doesn't seem related to the previous failure, what drove this change?", "author": "MikeDombo", "createdAt": "2020-07-25T01:49:12Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/MqttReconnectTest.java", "diffHunk": "@@ -155,6 +153,6 @@ void GIVEN_new_deployment_while_device_online_WHEN_mqtt_disconnects_and_reconnec\n \n         // Wait for the IoT job to be updated and marked as successful\n         IotJobsUtils.waitForJobExecutionStatusToSatisfy(iotClient, jobId, thingInfo.getThingName(),\n-                Duration.ofMinutes(2), s -> s.equals(JobExecutionStatus.SUCCEEDED));\n+                Duration.ofMinutes(5), s -> s.equals(JobExecutionStatus.SUCCEEDED));", "originalCommit": "01e7a9d73795a89d836c650e0d9ec3a8da840ff7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8a4e4b8ccb293a3b44a791abe53a7c461a6f9bd3", "chunk": "diff --git a/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/MqttReconnectTest.java b/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/MqttReconnectTest.java\nindex a011f5914..07587576f 100644\n--- a/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/MqttReconnectTest.java\n+++ b/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/MqttReconnectTest.java\n\n@@ -153,6 +155,6 @@ public class MqttReconnectTest extends BaseE2ETestCase {\n \n         // Wait for the IoT job to be updated and marked as successful\n         IotJobsUtils.waitForJobExecutionStatusToSatisfy(iotClient, jobId, thingInfo.getThingName(),\n-                Duration.ofMinutes(5), s -> s.equals(JobExecutionStatus.SUCCEEDED));\n+                Duration.ofMinutes(2), s -> s.equals(JobExecutionStatus.SUCCEEDED));\n     }\n }\n"}}, {"oid": "2a54cfac36fda6cf2c3a2d120fed5b3035b35ff5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2a54cfac36fda6cf2c3a2d120fed5b3035b35ff5", "message": "Fixing Mqtt reconnet flakiness", "committedDate": "2020-07-27T16:08:17Z", "type": "forcePushed"}, {"oid": "8a4e4b8ccb293a3b44a791abe53a7c461a6f9bd3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8a4e4b8ccb293a3b44a791abe53a7c461a6f9bd3", "message": "Fixing flaky tests. Making changes to not attempt to connect to cloud if device is not configured to", "committedDate": "2020-07-27T16:10:47Z", "type": "commit"}, {"oid": "b9b5e90208c9a87f6be761ba26788324d10b8993", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b9b5e90208c9a87f6be761ba26788324d10b8993", "message": "Increasing timeouts for tests as they fail on windows", "committedDate": "2020-07-27T16:10:47Z", "type": "commit"}, {"oid": "46f95a2f256b9b981a7076ca004797ebc303503a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/46f95a2f256b9b981a7076ca004797ebc303503a", "message": "Adding method in ServiceDependencyLifecycleTest to verify state transitions not in any specific order", "committedDate": "2020-07-27T16:10:47Z", "type": "commit"}, {"oid": "567bd4388db3b703b232b9f0a33cc474a05b183a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/567bd4388db3b703b232b9f0a33cc474a05b183a", "message": "Fixing Mqtt reconnet flakiness", "committedDate": "2020-07-27T16:10:47Z", "type": "commit"}, {"oid": "567bd4388db3b703b232b9f0a33cc474a05b183a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/567bd4388db3b703b232b9f0a33cc474a05b183a", "message": "Fixing Mqtt reconnet flakiness", "committedDate": "2020-07-27T16:10:47Z", "type": "forcePushed"}]}