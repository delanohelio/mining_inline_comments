{"pr_number": 532, "pr_title": "Fix periodic FSS integ test.", "pr_createdAt": "2020-10-15T03:54:21Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/532", "timeline": [{"oid": "95b663a18d29d360df3ec4f839f1d35782552dae", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/95b663a18d29d360df3ec4f839f1d35782552dae", "message": "Fix periodic FSS integ test.", "committedDate": "2020-10-15T03:51:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE0OTgxMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/532#discussion_r505149811", "bodyText": "Does this test need to be so long? This will slow everyone down. Can you increase the publish interval for testing like we've done for deployment polling?\nBy decreasing the deployment polling from 15 seconds to 1 second our e2e tests cut in more than half from over 20 minutes to around 12.", "author": "MikeDombo", "createdAt": "2020-10-15T03:57:20Z", "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/status/PeriodicFleetStatusServiceTest.java", "diffHunk": "@@ -105,37 +101,30 @@ void GIVEN_config_with_small_periodic_interval_WHEN_interval_elapses_THEN_status\n         ((Map) kernel.getContext().getvIfExists(Kernel.SERVICE_TYPE_TO_CLASS_MAP_KEY).get()).put(\"plugin\",\n                 GreengrassService.class.getName());\n         assertNotNull(deviceConfiguration.getThingName());\n-        CountDownLatch fssPublishLatch = new CountDownLatch(1);\n-        logListener = eslm -> {\n-            if (eslm.getEventType() != null && eslm.getEventType().equals(\"fss-status-update-published\")\n-                    && eslm.getMessage().equals(\"Status update published to FSS\")) {\n-                fssPublishLatch.countDown();\n-            }\n-        };\n-        Slf4jLogAdapter.addGlobalListener(logListener);\n \n-        assertTrue(fssPublishLatch.await(40, TimeUnit.SECONDS));\n+        // Sleep for more time than the FSS publish interval so that we have all the data.\n+        TimeUnit.SECONDS.sleep(50);", "originalCommit": "95b663a18d29d360df3ec4f839f1d35782552dae", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "63442d4017dab23c41b492d5a9aa7b2c27d1cbca", "chunk": "diff --git a/src/integrationtests/java/com/aws/greengrass/integrationtests/status/PeriodicFleetStatusServiceTest.java b/src/integrationtests/java/com/aws/greengrass/integrationtests/status/PeriodicFleetStatusServiceTest.java\nindex af321f7d7..9382b59b7 100644\n--- a/src/integrationtests/java/com/aws/greengrass/integrationtests/status/PeriodicFleetStatusServiceTest.java\n+++ b/src/integrationtests/java/com/aws/greengrass/integrationtests/status/PeriodicFleetStatusServiceTest.java\n\n@@ -101,10 +100,21 @@ class PeriodicFleetStatusServiceTest extends BaseITCase {\n         ((Map) kernel.getContext().getvIfExists(Kernel.SERVICE_TYPE_TO_CLASS_MAP_KEY).get()).put(\"plugin\",\n                 GreengrassService.class.getName());\n         assertNotNull(deviceConfiguration.getThingName());\n+        CountDownLatch allComponentsInFssUpdate = new CountDownLatch(1);\n \n-        // Sleep for more time than the FSS publish interval so that we have all the data.\n-        TimeUnit.SECONDS.sleep(50);\n-        verify(mqttClient, atLeastOnce()).publish(captor.capture());\n+        when(mqttClient.publish(captor.capture())).thenAnswer(i -> {\n+            Object argument = i.getArgument(0);\n+            PublishRequest publishRequest = (PublishRequest) argument;\n+            FleetStatusDetails fleetStatusDetails = OBJECT_MAPPER.readValue(publishRequest.getPayload(),\n+                    FleetStatusDetails.class);\n+            if (componentNamesToCheck.size() == fleetStatusDetails.getComponentStatusDetails().size()) {\n+                allComponentsInFssUpdate.countDown();\n+            }\n+            return new CompletableFuture<>();\n+        });\n+\n+        // Wait for some time for the publish request to have all the components update.\n+        assertTrue(allComponentsInFssUpdate.await(20, TimeUnit.SECONDS));\n \n         List<PublishRequest> prs = captor.getAllValues();\n         // Get the last FSS publish request which should have all the components information.\n"}}, {"oid": "63442d4017dab23c41b492d5a9aa7b2c27d1cbca", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/63442d4017dab23c41b492d5a9aa7b2c27d1cbca", "message": "Don't sleep for a long time. Add logic to see the MQTT message sent.", "committedDate": "2020-10-15T04:15:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE1NTUyMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/532#discussion_r505155523", "bodyText": "return CompletableFuture.completeFuture(0) so the future has completed", "author": "MikeDombo", "createdAt": "2020-10-15T04:23:31Z", "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/status/PeriodicFleetStatusServiceTest.java", "diffHunk": "@@ -105,37 +100,41 @@ void GIVEN_config_with_small_periodic_interval_WHEN_interval_elapses_THEN_status\n         ((Map) kernel.getContext().getvIfExists(Kernel.SERVICE_TYPE_TO_CLASS_MAP_KEY).get()).put(\"plugin\",\n                 GreengrassService.class.getName());\n         assertNotNull(deviceConfiguration.getThingName());\n-        CountDownLatch fssPublishLatch = new CountDownLatch(1);\n-        logListener = eslm -> {\n-            if (eslm.getEventType() != null && eslm.getEventType().equals(\"fss-status-update-published\")\n-                    && eslm.getMessage().equals(\"Status update published to FSS\")) {\n-                fssPublishLatch.countDown();\n+        CountDownLatch allComponentsInFssUpdate = new CountDownLatch(1);\n+\n+        when(mqttClient.publish(captor.capture())).thenAnswer(i -> {\n+            Object argument = i.getArgument(0);\n+            PublishRequest publishRequest = (PublishRequest) argument;\n+            FleetStatusDetails fleetStatusDetails = OBJECT_MAPPER.readValue(publishRequest.getPayload(),\n+                    FleetStatusDetails.class);\n+            if (componentNamesToCheck.size() == fleetStatusDetails.getComponentStatusDetails().size()) {\n+                allComponentsInFssUpdate.countDown();\n             }\n-        };\n-        Slf4jLogAdapter.addGlobalListener(logListener);\n+            return new CompletableFuture<>();", "originalCommit": "63442d4017dab23c41b492d5a9aa7b2c27d1cbca", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0911de8677a17019edeace38465b54aa0e652650", "chunk": "diff --git a/src/integrationtests/java/com/aws/greengrass/integrationtests/status/PeriodicFleetStatusServiceTest.java b/src/integrationtests/java/com/aws/greengrass/integrationtests/status/PeriodicFleetStatusServiceTest.java\nindex 9382b59b7..c3605638e 100644\n--- a/src/integrationtests/java/com/aws/greengrass/integrationtests/status/PeriodicFleetStatusServiceTest.java\n+++ b/src/integrationtests/java/com/aws/greengrass/integrationtests/status/PeriodicFleetStatusServiceTest.java\n\n@@ -110,7 +110,7 @@ class PeriodicFleetStatusServiceTest extends BaseITCase {\n             if (componentNamesToCheck.size() == fleetStatusDetails.getComponentStatusDetails().size()) {\n                 allComponentsInFssUpdate.countDown();\n             }\n-            return new CompletableFuture<>();\n+            return CompletableFuture.completedFuture(0);\n         });\n \n         // Wait for some time for the publish request to have all the components update.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE1NTU1MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/532#discussion_r505155551", "bodyText": "Nice!", "author": "MikeDombo", "createdAt": "2020-10-15T04:23:37Z", "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/status/PeriodicFleetStatusServiceTest.java", "diffHunk": "@@ -105,37 +100,41 @@ void GIVEN_config_with_small_periodic_interval_WHEN_interval_elapses_THEN_status\n         ((Map) kernel.getContext().getvIfExists(Kernel.SERVICE_TYPE_TO_CLASS_MAP_KEY).get()).put(\"plugin\",\n                 GreengrassService.class.getName());\n         assertNotNull(deviceConfiguration.getThingName());\n-        CountDownLatch fssPublishLatch = new CountDownLatch(1);\n-        logListener = eslm -> {\n-            if (eslm.getEventType() != null && eslm.getEventType().equals(\"fss-status-update-published\")\n-                    && eslm.getMessage().equals(\"Status update published to FSS\")) {\n-                fssPublishLatch.countDown();\n+        CountDownLatch allComponentsInFssUpdate = new CountDownLatch(1);\n+\n+        when(mqttClient.publish(captor.capture())).thenAnswer(i -> {\n+            Object argument = i.getArgument(0);\n+            PublishRequest publishRequest = (PublishRequest) argument;\n+            FleetStatusDetails fleetStatusDetails = OBJECT_MAPPER.readValue(publishRequest.getPayload(),\n+                    FleetStatusDetails.class);\n+            if (componentNamesToCheck.size() == fleetStatusDetails.getComponentStatusDetails().size()) {\n+                allComponentsInFssUpdate.countDown();\n             }\n-        };\n-        Slf4jLogAdapter.addGlobalListener(logListener);\n+            return new CompletableFuture<>();\n+        });\n \n-        assertTrue(fssPublishLatch.await(40, TimeUnit.SECONDS));\n-        verify(mqttClient, atLeastOnce()).publish(captor.capture());\n+        // Wait for some time for the publish request to have all the components update.\n+        assertTrue(allComponentsInFssUpdate.await(20, TimeUnit.SECONDS));\n ", "originalCommit": "63442d4017dab23c41b492d5a9aa7b2c27d1cbca", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0911de8677a17019edeace38465b54aa0e652650", "chunk": "diff --git a/src/integrationtests/java/com/aws/greengrass/integrationtests/status/PeriodicFleetStatusServiceTest.java b/src/integrationtests/java/com/aws/greengrass/integrationtests/status/PeriodicFleetStatusServiceTest.java\nindex 9382b59b7..c3605638e 100644\n--- a/src/integrationtests/java/com/aws/greengrass/integrationtests/status/PeriodicFleetStatusServiceTest.java\n+++ b/src/integrationtests/java/com/aws/greengrass/integrationtests/status/PeriodicFleetStatusServiceTest.java\n\n@@ -110,7 +110,7 @@ class PeriodicFleetStatusServiceTest extends BaseITCase {\n             if (componentNamesToCheck.size() == fleetStatusDetails.getComponentStatusDetails().size()) {\n                 allComponentsInFssUpdate.countDown();\n             }\n-            return new CompletableFuture<>();\n+            return CompletableFuture.completedFuture(0);\n         });\n \n         // Wait for some time for the publish request to have all the components update.\n"}}, {"oid": "0911de8677a17019edeace38465b54aa0e652650", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0911de8677a17019edeace38465b54aa0e652650", "message": "Address PR comments.", "committedDate": "2020-10-15T04:31:50Z", "type": "commit"}, {"oid": "290542d096a27126cea508b807464ad9d257d969", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/290542d096a27126cea508b807464ad9d257d969", "message": "Merge branch 'master' into fixFlakyFssIntegTest", "committedDate": "2020-10-15T15:21:31Z", "type": "commit"}]}