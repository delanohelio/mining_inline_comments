{"pr_number": 701, "pr_title": "P41779817: Remove runtime config namespace", "pr_createdAt": "2020-11-18T23:49:57Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/701", "timeline": [{"oid": "94b8a69630b78a9d1387c95a11cfa4e5fd0f6c97", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/94b8a69630b78a9d1387c95a11cfa4e5fd0f6c97", "message": "P41779817: Remove runtime config namespace", "committedDate": "2020-11-18T23:42:13Z", "type": "commit"}, {"oid": "686e71080edeb5deef4fe89e23976d4bb11233fb", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/686e71080edeb5deef4fe89e23976d4bb11233fb", "message": "Merge branch 'master' into remove_config_namespace", "committedDate": "2020-11-19T05:04:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYyMDA1Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/701#discussion_r526620056", "bodyText": "We should remove this test altogether", "author": "shaguptashaikh", "createdAt": "2020-11-19T06:21:56Z", "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/deployment/DeploymentConfigMergingTest.java", "diffHunk": "@@ -655,10 +655,6 @@ void GIVEN_service_running_with_rollback_safe_param_WHEN_rollback_THEN_rollback_\n         assertTrue(sleeperBRolledBack.await(10, TimeUnit.SECONDS));\n         assertEquals(DeploymentResult.DeploymentStatus.FAILED_ROLLBACK_COMPLETE, result.getDeploymentStatus());\n \n-        // Value set in listener should not have been rolled back", "originalCommit": "686e71080edeb5deef4fe89e23976d4bb11233fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA4MzU4MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/701#discussion_r527083580", "bodyText": "Done", "author": "k-khatri", "createdAt": "2020-11-19T17:51:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYyMDA1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "330f69b17cf03e74e3ac9cd7939e7b3e000a721c", "chunk": "diff --git a/src/integrationtests/java/com/aws/greengrass/integrationtests/deployment/DeploymentConfigMergingTest.java b/src/integrationtests/java/com/aws/greengrass/integrationtests/deployment/DeploymentConfigMergingTest.java\nindex 65de57e0..5cdb1c06 100644\n--- a/src/integrationtests/java/com/aws/greengrass/integrationtests/deployment/DeploymentConfigMergingTest.java\n+++ b/src/integrationtests/java/com/aws/greengrass/integrationtests/deployment/DeploymentConfigMergingTest.java\n\n@@ -595,70 +595,6 @@ class DeploymentConfigMergingTest extends BaseITCase {\n         assertEquals(2, preComponentUpdateCount.get());\n     }\n \n-    @Test\n-    void GIVEN_service_running_with_rollback_safe_param_WHEN_rollback_THEN_rollback_safe_param_not_updated(\n-            ExtensionContext context) throws Throwable {\n-\n-        ignoreExceptionUltimateCauseWithMessage(context, \"Service sleeperB in broken state after deployment\");\n-\n-        // GIVEN\n-        ConfigPlatformResolver.initKernelWithMultiPlatformConfig(kernel,\n-                getClass().getResource(\"short_running_services_using_startup_script.yaml\"));\n-\n-        kernel.launch();\n-\n-        Configuration config = kernel.getConfig();\n-        config.lookup(SERVICES_NAMESPACE_TOPIC, \"sleeperB\", RUNTIME_STORE_NAMESPACE_TOPIC, \"testKey\")\n-                .withNewerValue(System.currentTimeMillis(), \"initialValue\");\n-\n-        // WHEN\n-        // merge broken config\n-        HashMap<String, Object> brokenConfig = new HashMap<String, Object>() {{\n-            put(SERVICES_NAMESPACE_TOPIC, new HashMap<String, Object>() {{\n-                put(\"sleeperB\", new HashMap<String, Object>() {{\n-                    put(SERVICE_LIFECYCLE_NAMESPACE_TOPIC, new HashMap<String, Object>() {{\n-                        put(LIFECYCLE_STARTUP_NAMESPACE_TOPIC, \"exit 1\");\n-                    }});\n-                }});\n-\n-                put(DEFAULT_NUCLEUS_COMPONENT_NAME, getNucleusConfig());\n-            }});\n-        }};\n-\n-        AtomicBoolean sleeperBBroken = new AtomicBoolean(false);\n-        CountDownLatch sleeperBRolledBack = new CountDownLatch(1);\n-        GlobalStateChangeListener listener = (service, oldState, newState) -> {\n-            if (service.getName().equals(\"sleeperB\")) {\n-                if (newState.equals(State.ERRORED)) {\n-                    config.find(SERVICES_NAMESPACE_TOPIC, \"sleeperB\", RUNTIME_STORE_NAMESPACE_TOPIC, \"testKey\")\n-                            .withNewerValue(System.currentTimeMillis(), \"setOnErrorValue\");\n-                }\n-                if (newState.equals(State.BROKEN)) {\n-                    sleeperBBroken.set(true);\n-                }\n-                if (sleeperBBroken.get() && newState.equals(State.RUNNING)) {\n-                    // Rollback should only count after error\n-                    sleeperBRolledBack.countDown();\n-                }\n-            }\n-        };\n-\n-        kernel.getContext().get(DeploymentDirectoryManager.class).createNewDeploymentDirectory(\n-                \"mockFleetConfigArn\");\n-        kernel.getContext().addGlobalStateChangeListener(listener);\n-        DeploymentResult result =\n-                deploymentConfigMerger.mergeInNewConfig(testRollbackDeployment(), brokenConfig)\n-                        .get(40, TimeUnit.SECONDS);\n-\n-        // THEN\n-        // deployment should have errored and rolled back\n-        assertTrue(sleeperBRolledBack.await(10, TimeUnit.SECONDS));\n-        assertEquals(DeploymentResult.DeploymentStatus.FAILED_ROLLBACK_COMPLETE, result.getDeploymentStatus());\n-\n-        // remove listener\n-        kernel.getContext().removeGlobalStateChangeListener(listener);\n-    }\n-\n     @Test\n     void GIVEN_kernel_running_single_service_WHEN_deployment_with_skip_safety_check_config_THEN_merge_without_checking_safety()\n             throws Throwable {\n"}}, {"oid": "330f69b17cf03e74e3ac9cd7939e7b3e000a721c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/330f69b17cf03e74e3ac9cd7939e7b3e000a721c", "message": "Removing the test which is no longer required", "committedDate": "2020-11-19T17:51:09Z", "type": "commit"}, {"oid": "fadbf20cfd32ba5cac55b82e5e7839b00c151b08", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fadbf20cfd32ba5cac55b82e5e7839b00c151b08", "message": "Fixing the PMD violations", "committedDate": "2020-11-19T18:15:49Z", "type": "commit"}, {"oid": "998e27762f1b82cc7d84df018d944471591297d1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/998e27762f1b82cc7d84df018d944471591297d1", "message": "Merge branch 'master' into remove_config_namespace", "committedDate": "2020-11-20T20:15:27Z", "type": "commit"}, {"oid": "09b90d11f86695fad53791afb055b193b2da3726", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/09b90d11f86695fad53791afb055b193b2da3726", "message": "Merge branch 'master' into remove_config_namespace", "committedDate": "2020-11-20T23:52:27Z", "type": "commit"}, {"oid": "1d86f1dc1d2011310ce9026f5ce2c8b5df54f35c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1d86f1dc1d2011310ce9026f5ce2c8b5df54f35c", "message": "Merge branch 'master' into remove_config_namespace", "committedDate": "2020-11-21T00:48:51Z", "type": "commit"}]}