{"pr_number": 153, "pr_title": "Fix bugs and clean up code", "pr_createdAt": "2020-04-03T01:03:54Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/153", "timeline": [{"oid": "a67c291cd35575c664c6417f3d086757bbadebf0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a67c291cd35575c664c6417f3d086757bbadebf0", "message": "Fix bugs and clean up code\n\nfix a couple NPEs;\nclean up Kernel.java a bit and remove broken flag;\nremove fallback main because it's currently not used;\nadd a few more verifications and tests;", "committedDate": "2020-04-03T00:58:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4MjYwMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/153#discussion_r402682602", "bodyText": "I know why you did this, but I don't feel that this is appropriately fixing it. The reason why it failed is that the subscriber is called immediately during the subscribe. Which I think we do want, since that will immediately cause the service to restart and wait for the dependency to come up. With the change that you've made it will not do this; instead it would need the dependency to change state again before triggering this handling.\nI think one potential fix is to overload dependencyReady with an extra parameter for the startWhen state. Alternatively, just remove the start when state because I think we've been talking about getting rid of it for a while.", "author": "MikeDombo", "createdAt": "2020-04-03T01:11:05Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -758,7 +758,8 @@ public synchronized void addOrUpdateDependency(\n     private Subscriber createDependencySubscriber(EvergreenService dependentEvergreenService) {\n         return (WhatHappened what, Topic t) -> {\n             if (this.getState() == State.INSTALLED || this.getState() == State.RUNNING) {\n-                if (!dependencyReady(dependentEvergreenService)) {\n+                if (dependencies.containsKey(dependentEvergreenService)", "originalCommit": "a67c291cd35575c664c6417f3d086757bbadebf0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY5MzI2Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/153#discussion_r402693262", "bodyText": "We're not using startWhen? Do we allow specify dependency on different states?", "author": "fengwang666", "createdAt": "2020-04-03T01:51:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4MjYwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY5NDAzNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/153#discussion_r402694037", "bodyText": "It is allowed, but I know that Shirley has talked about removing it. We're not really using it at this time. All startWhen is just Running.", "author": "MikeDombo", "createdAt": "2020-04-03T01:55:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4MjYwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY5NDg3OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/153#discussion_r402694879", "bodyText": "Given that we'll want hot pluggability, maybe instead you should change the signature to take a DependencyInfo, that way you can pass it in directly instead of reading it from the dependency map since it doesn't exist at that point.", "author": "MikeDombo", "createdAt": "2020-04-03T01:58:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4MjYwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjcyMjg5MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/153#discussion_r402722891", "bodyText": "I modified to pass in the startWhen.", "author": "fengwang666", "createdAt": "2020-04-03T03:53:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4MjYwMg=="}], "type": "inlineReview", "revised_code": {"commit": "a3b21c9b69007a4bea754be91dfbb34f06cccb8b", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java b/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\nindex 4750d4c7a2..d2d69e540d 100644\n--- a/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\n+++ b/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\n\n@@ -755,11 +771,10 @@ public class EvergreenService implements InjectionActions {\n         });\n     }\n \n-    private Subscriber createDependencySubscriber(EvergreenService dependentEvergreenService) {\n+    private Subscriber createDependencySubscriber(EvergreenService dependentEvergreenService, State startWhenState) {\n         return (WhatHappened what, Topic t) -> {\n             if (this.getState() == State.INSTALLED || this.getState() == State.RUNNING) {\n-                if (dependencies.containsKey(dependentEvergreenService)\n-                        && !dependencyReady(dependentEvergreenService)) {\n+                if (!dependencyReady(dependentEvergreenService, startWhenState)) {\n                     this.requestRestart();\n                     logger.atInfo().setEventType(\"service-restart\").log(\"Restart service because of dependencies\");\n                 }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4Mjc3Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/153#discussion_r402682773", "bodyText": "nit\ncreatePaths", "author": "MikeDombo", "createdAt": "2020-04-03T01:11:43Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -202,10 +209,7 @@ private void initPaths(String rootAbsolutePath) {\n         Exec.addFirstPath(clitoolPath);\n         workPath = Paths.get(deTilde(workPathName));\n         Exec.setDefaultEnv(\"HOME\", workPath.toString());\n-        ensureCreated(configPath);\n-        ensureCreated(clitoolPath);\n-        ensureCreated(rootPath);\n-        ensureCreated(workPath);\n+        createPath(rootPath, configPath, clitoolPath, workPath);", "originalCommit": "a67c291cd35575c664c6417f3d086757bbadebf0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0aadd8b8fffaa1f928201d428eb8ce56a05367ec", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/kernel/Kernel.java b/src/main/java/com/aws/iot/evergreen/kernel/Kernel.java\nindex 81c2d946e6..e473ccfa09 100644\n--- a/src/main/java/com/aws/iot/evergreen/kernel/Kernel.java\n+++ b/src/main/java/com/aws/iot/evergreen/kernel/Kernel.java\n\n@@ -209,7 +212,7 @@ public class Kernel extends Configuration /*implements Runnable*/ {\n         Exec.addFirstPath(clitoolPath);\n         workPath = Paths.get(deTilde(workPathName));\n         Exec.setDefaultEnv(\"HOME\", workPath.toString());\n-        createPath(rootPath, configPath, clitoolPath, workPath);\n+        createPaths(rootPath, configPath, clitoolPath, workPath);\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4MzExMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/153#discussion_r402683113", "bodyText": "Can this be scoped down from throwable? Maybe IOException?", "author": "MikeDombo", "createdAt": "2020-04-03T01:13:06Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -247,37 +248,38 @@ public Kernel launch() {\n         }\n         Path transactionLogPath = configPath.resolve(\"config.tlog\"); //Paths.get(deTilde(\"~root/config/config.tlog\"));\n         Path configurationFile = configPath.resolve(\"config.yaml\"); //Paths.get(deTilde(\"~root/config/config.yaml\"));\n-        if (!broken) {\n-            try {\n-                if (haveRead) {\n-                    // new config file came in from the outside\n-                    writeEffectiveConfig(configurationFile);\n-                    Files.deleteIfExists(transactionLogPath);\n-                } else {\n-                    if (Files.exists(configurationFile)) {\n-                        read(configurationFile);\n-                    }\n-                    if (Files.exists(transactionLogPath)) {\n-                        read(transactionLogPath);\n-                    }\n+        try {\n+            mainService = EvergreenService.locate(context, mainServiceName);\n+        } catch (ServiceLoadException sle) {\n+            RuntimeException rte =\n+                    new RuntimeException(\"Cannot load main service\", sle);\n+            logger.atError().setEventType(\"system-boot-error\").setCause(rte);\n+            throw rte;\n+        }\n+        try {\n+            if (haveRead) {\n+                // new config file came in from the outside\n+                writeEffectiveConfig(configurationFile);\n+                Files.deleteIfExists(transactionLogPath);\n+            } else {\n+                if (Files.exists(configurationFile)) {\n+                    read(configurationFile);\n+                }\n+                if (Files.exists(transactionLogPath)) {\n+                    read(transactionLogPath);\n                 }\n-                tlog = ConfigurationWriter.logTransactionsTo(this, transactionLogPath);\n-                tlog.flushImmediately(true);\n-            } catch (Throwable ioe) {\n-                // Too early in the boot to log a message\n-                logger.atError().setEventType(\"system-config-error\").setCause(ioe).log();\n-                broken = true;\n-                return this;\n             }\n+            tlog = ConfigurationWriter.logTransactionsTo(this, transactionLogPath);\n+            tlog.flushImmediately(true);\n+        } catch (Throwable ioe) {", "originalCommit": "a67c291cd35575c664c6417f3d086757bbadebf0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjcyMjY4Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/153#discussion_r402722686", "bodyText": "This will be revisited again. A lot of them haven't been cleaned up yet.", "author": "fengwang666", "createdAt": "2020-04-03T03:52:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4MzExMw=="}], "type": "inlineReview", "revised_code": {"commit": "9d6f3d7cb143b91ee50bcefdf9ca1de8095a7ea7", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/kernel/Kernel.java b/src/main/java/com/aws/iot/evergreen/kernel/Kernel.java\nindex 81c2d946e6..c5eb56f370 100644\n--- a/src/main/java/com/aws/iot/evergreen/kernel/Kernel.java\n+++ b/src/main/java/com/aws/iot/evergreen/kernel/Kernel.java\n\n@@ -246,8 +249,6 @@ public class Kernel extends Configuration /*implements Runnable*/ {\n         } catch (Throwable t) {\n             logger.atError().log(\"Error launching plugins\", t);\n         }\n-        Path transactionLogPath = configPath.resolve(\"config.tlog\"); //Paths.get(deTilde(\"~root/config/config.tlog\"));\n-        Path configurationFile = configPath.resolve(\"config.yaml\"); //Paths.get(deTilde(\"~root/config/config.yaml\"));\n         try {\n             mainService = EvergreenService.locate(context, mainServiceName);\n         } catch (ServiceLoadException sle) {\n"}}, {"oid": "7a54e4c73628b6279edadd396604e1be444b84b8", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7a54e4c73628b6279edadd396604e1be444b84b8", "message": "Merge branch 'master' into kernel-bugfix", "committedDate": "2020-04-03T03:41:33Z", "type": "commit"}, {"oid": "0aadd8b8fffaa1f928201d428eb8ce56a05367ec", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0aadd8b8fffaa1f928201d428eb8ce56a05367ec", "message": "Fix bugs and clean up code\n\nfix a couple NPEs;\nclean up Kernel.java a bit and remove broken flag;\nremove fallback main because it's currently not used;\nadd a few more verifications and tests;", "committedDate": "2020-04-03T03:46:53Z", "type": "commit"}, {"oid": "a3b21c9b69007a4bea754be91dfbb34f06cccb8b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a3b21c9b69007a4bea754be91dfbb34f06cccb8b", "message": "Address comments", "committedDate": "2020-04-03T03:46:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA4ODYyNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/153#discussion_r403088624", "bodyText": "This can be tricky. since this subscriber is created and added only once, if you update the same dependency with a different startWhen, it will not update the subscriber", "author": "ShirleyZheng92", "createdAt": "2020-04-03T15:31:11Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -756,7 +756,7 @@ public synchronized void addOrUpdateDependency(\n \n         dependencies.compute(dependentEvergreenService, (dependentService, dependencyInfo) -> {\n             if (dependencyInfo == null) {\n-                Subscriber subscriber = createDependencySubscriber(dependentEvergreenService);\n+                Subscriber subscriber = createDependencySubscriber(dependentEvergreenService, startWhen);", "originalCommit": "a3b21c9b69007a4bea754be91dfbb34f06cccb8b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzEwMjczNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/153#discussion_r403102734", "bodyText": "How about just removing the startWhen field?", "author": "fengwang666", "createdAt": "2020-04-03T15:53:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA4ODYyNA=="}], "type": "inlineReview", "revised_code": {"commit": "9d6f3d7cb143b91ee50bcefdf9ca1de8095a7ea7", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java b/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\nindex d2d69e540d..71ccb9b3e0 100644\n--- a/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\n+++ b/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\n\n@@ -755,19 +755,10 @@ public class EvergreenService implements InjectionActions {\n         }\n \n         dependencies.compute(dependentEvergreenService, (dependentService, dependencyInfo) -> {\n-            if (dependencyInfo == null) {\n-                Subscriber subscriber = createDependencySubscriber(dependentEvergreenService, startWhen);\n-                dependentEvergreenService.getStateTopic().subscribe(subscriber);\n-                context.get(Kernel.class).clearODcache();\n-                return new DependencyInfo(startWhen, isDefault, subscriber);\n-            } else {\n-                dependencyInfo.startWhen = startWhen;\n-                // if a dependency is added as both a default and a non-default, treat it as default dependency\n-                if (!dependencyInfo.isDefaultDependency) {\n-                    dependencyInfo.isDefaultDependency = isDefault;\n-                }\n-                return dependencyInfo;\n-            }\n+            Subscriber subscriber = createDependencySubscriber(dependentEvergreenService, startWhen);\n+            dependentEvergreenService.getStateTopic().subscribe(subscriber);\n+            context.get(Kernel.class).clearODcache();\n+            return new DependencyInfo(startWhen, isDefault, subscriber);\n         });\n     }\n \n"}}, {"oid": "9d6f3d7cb143b91ee50bcefdf9ca1de8095a7ea7", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9d6f3d7cb143b91ee50bcefdf9ca1de8095a7ea7", "message": "Address comments", "committedDate": "2020-04-03T21:48:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM1NTk3OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/153#discussion_r403355979", "bodyText": "Would it be crazy to just do this outside of the compute so that the value is in the map when dependencyRead() tries to look it up?", "author": "MikeDombo", "createdAt": "2020-04-03T21:57:23Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -755,26 +755,17 @@ public synchronized void addOrUpdateDependency(\n         }\n \n         dependencies.compute(dependentEvergreenService, (dependentService, dependencyInfo) -> {\n-            if (dependencyInfo == null) {\n-                Subscriber subscriber = createDependencySubscriber(dependentEvergreenService);\n-                dependentEvergreenService.getStateTopic().subscribe(subscriber);\n-                context.get(Kernel.class).clearODcache();\n-                return new DependencyInfo(startWhen, isDefault, subscriber);\n-            } else {\n-                dependencyInfo.startWhen = startWhen;\n-                // if a dependency is added as both a default and a non-default, treat it as default dependency\n-                if (!dependencyInfo.isDefaultDependency) {\n-                    dependencyInfo.isDefaultDependency = isDefault;\n-                }\n-                return dependencyInfo;\n-            }\n+            Subscriber subscriber = createDependencySubscriber(dependentEvergreenService, startWhen);\n+            dependentEvergreenService.getStateTopic().subscribe(subscriber);\n+            context.get(Kernel.class).clearODcache();", "originalCommit": "9d6f3d7cb143b91ee50bcefdf9ca1de8095a7ea7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM2NTM4MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/153#discussion_r403365380", "bodyText": "Surely it will work, but is that much better than the current way? What's the benefit?", "author": "fengwang666", "createdAt": "2020-04-03T22:26:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM1NTk3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM2NTkyMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/153#discussion_r403365923", "bodyText": "Just that passing everything through feels a bit ugly, especially when we need more than just the startWhen state.", "author": "MikeDombo", "createdAt": "2020-04-03T22:27:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM1NTk3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM3MDI3MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/153#discussion_r403370271", "bodyText": "I'm not sure if I completely get what you propose. If we try to construct the DependencyInfo outside and put it to dependencies, we can only construct it partially without the subscriber field and later we need to set the subscriber field. It's not ideal either.", "author": "fengwang666", "createdAt": "2020-04-03T22:42:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM1NTk3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "f96a319bb54e7ddb2babb2a2e492e645da2c7d14", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java b/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\nindex 71ccb9b3e0..2557c9e11a 100644\n--- a/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\n+++ b/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\n\n@@ -755,6 +755,11 @@ public class EvergreenService implements InjectionActions {\n         }\n \n         dependencies.compute(dependentEvergreenService, (dependentService, dependencyInfo) -> {\n+            // If the dependency already exists, we should first remove the subscriber before creating the\n+            // new subscriber with updated input.\n+            if (dependencyInfo != null) {\n+                dependentEvergreenService.getStateTopic().remove(dependencyInfo.stateTopicSubscriber);\n+            }\n             Subscriber subscriber = createDependencySubscriber(dependentEvergreenService, startWhen);\n             dependentEvergreenService.getStateTopic().subscribe(subscriber);\n             context.get(Kernel.class).clearODcache();\n"}}, {"oid": "f96a319bb54e7ddb2babb2a2e492e645da2c7d14", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f96a319bb54e7ddb2babb2a2e492e645da2c7d14", "message": "address comments not to create multiple subscribers for a dependency", "committedDate": "2020-04-03T23:04:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM4MjY2MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/153#discussion_r403382661", "bodyText": "Why do we want to resubscribe all the time? I believe we ought to be using computeIfAbsent and then just subscribing once.", "author": "MikeDombo", "createdAt": "2020-04-03T23:28:27Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -755,26 +755,22 @@ public synchronized void addOrUpdateDependency(\n         }\n \n         dependencies.compute(dependentEvergreenService, (dependentService, dependencyInfo) -> {\n-            if (dependencyInfo == null) {\n-                Subscriber subscriber = createDependencySubscriber(dependentEvergreenService);\n-                dependentEvergreenService.getStateTopic().subscribe(subscriber);\n-                context.get(Kernel.class).clearODcache();\n-                return new DependencyInfo(startWhen, isDefault, subscriber);\n-            } else {\n-                dependencyInfo.startWhen = startWhen;\n-                // if a dependency is added as both a default and a non-default, treat it as default dependency\n-                if (!dependencyInfo.isDefaultDependency) {\n-                    dependencyInfo.isDefaultDependency = isDefault;\n-                }\n-                return dependencyInfo;\n+            // If the dependency already exists, we should first remove the subscriber before creating the\n+            // new subscriber with updated input.\n+            if (dependencyInfo != null) {\n+                dependentEvergreenService.getStateTopic().remove(dependencyInfo.stateTopicSubscriber);", "originalCommit": "f96a319bb54e7ddb2babb2a2e492e645da2c7d14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM4NDMyNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/153#discussion_r403384325", "bodyText": "If startWhenState is updated, don't we need to create a different subscriber?", "author": "fengwang666", "createdAt": "2020-04-03T23:35:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM4MjY2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM4NDY4Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/153#discussion_r403384682", "bodyText": "Oh, maybe. If the subscriber is pulling the startWhenState from the lambda's closure.", "author": "MikeDombo", "createdAt": "2020-04-03T23:37:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM4MjY2MQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "a70d3730f9530e5bd20f25f772b367b20362dc1c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a70d3730f9530e5bd20f25f772b367b20362dc1c", "message": "Merge branch 'master' into kernel-bugfix", "committedDate": "2020-04-04T01:04:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIzNzU3Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/153#discussion_r404237573", "bodyText": "add \".log()\" in the end. Also is it good to log the error and throw it at the same time?", "author": "ShirleyZheng92", "createdAt": "2020-04-06T16:46:03Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -141,8 +140,13 @@ public Kernel parseArgs(String... args) {\n                         read(deTilde(getArg()));\n                         haveRead = true;\n                     } catch (Throwable ex) {\n-                        broken = true;\n-                        logger.atError().log(\"Can't read config file {}\", arg, ex.getLocalizedMessage());\n+                        // Usually we don't want to log and throw at the same time because it can produce duplicate logs\n+                        // if the handler of the exception also logs. However since we use structured logging, I\n+                        // decide to log the error so that the future logging parser can parse the exceptions.\n+                        RuntimeException rte =\n+                                new RuntimeException(String.format(\"Can't read the config file %s\", getArg()), ex);\n+                        logger.atError().setEventType(\"parse-args-error\").setCause(rte);", "originalCommit": "a70d3730f9530e5bd20f25f772b367b20362dc1c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI2MDE1OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/153#discussion_r404260159", "bodyText": "As I explained in the comment, since we're doing structure logging, I think it's better to log the error too so that if we going to use a tool to parse the log, the error log won't be lost.", "author": "fengwang666", "createdAt": "2020-04-06T17:21:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIzNzU3Mw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIzNzY5Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/153#discussion_r404237693", "bodyText": "Ditto", "author": "ShirleyZheng92", "createdAt": "2020-04-06T16:46:14Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -160,19 +164,17 @@ public Kernel parseArgs(String... args) {\n                     rootAbsolutePath = getArg();\n                     break;\n                 default:\n-                    logger.atError().log(\"Undefined command line argument: {}\", arg);\n-                    broken = true;\n-                    break;\n+                    RuntimeException rte =\n+                            new RuntimeException(String.format(\"Undefined command line argument: %s\", arg));\n+                    logger.atError().setEventType(\"parse-args-error\").setCause(rte);\n+                    throw rte;", "originalCommit": "a70d3730f9530e5bd20f25f772b367b20362dc1c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIzODIxOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/153#discussion_r404238218", "bodyText": "Curious, is it only available to Linux?", "author": "ShirleyZheng92", "createdAt": "2020-04-06T16:47:02Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -297,48 +294,36 @@ public Kernel launch() {\n             });\n         } catch (Throwable ex) {\n             logger.atError().setEventType(\"system-boot-error\").setCause(ex)\n-                    .log(\"***BOOT FAILED, SWITCHING TO FALLBACKMAIN*** \");\n-            mainServiceName = \"fallbackMain\";\n-            try {\n-                mainService = getMain();\n-            } catch (Throwable t) {\n-                logger.atError().setEventType(\"system-boot-error\").setCause(t)\n-                        .log(\"***FALLBACK BOOT FAILED, ABANDON ALL HOPE*** \");\n-            }\n+                    .log(\"***BOOT FAILED, EXITING*** \");\n+            // The error is not recoverable, throw the exception up.\n+            throw ex;\n         }\n         writeEffectiveConfig();\n-        try {\n-            logger.atInfo().setEventType(\"system-start\").addKeyValue(\"main\", getMain()).log();\n-            startupAllServices();\n-        } catch (Throwable ex) {\n-            logger.atError().setEventType(\"service-start-error\").setCause(ex).log();\n-        }\n+        logger.atInfo().setEventType(\"system-start\").addKeyValue(\"main\", getMain()).log();\n+        startupAllServices();\n+\n         return this;\n     }\n \n-    private boolean ensureCreated(Path p) {\n-        try {\n-            Files.createDirectories(p,\n-                    PosixFilePermissions.asFileAttribute(PosixFilePermissions.fromString(\"rwx------\")));\n-            return true;\n-        } catch (IOException ex) {\n-            logger.atError().setEventType(\"file-path-create-error\").setCause(ex).addKeyValue(\"filePath\", p).log();\n-            return false;\n+    private void createPaths(Path... paths) {\n+        for (Path p: paths) {\n+            try {\n+                Files.createDirectories(p,\n+                        PosixFilePermissions.asFileAttribute(PosixFilePermissions.fromString(\"rwx------\")));", "originalCommit": "a70d3730f9530e5bd20f25f772b367b20362dc1c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI2OTQwNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/153#discussion_r404269405", "bodyText": "It is available in some of the Windows that are posix-compliant. We'll need to revisit this when we're testing on Windows.", "author": "fengwang666", "createdAt": "2020-04-06T17:36:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIzODIxOA=="}], "type": "inlineReview", "revised_code": null}]}