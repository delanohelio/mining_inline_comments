{"pr_number": 565, "pr_title": "Using symlink with IPC server so that socket filepath is short", "pr_createdAt": "2020-10-23T08:38:21Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/565", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk0NjM5OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/565#discussion_r510946399", "bodyText": "how is this going to work given that stuff is running in their own work dirs?", "author": "MikeDombo", "createdAt": "2020-10-23T15:01:39Z", "path": "src/main/java/com/aws/greengrass/ipc/IPCEventStreamService.java", "diffHunk": "@@ -38,6 +39,7 @@\n                 new ObjectMapper().configure(DeserializationFeature.FAIL_ON_INVALID_SUBTYPE, false)\n                         .configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n     public static final String IPC_SERVER_DOMAIN_SOCKET_FILENAME = \"ipcEventStreamServer\";\n+    public static final String IPC_SERVER_DOMAIN_SOCKET_FILENAME_SYMLINK = \"./ipcEventStreamServer\";", "originalCommit": "f20365ef64835e2d59f1dbae7218ae7b97f59e21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAxOTc1MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/565#discussion_r511019751", "bodyText": "The components will read the absolute path from the env variable. This symlink is only being sent to IPC server.", "author": "abanthiy", "createdAt": "2020-10-23T17:02:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk0NjM5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAyMjM4MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/565#discussion_r511022381", "bodyText": "The clients don't have the same path problem?", "author": "MikeDombo", "createdAt": "2020-10-23T17:08:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk0NjM5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAyNzU5OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/565#discussion_r511027598", "bodyText": "I was thinking clients can control to create a symlink themselves if needed because any of the generated code does not configure socket options for them. The client themselves create the socket options, so this can be more of on need basis. However we can set relative link in the env variable but I just thought having relative link can be undeterministic (if the assumption of client having CWD as expected is not true). For integration tests in kernel it will be not true I think.", "author": "abanthiy", "createdAt": "2020-10-23T17:18:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk0NjM5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAyODQ4MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/565#discussion_r511028481", "bodyText": "We set the CWD, so we can make that assumption", "author": "MikeDombo", "createdAt": "2020-10-23T17:19:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk0NjM5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "d291259ab7e8f651e5f2fb7425a41d12b4436994", "chunk": "diff --git a/src/main/java/com/aws/greengrass/ipc/IPCEventStreamService.java b/src/main/java/com/aws/greengrass/ipc/IPCEventStreamService.java\nindex 1f338863e..1a218b735 100644\n--- a/src/main/java/com/aws/greengrass/ipc/IPCEventStreamService.java\n+++ b/src/main/java/com/aws/greengrass/ipc/IPCEventStreamService.java\n\n@@ -40,7 +41,12 @@ public class IPCEventStreamService implements Startable, Closeable {\n                         .configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n     public static final String IPC_SERVER_DOMAIN_SOCKET_FILENAME = \"ipcEventStreamServer\";\n     public static final String IPC_SERVER_DOMAIN_SOCKET_FILENAME_SYMLINK = \"./ipcEventStreamServer\";\n+    // This is relative to component's CWD\n+    public static final String IPC_SERVER_DOMAIN_SOCKET_RELATIVE_FILENAME = \"../../ipcEventStreamServer\";\n+\n     public static final String NUCLEUS_DOMAIN_SOCKET_FILEPATH = \"AWS_GG_NUCLEUS_DOMAIN_SOCKET_FILEPATH\";\n+    public static final String NUCLEUS_DOMAIN_SOCKET_COMPONENT_CWD_RELATIVE_FILEPATH =\n+            \"AWS_GG_NUCLEUS_DOMAIN_SOCKET_COMPONENT_CWD_RELATIVE_FILEPATH\";\n \n     private static Logger logger = LogManager.getLogger(IPCEventStreamService.class);\n \n"}}, {"oid": "d291259ab7e8f651e5f2fb7425a41d12b4436994", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d291259ab7e8f651e5f2fb7425a41d12b4436994", "message": "Using symlink with IPC server so that socket filepath is short", "committedDate": "2020-10-23T18:40:55Z", "type": "forcePushed"}, {"oid": "f33d0dc2db8599c30bcdd4ccdad10b3d4da6897f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f33d0dc2db8599c30bcdd4ccdad10b3d4da6897f", "message": "Using symlink with IPC server so that socket filepath is short", "committedDate": "2020-10-23T18:50:15Z", "type": "forcePushed"}, {"oid": "b629d22118c9a704b150574bb1fc213cf2b6bb30", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b629d22118c9a704b150574bb1fc213cf2b6bb30", "message": "Using symlink with IPC server so that socket filepath is short", "committedDate": "2020-10-23T18:51:46Z", "type": "forcePushed"}, {"oid": "e1999a74b092aee08acde6b3789111b334b72a76", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e1999a74b092aee08acde6b3789111b334b72a76", "message": "Making symlink to nucleus root rather than to the socket file", "committedDate": "2020-10-25T22:13:18Z", "type": "forcePushed"}, {"oid": "12db8f163de7c9fa624067c7f595117c2e3f858c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/12db8f163de7c9fa624067c7f595117c2e3f858c", "message": "Fixing deletion of nucleus root path symlink", "committedDate": "2020-10-25T22:26:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY3NTA4OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/565#discussion_r511675089", "bodyText": "you're assuming that the CWD of the nucleus is the root which isn't necessarily true. You should use an absolute path when creating and deleting the symlinks to make sure they're all pointing to the proper location.", "author": "MikeDombo", "createdAt": "2020-10-26T00:57:11Z", "path": "src/main/java/com/aws/greengrass/ipc/IPCEventStreamService.java", "diffHunk": "@@ -85,27 +96,51 @@ public void startup() {\n         socketOptions.domain = SocketOptions.SocketDomain.LOCAL;\n         socketOptions.type = SocketOptions.SocketType.STREAM;\n         eventLoopGroup = new EventLoopGroup(1);\n-        ipcServerSocketPath = kernel.getNucleusPaths().rootPath()\n+        ipcServerSocketAbsolutePath = kernel.getNucleusPaths().rootPath()\n                 .resolve(IPC_SERVER_DOMAIN_SOCKET_FILENAME).toString();\n-        if (Files.exists(Paths.get(ipcServerSocketPath))) {\n+\n+        if (Files.exists(Paths.get(ipcServerSocketAbsolutePath))) {\n             try {\n                 logger.atDebug().log(\"Deleting the ipc server socket descriptor file\");\n-                Files.delete(Paths.get(ipcServerSocketPath));\n+                Files.delete(Paths.get(ipcServerSocketAbsolutePath));\n             } catch (IOException e) {\n                 logger.atError().setCause(e).log(\"Failed to delete the ipc server socket descriptor file\");\n             }\n         }\n+        if (Files.exists(Paths.get(NUCLEUS_ROOT_PATH_SYMLINK), LinkOption.NOFOLLOW_LINKS)) {\n+            try {\n+                logger.atDebug().log(\"Deleting the nucleus root path symlink\");\n+                Files.delete(Paths.get(NUCLEUS_ROOT_PATH_SYMLINK));", "originalCommit": "12db8f163de7c9fa624067c7f595117c2e3f858c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjIwNDIwNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/565#discussion_r512204206", "bodyText": "You need to address this", "author": "MikeDombo", "createdAt": "2020-10-26T19:09:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY3NTA4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI4MzQ2Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/565#discussion_r512283467", "bodyText": "No I am not assuming that, whatever the CWD, the symlink is being created in that directory and pointing to absolute path. I can delete the symlink during close to ensure that whatever symlink was created get deleted on server shutdown.", "author": "abanthiy", "createdAt": "2020-10-26T21:36:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY3NTA4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI4NDgyNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/565#discussion_r512284827", "bodyText": "The symlink wont be in the correct place though!\nIf the CWD of the kernel is /root/home/GG, then the symlink could be pointing to the right thing, but the relative path ../../nucleusRoot/socket will not be correct", "author": "MikeDombo", "createdAt": "2020-10-26T21:38:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY3NTA4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI5NDM1Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/565#discussion_r512294352", "bodyText": "The relative path I am using is ../../ipcEventStreamServer.socket\nIrrespective of where the symlink is it should be able to get to that file in the nucleus root (assuming '../../' takes the component to kernel root)\nIs this assumption wrong? Is the CWD of component relative to kernel's CWD or kernel's root?", "author": "abanthiy", "createdAt": "2020-10-26T21:58:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY3NTA4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI5NTQ4MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/565#discussion_r512295481", "bodyText": "There are 2 relative paths that you're using. ./nucleusRoot/ipcEventStreamServer.socket is this path, which is relative to the kernel's CWD and not the component's CWDs. The kernel's CWD is not necessarily the root. Use nucleusPaths to get a proper path", "author": "MikeDombo", "createdAt": "2020-10-26T22:01:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY3NTA4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI5NjAzMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/565#discussion_r512296031", "bodyText": "NUCLEUS_ROOT_PATH_SYMLINK must be an absolute path or it needs to be correctly relative", "author": "MikeDombo", "createdAt": "2020-10-26T22:02:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY3NTA4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMwNTc4MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/565#discussion_r512305781", "bodyText": "As discussed offline, having as absolute path does not solve the underlying problem. The concern was that we are writing outside of nucleus root which is reduced by putting in a check to create symlink only when necessary.", "author": "abanthiy", "createdAt": "2020-10-26T22:25:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY3NTA4OQ=="}], "type": "inlineReview", "revised_code": {"commit": "c8c82a53c3d9a3b81a90871010be679d8934630b", "chunk": "diff --git a/src/main/java/com/aws/greengrass/ipc/IPCEventStreamService.java b/src/main/java/com/aws/greengrass/ipc/IPCEventStreamService.java\nindex 294ffbf83..b74584451 100644\n--- a/src/main/java/com/aws/greengrass/ipc/IPCEventStreamService.java\n+++ b/src/main/java/com/aws/greengrass/ipc/IPCEventStreamService.java\n\n@@ -107,26 +110,26 @@ public class IPCEventStreamService implements Startable, Closeable {\n                 logger.atError().setCause(e).log(\"Failed to delete the ipc server socket descriptor file\");\n             }\n         }\n-        if (Files.exists(Paths.get(NUCLEUS_ROOT_PATH_SYMLINK), LinkOption.NOFOLLOW_LINKS)) {\n-            try {\n-                logger.atDebug().log(\"Deleting the nucleus root path symlink\");\n-                Files.delete(Paths.get(NUCLEUS_ROOT_PATH_SYMLINK));\n-            } catch (IOException e) {\n-                logger.atError().setCause(e).log(\"Failed to delete the ipc server socket descriptor file symlink\");\n-            }\n-        }\n+\n         Topic kernelUri = config.getRoot().lookup(SETENV_CONFIG_NAMESPACE, NUCLEUS_DOMAIN_SOCKET_FILEPATH);\n         kernelUri.withValue(ipcServerSocketAbsolutePath);\n         Topic kernelRelativeUri = config.getRoot().lookup(SETENV_CONFIG_NAMESPACE,\n-                NUCLEUS_DOMAIN_SOCKET_COMPONENT_CWD_RELATIVE_FILEPATH);\n-        kernelRelativeUri.withValue(IPC_SERVER_DOMAIN_SOCKET_RELATIVE_FILENAME);\n+                NUCLEUS_DOMAIN_SOCKET_FILEPATH_FOR_COMPONENT);\n+        kernelRelativeUri.withValue(ipcServerSocketAbsolutePath);\n \n         boolean symLinkCreated = false;\n \n         try {\n-            Files.createSymbolicLink(Paths.get(NUCLEUS_ROOT_PATH_SYMLINK),\n-                    kernel.getNucleusPaths().rootPath());\n-            symLinkCreated = true;\n+            // Usually we do not want to write outside of kernel root. Because of socket path length limitations we\n+            // will create a symlink only if needed\n+            if (ipcServerSocketAbsolutePath.length() > UDS_SOCKET_PATH_MAX_LEN) {\n+                Files.createSymbolicLink(Paths.get(NUCLEUS_ROOT_PATH_SYMLINK), kernel.getNucleusPaths().rootPath());\n+                kernelRelativeUri = config.getRoot().lookup(SETENV_CONFIG_NAMESPACE,\n+                        NUCLEUS_DOMAIN_SOCKET_FILEPATH_FOR_COMPONENT);\n+                kernelRelativeUri.withValue(IPC_SERVER_DOMAIN_SOCKET_RELATIVE_FILENAME);\n+                symLinkCreated = true;\n+            }\n+\n         } catch (IOException e) {\n             logger.atError().setCause(e).log(\"Cannot setup symlinks for the ipc server socket path\");\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY3NTIwNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/565#discussion_r511675206", "bodyText": "remove?", "author": "MikeDombo", "createdAt": "2020-10-26T00:58:00Z", "path": "src/test/java/com/aws/greengrass/ipc/IPCEventStreamServiceTest.java", "diffHunk": "@@ -76,7 +84,18 @@\n     private AuthorizationHandler mockAuthorizationHandler;\n \n     @BeforeEach\n-    public void setup() {\n+    public void setup() throws IOException {\n+        Set<PosixFilePermission> filePermissions = Files.getPosixFilePermissions(mockRootPath);\n+        filePermissions.stream().forEach(perm -> logger.atInfo().log(perm));", "originalCommit": "12db8f163de7c9fa624067c7f595117c2e3f858c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI5NTMzMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/565#discussion_r512295331", "bodyText": "Done", "author": "abanthiy", "createdAt": "2020-10-26T22:00:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY3NTIwNg=="}], "type": "inlineReview", "revised_code": {"commit": "c8c82a53c3d9a3b81a90871010be679d8934630b", "chunk": "diff --git a/src/test/java/com/aws/greengrass/ipc/IPCEventStreamServiceTest.java b/src/test/java/com/aws/greengrass/ipc/IPCEventStreamServiceTest.java\nindex ffedb334f..2eed66537 100644\n--- a/src/test/java/com/aws/greengrass/ipc/IPCEventStreamServiceTest.java\n+++ b/src/test/java/com/aws/greengrass/ipc/IPCEventStreamServiceTest.java\n\n@@ -84,10 +77,7 @@ public class IPCEventStreamServiceTest {\n     private AuthorizationHandler mockAuthorizationHandler;\n \n     @BeforeEach\n-    public void setup() throws IOException {\n-        Set<PosixFilePermission> filePermissions = Files.getPosixFilePermissions(mockRootPath);\n-        filePermissions.stream().forEach(perm -> logger.atInfo().log(perm));\n-\n+    public void setup() {\n         AuthenticationData authenticationData = new AuthenticationData() {\n             @Override\n             public String getIdentityLabel() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY3NTI2MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/565#discussion_r511675261", "bodyText": "this won't be closed if the test fails. Use try with resources or try-finally", "author": "MikeDombo", "createdAt": "2020-10-26T00:58:28Z", "path": "src/test/java/com/aws/greengrass/ipc/IPCEventStreamServiceTest.java", "diffHunk": "@@ -97,41 +118,44 @@ public void tearDown() {\n     }\n \n     @Test\n-    public void testClientConnection() throws InterruptedException, IOException, ExecutionException {\n-        final ClientConnection[] clientConnectionArray = {null};\n+    @SuppressWarnings(\"PMD.CloseResource\")\n+    public void testClientConnection() throws Exception {\n         CountDownLatch connectionLatch = new CountDownLatch(1);\n \n         try (EventLoopGroup elg = new EventLoopGroup(1);\n              ClientBootstrap clientBootstrap = new ClientBootstrap(elg, new HostResolver(elg));\n              SocketOptions socketOptions = TestUtils.getSocketOptionsForIPC()) {\n \n             String ipcServerSocketPath = mockRootPath.resolve(IPC_SERVER_DOMAIN_SOCKET_FILENAME).toString();\n-            ClientConnection\n-                    .connect(ipcServerSocketPath, (short) DEFAULT_PORT_NUMBER, socketOptions, null, clientBootstrap, new ClientConnectionHandler() {\n-                        @Override\n-                        protected void onConnectionSetup(ClientConnection connection, int errorCode) {\n-                            connectionLatch.countDown();\n-                            clientConnectionArray[0] = connection;\n-                        }\n-\n-                        @Override\n-                        protected void onProtocolMessage(List<Header> headers, byte[] payload, MessageType messageType, int messageFlags) {\n-\n-                        }\n-\n-                        @Override\n-                        protected void onConnectionClosed(int closeReason) {\n-\n-                        }\n-                    }).get();\n+            final EventStreamRPCConnectionConfig config = new EventStreamRPCConnectionConfig(clientBootstrap, elg,\n+                    socketOptions, null, ipcServerSocketPath, DEFAULT_PORT_NUMBER,\n+                    GreengrassConnectMessageSupplier.connectMessageSupplier(\"authToken\"));\n+            final EventStreamRPCConnection connection = new EventStreamRPCConnection(config);\n+            final boolean disconnected[] = {false};\n+            final int disconnectedCode[] = {-1};\n+            //this is a bit cumbersome but does not prevent a convenience wrapper from exposing a sync\n+            //connect() or a connect() that returns a CompletableFuture that errors\n+            //this could be wrapped by utility methods to provide a more\n+            connection.connect(new EventStreamRPCConnection.LifecycleHandler() {\n+                @Override\n+                public void onConnect() {\n+                    connectionLatch.countDown();\n+                }\n+\n+                @Override\n+                public void onDisconnect(int errorCode) {\n+                    disconnected[0] = true;\n+                    disconnectedCode[0] = errorCode;\n+                }\n+\n+                //This on error is for any errors that is connection level, including problems during connect()\n+                @Override\n+                public boolean onError(Throwable t) {\n+                    return true;    //hints at handler to disconnect due to this error\n+                }\n+            });\n             assertTrue(connectionLatch.await(2, TimeUnit.SECONDS));\n-            GreengrassEventStreamConnectMessage connectMessagePayloadStructure =\n-                    new GreengrassEventStreamConnectMessage();\n-            connectMessagePayloadStructure.setAuthToken(\"authToken\");\n-            String payload = OBJECT_MAPPER.writeValueAsString(connectMessagePayloadStructure);\n-            clientConnectionArray[0].sendProtocolMessage(null, payload.getBytes(StandardCharsets.UTF_8),\n-                    MessageType.Connect, 0).get();\n-            clientConnectionArray[0].closeConnection(0);\n+            connection.close();", "originalCommit": "12db8f163de7c9fa624067c7f595117c2e3f858c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI5NTM3NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/565#discussion_r512295374", "bodyText": "Done", "author": "abanthiy", "createdAt": "2020-10-26T22:01:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY3NTI2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "c8c82a53c3d9a3b81a90871010be679d8934630b", "chunk": "diff --git a/src/test/java/com/aws/greengrass/ipc/IPCEventStreamServiceTest.java b/src/test/java/com/aws/greengrass/ipc/IPCEventStreamServiceTest.java\nindex ffedb334f..2eed66537 100644\n--- a/src/test/java/com/aws/greengrass/ipc/IPCEventStreamServiceTest.java\n+++ b/src/test/java/com/aws/greengrass/ipc/IPCEventStreamServiceTest.java\n\n@@ -121,16 +111,15 @@ public class IPCEventStreamServiceTest {\n     @SuppressWarnings(\"PMD.CloseResource\")\n     public void testClientConnection() throws Exception {\n         CountDownLatch connectionLatch = new CountDownLatch(1);\n-\n+        EventStreamRPCConnection connection = null;\n         try (EventLoopGroup elg = new EventLoopGroup(1);\n              ClientBootstrap clientBootstrap = new ClientBootstrap(elg, new HostResolver(elg));\n              SocketOptions socketOptions = TestUtils.getSocketOptionsForIPC()) {\n \n             String ipcServerSocketPath = mockRootPath.resolve(IPC_SERVER_DOMAIN_SOCKET_FILENAME).toString();\n-            final EventStreamRPCConnectionConfig config = new EventStreamRPCConnectionConfig(clientBootstrap, elg,\n-                    socketOptions, null, ipcServerSocketPath, DEFAULT_PORT_NUMBER,\n-                    GreengrassConnectMessageSupplier.connectMessageSupplier(\"authToken\"));\n-            final EventStreamRPCConnection connection = new EventStreamRPCConnection(config);\n+            final EventStreamRPCConnectionConfig config = new EventStreamRPCConnectionConfig(clientBootstrap, elg, socketOptions, null, ipcServerSocketPath, DEFAULT_PORT_NUMBER, GreengrassConnectMessageSupplier\n+                    .connectMessageSupplier(\"authToken\"));\n+            connection = new EventStreamRPCConnection(config);\n             final boolean disconnected[] = {false};\n             final int disconnectedCode[] = {-1};\n             //this is a bit cumbersome but does not prevent a convenience wrapper from exposing a sync\n"}}, {"oid": "c8c82a53c3d9a3b81a90871010be679d8934630b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c8c82a53c3d9a3b81a90871010be679d8934630b", "message": "Adding check to create symlink only when absolute path is greater than 108 chars", "committedDate": "2020-10-27T00:32:28Z", "type": "forcePushed"}, {"oid": "1bf2f9decdb27bffa8572cf9dc237f2e0442c914", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1bf2f9decdb27bffa8572cf9dc237f2e0442c914", "message": "Shortening the filename for ipc server socket", "committedDate": "2020-10-27T17:38:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA3NjcwOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/565#discussion_r513076709", "bodyText": "should we abort the startup?", "author": "MikeDombo", "createdAt": "2020-10-27T22:44:46Z", "path": "src/main/java/com/aws/greengrass/ipc/IPCEventStreamService.java", "diffHunk": "@@ -90,27 +104,51 @@ public void startup() {\n         socketOptions.domain = SocketOptions.SocketDomain.LOCAL;\n         socketOptions.type = SocketOptions.SocketType.STREAM;\n         eventLoopGroup = new EventLoopGroup(1);\n-        ipcServerSocketPath = kernel.getNucleusPaths().rootPath()\n+        ipcServerSocketAbsolutePath = kernel.getNucleusPaths().rootPath()\n                 .resolve(IPC_SERVER_DOMAIN_SOCKET_FILENAME).toString();\n-        if (Files.exists(Paths.get(ipcServerSocketPath))) {\n+\n+        if (Files.exists(Paths.get(ipcServerSocketAbsolutePath))) {\n             try {\n                 logger.atDebug().log(\"Deleting the ipc server socket descriptor file\");\n-                Files.delete(Paths.get(ipcServerSocketPath));\n+                Files.delete(Paths.get(ipcServerSocketAbsolutePath));\n             } catch (IOException e) {\n                 logger.atError().setCause(e).log(\"Failed to delete the ipc server socket descriptor file\");\n             }\n         }\n+\n         Topic kernelUri = config.getRoot().lookup(SETENV_CONFIG_NAMESPACE, NUCLEUS_DOMAIN_SOCKET_FILEPATH);\n-        kernelUri.withValue(ipcServerSocketPath);\n+        kernelUri.withValue(ipcServerSocketAbsolutePath);\n+        Topic kernelRelativeUri = config.getRoot().lookup(SETENV_CONFIG_NAMESPACE,\n+                NUCLEUS_DOMAIN_SOCKET_FILEPATH_FOR_COMPONENT);\n+        kernelRelativeUri.withValue(ipcServerSocketAbsolutePath);\n+\n+        boolean symLinkCreated = false;\n+\n+        try {\n+            // Usually we do not want to write outside of kernel root. Because of socket path length limitations we\n+            // will create a symlink only if needed\n+            if (ipcServerSocketAbsolutePath.length() > UDS_SOCKET_PATH_MAX_LEN) {\n+                Files.createSymbolicLink(Paths.get(NUCLEUS_ROOT_PATH_SYMLINK), kernel.getNucleusPaths().rootPath());\n+                kernelRelativeUri = config.getRoot().lookup(SETENV_CONFIG_NAMESPACE,\n+                        NUCLEUS_DOMAIN_SOCKET_FILEPATH_FOR_COMPONENT);\n+                kernelRelativeUri.withValue(IPC_SERVER_DOMAIN_SOCKET_RELATIVE_FILENAME);\n+                symLinkCreated = true;\n+            }\n+\n+        } catch (IOException e) {\n+            logger.atError().setCause(e).log(\"Cannot setup symlinks for the ipc server socket path\");", "originalCommit": "160669ed37d40c87cbd2204bab514e8b7febba0e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA5MDEzNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/565#discussion_r513090137", "bodyText": "The client still has option to create a symlink themselves and solve teh issue. I don;t want to take that away from them by not starting the server", "author": "abanthiy", "createdAt": "2020-10-27T23:24:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA3NjcwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "b230f6e200e6cd38c132eecd5d35393efbcefa75", "chunk": "diff --git a/src/main/java/com/aws/greengrass/ipc/IPCEventStreamService.java b/src/main/java/com/aws/greengrass/ipc/IPCEventStreamService.java\nindex 1e5774319..0a772bf0b 100644\n--- a/src/main/java/com/aws/greengrass/ipc/IPCEventStreamService.java\n+++ b/src/main/java/com/aws/greengrass/ipc/IPCEventStreamService.java\n\n@@ -104,51 +99,46 @@ public class IPCEventStreamService implements Startable, Closeable {\n         socketOptions.domain = SocketOptions.SocketDomain.LOCAL;\n         socketOptions.type = SocketOptions.SocketType.STREAM;\n         eventLoopGroup = new EventLoopGroup(1);\n-        ipcServerSocketAbsolutePath = kernel.getNucleusPaths().rootPath()\n+        ipcServerSocketPath = kernel.getNucleusPaths().rootPath()\n                 .resolve(IPC_SERVER_DOMAIN_SOCKET_FILENAME).toString();\n-\n-        if (Files.exists(Paths.get(ipcServerSocketAbsolutePath))) {\n+        if (Files.exists(Paths.get(ipcServerSocketPath))) {\n             try {\n                 logger.atDebug().log(\"Deleting the ipc server socket descriptor file\");\n-                Files.delete(Paths.get(ipcServerSocketAbsolutePath));\n+                Files.delete(Paths.get(ipcServerSocketPath));\n             } catch (IOException e) {\n                 logger.atError().setCause(e).log(\"Failed to delete the ipc server socket descriptor file\");\n             }\n         }\n-\n+        if (Files.exists(Paths.get(IPC_SERVER_DOMAIN_SOCKET_FILENAME_SYMLINK), LinkOption.NOFOLLOW_LINKS)) {\n+            try {\n+                logger.atDebug().log(\"Deleting the ipc server socket descriptor file symlink\");\n+                Files.delete(Paths.get(IPC_SERVER_DOMAIN_SOCKET_FILENAME_SYMLINK));\n+            } catch (IOException e) {\n+                logger.atError().setCause(e).log(\"Failed to delete the ipc server socket descriptor file symlink\");\n+            }\n+        }\n         Topic kernelUri = config.getRoot().lookup(SETENV_CONFIG_NAMESPACE, NUCLEUS_DOMAIN_SOCKET_FILEPATH);\n-        kernelUri.withValue(ipcServerSocketAbsolutePath);\n+        kernelUri.withValue(ipcServerSocketPath);\n         Topic kernelRelativeUri = config.getRoot().lookup(SETENV_CONFIG_NAMESPACE,\n-                NUCLEUS_DOMAIN_SOCKET_FILEPATH_FOR_COMPONENT);\n-        kernelRelativeUri.withValue(ipcServerSocketAbsolutePath);\n-\n+                NUCLEUS_DOMAIN_SOCKET_COMPONENT_CWD_RELATIVE_FILEPATH);\n+        kernelRelativeUri.withValue(IPC_SERVER_DOMAIN_SOCKET_RELATIVE_FILENAME);\n         boolean symLinkCreated = false;\n-\n         try {\n-            // Usually we do not want to write outside of kernel root. Because of socket path length limitations we\n-            // will create a symlink only if needed\n-            if (ipcServerSocketAbsolutePath.length() > UDS_SOCKET_PATH_MAX_LEN) {\n-                Files.createSymbolicLink(Paths.get(NUCLEUS_ROOT_PATH_SYMLINK), kernel.getNucleusPaths().rootPath());\n-                kernelRelativeUri = config.getRoot().lookup(SETENV_CONFIG_NAMESPACE,\n-                        NUCLEUS_DOMAIN_SOCKET_FILEPATH_FOR_COMPONENT);\n-                kernelRelativeUri.withValue(IPC_SERVER_DOMAIN_SOCKET_RELATIVE_FILENAME);\n-                symLinkCreated = true;\n-            }\n-\n+            Files.createSymbolicLink(Paths.get(IPC_SERVER_DOMAIN_SOCKET_FILENAME_SYMLINK),\n+                    Paths.get(ipcServerSocketPath));\n+            symLinkCreated = true;\n         } catch (IOException e) {\n             logger.atError().setCause(e).log(\"Cannot setup symlinks for the ipc server socket path\");\n         }\n-\n         // For domain sockets:\n         // 1. Port number is ignored. IpcServer does not accept a null value so we are using a default value.\n         // 2. The hostname parameter expects the socket filepath\n         ipcServer = new IpcServer(eventLoopGroup, socketOptions, null,\n-                symLinkCreated ? IPC_SERVER_DOMAIN_SOCKET_FILENAME_SYMLINK : ipcServerSocketAbsolutePath,\n-                DEFAULT_PORT_NUMBER, greengrassCoreIPCService);\n+                symLinkCreated ? IPC_SERVER_DOMAIN_SOCKET_FILENAME_SYMLINK : ipcServerSocketPath, DEFAULT_PORT_NUMBER,\n+                greengrassCoreIPCService);\n         ipcServer.runServer();\n     }\n \n-\n     @SuppressWarnings(\"PMD.UnusedFormalParameter\")\n     private Authorization ipcAuthorizationHandler(AuthenticationData authenticationData) {\n         // No authorization on service level exist for whole IPC right now so returning ACCEPT for all authenticated\n"}}, {"oid": "b230f6e200e6cd38c132eecd5d35393efbcefa75", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b230f6e200e6cd38c132eecd5d35393efbcefa75", "message": "Using symlink with IPC server so that socket filepath is short", "committedDate": "2020-10-27T23:17:02Z", "type": "commit"}, {"oid": "e4cf64ec472c9b60f1bfd503a0220f8cf57ecbdb", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e4cf64ec472c9b60f1bfd503a0220f8cf57ecbdb", "message": "Removing symlink in the IPCServer close", "committedDate": "2020-10-27T23:18:47Z", "type": "commit"}, {"oid": "5113c8652a795a48a47286f0bae978a86c11c254", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5113c8652a795a48a47286f0bae978a86c11c254", "message": "Reverting symlink closure in close and using library code to create IPC connection in the test", "committedDate": "2020-10-27T23:19:22Z", "type": "commit"}, {"oid": "b387c43ce8530ef35b91b3f874d5ba322278c821", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b387c43ce8530ef35b91b3f874d5ba322278c821", "message": "Trying socket extention with the filename", "committedDate": "2020-10-27T23:19:22Z", "type": "commit"}, {"oid": "e38171d9bde6de1332a6a434d2d657c04e4899db", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e38171d9bde6de1332a6a434d2d657c04e4899db", "message": "Making symlink to nucleus root rather than to the socket file", "committedDate": "2020-10-27T23:19:22Z", "type": "commit"}, {"oid": "18bedbc31cad19b3859b10b54924f2170567ec8f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/18bedbc31cad19b3859b10b54924f2170567ec8f", "message": "Fixing deletion of nucleus root path symlink", "committedDate": "2020-10-27T23:19:22Z", "type": "commit"}, {"oid": "e03dca2911eead14999f48c2c46768e993e7f5ef", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e03dca2911eead14999f48c2c46768e993e7f5ef", "message": "Adding check to create symlink only when absolute path is greater than 108 chars", "committedDate": "2020-10-27T23:19:22Z", "type": "commit"}, {"oid": "2687acde969f3f76de0f5e1c25d3e2e57f18ba13", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2687acde969f3f76de0f5e1c25d3e2e57f18ba13", "message": "Shortening the filename for ipc server socket", "committedDate": "2020-10-27T23:19:22Z", "type": "commit"}, {"oid": "2687acde969f3f76de0f5e1c25d3e2e57f18ba13", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2687acde969f3f76de0f5e1c25d3e2e57f18ba13", "message": "Shortening the filename for ipc server socket", "committedDate": "2020-10-27T23:19:22Z", "type": "forcePushed"}]}