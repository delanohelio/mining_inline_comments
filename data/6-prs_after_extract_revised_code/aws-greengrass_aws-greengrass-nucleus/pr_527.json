{"pr_number": 527, "pr_title": "Fix problem with unarchiving being skipped for local artifacts ", "pr_createdAt": "2020-10-14T19:13:15Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/527", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk0Mjc0NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/527#discussion_r504942744", "bodyText": "missing space in log message", "author": "MikeDombo", "createdAt": "2020-10-14T20:09:17Z", "path": "src/main/java/com/aws/greengrass/componentmanager/plugins/GreengrassRepositoryDownloader.java", "diffHunk": "@@ -149,6 +149,10 @@ public long getDownloadSize(ComponentIdentifier componentIdentifier, ComponentAr\n             return length;\n         } catch (IOException e) {\n             throw new PackageDownloadException(\"Failed to get download size\", e);\n+        } catch (PackageDownloadException e) {\n+            logger.atWarn(\"get-download-size-from-greengrass-repo\").log(\"failed getting size.\"\n+                    + \"continuing assuming size is 0\", e);", "originalCommit": "8776020e8a37fedf49280b784322bd8bef1b40e5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2ef1c4ed469e7e424bbd980791f92c68ea243a24", "chunk": "diff --git a/src/main/java/com/aws/greengrass/componentmanager/plugins/GreengrassRepositoryDownloader.java b/src/main/java/com/aws/greengrass/componentmanager/plugins/GreengrassRepositoryDownloader.java\nindex 357a4d970b..0cde20066c 100644\n--- a/src/main/java/com/aws/greengrass/componentmanager/plugins/GreengrassRepositoryDownloader.java\n+++ b/src/main/java/com/aws/greengrass/componentmanager/plugins/GreengrassRepositoryDownloader.java\n\n@@ -142,6 +146,7 @@ public class GreengrassRepositoryDownloader extends ArtifactDownloader {\n                     getArtifactDownloadURL(componentIdentifier, artifact.getArtifactUri().getSchemeSpecificPart());\n             URL url = new URL(preSignedUrl);\n             HttpURLConnection conn = connect(url);\n+            conn.setRequestMethod(\"HEAD\");\n             long length = conn.getContentLengthLong();\n             if (length == -1) {\n                 throw new PackageDownloadException(\"Failed to get download size\");\n"}}, {"oid": "2ef1c4ed469e7e424bbd980791f92c68ea243a24", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2ef1c4ed469e7e424bbd980791f92c68ea243a24", "message": "Remove early check for if component download is required to fix UAT regression", "committedDate": "2020-10-14T20:33:41Z", "type": "forcePushed"}, {"oid": "ab0d1c114a700cdda35ce79d382d98fad2bc4c45", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ab0d1c114a700cdda35ce79d382d98fad2bc4c45", "message": "Fix problem with unarchiving being skipped for local artifacts", "committedDate": "2020-10-14T20:34:56Z", "type": "forcePushed"}, {"oid": "13ed7028ba0cd23eea89ae97cb907cb9fe455dbd", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/13ed7028ba0cd23eea89ae97cb907cb9fe455dbd", "message": "Fix problem with unarchiving being skipped for local artifacts", "committedDate": "2020-10-14T20:43:29Z", "type": "commit"}, {"oid": "13ed7028ba0cd23eea89ae97cb907cb9fe455dbd", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/13ed7028ba0cd23eea89ae97cb907cb9fe455dbd", "message": "Fix problem with unarchiving being skipped for local artifacts", "committedDate": "2020-10-14T20:43:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk2MjA4NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/527#discussion_r504962085", "bodyText": "this isn't getting the size?", "author": "MikeDombo", "createdAt": "2020-10-14T20:46:41Z", "path": "src/main/java/com/aws/greengrass/componentmanager/plugins/ArtifactDownloader.java", "diffHunk": "@@ -144,13 +144,26 @@ public abstract File downloadToPath(ComponentIdentifier componentIdentifier, Com\n      *\n      * @param componentIdentifier package info\n      * @param artifact artifact info\n-     * @param saveToPath path of directory where the artifact is expected to exist\n+     * @param artifactDir path of directory where the artifact is expected to exist\n      * @return size of the artifact in bytes\n      * @throws InvalidArtifactUriException if provided info results in invalid URI\n      * @throws PackageDownloadException if error encountered\n      */\n     public abstract long getDownloadSize(ComponentIdentifier componentIdentifier, ComponentArtifact artifact,\n-                                         Path saveToPath)\n+                                         Path artifactDir)\n             throws InvalidArtifactUriException, PackageDownloadException;\n+\n+    /**\n+     * Get the download size of an artifact file.", "originalCommit": "13ed7028ba0cd23eea89ae97cb907cb9fe455dbd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c3738120eaf1dd8da9764aaa7b077c4640eab8bb", "chunk": "diff --git a/src/main/java/com/aws/greengrass/componentmanager/plugins/ArtifactDownloader.java b/src/main/java/com/aws/greengrass/componentmanager/plugins/ArtifactDownloader.java\nindex 5e6019fb0e..1c8e288fe0 100644\n--- a/src/main/java/com/aws/greengrass/componentmanager/plugins/ArtifactDownloader.java\n+++ b/src/main/java/com/aws/greengrass/componentmanager/plugins/ArtifactDownloader.java\n\n@@ -154,14 +154,13 @@ public abstract class ArtifactDownloader {\n             throws InvalidArtifactUriException, PackageDownloadException;\n \n     /**\n-     * Get the download size of an artifact file.\n+     * Get the artifact file.\n      *\n-     * @param saveToPath path of directory where the artifact is expected to exist\n-     * @param artifact artifact info\n+     * @param saveToPath          path of directory where the artifact is expected to exist\n+     * @param artifact            artifact info\n      * @param componentIdentifier component info\n      * @return artifact file that was either downloaded or had been locally present\n      * @throws InvalidArtifactUriException if provided info results in invalid URI\n-     * @throws PackageDownloadException if error encountered\n      */\n     public abstract File getArtifactFile(Path saveToPath, ComponentArtifact artifact,\n                                          ComponentIdentifier componentIdentifier) throws InvalidArtifactUriException;\n"}}, {"oid": "93a55625364fd92f72c62d38f7698dc97f14aac8", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/93a55625364fd92f72c62d38f7698dc97f14aac8", "message": "fix unarchiver test", "committedDate": "2020-10-14T21:15:25Z", "type": "commit"}, {"oid": "4774484eaa83a10ce9007a3050995f811a04a926", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4774484eaa83a10ce9007a3050995f811a04a926", "message": "fix unarchiver integ test", "committedDate": "2020-10-14T21:31:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk4Mzg5Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/527#discussion_r504983893", "bodyText": "add a space before %d", "author": "MikeDombo", "createdAt": "2020-10-14T21:31:07Z", "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentManager.java", "diffHunk": "@@ -349,36 +349,36 @@ void prepareArtifacts(ComponentIdentifier componentIdentifier, List<ComponentArt\n                                 usableSpaceBytes, DEFAULT_MIN_DISK_AVAIL_BYTES));\n             }\n             ArtifactDownloader downloader = selectArtifactDownloader(artifact.getArtifactUri());\n-            if (!downloader.downloadRequired(componentIdentifier, artifact, packageArtifactDirectory)) {\n-                continue;\n-            }\n-            long downloadSize = downloader.getDownloadSize(componentIdentifier, artifact, packageArtifactDirectory);\n-            long storeContentSize = componentStore.getContentSize();\n-            if (storeContentSize + downloadSize > DEFAULT_MAX_STORE_SIZE_BYTES) {\n-                throw new SizeLimitException(String.format(\n-                        \"Component store size limit reached: %d bytes existing, %d bytes needed,\"\n-                                + \"%d bytes maximum allowed total\", storeContentSize, downloadSize,\n-                        DEFAULT_MAX_STORE_SIZE_BYTES));\n-            }\n \n-            File downloadedFile;\n-            try {\n-                downloadedFile = downloader.downloadToPath(componentIdentifier, artifact, packageArtifactDirectory);\n-            } catch (IOException e) {\n-                throw new PackageDownloadException(\n-                        String.format(\"Failed to download package %s artifact %s\", componentIdentifier, artifact), e);\n+            if (downloader.downloadRequired(componentIdentifier, artifact, packageArtifactDirectory)) {\n+                long downloadSize = downloader.getDownloadSize(componentIdentifier, artifact, packageArtifactDirectory);\n+                long storeContentSize = componentStore.getContentSize();\n+                if (storeContentSize + downloadSize > DEFAULT_MAX_STORE_SIZE_BYTES) {\n+                    throw new SizeLimitException(String.format(\n+                            \"Component store size limit reached: %d bytes existing, %d bytes needed,\"\n+                                    + \"%d bytes maximum allowed total\", storeContentSize, downloadSize,", "originalCommit": "93a55625364fd92f72c62d38f7698dc97f14aac8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1a52e62318fc480bb3076f53bfd078baa931d4cc", "chunk": "diff --git a/src/main/java/com/aws/greengrass/componentmanager/ComponentManager.java b/src/main/java/com/aws/greengrass/componentmanager/ComponentManager.java\nindex f6904a311d..125a7d87f5 100644\n--- a/src/main/java/com/aws/greengrass/componentmanager/ComponentManager.java\n+++ b/src/main/java/com/aws/greengrass/componentmanager/ComponentManager.java\n\n@@ -355,8 +355,8 @@ public class ComponentManager implements InjectionActions {\n                 long storeContentSize = componentStore.getContentSize();\n                 if (storeContentSize + downloadSize > DEFAULT_MAX_STORE_SIZE_BYTES) {\n                     throw new SizeLimitException(String.format(\n-                            \"Component store size limit reached: %d bytes existing, %d bytes needed,\"\n-                                    + \"%d bytes maximum allowed total\", storeContentSize, downloadSize,\n+                            \"Component store size limit reached: %d bytes existing, %d bytes needed\"\n+                                    + \", %d bytes maximum allowed total\", storeContentSize, downloadSize,\n                             DEFAULT_MAX_STORE_SIZE_BYTES));\n                 }\n                 try {\n"}}, {"oid": "b02d75f78a7a502fcf6c17c61b8049c11516e4d1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b02d75f78a7a502fcf6c17c61b8049c11516e4d1", "message": "Merge branch 'master' into unarchive-fix", "committedDate": "2020-10-14T21:31:20Z", "type": "commit"}, {"oid": "1a52e62318fc480bb3076f53bfd078baa931d4cc", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1a52e62318fc480bb3076f53bfd078baa931d4cc", "message": "Pretty comment", "committedDate": "2020-10-14T21:43:01Z", "type": "commit"}, {"oid": "1a52e62318fc480bb3076f53bfd078baa931d4cc", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1a52e62318fc480bb3076f53bfd078baa931d4cc", "message": "Pretty comment", "committedDate": "2020-10-14T21:43:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk5NDk2NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/527#discussion_r504994964", "bodyText": "change this back", "author": "MikeDombo", "createdAt": "2020-10-14T21:51:16Z", "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/componentmanager/ComponentManagerIntegTest.java", "diffHunk": "@@ -72,7 +73,7 @@ void GIVEN_component_with_archived_artifact_WHEN_prepareArtifacts_THEN_unarchive\n         kernel.getContext()\n               .get(ComponentManager.class)\n               .preparePackages(Collections.singletonList(ident))\n-              .get(10, TimeUnit.SECONDS);\n+              .get(1000000, TimeUnit.SECONDS);", "originalCommit": "1a52e62318fc480bb3076f53bfd078baa931d4cc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c3738120eaf1dd8da9764aaa7b077c4640eab8bb", "chunk": "diff --git a/src/integrationtests/java/com/aws/greengrass/integrationtests/componentmanager/ComponentManagerIntegTest.java b/src/integrationtests/java/com/aws/greengrass/integrationtests/componentmanager/ComponentManagerIntegTest.java\nindex c143fb136e..3851049a16 100644\n--- a/src/integrationtests/java/com/aws/greengrass/integrationtests/componentmanager/ComponentManagerIntegTest.java\n+++ b/src/integrationtests/java/com/aws/greengrass/integrationtests/componentmanager/ComponentManagerIntegTest.java\n\n@@ -73,7 +73,7 @@ class ComponentManagerIntegTest extends BaseITCase {\n         kernel.getContext()\n               .get(ComponentManager.class)\n               .preparePackages(Collections.singletonList(ident))\n-              .get(1000000, TimeUnit.SECONDS);\n+              .get(10, TimeUnit.SECONDS);\n \n         Path zipPath = nucleusPaths.unarchiveArtifactPath(ident, \"zip\");\n         assertThat(zipPath.toFile(), anExistingDirectory());\n"}}, {"oid": "c3738120eaf1dd8da9764aaa7b077c4640eab8bb", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c3738120eaf1dd8da9764aaa7b077c4640eab8bb", "message": "Minor comments", "committedDate": "2020-10-14T21:55:36Z", "type": "commit"}, {"oid": "3c60dad6c0568ecf556ef2d7275f7e5602dde526", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3c60dad6c0568ecf556ef2d7275f7e5602dde526", "message": "Merge branch 'master' into unarchive-fix", "committedDate": "2020-10-14T21:56:09Z", "type": "commit"}, {"oid": "52c50761fe2a98bfa5c8c886631e489da64be335", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/52c50761fe2a98bfa5c8c886631e489da64be335", "message": "Merge branch 'master' into unarchive-fix", "committedDate": "2020-10-14T22:31:12Z", "type": "commit"}]}