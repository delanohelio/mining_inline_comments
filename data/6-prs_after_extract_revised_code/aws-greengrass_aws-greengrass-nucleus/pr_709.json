{"pr_number": 709, "pr_title": "Fix multiple kernel update bugs", "pr_createdAt": "2020-11-20T01:09:31Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/709", "timeline": [{"oid": "8b5037b16ac9b44ccbc611ec6c0bf47b58e178f1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8b5037b16ac9b44ccbc611ec6c0bf47b58e178f1", "message": "Fix multiple kernel update bugs", "committedDate": "2020-11-20T01:12:58Z", "type": "commit"}, {"oid": "8b5037b16ac9b44ccbc611ec6c0bf47b58e178f1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8b5037b16ac9b44ccbc611ec6c0bf47b58e178f1", "message": "Fix multiple kernel update bugs", "committedDate": "2020-11-20T01:12:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzM0MDM2MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/709#discussion_r527340360", "bodyText": "why close the tlog? The merge on L71 won't get persisted. Is that intentional?", "author": "MikeDombo", "createdAt": "2020-11-20T01:43:13Z", "path": "src/main/java/com/aws/greengrass/deployment/activator/KernelUpdateActivator.java", "diffHunk": "@@ -62,15 +62,18 @@ public void activate(Map<String, Object> newConfig, Deployment deployment,\n         }\n \n         DeploymentDocument deploymentDocument = deployment.getDeploymentDocumentObj();\n-        // Wait for all services to close\n-        kernel.getContext().get(KernelLifecycle.class).stopAllServices(30);\n+        KernelLifecycle lifecycle = kernel.getContext().get(KernelLifecycle.class);\n+        // Preserve tlog state before launch directory is updated to reflect ongoing deployment.\n+        lifecycle.getTlog().close();", "originalCommit": "8b5037b16ac9b44ccbc611ec6c0bf47b58e178f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzM0NTA3Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/709#discussion_r527345077", "bodyText": "Yes. After merge, the full config will only be persisted to target.tlog.\nEarlier if anything fails between config merge and launch dir setup https://github.com/aws/aws-greengrass-nucleus/blob/8b5037b16ac9b44ccbc611ec6c0bf47b58e178f1/src/main/java/com/aws/greengrass/deployment/activator/KernelUpdateActivator.java#L72-L76, nucleus will start into the new config.tlog without executing the remaining parts of the deployment. When it gets notified of the same deployment later, it will appear to have no change in the config", "author": "hui-yang", "createdAt": "2020-11-20T01:57:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzM0MDM2MA=="}], "type": "inlineReview", "revised_code": null}]}