{"pr_number": 176, "pr_title": "Add e2e test for fixing a BROKEN service", "pr_createdAt": "2020-04-10T22:11:31Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/176", "timeline": [{"oid": "b5d761dba290ec3d1ac4707e6f9beb1008615d93", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b5d761dba290ec3d1ac4707e6f9beb1008615d93", "message": "Add e2e test for fixing a BROKEN service", "committedDate": "2020-04-10T22:07:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk2NTA0Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/176#discussion_r406965047", "bodyText": "I assume this was for testing locally? We do want to clean.", "author": "MikeDombo", "createdAt": "2020-04-10T22:13:48Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/DeploymentE2ETest.java", "diffHunk": "@@ -78,8 +78,8 @@ void afterEach() {\n     @AfterAll\n     static void afterAll() {\n         // Cleanup all IoT thing resources we created\n-        Utils.cleanAllCreatedThings();\n-        Utils.cleanAllCreatedJobs();\n+        // Utils.cleanAllCreatedThings();", "originalCommit": "b5d761dba290ec3d1ac4707e6f9beb1008615d93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk2OTA0OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/176#discussion_r406969049", "bodyText": "Yeah. Will clean up.", "author": "fengwang666", "createdAt": "2020-04-10T22:29:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk2NTA0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "098abedadad9720f33750bd9a6782b3305d07fb3", "chunk": "diff --git a/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/DeploymentE2ETest.java b/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/DeploymentE2ETest.java\nindex 5abd3283f9..ed94a0f0b6 100644\n--- a/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/DeploymentE2ETest.java\n+++ b/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/DeploymentE2ETest.java\n\n@@ -78,8 +78,8 @@ class DeploymentE2ETest {\n     @AfterAll\n     static void afterAll() {\n         // Cleanup all IoT thing resources we created\n-        // Utils.cleanAllCreatedThings();\n-        // Utils.cleanAllCreatedJobs();\n+        Utils.cleanAllCreatedThings();\n+        Utils.cleanAllCreatedJobs();\n     }\n \n     private void launchKernel(String configFile) throws IOException, InterruptedException {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk2NTM3Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/176#discussion_r406965372", "bodyText": "Should we unwrap the execution exception to determine if it is retryable or not?", "author": "MikeDombo", "createdAt": "2020-04-10T22:15:02Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentTask.java", "diffHunk": "@@ -56,9 +56,9 @@ public Void call() throws NonRetryableDeploymentTaskFailureException, RetryableD\n             kernel.mergeInNewConfig(document.getDeploymentId(), document.getTimestamp(), newConfig).get();\n             logger.atInfo().setEventType(DEPLOYMENT_TASK_EVENT_TYPE)\n                     .addKeyValue(\"deploymentId\", document.getDeploymentId()).log(\"Finish deployment task\");\n-        } catch (PackageVersionConflictException | UnexpectedPackagingException e) {\n+        } catch (PackageVersionConflictException | UnexpectedPackagingException | ExecutionException e) {", "originalCommit": "b5d761dba290ec3d1ac4707e6f9beb1008615d93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk2OTQwNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/176#discussion_r406969407", "bodyText": "We should. I think right now we don't have a retryable case. I'll add a comment.", "author": "fengwang666", "createdAt": "2020-04-10T22:31:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk2NTM3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "098abedadad9720f33750bd9a6782b3305d07fb3", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/deployment/DeploymentTask.java b/src/main/java/com/aws/iot/evergreen/deployment/DeploymentTask.java\nindex b2fde5ced7..001fec82e8 100644\n--- a/src/main/java/com/aws/iot/evergreen/deployment/DeploymentTask.java\n+++ b/src/main/java/com/aws/iot/evergreen/deployment/DeploymentTask.java\n\n@@ -56,6 +56,7 @@ public class DeploymentTask implements Callable<Void> {\n             kernel.mergeInNewConfig(document.getDeploymentId(), document.getTimestamp(), newConfig).get();\n             logger.atInfo().setEventType(DEPLOYMENT_TASK_EVENT_TYPE)\n                     .addKeyValue(\"deploymentId\", document.getDeploymentId()).log(\"Finish deployment task\");\n+        // TODO: unwrap ExcutionException to see which one is retryable.\n         } catch (PackageVersionConflictException | UnexpectedPackagingException | ExecutionException e) {\n             throw new NonRetryableDeploymentTaskFailureException(e);\n         } catch (InterruptedException | IOException | PackagingException e) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk2NjA1Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/176#discussion_r406966056", "bodyText": "I think I have a fix here: https://github.com/aws/aws-greengrass-kernel/pull/175/files#diff-ed690837067a5ad8d1e95dbc8da15ae8R287\nMaking it return true will use break in the state machine. That way the state machine will wait for the next event instead of spinning here.", "author": "MikeDombo", "createdAt": "2020-04-10T22:17:50Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/Lifecycle.java", "diffHunk": "@@ -289,9 +290,13 @@ private boolean handleCurrentStateBroken(Optional<State> desiredState) {\n         // we'll transition out of BROKEN state to give it a new chance.\n         if (State.NEW.equals(desiredState.get())) {\n             updateStateAndBroadcast(State.NEW);\n-        } else {\n-            logger.atError().setEventType(\"service-broken\")\n-                    .log(\"service is broken. Deployment is needed\");\n+        }\n+        // TODO: (fengwa@) Fix this temporary hack of reducing the busy loop spinning.\n+        try {\n+            Thread.sleep(Duration.ofSeconds(10L).toMillis());", "originalCommit": "b5d761dba290ec3d1ac4707e6f9beb1008615d93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk3MDgxMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/176#discussion_r406970810", "bodyText": "Nice!", "author": "fengwang666", "createdAt": "2020-04-10T22:37:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk2NjA1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "098abedadad9720f33750bd9a6782b3305d07fb3", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/kernel/Lifecycle.java b/src/main/java/com/aws/iot/evergreen/kernel/Lifecycle.java\nindex 329eb80793..0e90ccc6ac 100644\n--- a/src/main/java/com/aws/iot/evergreen/kernel/Lifecycle.java\n+++ b/src/main/java/com/aws/iot/evergreen/kernel/Lifecycle.java\n\n@@ -290,13 +289,9 @@ public class Lifecycle {\n         // we'll transition out of BROKEN state to give it a new chance.\n         if (State.NEW.equals(desiredState.get())) {\n             updateStateAndBroadcast(State.NEW);\n-        }\n-        // TODO: (fengwa@) Fix this temporary hack of reducing the busy loop spinning.\n-        try {\n-            Thread.sleep(Duration.ofSeconds(10L).toMillis());\n-        } catch (InterruptedException e) {\n-            logger.atWarn(\"thread-interrupted\").log(\"Thread interrupted while sleep\");\n-\n+        } else {\n+            logger.atError(\"service-broken\").log(\"service is broken. Deployment is needed\");\n+            return true;\n         }\n         return false;\n     }\n"}}, {"oid": "098abedadad9720f33750bd9a6782b3305d07fb3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/098abedadad9720f33750bd9a6782b3305d07fb3", "message": "Address comments", "committedDate": "2020-04-10T22:49:17Z", "type": "commit"}, {"oid": "3d0da2e97b60ac125d847b7dfd895370bc238f4f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3d0da2e97b60ac125d847b7dfd895370bc238f4f", "message": "Merge branch 'master' into e2e-test-for-broken-service", "committedDate": "2020-04-10T23:20:45Z", "type": "commit"}, {"oid": "2f23f5dbbbe488572ee613a5e5243e3e11a56f5e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2f23f5dbbbe488572ee613a5e5243e3e11a56f5e", "message": "Merge branch 'master' into e2e-test-for-broken-service", "committedDate": "2020-04-11T00:18:23Z", "type": "commit"}]}