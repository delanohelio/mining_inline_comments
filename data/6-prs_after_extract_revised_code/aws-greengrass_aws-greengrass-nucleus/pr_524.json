{"pr_number": 524, "pr_title": "Fix getting content length from public repo", "pr_createdAt": "2020-10-14T05:18:48Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/524", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQwOTM2OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/524#discussion_r504409369", "bodyText": "nit: getContentLengthLong() returns it as a long\ndo we handle the -1 case when the content length is unknown?", "author": "rbattle", "createdAt": "2020-10-14T05:26:03Z", "path": "src/main/java/com/aws/greengrass/componentmanager/plugins/GreengrassRepositoryDownloader.java", "diffHunk": "@@ -145,15 +143,7 @@ public long getDownloadSize(ComponentIdentifier componentIdentifier, ComponentAr\n             URL url = new URL(preSignedUrl);\n             HttpURLConnection conn = connect(url);\n             conn.setRequestMethod(\"HEAD\");\n-            Map<String, List<String>> headers = conn.getHeaderFields();\n-            // TODO verify this works by trying on a real package\n-            if (!headers.containsKey(HTTP_HEADER_CONTENT_LENGTH)\n-                    || headers.get(HTTP_HEADER_CONTENT_LENGTH).size() != 1) {\n-                throw new PackageDownloadException(HTTP_HEADER_CONTENT_LENGTH + \" not found in response header\");\n-            }\n-            return Long.parseLong(headers.get(HTTP_HEADER_CONTENT_LENGTH).get(0));\n-        } catch (NumberFormatException e) {\n-            throw new PackageDownloadException(\"Got mal-formed Content-Length\", e);\n+            return conn.getContentLength();", "originalCommit": "82cbad57c27018176baf47153a7fdce9f97bfe7b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQwOTc0NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/524#discussion_r504409745", "bodyText": "We return a long anyway, so updated to call getContentLengthLong", "author": "MikeDombo", "createdAt": "2020-10-14T05:27:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQwOTM2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQxMDIzOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/524#discussion_r504410238", "bodyText": "right - but it would return -1 if the binary was > max int", "author": "rbattle", "createdAt": "2020-10-14T05:29:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQwOTM2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "d116d96c1b17f63e84ab6199c28cf712873b96ec", "chunk": "diff --git a/src/main/java/com/aws/greengrass/componentmanager/plugins/GreengrassRepositoryDownloader.java b/src/main/java/com/aws/greengrass/componentmanager/plugins/GreengrassRepositoryDownloader.java\nindex d801ec505c..2e2cdb178b 100644\n--- a/src/main/java/com/aws/greengrass/componentmanager/plugins/GreengrassRepositoryDownloader.java\n+++ b/src/main/java/com/aws/greengrass/componentmanager/plugins/GreengrassRepositoryDownloader.java\n\n@@ -143,7 +143,7 @@ public class GreengrassRepositoryDownloader extends ArtifactDownloader {\n             URL url = new URL(preSignedUrl);\n             HttpURLConnection conn = connect(url);\n             conn.setRequestMethod(\"HEAD\");\n-            return conn.getContentLength();\n+            return conn.getContentLengthLong();\n         } catch (IOException e) {\n             throw new PackageDownloadException(\"Failed to get download size\", e);\n         }\n"}}, {"oid": "d116d96c1b17f63e84ab6199c28cf712873b96ec", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d116d96c1b17f63e84ab6199c28cf712873b96ec", "message": "Fix getting content length from public repo", "committedDate": "2020-10-14T05:27:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQxMDQyOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/524#discussion_r504410428", "bodyText": "handle NumberFormatException?", "author": "fengwang666", "createdAt": "2020-10-14T05:29:52Z", "path": "src/main/java/com/aws/greengrass/componentmanager/plugins/GreengrassRepositoryDownloader.java", "diffHunk": "@@ -145,15 +143,7 @@ public long getDownloadSize(ComponentIdentifier componentIdentifier, ComponentAr\n             URL url = new URL(preSignedUrl);\n             HttpURLConnection conn = connect(url);\n             conn.setRequestMethod(\"HEAD\");\n-            Map<String, List<String>> headers = conn.getHeaderFields();\n-            // TODO verify this works by trying on a real package\n-            if (!headers.containsKey(HTTP_HEADER_CONTENT_LENGTH)\n-                    || headers.get(HTTP_HEADER_CONTENT_LENGTH).size() != 1) {\n-                throw new PackageDownloadException(HTTP_HEADER_CONTENT_LENGTH + \" not found in response header\");\n-            }\n-            return Long.parseLong(headers.get(HTTP_HEADER_CONTENT_LENGTH).get(0));\n-        } catch (NumberFormatException e) {\n-            throw new PackageDownloadException(\"Got mal-formed Content-Length\", e);\n+            return conn.getContentLengthLong();", "originalCommit": "d116d96c1b17f63e84ab6199c28cf712873b96ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQxMTgzMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/524#discussion_r504411831", "bodyText": "Can't happen anymore", "author": "MikeDombo", "createdAt": "2020-10-14T05:34:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQxMDQyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQxMjgyMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/524#discussion_r504412822", "bodyText": "@fengwa-aws any exception is caught inside getContentLengthLong() and -1 would be returned", "author": "rbattle", "createdAt": "2020-10-14T05:37:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQxMDQyOA=="}], "type": "inlineReview", "revised_code": {"commit": "c388b1d58c595defbc8751fdee872c9fa9677a07", "chunk": "diff --git a/src/main/java/com/aws/greengrass/componentmanager/plugins/GreengrassRepositoryDownloader.java b/src/main/java/com/aws/greengrass/componentmanager/plugins/GreengrassRepositoryDownloader.java\nindex 2e2cdb178b..892bbb3f02 100644\n--- a/src/main/java/com/aws/greengrass/componentmanager/plugins/GreengrassRepositoryDownloader.java\n+++ b/src/main/java/com/aws/greengrass/componentmanager/plugins/GreengrassRepositoryDownloader.java\n\n@@ -143,7 +143,11 @@ public class GreengrassRepositoryDownloader extends ArtifactDownloader {\n             URL url = new URL(preSignedUrl);\n             HttpURLConnection conn = connect(url);\n             conn.setRequestMethod(\"HEAD\");\n-            return conn.getContentLengthLong();\n+            long length = conn.getContentLengthLong();\n+            if (length == -1) {\n+                throw new PackageDownloadException(\"Failed to get download size\");\n+            }\n+            return length;\n         } catch (IOException e) {\n             throw new PackageDownloadException(\"Failed to get download size\", e);\n         }\n"}}, {"oid": "c388b1d58c595defbc8751fdee872c9fa9677a07", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c388b1d58c595defbc8751fdee872c9fa9677a07", "message": "Fix getting content length from public repo", "committedDate": "2020-10-14T05:33:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQxMTYyOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/524#discussion_r504411628", "bodyText": "\ud83d\udc4d", "author": "rbattle", "createdAt": "2020-10-14T05:33:59Z", "path": "src/main/java/com/aws/greengrass/componentmanager/plugins/GreengrassRepositoryDownloader.java", "diffHunk": "@@ -145,15 +143,11 @@ public long getDownloadSize(ComponentIdentifier componentIdentifier, ComponentAr\n             URL url = new URL(preSignedUrl);\n             HttpURLConnection conn = connect(url);\n             conn.setRequestMethod(\"HEAD\");\n-            Map<String, List<String>> headers = conn.getHeaderFields();\n-            // TODO verify this works by trying on a real package\n-            if (!headers.containsKey(HTTP_HEADER_CONTENT_LENGTH)\n-                    || headers.get(HTTP_HEADER_CONTENT_LENGTH).size() != 1) {\n-                throw new PackageDownloadException(HTTP_HEADER_CONTENT_LENGTH + \" not found in response header\");\n+            long length = conn.getContentLengthLong();\n+            if (length == -1) {", "originalCommit": "c388b1d58c595defbc8751fdee872c9fa9677a07", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "85726624d3874e79debaa623100ad000693cac41", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/85726624d3874e79debaa623100ad000693cac41", "message": "Fix getting content length from public repo", "committedDate": "2020-10-14T06:16:31Z", "type": "commit"}, {"oid": "85726624d3874e79debaa623100ad000693cac41", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/85726624d3874e79debaa623100ad000693cac41", "message": "Fix getting content length from public repo", "committedDate": "2020-10-14T06:16:31Z", "type": "forcePushed"}]}