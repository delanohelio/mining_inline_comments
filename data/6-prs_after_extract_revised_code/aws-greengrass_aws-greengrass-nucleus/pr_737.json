{"pr_number": 737, "pr_title": "Improve logging of systemd setup", "pr_createdAt": "2020-12-01T00:45:09Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/737", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAwMDczMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/737#discussion_r533000732", "bodyText": "would be better if you use the UserDecorator to build these commands. They don't need sudo if kernel is already running as root (which is the common case)", "author": "MikeDombo", "createdAt": "2020-12-01T00:51:31Z", "path": "src/main/java/com/aws/greengrass/util/orchestration/SystemdUtils.java", "diffHunk": "@@ -21,25 +21,38 @@\n     private static final String PID_FILE_PARAM = \"REPLACE_WITH_GG_LOADER_PID_FILE\";\n     private static final String LOADER_FILE_PARAM = \"REPLACE_WITH_GG_LOADER_FILE\";\n     private static final String SERVICE_CONFIG_FILE_PATH = \"/etc/systemd/system/greengrass.service\";\n+    private static final String LOG_EVENT_NAME = \"systemd-setup\";\n \n     @Override\n     public boolean setupSystemService(KernelAlternatives kernelAlternatives) {\n+        logger.atDebug(LOG_EVENT_NAME).log(\"Start systemd setup\");\n         try {\n             kernelAlternatives.setupInitLaunchDirIfAbsent();\n+\n+            Path serviceTemplate = kernelAlternatives.getServiceTemplatePath();\n+            if (!Files.exists(serviceTemplate)) {\n+                throw new IOException(\"Missing service template file at: \" + serviceTemplate);\n+            }\n+            Path loaderPath = kernelAlternatives.getLoaderPath();\n+            if (!Files.exists(serviceTemplate)) {\n+                throw new IOException(\"Missing loader file at: \" + loaderPath);\n+            }\n+\n             Path serviceConfig = kernelAlternatives.getServiceConfigPath();\n-            interpolateServiceTemplate(kernelAlternatives.getServiceTemplatePath(), serviceConfig, kernelAlternatives);\n+            interpolateServiceTemplate(serviceTemplate, serviceConfig, kernelAlternatives);\n \n             runCommand(String.format(\"sudo cp %s %s\", serviceConfig, SERVICE_CONFIG_FILE_PATH));", "originalCommit": "4fb5891e8609d0747e9c5db7d1dd15da1f85d1d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzc5MzE0NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/737#discussion_r533793145", "bodyText": "and if you are worried about providing a user, there is a getPrivilegedUser() on the platform object so you can pass that in.", "author": "rbattle", "createdAt": "2020-12-01T23:32:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAwMDczMg=="}], "type": "inlineReview", "revised_code": {"commit": "ec1f6910ab8dd3800b207135145b10e6212e4dec", "chunk": "diff --git a/src/main/java/com/aws/greengrass/util/orchestration/SystemdUtils.java b/src/main/java/com/aws/greengrass/util/orchestration/SystemdUtils.java\nindex 87b93ece6..83a0858b4 100644\n--- a/src/main/java/com/aws/greengrass/util/orchestration/SystemdUtils.java\n+++ b/src/main/java/com/aws/greengrass/util/orchestration/SystemdUtils.java\n\n@@ -41,11 +42,12 @@ public class SystemdUtils implements SystemServiceUtils {\n             Path serviceConfig = kernelAlternatives.getServiceConfigPath();\n             interpolateServiceTemplate(serviceTemplate, serviceConfig, kernelAlternatives);\n \n-            runCommand(String.format(\"sudo cp %s %s\", serviceConfig, SERVICE_CONFIG_FILE_PATH));\n-            runCommand(\"sudo systemctl daemon-reload\");\n-            runCommand(\"sudo systemctl unmask greengrass.service\");\n-            runCommand(\"sudo systemctl start greengrass.service\");\n-            runCommand(\"sudo systemctl enable greengrass.service\");\n+            runCommand(String.format(\"cp %s %s\", serviceConfig, SERVICE_CONFIG_FILE_PATH));\n+            runCommand(\"systemctl daemon-reload\");\n+            runCommand(\"systemctl unmask greengrass.service\");\n+            runCommand(\"systemctl stop greengrass.service\");\n+            runCommand(\"systemctl start greengrass.service\");\n+            runCommand(\"systemctl enable greengrass.service\");\n \n             logger.atInfo(LOG_EVENT_NAME).log(\"Successfully set up systemd service\");\n             return true;\n"}}, {"oid": "65e6b724eed64a975ab745f348d46901ad802971", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/65e6b724eed64a975ab745f348d46901ad802971", "message": "Improve logging of systemd setup", "committedDate": "2020-12-02T23:50:21Z", "type": "commit"}, {"oid": "ec1f6910ab8dd3800b207135145b10e6212e4dec", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ec1f6910ab8dd3800b207135145b10e6212e4dec", "message": "Address comments", "committedDate": "2020-12-03T00:54:05Z", "type": "commit"}, {"oid": "ec1f6910ab8dd3800b207135145b10e6212e4dec", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ec1f6910ab8dd3800b207135145b10e6212e4dec", "message": "Address comments", "committedDate": "2020-12-03T00:54:05Z", "type": "forcePushed"}, {"oid": "f21ffc9ff1ba30d6913f0c7048e190ec2478add6", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f21ffc9ff1ba30d6913f0c7048e190ec2478add6", "message": "Merge branch 'master' into systemd-log", "committedDate": "2020-12-03T17:57:52Z", "type": "commit"}, {"oid": "a8db6802f5767a3f2ed8164dd6e86985637321d0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a8db6802f5767a3f2ed8164dd6e86985637321d0", "message": "Merge branch 'master' into systemd-log", "committedDate": "2020-12-03T21:00:37Z", "type": "commit"}, {"oid": "f6fd9513ca3caed6e2da0cfb94e922981488b83e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f6fd9513ca3caed6e2da0cfb94e922981488b83e", "message": "Merge branch 'master' into systemd-log", "committedDate": "2020-12-03T23:50:29Z", "type": "commit"}, {"oid": "5fb3f70b575bb9b3decfaf79d20eee02c22d4bd3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5fb3f70b575bb9b3decfaf79d20eee02c22d4bd3", "message": "Merge branch 'master' into systemd-log", "committedDate": "2020-12-04T02:14:29Z", "type": "commit"}]}