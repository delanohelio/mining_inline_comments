{"pr_number": 248, "pr_title": "Deflake LifecycleTest, KernelTest, close ExecutorServices in the Context on shutdown", "pr_createdAt": "2020-05-19T19:53:29Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/248", "timeline": [{"oid": "b77b000b61a664dffa78c73b7995478e7b92b96d", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b77b000b61a664dffa78c73b7995478e7b92b96d", "message": "Deflake LifecycleTest, close ExecutorServices in the Context on shutdown", "committedDate": "2020-05-19T20:10:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU4MjIyNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/248#discussion_r427582227", "bodyText": "We should prevent EvergreenService from accessing this method.", "author": "ShirleyZheng92", "createdAt": "2020-05-19T20:33:09Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/Lifecycle.java", "diffHunk": "@@ -358,6 +352,16 @@ private void startStateTransition() throws InterruptedException {\n         }\n     }\n \n+    protected void setState(State current, State newState) {", "originalCommit": "b77b000b61a664dffa78c73b7995478e7b92b96d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU4Mzk2NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/248#discussion_r427583965", "bodyText": "We can't do that and also unit test it in this way. I think we just need to enforce it through PRs. I'll add a big javadoc comment to it at least.", "author": "MikeDombo", "createdAt": "2020-05-19T20:36:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU4MjIyNw=="}], "type": "inlineReview", "revised_code": {"commit": "ce37311fe61fea31be80d1b3f6a6ed9d64861ab5", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/kernel/Lifecycle.java b/src/main/java/com/aws/iot/evergreen/kernel/Lifecycle.java\nindex ef8ce1dcd..11179ae27 100644\n--- a/src/main/java/com/aws/iot/evergreen/kernel/Lifecycle.java\n+++ b/src/main/java/com/aws/iot/evergreen/kernel/Lifecycle.java\n\n@@ -352,7 +352,15 @@ public class Lifecycle {\n         }\n     }\n \n-    protected void setState(State current, State newState) {\n+    /**\n+     * !!WARNING!!\n+     * This method is package-private for unit testing purposes, but it must NEVER be called\n+     * from anything but the lifecycle thread in this class.\n+     *\n+     * @param current current state to transition out of\n+     * @param newState new state to transition into\n+     */\n+    void setState(State current, State newState) {\n         logger.atInfo(\"service-set-state\").kv(NEW_STATE_METRIC_NAME, newState).log();\n         // Sync on State.class to make sure the order of setValue and globalNotifyStateChanged\n         // are consistent across different services.\n"}}, {"oid": "ce37311fe61fea31be80d1b3f6a6ed9d64861ab5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ce37311fe61fea31be80d1b3f6a6ed9d64861ab5", "message": "Deflake LifecycleTest, close ExecutorServices in the Context on shutdown", "committedDate": "2020-05-19T20:37:53Z", "type": "forcePushed"}, {"oid": "4ff64d9f51382bc04e64f3eb40b404cf02b90c66", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4ff64d9f51382bc04e64f3eb40b404cf02b90c66", "message": "Deflake LifecycleTest, close ExecutorServices in the Context on shutdown", "committedDate": "2020-05-19T21:43:04Z", "type": "commit"}, {"oid": "4ff64d9f51382bc04e64f3eb40b404cf02b90c66", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4ff64d9f51382bc04e64f3eb40b404cf02b90c66", "message": "Deflake LifecycleTest, close ExecutorServices in the Context on shutdown", "committedDate": "2020-05-19T21:43:04Z", "type": "forcePushed"}]}