{"pr_number": 744, "pr_title": "Add timeout for recovery lifecycle step", "pr_createdAt": "2020-12-02T01:06:08Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/744", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzgyODMzMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/744#discussion_r533828330", "bodyText": "why add this? Our other lifecycle steps can also timeout, but they never throw it up", "author": "MikeDombo", "createdAt": "2020-12-02T01:10:12Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/GreengrassService.java", "diffHunk": "@@ -229,8 +229,9 @@ public final void requestStop() {\n      * Custom handler to handle error.\n      *\n      * @throws InterruptedException if the thread is interrupted while handling the error\n+     * @throws TimeoutException if running the handler takes longer than the timeout\n      */\n-    protected void handleError() throws InterruptedException {\n+    protected void handleError() throws InterruptedException, TimeoutException {", "originalCommit": "412b26ae10396173bae25249cdcdca0ae46cf5c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzgyOTUwNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/744#discussion_r533829506", "bodyText": "It's just how the code is structured, some steps have all their logic in Lifecycle.java vs some i.e. recovery and bootstrap have it in GenericExternalService.java, I would have liked if it was all in one place but getting there will require some refactoring", "author": "shaguptashaikh", "createdAt": "2020-12-02T01:13:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzgyODMzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzgzMDE4Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/744#discussion_r533830186", "bodyText": "I think I'd prefer that the timeout is handled inside then.", "author": "MikeDombo", "createdAt": "2020-12-02T01:14:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzgyODMzMA=="}], "type": "inlineReview", "revised_code": {"commit": "4a8e115d9a51539583fd89b4da7c65ca71b1b5cb", "chunk": "diff --git a/src/main/java/com/aws/greengrass/lifecyclemanager/GreengrassService.java b/src/main/java/com/aws/greengrass/lifecyclemanager/GreengrassService.java\nindex 4bd3b1e7d8..eec2ff78fa 100644\n--- a/src/main/java/com/aws/greengrass/lifecyclemanager/GreengrassService.java\n+++ b/src/main/java/com/aws/greengrass/lifecyclemanager/GreengrassService.java\n\n@@ -229,9 +229,8 @@ public class GreengrassService implements InjectionActions {\n      * Custom handler to handle error.\n      *\n      * @throws InterruptedException if the thread is interrupted while handling the error\n-     * @throws TimeoutException if running the handler takes longer than the timeout\n      */\n-    protected void handleError() throws InterruptedException, TimeoutException {\n+    protected void handleError() throws InterruptedException {\n     }\n \n     /**\n"}}, {"oid": "018e2817a8dc00e8b76b3d770ec7c6fdd7793356", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/018e2817a8dc00e8b76b3d770ec7c6fdd7793356", "message": "Add timeout for recovery lifecycle step", "committedDate": "2020-12-02T01:15:35Z", "type": "forcePushed"}, {"oid": "c52f50d1df33f114b60c3cf42b579679e68e62b0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c52f50d1df33f114b60c3cf42b579679e68e62b0", "message": "Skip all logic when there is no recovery config", "committedDate": "2020-12-02T01:50:27Z", "type": "forcePushed"}, {"oid": "629234025b9ddd056effc8125f8dc44ea4455e83", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/629234025b9ddd056effc8125f8dc44ea4455e83", "message": "Add timeout for recovery lifecycle step", "committedDate": "2020-12-02T03:30:59Z", "type": "commit"}, {"oid": "f6e4ce7b5efcb8ea0ec1f4121e5d0f17c20d0e2a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f6e4ce7b5efcb8ea0ec1f4121e5d0f17c20d0e2a", "message": "Skip all logic when there is no recovery config", "committedDate": "2020-12-02T03:30:59Z", "type": "commit"}, {"oid": "4a8e115d9a51539583fd89b4da7c65ca71b1b5cb", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4a8e115d9a51539583fd89b4da7c65ca71b1b5cb", "message": "Address comments and add more tests", "committedDate": "2020-12-02T03:30:59Z", "type": "forcePushed"}, {"oid": "19d16ca29b2bb405c639d21c5eacb099fea81196", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/19d16ca29b2bb405c639d21c5eacb099fea81196", "message": "Address comments and add more tests", "committedDate": "2020-12-02T03:36:09Z", "type": "commit"}, {"oid": "19d16ca29b2bb405c639d21c5eacb099fea81196", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/19d16ca29b2bb405c639d21c5eacb099fea81196", "message": "Address comments and add more tests", "committedDate": "2020-12-02T03:36:09Z", "type": "forcePushed"}, {"oid": "4f9e3c3f53a694890afb1d37417f607aecef6f88", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4f9e3c3f53a694890afb1d37417f607aecef6f88", "message": "Fix permission issue with integ test", "committedDate": "2020-12-02T03:59:37Z", "type": "commit"}, {"oid": "ba63dc04000c08aa632938eccf3a2cc43fbc5444", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ba63dc04000c08aa632938eccf3a2cc43fbc5444", "message": "Try fixing integ test again", "committedDate": "2020-12-02T06:35:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk0NTExNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/744#discussion_r533945115", "bodyText": "What if this process goes rogue? Don't we need to kill it when it times out?", "author": "fengwang666", "createdAt": "2020-12-02T07:21:13Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/GenericExternalService.java", "diffHunk": "@@ -387,8 +387,22 @@ private synchronized void stopProcesses(List<Exec> processes) {\n \n     @Override\n     public void handleError() throws InterruptedException {\n-        // A placeholder for error handling in GenericExternalService\n-        run(\"recover\", null, lifecycleProcesses);\n+        if (getConfig().findNode(GreengrassService.SERVICE_LIFECYCLE_NAMESPACE_TOPIC,\n+                Lifecycle.LIFECYCLE_RECOVER_NAMESPACE_TOPIC) == null) {\n+            // No recovery step defined in lifecycle\n+            return;\n+        }\n+\n+        Integer timeout = Coerce.toInt(getConfig().findOrDefault(Lifecycle.DEFAULT_ERROR_RECOVERY_HANDLER_TIMEOUT_SEC,\n+                GreengrassService.SERVICE_LIFECYCLE_NAMESPACE_TOPIC, Lifecycle.LIFECYCLE_RECOVER_NAMESPACE_TOPIC,\n+                Lifecycle.TIMEOUT_NAMESPACE_TOPIC));\n+\n+        CountDownLatch handlerExecutionCdl = new CountDownLatch(1);\n+        run(Lifecycle.LIFECYCLE_RECOVER_NAMESPACE_TOPIC, c -> handlerExecutionCdl.countDown(), lifecycleProcesses);", "originalCommit": "ba63dc04000c08aa632938eccf3a2cc43fbc5444", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk1NDgzNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/744#discussion_r533954834", "bodyText": "It's handled as part of https://github.com/aws/aws-greengrass-nucleus/blob/master/src/main/java/com/aws/greengrass/lifecyclemanager/GenericExternalService.java#L360 where all all processes are cleaned up during shutdown so I didn't do anything specifically for the recovery one", "author": "shaguptashaikh", "createdAt": "2020-12-02T07:42:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk0NTExNQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "d801f46e9821157c1a37f0eeb99013110a6f6675", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d801f46e9821157c1a37f0eeb99013110a6f6675", "message": "Merge branch 'master' into recovery-timeout", "committedDate": "2020-12-02T16:56:36Z", "type": "commit"}]}