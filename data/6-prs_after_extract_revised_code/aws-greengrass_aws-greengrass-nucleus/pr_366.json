{"pr_number": 366, "pr_title": "make a new method in the evergreenService.class as shouldAutoStart() \u2026", "pr_createdAt": "2020-08-14T22:28:46Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/366", "timeline": [{"oid": "bd57a7ef77c093ab6c158e8fe00527dacc52d0cc", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/bd57a7ef77c093ab6c158e8fe00527dacc52d0cc", "message": "make a new method in the evergreenService.class as shouldAutoStart() which is return true by default", "committedDate": "2020-08-14T22:13:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg5MjgwMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/366#discussion_r470892800", "bodyText": "Add a TODO to rethink this stuff here", "author": "MikeDombo", "createdAt": "2020-08-14T22:36:37Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -613,11 +613,16 @@ protected void putDependenciesIntoSet(Set<EvergreenService> deps) {\n                 .collect(Collectors.toMap(Map.Entry::getKey, e -> e.getValue().dependencyType));\n     }\n \n-    public boolean isAutostart() {\n+    // If a service is a Builtin service, it is supposed to auto-start after kernel launches or deployment\n+    public boolean isBuiltin() {\n         ImplementsService serviceAnnotation = getClass().getAnnotation(ImplementsService.class);", "originalCommit": "bd57a7ef77c093ab6c158e8fe00527dacc52d0cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTgxNDYzNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/366#discussion_r471814637", "bodyText": "Please address this as we discussed last week", "author": "MikeDombo", "createdAt": "2020-08-17T22:44:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg5MjgwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTgxNTc4MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/366#discussion_r471815780", "bodyText": "This has been added in the new commit here 22ca102", "author": "awszztt", "createdAt": "2020-08-17T22:47:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg5MjgwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTgzMTc2OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/366#discussion_r471831769", "bodyText": "The \"TODO\" has been added in the comment.", "author": "awszztt", "createdAt": "2020-08-17T23:38:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg5MjgwMA=="}], "type": "inlineReview", "revised_code": {"commit": "22ca1025924c3b54f2e0f9ead48b5de092764f8a", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java b/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\nindex 56257cc43..7606d0d26 100644\n--- a/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\n+++ b/src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java\n\n@@ -613,6 +613,7 @@ public class EvergreenService implements InjectionActions, DisruptableCheck {\n                 .collect(Collectors.toMap(Map.Entry::getKey, e -> e.getValue().dependencyType));\n     }\n \n+    // Rewrite this builtin service detection, reconsider if it is needed at all, reconsider how it is implemented\n     // If a service is a Builtin service, it is supposed to auto-start after kernel launches or deployment\n     public boolean isBuiltin() {\n         ImplementsService serviceAnnotation = getClass().getAnnotation(ImplementsService.class);\n"}}, {"oid": "8220f65fc9f4011d063b6ec4692a78ccf592404d", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8220f65fc9f4011d063b6ec4692a78ccf592404d", "message": "Implement Fleet Status Service (#335)\n\n* Implment Fleet Status Service.\r\n\r\n* Add more unit tests.\r\n\r\n* Adding logic to handle getting dependencies fleet config from root components.\r\n\r\n* Address PR comments.\r\n\r\n* Fix build after addressing PR comments.\r\n\r\n* Handle MQTT connection interruptions.\r\n\r\n* fix build.\r\n\r\n* Address PR comments.\r\n\r\n* Address more PR comments. Move component to groups mapping in Deployment Service.\r\n\r\n* Add unit test for DeploymentService.\r\n\r\n* Fix build.\r\n\r\n* Fix flaky unit test. Address some PR comments.\r\n\r\n* Fix one more flaky test.\r\n\r\n* Do not update FSS data during initialization.\r\n\r\n* Fix build.\r\n\r\n* Address PR comments.\r\n\r\n* Refactor some code.\r\n\r\n* Address PR comments.\r\n\r\n* Address PR comments.\r\n\r\n* Address more PR comments. Make publish topic configurable.\r\n\r\n* Address PR comments on tests.\r\n\r\n* Address PR comments\r\n\r\n* Use const KERNEL_VERSION in tests.", "committedDate": "2020-08-14T23:30:55Z", "type": "commit"}, {"oid": "22ca1025924c3b54f2e0f9ead48b5de092764f8a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/22ca1025924c3b54f2e0f9ead48b5de092764f8a", "message": "fix the bug after renaming isAutostart()", "committedDate": "2020-08-14T23:30:55Z", "type": "commit"}, {"oid": "fce214fc22eeb108e73c12165a11e6c1f7c01d50", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fce214fc22eeb108e73c12165a11e6c1f7c01d50", "message": "Merge branch 'master' into prevent-auto-start", "committedDate": "2020-08-14T23:48:26Z", "type": "commit"}, {"oid": "60dc41eb67aee35bb1e10ca5c41dbe84e2387916", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/60dc41eb67aee35bb1e10ca5c41dbe84e2387916", "message": "Initial work to support component plugin with integ test (#364)\n\n* Initial work to support component plugin with integ test\r\n\r\n* Fix windows\r\n\r\n* Address comments", "committedDate": "2020-08-17T22:45:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTgxNjE4NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/366#discussion_r471816185", "bodyText": "You're including files that should not be here.", "author": "MikeDombo", "createdAt": "2020-08-17T22:49:15Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/PluginComponentTest.java", "diffHunk": "@@ -0,0 +1,125 @@\n+/*", "originalCommit": "60dc41eb67aee35bb1e10ca5c41dbe84e2387916", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "312c7b956d8ad95308b3d1df4bc4a69c099cfe1d", "chunk": "diff --git a/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/PluginComponentTest.java b/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/PluginComponentTest.java\ndeleted file mode 100644\nindex 88869ce41..000000000\n--- a/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/PluginComponentTest.java\n+++ /dev/null\n\n@@ -1,125 +0,0 @@\n-/*\n- * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n- * SPDX-License-Identifier: Apache-2.0\n- */\n-\n-package com.aws.iot.evergreen.integrationtests.kernel;\n-\n-import com.aws.iot.evergreen.config.Topics;\n-import com.aws.iot.evergreen.deployment.DefaultDeploymentTask;\n-import com.aws.iot.evergreen.deployment.DeploymentConfigMerger;\n-import com.aws.iot.evergreen.deployment.DeploymentService;\n-import com.aws.iot.evergreen.deployment.model.Deployment;\n-import com.aws.iot.evergreen.deployment.model.DeploymentDocument;\n-import com.aws.iot.evergreen.deployment.model.DeploymentResult;\n-import com.aws.iot.evergreen.integrationtests.BaseITCase;\n-import com.aws.iot.evergreen.kernel.EvergreenService;\n-import com.aws.iot.evergreen.kernel.Kernel;\n-import com.aws.iot.evergreen.logging.impl.LogManager;\n-import com.aws.iot.evergreen.packagemanager.DependencyResolver;\n-import com.aws.iot.evergreen.packagemanager.KernelConfigResolver;\n-import com.aws.iot.evergreen.packagemanager.PackageManager;\n-import com.aws.iot.evergreen.packagemanager.PackageStore;\n-import com.aws.iot.evergreen.packagemanager.exceptions.PackageDownloadException;\n-import com.aws.iot.evergreen.packagemanager.exceptions.PackagingException;\n-import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n-import com.aws.iot.evergreen.util.Coerce;\n-import com.fasterxml.jackson.databind.ObjectMapper;\n-import com.vdurmont.semver4j.Semver;\n-import org.apache.commons.io.FileUtils;\n-import org.junit.jupiter.api.AfterEach;\n-import org.junit.jupiter.api.BeforeEach;\n-import org.junit.jupiter.api.Test;\n-import org.junit.jupiter.api.extension.ExtensionContext;\n-\n-import java.io.File;\n-import java.io.IOException;\n-import java.net.URI;\n-import java.net.URISyntaxException;\n-import java.nio.file.Files;\n-import java.nio.file.Path;\n-import java.nio.file.Paths;\n-import java.util.concurrent.ExecutorService;\n-import java.util.concurrent.Future;\n-import java.util.concurrent.TimeUnit;\n-\n-import static com.aws.iot.evergreen.dependency.EZPlugins.JAR_FILE_EXTENSION;\n-import static com.aws.iot.evergreen.deployment.model.Deployment.DeploymentStage.DEFAULT;\n-import static com.aws.iot.evergreen.packagemanager.KernelConfigResolver.VERSION_CONFIG_KEY;\n-import static com.aws.iot.evergreen.testcommons.testutilities.ExceptionLogProtector.ignoreExceptionOfType;\n-import static org.junit.jupiter.api.Assertions.assertEquals;\n-\n-public class PluginComponentTest extends BaseITCase {\n-    private static final ObjectMapper OBJECT_MAPPER = new ObjectMapper();\n-    private Kernel kernel;\n-    private PackageIdentifier componentId;\n-\n-    @BeforeEach\n-    void beforeEach() {\n-        kernel = new Kernel();\n-    }\n-\n-    @AfterEach\n-    void afterEach() {\n-        kernel.shutdown();\n-    }\n-\n-    @Test\n-    void GIVEN_kernel_WHEN_locate_plugin_THEN_plugin_is_loaded_into_JVM() throws Exception {\n-        setupPackageStore();\n-        kernel.parseArgs(\"-i\", this.getClass().getResource(\"plugin.yaml\").toString());\n-        kernel.launch();\n-\n-        EvergreenService eg = kernel.locate(\"plugin\");\n-        assertEquals(\"com.aws.iot.evergreen.integrationtests.kernel.resource.PluginService\", eg.getClass().getName());\n-        assertEquals(componentId.getVersion().toString(),\n-                Coerce.toString(eg.getServiceConfig().findLeafChild(VERSION_CONFIG_KEY)));\n-    }\n-\n-    @Test\n-    void GIVEN_kernel_WHEN_deploy_plugin_THEN_plugin_is_loaded_into_JVM(ExtensionContext context) throws Exception {\n-        ignoreExceptionOfType(context, PackageDownloadException.class);\n-        setupPackageStore();\n-\n-        // launch kernel\n-        kernel.parseArgs().launch();\n-\n-        submitSampleJobDocument(getClass().getResource(\"PluginDeployment.json\").toURI(), System.currentTimeMillis(),\n-                kernel).get(30, TimeUnit.SECONDS);\n-\n-        EvergreenService eg = kernel.locate(\"plugin\");\n-        assertEquals(\"com.aws.iot.evergreen.integrationtests.kernel.resource.PluginService\", eg.getClass().getName());\n-        assertEquals(componentId.getVersion().toString(),\n-                Coerce.toString(eg.getServiceConfig().findLeafChild(VERSION_CONFIG_KEY)));\n-    }\n-\n-    private void setupPackageStore() throws IOException, PackagingException, URISyntaxException {\n-        Path localStoreContentPath = Paths.get(getClass().getResource(\"local_store_content\").toURI());\n-        Path e2eTestPkgStoreDir = tempRootDir.resolve(\"eteTestPkgStore\");\n-        FileUtils.copyDirectory(localStoreContentPath.toFile(), e2eTestPkgStoreDir.toFile());\n-        PackageStore e2eTestPackageStore = new PackageStore(e2eTestPkgStoreDir);\n-\n-        componentId = new PackageIdentifier(\"plugin\", new Semver(\"1.0.0\"));\n-        Files.move(e2eTestPackageStore.resolveArtifactDirectoryPath(componentId).resolve(\"plugin-tests.jar\"),\n-                e2eTestPackageStore.resolveArtifactDirectoryPath(componentId)\n-                        .resolve(componentId.getName() + JAR_FILE_EXTENSION));\n-        kernel.getContext().put(PackageStore.class, e2eTestPackageStore);\n-    }\n-\n-    private static Future<DeploymentResult> submitSampleJobDocument(URI uri, Long timestamp, Kernel kernel)\n-            throws Exception {\n-        DeploymentDocument sampleJobDocument = OBJECT_MAPPER.readValue(new File(uri), DeploymentDocument.class);\n-        sampleJobDocument.setTimestamp(timestamp);\n-        sampleJobDocument.setGroupName(\"ANY\");\n-        PackageManager packageManager = kernel.getContext().get(PackageManager.class);\n-        DependencyResolver dependencyResolver = kernel.getContext().get(DependencyResolver.class);\n-        KernelConfigResolver kernelConfigResolver = kernel.getContext().get(KernelConfigResolver.class);\n-        DeploymentConfigMerger deploymentConfigMerger = kernel.getContext().get(DeploymentConfigMerger.class);\n-        DefaultDeploymentTask deploymentTask =\n-                new DefaultDeploymentTask(dependencyResolver, packageManager, kernelConfigResolver,\n-                        deploymentConfigMerger, LogManager.getLogger(\"Deployer\"),\n-                        new Deployment(sampleJobDocument, Deployment.DeploymentType.IOT_JOBS, \"jobId\", DEFAULT),\n-                        Topics.of(kernel.getContext(), DeploymentService.DEPLOYMENT_SERVICE_TOPICS, null));\n-        return kernel.getContext().get(ExecutorService.class).submit(deploymentTask);\n-    }\n-}\n"}}, {"oid": "76c83430343adb1ccb4457943b566e52b724625b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/76c83430343adb1ccb4457943b566e52b724625b", "message": "make a new method in the evergreenService.class as shouldAutoStart() which is return true by default", "committedDate": "2020-08-17T22:57:40Z", "type": "commit"}, {"oid": "12a278eb74e1ba424f62bd0b7e88344e407a72c9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/12a278eb74e1ba424f62bd0b7e88344e407a72c9", "message": "fix the bug after renaming isAutostart()", "committedDate": "2020-08-17T22:57:41Z", "type": "commit"}, {"oid": "732baf43e15f937b74df50372034912e975a2cea", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/732baf43e15f937b74df50372034912e975a2cea", "message": "Merge branch 'prevent-auto-start' of ssh://github.com/aws/aws-greengrass-kernel into prevent-auto-start", "committedDate": "2020-08-17T22:59:36Z", "type": "commit"}, {"oid": "be68ff4e43b8d18c4ccfb620af980efe42a079df", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/be68ff4e43b8d18c4ccfb620af980efe42a079df", "message": "add word of TODO in the comment", "committedDate": "2020-08-17T23:06:09Z", "type": "commit"}, {"oid": "312c7b956d8ad95308b3d1df4bc4a69c099cfe1d", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/312c7b956d8ad95308b3d1df4bc4a69c099cfe1d", "message": "make a new method in the evergreenService.class as shouldAutoStart() which is return true by default", "committedDate": "2020-08-17T23:21:50Z", "type": "commit"}, {"oid": "9f4a13b1bab4fac976b4d4ca3772decddd3054d8", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9f4a13b1bab4fac976b4d4ca3772decddd3054d8", "message": "fix the bug after renaming isAutostart()", "committedDate": "2020-08-17T23:21:50Z", "type": "commit"}, {"oid": "896aaf298c7d4a356a1656a392a030c6f5ed2feb", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/896aaf298c7d4a356a1656a392a030c6f5ed2feb", "message": "make a new method in the evergreenService.class as shouldAutoStart() which is return true by default", "committedDate": "2020-08-17T23:23:53Z", "type": "commit"}, {"oid": "61b37b661fb552f34ab85608e06b086076bdfea1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/61b37b661fb552f34ab85608e06b086076bdfea1", "message": "fix the bug after renaming isAutostart()", "committedDate": "2020-08-17T23:29:56Z", "type": "commit"}, {"oid": "cd8f6141621d60c7c30199964d1519b99cb5132b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/cd8f6141621d60c7c30199964d1519b99cb5132b", "message": "Initial work to support component plugin with integ test (#364)\n\n* Initial work to support component plugin with integ test\r\n\r\n* Fix windows\r\n\r\n* Address comments", "committedDate": "2020-08-17T23:29:56Z", "type": "commit"}, {"oid": "af04fddeed75b9ef65e78d7d5811fb2d23941c2f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/af04fddeed75b9ef65e78d7d5811fb2d23941c2f", "message": "Merge branch 'prevent-auto-start' of ssh://github.com/aws/aws-greengrass-kernel into prevent-auto-start", "committedDate": "2020-08-17T23:31:46Z", "type": "commit"}, {"oid": "d5016b90e53ceaaba49253c6ae91591155599d6c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d5016b90e53ceaaba49253c6ae91591155599d6c", "message": "Merge branch 'master' into prevent-auto-start", "committedDate": "2020-08-18T00:22:32Z", "type": "commit"}]}