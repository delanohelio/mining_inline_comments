{"pr_number": 651, "pr_title": "Do not restart on changes between null and empty string", "pr_createdAt": "2020-11-10T20:17:38Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/651", "timeline": [{"oid": "a49582bbeb3529cde3afc643a6a11020bced6050", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a49582bbeb3529cde3afc643a6a11020bced6050", "message": "Do not restart on changes between null and empty string", "committedDate": "2020-11-10T20:11:23Z", "type": "commit"}, {"oid": "88a007ed4a06ab5544de8d19032283f79b9cee6e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/88a007ed4a06ab5544de8d19032283f79b9cee6e", "message": "Merge branch 'master' into restart-null-empty-string", "committedDate": "2020-11-10T20:22:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg1MTk2NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/651#discussion_r520851964", "bodyText": "use coerce to string instead of casting", "author": "MikeDombo", "createdAt": "2020-11-10T20:24:42Z", "path": "src/main/java/com/aws/greengrass/deployment/bootstrap/BootstrapManager.java", "diffHunk": "@@ -203,23 +203,24 @@ private boolean defaultRunWithChanged(Map<String, Object> newNucleusParameters,\n         Map<String, Object> currentValues = currentDeviceConfiguration.getRunWithTopic().toPOJO();\n \n         boolean changed = false;\n-        if (!Objects.equals(currentValues.get(RUN_WITH_DEFAULT_POSIX_USER),\n-                runWithDefault.get(RUN_WITH_DEFAULT_POSIX_USER))) {\n+        if (Utils.stringHasChanged(Coerce.toString(currentValues.get(RUN_WITH_DEFAULT_POSIX_USER)),\n+                (String) runWithDefault.get(RUN_WITH_DEFAULT_POSIX_USER))) {\n             logger.atInfo().kv(RUN_WITH_TOPIC + \".\" + RUN_WITH_DEFAULT_POSIX_USER,\n                     runWithDefault.get(RUN_WITH_DEFAULT_POSIX_USER))\n                     .log(RESTART_REQUIRED_MESSAGE);\n             changed = true;\n         }\n-        if (!Objects.equals(currentValues.get(RUN_WITH_DEFAULT_POSIX_GROUP),\n-                runWithDefault.get(RUN_WITH_DEFAULT_POSIX_GROUP))) {\n+        if (Utils.stringHasChanged(Coerce.toString(currentValues.get(RUN_WITH_DEFAULT_POSIX_GROUP)),\n+                (String) runWithDefault.get(RUN_WITH_DEFAULT_POSIX_GROUP))) {", "originalCommit": "88a007ed4a06ab5544de8d19032283f79b9cee6e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg1OTkwMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/651#discussion_r520859900", "bodyText": "Updated", "author": "tomnagy-aws", "createdAt": "2020-11-10T20:40:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg1MTk2NA=="}], "type": "inlineReview", "revised_code": {"commit": "89d992e1b4fd257cf1b3a988408c3845c8405298", "chunk": "diff --git a/src/main/java/com/aws/greengrass/deployment/bootstrap/BootstrapManager.java b/src/main/java/com/aws/greengrass/deployment/bootstrap/BootstrapManager.java\nindex c8281e1b..4e1f3779 100644\n--- a/src/main/java/com/aws/greengrass/deployment/bootstrap/BootstrapManager.java\n+++ b/src/main/java/com/aws/greengrass/deployment/bootstrap/BootstrapManager.java\n\n@@ -204,14 +204,14 @@ public class BootstrapManager implements Iterator<BootstrapTaskStatus>  {\n \n         boolean changed = false;\n         if (Utils.stringHasChanged(Coerce.toString(currentValues.get(RUN_WITH_DEFAULT_POSIX_USER)),\n-                (String) runWithDefault.get(RUN_WITH_DEFAULT_POSIX_USER))) {\n+                Coerce.toString(runWithDefault.get(RUN_WITH_DEFAULT_POSIX_USER)))) {\n             logger.atInfo().kv(RUN_WITH_TOPIC + \".\" + RUN_WITH_DEFAULT_POSIX_USER,\n                     runWithDefault.get(RUN_WITH_DEFAULT_POSIX_USER))\n                     .log(RESTART_REQUIRED_MESSAGE);\n             changed = true;\n         }\n         if (Utils.stringHasChanged(Coerce.toString(currentValues.get(RUN_WITH_DEFAULT_POSIX_GROUP)),\n-                (String) runWithDefault.get(RUN_WITH_DEFAULT_POSIX_GROUP))) {\n+                Coerce.toString(runWithDefault.get(RUN_WITH_DEFAULT_POSIX_GROUP)))) {\n             logger.atInfo().kv(RUN_WITH_TOPIC + \".\" + RUN_WITH_DEFAULT_POSIX_GROUP,\n                     runWithDefault.get(RUN_WITH_DEFAULT_POSIX_GROUP))\n                     .log(RESTART_REQUIRED_MESSAGE);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg1MjIzNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/651#discussion_r520852235", "bodyText": "you could check that both are empty using Utils.isEmpty", "author": "MikeDombo", "createdAt": "2020-11-10T20:25:15Z", "path": "src/main/java/com/aws/greengrass/util/Utils.java", "diffHunk": "@@ -90,16 +90,24 @@ public static Throwable flush(Object flushable) {\n     }\n \n     /**\n-     * Returns true if the two strings are different, including null.\n+     * Returns true if the two strings are different, including <code>null</code>.\n+     *\n+     * <p>A change from <code>null</code> to <code>\"\"</code>, or vice versa, is not considered a change.</p>\n      *\n      * @param oldValue first string\n      * @param newValue second string\n-     * @return true if the two strings are not equal\n+     * @return true if the two strings are different\n      */\n     public static boolean stringHasChanged(String oldValue, String newValue) {\n         if (oldValue == null && newValue == null) {\n             return false;\n         }\n+        if (oldValue == null && \"\".equals(newValue)) {", "originalCommit": "88a007ed4a06ab5544de8d19032283f79b9cee6e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg2MDA3OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/651#discussion_r520860079", "bodyText": "And updated \ud83d\udc4d", "author": "tomnagy-aws", "createdAt": "2020-11-10T20:40:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg1MjIzNQ=="}], "type": "inlineReview", "revised_code": {"commit": "e143b7b220744a7428bd5f64ced2f1df9bc8cadf", "chunk": "diff --git a/src/main/java/com/aws/greengrass/util/Utils.java b/src/main/java/com/aws/greengrass/util/Utils.java\nindex 0e8f4802..c7c6eddb 100644\n--- a/src/main/java/com/aws/greengrass/util/Utils.java\n+++ b/src/main/java/com/aws/greengrass/util/Utils.java\n\n@@ -102,10 +102,10 @@ public final class Utils {\n         if (oldValue == null && newValue == null) {\n             return false;\n         }\n-        if (oldValue == null && \"\".equals(newValue)) {\n+        if (oldValue == null && Utils.isEmpty(newValue)) {\n             return false;\n         }\n-        if (oldValue != null && oldValue.equals(\"\") && newValue == null) {\n+        if (oldValue != null && Utils.isEmpty(oldValue) && newValue == null) {\n             return false;\n         }\n         if ((oldValue == null) != (newValue == null)) {\n"}}, {"oid": "89d992e1b4fd257cf1b3a988408c3845c8405298", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/89d992e1b4fd257cf1b3a988408c3845c8405298", "message": "Using Coerce instead of a cast", "committedDate": "2020-11-10T20:38:51Z", "type": "commit"}, {"oid": "e143b7b220744a7428bd5f64ced2f1df9bc8cadf", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e143b7b220744a7428bd5f64ced2f1df9bc8cadf", "message": "Using Utils.isEmpty", "committedDate": "2020-11-10T20:39:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg2MTYwMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/651#discussion_r520861603", "bodyText": "can't this all be simplified? Utils.isEmpty(oldValue) && Utils.isEmpty(newValue)", "author": "MikeDombo", "createdAt": "2020-11-10T20:43:07Z", "path": "src/main/java/com/aws/greengrass/util/Utils.java", "diffHunk": "@@ -90,16 +90,24 @@ public static Throwable flush(Object flushable) {\n     }\n \n     /**\n-     * Returns true if the two strings are different, including null.\n+     * Returns true if the two strings are different, including <code>null</code>.\n+     *\n+     * <p>A change from <code>null</code> to <code>\"\"</code>, or vice versa, is not considered a change.</p>\n      *\n      * @param oldValue first string\n      * @param newValue second string\n-     * @return true if the two strings are not equal\n+     * @return true if the two strings are different\n      */\n     public static boolean stringHasChanged(String oldValue, String newValue) {\n         if (oldValue == null && newValue == null) {\n             return false;\n         }\n+        if (oldValue == null && Utils.isEmpty(newValue)) {\n+            return false;\n+        }\n+        if (oldValue != null && Utils.isEmpty(oldValue) && newValue == null) {", "originalCommit": "e143b7b220744a7428bd5f64ced2f1df9bc8cadf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg2NTE4NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/651#discussion_r520865184", "bodyText": "Yeah. Changed", "author": "tomnagy-aws", "createdAt": "2020-11-10T20:49:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg2MTYwMw=="}], "type": "inlineReview", "revised_code": {"commit": "79901fed7dd33a71c1389842f50d3982a564a783", "chunk": "diff --git a/src/main/java/com/aws/greengrass/util/Utils.java b/src/main/java/com/aws/greengrass/util/Utils.java\nindex c7c6eddb..2e036463 100644\n--- a/src/main/java/com/aws/greengrass/util/Utils.java\n+++ b/src/main/java/com/aws/greengrass/util/Utils.java\n\n@@ -102,10 +102,7 @@ public final class Utils {\n         if (oldValue == null && newValue == null) {\n             return false;\n         }\n-        if (oldValue == null && Utils.isEmpty(newValue)) {\n-            return false;\n-        }\n-        if (oldValue != null && Utils.isEmpty(oldValue) && newValue == null) {\n+        if (Utils.isEmpty(oldValue) && Utils.isEmpty(newValue)) {\n             return false;\n         }\n         if ((oldValue == null) != (newValue == null)) {\n"}}, {"oid": "79901fed7dd33a71c1389842f50d3982a564a783", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/79901fed7dd33a71c1389842f50d3982a564a783", "message": "Simplify stringHasChanged", "committedDate": "2020-11-10T20:49:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg2NjE5OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/651#discussion_r520866199", "bodyText": "this is also covered by L105", "author": "MikeDombo", "createdAt": "2020-11-10T20:51:49Z", "path": "src/main/java/com/aws/greengrass/util/Utils.java", "diffHunk": "@@ -90,16 +90,21 @@ public static Throwable flush(Object flushable) {\n     }\n \n     /**\n-     * Returns true if the two strings are different, including null.\n+     * Returns true if the two strings are different, including <code>null</code>.\n+     *\n+     * <p>A change from <code>null</code> to <code>\"\"</code>, or vice versa, is not considered a change.</p>\n      *\n      * @param oldValue first string\n      * @param newValue second string\n-     * @return true if the two strings are not equal\n+     * @return true if the two strings are different\n      */\n     public static boolean stringHasChanged(String oldValue, String newValue) {\n         if (oldValue == null && newValue == null) {", "originalCommit": "79901fed7dd33a71c1389842f50d3982a564a783", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg2OTQwNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/651#discussion_r520869406", "bodyText": "For some reason I thought it was returning something different. Removed it.", "author": "tomnagy-aws", "createdAt": "2020-11-10T20:57:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg2NjE5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "7b14b2c4dc7322478795d7126b715ad1d2d0bd76", "chunk": "diff --git a/src/main/java/com/aws/greengrass/util/Utils.java b/src/main/java/com/aws/greengrass/util/Utils.java\nindex 2e036463..f3c16d17 100644\n--- a/src/main/java/com/aws/greengrass/util/Utils.java\n+++ b/src/main/java/com/aws/greengrass/util/Utils.java\n\n@@ -99,9 +99,6 @@ public final class Utils {\n      * @return true if the two strings are different\n      */\n     public static boolean stringHasChanged(String oldValue, String newValue) {\n-        if (oldValue == null && newValue == null) {\n-            return false;\n-        }\n         if (Utils.isEmpty(oldValue) && Utils.isEmpty(newValue)) {\n             return false;\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg2NjYxMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/651#discussion_r520866613", "bodyText": "this can go too", "author": "rbattle", "createdAt": "2020-11-10T20:52:34Z", "path": "src/main/java/com/aws/greengrass/util/Utils.java", "diffHunk": "@@ -102,10 +102,7 @@ public static boolean stringHasChanged(String oldValue, String newValue) {\n         if (oldValue == null && newValue == null) {\n             return false;\n         }", "originalCommit": "79901fed7dd33a71c1389842f50d3982a564a783", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg2OTQ3NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/651#discussion_r520869475", "bodyText": "Removed it", "author": "tomnagy-aws", "createdAt": "2020-11-10T20:58:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg2NjYxMw=="}], "type": "inlineReview", "revised_code": {"commit": "7b14b2c4dc7322478795d7126b715ad1d2d0bd76", "chunk": "diff --git a/src/main/java/com/aws/greengrass/util/Utils.java b/src/main/java/com/aws/greengrass/util/Utils.java\nindex 2e036463..f3c16d17 100644\n--- a/src/main/java/com/aws/greengrass/util/Utils.java\n+++ b/src/main/java/com/aws/greengrass/util/Utils.java\n\n@@ -99,9 +99,6 @@ public final class Utils {\n      * @return true if the two strings are different\n      */\n     public static boolean stringHasChanged(String oldValue, String newValue) {\n-        if (oldValue == null && newValue == null) {\n-            return false;\n-        }\n         if (Utils.isEmpty(oldValue) && Utils.isEmpty(newValue)) {\n             return false;\n         }\n"}}, {"oid": "7b14b2c4dc7322478795d7126b715ad1d2d0bd76", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7b14b2c4dc7322478795d7126b715ad1d2d0bd76", "message": "oops", "committedDate": "2020-11-10T20:56:21Z", "type": "commit"}]}