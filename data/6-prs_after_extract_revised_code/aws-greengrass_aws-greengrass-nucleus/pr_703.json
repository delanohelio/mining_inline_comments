{"pr_number": 703, "pr_title": "Add deployment fixes to kernel update", "pr_createdAt": "2020-11-19T00:20:29Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/703", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUxMDM5Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/703#discussion_r526510392", "bodyText": "remove inject from the fields if they are coming in through the constructor.", "author": "MikeDombo", "createdAt": "2020-11-19T00:22:50Z", "path": "src/main/java/com/aws/greengrass/deployment/DeploymentConfigMerger.java", "diffHunk": "@@ -50,6 +52,8 @@\n \n     @Inject\n     private Kernel kernel;\n+    @Inject\n+    private DynamicComponentConfigurationValidator validator;", "originalCommit": "2bed7ea0af8636146ca07048b211e7da030a8757", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3dc47be9c618e03d936396f3bf7d81d28923ee43", "chunk": "diff --git a/src/main/java/com/aws/greengrass/deployment/DeploymentConfigMerger.java b/src/main/java/com/aws/greengrass/deployment/DeploymentConfigMerger.java\nindex 3447512dd5..1ed1482525 100644\n--- a/src/main/java/com/aws/greengrass/deployment/DeploymentConfigMerger.java\n+++ b/src/main/java/com/aws/greengrass/deployment/DeploymentConfigMerger.java\n\n@@ -50,9 +51,7 @@ public class DeploymentConfigMerger {\n \n     private static final Logger logger = LogManager.getLogger(DeploymentConfigMerger.class);\n \n-    @Inject\n     private Kernel kernel;\n-    @Inject\n     private DynamicComponentConfigurationValidator validator;\n \n     /**\n"}}, {"oid": "8e6201d6594237d8237292e12ace3a97c9480046", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8e6201d6594237d8237292e12ace3a97c9480046", "message": "Add deployment fixes to kernel update", "committedDate": "2020-11-24T03:13:35Z", "type": "forcePushed"}, {"oid": "b31994e92a760c92f91335bd392e00c65b9e98b1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b31994e92a760c92f91335bd392e00c65b9e98b1", "message": "Add deployment fixes to kernel update", "committedDate": "2020-11-24T21:39:28Z", "type": "commit"}, {"oid": "3dc47be9c618e03d936396f3bf7d81d28923ee43", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3dc47be9c618e03d936396f3bf7d81d28923ee43", "message": "Update config merging of Nucleus-type component", "committedDate": "2020-11-24T22:02:51Z", "type": "commit"}, {"oid": "3dc47be9c618e03d936396f3bf7d81d28923ee43", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3dc47be9c618e03d936396f3bf7d81d28923ee43", "message": "Update config merging of Nucleus-type component", "committedDate": "2020-11-24T22:02:51Z", "type": "forcePushed"}, {"oid": "13c7399594cf58c024a325aedc9a26aaa5ae6130", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/13c7399594cf58c024a325aedc9a26aaa5ae6130", "message": "Merge branch 'master' into ku-fix-2", "committedDate": "2020-11-24T23:33:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA1MTM5MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/703#discussion_r530051390", "bodyText": "Maybe I miss something here, isn't line295 duplicate of line 287?", "author": "fengwang666", "createdAt": "2020-11-25T01:34:48Z", "path": "src/main/java/com/aws/greengrass/componentmanager/KernelConfigResolver.java", "diffHunk": "@@ -280,6 +286,15 @@ private void updateRunWith(RunWith runWith, Map<String, Object> resolvedServiceC\n                 if (configuration != null) {\n                     currentRunningConfig.copyFrom(configuration);\n                 }\n+            } else if (ComponentType.NUCLEUS.equals(componentRecipe.getComponentType())) {\n+                // Copy from existing Nucleus config (if any)\n+                Topics nucleusTopics = kernel.findServiceTopic(deviceConfiguration.getNucleusComponentName());\n+                if (nucleusTopics != null) {\n+                    Topics nucleusConfig = nucleusTopics.findTopics(CONFIGURATION_CONFIG_KEY);\n+                    if (nucleusConfig != null) {\n+                        currentRunningConfig.copyFrom(nucleusConfig);", "originalCommit": "13c7399594cf58c024a325aedc9a26aaa5ae6130", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA1Mzk2Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/703#discussion_r530053962", "bodyText": "ln 287 loads current configuration for all components, if applicable.\nln 295 makes sure the nucleus-type component inherits the existing config for current nucleus-type component. This applies when we deploy a new Nucleus component with a different name. There's separate code to ensure there's only one nucleus-type component.", "author": "hui-yang", "createdAt": "2020-11-25T01:43:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA1MTM5MA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "53ad2d2a322c35b8f9703da9d30de61af0bdb5ef", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/53ad2d2a322c35b8f9703da9d30de61af0bdb5ef", "message": "Merge branch 'master' into ku-fix-2", "committedDate": "2020-11-25T01:43:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEwNDE1MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/703#discussion_r530104151", "bodyText": "We don't need this?", "author": "shaguptashaikh", "createdAt": "2020-11-25T04:41:13Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/KernelCommandLine.java", "diffHunk": "@@ -141,12 +154,6 @@ private void initPaths(String rootAbsolutePath) {\n             nucleusPaths.setTelemetryPath(TelemetryConfig.getInstance().getStoreDirectory());\n             String storeDirectory = LogManager.getRootLogConfiguration().getStoreDirectory().toAbsolutePath()\n                     .toString();\n-            Topic outputDirectoryTopic = deviceConfiguration.getLoggingConfigurationTopics()\n-                    .lookup(\"outputDirectory\");\n-            String outputDirectory = Coerce.toString(outputDirectoryTopic);\n-            if (Utils.isNotEmpty(outputDirectory)) {\n-                storeDirectory = deTilde(outputDirectory);\n-            }", "originalCommit": "53ad2d2a322c35b8f9703da9d30de61af0bdb5ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDExNzQ3OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/703#discussion_r530117479", "bodyText": "It doesn't work actually. Config hasn't been loaded here.", "author": "hui-yang", "createdAt": "2020-11-25T05:32:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEwNDE1MQ=="}], "type": "inlineReview", "revised_code": null}]}