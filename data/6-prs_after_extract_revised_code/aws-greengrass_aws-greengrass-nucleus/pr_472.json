{"pr_number": 472, "pr_title": "Set Group name along with deployment ID.", "pr_createdAt": "2020-09-24T22:42:13Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/472", "timeline": [{"oid": "ab6e64c2e4a37852a4ae2aadb07de70369b8de51", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ab6e64c2e4a37852a4ae2aadb07de70369b8de51", "message": "Set Group name along with dpeloyment ID.", "committedDate": "2020-09-24T22:39:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcxMjA5OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/472#discussion_r494712098", "bodyText": "Curious, where is deploymentGroupToRootPackages used?", "author": "ShirleyZheng92", "createdAt": "2020-09-25T02:30:52Z", "path": "src/main/java/com/aws/greengrass/deployment/DeploymentService.java", "diffHunk": "@@ -243,6 +245,8 @@ private void finishCurrentDeployment() throws InterruptedException {\n                             pkgDetails.put(GROUP_TO_ROOT_COMPONENTS_VERSION_KEY, pkgConfig.getResolvedVersion());\n                             pkgDetails.put(GROUP_TO_ROOT_COMPONENTS_GROUP_CONFIG_ARN,\n                                     deploymentDocument.getDeploymentId());\n+                            pkgDetails.put(GROUP_TO_ROOT_COMPONENTS_GROUP_NAME,\n+                                    deploymentDocument.getGroupName());", "originalCommit": "ab6e64c2e4a37852a4ae2aadb07de70369b8de51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDczNDQwNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/472#discussion_r494734404", "bodyText": "deploymentGroupToRootPackages is used to update the GROUP_TO_ROOT_COMPONENTS_TOPICS which contain all the root component to group mappings. This is updated during deployment.", "author": "nikkhilmuthye", "createdAt": "2020-09-25T04:01:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcxMjA5OA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcxNzM0OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/472#discussion_r494717348", "bodyText": "NIT: can you add a comment of what's the structure under componentsToGroupsTopics ?\ncomponentsToGroupsTopics:\n  <componentName>:\n    <deploymentConfigArn>: <groupName>", "author": "ShirleyZheng92", "createdAt": "2020-09-25T02:50:39Z", "path": "src/main/java/com/aws/greengrass/deployment/DeploymentService.java", "diffHunk": "@@ -460,9 +464,12 @@ private void setComponentsToGroupsMapping(Topics groupsToRootComponents) {\n             Topic groupConfigTopic = componentTopics.lookup(GROUP_TO_ROOT_COMPONENTS_GROUP_CONFIG_ARN);\n             String groupConfig = Coerce.toString(groupConfigTopic);\n \n+            Topic groupNameTopic = componentTopics.lookup(GROUP_TO_ROOT_COMPONENTS_GROUP_NAME);\n+            String groupName = Coerce.toString(groupNameTopic);\n+\n             Map<String, Object> groupDeploymentIdSet = (Map<String, Object>) componentsToGroupsMappingCache\n                     .getOrDefault(componentTopics.getName(), new HashMap<>());\n-            groupDeploymentIdSet.putIfAbsent(groupConfig, true);\n+            groupDeploymentIdSet.putIfAbsent(groupConfig, groupName);", "originalCommit": "ab6e64c2e4a37852a4ae2aadb07de70369b8de51", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "683ee6dce56ac4580ee449e434e55f6252b07be4", "chunk": "diff --git a/src/main/java/com/aws/greengrass/deployment/DeploymentService.java b/src/main/java/com/aws/greengrass/deployment/DeploymentService.java\nindex e0e5cb2ab..ed4039d7b 100644\n--- a/src/main/java/com/aws/greengrass/deployment/DeploymentService.java\n+++ b/src/main/java/com/aws/greengrass/deployment/DeploymentService.java\n\n@@ -457,6 +457,14 @@ public class DeploymentService extends GreengrassService {\n         List<String> pendingComponentsList = new LinkedList<>();\n         Map<String, Object> componentsToGroupsMappingCache = new ConcurrentHashMap<>();\n         Topics componentsToGroupsTopics = getConfig().lookupTopics(COMPONENTS_TO_GROUPS_TOPICS);\n+        /*\n+         * Structure of COMPONENTS_TO_GROUPS_TOPICS is:\n+         * COMPONENTS_TO_GROUPS_TOPICS :\n+         * |_ <componentName> :\n+         *     |_ <deploymentID> : <GroupName>\n+         * This stores all the components with the list of deployment IDs associated to it along with the thing group\n+         * (if available) to be associated to the deployment.\n+         */\n         // Get all the groups associated to the root components.\n         groupsToRootComponents.iterator().forEachRemaining(groupNode -> {\n             Topics componentTopics = (Topics) groupNode;\n"}}, {"oid": "683ee6dce56ac4580ee449e434e55f6252b07be4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/683ee6dce56ac4580ee449e434e55f6252b07be4", "message": "Address PR comments.", "committedDate": "2020-09-25T04:06:27Z", "type": "commit"}, {"oid": "e20a7f4b0fc9341497d2c74fe8fe1968b7b591c5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e20a7f4b0fc9341497d2c74fe8fe1968b7b591c5", "message": "Merge branch 'master' into setGroupNameWithDeploymentId", "committedDate": "2020-09-25T15:26:11Z", "type": "commit"}, {"oid": "2ceba704f76dbe402b05f08c8de79c15e9be9159", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2ceba704f76dbe402b05f08c8de79c15e9be9159", "message": "Merge branch 'master' into setGroupNameWithDeploymentId", "committedDate": "2020-09-25T16:23:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEwMDI0MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/472#discussion_r495100241", "bodyText": "use our own utils. Utils.isEmpty", "author": "MikeDombo", "createdAt": "2020-09-25T16:27:29Z", "path": "src/main/java/com/aws/greengrass/deployment/DeploymentService.java", "diffHunk": "@@ -502,14 +517,19 @@ private void setComponentsToGroupsMapping(Topics groupsToRootComponents) {\n      * @param componentName The name of the component.\n      * @return The list of groups the component is a part of.\n      */\n-    public Set<String> getGroupConfigsForUserComponent(String componentName) {\n+    public Set<String> getGroupNamesForUserComponent(String componentName) {\n         Topics componentsToGroupsTopics = config.lookupTopics(COMPONENTS_TO_GROUPS_TOPICS);\n \n         Set<String> componentGroups = new HashSet<>();\n         if (componentsToGroupsTopics != null) {\n             Topics groupsTopics = componentsToGroupsTopics.lookupTopics(componentName);\n-            groupsTopics.children.values().stream().map(n -> (Topic) n).map(Topic::getName)\n-                    .forEach(componentGroups::add);\n+            groupsTopics.children.values().stream().map(n -> (Topic) n)\n+                    .forEach(topic -> {\n+                        String groupName = Coerce.toString(topic);\n+                        if (!StringUtils.isNullOrEmpty(groupName)) {", "originalCommit": "2ceba704f76dbe402b05f08c8de79c15e9be9159", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bd2c044c437e0cf83c56ab63dcc86fbfcba5c4b6", "chunk": "diff --git a/src/main/java/com/aws/greengrass/deployment/DeploymentService.java b/src/main/java/com/aws/greengrass/deployment/DeploymentService.java\nindex ed4039d7b..91d631937 100644\n--- a/src/main/java/com/aws/greengrass/deployment/DeploymentService.java\n+++ b/src/main/java/com/aws/greengrass/deployment/DeploymentService.java\n\n@@ -526,7 +524,7 @@ public class DeploymentService extends GreengrassService {\n             groupsTopics.children.values().stream().map(n -> (Topic) n)\n                     .forEach(topic -> {\n                         String groupName = Coerce.toString(topic);\n-                        if (!StringUtils.isNullOrEmpty(groupName)) {\n+                        if (!Utils.isEmpty(groupName)) {\n                             componentGroups.add(groupName);\n                         }\n                     });\n"}}, {"oid": "bd2c044c437e0cf83c56ab63dcc86fbfcba5c4b6", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/bd2c044c437e0cf83c56ab63dcc86fbfcba5c4b6", "message": "Use Utils.isEmpty.", "committedDate": "2020-09-25T16:50:19Z", "type": "commit"}, {"oid": "3a6d75eb4f22341fe1ff5d2a21eb99f1fe0c71b7", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3a6d75eb4f22341fe1ff5d2a21eb99f1fe0c71b7", "message": "Merge branch 'master' into setGroupNameWithDeploymentId", "committedDate": "2020-09-25T18:46:16Z", "type": "commit"}, {"oid": "c02e3dde2a42dba1e32339878bf28f170d77dce5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c02e3dde2a42dba1e32339878bf28f170d77dce5", "message": "Merge branch 'master' into setGroupNameWithDeploymentId", "committedDate": "2020-09-25T19:55:23Z", "type": "commit"}, {"oid": "62368b1da481e2fa79b9093d0a3d171bdb779850", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/62368b1da481e2fa79b9093d0a3d171bdb779850", "message": "Merge branch 'master' into setGroupNameWithDeploymentId", "committedDate": "2020-09-26T14:47:37Z", "type": "commit"}, {"oid": "77caa7e87c17dccf92fd56024cf5761ce82be119", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/77caa7e87c17dccf92fd56024cf5761ce82be119", "message": "Merge branch 'master' into setGroupNameWithDeploymentId", "committedDate": "2020-09-26T18:28:59Z", "type": "commit"}, {"oid": "9dad06e6a35ff19718e0fa2714e221cc6d957654", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9dad06e6a35ff19718e0fa2714e221cc6d957654", "message": "Add test change to increase converage.", "committedDate": "2020-09-28T15:22:23Z", "type": "commit"}, {"oid": "d57109e293e754ddae949b4335025c419963a084", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d57109e293e754ddae949b4335025c419963a084", "message": "Merge branch 'master' into setGroupNameWithDeploymentId", "committedDate": "2020-09-28T19:16:25Z", "type": "commit"}, {"oid": "1efb791aca685ac0e4cb711f9c7fc3ef31c4180b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1efb791aca685ac0e4cb711f9c7fc3ef31c4180b", "message": "Merge branch 'master' into setGroupNameWithDeploymentId", "committedDate": "2020-09-28T20:32:55Z", "type": "commit"}, {"oid": "c4168773fb52dffbeca201de689a9e233f4db85c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c4168773fb52dffbeca201de689a9e233f4db85c", "message": "Merge branch 'master' into setGroupNameWithDeploymentId", "committedDate": "2020-09-28T23:23:04Z", "type": "commit"}, {"oid": "186a10760c76f673ad660d5388b5a37c2ec9f30b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/186a10760c76f673ad660d5388b5a37c2ec9f30b", "message": "Add proper message to check why test is flaky.", "committedDate": "2020-09-29T15:40:04Z", "type": "commit"}, {"oid": "f35cd40c11a15355aba2073f09b1e919182c3d09", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f35cd40c11a15355aba2073f09b1e919182c3d09", "message": "Merge branch 'setGroupNameWithDeploymentId' of github.com:aws/aws-greengrass-kernel into setGroupNameWithDeploymentId", "committedDate": "2020-09-29T15:40:35Z", "type": "commit"}]}