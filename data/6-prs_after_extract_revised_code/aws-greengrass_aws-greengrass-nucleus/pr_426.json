{"pr_number": 426, "pr_title": "Force executors to shutdown and interrupt their tasks", "pr_createdAt": "2020-09-10T05:58:47Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/426", "timeline": [{"oid": "5650e62922ee9a8fc362819310909da5d1c0a6b4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5650e62922ee9a8fc362819310909da5d1c0a6b4", "message": "Remove unnecessary sleep", "committedDate": "2020-09-10T15:58:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ5NTMzMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/426#discussion_r486495331", "bodyText": "I guess we do want to wait when shipping the kernel though. Is this only for test improvement temporarily?", "author": "leaf94", "createdAt": "2020-09-10T16:57:59Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/KernelLifecycle.java", "diffHunk": "@@ -262,12 +262,12 @@ public void shutdown(int timeoutSeconds) {\n             logger.atInfo().setEventType(\"system-shutdown\").addKeyValue(\"main\", getMain()).log();\n             stopAllServices(timeoutSeconds);\n \n-            // Wait for tasks in the executor to end.\n+            // Do not wait for tasks in the executor to end.\n             ScheduledExecutorService scheduledExecutorService = kernel.getContext().get(ScheduledExecutorService.class);\n             ExecutorService executorService = kernel.getContext().get(ExecutorService.class);\n             kernel.getContext().runOnPublishQueueAndWait(() -> {\n-                executorService.shutdown();\n-                scheduledExecutorService.shutdown();\n+                executorService.shutdownNow();\n+                scheduledExecutorService.shutdownNow();", "originalCommit": "5650e62922ee9a8fc362819310909da5d1c0a6b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ5NjI0Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/426#discussion_r486496246", "bodyText": "No, I'm not sure about that actually. We give the services 30 seconds to shutdown and if they haven't died after that point, we need to just start killing stuff.", "author": "MikeDombo", "createdAt": "2020-09-10T16:59:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ5NTMzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ5NjQ3OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/426#discussion_r486496479", "bodyText": "Up for debate though", "author": "MikeDombo", "createdAt": "2020-09-10T16:59:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ5NTMzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUwMjExMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/426#discussion_r486502110", "bodyText": "@fengwa-aws any opinion?", "author": "MikeDombo", "createdAt": "2020-09-10T17:09:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ5NTMzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njc2NjQ2MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/426#discussion_r486766461", "bodyText": "if we are forcing the executors to shut down, can you add a todo to update the stopAllServices() function to honor the shutdown timeout of each individual component. Otherwise looks good", "author": "fahadmohammed01", "createdAt": "2020-09-11T04:28:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ5NTMzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "a4898159ac4518d92b973cc6ed46befdea76955c", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/kernel/KernelLifecycle.java b/src/main/java/com/aws/iot/evergreen/kernel/KernelLifecycle.java\nindex 648db728b8..89ffde7a31 100644\n--- a/src/main/java/com/aws/iot/evergreen/kernel/KernelLifecycle.java\n+++ b/src/main/java/com/aws/iot/evergreen/kernel/KernelLifecycle.java\n\n@@ -270,11 +271,9 @@ public class KernelLifecycle {\n                 scheduledExecutorService.shutdownNow();\n                 logger.atInfo().setEventType(\"executor-service-shutdown-initiated\").log();\n             });\n-            // TODO: Timeouts should not be additive (ie. our timeout should be for this entire method, not\n-            //  each timeout-able part of the method.\n             logger.atInfo().log(\"Waiting for executors to shutdown\");\n-            executorService.awaitTermination(timeoutSeconds, TimeUnit.SECONDS);\n-            scheduledExecutorService.awaitTermination(timeoutSeconds, TimeUnit.SECONDS);\n+            executorService.awaitTermination(EXECUTOR_SHUTDOWN_TIMEOUT_SECONDS, TimeUnit.SECONDS);\n+            scheduledExecutorService.awaitTermination(EXECUTOR_SHUTDOWN_TIMEOUT_SECONDS, TimeUnit.SECONDS);\n             logger.atInfo(\"executor-service-shutdown-complete\").log();\n             logger.atInfo(\"context-shutdown-initiated\").log();\n             kernel.getContext().close();\n"}}, {"oid": "378231c1783cc5c65f2a4266a4a24bd96c9f0841", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/378231c1783cc5c65f2a4266a4a24bd96c9f0841", "message": "Remove unnecessary sleep", "committedDate": "2020-09-11T02:24:44Z", "type": "forcePushed"}, {"oid": "a4530021476123a0d19ddad48f125760b32228aa", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a4530021476123a0d19ddad48f125760b32228aa", "message": "Force executors to shutdown and interrupt their tasks", "committedDate": "2020-09-11T05:11:33Z", "type": "commit"}, {"oid": "dec8cbdc002abdcfb965ce51cfd9d26b908d87a0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/dec8cbdc002abdcfb965ce51cfd9d26b908d87a0", "message": "Remove unnecessary sleep", "committedDate": "2020-09-11T05:11:34Z", "type": "commit"}, {"oid": "ed0608dcb3ef6749277ac65c408d288bfa74c0ba", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ed0608dcb3ef6749277ac65c408d288bfa74c0ba", "message": "Fix broken test", "committedDate": "2020-09-11T05:11:34Z", "type": "commit"}, {"oid": "ed0608dcb3ef6749277ac65c408d288bfa74c0ba", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ed0608dcb3ef6749277ac65c408d288bfa74c0ba", "message": "Fix broken test", "committedDate": "2020-09-11T05:11:34Z", "type": "forcePushed"}, {"oid": "a4898159ac4518d92b973cc6ed46befdea76955c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a4898159ac4518d92b973cc6ed46befdea76955c", "message": "Add comment", "committedDate": "2020-09-11T06:09:34Z", "type": "forcePushed"}, {"oid": "0efff00d8ea883489e094a4304483625c6c9c372", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0efff00d8ea883489e094a4304483625c6c9c372", "message": "Add comment", "committedDate": "2020-09-11T06:26:41Z", "type": "forcePushed"}, {"oid": "06e6008d8b92a1dbe7179e8840dd0b49e787572f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/06e6008d8b92a1dbe7179e8840dd0b49e787572f", "message": "Add comment", "committedDate": "2020-09-11T07:00:23Z", "type": "commit"}, {"oid": "06e6008d8b92a1dbe7179e8840dd0b49e787572f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/06e6008d8b92a1dbe7179e8840dd0b49e787572f", "message": "Add comment", "committedDate": "2020-09-11T07:00:23Z", "type": "forcePushed"}, {"oid": "e9446bfeee63fa9a680e5a7e7777d6e1d3abe93f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e9446bfeee63fa9a680e5a7e7777d6e1d3abe93f", "message": "Merge branch 'master' into shutdown", "committedDate": "2020-09-11T16:37:44Z", "type": "commit"}]}