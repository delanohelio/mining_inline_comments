{"pr_number": 629, "pr_title": "Waiting for Ipc shutdown and elg close which should be fixed with lat\u2026", "pr_createdAt": "2020-11-06T03:21:02Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/629", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUwNDM5MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/629#discussion_r518504391", "bodyText": "use SLF4J?", "author": "MikeDombo", "createdAt": "2020-11-06T03:34:20Z", "path": "src/main/java/software/amazon/awssdk/eventstreamrpc/DebugLoggingOperationHandler.java", "diffHunk": "@@ -6,18 +6,17 @@\n package software.amazon.awssdk.eventstreamrpc;\n \n import com.google.gson.Gson;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n import software.amazon.awssdk.eventstreamrpc.model.EventStreamJsonMessage;\n \n import java.nio.charset.StandardCharsets;\n+import java.util.logging.Logger;\n \n /**\n  * Useful to set as a handler for an operation with no implementation yet.\n  */\n public class DebugLoggingOperationHandler extends OperationContinuationHandler\n         <EventStreamJsonMessage, EventStreamJsonMessage, EventStreamJsonMessage, EventStreamJsonMessage> {\n-    private static final Logger LOGGER = LoggerFactory.getLogger(DebugLoggingOperationHandler.class);\n+    private static final Logger LOGGER = Logger.getLogger(DebugLoggingOperationHandler.class.getName());", "originalCommit": "c626c73d6d8b742d0ad3a16d2ae3037318fd9a80", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUwNDg5MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/629#discussion_r518504890", "bodyText": "and if there is a reason to  not use SLF4J, it should be commented here. I saw some reference to logging in the SDK conversations yesterday..but I haven't followed up on the whole thread", "author": "rbattle", "createdAt": "2020-11-06T03:36:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUwNDM5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUyMTE2MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/629#discussion_r518521160", "bodyText": "We are not making that change in SDK code.", "author": "abanthiy", "createdAt": "2020-11-06T04:47:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUwNDM5MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUwNDQzNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/629#discussion_r518504434", "bodyText": "use SLF4J?", "author": "MikeDombo", "createdAt": "2020-11-06T03:34:30Z", "path": "src/main/java/software/amazon/awssdk/eventstreamrpc/IpcServer.java", "diffHunk": "@@ -18,13 +23,8 @@\n import software.amazon.awssdk.crt.io.SocketOptions;\n import software.amazon.awssdk.crt.io.TlsContextOptions;\n \n-import java.util.Set;\n-import java.util.concurrent.CompletableFuture;\n-import java.util.concurrent.atomic.AtomicBoolean;\n-import java.util.stream.Collectors;\n-\n public class IpcServer implements AutoCloseable {\n-    private static final Logger LOGGER = LoggerFactory.getLogger(IpcServer.class);\n+    private static final Logger LOGGER = Logger.getLogger(IpcServer.class.getName());", "originalCommit": "c626c73d6d8b742d0ad3a16d2ae3037318fd9a80", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUyMTEzNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/629#discussion_r518521137", "bodyText": "We are not making that change in SDK code.", "author": "abanthiy", "createdAt": "2020-11-06T04:47:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUwNDQzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUyMTU5OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/629#discussion_r518521599", "bodyText": "This was switched to slf to avoid the logger deadlock. Why not switch it back to slf?", "author": "MikeDombo", "createdAt": "2020-11-06T04:49:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUwNDQzNA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUwNDUzNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/629#discussion_r518504535", "bodyText": "remove system out", "author": "MikeDombo", "createdAt": "2020-11-06T03:34:57Z", "path": "src/main/java/software/amazon/awssdk/eventstreamrpc/IpcServer.java", "diffHunk": "@@ -58,6 +58,7 @@ public void runServer() {\n         }\n         serverBootstrap = new ServerBootstrap(eventLoopGroup);\n         tlsContext = tlsContextOptions != null ? new ServerTlsContext(tlsContextOptions) : null;\n+        System.out.println(\"Hostname: \" + hostname);", "originalCommit": "c626c73d6d8b742d0ad3a16d2ae3037318fd9a80", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c6ca7f689ff615c6f99cfb12d5e52658aaa43d6d", "chunk": "diff --git a/src/main/java/software/amazon/awssdk/eventstreamrpc/IpcServer.java b/src/main/java/software/amazon/awssdk/eventstreamrpc/IpcServer.java\nindex cca890a09..f0e1bbb97 100644\n--- a/src/main/java/software/amazon/awssdk/eventstreamrpc/IpcServer.java\n+++ b/src/main/java/software/amazon/awssdk/eventstreamrpc/IpcServer.java\n\n@@ -58,7 +58,6 @@ public class IpcServer implements AutoCloseable {\n         }\n         serverBootstrap = new ServerBootstrap(eventLoopGroup);\n         tlsContext = tlsContextOptions != null ? new ServerTlsContext(tlsContextOptions) : null;\n-        System.out.println(\"Hostname: \" + hostname);\n         listener = new ServerListener(hostname, (short) port, socketOptions, tlsContext, serverBootstrap, new ServerListenerHandler() {\n                 @Override\n                 public ServerConnectionHandler onNewConnection(ServerConnection serverConnection, int errorCode) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUwNTkyMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/629#discussion_r518505922", "bodyText": "A better log might be: \"Error while waiting for IPC shutdown to finish\"\nThere's no reason to introduce \"ELG\" here", "author": "rbattle", "createdAt": "2020-11-06T03:41:04Z", "path": "src/main/java/com/aws/greengrass/ipc/IPCEventStreamService.java", "diffHunk": "@@ -225,15 +226,22 @@ private AuthenticationData ipcAuthenticationHandler(byte[] payload) {\n     }\n \n     @Override\n-    @SuppressWarnings(\"PMD.AvoidCatchingThrowable\")\n+    @SuppressWarnings({\"PMD.AvoidCatchingThrowable\", \"PMD.AvoidCatchingGenericException\"})\n     public void close() {\n-        // GG_NEEDS_REVIEW: TODO: Future does not complete, wait on them when fixed.\n         if (ipcServer != null) {\n-            ipcServer.stopServer();\n+            try {\n+                ipcServer.stopServer().get(10, TimeUnit.SECONDS);\n+            } catch (Exception e) {\n+                logger.atError().setCause(e).log(\"Error stopping IPC server\");\n+            }\n         }\n         if (eventLoopGroup != null) {\n             eventLoopGroup.close();\n-            // GG_NEEDS_REVIEW: TODO: Wait for ELG to close. Right now the future does not complete, thus timing out.\n+            try {\n+                eventLoopGroup.getShutdownCompleteFuture().get(10, TimeUnit.SECONDS);\n+            } catch (Exception e) {\n+                logger.atError().setCause(e).log(\"Error waiting for ELG to close\");", "originalCommit": "c626c73d6d8b742d0ad3a16d2ae3037318fd9a80", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c6ca7f689ff615c6f99cfb12d5e52658aaa43d6d", "chunk": "diff --git a/src/main/java/com/aws/greengrass/ipc/IPCEventStreamService.java b/src/main/java/com/aws/greengrass/ipc/IPCEventStreamService.java\nindex afe2168de..1d98de7f9 100644\n--- a/src/main/java/com/aws/greengrass/ipc/IPCEventStreamService.java\n+++ b/src/main/java/com/aws/greengrass/ipc/IPCEventStreamService.java\n\n@@ -230,7 +230,7 @@ public class IPCEventStreamService implements Startable, Closeable {\n     public void close() {\n         if (ipcServer != null) {\n             try {\n-                ipcServer.stopServer().get(10, TimeUnit.SECONDS);\n+                ipcServer.stopServer().get(2, TimeUnit.MINUTES);\n             } catch (Exception e) {\n                 logger.atError().setCause(e).log(\"Error stopping IPC server\");\n             }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUwNjI5NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/629#discussion_r518506294", "bodyText": "where does 10s come from?\nIs this going to be a problem on slow devices?", "author": "rbattle", "createdAt": "2020-11-06T03:42:48Z", "path": "src/main/java/com/aws/greengrass/ipc/IPCEventStreamService.java", "diffHunk": "@@ -225,15 +226,22 @@ private AuthenticationData ipcAuthenticationHandler(byte[] payload) {\n     }\n \n     @Override\n-    @SuppressWarnings(\"PMD.AvoidCatchingThrowable\")\n+    @SuppressWarnings({\"PMD.AvoidCatchingThrowable\", \"PMD.AvoidCatchingGenericException\"})\n     public void close() {\n-        // GG_NEEDS_REVIEW: TODO: Future does not complete, wait on them when fixed.\n         if (ipcServer != null) {\n-            ipcServer.stopServer();\n+            try {\n+                ipcServer.stopServer().get(10, TimeUnit.SECONDS);", "originalCommit": "c626c73d6d8b742d0ad3a16d2ae3037318fd9a80", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUyMTUyNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/629#discussion_r518521527", "bodyText": "I thought 10 will be generous for devices. What do you think is a good value?", "author": "abanthiy", "createdAt": "2020-11-06T04:48:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUwNjI5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUyNjA1MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/629#discussion_r518526051", "bodyText": "I don't know :-) 10s seems like a long time - how long does it normally take?\nIs it something that needs to be adjustable?\nWe've had issues in v1 of timeouts that have seemed \"reasonable\" that were too small on slow single core devices.\nWhat happens after the 10s is done if the server isn't stopped?", "author": "rbattle", "createdAt": "2020-11-06T05:07:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUwNjI5NA=="}], "type": "inlineReview", "revised_code": {"commit": "c6ca7f689ff615c6f99cfb12d5e52658aaa43d6d", "chunk": "diff --git a/src/main/java/com/aws/greengrass/ipc/IPCEventStreamService.java b/src/main/java/com/aws/greengrass/ipc/IPCEventStreamService.java\nindex afe2168de..1d98de7f9 100644\n--- a/src/main/java/com/aws/greengrass/ipc/IPCEventStreamService.java\n+++ b/src/main/java/com/aws/greengrass/ipc/IPCEventStreamService.java\n\n@@ -230,7 +230,7 @@ public class IPCEventStreamService implements Startable, Closeable {\n     public void close() {\n         if (ipcServer != null) {\n             try {\n-                ipcServer.stopServer().get(10, TimeUnit.SECONDS);\n+                ipcServer.stopServer().get(2, TimeUnit.MINUTES);\n             } catch (Exception e) {\n                 logger.atError().setCause(e).log(\"Error stopping IPC server\");\n             }\n"}}, {"oid": "c6ca7f689ff615c6f99cfb12d5e52658aaa43d6d", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c6ca7f689ff615c6f99cfb12d5e52658aaa43d6d", "message": "Waiting for Ipc shutdown and elg close which should be fixed with latest CRT. Updated SDK lib", "committedDate": "2020-11-06T04:56:19Z", "type": "commit"}, {"oid": "c6ca7f689ff615c6f99cfb12d5e52658aaa43d6d", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c6ca7f689ff615c6f99cfb12d5e52658aaa43d6d", "message": "Waiting for Ipc shutdown and elg close which should be fixed with latest CRT. Updated SDK lib", "committedDate": "2020-11-06T04:56:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUyNTEwMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/629#discussion_r518525101", "bodyText": "close() is called when greengrass is shutting down, waiting 2 minutes is unreasonable IMO", "author": "MikeDombo", "createdAt": "2020-11-06T05:03:54Z", "path": "src/main/java/com/aws/greengrass/ipc/IPCEventStreamService.java", "diffHunk": "@@ -225,15 +226,22 @@ private AuthenticationData ipcAuthenticationHandler(byte[] payload) {\n     }\n \n     @Override\n-    @SuppressWarnings(\"PMD.AvoidCatchingThrowable\")\n+    @SuppressWarnings({\"PMD.AvoidCatchingThrowable\", \"PMD.AvoidCatchingGenericException\"})\n     public void close() {\n-        // GG_NEEDS_REVIEW: TODO: Future does not complete, wait on them when fixed.\n         if (ipcServer != null) {\n-            ipcServer.stopServer();\n+            try {\n+                ipcServer.stopServer().get(2, TimeUnit.MINUTES);", "originalCommit": "c6ca7f689ff615c6f99cfb12d5e52658aaa43d6d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUyNTE2Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/629#discussion_r518525167", "bodyText": "The server should be able to shutdown basically immediately.", "author": "MikeDombo", "createdAt": "2020-11-06T05:04:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUyNTEwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUyNzYzOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/629#discussion_r518527639", "bodyText": "I am getting a timeout with 10 seconds. I need to verify that a value works. Can find a sweet spot later.", "author": "abanthiy", "createdAt": "2020-11-06T05:14:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUyNTEwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUyODEzMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/629#discussion_r518528133", "bodyText": "E2E test has been running 20 minutes now. It normally completes in 12. So I don't think it is closing in less than 2 minutes.", "author": "MikeDombo", "createdAt": "2020-11-06T05:16:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUyNTEwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUyOTE1Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/629#discussion_r518529156", "bodyText": "yes its not. I probably need to remove this change and unblock builds. I will add the wait later", "author": "abanthiy", "createdAt": "2020-11-06T05:20:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUyNTEwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "77a8ab3a536ddb0583a9d2c7a77e9870728a02c1", "chunk": "diff --git a/src/main/java/com/aws/greengrass/ipc/IPCEventStreamService.java b/src/main/java/com/aws/greengrass/ipc/IPCEventStreamService.java\nindex 1d98de7f9..3b49adee1 100644\n--- a/src/main/java/com/aws/greengrass/ipc/IPCEventStreamService.java\n+++ b/src/main/java/com/aws/greengrass/ipc/IPCEventStreamService.java\n\n@@ -228,20 +227,13 @@ public class IPCEventStreamService implements Startable, Closeable {\n     @Override\n     @SuppressWarnings({\"PMD.AvoidCatchingThrowable\", \"PMD.AvoidCatchingGenericException\"})\n     public void close() {\n+        // GG_NEEDS_REVIEW: TODO: Future does not complete, wait on them when fixed.\n         if (ipcServer != null) {\n-            try {\n-                ipcServer.stopServer().get(2, TimeUnit.MINUTES);\n-            } catch (Exception e) {\n-                logger.atError().setCause(e).log(\"Error stopping IPC server\");\n-            }\n+            ipcServer.stopServer();\n         }\n         if (eventLoopGroup != null) {\n             eventLoopGroup.close();\n-            try {\n-                eventLoopGroup.getShutdownCompleteFuture().get(2, TimeUnit.MINUTES);\n-            } catch (Exception e) {\n-                logger.atError().setCause(e).log(\"Error while waiting for IPC shutdown to finish\");\n-            }\n+            // GG_NEEDS_REVIEW: TODO: Wait for ELG to close. Right now the future does not complete, thus timing out.\n         }\n         if (socketOptions != null) {\n             socketOptions.close();\n"}}, {"oid": "77a8ab3a536ddb0583a9d2c7a77e9870728a02c1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/77a8ab3a536ddb0583a9d2c7a77e9870728a02c1", "message": "Removing the wait on Ipc server shutdown. Works on mac but does not on linux. Revisit in next PR", "committedDate": "2020-11-06T05:27:19Z", "type": "commit"}, {"oid": "77a8ab3a536ddb0583a9d2c7a77e9870728a02c1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/77a8ab3a536ddb0583a9d2c7a77e9870728a02c1", "message": "Removing the wait on Ipc server shutdown. Works on mac but does not on linux. Revisit in next PR", "committedDate": "2020-11-06T05:27:19Z", "type": "forcePushed"}]}