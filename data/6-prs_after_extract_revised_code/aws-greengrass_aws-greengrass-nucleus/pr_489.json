{"pr_number": 489, "pr_title": "stop service after it turns into BROKEN state", "pr_createdAt": "2020-09-29T21:34:05Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/489", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA3NDI5Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/489#discussion_r497074296", "bodyText": "what if it fails during install?", "author": "MikeDombo", "createdAt": "2020-09-29T21:35:35Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/Lifecycle.java", "diffHunk": "@@ -368,7 +368,17 @@ void setState(State current, State newState) {\n         }\n     }\n \n-    private void handleCurrentStateBroken(Optional<State> desiredState) {\n+    private void handleCurrentStateBroken(Optional<State> desiredState, State previousState)\n+            throws InterruptedException {\n+        switch (previousState) {\n+            case STARTING:\n+            case RUNNING:\n+            case ERRORED: // shouldn't happen. Try to stop the service anyways.", "originalCommit": "d44bd9649b797367be654c3a669abe4f62552c7e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA3NTg4MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/489#discussion_r497075881", "bodyText": "we don't do anything so far. in handleCurrentStateErrored() we directly set state to NEW and wait to re-install.", "author": "ShirleyZheng92", "createdAt": "2020-09-29T21:39:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA3NDI5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "a6c8d51ddae09f934d230d9d098ef5e25f38b6e9", "chunk": "diff --git a/src/main/java/com/aws/greengrass/lifecyclemanager/Lifecycle.java b/src/main/java/com/aws/greengrass/lifecyclemanager/Lifecycle.java\nindex 2396f73d43..093d4be4d8 100644\n--- a/src/main/java/com/aws/greengrass/lifecyclemanager/Lifecycle.java\n+++ b/src/main/java/com/aws/greengrass/lifecyclemanager/Lifecycle.java\n\n@@ -374,7 +374,29 @@ public class Lifecycle {\n             case STARTING:\n             case RUNNING:\n             case ERRORED: // shouldn't happen. Try to stop the service anyways.\n-                handleCurrentStateStopping();\n+                logger.atInfo(\"Stopping service in BROKEN state\");\n+                Future<?> shutdownFuture = greengrassService.getContext().get(ExecutorService.class).submit(() -> {\n+                    try {\n+                        greengrassService.shutdown();\n+                    } catch (InterruptedException i) {\n+                        logger.atWarn(\"service-shutdown-interrupted\").log(\"Service interrupted while running shutdown\");\n+                    } catch (Throwable i) {\n+                        logger.atError(\"service-shutdown-error\").setCause(i).log();\n+                    }\n+                });\n+\n+                try {\n+                    Integer timeout = getTimeoutConfigValue(\n+                            LIFECYCLE_SHUTDOWN_NAMESPACE_TOPIC, DEFAULT_SHUTDOWN_STAGE_TIMEOUT_IN_SEC);\n+                    shutdownFuture.get(timeout, TimeUnit.SECONDS);\n+                } catch (ExecutionException e) {\n+                    logger.atError(\"service-shutdown-error\").setCause(e).log();\n+                } catch (TimeoutException te) {\n+                    logger.atWarn(\"service-shutdown-timeout\").log();\n+                    shutdownFuture.cancel(true);\n+                } finally {\n+                    stopBackingTask();\n+                }\n                 break;\n             default:\n                 // do nothing\n"}}, {"oid": "a6c8d51ddae09f934d230d9d098ef5e25f38b6e9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a6c8d51ddae09f934d230d9d098ef5e25f38b6e9", "message": "stop service after it turns into BROKEN state", "committedDate": "2020-09-30T01:51:34Z", "type": "forcePushed"}, {"oid": "c47dcb0e47662b36e3561b69bbe6a4980d38b5d8", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c47dcb0e47662b36e3561b69bbe6a4980d38b5d8", "message": "stop service after it turns into BROKEN state", "committedDate": "2020-09-30T02:20:43Z", "type": "commit"}, {"oid": "c47dcb0e47662b36e3561b69bbe6a4980d38b5d8", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c47dcb0e47662b36e3561b69bbe6a4980d38b5d8", "message": "stop service after it turns into BROKEN state", "committedDate": "2020-09-30T02:20:43Z", "type": "forcePushed"}, {"oid": "a84af065c34a2aa3bfaabf313be9d52e34b0566a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a84af065c34a2aa3bfaabf313be9d52e34b0566a", "message": "Merge branch 'master' into fix_lifecycle", "committedDate": "2020-09-30T19:58:14Z", "type": "commit"}]}