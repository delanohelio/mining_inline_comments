{"pr_number": 630, "pr_title": "Better process tree killing", "pr_createdAt": "2020-11-06T05:43:26Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/630", "timeline": [{"oid": "6feed201673c76c633fd05c4eb2d5f64078115b7", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6feed201673c76c633fd05c4eb2d5f64078115b7", "message": "Better process tree killing", "committedDate": "2020-11-06T05:44:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODU0MzA4NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/630#discussion_r518543085", "bodyText": "this won't work on mac/linux when nucleus is not running as root and processes are able to be run as other uses via sudo- but it arguably wasn't working very well before anyway", "author": "rbattle", "createdAt": "2020-11-06T06:13:21Z", "path": "src/main/java/com/aws/greengrass/util/platforms/unix/UnixPlatform.java", "diffHunk": "@@ -253,23 +253,20 @@ public UnixUserAttributes lookupCurrentUser() throws IOException {\n     }\n \n     @Override\n-    public void killProcessAndChildren(Process process, boolean force, UserDecorator userDecorator)\n+    public Set<Integer> killProcessAndChildren(Process process, boolean force, Set<Integer> additionalPids)\n             throws IOException, InterruptedException {\n         PidProcess pp = Processes.newPidProcess(process);\n \n-        logger.atDebug().log(\"Running pkill to kill child processes of pid {}\", pp.getPid());\n-        // Use pkill to kill all subprocesses under the main shell\n-        String[] cmd = {\"pkill\", \"-\" + (force ? SIGKILL : SIGINT), \"-P\", Integer.toString(pp.getPid())};\n-        if (userDecorator != null) {\n-            cmd = userDecorator.decorate(cmd);\n+        logger.atDebug().log(\"Killing child processes of pid {}\", pp.getPid());\n+        Set<Integer> pids = getChildPids(process);\n+        if (additionalPids != null) {\n+            pids.addAll(additionalPids);\n         }\n-        Process proc = Runtime.getRuntime().exec(cmd);\n-        proc.waitFor();\n-        if (proc.exitValue() != 0) {\n-            logger.atWarn().kv(\"pid\", pp.getPid()).kv(\"exit-code\", proc.exitValue())\n-                    .kv(STDOUT, inputStreamToString(proc.getInputStream()))\n-                    .kv(STDERR, inputStreamToString(proc.getErrorStream()))\n-                    .log(\"pkill exited non-zero (process not found or other error)\");\n+        for (Integer pid : pids) {\n+            PidProcess proc = Processes.newPidProcess(pid);\n+            if (proc.isAlive()) {\n+                proc.destroy(force);", "originalCommit": "6feed201673c76c633fd05c4eb2d5f64078115b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODU0NDcyNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/630#discussion_r518544725", "bodyText": "Yeah I found that out unfortunately. Fixed it though by just calling out to kill with the user decorator as before.\nStill see some warnings for \"operation not permitted\", but the processes seem to die...", "author": "MikeDombo", "createdAt": "2020-11-06T06:19:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODU0MzA4NQ=="}], "type": "inlineReview", "revised_code": {"commit": "531c89fdabbc7eb60febd51aa266b298a67145d2", "chunk": "diff --git a/src/main/java/com/aws/greengrass/util/platforms/unix/UnixPlatform.java b/src/main/java/com/aws/greengrass/util/platforms/unix/UnixPlatform.java\nindex 143f933f..caf87895 100644\n--- a/src/main/java/com/aws/greengrass/util/platforms/unix/UnixPlatform.java\n+++ b/src/main/java/com/aws/greengrass/util/platforms/unix/UnixPlatform.java\n\n@@ -253,7 +253,8 @@ public class UnixPlatform extends Platform {\n     }\n \n     @Override\n-    public Set<Integer> killProcessAndChildren(Process process, boolean force, Set<Integer> additionalPids)\n+    public Set<Integer> killProcessAndChildren(Process process, boolean force, Set<Integer> additionalPids,\n+                                               UserDecorator decorator)\n             throws IOException, InterruptedException {\n         PidProcess pp = Processes.newPidProcess(process);\n \n"}}, {"oid": "531c89fdabbc7eb60febd51aa266b298a67145d2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/531c89fdabbc7eb60febd51aa266b298a67145d2", "message": "Better process tree killing", "committedDate": "2020-11-06T06:14:55Z", "type": "forcePushed"}, {"oid": "f1a705705c0d819a519dcdd33c1da8e55824247b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f1a705705c0d819a519dcdd33c1da8e55824247b", "message": "Better process tree killing", "committedDate": "2020-11-06T06:21:30Z", "type": "forcePushed"}, {"oid": "42d36864971c41b1f3a13eaf385f0fae4effcc33", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/42d36864971c41b1f3a13eaf385f0fae4effcc33", "message": "Better process tree killing", "committedDate": "2020-11-06T07:17:42Z", "type": "forcePushed"}, {"oid": "2d374187c61a698c96e3aefac778ff3584b4c17f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2d374187c61a698c96e3aefac778ff3584b4c17f", "message": "Better process tree killing", "committedDate": "2020-11-06T07:47:11Z", "type": "commit"}, {"oid": "2d374187c61a698c96e3aefac778ff3584b4c17f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2d374187c61a698c96e3aefac778ff3584b4c17f", "message": "Better process tree killing", "committedDate": "2020-11-06T07:47:11Z", "type": "forcePushed"}, {"oid": "0fd0979a6fac90e863f09b6db3b48da999d01c5c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0fd0979a6fac90e863f09b6db3b48da999d01c5c", "message": "Merge branch 'master' into kill", "committedDate": "2020-11-06T08:02:09Z", "type": "commit"}, {"oid": "569c161a496782f51153fcbf90d88a6b3ee30650", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/569c161a496782f51153fcbf90d88a6b3ee30650", "message": "Always kill children no matter what parent does", "committedDate": "2020-11-06T08:26:01Z", "type": "commit"}, {"oid": "020100cb805d27e635194bf50cd96937e688ed0c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/020100cb805d27e635194bf50cd96937e688ed0c", "message": "Use symlink fix when path is 108", "committedDate": "2020-11-06T16:47:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg3OTA4OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/630#discussion_r518879088", "bodyText": "2 seconds seems pretty short. Ideally this should be configurable. I'm okay to use a hardcoded value here for now, but I would extend the wait time, such as 30 seconds. Also add a log if the waitFor return false.", "author": "fengwang666", "createdAt": "2020-11-06T16:54:53Z", "path": "src/main/java/com/aws/greengrass/util/Exec.java", "diffHunk": "@@ -491,19 +493,22 @@ public synchronized void close() throws IOException {\n \n         Platform platformInstance = Platform.getInstance();\n \n+        Set<Integer> pids = Collections.emptySet();\n         try {\n-            platformInstance.killProcessAndChildren(p, false, userDecorator);\n+            pids = platformInstance.killProcessAndChildren(p, false, pids, userDecorator);\n             // TODO: [P41214162] configurable timeout\n-            if (!p.waitFor(2, TimeUnit.SECONDS)) {\n-                platformInstance.killProcessAndChildren(p, true, userDecorator);\n-                if (!p.waitFor(5, TimeUnit.SECONDS) && !isClosed.get()) {\n-                    throw new IOException(\"Could not stop \" + this);\n-                }\n+            // Wait for it to die, but ignore the outcome and just forcefully kill it and all its\n+            // children anyway. This way, any misbehaving children or grandchildren will be killed\n+            // whether or not the parent behaved appropriately.\n+            p.waitFor(2, TimeUnit.SECONDS);", "originalCommit": "569c161a496782f51153fcbf90d88a6b3ee30650", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b19d13e98d403ad3384047380ee282f1a75cdd0c", "chunk": "diff --git a/src/main/java/com/aws/greengrass/util/Exec.java b/src/main/java/com/aws/greengrass/util/Exec.java\nindex 41bd0b23..9570dcce 100644\n--- a/src/main/java/com/aws/greengrass/util/Exec.java\n+++ b/src/main/java/com/aws/greengrass/util/Exec.java\n\n@@ -500,7 +500,11 @@ public final class Exec implements Closeable {\n             // Wait for it to die, but ignore the outcome and just forcefully kill it and all its\n             // children anyway. This way, any misbehaving children or grandchildren will be killed\n             // whether or not the parent behaved appropriately.\n-            p.waitFor(2, TimeUnit.SECONDS);\n+            boolean died = p.waitFor(20, TimeUnit.SECONDS);\n+            if (!died) {\n+                logger.atWarn().log(\"Command {} did not respond to interruption within 30 seconds. \"\n+                        + \"Going to kill it now\", this);\n+            }\n             platformInstance.killProcessAndChildren(p, true, pids, userDecorator);\n             if (!p.waitFor(5, TimeUnit.SECONDS) && !isClosed.get()) {\n                 throw new IOException(\"Could not stop \" + this);\n"}}, {"oid": "b19d13e98d403ad3384047380ee282f1a75cdd0c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b19d13e98d403ad3384047380ee282f1a75cdd0c", "message": "Address comment", "committedDate": "2020-11-06T17:30:17Z", "type": "forcePushed"}, {"oid": "149926f465d8166dff139a5cccf5faed364cd59d", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/149926f465d8166dff139a5cccf5faed364cd59d", "message": "Address comment", "committedDate": "2020-11-06T17:50:52Z", "type": "forcePushed"}, {"oid": "f5860a2b42f42c42d43457fb07bfb7cdf033526c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f5860a2b42f42c42d43457fb07bfb7cdf033526c", "message": "Address comment", "committedDate": "2020-11-06T17:53:02Z", "type": "commit"}, {"oid": "f5860a2b42f42c42d43457fb07bfb7cdf033526c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f5860a2b42f42c42d43457fb07bfb7cdf033526c", "message": "Address comment", "committedDate": "2020-11-06T17:53:02Z", "type": "forcePushed"}]}