{"pr_number": 704, "pr_title": "Unsubscribe on shutdown", "pr_createdAt": "2020-11-19T00:23:17Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/704", "timeline": [{"oid": "3324282579a0f3257c93aa981f2acd9233df87af", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3324282579a0f3257c93aa981f2acd9233df87af", "message": "Unsubscribing to Iot Jobs topics when DeploymentService shuts down", "committedDate": "2020-11-18T23:38:07Z", "type": "commit"}, {"oid": "ba2f0f41d2ede7148765e54041281ae785a34b73", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ba2f0f41d2ede7148765e54041281ae785a34b73", "message": "Reversing the order of subscriptions to Iot Jobs to avoid subscription timeout", "committedDate": "2020-11-19T00:14:11Z", "type": "commit"}, {"oid": "d5f210381bccbf9c46f0cb684b20a372fd8fd043", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d5f210381bccbf9c46f0cb684b20a372fd8fd043", "message": "Fixing tests", "committedDate": "2020-11-19T01:07:01Z", "type": "commit"}, {"oid": "d5f210381bccbf9c46f0cb684b20a372fd8fd043", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d5f210381bccbf9c46f0cb684b20a372fd8fd043", "message": "Fixing tests", "committedDate": "2020-11-19T01:07:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTAyMTIzNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/704#discussion_r529021235", "bodyText": "Use the constants in IotJobsClientWrapper? It's changed to gg namespace now", "author": "hui-yang", "createdAt": "2020-11-23T21:55:18Z", "path": "src/main/java/com/aws/greengrass/deployment/IotJobsHelper.java", "diffHunk": "@@ -521,6 +540,30 @@ protected void subscribeToGetNextJobDescription(Consumer<DescribeJobExecutionRes\n         }\n     }\n \n+    private void unsubscribeFromJobDescription() {\n+        if (connection != null) {\n+            String topic = \"$aws/things/{thingName}/jobs/{jobId}/get/accepted\";\n+            topic = topic.replace(THING_NAME_PLACEHOLDER, Coerce.toString(deviceConfiguration.getThingName()));\n+            topic = topic.replace(JOB_ID_PLACEHOLDER, NEXT_JOB_LITERAL);\n+            connection.unsubscribe(topic);\n+\n+            topic = \"$aws/things/{thingName}/jobs/{jobId}/get/rejected\";\n+            topic = topic.replace(THING_NAME_PLACEHOLDER, Coerce.toString(deviceConfiguration.getThingName()));\n+            topic = topic.replace(JOB_ID_PLACEHOLDER, NEXT_JOB_LITERAL);\n+            connection.unsubscribe(topic);\n+\n+            topic = \"$aws/things/{thingName}/jobs/{jobId}/namespace-cust-deployment/get/accepted\";", "originalCommit": "d5f210381bccbf9c46f0cb684b20a372fd8fd043", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU1MTk1OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/704#discussion_r535551959", "bodyText": "updated", "author": "fahadmohammed01", "createdAt": "2020-12-03T20:09:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTAyMTIzNQ=="}], "type": "inlineReview", "revised_code": {"commit": "914738fab307abf252896fe6926d7b0e689140f1", "chunk": "diff --git a/src/main/java/com/aws/greengrass/deployment/IotJobsHelper.java b/src/main/java/com/aws/greengrass/deployment/IotJobsHelper.java\nindex 73d3a900f..e5898b192 100644\n--- a/src/main/java/com/aws/greengrass/deployment/IotJobsHelper.java\n+++ b/src/main/java/com/aws/greengrass/deployment/IotJobsHelper.java\n\n@@ -542,24 +497,12 @@ public class IotJobsHelper implements InjectionActions {\n \n     private void unsubscribeFromJobDescription() {\n         if (connection != null) {\n-            String topic = \"$aws/things/{thingName}/jobs/{jobId}/get/accepted\";\n-            topic = topic.replace(THING_NAME_PLACEHOLDER, Coerce.toString(deviceConfiguration.getThingName()));\n-            topic = topic.replace(JOB_ID_PLACEHOLDER, NEXT_JOB_LITERAL);\n-            connection.unsubscribe(topic);\n-\n-            topic = \"$aws/things/{thingName}/jobs/{jobId}/get/rejected\";\n-            topic = topic.replace(THING_NAME_PLACEHOLDER, Coerce.toString(deviceConfiguration.getThingName()));\n-            topic = topic.replace(JOB_ID_PLACEHOLDER, NEXT_JOB_LITERAL);\n+            String topic = String.format(JOB_DESCRIBE_ACCEPTED_TOPIC,\n+                    Coerce.toString(deviceConfiguration.getThingName()), NEXT_JOB_LITERAL);\n             connection.unsubscribe(topic);\n \n-            topic = \"$aws/things/{thingName}/jobs/{jobId}/namespace-cust-deployment/get/accepted\";\n-            topic = topic.replace(THING_NAME_PLACEHOLDER, Coerce.toString(deviceConfiguration.getThingName()));\n-            topic = topic.replace(JOB_ID_PLACEHOLDER, NEXT_JOB_LITERAL);\n-            connection.unsubscribe(topic);\n-\n-            topic = \"$aws/things/{thingName}/jobs/{jobId}/namespace-cust-deployment/get/rejected\";\n-            topic = topic.replace(THING_NAME_PLACEHOLDER, Coerce.toString(deviceConfiguration.getThingName()));\n-            topic = topic.replace(JOB_ID_PLACEHOLDER, NEXT_JOB_LITERAL);\n+            topic = String.format(JOB_DESCRIBE_REJECTED_TOPIC,\n+                    Coerce.toString(deviceConfiguration.getThingName()), NEXT_JOB_LITERAL);\n             connection.unsubscribe(topic);\n         }\n     }\n"}}, {"oid": "4554d6d778fd76b374c7229bb3f3d0d2d2b05c9f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4554d6d778fd76b374c7229bb3f3d0d2d2b05c9f", "message": "Merge branch 'master' into unsubscribeOnShutdown", "committedDate": "2020-12-03T18:34:08Z", "type": "commit"}, {"oid": "914738fab307abf252896fe6926d7b0e689140f1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/914738fab307abf252896fe6926d7b0e689140f1", "message": "use custom namespace", "committedDate": "2020-12-03T20:01:18Z", "type": "commit"}, {"oid": "5c690b2ef2d5d1290dd23697f3cd6205a4adc983", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5c690b2ef2d5d1290dd23697f3cd6205a4adc983", "message": "Merge branch 'master' into unsubscribeOnShutdown", "committedDate": "2020-12-03T20:54:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTYwMTU0Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/704#discussion_r535601543", "bodyText": "not used?", "author": "hui-yang", "createdAt": "2020-12-03T20:55:10Z", "path": "src/main/java/com/aws/greengrass/deployment/IotJobsHelper.java", "diffHunk": "@@ -91,6 +94,9 @@\n     //This value needs to be revisited and set to more realistic numbers\n     private static final long TIMEOUT_FOR_IOT_JOBS_OPERATIONS_SECONDS = Duration.ofMinutes(1).getSeconds();\n     private static final String JOB_ID_LOG_KEY_NAME = \"JobId\";\n+    private static final String THING_NAME_PLACEHOLDER = \"{thingName}\";\n+    private static final String JOB_ID_PLACEHOLDER = \"{jobId}\";", "originalCommit": "5c690b2ef2d5d1290dd23697f3cd6205a4adc983", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTYyMDc4Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/704#discussion_r535620783", "bodyText": "yep, removed.", "author": "fahadmohammed01", "createdAt": "2020-12-03T21:08:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTYwMTU0Mw=="}], "type": "inlineReview", "revised_code": {"commit": "67b633a5ade6967f295fded35aeab3a06649e129", "chunk": "diff --git a/src/main/java/com/aws/greengrass/deployment/IotJobsHelper.java b/src/main/java/com/aws/greengrass/deployment/IotJobsHelper.java\nindex e5898b192..82de4371a 100644\n--- a/src/main/java/com/aws/greengrass/deployment/IotJobsHelper.java\n+++ b/src/main/java/com/aws/greengrass/deployment/IotJobsHelper.java\n\n@@ -94,8 +94,6 @@ public class IotJobsHelper implements InjectionActions {\n     //This value needs to be revisited and set to more realistic numbers\n     private static final long TIMEOUT_FOR_IOT_JOBS_OPERATIONS_SECONDS = Duration.ofMinutes(1).getSeconds();\n     private static final String JOB_ID_LOG_KEY_NAME = \"JobId\";\n-    private static final String THING_NAME_PLACEHOLDER = \"{thingName}\";\n-    private static final String JOB_ID_PLACEHOLDER = \"{jobId}\";\n     private static final String NEXT_JOB_LITERAL = \"$next\";\n     // Sometimes when we are notified that a new job is queued and request the next pending job document immediately,\n     // we get an empty response. This unprocessedJobs is to track the number of new queued jobs that we are notified\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTYwODM2Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/704#discussion_r535608367", "bodyText": "I'm not familiar with this. Will $next be replaced by any deployment ID?", "author": "hui-yang", "createdAt": "2020-12-03T20:59:31Z", "path": "src/main/java/com/aws/greengrass/deployment/IotJobsHelper.java", "diffHunk": "@@ -475,6 +495,18 @@ protected void subscribeToGetNextJobDescription(Consumer<DescribeJobExecutionRes\n         }\n     }\n \n+    private void unsubscribeFromJobDescription() {\n+        if (connection != null) {\n+            String topic = String.format(JOB_DESCRIBE_ACCEPTED_TOPIC,\n+                    Coerce.toString(deviceConfiguration.getThingName()), NEXT_JOB_LITERAL);", "originalCommit": "5c690b2ef2d5d1290dd23697f3cd6205a4adc983", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTYyMDc0MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/704#discussion_r535620741", "bodyText": "We subscribe to DescribeJobExecutionAccepted and DescribeJobExecutionRejected using $next as job Id to get the next job.", "author": "fahadmohammed01", "createdAt": "2020-12-03T21:08:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTYwODM2Nw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "67b633a5ade6967f295fded35aeab3a06649e129", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/67b633a5ade6967f295fded35aeab3a06649e129", "message": "addressed comments", "committedDate": "2020-12-03T21:10:04Z", "type": "commit"}, {"oid": "0dcc1cec42cac162ab566bbbb44c090f551fdfcb", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0dcc1cec42cac162ab566bbbb44c090f551fdfcb", "message": "Merge branch 'master' into unsubscribeOnShutdown", "committedDate": "2020-12-04T00:04:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc2NjY5NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/704#discussion_r535766694", "bodyText": "Shouldn't this comment be above line422? Also probably want to add a bit more context on why we need to subscribe to job description before event notification. The whole jobs call pattern is not very obvious. Is it documented somewhere?", "author": "fengwang666", "createdAt": "2020-12-04T01:23:34Z", "path": "src/main/java/com/aws/greengrass/deployment/IotJobsHelper.java", "diffHunk": "@@ -409,13 +415,25 @@ public void requestNextPendingJobDocument() {\n      * @throws ConnectionUnavailableException When connection to cloud is not available\n      */\n     public void subscribeToJobsTopics() {\n-        subscribeToEventNotifications(eventHandler);\n+\n         subscribeToGetNextJobDescription(describeJobExecutionResponseConsumer, rejectedError -> {\n             logger.error(\"Job subscription got rejected\", rejectedError);\n         });\n+        subscribeToEventNotifications(eventHandler);\n+        // To receive the description of jobs which were created before the subscription was created (before the device\n+        // came online)", "originalCommit": "0dcc1cec42cac162ab566bbbb44c090f551fdfcb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}