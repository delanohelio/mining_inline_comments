{"pr_number": 264, "pr_title": "[Bug fix]Get rid of validation error message when initializing DeviceConfiguration object, fix arg names between setup and kernel command line", "pr_createdAt": "2020-06-02T16:56:51Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/264", "timeline": [{"oid": "f7ac3cf6e4724f92347ee60871d47965025fa945", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f7ac3cf6e4724f92347ee60871d47965025fa945", "message": "[Bug fixes] Get rid of device config validation error while setting device config and fix arg names between setup script and kernel command line", "committedDate": "2020-06-02T16:58:34Z", "type": "forcePushed"}, {"oid": "02440e0edadd585dbff15a3777ee8cd0a597a544", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/02440e0edadd585dbff15a3777ee8cd0a597a544", "message": "[Bug fixes] Get rid of device config validation error while setting device config and fix arg names between setup script and kernel command line", "committedDate": "2020-06-02T16:59:54Z", "type": "forcePushed"}, {"oid": "e156945dadbaf1113b1f9306858eedfa13aa5b96", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e156945dadbaf1113b1f9306858eedfa13aa5b96", "message": "[Bug fixes] Get rid of device config validation error while setting device config and fix arg names between setup script and kernel command line", "committedDate": "2020-06-02T17:03:34Z", "type": "forcePushed"}, {"oid": "c849713069042c09804bb74cbd03fa7a61f16277", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c849713069042c09804bb74cbd03fa7a61f16277", "message": "[Bug fixes] Get rid of device config validation error while setting device config and fix arg names between setup script and kernel command line", "committedDate": "2020-06-02T17:11:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA0MDQyNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/264#discussion_r434040426", "bodyText": "call validate here?", "author": "fahadmohammed01", "createdAt": "2020-06-02T17:14:01Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeviceConfiguration.java", "diffHunk": "@@ -46,16 +46,53 @@\n     private final Validator regionValidator;\n \n     /**\n-     * Constructor.\n+     * Constructor used to read device cinfiguration from the config store.\n      *\n      * @param kernel Kernel to get config from\n      */\n     @Inject\n-    @SuppressWarnings(\"PMD.NullAssignment\")\n     public DeviceConfiguration(Kernel kernel) {\n         this.kernel = kernel;\n-        deTildeValidator = (newV, old) -> kernel.deTilde(Coerce.toString(newV));\n-        regionValidator = (newV, old) -> {\n+        deTildeValidator = getDeTildeValidator(kernel);\n+        regionValidator = getRegionValidator();\n+        validate();\n+    }\n+\n+    /**\n+     * Constructor to use when setting the device configuration to kernel config.\n+     *\n+     * @param kernel              kernel to set config for\n+     * @param thingName           IoT thing name\n+     * @param iotDataEndpoint     IoT data endpoint\n+     * @param iotCredEndpoint     IoT cert endpoint\n+     * @param privateKeyPath      private key location on device\n+     * @param certificateFilePath certificate location on device\n+     * @param rootCaFilePath      downloaded RootCA location on device\n+     * @param awsRegion           aws region for the device\n+     */\n+    public DeviceConfiguration(Kernel kernel, String thingName, String iotDataEndpoint, String iotCredEndpoint,\n+                               String privateKeyPath, String certificateFilePath, String rootCaFilePath,\n+                               String awsRegion) {\n+        this.kernel = kernel;\n+        deTildeValidator = getDeTildeValidator(kernel);\n+        regionValidator = getRegionValidator();\n+\n+        getThingName().withValue(thingName);\n+        getIotDataEndpoint().withValue(iotDataEndpoint);\n+        getCertificateFilePath().withValue(iotCredEndpoint);\n+        getPrivateKeyFilePath().withValue(privateKeyPath);\n+        getCertificateFilePath().withValue(certificateFilePath);\n+        getRootCAFilePath().withValue(rootCaFilePath);\n+        getAWSRegion().withValue(awsRegion);", "originalCommit": "c849713069042c09804bb74cbd03fa7a61f16277", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgyMTM4Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/264#discussion_r434821382", "bodyText": "It wasn't exactly necessary since the other place where you read it always validates, which would make sure even if config is updated adhoc it is valid when it's used, but I've made this change now", "author": "shaguptashaikh", "createdAt": "2020-06-03T20:02:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA0MDQyNg=="}], "type": "inlineReview", "revised_code": {"commit": "c14b91f735bb05c126978f6e1642f1d26aef3b3e", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/deployment/DeviceConfiguration.java b/src/main/java/com/aws/iot/evergreen/deployment/DeviceConfiguration.java\nindex 471e8f732..7be9b0891 100644\n--- a/src/main/java/com/aws/iot/evergreen/deployment/DeviceConfiguration.java\n+++ b/src/main/java/com/aws/iot/evergreen/deployment/DeviceConfiguration.java\n\n@@ -84,6 +84,8 @@ public class DeviceConfiguration {\n         getCertificateFilePath().withValue(certificateFilePath);\n         getRootCAFilePath().withValue(rootCaFilePath);\n         getAWSRegion().withValue(awsRegion);\n+\n+        validate();\n     }\n \n     private Validator getDeTildeValidator(Kernel kernel) {\n"}}, {"oid": "c14b91f735bb05c126978f6e1642f1d26aef3b3e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c14b91f735bb05c126978f6e1642f1d26aef3b3e", "message": "Validate device config while setting up in config store", "committedDate": "2020-06-03T19:50:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgxOTI0NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/264#discussion_r434819245", "bodyText": "this isn't needed.", "author": "MikeDombo", "createdAt": "2020-06-03T19:58:10Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java", "diffHunk": "@@ -74,6 +75,20 @@ void GIVEN_config_missing_main_WHEN_kernel_launches_THEN_throw_RuntimeException(\n         assertThrows(RuntimeException.class, () -> kernel.launch());\n     }\n \n+    @Test\n+    void GIVEN_config_path_not_given_WHEN_kernel_launches_THEN_load_empty_main_service() throws Exception {\n+        // launch kernel without config arg\n+        kernel = new Kernel();\n+        kernel.parseArgs().toString();\n+        kernel.launch();\n+\n+        // verify\n+        EvergreenService mainService = kernel.locate(\"main\");\n+        assertNotNull(mainService);\n+\n+        kernel.shutdown();", "originalCommit": "c14b91f735bb05c126978f6e1642f1d26aef3b3e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "17523a1ee6fa7a30653c9e360644d295e1757385", "chunk": "diff --git a/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java b/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java\nindex fffab7990..9b4adfcbb 100644\n--- a/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java\n+++ b/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java\n\n@@ -85,8 +85,6 @@ class KernelTest extends BaseITCase {\n         // verify\n         EvergreenService mainService = kernel.locate(\"main\");\n         assertNotNull(mainService);\n-\n-        kernel.shutdown();\n     }\n \n     @SuppressWarnings(\"PMD.AssignmentInOperand\")\n"}}, {"oid": "17523a1ee6fa7a30653c9e360644d295e1757385", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/17523a1ee6fa7a30653c9e360644d295e1757385", "message": "Validate device config while setting up in config store", "committedDate": "2020-06-03T23:51:51Z", "type": "forcePushed"}, {"oid": "813f9ce278be1d00df39701e1f0c0c50040be3b4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/813f9ce278be1d00df39701e1f0c0c50040be3b4", "message": "Fixes and enhancements to setup script", "committedDate": "2020-06-04T17:03:32Z", "type": "commit"}, {"oid": "813f9ce278be1d00df39701e1f0c0c50040be3b4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/813f9ce278be1d00df39701e1f0c0c50040be3b4", "message": "Fixes and enhancements to setup script", "committedDate": "2020-06-04T17:03:32Z", "type": "forcePushed"}]}