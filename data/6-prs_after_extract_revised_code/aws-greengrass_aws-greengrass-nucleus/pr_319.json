{"pr_number": 319, "pr_title": "Retry deleteThing when clean up test resources", "pr_createdAt": "2020-07-17T01:00:13Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/319", "timeline": [{"oid": "d50608f4e0696eadece98638dd1be1eaa9b8d2a4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d50608f4e0696eadece98638dd1be1eaa9b8d2a4", "message": "Retry deleteThing when clean up test resources", "committedDate": "2020-07-17T00:53:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ0OTczOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/319#discussion_r456449739", "bodyText": "The IotClient can be built using desired retry settings as the AWS SDK provides that out of the box, please switch to using that for the client being passed at line 185 https://github.com/aws/aws-greengrass-kernel/blob/master/src/main/java/com/aws/iot/evergreen/util/IotSdkClientFactory.java#L69- . BaseRetryableAccessor was meant to be used for non AWS SDK based clients that would need custom retry logic.", "author": "shaguptashaikh", "createdAt": "2020-07-17T13:41:36Z", "path": "src/main/java/com/aws/iot/evergreen/easysetup/DeviceProvisioningHelper.java", "diffHunk": "@@ -180,7 +186,12 @@ public void cleanThing(IotClient client, ThingInfo thing) {\n         client.detachThingPrincipal(\n                 DetachThingPrincipalRequest.builder().thingName(thing.thingName).principal(thing.certificateArn)\n                         .build());\n-        client.deleteThing(DeleteThingRequest.builder().thingName(thing.thingName).build());\n+        // Retry deleteThing when getting \"still attached to one or more principals\" InvalidRequestException\n+        // as the detachThingPrincipal call is async\n+        BaseRetryableAccessor accessor = new BaseRetryableAccessor();\n+        accessor.retry(RETRY_COUNT, BACKOFF_MILLIS,\n+                () -> client.deleteThing(DeleteThingRequest.builder().thingName(thing.thingName).build()),", "originalCommit": "d50608f4e0696eadece98638dd1be1eaa9b8d2a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjUyNjI3OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/319#discussion_r456526279", "bodyText": "Should I make all the iotclient in the e2e tests retry on InvalidRequestException? I intended to just wait for the detach call to be finished here, which might take several seconds in background.", "author": "youtuyy", "createdAt": "2020-07-17T15:48:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ0OTczOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjUzMjc3Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/319#discussion_r456532772", "bodyText": "That sounds okay", "author": "shaguptashaikh", "createdAt": "2020-07-17T16:00:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ0OTczOQ=="}], "type": "inlineReview", "revised_code": {"commit": "d26d4e6e08a021e666052859894ba5a619ee455c", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/easysetup/DeviceProvisioningHelper.java b/src/main/java/com/aws/iot/evergreen/easysetup/DeviceProvisioningHelper.java\nindex 438a19784..15799db68 100644\n--- a/src/main/java/com/aws/iot/evergreen/easysetup/DeviceProvisioningHelper.java\n+++ b/src/main/java/com/aws/iot/evergreen/easysetup/DeviceProvisioningHelper.java\n\n@@ -186,12 +180,7 @@ public class DeviceProvisioningHelper {\n         client.detachThingPrincipal(\n                 DetachThingPrincipalRequest.builder().thingName(thing.thingName).principal(thing.certificateArn)\n                         .build());\n-        // Retry deleteThing when getting \"still attached to one or more principals\" InvalidRequestException\n-        // as the detachThingPrincipal call is async\n-        BaseRetryableAccessor accessor = new BaseRetryableAccessor();\n-        accessor.retry(RETRY_COUNT, BACKOFF_MILLIS,\n-                () -> client.deleteThing(DeleteThingRequest.builder().thingName(thing.thingName).build()),\n-                new HashSet<>(Arrays.asList(InvalidRequestException.class)));\n+        client.deleteThing(DeleteThingRequest.builder().thingName(thing.thingName).build());\n         client.updateCertificate(UpdateCertificateRequest.builder().certificateId(thing.certificateId)\n                 .newStatus(CertificateStatus.INACTIVE).build());\n         for (Policy p : client\n"}}, {"oid": "d26d4e6e08a021e666052859894ba5a619ee455c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d26d4e6e08a021e666052859894ba5a619ee455c", "message": "Retry override on iotclient in e2e tests", "committedDate": "2020-07-17T16:51:27Z", "type": "commit"}, {"oid": "7817f670130fb0535d8e07e96359d38685f3faa2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7817f670130fb0535d8e07e96359d38685f3faa2", "message": "Merge branch 'master' into retry-delete-thing", "committedDate": "2020-07-17T19:36:41Z", "type": "commit"}, {"oid": "8cfb5a0c132c8e0c99e151047bc6e1397f31342f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8cfb5a0c132c8e0c99e151047bc6e1397f31342f", "message": "Merge branch 'master' into retry-delete-thing", "committedDate": "2020-07-20T23:25:01Z", "type": "commit"}, {"oid": "3bfb93835b27d1499651ef5e7297980e94379d3d", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3bfb93835b27d1499651ef5e7297980e94379d3d", "message": "Merge branch 'master' into retry-delete-thing", "committedDate": "2020-07-21T02:47:06Z", "type": "commit"}, {"oid": "920fafbdda9039cac98cac50e0091d7343a88de8", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/920fafbdda9039cac98cac50e0091d7343a88de8", "message": "Merge branch 'master' into retry-delete-thing", "committedDate": "2020-07-21T03:17:45Z", "type": "commit"}, {"oid": "03e8e4228b52bc37592841ebee4ad4b29d5aa5d3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/03e8e4228b52bc37592841ebee4ad4b29d5aa5d3", "message": "Merge branch 'master' into retry-delete-thing", "committedDate": "2020-07-21T05:16:03Z", "type": "commit"}]}