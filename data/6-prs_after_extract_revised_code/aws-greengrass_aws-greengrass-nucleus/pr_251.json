{"pr_number": 251, "pr_title": "Support Fleet Configuration in deployments", "pr_createdAt": "2020-05-21T17:24:56Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/251", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgwMTcyNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/251#discussion_r428801727", "bodyText": "why is the group gone? We do need to know the group for when we handle multi-group deployments", "author": "MikeDombo", "createdAt": "2020-05-21T17:28:21Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/model/DeploymentDocument.java", "diffHunk": "@@ -38,14 +40,33 @@\n     @JsonProperty(\"Packages\")\n     private List<DeploymentPackageConfiguration> deploymentPackageConfigurationList;\n \n-    @JsonProperty(\"GroupName\")\n-    private String groupName;", "originalCommit": "df4de171c8b88ef8934f982ad540c89d2c58847d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg0NjkyOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/251#discussion_r428846928", "bodyText": "Right. I'll add it back. It's not used for now, but should be parsed from the configurationArn.", "author": "hui-yang", "createdAt": "2020-05-21T18:51:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgwMTcyNw=="}], "type": "inlineReview", "revised_code": {"commit": "bd91c99d65dd4c8222013026fd1064c304c0ba9b", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/deployment/model/DeploymentDocument.java b/src/main/java/com/aws/iot/evergreen/deployment/model/DeploymentDocument.java\nindex 96b37922..4e513a33 100644\n--- a/src/main/java/com/aws/iot/evergreen/deployment/model/DeploymentDocument.java\n+++ b/src/main/java/com/aws/iot/evergreen/deployment/model/DeploymentDocument.java\n\n@@ -40,6 +41,9 @@ public class DeploymentDocument {\n     @JsonProperty(\"Packages\")\n     private List<DeploymentPackageConfiguration> deploymentPackageConfigurationList;\n \n+    @JsonProperty(\"GroupName\")\n+    private String groupName;\n+\n     @Setter\n     @JsonProperty(\"Timestamp\")\n     private Long timestamp;\n"}}, {"oid": "bd91c99d65dd4c8222013026fd1064c304c0ba9b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/bd91c99d65dd4c8222013026fd1064c304c0ba9b", "message": "Support Fleet Configuration in deployments", "committedDate": "2020-05-21T21:51:57Z", "type": "commit"}, {"oid": "bd91c99d65dd4c8222013026fd1064c304c0ba9b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/bd91c99d65dd4c8222013026fd1064c304c0ba9b", "message": "Support Fleet Configuration in deployments", "committedDate": "2020-05-21T21:51:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk0MDAzMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/251#discussion_r428940033", "bodyText": "will this todo be done for this PR?", "author": "MikeDombo", "createdAt": "2020-05-21T22:01:10Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/DeploymentCloudServiceIntegTest.java", "diffHunk": "@@ -112,6 +112,7 @@ void cleanUp() {\n         createdIotJobIdList.clear();\n     }\n \n+    // TODO: Integrate with Fleet Configuration Service", "originalCommit": "bd91c99d65dd4c8222013026fd1064c304c0ba9b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk0MjA3OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/251#discussion_r428942079", "bodyText": "Separately. I can integrate now with http request. Will try to get SDK for the actual integration.", "author": "hui-yang", "createdAt": "2020-05-21T22:06:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk0MDAzMw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk0MDQ1NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/251#discussion_r428940454", "bodyText": "I'd probably put \"mock\" somewhere in the name since, even though it is in the E2E folder (which uses real accounts), this arn isn't real.", "author": "MikeDombo", "createdAt": "2020-05-21T22:02:19Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/util/Utils.java", "diffHunk": "@@ -324,6 +325,11 @@ public static void updateKernelConfigWithIotConfiguration(Kernel kernel, Utils.T\n         deploymentServiceTopics.createLeafChild(DEVICE_PARAM_IOT_CRED_ENDPOINT).withValue(thing.credEndpoint);\n     }\n \n+    public static String generateTestConfigurationArn() {", "originalCommit": "bd91c99d65dd4c8222013026fd1064c304c0ba9b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk0MzEyMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/251#discussion_r428943121", "bodyText": "Agree", "author": "hui-yang", "createdAt": "2020-05-21T22:09:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk0MDQ1NA=="}], "type": "inlineReview", "revised_code": {"commit": "ba14d814c18883ae64cee88dea26533c5b6fc083", "chunk": "diff --git a/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/util/Utils.java b/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/util/Utils.java\nindex 244093d5..121861f4 100644\n--- a/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/util/Utils.java\n+++ b/src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/util/Utils.java\n\n@@ -325,7 +325,7 @@ public class Utils {\n         deploymentServiceTopics.createLeafChild(DEVICE_PARAM_IOT_CRED_ENDPOINT).withValue(thing.credEndpoint);\n     }\n \n-    public static String generateTestConfigurationArn() {\n+    public static String generateMockConfigurationArn() {\n         return Arn.builder().withPartition(\"aws\").withAccountId(\"1234567890\").withRegion(\"test-region\").withService(\n                 \"gg\").withResource(\"configuration:test/mock:1\").build().toString();\n     }\n"}}, {"oid": "ba14d814c18883ae64cee88dea26533c5b6fc083", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ba14d814c18883ae64cee88dea26533c5b6fc083", "message": "Address comments", "committedDate": "2020-05-21T23:12:34Z", "type": "commit"}, {"oid": "ba14d814c18883ae64cee88dea26533c5b6fc083", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ba14d814c18883ae64cee88dea26533c5b6fc083", "message": "Address comments", "committedDate": "2020-05-21T23:12:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk3NzI1Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/251#discussion_r428977257", "bodyText": "Will this be the time when config was drafted or when the job was triggered? Is this in alignment with the experience we needed around timestamps?", "author": "shaguptashaikh", "createdAt": "2020-05-22T00:04:57Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/model/DeploymentDocument.java", "diffHunk": "@@ -48,4 +51,36 @@\n     @JsonProperty(\"FailureHandlingPolicy\")\n     private FailureHandlingPolicy failureHandlingPolicy;\n \n+    /**\n+     * Constructor to wrap around deployment configurations from Fleet Configuration Service.\n+     *\n+     * @param config Fleet Configuration\n+     */\n+    public DeploymentDocument(FleetConfiguration config) {\n+        deploymentId = config.getConfigurationArn();\n+        timestamp = config.getCreationTimestamp();", "originalCommit": "ba14d814c18883ae64cee88dea26533c5b6fc083", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk3ODM3OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/251#discussion_r428978378", "bodyText": "This is when config was drafted. I thought about this actually. It seems ok to me because in FCS, customers cannot publish an older draft (as in deployment). I cannot imagine a case (at least not in prod, maybe possible in dev), where customer creates a draft, make some config changes in kernel in whichever way, and then publish the draft for deployment.", "author": "hui-yang", "createdAt": "2020-05-22T00:09:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk3NzI1Nw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk3NzcxMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/251#discussion_r428977711", "bodyText": "I used deploymentId to create snapshot files for rollbacks, it might be a bit odd to have an arn in the file name, but technically it doesn't sound like an issue so I'm okay with this for this PR", "author": "shaguptashaikh", "createdAt": "2020-05-22T00:06:42Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/model/DeploymentDocument.java", "diffHunk": "@@ -48,4 +51,36 @@\n     @JsonProperty(\"FailureHandlingPolicy\")\n     private FailureHandlingPolicy failureHandlingPolicy;\n \n+    /**\n+     * Constructor to wrap around deployment configurations from Fleet Configuration Service.\n+     *\n+     * @param config Fleet Configuration\n+     */\n+    public DeploymentDocument(FleetConfiguration config) {\n+        deploymentId = config.getConfigurationArn();", "originalCommit": "ba14d814c18883ae64cee88dea26533c5b6fc083", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk3ODYxMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/251#discussion_r428978612", "bodyText": "Arns have characters that we shouldn't have in a file name. This needs to be fixed.", "author": "MikeDombo", "createdAt": "2020-05-22T00:10:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk3NzcxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk3ODk2Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/251#discussion_r428978967", "bodyText": "Yes. I talked to Fengyi a few times. He doesn't want to pass a deploymentId to device unless we have a good reason, though a deploymentId is generated in the cloud for tracing logs anyway. But this can always be changed IMO.", "author": "hui-yang", "createdAt": "2020-05-22T00:11:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk3NzcxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk3OTgyNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/251#discussion_r428979824", "bodyText": "How will logs be traced if the deployment id is not present in device logs that were streamed to CW? using the arn? is sending one UUID in the doc that big a deal?", "author": "shaguptashaikh", "createdAt": "2020-05-22T00:14:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk3NzcxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk4MDA1Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/251#discussion_r428980057", "bodyText": "Also I wonder how the rollback test passed if the filename is really problematic", "author": "shaguptashaikh", "createdAt": "2020-05-22T00:15:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk3NzcxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk4MjI2Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/251#discussion_r428982262", "bodyText": "I'll try follow up again. deploymentId is currently intended to looking up service logs.\nGood point on the test... I'll check what happens during the test.", "author": "hui-yang", "createdAt": "2020-05-22T00:24:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk3NzcxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk4Mzg0MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/251#discussion_r428983841", "bodyText": "The path appears to work. {path=/tmp/junit6723446930195798793/config/rollback_snapshot_arn:aws:gg:test-region:1234567890:configuration:test/mock:1.tlog} But I will still update it.", "author": "hui-yang", "createdAt": "2020-05-22T00:30:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk3NzcxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk4NDI2Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/251#discussion_r428984267", "bodyText": "I'm pretty sure that : isn't allowed on windows, so definitely should change that.", "author": "MikeDombo", "createdAt": "2020-05-22T00:32:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk3NzcxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk4OTU3Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/251#discussion_r428989573", "bodyText": "Currently deploymentId is not stored in service DDB and cannot be used in FCS requests. Probably not a good indication of what the snapshot contains.", "author": "hui-yang", "createdAt": "2020-05-22T00:53:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk3NzcxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTAwMDg4Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/251#discussion_r429000882", "bodyText": "Updated file path to {path=/tmp/junit5839896333357434982/config/rollback_snapshot_arn.aws.gg.test-region.1234567890.configuration.fail+rollback.2.tlog}", "author": "hui-yang", "createdAt": "2020-05-22T01:42:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk3NzcxMQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk3ODIzNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/251#discussion_r428978237", "bodyText": "Do we plan to keep this wrapper or is it temporary to avoid refactoring? Why not replace the contents of DeploymentDocument with that of FleetConfiguration?", "author": "shaguptashaikh", "createdAt": "2020-05-22T00:08:36Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/model/DeploymentDocument.java", "diffHunk": "@@ -48,4 +51,36 @@\n     @JsonProperty(\"FailureHandlingPolicy\")\n     private FailureHandlingPolicy failureHandlingPolicy;\n \n+    /**\n+     * Constructor to wrap around deployment configurations from Fleet Configuration Service.\n+     *\n+     * @param config Fleet Configuration\n+     */\n+    public DeploymentDocument(FleetConfiguration config) {", "originalCommit": "ba14d814c18883ae64cee88dea26533c5b6fc083", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk4MDEzNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/251#discussion_r428980134", "bodyText": "Initial intention was to avoid conflicts with local deployment. @leaf94 then brought up the idea to keep DeploymentDocument as our internal interface, not bundled with cloud contracts. I think it's worth a discussion after the demo and maybe we can refactor then.", "author": "hui-yang", "createdAt": "2020-05-22T00:15:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk3ODIzNw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "10dfa78778d055d6df81d65dd681665ebe4cdfb6", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/10dfa78778d055d6df81d65dd681665ebe4cdfb6", "message": "Fix config snapshot file path", "committedDate": "2020-05-22T01:40:32Z", "type": "commit"}]}