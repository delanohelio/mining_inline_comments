{"pr_number": 554, "pr_title": "Use separate logger file for GenericExternalService stdout/stderr", "pr_createdAt": "2020-10-21T20:20:49Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/554", "timeline": [{"oid": "9e5def8e92a53da0a8fea7afa399769b65b106cb", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9e5def8e92a53da0a8fea7afa399769b65b106cb", "message": "Use separate logger file for GenericExternalService stdout/stderr", "committedDate": "2020-10-21T20:23:24Z", "type": "forcePushed"}, {"oid": "3127318a44ab91e141f3818b8860dd8bc22d65b2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3127318a44ab91e141f3818b8860dd8bc22d65b2", "message": "Use separate logger file for GenericExternalService stdout/stderr", "committedDate": "2020-10-21T20:33:56Z", "type": "forcePushed"}, {"oid": "21c2cb236d4936f2431ac75274c0e6218e20ec38", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/21c2cb236d4936f2431ac75274c0e6218e20ec38", "message": "Use separate logger file for GenericExternalService stdout/stderr", "committedDate": "2020-10-21T20:40:28Z", "type": "forcePushed"}, {"oid": "3246971b588d479e6cafcd3949fea827e45a6d0a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3246971b588d479e6cafcd3949fea827e45a6d0a", "message": "Use separate logger file for GenericExternalService's stdout/stderr", "committedDate": "2020-10-21T20:55:30Z", "type": "forcePushed"}, {"oid": "d675c1e13c99cbf3f0d5374caab5a4b3660bbc17", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d675c1e13c99cbf3f0d5374caab5a4b3660bbc17", "message": "Use separate logger file for GenericExternalService's stdout/stderr", "committedDate": "2020-10-21T20:57:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcwODg3OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/554#discussion_r509708878", "bodyText": "I thought we decide the generic external service log will go to greengrass.log. Did you change your mind?", "author": "fengwang666", "createdAt": "2020-10-21T21:21:29Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/GenericExternalService.java", "diffHunk": "@@ -261,7 +268,7 @@ private synchronized void handleRunScript() throws InterruptedException {\n             // Synchronize within the callback so that these reportStates don't interfere with\n             // the reportStates outside of the callback\n             synchronized (this) {\n-                logger.atInfo().kv(\"exitCode\", exit).log(\"Run script exited\");\n+                separateLogger.atInfo().kv(\"exitCode\", exit).log(\"Run script exited\");", "originalCommit": "d675c1e13c99cbf3f0d5374caab5a4b3660bbc17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcxNzY1MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/554#discussion_r509717651", "bodyText": "I think that's a matter of classification. I looked through all 25 logs and made a choice. I moved everything that was external, like exit code and stdout/stderr.\nHappy to change if you don't agree.", "author": "MikeDombo", "createdAt": "2020-10-21T21:32:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcwODg3OA=="}], "type": "inlineReview", "revised_code": {"commit": "7c7115c0cfe6242895a1798ff5e70c53ceab452b", "chunk": "diff --git a/src/main/java/com/aws/greengrass/lifecyclemanager/GenericExternalService.java b/src/main/java/com/aws/greengrass/lifecyclemanager/GenericExternalService.java\nindex afb9898972..ba37aee3d7 100644\n--- a/src/main/java/com/aws/greengrass/lifecyclemanager/GenericExternalService.java\n+++ b/src/main/java/com/aws/greengrass/lifecyclemanager/GenericExternalService.java\n\n@@ -268,7 +270,8 @@ public class GenericExternalService extends GreengrassService {\n             // Synchronize within the callback so that these reportStates don't interfere with\n             // the reportStates outside of the callback\n             synchronized (this) {\n-                separateLogger.atInfo().kv(\"exitCode\", exit).log(\"Run script exited\");\n+                logger.atInfo().kv(EXIT_CODE, exit).log(\"Run script exited\");\n+                separateLogger.atInfo().kv(EXIT_CODE, exit).log(\"Run script exited\");\n                 if (startingStateGeneration == getStateGeneration() && currentOrReportedStateIs(State.RUNNING)) {\n                     if (exit == 0) {\n                         logger.atInfo().setEventType(\"generic-service-stopping\").log(\"Service finished running\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcxMTAxMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/554#discussion_r509711012", "bodyText": "Why createChild? Why not just use the component logger?", "author": "fengwang666", "createdAt": "2020-10-21T21:24:16Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/GenericExternalService.java", "diffHunk": "@@ -71,6 +74,10 @@ public GenericExternalService(Topics c) {\n     protected GenericExternalService(Topics c, Topics privateSpace) {\n         super(c, privateSpace);\n \n+        this.separateLogger = LogManagerHelper.getComponentLogger(this).createChild();", "originalCommit": "d675c1e13c99cbf3f0d5374caab5a4b3660bbc17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcxNTcyMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/554#discussion_r509715723", "bodyText": "What would the name of the log file? Is it COMPONENT_NAME.log? What would happen if the name collides with the log file created by the customer's component code (e.g. if they use log4j in their code)? Would it be better name it COMPONENT_NAME.stdout?", "author": "fengwang666", "createdAt": "2020-10-21T21:29:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcxMTAxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcxNzk5NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/554#discussion_r509717995", "bodyText": "Customer's can't log into our log directory, they don't have permissions.", "author": "MikeDombo", "createdAt": "2020-10-21T21:32:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcxMTAxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcxODg0NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/554#discussion_r509718845", "bodyText": "createChild is needed so that setting the dfltKV values for one instance of a lambda doesn't also affect other instances of it. See the same code in GreengrassService, we do the exact same thing there as well.", "author": "MikeDombo", "createdAt": "2020-10-21T21:34:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcxMTAxMg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "7c7115c0cfe6242895a1798ff5e70c53ceab452b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7c7115c0cfe6242895a1798ff5e70c53ceab452b", "message": "Use separate logger file for GenericExternalService's stdout/stderr", "committedDate": "2020-10-21T21:54:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTczMzU2OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/554#discussion_r509733569", "bodyText": "Any reason to make this a final class? I was thinking of having the kernel logging topics subscribed here so that this class and only this class will be responsible for any logging config changes.", "author": "nikkhilmuthye", "createdAt": "2020-10-21T21:54:38Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/LogManagerHelper.java", "diffHunk": "@@ -5,30 +5,19 @@\n \n package com.aws.greengrass.lifecyclemanager;\n \n+import com.aws.greengrass.logging.api.Logger;\n import com.aws.greengrass.logging.impl.LogManager;\n import com.aws.greengrass.logging.impl.config.model.LoggerConfiguration;\n \n /**\n  * Helper function to get a logger with configurations separate from the root logger.\n  */\n-public class LogManagerHelper {\n+public final class LogManagerHelper {\n     static final String KERNEL_CONFIG_LOGGING_TOPICS = \"logging\";\n     static final String SERVICE_CONFIG_LOGGING_TOPICS = \"ComponentLogging\";\n     private static final String LOG_FILE_EXTENSION = \".log\";\n-    //private final Kernel kernel;\n \n-    /**\n-     * Constructor for LogManagerHelper.\n-     * @param kernel {@link Kernel}\n-     */\n-    @SuppressWarnings(\"PMD.UnusedFormalParameter\")\n-    public LogManagerHelper(Kernel kernel) {\n-        //this.kernel = kernel;\n-        // TODO: uncomment this after KERNEL_COMPONENT_NAME is available to use.\n-        //this.kernel.getConfig().lookup(SERVICES_NAMESPACE_TOPIC, KERNEL_COMPONENT_NAME, KERNEL_CONFIG_LOGGING_TOPICS)\n-        //        .subscribe((why, newv) -> {\n-        //            // TODO: Reconfigure all loggers using logging configuration in the kernel config.\n-        //        });\n+    private LogManagerHelper() {", "originalCommit": "d675c1e13c99cbf3f0d5374caab5a4b3660bbc17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTczNTA5MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/554#discussion_r509735091", "bodyText": "You can still do that with a static method. Just LogManagerHelper.handleNucleusLogs(kernel) do that call when we startup, something like that. That method can subscribe as needed", "author": "MikeDombo", "createdAt": "2020-10-21T21:56:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTczMzU2OQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "2da84ebc0ebad06908ffe303f824edd71af9cf90", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2da84ebc0ebad06908ffe303f824edd71af9cf90", "message": "Use separate logger file for GenericExternalService's stdout/stderr", "committedDate": "2020-10-22T03:54:19Z", "type": "forcePushed"}, {"oid": "086d7b19d2fef032c45ae50896d4eed63aabe537", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/086d7b19d2fef032c45ae50896d4eed63aabe537", "message": "Use separate logger file for GenericExternalService's stdout/stderr", "committedDate": "2020-10-22T05:10:55Z", "type": "commit"}, {"oid": "086d7b19d2fef032c45ae50896d4eed63aabe537", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/086d7b19d2fef032c45ae50896d4eed63aabe537", "message": "Use separate logger file for GenericExternalService's stdout/stderr", "committedDate": "2020-10-22T05:10:55Z", "type": "forcePushed"}, {"oid": "9325726fffd590d00a4bca3d32592cad0cd8508a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9325726fffd590d00a4bca3d32592cad0cd8508a", "message": "Merge branch 'master' into sep-log", "committedDate": "2020-10-22T05:48:45Z", "type": "commit"}]}