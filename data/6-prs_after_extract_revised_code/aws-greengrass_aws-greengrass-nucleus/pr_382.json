{"pr_number": 382, "pr_title": "Implement recipe converter from common file contract.", "pr_createdAt": "2020-08-25T01:14:04Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/382", "timeline": [{"oid": "c223b00f169e69fb713d202a9076bdfdea5ff529", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c223b00f169e69fb713d202a9076bdfdea5ff529", "message": "implement recipe converter with updated artifact", "committedDate": "2020-08-25T01:06:06Z", "type": "commit"}, {"oid": "dd2268fe47b3f6162576ba0f77ae5ee76845c96e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/dd2268fe47b3f6162576ba0f77ae5ee76845c96e", "message": "Merge from master", "committedDate": "2020-08-25T01:16:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjAzOTU2NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/382#discussion_r476039564", "bodyText": "What's the intention here?", "author": "hui-yang", "createdAt": "2020-08-25T01:29:28Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/common/ComponentArtifact.java", "diffHunk": "@@ -0,0 +1,30 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.packagemanager.common;\n+\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+import com.fasterxml.jackson.databind.annotation.JsonPOJOBuilder;\n+import lombok.Builder;\n+import lombok.Value;\n+\n+import java.net.URI;\n+\n+@JsonDeserialize(builder = ComponentArtifact.ComponentArtifactBuilder.class)\n+@Value\n+@Builder\n+public class ComponentArtifact {\n+    URI uri;\n+\n+    String digest;\n+\n+    String algorithm;\n+\n+    String unarchive;\n+\n+    @JsonPOJOBuilder(withPrefix = \"\")", "originalCommit": "dd2268fe47b3f6162576ba0f77ae5ee76845c96e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjE3OTA5MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/382#discussion_r476179091", "bodyText": "This is the jackson annotation for using Builder\u2019s method to deserialize. Jackson uses the withPrefix to identify what builder methods to call when deserialize. If not set, the default prefix is \u201cwith\u201d, but we used lombok\u2019s @builder and didn\u2019t specify a prefix, that\u2019s why withPrefix=\"\" (Which I know looks almost like a hack or something. \ud83d\ude06 )", "author": "leaf94", "createdAt": "2020-08-25T05:03:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjAzOTU2NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjA0MDg2NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/382#discussion_r476040864", "bodyText": "Will we support nested param?", "author": "hui-yang", "createdAt": "2020-08-25T01:31:22Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/common/ComponentParameter.java", "diffHunk": "@@ -0,0 +1,26 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.packagemanager.common;\n+\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+import lombok.Builder;\n+import lombok.Value;\n+\n+@JsonDeserialize(builder = ComponentParameter.ComponentParameterBuilder.class)\n+@Value\n+@Builder\n+public class ComponentParameter {\n+\n+    String name;\n+\n+    String value;\n+\n+    ParameterType type;\n+\n+    public enum ParameterType {\n+        NUMBER, STRING, BOOLEAN", "originalCommit": "dd2268fe47b3f6162576ba0f77ae5ee76845c96e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjE3ODYwOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/382#discussion_r476178608", "bodyText": "Yes. Long story short, before M2, nested structure will be supported with JSON String so the type will be \"STRING\". Afterwards, we will revisit to probably remove this type from the recipe syntax perspective and switch to use a separate JSON/YAML schema file for validation (current favorable direction). But it can change depending on the actual design decision.", "author": "leaf94", "createdAt": "2020-08-25T05:01:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjA0MDg2NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjA0MjEzMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/382#discussion_r476042132", "bodyText": "I think there's one in util", "author": "hui-yang", "createdAt": "2020-08-25T01:33:27Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/common/SerializerFactory.java", "diffHunk": "@@ -0,0 +1,26 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.packagemanager.common;\n+\n+import com.fasterxml.jackson.annotation.JsonInclude;\n+import com.fasterxml.jackson.databind.MapperFeature;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.dataformat.yaml.YAMLFactory;\n+import lombok.AccessLevel;\n+import lombok.NoArgsConstructor;\n+\n+@NoArgsConstructor(access = AccessLevel.PRIVATE)\n+public final class SerializerFactory {", "originalCommit": "dd2268fe47b3f6162576ba0f77ae5ee76845c96e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjE3ODA2Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/382#discussion_r476178062", "bodyText": "Right. That one could be removed after we migrated.", "author": "leaf94", "createdAt": "2020-08-25T04:59:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjA0MjEzMg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjA0Mzk0OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/382#discussion_r476043948", "bodyText": "Do we keep these models along with common/* ?", "author": "hui-yang", "createdAt": "2020-08-25T01:36:21Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/models/ComponentArtifact.java", "diffHunk": "@@ -13,6 +14,7 @@\n @Getter\n @AllArgsConstructor\n @NoArgsConstructor\n+@Builder\n public class ComponentArtifact {", "originalCommit": "dd2268fe47b3f6162576ba0f77ae5ee76845c96e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjE3NzQwMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/382#discussion_r476177402", "bodyText": "Yes. Note the common/* is temporarily copied from Brazil pkg EvergreenComponentCommon. It will be removed after maven dependency is setup. For why we are not using it directly across our codebase, the main reason is that we don't want to tie our core models to the recipe file contract. The maintainability benefit wins over the cost of \"duplicating\" it.\nSee detailed comparison and the winner from the this doc", "author": "leaf94", "createdAt": "2020-08-25T04:57:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjA0Mzk0OA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjA0ODM1NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/382#discussion_r476048354", "bodyText": "Does platformSpecificManifest only have details of the resolved platform?", "author": "hui-yang", "createdAt": "2020-08-25T01:43:00Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/converter/RecipeConverter.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.packagemanager.converter;\n+\n+import com.aws.iot.evergreen.config.PlatformResolver;\n+import com.aws.iot.evergreen.packagemanager.common.ComponentParameter;\n+import com.aws.iot.evergreen.packagemanager.common.ComponentRecipe;\n+import com.aws.iot.evergreen.packagemanager.common.DependencyProperties;\n+import com.aws.iot.evergreen.packagemanager.common.PlatformSpecificManifest;\n+import com.aws.iot.evergreen.packagemanager.common.SerializerFactory;\n+import com.aws.iot.evergreen.packagemanager.exceptions.PackageLoadingException;\n+import com.aws.iot.evergreen.packagemanager.models.ComponentArtifact;\n+import com.aws.iot.evergreen.packagemanager.models.PackageParameter;\n+import com.aws.iot.evergreen.packagemanager.models.PackageRecipe;\n+import com.aws.iot.evergreen.packagemanager.models.RecipeDependencyProperties;\n+import com.aws.iot.evergreen.packagemanager.models.RecipeTemplateVersion;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import javax.inject.Inject;\n+\n+/**\n+ * This class handles conversion between recipe file contract and device business model. It also resolves platform\n+ * resolving logic while converting.\n+ */\n+public class RecipeConverter {\n+    // TODO add logging\n+    //    private static final Logger logger = LogManager.getLogger(RecipeConverter.class);\n+\n+    @Inject\n+    private PlatformResolver platformResolver;\n+\n+    /**\n+     * Converts.\n+     *\n+     * @param recipeFileContent recipe file content\n+     * @return Optional package recipe\n+     * @throws PackageLoadingException when failed to convert recipe file.\n+     */\n+    public Optional<PackageRecipe> convertFromFile(String recipeFileContent) throws PackageLoadingException {\n+\n+        ComponentRecipe componentRecipe;\n+        try {\n+            componentRecipe =\n+                    SerializerFactory.getRecipeSerializer().readValue(recipeFileContent, ComponentRecipe.class);\n+        } catch (JsonProcessingException e) {\n+            //TODO move this to common model\n+            throw new PackageLoadingException(\n+                    String.format(\"Failed to parse recipe file content to contract model. Recipe file content: '%s'.\",\n+                            recipeFileContent), e);\n+        }\n+\n+        Optional<PlatformSpecificManifest> optionalPlatformSpecificManifest =\n+                platformResolver.findBestMatch(componentRecipe.getManifests());\n+\n+        if (!optionalPlatformSpecificManifest.isPresent()) {\n+            return Optional.empty();\n+        }\n+\n+        PlatformSpecificManifest platformSpecificManifest = optionalPlatformSpecificManifest.get();\n+\n+        PackageRecipe packageRecipe = PackageRecipe.builder()\n+                                                   .componentName(componentRecipe.getComponentName())\n+                                                   .version(componentRecipe.getVersion())\n+                                                   .publisher(componentRecipe.getPublisher())\n+                                                   .recipeTemplateVersion(RecipeTemplateVersion.valueOf(\n+                                                           componentRecipe.getTemplateVersion().name()))\n+                                                   .componentType(componentRecipe.getComponentType())\n+                                                   .dependencies(convertDependencyFromFile(\n+                                                           platformSpecificManifest.getDependencies()))\n+                                                   .lifecycle(platformSpecificManifest.getLifecycle())", "originalCommit": "dd2268fe47b3f6162576ba0f77ae5ee76845c96e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjE3NTAyMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/382#discussion_r476175023", "bodyText": "The object type holds one platform's manifest, which may be multiple instances in a recipe file. But it resolved to the best match when loading to our PackageRecipe.", "author": "leaf94", "createdAt": "2020-08-25T04:54:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjA0ODM1NA=="}], "type": "inlineReview", "revised_code": {"commit": "d7844daeddef52f12d67e3bc84785df540a58445", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/packagemanager/converter/RecipeConverter.java b/src/main/java/com/aws/iot/evergreen/packagemanager/converter/RecipeConverter.java\nindex bc726e588..ff4641bf8 100644\n--- a/src/main/java/com/aws/iot/evergreen/packagemanager/converter/RecipeConverter.java\n+++ b/src/main/java/com/aws/iot/evergreen/packagemanager/converter/RecipeConverter.java\n\n@@ -3,11 +3,6 @@\n  * SPDX-License-Identifier: Apache-2.0\n  */\n \n-/*\n- * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n- * SPDX-License-Identifier: Apache-2.0\n- */\n-\n package com.aws.iot.evergreen.packagemanager.converter;\n \n import com.aws.iot.evergreen.config.PlatformResolver;\n"}}, {"oid": "7d310e02f4c80450b2e518878b204ec5e85fde98", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7d310e02f4c80450b2e518878b204ec5e85fde98", "message": "Merge branch 'master' into recipe_converter", "committedDate": "2020-08-25T04:52:11Z", "type": "commit"}, {"oid": "617f1078d50d79a7752cd6897e3d293cb0432ae9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/617f1078d50d79a7752cd6897e3d293cb0432ae9", "message": "Fix tests", "committedDate": "2020-08-25T04:52:29Z", "type": "commit"}, {"oid": "b6deaacad6d46410cedd0a93135f0dddf5e7e726", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b6deaacad6d46410cedd0a93135f0dddf5e7e726", "message": "fix merge", "committedDate": "2020-08-25T05:05:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjE2ODgxOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/382#discussion_r476168818", "bodyText": "Is this a placeholder that in the future the POJO field name might be different than json field name?", "author": "ShirleyZheng92", "createdAt": "2020-08-25T04:45:22Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/common/PlatformSpecificManifest.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.packagemanager.common;\n+\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+import com.fasterxml.jackson.databind.annotation.JsonPOJOBuilder;\n+import lombok.Builder;\n+import lombok.Value;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+\n+@JsonDeserialize(builder = PlatformSpecificManifest.PlatformSpecificManifestBuilder.class)\n+@Value\n+@Builder\n+public class PlatformSpecificManifest {\n+\n+    Platform platform;\n+\n+    @Builder.Default\n+    List<ComponentParameter> parameters = Collections.emptyList();\n+\n+    @Builder.Default\n+    Map<String, Object> lifecycle = Collections.emptyMap();\n+\n+    @Builder.Default\n+    List<ComponentArtifact> artifacts = Collections.emptyList();\n+\n+    @Builder.Default\n+    Map<String, DependencyProperties> dependencies = Collections.emptyMap();\n+\n+    @JsonPOJOBuilder(withPrefix = \"\")\n+    public static class PlatformSpecificManifestBuilder {", "originalCommit": "dd2268fe47b3f6162576ba0f77ae5ee76845c96e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjE4ODc5Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/382#discussion_r476188792", "bodyText": "I'd need @wikimonkey 's help as he implemented in the Brazil side.", "author": "leaf94", "createdAt": "2020-08-25T05:36:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjE2ODgxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjE5MzgwNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/382#discussion_r476193807", "bodyText": "I guess eventually we'll need to seek for tools to auto generate these pojo (like swagger ) in the common model. This LGTM for now", "author": "ShirleyZheng92", "createdAt": "2020-08-25T05:52:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjE2ODgxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjIwNTE5NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/382#discussion_r476205194", "bodyText": "Manually declaring builder class PlatformSpecificManifestBuilder is purely for annotation purpose so Jackson can use generated builder to deserialize. @JsonPOJOBuilder recognized default prefix is with.", "author": "wikimonkey", "createdAt": "2020-08-25T06:25:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjE2ODgxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU1MzUxNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/382#discussion_r476553514", "bodyText": "@ShirleyZheng92 Correct! That's where we want to get to!", "author": "leaf94", "createdAt": "2020-08-25T15:50:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjE2ODgxOA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjE2OTA3NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/382#discussion_r476169074", "bodyText": "NIT: double copyright", "author": "ShirleyZheng92", "createdAt": "2020-08-25T04:45:41Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/converter/RecipeConverter.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */", "originalCommit": "dd2268fe47b3f6162576ba0f77ae5ee76845c96e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjE4ODExMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/382#discussion_r476188110", "bodyText": "Thanks!", "author": "leaf94", "createdAt": "2020-08-25T05:34:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjE2OTA3NA=="}], "type": "inlineReview", "revised_code": {"commit": "d7844daeddef52f12d67e3bc84785df540a58445", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/packagemanager/converter/RecipeConverter.java b/src/main/java/com/aws/iot/evergreen/packagemanager/converter/RecipeConverter.java\nindex bc726e588..ff4641bf8 100644\n--- a/src/main/java/com/aws/iot/evergreen/packagemanager/converter/RecipeConverter.java\n+++ b/src/main/java/com/aws/iot/evergreen/packagemanager/converter/RecipeConverter.java\n\n@@ -3,11 +3,6 @@\n  * SPDX-License-Identifier: Apache-2.0\n  */\n \n-/*\n- * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n- * SPDX-License-Identifier: Apache-2.0\n- */\n-\n package com.aws.iot.evergreen.packagemanager.converter;\n \n import com.aws.iot.evergreen.config.PlatformResolver;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjE3OTYzNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/382#discussion_r476179634", "bodyText": "why the name is FromFile?", "author": "ShirleyZheng92", "createdAt": "2020-08-25T05:05:03Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/converter/RecipeConverter.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.packagemanager.converter;\n+\n+import com.aws.iot.evergreen.config.PlatformResolver;\n+import com.aws.iot.evergreen.packagemanager.common.ComponentParameter;\n+import com.aws.iot.evergreen.packagemanager.common.ComponentRecipe;\n+import com.aws.iot.evergreen.packagemanager.common.DependencyProperties;\n+import com.aws.iot.evergreen.packagemanager.common.PlatformSpecificManifest;\n+import com.aws.iot.evergreen.packagemanager.common.SerializerFactory;\n+import com.aws.iot.evergreen.packagemanager.exceptions.PackageLoadingException;\n+import com.aws.iot.evergreen.packagemanager.models.ComponentArtifact;\n+import com.aws.iot.evergreen.packagemanager.models.PackageParameter;\n+import com.aws.iot.evergreen.packagemanager.models.PackageRecipe;\n+import com.aws.iot.evergreen.packagemanager.models.RecipeDependencyProperties;\n+import com.aws.iot.evergreen.packagemanager.models.RecipeTemplateVersion;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import javax.inject.Inject;\n+\n+/**\n+ * This class handles conversion between recipe file contract and device business model. It also resolves platform\n+ * resolving logic while converting.\n+ */\n+public class RecipeConverter {\n+    // TODO add logging\n+    //    private static final Logger logger = LogManager.getLogger(RecipeConverter.class);\n+\n+    @Inject\n+    private PlatformResolver platformResolver;\n+\n+    /**\n+     * Converts.\n+     *\n+     * @param recipeFileContent recipe file content\n+     * @return Optional package recipe\n+     * @throws PackageLoadingException when failed to convert recipe file.\n+     */\n+    public Optional<PackageRecipe> convertFromFile(String recipeFileContent) throws PackageLoadingException {\n+\n+        ComponentRecipe componentRecipe;\n+        try {\n+            componentRecipe =\n+                    SerializerFactory.getRecipeSerializer().readValue(recipeFileContent, ComponentRecipe.class);\n+        } catch (JsonProcessingException e) {\n+            //TODO move this to common model\n+            throw new PackageLoadingException(\n+                    String.format(\"Failed to parse recipe file content to contract model. Recipe file content: '%s'.\",\n+                            recipeFileContent), e);\n+        }\n+\n+        Optional<PlatformSpecificManifest> optionalPlatformSpecificManifest =\n+                platformResolver.findBestMatch(componentRecipe.getManifests());\n+\n+        if (!optionalPlatformSpecificManifest.isPresent()) {\n+            return Optional.empty();\n+        }\n+\n+        PlatformSpecificManifest platformSpecificManifest = optionalPlatformSpecificManifest.get();\n+\n+        PackageRecipe packageRecipe = PackageRecipe.builder()\n+                                                   .componentName(componentRecipe.getComponentName())\n+                                                   .version(componentRecipe.getVersion())\n+                                                   .publisher(componentRecipe.getPublisher())\n+                                                   .recipeTemplateVersion(RecipeTemplateVersion.valueOf(\n+                                                           componentRecipe.getTemplateVersion().name()))\n+                                                   .componentType(componentRecipe.getComponentType())\n+                                                   .dependencies(convertDependencyFromFile(\n+                                                           platformSpecificManifest.getDependencies()))\n+                                                   .lifecycle(platformSpecificManifest.getLifecycle())\n+                                                   .artifacts(convertArtifactsFromFile(\n+                                                           platformSpecificManifest.getArtifacts()))\n+\n+                                                   .packageParameters(convertParametersFromFile(\n+                                                           platformSpecificManifest.getParameters()))\n+                                                   .build();\n+\n+        return Optional.of(packageRecipe);\n+    }\n+\n+    private Set<PackageParameter> convertParametersFromFile(List<ComponentParameter> parameters) {\n+        if (parameters == null || parameters.isEmpty()) {\n+            return Collections.emptySet();\n+        }\n+        return parameters.stream().map(this::convertParameterFromFile).collect(Collectors.toSet());\n+    }\n+\n+    private PackageParameter convertParameterFromFile(ComponentParameter parameter) {", "originalCommit": "617f1078d50d79a7752cd6897e3d293cb0432ae9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjE4ODA4NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/382#discussion_r476188085", "bodyText": "Because it's from the file contract of recipe. I hesitated when naming it... Looking for a better name. Didn't like convertXyzFromRecipe or convertXyzFromCommonModel...", "author": "leaf94", "createdAt": "2020-08-25T05:34:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjE3OTYzNA=="}], "type": "inlineReview", "revised_code": {"commit": "d7844daeddef52f12d67e3bc84785df540a58445", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/packagemanager/converter/RecipeConverter.java b/src/main/java/com/aws/iot/evergreen/packagemanager/converter/RecipeConverter.java\nindex bc726e588..ff4641bf8 100644\n--- a/src/main/java/com/aws/iot/evergreen/packagemanager/converter/RecipeConverter.java\n+++ b/src/main/java/com/aws/iot/evergreen/packagemanager/converter/RecipeConverter.java\n\n@@ -3,11 +3,6 @@\n  * SPDX-License-Identifier: Apache-2.0\n  */\n \n-/*\n- * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n- * SPDX-License-Identifier: Apache-2.0\n- */\n-\n package com.aws.iot.evergreen.packagemanager.converter;\n \n import com.aws.iot.evergreen.config.PlatformResolver;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjE4MDA5Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/382#discussion_r476180097", "bodyText": "Curious, why not use the existing PackageParameter and ComponentArtifact class?", "author": "ShirleyZheng92", "createdAt": "2020-08-25T05:06:45Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/common/PlatformSpecificManifest.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.packagemanager.common;\n+\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+import com.fasterxml.jackson.databind.annotation.JsonPOJOBuilder;\n+import lombok.Builder;\n+import lombok.Value;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+\n+@JsonDeserialize(builder = PlatformSpecificManifest.PlatformSpecificManifestBuilder.class)\n+@Value\n+@Builder\n+public class PlatformSpecificManifest {\n+\n+    Platform platform;\n+\n+    @Builder.Default\n+    List<ComponentParameter> parameters = Collections.emptyList();", "originalCommit": "617f1078d50d79a7752cd6897e3d293cb0432ae9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjE4ODM4Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/382#discussion_r476188383", "bodyText": "See: #382 (comment).\nThey are very similar now, but they could change at different time for different reasons.", "author": "leaf94", "createdAt": "2020-08-25T05:35:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjE4MDA5Nw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "43f9d097bd776596f1419182e4ab0da311ddd239", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/43f9d097bd776596f1419182e4ab0da311ddd239", "message": "Fix deprecated tests", "committedDate": "2020-08-25T05:30:01Z", "type": "commit"}, {"oid": "c91081d457c03f00c15a9cf31a6da3610938142b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c91081d457c03f00c15a9cf31a6da3610938142b", "message": "Fix tests", "committedDate": "2020-08-25T05:41:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjE5NTA2MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/382#discussion_r476195061", "bodyText": "which part should be moved to common model?", "author": "ShirleyZheng92", "createdAt": "2020-08-25T05:56:33Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/converter/RecipeConverter.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.packagemanager.converter;\n+\n+import com.aws.iot.evergreen.config.PlatformResolver;\n+import com.aws.iot.evergreen.packagemanager.common.ComponentParameter;\n+import com.aws.iot.evergreen.packagemanager.common.ComponentRecipe;\n+import com.aws.iot.evergreen.packagemanager.common.DependencyProperties;\n+import com.aws.iot.evergreen.packagemanager.common.PlatformSpecificManifest;\n+import com.aws.iot.evergreen.packagemanager.common.SerializerFactory;\n+import com.aws.iot.evergreen.packagemanager.exceptions.PackageLoadingException;\n+import com.aws.iot.evergreen.packagemanager.models.ComponentArtifact;\n+import com.aws.iot.evergreen.packagemanager.models.PackageParameter;\n+import com.aws.iot.evergreen.packagemanager.models.PackageRecipe;\n+import com.aws.iot.evergreen.packagemanager.models.RecipeDependencyProperties;\n+import com.aws.iot.evergreen.packagemanager.models.RecipeTemplateVersion;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import javax.inject.Inject;\n+\n+/**\n+ * This class handles conversion between recipe file contract and device business model. It also resolves platform\n+ * resolving logic while converting.\n+ */\n+public class RecipeConverter {\n+    // TODO add logging\n+    //    private static final Logger logger = LogManager.getLogger(RecipeConverter.class);\n+\n+    @Inject\n+    private PlatformResolver platformResolver;\n+\n+    /**\n+     * Converts.\n+     *\n+     * @param recipeFileContent recipe file content\n+     * @return Optional package recipe\n+     * @throws PackageLoadingException when failed to convert recipe file.\n+     */\n+    public Optional<PackageRecipe> convertFromFile(String recipeFileContent) throws PackageLoadingException {\n+\n+        ComponentRecipe componentRecipe;\n+        try {\n+            componentRecipe =\n+                    SerializerFactory.getRecipeSerializer().readValue(recipeFileContent, ComponentRecipe.class);\n+        } catch (JsonProcessingException e) {\n+            //TODO move this to common model", "originalCommit": "c91081d457c03f00c15a9cf31a6da3610938142b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjIwNjI3Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/382#discussion_r476206277", "bodyText": "I guess Ethan means deserialization part. Then common model needs to define exception(s) as well.", "author": "wikimonkey", "createdAt": "2020-08-25T06:28:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjE5NTA2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU1MjgwMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/382#discussion_r476552802", "bodyText": "Yes. Something like RecipeParseException maybe.", "author": "leaf94", "createdAt": "2020-08-25T15:49:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjE5NTA2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "d7844daeddef52f12d67e3bc84785df540a58445", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/packagemanager/converter/RecipeConverter.java b/src/main/java/com/aws/iot/evergreen/packagemanager/converter/RecipeConverter.java\nindex bc726e588..ff4641bf8 100644\n--- a/src/main/java/com/aws/iot/evergreen/packagemanager/converter/RecipeConverter.java\n+++ b/src/main/java/com/aws/iot/evergreen/packagemanager/converter/RecipeConverter.java\n\n@@ -3,11 +3,6 @@\n  * SPDX-License-Identifier: Apache-2.0\n  */\n \n-/*\n- * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n- * SPDX-License-Identifier: Apache-2.0\n- */\n-\n package com.aws.iot.evergreen.packagemanager.converter;\n \n import com.aws.iot.evergreen.config.PlatformResolver;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjIwMjI3MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/382#discussion_r476202270", "bodyText": "Why isn't it final? Also is the class singleton?", "author": "wikimonkey", "createdAt": "2020-08-25T06:17:54Z", "path": "src/main/java/com/aws/iot/evergreen/config/PlatformResolver.java", "diffHunk": "@@ -13,25 +14,22 @@\n import java.util.Comparator;\n import java.util.HashMap;\n import java.util.HashSet;\n+import java.util.List;\n import java.util.Map;\n+import java.util.Optional;\n import java.util.Set;\n import java.util.concurrent.atomic.AtomicReference;\n \n-public final class PlatformResolver {\n+public class PlatformResolver {", "originalCommit": "c91081d457c03f00c15a9cf31a6da3610938142b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU1NDAzNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/382#discussion_r476554036", "bodyText": "It was static utils before but I added an instance method and used it with our DI. Removed final so that I can easily mock it in tests. It's singleton.", "author": "leaf94", "createdAt": "2020-08-25T15:50:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjIwMjI3MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjIwNjQ0MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/382#discussion_r476206440", "bodyText": "Can you proceed if no match? Should it throw exception here?", "author": "wikimonkey", "createdAt": "2020-08-25T06:28:56Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/converter/RecipeConverter.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.packagemanager.converter;\n+\n+import com.aws.iot.evergreen.config.PlatformResolver;\n+import com.aws.iot.evergreen.packagemanager.common.ComponentParameter;\n+import com.aws.iot.evergreen.packagemanager.common.ComponentRecipe;\n+import com.aws.iot.evergreen.packagemanager.common.DependencyProperties;\n+import com.aws.iot.evergreen.packagemanager.common.PlatformSpecificManifest;\n+import com.aws.iot.evergreen.packagemanager.common.SerializerFactory;\n+import com.aws.iot.evergreen.packagemanager.exceptions.PackageLoadingException;\n+import com.aws.iot.evergreen.packagemanager.models.ComponentArtifact;\n+import com.aws.iot.evergreen.packagemanager.models.PackageParameter;\n+import com.aws.iot.evergreen.packagemanager.models.PackageRecipe;\n+import com.aws.iot.evergreen.packagemanager.models.RecipeDependencyProperties;\n+import com.aws.iot.evergreen.packagemanager.models.RecipeTemplateVersion;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import javax.inject.Inject;\n+\n+/**\n+ * This class handles conversion between recipe file contract and device business model. It also resolves platform\n+ * resolving logic while converting.\n+ */\n+public class RecipeConverter {\n+    // TODO add logging\n+    //    private static final Logger logger = LogManager.getLogger(RecipeConverter.class);\n+\n+    @Inject\n+    private PlatformResolver platformResolver;\n+\n+    /**\n+     * Converts.\n+     *\n+     * @param recipeFileContent recipe file content\n+     * @return Optional package recipe\n+     * @throws PackageLoadingException when failed to convert recipe file.\n+     */\n+    public Optional<PackageRecipe> convertFromFile(String recipeFileContent) throws PackageLoadingException {\n+\n+        ComponentRecipe componentRecipe;\n+        try {\n+            componentRecipe =\n+                    SerializerFactory.getRecipeSerializer().readValue(recipeFileContent, ComponentRecipe.class);\n+        } catch (JsonProcessingException e) {\n+            //TODO move this to common model\n+            throw new PackageLoadingException(\n+                    String.format(\"Failed to parse recipe file content to contract model. Recipe file content: '%s'.\",\n+                            recipeFileContent), e);\n+        }\n+\n+        Optional<PlatformSpecificManifest> optionalPlatformSpecificManifest =\n+                platformResolver.findBestMatch(componentRecipe.getManifests());\n+\n+        if (!optionalPlatformSpecificManifest.isPresent()) {", "originalCommit": "c91081d457c03f00c15a9cf31a6da3610938142b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU1NTg2MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/382#discussion_r476555861", "bodyText": "Hmm. I thought we could probably be able to... In this case it's find, the recipe file may exist but can't be used for this platform, so we just log a warn and then go to another usable version, etc. But we can refine it later.", "author": "leaf94", "createdAt": "2020-08-25T15:53:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjIwNjQ0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU4NTAwOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/382#discussion_r476585008", "bodyText": "The situation is not supposed to happen in cloud interaction because cloud is supposed to resolve to a platform compatible one, but it could happen in local dev - developer uses a recipe that no applicable platform config, in such case, I think deployment should fail fast. We can refactor this when we do DR overhaul.", "author": "wikimonkey", "createdAt": "2020-08-25T16:36:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjIwNjQ0MA=="}], "type": "inlineReview", "revised_code": {"commit": "d7844daeddef52f12d67e3bc84785df540a58445", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/packagemanager/converter/RecipeConverter.java b/src/main/java/com/aws/iot/evergreen/packagemanager/converter/RecipeConverter.java\nindex bc726e588..ff4641bf8 100644\n--- a/src/main/java/com/aws/iot/evergreen/packagemanager/converter/RecipeConverter.java\n+++ b/src/main/java/com/aws/iot/evergreen/packagemanager/converter/RecipeConverter.java\n\n@@ -3,11 +3,6 @@\n  * SPDX-License-Identifier: Apache-2.0\n  */\n \n-/*\n- * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n- * SPDX-License-Identifier: Apache-2.0\n- */\n-\n package com.aws.iot.evergreen.packagemanager.converter;\n \n import com.aws.iot.evergreen.config.PlatformResolver;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjIwNzcwNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/382#discussion_r476207706", "bodyText": "Shouldn't we rename it to 'component...'? The name probably should avoid conflicting with file model", "author": "wikimonkey", "createdAt": "2020-08-25T06:31:43Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/models/PackageRecipe.java", "diffHunk": "@@ -29,6 +31,8 @@\n @Getter\n @NoArgsConstructor(force = true, access = AccessLevel.PRIVATE)\n @EqualsAndHashCode(onlyExplicitlyIncluded = true)\n+@Builder\n+@AllArgsConstructor\n public class PackageRecipe {", "originalCommit": "c91081d457c03f00c15a9cf31a6da3610938142b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU1NjI5Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/382#discussion_r476556292", "bodyText": "Yes. I will do them in one shot after we cleaned things up.", "author": "leaf94", "createdAt": "2020-08-25T15:54:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjIwNzcwNg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjIwOTM1NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/382#discussion_r476209354", "bodyText": "nit: probably it will never happen, but can we ensure no null element in the result list by doing a filter?", "author": "wikimonkey", "createdAt": "2020-08-25T06:35:44Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/converter/RecipeConverter.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.packagemanager.converter;\n+\n+import com.aws.iot.evergreen.config.PlatformResolver;\n+import com.aws.iot.evergreen.packagemanager.common.ComponentParameter;\n+import com.aws.iot.evergreen.packagemanager.common.ComponentRecipe;\n+import com.aws.iot.evergreen.packagemanager.common.DependencyProperties;\n+import com.aws.iot.evergreen.packagemanager.common.PlatformSpecificManifest;\n+import com.aws.iot.evergreen.packagemanager.common.SerializerFactory;\n+import com.aws.iot.evergreen.packagemanager.exceptions.PackageLoadingException;\n+import com.aws.iot.evergreen.packagemanager.models.ComponentArtifact;\n+import com.aws.iot.evergreen.packagemanager.models.PackageParameter;\n+import com.aws.iot.evergreen.packagemanager.models.PackageRecipe;\n+import com.aws.iot.evergreen.packagemanager.models.RecipeDependencyProperties;\n+import com.aws.iot.evergreen.packagemanager.models.RecipeTemplateVersion;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import javax.inject.Inject;\n+\n+/**\n+ * This class handles conversion between recipe file contract and device business model. It also resolves platform\n+ * resolving logic while converting.\n+ */\n+public class RecipeConverter {\n+    // TODO add logging\n+    //    private static final Logger logger = LogManager.getLogger(RecipeConverter.class);\n+\n+    @Inject\n+    private PlatformResolver platformResolver;\n+\n+    /**\n+     * Converts.\n+     *\n+     * @param recipeFileContent recipe file content\n+     * @return Optional package recipe\n+     * @throws PackageLoadingException when failed to convert recipe file.\n+     */\n+    public Optional<PackageRecipe> convertFromFile(String recipeFileContent) throws PackageLoadingException {\n+\n+        ComponentRecipe componentRecipe;\n+        try {\n+            componentRecipe =\n+                    SerializerFactory.getRecipeSerializer().readValue(recipeFileContent, ComponentRecipe.class);\n+        } catch (JsonProcessingException e) {\n+            //TODO move this to common model\n+            throw new PackageLoadingException(\n+                    String.format(\"Failed to parse recipe file content to contract model. Recipe file content: '%s'.\",\n+                            recipeFileContent), e);\n+        }\n+\n+        Optional<PlatformSpecificManifest> optionalPlatformSpecificManifest =\n+                platformResolver.findBestMatch(componentRecipe.getManifests());\n+\n+        if (!optionalPlatformSpecificManifest.isPresent()) {\n+            return Optional.empty();\n+        }\n+\n+        PlatformSpecificManifest platformSpecificManifest = optionalPlatformSpecificManifest.get();\n+\n+        PackageRecipe packageRecipe = PackageRecipe.builder()\n+                                                   .componentName(componentRecipe.getComponentName())\n+                                                   .version(componentRecipe.getVersion())\n+                                                   .publisher(componentRecipe.getPublisher())\n+                                                   .recipeTemplateVersion(RecipeTemplateVersion.valueOf(\n+                                                           componentRecipe.getTemplateVersion().name()))\n+                                                   .componentType(componentRecipe.getComponentType())\n+                                                   .dependencies(convertDependencyFromFile(\n+                                                           platformSpecificManifest.getDependencies()))\n+                                                   .lifecycle(platformSpecificManifest.getLifecycle())\n+                                                   .artifacts(convertArtifactsFromFile(\n+                                                           platformSpecificManifest.getArtifacts()))\n+\n+                                                   .packageParameters(convertParametersFromFile(\n+                                                           platformSpecificManifest.getParameters()))\n+                                                   .build();\n+\n+        return Optional.of(packageRecipe);\n+    }\n+\n+    private Set<PackageParameter> convertParametersFromFile(List<ComponentParameter> parameters) {\n+        if (parameters == null || parameters.isEmpty()) {\n+            return Collections.emptySet();\n+        }\n+        return parameters.stream().map(this::convertParameterFromFile).collect(Collectors.toSet());\n+    }\n+\n+    private PackageParameter convertParameterFromFile(ComponentParameter parameter) {\n+        if (parameter == null) {\n+            return null;\n+        }\n+        return PackageParameter.builder()\n+                               .name(parameter.getName())\n+                               .value(parameter.getValue())\n+                               .type(PackageParameter.ParameterType.valueOf(parameter.getType().name()))\n+                               .build();\n+\n+    }\n+\n+    private List<ComponentArtifact> convertArtifactsFromFile(\n+            List<com.aws.iot.evergreen.packagemanager.common.ComponentArtifact> artifacts) {\n+        if (artifacts == null || artifacts.isEmpty()) {\n+            return Collections.emptyList();\n+        }\n+        return artifacts.stream().map(this::convertArtifactFromFile).collect(Collectors.toList());", "originalCommit": "c91081d457c03f00c15a9cf31a6da3610938142b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU1OTIzOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/382#discussion_r476559238", "bodyText": "Great suggestion. I added filter nonnull before doing map and removed the null check in the convertX method. Cleaner!", "author": "leaf94", "createdAt": "2020-08-25T15:58:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjIwOTM1NA=="}], "type": "inlineReview", "revised_code": {"commit": "d7844daeddef52f12d67e3bc84785df540a58445", "chunk": "diff --git a/src/main/java/com/aws/iot/evergreen/packagemanager/converter/RecipeConverter.java b/src/main/java/com/aws/iot/evergreen/packagemanager/converter/RecipeConverter.java\nindex bc726e588..ff4641bf8 100644\n--- a/src/main/java/com/aws/iot/evergreen/packagemanager/converter/RecipeConverter.java\n+++ b/src/main/java/com/aws/iot/evergreen/packagemanager/converter/RecipeConverter.java\n\n@@ -3,11 +3,6 @@\n  * SPDX-License-Identifier: Apache-2.0\n  */\n \n-/*\n- * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n- * SPDX-License-Identifier: Apache-2.0\n- */\n-\n package com.aws.iot.evergreen.packagemanager.converter;\n \n import com.aws.iot.evergreen.config.PlatformResolver;\n"}}, {"oid": "bc98b9ebb06f263c1d650827ef4b0360c423da01", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/bc98b9ebb06f263c1d650827ef4b0360c423da01", "message": "fix more tests", "committedDate": "2020-08-25T07:22:05Z", "type": "commit"}, {"oid": "1488b54c837edb7d8dc689b7ffd2702f36cbaba7", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1488b54c837edb7d8dc689b7ffd2702f36cbaba7", "message": "fix more tests", "committedDate": "2020-08-25T15:48:10Z", "type": "commit"}, {"oid": "d7844daeddef52f12d67e3bc84785df540a58445", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d7844daeddef52f12d67e3bc84785df540a58445", "message": "wikimonkey's comments", "committedDate": "2020-08-25T16:03:18Z", "type": "commit"}, {"oid": "8392192c599d989fad4d368744e03434babd5be2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8392192c599d989fad4d368744e03434babd5be2", "message": "Merge branch 'master' into recipe_converter", "committedDate": "2020-08-25T16:09:26Z", "type": "commit"}]}