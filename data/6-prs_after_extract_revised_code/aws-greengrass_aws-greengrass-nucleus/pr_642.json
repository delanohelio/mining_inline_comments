{"pr_number": 642, "pr_title": "Handle runWith component and default changes", "pr_createdAt": "2020-11-07T06:15:46Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/642", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTEyNjgzOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/642#discussion_r519126839", "bodyText": "can the topic be null? toPojo might throw NPE.", "author": "MikeDombo", "createdAt": "2020-11-07T06:21:15Z", "path": "src/main/java/com/aws/greengrass/deployment/bootstrap/BootstrapManager.java", "diffHunk": "@@ -180,9 +195,64 @@ private boolean networkProxyHasChanged(Map<String, Object> newNucleusParameters,\n         return false;\n     }\n \n+    private boolean defaultRunWithChanged(Map<String, Object> newNucleusParameters,\n+            DeviceConfiguration currentDeviceConfiguration) throws ComponentConfigurationValidationException {\n+        Map<String, Object> runWithDefault = (Map<String, Object>)newNucleusParameters.getOrDefault(RUN_WITH_TOPIC,\n+                Collections.emptyMap());\n+\n+        Map<String, Object> currentValues = currentDeviceConfiguration.getRunWithTopic().toPOJO();", "originalCommit": "ef1c1f82253fad2e65b99f107d1e80fa8104522f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTEyOTI3Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/642#discussion_r519129272", "bodyText": "Unless the comment on lookupTopics is false - it says it never returns null.", "author": "rbattle", "createdAt": "2020-11-07T06:26:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTEyNjgzOQ=="}], "type": "inlineReview", "revised_code": {"commit": "4639cac4b0e29307c276161dc3c49eb1b29ce0b0", "chunk": "diff --git a/src/main/java/com/aws/greengrass/deployment/bootstrap/BootstrapManager.java b/src/main/java/com/aws/greengrass/deployment/bootstrap/BootstrapManager.java\nindex 38569f98..01779548 100644\n--- a/src/main/java/com/aws/greengrass/deployment/bootstrap/BootstrapManager.java\n+++ b/src/main/java/com/aws/greengrass/deployment/bootstrap/BootstrapManager.java\n\n@@ -248,7 +248,7 @@ public class BootstrapManager implements Iterator<BootstrapTaskStatus>  {\n     private boolean nucleusConfigChangeRequiresRestart(Map<String, Object> newNucleusParameters,\n                                                        DeviceConfiguration currentDeviceConfiguration)\n             throws ComponentConfigurationValidationException {\n-        // validation must not be skipped\n+        // validation must not be skipped - otherwise the nucleus will be restarted with invalid config\n         boolean proxyChanged =  networkProxyHasChanged(newNucleusParameters, currentDeviceConfiguration);\n         boolean runWithChanged = defaultRunWithChanged(newNucleusParameters, currentDeviceConfiguration);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTEyNzE4NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/642#discussion_r519127184", "bodyText": "why not? Can you mention it.", "author": "MikeDombo", "createdAt": "2020-11-07T06:22:01Z", "path": "src/main/java/com/aws/greengrass/deployment/bootstrap/BootstrapManager.java", "diffHunk": "@@ -196,16 +266,21 @@ private boolean nucleusConfigValidAndNeedsRestart(Map<String, Object> deployment\n         for (GreengrassService s : kernel.orderedDependencies()) {\n             // For now, only let builtin Greengrass services decide\n             if (s.isBuiltin()) {\n-                needsRestart = needsRestart || s.restartNucleusOnNucleusConfigChange(proposedNucleusConfig);\n+                // don't short-circuit validation", "originalCommit": "ef1c1f82253fad2e65b99f107d1e80fa8104522f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTEzMDgzNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/642#discussion_r519130834", "bodyText": "sure - I'll update the comment. restartNucleusOnNucleusConfig throws a validation exception. The components are expected to throw an exception if it is invalid which then stops the configuration from being applied.\nIf the first component's config is ok, and it needs to restart, then it would stop other components from even looking at it", "author": "rbattle", "createdAt": "2020-11-07T06:30:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTEyNzE4NA=="}], "type": "inlineReview", "revised_code": {"commit": "4639cac4b0e29307c276161dc3c49eb1b29ce0b0", "chunk": "diff --git a/src/main/java/com/aws/greengrass/deployment/bootstrap/BootstrapManager.java b/src/main/java/com/aws/greengrass/deployment/bootstrap/BootstrapManager.java\nindex 38569f98..01779548 100644\n--- a/src/main/java/com/aws/greengrass/deployment/bootstrap/BootstrapManager.java\n+++ b/src/main/java/com/aws/greengrass/deployment/bootstrap/BootstrapManager.java\n\n@@ -266,7 +266,10 @@ public class BootstrapManager implements Iterator<BootstrapTaskStatus>  {\n         for (GreengrassService s : kernel.orderedDependencies()) {\n             // For now, only let builtin Greengrass services decide\n             if (s.isBuiltin()) {\n-                // don't short-circuit validation\n+                // Don't short-circuit validation - restartNucleusOnNucleusConfigChange throws\n+                // ComponentConfigurationValidationException. Each component should check that the config is valid\n+                // before accepting the change and restarting the Nucleus. The exception is handled by the\n+                // DeploymentActivatorFactory to reject the deployment.\n                 boolean componentChanged = s.restartNucleusOnNucleusConfigChange(proposedNucleusConfig);\n                 needsRestart = needsRestart || componentChanged;\n             }\n"}}, {"oid": "4639cac4b0e29307c276161dc3c49eb1b29ce0b0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4639cac4b0e29307c276161dc3c49eb1b29ce0b0", "message": "Handle runWith component and default changes\n\nReinstall on component runWith updating\n\nRestart nucleus on default changing\n\nAdd tests for bootstrapping and fix some bugs in how the nucleus config changes were being discovered", "committedDate": "2020-11-07T06:34:38Z", "type": "commit"}, {"oid": "4639cac4b0e29307c276161dc3c49eb1b29ce0b0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4639cac4b0e29307c276161dc3c49eb1b29ce0b0", "message": "Handle runWith component and default changes\n\nReinstall on component runWith updating\n\nRestart nucleus on default changing\n\nAdd tests for bootstrapping and fix some bugs in how the nucleus config changes were being discovered", "committedDate": "2020-11-07T06:34:38Z", "type": "forcePushed"}, {"oid": "211771453aeafc409385dbe82391ad3587c4e5f8", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/211771453aeafc409385dbe82391ad3587c4e5f8", "message": "Merge branch 'master' into runwith-restart", "committedDate": "2020-11-07T07:08:08Z", "type": "commit"}, {"oid": "3642f523fe1ebc1101a3e76f81caf47942b0b5f8", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3642f523fe1ebc1101a3e76f81caf47942b0b5f8", "message": "Merge branch 'master' into runwith-restart", "committedDate": "2020-11-09T18:06:27Z", "type": "commit"}, {"oid": "6088b8fc600c62ac3da41bab11ca0c988cb3db08", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6088b8fc600c62ac3da41bab11ca0c988cb3db08", "message": "Merge branch 'master' into runwith-restart", "committedDate": "2020-11-09T19:23:46Z", "type": "commit"}, {"oid": "e842c383225a976696f80ad5679071059551f7b2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e842c383225a976696f80ad5679071059551f7b2", "message": "Merge branch 'master' into runwith-restart", "committedDate": "2020-11-09T21:44:08Z", "type": "commit"}]}