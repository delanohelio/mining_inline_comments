{"pr_number": 746, "pr_title": "[DNM] Initial dev tools deployment issue fixes", "pr_createdAt": "2020-12-02T01:59:19Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/746", "timeline": [{"oid": "da7b24fb205501575100dc10a2c5315b70017af4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/da7b24fb205501575100dc10a2c5315b70017af4", "message": "Improve message for deployment creation getting skipped for existing thing group", "committedDate": "2020-12-03T06:07:30Z", "type": "forcePushed"}, {"oid": "e9cfdb382ef689cd9e632c8bb43dcb9643cce346", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e9cfdb382ef689cd9e632c8bb43dcb9643cce346", "message": "Improve message for deployment creation getting skipped for existing thing group", "committedDate": "2020-12-04T05:24:37Z", "type": "commit"}, {"oid": "c3dd287950a0a5eb275a43404e6f03612d82d0f0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c3dd287950a0a5eb275a43404e6f03612d82d0f0", "message": "Add current nucleus version as top level component to initial deployment in setup", "committedDate": "2020-12-04T06:00:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg1NzM5Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/746#discussion_r535857393", "bodyText": "can you get the version from the config instead? That will help us in testing.", "author": "MikeDombo", "createdAt": "2020-12-04T06:03:26Z", "path": "src/main/java/com/aws/greengrass/easysetup/DeviceProvisioningHelper.java", "diffHunk": "@@ -472,7 +477,9 @@ public void createInitialDeploymentIfNeeded(ThingInfo thingInfo, String thingGro\n         }\n \n         deploymentRequest.components(Utils.immutableMap(GREENGRASS_CLI_COMPONENT_NAME,\n-                ComponentDeploymentSpecification.builder().componentVersion(GREENGRASS_CLI_COMPONENT_VERSION).build()));\n+                ComponentDeploymentSpecification.builder().componentVersion(GREENGRASS_CLI_COMPONENT_VERSION).build(),\n+                DeviceConfiguration.DEFAULT_NUCLEUS_COMPONENT_NAME,\n+                ComponentDeploymentSpecification.builder().componentVersion(KernelVersion.KERNEL_VERSION).build()));", "originalCommit": "c3dd287950a0a5eb275a43404e6f03612d82d0f0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg1OTIyMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/746#discussion_r535859221", "bodyText": "We don't use the deploy dev tools option for testing do we?", "author": "shaguptashaikh", "createdAt": "2020-12-04T06:08:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg1NzM5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg3NDMxNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/746#discussion_r535874316", "bodyText": "No, but we should at some point.", "author": "MikeDombo", "createdAt": "2020-12-04T06:50:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg1NzM5Mw=="}], "type": "inlineReview", "revised_code": {"commit": "98f6a066ac4b86ccf5a8a01a282731313561cf11", "chunk": "diff --git a/src/main/java/com/aws/greengrass/easysetup/DeviceProvisioningHelper.java b/src/main/java/com/aws/greengrass/easysetup/DeviceProvisioningHelper.java\nindex 99f6c48b8a..b655d02b63 100644\n--- a/src/main/java/com/aws/greengrass/easysetup/DeviceProvisioningHelper.java\n+++ b/src/main/java/com/aws/greengrass/easysetup/DeviceProvisioningHelper.java\n\n@@ -476,10 +481,14 @@ public class DeviceProvisioningHelper {\n                     .deploymentName(String.format(INITIAL_DEPLOYMENT_NAME_FORMAT, thingInfo.thingName));\n         }\n \n+        DeviceConfiguration deviceConfiguration = kernel.getContext().get(DeviceConfiguration.class);\n+        String nucleusName = deviceConfiguration.getNucleusComponentName();\n+        String nucleusVersion = Coerce.toString(kernel.getConfig().getRoot()\n+                .findOrDefault(KernelVersion.KERNEL_VERSION, SERVICES_NAMESPACE_TOPIC, nucleusName,\n+                        VERSION_CONFIG_KEY));\n         deploymentRequest.components(Utils.immutableMap(GREENGRASS_CLI_COMPONENT_NAME,\n                 ComponentDeploymentSpecification.builder().componentVersion(GREENGRASS_CLI_COMPONENT_VERSION).build(),\n-                DeviceConfiguration.DEFAULT_NUCLEUS_COMPONENT_NAME,\n-                ComponentDeploymentSpecification.builder().componentVersion(KernelVersion.KERNEL_VERSION).build()));\n+                nucleusName, ComponentDeploymentSpecification.builder().componentVersion(nucleusVersion).build()));\n \n         greengrassClient.createDeployment(deploymentRequest.build());\n         outStream.printf(\"Configured Nucleus to deploy %s component%n\", GREENGRASS_CLI_COMPONENT_NAME);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg1NzUyMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/746#discussion_r535857521", "bodyText": "take nucleus name from config", "author": "MikeDombo", "createdAt": "2020-12-04T06:03:49Z", "path": "src/main/java/com/aws/greengrass/easysetup/DeviceProvisioningHelper.java", "diffHunk": "@@ -472,7 +477,9 @@ public void createInitialDeploymentIfNeeded(ThingInfo thingInfo, String thingGro\n         }\n \n         deploymentRequest.components(Utils.immutableMap(GREENGRASS_CLI_COMPONENT_NAME,\n-                ComponentDeploymentSpecification.builder().componentVersion(GREENGRASS_CLI_COMPONENT_VERSION).build()));\n+                ComponentDeploymentSpecification.builder().componentVersion(GREENGRASS_CLI_COMPONENT_VERSION).build(),\n+                DeviceConfiguration.DEFAULT_NUCLEUS_COMPONENT_NAME,", "originalCommit": "c3dd287950a0a5eb275a43404e6f03612d82d0f0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg1OTA3NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/746#discussion_r535859075", "bodyText": "Taking nucleus name from config is not very helpful, if the current nucleus is a custom one and the dev tools deployment option is used along with it, this cli component will still bring the default nucleus so there will be conflict and it will fail anyway", "author": "shaguptashaikh", "createdAt": "2020-12-04T06:08:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg1NzUyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg3NDM3Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/746#discussion_r535874373", "bodyText": "Yeah you're right", "author": "MikeDombo", "createdAt": "2020-12-04T06:50:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg1NzUyMQ=="}], "type": "inlineReview", "revised_code": {"commit": "98f6a066ac4b86ccf5a8a01a282731313561cf11", "chunk": "diff --git a/src/main/java/com/aws/greengrass/easysetup/DeviceProvisioningHelper.java b/src/main/java/com/aws/greengrass/easysetup/DeviceProvisioningHelper.java\nindex 99f6c48b8a..b655d02b63 100644\n--- a/src/main/java/com/aws/greengrass/easysetup/DeviceProvisioningHelper.java\n+++ b/src/main/java/com/aws/greengrass/easysetup/DeviceProvisioningHelper.java\n\n@@ -476,10 +481,14 @@ public class DeviceProvisioningHelper {\n                     .deploymentName(String.format(INITIAL_DEPLOYMENT_NAME_FORMAT, thingInfo.thingName));\n         }\n \n+        DeviceConfiguration deviceConfiguration = kernel.getContext().get(DeviceConfiguration.class);\n+        String nucleusName = deviceConfiguration.getNucleusComponentName();\n+        String nucleusVersion = Coerce.toString(kernel.getConfig().getRoot()\n+                .findOrDefault(KernelVersion.KERNEL_VERSION, SERVICES_NAMESPACE_TOPIC, nucleusName,\n+                        VERSION_CONFIG_KEY));\n         deploymentRequest.components(Utils.immutableMap(GREENGRASS_CLI_COMPONENT_NAME,\n                 ComponentDeploymentSpecification.builder().componentVersion(GREENGRASS_CLI_COMPONENT_VERSION).build(),\n-                DeviceConfiguration.DEFAULT_NUCLEUS_COMPONENT_NAME,\n-                ComponentDeploymentSpecification.builder().componentVersion(KernelVersion.KERNEL_VERSION).build()));\n+                nucleusName, ComponentDeploymentSpecification.builder().componentVersion(nucleusVersion).build()));\n \n         greengrassClient.createDeployment(deploymentRequest.build());\n         outStream.printf(\"Configured Nucleus to deploy %s component%n\", GREENGRASS_CLI_COMPONENT_NAME);\n"}}, {"oid": "98f6a066ac4b86ccf5a8a01a282731313561cf11", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/98f6a066ac4b86ccf5a8a01a282731313561cf11", "message": "Add current nucleus version as top level component to initial deployment in setup", "committedDate": "2020-12-04T06:16:13Z", "type": "forcePushed"}, {"oid": "e9cfdb382ef689cd9e632c8bb43dcb9643cce346", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e9cfdb382ef689cd9e632c8bb43dcb9643cce346", "message": "Improve message for deployment creation getting skipped for existing thing group", "committedDate": "2020-12-04T05:24:37Z", "type": "forcePushed"}]}