{"pr_number": 4986, "pr_title": "FISH-660 Upgrade MicroProfile Health Implementation to 3.0-RC5", "pr_createdAt": "2020-11-10T11:35:45Z", "pr_url": "https://github.com/payara/Payara/pull/4986", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTIzMDA5Nw==", "url": "https://github.com/payara/Payara/pull/4986#discussion_r521230097", "bodyText": "Can't wrap my head around this one. How is an empty modifiable map of any use? Why would a concurrent map be wrong in a shared service? How is this only applying to health and not equally to readiness and liveness?\nMaybe you can shine some light on this for me.", "author": "jbee", "createdAt": "2020-11-11T09:34:14Z", "path": "appserver/payara-appserver-modules/microprofile/healthcheck/src/main/java/fish/payara/microprofile/healthcheck/HealthCheckService.java", "diffHunk": "@@ -116,16 +115,11 @@\n     private ApplicationRegistry applicationRegistry;\n \n     @Inject\n-    private MetricsHealthCheckConfiguration configuration;\n-\n-    @Inject\n-    private ConfigProviderResolver microConfigResolver;\n-\n-    private boolean backwardCompEnabled;\n+    private MicroprofileHealthCheckConfiguration configuration;\n \n     private static final Logger LOG = Logger.getLogger(HealthCheckService.class.getName());\n \n-    private final Map<String, Set<HealthCheck>> health = new ConcurrentHashMap<>();\n+    private final Map<String, Set<HealthCheck>> health = unmodifiableMap(new HashMap<>());", "originalCommit": "e5714744023ca96ec57c9f11387dec8df721c97d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQwODQzNg==", "url": "https://github.com/payara/Payara/pull/4986#discussion_r521408436", "bodyText": "I did it in the interest of \"non invasive changes\" whilst still trying to make it clear that this isn't modified anymore. Perhaps it would be more readable if I just use an explicit new HashMap each time instead. I'll refactor this", "author": "MattGill98", "createdAt": "2020-11-11T14:46:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTIzMDA5Nw=="}], "type": "inlineReview", "revised_code": {"commit": "6b53a0675b2d0c75ecb4e426e1d5d0de94483b21", "chunk": "diff --git a/appserver/payara-appserver-modules/microprofile/healthcheck/src/main/java/fish/payara/microprofile/healthcheck/HealthCheckService.java b/appserver/payara-appserver-modules/microprofile/healthcheck/src/main/java/fish/payara/microprofile/healthcheck/HealthCheckService.java\nindex 6d746d4af8..478bf75a7a 100644\n--- a/appserver/payara-appserver-modules/microprofile/healthcheck/src/main/java/fish/payara/microprofile/healthcheck/HealthCheckService.java\n+++ b/appserver/payara-appserver-modules/microprofile/healthcheck/src/main/java/fish/payara/microprofile/healthcheck/HealthCheckService.java\n\n@@ -115,11 +114,10 @@ public class HealthCheckService implements EventListener, ConfigListener, Monito\n     private ApplicationRegistry applicationRegistry;\n \n     @Inject\n-    private MicroprofileHealthCheckConfiguration configuration;\n+    private MetricsHealthCheckConfiguration configuration;\n \n     private static final Logger LOG = Logger.getLogger(HealthCheckService.class.getName());\n \n-    private final Map<String, Set<HealthCheck>> health = unmodifiableMap(new HashMap<>());\n     private final Map<String, Set<HealthCheck>> readiness = new ConcurrentHashMap<>();\n     private final Map<String, Set<HealthCheck>> liveness = new ConcurrentHashMap<>();\n \n"}}, {"oid": "6b53a0675b2d0c75ecb4e426e1d5d0de94483b21", "url": "https://github.com/payara/Payara/commit/6b53a0675b2d0c75ecb4e426e1d5d0de94483b21", "message": "FISH-660 Upgrade MicroProfile Health to 3.0-RC5\n\n@Health annotation has been removed, so the backward compatibility flag\nhas also been removed.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>", "committedDate": "2020-11-11T14:57:35Z", "type": "commit"}, {"oid": "b59f164a71d80edd86e1383f58d67d5ea75af68e", "url": "https://github.com/payara/Payara/commit/b59f164a71d80edd86e1383f58d67d5ea75af68e", "message": "FISH-660 Fix MicroProfile Health Configuration Name\n\nThis is a breaking change, but the MP health configuration was\nincorrectly called \"metrics-healthcheck-configuration\" which was\nconfusing.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>", "committedDate": "2020-11-11T14:57:41Z", "type": "commit"}, {"oid": "b59f164a71d80edd86e1383f58d67d5ea75af68e", "url": "https://github.com/payara/Payara/commit/b59f164a71d80edd86e1383f58d67d5ea75af68e", "message": "FISH-660 Fix MicroProfile Health Configuration Name\n\nThis is a breaking change, but the MP health configuration was\nincorrectly called \"metrics-healthcheck-configuration\" which was\nconfusing.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>", "committedDate": "2020-11-11T14:57:41Z", "type": "forcePushed"}, {"oid": "84d37c78db5215e54edd01689d253a0410a1b778", "url": "https://github.com/payara/Payara/commit/84d37c78db5215e54edd01689d253a0410a1b778", "message": "FISH-660 Remove Old MP Health Watches\n\nMonitoring still collected Health data, which has been removed. The\n'overall' metric has also been renamed to health as it now feels more\nappropriate.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>", "committedDate": "2020-11-12T10:46:44Z", "type": "commit"}, {"oid": "1cc21a1b7b5ceec4d76a5a6d65f8ca616ab358b2", "url": "https://github.com/payara/Payara/commit/1cc21a1b7b5ceec4d76a5a6d65f8ca616ab358b2", "message": "Merge branch 'FISH-660' of github.com:MattGill98/Payara into FISH-660", "committedDate": "2020-11-20T11:28:55Z", "type": "forcePushed"}, {"oid": "f1ec9a1da720da92cc952e69c0c592faea46dea0", "url": "https://github.com/payara/Payara/commit/f1ec9a1da720da92cc952e69c0c592faea46dea0", "message": "Merge branch 'master' into FISH-660", "committedDate": "2020-11-20T11:34:02Z", "type": "commit"}, {"oid": "7e299af6efe77b062ebdbd41dac0d9d5cbee6571", "url": "https://github.com/payara/Payara/commit/7e299af6efe77b062ebdbd41dac0d9d5cbee6571", "message": "FISH-660 Reconcile master merge with Health Upgrade\n\nConflicts arose caused by FISH-327 MP Sniffers. These are integrated\ninto the Health upgrade.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>", "committedDate": "2020-11-20T11:35:25Z", "type": "forcePushed"}, {"oid": "6683379ee2b61757db66008608a7762dca05f75b", "url": "https://github.com/payara/Payara/commit/6683379ee2b61757db66008608a7762dca05f75b", "message": "FISH-660 Reconcile master merge with Health Upgrade\n\nConflicts arose caused by FISH-327 MP Sniffers. These are integrated\ninto the Health upgrade.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>", "committedDate": "2020-11-20T12:04:29Z", "type": "forcePushed"}, {"oid": "2c2e33b73d38f5c2e6199acab5f176837e64b87a", "url": "https://github.com/payara/Payara/commit/2c2e33b73d38f5c2e6199acab5f176837e64b87a", "message": "FISH-660 Reconcile master merge with Health Upgrade\n\nConflicts arose caused by FISH-327 MP Sniffers. These are integrated\ninto the Health upgrade.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>", "committedDate": "2020-11-20T13:09:41Z", "type": "commit"}, {"oid": "2c2e33b73d38f5c2e6199acab5f176837e64b87a", "url": "https://github.com/payara/Payara/commit/2c2e33b73d38f5c2e6199acab5f176837e64b87a", "message": "FISH-660 Reconcile master merge with Health Upgrade\n\nConflicts arose caused by FISH-327 MP Sniffers. These are integrated\ninto the Health upgrade.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>", "committedDate": "2020-11-20T13:09:41Z", "type": "forcePushed"}]}