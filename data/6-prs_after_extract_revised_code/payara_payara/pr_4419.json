{"pr_number": 4419, "pr_title": "CUSTCOM-168 OpenID Connect: Fixed simultaneous redirects and invalidation of session", "pr_createdAt": "2020-01-09T08:38:15Z", "pr_url": "https://github.com/payara/Payara/pull/4419", "timeline": [{"oid": "d47ef1eeb16778fdd27244301ac48e8d995ce92e", "url": "https://github.com/payara/Payara/commit/d47ef1eeb16778fdd27244301ac48e8d995ce92e", "message": "Sychronize request validation with HTTP session", "committedDate": "2019-12-30T17:44:17Z", "type": "commit"}, {"oid": "f8c954b01a13ab6586d41a9b59c67f7d5faf5535", "url": "https://github.com/payara/Payara/commit/f8c954b01a13ab6586d41a9b59c67f7d5faf5535", "message": "Disabled session registration after refreshing token (causes session to be invalidated)", "committedDate": "2019-12-30T19:38:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg3Mzc2Mw==", "url": "https://github.com/payara/Payara/pull/4419#discussion_r364873763", "bodyText": "Same line is duplicated and commented out ... was it tested? :-)", "author": "dmatej", "createdAt": "2020-01-09T17:41:44Z", "path": "appserver/payara-appserver-modules/security-openid/src/main/java/fish/payara/security/openid/OpenIdAuthenticationMechanism.java", "diffHunk": "@@ -332,7 +333,10 @@ private AuthenticationStatus refreshTokens(HttpMessageContext httpContext, Refre\n             updateContext(tokensObject);\n             OpenIdCredential credential = new OpenIdCredential(tokensObject, httpContext, configuration);\n             CredentialValidationResult validationResult = identityStoreHandler.validate(credential);\n-            // Register session manually (if @AutoApplySession used, this would be done by its interceptor)\n+            \n+            // Dot not register session, as this will invalidate the currently active sessions (with all of its attributes)!\n+            // httpContext.setRegisterSession(validationResult.getCallerPrincipal().getName(), validationResult.getCallerGroups());\n+\n             httpContext.setRegisterSession(validationResult.getCallerPrincipal().getName(), validationResult.getCallerGroups());", "originalCommit": "f8c954b01a13ab6586d41a9b59c67f7d5faf5535", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg4NjMzNg==", "url": "https://github.com/payara/Payara/pull/4419#discussion_r364886336", "bodyText": "Ah, sorry. Copied the changes from my test-env without removing the line. Will fix it.", "author": "parysto", "createdAt": "2020-01-09T18:11:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg3Mzc2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "c3c60b0e7c7c005941617bb2df1da0def17bb20e", "chunk": "diff --git a/appserver/payara-appserver-modules/security-openid/src/main/java/fish/payara/security/openid/OpenIdAuthenticationMechanism.java b/appserver/payara-appserver-modules/security-openid/src/main/java/fish/payara/security/openid/OpenIdAuthenticationMechanism.java\nindex fe4dc53745..07757cb79a 100644\n--- a/appserver/payara-appserver-modules/security-openid/src/main/java/fish/payara/security/openid/OpenIdAuthenticationMechanism.java\n+++ b/appserver/payara-appserver-modules/security-openid/src/main/java/fish/payara/security/openid/OpenIdAuthenticationMechanism.java\n\n@@ -336,8 +336,7 @@ public class OpenIdAuthenticationMechanism implements HttpAuthenticationMechanis\n             \n             // Dot not register session, as this will invalidate the currently active sessions (with all of its attributes)!\n             // httpContext.setRegisterSession(validationResult.getCallerPrincipal().getName(), validationResult.getCallerGroups());\n-\n-            httpContext.setRegisterSession(validationResult.getCallerPrincipal().getName(), validationResult.getCallerGroups());\n+            \n             return httpContext.notifyContainerAboutLogin(validationResult);\n         } else {\n             // Token Request is invalid (refresh token invalid or expired)\n"}}, {"oid": "c3c60b0e7c7c005941617bb2df1da0def17bb20e", "url": "https://github.com/payara/Payara/commit/c3c60b0e7c7c005941617bb2df1da0def17bb20e", "message": "Removed duplicated line (registration of session)", "committedDate": "2020-01-09T18:14:10Z", "type": "commit"}, {"oid": "7e7d33ecc1d6523061881447bb6529a26a5ba043", "url": "https://github.com/payara/Payara/commit/7e7d33ecc1d6523061881447bb6529a26a5ba043", "message": "Fixed typo in comment", "committedDate": "2020-01-09T18:21:27Z", "type": "commit"}, {"oid": "ce0e8717af71fe4778eb63315475cfafb8524793", "url": "https://github.com/payara/Payara/commit/ce0e8717af71fe4778eb63315475cfafb8524793", "message": "Cleanup of imports.", "committedDate": "2020-01-13T18:09:02Z", "type": "commit"}, {"oid": "529e5c927959c439a8512ebda51242ef6320e6f9", "url": "https://github.com/payara/Payara/commit/529e5c927959c439a8512ebda51242ef6320e6f9", "message": "Synchronize re-authentication of token only, not whole authentication process.", "committedDate": "2020-01-19T13:34:38Z", "type": "commit"}, {"oid": "63ece4bf81e292dfc8a6c91a73bf9b48470d3dd5", "url": "https://github.com/payara/Payara/commit/63ece4bf81e292dfc8a6c91a73bf9b48470d3dd5", "message": "Added double check for access token expiration.", "committedDate": "2020-01-19T17:31:02Z", "type": "commit"}, {"oid": "af59a1c253e622611e9401025bd69ab9b957954d", "url": "https://github.com/payara/Payara/commit/af59a1c253e622611e9401025bd69ab9b957954d", "message": "Fixed compilation failure due to invalid position of return value.", "committedDate": "2020-01-20T16:43:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc2Njk0OA==", "url": "https://github.com/payara/Payara/pull/4419#discussion_r376766948", "bodyText": "Is really the plan to put the lock to the session object and leave it there forever? What if the token expires for second time? The lock will be still in session attributes from previous iteration.\nAlso replication in cluster will have some latency, is it or isn't it a problem? (probably it isn't)\nI don't say it is incorrect, I am only asking ;-)", "author": "dmatej", "createdAt": "2020-02-09T09:06:19Z", "path": "appserver/payara-appserver-modules/security-openid/src/main/java/fish/payara/security/openid/OpenIdAuthenticationMechanism.java", "diffHunk": "@@ -364,4 +368,20 @@ private void updateContext(JsonObject tokensObject) {\n         }\n     }\n \n+    private Object getSessionLock(HttpServletRequest request) {", "originalCommit": "af59a1c253e622611e9401025bd69ab9b957954d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc2ODYyOQ==", "url": "https://github.com/payara/Payara/pull/4419#discussion_r376768629", "bodyText": "Interesting...\nI know raw Object is not Serializable. I do not remember perfectly, but I do wonder what happens at HttpSession passivation... Or if session migrates to other VM...", "author": "pzygielo", "createdAt": "2020-02-09T09:34:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc2Njk0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc3MzkxOA==", "url": "https://github.com/payara/Payara/pull/4419#discussion_r376773918", "bodyText": "Hi @dmatej, hi @pzygielo\n\nIs really the plan to put the lock to the session object and leave it there forever? What if the token expires for second time? The lock will be still in session attributes from previous iteration.\n\nYou mean the lock-object? Yes, when the token expires again, the same instance of the lock will be reused. So, we do not need to set the \"lock-attribute\" again as long as the user's session is not invalidated. When the user's session is invalidated, the lock will be removed. Or am I wrong?\n\nAlso replication in cluster will have some latency, is it or isn't it a problem? (probably it isn't)\n\nObject itself does not have any fields that need to be transferred. So there shouldn't be a huge impact on latency. Although I haven't measured that ;-)\n\nI know raw Object is not Serializable. I do not remember perfectly, but I do wonder what happens at HttpSession passivation... Or if session migrates to other VM...\n\nGood point, haven't thought about that. Yes, Object is not Serializable, so passivation or replication will fail. Will change the lock to an \"empty\" implementation of Serializable.\n\nI don't say it is incorrect, I am only asking ;-)\n\nI appreciate your feedback :-)", "author": "parysto", "createdAt": "2020-02-09T10:59:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc2Njk0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTI0MjIxNg==", "url": "https://github.com/payara/Payara/pull/4419#discussion_r381242216", "bodyText": "@pzygielo I think I investigated in years ago when I was fixing SSO session replication and I found that nonserializable objects are simply ignored if there is no special implementation for them.", "author": "dmatej", "createdAt": "2020-02-19T11:47:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc2Njk0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTI1OTEyMw==", "url": "https://github.com/payara/Payara/pull/4419#discussion_r381259123", "bodyText": "@dmatej thanks for checking\n\nI think I investigated in years ago when I was fixing SSO session replication and I found that nonserializable objects are simply ignored if there is no special implementation for them.\n\nHowever it's not so clear for me, given section 7.7.2 of Servlet 4.0 spec, and:\n\nThe distributed servlet container must throw an IllegalArgumentException for\nobjects where the container cannot support the mechanism necessary for migration\nof the session storing them.\n\nthus I'm not so sure about simply ignoring such session attributes. So it seems I have to investigate myself \ud83d\ude09", "author": "pzygielo", "createdAt": "2020-02-19T12:26:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc2Njk0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTI2NDgxMw==", "url": "https://github.com/payara/Payara/pull/4419#discussion_r381264813", "bodyText": "Here is one implementation piece I found, that confirms your statement, about \"how it is\": \n  \n    \n      Payara/appserver/web/web-core/src/main/java/org/apache/catalina/session/StandardSession.java\n    \n    \n        Lines 2172 to 2178\n      in\n      bdb468a\n    \n    \n    \n    \n\n        \n          \n           } else if (isSerializable(value)) { \n        \n\n        \n          \n               saveNames.add(keys[i]); \n        \n\n        \n          \n               saveValues.add(value); \n        \n\n        \n          \n           //end HERCULES:mod \n        \n\n        \n          \n           } else { \n        \n\n        \n          \n               removeAttribute(keys[i], true, true); \n        \n\n        \n          \n           }", "author": "pzygielo", "createdAt": "2020-02-19T12:39:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc2Njk0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQzMTQ1MA==", "url": "https://github.com/payara/Payara/pull/4419#discussion_r381431450", "bodyText": "\"the container cannot support the mechanism necessary\" ... such mechanism might be even ignoring objects which are managed by some mechanism on the other side.\nBut ... yes, I think there are some \"blank spaces\" in impl ... the problem is that implementing it would crash nearly all older+larger applications I have seen :D", "author": "dmatej", "createdAt": "2020-02-19T17:33:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc2Njk0OA=="}], "type": "inlineReview", "revised_code": {"commit": "22451563b1ce571419c0061821b5497ccf4c857d", "chunk": "diff --git a/appserver/payara-appserver-modules/security-openid/src/main/java/fish/payara/security/openid/OpenIdAuthenticationMechanism.java b/appserver/payara-appserver-modules/security-openid/src/main/java/fish/payara/security/openid/OpenIdAuthenticationMechanism.java\nindex 248ed975c0..fe9b8c4d3e 100644\n--- a/appserver/payara-appserver-modules/security-openid/src/main/java/fish/payara/security/openid/OpenIdAuthenticationMechanism.java\n+++ b/appserver/payara-appserver-modules/security-openid/src/main/java/fish/payara/security/openid/OpenIdAuthenticationMechanism.java\n\n@@ -375,7 +378,7 @@ public class OpenIdAuthenticationMechanism implements HttpAuthenticationMechanis\n             synchronized (OpenIdAuthenticationMechanism.class) {\n                 lock = session.getAttribute(SESSION_LOCK_NAME);\n                 if (isNull(lock)) {\n-                    lock = new Object();\n+                    lock = new Lock();\n                     session.setAttribute(SESSION_LOCK_NAME, lock);\n                 }\n \n"}}, {"oid": "22451563b1ce571419c0061821b5497ccf4c857d", "url": "https://github.com/payara/Payara/commit/22451563b1ce571419c0061821b5497ccf4c857d", "message": "Replaced lock with implementation of Serializable to support session passivation.", "committedDate": "2020-02-09T11:06:08Z", "type": "commit"}]}