{"pr_number": 4949, "pr_title": "FISH-629 Cleanup of deployment/dol module", "pr_createdAt": "2020-10-13T08:55:36Z", "pr_url": "https://github.com/payara/Payara/pull/4949", "timeline": [{"oid": "4ba5493bf383de1e6f392da841442ca0738b8ab3", "url": "https://github.com/payara/Payara/commit/4ba5493bf383de1e6f392da841442ca0738b8ab3", "message": "FISH-629 Cleanup of deployment/dol module", "committedDate": "2020-10-13T08:51:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg1OTYwNA==", "url": "https://github.com/payara/Payara/pull/4949#discussion_r503859604", "bodyText": "This is no longer thread safe, I'd revert this to be safe", "author": "MattGill98", "createdAt": "2020-10-13T11:01:05Z", "path": "appserver/deployment/dol/src/main/java/com/sun/enterprise/deployment/ApplicationClientDescriptor.java", "diffHunk": "@@ -165,25 +160,25 @@ public Collection getNamedDescriptors() {\n     /**\n     * Returns the set of environment properties of this app client.\n     */\n-    public Set getEnvironmentProperties() {\n+    @Override\n+    public Set<EnvironmentProperty> getEnvironmentProperties() {\n \tif (this.environmentProperties == null) {\n-\t    this.environmentProperties = new OrderedSet();\n+\t    this.environmentProperties = new OrderedSet<>();\n \t}\n-\treturn this.environmentProperties = new OrderedSet(this.environmentProperties);\n+\treturn this.environmentProperties = new OrderedSet<>(this.environmentProperties);\n     }\n \n     /**\n      * Returns the environment property object searching on the supplied key.\n      * throws an illegal argument exception if no such environment property exists.\n      */\n+    @Override\n     public EnvironmentProperty getEnvironmentPropertyByName(String name) {\n-\tfor (Iterator itr = this.getEnvironmentProperties().iterator();\n-             itr.hasNext();) {\n-\t    EnvironmentProperty ev = (EnvironmentProperty) itr.next();\n-\t    if (ev.getName().equals(name)) {\n-\t\treturn ev;\n-\t    }\n-\t}\n+        for (EnvironmentProperty ev : this.getEnvironmentProperties()) {", "originalCommit": "4ba5493bf383de1e6f392da841442ca0738b8ab3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3MDg0MQ==", "url": "https://github.com/payara/Payara/pull/4949#discussion_r503870841", "bodyText": "The collection is not being modified, so it doesn't need to create an iterator. All of the for-loop changes were suggested by the IDE.", "author": "Cousjava", "createdAt": "2020-10-13T11:22:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg1OTYwNA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg2MDY0OA==", "url": "https://github.com/payara/Payara/pull/4949#discussion_r503860648", "bodyText": "This comment isn't essential, but a lot of these variables use the implementation as the type, when an interface will probably do", "author": "MattGill98", "createdAt": "2020-10-13T11:03:01Z", "path": "appserver/deployment/dol/src/main/java/com/sun/enterprise/deployment/BundleDescriptor.java", "diffHunk": "@@ -109,7 +106,7 @@\n     private boolean keepState = false;\n     private boolean defaultGroupPrincipalMapping = true;\n \n-    protected HashMap<String, RootXMLNode> rootNodes = new HashMap<String, RootXMLNode>();\n+    protected HashMap<String, RootXMLNode> rootNodes = new HashMap<>();", "originalCommit": "4ba5493bf383de1e6f392da841442ca0738b8ab3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg2MjQ3MA==", "url": "https://github.com/payara/Payara/pull/4949#discussion_r503862470", "bodyText": "This isn't a class variable to it's less important somewhat, but this still isn't thread safe. Whatever we do, I'd update the method so that each of the loops here uses the same convention", "author": "MattGill98", "createdAt": "2020-10-13T11:06:23Z", "path": "appserver/deployment/dol/src/main/java/com/sun/enterprise/deployment/BundleDescriptor.java", "diffHunk": "@@ -388,26 +385,24 @@ public void addRole(SecurityRoleDescriptor descriptor) {\n     /**\n      * Removes a role object from me.\n      */\n+    @Override\n     public void removeRole(Role role) {\n         this.getRoles().remove(role);\n     }\n \n     /**\n      * Utility method for iterating the set of named descriptors in the supplied nameEnvironment\n      */\n-    protected Collection getNamedDescriptorsFrom(JndiNameEnvironment nameEnvironment) {\n-        Collection namedDescriptors = new Vector();\n-        for (Iterator itr = nameEnvironment.getResourceReferenceDescriptors().iterator(); itr.hasNext();) {\n-            ResourceReferenceDescriptor resourceReference = (ResourceReferenceDescriptor) itr.next();\n+    protected Collection<NamedDescriptor> getNamedDescriptorsFrom(JndiNameEnvironment nameEnvironment) {\n+        Collection<NamedDescriptor> namedDescriptors = new Vector<>();\n+        for (ResourceReferenceDescriptor resourceReference : nameEnvironment.getResourceReferenceDescriptors()) {", "originalCommit": "4ba5493bf383de1e6f392da841442ca0738b8ab3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg2MjY3Mg==", "url": "https://github.com/payara/Payara/pull/4949#discussion_r503862672", "bodyText": "Same as above", "author": "MattGill98", "createdAt": "2020-10-13T11:06:48Z", "path": "appserver/deployment/dol/src/main/java/com/sun/enterprise/deployment/BundleDescriptor.java", "diffHunk": "@@ -418,18 +413,15 @@ protected Collection getNamedDescriptorsFrom(JndiNameEnvironment nameEnvironment\n      * Utility method for iterating the set of NameReference pairs in the supplied nameEnvironment\n      */\n     protected Vector<NamedReferencePair> getNamedReferencePairsFrom(JndiNameEnvironment nameEnvironment) {\n-        Vector<NamedReferencePair> pairs = new Vector<NamedReferencePair>();\n-        for (Iterator itr = nameEnvironment.getResourceReferenceDescriptors().iterator(); itr.hasNext();) {\n-            ResourceReferenceDescriptor resourceReference = (ResourceReferenceDescriptor) itr.next();\n+        Vector<NamedReferencePair> pairs = new Vector<>();\n+        for (ResourceReferenceDescriptor resourceReference : nameEnvironment.getResourceReferenceDescriptors()) {", "originalCommit": "4ba5493bf383de1e6f392da841442ca0738b8ab3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg2MzM2NQ==", "url": "https://github.com/payara/Payara/pull/4949#discussion_r503863365", "bodyText": "As above", "author": "MattGill98", "createdAt": "2020-10-13T11:08:11Z", "path": "appserver/deployment/dol/src/main/java/com/sun/enterprise/deployment/BundleDescriptor.java", "diffHunk": "@@ -483,69 +476,50 @@ public InjectionInfo getInjectionInfoByClass(Class clazz,\n         String className = clazz.getName();\n \n         // if it's not in the cache, create a new one\n-        LifecycleCallbackDescriptor postConstructDesc =\n-                getPostConstructDescriptorByClass(className, jndiNameEnv);\n-        String postConstructMethodName = (postConstructDesc != null) ?\n-                postConstructDesc.getLifecycleCallbackMethod() : null;\n-        LifecycleCallbackDescriptor preDestroyDesc =\n-                getPreDestroyDescriptorByClass(className, jndiNameEnv);\n-        String preDestroyMethodName = (preDestroyDesc != null) ?\n-                preDestroyDesc.getLifecycleCallbackMethod() : null;\n-        injectionInfo = new InjectionInfo(className,\n-                postConstructMethodName, preDestroyMethodName,\n-                getInjectableResourcesByClass(className,\n-                        jndiNameEnv));\n+        LifecycleCallbackDescriptor postConstructDesc = getPostConstructDescriptorByClass(className, jndiNameEnv);\n+        String postConstructMethodName = (postConstructDesc != null) ? postConstructDesc.getLifecycleCallbackMethod() : null;\n+        LifecycleCallbackDescriptor preDestroyDesc = getPreDestroyDescriptorByClass(className, jndiNameEnv);\n+        String preDestroyMethodName = (preDestroyDesc != null) ? preDestroyDesc.getLifecycleCallbackMethod() : null;\n+        injectionInfo = new InjectionInfo(className, postConstructMethodName, preDestroyMethodName, getInjectableResourcesByClass(className, jndiNameEnv));\n \n         // store it in the cache and return\n         injectionInfos.put(key, injectionInfo);\n         return injectionInfo;\n     }\n \n-    public LifecycleCallbackDescriptor\n-    getPostConstructDescriptorByClass(String className,\n-                                      JndiNameEnvironment jndiNameEnv) {\n-        for (LifecycleCallbackDescriptor next :\n-                jndiNameEnv.getPostConstructDescriptors()) {\n+    public LifecycleCallbackDescriptor getPostConstructDescriptorByClass(String className, JndiNameEnvironment jndiNameEnv) {\n+        for (LifecycleCallbackDescriptor next : jndiNameEnv.getPostConstructDescriptors()) {\n             if (next.getLifecycleCallbackClass().equals(className)) {\n                 return next;\n             }\n         }\n         return null;\n     }\n \n-    public LifecycleCallbackDescriptor\n-    getPreDestroyDescriptorByClass(String className,\n-                                   JndiNameEnvironment jndiNameEnv) {\n-        for (LifecycleCallbackDescriptor next :\n-                jndiNameEnv.getPreDestroyDescriptors()) {\n+    public LifecycleCallbackDescriptor getPreDestroyDescriptorByClass(String className, JndiNameEnvironment jndiNameEnv) {\n+        for (LifecycleCallbackDescriptor next : jndiNameEnv.getPreDestroyDescriptors()) {\n             if (next.getLifecycleCallbackClass().equals(className)) {\n                 return next;\n             }\n         }\n         return null;\n     }\n \n-    public List<InjectionCapable> getInjectableResources\n-            (JndiNameEnvironment jndiNameEnv) {\n+    public List<InjectionCapable> getInjectableResources(JndiNameEnvironment jndiNameEnv) {\n \n-        List<InjectionCapable> injectables =\n-                new LinkedList<InjectionCapable>();\n+        List<InjectionCapable> injectables = new LinkedList<>();\n \n         addJndiNameEnvironmentInjectables(jndiNameEnv, injectables);\n \n         return injectables;\n     }\n \n-    private void addJndiNameEnvironmentInjectables(JndiNameEnvironment jndiNameEnv,\n-                                                   List<InjectionCapable> injectables) {\n+    private void addJndiNameEnvironmentInjectables(JndiNameEnvironment jndiNameEnv, List<InjectionCapable> injectables) {\n \n-        Collection allEnvProps = new HashSet();\n+        Collection allEnvProps = new HashSet<>();\n \n-        for (Iterator envEntryItr =\n-                jndiNameEnv.getEnvironmentProperties().iterator();\n-             envEntryItr.hasNext();) {\n-            EnvironmentProperty envEntry = (EnvironmentProperty)\n-                    envEntryItr.next();\n+        for (Iterator envEntryItr =jndiNameEnv.getEnvironmentProperties().iterator(); envEntryItr.hasNext();) {", "originalCommit": "4ba5493bf383de1e6f392da841442ca0738b8ab3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}