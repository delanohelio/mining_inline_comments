{"pr_number": 13245, "pr_title": "Modify JPA HybridPersistenceActivator to not key off ClassLoader.", "pr_createdAt": "2020-07-29T21:27:47Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/13245", "timeline": [{"oid": "fb2b56ed25ffbe2d7a5e23b73fdbb80d7d1ee9e7", "url": "https://github.com/OpenLiberty/open-liberty/commit/fb2b56ed25ffbe2d7a5e23b73fdbb80d7d1ee9e7", "message": "Modify JPA HybridPersistenceActivator to not key off ClassLoader.\n\nSigned-off-by: Joe Grassel <jgrassel@us.ibm.com>", "committedDate": "2020-07-30T15:33:04Z", "type": "forcePushed"}, {"oid": "f1c3ee7b33cc2f0c49b074a4c57775f4b3ae578d", "url": "https://github.com/OpenLiberty/open-liberty/commit/f1c3ee7b33cc2f0c49b074a4c57775f4b3ae578d", "message": "Modify JPA HybridPersistenceActivator to not key off ClassLoader.\n\nSigned-off-by: Joe Grassel <jgrassel@us.ibm.com>", "committedDate": "2020-07-30T20:01:17Z", "type": "forcePushed"}, {"oid": "742767556cc65b5717687dd9807115d2c7fa5922", "url": "https://github.com/OpenLiberty/open-liberty/commit/742767556cc65b5717687dd9807115d2c7fa5922", "message": "Modify JPA HybridPersistenceActivator to not key off ClassLoader.\n\nSigned-off-by: Joe Grassel <jgrassel@us.ibm.com>", "committedDate": "2020-08-03T21:51:14Z", "type": "forcePushed"}, {"oid": "49fb0112429a02cc09755b9e6b264e93c07e49b0", "url": "https://github.com/OpenLiberty/open-liberty/commit/49fb0112429a02cc09755b9e6b264e93c07e49b0", "message": "Modify JPA HybridPersistenceActivator to not key off ClassLoader.\n\nSigned-off-by: Joe Grassel <jgrassel@us.ibm.com>", "committedDate": "2020-08-04T17:08:02Z", "type": "forcePushed"}, {"oid": "331525b3ad14ffffa32ce61ff401438596a1144e", "url": "https://github.com/OpenLiberty/open-liberty/commit/331525b3ad14ffffa32ce61ff401438596a1144e", "message": "Modify JPA HybridPersistenceActivator to not key off ClassLoader.\n\nSigned-off-by: Joe Grassel <jgrassel@us.ibm.com>", "committedDate": "2020-08-05T17:49:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjcxMDAzNA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13245#discussion_r466710034", "bodyText": "WeakHashMap is not thread safe.  Nothing is done to give you thread safety when accessing the map.  This can lead to infinite loops.", "author": "jhanders34", "createdAt": "2020-08-06T22:02:11Z", "path": "dev/com.ibm.ws.jpa.hybridpersistenceactivator/src/com/ibm/ws/javaee/persistence/internal/HybridPersistenceActivator.java", "diffHunk": "@@ -23,14 +23,16 @@\n import org.apache.geronimo.osgi.locator.ProviderLocator;\n import org.apache.geronimo.specs.jpa.PersistenceActivator;\n \n+import com.ibm.ws.runtime.metadata.ModuleMetaData;\n+import com.ibm.ws.threadContext.ComponentMetaDataAccessorImpl;\n+\n /**\n  * An override of the default persistence activator that provides a hybrid mechanism\n  * to discover persistence providers by searching for providers available from\n  * META-INF/services in addition to those registered in the OSGi service registry.\n  */\n public class HybridPersistenceActivator extends PersistenceActivator {\n-\n-    private volatile WeakHashMap<ClassLoader, List<PersistenceProvider>> providerCache = new WeakHashMap<ClassLoader, List<PersistenceProvider>>();\n+    private volatile WeakHashMap<ModuleMetaData, List<PersistenceProvider>> providerCache = new WeakHashMap<ModuleMetaData, List<PersistenceProvider>>();", "originalCommit": "331525b3ad14ffffa32ce61ff401438596a1144e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE3MDQ4MA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13245#discussion_r468170480", "bodyText": "Protected map access with a sync block.", "author": "jgrassel", "createdAt": "2020-08-10T20:35:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjcxMDAzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODYyNzIxOQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13245#discussion_r468627219", "bodyText": "@jhanders34 please re-review.", "author": "jgrassel", "createdAt": "2020-08-11T14:31:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjcxMDAzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg5NTcyNg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13245#discussion_r468895726", "bodyText": "Yeah it is going to need some work still.  You are going to have to do like the previous code to do the put after you populate the List.  If you don't you can erroneously return an empty or partial list in another thread.", "author": "jhanders34", "createdAt": "2020-08-11T22:17:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjcxMDAzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQ5OTAyMA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13245#discussion_r469499020", "bodyText": "Believe this is addressed now.", "author": "jgrassel", "createdAt": "2020-08-12T19:45:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjcxMDAzNA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "a0df5abc00f17fdd2f1efd3e7fb4bcb43bd877d2", "url": "https://github.com/OpenLiberty/open-liberty/commit/a0df5abc00f17fdd2f1efd3e7fb4bcb43bd877d2", "message": "Modify JPA HybridPersistenceActivator to not key off ClassLoader.\n\nSigned-off-by: Joe Grassel <jgrassel@us.ibm.com>", "committedDate": "2020-08-10T17:24:38Z", "type": "commit"}, {"oid": "7bd2fad07b551608d4d35d6503ea3daa44e2fadd", "url": "https://github.com/OpenLiberty/open-liberty/commit/7bd2fad07b551608d4d35d6503ea3daa44e2fadd", "message": "Modify JPA HybridPersistenceActivator to not key off ClassLoader (review updates) #13245\n\nSigned-off-by: Joe Grassel <jgrassel@us.ibm.com>", "committedDate": "2020-08-10T20:34:03Z", "type": "forcePushed"}, {"oid": "2b7cd1fbae31802acb85ffc9da863c1c88c9acd4", "url": "https://github.com/OpenLiberty/open-liberty/commit/2b7cd1fbae31802acb85ffc9da863c1c88c9acd4", "message": "Modify JPA HybridPersistenceActivator to not key off ClassLoader (review updates) #13245\n\nSigned-off-by: Joe Grassel <jgrassel@us.ibm.com>", "committedDate": "2020-08-11T14:28:19Z", "type": "forcePushed"}, {"oid": "39a9b9ff214d6ba7f54da3bdc08830fea9a60321", "url": "https://github.com/OpenLiberty/open-liberty/commit/39a9b9ff214d6ba7f54da3bdc08830fea9a60321", "message": "Modify JPA HybridPersistenceActivator to not key off ClassLoader (review updates) #13245\n\nSigned-off-by: Joe Grassel <jgrassel@us.ibm.com>", "committedDate": "2020-08-12T19:45:00Z", "type": "commit"}, {"oid": "39a9b9ff214d6ba7f54da3bdc08830fea9a60321", "url": "https://github.com/OpenLiberty/open-liberty/commit/39a9b9ff214d6ba7f54da3bdc08830fea9a60321", "message": "Modify JPA HybridPersistenceActivator to not key off ClassLoader (review updates) #13245\n\nSigned-off-by: Joe Grassel <jgrassel@us.ibm.com>", "committedDate": "2020-08-12T19:45:00Z", "type": "forcePushed"}, {"oid": "54fce2b1d8994a12a50a12bb3462dd936ae5150b", "url": "https://github.com/OpenLiberty/open-liberty/commit/54fce2b1d8994a12a50a12bb3462dd936ae5150b", "message": " Modify JPA HybridPersistenceActivator to not key off ClassLoader (review updates, private jpa base features) #13245\n\nSigned-off-by: Joe Grassel <jgrassel@us.ibm.com>", "committedDate": "2020-08-13T14:35:01Z", "type": "commit"}]}