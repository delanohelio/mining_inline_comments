{"pr_number": 10671, "pr_title": "Fix for Issue #10670: Allow JAX-RS Application.getSingletons() to handle CDI proxy classes", "pr_createdAt": "2020-01-31T14:50:24Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/10671", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU5MjQ3MA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10671#discussion_r373592470", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import static org.junit.Assert.assertTrue;\n          \n          \n            \n            import static org.junit.Assert.assertEquals;\n          \n      \n    \n    \n  \n\nThis should make a better failure message if the verifySuccess method fails.", "author": "andymc12", "createdAt": "2020-01-31T17:21:11Z", "path": "dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/fat/src/com/ibm/ws/jaxrs20/cdi12/fat/test/ContextandCDI12Test.java", "diffHunk": "@@ -0,0 +1,205 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package com.ibm.ws.jaxrs20.cdi12.fat.test;\n+\n+import static org.junit.Assert.assertTrue;", "originalCommit": "c7675e56c8f3711d1b3d5874a69626d0adc3dc40", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c4aceea6fd4bfa5f3b306873460bea44e38d62f9", "chunk": "diff --git a/dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/fat/src/com/ibm/ws/jaxrs20/cdi12/fat/test/ContextandCDI12Test.java b/dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/fat/src/com/ibm/ws/jaxrs20/cdi12/fat/test/ContextandCDI12Test.java\nindex 8a44820951..3dfebf872a 100644\n--- a/dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/fat/src/com/ibm/ws/jaxrs20/cdi12/fat/test/ContextandCDI12Test.java\n+++ b/dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/fat/src/com/ibm/ws/jaxrs20/cdi12/fat/test/ContextandCDI12Test.java\n\n@@ -10,7 +10,7 @@\n  *******************************************************************************/\n package com.ibm.ws.jaxrs20.cdi12.fat.test;\n \n-import static org.junit.Assert.assertTrue;\n+import static org.junit.Assert.assertEquals;\n \n import java.util.List;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU5NzYxNg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10671#discussion_r373597616", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertTrue(\"Expect to get CDI test message: \" + message, messages.size() == messageSize);\n          \n          \n            \n                    assertEquals(\"Expect to get CDI init test message: \" + message, messageSize, messages.size());", "author": "andymc12", "createdAt": "2020-01-31T17:33:48Z", "path": "dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/fat/src/com/ibm/ws/jaxrs20/cdi12/fat/test/ContextandCDI12Test.java", "diffHunk": "@@ -0,0 +1,205 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package com.ibm.ws.jaxrs20.cdi12.fat.test;\n+\n+import static org.junit.Assert.assertTrue;\n+\n+import java.util.List;\n+\n+import org.jboss.shrinkwrap.api.spec.WebArchive;\n+import org.junit.After;\n+import org.junit.AfterClass;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+import com.ibm.websphere.simplicity.ShrinkHelper;\n+\n+import componenttest.annotation.Server;\n+import componenttest.custom.junit.runner.FATRunner;\n+import componenttest.topology.impl.LibertyServer;\n+\n+@RunWith(FATRunner.class)\n+public class ContextandCDI12Test extends AbstractTest {\n+\n+    public static final String[] ignore_messages =  new String[] { \"CWWKW1001W\" , \"CWWKW1002W\" , \"CWWKE1102W\", \"CWWKE1106W\" , \"CWWKE1107W\" };\n+\n+    @Server(\"com.ibm.ws.jaxrs20.cdi12.fat.contextandCDI\")\n+    public static LibertyServer server;\n+\n+    @BeforeClass\n+    public static void setUp() throws Exception {\n+        appname = \"contextandCDI\";\n+        WebArchive app = ShrinkHelper.defaultDropinApp(server, appname, \"com.ibm.ws.jaxrs20.cdi12.fat.contextandCDI\");\n+//        server.startServer();\n+    }\n+\n+    @AfterClass\n+    public static void tearDown() throws Exception {\n+        server.stopServer(ignore_messages);\n+    }\n+\n+    @Before\n+    public void preTest() {\n+        serverRef = server;\n+    }\n+\n+    @After\n+    public void afterTest() {\n+        serverRef = null;\n+    }\n+    \n+    \n+    public void verifySuccess(String filterName, int messageSize) throws Exception {\n+        String message = filterName + \"#init: servletContext.getServletContextName contextandCDI\";        \n+        List<String> messages = serverRef.findStringsInLogs(message);\n+        assertTrue(\"Expect to get CDI test message: \" + message, messages.size() == messageSize);", "originalCommit": "c7675e56c8f3711d1b3d5874a69626d0adc3dc40", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c4aceea6fd4bfa5f3b306873460bea44e38d62f9", "chunk": "diff --git a/dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/fat/src/com/ibm/ws/jaxrs20/cdi12/fat/test/ContextandCDI12Test.java b/dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/fat/src/com/ibm/ws/jaxrs20/cdi12/fat/test/ContextandCDI12Test.java\nindex 8a44820951..3dfebf872a 100644\n--- a/dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/fat/src/com/ibm/ws/jaxrs20/cdi12/fat/test/ContextandCDI12Test.java\n+++ b/dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/fat/src/com/ibm/ws/jaxrs20/cdi12/fat/test/ContextandCDI12Test.java\n\n@@ -10,7 +10,7 @@\n  *******************************************************************************/\n package com.ibm.ws.jaxrs20.cdi12.fat.test;\n \n-import static org.junit.Assert.assertTrue;\n+import static org.junit.Assert.assertEquals;\n \n import java.util.List;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU5Nzg2Ng==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10671#discussion_r373597866", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertTrue(\"Expect to get CDI test message: \" + message, messages.size() == messageSize); \n          \n          \n            \n                    assertEquals(\"Expect to get CDI request test message: \" + message, messageSize, messages.size());", "author": "andymc12", "createdAt": "2020-01-31T17:34:23Z", "path": "dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/fat/src/com/ibm/ws/jaxrs20/cdi12/fat/test/ContextandCDI12Test.java", "diffHunk": "@@ -0,0 +1,205 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package com.ibm.ws.jaxrs20.cdi12.fat.test;\n+\n+import static org.junit.Assert.assertTrue;\n+\n+import java.util.List;\n+\n+import org.jboss.shrinkwrap.api.spec.WebArchive;\n+import org.junit.After;\n+import org.junit.AfterClass;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+import com.ibm.websphere.simplicity.ShrinkHelper;\n+\n+import componenttest.annotation.Server;\n+import componenttest.custom.junit.runner.FATRunner;\n+import componenttest.topology.impl.LibertyServer;\n+\n+@RunWith(FATRunner.class)\n+public class ContextandCDI12Test extends AbstractTest {\n+\n+    public static final String[] ignore_messages =  new String[] { \"CWWKW1001W\" , \"CWWKW1002W\" , \"CWWKE1102W\", \"CWWKE1106W\" , \"CWWKE1107W\" };\n+\n+    @Server(\"com.ibm.ws.jaxrs20.cdi12.fat.contextandCDI\")\n+    public static LibertyServer server;\n+\n+    @BeforeClass\n+    public static void setUp() throws Exception {\n+        appname = \"contextandCDI\";\n+        WebArchive app = ShrinkHelper.defaultDropinApp(server, appname, \"com.ibm.ws.jaxrs20.cdi12.fat.contextandCDI\");\n+//        server.startServer();\n+    }\n+\n+    @AfterClass\n+    public static void tearDown() throws Exception {\n+        server.stopServer(ignore_messages);\n+    }\n+\n+    @Before\n+    public void preTest() {\n+        serverRef = server;\n+    }\n+\n+    @After\n+    public void afterTest() {\n+        serverRef = null;\n+    }\n+    \n+    \n+    public void verifySuccess(String filterName, int messageSize) throws Exception {\n+        String message = filterName + \"#init: servletContext.getServletContextName contextandCDI\";        \n+        List<String> messages = serverRef.findStringsInLogs(message);\n+        assertTrue(\"Expect to get CDI test message: \" + message, messages.size() == messageSize);\n+        message = filterName + \"#filter#requestContext: servletContext.getServletContextName contextandCDI\";        \n+        messages = serverRef.findStringsInLogs(message);\n+        assertTrue(\"Expect to get CDI test message: \" + message, messages.size() == messageSize); ", "originalCommit": "c7675e56c8f3711d1b3d5874a69626d0adc3dc40", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c4aceea6fd4bfa5f3b306873460bea44e38d62f9", "chunk": "diff --git a/dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/fat/src/com/ibm/ws/jaxrs20/cdi12/fat/test/ContextandCDI12Test.java b/dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/fat/src/com/ibm/ws/jaxrs20/cdi12/fat/test/ContextandCDI12Test.java\nindex 8a44820951..3dfebf872a 100644\n--- a/dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/fat/src/com/ibm/ws/jaxrs20/cdi12/fat/test/ContextandCDI12Test.java\n+++ b/dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/fat/src/com/ibm/ws/jaxrs20/cdi12/fat/test/ContextandCDI12Test.java\n\n@@ -10,7 +10,7 @@\n  *******************************************************************************/\n package com.ibm.ws.jaxrs20.cdi12.fat.test;\n \n-import static org.junit.Assert.assertTrue;\n+import static org.junit.Assert.assertEquals;\n \n import java.util.List;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU5OTUyNw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10671#discussion_r373599527", "bodyText": "These should be put in the @Before (to start the server) and @After (to stop it) methods - both methods might need to throw Exception.  Once in those methods, it will apply to all tests, so you can remove these lines from each test method.", "author": "andymc12", "createdAt": "2020-01-31T17:38:30Z", "path": "dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/fat/src/com/ibm/ws/jaxrs20/cdi12/fat/test/ContextandCDI12Test.java", "diffHunk": "@@ -0,0 +1,205 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package com.ibm.ws.jaxrs20.cdi12.fat.test;\n+\n+import static org.junit.Assert.assertTrue;\n+\n+import java.util.List;\n+\n+import org.jboss.shrinkwrap.api.spec.WebArchive;\n+import org.junit.After;\n+import org.junit.AfterClass;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+import com.ibm.websphere.simplicity.ShrinkHelper;\n+\n+import componenttest.annotation.Server;\n+import componenttest.custom.junit.runner.FATRunner;\n+import componenttest.topology.impl.LibertyServer;\n+\n+@RunWith(FATRunner.class)\n+public class ContextandCDI12Test extends AbstractTest {\n+\n+    public static final String[] ignore_messages =  new String[] { \"CWWKW1001W\" , \"CWWKW1002W\" , \"CWWKE1102W\", \"CWWKE1106W\" , \"CWWKE1107W\" };\n+\n+    @Server(\"com.ibm.ws.jaxrs20.cdi12.fat.contextandCDI\")\n+    public static LibertyServer server;\n+\n+    @BeforeClass\n+    public static void setUp() throws Exception {\n+        appname = \"contextandCDI\";\n+        WebArchive app = ShrinkHelper.defaultDropinApp(server, appname, \"com.ibm.ws.jaxrs20.cdi12.fat.contextandCDI\");\n+//        server.startServer();\n+    }\n+\n+    @AfterClass\n+    public static void tearDown() throws Exception {\n+        server.stopServer(ignore_messages);\n+    }\n+\n+    @Before\n+    public void preTest() {\n+        serverRef = server;\n+    }\n+\n+    @After\n+    public void afterTest() {\n+        serverRef = null;\n+    }\n+    \n+    \n+    public void verifySuccess(String filterName, int messageSize) throws Exception {\n+        String message = filterName + \"#init: servletContext.getServletContextName contextandCDI\";        \n+        List<String> messages = serverRef.findStringsInLogs(message);\n+        assertTrue(\"Expect to get CDI test message: \" + message, messages.size() == messageSize);\n+        message = filterName + \"#filter#requestContext: servletContext.getServletContextName contextandCDI\";        \n+        messages = serverRef.findStringsInLogs(message);\n+        assertTrue(\"Expect to get CDI test message: \" + message, messages.size() == messageSize); \n+    }\n+\n+    @Test\n+    public void testContextandCDIResource1() throws Exception {\n+        if (server.isStarted()) {\n+            server.stopServer(ignore_messages); \n+        }        \n+        server.startServer(true);        ", "originalCommit": "c7675e56c8f3711d1b3d5874a69626d0adc3dc40", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c4aceea6fd4bfa5f3b306873460bea44e38d62f9", "chunk": "diff --git a/dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/fat/src/com/ibm/ws/jaxrs20/cdi12/fat/test/ContextandCDI12Test.java b/dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/fat/src/com/ibm/ws/jaxrs20/cdi12/fat/test/ContextandCDI12Test.java\nindex 8a44820951..3dfebf872a 100644\n--- a/dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/fat/src/com/ibm/ws/jaxrs20/cdi12/fat/test/ContextandCDI12Test.java\n+++ b/dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/fat/src/com/ibm/ws/jaxrs20/cdi12/fat/test/ContextandCDI12Test.java\n\n@@ -10,7 +10,7 @@\n  *******************************************************************************/\n package com.ibm.ws.jaxrs20.cdi12.fat.test;\n \n-import static org.junit.Assert.assertTrue;\n+import static org.junit.Assert.assertEquals;\n \n import java.util.List;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzYwMTY0Ng==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10671#discussion_r373601646", "bodyText": "Just a thought, but maybe this method could be put in some utils class so that we only need it in one place - then all of the getSingletons() methods that need to invoke it could just call CDIUtils.getBean(<resourceClass>);. What do you think?", "author": "andymc12", "createdAt": "2020-01-31T17:43:16Z", "path": "dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/test-applications/contextandCDI/src/com/ibm/ws/jaxrs20/cdi12/fat/contextandCDI/CDIApplication22.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package com.ibm.ws.jaxrs20.cdi12.fat.contextandCDI;\n+\n+import java.lang.annotation.Annotation;\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.LinkedHashSet;\n+import java.util.Set;\n+\n+import javax.enterprise.inject.Instance;\n+import javax.enterprise.inject.spi.CDI;\n+import javax.ws.rs.ApplicationPath;\n+import javax.ws.rs.core.Application;\n+import javax.enterprise.context.Dependent;\n+\n+@Dependent\n+@ApplicationPath(\"contextandCDI22\")\n+public class CDIApplication22 extends Application {\n+\n+    @Override\n+    public Set<Class<?>> getClasses() {\n+\n+        LinkedHashSet<Class<?>> classes = new LinkedHashSet<>();\n+        classes.add(CDIFilter.class);\n+        return classes;\n+        \n+    }\n+    \n+    @Override\n+    public Set<Object> getSingletons() {\n+       \n+        LinkedHashSet<Object> classes = new LinkedHashSet<>();\n+        TestResource resource = getBean(TestResource.class);\n+//        TestResource resource = new TestResource();\n+        classes.add(resource);\n+        return classes;\n+    }\n+    \n+    public <E> E getBean(Class<E> clazz, Annotation... qualifiers) {", "originalCommit": "c7675e56c8f3711d1b3d5874a69626d0adc3dc40", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c4aceea6fd4bfa5f3b306873460bea44e38d62f9", "chunk": "diff --git a/dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/test-applications/contextandCDI/src/com/ibm/ws/jaxrs20/cdi12/fat/contextandCDI/CDIApplication22.java b/dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/test-applications/contextandCDI/src/com/ibm/ws/jaxrs20/cdi12/fat/contextandCDI/CDIApplication22.java\nindex 21d3d0fe08..d82e86d91a 100644\n--- a/dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/test-applications/contextandCDI/src/com/ibm/ws/jaxrs20/cdi12/fat/contextandCDI/CDIApplication22.java\n+++ b/dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/test-applications/contextandCDI/src/com/ibm/ws/jaxrs20/cdi12/fat/contextandCDI/CDIApplication22.java\n\n@@ -39,24 +39,9 @@ public class CDIApplication22 extends Application {\n     public Set<Object> getSingletons() {\n        \n         LinkedHashSet<Object> classes = new LinkedHashSet<>();\n-        TestResource resource = getBean(TestResource.class);\n-//        TestResource resource = new TestResource();\n+        TestResource resource = CDIUtils.getBean(TestResource.class);\n         classes.add(resource);\n         return classes;\n     }\n-    \n-    public <E> E getBean(Class<E> clazz, Annotation... qualifiers) {\n-\n-        Instance<E> instance = CDI.current().select(clazz, qualifiers);\n-\n-        if (instance.isUnsatisfied()) {\n-            throw new RuntimeException();\n-        }\n-        if (instance.isAmbiguous()) {\n-            throw new RuntimeException();\n-        }\n-\n-        return instance.get();\n-    }\n }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzYwMjU2Mw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10671#discussion_r373602563", "bodyText": "Just a thought here... I think it is also possible for CDI to inject the ServletContext (using @Inject ServletContext servletContext2; - maybe we could include this in the test too?  That would ensure that ServletContext injection works regardless of who injects it.", "author": "andymc12", "createdAt": "2020-01-31T17:45:25Z", "path": "dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/test-applications/contextandCDI/src/com/ibm/ws/jaxrs20/cdi12/fat/contextandCDI/CDIFilter.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package com.ibm.ws.jaxrs20.cdi12.fat.contextandCDI;\n+\n+import java.io.IOException;\n+\n+import javax.annotation.PostConstruct;\n+import javax.enterprise.context.ApplicationScoped;\n+import javax.inject.Inject;\n+import javax.servlet.ServletContext;\n+import javax.ws.rs.container.ContainerRequestContext;\n+import javax.ws.rs.container.ContainerRequestFilter;\n+import javax.ws.rs.container.ContainerResponseContext;\n+import javax.ws.rs.container.ContainerResponseFilter;\n+import javax.ws.rs.core.Context;\n+\n+@ApplicationScoped\n+public class CDIFilter implements ContainerRequestFilter, ContainerResponseFilter {\n+\n+    @Context ServletContext servletContext;", "originalCommit": "c7675e56c8f3711d1b3d5874a69626d0adc3dc40", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c4aceea6fd4bfa5f3b306873460bea44e38d62f9", "chunk": "diff --git a/dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/test-applications/contextandCDI/src/com/ibm/ws/jaxrs20/cdi12/fat/contextandCDI/CDIFilter.java b/dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/test-applications/contextandCDI/src/com/ibm/ws/jaxrs20/cdi12/fat/contextandCDI/CDIFilter.java\nindex 069a1b5a38..3d59479733 100644\n--- a/dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/test-applications/contextandCDI/src/com/ibm/ws/jaxrs20/cdi12/fat/contextandCDI/CDIFilter.java\n+++ b/dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/test-applications/contextandCDI/src/com/ibm/ws/jaxrs20/cdi12/fat/contextandCDI/CDIFilter.java\n\n@@ -26,21 +26,25 @@ import javax.ws.rs.core.Context;\n public class CDIFilter implements ContainerRequestFilter, ContainerResponseFilter {\n \n     @Context ServletContext servletContext;\n+    @Inject ServletContext servletContext2; \n \n     @PostConstruct\n     public void init() {\n         System.out.println(\"CDIFilter#init: servletContext.getContextPath \" + servletContext.getContextPath() );         \n         System.out.println(\"CDIFilter#init: servletContext.getServletContextName \" + servletContext.getServletContextName() );\n+        System.out.println(\"CDIFilter#init: servletContext.getServletContextName2 \" + servletContext2.getServletContextName() );\n         new Exception(\"CDIFilter#init \").printStackTrace(System.out);\n     }\n \n     public void filter(ContainerRequestContext requestContext) throws IOException {        \n-        System.out.println(\"CDIFilter#filter#requestContext: servletContext.getServletContextName \" + servletContext.getServletContextName() );        \n+        System.out.println(\"CDIFilter#filter#requestContext: servletContext.getServletContextName \" + servletContext.getServletContextName() );\n+        System.out.println(\"CDIFilter#filter#requestContext: servletContext.getServletContextName2 \" + servletContext2.getServletContextName() );\n         new Exception(\"CDIFilter#filter \").printStackTrace(System.out);\n     }\n     \n     public void filter(ContainerRequestContext reqContext, ContainerResponseContext responseContext) throws IOException {        \n-        System.out.println(\"CDIFilter#filter#responseContext: servletContext.getServletContextName \"  + servletContext.getServletContextName());        \n+        System.out.println(\"CDIFilter#filter#responseContext: servletContext.getServletContextName \"  + servletContext.getServletContextName());\n+        System.out.println(\"CDIFilter#filter#responseContext: servletContext.getServletContextName2 \" + servletContext2.getServletContextName() );\n     }\n \n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzYwMzczNw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10671#discussion_r373603737", "bodyText": "It might be good to test ServletContext injection in the resource classes too.", "author": "andymc12", "createdAt": "2020-01-31T17:48:08Z", "path": "dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/test-applications/contextandCDI/src/com/ibm/ws/jaxrs20/cdi12/fat/contextandCDI/TestResource.java", "diffHunk": "@@ -0,0 +1,28 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package com.ibm.ws.jaxrs20.cdi12.fat.contextandCDI;\n+\n+\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.core.Response;\n+\n+import javax.enterprise.context.ApplicationScoped;\n+\n+@ApplicationScoped\n+@Path(\"resource\")\n+public class TestResource {\n+", "originalCommit": "c7675e56c8f3711d1b3d5874a69626d0adc3dc40", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c4aceea6fd4bfa5f3b306873460bea44e38d62f9", "chunk": "diff --git a/dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/test-applications/contextandCDI/src/com/ibm/ws/jaxrs20/cdi12/fat/contextandCDI/TestResource.java b/dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/test-applications/contextandCDI/src/com/ibm/ws/jaxrs20/cdi12/fat/contextandCDI/TestResource.java\nindex 4cad4e2e32..c6edcf396c 100644\n--- a/dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/test-applications/contextandCDI/src/com/ibm/ws/jaxrs20/cdi12/fat/contextandCDI/TestResource.java\n+++ b/dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/test-applications/contextandCDI/src/com/ibm/ws/jaxrs20/cdi12/fat/contextandCDI/TestResource.java\n\n@@ -13,16 +13,24 @@ package com.ibm.ws.jaxrs20.cdi12.fat.contextandCDI;\n \n import javax.ws.rs.GET;\n import javax.ws.rs.Path;\n+import javax.ws.rs.core.Context;\n import javax.ws.rs.core.Response;\n \n import javax.enterprise.context.ApplicationScoped;\n+import javax.inject.Inject;\n+import javax.servlet.ServletContext;\n \n @ApplicationScoped\n @Path(\"resource\")\n public class TestResource {\n+    \n+    @Context ServletContext servletContext;\n+    @Inject ServletContext servletContext2; \n \n     @GET\n-    public Response get() {\n+    public Response get() {                 \n+        System.out.println(\"TestResource#get: servletContext.getServletContextName \" + servletContext.getServletContextName() );\n+        System.out.println(\"TestResource#get: servletContext.getServletContextName2 \" + servletContext2.getServletContextName() );\n         return Response.ok(\"ok\").build();\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzYwNDU1NA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10671#discussion_r373604554", "bodyText": "It seems weird to be importing an \"internal\" package.  Please make sure that the CDI team is ok with us using this class - possibly a better approach would be to put CDI Utils in a different (more public) package.", "author": "andymc12", "createdAt": "2020-01-31T17:50:08Z", "path": "dev/com.ibm.ws.jaxrs.2.0.cdi/src/com/ibm/ws/jaxrs20/cdi/component/JaxRsFactoryImplicitBeanCDICustomizer.java", "diffHunk": "@@ -50,6 +50,7 @@\n import com.ibm.websphere.ras.TraceComponent;\n import com.ibm.websphere.ras.annotation.Trivial;\n import com.ibm.ws.cdi.CDIService;\n+import com.ibm.ws.cdi.internal.interfaces.CDIUtils;", "originalCommit": "c7675e56c8f3711d1b3d5874a69626d0adc3dc40", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDE0ODA1Ng==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10671#discussion_r374148056", "bodyText": "Ben's new PR #10690", "author": "jkoehler22", "createdAt": "2020-02-03T14:56:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzYwNDU1NA=="}], "type": "inlineReview", "revised_code": {"commit": "41bbc4a1a135e470c48f2b62d9dd7c9f81fa1d02", "chunk": "diff --git a/dev/com.ibm.ws.jaxrs.2.0.cdi/src/com/ibm/ws/jaxrs20/cdi/component/JaxRsFactoryImplicitBeanCDICustomizer.java b/dev/com.ibm.ws.jaxrs.2.0.cdi/src/com/ibm/ws/jaxrs20/cdi/component/JaxRsFactoryImplicitBeanCDICustomizer.java\nindex a0590fd1a6..cd9da37bef 100644\n--- a/dev/com.ibm.ws.jaxrs.2.0.cdi/src/com/ibm/ws/jaxrs20/cdi/component/JaxRsFactoryImplicitBeanCDICustomizer.java\n+++ b/dev/com.ibm.ws.jaxrs.2.0.cdi/src/com/ibm/ws/jaxrs20/cdi/component/JaxRsFactoryImplicitBeanCDICustomizer.java\n\n@@ -50,7 +50,6 @@ import com.ibm.websphere.ras.Tr;\n import com.ibm.websphere.ras.TraceComponent;\n import com.ibm.websphere.ras.annotation.Trivial;\n import com.ibm.ws.cdi.CDIService;\n-import com.ibm.ws.cdi.internal.interfaces.CDIUtils;\n import com.ibm.ws.container.service.app.deploy.ApplicationInfo;\n import com.ibm.ws.container.service.state.ApplicationStateListener;\n import com.ibm.ws.container.service.state.StateChangeException;\n"}}, {"oid": "c4aceea6fd4bfa5f3b306873460bea44e38d62f9", "url": "https://github.com/OpenLiberty/open-liberty/commit/c4aceea6fd4bfa5f3b306873460bea44e38d62f9", "message": "Issue #10670: Allow JAX-RS Application.getSingletons() to handle CDI proxy classes Andy's Comments-2", "committedDate": "2020-02-04T14:06:57Z", "type": "forcePushed"}, {"oid": "3256e7426133e6a24027bc8bac5497cad5c09232", "url": "https://github.com/OpenLiberty/open-liberty/commit/3256e7426133e6a24027bc8bac5497cad5c09232", "message": "Issue #10670: Allow JAX-RS Application.getSingletons() to handle CDI proxy classes", "committedDate": "2020-02-04T20:38:02Z", "type": "commit"}, {"oid": "7f19d6aa024983f7cc037f3324191c61f4e93c9b", "url": "https://github.com/OpenLiberty/open-liberty/commit/7f19d6aa024983f7cc037f3324191c61f4e93c9b", "message": "Issue #10670: Allow JAX-RS Application.getSingletons() to handle CDI proxy classes Andy's Comments", "committedDate": "2020-02-04T20:38:03Z", "type": "commit"}, {"oid": "12f0315f60abe289988e5b5bfcb6a9008b59550c", "url": "https://github.com/OpenLiberty/open-liberty/commit/12f0315f60abe289988e5b5bfcb6a9008b59550c", "message": "Issue #10670: Allow JAX-RS Application.getSingletons() to handle CDI proxy classes Andy's Comments-2", "committedDate": "2020-02-04T20:38:03Z", "type": "commit"}, {"oid": "41bbc4a1a135e470c48f2b62d9dd7c9f81fa1d02", "url": "https://github.com/OpenLiberty/open-liberty/commit/41bbc4a1a135e470c48f2b62d9dd7c9f81fa1d02", "message": "Issue #10670: Allow JAX-RS Application.getSingletons() to handle CDI proxy classes Andy's Comments-3", "committedDate": "2020-02-04T20:38:03Z", "type": "commit"}, {"oid": "41bbc4a1a135e470c48f2b62d9dd7c9f81fa1d02", "url": "https://github.com/OpenLiberty/open-liberty/commit/41bbc4a1a135e470c48f2b62d9dd7c9f81fa1d02", "message": "Issue #10670: Allow JAX-RS Application.getSingletons() to handle CDI proxy classes Andy's Comments-3", "committedDate": "2020-02-04T20:38:03Z", "type": "forcePushed"}, {"oid": "21b99a63ff73321849d16e80bbf74e63700788d6", "url": "https://github.com/OpenLiberty/open-liberty/commit/21b99a63ff73321849d16e80bbf74e63700788d6", "message": "Issue #10670: Allow JAX-RS Application.getSingletons() to handle CDI proxy classes Andy's Comments-3", "committedDate": "2020-02-04T20:42:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkzNjc3MA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10671#discussion_r374936770", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            @SessionScoped@ApplicationPath(\"contextandCDI32\")\n          \n          \n            \n            @SessionScoped\n          \n          \n            \n            @ApplicationPath(\"contextandCDI32\")\n          \n      \n    \n    \n  \n\nDoes this work?  I would've expected that white space would be required between two annotations...", "author": "andymc12", "createdAt": "2020-02-04T21:37:05Z", "path": "dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/test-applications/contextandCDI/src/com/ibm/ws/jaxrs20/cdi12/fat/contextandCDI/CDIApplication32.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package com.ibm.ws.jaxrs20.cdi12.fat.contextandCDI;\n+\n+import java.lang.annotation.Annotation;\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.LinkedHashSet;\n+import java.util.Set;\n+\n+import javax.enterprise.inject.Instance;\n+import javax.enterprise.inject.spi.CDI;\n+import javax.ws.rs.ApplicationPath;\n+import javax.ws.rs.core.Application;\n+import javax.enterprise.context.SessionScoped;\n+import java.io.Serializable;\n+\n+@SessionScoped@ApplicationPath(\"contextandCDI32\")", "originalCommit": "21b99a63ff73321849d16e80bbf74e63700788d6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "afb610eee35ea8d1bbd494eff32530c4891237c6", "chunk": "diff --git a/dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/test-applications/contextandCDI/src/com/ibm/ws/jaxrs20/cdi12/fat/contextandCDI/CDIApplication32.java b/dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/test-applications/contextandCDI/src/com/ibm/ws/jaxrs20/cdi12/fat/contextandCDI/CDIApplication32.java\nindex 9437b48730..1e62ccdaa5 100644\n--- a/dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/test-applications/contextandCDI/src/com/ibm/ws/jaxrs20/cdi12/fat/contextandCDI/CDIApplication32.java\n+++ b/dev/com.ibm.ws.jaxrs.2.0.cdi.1.2_fat/test-applications/contextandCDI/src/com/ibm/ws/jaxrs20/cdi12/fat/contextandCDI/CDIApplication32.java\n\n@@ -23,7 +23,8 @@ import javax.ws.rs.core.Application;\n import javax.enterprise.context.SessionScoped;\n import java.io.Serializable;\n \n-@SessionScoped@ApplicationPath(\"contextandCDI32\")\n+@SessionScoped\n+@ApplicationPath(\"contextandCDI32\")\n public class CDIApplication32 extends Application implements Serializable {\n \n     @Override\n"}}, {"oid": "afb610eee35ea8d1bbd494eff32530c4891237c6", "url": "https://github.com/OpenLiberty/open-liberty/commit/afb610eee35ea8d1bbd494eff32530c4891237c6", "message": "Issue #10670: Allow JAX-RS Application.getSingletons() to handle CDI proxy classes Andy's Comments-4", "committedDate": "2020-02-04T22:08:10Z", "type": "commit"}]}