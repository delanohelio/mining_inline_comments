{"pr_number": 10990, "pr_title": "jaxrs - return a HTTP 400 instead of 500 when a POST request contains invalid json", "pr_createdAt": "2020-02-20T22:07:45Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/10990", "timeline": [{"oid": "24e1593335862bcc8e20864bb0f2d89572127d95", "url": "https://github.com/OpenLiberty/open-liberty/commit/24e1593335862bcc8e20864bb0f2d89572127d95", "message": "jaxrs - return a HTTP 400 instead of 500 when a POST request contains invalid json", "committedDate": "2020-02-26T20:51:47Z", "type": "forcePushed"}, {"oid": "d1da3adaa1a553049a4b5eb856d6d676e85ce51b", "url": "https://github.com/OpenLiberty/open-liberty/commit/d1da3adaa1a553049a4b5eb856d6d676e85ce51b", "message": "create a jaxrs FAT test to test invalid JSON", "committedDate": "2020-02-28T17:04:07Z", "type": "forcePushed"}, {"oid": "62740f9245baa13eabe3be15286ece304ef53553", "url": "https://github.com/OpenLiberty/open-liberty/commit/62740f9245baa13eabe3be15286ece304ef53553", "message": "create jaxrs FAT test to test invalid JSON", "committedDate": "2020-03-02T16:59:12Z", "type": "forcePushed"}, {"oid": "295d9edbd971ca98876295f97dae97100715252d", "url": "https://github.com/OpenLiberty/open-liberty/commit/295d9edbd971ca98876295f97dae97100715252d", "message": "10986 - test invalid JSON in a jaxrs request", "committedDate": "2020-03-02T17:07:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUzMzQ3Ng==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10990#discussion_r386533476", "bodyText": "What an oddly-specific vehicle... ;-)", "author": "andymc12", "createdAt": "2020-03-02T17:20:53Z", "path": "dev/com.ibm.ws.jaxrs.2.0_fat/test-applications/simpleJson/src/com/ibm/ws/jaxrs/fat/simpleJson/JaxrsJsonClientTestServlet.java", "diffHunk": "@@ -0,0 +1,114 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package com.ibm.ws.jaxrs.fat.simpleJson;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.fail;\n+\n+import javax.servlet.ServletException;\n+import javax.servlet.annotation.WebServlet;\n+import javax.ws.rs.client.Client;\n+import javax.ws.rs.client.ClientBuilder;\n+import javax.ws.rs.client.Entity;\n+import javax.ws.rs.client.ResponseProcessingException;\n+import javax.ws.rs.core.MediaType;\n+import javax.ws.rs.core.Response;\n+\n+import org.apache.http.HttpResponse;\n+import org.apache.http.client.HttpClient;\n+import org.apache.http.client.methods.HttpPost;\n+import org.apache.http.entity.StringEntity;\n+import org.apache.http.impl.client.DefaultHttpClient;\n+import org.junit.After;\n+import org.junit.Test;\n+\n+import componenttest.app.FATServlet;\n+\n+@WebServlet(urlPatterns = \"/JaxrsJsonClientTestServlet\")\n+public class JaxrsJsonClientTestServlet extends FATServlet {\n+\n+    private static final long serialVersionUID = 4563445389586844836L;\n+\n+    final static String URI_CONTEXT_ROOT = \"http://localhost:\" + Integer.getInteger(\"bvt.prop.HTTP_default\") + \"/simpleJson/\";\n+\n+    private static Client client;\n+\n+    // needed to make requests with invalid json to the server\n+    private static HttpClient httpClient;\n+\n+    @Override\n+    public void init() throws ServletException {\n+        client = ClientBuilder.newClient();\n+//      httpClient = new HttpClientBuilder.create().build();\n+        httpClient = new DefaultHttpClient();\n+    }\n+\n+    @After\n+    private void teardown() {\n+        client.close();\n+        httpClient.getConnectionManager().shutdown();\n+    }\n+\n+    @Test\n+    public void simpleTest() throws Exception {\n+        Car corvette = new Car();\n+        corvette.color = \"red\";\n+        corvette.make = \"Chevrolet\";\n+        corvette.model = \"Corvette\";\n+        corvette.year = 2014;", "originalCommit": "295d9edbd971ca98876295f97dae97100715252d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fa5ca4d35eb0e75b8cbfa8c93662c67440457fcd", "chunk": "diff --git a/dev/com.ibm.ws.jaxrs.2.0_fat/test-applications/simpleJson/src/com/ibm/ws/jaxrs/fat/simpleJson/JaxrsJsonClientTestServlet.java b/dev/com.ibm.ws.jaxrs.2.0_fat/test-applications/simpleJson/src/com/ibm/ws/jaxrs/fat/simpleJson/JaxrsJsonClientTestServlet.java\nindex 1bada906b5..cba623f200 100644\n--- a/dev/com.ibm.ws.jaxrs.2.0_fat/test-applications/simpleJson/src/com/ibm/ws/jaxrs/fat/simpleJson/JaxrsJsonClientTestServlet.java\n+++ b/dev/com.ibm.ws.jaxrs.2.0_fat/test-applications/simpleJson/src/com/ibm/ws/jaxrs/fat/simpleJson/JaxrsJsonClientTestServlet.java\n\n@@ -98,13 +98,10 @@ public class JaxrsJsonClientTestServlet extends FATServlet {\n         boolean exception = false;\n         try {\n             response.readEntity(Foo.class);\n+            fail();\n         } catch (ResponseProcessingException e) {\n             exception = true;\n         }\n-\n-        if(!exception) {\n-            fail();\n-        }\n     }\n \n     private class Foo {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUzNDM4Mw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10990#discussion_r386534383", "bodyText": "You could remove this and just call fail() in the try block after response.readEntity(Foo.class);", "author": "andymc12", "createdAt": "2020-03-02T17:22:33Z", "path": "dev/com.ibm.ws.jaxrs.2.0_fat/test-applications/simpleJson/src/com/ibm/ws/jaxrs/fat/simpleJson/JaxrsJsonClientTestServlet.java", "diffHunk": "@@ -0,0 +1,114 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package com.ibm.ws.jaxrs.fat.simpleJson;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.fail;\n+\n+import javax.servlet.ServletException;\n+import javax.servlet.annotation.WebServlet;\n+import javax.ws.rs.client.Client;\n+import javax.ws.rs.client.ClientBuilder;\n+import javax.ws.rs.client.Entity;\n+import javax.ws.rs.client.ResponseProcessingException;\n+import javax.ws.rs.core.MediaType;\n+import javax.ws.rs.core.Response;\n+\n+import org.apache.http.HttpResponse;\n+import org.apache.http.client.HttpClient;\n+import org.apache.http.client.methods.HttpPost;\n+import org.apache.http.entity.StringEntity;\n+import org.apache.http.impl.client.DefaultHttpClient;\n+import org.junit.After;\n+import org.junit.Test;\n+\n+import componenttest.app.FATServlet;\n+\n+@WebServlet(urlPatterns = \"/JaxrsJsonClientTestServlet\")\n+public class JaxrsJsonClientTestServlet extends FATServlet {\n+\n+    private static final long serialVersionUID = 4563445389586844836L;\n+\n+    final static String URI_CONTEXT_ROOT = \"http://localhost:\" + Integer.getInteger(\"bvt.prop.HTTP_default\") + \"/simpleJson/\";\n+\n+    private static Client client;\n+\n+    // needed to make requests with invalid json to the server\n+    private static HttpClient httpClient;\n+\n+    @Override\n+    public void init() throws ServletException {\n+        client = ClientBuilder.newClient();\n+//      httpClient = new HttpClientBuilder.create().build();\n+        httpClient = new DefaultHttpClient();\n+    }\n+\n+    @After\n+    private void teardown() {\n+        client.close();\n+        httpClient.getConnectionManager().shutdown();\n+    }\n+\n+    @Test\n+    public void simpleTest() throws Exception {\n+        Car corvette = new Car();\n+        corvette.color = \"red\";\n+        corvette.make = \"Chevrolet\";\n+        corvette.model = \"Corvette\";\n+        corvette.year = 2014;\n+\n+        Response response = client.target(URI_CONTEXT_ROOT)\n+                        .path(\"simpleresource/post\")\n+                        .request(MediaType.APPLICATION_JSON_TYPE)\n+                        .post(Entity.json(corvette));\n+        assertEquals(200, response.getStatus());\n+        String actual = response.readEntity(String.class);\n+\n+        assertEquals(\"2014 Chevrolet Corvette\", actual);\n+    }\n+\n+    @Test\n+    public void sendInvalidJson() throws Exception {\n+\n+        HttpPost post = new HttpPost(URI_CONTEXT_ROOT + \"simpleresource/post\");\n+        StringEntity entity = new StringEntity(\"invalid\");\n+        post.setEntity(entity);\n+        post.addHeader(\"Content-Type\", \"application/json\");\n+\n+        HttpResponse response = httpClient.execute(post);\n+        assertEquals(400, response.getStatusLine().getStatusCode());\n+    }\n+\n+    @Test\n+    public void recieveInvalidJson() throws Exception {\n+\n+        Response response = client.target(URI_CONTEXT_ROOT)\n+                        .path(\"badsimpleresource/badresponse\")\n+                        .request(MediaType.APPLICATION_JSON_TYPE)\n+                        .get();\n+\n+        boolean exception = false;\n+        try {\n+            response.readEntity(Foo.class);\n+        } catch (ResponseProcessingException e) {\n+            exception = true;\n+        }\n+\n+        if(!exception) {\n+            fail();\n+        }", "originalCommit": "295d9edbd971ca98876295f97dae97100715252d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fa5ca4d35eb0e75b8cbfa8c93662c67440457fcd", "chunk": "diff --git a/dev/com.ibm.ws.jaxrs.2.0_fat/test-applications/simpleJson/src/com/ibm/ws/jaxrs/fat/simpleJson/JaxrsJsonClientTestServlet.java b/dev/com.ibm.ws.jaxrs.2.0_fat/test-applications/simpleJson/src/com/ibm/ws/jaxrs/fat/simpleJson/JaxrsJsonClientTestServlet.java\nindex 1bada906b5..cba623f200 100644\n--- a/dev/com.ibm.ws.jaxrs.2.0_fat/test-applications/simpleJson/src/com/ibm/ws/jaxrs/fat/simpleJson/JaxrsJsonClientTestServlet.java\n+++ b/dev/com.ibm.ws.jaxrs.2.0_fat/test-applications/simpleJson/src/com/ibm/ws/jaxrs/fat/simpleJson/JaxrsJsonClientTestServlet.java\n\n@@ -98,13 +98,10 @@ public class JaxrsJsonClientTestServlet extends FATServlet {\n         boolean exception = false;\n         try {\n             response.readEntity(Foo.class);\n+            fail();\n         } catch (ResponseProcessingException e) {\n             exception = true;\n         }\n-\n-        if(!exception) {\n-            fail();\n-        }\n     }\n \n     private class Foo {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUzODI0NQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10990#discussion_r386538245", "bodyText": "You can just remove the else keyword here.", "author": "andymc12", "createdAt": "2020-03-02T17:29:44Z", "path": "dev/com.ibm.ws.jaxrs.2.0.common/src/org/apache/cxf/jaxrs/utils/JAXRSUtils.java", "diffHunk": "@@ -1435,9 +1437,11 @@ public Object run() throws IOException, WebApplicationException {\n                 });\n             } catch (PrivilegedActionException e) {\n                 Exception e1 = e.getException();\n-                if (e1 instanceof IOException)\n+                if (e1 instanceof JsonParseException) {\n+                    throw new BadRequestException(e1);\n+                } else if (e1 instanceof IOException) {\n                     throw (IOException) e1;\n-                else\n+                } else", "originalCommit": "295d9edbd971ca98876295f97dae97100715252d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY3MDgxOQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10990#discussion_r386670819", "bodyText": "I prefer else blocks for uniformity (and brackets)", "author": "WhiteCat22", "createdAt": "2020-03-02T21:48:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUzODI0NQ=="}], "type": "inlineReview", "revised_code": {"commit": "fa5ca4d35eb0e75b8cbfa8c93662c67440457fcd", "chunk": "diff --git a/dev/com.ibm.ws.jaxrs.2.0.common/src/org/apache/cxf/jaxrs/utils/JAXRSUtils.java b/dev/com.ibm.ws.jaxrs.2.0.common/src/org/apache/cxf/jaxrs/utils/JAXRSUtils.java\nindex c283dd06f7..27f976681c 100644\n--- a/dev/com.ibm.ws.jaxrs.2.0.common/src/org/apache/cxf/jaxrs/utils/JAXRSUtils.java\n+++ b/dev/com.ibm.ws.jaxrs.2.0.common/src/org/apache/cxf/jaxrs/utils/JAXRSUtils.java\n\n@@ -1441,8 +1441,8 @@ public final class JAXRSUtils {\n                     throw new BadRequestException(e1);\n                 } else if (e1 instanceof IOException) {\n                     throw (IOException) e1;\n-                } else\n-                    throw (WebApplicationException) e1;\n+                }\n+                throw (WebApplicationException) e1;\n             }\n             // Liberty change end\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUzODk1NA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10990#discussion_r386538954", "bodyText": "I'm not sure that we want to put Jackson dependencies in the JAXRSUtils class.  Is it possible to update the Jackson MBR/MBW to throw BadRequestException instead and then leave JAXRSUtils unchanged?", "author": "andymc12", "createdAt": "2020-03-02T17:31:01Z", "path": "dev/com.ibm.ws.jaxrs.2.0.common/src/org/apache/cxf/jaxrs/utils/JAXRSUtils.java", "diffHunk": "@@ -141,6 +142,7 @@\n import org.apache.cxf.message.MessageUtils;\n import org.apache.cxf.phase.PhaseInterceptorChain;\n import org.apache.cxf.service.Service;\n+import org.codehaus.jackson.JsonParseException;", "originalCommit": "295d9edbd971ca98876295f97dae97100715252d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY2NDcwNg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10990#discussion_r386664706", "bodyText": "We could probably modify our wrapper class, I'd have to look into it further", "author": "WhiteCat22", "createdAt": "2020-03-02T21:36:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUzODk1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY3NDcyNg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10990#discussion_r386674726", "bodyText": "I was right, we pull in one of Jackson's prebuilt wrapper classes directly, we'd have to make our wrapper for their wrapper", "author": "WhiteCat22", "createdAt": "2020-03-02T21:56:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUzODk1NA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "fa5ca4d35eb0e75b8cbfa8c93662c67440457fcd", "url": "https://github.com/OpenLiberty/open-liberty/commit/fa5ca4d35eb0e75b8cbfa8c93662c67440457fcd", "message": "10986 - test invalid JSON in a jaxrs request", "committedDate": "2020-03-02T22:52:32Z", "type": "forcePushed"}, {"oid": "f6b624e581dee5bdae60406a808b5b2e5438ae51", "url": "https://github.com/OpenLiberty/open-liberty/commit/f6b624e581dee5bdae60406a808b5b2e5438ae51", "message": "10986 - jaxrs requests should return 400 instead of 500 when a POST request contains invalid JSON", "committedDate": "2020-03-02T23:16:11Z", "type": "commit"}, {"oid": "f32e005caffb4fb23c701775e4ee1800bfbf1396", "url": "https://github.com/OpenLiberty/open-liberty/commit/f32e005caffb4fb23c701775e4ee1800bfbf1396", "message": "10986 - test invalid JSON in a jaxrs request", "committedDate": "2020-03-02T23:17:09Z", "type": "commit"}, {"oid": "f32e005caffb4fb23c701775e4ee1800bfbf1396", "url": "https://github.com/OpenLiberty/open-liberty/commit/f32e005caffb4fb23c701775e4ee1800bfbf1396", "message": "10986 - test invalid JSON in a jaxrs request", "committedDate": "2020-03-02T23:17:09Z", "type": "forcePushed"}]}