{"pr_number": 13031, "pr_title": "Issue 13030: Wait for HTTP to allow ACME startup", "pr_createdAt": "2020-07-15T00:47:42Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/13031", "timeline": [{"oid": "cdd6ecd5e77fb7513ea9905e2deb7b0a16fb9429", "url": "https://github.com/OpenLiberty/open-liberty/commit/cdd6ecd5e77fb7513ea9905e2deb7b0a16fb9429", "message": "Issue 13030: Wait for HTTP to allow ACME startup", "committedDate": "2020-07-15T20:41:27Z", "type": "forcePushed"}, {"oid": "c651b5ac4e7721a749660ba3460fe3de38b9e71d", "url": "https://github.com/OpenLiberty/open-liberty/commit/c651b5ac4e7721a749660ba3460fe3de38b9e71d", "message": "Issue 13030: Wait for HTTP to allow ACME startup", "committedDate": "2020-07-15T21:03:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTgwNzQ1OA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13031#discussion_r455807458", "bodyText": "I would probably make this a WARNING, since it is significant and would help us debug the issue immediately.", "author": "jvanhill", "createdAt": "2020-07-16T13:59:14Z", "path": "dev/com.ibm.ws.security.acme/src/com/ibm/ws/security/acme/internal/AcmeApplicationStateListener.java", "diffHunk": "@@ -140,10 +196,51 @@ public void waitUntilWebAppAvailable() throws AcmeCaException {\n \t\t\t\t}\n \n \t\t\t} else {\n-\t\t\t\tif (TraceComponent.isAnyTracingEnabled() && tc.isEntryEnabled()) {\n+\t\t\t\tif (TraceComponent.isAnyTracingEnabled() && tc.isDebugEnabled()) {\n \t\t\t\t\tTr.debug(tc, methodName + \": ACME authorization web application already started - not waiting.\");\n \t\t\t\t}\n \t\t\t}\n+\n+\t\t\tif (!isHttpStarted) {\n+\t\t\t\tif (TraceComponent.isAnyTracingEnabled() && tc.isDebugEnabled()) {\n+\n+\t\t\t\t\tTr.debug(tc, methodName + \": HTTP has not started - waiting.\");\n+\t\t\t\t}\n+\n+\t\t\t\tboolean signaled = false, keepWaiting = true;\n+\t\t\t\tCalendar cal = Calendar.getInstance();\n+\t\t\t\tint timeToWait = 1;\n+\t\t\t\tcal.add(Calendar.MINUTE, timeToWait); // Wait 1 minute, the HTTP port should open after 30 seconds\n+\t\t\t\twhile (keepWaiting) {\n+\t\t\t\t\ttry {\n+\t\t\t\t\t\tkeepWaiting = false;\n+\t\t\t\t\t\tsignaled = httpStartedCondition.awaitUntil(cal.getTime());\n+\t\t\t\t\t} catch (InterruptedException e) {\n+\t\t\t\t\t\tkeepWaiting = true;\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t\tif (TraceComponent.isAnyTracingEnabled() && tc.isEntryEnabled()) {\n+\t\t\t\t\tTr.debug(tc, methodName + \": Finished waiting.\");\n+\t\t\t\t}\n+\n+\t\t\t\t/*\n+\t\t\t\t * If the wait above expired and we weren't signaled by the startedPhase2\n+\t\t\t\t * method, we will attempt to start ACME anyway. If the HTTP port is truly not\n+\t\t\t\t * open, then the CA call back to the well-known URL will fail\n+\t\t\t\t * (\"Connection refused\" or similar).\n+\t\t\t\t */\n+\t\t\t\tif (!signaled || !isHttpStarted) {\n+\t\t\t\t\tif (TraceComponent.isAnyTracingEnabled() && tc.isEventEnabled()) {\n+\t\t\t\t\t\tTr.event(tc, methodName", "originalCommit": "c651b5ac4e7721a749660ba3460fe3de38b9e71d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjA4NjQ3NA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13031#discussion_r456086474", "bodyText": "Added a warning message.", "author": "kristip17", "createdAt": "2020-07-16T21:24:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTgwNzQ1OA=="}], "type": "inlineReview", "revised_code": {"commit": "030196961924a26b324b8ce1510503857ed08273", "chunk": "diff --git a/dev/com.ibm.ws.security.acme/src/com/ibm/ws/security/acme/internal/AcmeApplicationStateListener.java b/dev/com.ibm.ws.security.acme/src/com/ibm/ws/security/acme/internal/AcmeApplicationStateListener.java\nindex 766d615eb7..586bbce001 100644\n--- a/dev/com.ibm.ws.security.acme/src/com/ibm/ws/security/acme/internal/AcmeApplicationStateListener.java\n+++ b/dev/com.ibm.ws.security.acme/src/com/ibm/ws/security/acme/internal/AcmeApplicationStateListener.java\n\n@@ -203,24 +211,24 @@ public class AcmeApplicationStateListener implements ApplicationStateListener {\n \n \t\t\tif (!isHttpStarted) {\n \t\t\t\tif (TraceComponent.isAnyTracingEnabled() && tc.isDebugEnabled()) {\n-\n-\t\t\t\t\tTr.debug(tc, methodName + \": HTTP has not started - waiting.\");\n+\t\t\t\t\tTr.debug(tc, methodName + \": HTTP has not started - waiting. Time left: \"\n+\t\t\t\t\t\t\t+ (cal.getTimeInMillis() - System.currentTimeMillis()) + \"ms\");\n \t\t\t\t}\n \n \t\t\t\tboolean signaled = false, keepWaiting = true;\n-\t\t\t\tCalendar cal = Calendar.getInstance();\n-\t\t\t\tint timeToWait = 1;\n-\t\t\t\tcal.add(Calendar.MINUTE, timeToWait); // Wait 1 minute, the HTTP port should open after 30 seconds\n \t\t\t\twhile (keepWaiting) {\n \t\t\t\t\ttry {\n \t\t\t\t\t\tkeepWaiting = false;\n+\t\t\t\t\t\t/*\n+\t\t\t\t\t\t * Use any time left from waiting on the servlet to start\n+\t\t\t\t\t\t */\n \t\t\t\t\t\tsignaled = httpStartedCondition.awaitUntil(cal.getTime());\n \t\t\t\t\t} catch (InterruptedException e) {\n \t\t\t\t\t\tkeepWaiting = true;\n \t\t\t\t\t}\n \t\t\t\t}\n \t\t\t\tif (TraceComponent.isAnyTracingEnabled() && tc.isEntryEnabled()) {\n-\t\t\t\t\tTr.debug(tc, methodName + \": Finished waiting.\");\n+\t\t\t\t\tTr.debug(tc, methodName + \": Finished waiting on HTTP.\");\n \t\t\t\t}\n \n \t\t\t\t/*\n"}}, {"oid": "030196961924a26b324b8ce1510503857ed08273", "url": "https://github.com/OpenLiberty/open-liberty/commit/030196961924a26b324b8ce1510503857ed08273", "message": "Issue 13030: Wait for HTTP to allow ACME startup", "committedDate": "2020-07-16T20:58:00Z", "type": "forcePushed"}, {"oid": "f83112014f99b3f97e4790c58203f26d07051c67", "url": "https://github.com/OpenLiberty/open-liberty/commit/f83112014f99b3f97e4790c58203f26d07051c67", "message": "Issue 13030: Wait for HTTP to allow ACME startup", "committedDate": "2020-07-16T21:23:52Z", "type": "forcePushed"}, {"oid": "5bef16eb63e62a6b6ac9256f56b5f49e7ff90db5", "url": "https://github.com/OpenLiberty/open-liberty/commit/5bef16eb63e62a6b6ac9256f56b5f49e7ff90db5", "message": "Issue 13030: Wait for HTTP to allow ACME startup", "committedDate": "2020-07-20T02:36:00Z", "type": "forcePushed"}, {"oid": "cded4279e5b7ba4d7b1a007165b38cb0338df1b9", "url": "https://github.com/OpenLiberty/open-liberty/commit/cded4279e5b7ba4d7b1a007165b38cb0338df1b9", "message": "Issue 13030: Wait for HTTP to allow ACME startup", "committedDate": "2020-07-21T21:14:08Z", "type": "forcePushed"}, {"oid": "57584bace5150ff6be5d368ce6c67d447c7567f7", "url": "https://github.com/OpenLiberty/open-liberty/commit/57584bace5150ff6be5d368ce6c67d447c7567f7", "message": "Issue 13030: Wait for HTTP to allow ACME startup", "committedDate": "2020-07-22T14:04:15Z", "type": "forcePushed"}, {"oid": "ddcbbb98596a956ca35689389783534611ba35dd", "url": "https://github.com/OpenLiberty/open-liberty/commit/ddcbbb98596a956ca35689389783534611ba35dd", "message": "Issue 13030: Wait for HTTP to allow ACME startup", "committedDate": "2020-07-22T18:00:06Z", "type": "commit"}, {"oid": "ddcbbb98596a956ca35689389783534611ba35dd", "url": "https://github.com/OpenLiberty/open-liberty/commit/ddcbbb98596a956ca35689389783534611ba35dd", "message": "Issue 13030: Wait for HTTP to allow ACME startup", "committedDate": "2020-07-22T18:00:06Z", "type": "forcePushed"}]}