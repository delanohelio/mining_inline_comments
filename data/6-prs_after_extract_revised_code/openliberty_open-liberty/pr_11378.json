{"pr_number": 11378, "pr_title": "Resolve issue where JAX-RS Client SSL feature overrides user-specific security info", "pr_createdAt": "2020-03-18T21:08:12Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/11378", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY0NjYyMA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11378#discussion_r394646620", "bodyText": "just a comment on the style, I don't normally see null != var it's usually var != null\nnot that it matters", "author": "WhiteCat22", "createdAt": "2020-03-18T21:20:52Z", "path": "dev/com.ibm.ws.jaxrs.2.0.client/src/com/ibm/ws/jaxrs20/client/security/LibertyJaxRsClientSSLOutInterceptor.java", "diffHunk": "@@ -71,36 +80,37 @@ public void handleMessage(Message message) throws Fault {\n         // getSocketFactory will return null if either the ssl feature is not enabled\n         // or if it is enabled but there is no SSL configuration defined.  A null here\n         // means to use the JDK's SSL implementation.\n-        if (getSocketFactory(sslRef) != null) {\n+        SSLSocketFactory socketFactory = getSocketFactory(sslRef);\n+        if (socketFactory != null) {\n             Object disableCNCheckObj = message.get(JAXRSClientConstants.DISABLE_CN_CHECK);\n             Conduit cd = message.getExchange().getConduit(message);\n-            configClientSSL(cd, sslRef, PropertyUtils.isTrue(disableCNCheckObj));\n+            configClientSSL(cd, sslRef, PropertyUtils.isTrue(disableCNCheckObj), socketFactory);\n         }\n     }\n \n-    private void configClientSSL(Conduit conduit, String sslRef, boolean disableCNCheck) {\n+    private void configClientSSL(Conduit conduit, String sslRef, boolean disableCNCheck, SSLSocketFactory socketFactory) {\n \n         //for HTTPS protocol\n         if (conduit instanceof HTTPConduit) {\n             HTTPConduit httpConduit = (HTTPConduit) conduit;\n \n-            TLSClientParameters tlsClientParams = retriveHTTPTLSClientParametersUsingSSLRef(httpConduit, sslRef, disableCNCheck);\n-            if (null != tlsClientParams) {\n-                httpConduit.setTlsClientParameters(tlsClientParams);\n+            if (null == httpConduit.getTlsClientParameters() || overrideUserTLS) {", "originalCommit": "b5f1256b2fe7d87933ebfa6f3fac9f2535851caa", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c88aa42683fe86ee9ba8e14cdf321a3d1fe7d810", "chunk": "diff --git a/dev/com.ibm.ws.jaxrs.2.0.client/src/com/ibm/ws/jaxrs20/client/security/LibertyJaxRsClientSSLOutInterceptor.java b/dev/com.ibm.ws.jaxrs.2.0.client/src/com/ibm/ws/jaxrs20/client/security/LibertyJaxRsClientSSLOutInterceptor.java\nindex 15c96c647c..e2383b7a41 100644\n--- a/dev/com.ibm.ws.jaxrs.2.0.client/src/com/ibm/ws/jaxrs20/client/security/LibertyJaxRsClientSSLOutInterceptor.java\n+++ b/dev/com.ibm.ws.jaxrs.2.0.client/src/com/ibm/ws/jaxrs20/client/security/LibertyJaxRsClientSSLOutInterceptor.java\n\n@@ -80,30 +71,27 @@ public class LibertyJaxRsClientSSLOutInterceptor extends AbstractPhaseIntercepto\n         // getSocketFactory will return null if either the ssl feature is not enabled\n         // or if it is enabled but there is no SSL configuration defined.  A null here\n         // means to use the JDK's SSL implementation.\n-        SSLSocketFactory socketFactory = getSocketFactory(sslRef);\n-        if (socketFactory != null) {\n+        if (getSocketFactory(sslRef) != null) {\n             Object disableCNCheckObj = message.get(JAXRSClientConstants.DISABLE_CN_CHECK);\n             Conduit cd = message.getExchange().getConduit(message);\n-            configClientSSL(cd, sslRef, PropertyUtils.isTrue(disableCNCheckObj), socketFactory);\n+            configClientSSL(cd, sslRef, PropertyUtils.isTrue(disableCNCheckObj));\n         }\n     }\n \n-    private void configClientSSL(Conduit conduit, String sslRef, boolean disableCNCheck, SSLSocketFactory socketFactory) {\n+    private void configClientSSL(Conduit conduit, String sslRef, boolean disableCNCheck) {\n \n         //for HTTPS protocol\n         if (conduit instanceof HTTPConduit) {\n             HTTPConduit httpConduit = (HTTPConduit) conduit;\n \n-            if (null == httpConduit.getTlsClientParameters() || overrideUserTLS) {\n-                TLSClientParameters tlsClientParams = retriveHTTPTLSClientParametersUsingSSLRef(httpConduit, sslRef, disableCNCheck, socketFactory);\n-                if (null != tlsClientParams) {\n-                    httpConduit.setTlsClientParameters(tlsClientParams);\n-                }\n+            TLSClientParameters tlsClientParams = retriveHTTPTLSClientParametersUsingSSLRef(httpConduit, sslRef, disableCNCheck);\n+            if (null != tlsClientParams) {\n+                httpConduit.setTlsClientParameters(tlsClientParams);\n             }\n         }\n     }\n \n-    private TLSClientParameters retriveHTTPTLSClientParametersUsingSSLRef(HTTPConduit httpConduit, String sslRef, boolean disableCNCheck, SSLSocketFactory sslSocketFactory) {\n+    private TLSClientParameters retriveHTTPTLSClientParametersUsingSSLRef(HTTPConduit httpConduit, String sslRef, boolean disableCNCheck) {\n         TLSClientParameters tlsClientParams = null;\n         if (this.secConfig == null) {\n             tlsClientParams = httpConduit.getTlsClientParameters();\n"}}, {"oid": "c88aa42683fe86ee9ba8e14cdf321a3d1fe7d810", "url": "https://github.com/OpenLiberty/open-liberty/commit/c88aa42683fe86ee9ba8e14cdf321a3d1fe7d810", "message": "[11108] Test case for MP Rest Client using hostnameVerifier", "committedDate": "2020-03-19T18:11:45Z", "type": "commit"}, {"oid": "4e3c3a9ea00352506253effaabff3ba48a3d4285", "url": "https://github.com/OpenLiberty/open-liberty/commit/4e3c3a9ea00352506253effaabff3ba48a3d4285", "message": "[11108] Avoid overwriting TLSClientParameters specified by user code", "committedDate": "2020-03-19T18:11:45Z", "type": "commit"}, {"oid": "4e3c3a9ea00352506253effaabff3ba48a3d4285", "url": "https://github.com/OpenLiberty/open-liberty/commit/4e3c3a9ea00352506253effaabff3ba48a3d4285", "message": "[11108] Avoid overwriting TLSClientParameters specified by user code", "committedDate": "2020-03-19T18:11:45Z", "type": "forcePushed"}]}