{"pr_number": 13892, "pr_title": "Refactoring/simplification", "pr_createdAt": "2020-09-11T15:28:51Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/13892", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDMzMjM0MA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13892#discussion_r490332340", "bodyText": "This is much better.\nHowever, is there a possibility that anything else could be reading openAPIModel at the same point that this modification is happening? (E.g. line 125)\nI suspect that you need to synchronize around every access to openAPIModel to be safe here.", "author": "Azquelt", "createdAt": "2020-09-17T15:13:18Z", "path": "dev/io.openliberty.microprofile.openapi.2.0.internal/src/io/openliberty/microprofile/openapi20/WebModuleOpenAPIProvider.java", "diffHunk": "@@ -56,12 +75,68 @@ public String getOpenAPIDocument(Format format) {\n         return document;\n     }\n \n+    /**\n+     * @see io.openliberty.microprofile.openapi20.OpenAPIProvider#getOpenAPIDocument(List<Server>, Format)\n+     */\n+    @Override\n+    public String getOpenAPIDocument(List<Server> servers, Format format) {\n+        // Create the variable to return\n+        String document = null;\n+\n+        // Make sure that the list of servers is valid\n+        if (servers != null && !servers.isEmpty()) {\n+            /*\n+             * We only store a single copy of the OpenAPI model for a given application, but the OpenAPI document could\n+             * be requested by multiple clients concurrently.  As a result, we need to synchronize operations that\n+             * update the model to ensure consistent behaviour. \n+             */\n+            synchronized (openAPIModel) {\n+                // Set the servers in the OpenAPI model and generate the OpenAPI document\n+                openAPIModel.setServers(servers);\n+                document = OpenAPIUtils.getOpenAPIDocument(openAPIModel, format);\n+            }", "originalCommit": "f75940c7a6c6d030f442f6ca6a27e0db82494de0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "68d5bbf70e1d3850b4dd566e71cc14df0bb05848", "chunk": "diff --git a/dev/io.openliberty.microprofile.openapi.2.0.internal/src/io/openliberty/microprofile/openapi20/WebModuleOpenAPIProvider.java b/dev/io.openliberty.microprofile.openapi.2.0.internal/src/io/openliberty/microprofile/openapi20/WebModuleOpenAPIProvider.java\nindex 5f4159e7b4..f6cf11b8fb 100644\n--- a/dev/io.openliberty.microprofile.openapi.2.0.internal/src/io/openliberty/microprofile/openapi20/WebModuleOpenAPIProvider.java\n+++ b/dev/io.openliberty.microprofile.openapi.2.0.internal/src/io/openliberty/microprofile/openapi20/WebModuleOpenAPIProvider.java\n\n@@ -68,7 +68,9 @@ public class WebModuleOpenAPIProvider implements OpenAPIProvider {\n                 document = openAPIDocuments.get(format);\n             } else {\n                 // We are not caching the OpenAPI document... generate it now\n-                document = OpenAPIUtils.getOpenAPIDocument(openAPIModel, format);\n+                synchronized (openAPIModel) {\n+                    document = OpenAPIUtils.getOpenAPIDocument(openAPIModel, format);\n+                }\n             }\n         }\n         \n"}}, {"oid": "68d5bbf70e1d3850b4dd566e71cc14df0bb05848", "url": "https://github.com/OpenLiberty/open-liberty/commit/68d5bbf70e1d3850b4dd566e71cc14df0bb05848", "message": "Refactoring/simplification\n\nSigned-off-by: Martin Smithson <msmiths@uk.ibm.com>\n\nRefactoring/simplification\n\nSigned-off-by: Martin Smithson <msmiths@uk.ibm.com>\n\nAdd locking when updating the OpenAPI model\n\nSigned-off-by: Martin Smithson <msmiths@uk.ibm.com>\n\nMove to MP OpenAPI 2.0-RC3\n\nSigned-off-by: Martin Smithson <msmiths@uk.ibm.com>\n\nApply PR review comments\n\nSigned-off-by: Martin Smithson <msmiths@uk.ibm.com>\n\nFix toString format for test log monitoring\n\nSigned-off-by: Martin Smithson <msmiths@uk.ibm.com>\n\nSynchronize access to openAPIModel\n\nSigned-off-by: Martin Smithson <msmiths@uk.ibm.com>", "committedDate": "2020-09-17T16:07:38Z", "type": "commit"}, {"oid": "68d5bbf70e1d3850b4dd566e71cc14df0bb05848", "url": "https://github.com/OpenLiberty/open-liberty/commit/68d5bbf70e1d3850b4dd566e71cc14df0bb05848", "message": "Refactoring/simplification\n\nSigned-off-by: Martin Smithson <msmiths@uk.ibm.com>\n\nRefactoring/simplification\n\nSigned-off-by: Martin Smithson <msmiths@uk.ibm.com>\n\nAdd locking when updating the OpenAPI model\n\nSigned-off-by: Martin Smithson <msmiths@uk.ibm.com>\n\nMove to MP OpenAPI 2.0-RC3\n\nSigned-off-by: Martin Smithson <msmiths@uk.ibm.com>\n\nApply PR review comments\n\nSigned-off-by: Martin Smithson <msmiths@uk.ibm.com>\n\nFix toString format for test log monitoring\n\nSigned-off-by: Martin Smithson <msmiths@uk.ibm.com>\n\nSynchronize access to openAPIModel\n\nSigned-off-by: Martin Smithson <msmiths@uk.ibm.com>", "committedDate": "2020-09-17T16:07:38Z", "type": "forcePushed"}, {"oid": "534012eba590465cf467f1ed8e7dba199f3e7179", "url": "https://github.com/OpenLiberty/open-liberty/commit/534012eba590465cf467f1ed8e7dba199f3e7179", "message": "Merge branch 'integration' into smallRyeOpenAPI", "committedDate": "2020-09-17T16:11:42Z", "type": "commit"}]}