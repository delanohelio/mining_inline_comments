{"pr_number": 14164, "pr_title": "Add a JAX-RS MULTIPART_FORM_DATA test that consumes a .csv file with at least 256 characters of data", "pr_createdAt": "2020-09-25T13:21:23Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/14164", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTAxMDM2MA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14164#discussion_r495010360", "bodyText": "Probably you should move the stream.close(), out.flush() and out.close() into a finally{} with null checks.", "author": "jim-krueger", "createdAt": "2020-09-25T14:04:12Z", "path": "dev/com.ibm.ws.jaxrs.2.x.webcontainer_fat/test-applications/thirdpartylib/src/com/ibm/ws/jaxrs2x/fat/thirdparty/multipart/UploadServiceImpl.java", "diffHunk": "@@ -70,6 +73,37 @@ public Response uploadFile(List<IAttachment> attachments, @Context HttpServletRe\n         return Response.ok(\"file uploaded\").build();\n     }\n \n+    @POST\n+    @Path(\"/uploadFile2\")\n+    @Consumes(MediaType.MULTIPART_FORM_DATA)\n+    public Response uploadFile2(List<IAttachment> attachments, @Context HttpServletRequest request) {\n+        for (IAttachment attachment : attachments) {\n+            DataHandler handler = attachment.getDataHandler();\n+            try {\n+                InputStream stream = handler.getInputStream();\n+                MultivaluedMap<String, String> map = attachment.getHeaders();\n+                System.out.println(\"fileName2 Here \" + getFileName(map));\n+                OutputStream out = new FileOutputStream(new File(\"./\" + getFileName(map)));\n+                StringBuilder stringBuilder = new StringBuilder();\n+                Reader in = new InputStreamReader(stream, StandardCharsets.UTF_8);\n+                char[] chars = new char[1024];\n+                int charsRead;\n+                while((charsRead = in.read(chars, 0, chars.length)) > 0) {\n+                    stringBuilder.append(chars, 0, charsRead);\n+                    out.write(new String(chars).getBytes(\"UTF-8\"), 0, charsRead);\n+                }\n+                System.out.println(\"uploadFile2 stringBuilder.toString(): \" + stringBuilder.toString());\n+                stream.close();", "originalCommit": "307dd1d210b85a7329ebfe1016d2e501ad979b61", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTAyNDQyOQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14164#discussion_r495024429", "bodyText": "+1 or use try-with-resources to auto close", "author": "andymc12", "createdAt": "2020-09-25T14:24:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTAxMDM2MA=="}], "type": "inlineReview", "revised_code": {"commit": "f96de47960599f63f8a2bd9dee00aacdc7a86ef2", "chunk": "diff --git a/dev/com.ibm.ws.jaxrs.2.x.webcontainer_fat/test-applications/thirdpartylib/src/com/ibm/ws/jaxrs2x/fat/thirdparty/multipart/UploadServiceImpl.java b/dev/com.ibm.ws.jaxrs.2.x.webcontainer_fat/test-applications/thirdpartylib/src/com/ibm/ws/jaxrs2x/fat/thirdparty/multipart/UploadServiceImpl.java\nindex 631a8581dc..fc4539a01c 100644\n--- a/dev/com.ibm.ws.jaxrs.2.x.webcontainer_fat/test-applications/thirdpartylib/src/com/ibm/ws/jaxrs2x/fat/thirdparty/multipart/UploadServiceImpl.java\n+++ b/dev/com.ibm.ws.jaxrs.2.x.webcontainer_fat/test-applications/thirdpartylib/src/com/ibm/ws/jaxrs2x/fat/thirdparty/multipart/UploadServiceImpl.java\n\n@@ -86,11 +86,10 @@ public class UploadServiceImpl {\n                 OutputStream out = new FileOutputStream(new File(\"./\" + getFileName(map)));\n                 StringBuilder stringBuilder = new StringBuilder();\n                 Reader in = new InputStreamReader(stream, StandardCharsets.UTF_8);\n-                char[] chars = new char[1024];\n+                char[] buffer = new char[1024];\n                 int charsRead;\n-                while((charsRead = in.read(chars, 0, chars.length)) > 0) {\n-                    stringBuilder.append(chars, 0, charsRead);\n-                    out.write(new String(chars).getBytes(\"UTF-8\"), 0, charsRead);\n+                while((charsRead = in.read(buffer, 0, buffer.length)) > 0) {\n+                    stringBuilder.append(buffer, 0, charsRead);\n                 }\n                 System.out.println(\"uploadFile2 stringBuilder.toString(): \" + stringBuilder.toString());\n                 stream.close();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTAyNzI1NA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14164#discussion_r495027254", "bodyText": "this will always return ok(\"file uploaded\") even if there was an exception thrown.\nMaybe put this return statement as the last line of the try block, and then add the following line inside the catch block (after printing the stack trace):\nreturn Response.serverError().entity(\"caught exception: \" + e);", "author": "andymc12", "createdAt": "2020-09-25T14:28:48Z", "path": "dev/com.ibm.ws.jaxrs.2.x.webcontainer_fat/test-applications/thirdpartylib/src/com/ibm/ws/jaxrs2x/fat/thirdparty/multipart/UploadServiceImpl.java", "diffHunk": "@@ -70,6 +73,37 @@ public Response uploadFile(List<IAttachment> attachments, @Context HttpServletRe\n         return Response.ok(\"file uploaded\").build();\n     }\n \n+    @POST\n+    @Path(\"/uploadFile2\")\n+    @Consumes(MediaType.MULTIPART_FORM_DATA)\n+    public Response uploadFile2(List<IAttachment> attachments, @Context HttpServletRequest request) {\n+        for (IAttachment attachment : attachments) {\n+            DataHandler handler = attachment.getDataHandler();\n+            try {\n+                InputStream stream = handler.getInputStream();\n+                MultivaluedMap<String, String> map = attachment.getHeaders();\n+                System.out.println(\"fileName2 Here \" + getFileName(map));\n+                OutputStream out = new FileOutputStream(new File(\"./\" + getFileName(map)));\n+                StringBuilder stringBuilder = new StringBuilder();\n+                Reader in = new InputStreamReader(stream, StandardCharsets.UTF_8);\n+                char[] chars = new char[1024];\n+                int charsRead;\n+                while((charsRead = in.read(chars, 0, chars.length)) > 0) {\n+                    stringBuilder.append(chars, 0, charsRead);\n+                    out.write(new String(chars).getBytes(\"UTF-8\"), 0, charsRead);\n+                }\n+                System.out.println(\"uploadFile2 stringBuilder.toString(): \" + stringBuilder.toString());\n+                stream.close();\n+                out.flush();\n+                out.close();\n+            } catch (Exception e) {\n+                e.printStackTrace();\n+            }\n+        }\n+\n+        return Response.ok(\"file uploaded\").build();", "originalCommit": "307dd1d210b85a7329ebfe1016d2e501ad979b61", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f96de47960599f63f8a2bd9dee00aacdc7a86ef2", "chunk": "diff --git a/dev/com.ibm.ws.jaxrs.2.x.webcontainer_fat/test-applications/thirdpartylib/src/com/ibm/ws/jaxrs2x/fat/thirdparty/multipart/UploadServiceImpl.java b/dev/com.ibm.ws.jaxrs.2.x.webcontainer_fat/test-applications/thirdpartylib/src/com/ibm/ws/jaxrs2x/fat/thirdparty/multipart/UploadServiceImpl.java\nindex 631a8581dc..fc4539a01c 100644\n--- a/dev/com.ibm.ws.jaxrs.2.x.webcontainer_fat/test-applications/thirdpartylib/src/com/ibm/ws/jaxrs2x/fat/thirdparty/multipart/UploadServiceImpl.java\n+++ b/dev/com.ibm.ws.jaxrs.2.x.webcontainer_fat/test-applications/thirdpartylib/src/com/ibm/ws/jaxrs2x/fat/thirdparty/multipart/UploadServiceImpl.java\n\n@@ -86,11 +86,10 @@ public class UploadServiceImpl {\n                 OutputStream out = new FileOutputStream(new File(\"./\" + getFileName(map)));\n                 StringBuilder stringBuilder = new StringBuilder();\n                 Reader in = new InputStreamReader(stream, StandardCharsets.UTF_8);\n-                char[] chars = new char[1024];\n+                char[] buffer = new char[1024];\n                 int charsRead;\n-                while((charsRead = in.read(chars, 0, chars.length)) > 0) {\n-                    stringBuilder.append(chars, 0, charsRead);\n-                    out.write(new String(chars).getBytes(\"UTF-8\"), 0, charsRead);\n+                while((charsRead = in.read(buffer, 0, buffer.length)) > 0) {\n+                    stringBuilder.append(buffer, 0, charsRead);\n                 }\n                 System.out.println(\"uploadFile2 stringBuilder.toString(): \" + stringBuilder.toString());\n                 stream.close();\n"}}, {"oid": "f96de47960599f63f8a2bd9dee00aacdc7a86ef2", "url": "https://github.com/OpenLiberty/open-liberty/commit/f96de47960599f63f8a2bd9dee00aacdc7a86ef2", "message": "Add a JAX-RS MULTIPART_FORM_DATA test that consumes a .csv file with at least 256 characters of data", "committedDate": "2020-09-27T13:15:53Z", "type": "commit"}, {"oid": "d903d7adfe95f7e53378e11b818904d0efe24f28", "url": "https://github.com/OpenLiberty/open-liberty/commit/d903d7adfe95f7e53378e11b818904d0efe24f28", "message": "Add a JAX-RS MULTIPART_FORM_DATA test that consume a .csv file with at least 256 characters of data", "committedDate": "2020-09-27T13:15:53Z", "type": "commit"}, {"oid": "b2dd70138deaf9a6b5b3e30b3ed4a5bf54d1105a", "url": "https://github.com/OpenLiberty/open-liberty/commit/b2dd70138deaf9a6b5b3e30b3ed4a5bf54d1105a", "message": "Add a JAX-RS MULTIPART_FORM_DATA test that consume a .csv file with at least 256 characters of data", "committedDate": "2020-09-27T13:15:54Z", "type": "commit"}, {"oid": "9590959e66a92fd5fdd5256a8a164af33c1917a1", "url": "https://github.com/OpenLiberty/open-liberty/commit/9590959e66a92fd5fdd5256a8a164af33c1917a1", "message": "Add a JAX-RS MULTIPART_FORM_DATA test that consume a .csv file with at least 256 characters of data", "committedDate": "2020-09-27T13:15:54Z", "type": "commit"}, {"oid": "9590959e66a92fd5fdd5256a8a164af33c1917a1", "url": "https://github.com/OpenLiberty/open-liberty/commit/9590959e66a92fd5fdd5256a8a164af33c1917a1", "message": "Add a JAX-RS MULTIPART_FORM_DATA test that consume a .csv file with at least 256 characters of data", "committedDate": "2020-09-27T13:15:54Z", "type": "forcePushed"}]}