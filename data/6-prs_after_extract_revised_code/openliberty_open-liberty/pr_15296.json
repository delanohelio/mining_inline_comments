{"pr_number": 15296, "pr_title": "Use private mirror of Docker Hub", "pr_createdAt": "2020-12-14T02:43:14Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/15296", "timeline": [{"oid": "8f9ad24b8bd45788332d1fd2c6101b8a3f86c7b0", "url": "https://github.com/OpenLiberty/open-liberty/commit/8f9ad24b8bd45788332d1fd2c6101b8a3f86c7b0", "message": "Get auth token for custom docker config", "committedDate": "2020-12-14T02:51:51Z", "type": "forcePushed"}, {"oid": "95fd675165decd571fd98ef9e5a4c483d0b28aec", "url": "https://github.com/OpenLiberty/open-liberty/commit/95fd675165decd571fd98ef9e5a4c483d0b28aec", "message": "Get auth token for custom docker config", "committedDate": "2020-12-14T17:06:56Z", "type": "forcePushed"}, {"oid": "9c80f496aaa0d0ad97331ec299436eec4771c594", "url": "https://github.com/OpenLiberty/open-liberty/commit/9c80f496aaa0d0ad97331ec299436eec4771c594", "message": "Get auth token for custom docker config", "committedDate": "2020-12-15T05:49:25Z", "type": "forcePushed"}, {"oid": "c6b95d7961b9fb998549153a8ba23d91e05c17ba", "url": "https://github.com/OpenLiberty/open-liberty/commit/c6b95d7961b9fb998549153a8ba23d91e05c17ba", "message": "Pull private registry token from Consul", "committedDate": "2020-12-16T21:33:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcwOTQzMw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/15296#discussion_r544709433", "bodyText": "I do not really understand what this class is doing.  Or more accurately how our infrastructure is set up to support this.\nDo we have a system set up that caches docker images from docker hub and hosts them within our test environment?\nWill developers running tests locally still be able to run against our remote docker machines?", "author": "KyleAure", "createdAt": "2020-12-16T23:58:23Z", "path": "dev/fattest.simplicity/src/componenttest/containers/ArtifactoryImageNameSubstitutor.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package componenttest.containers;\n+\n+import org.testcontainers.utility.DockerImageName;\n+import org.testcontainers.utility.ImageNameSubstitutor;\n+\n+import com.ibm.websphere.simplicity.log.Log;\n+\n+import componenttest.topology.utils.ExternalTestService;\n+\n+/**\n+ * An image name substituter is configured in testcontainers.properties and will transform docker image names.\n+ * Here we use it to apply a private registry prefix so that in remote builds we use an internal mirror\n+ * of Docker Hub, instead of downloading from Docker Hub in each build which causes rate limiting issues.\n+ */\n+public class ArtifactoryImageNameSubstitutor extends ImageNameSubstitutor {", "originalCommit": "c6b95d7961b9fb998549153a8ba23d91e05c17ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcxNTU0OA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/15296#discussion_r544715548", "bodyText": "The image name substitutor is an SPI that Testcontainers recently added specifically for addressing the docker hub rate limiting issue:\nhttps://www.testcontainers.org/features/image_name_substitution/\nBasically you can configure an ImageNameSubstitutor globally (as we do in this PR) and it will remap all of the docker image names used by Testcontainers. So if some FAT bucket does:\npublic static GenericContainer myContainer = new GenericContainer(\"someImage:1.0\");\nWhen the substitutor is activated the code will effectively be:\npublic static GenericContainer myContainer = new GenericContainer(\"com.mycompany.registry/someImage:1.0\");\nWhere com.mycompany.registry is a companies private docker registry (ideally a mirror of Docker Hub). I've set up a mirror registry within the IBM network to handle this. A registry mirror is basically a lazily-populated cache. If a bucket does a pull of a new image someImage:1.0, the mirror will check to see if it's available within the mirror, and if not it'll download the image from Docker Hub and cache it for future use. So that way the next time we do a pull of someImage:1.0 it comes from the mirror registry and we don't need to touch Docker Hub, thus avoiding the rate limiting issue.\n\nWill developers running tests locally still be able to run against our remote docker machines?\n\nYes. If we detect that remote docker is being used, then the new ExternalTestServiceDockerClient.setupTestcontainers method will rewrite the .testcontainers.properties file to use the ArtifactoryImageNameSubstitutor and it will generate a ~/.docker/config.json with a the private docker registry mirror auth token.", "author": "aguibert", "createdAt": "2020-12-17T00:14:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcwOTQzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTE3NzgwMQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/15296#discussion_r545177801", "bodyText": "Okay thanks for that extra explanation! \ud83d\udc4d", "author": "KyleAure", "createdAt": "2020-12-17T15:27:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcwOTQzMw=="}], "type": "inlineReview", "revised_code": {"commit": "7e0a096d72a8bc7a402b9da06f8bb2b3c5dc5a7c", "chunk": "diff --git a/dev/fattest.simplicity/src/componenttest/containers/ArtifactoryImageNameSubstitutor.java b/dev/fattest.simplicity/src/componenttest/containers/ArtifactoryImageNameSubstitutor.java\nindex e59f6ba319..a25d4b04cd 100644\n--- a/dev/fattest.simplicity/src/componenttest/containers/ArtifactoryImageNameSubstitutor.java\n+++ b/dev/fattest.simplicity/src/componenttest/containers/ArtifactoryImageNameSubstitutor.java\n\n@@ -28,14 +28,18 @@ public class ArtifactoryImageNameSubstitutor extends ImageNameSubstitutor {\n \n     @Override\n     public DockerImageName apply(DockerImageName original) {\n-        if (ExternalTestServiceDockerClientStrategy.useRemoteDocker() && !isSyntheticImage(original)) {\n-            // Using remote docker, need to substitute image name to use private registry\n-            String privateImage = getPrivateRegistry() + '/' + original.asCanonicalNameString();\n-            Log.info(c, \"apply\", \"Swapping docker image name from \" + original.asCanonicalNameString() + \" --> \" + privateImage);\n-            return DockerImageName.parse(privateImage).asCompatibleSubstituteFor(original);\n-        } else {\n+        // If we are using local docker, or a programmatically built image, or a registry was explicitly set,\n+        // we don't want to perform any substitution -- just return the original\n+        if (!ExternalTestServiceDockerClientStrategy.useRemoteDocker() ||\n+            isSyntheticImage(original) ||\n+            (original.getRegistry() != null && !original.getRegistry().isEmpty())) {\n             return original;\n         }\n+\n+        // Using remote docker, need to substitute image name to use private registry\n+        String privateImage = getPrivateRegistry() + '/' + original.asCanonicalNameString();\n+        Log.info(c, \"apply\", \"Swapping docker image name from \" + original.asCanonicalNameString() + \" --> \" + privateImage);\n+        return DockerImageName.parse(privateImage).asCompatibleSubstituteFor(original);\n     }\n \n     @Override\n"}}, {"oid": "7e0a096d72a8bc7a402b9da06f8bb2b3c5dc5a7c", "url": "https://github.com/OpenLiberty/open-liberty/commit/7e0a096d72a8bc7a402b9da06f8bb2b3c5dc5a7c", "message": "Fixes to various FATs after upgrading to Testcontainers 1.15.0", "committedDate": "2020-12-17T22:20:17Z", "type": "forcePushed"}, {"oid": "c33a778f776a86137fa817e5c70ccf93f3cd261d", "url": "https://github.com/OpenLiberty/open-liberty/commit/c33a778f776a86137fa817e5c70ccf93f3cd261d", "message": "Fixes to various FATs after upgrading to Testcontainers 1.15.0", "committedDate": "2020-12-19T05:21:27Z", "type": "forcePushed"}, {"oid": "400a584b17cb2bc128936f337f74179f023844e4", "url": "https://github.com/OpenLiberty/open-liberty/commit/400a584b17cb2bc128936f337f74179f023844e4", "message": "Upgrade to Testcontainers 1.15.0", "committedDate": "2020-12-19T05:25:08Z", "type": "commit"}, {"oid": "58fb7acc261515dcfa65499c3c0485285dc0a9b9", "url": "https://github.com/OpenLiberty/open-liberty/commit/58fb7acc261515dcfa65499c3c0485285dc0a9b9", "message": "Update FAT projects to use maven central mirror", "committedDate": "2020-12-19T05:25:09Z", "type": "commit"}, {"oid": "ba581668965fcc06e6cd19f15c868f7b91a808b2", "url": "https://github.com/OpenLiberty/open-liberty/commit/ba581668965fcc06e6cd19f15c868f7b91a808b2", "message": "Use private DockerHub mirror via ImageNameSubstitutor", "committedDate": "2020-12-19T05:25:09Z", "type": "commit"}, {"oid": "c4d2dd86fcf39ff14ab7eab4f1dd1aaf41a1a10c", "url": "https://github.com/OpenLiberty/open-liberty/commit/c4d2dd86fcf39ff14ab7eab4f1dd1aaf41a1a10c", "message": "Always use local docker for GH Actions", "committedDate": "2020-12-19T05:25:09Z", "type": "commit"}, {"oid": "695b6da97f4f7068d44f5bc5ff1304728af2df97", "url": "https://github.com/OpenLiberty/open-liberty/commit/695b6da97f4f7068d44f5bc5ff1304728af2df97", "message": "Update cloudant_fat to use static image", "committedDate": "2020-12-19T05:25:09Z", "type": "commit"}, {"oid": "6a79dbc955db742e84e081f6ecad142dabcd7bb5", "url": "https://github.com/OpenLiberty/open-liberty/commit/6a79dbc955db742e84e081f6ecad142dabcd7bb5", "message": "Use static image for couchdb_fat", "committedDate": "2020-12-19T05:25:10Z", "type": "commit"}, {"oid": "411aa85082ec2fff154fdd6a610a30e0a39f6f2b", "url": "https://github.com/OpenLiberty/open-liberty/commit/411aa85082ec2fff154fdd6a610a30e0a39f6f2b", "message": "Get auth token for custom docker config", "committedDate": "2020-12-19T05:25:10Z", "type": "commit"}, {"oid": "02c9a660516561b66c257965c5328e2855aef224", "url": "https://github.com/OpenLiberty/open-liberty/commit/02c9a660516561b66c257965c5328e2855aef224", "message": "Pull private registry token from Consul", "committedDate": "2020-12-19T05:25:10Z", "type": "commit"}, {"oid": "aaa84ec9da6215ab057b6813239cca6f9d73d24f", "url": "https://github.com/OpenLiberty/open-liberty/commit/aaa84ec9da6215ab057b6813239cca6f9d73d24f", "message": "Fixes to various FATs after upgrading to Testcontainers 1.15.0", "committedDate": "2020-12-19T05:25:10Z", "type": "commit"}, {"oid": "aaa84ec9da6215ab057b6813239cca6f9d73d24f", "url": "https://github.com/OpenLiberty/open-liberty/commit/aaa84ec9da6215ab057b6813239cca6f9d73d24f", "message": "Fixes to various FATs after upgrading to Testcontainers 1.15.0", "committedDate": "2020-12-19T05:25:10Z", "type": "forcePushed"}]}