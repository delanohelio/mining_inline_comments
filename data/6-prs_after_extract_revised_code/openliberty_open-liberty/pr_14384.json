{"pr_number": 14384, "pr_title": "allow components to add additional features when using EE9 repeat action", "pr_createdAt": "2020-10-07T22:48:56Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/14384", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM3NjU4Mg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14384#discussion_r501376582", "bodyText": "Looks like no change in the code here, just breaking it out into its own method right?", "author": "aguibert", "createdAt": "2020-10-08T00:01:53Z", "path": "dev/fattest.simplicity/src/componenttest/rules/repeater/FeatureReplacementAction.java", "diffHunk": "@@ -417,6 +383,45 @@ public void setup() throws Exception {\n             LibertyClientFactory.getLibertyClient(clientName);\n     }\n \n+    protected void swizzleFeatures(Set<String> features) {", "originalCommit": "7a9822756e1ff589cf23ee46df85cd06db2b18d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM3NzI3MA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14384#discussion_r501377270", "bodyText": "Suggested name change: swizzelFeatures --> replaceFeatures", "author": "aguibert", "createdAt": "2020-10-08T00:04:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM3NjU4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTgzMDQ2Mw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14384#discussion_r501830463", "bodyText": "Right - I had originally moved that to its own method in order to extend only that functionality.  If we make the change to the base class as you suggested later, then we no longer to split it out.", "author": "andymc12", "createdAt": "2020-10-08T15:53:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM3NjU4Mg=="}], "type": "inlineReview", "revised_code": {"commit": "e41fb1ec2395d89b575cfa4addbea01938d3cb81", "chunk": "diff --git a/dev/fattest.simplicity/src/componenttest/rules/repeater/FeatureReplacementAction.java b/dev/fattest.simplicity/src/componenttest/rules/repeater/FeatureReplacementAction.java\nindex e13fd39d4c..bfe10d7309 100644\n--- a/dev/fattest.simplicity/src/componenttest/rules/repeater/FeatureReplacementAction.java\n+++ b/dev/fattest.simplicity/src/componenttest/rules/repeater/FeatureReplacementAction.java\n\n@@ -383,45 +441,6 @@ public class FeatureReplacementAction implements RepeatTestAction {\n             LibertyClientFactory.getLibertyClient(clientName);\n     }\n \n-    protected void swizzleFeatures(Set<String> features) {\n-        final String m = \"swizzleFeatures\";\n-        // Convert feature set to all lowercase to prevent case sensitivity issues\n-        Set<String> intermediateFeatures = new TreeSet<>(features);\n-        features.clear();\n-        for (String f : intermediateFeatures)\n-            features.add(f.toLowerCase());\n-\n-        Log.info(c, m, \"Original features:  \" + features);\n-        if (forceAddFeatures) {\n-            features.removeAll(removeFeatures);\n-            //remove any wildcard features, before adding the new feature.\n-            for (String removeFeature : removeFeatures) {\n-                if (removeFeature.endsWith(\"*\")) {\n-                    removeWildcardFeature(features, removeFeature);\n-                }\n-            }\n-            features.addAll(addFeatures);\n-        } else {\n-            for (String removeFeature : removeFeatures) {\n-                boolean removed = false;\n-                if (removeFeature.endsWith(\"*\")) {\n-                    removed = removeWildcardFeature(features, removeFeature);\n-                } else if (features.remove(removeFeature)) {\n-                    removed = true;\n-                }\n-\n-                // If we found a feature to remove that is actually present in config file, then\n-                // replace it with the corresponding feature\n-                if (removed) {\n-                    String toAdd = getReplacementFeature(removeFeature, addFeatures);\n-                    if (toAdd != null)\n-                        features.add(toAdd);\n-                }\n-            }\n-        }\n-        Log.info(c, m, \"Resulting features: \" + features);\n-    }\n-\n     /**\n      * Obtain the replacement for a feature for this replacement action.\n      *\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM3NzY5MA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14384#discussion_r501377690", "bodyText": "If we are going to add this new API I think it makes sense to add it in FeatureReplacementAction so it can apply to all subclasses, rather than only putting it on the JakartaEE9Action", "author": "aguibert", "createdAt": "2020-10-08T00:05:45Z", "path": "dev/fattest.simplicity/src/componenttest/rules/repeater/JakartaEE9Action.java", "diffHunk": "@@ -133,6 +135,11 @@ public JakartaEE9Action addFeatures(Set<String> addFeatures) {\n         return (JakartaEE9Action) super.addFeatures(addFeatures);\n     }\n \n+    public JakartaEE9Action addAdditionalFeatures(Set<String> additionalFeatures) {", "originalCommit": "7a9822756e1ff589cf23ee46df85cd06db2b18d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM3ODkyMQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14384#discussion_r501378921", "bodyText": "Could we do a different name for this method? Without knowing the background it's not clear what \"additional features\" mean. The purpose of this new method is to \"add a feature that will always be added to configs\" (also referred to as \"force adding\"). So perhaps name change addAdditionalFeatures --> forceAddFeature or alwaysAddFeature. Another option could be overloading addFeatures with a boolean param for force add like: addFeatures(Set<String>, boolean forciblyAdd)\nWhatever method signature we go with, javadoc please!", "author": "aguibert", "createdAt": "2020-10-08T00:10:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM3NzY5MA=="}], "type": "inlineReview", "revised_code": {"commit": "e41fb1ec2395d89b575cfa4addbea01938d3cb81", "chunk": "diff --git a/dev/fattest.simplicity/src/componenttest/rules/repeater/JakartaEE9Action.java b/dev/fattest.simplicity/src/componenttest/rules/repeater/JakartaEE9Action.java\nindex 3b038ca9f6..ad905a2e10 100644\n--- a/dev/fattest.simplicity/src/componenttest/rules/repeater/JakartaEE9Action.java\n+++ b/dev/fattest.simplicity/src/componenttest/rules/repeater/JakartaEE9Action.java\n\n@@ -135,11 +133,6 @@ public class JakartaEE9Action extends FeatureReplacementAction {\n         return (JakartaEE9Action) super.addFeatures(addFeatures);\n     }\n \n-    public JakartaEE9Action addAdditionalFeatures(Set<String> additionalFeatures) {\n-        additionalFeatures.forEach(s -> this.additionalAddFeatures.add(s.toLowerCase()));\n-        return this;\n-    }\n-\n     @Override\n     public JakartaEE9Action removeFeature(String removeFeature) {\n         return (JakartaEE9Action) super.removeFeature(removeFeature);\n"}}, {"oid": "e41fb1ec2395d89b575cfa4addbea01938d3cb81", "url": "https://github.com/OpenLiberty/open-liberty/commit/e41fb1ec2395d89b575cfa4addbea01938d3cb81", "message": "allow components to add additional features when using EE9 repeat action", "committedDate": "2020-10-08T15:51:32Z", "type": "commit"}, {"oid": "e41fb1ec2395d89b575cfa4addbea01938d3cb81", "url": "https://github.com/OpenLiberty/open-liberty/commit/e41fb1ec2395d89b575cfa4addbea01938d3cb81", "message": "allow components to add additional features when using EE9 repeat action", "committedDate": "2020-10-08T15:51:32Z", "type": "forcePushed"}]}