{"pr_number": 15004, "pr_title": "Handle NPE during remote unbind if orb didn't come up", "pr_createdAt": "2020-11-17T16:50:29Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/15004", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI0MDgwMg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/15004#discussion_r526240802", "bodyText": "Seems we are starting at a leaf node, and if that context is empty, we unbind it from the parent, then back up one and check if that context is null, etc... all the way back to the root.  As soon as we find one that is not empty, we stop.\nHowever, now we will stop as soon as we find a \"null\" context.... but what if the parent context exists and is empty, shouldn't we back up one and check the parent as well?  If it does exist and is empty, seems we should unbind it.", "author": "tkburroughs", "createdAt": "2020-11-18T16:47:05Z", "path": "dev/com.ibm.ws.ejbcontainer.remote/src/com/ibm/ws/ejbcontainer/remote/internal/EJBRemoteRuntimeImpl.java", "diffHunk": "@@ -249,17 +250,23 @@ public synchronized void unbindAll(Object bindingDataObject) {\n             }\n         }\n \n-        for (int i = bindingData.contextNames.length - 1; i >= 0 && !hasBindings(bindingData.contexts[i]); i--) {\n+        // For contextNames, if completely empty of bindings, unbind the naming context from its parent context.\n+        for (int i = bindingData.contextNames.length - 1; i >= 0 && isBindingContextEmpty(bindingData.contexts[i]); i--) {", "originalCommit": "236bb3183d4e29218fc74037a00d0e32f99f9e47", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0be18345b8451130318ba0c21850ad91fe5506e1", "chunk": "diff --git a/dev/com.ibm.ws.ejbcontainer.remote/src/com/ibm/ws/ejbcontainer/remote/internal/EJBRemoteRuntimeImpl.java b/dev/com.ibm.ws.ejbcontainer.remote/src/com/ibm/ws/ejbcontainer/remote/internal/EJBRemoteRuntimeImpl.java\nindex 46dfb80079..4524ad3afd 100644\n--- a/dev/com.ibm.ws.ejbcontainer.remote/src/com/ibm/ws/ejbcontainer/remote/internal/EJBRemoteRuntimeImpl.java\n+++ b/dev/com.ibm.ws.ejbcontainer.remote/src/com/ibm/ws/ejbcontainer/remote/internal/EJBRemoteRuntimeImpl.java\n\n@@ -251,9 +251,11 @@ public class EJBRemoteRuntimeImpl implements EJBRemoteRuntime, RemoteObjectRepla\n         }\n \n         // For contextNames, if completely empty of bindings, unbind the naming context from its parent context.\n-        for (int i = bindingData.contextNames.length - 1; i >= 0 && isBindingContextEmpty(bindingData.contexts[i]); i--) {\n-            NamingContext parentContext = i == 0 ? rootNamingContext : bindingData.contexts[i - 1];\n-            unbind(parentContext, bindingData.contextNames[i]);\n+        for (int i = bindingData.contextNames.length - 1; i >= 0; i--) {\n+            if (isBindingContextEmpty(bindingData.contexts[i])) {\n+                NamingContext parentContext = i == 0 ? rootNamingContext : bindingData.contexts[i - 1];\n+                unbind(parentContext, bindingData.contextNames[i]);\n+            }\n         }\n     }\n \n"}}, {"oid": "0be18345b8451130318ba0c21850ad91fe5506e1", "url": "https://github.com/OpenLiberty/open-liberty/commit/0be18345b8451130318ba0c21850ad91fe5506e1", "message": "Handle NPE during remote unbind if orb didn't come up", "committedDate": "2020-11-18T16:59:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMyNzEwMA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/15004#discussion_r526327100", "bodyText": "This is better, but inefficient.  The code used to stop at the first non-empty list, but will now keep going.  The logic here is skipped, but isBindingContextEmpty will continue to be called and creates several objects and creates a list.  Could we have isBindingContextEmpty return Boolean, so we could tell the difference between True, False, and null?", "author": "tkburroughs", "createdAt": "2020-11-18T18:31:06Z", "path": "dev/com.ibm.ws.ejbcontainer.remote/src/com/ibm/ws/ejbcontainer/remote/internal/EJBRemoteRuntimeImpl.java", "diffHunk": "@@ -249,17 +250,25 @@ public synchronized void unbindAll(Object bindingDataObject) {\n             }\n         }\n \n-        for (int i = bindingData.contextNames.length - 1; i >= 0 && !hasBindings(bindingData.contexts[i]); i--) {\n-            NamingContext parentContext = i == 0 ? rootNamingContext : bindingData.contexts[i - 1];\n-            unbind(parentContext, bindingData.contextNames[i]);\n+        // For contextNames, if completely empty of bindings, unbind the naming context from its parent context.\n+        for (int i = bindingData.contextNames.length - 1; i >= 0; i--) {\n+            if (isBindingContextEmpty(bindingData.contexts[i])) {", "originalCommit": "0be18345b8451130318ba0c21850ad91fe5506e1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "209510ebe2ed3a163b15d63232aa80f850d50a3c", "chunk": "diff --git a/dev/com.ibm.ws.ejbcontainer.remote/src/com/ibm/ws/ejbcontainer/remote/internal/EJBRemoteRuntimeImpl.java b/dev/com.ibm.ws.ejbcontainer.remote/src/com/ibm/ws/ejbcontainer/remote/internal/EJBRemoteRuntimeImpl.java\nindex 4524ad3afd..d3bb476b4c 100644\n--- a/dev/com.ibm.ws.ejbcontainer.remote/src/com/ibm/ws/ejbcontainer/remote/internal/EJBRemoteRuntimeImpl.java\n+++ b/dev/com.ibm.ws.ejbcontainer.remote/src/com/ibm/ws/ejbcontainer/remote/internal/EJBRemoteRuntimeImpl.java\n\n@@ -252,23 +252,28 @@ public class EJBRemoteRuntimeImpl implements EJBRemoteRuntime, RemoteObjectRepla\n \n         // For contextNames, if completely empty of bindings, unbind the naming context from its parent context.\n         for (int i = bindingData.contextNames.length - 1; i >= 0; i--) {\n-            if (isBindingContextEmpty(bindingData.contexts[i])) {\n-                NamingContext parentContext = i == 0 ? rootNamingContext : bindingData.contexts[i - 1];\n-                unbind(parentContext, bindingData.contextNames[i]);\n+            Boolean contextEmpty = isBindingContextEmpty(bindingData.contexts[i]);\n+            if (contextEmpty == null) {\n+                continue;\n             }\n+            if (contextEmpty.booleanValue() == false) {\n+                break;\n+            }\n+            NamingContext parentContext = i == 0 ? rootNamingContext : bindingData.contexts[i - 1];\n+            unbind(parentContext, bindingData.contextNames[i]);\n         }\n     }\n \n-    private boolean isBindingContextEmpty(NamingContext context) {\n+    private Boolean isBindingContextEmpty(NamingContext context) {\n         // If the namingContext is null it possibly didn't come up.\n         // Either way we don't need to unbind it from it's parent context (we will get NPE) so just return false\n         if (context == null) {\n-            return false;\n+            return null;\n         }\n         BindingListHolder blh = new BindingListHolder();\n         BindingIteratorHolder bih = new BindingIteratorHolder();\n         context.list(1, blh, bih);\n-        return blh.value.length == 0;\n+        return new Boolean(blh.value.length == 0);\n     }\n \n     private void unbind(NamingContext context, String name) {\n"}}, {"oid": "209510ebe2ed3a163b15d63232aa80f850d50a3c", "url": "https://github.com/OpenLiberty/open-liberty/commit/209510ebe2ed3a163b15d63232aa80f850d50a3c", "message": "Handle NPE during remote unbind if orb didn't come up", "committedDate": "2020-11-19T15:31:29Z", "type": "forcePushed"}, {"oid": "1d526dbbb007562777e6d18690c7e892f780d39e", "url": "https://github.com/OpenLiberty/open-liberty/commit/1d526dbbb007562777e6d18690c7e892f780d39e", "message": "Handle NPE during remote unbind if orb didn't come up", "committedDate": "2020-11-19T15:36:18Z", "type": "commit"}, {"oid": "1d526dbbb007562777e6d18690c7e892f780d39e", "url": "https://github.com/OpenLiberty/open-liberty/commit/1d526dbbb007562777e6d18690c7e892f780d39e", "message": "Handle NPE during remote unbind if orb didn't come up", "committedDate": "2020-11-19T15:36:18Z", "type": "forcePushed"}]}