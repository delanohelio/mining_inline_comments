{"pr_number": 14606, "pr_title": "Issue #14600: Fix a performance degradation that was introduced when \u2026", "pr_createdAt": "2020-10-21T15:35:11Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/14606", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTUzNzI1Mw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14606#discussion_r509537253", "bodyText": "In general this whole method is an anti-pattern.  Usually this is handled with a service being applied to the instance and this not being calculated on EVERY web request.  In order to reduce the extra processing of getting the installed features I suggest to change this to the below for now in order to get us back to close to where we were.\n        if (WebContainer.getServletContainerSpecLevel() < WebContainer.SPEC_LEVEL_40) {\n            return false;\n        }\n        Set<String> features = provisionerService.getInstalledFeatures();\n        return features.contains(\"appSecurity-3.0\") || features.contains(\"appSecurity-4.0\");", "author": "jhanders34", "createdAt": "2020-10-21T18:09:25Z", "path": "dev/com.ibm.ws.webcontainer.security/src/com/ibm/ws/webcontainer/security/WebAppSecurityCollaboratorImpl.java", "diffHunk": "@@ -461,31 +461,16 @@ public void handleException(HttpServletRequest req, HttpServletResponse rsp, Thr\n     }\n \n     @Override\n-    @FFDCIgnore(NumberFormatException.class)\n     public boolean isCDINeeded() {\n-        int specLevel = WebContainer.getServletContainerSpecLevel();\n-\n-        /*\n-         * Determine which version of appSecurity we are running.\n-         */\n-        Set<String> installedFeatures = provisionerService.getInstalledFeatures();\n-        float appSecurityVers = 0.0f;\n-        for (String feature : installedFeatures) {\n-            if (feature.startsWith(\"appSecurity-\")) {\n-                try {\n-                    appSecurityVers = Float.valueOf(feature.substring(12));\n-                    break;\n-                } catch (NumberFormatException e) {\n-                    // Ignore. Not the feature we are looking for.\n-                }\n-            }\n-        }\n-\n         /*\n-         * Future-proof check. Some of these combinations aren't valid, but\n-         * they will not make it this far.\n+         * Tried to future-proof this check by iterating over all the\n+         * installed features and finding the version of appSecurity installed,\n+         * but that introduced a performance degradation. So for now, checking\n+         * for the appSecurity-3.0/4.0 features directly.\n          */\n-        return appSecurityVers >= 3.0 && specLevel >= WebContainer.SPEC_LEVEL_40;\n+        return WebContainer.getServletContainerSpecLevel() >= WebContainer.SPEC_LEVEL_40 &&", "originalCommit": "9de875552242ee2043ca07d0bdcdcc833cc55242", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTYwNDA2MQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14606#discussion_r509604061", "bodyText": "Made this change.", "author": "jvanhill", "createdAt": "2020-10-21T19:19:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTUzNzI1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "8eccb2c9d7803275d21bc863a10c05548f32405e", "chunk": "diff --git a/dev/com.ibm.ws.webcontainer.security/src/com/ibm/ws/webcontainer/security/WebAppSecurityCollaboratorImpl.java b/dev/com.ibm.ws.webcontainer.security/src/com/ibm/ws/webcontainer/security/WebAppSecurityCollaboratorImpl.java\nindex ff8fe33de2..3417b1aaa0 100644\n--- a/dev/com.ibm.ws.webcontainer.security/src/com/ibm/ws/webcontainer/security/WebAppSecurityCollaboratorImpl.java\n+++ b/dev/com.ibm.ws.webcontainer.security/src/com/ibm/ws/webcontainer/security/WebAppSecurityCollaboratorImpl.java\n\n@@ -468,9 +468,11 @@ public class WebAppSecurityCollaboratorImpl implements IWebAppSecurityCollaborat\n          * but that introduced a performance degradation. So for now, checking\n          * for the appSecurity-3.0/4.0 features directly.\n          */\n-        return WebContainer.getServletContainerSpecLevel() >= WebContainer.SPEC_LEVEL_40 &&\n-\t       (provisionerService.getInstalledFeatures().contains(\"appSecurity-3.0\") ||\n-                provisionerService.getInstalledFeatures().contains(\"appSecurity-4.0\"));\n+        if (WebContainer.getServletContainerSpecLevel() < WebContainer.SPEC_LEVEL_40) {\n+            return false;\n+        }\n+        Set<String> features = provisionerService.getInstalledFeatures();\n+\treturn features.contains(\"appSecurity-3.0\") || features.contains(\"appSecurity-4.0\"));\n     }\n \n     /**\n"}}, {"oid": "8eccb2c9d7803275d21bc863a10c05548f32405e", "url": "https://github.com/OpenLiberty/open-liberty/commit/8eccb2c9d7803275d21bc863a10c05548f32405e", "message": "Issue #14600: Fix a performance degradation that was introduced when checking whether CDI was needed for Jakarta EE9.", "committedDate": "2020-10-21T19:19:09Z", "type": "forcePushed"}, {"oid": "304a49e9030757026e543f0048ce24af15ff1778", "url": "https://github.com/OpenLiberty/open-liberty/commit/304a49e9030757026e543f0048ce24af15ff1778", "message": "Issue #14600: Fix a performance degradation that was introduced when checking whether CDI was needed for Jakarta EE9.", "committedDate": "2020-10-23T13:27:44Z", "type": "forcePushed"}, {"oid": "6536c2f513ce80f85377368e43aaf0291aaaf63c", "url": "https://github.com/OpenLiberty/open-liberty/commit/6536c2f513ce80f85377368e43aaf0291aaaf63c", "message": "Issue #14600: Fix a performance degradation that was introduced when checking whether CDI was needed for Jakarta EE9.", "committedDate": "2020-10-25T19:51:16Z", "type": "forcePushed"}, {"oid": "652e439435abd7be84b568bcdef49de29306d483", "url": "https://github.com/OpenLiberty/open-liberty/commit/652e439435abd7be84b568bcdef49de29306d483", "message": "Issue #14600: Fix a performance degradation that was introduced when checking whether CDI was needed for Jakarta EE9.", "committedDate": "2020-10-26T13:20:20Z", "type": "commit"}, {"oid": "652e439435abd7be84b568bcdef49de29306d483", "url": "https://github.com/OpenLiberty/open-liberty/commit/652e439435abd7be84b568bcdef49de29306d483", "message": "Issue #14600: Fix a performance degradation that was introduced when checking whether CDI was needed for Jakarta EE9.", "committedDate": "2020-10-26T13:20:20Z", "type": "forcePushed"}]}