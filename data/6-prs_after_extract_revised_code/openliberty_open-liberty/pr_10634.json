{"pr_number": 10634, "pr_title": "Added new async request context test for when Future.cancel() occurs", "pr_createdAt": "2020-01-29T16:55:10Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/10634", "timeline": [{"oid": "015225b94b62a7e4967c13f05f2e7604f95d900d", "url": "https://github.com/OpenLiberty/open-liberty/commit/015225b94b62a7e4967c13f05f2e7604f95d900d", "message": "Added new async request context tests for when Future.cancel() occurs", "committedDate": "2020-01-29T16:47:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjUzMjE5Nw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10634#discussion_r372532197", "bodyText": "This assert won't cause the test to fail correctly as it's inside the executor's callable and the result of that is thrown away because you cancel the execution.\nHowever, if this assert ever did fail, you wouldn't call countDown() on line 222 and then your test would hang waiting for it on line 231.\nI don't really think this check is necessary as you're already testing this elsewhere, so you can just take it out.", "author": "Azquelt", "createdAt": "2020-01-29T17:43:20Z", "path": "dev/com.ibm.ws.microprofile.faulttolerance.2.0/test/src/com/ibm/ws/microprofile/faulttolerance/test/AsyncTest.java", "diffHunk": "@@ -204,6 +202,46 @@ public void testAsyncRequestContextDeactivatedOnInterruption() throws Interrupte\n         }\n     }\n \n+    @Test\n+    public void testAsyncRequestContextDeactivatedOnInterruption() throws InterruptedException, ExecutionException, TimeoutException, TestException {\n+        ExecutorBuilder<String> builder = FaultToleranceProvider.newExecutionBuilder();\n+\n+        MockAsyncRequestContextController asyncRequestContextController = new MockAsyncRequestContextController();\n+        builder.setRequestContextController(asyncRequestContextController);\n+\n+        Executor<Future<String>> executor = builder.buildAsync(Future.class);\n+        ExecutionContext context = executor.newExecutionContext(\"testAsyncCS\", null);\n+\n+        CountDownLatch startSignal = new CountDownLatch(1); // Prevents the execution from being interrupted until request context is set\n+\n+        // Test an execution which is cancelled\n+        Future<String> result = executor.execute(() -> {\n+            assertEquals(\"Activate request context should be called when request is started\", 1, asyncRequestContextController.getActivateContextCount());", "originalCommit": "015225b94b62a7e4967c13f05f2e7604f95d900d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjgxODU2OA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10634#discussion_r372818568", "bodyText": "Okay that's great, thanks for the explanation", "author": "Joseph-Cass", "createdAt": "2020-01-30T08:42:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjUzMjE5Nw=="}], "type": "inlineReview", "revised_code": {"commit": "b5437325621bf1ce14a05981fd60aa20870d00ba", "chunk": "diff --git a/dev/com.ibm.ws.microprofile.faulttolerance.2.0/test/src/com/ibm/ws/microprofile/faulttolerance/test/AsyncTest.java b/dev/com.ibm.ws.microprofile.faulttolerance.2.0/test/src/com/ibm/ws/microprofile/faulttolerance/test/AsyncTest.java\nindex 34fa44d629..1688ca1858 100644\n--- a/dev/com.ibm.ws.microprofile.faulttolerance.2.0/test/src/com/ibm/ws/microprofile/faulttolerance/test/AsyncTest.java\n+++ b/dev/com.ibm.ws.microprofile.faulttolerance.2.0/test/src/com/ibm/ws/microprofile/faulttolerance/test/AsyncTest.java\n\n@@ -195,6 +196,7 @@ public class AsyncTest extends AbstractFTTest {\n         try {\n             // Give the execution up to 5 seconds to complete\n             result.get(5, TimeUnit.SECONDS);\n+            fail(\"ExecutionException should be thrown\");\n         } catch (ExecutionException e) {\n             assertThat(e.getCause(), instanceOf(TestException.class));\n             assertEquals(\"Activate request context should have been called\", 1, asyncRequestContextController.getActivateContextCount());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjUzMzU5MA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10634#discussion_r372533590", "bodyText": "Add a timeout here as we don't want to wait forever. Also then assert that it returned true.", "author": "Azquelt", "createdAt": "2020-01-29T17:46:01Z", "path": "dev/com.ibm.ws.microprofile.faulttolerance.2.0/test/src/com/ibm/ws/microprofile/faulttolerance/test/AsyncTest.java", "diffHunk": "@@ -204,6 +202,46 @@ public void testAsyncRequestContextDeactivatedOnInterruption() throws Interrupte\n         }\n     }\n \n+    @Test\n+    public void testAsyncRequestContextDeactivatedOnInterruption() throws InterruptedException, ExecutionException, TimeoutException, TestException {\n+        ExecutorBuilder<String> builder = FaultToleranceProvider.newExecutionBuilder();\n+\n+        MockAsyncRequestContextController asyncRequestContextController = new MockAsyncRequestContextController();\n+        builder.setRequestContextController(asyncRequestContextController);\n+\n+        Executor<Future<String>> executor = builder.buildAsync(Future.class);\n+        ExecutionContext context = executor.newExecutionContext(\"testAsyncCS\", null);\n+\n+        CountDownLatch startSignal = new CountDownLatch(1); // Prevents the execution from being interrupted until request context is set\n+\n+        // Test an execution which is cancelled\n+        Future<String> result = executor.execute(() -> {\n+            assertEquals(\"Activate request context should be called when request is started\", 1, asyncRequestContextController.getActivateContextCount());\n+\n+            // Allow the execution to be interrupted\n+            startSignal.countDown();\n+\n+            // Wait for up to 10 seconds for the execution to be interrupted\n+            Thread.sleep(FUTURE_TIMEOUT);\n+\n+            return null;\n+        }, context);\n+\n+        // Wait for the execution to have started before interrupting\n+        startSignal.await();", "originalCommit": "015225b94b62a7e4967c13f05f2e7604f95d900d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b5437325621bf1ce14a05981fd60aa20870d00ba", "chunk": "diff --git a/dev/com.ibm.ws.microprofile.faulttolerance.2.0/test/src/com/ibm/ws/microprofile/faulttolerance/test/AsyncTest.java b/dev/com.ibm.ws.microprofile.faulttolerance.2.0/test/src/com/ibm/ws/microprofile/faulttolerance/test/AsyncTest.java\nindex 34fa44d629..1688ca1858 100644\n--- a/dev/com.ibm.ws.microprofile.faulttolerance.2.0/test/src/com/ibm/ws/microprofile/faulttolerance/test/AsyncTest.java\n+++ b/dev/com.ibm.ws.microprofile.faulttolerance.2.0/test/src/com/ibm/ws/microprofile/faulttolerance/test/AsyncTest.java\n\n@@ -195,6 +196,7 @@ public class AsyncTest extends AbstractFTTest {\n         try {\n             // Give the execution up to 5 seconds to complete\n             result.get(5, TimeUnit.SECONDS);\n+            fail(\"ExecutionException should be thrown\");\n         } catch (ExecutionException e) {\n             assertThat(e.getCause(), instanceOf(TestException.class));\n             assertEquals(\"Activate request context should have been called\", 1, asyncRequestContextController.getActivateContextCount());\n"}}, {"oid": "b5437325621bf1ce14a05981fd60aa20870d00ba", "url": "https://github.com/OpenLiberty/open-liberty/commit/b5437325621bf1ce14a05981fd60aa20870d00ba", "message": "Added await timeout and removed unnecessary assert", "committedDate": "2020-01-30T09:07:29Z", "type": "commit"}]}