{"pr_number": 12250, "pr_title": "Fix for jakarta feature name change", "pr_createdAt": "2020-05-19T01:29:53Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/12250", "timeline": [{"oid": "79154ab0d7619ce1411ad8624427c23315c7e03d", "url": "https://github.com/OpenLiberty/open-liberty/commit/79154ab0d7619ce1411ad8624427c23315c7e03d", "message": "Added simple fix for jakarta feature name change", "committedDate": "2020-05-19T14:26:35Z", "type": "forcePushed"}, {"oid": "6828a5d5612f514e4a845aed26eeffc31266974a", "url": "https://github.com/OpenLiberty/open-liberty/commit/6828a5d5612f514e4a845aed26eeffc31266974a", "message": "Clean up changes", "committedDate": "2020-07-14T14:22:16Z", "type": "forcePushed"}, {"oid": "0c831075057cd1264ab85d205f0b6ace41fa26c9", "url": "https://github.com/OpenLiberty/open-liberty/commit/0c831075057cd1264ab85d205f0b6ace41fa26c9", "message": "Clean up changes", "committedDate": "2020-07-14T16:03:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU1NzMwMg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12250#discussion_r454557302", "bodyText": "we can remove this case, or throw an exception here. All public features should have a version component", "author": "aguibert", "createdAt": "2020-07-14T18:25:56Z", "path": "dev/fattest.simplicity/src/componenttest/rules/repeater/FeatureReplacementAction.java", "diffHunk": "@@ -378,14 +390,54 @@ public void setup() throws Exception {\n             LibertyClientFactory.getLibertyClient(clientName);\n     }\n \n-    private static String getReplacementFeature(String originalFeature, Set<String> featuresToAdd) {\n+    /**\n+     * Obtain the replacement for a feature for this replacement action.\n+     * \n+     * The lookup uses the base feature name, which is the feature name up to\n+     * the first '-' character.\n+     * \n+     * If EE9 replacement is active, allow the base feature name to be replaced\n+     * with an EE9 replacement.\n+     * \n+     * If no replacement is located, answer null, which indicates that the feature\n+     * should be removed instead of being replaced.\n+     *\n+     * Feature names are required to have a '-', for example, \"servlet-3.1\".  Null\n+     * is answered for feature names which do not have a '-'.\n+     *\n+     * @param originalFeature The feature name which is to be replaced.\n+     * @param replacementFeatures Table of replacement features.\n+     *\n+     * @return The replacement feature name.  Null if no replacement is available.\n+     */\n+    private static String getReplacementFeature(String originalFeature, Set<String> replacementFeatures) {\n+        String methodName = \"getReplacementFeature\";\n         // Example: servlet-3.1 --> servlet-4.0\n-        String featureBasename = originalFeature.substring(0, originalFeature.indexOf('-') + 1); // \"servlet-\"\n-        for (String featureToAdd : featuresToAdd)\n-            if (featureToAdd.contains(featureBasename)) // \"servlet-4.0\".contains(\"servlet-\")\n-                return featureToAdd;\n+        int dashOffset = originalFeature.indexOf('-');\n+        if ( dashOffset == -1 ) {\n+            Log.info(c, methodName, \"Remove feature [ \" + originalFeature +  \" ]: No '-' was found.\");\n+            return null;\n+        }", "originalCommit": "0c831075057cd1264ab85d205f0b6ace41fa26c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc1MjQ0Mw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12250#discussion_r454752443", "bodyText": "Ok sounds good Ill make the change to throw an exception since it could be possible that manually someone adds a feature and mistakenly leaves out the '-' so that would be a good debug as to why it failed", "author": "isaacrivriv", "createdAt": "2020-07-15T02:27:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU1NzMwMg=="}], "type": "inlineReview", "revised_code": {"commit": "03c259c210fcfa1bca38b49bd129b2c068df8874", "chunk": "diff --git a/dev/fattest.simplicity/src/componenttest/rules/repeater/FeatureReplacementAction.java b/dev/fattest.simplicity/src/componenttest/rules/repeater/FeatureReplacementAction.java\nindex 97f9f6a69a..abd54461a9 100644\n--- a/dev/fattest.simplicity/src/componenttest/rules/repeater/FeatureReplacementAction.java\n+++ b/dev/fattest.simplicity/src/componenttest/rules/repeater/FeatureReplacementAction.java\n\n@@ -414,21 +414,44 @@ public class FeatureReplacementAction implements RepeatTestAction {\n         String methodName = \"getReplacementFeature\";\n         // Example: servlet-3.1 --> servlet-4.0\n         int dashOffset = originalFeature.indexOf('-');\n-        if ( dashOffset == -1 ) {\n-            Log.info(c, methodName, \"Remove feature [ \" + originalFeature +  \" ]: No '-' was found.\");\n-            return null;\n-        }\n+        if ( dashOffset == -1 )\n+            throw new IllegalArgumentException(\"Remove feature [ \" + originalFeature +  \" ]: No '-' was found.\");\n         // \"servlet-3.1\" ==> \"servlet\"\n-        String baseFeature = originalFeature.substring(0, dashOffset);\n-        if ( JakartaEE9Action.isActive() ) {\n-            String ee9BaseFeature = featuresWithNameChangeOnEE9.get(baseFeature);\n-            if ( ee9BaseFeature != null ) {\n-                Log.info(c, methodName, \"Replace base feature [ \" + baseFeature +  \" ] with EE9 feature [ \" + ee9BaseFeature + \" ]\");\n-                baseFeature = ee9BaseFeature;\n+        String baseFeature = originalFeature.substring(0, dashOffset + 1);\n+        // \"servlet-4.0\".contains(\"servlet-\")\n+        for ( String replacementFeature : replacementFeatures ) {\n+            if ( replacementFeature.contains(baseFeature) )  {\n+                Log.info(c, methodName, \"Replace feature [ \" + originalFeature +  \" ] with [ \" + replacementFeature + \" ]\");\n+                return replacementFeature;\n             }\n         }\n+        // We need to check that the feature passed is an EE7/EE8 feature which could have a name change on EE9 that doesnt match \n+        // the original feature name it replaces. We also check viceversa if the feature is an EE9 feature that involves a name change\n+        // to update from EE9 to EE7/EE8\n+        Log.info(c, methodName, \"No feature replacement found for [ \" + originalFeature +  \" ]. Verifying if feature name was changed on EE9.\");\n+        // Reset base feature to not include the \"-\"\n+        baseFeature = baseFeature.substring(0, dashOffset);\n+        String featureReplacement = null;\n+        for (Map.Entry<String, String> nameChangeEntry : featuresWithNameChangeOnEE9.entrySet()) {\n+            if(nameChangeEntry.getValue().equals(baseFeature)){\n+                featureReplacement = nameChangeEntry.getKey();\n+                Log.info(c, methodName, \"Replace EE9 feature [ \" + baseFeature +  \" ] with feature [ \" + featureReplacement + \" ]\");\n+                baseFeature = featureReplacement;\n+                break;\n+            }\n+            if(nameChangeEntry.getKey().equals(baseFeature)){\n+                featureReplacement = nameChangeEntry.getValue();\n+                Log.info(c, methodName, \"Replace base feature [ \" + baseFeature +  \" ] with EE9 feature [ \" + featureReplacement + \" ]\");\n+                baseFeature = featureReplacement;\n+                break;\n+            }\n+        }\n+        if ( featureReplacement == null ) {\n+            Log.info(c, methodName, \"Remove feature [ \" + originalFeature +  \" ]: No replacement is available\");\n+            return null;\n+        }\n         baseFeature += \"-\";\n-        // \"servlet-4.0\".contains(\"servlet-\")\n+        // Re-check the features with the name changes\n         for ( String replacementFeature : replacementFeatures ) {\n             if ( replacementFeature.contains(baseFeature) )  {\n                 Log.info(c, methodName, \"Replace feature [ \" + originalFeature +  \" ] with [ \" + replacementFeature + \" ]\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU1OTg1Mg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12250#discussion_r454559852", "bodyText": "Lets move this block after the standard replacement block -- we should prefer standard replacements over the special case replacements generally.\nAlso, we need to support both directions: EE7/8 --> EE9 but also EE9 --> EE7/8\nFor this we can simply iterate over featuresWithNameChangeOnEE9.entrySet() and check if replacementFeature is the key or the value, and if it is, check the opposite entry (value or key respectively) for the replacement.", "author": "aguibert", "createdAt": "2020-07-14T18:30:16Z", "path": "dev/fattest.simplicity/src/componenttest/rules/repeater/FeatureReplacementAction.java", "diffHunk": "@@ -378,14 +390,54 @@ public void setup() throws Exception {\n             LibertyClientFactory.getLibertyClient(clientName);\n     }\n \n-    private static String getReplacementFeature(String originalFeature, Set<String> featuresToAdd) {\n+    /**\n+     * Obtain the replacement for a feature for this replacement action.\n+     * \n+     * The lookup uses the base feature name, which is the feature name up to\n+     * the first '-' character.\n+     * \n+     * If EE9 replacement is active, allow the base feature name to be replaced\n+     * with an EE9 replacement.\n+     * \n+     * If no replacement is located, answer null, which indicates that the feature\n+     * should be removed instead of being replaced.\n+     *\n+     * Feature names are required to have a '-', for example, \"servlet-3.1\".  Null\n+     * is answered for feature names which do not have a '-'.\n+     *\n+     * @param originalFeature The feature name which is to be replaced.\n+     * @param replacementFeatures Table of replacement features.\n+     *\n+     * @return The replacement feature name.  Null if no replacement is available.\n+     */\n+    private static String getReplacementFeature(String originalFeature, Set<String> replacementFeatures) {\n+        String methodName = \"getReplacementFeature\";\n         // Example: servlet-3.1 --> servlet-4.0\n-        String featureBasename = originalFeature.substring(0, originalFeature.indexOf('-') + 1); // \"servlet-\"\n-        for (String featureToAdd : featuresToAdd)\n-            if (featureToAdd.contains(featureBasename)) // \"servlet-4.0\".contains(\"servlet-\")\n-                return featureToAdd;\n+        int dashOffset = originalFeature.indexOf('-');\n+        if ( dashOffset == -1 ) {\n+            Log.info(c, methodName, \"Remove feature [ \" + originalFeature +  \" ]: No '-' was found.\");\n+            return null;\n+        }\n+        // \"servlet-3.1\" ==> \"servlet\"\n+        String baseFeature = originalFeature.substring(0, dashOffset);\n+        if ( JakartaEE9Action.isActive() ) {\n+            String ee9BaseFeature = featuresWithNameChangeOnEE9.get(baseFeature);\n+            if ( ee9BaseFeature != null ) {\n+                Log.info(c, methodName, \"Replace base feature [ \" + baseFeature +  \" ] with EE9 feature [ \" + ee9BaseFeature + \" ]\");\n+                baseFeature = ee9BaseFeature;\n+            }\n+        }", "originalCommit": "0c831075057cd1264ab85d205f0b6ace41fa26c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc1Mjg1Ng==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12250#discussion_r454752856", "bodyText": "Ok sounds good Ill make the change", "author": "isaacrivriv", "createdAt": "2020-07-15T02:29:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU1OTg1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "03c259c210fcfa1bca38b49bd129b2c068df8874", "chunk": "diff --git a/dev/fattest.simplicity/src/componenttest/rules/repeater/FeatureReplacementAction.java b/dev/fattest.simplicity/src/componenttest/rules/repeater/FeatureReplacementAction.java\nindex 97f9f6a69a..abd54461a9 100644\n--- a/dev/fattest.simplicity/src/componenttest/rules/repeater/FeatureReplacementAction.java\n+++ b/dev/fattest.simplicity/src/componenttest/rules/repeater/FeatureReplacementAction.java\n\n@@ -414,21 +414,44 @@ public class FeatureReplacementAction implements RepeatTestAction {\n         String methodName = \"getReplacementFeature\";\n         // Example: servlet-3.1 --> servlet-4.0\n         int dashOffset = originalFeature.indexOf('-');\n-        if ( dashOffset == -1 ) {\n-            Log.info(c, methodName, \"Remove feature [ \" + originalFeature +  \" ]: No '-' was found.\");\n-            return null;\n-        }\n+        if ( dashOffset == -1 )\n+            throw new IllegalArgumentException(\"Remove feature [ \" + originalFeature +  \" ]: No '-' was found.\");\n         // \"servlet-3.1\" ==> \"servlet\"\n-        String baseFeature = originalFeature.substring(0, dashOffset);\n-        if ( JakartaEE9Action.isActive() ) {\n-            String ee9BaseFeature = featuresWithNameChangeOnEE9.get(baseFeature);\n-            if ( ee9BaseFeature != null ) {\n-                Log.info(c, methodName, \"Replace base feature [ \" + baseFeature +  \" ] with EE9 feature [ \" + ee9BaseFeature + \" ]\");\n-                baseFeature = ee9BaseFeature;\n+        String baseFeature = originalFeature.substring(0, dashOffset + 1);\n+        // \"servlet-4.0\".contains(\"servlet-\")\n+        for ( String replacementFeature : replacementFeatures ) {\n+            if ( replacementFeature.contains(baseFeature) )  {\n+                Log.info(c, methodName, \"Replace feature [ \" + originalFeature +  \" ] with [ \" + replacementFeature + \" ]\");\n+                return replacementFeature;\n             }\n         }\n+        // We need to check that the feature passed is an EE7/EE8 feature which could have a name change on EE9 that doesnt match \n+        // the original feature name it replaces. We also check viceversa if the feature is an EE9 feature that involves a name change\n+        // to update from EE9 to EE7/EE8\n+        Log.info(c, methodName, \"No feature replacement found for [ \" + originalFeature +  \" ]. Verifying if feature name was changed on EE9.\");\n+        // Reset base feature to not include the \"-\"\n+        baseFeature = baseFeature.substring(0, dashOffset);\n+        String featureReplacement = null;\n+        for (Map.Entry<String, String> nameChangeEntry : featuresWithNameChangeOnEE9.entrySet()) {\n+            if(nameChangeEntry.getValue().equals(baseFeature)){\n+                featureReplacement = nameChangeEntry.getKey();\n+                Log.info(c, methodName, \"Replace EE9 feature [ \" + baseFeature +  \" ] with feature [ \" + featureReplacement + \" ]\");\n+                baseFeature = featureReplacement;\n+                break;\n+            }\n+            if(nameChangeEntry.getKey().equals(baseFeature)){\n+                featureReplacement = nameChangeEntry.getValue();\n+                Log.info(c, methodName, \"Replace base feature [ \" + baseFeature +  \" ] with EE9 feature [ \" + featureReplacement + \" ]\");\n+                baseFeature = featureReplacement;\n+                break;\n+            }\n+        }\n+        if ( featureReplacement == null ) {\n+            Log.info(c, methodName, \"Remove feature [ \" + originalFeature +  \" ]: No replacement is available\");\n+            return null;\n+        }\n         baseFeature += \"-\";\n-        // \"servlet-4.0\".contains(\"servlet-\")\n+        // Re-check the features with the name changes\n         for ( String replacementFeature : replacementFeatures ) {\n             if ( replacementFeature.contains(baseFeature) )  {\n                 Log.info(c, methodName, \"Replace feature [ \" + originalFeature +  \" ] with [ \" + replacementFeature + \" ]\");\n"}}, {"oid": "03c259c210fcfa1bca38b49bd129b2c068df8874", "url": "https://github.com/OpenLiberty/open-liberty/commit/03c259c210fcfa1bca38b49bd129b2c068df8874", "message": "Made requested changes\n- Updated feature replacement to use default the base features and later check for renamed features\n- Updated feature replacement so renamed features works both ee9->ee7/ee8 and ee7/ee8->ee9\n- Updated feature replacement to throw exception if dash is omitted", "committedDate": "2020-07-15T16:00:28Z", "type": "forcePushed"}, {"oid": "b3584fa600cd65046932c66faa57bd6661e80b02", "url": "https://github.com/OpenLiberty/open-liberty/commit/b3584fa600cd65046932c66faa57bd6661e80b02", "message": "Made requested changes\n- Updated feature replacement to use default the base features and later check for renamed features\n- Updated feature replacement so renamed features works both ee9->ee7/ee8 and ee7/ee8->ee9\n- Updated feature replacement to throw exception if dash is omitted", "committedDate": "2020-07-15T16:15:40Z", "type": "forcePushed"}, {"oid": "bf80f4aafee4c1921f181e12067386256817b8b4", "url": "https://github.com/OpenLiberty/open-liberty/commit/bf80f4aafee4c1921f181e12067386256817b8b4", "message": "Made requested changes\n- Updated feature replacement to use default the base features and later check for renamed features\n- Updated feature replacement so renamed features works both ee9->ee7/ee8 and ee7/ee8->ee9\n- Updated feature replacement to throw exception if dash is omitted", "committedDate": "2020-07-17T04:49:34Z", "type": "forcePushed"}, {"oid": "666873a814e1d366ed3427f159012529f21c7764", "url": "https://github.com/OpenLiberty/open-liberty/commit/666873a814e1d366ed3427f159012529f21c7764", "message": "Added simple fix for jakarta feature name change", "committedDate": "2020-07-19T20:01:33Z", "type": "commit"}, {"oid": "86f5dc86b55cdf512aed07fde9188c1f8ceb5e8f", "url": "https://github.com/OpenLiberty/open-liberty/commit/86f5dc86b55cdf512aed07fde9188c1f8ceb5e8f", "message": "Clean up changes", "committedDate": "2020-07-19T20:01:33Z", "type": "commit"}, {"oid": "bdb335e382a9078c503181fb8423ca88a6fa090a", "url": "https://github.com/OpenLiberty/open-liberty/commit/bdb335e382a9078c503181fb8423ca88a6fa090a", "message": "Made requested changes\n- Updated feature replacement to use default the base features and later check for renamed features\n- Updated feature replacement so renamed features works both ee9->ee7/ee8 and ee7/ee8->ee9\n- Updated feature replacement to throw exception if dash is omitted", "committedDate": "2020-07-19T20:01:33Z", "type": "commit"}, {"oid": "bdb335e382a9078c503181fb8423ca88a6fa090a", "url": "https://github.com/OpenLiberty/open-liberty/commit/bdb335e382a9078c503181fb8423ca88a6fa090a", "message": "Made requested changes\n- Updated feature replacement to use default the base features and later check for renamed features\n- Updated feature replacement so renamed features works both ee9->ee7/ee8 and ee7/ee8->ee9\n- Updated feature replacement to throw exception if dash is omitted", "committedDate": "2020-07-19T20:01:33Z", "type": "forcePushed"}]}