{"pr_number": 855, "pr_title": "RDM-7694 - DCP for workbasket and search input/results", "pr_createdAt": "2020-03-23T08:44:48Z", "pr_url": "https://github.com/hmcts/ccd-data-store-api/pull/855", "timeline": [{"oid": "175a662112b2cdcc5ba99435df0e9a8952530b46", "url": "https://github.com/hmcts/ccd-data-store-api/commit/175a662112b2cdcc5ba99435df0e9a8952530b46", "message": "RDM-7694 - DCP for workbasket and search input/results", "committedDate": "2020-03-23T08:41:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI5NDkxMw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/855#discussion_r397294913", "bodyText": "same consideration added to the other tickets. Better to have SearchResultViewColumn have getDisplayContextParameter not as a String but as a DisplayContextParameter object, which then has the method itself to check the type", "author": "mario-paniccia", "createdAt": "2020-03-24T16:34:10Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/processor/SearchResultProcessor.java", "diffHunk": "@@ -0,0 +1,87 @@\n+package uk.gov.hmcts.ccd.domain.service.processor;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.node.ArrayNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.fasterxml.jackson.databind.node.TextNode;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+import uk.gov.hmcts.ccd.domain.model.definition.FieldType;\n+import uk.gov.hmcts.ccd.domain.model.search.SearchResultView;\n+import uk.gov.hmcts.ccd.domain.model.search.SearchResultViewColumn;\n+import uk.gov.hmcts.ccd.domain.model.search.SearchResultViewItem;\n+import uk.gov.hmcts.ccd.domain.types.CollectionValidator;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+@Component\n+public class SearchResultProcessor {\n+\n+    protected static final ObjectMapper MAPPER = new ObjectMapper();\n+\n+    private final DateTimeFormatParser dateTimeFormatParser;\n+\n+    @Autowired\n+    public SearchResultProcessor(final DateTimeFormatParser dateTimeFormatParser) {\n+        this.dateTimeFormatParser = dateTimeFormatParser;\n+    }\n+\n+    public SearchResultView execute(List<SearchResultViewColumn> viewColumns,\n+                                    List<SearchResultViewItem> viewItems,\n+                                    String resultError) {\n+        for (SearchResultViewColumn viewColumn : viewColumns) {\n+            if (DisplayContextParameter\n+                .hasDisplayContextParameterType(viewColumn.getDisplayContextParameter(), DisplayContextParameterType.DATETIMEDISPLAY)) {", "originalCommit": "175a662112b2cdcc5ba99435df0e9a8952530b46", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9ed8f3aa934a5df994e9d444f052ff02e62f2c1e", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/domain/service/processor/SearchResultProcessor.java b/src/main/java/uk/gov/hmcts/ccd/domain/service/processor/SearchResultProcessor.java\nindex 28b2bb924..e166cc463 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/domain/service/processor/SearchResultProcessor.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/domain/service/processor/SearchResultProcessor.java\n\n@@ -46,7 +46,7 @@ public class SearchResultProcessor {\n     private SearchResultViewItem processSearchResultViewItem(SearchResultViewItem viewItem, SearchResultViewColumn viewColumn) {\n         return DisplayContextParameter.getDisplayContextParameterOfType(viewColumn.getDisplayContextParameter(), DisplayContextParameterType.DATETIMEDISPLAY)\n             .map(dcp ->  {\n-                viewItem.getCaseFields().replace(viewColumn.getCaseFieldId(),\n+                viewItem.getCaseFieldsFormatted().replace(viewColumn.getCaseFieldId(),\n                     processNode(viewItem.getCaseFields().get(viewColumn.getCaseFieldId()), dcp.getValue(), viewColumn.getCaseFieldType()));\n                 return viewItem;\n             })\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI5NTQ5Mw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/855#discussion_r397295493", "bodyText": "same as above", "author": "mario-paniccia", "createdAt": "2020-03-24T16:35:01Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/processor/SearchResultProcessor.java", "diffHunk": "@@ -0,0 +1,87 @@\n+package uk.gov.hmcts.ccd.domain.service.processor;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.node.ArrayNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.fasterxml.jackson.databind.node.TextNode;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+import uk.gov.hmcts.ccd.domain.model.definition.FieldType;\n+import uk.gov.hmcts.ccd.domain.model.search.SearchResultView;\n+import uk.gov.hmcts.ccd.domain.model.search.SearchResultViewColumn;\n+import uk.gov.hmcts.ccd.domain.model.search.SearchResultViewItem;\n+import uk.gov.hmcts.ccd.domain.types.CollectionValidator;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+@Component\n+public class SearchResultProcessor {\n+\n+    protected static final ObjectMapper MAPPER = new ObjectMapper();\n+\n+    private final DateTimeFormatParser dateTimeFormatParser;\n+\n+    @Autowired\n+    public SearchResultProcessor(final DateTimeFormatParser dateTimeFormatParser) {\n+        this.dateTimeFormatParser = dateTimeFormatParser;\n+    }\n+\n+    public SearchResultView execute(List<SearchResultViewColumn> viewColumns,\n+                                    List<SearchResultViewItem> viewItems,\n+                                    String resultError) {\n+        for (SearchResultViewColumn viewColumn : viewColumns) {\n+            if (DisplayContextParameter\n+                .hasDisplayContextParameterType(viewColumn.getDisplayContextParameter(), DisplayContextParameterType.DATETIMEDISPLAY)) {\n+                viewItems = viewItems.stream()\n+                    .map(viewItem -> processSearchResultViewItem(viewItem, viewColumn))\n+                    .collect(Collectors.toList());\n+            }\n+        }\n+\n+        return new SearchResultView(viewColumns, viewItems, resultError);\n+    }\n+\n+    private SearchResultViewItem processSearchResultViewItem(SearchResultViewItem viewItem, SearchResultViewColumn viewColumn) {\n+        return DisplayContextParameter.getDisplayContextParameterOfType(viewColumn.getDisplayContextParameter(), DisplayContextParameterType.DATETIMEDISPLAY)", "originalCommit": "175a662112b2cdcc5ba99435df0e9a8952530b46", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9ed8f3aa934a5df994e9d444f052ff02e62f2c1e", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/domain/service/processor/SearchResultProcessor.java b/src/main/java/uk/gov/hmcts/ccd/domain/service/processor/SearchResultProcessor.java\nindex 28b2bb924..e166cc463 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/domain/service/processor/SearchResultProcessor.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/domain/service/processor/SearchResultProcessor.java\n\n@@ -46,7 +46,7 @@ public class SearchResultProcessor {\n     private SearchResultViewItem processSearchResultViewItem(SearchResultViewItem viewItem, SearchResultViewColumn viewColumn) {\n         return DisplayContextParameter.getDisplayContextParameterOfType(viewColumn.getDisplayContextParameter(), DisplayContextParameterType.DATETIMEDISPLAY)\n             .map(dcp ->  {\n-                viewItem.getCaseFields().replace(viewColumn.getCaseFieldId(),\n+                viewItem.getCaseFieldsFormatted().replace(viewColumn.getCaseFieldId(),\n                     processNode(viewItem.getCaseFields().get(viewColumn.getCaseFieldId()), dcp.getValue(), viewColumn.getCaseFieldType()));\n                 return viewItem;\n             })\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI5NzM0Mw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/855#discussion_r397297343", "bodyText": "strictly speaking this is not generic. It's tied to date time processing. So better rename it to DateFormattingSearchResultProcessor?", "author": "mario-paniccia", "createdAt": "2020-03-24T16:37:24Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/processor/SearchResultProcessor.java", "diffHunk": "@@ -0,0 +1,87 @@\n+package uk.gov.hmcts.ccd.domain.service.processor;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.node.ArrayNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.fasterxml.jackson.databind.node.TextNode;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+import uk.gov.hmcts.ccd.domain.model.definition.FieldType;\n+import uk.gov.hmcts.ccd.domain.model.search.SearchResultView;\n+import uk.gov.hmcts.ccd.domain.model.search.SearchResultViewColumn;\n+import uk.gov.hmcts.ccd.domain.model.search.SearchResultViewItem;\n+import uk.gov.hmcts.ccd.domain.types.CollectionValidator;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+@Component\n+public class SearchResultProcessor {", "originalCommit": "175a662112b2cdcc5ba99435df0e9a8952530b46", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9ed8f3aa934a5df994e9d444f052ff02e62f2c1e", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/domain/service/processor/SearchResultProcessor.java b/src/main/java/uk/gov/hmcts/ccd/domain/service/processor/SearchResultProcessor.java\nindex 28b2bb924..e166cc463 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/domain/service/processor/SearchResultProcessor.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/domain/service/processor/SearchResultProcessor.java\n\n@@ -46,7 +46,7 @@ public class SearchResultProcessor {\n     private SearchResultViewItem processSearchResultViewItem(SearchResultViewItem viewItem, SearchResultViewColumn viewColumn) {\n         return DisplayContextParameter.getDisplayContextParameterOfType(viewColumn.getDisplayContextParameter(), DisplayContextParameterType.DATETIMEDISPLAY)\n             .map(dcp ->  {\n-                viewItem.getCaseFields().replace(viewColumn.getCaseFieldId(),\n+                viewItem.getCaseFieldsFormatted().replace(viewColumn.getCaseFieldId(),\n                     processNode(viewItem.getCaseFields().get(viewColumn.getCaseFieldId()), dcp.getValue(), viewColumn.getCaseFieldType()));\n                 return viewItem;\n             })\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI5OTkxOQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/855#discussion_r397299919", "bodyText": "this logic is duplicated with another date store PR. We could remove this duplication by moving this logic inside the dateTimeFormatParser itself", "author": "mario-paniccia", "createdAt": "2020-03-24T16:40:48Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/processor/SearchResultProcessor.java", "diffHunk": "@@ -0,0 +1,87 @@\n+package uk.gov.hmcts.ccd.domain.service.processor;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.node.ArrayNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.fasterxml.jackson.databind.node.TextNode;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+import uk.gov.hmcts.ccd.domain.model.definition.FieldType;\n+import uk.gov.hmcts.ccd.domain.model.search.SearchResultView;\n+import uk.gov.hmcts.ccd.domain.model.search.SearchResultViewColumn;\n+import uk.gov.hmcts.ccd.domain.model.search.SearchResultViewItem;\n+import uk.gov.hmcts.ccd.domain.types.CollectionValidator;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+@Component\n+public class SearchResultProcessor {\n+\n+    protected static final ObjectMapper MAPPER = new ObjectMapper();\n+\n+    private final DateTimeFormatParser dateTimeFormatParser;\n+\n+    @Autowired\n+    public SearchResultProcessor(final DateTimeFormatParser dateTimeFormatParser) {\n+        this.dateTimeFormatParser = dateTimeFormatParser;\n+    }\n+\n+    public SearchResultView execute(List<SearchResultViewColumn> viewColumns,\n+                                    List<SearchResultViewItem> viewItems,\n+                                    String resultError) {\n+        for (SearchResultViewColumn viewColumn : viewColumns) {\n+            if (DisplayContextParameter\n+                .hasDisplayContextParameterType(viewColumn.getDisplayContextParameter(), DisplayContextParameterType.DATETIMEDISPLAY)) {\n+                viewItems = viewItems.stream()\n+                    .map(viewItem -> processSearchResultViewItem(viewItem, viewColumn))\n+                    .collect(Collectors.toList());\n+            }\n+        }\n+\n+        return new SearchResultView(viewColumns, viewItems, resultError);\n+    }\n+\n+    private SearchResultViewItem processSearchResultViewItem(SearchResultViewItem viewItem, SearchResultViewColumn viewColumn) {\n+        return DisplayContextParameter.getDisplayContextParameterOfType(viewColumn.getDisplayContextParameter(), DisplayContextParameterType.DATETIMEDISPLAY)\n+            .map(dcp ->  {\n+                viewItem.getCaseFields().replace(viewColumn.getCaseFieldId(),\n+                    processNode(viewItem.getCaseFields().get(viewColumn.getCaseFieldId()), dcp.getValue(), viewColumn.getCaseFieldType()));\n+                return viewItem;\n+            })\n+            .orElse(viewItem);\n+    }\n+\n+    private Object processNode(final Object object,\n+                               final String dateFormat,\n+                               final FieldType fieldType) {\n+        if (object instanceof TextNode && !FieldProcessor.isNullOrEmpty((TextNode) object)) {\n+            return createTextNodeFrom((TextNode) object, dateFormat, fieldType);\n+        } else if (object instanceof ArrayNode && !FieldProcessor.isNullOrEmpty((ArrayNode) object)) {\n+            return createArrayNodeFrom((ArrayNode) object, dateFormat, fieldType);\n+        }\n+\n+        return object;\n+    }\n+\n+    private JsonNode createTextNodeFrom(final TextNode originalNode, final String dateFormat, final FieldType fieldType) {\n+        if (fieldType.getType().equals(FieldType.DATE)) {\n+            return new TextNode(dateTimeFormatParser.convertIso8601ToDate(dateFormat, originalNode.asText()));\n+        } else {\n+            return new TextNode(dateTimeFormatParser.convertIso8601ToDateTime(dateFormat, originalNode.asText()));\n+        }", "originalCommit": "175a662112b2cdcc5ba99435df0e9a8952530b46", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9ed8f3aa934a5df994e9d444f052ff02e62f2c1e", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/domain/service/processor/SearchResultProcessor.java b/src/main/java/uk/gov/hmcts/ccd/domain/service/processor/SearchResultProcessor.java\nindex 28b2bb924..e166cc463 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/domain/service/processor/SearchResultProcessor.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/domain/service/processor/SearchResultProcessor.java\n\n@@ -46,7 +46,7 @@ public class SearchResultProcessor {\n     private SearchResultViewItem processSearchResultViewItem(SearchResultViewItem viewItem, SearchResultViewColumn viewColumn) {\n         return DisplayContextParameter.getDisplayContextParameterOfType(viewColumn.getDisplayContextParameter(), DisplayContextParameterType.DATETIMEDISPLAY)\n             .map(dcp ->  {\n-                viewItem.getCaseFields().replace(viewColumn.getCaseFieldId(),\n+                viewItem.getCaseFieldsFormatted().replace(viewColumn.getCaseFieldId(),\n                     processNode(viewItem.getCaseFields().get(viewColumn.getCaseFieldId()), dcp.getValue(), viewColumn.getCaseFieldType()));\n                 return viewItem;\n             })\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzMwMjAzMg==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/855#discussion_r397302032", "bodyText": "does the processing work also for complex fields with nested date fields?", "author": "mario-paniccia", "createdAt": "2020-03-24T16:43:34Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/processor/SearchResultProcessor.java", "diffHunk": "@@ -0,0 +1,87 @@\n+package uk.gov.hmcts.ccd.domain.service.processor;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.node.ArrayNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.fasterxml.jackson.databind.node.TextNode;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+import uk.gov.hmcts.ccd.domain.model.definition.FieldType;\n+import uk.gov.hmcts.ccd.domain.model.search.SearchResultView;\n+import uk.gov.hmcts.ccd.domain.model.search.SearchResultViewColumn;\n+import uk.gov.hmcts.ccd.domain.model.search.SearchResultViewItem;\n+import uk.gov.hmcts.ccd.domain.types.CollectionValidator;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+@Component\n+public class SearchResultProcessor {\n+\n+    protected static final ObjectMapper MAPPER = new ObjectMapper();\n+\n+    private final DateTimeFormatParser dateTimeFormatParser;\n+\n+    @Autowired\n+    public SearchResultProcessor(final DateTimeFormatParser dateTimeFormatParser) {\n+        this.dateTimeFormatParser = dateTimeFormatParser;\n+    }\n+\n+    public SearchResultView execute(List<SearchResultViewColumn> viewColumns,\n+                                    List<SearchResultViewItem> viewItems,\n+                                    String resultError) {\n+        for (SearchResultViewColumn viewColumn : viewColumns) {\n+            if (DisplayContextParameter\n+                .hasDisplayContextParameterType(viewColumn.getDisplayContextParameter(), DisplayContextParameterType.DATETIMEDISPLAY)) {\n+                viewItems = viewItems.stream()\n+                    .map(viewItem -> processSearchResultViewItem(viewItem, viewColumn))\n+                    .collect(Collectors.toList());\n+            }\n+        }\n+\n+        return new SearchResultView(viewColumns, viewItems, resultError);\n+    }\n+\n+    private SearchResultViewItem processSearchResultViewItem(SearchResultViewItem viewItem, SearchResultViewColumn viewColumn) {\n+        return DisplayContextParameter.getDisplayContextParameterOfType(viewColumn.getDisplayContextParameter(), DisplayContextParameterType.DATETIMEDISPLAY)\n+            .map(dcp ->  {\n+                viewItem.getCaseFields().replace(viewColumn.getCaseFieldId(),\n+                    processNode(viewItem.getCaseFields().get(viewColumn.getCaseFieldId()), dcp.getValue(), viewColumn.getCaseFieldType()));\n+                return viewItem;\n+            })\n+            .orElse(viewItem);\n+    }\n+\n+    private Object processNode(final Object object,\n+                               final String dateFormat,\n+                               final FieldType fieldType) {\n+        if (object instanceof TextNode && !FieldProcessor.isNullOrEmpty((TextNode) object)) {\n+            return createTextNodeFrom((TextNode) object, dateFormat, fieldType);\n+        } else if (object instanceof ArrayNode && !FieldProcessor.isNullOrEmpty((ArrayNode) object)) {", "originalCommit": "175a662112b2cdcc5ba99435df0e9a8952530b46", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9ed8f3aa934a5df994e9d444f052ff02e62f2c1e", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/domain/service/processor/SearchResultProcessor.java b/src/main/java/uk/gov/hmcts/ccd/domain/service/processor/SearchResultProcessor.java\nindex 28b2bb924..e166cc463 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/domain/service/processor/SearchResultProcessor.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/domain/service/processor/SearchResultProcessor.java\n\n@@ -46,7 +46,7 @@ public class SearchResultProcessor {\n     private SearchResultViewItem processSearchResultViewItem(SearchResultViewItem viewItem, SearchResultViewColumn viewColumn) {\n         return DisplayContextParameter.getDisplayContextParameterOfType(viewColumn.getDisplayContextParameter(), DisplayContextParameterType.DATETIMEDISPLAY)\n             .map(dcp ->  {\n-                viewItem.getCaseFields().replace(viewColumn.getCaseFieldId(),\n+                viewItem.getCaseFieldsFormatted().replace(viewColumn.getCaseFieldId(),\n                     processNode(viewItem.getCaseFields().get(viewColumn.getCaseFieldId()), dcp.getValue(), viewColumn.getCaseFieldType()));\n                 return viewItem;\n             })\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzMwMzI1Nw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/855#discussion_r397303257", "bodyText": "we forgot to add a good bunch of integration test which for a complex feature like this are fundamental", "author": "mario-paniccia", "createdAt": "2020-03-24T16:45:14Z", "path": "src/test/java/uk/gov/hmcts/ccd/domain/service/aggregated/MergeDataToSearchResultOperationTest.java", "diffHunk": "@@ -11,6 +11,7 @@\n import org.junit.jupiter.api.DisplayName;", "originalCommit": "175a662112b2cdcc5ba99435df0e9a8952530b46", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzMxMzI4Ng==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/855#discussion_r397313286", "bodyText": "extract a method please", "author": "mario-paniccia", "createdAt": "2020-03-24T16:58:15Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/processor/SearchInputProcessor.java", "diffHunk": "@@ -0,0 +1,87 @@\n+package uk.gov.hmcts.ccd.domain.service.processor;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Component;\n+import uk.gov.hmcts.ccd.data.casedetails.search.MetaData;\n+import uk.gov.hmcts.ccd.domain.model.definition.FieldType;\n+import uk.gov.hmcts.ccd.domain.model.search.CriteriaInput;\n+import uk.gov.hmcts.ccd.domain.model.search.CriteriaType;\n+import uk.gov.hmcts.ccd.domain.service.aggregated.DefaultGetCriteriaOperation;\n+import uk.gov.hmcts.ccd.domain.service.aggregated.GetCriteriaOperation;\n+import uk.gov.hmcts.ccd.endpoint.exceptions.DataProcessingException;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+@Component\n+public class SearchInputProcessor {\n+\n+    protected static final ObjectMapper MAPPER = new ObjectMapper();\n+\n+    private final DateTimeFormatParser dateTimeFormatParser;\n+    private final GetCriteriaOperation getCriteriaOperation;\n+\n+    @Autowired\n+    public SearchInputProcessor(final DateTimeFormatParser dateTimeFormatParser,\n+                                @Qualifier(DefaultGetCriteriaOperation.QUALIFIER) final GetCriteriaOperation getCriteriaOperation) {\n+        this.dateTimeFormatParser = dateTimeFormatParser;\n+        this.getCriteriaOperation = getCriteriaOperation;\n+    }\n+\n+    public Map<String, String> execute(String view, MetaData metadata, Map<String, String> queryParameters) {\n+        List<? extends CriteriaInput> criteriaInputs =\n+            getCriteriaOperation.execute(metadata.getCaseTypeId(), null,\n+                view == null ? CriteriaType.SEARCH : CriteriaType.valueOf(view));\n+\n+        Map<String, String> newParams = new HashMap<>();\n+        queryParameters.entrySet().stream().forEach(entry -> {\n+            Optional<? extends CriteriaInput> input = criteriaInputs.stream()\n+                .filter(i -> i.getField().getId().equals(entry.getKey()))\n+                .findAny();", "originalCommit": "175a662112b2cdcc5ba99435df0e9a8952530b46", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzMxMzczMQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/855#discussion_r397313731", "bodyText": "extract  a method please", "author": "mario-paniccia", "createdAt": "2020-03-24T16:58:52Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/processor/SearchInputProcessor.java", "diffHunk": "@@ -0,0 +1,87 @@\n+package uk.gov.hmcts.ccd.domain.service.processor;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Component;\n+import uk.gov.hmcts.ccd.data.casedetails.search.MetaData;\n+import uk.gov.hmcts.ccd.domain.model.definition.FieldType;\n+import uk.gov.hmcts.ccd.domain.model.search.CriteriaInput;\n+import uk.gov.hmcts.ccd.domain.model.search.CriteriaType;\n+import uk.gov.hmcts.ccd.domain.service.aggregated.DefaultGetCriteriaOperation;\n+import uk.gov.hmcts.ccd.domain.service.aggregated.GetCriteriaOperation;\n+import uk.gov.hmcts.ccd.endpoint.exceptions.DataProcessingException;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+@Component\n+public class SearchInputProcessor {\n+\n+    protected static final ObjectMapper MAPPER = new ObjectMapper();\n+\n+    private final DateTimeFormatParser dateTimeFormatParser;\n+    private final GetCriteriaOperation getCriteriaOperation;\n+\n+    @Autowired\n+    public SearchInputProcessor(final DateTimeFormatParser dateTimeFormatParser,\n+                                @Qualifier(DefaultGetCriteriaOperation.QUALIFIER) final GetCriteriaOperation getCriteriaOperation) {\n+        this.dateTimeFormatParser = dateTimeFormatParser;\n+        this.getCriteriaOperation = getCriteriaOperation;\n+    }\n+\n+    public Map<String, String> execute(String view, MetaData metadata, Map<String, String> queryParameters) {\n+        List<? extends CriteriaInput> criteriaInputs =\n+            getCriteriaOperation.execute(metadata.getCaseTypeId(), null,\n+                view == null ? CriteriaType.SEARCH : CriteriaType.valueOf(view));", "originalCommit": "175a662112b2cdcc5ba99435df0e9a8952530b46", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzMxNDU0OQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/855#discussion_r397314549", "bodyText": "same comment as above", "author": "mario-paniccia", "createdAt": "2020-03-24T17:00:07Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/processor/SearchInputProcessor.java", "diffHunk": "@@ -0,0 +1,87 @@\n+package uk.gov.hmcts.ccd.domain.service.processor;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Component;\n+import uk.gov.hmcts.ccd.data.casedetails.search.MetaData;\n+import uk.gov.hmcts.ccd.domain.model.definition.FieldType;\n+import uk.gov.hmcts.ccd.domain.model.search.CriteriaInput;\n+import uk.gov.hmcts.ccd.domain.model.search.CriteriaType;\n+import uk.gov.hmcts.ccd.domain.service.aggregated.DefaultGetCriteriaOperation;\n+import uk.gov.hmcts.ccd.domain.service.aggregated.GetCriteriaOperation;\n+import uk.gov.hmcts.ccd.endpoint.exceptions.DataProcessingException;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+@Component\n+public class SearchInputProcessor {\n+\n+    protected static final ObjectMapper MAPPER = new ObjectMapper();\n+\n+    private final DateTimeFormatParser dateTimeFormatParser;\n+    private final GetCriteriaOperation getCriteriaOperation;\n+\n+    @Autowired\n+    public SearchInputProcessor(final DateTimeFormatParser dateTimeFormatParser,\n+                                @Qualifier(DefaultGetCriteriaOperation.QUALIFIER) final GetCriteriaOperation getCriteriaOperation) {\n+        this.dateTimeFormatParser = dateTimeFormatParser;\n+        this.getCriteriaOperation = getCriteriaOperation;\n+    }\n+\n+    public Map<String, String> execute(String view, MetaData metadata, Map<String, String> queryParameters) {\n+        List<? extends CriteriaInput> criteriaInputs =\n+            getCriteriaOperation.execute(metadata.getCaseTypeId(), null,\n+                view == null ? CriteriaType.SEARCH : CriteriaType.valueOf(view));\n+\n+        Map<String, String> newParams = new HashMap<>();\n+        queryParameters.entrySet().stream().forEach(entry -> {\n+            Optional<? extends CriteriaInput> input = criteriaInputs.stream()\n+                .filter(i -> i.getField().getId().equals(entry.getKey()))\n+                .findAny();\n+\n+            if (input.isPresent() &&\n+                DisplayContextParameter\n+                    .hasDisplayContextParameterType(input.get().getDisplayContextParameter(), DisplayContextParameterType.DATETIMEENTRY)) {", "originalCommit": "175a662112b2cdcc5ba99435df0e9a8952530b46", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc2NzI3OQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/855#discussion_r397767279", "bodyText": "Better to create a method to check the condition", "author": "kiran-yenigala-hmcts", "createdAt": "2020-03-25T10:58:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzMxNDU0OQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzMxNTA2NQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/855#discussion_r397315065", "bodyText": "extract a method please", "author": "mario-paniccia", "createdAt": "2020-03-24T17:00:46Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/processor/SearchInputProcessor.java", "diffHunk": "@@ -0,0 +1,87 @@\n+package uk.gov.hmcts.ccd.domain.service.processor;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Component;\n+import uk.gov.hmcts.ccd.data.casedetails.search.MetaData;\n+import uk.gov.hmcts.ccd.domain.model.definition.FieldType;\n+import uk.gov.hmcts.ccd.domain.model.search.CriteriaInput;\n+import uk.gov.hmcts.ccd.domain.model.search.CriteriaType;\n+import uk.gov.hmcts.ccd.domain.service.aggregated.DefaultGetCriteriaOperation;\n+import uk.gov.hmcts.ccd.domain.service.aggregated.GetCriteriaOperation;\n+import uk.gov.hmcts.ccd.endpoint.exceptions.DataProcessingException;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+@Component\n+public class SearchInputProcessor {\n+\n+    protected static final ObjectMapper MAPPER = new ObjectMapper();\n+\n+    private final DateTimeFormatParser dateTimeFormatParser;\n+    private final GetCriteriaOperation getCriteriaOperation;\n+\n+    @Autowired\n+    public SearchInputProcessor(final DateTimeFormatParser dateTimeFormatParser,\n+                                @Qualifier(DefaultGetCriteriaOperation.QUALIFIER) final GetCriteriaOperation getCriteriaOperation) {\n+        this.dateTimeFormatParser = dateTimeFormatParser;\n+        this.getCriteriaOperation = getCriteriaOperation;\n+    }\n+\n+    public Map<String, String> execute(String view, MetaData metadata, Map<String, String> queryParameters) {\n+        List<? extends CriteriaInput> criteriaInputs =\n+            getCriteriaOperation.execute(metadata.getCaseTypeId(), null,\n+                view == null ? CriteriaType.SEARCH : CriteriaType.valueOf(view));\n+\n+        Map<String, String> newParams = new HashMap<>();\n+        queryParameters.entrySet().stream().forEach(entry -> {\n+            Optional<? extends CriteriaInput> input = criteriaInputs.stream()\n+                .filter(i -> i.getField().getId().equals(entry.getKey()))\n+                .findAny();\n+\n+            if (input.isPresent() &&\n+                DisplayContextParameter\n+                    .hasDisplayContextParameterType(input.get().getDisplayContextParameter(), DisplayContextParameterType.DATETIMEENTRY)) {\n+                newParams.put(entry.getKey(),\n+                    processValue(entry.getKey(), input.get().getDisplayContextParameter(),\n+                        entry.getValue(), input.get().getField().getType()));", "originalCommit": "175a662112b2cdcc5ba99435df0e9a8952530b46", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzMxNTgxMw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/855#discussion_r397315813", "bodyText": "this is not a generic processor, it's tied to doing date transformation so we should rename it to DateSearchInputProcessor or sim", "author": "mario-paniccia", "createdAt": "2020-03-24T17:01:50Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/processor/SearchInputProcessor.java", "diffHunk": "@@ -0,0 +1,87 @@\n+package uk.gov.hmcts.ccd.domain.service.processor;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Component;\n+import uk.gov.hmcts.ccd.data.casedetails.search.MetaData;\n+import uk.gov.hmcts.ccd.domain.model.definition.FieldType;\n+import uk.gov.hmcts.ccd.domain.model.search.CriteriaInput;\n+import uk.gov.hmcts.ccd.domain.model.search.CriteriaType;\n+import uk.gov.hmcts.ccd.domain.service.aggregated.DefaultGetCriteriaOperation;\n+import uk.gov.hmcts.ccd.domain.service.aggregated.GetCriteriaOperation;\n+import uk.gov.hmcts.ccd.endpoint.exceptions.DataProcessingException;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+@Component\n+public class SearchInputProcessor {", "originalCommit": "175a662112b2cdcc5ba99435df0e9a8952530b46", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzMxNjU1NQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/855#discussion_r397316555", "bodyText": "duplicated", "author": "mario-paniccia", "createdAt": "2020-03-24T17:02:54Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/processor/SearchInputProcessor.java", "diffHunk": "@@ -0,0 +1,87 @@\n+package uk.gov.hmcts.ccd.domain.service.processor;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Component;\n+import uk.gov.hmcts.ccd.data.casedetails.search.MetaData;\n+import uk.gov.hmcts.ccd.domain.model.definition.FieldType;\n+import uk.gov.hmcts.ccd.domain.model.search.CriteriaInput;\n+import uk.gov.hmcts.ccd.domain.model.search.CriteriaType;\n+import uk.gov.hmcts.ccd.domain.service.aggregated.DefaultGetCriteriaOperation;\n+import uk.gov.hmcts.ccd.domain.service.aggregated.GetCriteriaOperation;\n+import uk.gov.hmcts.ccd.endpoint.exceptions.DataProcessingException;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+@Component\n+public class SearchInputProcessor {\n+\n+    protected static final ObjectMapper MAPPER = new ObjectMapper();\n+\n+    private final DateTimeFormatParser dateTimeFormatParser;\n+    private final GetCriteriaOperation getCriteriaOperation;\n+\n+    @Autowired\n+    public SearchInputProcessor(final DateTimeFormatParser dateTimeFormatParser,\n+                                @Qualifier(DefaultGetCriteriaOperation.QUALIFIER) final GetCriteriaOperation getCriteriaOperation) {\n+        this.dateTimeFormatParser = dateTimeFormatParser;\n+        this.getCriteriaOperation = getCriteriaOperation;\n+    }\n+\n+    public Map<String, String> execute(String view, MetaData metadata, Map<String, String> queryParameters) {\n+        List<? extends CriteriaInput> criteriaInputs =\n+            getCriteriaOperation.execute(metadata.getCaseTypeId(), null,\n+                view == null ? CriteriaType.SEARCH : CriteriaType.valueOf(view));\n+\n+        Map<String, String> newParams = new HashMap<>();\n+        queryParameters.entrySet().stream().forEach(entry -> {\n+            Optional<? extends CriteriaInput> input = criteriaInputs.stream()\n+                .filter(i -> i.getField().getId().equals(entry.getKey()))\n+                .findAny();\n+\n+            if (input.isPresent() &&\n+                DisplayContextParameter\n+                    .hasDisplayContextParameterType(input.get().getDisplayContextParameter(), DisplayContextParameterType.DATETIMEENTRY)) {\n+                newParams.put(entry.getKey(),\n+                    processValue(entry.getKey(), input.get().getDisplayContextParameter(),\n+                        entry.getValue(), input.get().getField().getType()));\n+            } else {\n+                newParams.put(entry.getKey(), entry.getValue());\n+            }\n+        });\n+\n+        return newParams;\n+    }\n+\n+    private String processValue(String id, String displayContextParameter, String value, FieldType fieldType) {\n+        try {\n+            if (fieldType.getType().equals(FieldType.DATE)) {\n+                return dateTimeFormatParser.convertDateToIso8601(format(displayContextParameter, fieldType), value);\n+            } else if (fieldType.getType().equals(FieldType.DATETIME)) {\n+                return dateTimeFormatParser.convertDateTimeToIso8601(format(displayContextParameter, fieldType), value);", "originalCommit": "175a662112b2cdcc5ba99435df0e9a8952530b46", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzMxNzU1MA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/855#discussion_r397317550", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            String.format(\"Unable to process input %s with value %s. Expected format: %s\",\n          \n          \n            \n                            String.format(\"Unable to process search input %s with value %s. Expected format: %s\",", "author": "mario-paniccia", "createdAt": "2020-03-24T17:04:20Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/processor/SearchInputProcessor.java", "diffHunk": "@@ -0,0 +1,87 @@\n+package uk.gov.hmcts.ccd.domain.service.processor;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Component;\n+import uk.gov.hmcts.ccd.data.casedetails.search.MetaData;\n+import uk.gov.hmcts.ccd.domain.model.definition.FieldType;\n+import uk.gov.hmcts.ccd.domain.model.search.CriteriaInput;\n+import uk.gov.hmcts.ccd.domain.model.search.CriteriaType;\n+import uk.gov.hmcts.ccd.domain.service.aggregated.DefaultGetCriteriaOperation;\n+import uk.gov.hmcts.ccd.domain.service.aggregated.GetCriteriaOperation;\n+import uk.gov.hmcts.ccd.endpoint.exceptions.DataProcessingException;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+@Component\n+public class SearchInputProcessor {\n+\n+    protected static final ObjectMapper MAPPER = new ObjectMapper();\n+\n+    private final DateTimeFormatParser dateTimeFormatParser;\n+    private final GetCriteriaOperation getCriteriaOperation;\n+\n+    @Autowired\n+    public SearchInputProcessor(final DateTimeFormatParser dateTimeFormatParser,\n+                                @Qualifier(DefaultGetCriteriaOperation.QUALIFIER) final GetCriteriaOperation getCriteriaOperation) {\n+        this.dateTimeFormatParser = dateTimeFormatParser;\n+        this.getCriteriaOperation = getCriteriaOperation;\n+    }\n+\n+    public Map<String, String> execute(String view, MetaData metadata, Map<String, String> queryParameters) {\n+        List<? extends CriteriaInput> criteriaInputs =\n+            getCriteriaOperation.execute(metadata.getCaseTypeId(), null,\n+                view == null ? CriteriaType.SEARCH : CriteriaType.valueOf(view));\n+\n+        Map<String, String> newParams = new HashMap<>();\n+        queryParameters.entrySet().stream().forEach(entry -> {\n+            Optional<? extends CriteriaInput> input = criteriaInputs.stream()\n+                .filter(i -> i.getField().getId().equals(entry.getKey()))\n+                .findAny();\n+\n+            if (input.isPresent() &&\n+                DisplayContextParameter\n+                    .hasDisplayContextParameterType(input.get().getDisplayContextParameter(), DisplayContextParameterType.DATETIMEENTRY)) {\n+                newParams.put(entry.getKey(),\n+                    processValue(entry.getKey(), input.get().getDisplayContextParameter(),\n+                        entry.getValue(), input.get().getField().getType()));\n+            } else {\n+                newParams.put(entry.getKey(), entry.getValue());\n+            }\n+        });\n+\n+        return newParams;\n+    }\n+\n+    private String processValue(String id, String displayContextParameter, String value, FieldType fieldType) {\n+        try {\n+            if (fieldType.getType().equals(FieldType.DATE)) {\n+                return dateTimeFormatParser.convertDateToIso8601(format(displayContextParameter, fieldType), value);\n+            } else if (fieldType.getType().equals(FieldType.DATETIME)) {\n+                return dateTimeFormatParser.convertDateTimeToIso8601(format(displayContextParameter, fieldType), value);\n+            } else {\n+                return value;\n+            }\n+        } catch (Exception e) {\n+            throw new DataProcessingException().withDetails(\n+                String.format(\"Unable to process input %s with value %s. Expected format: %s\",", "originalCommit": "175a662112b2cdcc5ba99435df0e9a8952530b46", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzMyMDgyMw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/855#discussion_r397320823", "bodyText": "duplicated. This should be moved into the domain class", "author": "mario-paniccia", "createdAt": "2020-03-24T17:08:55Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/processor/SearchInputProcessor.java", "diffHunk": "@@ -0,0 +1,87 @@\n+package uk.gov.hmcts.ccd.domain.service.processor;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Component;\n+import uk.gov.hmcts.ccd.data.casedetails.search.MetaData;\n+import uk.gov.hmcts.ccd.domain.model.definition.FieldType;\n+import uk.gov.hmcts.ccd.domain.model.search.CriteriaInput;\n+import uk.gov.hmcts.ccd.domain.model.search.CriteriaType;\n+import uk.gov.hmcts.ccd.domain.service.aggregated.DefaultGetCriteriaOperation;\n+import uk.gov.hmcts.ccd.domain.service.aggregated.GetCriteriaOperation;\n+import uk.gov.hmcts.ccd.endpoint.exceptions.DataProcessingException;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+@Component\n+public class SearchInputProcessor {\n+\n+    protected static final ObjectMapper MAPPER = new ObjectMapper();\n+\n+    private final DateTimeFormatParser dateTimeFormatParser;\n+    private final GetCriteriaOperation getCriteriaOperation;\n+\n+    @Autowired\n+    public SearchInputProcessor(final DateTimeFormatParser dateTimeFormatParser,\n+                                @Qualifier(DefaultGetCriteriaOperation.QUALIFIER) final GetCriteriaOperation getCriteriaOperation) {\n+        this.dateTimeFormatParser = dateTimeFormatParser;\n+        this.getCriteriaOperation = getCriteriaOperation;\n+    }\n+\n+    public Map<String, String> execute(String view, MetaData metadata, Map<String, String> queryParameters) {\n+        List<? extends CriteriaInput> criteriaInputs =\n+            getCriteriaOperation.execute(metadata.getCaseTypeId(), null,\n+                view == null ? CriteriaType.SEARCH : CriteriaType.valueOf(view));\n+\n+        Map<String, String> newParams = new HashMap<>();\n+        queryParameters.entrySet().stream().forEach(entry -> {\n+            Optional<? extends CriteriaInput> input = criteriaInputs.stream()\n+                .filter(i -> i.getField().getId().equals(entry.getKey()))\n+                .findAny();\n+\n+            if (input.isPresent() &&\n+                DisplayContextParameter\n+                    .hasDisplayContextParameterType(input.get().getDisplayContextParameter(), DisplayContextParameterType.DATETIMEENTRY)) {\n+                newParams.put(entry.getKey(),\n+                    processValue(entry.getKey(), input.get().getDisplayContextParameter(),\n+                        entry.getValue(), input.get().getField().getType()));\n+            } else {\n+                newParams.put(entry.getKey(), entry.getValue());\n+            }\n+        });\n+\n+        return newParams;\n+    }\n+\n+    private String processValue(String id, String displayContextParameter, String value, FieldType fieldType) {\n+        try {\n+            if (fieldType.getType().equals(FieldType.DATE)) {\n+                return dateTimeFormatParser.convertDateToIso8601(format(displayContextParameter, fieldType), value);\n+            } else if (fieldType.getType().equals(FieldType.DATETIME)) {\n+                return dateTimeFormatParser.convertDateTimeToIso8601(format(displayContextParameter, fieldType), value);\n+            } else {\n+                return value;\n+            }\n+        } catch (Exception e) {\n+            throw new DataProcessingException().withDetails(\n+                String.format(\"Unable to process input %s with value %s. Expected format: %s\",\n+                    id,\n+                    value,\n+                    format(displayContextParameter, fieldType))\n+            );\n+        }\n+    }\n+\n+    private String format(String displayContextParameter, FieldType fieldType) {\n+        return DisplayContextParameter\n+            .getDisplayContextParameterOfType(displayContextParameter, DisplayContextParameterType.DATETIMEENTRY)\n+            .map(DisplayContextParameter::getValue)", "originalCommit": "175a662112b2cdcc5ba99435df0e9a8952530b46", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzMyMzA5NQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/855#discussion_r397323095", "bodyText": "is this needed? if there's no datetimeentry specified then the date must already be in iso format right?", "author": "mario-paniccia", "createdAt": "2020-03-24T17:12:20Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/processor/SearchInputProcessor.java", "diffHunk": "@@ -0,0 +1,87 @@\n+package uk.gov.hmcts.ccd.domain.service.processor;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Component;\n+import uk.gov.hmcts.ccd.data.casedetails.search.MetaData;\n+import uk.gov.hmcts.ccd.domain.model.definition.FieldType;\n+import uk.gov.hmcts.ccd.domain.model.search.CriteriaInput;\n+import uk.gov.hmcts.ccd.domain.model.search.CriteriaType;\n+import uk.gov.hmcts.ccd.domain.service.aggregated.DefaultGetCriteriaOperation;\n+import uk.gov.hmcts.ccd.domain.service.aggregated.GetCriteriaOperation;\n+import uk.gov.hmcts.ccd.endpoint.exceptions.DataProcessingException;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+@Component\n+public class SearchInputProcessor {\n+\n+    protected static final ObjectMapper MAPPER = new ObjectMapper();\n+\n+    private final DateTimeFormatParser dateTimeFormatParser;\n+    private final GetCriteriaOperation getCriteriaOperation;\n+\n+    @Autowired\n+    public SearchInputProcessor(final DateTimeFormatParser dateTimeFormatParser,\n+                                @Qualifier(DefaultGetCriteriaOperation.QUALIFIER) final GetCriteriaOperation getCriteriaOperation) {\n+        this.dateTimeFormatParser = dateTimeFormatParser;\n+        this.getCriteriaOperation = getCriteriaOperation;\n+    }\n+\n+    public Map<String, String> execute(String view, MetaData metadata, Map<String, String> queryParameters) {\n+        List<? extends CriteriaInput> criteriaInputs =\n+            getCriteriaOperation.execute(metadata.getCaseTypeId(), null,\n+                view == null ? CriteriaType.SEARCH : CriteriaType.valueOf(view));\n+\n+        Map<String, String> newParams = new HashMap<>();\n+        queryParameters.entrySet().stream().forEach(entry -> {\n+            Optional<? extends CriteriaInput> input = criteriaInputs.stream()\n+                .filter(i -> i.getField().getId().equals(entry.getKey()))\n+                .findAny();\n+\n+            if (input.isPresent() &&\n+                DisplayContextParameter\n+                    .hasDisplayContextParameterType(input.get().getDisplayContextParameter(), DisplayContextParameterType.DATETIMEENTRY)) {\n+                newParams.put(entry.getKey(),\n+                    processValue(entry.getKey(), input.get().getDisplayContextParameter(),\n+                        entry.getValue(), input.get().getField().getType()));\n+            } else {\n+                newParams.put(entry.getKey(), entry.getValue());\n+            }\n+        });\n+\n+        return newParams;\n+    }\n+\n+    private String processValue(String id, String displayContextParameter, String value, FieldType fieldType) {\n+        try {\n+            if (fieldType.getType().equals(FieldType.DATE)) {\n+                return dateTimeFormatParser.convertDateToIso8601(format(displayContextParameter, fieldType), value);\n+            } else if (fieldType.getType().equals(FieldType.DATETIME)) {\n+                return dateTimeFormatParser.convertDateTimeToIso8601(format(displayContextParameter, fieldType), value);\n+            } else {\n+                return value;\n+            }\n+        } catch (Exception e) {\n+            throw new DataProcessingException().withDetails(\n+                String.format(\"Unable to process input %s with value %s. Expected format: %s\",\n+                    id,\n+                    value,\n+                    format(displayContextParameter, fieldType))\n+            );\n+        }\n+    }\n+\n+    private String format(String displayContextParameter, FieldType fieldType) {\n+        return DisplayContextParameter\n+            .getDisplayContextParameterOfType(displayContextParameter, DisplayContextParameterType.DATETIMEENTRY)\n+            .map(DisplayContextParameter::getValue)\n+            .orElseGet(() -> fieldType.getType().equals(FieldType.DATE) ?\n+                DateTimeFormatParser.DATE_FORMAT.toString() :\n+                DateTimeFormatParser.DATE_TIME_FORMAT.toString());", "originalCommit": "175a662112b2cdcc5ba99435df0e9a8952530b46", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "d608e2c450bd04b5b02e6b7f9cef771fdae8fa51", "url": "https://github.com/hmcts/ccd-data-store-api/commit/d608e2c450bd04b5b02e6b7f9cef771fdae8fa51", "message": "Merge branch 'RDM-7692' into RDM-7694\n\n# Conflicts:\n#\tsrc/main/java/uk/gov/hmcts/ccd/domain/model/search/CriteriaInput.java\n#\tsrc/test/java/uk/gov/hmcts/ccd/domain/service/common/TestBuildersUtil.java", "committedDate": "2020-03-25T09:54:21Z", "type": "commit"}, {"oid": "296066aee5343e4502982736c1195e03a2b35710", "url": "https://github.com/hmcts/ccd-data-store-api/commit/296066aee5343e4502982736c1195e03a2b35710", "message": "Merge branch 'RDM-7692' into RDM-7694", "committedDate": "2020-03-27T10:34:41Z", "type": "commit"}, {"oid": "8015087b60db2208d545e2d8024ffe94fcb18a1e", "url": "https://github.com/hmcts/ccd-data-store-api/commit/8015087b60db2208d545e2d8024ffe94fcb18a1e", "message": "Merge branch 'RDM-7692' into RDM-7694", "committedDate": "2020-03-30T08:48:55Z", "type": "commit"}, {"oid": "b9e5d2a15e73fc7852bd66338ed2ed76c5b6f00e", "url": "https://github.com/hmcts/ccd-data-store-api/commit/b9e5d2a15e73fc7852bd66338ed2ed76c5b6f00e", "message": "Merge branch 'RDM-7692' into RDM-7694", "committedDate": "2020-03-30T09:25:36Z", "type": "commit"}, {"oid": "5a58ca28950c5b1acb38f6a201bee26357dec6f5", "url": "https://github.com/hmcts/ccd-data-store-api/commit/5a58ca28950c5b1acb38f6a201bee26357dec6f5", "message": "Merge branch 'RDM-7692' into RDM-7694", "committedDate": "2020-03-30T12:06:17Z", "type": "commit"}, {"oid": "9ed8f3aa934a5df994e9d444f052ff02e62f2c1e", "url": "https://github.com/hmcts/ccd-data-store-api/commit/9ed8f3aa934a5df994e9d444f052ff02e62f2c1e", "message": "Add formatted values to search/workbasket results", "committedDate": "2020-03-30T14:02:41Z", "type": "commit"}, {"oid": "8a4ae4951803d3b2b1b3d3bb68464a41f777eed1", "url": "https://github.com/hmcts/ccd-data-store-api/commit/8a4ae4951803d3b2b1b3d3bb68464a41f777eed1", "message": "Merge branch 'RDM-7692' into RDM-7694", "committedDate": "2020-03-31T12:02:55Z", "type": "commit"}, {"oid": "f7256532c9bdaa1b400f8bfa8a216fe9d9d75394", "url": "https://github.com/hmcts/ccd-data-store-api/commit/f7256532c9bdaa1b400f8bfa8a216fe9d9d75394", "message": "Merge branch 'RDM-7692' into RDM-7694", "committedDate": "2020-04-01T12:00:05Z", "type": "commit"}, {"oid": "1bd8276e4b9ab23deffd5b39346509c03eb4e4ca", "url": "https://github.com/hmcts/ccd-data-store-api/commit/1bd8276e4b9ab23deffd5b39346509c03eb4e4ca", "message": "Handle TextNodes with empty strings", "committedDate": "2020-04-01T12:16:47Z", "type": "commit"}, {"oid": "92906be40e2b64f6e386a76c01f89928c6cb2a42", "url": "https://github.com/hmcts/ccd-data-store-api/commit/92906be40e2b64f6e386a76c01f89928c6cb2a42", "message": "Support complex fields in search/workbasket results", "committedDate": "2020-04-06T08:28:27Z", "type": "commit"}, {"oid": "5f28e7a93e315c4d6886aba0e2aa201bf331a308", "url": "https://github.com/hmcts/ccd-data-store-api/commit/5f28e7a93e315c4d6886aba0e2aa201bf331a308", "message": "Update mappings for failing tests", "committedDate": "2020-04-06T10:30:23Z", "type": "commit"}, {"oid": "524c8a0a24e93365c03f3d7ad3c139e5f2653745", "url": "https://github.com/hmcts/ccd-data-store-api/commit/524c8a0a24e93365c03f3d7ad3c139e5f2653745", "message": "Merge branch 'RDM-7692' into RDM-7694", "committedDate": "2020-04-06T11:26:31Z", "type": "commit"}, {"oid": "17dc665970fdec9df13dfe3762bf296399cf8f63", "url": "https://github.com/hmcts/ccd-data-store-api/commit/17dc665970fdec9df13dfe3762bf296399cf8f63", "message": "Handle metadata data fields", "committedDate": "2020-04-06T13:53:20Z", "type": "commit"}, {"oid": "35a9dfaf6e2ece49ca31dd880aef3966459de0a9", "url": "https://github.com/hmcts/ccd-data-store-api/commit/35a9dfaf6e2ece49ca31dd880aef3966459de0a9", "message": "Minor checkstyle", "committedDate": "2020-04-06T14:11:57Z", "type": "commit"}, {"oid": "792401bf6505699b6e711c72b1563975bb834e52", "url": "https://github.com/hmcts/ccd-data-store-api/commit/792401bf6505699b6e711c72b1563975bb834e52", "message": "Add DCP to FT data", "committedDate": "2020-04-06T14:59:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIwODY0OQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/855#discussion_r404208649", "bodyText": "you can inject this", "author": "smathangi", "createdAt": "2020-04-06T16:03:53Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/processor/SearchInputProcessor.java", "diffHunk": "@@ -0,0 +1,87 @@\n+package uk.gov.hmcts.ccd.domain.service.processor;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Component;\n+import uk.gov.hmcts.ccd.data.casedetails.search.MetaData;\n+import uk.gov.hmcts.ccd.domain.model.definition.FieldType;\n+import uk.gov.hmcts.ccd.domain.model.search.CriteriaInput;\n+import uk.gov.hmcts.ccd.domain.model.search.CriteriaType;\n+import uk.gov.hmcts.ccd.domain.service.aggregated.DefaultGetCriteriaOperation;\n+import uk.gov.hmcts.ccd.domain.service.aggregated.GetCriteriaOperation;\n+import uk.gov.hmcts.ccd.endpoint.exceptions.DataProcessingException;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+@Component\n+public class SearchInputProcessor {\n+\n+    protected static final ObjectMapper MAPPER = new ObjectMapper();", "originalCommit": "792401bf6505699b6e711c72b1563975bb834e52", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIxMzY4OQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/855#discussion_r404213689", "bodyText": "looks like this method has significant logic. Can you add few unit tests to domain class please.", "author": "smathangi", "createdAt": "2020-04-06T16:10:53Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/search/SearchResultViewColumn.java", "diffHunk": "@@ -48,4 +63,42 @@ public Integer getOrder() {\n     public boolean isMetadata() {\n         return metadata;\n     }\n+\n+    public String getDisplayContextParameter() {\n+        return displayContextParameter;\n+    }\n+\n+    public Optional<DisplayContextParameter> getDisplayContextParameterOfType(DisplayContextParameterType displayContextParameterType) {\n+        return DisplayContextParameter.getDisplayContextParameterOfType(getDisplayContextParameter(), displayContextParameterType);\n+    }\n+\n+    public Optional<CommonField> getNestedField(String path) {", "originalCommit": "792401bf6505699b6e711c72b1563975bb834e52", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "e7f8784041eea43e1bea615e061fe72ea2bddb45", "url": "https://github.com/hmcts/ccd-data-store-api/commit/e7f8784041eea43e1bea615e061fe72ea2bddb45", "message": "Unit tests for nested field logic", "committedDate": "2020-04-06T17:47:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY0Mjg1MQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/855#discussion_r404642851", "bodyText": "newHashMap really required? if so may be Collections.unmodifiableMap ?", "author": "smathangi", "createdAt": "2020-04-07T08:49:01Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/aggregated/MergeDataToSearchResultOperation.java", "diffHunk": "@@ -109,7 +119,7 @@ private SearchResultViewItem buildSearchResultViewItem(final CaseDetails caseDet\n         Map<String, Object> caseFields = prepareData(searchResult, caseData, caseMetadata, labels);\n \n         String caseId = caseDetails.hasCaseReference() ? caseDetails.getReferenceAsString() : caseDetails.getId();\n-        return new SearchResultViewItem(caseId, caseFields);\n+        return new SearchResultViewItem(caseId, caseFields, new HashMap<>(caseFields));", "originalCommit": "e7f8784041eea43e1bea615e061fe72ea2bddb45", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY0Njg2OQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/855#discussion_r404646869", "bodyText": "specific exceptions rather than catching very generic Exception?", "author": "smathangi", "createdAt": "2020-04-07T08:55:07Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/processor/SearchInputProcessor.java", "diffHunk": "@@ -0,0 +1,87 @@\n+package uk.gov.hmcts.ccd.domain.service.processor;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Component;\n+import uk.gov.hmcts.ccd.data.casedetails.search.MetaData;\n+import uk.gov.hmcts.ccd.domain.model.definition.FieldType;\n+import uk.gov.hmcts.ccd.domain.model.search.CriteriaInput;\n+import uk.gov.hmcts.ccd.domain.model.search.CriteriaType;\n+import uk.gov.hmcts.ccd.domain.service.aggregated.DefaultGetCriteriaOperation;\n+import uk.gov.hmcts.ccd.domain.service.aggregated.GetCriteriaOperation;\n+import uk.gov.hmcts.ccd.endpoint.exceptions.DataProcessingException;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+@Component\n+public class SearchInputProcessor {\n+\n+    protected static final ObjectMapper MAPPER = new ObjectMapper();\n+\n+    private final DateTimeFormatParser dateTimeFormatParser;\n+    private final GetCriteriaOperation getCriteriaOperation;\n+\n+    @Autowired\n+    public SearchInputProcessor(final DateTimeFormatParser dateTimeFormatParser,\n+                                @Qualifier(DefaultGetCriteriaOperation.QUALIFIER) final GetCriteriaOperation getCriteriaOperation) {\n+        this.dateTimeFormatParser = dateTimeFormatParser;\n+        this.getCriteriaOperation = getCriteriaOperation;\n+    }\n+\n+    public Map<String, String> execute(String view, MetaData metadata, Map<String, String> queryParameters) {\n+        List<? extends CriteriaInput> criteriaInputs =\n+            getCriteriaOperation.execute(metadata.getCaseTypeId(), null,\n+                view == null ? CriteriaType.SEARCH : CriteriaType.valueOf(view));\n+\n+        Map<String, String> newParams = new HashMap<>();\n+        queryParameters.entrySet().stream().forEach(entry -> {\n+            Optional<? extends CriteriaInput> input = criteriaInputs.stream()\n+                .filter(i -> i.getField().getId().equals(entry.getKey()))\n+                .findAny();\n+\n+            if (input.isPresent() &&\n+                DisplayContextParameter\n+                    .hasDisplayContextParameterType(input.get().getDisplayContextParameter(), DisplayContextParameterType.DATETIMEENTRY)) {\n+                newParams.put(entry.getKey(),\n+                    processValue(entry.getKey(), input.get().getDisplayContextParameter(),\n+                        entry.getValue(), input.get().getField().getType()));\n+            } else {\n+                newParams.put(entry.getKey(), entry.getValue());\n+            }\n+        });\n+\n+        return newParams;\n+    }\n+\n+    private String processValue(String id, String displayContextParameter, String value, FieldType fieldType) {\n+        try {\n+            if (fieldType.getType().equals(FieldType.DATE)) {\n+                return dateTimeFormatParser.convertDateToIso8601(format(displayContextParameter, fieldType), value);\n+            } else if (fieldType.getType().equals(FieldType.DATETIME)) {\n+                return dateTimeFormatParser.convertDateTimeToIso8601(format(displayContextParameter, fieldType), value);\n+            } else {\n+                return value;\n+            }\n+        } catch (Exception e) {", "originalCommit": "e7f8784041eea43e1bea615e061fe72ea2bddb45", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "e48623b6665c787599aa70f1a4139ca1b2a74d95", "url": "https://github.com/hmcts/ccd-data-store-api/commit/e48623b6665c787599aa70f1a4139ca1b2a74d95", "message": "Merge branch 'RDM-7692' into RDM-7694", "committedDate": "2020-04-07T11:57:23Z", "type": "commit"}, {"oid": "61be3bdf38361f6631f7ea3bb27a81a8a95539ea", "url": "https://github.com/hmcts/ccd-data-store-api/commit/61be3bdf38361f6631f7ea3bb27a81a8a95539ea", "message": "RDM-8113 handle display without seconds or milliseconds\nRDM-8057 split DCP correctly when there is multiple params", "committedDate": "2020-04-09T12:21:01Z", "type": "commit"}, {"oid": "622181fc4cb20ff67c626dd5a860a6f97189da10", "url": "https://github.com/hmcts/ccd-data-store-api/commit/622181fc4cb20ff67c626dd5a860a6f97189da10", "message": "RDM-8113 updated functional response", "committedDate": "2020-04-09T12:53:42Z", "type": "commit"}, {"oid": "b02cbadefeece8e4fab9f120e48db5d0c5bb3cdc", "url": "https://github.com/hmcts/ccd-data-store-api/commit/b02cbadefeece8e4fab9f120e48db5d0c5bb3cdc", "message": "RDM-8113 added unit tests for partial milliseconds", "committedDate": "2020-04-09T14:19:05Z", "type": "commit"}, {"oid": "19101d5fc91a714a1f84b5e67facf5c7da82d919", "url": "https://github.com/hmcts/ccd-data-store-api/commit/19101d5fc91a714a1f84b5e67facf5c7da82d919", "message": "RDM-8113 updated functional test", "committedDate": "2020-04-10T06:29:56Z", "type": "commit"}, {"oid": "a6bcba95f56c01f40df1f522ac4eaebc0d63c172", "url": "https://github.com/hmcts/ccd-data-store-api/commit/a6bcba95f56c01f40df1f522ac4eaebc0d63c172", "message": "RDM-8113 updated functional test", "committedDate": "2020-04-10T06:54:11Z", "type": "commit"}, {"oid": "e8220490c5ce02151f34908079418a5fbb38a95f", "url": "https://github.com/hmcts/ccd-data-store-api/commit/e8220490c5ce02151f34908079418a5fbb38a95f", "message": "Merge pull request #899 from hmcts/RDM-8113\n\nRDM-8113 handle display without seconds or milliseconds", "committedDate": "2020-04-15T08:44:22Z", "type": "commit"}]}