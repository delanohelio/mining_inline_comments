{"pr_number": 799, "pr_title": "Rdm 4641 - Persist state last modified dateTime", "pr_createdAt": "2020-02-06T12:05:19Z", "pr_url": "https://github.com/hmcts/ccd-data-store-api/pull/799", "timeline": [{"oid": "9702977849f4ec3e31a1d9c4b424c65f8a416951", "url": "https://github.com/hmcts/ccd-data-store-api/commit/9702977849f4ec3e31a1d9c4b424c65f8a416951", "message": "RDM-4641 - added new matadata field 'LAST_STATE_MODIFIED_DATE'", "committedDate": "2020-01-29T10:24:45Z", "type": "commit"}, {"oid": "ca90cdfaff531112ad765063060aaa830c54cd26", "url": "https://github.com/hmcts/ccd-data-store-api/commit/ca90cdfaff531112ad765063060aaa830c54cd26", "message": "RDM-4641 - persist state last modified dateTime", "committedDate": "2020-02-06T11:35:06Z", "type": "commit"}, {"oid": "f67e97ceb4ee9bf80a76be295451a3954e1d06da", "url": "https://github.com/hmcts/ccd-data-store-api/commit/f67e97ceb4ee9bf80a76be295451a3954e1d06da", "message": "Merge branch 'develop' into RDM-4641", "committedDate": "2020-02-06T11:41:54Z", "type": "commit"}, {"oid": "4d42b97d6848138ad18ea28be6dbc16eb9ce96e2", "url": "https://github.com/hmcts/ccd-data-store-api/commit/4d42b97d6848138ad18ea28be6dbc16eb9ce96e2", "message": "RDM-4641 - imports fix", "committedDate": "2020-02-06T12:04:32Z", "type": "commit"}, {"oid": "c4ede4f098d78e8d9ea426dd5488c59187b141c4", "url": "https://github.com/hmcts/ccd-data-store-api/commit/c4ede4f098d78e8d9ea426dd5488c59187b141c4", "message": "RDM-4641 - added last_state_modified_date to all test jsons for GET response.", "committedDate": "2020-02-06T23:03:57Z", "type": "commit"}, {"oid": "99f68c9f8753ecadc23d65501323299f954e96e5", "url": "https://github.com/hmcts/ccd-data-store-api/commit/99f68c9f8753ecadc23d65501323299f954e96e5", "message": "Merge branch 'develop' into RDM-4641", "committedDate": "2020-02-07T08:55:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk1MDMxMQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/799#discussion_r376950311", "bodyText": "just an improvement suggestion. Feel free to ignore.\nUsually when working with dates, to make testability simpler, it's recommended to have a DateService with methods like now() and others which can then be mocked in Unit tests. We could introduce that", "author": "mario-paniccia", "createdAt": "2020-02-10T09:36:25Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/createevent/CreateCaseEventService.java", "diffHunk": "@@ -168,12 +168,15 @@ private CaseDetails getCaseDetails(final String caseReference) {\n             .orElseThrow(() -> new ResourceNotFoundException(format(\"Case with reference %s could not be found\", caseReference)));\n     }\n \n-    private CaseDetails saveCaseDetails(final CaseDetails caseDetails,\n+    private CaseDetails saveCaseDetails(CaseDetails caseDetailsBefore, final CaseDetails caseDetails,\n                                         final CaseEvent eventTrigger,\n                                         final Optional<String> state) {\n         if (!state.isPresent() && !equalsIgnoreCase(CaseState.ANY, eventTrigger.getPostState())) {\n             caseDetails.setState(eventTrigger.getPostState());\n         }\n+        if (!caseDetails.getState().equalsIgnoreCase(caseDetailsBefore.getState())) {\n+            caseDetails.setLastStateModifiedDate(LocalDateTime.now(ZoneOffset.UTC));", "originalCommit": "99f68c9f8753ecadc23d65501323299f954e96e5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA2NTAxOA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/799#discussion_r377065018", "bodyText": "Yes, I agree. I'll see if i can introduce \"Clock\" class.", "author": "smathangi", "createdAt": "2020-02-10T13:36:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk1MDMxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc2NjI5Ng==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/799#discussion_r377766296", "bodyText": "done", "author": "smathangi", "createdAt": "2020-02-11T16:56:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk1MDMxMQ=="}], "type": "inlineReview", "revised_code": {"commit": "d6f07349689959775cfcb67b46eb7dd38d1ccda0", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/domain/service/createevent/CreateCaseEventService.java b/src/main/java/uk/gov/hmcts/ccd/domain/service/createevent/CreateCaseEventService.java\nindex dedd2e067..6c1f9ecc9 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/domain/service/createevent/CreateCaseEventService.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/domain/service/createevent/CreateCaseEventService.java\n\n@@ -175,11 +178,15 @@ public class CreateCaseEventService {\n             caseDetails.setState(eventTrigger.getPostState());\n         }\n         if (!caseDetails.getState().equalsIgnoreCase(caseDetailsBefore.getState())) {\n-            caseDetails.setLastStateModifiedDate(LocalDateTime.now(ZoneOffset.UTC));\n+            caseDetails.setLastStateModifiedDate(now());\n         }\n         return caseDetailsRepository.set(caseDetails);\n     }\n \n+    private LocalDateTime now() {\n+        return LocalDateTime.now(clock);\n+    }\n+\n     private void mergeUpdatedFieldsToCaseDetails(final Map<String, JsonNode> data,\n                                                  final CaseDetails caseDetails,\n                                                  final CaseEvent caseEvent,\n"}}, {"oid": "fdf926fddb411920782cdb0090636cbbcf4c28d6", "url": "https://github.com/hmcts/ccd-data-store-api/commit/fdf926fddb411920782cdb0090636cbbcf4c28d6", "message": "Merge branch 'develop' into RDM-4641\n\nConflicts:\n\tsrc/aat/resources/features/F-036/S-199.td.json\n\tsrc/aat/resources/features/F-037/S-577_Get_Case_For_Case_Worker_Data_Base.td.json\n\tsrc/aat/resources/features/F-040/F-040_Later_Case_Read_By_Solicitor_1.td.json\n\tsrc/aat/resources/features/F-040/F-040_Later_Case_Read_By_Solicitor_3.td.json\n\tsrc/aat/resources/features/F-040/S-576.td.json\n\tsrc/aat/resources/features/F-042/S-243.td.json\n\tsrc/aat/resources/features/F-042/S-249_Update_Case_State.td.json\n\tsrc/aat/resources/features/F-044/F-044-Prerequisite_CaseUpdate.td.json\n\tsrc/aat/resources/features/F-044/S-278.td.json\n\tsrc/aat/resources/features/F-044/S-579.td.json\n\tsrc/aat/resources/features/F-044/S-579_Get_Case_For_Case_Worker_Data_Base.td.json\n\tsrc/aat/resources/features/F-044/S-579_Later_Case_Read_By_Solicitor_1.td.json\n\tsrc/aat/resources/features/F-044/S-579_Later_Case_Update_By_Solicitor_3.td.json\n\tsrc/aat/resources/features/F-053/S-269.td.json\n\tsrc/aat/resources/features/F-054/S-093.td.json\n\tsrc/aat/resources/features/F-055/S-251.td.json\n\tsrc/aat/resources/features/F-056/S-288.td.json\n\tsrc/aat/resources/features/F-056/S-582.td.json\n\tsrc/aat/resources/features/F-056/S-582_Get_Case_For_Citizen_Data_Base.td.json\n\tsrc/aat/resources/features/F-065/S-164-Prerequisite_Case_Update.td.json\n\tsrc/aat/resources/features/common/case/Case_Creation_Data_Base.td.json\n\tsrc/aat/resources/features/common/case/Citizen_Full_Case_Creation_Data.td.json\n\tsrc/aat/resources/features/common/case/befta-jurisdiction2-case-creation/Befta_Jurisdiction2_Case_Creation_Base_Data.td.json\n\tsrc/aat/resources/features/common/case/befta-jurisdiction2-case-creation/Befta_Jurisdiction2_Default_Full_Case_Creation_Data.td.json\n\tsrc/aat/resources/features/common/case/befta-jurisdiction2-case-creation_by_solicitor_1/Befta_Jurisdiction2_Case_Creation_Base_Data_Solicitor_1.td.json\n\tsrc/aat/resources/features/common/case/befta-jurisdiction2-case-creation_by_solicitor_1/Befta_Jurisdiction2_Default_Full_Case_Creation_Data_solicitor_1.td.json\n\tsrc/aat/resources/features/common/case/befta-jurisdiction2-citizen-case-creation/Befta_Jurisdiction2_Citizen_Case_Creation_Base_Data.td.json\n\tsrc/aat/resources/features/common/case/befta-jurisdiction2-citizen-case-creation/Befta_Jurisdiction2_Default_Citizen_Case_Creation_Data.td.json\n\tsrc/aat/resources/features/common/case/befta_new/Befta_Case_Creation_Base_Data.td.json", "committedDate": "2020-02-10T10:22:47Z", "type": "commit"}, {"oid": "aac3dca59527fef988730450a65dbff164fa611e", "url": "https://github.com/hmcts/ccd-data-store-api/commit/aac3dca59527fef988730450a65dbff164fa611e", "message": "correct merge error", "committedDate": "2020-02-10T10:24:29Z", "type": "commit"}, {"oid": "170cfddd17d2968f97cd07e41ca6f3f96b2738bc", "url": "https://github.com/hmcts/ccd-data-store-api/commit/170cfddd17d2968f97cd07e41ca6f3f96b2738bc", "message": "Merge branch 'develop' into RDM-4641", "committedDate": "2020-02-10T10:55:19Z", "type": "commit"}, {"oid": "bcded7b869d215e3b2d0f942bdd3d726d44aa539", "url": "https://github.com/hmcts/ccd-data-store-api/commit/bcded7b869d215e3b2d0f942bdd3d726d44aa539", "message": "Merge branch 'develop' into RDM-4641", "committedDate": "2020-02-10T11:20:43Z", "type": "commit"}, {"oid": "1bba6c2c9e1be0d92dab1fc6a751abbbdb87c6d7", "url": "https://github.com/hmcts/ccd-data-store-api/commit/1bba6c2c9e1be0d92dab1fc6a751abbbdb87c6d7", "message": "Merge branch 'RDM-7583' into RDM-4641", "committedDate": "2020-02-10T12:02:12Z", "type": "commit"}, {"oid": "3bf036cb14ad2f88662b166f815b5461e09d8242", "url": "https://github.com/hmcts/ccd-data-store-api/commit/3bf036cb14ad2f88662b166f815b5461e09d8242", "message": "Merge branch 'develop' into RDM-4641", "committedDate": "2020-02-11T09:49:10Z", "type": "commit"}, {"oid": "d6f07349689959775cfcb67b46eb7dd38d1ccda0", "url": "https://github.com/hmcts/ccd-data-store-api/commit/d6f07349689959775cfcb67b46eb7dd38d1ccda0", "message": "RDM-4641 - added Clock utility and fixed search criteria query", "committedDate": "2020-02-11T16:22:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE4OTAwMA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/799#discussion_r378189000", "bodyText": "shall we do utcClock?", "author": "mario-paniccia", "createdAt": "2020-02-12T11:18:33Z", "path": "src/main/java/uk/gov/hmcts/ccd/CoreCaseDataApplication.java", "diffHunk": "@@ -33,4 +37,9 @@ public static void main(String[] args) {\n         SpringApplication.run(CoreCaseDataApplication.class, args);\n     }\n \n+    @Bean\n+    public Clock uTCClock() {", "originalCommit": "d6f07349689959775cfcb67b46eb7dd38d1ccda0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c1be93039b16867adfa18ccb5a1bf161aa3c649d", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/CoreCaseDataApplication.java b/src/main/java/uk/gov/hmcts/ccd/CoreCaseDataApplication.java\nindex 7533156fd..7012888f0 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/CoreCaseDataApplication.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/CoreCaseDataApplication.java\n\n@@ -39,7 +38,7 @@ public class CoreCaseDataApplication {\n \n     @Bean\n     public Clock uTCClock() {\n-        return Clock.system(ZoneOffset.UTC);\n+        return Clock.systemUTC();\n     }\n \n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE5MjY2OA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/799#discussion_r378192668", "bodyText": "could we replace with:\nClock.systemUTC()?", "author": "mario-paniccia", "createdAt": "2020-02-12T11:26:35Z", "path": "src/main/java/uk/gov/hmcts/ccd/CoreCaseDataApplication.java", "diffHunk": "@@ -33,4 +37,9 @@ public static void main(String[] args) {\n         SpringApplication.run(CoreCaseDataApplication.class, args);\n     }\n \n+    @Bean\n+    public Clock uTCClock() {\n+        return Clock.system(ZoneOffset.UTC);", "originalCommit": "d6f07349689959775cfcb67b46eb7dd38d1ccda0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE5NjEzOA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/799#discussion_r378196138", "bodyText": "can we notify QAs we've made some changes on the way we retrieve current time ? Better doing some regression testing on this", "author": "mario-paniccia", "createdAt": "2020-02-12T11:33:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE5MjY2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE5ODc3MQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/799#discussion_r378198771", "bodyText": "sure but no changes tbh.\nLocalDateTime.now(ZoneOffset.UTC) => LocalDateTime.now(Clock.systemUTC())", "author": "smathangi", "createdAt": "2020-02-12T11:39:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE5MjY2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIwMjQxNg==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/799#discussion_r378202416", "bodyText": "ok then if you are 100% confident ignore my request", "author": "mario-paniccia", "createdAt": "2020-02-12T11:47:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE5MjY2OA=="}], "type": "inlineReview", "revised_code": {"commit": "c1be93039b16867adfa18ccb5a1bf161aa3c649d", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/CoreCaseDataApplication.java b/src/main/java/uk/gov/hmcts/ccd/CoreCaseDataApplication.java\nindex 7533156fd..7012888f0 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/CoreCaseDataApplication.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/CoreCaseDataApplication.java\n\n@@ -39,7 +38,7 @@ public class CoreCaseDataApplication {\n \n     @Bean\n     public Clock uTCClock() {\n-        return Clock.system(ZoneOffset.UTC);\n+        return Clock.systemUTC();\n     }\n \n }\n"}}, {"oid": "c1be93039b16867adfa18ccb5a1bf161aa3c649d", "url": "https://github.com/hmcts/ccd-data-store-api/commit/c1be93039b16867adfa18ccb5a1bf161aa3c649d", "message": "RDM-4641 - minor review comment.", "committedDate": "2020-02-12T11:37:17Z", "type": "commit"}, {"oid": "d5e6084bac326a3b4df664e7ad073ad5cad67234", "url": "https://github.com/hmcts/ccd-data-store-api/commit/d5e6084bac326a3b4df664e7ad073ad5cad67234", "message": "RDM-4641 - minor review comment.", "committedDate": "2020-02-12T11:51:13Z", "type": "commit"}, {"oid": "b9a46b976f92d07e963d352891af12c8d734bc7e", "url": "https://github.com/hmcts/ccd-data-store-api/commit/b9a46b976f92d07e963d352891af12c8d734bc7e", "message": "Merge branch 'develop' into RDM-4641", "committedDate": "2020-02-12T12:20:43Z", "type": "commit"}, {"oid": "3ad68942da58ec1bb9ba8fa0111255bd5661fc88", "url": "https://github.com/hmcts/ccd-data-store-api/commit/3ad68942da58ec1bb9ba8fa0111255bd5661fc88", "message": "Merge branch 'develop' into RDM-4641", "committedDate": "2020-02-13T16:48:16Z", "type": "commit"}, {"oid": "b8d4e799056c25c05eee172107472e687a4c067f", "url": "https://github.com/hmcts/ccd-data-store-api/commit/b8d4e799056c25c05eee172107472e687a4c067f", "message": "RDM-5691 - setting same time for last_state and event creation date and time.", "committedDate": "2020-02-17T09:33:45Z", "type": "commit"}, {"oid": "af4be3eb2d7efc23d9d1f4a4335627273128a87d", "url": "https://github.com/hmcts/ccd-data-store-api/commit/af4be3eb2d7efc23d9d1f4a4335627273128a87d", "message": "RDM-4641 - fixing V2 response for lastStateModified", "committedDate": "2020-02-20T13:06:41Z", "type": "commit"}, {"oid": "5852a6dba78f4dab32fc37a2a4124d06b0fee9be", "url": "https://github.com/hmcts/ccd-data-store-api/commit/5852a6dba78f4dab32fc37a2a4124d06b0fee9be", "message": "added functional tests", "committedDate": "2020-02-21T14:56:00Z", "type": "commit"}, {"oid": "c2ce4cba3e353282726e7d5c4447246723f43ff0", "url": "https://github.com/hmcts/ccd-data-store-api/commit/c2ce4cba3e353282726e7d5c4447246723f43ff0", "message": "Merge branch 'RDM-4641' of github.com:hmcts/ccd-data-store-api into RDM-4641", "committedDate": "2020-02-21T14:56:11Z", "type": "commit"}, {"oid": "a94f4757a39515ea7a8aeb3091706dcba6c6e16d", "url": "https://github.com/hmcts/ccd-data-store-api/commit/a94f4757a39515ea7a8aeb3091706dcba6c6e16d", "message": "Merge branch 'develop' into RDM-4641", "committedDate": "2020-02-21T14:57:42Z", "type": "commit"}, {"oid": "ced28c4fb249a49f01b853a01ee4d01b0c25c562", "url": "https://github.com/hmcts/ccd-data-store-api/commit/ced28c4fb249a49f01b853a01ee4d01b0c25c562", "message": "Merge branch 'RDM-4641' of github.com:hmcts/ccd-data-store-api into RDM-4641", "committedDate": "2020-02-21T14:57:58Z", "type": "commit"}, {"oid": "1a93c28672ec6de69779dbe1c3740425c56ae8cb", "url": "https://github.com/hmcts/ccd-data-store-api/commit/1a93c28672ec6de69779dbe1c3740425c56ae8cb", "message": "updated tests with valid response", "committedDate": "2020-02-21T16:23:56Z", "type": "commit"}, {"oid": "e0e689c159a368b15b9bf8b469d3b17c75202465", "url": "https://github.com/hmcts/ccd-data-store-api/commit/e0e689c159a368b15b9bf8b469d3b17c75202465", "message": "updated json data to fix failures", "committedDate": "2020-02-21T17:20:55Z", "type": "commit"}, {"oid": "c53041f349ccfd3abb01770ce564691544f1e91c", "url": "https://github.com/hmcts/ccd-data-store-api/commit/c53041f349ccfd3abb01770ce564691544f1e91c", "message": "fixing header mismatch in func tests", "committedDate": "2020-02-24T09:12:41Z", "type": "commit"}, {"oid": "618348bd402350779950ade318cb77f478c3762f", "url": "https://github.com/hmcts/ccd-data-store-api/commit/618348bd402350779950ade318cb77f478c3762f", "message": "Merge branch 'develop' into RDM-4641", "committedDate": "2020-02-25T12:47:42Z", "type": "commit"}, {"oid": "6e742511f916ee4618ed5a5dde90922de50c3055", "url": "https://github.com/hmcts/ccd-data-store-api/commit/6e742511f916ee4618ed5a5dde90922de50c3055", "message": "fixed response data", "committedDate": "2020-02-25T14:25:17Z", "type": "commit"}, {"oid": "30d2caf4a10cece9b9c2e022d1a9431c62bcaf34", "url": "https://github.com/hmcts/ccd-data-store-api/commit/30d2caf4a10cece9b9c2e022d1a9431c62bcaf34", "message": "Merge branch 'RDM-4641' of github.com:hmcts/ccd-data-store-api into RDM-4641", "committedDate": "2020-02-25T14:25:43Z", "type": "commit"}, {"oid": "8b1d6f9125f5ca44fd04f71d4077750829fffc73", "url": "https://github.com/hmcts/ccd-data-store-api/commit/8b1d6f9125f5ca44fd04f71d4077750829fffc73", "message": "Merge branch 'develop' into RDM-4641", "committedDate": "2020-02-26T10:38:11Z", "type": "commit"}, {"oid": "b71e8e0a86edd32594905199f4213581aaf14e62", "url": "https://github.com/hmcts/ccd-data-store-api/commit/b71e8e0a86edd32594905199f4213581aaf14e62", "message": "updated with jira reference for case list ordering", "committedDate": "2020-02-26T14:53:45Z", "type": "commit"}, {"oid": "d9f44f9c04471aaab2e63f2471024e506d7ee159", "url": "https://github.com/hmcts/ccd-data-store-api/commit/d9f44f9c04471aaab2e63f2471024e506d7ee159", "message": "Merge branch 'RDM-4641' of github.com:hmcts/ccd-data-store-api into RDM-4641", "committedDate": "2020-02-26T14:54:04Z", "type": "commit"}]}