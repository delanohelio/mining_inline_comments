{"pr_number": 968, "pr_title": "RDM-8344: Implement 'Get Case-Assigned Users and Roles'", "pr_createdAt": "2020-06-04T23:20:22Z", "pr_url": "https://github.com/hmcts/ccd-data-store-api/pull/968", "timeline": [{"oid": "3b7752f26f33d9bf459d1b25b32ced987ab4fd59", "url": "https://github.com/hmcts/ccd-data-store-api/commit/3b7752f26f33d9bf459d1b25b32ced987ab4fd59", "message": "RDM-8344: Implement Get Case-Assigned Users and Roles", "committedDate": "2020-06-04T23:22:18Z", "type": "commit"}, {"oid": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad", "url": "https://github.com/hmcts/ccd-data-store-api/commit/1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad", "message": "RDM-8344: Fixed Checkstyle issues", "committedDate": "2020-06-04T23:44:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTczNzA3OQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r435737079", "bodyText": "But even if we do, a set equivalence should be used for this kind of a key design. What if the a list contains a duplicate entry while all others being the same as the other? I suspect we need a caching and therefore a key design like this.", "author": "MSancaktutar", "createdAt": "2020-06-05T07:26:19Z", "path": "src/main/java/uk/gov/hmcts/ccd/data/caseaccess/CaseAssignedUserRolesKey.java", "diffHunk": "@@ -0,0 +1,42 @@\n+package uk.gov.hmcts.ccd.data.caseaccess;\n+\n+import java.util.List;\n+import org.apache.commons.collections.ListUtils;\n+\n+public class CaseAssignedUserRolesKey {\n+\n+    private final List<Long> caseIds;\n+\n+    private final List<String> userIds;\n+\n+    public CaseAssignedUserRolesKey(List<Long> caseIds, List<String> userIds) {\n+        this.caseIds = caseIds;\n+        this.userIds = userIds;\n+    }\n+\n+    @Override\n+    public boolean equals(Object o) {\n+        if (this == o) {\n+            return true;\n+        }\n+        if (o == null || getClass() != o.getClass()) {\n+            return false;\n+        }\n+        CaseAssignedUserRolesKey that = (CaseAssignedUserRolesKey) o;\n+        if (caseIds == null || that.caseIds == null || caseIds.size() != that.caseIds.size()) {\n+            return false;\n+        }\n+\n+        if (userIds == null || that.userIds == null || userIds.size() != that.userIds.size()) {\n+            return false;\n+        }\n+        return caseIds.containsAll(that.caseIds) && userIds.containsAll(that.userIds);", "originalCommit": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "50d834a4e85b24b88b69b5d70c5e949ddb87ac46", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/data/caseaccess/CaseAssignedUserRolesKey.java b/src/main/java/uk/gov/hmcts/ccd/data/caseaccess/CaseAssignedUserRolesKey.java\nindex 8aba1f38d..8796f1fee 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/data/caseaccess/CaseAssignedUserRolesKey.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/data/caseaccess/CaseAssignedUserRolesKey.java\n\n@@ -1,15 +1,15 @@\n package uk.gov.hmcts.ccd.data.caseaccess;\n \n-import java.util.List;\n+import java.util.Set;\n import org.apache.commons.collections.ListUtils;\n \n public class CaseAssignedUserRolesKey {\n \n-    private final List<Long> caseIds;\n+    private final Set<Long> caseIds;\n \n-    private final List<String> userIds;\n+    private final Set<String> userIds;\n \n-    public CaseAssignedUserRolesKey(List<Long> caseIds, List<String> userIds) {\n+    public CaseAssignedUserRolesKey(Set<Long> caseIds, Set<String> userIds) {\n         this.caseIds = caseIds;\n         this.userIds = userIds;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTczNzEwMg==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r435737102", "bodyText": "This caching doesn't seem to be ok. What if the case-user-role assignments change? And what if the list of user ids and case ids are provided in a different order? And, what is the eviction policy of this cache?", "author": "MSancaktutar", "createdAt": "2020-06-05T07:26:23Z", "path": "src/main/java/uk/gov/hmcts/ccd/data/caseaccess/CachedCaseUserRepository.java", "diffHunk": "@@ -43,4 +44,11 @@ public void revokeAccess(Long caseId, String userId, String caseRole) {\n     public List<String> findCaseRoles(final Long caseId, final String userId) {\n         return caseUserRoles.computeIfAbsent(caseId + userId, e -> caseUserRepository.findCaseRoles(caseId, userId));\n     }\n+\n+    @Override\n+    public List<CaseUserEntity> findCaseUserRoles(List<Long> caseIds, List<String> userIds) {\n+        return caseAssignedUserRoles.computeIfAbsent(\n+            new CaseAssignedUserRolesKey(caseIds, userIds),\n+            e -> caseUserRepository.findCaseUserRoles(caseIds, userIds));\n+    }", "originalCommit": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "50d834a4e85b24b88b69b5d70c5e949ddb87ac46", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/data/caseaccess/CachedCaseUserRepository.java b/src/main/java/uk/gov/hmcts/ccd/data/caseaccess/CachedCaseUserRepository.java\nindex 35ea1a8b6..53701e401 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/data/caseaccess/CachedCaseUserRepository.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/data/caseaccess/CachedCaseUserRepository.java\n\n@@ -48,7 +49,7 @@ public class CachedCaseUserRepository implements CaseUserRepository {\n     @Override\n     public List<CaseUserEntity> findCaseUserRoles(List<Long> caseIds, List<String> userIds) {\n         return caseAssignedUserRoles.computeIfAbsent(\n-            new CaseAssignedUserRolesKey(caseIds, userIds),\n+            new CaseAssignedUserRolesKey(new HashSet<>(caseIds), new HashSet<>(userIds)),\n             e -> caseUserRepository.findCaseUserRoles(caseIds, userIds));\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTczODEyNw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r435738127", "bodyText": "this could be written nicer with less or no repeated lines.", "author": "MSancaktutar", "createdAt": "2020-06-05T07:28:27Z", "path": "src/main/java/uk/gov/hmcts/ccd/data/caseaccess/DefaultCaseUserRepository.java", "diffHunk": "@@ -53,4 +53,17 @@ public void revokeAccess(Long caseId, String userId, String caseRole) {\n \n         return namedQuery.getResultList();\n     }\n+\n+    public List<CaseUserEntity> findCaseUserRoles(final List<Long> caseIds, final List<String> userIds) {\n+        if (userIds.size() == 0) {\n+            TypedQuery<CaseUserEntity> namedQuery = em.createNamedQuery(CaseUserEntity.GET_ALL_CASE_ROLES_BY_CASE_IDS, CaseUserEntity.class);\n+            namedQuery.setParameter(CaseUserEntity.PARAM_CASE_DATA_IDS, caseIds);\n+            return namedQuery.getResultList();\n+        } else {\n+            TypedQuery<CaseUserEntity> namedQuery = em.createNamedQuery(CaseUserEntity.GET_ALL_CASE_ROLES_USERS_HAS_ACCESS_TO_CASES, CaseUserEntity.class);\n+            namedQuery.setParameter(CaseUserEntity.PARAM_CASE_DATA_IDS, caseIds);\n+            namedQuery.setParameter(CaseUserEntity.PARAM_USER_IDS, userIds);\n+            return namedQuery.getResultList();\n+        }", "originalCommit": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "50d834a4e85b24b88b69b5d70c5e949ddb87ac46", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/data/caseaccess/DefaultCaseUserRepository.java b/src/main/java/uk/gov/hmcts/ccd/data/caseaccess/DefaultCaseUserRepository.java\nindex b622336b6..532c43a16 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/data/caseaccess/DefaultCaseUserRepository.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/data/caseaccess/DefaultCaseUserRepository.java\n\n@@ -55,15 +55,14 @@ public class DefaultCaseUserRepository implements CaseUserRepository {\n     }\n \n     public List<CaseUserEntity> findCaseUserRoles(final List<Long> caseIds, final List<String> userIds) {\n+        TypedQuery<CaseUserEntity> namedQuery = null;\n         if (userIds.size() == 0) {\n-            TypedQuery<CaseUserEntity> namedQuery = em.createNamedQuery(CaseUserEntity.GET_ALL_CASE_ROLES_BY_CASE_IDS, CaseUserEntity.class);\n-            namedQuery.setParameter(CaseUserEntity.PARAM_CASE_DATA_IDS, caseIds);\n-            return namedQuery.getResultList();\n+            namedQuery = em.createNamedQuery(CaseUserEntity.GET_ALL_CASE_ROLES_BY_CASE_IDS, CaseUserEntity.class);\n         } else {\n-            TypedQuery<CaseUserEntity> namedQuery = em.createNamedQuery(CaseUserEntity.GET_ALL_CASE_ROLES_USERS_HAS_ACCESS_TO_CASES, CaseUserEntity.class);\n-            namedQuery.setParameter(CaseUserEntity.PARAM_CASE_DATA_IDS, caseIds);\n+            namedQuery = em.createNamedQuery(CaseUserEntity.GET_ALL_CASE_ROLES_USERS_HAS_ACCESS_TO_CASES, CaseUserEntity.class);\n             namedQuery.setParameter(CaseUserEntity.PARAM_USER_IDS, userIds);\n-            return namedQuery.getResultList();\n         }\n+        namedQuery.setParameter(CaseUserEntity.PARAM_CASE_DATA_IDS, caseIds);\n+        return namedQuery.getResultList();\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc0MzM2MQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r435743361", "bodyText": "could id (reference) is a String / (varchar 255) elsewhere in CCD.", "author": "MSancaktutar", "createdAt": "2020-06-05T07:39:23Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/std/CaseAssignedUserRole.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package uk.gov.hmcts.ccd.domain.model.std;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import lombok.AllArgsConstructor;\n+import lombok.NoArgsConstructor;\n+import lombok.ToString;\n+\n+@ToString\n+@AllArgsConstructor\n+@NoArgsConstructor\n+public class CaseAssignedUserRole {\n+\n+    @JsonProperty(\"case_data_id\")\n+    private Long caseDataId;", "originalCommit": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg0MDI4OA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r435840288", "bodyText": "changed to String!!", "author": "kiran-yenigala-hmcts", "createdAt": "2020-06-05T10:43:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc0MzM2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "50d834a4e85b24b88b69b5d70c5e949ddb87ac46", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/domain/model/std/CaseAssignedUserRole.java b/src/main/java/uk/gov/hmcts/ccd/domain/model/std/CaseAssignedUserRole.java\nindex f53e7d80d..5ec09ce91 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/domain/model/std/CaseAssignedUserRole.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/domain/model/std/CaseAssignedUserRole.java\n\n@@ -2,32 +2,22 @@ package uk.gov.hmcts.ccd.domain.model.std;\n \n import com.fasterxml.jackson.annotation.JsonProperty;\n import lombok.AllArgsConstructor;\n+import lombok.Getter;\n import lombok.NoArgsConstructor;\n import lombok.ToString;\n \n @ToString\n @AllArgsConstructor\n @NoArgsConstructor\n+@Getter\n public class CaseAssignedUserRole {\n \n-    @JsonProperty(\"case_data_id\")\n-    private Long caseDataId;\n+    @JsonProperty(\"case_id\")\n+    private String caseDataId;\n \n     @JsonProperty(\"user_id\")\n     private String userId;\n \n     @JsonProperty(\"case_role\")\n     private String caseRole;\n-\n-    public Long getCaseDataId() {\n-        return caseDataId;\n-    }\n-\n-    public String getUserId() {\n-        return userId;\n-    }\n-\n-    public String getCaseRole() {\n-        return caseRole;\n-    }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc0Mzc1OQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r435743759", "bodyText": "case_id is used in LLD and other references", "author": "MSancaktutar", "createdAt": "2020-06-05T07:40:07Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/std/CaseAssignedUserRole.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package uk.gov.hmcts.ccd.domain.model.std;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import lombok.AllArgsConstructor;\n+import lombok.NoArgsConstructor;\n+import lombok.ToString;\n+\n+@ToString\n+@AllArgsConstructor\n+@NoArgsConstructor\n+public class CaseAssignedUserRole {\n+\n+    @JsonProperty(\"case_data_id\")", "originalCommit": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTgzNzU4OQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r435837589", "bodyText": "Done", "author": "kiran-yenigala-hmcts", "createdAt": "2020-06-05T10:37:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc0Mzc1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "50d834a4e85b24b88b69b5d70c5e949ddb87ac46", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/domain/model/std/CaseAssignedUserRole.java b/src/main/java/uk/gov/hmcts/ccd/domain/model/std/CaseAssignedUserRole.java\nindex f53e7d80d..5ec09ce91 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/domain/model/std/CaseAssignedUserRole.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/domain/model/std/CaseAssignedUserRole.java\n\n@@ -2,32 +2,22 @@ package uk.gov.hmcts.ccd.domain.model.std;\n \n import com.fasterxml.jackson.annotation.JsonProperty;\n import lombok.AllArgsConstructor;\n+import lombok.Getter;\n import lombok.NoArgsConstructor;\n import lombok.ToString;\n \n @ToString\n @AllArgsConstructor\n @NoArgsConstructor\n+@Getter\n public class CaseAssignedUserRole {\n \n-    @JsonProperty(\"case_data_id\")\n-    private Long caseDataId;\n+    @JsonProperty(\"case_id\")\n+    private String caseDataId;\n \n     @JsonProperty(\"user_id\")\n     private String userId;\n \n     @JsonProperty(\"case_role\")\n     private String caseRole;\n-\n-    public Long getCaseDataId() {\n-        return caseDataId;\n-    }\n-\n-    public String getUserId() {\n-        return userId;\n-    }\n-\n-    public String getCaseRole() {\n-        return caseRole;\n-    }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc0NTM2MA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r435745360", "bodyText": "We wouldn't use a new media type for the initial version of this operation.", "author": "MSancaktutar", "createdAt": "2020-06-05T07:43:23Z", "path": "src/main/java/uk/gov/hmcts/ccd/v2/V2.java", "diffHunk": "@@ -43,6 +43,8 @@ private MediaType() {}\n \n         public static final String CASE_EVENTS = \"application/vnd.uk.gov.hmcts.ccd-data-store-api.case-events.v2+json;charset=UTF-8\";\n \n+        public static final String CASE_USER_ROLES = \"application/vnd.uk.gov.hmcts.ccd-data-store-api.case-user-roles.v2+json;charset=UTF-8\";", "originalCommit": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTgzOTg3Ng==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r435839876", "bodyText": "Not using any media type for now!!!", "author": "kiran-yenigala-hmcts", "createdAt": "2020-06-05T10:42:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc0NTM2MA=="}], "type": "inlineReview", "revised_code": {"commit": "50d834a4e85b24b88b69b5d70c5e949ddb87ac46", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/v2/V2.java b/src/main/java/uk/gov/hmcts/ccd/v2/V2.java\nindex 3d830ff1c..14fd61d14 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/v2/V2.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/v2/V2.java\n\n@@ -43,8 +43,6 @@ public final class V2 {\n \n         public static final String CASE_EVENTS = \"application/vnd.uk.gov.hmcts.ccd-data-store-api.case-events.v2+json;charset=UTF-8\";\n \n-        public static final String CASE_USER_ROLES = \"application/vnd.uk.gov.hmcts.ccd-data-store-api.case-user-roles.v2+json;charset=UTF-8\";\n-\n     }\n \n     public final class Error {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc0NzQ2OA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r435747468", "bodyText": "This could have been done by Spring automatatically. Just use type List", "author": "MSancaktutar", "createdAt": "2020-06-05T07:47:41Z", "path": "src/main/java/uk/gov/hmcts/ccd/v2/external/controller/CaseAssignedUserRolesController.java", "diffHunk": "@@ -0,0 +1,107 @@\n+package uk.gov.hmcts.ccd.v2.external.controller;\n+\n+import io.swagger.annotations.ApiOperation;\n+import io.swagger.annotations.ApiResponse;\n+import io.swagger.annotations.ApiResponses;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import org.apache.commons.lang3.StringUtils;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.RequestMapping;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.bind.annotation.RestController;\n+import uk.gov.hmcts.ccd.domain.model.std.CaseAssignedUserRole;\n+import uk.gov.hmcts.ccd.domain.service.cauroles.CaseAssignedUserRolesOperation;\n+import uk.gov.hmcts.ccd.domain.service.common.UIDService;\n+import uk.gov.hmcts.ccd.endpoint.exceptions.BadRequestException;\n+import uk.gov.hmcts.ccd.v2.V2;\n+import uk.gov.hmcts.ccd.v2.external.resource.CaseAssignedUserRolesResource;\n+\n+@RestController\n+@RequestMapping(path = \"/\")\n+public class CaseAssignedUserRolesController {\n+\n+    private final UIDService caseReferenceService;\n+    private final CaseAssignedUserRolesOperation caseAssignedUserRolesOperation;\n+\n+    @Autowired\n+    public CaseAssignedUserRolesController(UIDService caseReferenceService,\n+                                           @Qualifier(\"authorised\") CaseAssignedUserRolesOperation caseAssignedUserRolesOperation) {\n+        this.caseReferenceService = caseReferenceService;\n+        this.caseAssignedUserRolesOperation = caseAssignedUserRolesOperation;\n+    }\n+\n+    @GetMapping(\n+        path = \"/case-users\",\n+        produces = {\n+            V2.MediaType.CASE_USER_ROLES\n+        }\n+    )\n+    @ApiOperation(\n+        value = \"Retrieve Case user roles by Case ID and User ID\"\n+    )\n+    @ApiResponses({\n+        @ApiResponse(\n+            code = 200,\n+            message = \"Case-User-Role assignments returned successfully\",\n+            response = CaseAssignedUserRolesResource.class\n+        ),\n+        @ApiResponse(\n+            code = 400,\n+            message = V2.Error.CASE_ID_INVALID\n+        ),\n+        @ApiResponse(\n+            code = 400,\n+            message = V2.Error.EMPTY_CASE_ID_LIST\n+        ),\n+        @ApiResponse(\n+            code = 400,\n+            message = V2.Error.USER_ID_INVALID\n+        ),\n+        @ApiResponse(\n+            code = 403,\n+            message = V2.Error.OTHER_USER_CASE_ROLE_ACCESS_NOT_GRANTED\n+        )\n+    })\n+    // TODO: 01/06/2020  add LogAudit\n+    public ResponseEntity<CaseAssignedUserRolesResource> getCaseUserRoles(@RequestParam(\"case_ids\") String caseIds,\n+                                                                          @RequestParam(value = \"user_ids\", required = false) String userIds) {\n+        List<String> listUserIds = convertToList(userIds);\n+        List<String> listCaseIds = convertToList(caseIds);", "originalCommit": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg0MDA4NA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r435840084", "bodyText": "done!!!!", "author": "kiran-yenigala-hmcts", "createdAt": "2020-06-05T10:42:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc0NzQ2OA=="}], "type": "inlineReview", "revised_code": {"commit": "50d834a4e85b24b88b69b5d70c5e949ddb87ac46", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/v2/external/controller/CaseAssignedUserRolesController.java b/src/main/java/uk/gov/hmcts/ccd/v2/external/controller/CaseAssignedUserRolesController.java\nindex 2cabfd8af..58864242c 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/v2/external/controller/CaseAssignedUserRolesController.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/v2/external/controller/CaseAssignedUserRolesController.java\n\n@@ -4,8 +4,6 @@ import io.swagger.annotations.ApiOperation;\n import io.swagger.annotations.ApiResponse;\n import io.swagger.annotations.ApiResponses;\n import java.util.ArrayList;\n-import java.util.Arrays;\n-import java.util.Collections;\n import java.util.List;\n import java.util.stream.Collectors;\n import org.apache.commons.lang3.StringUtils;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc0ODk3OQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r435748979", "bodyText": "This throws an Exception upon the first issue it encounters. However, all validation issues should be reported at once.", "author": "MSancaktutar", "createdAt": "2020-06-05T07:50:12Z", "path": "src/main/java/uk/gov/hmcts/ccd/v2/external/controller/CaseAssignedUserRolesController.java", "diffHunk": "@@ -0,0 +1,107 @@\n+package uk.gov.hmcts.ccd.v2.external.controller;\n+\n+import io.swagger.annotations.ApiOperation;\n+import io.swagger.annotations.ApiResponse;\n+import io.swagger.annotations.ApiResponses;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import org.apache.commons.lang3.StringUtils;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.RequestMapping;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.bind.annotation.RestController;\n+import uk.gov.hmcts.ccd.domain.model.std.CaseAssignedUserRole;\n+import uk.gov.hmcts.ccd.domain.service.cauroles.CaseAssignedUserRolesOperation;\n+import uk.gov.hmcts.ccd.domain.service.common.UIDService;\n+import uk.gov.hmcts.ccd.endpoint.exceptions.BadRequestException;\n+import uk.gov.hmcts.ccd.v2.V2;\n+import uk.gov.hmcts.ccd.v2.external.resource.CaseAssignedUserRolesResource;\n+\n+@RestController\n+@RequestMapping(path = \"/\")\n+public class CaseAssignedUserRolesController {\n+\n+    private final UIDService caseReferenceService;\n+    private final CaseAssignedUserRolesOperation caseAssignedUserRolesOperation;\n+\n+    @Autowired\n+    public CaseAssignedUserRolesController(UIDService caseReferenceService,\n+                                           @Qualifier(\"authorised\") CaseAssignedUserRolesOperation caseAssignedUserRolesOperation) {\n+        this.caseReferenceService = caseReferenceService;\n+        this.caseAssignedUserRolesOperation = caseAssignedUserRolesOperation;\n+    }\n+\n+    @GetMapping(\n+        path = \"/case-users\",\n+        produces = {\n+            V2.MediaType.CASE_USER_ROLES\n+        }\n+    )\n+    @ApiOperation(\n+        value = \"Retrieve Case user roles by Case ID and User ID\"\n+    )\n+    @ApiResponses({\n+        @ApiResponse(\n+            code = 200,\n+            message = \"Case-User-Role assignments returned successfully\",\n+            response = CaseAssignedUserRolesResource.class\n+        ),\n+        @ApiResponse(\n+            code = 400,\n+            message = V2.Error.CASE_ID_INVALID\n+        ),\n+        @ApiResponse(\n+            code = 400,\n+            message = V2.Error.EMPTY_CASE_ID_LIST\n+        ),\n+        @ApiResponse(\n+            code = 400,\n+            message = V2.Error.USER_ID_INVALID\n+        ),\n+        @ApiResponse(\n+            code = 403,\n+            message = V2.Error.OTHER_USER_CASE_ROLE_ACCESS_NOT_GRANTED\n+        )\n+    })\n+    // TODO: 01/06/2020  add LogAudit\n+    public ResponseEntity<CaseAssignedUserRolesResource> getCaseUserRoles(@RequestParam(\"case_ids\") String caseIds,\n+                                                                          @RequestParam(value = \"user_ids\", required = false) String userIds) {\n+        List<String> listUserIds = convertToList(userIds);\n+        List<String> listCaseIds = convertToList(caseIds);\n+        validateRequestParams(listCaseIds, listUserIds);\n+\n+        List<CaseAssignedUserRole> caseAssignedUserRoles = this.caseAssignedUserRolesOperation.findCaseUserRoles(listCaseIds\n+            .stream()\n+            .map(caseId -> Long.valueOf(caseId))\n+            .collect(Collectors.toCollection(ArrayList::new)), listUserIds);\n+        return ResponseEntity.ok(new CaseAssignedUserRolesResource(caseIds, userIds, caseAssignedUserRoles));\n+    }\n+\n+    private List<String> convertToList(String ids) {\n+        return ids == null ? Collections.EMPTY_LIST : Arrays.asList(ids.split(\",\"));\n+    }\n+\n+    private void validateRequestParams(List<String> caseIds, List<String> userIds) {\n+        if (caseIds.isEmpty()) {\n+            throw new BadRequestException(V2.Error.EMPTY_CASE_ID_LIST);\n+        }\n+\n+        caseIds.forEach(caseId -> {\n+            if (!caseReferenceService.validateUID(caseId)) {\n+                throw new BadRequestException(V2.Error.CASE_ID_INVALID);\n+            }\n+        });\n+\n+        userIds.forEach(userId -> {\n+            if (StringUtils.isAllBlank(userId)) {\n+                throw new BadRequestException(V2.Error.USER_ID_INVALID);\n+            }\n+        });\n+    }", "originalCommit": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "50d834a4e85b24b88b69b5d70c5e949ddb87ac46", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/v2/external/controller/CaseAssignedUserRolesController.java b/src/main/java/uk/gov/hmcts/ccd/v2/external/controller/CaseAssignedUserRolesController.java\nindex 2cabfd8af..58864242c 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/v2/external/controller/CaseAssignedUserRolesController.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/v2/external/controller/CaseAssignedUserRolesController.java\n\n@@ -4,8 +4,6 @@ import io.swagger.annotations.ApiOperation;\n import io.swagger.annotations.ApiResponse;\n import io.swagger.annotations.ApiResponses;\n import java.util.ArrayList;\n-import java.util.Arrays;\n-import java.util.Collections;\n import java.util.List;\n import java.util.stream.Collectors;\n import org.apache.commons.lang3.StringUtils;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc0OTU4OA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r435749588", "bodyText": "no hateoas links for now, pls.", "author": "MSancaktutar", "createdAt": "2020-06-05T07:51:28Z", "path": "src/main/java/uk/gov/hmcts/ccd/v2/external/resource/CaseAssignedUserRolesResource.java", "diffHunk": "@@ -0,0 +1,28 @@\n+package uk.gov.hmcts.ccd.v2.external.resource;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import java.util.List;\n+import lombok.Data;\n+import lombok.EqualsAndHashCode;\n+import lombok.NoArgsConstructor;\n+import lombok.NonNull;\n+import org.springframework.hateoas.RepresentationModel;\n+import uk.gov.hmcts.ccd.domain.model.std.CaseAssignedUserRole;\n+import uk.gov.hmcts.ccd.v2.external.controller.CaseAssignedUserRolesController;\n+\n+import static org.springframework.hateoas.server.mvc.WebMvcLinkBuilder.linkTo;\n+import static org.springframework.hateoas.server.mvc.WebMvcLinkBuilder.methodOn;\n+\n+@Data\n+@EqualsAndHashCode(callSuper = true)\n+@NoArgsConstructor\n+public class CaseAssignedUserRolesResource extends RepresentationModel {\n+\n+    @JsonProperty(\"case-users\")\n+    private List<CaseAssignedUserRole> caseAssignedUserRoles;\n+\n+    public CaseAssignedUserRolesResource(@NonNull String caseIds, String userIds, List<CaseAssignedUserRole> caseAssignedUserRoles) {\n+        this.caseAssignedUserRoles = caseAssignedUserRoles;\n+        add(linkTo(methodOn(CaseAssignedUserRolesController.class).getCaseUserRoles(caseIds, userIds)).withSelfRel());", "originalCommit": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTgzOTk4MA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r435839980", "bodyText": "removed", "author": "kiran-yenigala-hmcts", "createdAt": "2020-06-05T10:42:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc0OTU4OA=="}], "type": "inlineReview", "revised_code": {"commit": "50d834a4e85b24b88b69b5d70c5e949ddb87ac46", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/v2/external/resource/CaseAssignedUserRolesResource.java b/src/main/java/uk/gov/hmcts/ccd/v2/external/resource/CaseAssignedUserRolesResource.java\nindex 3e37677dc..5a6da2c95 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/v2/external/resource/CaseAssignedUserRolesResource.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/v2/external/resource/CaseAssignedUserRolesResource.java\n\n@@ -5,13 +5,8 @@ import java.util.List;\n import lombok.Data;\n import lombok.EqualsAndHashCode;\n import lombok.NoArgsConstructor;\n-import lombok.NonNull;\n import org.springframework.hateoas.RepresentationModel;\n import uk.gov.hmcts.ccd.domain.model.std.CaseAssignedUserRole;\n-import uk.gov.hmcts.ccd.v2.external.controller.CaseAssignedUserRolesController;\n-\n-import static org.springframework.hateoas.server.mvc.WebMvcLinkBuilder.linkTo;\n-import static org.springframework.hateoas.server.mvc.WebMvcLinkBuilder.methodOn;\n \n @Data\n @EqualsAndHashCode(callSuper = true)\n"}}, {"oid": "50d834a4e85b24b88b69b5d70c5e949ddb87ac46", "url": "https://github.com/hmcts/ccd-data-store-api/commit/50d834a4e85b24b88b69b5d70c5e949ddb87ac46", "message": "RDM-8344: Addressed review comments", "committedDate": "2020-06-05T10:51:46Z", "type": "commit"}, {"oid": "08277234d2515d9588ce47195eb01aa9db4250be", "url": "https://github.com/hmcts/ccd-data-store-api/commit/08277234d2515d9588ce47195eb01aa9db4250be", "message": "RDM-8344: Addressed review comments", "committedDate": "2020-06-05T14:54:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQzNzk4Mw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r437437983", "bodyText": "what is the user's own id is repeated twice?", "author": "MSancaktutar", "createdAt": "2020-06-09T13:52:38Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/cauroles/rolevalidator/DefaultCaseAssignedUserRoleValidator.java", "diffHunk": "@@ -0,0 +1,30 @@\n+package uk.gov.hmcts.ccd.domain.service.cauroles.rolevalidator;\n+\n+import java.util.List;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Service;\n+import uk.gov.hmcts.ccd.data.user.CachedUserRepository;\n+import uk.gov.hmcts.ccd.data.user.UserRepository;\n+\n+@Service\n+@Qualifier(\"default\")\n+public class DefaultCaseAssignedUserRoleValidator implements CaseAssignedUserRoleValidator {\n+\n+    private final String roleCaseWorkerCaa = \"caseworker-caa\";\n+\n+    private UserRepository userRepository;\n+\n+    @Autowired\n+    public DefaultCaseAssignedUserRoleValidator(@Qualifier(CachedUserRepository.QUALIFIER) final UserRepository userRepository) {\n+        this.userRepository = userRepository;\n+    }\n+\n+    public boolean canAccessUserCaseRoles(List<String> userIds) {\n+        boolean canAccess = this.userRepository.getUserRoles().contains(roleCaseWorkerCaa);\n+        if (!canAccess) {\n+            canAccess = userIds.size() == 1 && userIds.contains(this.userRepository.getUserId());", "originalCommit": "08277234d2515d9588ce47195eb01aa9db4250be", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ed83599fc8dfae3493f48c0794f19da45f2fbc18", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/domain/service/cauroles/rolevalidator/DefaultCaseAssignedUserRoleValidator.java b/src/main/java/uk/gov/hmcts/ccd/domain/service/cauroles/rolevalidator/DefaultCaseAssignedUserRoleValidator.java\nindex 829c82b2c..f4fea8cde 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/domain/service/cauroles/rolevalidator/DefaultCaseAssignedUserRoleValidator.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/domain/service/cauroles/rolevalidator/DefaultCaseAssignedUserRoleValidator.java\n\n@@ -1,6 +1,7 @@\n package uk.gov.hmcts.ccd.domain.service.cauroles.rolevalidator;\n \n import java.util.List;\n+import java.util.stream.Collectors;\n import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.beans.factory.annotation.Qualifier;\n import org.springframework.stereotype.Service;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQzOTY5MA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r437439690", "bodyText": "This should be Get Case-Assigned Users and Roles. That is the operation's well-known name in all other references.", "author": "MSancaktutar", "createdAt": "2020-06-09T13:54:07Z", "path": "src/main/java/uk/gov/hmcts/ccd/v2/external/controller/CaseAssignedUserRolesController.java", "diffHunk": "@@ -0,0 +1,104 @@\n+package uk.gov.hmcts.ccd.v2.external.controller;\n+\n+import com.google.common.collect.Lists;\n+import io.swagger.annotations.ApiOperation;\n+import io.swagger.annotations.ApiResponse;\n+import io.swagger.annotations.ApiResponses;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+import org.apache.commons.lang3.StringUtils;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.RequestMapping;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.bind.annotation.RestController;\n+import uk.gov.hmcts.ccd.domain.model.std.CaseAssignedUserRole;\n+import uk.gov.hmcts.ccd.domain.service.cauroles.CaseAssignedUserRolesOperation;\n+import uk.gov.hmcts.ccd.domain.service.common.UIDService;\n+import uk.gov.hmcts.ccd.endpoint.exceptions.BadRequestException;\n+import uk.gov.hmcts.ccd.v2.V2;\n+import uk.gov.hmcts.ccd.v2.external.resource.CaseAssignedUserRolesResource;\n+\n+@RestController\n+@RequestMapping(path = \"/\")\n+public class CaseAssignedUserRolesController {\n+\n+    private final UIDService caseReferenceService;\n+    private final CaseAssignedUserRolesOperation caseAssignedUserRolesOperation;\n+\n+    @Autowired\n+    public CaseAssignedUserRolesController(UIDService caseReferenceService,\n+                                           @Qualifier(\"authorised\") CaseAssignedUserRolesOperation caseAssignedUserRolesOperation) {\n+        this.caseReferenceService = caseReferenceService;\n+        this.caseAssignedUserRolesOperation = caseAssignedUserRolesOperation;\n+    }\n+\n+    @GetMapping(\n+        path = \"/case-users\"\n+    )\n+    @ApiOperation(\n+        value = \"Retrieve Case user roles by Case ID and User ID\"", "originalCommit": "08277234d2515d9588ce47195eb01aa9db4250be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ0NTg1OQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r437445859", "bodyText": "Changed this", "author": "kiran-yenigala-hmcts", "createdAt": "2020-06-09T14:00:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQzOTY5MA=="}], "type": "inlineReview", "revised_code": {"commit": "ed83599fc8dfae3493f48c0794f19da45f2fbc18", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/v2/external/controller/CaseAssignedUserRolesController.java b/src/main/java/uk/gov/hmcts/ccd/v2/external/controller/CaseAssignedUserRolesController.java\nindex 744c090a6..294c325a5 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/v2/external/controller/CaseAssignedUserRolesController.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/v2/external/controller/CaseAssignedUserRolesController.java\n\n@@ -41,7 +41,7 @@ public class CaseAssignedUserRolesController {\n         path = \"/case-users\"\n     )\n     @ApiOperation(\n-        value = \"Retrieve Case user roles by Case ID and User ID\"\n+        value = \"Get Case-Assigned Users and Roles\"\n     )\n     @ApiResponses({\n         @ApiResponse(\n"}}, {"oid": "ed83599fc8dfae3493f48c0794f19da45f2fbc18", "url": "https://github.com/hmcts/ccd-data-store-api/commit/ed83599fc8dfae3493f48c0794f19da45f2fbc18", "message": "RDM-8344: Addressed review Comments", "committedDate": "2020-06-09T14:09:50Z", "type": "commit"}, {"oid": "d9f68a1f5df8b03e5c93b58aaf2a0785aa5432a6", "url": "https://github.com/hmcts/ccd-data-store-api/commit/d9f68a1f5df8b03e5c93b58aaf2a0785aa5432a6", "message": "RDM-8344: Added test cases for the new code added after review comments", "committedDate": "2020-06-09T14:12:25Z", "type": "commit"}, {"oid": "290d0514a6caed98f05e6e38531599be1e561131", "url": "https://github.com/hmcts/ccd-data-store-api/commit/290d0514a6caed98f05e6e38531599be1e561131", "message": "RDM-8344: Fixed issue with access to case_users table", "committedDate": "2020-06-12T12:37:56Z", "type": "commit"}, {"oid": "f44945b3ad750e430187bc0f3b6b77fd64266c92", "url": "https://github.com/hmcts/ccd-data-store-api/commit/f44945b3ad750e430187bc0f3b6b77fd64266c92", "message": "RDM-8344: Fixed issue with access to case_users table", "committedDate": "2020-06-12T12:48:36Z", "type": "commit"}, {"oid": "14a9617c06637224c6cfe46cc658a731809315b7", "url": "https://github.com/hmcts/ccd-data-store-api/commit/14a9617c06637224c6cfe46cc658a731809315b7", "message": "RDM-8344: Fixed issue with access to case_users table", "committedDate": "2020-06-12T13:04:22Z", "type": "commit"}, {"oid": "68c9e06ebec56b0e33c149d787859edd7c80f169", "url": "https://github.com/hmcts/ccd-data-store-api/commit/68c9e06ebec56b0e33c149d787859edd7c80f169", "message": "RDM-8344: Fixed issue with access to case_users table and check style issues", "committedDate": "2020-06-12T14:26:24Z", "type": "commit"}, {"oid": "caddbc8d8358432da7fb1ac6a239926b110def0c", "url": "https://github.com/hmcts/ccd-data-store-api/commit/caddbc8d8358432da7fb1ac6a239926b110def0c", "message": "RDM-8344: fix CVE-2020-13692", "committedDate": "2020-06-12T14:57:30Z", "type": "commit"}, {"oid": "145a855070aa1e41bd3a5806aad5d8ac45c792c7", "url": "https://github.com/hmcts/ccd-data-store-api/commit/145a855070aa1e41bd3a5806aad5d8ac45c792c7", "message": "RDM-8344: fix CVE-2017-18365", "committedDate": "2020-06-12T15:12:08Z", "type": "commit"}, {"oid": "ca9cc83cb8a06e535d4c1a4e4d76f551d9eb3240", "url": "https://github.com/hmcts/ccd-data-store-api/commit/ca9cc83cb8a06e535d4c1a4e4d76f551d9eb3240", "message": "Suppress CVE-2017-18365", "committedDate": "2020-06-12T15:22:10Z", "type": "commit"}, {"oid": "f0ce36bc77dde18dab94e427de0917c4d02f64d9", "url": "https://github.com/hmcts/ccd-data-store-api/commit/f0ce36bc77dde18dab94e427de0917c4d02f64d9", "message": "Merge branch 'develop' into RDM-8344", "committedDate": "2020-06-12T15:28:09Z", "type": "commit"}, {"oid": "18b9fe025e02841f27469b2f9a35f1804dd2d111", "url": "https://github.com/hmcts/ccd-data-store-api/commit/18b9fe025e02841f27469b2f9a35f1804dd2d111", "message": "Fixed failure tests", "committedDate": "2020-06-12T15:56:21Z", "type": "commit"}, {"oid": "a41f1871ad576cff54f30864a3202f702f9897c3", "url": "https://github.com/hmcts/ccd-data-store-api/commit/a41f1871ad576cff54f30864a3202f702f9897c3", "message": "Merge remote-tracking branch 'origin/RDM-8344' into RDM-8344", "committedDate": "2020-06-12T15:56:32Z", "type": "commit"}, {"oid": "5faa100257d8ea5c0d7b8c2b42ecb5a14d3f7947", "url": "https://github.com/hmcts/ccd-data-store-api/commit/5faa100257d8ea5c0d7b8c2b42ecb5a14d3f7947", "message": "fix failure tests", "committedDate": "2020-06-12T16:12:09Z", "type": "commit"}]}