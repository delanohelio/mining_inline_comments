{"pr_number": 990, "pr_title": "RDM-8782 Authorisation on fields", "pr_createdAt": "2020-06-23T11:54:18Z", "pr_url": "https://github.com/hmcts/ccd-data-store-api/pull/990", "timeline": [{"oid": "9ec327960ed400946f5a3cf82c51bda59a426c30", "url": "https://github.com/hmcts/ccd-data-store-api/commit/9ec327960ed400946f5a3cf82c51bda59a426c30", "message": "RDM-8782 Initial commit for filtering by authorisation", "committedDate": "2020-06-19T08:52:45Z", "type": "commit"}, {"oid": "79ff8032dfdae64ef0816aca6552ed69c2aac7bc", "url": "https://github.com/hmcts/ccd-data-store-api/commit/79ff8032dfdae64ef0816aca6552ed69c2aac7bc", "message": "RDM-8782 updated logic and added test scenarios to be modified in the future", "committedDate": "2020-06-22T11:02:19Z", "type": "commit"}, {"oid": "99b726dca3d19afcff3cff62c3de79a73066838f", "url": "https://github.com/hmcts/ccd-data-store-api/commit/99b726dca3d19afcff3cff62c3de79a73066838f", "message": "Merge branch 'RDM-8325' into RDM-8782\n\n# Conflicts:\n#\tsrc/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\n#\tsrc/test/java/uk/gov/hmcts/ccd/domain/service/aggregated/CaseSearchResultViewGeneratorTest.java", "committedDate": "2020-06-22T11:06:22Z", "type": "commit"}, {"oid": "d777df0cf3a97d5dd4bb38d3ae09940daf5e0f24", "url": "https://github.com/hmcts/ccd-data-store-api/commit/d777df0cf3a97d5dd4bb38d3ae09940daf5e0f24", "message": "RDM-8782 added integration tests", "committedDate": "2020-06-23T11:52:52Z", "type": "commit"}, {"oid": "8756a2275746d70d6354b47cbc5a7bec0478b983", "url": "https://github.com/hmcts/ccd-data-store-api/commit/8756a2275746d70d6354b47cbc5a7bec0478b983", "message": "RDM-8782 fixed unit tests and logic", "committedDate": "2020-06-23T12:07:28Z", "type": "commit"}, {"oid": "f0069446eb4fe9ebad1c4f66bd407d84975e09fd", "url": "https://github.com/hmcts/ccd-data-store-api/commit/f0069446eb4fe9ebad1c4f66bd407d84975e09fd", "message": "RDM-8782 fixed checkstyle", "committedDate": "2020-06-23T12:09:23Z", "type": "commit"}, {"oid": "ddaad7d576a18aff3af06deb4d74c9a246e8db7d", "url": "https://github.com/hmcts/ccd-data-store-api/commit/ddaad7d576a18aff3af06deb4d74c9a246e8db7d", "message": "RDM-8782 fixed checkstyle", "committedDate": "2020-06-23T12:19:30Z", "type": "commit"}, {"oid": "6dc761da3f5effd87b036510d2cff55713bc460c", "url": "https://github.com/hmcts/ccd-data-store-api/commit/6dc761da3f5effd87b036510d2cff55713bc460c", "message": "RDM-8782 disabled two tests", "committedDate": "2020-06-23T13:08:50Z", "type": "commit"}, {"oid": "6123d9ef931cb34cddf15d94e792add328489083", "url": "https://github.com/hmcts/ccd-data-store-api/commit/6123d9ef931cb34cddf15d94e792add328489083", "message": "RDM-8782 fixed test", "committedDate": "2020-06-23T13:22:13Z", "type": "commit"}, {"oid": "4265aa09731463568f85d01e2f5db4fa3020480f", "url": "https://github.com/hmcts/ccd-data-store-api/commit/4265aa09731463568f85d01e2f5db4fa3020480f", "message": "RDM-8782 fixed tests", "committedDate": "2020-06-23T13:55:46Z", "type": "commit"}, {"oid": "0c0414647b894b128cc7f1d7d7b6b38f8d152daa", "url": "https://github.com/hmcts/ccd-data-store-api/commit/0c0414647b894b128cc7f1d7d7b6b38f8d152daa", "message": "RDM-8782 fixed integration tests and refactored unit tests", "committedDate": "2020-06-23T22:04:27Z", "type": "commit"}, {"oid": "1a58b78aab0ae8240ed2484adcdb4252bf9b45b8", "url": "https://github.com/hmcts/ccd-data-store-api/commit/1a58b78aab0ae8240ed2484adcdb4252bf9b45b8", "message": "RDM-8782 fixed checkstyle", "committedDate": "2020-06-23T22:11:25Z", "type": "commit"}, {"oid": "b4c56471921e44f95adaf2b101f179c1b5f4eed9", "url": "https://github.com/hmcts/ccd-data-store-api/commit/b4c56471921e44f95adaf2b101f179c1b5f4eed9", "message": "RDM-8782 fixed checkstyle", "committedDate": "2020-06-24T06:37:43Z", "type": "commit"}, {"oid": "aba7e9f7e57c442e7e1353cef0380647c4509792", "url": "https://github.com/hmcts/ccd-data-store-api/commit/aba7e9f7e57c442e7e1353cef0380647c4509792", "message": "RDM-8782 fixed remaining tests and updated logic", "committedDate": "2020-06-24T07:46:05Z", "type": "commit"}, {"oid": "02fd8e76d54c498c018da8f109d2ea96cd565780", "url": "https://github.com/hmcts/ccd-data-store-api/commit/02fd8e76d54c498c018da8f109d2ea96cd565780", "message": "RDM-8782 fixed remaining tests and updated logic", "committedDate": "2020-06-24T08:08:38Z", "type": "commit"}, {"oid": "ba5c0368ca73de7ca7ec77bd1f8b63998e7f3da2", "url": "https://github.com/hmcts/ccd-data-store-api/commit/ba5c0368ca73de7ca7ec77bd1f8b63998e7f3da2", "message": "RDM-8782 fixed sonar issue", "committedDate": "2020-06-24T08:31:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDgwMjM4NA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/990#discussion_r444802384", "bodyText": "This method is a bit complex (Sonar also mentions this) - adding some comments in the method itself with suggestions.", "author": "danlysiak", "createdAt": "2020-06-24T10:36:33Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java", "diffHunk": "@@ -70,16 +75,86 @@ private boolean itemsRequireFormatting(List<SearchResultViewHeaderGroup> headerG\n \n         List<SearchResultViewItem> items = new ArrayList<>();\n         // Only one case type is currently supported so we can reuse the same definitions for building all items\n-        caseSearchResult.getCases().forEach(caseDetails ->\n-            items.add(buildSearchResultViewItem(caseDetails, caseTypeDefinition, searchResultDefinition)));\n-\n+        caseSearchResult.getCases().forEach(caseDetails -> {\n+            filterResultsByAuthorisationAndUserRole(useCase, caseDetails, caseTypeId, requestedFields);\n+            items.add(buildSearchResultViewItem(caseDetails, caseTypeDefinition, searchResultDefinition));\n+        });\n         return items;\n     }\n \n-    private List<SearchResultViewHeaderGroup> buildHeaders(String caseTypeId,\n-                                                           String useCase,\n-                                                           CaseSearchResult caseSearchResult,\n-                                                           List<String> requestedFields) {\n+    private CaseDetails filterResultsByAuthorisationAndUserRole(String useCase, CaseDetails caseDetails, String caseTypeId, List<String> requestedFields) {", "originalCommit": "ba5c0368ca73de7ca7ec77bd1f8b63998e7f3da2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5a49140aba2035d10a6bc4479c021e702d79aa3c", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java b/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\nindex 22e4c9eba..e56dde194 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\n\n@@ -144,6 +147,14 @@ public class CaseSearchResultViewGenerator {\n         return false;\n     }\n \n+    private Boolean filterResultsBySecurityClassification(CaseFieldDefinition caseFieldDefinition,\n+                                                          CaseTypeDefinition caseTypeDefinition) {\n+        return securityClassificationService.userHasEnoughSecurityClassificationForField(caseTypeDefinition.getJurisdictionId(),\n+            caseTypeDefinition,\n+            caseFieldDefinition.getId());\n+\n+    }\n+\n     private HashMap<String, String> getSearchResultDefinitionFieldUserRoleAndField(SearchResult searchResultDefinition) {\n         HashMap<String, String> fields = new HashMap<>();\n         for (SearchResultField srf : searchResultDefinition.getFields()) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDgwNTEwNw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/990#discussion_r444805107", "bodyText": "This could be simplified by replacing the while loop with a Stream e.g.\ncaseDetails.getData().entrySet().stream()\n    .filter(entry -> newMethodThatDealsWithThisCodeBlock(....))\n    ...", "author": "danlysiak", "createdAt": "2020-06-24T10:42:19Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java", "diffHunk": "@@ -70,16 +75,86 @@ private boolean itemsRequireFormatting(List<SearchResultViewHeaderGroup> headerG\n \n         List<SearchResultViewItem> items = new ArrayList<>();\n         // Only one case type is currently supported so we can reuse the same definitions for building all items\n-        caseSearchResult.getCases().forEach(caseDetails ->\n-            items.add(buildSearchResultViewItem(caseDetails, caseTypeDefinition, searchResultDefinition)));\n-\n+        caseSearchResult.getCases().forEach(caseDetails -> {\n+            filterResultsByAuthorisationAndUserRole(useCase, caseDetails, caseTypeId, requestedFields);\n+            items.add(buildSearchResultViewItem(caseDetails, caseTypeDefinition, searchResultDefinition));\n+        });\n         return items;\n     }\n \n-    private List<SearchResultViewHeaderGroup> buildHeaders(String caseTypeId,\n-                                                           String useCase,\n-                                                           CaseSearchResult caseSearchResult,\n-                                                           List<String> requestedFields) {\n+    private CaseDetails filterResultsByAuthorisationAndUserRole(String useCase, CaseDetails caseDetails, String caseTypeId, List<String> requestedFields) {\n+        Set<String> roles = userRepository.getUserRoles();\n+        CaseTypeDefinition caseTypeDefinition = getCaseTypeDefinition(caseTypeId);\n+        SearchResult searchResultDefinition = searchResultDefinitionService.getSearchResultDefinition(caseTypeDefinition, useCase, requestedFields);\n+        HashMap<String, String> searchFields = getSearchResultDefinitionFieldUserRoleAndField(searchResultDefinition);\n+\n+        Iterator<String> caseFieldsUseCase = caseDetails.getData().keySet().iterator();\n+        while (caseFieldsUseCase.hasNext()) {\n+            Object caseField = caseFieldsUseCase.next();\n+            if (useCase != null) {\n+                if (!searchFields.containsKey(caseField)) {\n+                    caseFieldsUseCase.remove();\n+                    caseField = null;\n+                }\n+                String role = searchFields.get(caseField);\n+                if (role != null && !roles.contains(role)) {\n+                    caseFieldsUseCase.remove();\n+                    caseField = null;\n+\n+                }\n+            }", "originalCommit": "ba5c0368ca73de7ca7ec77bd1f8b63998e7f3da2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5a49140aba2035d10a6bc4479c021e702d79aa3c", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java b/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\nindex 22e4c9eba..e56dde194 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\n\n@@ -144,6 +147,14 @@ public class CaseSearchResultViewGenerator {\n         return false;\n     }\n \n+    private Boolean filterResultsBySecurityClassification(CaseFieldDefinition caseFieldDefinition,\n+                                                          CaseTypeDefinition caseTypeDefinition) {\n+        return securityClassificationService.userHasEnoughSecurityClassificationForField(caseTypeDefinition.getJurisdictionId(),\n+            caseTypeDefinition,\n+            caseFieldDefinition.getId());\n+\n+    }\n+\n     private HashMap<String, String> getSearchResultDefinitionFieldUserRoleAndField(SearchResult searchResultDefinition) {\n         HashMap<String, String> fields = new HashMap<>();\n         for (SearchResultField srf : searchResultDefinition.getFields()) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDgwNTIzNA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/990#discussion_r444805234", "bodyText": "This could be a second .filter()", "author": "danlysiak", "createdAt": "2020-06-24T10:42:36Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java", "diffHunk": "@@ -70,16 +75,86 @@ private boolean itemsRequireFormatting(List<SearchResultViewHeaderGroup> headerG\n \n         List<SearchResultViewItem> items = new ArrayList<>();\n         // Only one case type is currently supported so we can reuse the same definitions for building all items\n-        caseSearchResult.getCases().forEach(caseDetails ->\n-            items.add(buildSearchResultViewItem(caseDetails, caseTypeDefinition, searchResultDefinition)));\n-\n+        caseSearchResult.getCases().forEach(caseDetails -> {\n+            filterResultsByAuthorisationAndUserRole(useCase, caseDetails, caseTypeId, requestedFields);\n+            items.add(buildSearchResultViewItem(caseDetails, caseTypeDefinition, searchResultDefinition));\n+        });\n         return items;\n     }\n \n-    private List<SearchResultViewHeaderGroup> buildHeaders(String caseTypeId,\n-                                                           String useCase,\n-                                                           CaseSearchResult caseSearchResult,\n-                                                           List<String> requestedFields) {\n+    private CaseDetails filterResultsByAuthorisationAndUserRole(String useCase, CaseDetails caseDetails, String caseTypeId, List<String> requestedFields) {\n+        Set<String> roles = userRepository.getUserRoles();\n+        CaseTypeDefinition caseTypeDefinition = getCaseTypeDefinition(caseTypeId);\n+        SearchResult searchResultDefinition = searchResultDefinitionService.getSearchResultDefinition(caseTypeDefinition, useCase, requestedFields);\n+        HashMap<String, String> searchFields = getSearchResultDefinitionFieldUserRoleAndField(searchResultDefinition);\n+\n+        Iterator<String> caseFieldsUseCase = caseDetails.getData().keySet().iterator();\n+        while (caseFieldsUseCase.hasNext()) {\n+            Object caseField = caseFieldsUseCase.next();\n+            if (useCase != null) {\n+                if (!searchFields.containsKey(caseField)) {\n+                    caseFieldsUseCase.remove();\n+                    caseField = null;\n+                }\n+                String role = searchFields.get(caseField);\n+                if (role != null && !roles.contains(role)) {\n+                    caseFieldsUseCase.remove();\n+                    caseField = null;\n+\n+                }\n+            }\n+            if (caseField != null) {\n+                Optional<CaseFieldDefinition> caseFieldDefinition = caseTypeDefinition.getCaseField(caseField.toString());\n+                if (caseFieldDefinition.isPresent() && caseFieldDefinition.get().isComplexFieldType()) {\n+                    if (!filterResultsByAuthorisationAccess(caseFieldDefinition)) {\n+                        caseFieldsUseCase.remove();\n+                    }\n+                } else {\n+                    if (!accessControlService.canAccessCaseFieldsWithCriteria(\n+                        JacksonUtils.convertValueJsonNode(caseField),\n+                        caseTypeDefinition.getCaseFieldDefinitions(),\n+                        roles,\n+                        CAN_READ)) {\n+                        caseFieldsUseCase.remove();\n+                    }\n+                }\n+\n+            }", "originalCommit": "ba5c0368ca73de7ca7ec77bd1f8b63998e7f3da2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5a49140aba2035d10a6bc4479c021e702d79aa3c", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java b/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\nindex 22e4c9eba..e56dde194 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\n\n@@ -144,6 +147,14 @@ public class CaseSearchResultViewGenerator {\n         return false;\n     }\n \n+    private Boolean filterResultsBySecurityClassification(CaseFieldDefinition caseFieldDefinition,\n+                                                          CaseTypeDefinition caseTypeDefinition) {\n+        return securityClassificationService.userHasEnoughSecurityClassificationForField(caseTypeDefinition.getJurisdictionId(),\n+            caseTypeDefinition,\n+            caseFieldDefinition.getId());\n+\n+    }\n+\n     private HashMap<String, String> getSearchResultDefinitionFieldUserRoleAndField(SearchResult searchResultDefinition) {\n         HashMap<String, String> fields = new HashMap<>();\n         for (SearchResultField srf : searchResultDefinition.getFields()) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDgwNzcxNQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/990#discussion_r444807715", "bodyText": "isPresent() has been checked so we can pass in the value to the method and its argument no longer needs to be Optional (removing one of the Sonar complaints).\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                if (!filterResultsByAuthorisationAccess(caseFieldDefinition)) {\n          \n          \n            \n                                if (!filterResultsByAuthorisationAccess(caseFieldDefinition.get())) {", "author": "danlysiak", "createdAt": "2020-06-24T10:47:55Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java", "diffHunk": "@@ -70,16 +75,86 @@ private boolean itemsRequireFormatting(List<SearchResultViewHeaderGroup> headerG\n \n         List<SearchResultViewItem> items = new ArrayList<>();\n         // Only one case type is currently supported so we can reuse the same definitions for building all items\n-        caseSearchResult.getCases().forEach(caseDetails ->\n-            items.add(buildSearchResultViewItem(caseDetails, caseTypeDefinition, searchResultDefinition)));\n-\n+        caseSearchResult.getCases().forEach(caseDetails -> {\n+            filterResultsByAuthorisationAndUserRole(useCase, caseDetails, caseTypeId, requestedFields);\n+            items.add(buildSearchResultViewItem(caseDetails, caseTypeDefinition, searchResultDefinition));\n+        });\n         return items;\n     }\n \n-    private List<SearchResultViewHeaderGroup> buildHeaders(String caseTypeId,\n-                                                           String useCase,\n-                                                           CaseSearchResult caseSearchResult,\n-                                                           List<String> requestedFields) {\n+    private CaseDetails filterResultsByAuthorisationAndUserRole(String useCase, CaseDetails caseDetails, String caseTypeId, List<String> requestedFields) {\n+        Set<String> roles = userRepository.getUserRoles();\n+        CaseTypeDefinition caseTypeDefinition = getCaseTypeDefinition(caseTypeId);\n+        SearchResult searchResultDefinition = searchResultDefinitionService.getSearchResultDefinition(caseTypeDefinition, useCase, requestedFields);\n+        HashMap<String, String> searchFields = getSearchResultDefinitionFieldUserRoleAndField(searchResultDefinition);\n+\n+        Iterator<String> caseFieldsUseCase = caseDetails.getData().keySet().iterator();\n+        while (caseFieldsUseCase.hasNext()) {\n+            Object caseField = caseFieldsUseCase.next();\n+            if (useCase != null) {\n+                if (!searchFields.containsKey(caseField)) {\n+                    caseFieldsUseCase.remove();\n+                    caseField = null;\n+                }\n+                String role = searchFields.get(caseField);\n+                if (role != null && !roles.contains(role)) {\n+                    caseFieldsUseCase.remove();\n+                    caseField = null;\n+\n+                }\n+            }\n+            if (caseField != null) {\n+                Optional<CaseFieldDefinition> caseFieldDefinition = caseTypeDefinition.getCaseField(caseField.toString());\n+                if (caseFieldDefinition.isPresent() && caseFieldDefinition.get().isComplexFieldType()) {\n+                    if (!filterResultsByAuthorisationAccess(caseFieldDefinition)) {", "originalCommit": "ba5c0368ca73de7ca7ec77bd1f8b63998e7f3da2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5a49140aba2035d10a6bc4479c021e702d79aa3c", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java b/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\nindex 22e4c9eba..e56dde194 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\n\n@@ -144,6 +147,14 @@ public class CaseSearchResultViewGenerator {\n         return false;\n     }\n \n+    private Boolean filterResultsBySecurityClassification(CaseFieldDefinition caseFieldDefinition,\n+                                                          CaseTypeDefinition caseTypeDefinition) {\n+        return securityClassificationService.userHasEnoughSecurityClassificationForField(caseTypeDefinition.getJurisdictionId(),\n+            caseTypeDefinition,\n+            caseFieldDefinition.getId());\n+\n+    }\n+\n     private HashMap<String, String> getSearchResultDefinitionFieldUserRoleAndField(SearchResult searchResultDefinition) {\n         HashMap<String, String> fields = new HashMap<>();\n         for (SearchResultField srf : searchResultDefinition.getFields()) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDgwODY1MA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/990#discussion_r444808650", "bodyText": "Does this work for all scenarios? Since caseField is an Object but getCaseField() expects the field ID.", "author": "danlysiak", "createdAt": "2020-06-24T10:49:56Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java", "diffHunk": "@@ -70,16 +75,86 @@ private boolean itemsRequireFormatting(List<SearchResultViewHeaderGroup> headerG\n \n         List<SearchResultViewItem> items = new ArrayList<>();\n         // Only one case type is currently supported so we can reuse the same definitions for building all items\n-        caseSearchResult.getCases().forEach(caseDetails ->\n-            items.add(buildSearchResultViewItem(caseDetails, caseTypeDefinition, searchResultDefinition)));\n-\n+        caseSearchResult.getCases().forEach(caseDetails -> {\n+            filterResultsByAuthorisationAndUserRole(useCase, caseDetails, caseTypeId, requestedFields);\n+            items.add(buildSearchResultViewItem(caseDetails, caseTypeDefinition, searchResultDefinition));\n+        });\n         return items;\n     }\n \n-    private List<SearchResultViewHeaderGroup> buildHeaders(String caseTypeId,\n-                                                           String useCase,\n-                                                           CaseSearchResult caseSearchResult,\n-                                                           List<String> requestedFields) {\n+    private CaseDetails filterResultsByAuthorisationAndUserRole(String useCase, CaseDetails caseDetails, String caseTypeId, List<String> requestedFields) {\n+        Set<String> roles = userRepository.getUserRoles();\n+        CaseTypeDefinition caseTypeDefinition = getCaseTypeDefinition(caseTypeId);\n+        SearchResult searchResultDefinition = searchResultDefinitionService.getSearchResultDefinition(caseTypeDefinition, useCase, requestedFields);\n+        HashMap<String, String> searchFields = getSearchResultDefinitionFieldUserRoleAndField(searchResultDefinition);\n+\n+        Iterator<String> caseFieldsUseCase = caseDetails.getData().keySet().iterator();\n+        while (caseFieldsUseCase.hasNext()) {\n+            Object caseField = caseFieldsUseCase.next();\n+            if (useCase != null) {\n+                if (!searchFields.containsKey(caseField)) {\n+                    caseFieldsUseCase.remove();\n+                    caseField = null;\n+                }\n+                String role = searchFields.get(caseField);\n+                if (role != null && !roles.contains(role)) {\n+                    caseFieldsUseCase.remove();\n+                    caseField = null;\n+\n+                }\n+            }\n+            if (caseField != null) {\n+                Optional<CaseFieldDefinition> caseFieldDefinition = caseTypeDefinition.getCaseField(caseField.toString());", "originalCommit": "ba5c0368ca73de7ca7ec77bd1f8b63998e7f3da2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5a49140aba2035d10a6bc4479c021e702d79aa3c", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java b/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\nindex 22e4c9eba..e56dde194 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\n\n@@ -144,6 +147,14 @@ public class CaseSearchResultViewGenerator {\n         return false;\n     }\n \n+    private Boolean filterResultsBySecurityClassification(CaseFieldDefinition caseFieldDefinition,\n+                                                          CaseTypeDefinition caseTypeDefinition) {\n+        return securityClassificationService.userHasEnoughSecurityClassificationForField(caseTypeDefinition.getJurisdictionId(),\n+            caseTypeDefinition,\n+            caseFieldDefinition.getId());\n+\n+    }\n+\n     private HashMap<String, String> getSearchResultDefinitionFieldUserRoleAndField(SearchResult searchResultDefinition) {\n         HashMap<String, String> fields = new HashMap<>();\n         for (SearchResultField srf : searchResultDefinition.getFields()) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDgxMTc1MQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/990#discussion_r444811751", "bodyText": "Could consider making use of the existing method CaseFieldDefinition.getAccessControlListByRole() in here (would need to be made public, and think then looping through roles could be simpler.", "author": "danlysiak", "createdAt": "2020-06-24T10:56:14Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java", "diffHunk": "@@ -70,16 +75,86 @@ private boolean itemsRequireFormatting(List<SearchResultViewHeaderGroup> headerG\n \n         List<SearchResultViewItem> items = new ArrayList<>();\n         // Only one case type is currently supported so we can reuse the same definitions for building all items\n-        caseSearchResult.getCases().forEach(caseDetails ->\n-            items.add(buildSearchResultViewItem(caseDetails, caseTypeDefinition, searchResultDefinition)));\n-\n+        caseSearchResult.getCases().forEach(caseDetails -> {\n+            filterResultsByAuthorisationAndUserRole(useCase, caseDetails, caseTypeId, requestedFields);\n+            items.add(buildSearchResultViewItem(caseDetails, caseTypeDefinition, searchResultDefinition));\n+        });\n         return items;\n     }\n \n-    private List<SearchResultViewHeaderGroup> buildHeaders(String caseTypeId,\n-                                                           String useCase,\n-                                                           CaseSearchResult caseSearchResult,\n-                                                           List<String> requestedFields) {\n+    private CaseDetails filterResultsByAuthorisationAndUserRole(String useCase, CaseDetails caseDetails, String caseTypeId, List<String> requestedFields) {\n+        Set<String> roles = userRepository.getUserRoles();\n+        CaseTypeDefinition caseTypeDefinition = getCaseTypeDefinition(caseTypeId);\n+        SearchResult searchResultDefinition = searchResultDefinitionService.getSearchResultDefinition(caseTypeDefinition, useCase, requestedFields);\n+        HashMap<String, String> searchFields = getSearchResultDefinitionFieldUserRoleAndField(searchResultDefinition);\n+\n+        Iterator<String> caseFieldsUseCase = caseDetails.getData().keySet().iterator();\n+        while (caseFieldsUseCase.hasNext()) {\n+            Object caseField = caseFieldsUseCase.next();\n+            if (useCase != null) {\n+                if (!searchFields.containsKey(caseField)) {\n+                    caseFieldsUseCase.remove();\n+                    caseField = null;\n+                }\n+                String role = searchFields.get(caseField);\n+                if (role != null && !roles.contains(role)) {\n+                    caseFieldsUseCase.remove();\n+                    caseField = null;\n+\n+                }\n+            }\n+            if (caseField != null) {\n+                Optional<CaseFieldDefinition> caseFieldDefinition = caseTypeDefinition.getCaseField(caseField.toString());\n+                if (caseFieldDefinition.isPresent() && caseFieldDefinition.get().isComplexFieldType()) {\n+                    if (!filterResultsByAuthorisationAccess(caseFieldDefinition)) {\n+                        caseFieldsUseCase.remove();\n+                    }\n+                } else {\n+                    if (!accessControlService.canAccessCaseFieldsWithCriteria(\n+                        JacksonUtils.convertValueJsonNode(caseField),\n+                        caseTypeDefinition.getCaseFieldDefinitions(),\n+                        roles,\n+                        CAN_READ)) {\n+                        caseFieldsUseCase.remove();\n+                    }\n+                }\n+\n+            }\n+\n+        }\n+        return caseDetails;\n+    }\n+\n+    private Boolean filterResultsByAuthorisationAccess(Optional<CaseFieldDefinition> caseFieldDefinition) {", "originalCommit": "ba5c0368ca73de7ca7ec77bd1f8b63998e7f3da2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5a49140aba2035d10a6bc4479c021e702d79aa3c", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java b/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\nindex 22e4c9eba..e56dde194 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\n\n@@ -144,6 +147,14 @@ public class CaseSearchResultViewGenerator {\n         return false;\n     }\n \n+    private Boolean filterResultsBySecurityClassification(CaseFieldDefinition caseFieldDefinition,\n+                                                          CaseTypeDefinition caseTypeDefinition) {\n+        return securityClassificationService.userHasEnoughSecurityClassificationForField(caseTypeDefinition.getJurisdictionId(),\n+            caseTypeDefinition,\n+            caseFieldDefinition.getId());\n+\n+    }\n+\n     private HashMap<String, String> getSearchResultDefinitionFieldUserRoleAndField(SearchResult searchResultDefinition) {\n         HashMap<String, String> fields = new HashMap<>();\n         for (SearchResultField srf : searchResultDefinition.getFields()) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDgxOTU2NQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/990#discussion_r444819565", "bodyText": "Requires testing but I think can be simplified to something like this?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (caseFieldDefinition.isPresent()) {\n          \n          \n            \n                        List<AccessControlList> accessControlLists = caseFieldDefinition.get().getAccessControlLists();\n          \n          \n            \n                        Set<String> roles = userRepository.getUserRoles();\n          \n          \n            \n                        if (!caseFieldDefinition.get().isMetadata()) {\n          \n          \n            \n                            for (AccessControlList accessControlList : accessControlLists) {\n          \n          \n            \n                                for (String role : roles) {\n          \n          \n            \n                                    if (accessControlList.getRole().equals(role)) {\n          \n          \n            \n                                        return accessControlList.isRead();\n          \n          \n            \n                                    }\n          \n          \n            \n                                }\n          \n          \n            \n                            }\n          \n          \n            \n                            return false;\n          \n          \n            \n                        }\n          \n          \n            \n                        return true;\n          \n          \n            \n                    }\n          \n          \n            \n                    return false;\n          \n          \n            \n                    if (!caseFieldDefinition.isMetadata()) {\n          \n          \n            \n                        return userRepository.getUserRoles().stream()\n          \n          \n            \n                            .anyMatch(role -> caseFieldDefinition.getAccessControlListByRole(role).map(AccessControlList::isRead).orElse(false));\n          \n          \n            \n                    }\n          \n          \n            \n                    return true;", "author": "danlysiak", "createdAt": "2020-06-24T11:12:13Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java", "diffHunk": "@@ -70,16 +75,86 @@ private boolean itemsRequireFormatting(List<SearchResultViewHeaderGroup> headerG\n \n         List<SearchResultViewItem> items = new ArrayList<>();\n         // Only one case type is currently supported so we can reuse the same definitions for building all items\n-        caseSearchResult.getCases().forEach(caseDetails ->\n-            items.add(buildSearchResultViewItem(caseDetails, caseTypeDefinition, searchResultDefinition)));\n-\n+        caseSearchResult.getCases().forEach(caseDetails -> {\n+            filterResultsByAuthorisationAndUserRole(useCase, caseDetails, caseTypeId, requestedFields);\n+            items.add(buildSearchResultViewItem(caseDetails, caseTypeDefinition, searchResultDefinition));\n+        });\n         return items;\n     }\n \n-    private List<SearchResultViewHeaderGroup> buildHeaders(String caseTypeId,\n-                                                           String useCase,\n-                                                           CaseSearchResult caseSearchResult,\n-                                                           List<String> requestedFields) {\n+    private CaseDetails filterResultsByAuthorisationAndUserRole(String useCase, CaseDetails caseDetails, String caseTypeId, List<String> requestedFields) {\n+        Set<String> roles = userRepository.getUserRoles();\n+        CaseTypeDefinition caseTypeDefinition = getCaseTypeDefinition(caseTypeId);\n+        SearchResult searchResultDefinition = searchResultDefinitionService.getSearchResultDefinition(caseTypeDefinition, useCase, requestedFields);\n+        HashMap<String, String> searchFields = getSearchResultDefinitionFieldUserRoleAndField(searchResultDefinition);\n+\n+        Iterator<String> caseFieldsUseCase = caseDetails.getData().keySet().iterator();\n+        while (caseFieldsUseCase.hasNext()) {\n+            Object caseField = caseFieldsUseCase.next();\n+            if (useCase != null) {\n+                if (!searchFields.containsKey(caseField)) {\n+                    caseFieldsUseCase.remove();\n+                    caseField = null;\n+                }\n+                String role = searchFields.get(caseField);\n+                if (role != null && !roles.contains(role)) {\n+                    caseFieldsUseCase.remove();\n+                    caseField = null;\n+\n+                }\n+            }\n+            if (caseField != null) {\n+                Optional<CaseFieldDefinition> caseFieldDefinition = caseTypeDefinition.getCaseField(caseField.toString());\n+                if (caseFieldDefinition.isPresent() && caseFieldDefinition.get().isComplexFieldType()) {\n+                    if (!filterResultsByAuthorisationAccess(caseFieldDefinition)) {\n+                        caseFieldsUseCase.remove();\n+                    }\n+                } else {\n+                    if (!accessControlService.canAccessCaseFieldsWithCriteria(\n+                        JacksonUtils.convertValueJsonNode(caseField),\n+                        caseTypeDefinition.getCaseFieldDefinitions(),\n+                        roles,\n+                        CAN_READ)) {\n+                        caseFieldsUseCase.remove();\n+                    }\n+                }\n+\n+            }\n+\n+        }\n+        return caseDetails;\n+    }\n+\n+    private Boolean filterResultsByAuthorisationAccess(Optional<CaseFieldDefinition> caseFieldDefinition) {\n+        if (caseFieldDefinition.isPresent()) {\n+            List<AccessControlList> accessControlLists = caseFieldDefinition.get().getAccessControlLists();\n+            Set<String> roles = userRepository.getUserRoles();\n+            if (!caseFieldDefinition.get().isMetadata()) {\n+                for (AccessControlList accessControlList : accessControlLists) {\n+                    for (String role : roles) {\n+                        if (accessControlList.getRole().equals(role)) {\n+                            return accessControlList.isRead();\n+                        }\n+                    }\n+                }\n+                return false;\n+            }\n+            return true;\n+        }\n+        return false;", "originalCommit": "ba5c0368ca73de7ca7ec77bd1f8b63998e7f3da2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5a49140aba2035d10a6bc4479c021e702d79aa3c", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java b/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\nindex 22e4c9eba..e56dde194 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\n\n@@ -144,6 +147,14 @@ public class CaseSearchResultViewGenerator {\n         return false;\n     }\n \n+    private Boolean filterResultsBySecurityClassification(CaseFieldDefinition caseFieldDefinition,\n+                                                          CaseTypeDefinition caseTypeDefinition) {\n+        return securityClassificationService.userHasEnoughSecurityClassificationForField(caseTypeDefinition.getJurisdictionId(),\n+            caseTypeDefinition,\n+            caseFieldDefinition.getId());\n+\n+    }\n+\n     private HashMap<String, String> getSearchResultDefinitionFieldUserRoleAndField(SearchResult searchResultDefinition) {\n         HashMap<String, String> fields = new HashMap<>();\n         for (SearchResultField srf : searchResultDefinition.getFields()) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDgyMTk5Mw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/990#discussion_r444821993", "bodyText": "Can delete this method by refactoring the earlier one?", "author": "danlysiak", "createdAt": "2020-06-24T11:17:19Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java", "diffHunk": "@@ -112,15 +188,33 @@ private SearchResultViewHeaderGroup buildHeader(String useCase,\n                                                                       SearchResult searchResult) {\n         HashSet<String> addedFields = new HashSet<>();\n \n+        // Only one case type is currently supported so we can reuse the same definitions for building all items\n         return Arrays.stream(searchResult.getFields())\n             .flatMap(searchResultField -> caseTypeDefinition.getCaseFieldDefinitions().stream()\n                 .filter(caseField -> caseField.getId().equals(searchResultField.getCaseFieldId()))\n                 .filter(caseField -> filterDistinctFieldsByRole(addedFields, searchResultField))\n+                .filter(caseField -> filterResultsByAuthorisation(caseField))\n                 .map(caseField -> buildSearchResultViewColumn(searchResultField, caseField))\n             )\n             .collect(Collectors.toList());\n     }\n \n+    private Boolean filterResultsByAuthorisation(CaseFieldDefinition caseFieldDefinition) {", "originalCommit": "ba5c0368ca73de7ca7ec77bd1f8b63998e7f3da2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5a49140aba2035d10a6bc4479c021e702d79aa3c", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java b/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\nindex 22e4c9eba..e56dde194 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\n\n@@ -194,6 +205,7 @@ public class CaseSearchResultViewGenerator {\n                 .filter(caseField -> caseField.getId().equals(searchResultField.getCaseFieldId()))\n                 .filter(caseField -> filterDistinctFieldsByRole(addedFields, searchResultField))\n                 .filter(caseField -> filterResultsByAuthorisation(caseField))\n+                .filter(caseField -> filterResultsBySecurityClassification(caseField, caseTypeDefinition))\n                 .map(caseField -> buildSearchResultViewColumn(searchResultField, caseField))\n             )\n             .collect(Collectors.toList());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDgyMzQzOA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/990#discussion_r444823438", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import org.junit.*;", "author": "danlysiak", "createdAt": "2020-06-24T11:20:25Z", "path": "src/test/java/uk/gov/hmcts/ccd/v2/internal/controller/UICaseSearchControllerIT.java", "diffHunk": "@@ -2,14 +2,15 @@\n \n import com.fasterxml.jackson.databind.DeserializationFeature;\n import com.fasterxml.jackson.databind.JsonNode;\n-import org.junit.jupiter.api.BeforeEach;\n+import org.junit.*;", "originalCommit": "ba5c0368ca73de7ca7ec77bd1f8b63998e7f3da2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5a49140aba2035d10a6bc4479c021e702d79aa3c", "chunk": "diff --git a/src/test/java/uk/gov/hmcts/ccd/v2/internal/controller/UICaseSearchControllerIT.java b/src/test/java/uk/gov/hmcts/ccd/v2/internal/controller/UICaseSearchControllerIT.java\nindex 57ec54ff9..987282d88 100644\n--- a/src/test/java/uk/gov/hmcts/ccd/v2/internal/controller/UICaseSearchControllerIT.java\n+++ b/src/test/java/uk/gov/hmcts/ccd/v2/internal/controller/UICaseSearchControllerIT.java\n\n@@ -2,7 +2,6 @@ package uk.gov.hmcts.ccd.v2.internal.controller;\n \n import com.fasterxml.jackson.databind.DeserializationFeature;\n import com.fasterxml.jackson.databind.JsonNode;\n-import org.junit.*;\n import org.junit.jupiter.api.*;\n import org.junit.jupiter.api.Test;\n import org.mockito.Mock;\n"}}, {"oid": "5a49140aba2035d10a6bc4479c021e702d79aa3c", "url": "https://github.com/hmcts/ccd-data-store-api/commit/5a49140aba2035d10a6bc4479c021e702d79aa3c", "message": "RDM-8782 fixed issues on checking security classification and added role testing", "committedDate": "2020-06-25T14:10:26Z", "type": "commit"}, {"oid": "493e5b516806c041e2cdd23111b1368bfe2896aa", "url": "https://github.com/hmcts/ccd-data-store-api/commit/493e5b516806c041e2cdd23111b1368bfe2896aa", "message": "RDM-8782 actioned review comments", "committedDate": "2020-06-26T11:52:25Z", "type": "commit"}, {"oid": "b4b80c5f5778b9d9f11197e735c8db530bc0e14d", "url": "https://github.com/hmcts/ccd-data-store-api/commit/b4b80c5f5778b9d9f11197e735c8db530bc0e14d", "message": "RDM-8782 added assert on field size to ensure only meta data is returned", "committedDate": "2020-06-26T11:56:20Z", "type": "commit"}, {"oid": "7c2a4a75ab1f557bf77be37050c9be85f1ec3a0d", "url": "https://github.com/hmcts/ccd-data-store-api/commit/7c2a4a75ab1f557bf77be37050c9be85f1ec3a0d", "message": "RDM-8782 fixed checkstyle", "committedDate": "2020-06-26T11:59:13Z", "type": "commit"}, {"oid": "8cb22f8cef6938147363854b0e4e7d4b870bc8c8", "url": "https://github.com/hmcts/ccd-data-store-api/commit/8cb22f8cef6938147363854b0e4e7d4b870bc8c8", "message": "RDM-8782 removed unused class", "committedDate": "2020-06-26T12:03:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI0NDAyNw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/990#discussion_r446244027", "bodyText": "I know it's not part of your code changes but can we please rename SearchResult to SearchResultDefinition? We are trying to have all definition objects classes in DataStore end with Definition suffix", "author": "mario-paniccia", "createdAt": "2020-06-26T15:11:33Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java", "diffHunk": "@@ -61,25 +64,78 @@ public CaseSearchResultView execute(String caseTypeId,\n \n     private boolean itemsRequireFormatting(List<SearchResultViewHeaderGroup> headerGroups) {\n         return headerGroups.size() == 1\n-               && headerGroups.get(0).getFields().stream().anyMatch(field -> field.getDisplayContextParameter() != null);\n+            && headerGroups.get(0).getFields().stream().anyMatch(field -> field.getDisplayContextParameter() != null);\n     }\n \n     private List<SearchResultViewItem> buildItems(String useCase, CaseSearchResult caseSearchResult, String caseTypeId, List<String> requestedFields) {\n         CaseTypeDefinition caseTypeDefinition = getCaseTypeDefinition(caseTypeId);\n         SearchResult searchResultDefinition = searchResultDefinitionService.getSearchResultDefinition(caseTypeDefinition, useCase, requestedFields);", "originalCommit": "8cb22f8cef6938147363854b0e4e7d4b870bc8c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY2NTg0OA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/990#discussion_r447665848", "bodyText": "Done \ud83d\udc4d", "author": "RebeccaBaker", "createdAt": "2020-06-30T13:05:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI0NDAyNw=="}], "type": "inlineReview", "revised_code": {"commit": "da9cc91a36347825389534ab85022eeeee5db474", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java b/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\nindex eaaac7ef4..ea276ef0a 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\n\n@@ -62,6 +61,17 @@ public class CaseSearchResultViewGenerator {\n         );\n     }\n \n+    public CaseDetails filterUnauthorisedFieldsByUseCaseAndUserRole(String useCase, CaseDetails caseDetails, String caseTypeId, List<String> requestedFields) {\n+        CaseTypeDefinition caseTypeDefinition = getCaseTypeDefinition(caseTypeId);\n+        caseDetails.getData().entrySet().removeIf(\n+            caseField -> {\n+                Optional<CaseFieldDefinition> caseFieldDefinition = caseTypeDefinition.getCaseField(caseField.getKey());\n+                return !caseSearchesViewAccessControl.filterResultsBySearchResultsDefinition(useCase, caseTypeId, requestedFields, caseField.getKey())\n+                    || !caseSearchesViewAccessControl.filterFieldByAuthorisationAccessOnField(caseFieldDefinition.get());\n+            });\n+        return caseDetails;\n+    }\n+\n     private boolean itemsRequireFormatting(List<SearchResultViewHeaderGroup> headerGroups) {\n         return headerGroups.size() == 1\n             && headerGroups.get(0).getFields().stream().anyMatch(field -> field.getDisplayContextParameter() != null);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI0NjM2MQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/990#discussion_r446246361", "bodyText": "I'd suggest we introduce a new dedicated class called CaseSearchesViewAccessControl or similar, and move all the access control code added to this class in there. This will help reduce the complexity of this class which is otherwise growing too much. It would also be better in terms of separation of concerns", "author": "mario-paniccia", "createdAt": "2020-06-26T15:15:24Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java", "diffHunk": "@@ -61,25 +64,78 @@ public CaseSearchResultView execute(String caseTypeId,\n \n     private boolean itemsRequireFormatting(List<SearchResultViewHeaderGroup> headerGroups) {\n         return headerGroups.size() == 1\n-               && headerGroups.get(0).getFields().stream().anyMatch(field -> field.getDisplayContextParameter() != null);\n+            && headerGroups.get(0).getFields().stream().anyMatch(field -> field.getDisplayContextParameter() != null);\n     }\n \n     private List<SearchResultViewItem> buildItems(String useCase, CaseSearchResult caseSearchResult, String caseTypeId, List<String> requestedFields) {\n         CaseTypeDefinition caseTypeDefinition = getCaseTypeDefinition(caseTypeId);\n         SearchResult searchResultDefinition = searchResultDefinitionService.getSearchResultDefinition(caseTypeDefinition, useCase, requestedFields);\n \n         List<SearchResultViewItem> items = new ArrayList<>();\n-        // Only one case type is currently supported so we can reuse the same definitions for building all items\n-        caseSearchResult.getCases().forEach(caseDetails ->\n-            items.add(buildSearchResultViewItem(caseDetails, caseTypeDefinition, searchResultDefinition)));\n-\n+        caseSearchResult.getCases().forEach(caseDetails -> {\n+            filterResultsByAuthorisationAndUserRole(useCase, caseDetails, caseTypeId, requestedFields);", "originalCommit": "8cb22f8cef6938147363854b0e4e7d4b870bc8c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY2NTk2Ng==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/990#discussion_r447665966", "bodyText": "Added the new class as requested", "author": "RebeccaBaker", "createdAt": "2020-06-30T13:05:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI0NjM2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "da9cc91a36347825389534ab85022eeeee5db474", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java b/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\nindex eaaac7ef4..ea276ef0a 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\n\n@@ -62,6 +61,17 @@ public class CaseSearchResultViewGenerator {\n         );\n     }\n \n+    public CaseDetails filterUnauthorisedFieldsByUseCaseAndUserRole(String useCase, CaseDetails caseDetails, String caseTypeId, List<String> requestedFields) {\n+        CaseTypeDefinition caseTypeDefinition = getCaseTypeDefinition(caseTypeId);\n+        caseDetails.getData().entrySet().removeIf(\n+            caseField -> {\n+                Optional<CaseFieldDefinition> caseFieldDefinition = caseTypeDefinition.getCaseField(caseField.getKey());\n+                return !caseSearchesViewAccessControl.filterResultsBySearchResultsDefinition(useCase, caseTypeId, requestedFields, caseField.getKey())\n+                    || !caseSearchesViewAccessControl.filterFieldByAuthorisationAccessOnField(caseFieldDefinition.get());\n+            });\n+        return caseDetails;\n+    }\n+\n     private boolean itemsRequireFormatting(List<SearchResultViewHeaderGroup> headerGroups) {\n         return headerGroups.size() == 1\n             && headerGroups.get(0).getFields().stream().anyMatch(field -> field.getDisplayContextParameter() != null);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI0OTMwMw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/990#discussion_r446249303", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        filterResultsByAuthorisationAndUserRole(useCase, caseDetails, caseTypeId, requestedFields);\n          \n          \n            \n                        filterUnauthorisedFieldsByUseCaseAndUserRole(useCase, caseDetails, caseTypeId, requestedFields);", "author": "mario-paniccia", "createdAt": "2020-06-26T15:20:44Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java", "diffHunk": "@@ -61,25 +64,78 @@ public CaseSearchResultView execute(String caseTypeId,\n \n     private boolean itemsRequireFormatting(List<SearchResultViewHeaderGroup> headerGroups) {\n         return headerGroups.size() == 1\n-               && headerGroups.get(0).getFields().stream().anyMatch(field -> field.getDisplayContextParameter() != null);\n+            && headerGroups.get(0).getFields().stream().anyMatch(field -> field.getDisplayContextParameter() != null);\n     }\n \n     private List<SearchResultViewItem> buildItems(String useCase, CaseSearchResult caseSearchResult, String caseTypeId, List<String> requestedFields) {\n         CaseTypeDefinition caseTypeDefinition = getCaseTypeDefinition(caseTypeId);\n         SearchResult searchResultDefinition = searchResultDefinitionService.getSearchResultDefinition(caseTypeDefinition, useCase, requestedFields);\n \n         List<SearchResultViewItem> items = new ArrayList<>();\n-        // Only one case type is currently supported so we can reuse the same definitions for building all items\n-        caseSearchResult.getCases().forEach(caseDetails ->\n-            items.add(buildSearchResultViewItem(caseDetails, caseTypeDefinition, searchResultDefinition)));\n-\n+        caseSearchResult.getCases().forEach(caseDetails -> {\n+            filterResultsByAuthorisationAndUserRole(useCase, caseDetails, caseTypeId, requestedFields);", "originalCommit": "8cb22f8cef6938147363854b0e4e7d4b870bc8c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY2NjA1MQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/990#discussion_r447666051", "bodyText": "renamed \ud83d\udc4d", "author": "RebeccaBaker", "createdAt": "2020-06-30T13:05:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI0OTMwMw=="}], "type": "inlineReview", "revised_code": {"commit": "da9cc91a36347825389534ab85022eeeee5db474", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java b/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\nindex eaaac7ef4..ea276ef0a 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\n\n@@ -62,6 +61,17 @@ public class CaseSearchResultViewGenerator {\n         );\n     }\n \n+    public CaseDetails filterUnauthorisedFieldsByUseCaseAndUserRole(String useCase, CaseDetails caseDetails, String caseTypeId, List<String> requestedFields) {\n+        CaseTypeDefinition caseTypeDefinition = getCaseTypeDefinition(caseTypeId);\n+        caseDetails.getData().entrySet().removeIf(\n+            caseField -> {\n+                Optional<CaseFieldDefinition> caseFieldDefinition = caseTypeDefinition.getCaseField(caseField.getKey());\n+                return !caseSearchesViewAccessControl.filterResultsBySearchResultsDefinition(useCase, caseTypeId, requestedFields, caseField.getKey())\n+                    || !caseSearchesViewAccessControl.filterFieldByAuthorisationAccessOnField(caseFieldDefinition.get());\n+            });\n+        return caseDetails;\n+    }\n+\n     private boolean itemsRequireFormatting(List<SearchResultViewHeaderGroup> headerGroups) {\n         return headerGroups.size() == 1\n             && headerGroups.get(0).getFields().stream().anyMatch(field -> field.getDisplayContextParameter() != null);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg0MjUzMg==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/990#discussion_r446842532", "bodyText": "here we are applying access control based on the CRUD coming from the AuthorizationCaseField definition tab right? if yes, then this should be done in the external search API, not the internal", "author": "mario-paniccia", "createdAt": "2020-06-29T08:02:21Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java", "diffHunk": "@@ -61,25 +64,78 @@ public CaseSearchResultView execute(String caseTypeId,\n \n     private boolean itemsRequireFormatting(List<SearchResultViewHeaderGroup> headerGroups) {\n         return headerGroups.size() == 1\n-               && headerGroups.get(0).getFields().stream().anyMatch(field -> field.getDisplayContextParameter() != null);\n+            && headerGroups.get(0).getFields().stream().anyMatch(field -> field.getDisplayContextParameter() != null);\n     }\n \n     private List<SearchResultViewItem> buildItems(String useCase, CaseSearchResult caseSearchResult, String caseTypeId, List<String> requestedFields) {\n         CaseTypeDefinition caseTypeDefinition = getCaseTypeDefinition(caseTypeId);\n         SearchResult searchResultDefinition = searchResultDefinitionService.getSearchResultDefinition(caseTypeDefinition, useCase, requestedFields);\n \n         List<SearchResultViewItem> items = new ArrayList<>();\n-        // Only one case type is currently supported so we can reuse the same definitions for building all items\n-        caseSearchResult.getCases().forEach(caseDetails ->\n-            items.add(buildSearchResultViewItem(caseDetails, caseTypeDefinition, searchResultDefinition)));\n-\n+        caseSearchResult.getCases().forEach(caseDetails -> {\n+            filterResultsByAuthorisationAndUserRole(useCase, caseDetails, caseTypeId, requestedFields);\n+            items.add(buildSearchResultViewItem(caseDetails, caseTypeDefinition, searchResultDefinition));\n+        });\n         return items;\n     }\n \n-    private List<SearchResultViewHeaderGroup> buildHeaders(String caseTypeId,\n-                                                           String useCase,\n-                                                           CaseSearchResult caseSearchResult,\n-                                                           List<String> requestedFields) {\n+    private CaseDetails filterResultsByAuthorisationAndUserRole(String useCase, CaseDetails caseDetails, String caseTypeId, List<String> requestedFields) {\n+        CaseTypeDefinition caseTypeDefinition = getCaseTypeDefinition(caseTypeId);\n+        caseDetails.getData().entrySet().removeIf(\n+            caseField -> {\n+                Optional<CaseFieldDefinition> caseFieldDefinition = caseTypeDefinition.getCaseField(caseField.getKey());\n+                return !filterResultsBySearchResultsDefinition(useCase, caseTypeId, requestedFields, caseField.getKey())\n+                    || !filterResultsByAuthorisationAccessOnField(caseFieldDefinition.get());\n+            });\n+        return caseDetails;\n+    }\n+\n+\n+    private Boolean filterResultsBySearchResultsDefinition(String useCase, String caseTypeId, List<String> requestedFields, String caseFieldId) {\n+        Set<String> roles = userRepository.getUserRoles();\n+        CaseTypeDefinition caseTypeDefinition = getCaseTypeDefinition(caseTypeId);\n+        SearchResult searchResultDefinition = searchResultDefinitionService.getSearchResultDefinition(caseTypeDefinition, useCase, requestedFields);\n+        HashMap<String, String> searchFields = getSearchResultDefinitionFieldUserRoleAndField(searchResultDefinition);\n+\n+        if (useCase != null) {\n+            if (!searchFields.containsKey(caseFieldId)) {\n+                return false;\n+            }\n+            String role = searchFields.get(caseFieldId);\n+            if (role != null && !roles.contains(role)) {\n+                return false;\n+            }\n+        }\n+        return true;\n+    }\n+\n+    private Boolean filterResultsByAuthorisationAccessOnField(CaseFieldDefinition caseFieldDefinition) {\n+        if (!caseFieldDefinition.isMetadata()) {\n+            return userRepository.getUserRoles().stream()\n+                .anyMatch(role -> caseFieldDefinition.getAccessControlListByRole(role).map(AccessControlList::isRead).orElse(false));\n+        }\n+        return true;\n+    }", "originalCommit": "8cb22f8cef6938147363854b0e4e7d4b870bc8c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg0NDE4OQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/990#discussion_r446844189", "bodyText": "Also, is there any method in AccessControlService that we could reuse?", "author": "mario-paniccia", "createdAt": "2020-06-29T08:05:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg0MjUzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY2NjMyMQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/990#discussion_r447666321", "bodyText": "External search completed this work therefore removed the logic code here", "author": "RebeccaBaker", "createdAt": "2020-06-30T13:06:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg0MjUzMg=="}], "type": "inlineReview", "revised_code": {"commit": "da9cc91a36347825389534ab85022eeeee5db474", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java b/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\nindex eaaac7ef4..ea276ef0a 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\n\n@@ -62,6 +61,17 @@ public class CaseSearchResultViewGenerator {\n         );\n     }\n \n+    public CaseDetails filterUnauthorisedFieldsByUseCaseAndUserRole(String useCase, CaseDetails caseDetails, String caseTypeId, List<String> requestedFields) {\n+        CaseTypeDefinition caseTypeDefinition = getCaseTypeDefinition(caseTypeId);\n+        caseDetails.getData().entrySet().removeIf(\n+            caseField -> {\n+                Optional<CaseFieldDefinition> caseFieldDefinition = caseTypeDefinition.getCaseField(caseField.getKey());\n+                return !caseSearchesViewAccessControl.filterResultsBySearchResultsDefinition(useCase, caseTypeId, requestedFields, caseField.getKey())\n+                    || !caseSearchesViewAccessControl.filterFieldByAuthorisationAccessOnField(caseFieldDefinition.get());\n+            });\n+        return caseDetails;\n+    }\n+\n     private boolean itemsRequireFormatting(List<SearchResultViewHeaderGroup> headerGroups) {\n         return headerGroups.size() == 1\n             && headerGroups.get(0).getFields().stream().anyMatch(field -> field.getDisplayContextParameter() != null);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg0NTY4Mg==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/990#discussion_r446845682", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                || !filterResultsByAuthorisationAccessOnField(caseFieldDefinition.get());\n          \n          \n            \n                                || !filterFieldByAuthorisationAccessOnField(caseFieldDefinition.get());", "author": "mario-paniccia", "createdAt": "2020-06-29T08:08:16Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java", "diffHunk": "@@ -61,25 +64,78 @@ public CaseSearchResultView execute(String caseTypeId,\n \n     private boolean itemsRequireFormatting(List<SearchResultViewHeaderGroup> headerGroups) {\n         return headerGroups.size() == 1\n-               && headerGroups.get(0).getFields().stream().anyMatch(field -> field.getDisplayContextParameter() != null);\n+            && headerGroups.get(0).getFields().stream().anyMatch(field -> field.getDisplayContextParameter() != null);\n     }\n \n     private List<SearchResultViewItem> buildItems(String useCase, CaseSearchResult caseSearchResult, String caseTypeId, List<String> requestedFields) {\n         CaseTypeDefinition caseTypeDefinition = getCaseTypeDefinition(caseTypeId);\n         SearchResult searchResultDefinition = searchResultDefinitionService.getSearchResultDefinition(caseTypeDefinition, useCase, requestedFields);\n \n         List<SearchResultViewItem> items = new ArrayList<>();\n-        // Only one case type is currently supported so we can reuse the same definitions for building all items\n-        caseSearchResult.getCases().forEach(caseDetails ->\n-            items.add(buildSearchResultViewItem(caseDetails, caseTypeDefinition, searchResultDefinition)));\n-\n+        caseSearchResult.getCases().forEach(caseDetails -> {\n+            filterResultsByAuthorisationAndUserRole(useCase, caseDetails, caseTypeId, requestedFields);\n+            items.add(buildSearchResultViewItem(caseDetails, caseTypeDefinition, searchResultDefinition));\n+        });\n         return items;\n     }\n \n-    private List<SearchResultViewHeaderGroup> buildHeaders(String caseTypeId,\n-                                                           String useCase,\n-                                                           CaseSearchResult caseSearchResult,\n-                                                           List<String> requestedFields) {\n+    private CaseDetails filterResultsByAuthorisationAndUserRole(String useCase, CaseDetails caseDetails, String caseTypeId, List<String> requestedFields) {\n+        CaseTypeDefinition caseTypeDefinition = getCaseTypeDefinition(caseTypeId);\n+        caseDetails.getData().entrySet().removeIf(\n+            caseField -> {\n+                Optional<CaseFieldDefinition> caseFieldDefinition = caseTypeDefinition.getCaseField(caseField.getKey());\n+                return !filterResultsBySearchResultsDefinition(useCase, caseTypeId, requestedFields, caseField.getKey())\n+                    || !filterResultsByAuthorisationAccessOnField(caseFieldDefinition.get());", "originalCommit": "8cb22f8cef6938147363854b0e4e7d4b870bc8c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY2NjQzMA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/990#discussion_r447666430", "bodyText": "renamed \ud83d\udc4d", "author": "RebeccaBaker", "createdAt": "2020-06-30T13:06:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg0NTY4Mg=="}], "type": "inlineReview", "revised_code": {"commit": "da9cc91a36347825389534ab85022eeeee5db474", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java b/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\nindex eaaac7ef4..ea276ef0a 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\n\n@@ -62,6 +61,17 @@ public class CaseSearchResultViewGenerator {\n         );\n     }\n \n+    public CaseDetails filterUnauthorisedFieldsByUseCaseAndUserRole(String useCase, CaseDetails caseDetails, String caseTypeId, List<String> requestedFields) {\n+        CaseTypeDefinition caseTypeDefinition = getCaseTypeDefinition(caseTypeId);\n+        caseDetails.getData().entrySet().removeIf(\n+            caseField -> {\n+                Optional<CaseFieldDefinition> caseFieldDefinition = caseTypeDefinition.getCaseField(caseField.getKey());\n+                return !caseSearchesViewAccessControl.filterResultsBySearchResultsDefinition(useCase, caseTypeId, requestedFields, caseField.getKey())\n+                    || !caseSearchesViewAccessControl.filterFieldByAuthorisationAccessOnField(caseFieldDefinition.get());\n+            });\n+        return caseDetails;\n+    }\n+\n     private boolean itemsRequireFormatting(List<SearchResultViewHeaderGroup> headerGroups) {\n         return headerGroups.size() == 1\n             && headerGroups.get(0).getFields().stream().anyMatch(field -> field.getDisplayContextParameter() != null);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg0OTIwMQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/990#discussion_r446849201", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    HashMap<String, String> fields = new HashMap<>();\n          \n          \n            \n                    Map<String, String> fields = new HashMap<>();", "author": "mario-paniccia", "createdAt": "2020-06-29T08:14:48Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java", "diffHunk": "@@ -61,25 +64,78 @@ public CaseSearchResultView execute(String caseTypeId,\n \n     private boolean itemsRequireFormatting(List<SearchResultViewHeaderGroup> headerGroups) {\n         return headerGroups.size() == 1\n-               && headerGroups.get(0).getFields().stream().anyMatch(field -> field.getDisplayContextParameter() != null);\n+            && headerGroups.get(0).getFields().stream().anyMatch(field -> field.getDisplayContextParameter() != null);\n     }\n \n     private List<SearchResultViewItem> buildItems(String useCase, CaseSearchResult caseSearchResult, String caseTypeId, List<String> requestedFields) {\n         CaseTypeDefinition caseTypeDefinition = getCaseTypeDefinition(caseTypeId);\n         SearchResult searchResultDefinition = searchResultDefinitionService.getSearchResultDefinition(caseTypeDefinition, useCase, requestedFields);\n \n         List<SearchResultViewItem> items = new ArrayList<>();\n-        // Only one case type is currently supported so we can reuse the same definitions for building all items\n-        caseSearchResult.getCases().forEach(caseDetails ->\n-            items.add(buildSearchResultViewItem(caseDetails, caseTypeDefinition, searchResultDefinition)));\n-\n+        caseSearchResult.getCases().forEach(caseDetails -> {\n+            filterResultsByAuthorisationAndUserRole(useCase, caseDetails, caseTypeId, requestedFields);\n+            items.add(buildSearchResultViewItem(caseDetails, caseTypeDefinition, searchResultDefinition));\n+        });\n         return items;\n     }\n \n-    private List<SearchResultViewHeaderGroup> buildHeaders(String caseTypeId,\n-                                                           String useCase,\n-                                                           CaseSearchResult caseSearchResult,\n-                                                           List<String> requestedFields) {\n+    private CaseDetails filterResultsByAuthorisationAndUserRole(String useCase, CaseDetails caseDetails, String caseTypeId, List<String> requestedFields) {\n+        CaseTypeDefinition caseTypeDefinition = getCaseTypeDefinition(caseTypeId);\n+        caseDetails.getData().entrySet().removeIf(\n+            caseField -> {\n+                Optional<CaseFieldDefinition> caseFieldDefinition = caseTypeDefinition.getCaseField(caseField.getKey());\n+                return !filterResultsBySearchResultsDefinition(useCase, caseTypeId, requestedFields, caseField.getKey())\n+                    || !filterResultsByAuthorisationAccessOnField(caseFieldDefinition.get());\n+            });\n+        return caseDetails;\n+    }\n+\n+\n+    private Boolean filterResultsBySearchResultsDefinition(String useCase, String caseTypeId, List<String> requestedFields, String caseFieldId) {\n+        Set<String> roles = userRepository.getUserRoles();\n+        CaseTypeDefinition caseTypeDefinition = getCaseTypeDefinition(caseTypeId);\n+        SearchResult searchResultDefinition = searchResultDefinitionService.getSearchResultDefinition(caseTypeDefinition, useCase, requestedFields);\n+        HashMap<String, String> searchFields = getSearchResultDefinitionFieldUserRoleAndField(searchResultDefinition);\n+\n+        if (useCase != null) {\n+            if (!searchFields.containsKey(caseFieldId)) {\n+                return false;\n+            }\n+            String role = searchFields.get(caseFieldId);\n+            if (role != null && !roles.contains(role)) {\n+                return false;\n+            }\n+        }\n+        return true;\n+    }\n+\n+    private Boolean filterResultsByAuthorisationAccessOnField(CaseFieldDefinition caseFieldDefinition) {\n+        if (!caseFieldDefinition.isMetadata()) {\n+            return userRepository.getUserRoles().stream()\n+                .anyMatch(role -> caseFieldDefinition.getAccessControlListByRole(role).map(AccessControlList::isRead).orElse(false));\n+        }\n+        return true;\n+    }\n+\n+    private Boolean filterResultsBySecurityClassification(CaseFieldDefinition caseFieldDefinition,\n+                                                          CaseTypeDefinition caseTypeDefinition) {\n+        return securityClassificationService.userHasEnoughSecurityClassificationForField(caseTypeDefinition.getJurisdictionId(),\n+            caseTypeDefinition,\n+            caseFieldDefinition.getId());\n+\n+    }\n+\n+    private HashMap<String, String> getSearchResultDefinitionFieldUserRoleAndField(SearchResult searchResultDefinition) {\n+        HashMap<String, String> fields = new HashMap<>();", "originalCommit": "8cb22f8cef6938147363854b0e4e7d4b870bc8c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY2NjUxNw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/990#discussion_r447666517", "bodyText": "done \ud83d\udc4d", "author": "RebeccaBaker", "createdAt": "2020-06-30T13:06:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg0OTIwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "da9cc91a36347825389534ab85022eeeee5db474", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java b/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\nindex eaaac7ef4..ea276ef0a 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\n\n@@ -62,6 +61,17 @@ public class CaseSearchResultViewGenerator {\n         );\n     }\n \n+    public CaseDetails filterUnauthorisedFieldsByUseCaseAndUserRole(String useCase, CaseDetails caseDetails, String caseTypeId, List<String> requestedFields) {\n+        CaseTypeDefinition caseTypeDefinition = getCaseTypeDefinition(caseTypeId);\n+        caseDetails.getData().entrySet().removeIf(\n+            caseField -> {\n+                Optional<CaseFieldDefinition> caseFieldDefinition = caseTypeDefinition.getCaseField(caseField.getKey());\n+                return !caseSearchesViewAccessControl.filterResultsBySearchResultsDefinition(useCase, caseTypeId, requestedFields, caseField.getKey())\n+                    || !caseSearchesViewAccessControl.filterFieldByAuthorisationAccessOnField(caseFieldDefinition.get());\n+            });\n+        return caseDetails;\n+    }\n+\n     private boolean itemsRequireFormatting(List<SearchResultViewHeaderGroup> headerGroups) {\n         return headerGroups.size() == 1\n             && headerGroups.get(0).getFields().stream().anyMatch(field -> field.getDisplayContextParameter() != null);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg1MDQxNw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/990#discussion_r446850417", "bodyText": "can we move this method to SearchResult itself please. We could also rename it to getFieldsUserRoles or sim", "author": "mario-paniccia", "createdAt": "2020-06-29T08:16:55Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java", "diffHunk": "@@ -61,25 +64,78 @@ public CaseSearchResultView execute(String caseTypeId,\n \n     private boolean itemsRequireFormatting(List<SearchResultViewHeaderGroup> headerGroups) {\n         return headerGroups.size() == 1\n-               && headerGroups.get(0).getFields().stream().anyMatch(field -> field.getDisplayContextParameter() != null);\n+            && headerGroups.get(0).getFields().stream().anyMatch(field -> field.getDisplayContextParameter() != null);\n     }\n \n     private List<SearchResultViewItem> buildItems(String useCase, CaseSearchResult caseSearchResult, String caseTypeId, List<String> requestedFields) {\n         CaseTypeDefinition caseTypeDefinition = getCaseTypeDefinition(caseTypeId);\n         SearchResult searchResultDefinition = searchResultDefinitionService.getSearchResultDefinition(caseTypeDefinition, useCase, requestedFields);\n \n         List<SearchResultViewItem> items = new ArrayList<>();\n-        // Only one case type is currently supported so we can reuse the same definitions for building all items\n-        caseSearchResult.getCases().forEach(caseDetails ->\n-            items.add(buildSearchResultViewItem(caseDetails, caseTypeDefinition, searchResultDefinition)));\n-\n+        caseSearchResult.getCases().forEach(caseDetails -> {\n+            filterResultsByAuthorisationAndUserRole(useCase, caseDetails, caseTypeId, requestedFields);\n+            items.add(buildSearchResultViewItem(caseDetails, caseTypeDefinition, searchResultDefinition));\n+        });\n         return items;\n     }\n \n-    private List<SearchResultViewHeaderGroup> buildHeaders(String caseTypeId,\n-                                                           String useCase,\n-                                                           CaseSearchResult caseSearchResult,\n-                                                           List<String> requestedFields) {\n+    private CaseDetails filterResultsByAuthorisationAndUserRole(String useCase, CaseDetails caseDetails, String caseTypeId, List<String> requestedFields) {\n+        CaseTypeDefinition caseTypeDefinition = getCaseTypeDefinition(caseTypeId);\n+        caseDetails.getData().entrySet().removeIf(\n+            caseField -> {\n+                Optional<CaseFieldDefinition> caseFieldDefinition = caseTypeDefinition.getCaseField(caseField.getKey());\n+                return !filterResultsBySearchResultsDefinition(useCase, caseTypeId, requestedFields, caseField.getKey())\n+                    || !filterResultsByAuthorisationAccessOnField(caseFieldDefinition.get());\n+            });\n+        return caseDetails;\n+    }\n+\n+\n+    private Boolean filterResultsBySearchResultsDefinition(String useCase, String caseTypeId, List<String> requestedFields, String caseFieldId) {\n+        Set<String> roles = userRepository.getUserRoles();\n+        CaseTypeDefinition caseTypeDefinition = getCaseTypeDefinition(caseTypeId);\n+        SearchResult searchResultDefinition = searchResultDefinitionService.getSearchResultDefinition(caseTypeDefinition, useCase, requestedFields);\n+        HashMap<String, String> searchFields = getSearchResultDefinitionFieldUserRoleAndField(searchResultDefinition);\n+\n+        if (useCase != null) {\n+            if (!searchFields.containsKey(caseFieldId)) {\n+                return false;\n+            }\n+            String role = searchFields.get(caseFieldId);\n+            if (role != null && !roles.contains(role)) {\n+                return false;\n+            }\n+        }\n+        return true;\n+    }\n+\n+    private Boolean filterResultsByAuthorisationAccessOnField(CaseFieldDefinition caseFieldDefinition) {\n+        if (!caseFieldDefinition.isMetadata()) {\n+            return userRepository.getUserRoles().stream()\n+                .anyMatch(role -> caseFieldDefinition.getAccessControlListByRole(role).map(AccessControlList::isRead).orElse(false));\n+        }\n+        return true;\n+    }\n+\n+    private Boolean filterResultsBySecurityClassification(CaseFieldDefinition caseFieldDefinition,\n+                                                          CaseTypeDefinition caseTypeDefinition) {\n+        return securityClassificationService.userHasEnoughSecurityClassificationForField(caseTypeDefinition.getJurisdictionId(),\n+            caseTypeDefinition,\n+            caseFieldDefinition.getId());\n+\n+    }\n+\n+    private HashMap<String, String> getSearchResultDefinitionFieldUserRoleAndField(SearchResult searchResultDefinition) {", "originalCommit": "8cb22f8cef6938147363854b0e4e7d4b870bc8c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY2NjY3NA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/990#discussion_r447666674", "bodyText": "added method to the class as requested", "author": "RebeccaBaker", "createdAt": "2020-06-30T13:06:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg1MDQxNw=="}], "type": "inlineReview", "revised_code": {"commit": "da9cc91a36347825389534ab85022eeeee5db474", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java b/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\nindex eaaac7ef4..ea276ef0a 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\n\n@@ -62,6 +61,17 @@ public class CaseSearchResultViewGenerator {\n         );\n     }\n \n+    public CaseDetails filterUnauthorisedFieldsByUseCaseAndUserRole(String useCase, CaseDetails caseDetails, String caseTypeId, List<String> requestedFields) {\n+        CaseTypeDefinition caseTypeDefinition = getCaseTypeDefinition(caseTypeId);\n+        caseDetails.getData().entrySet().removeIf(\n+            caseField -> {\n+                Optional<CaseFieldDefinition> caseFieldDefinition = caseTypeDefinition.getCaseField(caseField.getKey());\n+                return !caseSearchesViewAccessControl.filterResultsBySearchResultsDefinition(useCase, caseTypeId, requestedFields, caseField.getKey())\n+                    || !caseSearchesViewAccessControl.filterFieldByAuthorisationAccessOnField(caseFieldDefinition.get());\n+            });\n+        return caseDetails;\n+    }\n+\n     private boolean itemsRequireFormatting(List<SearchResultViewHeaderGroup> headerGroups) {\n         return headerGroups.size() == 1\n             && headerGroups.get(0).getFields().stream().anyMatch(field -> field.getDisplayContextParameter() != null);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg1MzU4Mg==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/990#discussion_r446853582", "bodyText": "just to double check, do we have a test verifying this works for nested fields specified with a path?", "author": "mario-paniccia", "createdAt": "2020-06-29T08:22:40Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java", "diffHunk": "@@ -61,25 +64,78 @@ public CaseSearchResultView execute(String caseTypeId,\n \n     private boolean itemsRequireFormatting(List<SearchResultViewHeaderGroup> headerGroups) {\n         return headerGroups.size() == 1\n-               && headerGroups.get(0).getFields().stream().anyMatch(field -> field.getDisplayContextParameter() != null);\n+            && headerGroups.get(0).getFields().stream().anyMatch(field -> field.getDisplayContextParameter() != null);\n     }\n \n     private List<SearchResultViewItem> buildItems(String useCase, CaseSearchResult caseSearchResult, String caseTypeId, List<String> requestedFields) {\n         CaseTypeDefinition caseTypeDefinition = getCaseTypeDefinition(caseTypeId);\n         SearchResult searchResultDefinition = searchResultDefinitionService.getSearchResultDefinition(caseTypeDefinition, useCase, requestedFields);\n \n         List<SearchResultViewItem> items = new ArrayList<>();\n-        // Only one case type is currently supported so we can reuse the same definitions for building all items\n-        caseSearchResult.getCases().forEach(caseDetails ->\n-            items.add(buildSearchResultViewItem(caseDetails, caseTypeDefinition, searchResultDefinition)));\n-\n+        caseSearchResult.getCases().forEach(caseDetails -> {\n+            filterResultsByAuthorisationAndUserRole(useCase, caseDetails, caseTypeId, requestedFields);\n+            items.add(buildSearchResultViewItem(caseDetails, caseTypeDefinition, searchResultDefinition));\n+        });\n         return items;\n     }\n \n-    private List<SearchResultViewHeaderGroup> buildHeaders(String caseTypeId,\n-                                                           String useCase,\n-                                                           CaseSearchResult caseSearchResult,\n-                                                           List<String> requestedFields) {\n+    private CaseDetails filterResultsByAuthorisationAndUserRole(String useCase, CaseDetails caseDetails, String caseTypeId, List<String> requestedFields) {\n+        CaseTypeDefinition caseTypeDefinition = getCaseTypeDefinition(caseTypeId);\n+        caseDetails.getData().entrySet().removeIf(\n+            caseField -> {\n+                Optional<CaseFieldDefinition> caseFieldDefinition = caseTypeDefinition.getCaseField(caseField.getKey());\n+                return !filterResultsBySearchResultsDefinition(useCase, caseTypeId, requestedFields, caseField.getKey())\n+                    || !filterResultsByAuthorisationAccessOnField(caseFieldDefinition.get());\n+            });\n+        return caseDetails;\n+    }\n+\n+\n+    private Boolean filterResultsBySearchResultsDefinition(String useCase, String caseTypeId, List<String> requestedFields, String caseFieldId) {", "originalCommit": "8cb22f8cef6938147363854b0e4e7d4b870bc8c8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "da9cc91a36347825389534ab85022eeeee5db474", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java b/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\nindex eaaac7ef4..ea276ef0a 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\n\n@@ -62,6 +61,17 @@ public class CaseSearchResultViewGenerator {\n         );\n     }\n \n+    public CaseDetails filterUnauthorisedFieldsByUseCaseAndUserRole(String useCase, CaseDetails caseDetails, String caseTypeId, List<String> requestedFields) {\n+        CaseTypeDefinition caseTypeDefinition = getCaseTypeDefinition(caseTypeId);\n+        caseDetails.getData().entrySet().removeIf(\n+            caseField -> {\n+                Optional<CaseFieldDefinition> caseFieldDefinition = caseTypeDefinition.getCaseField(caseField.getKey());\n+                return !caseSearchesViewAccessControl.filterResultsBySearchResultsDefinition(useCase, caseTypeId, requestedFields, caseField.getKey())\n+                    || !caseSearchesViewAccessControl.filterFieldByAuthorisationAccessOnField(caseFieldDefinition.get());\n+            });\n+        return caseDetails;\n+    }\n+\n     private boolean itemsRequireFormatting(List<SearchResultViewHeaderGroup> headerGroups) {\n         return headerGroups.size() == 1\n             && headerGroups.get(0).getFields().stream().anyMatch(field -> field.getDisplayContextParameter() != null);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg1NTMyMg==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/990#discussion_r446855322", "bodyText": "minor, as an alternative we could add 2 methods to SearchResult itself, fieldExists(...) and fieldHasRole(...) or similar.\nOr, another approach as well, see comment further down", "author": "mario-paniccia", "createdAt": "2020-06-29T08:25:34Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java", "diffHunk": "@@ -61,25 +64,78 @@ public CaseSearchResultView execute(String caseTypeId,\n \n     private boolean itemsRequireFormatting(List<SearchResultViewHeaderGroup> headerGroups) {\n         return headerGroups.size() == 1\n-               && headerGroups.get(0).getFields().stream().anyMatch(field -> field.getDisplayContextParameter() != null);\n+            && headerGroups.get(0).getFields().stream().anyMatch(field -> field.getDisplayContextParameter() != null);\n     }\n \n     private List<SearchResultViewItem> buildItems(String useCase, CaseSearchResult caseSearchResult, String caseTypeId, List<String> requestedFields) {\n         CaseTypeDefinition caseTypeDefinition = getCaseTypeDefinition(caseTypeId);\n         SearchResult searchResultDefinition = searchResultDefinitionService.getSearchResultDefinition(caseTypeDefinition, useCase, requestedFields);\n \n         List<SearchResultViewItem> items = new ArrayList<>();\n-        // Only one case type is currently supported so we can reuse the same definitions for building all items\n-        caseSearchResult.getCases().forEach(caseDetails ->\n-            items.add(buildSearchResultViewItem(caseDetails, caseTypeDefinition, searchResultDefinition)));\n-\n+        caseSearchResult.getCases().forEach(caseDetails -> {\n+            filterResultsByAuthorisationAndUserRole(useCase, caseDetails, caseTypeId, requestedFields);\n+            items.add(buildSearchResultViewItem(caseDetails, caseTypeDefinition, searchResultDefinition));\n+        });\n         return items;\n     }\n \n-    private List<SearchResultViewHeaderGroup> buildHeaders(String caseTypeId,\n-                                                           String useCase,\n-                                                           CaseSearchResult caseSearchResult,\n-                                                           List<String> requestedFields) {\n+    private CaseDetails filterResultsByAuthorisationAndUserRole(String useCase, CaseDetails caseDetails, String caseTypeId, List<String> requestedFields) {\n+        CaseTypeDefinition caseTypeDefinition = getCaseTypeDefinition(caseTypeId);\n+        caseDetails.getData().entrySet().removeIf(\n+            caseField -> {\n+                Optional<CaseFieldDefinition> caseFieldDefinition = caseTypeDefinition.getCaseField(caseField.getKey());\n+                return !filterResultsBySearchResultsDefinition(useCase, caseTypeId, requestedFields, caseField.getKey())\n+                    || !filterResultsByAuthorisationAccessOnField(caseFieldDefinition.get());\n+            });\n+        return caseDetails;\n+    }\n+\n+\n+    private Boolean filterResultsBySearchResultsDefinition(String useCase, String caseTypeId, List<String> requestedFields, String caseFieldId) {\n+        Set<String> roles = userRepository.getUserRoles();\n+        CaseTypeDefinition caseTypeDefinition = getCaseTypeDefinition(caseTypeId);\n+        SearchResult searchResultDefinition = searchResultDefinitionService.getSearchResultDefinition(caseTypeDefinition, useCase, requestedFields);\n+        HashMap<String, String> searchFields = getSearchResultDefinitionFieldUserRoleAndField(searchResultDefinition);\n+\n+        if (useCase != null) {\n+            if (!searchFields.containsKey(caseFieldId)) {\n+                return false;\n+            }\n+            String role = searchFields.get(caseFieldId);\n+            if (role != null && !roles.contains(role)) {\n+                return false;\n+            }\n+        }", "originalCommit": "8cb22f8cef6938147363854b0e4e7d4b870bc8c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY2NjgzMw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/990#discussion_r447666833", "bodyText": "added methods to the class as requested", "author": "RebeccaBaker", "createdAt": "2020-06-30T13:07:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg1NTMyMg=="}], "type": "inlineReview", "revised_code": {"commit": "da9cc91a36347825389534ab85022eeeee5db474", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java b/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\nindex eaaac7ef4..ea276ef0a 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/domain/service/search/CaseSearchResultViewGenerator.java\n\n@@ -62,6 +61,17 @@ public class CaseSearchResultViewGenerator {\n         );\n     }\n \n+    public CaseDetails filterUnauthorisedFieldsByUseCaseAndUserRole(String useCase, CaseDetails caseDetails, String caseTypeId, List<String> requestedFields) {\n+        CaseTypeDefinition caseTypeDefinition = getCaseTypeDefinition(caseTypeId);\n+        caseDetails.getData().entrySet().removeIf(\n+            caseField -> {\n+                Optional<CaseFieldDefinition> caseFieldDefinition = caseTypeDefinition.getCaseField(caseField.getKey());\n+                return !caseSearchesViewAccessControl.filterResultsBySearchResultsDefinition(useCase, caseTypeId, requestedFields, caseField.getKey())\n+                    || !caseSearchesViewAccessControl.filterFieldByAuthorisationAccessOnField(caseFieldDefinition.get());\n+            });\n+        return caseDetails;\n+    }\n+\n     private boolean itemsRequireFormatting(List<SearchResultViewHeaderGroup> headerGroups) {\n         return headerGroups.size() == 1\n             && headerGroups.get(0).getFields().stream().anyMatch(field -> field.getDisplayContextParameter() != null);\n"}}, {"oid": "da9cc91a36347825389534ab85022eeeee5db474", "url": "https://github.com/hmcts/ccd-data-store-api/commit/da9cc91a36347825389534ab85022eeeee5db474", "message": "RDM-8782 actioned review comments", "committedDate": "2020-06-29T14:41:09Z", "type": "commit"}, {"oid": "111496fd68a128bbbec8415ed2d0de8cc7496962", "url": "https://github.com/hmcts/ccd-data-store-api/commit/111496fd68a128bbbec8415ed2d0de8cc7496962", "message": "RDM-8782 actioned review comments removed check on Read privilege as this is handled by external search endpoint", "committedDate": "2020-06-30T11:11:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY5OTIyNg==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/990#discussion_r447699226", "bodyText": "why you need to pass SearchResultDefinition? you are inside SearchResultDefinition here. Same for the other APIs", "author": "mario-paniccia", "createdAt": "2020-06-30T13:51:53Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/definition/SearchResultDefinition.java", "diffHunk": "@@ -0,0 +1,50 @@\n+package uk.gov.hmcts.ccd.domain.model.definition;\n+\n+import java.io.Serializable;\n+import java.util.*;\n+import java.util.stream.Collectors;\n+\n+import org.apache.commons.lang3.StringUtils;\n+\n+public class SearchResultDefinition implements Serializable {\n+    private SearchResultField[] fields;\n+\n+    public SearchResultField[] getFields() {\n+        return fields;\n+    }\n+\n+    public void setFields(SearchResultField[] fields) {\n+        this.fields = fields;\n+    }\n+\n+    public List<SearchResultField> getFieldsWithPaths() {\n+        return Arrays.stream(fields)\n+            .filter(f -> StringUtils.isNotBlank(f.getCaseFieldPath()))\n+            .collect(Collectors.toList());\n+    }\n+\n+    public Map<String, String> getFieldsUserRoles(SearchResultDefinition searchResultDefinition) {", "originalCommit": "111496fd68a128bbbec8415ed2d0de8cc7496962", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzcwMzMxMw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/990#discussion_r447703313", "bodyText": "good spot- agreed I have removed", "author": "RebeccaBaker", "createdAt": "2020-06-30T13:57:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY5OTIyNg=="}], "type": "inlineReview", "revised_code": {"commit": "39e67fe22c686191d2dc7ea057d96a677824192f", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/domain/model/definition/SearchResultDefinition.java b/src/main/java/uk/gov/hmcts/ccd/domain/model/definition/SearchResultDefinition.java\nindex 4c2e6c420..19ab3052d 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/domain/model/definition/SearchResultDefinition.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/domain/model/definition/SearchResultDefinition.java\n\n@@ -23,24 +23,24 @@ public class SearchResultDefinition implements Serializable {\n             .collect(Collectors.toList());\n     }\n \n-    public Map<String, String> getFieldsUserRoles(SearchResultDefinition searchResultDefinition) {\n+    public Map<String, String> getFieldsUserRoles() {\n         Map<String, String> fields = new HashMap<>();\n-        for (SearchResultField srf : searchResultDefinition.getFields()) {\n+        for (SearchResultField srf : getFields()) {\n             fields.put(srf.getCaseFieldId(), srf.getRole());\n         }\n         return fields;\n     }\n \n-    public boolean fieldExists(String caseFieldId, SearchResultDefinition searchResultDefinition) {\n-        Map<String, String> fields = getFieldsUserRoles(searchResultDefinition);\n+    public boolean fieldExists(String caseFieldId) {\n+        Map<String, String> fields = getFieldsUserRoles();\n         if (!fields.containsKey(caseFieldId)) {\n             return false;\n         }\n         return true;\n     }\n \n-    public boolean fieldHasRole(String caseFieldId, SearchResultDefinition searchResultDefinition, Set<String> roles) {\n-        Map<String, String> fields = getFieldsUserRoles(searchResultDefinition);\n+    public boolean fieldHasRole(String caseFieldId, Set<String> roles) {\n+        Map<String, String> fields = getFieldsUserRoles();\n         String role = fields.get(caseFieldId);\n         if (role != null && !roles.contains(role)) {\n             return false;\n"}}, {"oid": "39e67fe22c686191d2dc7ea057d96a677824192f", "url": "https://github.com/hmcts/ccd-data-store-api/commit/39e67fe22c686191d2dc7ea057d96a677824192f", "message": "RDM-8782 removed parameter searchResultDefinition as it was un-needed", "committedDate": "2020-06-30T13:56:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzcxMTYyNQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/990#discussion_r447711625", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (!fields.containsKey(caseFieldId)) {\n          \n          \n            \n                        return false;\n          \n          \n            \n                    }\n          \n          \n            \n                    return true;\n          \n          \n            \n                    return !fields.containsKey(caseFieldId);", "author": "mario-paniccia", "createdAt": "2020-06-30T14:08:03Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/definition/SearchResultDefinition.java", "diffHunk": "@@ -0,0 +1,50 @@\n+package uk.gov.hmcts.ccd.domain.model.definition;\n+\n+import java.io.Serializable;\n+import java.util.*;\n+import java.util.stream.Collectors;\n+\n+import org.apache.commons.lang3.StringUtils;\n+\n+public class SearchResultDefinition implements Serializable {\n+    private SearchResultField[] fields;\n+\n+    public SearchResultField[] getFields() {\n+        return fields;\n+    }\n+\n+    public void setFields(SearchResultField[] fields) {\n+        this.fields = fields;\n+    }\n+\n+    public List<SearchResultField> getFieldsWithPaths() {\n+        return Arrays.stream(fields)\n+            .filter(f -> StringUtils.isNotBlank(f.getCaseFieldPath()))\n+            .collect(Collectors.toList());\n+    }\n+\n+    public Map<String, String> getFieldsUserRoles() {\n+        Map<String, String> fields = new HashMap<>();\n+        for (SearchResultField srf : getFields()) {\n+            fields.put(srf.getCaseFieldId(), srf.getRole());\n+        }\n+        return fields;\n+    }\n+\n+    public boolean fieldExists(String caseFieldId) {\n+        Map<String, String> fields = getFieldsUserRoles();\n+        if (!fields.containsKey(caseFieldId)) {\n+            return false;\n+        }\n+        return true;", "originalCommit": "39e67fe22c686191d2dc7ea057d96a677824192f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8fd990f16831c52eb6456b32b57e45a1c1d59da4", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/domain/model/definition/SearchResultDefinition.java b/src/main/java/uk/gov/hmcts/ccd/domain/model/definition/SearchResultDefinition.java\nindex 19ab3052d..8c73ef5dd 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/domain/model/definition/SearchResultDefinition.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/domain/model/definition/SearchResultDefinition.java\n\n@@ -42,9 +42,6 @@ public class SearchResultDefinition implements Serializable {\n     public boolean fieldHasRole(String caseFieldId, Set<String> roles) {\n         Map<String, String> fields = getFieldsUserRoles();\n         String role = fields.get(caseFieldId);\n-        if (role != null && !roles.contains(role)) {\n-            return false;\n-        }\n-        return true;\n+        return (role != null && !roles.contains(role));\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzcxMjczMQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/990#discussion_r447712731", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (role != null && !roles.contains(role)) {\n          \n          \n            \n                        return false;\n          \n          \n            \n                    }\n          \n          \n            \n                    return true;\n          \n          \n            \n                    return (role != null && !roles.contains(role));", "author": "mario-paniccia", "createdAt": "2020-06-30T14:09:32Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/definition/SearchResultDefinition.java", "diffHunk": "@@ -0,0 +1,50 @@\n+package uk.gov.hmcts.ccd.domain.model.definition;\n+\n+import java.io.Serializable;\n+import java.util.*;\n+import java.util.stream.Collectors;\n+\n+import org.apache.commons.lang3.StringUtils;\n+\n+public class SearchResultDefinition implements Serializable {\n+    private SearchResultField[] fields;\n+\n+    public SearchResultField[] getFields() {\n+        return fields;\n+    }\n+\n+    public void setFields(SearchResultField[] fields) {\n+        this.fields = fields;\n+    }\n+\n+    public List<SearchResultField> getFieldsWithPaths() {\n+        return Arrays.stream(fields)\n+            .filter(f -> StringUtils.isNotBlank(f.getCaseFieldPath()))\n+            .collect(Collectors.toList());\n+    }\n+\n+    public Map<String, String> getFieldsUserRoles() {\n+        Map<String, String> fields = new HashMap<>();\n+        for (SearchResultField srf : getFields()) {\n+            fields.put(srf.getCaseFieldId(), srf.getRole());\n+        }\n+        return fields;\n+    }\n+\n+    public boolean fieldExists(String caseFieldId) {\n+        Map<String, String> fields = getFieldsUserRoles();\n+        if (!fields.containsKey(caseFieldId)) {\n+            return false;\n+        }\n+        return true;\n+    }\n+\n+    public boolean fieldHasRole(String caseFieldId, Set<String> roles) {\n+        Map<String, String> fields = getFieldsUserRoles();\n+        String role = fields.get(caseFieldId);\n+        if (role != null && !roles.contains(role)) {\n+            return false;\n+        }\n+        return true;", "originalCommit": "39e67fe22c686191d2dc7ea057d96a677824192f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8fd990f16831c52eb6456b32b57e45a1c1d59da4", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/domain/model/definition/SearchResultDefinition.java b/src/main/java/uk/gov/hmcts/ccd/domain/model/definition/SearchResultDefinition.java\nindex 19ab3052d..8c73ef5dd 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/domain/model/definition/SearchResultDefinition.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/domain/model/definition/SearchResultDefinition.java\n\n@@ -42,9 +42,6 @@ public class SearchResultDefinition implements Serializable {\n     public boolean fieldHasRole(String caseFieldId, Set<String> roles) {\n         Map<String, String> fields = getFieldsUserRoles();\n         String role = fields.get(caseFieldId);\n-        if (role != null && !roles.contains(role)) {\n-            return false;\n-        }\n-        return true;\n+        return (role != null && !roles.contains(role));\n     }\n }\n"}}, {"oid": "8fd990f16831c52eb6456b32b57e45a1c1d59da4", "url": "https://github.com/hmcts/ccd-data-store-api/commit/8fd990f16831c52eb6456b32b57e45a1c1d59da4", "message": "Update src/main/java/uk/gov/hmcts/ccd/domain/model/definition/SearchResultDefinition.java\n\nCo-authored-by: Mario Paniccia <mario.paniccia@hmcts.net>", "committedDate": "2020-06-30T14:22:00Z", "type": "commit"}, {"oid": "bc04a256c5b9d58dea21c40702a9d95271483220", "url": "https://github.com/hmcts/ccd-data-store-api/commit/bc04a256c5b9d58dea21c40702a9d95271483220", "message": "Update src/main/java/uk/gov/hmcts/ccd/domain/model/definition/SearchResultDefinition.java\n\nCo-authored-by: Mario Paniccia <mario.paniccia@hmcts.net>", "committedDate": "2020-06-30T14:22:16Z", "type": "commit"}, {"oid": "287f9f5c6d750dcfb2fd0b55fb2c750d1c364580", "url": "https://github.com/hmcts/ccd-data-store-api/commit/287f9f5c6d750dcfb2fd0b55fb2c750d1c364580", "message": "RDM-8782 fixed logic", "committedDate": "2020-06-30T15:23:50Z", "type": "commit"}]}