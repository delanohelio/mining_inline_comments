{"pr_number": 1042, "pr_title": "Rdm 2676", "pr_createdAt": "2020-08-03T15:44:27Z", "pr_url": "https://github.com/hmcts/ccd-data-store-api/pull/1042", "timeline": [{"oid": "c6c4e9606eae84532095d1755da17f10dac2afbc", "url": "https://github.com/hmcts/ccd-data-store-api/commit/c6c4e9606eae84532095d1755da17f10dac2afbc", "message": " RDM-2676: Validate CCD reference number when entered as a CaseLink\n\n    \u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-2676] (https://tools.hmcts.net/jira/browse/RDM-2676).", "committedDate": "2020-07-31T09:22:18Z", "type": "commit"}, {"oid": "2ad468d95f54e16e8eebb47b89a75cc657d45465", "url": "https://github.com/hmcts/ccd-data-store-api/commit/2ad468d95f54e16e8eebb47b89a75cc657d45465", "message": " RDM-2676: Validate CCD reference number when entered as a CaseLink\n\n    \u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-2676] (https://tools.hmcts.net/jira/browse/RDM-2676).", "committedDate": "2020-07-31T11:39:05Z", "type": "commit"}, {"oid": "2a9fb8f8f89e150fb2572df83cf5e878ca2a07b9", "url": "https://github.com/hmcts/ccd-data-store-api/commit/2a9fb8f8f89e150fb2572df83cf5e878ca2a07b9", "message": " RDM-2676: Validate CCD reference number when entered as a CaseLink\n\n    \u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-2676] (https://tools.hmcts.net/jira/browse/RDM-2676).", "committedDate": "2020-08-03T10:29:13Z", "type": "commit"}, {"oid": "bd0c7657b0556b5a9a9f2851b1bf78132ee42464", "url": "https://github.com/hmcts/ccd-data-store-api/commit/bd0c7657b0556b5a9a9f2851b1bf78132ee42464", "message": "Merge commit '494c12479ddc24adae2e892c6e873acd88cfdf0f' into HEAD", "committedDate": "2020-08-03T10:50:02Z", "type": "commit"}, {"oid": "eed559a68a9dce9361d8cce1058b295fa95cf24c", "url": "https://github.com/hmcts/ccd-data-store-api/commit/eed559a68a9dce9361d8cce1058b295fa95cf24c", "message": "Bumping chart version", "committedDate": "2020-08-03T10:50:24Z", "type": "commit"}, {"oid": "ee0bc474fcdcd3045a0a50a228ac739e5cbeeded", "url": "https://github.com/hmcts/ccd-data-store-api/commit/ee0bc474fcdcd3045a0a50a228ac739e5cbeeded", "message": "Merge branch 'develop' of github.com:hmcts/ccd-data-store-api into RDM-2676", "committedDate": "2020-08-03T11:17:45Z", "type": "commit"}, {"oid": "98c1792e49244c7ec1f1651cb86a3be6afedf5b3", "url": "https://github.com/hmcts/ccd-data-store-api/commit/98c1792e49244c7ec1f1651cb86a3be6afedf5b3", "message": "Merge branch 'RDM-2676' of github.com:hmcts/ccd-data-store-api into RDM-2676", "committedDate": "2020-08-03T11:20:41Z", "type": "commit"}, {"oid": "0c4ac8285aae262cb7afa6a5b079871302d64cfb", "url": "https://github.com/hmcts/ccd-data-store-api/commit/0c4ac8285aae262cb7afa6a5b079871302d64cfb", "message": "introduced PredefinedTypeField validator", "committedDate": "2020-08-03T13:57:12Z", "type": "commit"}, {"oid": "020ab046a41be2420b757dff4ad04d1b6d9f7ffe", "url": "https://github.com/hmcts/ccd-data-store-api/commit/020ab046a41be2420b757dff4ad04d1b6d9f7ffe", "message": "Merge remote-tracking branch 'origin/RDM-2676' into RDM-2676", "committedDate": "2020-08-03T13:57:26Z", "type": "commit"}, {"oid": "c6a8d8a1dd24c9729da040e59c0ce38edbccde29", "url": "https://github.com/hmcts/ccd-data-store-api/commit/c6a8d8a1dd24c9729da040e59c0ce38edbccde29", "message": " RDM-2676: Validate CCD reference number when entered as a CaseLink\n\n    \u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-2676] (https://tools.hmcts.net/jira/browse/RDM-2676).", "committedDate": "2020-08-03T14:43:42Z", "type": "commit"}, {"oid": "b78dd0ca26580d100ae998181b2531a3d49473f1", "url": "https://github.com/hmcts/ccd-data-store-api/commit/b78dd0ca26580d100ae998181b2531a3d49473f1", "message": "polished code", "committedDate": "2020-08-03T14:59:20Z", "type": "commit"}, {"oid": "be52bc5f1856d0791b8d63a2589ecc91507495b0", "url": "https://github.com/hmcts/ccd-data-store-api/commit/be52bc5f1856d0791b8d63a2589ecc91507495b0", "message": " RDM-2676: Validate CCD reference number when entered as a CaseLink\n\n    \u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-2676] (https://tools.hmcts.net/jira/browse/RDM-2676).", "committedDate": "2020-08-03T15:04:41Z", "type": "commit"}, {"oid": "80b838d77530a9a0884b027b891d9ade541b7cc2", "url": "https://github.com/hmcts/ccd-data-store-api/commit/80b838d77530a9a0884b027b891d9ade541b7cc2", "message": "Merge branches 'RDM-2676' and 'develop' of github.com:hmcts/ccd-data-store-api into RDM-2676", "committedDate": "2020-08-03T15:06:53Z", "type": "commit"}, {"oid": "aac225f640239f1e14af5c26ef333a5c249e5c5b", "url": "https://github.com/hmcts/ccd-data-store-api/commit/aac225f640239f1e14af5c26ef333a5c249e5c5b", "message": "polished code", "committedDate": "2020-08-03T15:09:49Z", "type": "commit"}, {"oid": "eadb4f461dadcd7f79e9b6660a5f1fb89a2112a5", "url": "https://github.com/hmcts/ccd-data-store-api/commit/eadb4f461dadcd7f79e9b6660a5f1fb89a2112a5", "message": "Merge branch 'RDM-2676' of github.com:hmcts/ccd-data-store-api into RDM-2676", "committedDate": "2020-08-03T15:15:01Z", "type": "commit"}, {"oid": "d834f25c264ee5e365e40d46b43a3f4e9b76cc61", "url": "https://github.com/hmcts/ccd-data-store-api/commit/d834f25c264ee5e365e40d46b43a3f4e9b76cc61", "message": " RDM-2676: Validate CCD reference number when entered as a CaseLink\n\n    \u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-2676] (https://tools.hmcts.net/jira/browse/RDM-2676).", "committedDate": "2020-08-03T15:41:02Z", "type": "commit"}, {"oid": "4313cd7841beb1ca7c06975e113fdf2811f40bba", "url": "https://github.com/hmcts/ccd-data-store-api/commit/4313cd7841beb1ca7c06975e113fdf2811f40bba", "message": " RDM-2676: Validate CCD reference number when entered as a CaseLink\n\n    \u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-2676] (https://tools.hmcts.net/jira/browse/RDM-2676).", "committedDate": "2020-08-04T10:11:53Z", "type": "commit"}, {"oid": "c0e8f41f71b9e083cd7838d7be1c67c33edd4468", "url": "https://github.com/hmcts/ccd-data-store-api/commit/c0e8f41f71b9e083cd7838d7be1c67c33edd4468", "message": " RDM-2676: Validate CCD reference number when entered as a CaseLink\n\n    \u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-2676] (https://tools.hmcts.net/jira/browse/RDM-2676).", "committedDate": "2020-08-04T12:04:32Z", "type": "commit"}, {"oid": "3d9639e5ac048a604fab6a4f5d4f3dbc48c0ca9b", "url": "https://github.com/hmcts/ccd-data-store-api/commit/3d9639e5ac048a604fab6a4f5d4f3dbc48c0ca9b", "message": " RDM-2676: Validate CCD reference number when entered as a CaseLink\n\n    \u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-2676] (https://tools.hmcts.net/jira/browse/RDM-2676).", "committedDate": "2020-08-04T13:58:33Z", "type": "commit"}, {"oid": "ae1f9ebd8ab6274d8105c66f8ec8fa96e723f386", "url": "https://github.com/hmcts/ccd-data-store-api/commit/ae1f9ebd8ab6274d8105c66f8ec8fa96e723f386", "message": " RDM-2676: Validate CCD reference number when entered as a CaseLink\n\n    \u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-2676] (https://tools.hmcts.net/jira/browse/RDM-2676).", "committedDate": "2020-08-04T14:35:18Z", "type": "commit"}, {"oid": "246604c997f2a50c8d6f4be344c7dba68e0cd7c9", "url": "https://github.com/hmcts/ccd-data-store-api/commit/246604c997f2a50c8d6f4be344c7dba68e0cd7c9", "message": "added method to Repository to find case without applying access control", "committedDate": "2020-08-05T12:20:22Z", "type": "commit"}, {"oid": "fb5ab54ae5f92995650169cc20784a97e423b186", "url": "https://github.com/hmcts/ccd-data-store-api/commit/fb5ab54ae5f92995650169cc20784a97e423b186", "message": "added method to Repository to find case without applying access control", "committedDate": "2020-08-05T13:13:20Z", "type": "commit"}, {"oid": "5704ba458104e9552075118b67f5a3b81c57e5ee", "url": "https://github.com/hmcts/ccd-data-store-api/commit/5704ba458104e9552075118b67f5a3b81c57e5ee", "message": " RDM-2676: Validate CCD reference number when entered as a CaseLink\n\n    \u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-2676] (https://tools.hmcts.net/jira/browse/RDM-2676).", "committedDate": "2020-08-05T13:58:47Z", "type": "commit"}, {"oid": "9fbf427576c519d654f7dd3d59b7b1de2c47933e", "url": "https://github.com/hmcts/ccd-data-store-api/commit/9fbf427576c519d654f7dd3d59b7b1de2c47933e", "message": " RDM-2676: Validate CCD reference number when entered as a CaseLink\n\n    \u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-2676] (https://tools.hmcts.net/jira/browse/RDM-2676).", "committedDate": "2020-08-05T14:24:46Z", "type": "commit"}, {"oid": "2bba37ac1bd52b7a299c7b7a7bc62995fc40e035", "url": "https://github.com/hmcts/ccd-data-store-api/commit/2bba37ac1bd52b7a299c7b7a7bc62995fc40e035", "message": " RDM-2676: Validate CCD reference number when entered as a CaseLink\n\n    \u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-2676] (https://tools.hmcts.net/jira/browse/RDM-2676).", "committedDate": "2020-08-05T15:00:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMzMjQ2NA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1042#discussion_r466332464", "bodyText": "this seems a good candidate for a utility method put in a utility class", "author": "mario-paniccia", "createdAt": "2020-08-06T10:58:24Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/types/TextCaseReferenceCaseLinkValidator.java", "diffHunk": "@@ -0,0 +1,65 @@\n+package uk.gov.hmcts.ccd.domain.types;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseFieldDefinition;\n+import uk.gov.hmcts.ccd.domain.service.common.CaseService;\n+import uk.gov.hmcts.ccd.endpoint.exceptions.ResourceNotFoundException;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+import javax.inject.Singleton;\n+import java.util.Collections;\n+import java.util.List;\n+\n+@Named(\"TextCaseReferenceCaseLinkValidator\")\n+@Singleton\n+public class TextCaseReferenceCaseLinkValidator implements PredefinedTypeFieldValidator {\n+\n+    private CaseService caseService;\n+    private TextValidator textValidator;\n+\n+    @Inject\n+    public TextCaseReferenceCaseLinkValidator(@Qualifier(\"TextValidator\") TextValidator textValidator, CaseService caseService) {\n+        this.caseService = caseService;\n+        this.textValidator = textValidator;\n+    }\n+\n+    @Override\n+    public List<ValidationResult> validate(final String dataFieldId,\n+                                           final JsonNode dataValue,\n+                                           final CaseFieldDefinition caseFieldDefinition) {\n+\n+        List<ValidationResult> validationResults = textValidator.validate(dataFieldId, dataValue, caseFieldDefinition);\n+        if (validationResults.isEmpty() && !textValidator.isNullOrEmpty(dataValue)) {\n+            final String value = dataValue.textValue();\n+            return isAnExistingCase(value, dataFieldId);\n+        }\n+        return validationResults;\n+    }\n+\n+    private List<ValidationResult> isAnExistingCase(final String value, final String dataFieldId) {\n+        try {\n+            this.caseService.getCaseDetailsByCaseReference(formatCaseReference(value));\n+            return Collections.emptyList();\n+        } catch (ResourceNotFoundException resourceNotFoundException) {\n+            return Collections.singletonList(\n+                new ValidationResult(\n+                    value + \" does not correspond to an existing CCD case. Please update before proceeding\",\n+                    dataFieldId)\n+            );\n+        }\n+    }\n+\n+    private String formatCaseReference(String caseReference) {\n+        if (caseReference.contains(\"-\")) {\n+            return String.join(\"\", caseReference.split(\"-\"));\n+        }\n+        return caseReference;\n+    }", "originalCommit": "2bba37ac1bd52b7a299c7b7a7bc62995fc40e035", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM1MDc2Mw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1042#discussion_r466350763", "bodyText": "Where is going to be the Utility Class ?  Should we inject it ?  that can cause more refactor .  let me know", "author": "Thor-tech-of-metal", "createdAt": "2020-08-06T11:37:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMzMjQ2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkzNjAxNQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1042#discussion_r466936015", "bodyText": "DONE", "author": "Thor-tech-of-metal", "createdAt": "2020-08-07T09:42:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMzMjQ2NA=="}], "type": "inlineReview", "revised_code": {"commit": "c565dfeea2255d097a326857831737a976e7ad2f", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/domain/types/TextCaseReferenceCaseLinkValidator.java b/src/main/java/uk/gov/hmcts/ccd/domain/types/TextCaseReferenceCaseLinkValidator.java\nindex 73e224c6c..9ae3eb1f8 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/domain/types/TextCaseReferenceCaseLinkValidator.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/domain/types/TextCaseReferenceCaseLinkValidator.java\n\n@@ -45,7 +45,7 @@ public class TextCaseReferenceCaseLinkValidator implements PredefinedTypeFieldVa\n         } catch (ResourceNotFoundException resourceNotFoundException) {\n             return Collections.singletonList(\n                 new ValidationResult(\n-                    value + \" does not correspond to an existing CCD case. Please update before proceeding\",\n+                    value + \" does not correspond to an existing CCD case.\",\n                     dataFieldId)\n             );\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMzMzE2MQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1042#discussion_r466333161", "bodyText": "what happens in case of other exceptions that are not ResourceNotFoundException? we should test that out and decide what happens in that case", "author": "mario-paniccia", "createdAt": "2020-08-06T10:59:50Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/types/TextCaseReferenceCaseLinkValidator.java", "diffHunk": "@@ -0,0 +1,65 @@\n+package uk.gov.hmcts.ccd.domain.types;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseFieldDefinition;\n+import uk.gov.hmcts.ccd.domain.service.common.CaseService;\n+import uk.gov.hmcts.ccd.endpoint.exceptions.ResourceNotFoundException;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+import javax.inject.Singleton;\n+import java.util.Collections;\n+import java.util.List;\n+\n+@Named(\"TextCaseReferenceCaseLinkValidator\")\n+@Singleton\n+public class TextCaseReferenceCaseLinkValidator implements PredefinedTypeFieldValidator {\n+\n+    private CaseService caseService;\n+    private TextValidator textValidator;\n+\n+    @Inject\n+    public TextCaseReferenceCaseLinkValidator(@Qualifier(\"TextValidator\") TextValidator textValidator, CaseService caseService) {\n+        this.caseService = caseService;\n+        this.textValidator = textValidator;\n+    }\n+\n+    @Override\n+    public List<ValidationResult> validate(final String dataFieldId,\n+                                           final JsonNode dataValue,\n+                                           final CaseFieldDefinition caseFieldDefinition) {\n+\n+        List<ValidationResult> validationResults = textValidator.validate(dataFieldId, dataValue, caseFieldDefinition);\n+        if (validationResults.isEmpty() && !textValidator.isNullOrEmpty(dataValue)) {\n+            final String value = dataValue.textValue();\n+            return isAnExistingCase(value, dataFieldId);\n+        }\n+        return validationResults;\n+    }\n+\n+    private List<ValidationResult> isAnExistingCase(final String value, final String dataFieldId) {\n+        try {\n+            this.caseService.getCaseDetailsByCaseReference(formatCaseReference(value));\n+            return Collections.emptyList();\n+        } catch (ResourceNotFoundException resourceNotFoundException) {", "originalCommit": "2bba37ac1bd52b7a299c7b7a7bc62995fc40e035", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM1MDE5OQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1042#discussion_r466350199", "bodyText": "There are some exception in uk.gov.hmcts.ccd.endpoint.exceptions .  1). Should we  throw BadRequestException() for unexpected errors ?   2) Log the error  and return a ValidationException() ?", "author": "Thor-tech-of-metal", "createdAt": "2020-08-06T11:36:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMzMzE2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njk4OTExOA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1042#discussion_r466989118", "bodyText": "DONE", "author": "Thor-tech-of-metal", "createdAt": "2020-08-07T11:45:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMzMzE2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njk4OTI1NQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1042#discussion_r466989255", "bodyText": "DONE", "author": "Thor-tech-of-metal", "createdAt": "2020-08-07T11:46:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMzMzE2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "c565dfeea2255d097a326857831737a976e7ad2f", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/domain/types/TextCaseReferenceCaseLinkValidator.java b/src/main/java/uk/gov/hmcts/ccd/domain/types/TextCaseReferenceCaseLinkValidator.java\nindex 73e224c6c..9ae3eb1f8 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/domain/types/TextCaseReferenceCaseLinkValidator.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/domain/types/TextCaseReferenceCaseLinkValidator.java\n\n@@ -45,7 +45,7 @@ public class TextCaseReferenceCaseLinkValidator implements PredefinedTypeFieldVa\n         } catch (ResourceNotFoundException resourceNotFoundException) {\n             return Collections.singletonList(\n                 new ValidationResult(\n-                    value + \" does not correspond to an existing CCD case. Please update before proceeding\",\n+                    value + \" does not correspond to an existing CCD case.\",\n                     dataFieldId)\n             );\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMzNDIyMQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1042#discussion_r466334221", "bodyText": "Please update before proceeding is more a UI type of error message. But this validator is supposed to be generic. I would remove that from the message", "author": "mario-paniccia", "createdAt": "2020-08-06T11:01:59Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/types/TextCaseReferenceCaseLinkValidator.java", "diffHunk": "@@ -0,0 +1,65 @@\n+package uk.gov.hmcts.ccd.domain.types;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseFieldDefinition;\n+import uk.gov.hmcts.ccd.domain.service.common.CaseService;\n+import uk.gov.hmcts.ccd.endpoint.exceptions.ResourceNotFoundException;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+import javax.inject.Singleton;\n+import java.util.Collections;\n+import java.util.List;\n+\n+@Named(\"TextCaseReferenceCaseLinkValidator\")\n+@Singleton\n+public class TextCaseReferenceCaseLinkValidator implements PredefinedTypeFieldValidator {\n+\n+    private CaseService caseService;\n+    private TextValidator textValidator;\n+\n+    @Inject\n+    public TextCaseReferenceCaseLinkValidator(@Qualifier(\"TextValidator\") TextValidator textValidator, CaseService caseService) {\n+        this.caseService = caseService;\n+        this.textValidator = textValidator;\n+    }\n+\n+    @Override\n+    public List<ValidationResult> validate(final String dataFieldId,\n+                                           final JsonNode dataValue,\n+                                           final CaseFieldDefinition caseFieldDefinition) {\n+\n+        List<ValidationResult> validationResults = textValidator.validate(dataFieldId, dataValue, caseFieldDefinition);\n+        if (validationResults.isEmpty() && !textValidator.isNullOrEmpty(dataValue)) {\n+            final String value = dataValue.textValue();\n+            return isAnExistingCase(value, dataFieldId);\n+        }\n+        return validationResults;\n+    }\n+\n+    private List<ValidationResult> isAnExistingCase(final String value, final String dataFieldId) {\n+        try {\n+            this.caseService.getCaseDetailsByCaseReference(formatCaseReference(value));\n+            return Collections.emptyList();\n+        } catch (ResourceNotFoundException resourceNotFoundException) {\n+            return Collections.singletonList(\n+                new ValidationResult(\n+                    value + \" does not correspond to an existing CCD case. Please update before proceeding\",", "originalCommit": "2bba37ac1bd52b7a299c7b7a7bc62995fc40e035", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM0NzYwMg==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1042#discussion_r466347602", "bodyText": "what is would be the final message mario ? the current one without the \"Please update before proceeding\".   The message that I added come from the ticket .  https://tools.hmcts.net/jira/browse/RDM-2676.", "author": "Thor-tech-of-metal", "createdAt": "2020-08-06T11:31:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMzNDIyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQzMDc1Mw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1042#discussion_r466430753", "bodyText": "Mario I ended up removing the \"  Please update before proceeding\".  As suggested . We need to update the ticket too.  DONE", "author": "Thor-tech-of-metal", "createdAt": "2020-08-06T13:55:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMzNDIyMQ=="}], "type": "inlineReview", "revised_code": {"commit": "c565dfeea2255d097a326857831737a976e7ad2f", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/domain/types/TextCaseReferenceCaseLinkValidator.java b/src/main/java/uk/gov/hmcts/ccd/domain/types/TextCaseReferenceCaseLinkValidator.java\nindex 73e224c6c..9ae3eb1f8 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/domain/types/TextCaseReferenceCaseLinkValidator.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/domain/types/TextCaseReferenceCaseLinkValidator.java\n\n@@ -45,7 +45,7 @@ public class TextCaseReferenceCaseLinkValidator implements PredefinedTypeFieldVa\n         } catch (ResourceNotFoundException resourceNotFoundException) {\n             return Collections.singletonList(\n                 new ValidationResult(\n-                    value + \" does not correspond to an existing CCD case. Please update before proceeding\",\n+                    value + \" does not correspond to an existing CCD case.\",\n                     dataFieldId)\n             );\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMzNDcxMw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1042#discussion_r466334713", "bodyText": "we need to add unite tests here for the unsecured case we introduced", "author": "mario-paniccia", "createdAt": "2020-08-06T11:03:03Z", "path": "src/test/java/uk/gov/hmcts/ccd/data/casedetails/query/CaseDetailsQueryBuilderFactoryTest.java", "diffHunk": "@@ -67,7 +67,7 @@ void setUp() {\n         @Test\n         @DisplayName(\"should secure new builder instance with user authorisation\")", "originalCommit": "2bba37ac1bd52b7a299c7b7a7bc62995fc40e035", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQwMjQ4NQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1042#discussion_r466402485", "bodyText": "ok \ud83d\udc4d", "author": "Thor-tech-of-metal", "createdAt": "2020-08-06T13:14:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMzNDcxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQyMzU3MA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1042#discussion_r466423570", "bodyText": "DONE", "author": "Thor-tech-of-metal", "createdAt": "2020-08-06T13:45:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMzNDcxMw=="}], "type": "inlineReview", "revised_code": {"commit": "be797e01d83b1083a8900ff3182b14477c05a32d", "chunk": "diff --git a/src/test/java/uk/gov/hmcts/ccd/data/casedetails/query/CaseDetailsQueryBuilderFactoryTest.java b/src/test/java/uk/gov/hmcts/ccd/data/casedetails/query/CaseDetailsQueryBuilderFactoryTest.java\nindex dafb50259..cbdd50108 100644\n--- a/src/test/java/uk/gov/hmcts/ccd/data/casedetails/query/CaseDetailsQueryBuilderFactoryTest.java\n+++ b/src/test/java/uk/gov/hmcts/ccd/data/casedetails/query/CaseDetailsQueryBuilderFactoryTest.java\n\n@@ -61,6 +62,14 @@ class CaseDetailsQueryBuilderFactoryTest {\n         when(query.from(CaseDetailsEntity.class)).thenReturn(root);\n     }\n \n+    private void assertAllA(CaseDetailsQueryBuilder<CaseDetailsEntity> queryBuilder) {\n+        assertAll(\n+            () -> assertThat(queryBuilder, is(notNullValue())),\n+            () -> verify(userAuthorisationSecurity).secure(queryBuilder, null),\n+            () -> verify(caseStateAuthorisationSecurity).secure(queryBuilder, null)\n+        );\n+    }\n+\n     @Nested\n     @DisplayName(\"create()\")\n     class Create {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMzNjEwMg==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1042#discussion_r466336102", "bodyText": "CaseDataValidatorTest is a generic class, should not contain tests for a specific field like this test. Le't make it more generic", "author": "mario-paniccia", "createdAt": "2020-08-06T11:06:01Z", "path": "src/test/java/uk/gov/hmcts/ccd/domain/types/CaseDataValidatorTest.java", "diffHunk": "@@ -338,6 +338,24 @@ public void invalidCollection_notObject() throws Exception {\n         assertThat(result1.getFieldId(), equalTo(\"Initials.1\"));\n     }\n \n+    @Test\n+    public void shouldFailForTextCaseReference() throws Exception {\n+        final String DATA = \"{\\n\" +\n+            \"        \\\"CaseReference\\\": \\\"1596XXXXX1048-4059XXXOOOO\\\"\\n\" +\n+            \"      }\";\n+\n+        final Map<String, JsonNode> values = MAPPER.readValue(DATA, new TypeReference<HashMap<String, JsonNode>>() {\n+        });\n+        final List<ValidationResult> results = caseDataValidator.validate(values, caseFields);\n+        assertEquals(results.toString(), 1, results.size());\n+\n+        final ValidationResult result0 = results.get(0);\n+        assertThat(result0.getFieldId(), equalTo(\"CaseReference\"));\n+        assertThat(result0.getErrorMessage(),\n+            equalTo(\"The data entered is not valid for this type of field, please delete and re-enter using only valid data\")\n+        );\n+    }", "originalCommit": "2bba37ac1bd52b7a299c7b7a7bc62995fc40e035", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQyODUwMg==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1042#discussion_r466428502", "bodyText": "mario, The current test is validating counreate text fields features.  for instance textFieldWithMaxMin  and textFieldWithInvalidMaxMin .  Should a rename my test for refer to a predefined-field ? or Should I Create a new test class for Predefined types ?", "author": "Thor-tech-of-metal", "createdAt": "2020-08-06T13:52:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMzNjEwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA4NDc5NA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1042#discussion_r467084794", "bodyText": "More test has been added . DONE", "author": "Thor-tech-of-metal", "createdAt": "2020-08-07T14:42:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMzNjEwMg=="}], "type": "inlineReview", "revised_code": {"commit": "784d7ff7dcc5d1386ab73f0d400b8f5725a0796b", "chunk": "diff --git a/src/test/java/uk/gov/hmcts/ccd/domain/types/CaseDataValidatorTest.java b/src/test/java/uk/gov/hmcts/ccd/domain/types/CaseDataValidatorTest.java\nindex 5683f70e6..9f54820be 100644\n--- a/src/test/java/uk/gov/hmcts/ccd/domain/types/CaseDataValidatorTest.java\n+++ b/src/test/java/uk/gov/hmcts/ccd/domain/types/CaseDataValidatorTest.java\n\n@@ -339,7 +347,7 @@ public class CaseDataValidatorTest extends WireMockBaseTest {\n     }\n \n     @Test\n-    public void shouldFailForTextCaseReference() throws Exception {\n+    public void shouldFailForPredefinedType() throws Exception {\n         final String DATA = \"{\\n\" +\n             \"        \\\"CaseReference\\\": \\\"1596XXXXX1048-4059XXXOOOO\\\"\\n\" +\n             \"      }\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMzNjI5NQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1042#discussion_r466336295", "bodyText": "we need to introduce more tests. We have made an important change in the class logic. Please test it well", "author": "mario-paniccia", "createdAt": "2020-08-06T11:06:28Z", "path": "src/test/java/uk/gov/hmcts/ccd/domain/types/CaseDataValidatorTest.java", "diffHunk": "@@ -338,6 +338,24 @@ public void invalidCollection_notObject() throws Exception {\n         assertThat(result1.getFieldId(), equalTo(\"Initials.1\"));", "originalCommit": "2bba37ac1bd52b7a299c7b7a7bc62995fc40e035", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA4NDMyOA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1042#discussion_r467084328", "bodyText": "DONE", "author": "Thor-tech-of-metal", "createdAt": "2020-08-07T14:41:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMzNjI5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "784d7ff7dcc5d1386ab73f0d400b8f5725a0796b", "chunk": "diff --git a/src/test/java/uk/gov/hmcts/ccd/domain/types/CaseDataValidatorTest.java b/src/test/java/uk/gov/hmcts/ccd/domain/types/CaseDataValidatorTest.java\nindex 5683f70e6..9f54820be 100644\n--- a/src/test/java/uk/gov/hmcts/ccd/domain/types/CaseDataValidatorTest.java\n+++ b/src/test/java/uk/gov/hmcts/ccd/domain/types/CaseDataValidatorTest.java\n\n@@ -339,7 +347,7 @@ public class CaseDataValidatorTest extends WireMockBaseTest {\n     }\n \n     @Test\n-    public void shouldFailForTextCaseReference() throws Exception {\n+    public void shouldFailForPredefinedType() throws Exception {\n         final String DATA = \"{\\n\" +\n             \"        \\\"CaseReference\\\": \\\"1596XXXXX1048-4059XXXOOOO\\\"\\n\" +\n             \"      }\";\n"}}, {"oid": "be797e01d83b1083a8900ff3182b14477c05a32d", "url": "https://github.com/hmcts/ccd-data-store-api/commit/be797e01d83b1083a8900ff3182b14477c05a32d", "message": " RDM-2676: Validate CCD reference number when entered as a CaseLink\n\n    \u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-2676] (https://tools.hmcts.net/jira/browse/RDM-2676).", "committedDate": "2020-08-06T13:46:46Z", "type": "commit"}, {"oid": "c565dfeea2255d097a326857831737a976e7ad2f", "url": "https://github.com/hmcts/ccd-data-store-api/commit/c565dfeea2255d097a326857831737a976e7ad2f", "message": " RDM-2676: Validate CCD reference number when entered as a CaseLink\n\n    \u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-2676] (https://tools.hmcts.net/jira/browse/RDM-2676).", "committedDate": "2020-08-06T13:58:13Z", "type": "commit"}, {"oid": "d6b6d3f199e3519daf09e21f61b4e1a2b51d1ae4", "url": "https://github.com/hmcts/ccd-data-store-api/commit/d6b6d3f199e3519daf09e21f61b4e1a2b51d1ae4", "message": " RDM-2676: Validate CCD reference number when entered as a CaseLink\n\n    \u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-2676] (https://tools.hmcts.net/jira/browse/RDM-2676).", "committedDate": "2020-08-07T10:07:49Z", "type": "commit"}, {"oid": "9d28275c557a81587765019b7128416f3d47e012", "url": "https://github.com/hmcts/ccd-data-store-api/commit/9d28275c557a81587765019b7128416f3d47e012", "message": " RDM-2676: Validate CCD reference number when entered as a CaseLink\n\n    \u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-2676] (https://tools.hmcts.net/jira/browse/RDM-2676).", "committedDate": "2020-08-07T11:47:37Z", "type": "commit"}, {"oid": "784d7ff7dcc5d1386ab73f0d400b8f5725a0796b", "url": "https://github.com/hmcts/ccd-data-store-api/commit/784d7ff7dcc5d1386ab73f0d400b8f5725a0796b", "message": " RDM-2676: Validate CCD reference number when entered as a CaseLink\n\n    \u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-2676] (https://tools.hmcts.net/jira/browse/RDM-2676).", "committedDate": "2020-08-07T14:44:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQzMzI4Nw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1042#discussion_r468433287", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class CaseReferenceUtils {\n          \n          \n            \n            public class CommonUtils {", "author": "mario-paniccia", "createdAt": "2020-08-11T09:02:09Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/common/CaseReferenceUtils.java", "diffHunk": "@@ -0,0 +1,14 @@\n+package uk.gov.hmcts.ccd.domain.model.common;\n+\n+public class CaseReferenceUtils {", "originalCommit": "784d7ff7dcc5d1386ab73f0d400b8f5725a0796b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQzMzQ4Nw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1042#discussion_r468433487", "bodyText": "possible to come up with a more descriptive name? And add a javadoc with example please", "author": "mario-paniccia", "createdAt": "2020-08-11T09:02:31Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/common/CaseReferenceUtils.java", "diffHunk": "@@ -0,0 +1,14 @@\n+package uk.gov.hmcts.ccd.domain.model.common;\n+\n+public class CaseReferenceUtils {\n+\n+    private CaseReferenceUtils() {\n+    }\n+\n+    public static String formatCaseReference(String caseReference) {", "originalCommit": "784d7ff7dcc5d1386ab73f0d400b8f5725a0796b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQzNzQ1NQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1042#discussion_r468437455", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        final String message = \"Un expected error during case link validation.\";\n          \n          \n            \n                       String message = \"Unexpected error during case link validation.\";", "author": "mario-paniccia", "createdAt": "2020-08-11T09:09:32Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/types/TextCaseReferenceCaseLinkValidator.java", "diffHunk": "@@ -0,0 +1,68 @@\n+package uk.gov.hmcts.ccd.domain.types;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseFieldDefinition;\n+import uk.gov.hmcts.ccd.domain.service.common.CaseService;\n+import uk.gov.hmcts.ccd.endpoint.exceptions.ResourceNotFoundException;\n+import uk.gov.hmcts.ccd.endpoint.exceptions.ServiceException;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+import javax.inject.Singleton;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static uk.gov.hmcts.ccd.domain.model.common.CaseReferenceUtils.formatCaseReference;\n+\n+@Named(\"TextCaseReferenceCaseLinkValidator\")\n+@Singleton\n+public class TextCaseReferenceCaseLinkValidator implements PredefinedTypeFieldValidator {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(TextCaseReferenceCaseLinkValidator.class);\n+    private CaseService caseService;\n+    private TextValidator textValidator;\n+\n+    @Inject\n+    public TextCaseReferenceCaseLinkValidator(@Qualifier(\"TextValidator\") TextValidator textValidator, CaseService caseService) {\n+        this.caseService = caseService;\n+        this.textValidator = textValidator;\n+    }\n+\n+    @Override\n+    public List<ValidationResult> validate(final String dataFieldId,\n+                                           final JsonNode dataValue,\n+                                           final CaseFieldDefinition caseFieldDefinition) {\n+\n+        List<ValidationResult> validationResults = textValidator.validate(dataFieldId, dataValue, caseFieldDefinition);\n+        if (validationResults.isEmpty() && !textValidator.isNullOrEmpty(dataValue)) {\n+            final String value = dataValue.textValue();\n+            return isAnExistingCase(value, dataFieldId);\n+        }\n+        return validationResults;\n+    }\n+\n+    private List<ValidationResult> isAnExistingCase(final String value, final String dataFieldId) {\n+        try {\n+            this.caseService.getCaseDetailsByCaseReference(formatCaseReference(value));\n+            return Collections.emptyList();\n+        } catch (ResourceNotFoundException resourceNotFoundException) {\n+            return Collections.singletonList(\n+                new ValidationResult(\n+                    value + \" does not correspond to an existing CCD case.\",\n+                    dataFieldId)\n+            );\n+        } catch (Exception exception) {\n+            final String message = \"Un expected error during case link validation.\";", "originalCommit": "784d7ff7dcc5d1386ab73f0d400b8f5725a0796b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQzNzc1OQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1042#discussion_r468437759", "bodyText": "please change your IDE setting to not add 'final' by default", "author": "mario-paniccia", "createdAt": "2020-08-11T09:10:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQzNzQ1NQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "9ef7d36de8c3979331b86fb8bf9b6b9c8a5b059f", "url": "https://github.com/hmcts/ccd-data-store-api/commit/9ef7d36de8c3979331b86fb8bf9b6b9c8a5b059f", "message": "Merge branch 'develop' of github.com:hmcts/ccd-data-store-api into RDM-2676", "committedDate": "2020-08-11T13:56:17Z", "type": "commit"}, {"oid": "8fbdfb4be0ba09f606190a8836467973303f89d1", "url": "https://github.com/hmcts/ccd-data-store-api/commit/8fbdfb4be0ba09f606190a8836467973303f89d1", "message": "Merge branch 'develop' of github.com:hmcts/ccd-data-store-api into RDM-2676", "committedDate": "2020-08-11T13:59:39Z", "type": "commit"}, {"oid": "3b9277f1406f01806e235c6dd581eeed23983f02", "url": "https://github.com/hmcts/ccd-data-store-api/commit/3b9277f1406f01806e235c6dd581eeed23983f02", "message": "Merge branch 'develop' of github.com:hmcts/ccd-data-store-api into RDM-2676", "committedDate": "2020-08-12T08:44:41Z", "type": "commit"}, {"oid": "9b1fc8e1b2618a3b8d4014cbbce738773540c9b0", "url": "https://github.com/hmcts/ccd-data-store-api/commit/9b1fc8e1b2618a3b8d4014cbbce738773540c9b0", "message": "Merge branch 'develop' of github.com:hmcts/ccd-data-store-api into RDM-2676", "committedDate": "2020-08-12T13:10:17Z", "type": "commit"}]}