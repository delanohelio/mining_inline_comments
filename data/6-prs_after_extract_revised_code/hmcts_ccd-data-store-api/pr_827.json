{"pr_number": 827, "pr_title": "RDM-7667 fix NPE when hidden field in a collection", "pr_createdAt": "2020-02-26T13:05:56Z", "pr_url": "https://github.com/hmcts/ccd-data-store-api/pull/827", "timeline": [{"oid": "cf60b884712a46f8f6ec5db9e0d6e17dff93db21", "url": "https://github.com/hmcts/ccd-data-store-api/commit/cf60b884712a46f8f6ec5db9e0d6e17dff93db21", "message": "RDM-7667 fix NPE when hidden field in a collection\n\n   [RDM-7667](https://tools.hmcts.net/jira/browse/RDM-7667)\n\nFix NullPointerException when a complex type is used inside a collection\nwhich contains a hidden field that is either a complex type or a\ncollecton.", "committedDate": "2020-02-26T13:00:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ5MDg0NA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/827#discussion_r384490844", "bodyText": "This if getting too complicated. Let's move these null checks into a separate private method:\nif (field.isCompoundFieldType() && notNulls(existingNode, newNode, field.getId()) && ....)", "author": "mario-paniccia", "createdAt": "2020-02-26T13:28:49Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/common/CompoundAccessControlService.java", "diffHunk": "@@ -133,7 +133,9 @@ private boolean isCurrentNodeOrAnyChildNodeDeletedWithoutAccess(final JsonNode n\n         if (correspondingNewNode.isPresent()) {\n             JsonNode newNode = correspondingNewNode.get();\n             for (CaseField field : caseField.getFieldType().getCollectionFieldType().getComplexFields()) {\n-                if (field.isCompoundFieldType() && existingNode.get(VALUE) != null && existingNode.get(VALUE).get(field.getId()) != null\n+                if (field.isCompoundFieldType()\n+                    && existingNode.get(VALUE) != null && existingNode.get(VALUE).get(field.getId()) != null\n+                    && newNode.get(VALUE) != null && newNode.get(VALUE).get(field.getId()) != null", "originalCommit": "cf60b884712a46f8f6ec5db9e0d6e17dff93db21", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9a8ae2715065c4977cd9dd94848e9206a8fdf649", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/domain/service/common/CompoundAccessControlService.java b/src/main/java/uk/gov/hmcts/ccd/domain/service/common/CompoundAccessControlService.java\nindex b34be3f8e..fd412d9d2 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/domain/service/common/CompoundAccessControlService.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/domain/service/common/CompoundAccessControlService.java\n\n@@ -133,9 +133,7 @@ public class CompoundAccessControlService {\n         if (correspondingNewNode.isPresent()) {\n             JsonNode newNode = correspondingNewNode.get();\n             for (CaseField field : caseField.getFieldType().getCollectionFieldType().getComplexFields()) {\n-                if (field.isCompoundFieldType()\n-                    && existingNode.get(VALUE) != null && existingNode.get(VALUE).get(field.getId()) != null\n-                    && newNode.get(VALUE) != null && newNode.get(VALUE).get(field.getId()) != null\n+                if (field.isCompoundFieldType() && existingNode.get(VALUE) != null && existingNode.get(VALUE).get(field.getId()) != null\n                     && isDeleteDeniedForChildren(existingNode.get(VALUE).get(field.getId()), newNode.get(VALUE).get(field.getId()), field, userRoles)) {\n                     currentNodeOrAnyChildNodeDeletedWithoutAccess = true;\n                     LOG.info(\"Simple child {} of {} has been deleted item but no Delete ACL\", field.getId(), caseField.getId());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ5MDk5NA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/827#discussion_r384490994", "bodyText": "Unit Tests?\nIntegration Tests?", "author": "mario-paniccia", "createdAt": "2020-02-26T13:29:07Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/common/CompoundAccessControlService.java", "diffHunk": "@@ -133,7 +133,9 @@ private boolean isCurrentNodeOrAnyChildNodeDeletedWithoutAccess(final JsonNode n\n         if (correspondingNewNode.isPresent()) {\n             JsonNode newNode = correspondingNewNode.get();\n             for (CaseField field : caseField.getFieldType().getCollectionFieldType().getComplexFields()) {", "originalCommit": "cf60b884712a46f8f6ec5db9e0d6e17dff93db21", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9a8ae2715065c4977cd9dd94848e9206a8fdf649", "chunk": "diff --git a/src/main/java/uk/gov/hmcts/ccd/domain/service/common/CompoundAccessControlService.java b/src/main/java/uk/gov/hmcts/ccd/domain/service/common/CompoundAccessControlService.java\nindex b34be3f8e..fd412d9d2 100644\n--- a/src/main/java/uk/gov/hmcts/ccd/domain/service/common/CompoundAccessControlService.java\n+++ b/src/main/java/uk/gov/hmcts/ccd/domain/service/common/CompoundAccessControlService.java\n\n@@ -133,9 +133,7 @@ public class CompoundAccessControlService {\n         if (correspondingNewNode.isPresent()) {\n             JsonNode newNode = correspondingNewNode.get();\n             for (CaseField field : caseField.getFieldType().getCollectionFieldType().getComplexFields()) {\n-                if (field.isCompoundFieldType()\n-                    && existingNode.get(VALUE) != null && existingNode.get(VALUE).get(field.getId()) != null\n-                    && newNode.get(VALUE) != null && newNode.get(VALUE).get(field.getId()) != null\n+                if (field.isCompoundFieldType() && existingNode.get(VALUE) != null && existingNode.get(VALUE).get(field.getId()) != null\n                     && isDeleteDeniedForChildren(existingNode.get(VALUE).get(field.getId()), newNode.get(VALUE).get(field.getId()), field, userRoles)) {\n                     currentNodeOrAnyChildNodeDeletedWithoutAccess = true;\n                     LOG.info(\"Simple child {} of {} has been deleted item but no Delete ACL\", field.getId(), caseField.getId());\n"}}, {"oid": "9a8ae2715065c4977cd9dd94848e9206a8fdf649", "url": "https://github.com/hmcts/ccd-data-store-api/commit/9a8ae2715065c4977cd9dd94848e9206a8fdf649", "message": "Revert \"RDM-7667 fix NPE when hidden field in a collection\"\n\nThis reverts commit cf60b884712a46f8f6ec5db9e0d6e17dff93db21.", "committedDate": "2020-02-27T11:44:55Z", "type": "commit"}, {"oid": "615339ef52802b83b64761686e1e690879dba357", "url": "https://github.com/hmcts/ccd-data-store-api/commit/615339ef52802b83b64761686e1e690879dba357", "message": "RDM-7667 fix NPE when hidden complex in collection\n\n   [RDM-7667](https://tools.hmcts.net/jira/browse/RDM-7667)\n\nFix NullPointerException when a nested complex type is used inside a\ncollection and the child complex type data is being hidden.\n\nSolution: Adjust delete permission check on complex type so it verifies\ndelete permission on current node prior to checking children (i.e. so it\ncan safely skip children if data is legitimately null).", "committedDate": "2020-02-27T12:44:23Z", "type": "commit"}, {"oid": "b49979c93959c6f6cabe5be624f5f237961c6404", "url": "https://github.com/hmcts/ccd-data-store-api/commit/b49979c93959c6f6cabe5be624f5f237961c6404", "message": "Revert \"RDM-7667 fix NPE when hidden complex in collection\"\n\nThis reverts commit 615339ef52802b83b64761686e1e690879dba357.", "committedDate": "2020-02-27T14:11:14Z", "type": "commit"}, {"oid": "6274a4b9da18dc75b689f4027515ef849231d38d", "url": "https://github.com/hmcts/ccd-data-store-api/commit/6274a4b9da18dc75b689f4027515ef849231d38d", "message": "RDM-7667 fix NPE when hidden complex in collection\n\n   [RDM-7667](https://tools.hmcts.net/jira/browse/RDM-7667)\n\nFix NullPointerException when a nested complex type is used inside a\ncollection and the child complex type data is being hidden.\n\nSolution: Adjust delete permission check on complex type to filter nulls\nin the same way it currently filters empty nodes.", "committedDate": "2020-02-27T15:00:17Z", "type": "commit"}, {"oid": "8b15957ec344cd9a34170d9093e203ecd22095f9", "url": "https://github.com/hmcts/ccd-data-store-api/commit/8b15957ec344cd9a34170d9093e203ecd22095f9", "message": "RDM-7667 add tests to improve Condition Coverage\n\n   [RDM-7667](https://tools.hmcts.net/jira/browse/RDM-7667)\n\nAdd extra tests to improve Condition Coverage on updated code to allow\npass of SonarQube gateway.", "committedDate": "2020-02-27T17:10:13Z", "type": "commit"}, {"oid": "e5732bf13313bb5b1daded8f434c6dbf82c11c42", "url": "https://github.com/hmcts/ccd-data-store-api/commit/e5732bf13313bb5b1daded8f434c6dbf82c11c42", "message": "Merge branch 'master' into RDM-7667", "committedDate": "2020-03-02T09:46:51Z", "type": "commit"}, {"oid": "8cd1586b22640615d46fb7475d0a6b1f739ad4a5", "url": "https://github.com/hmcts/ccd-data-store-api/commit/8cd1586b22640615d46fb7475d0a6b1f739ad4a5", "message": "Merge branch 'master' into RDM-7667", "committedDate": "2020-03-03T11:18:36Z", "type": "commit"}, {"oid": "2d62b67e515b00c073ef84a066925146a5d82f83", "url": "https://github.com/hmcts/ccd-data-store-api/commit/2d62b67e515b00c073ef84a066925146a5d82f83", "message": "Merge branch 'master' into RDM-7667", "committedDate": "2020-03-05T09:38:18Z", "type": "commit"}]}