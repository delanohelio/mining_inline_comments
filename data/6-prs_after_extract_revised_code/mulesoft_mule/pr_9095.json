{"pr_number": 9095, "pr_title": "MULE-18542: review + test.", "pr_createdAt": "2020-07-22T15:50:44Z", "pr_url": "https://github.com/mulesoft/mule/pull/9095", "timeline": [{"oid": "1ad0473c2b31db3b9115fa0c59fcaab00c7ce7d0", "url": "https://github.com/mulesoft/mule/commit/1ad0473c2b31db3b9115fa0c59fcaab00c7ce7d0", "message": "Added check for domains", "committedDate": "2020-07-27T15:31:58Z", "type": "forcePushed"}, {"oid": "734bd6643b253ca64fc03d121cd835b3141dd229", "url": "https://github.com/mulesoft/mule/commit/734bd6643b253ca64fc03d121cd835b3141dd229", "message": "MULE-18542: test branch.", "committedDate": "2020-07-31T15:21:06Z", "type": "commit"}, {"oid": "c5a4fd757e700ee87a6bc07b355de6ff7e82cfc7", "url": "https://github.com/mulesoft/mule/commit/c5a4fd757e700ee87a6bc07b355de6ff7e82cfc7", "message": "Review + test", "committedDate": "2020-07-31T15:21:06Z", "type": "commit"}, {"oid": "0a938d5008aa628d260a2311aa7b5e579e3e3734", "url": "https://github.com/mulesoft/mule/commit/0a938d5008aa628d260a2311aa7b5e579e3e3734", "message": "Deleted Oracle classes", "committedDate": "2020-07-31T15:21:06Z", "type": "commit"}, {"oid": "06316a68eae1a50a5001168a4d0791d4f969bb83", "url": "https://github.com/mulesoft/mule/commit/06316a68eae1a50a5001168a4d0791d4f969bb83", "message": "Refactor", "committedDate": "2020-07-31T15:21:06Z", "type": "commit"}, {"oid": "8d246ca5138d512456b4dfa307e0eeb3de598236", "url": "https://github.com/mulesoft/mule/commit/8d246ca5138d512456b4dfa307e0eeb3de598236", "message": "Fix error log", "committedDate": "2020-07-31T15:21:06Z", "type": "commit"}, {"oid": "66e8766d85a1b5aba90bba40df45cb4e3067a013", "url": "https://github.com/mulesoft/mule/commit/66e8766d85a1b5aba90bba40df45cb4e3067a013", "message": "Fix class loader verification", "committedDate": "2020-07-31T15:21:06Z", "type": "commit"}, {"oid": "71546fa148eb87af130dc1587d4c8db0989da2fb", "url": "https://github.com/mulesoft/mule/commit/71546fa148eb87af130dc1587d4c8db0989da2fb", "message": "Added oracle custom extension", "committedDate": "2020-07-31T15:21:06Z", "type": "commit"}, {"oid": "7bf5acf2b916502c7aa611f87f69a839f15dd810", "url": "https://github.com/mulesoft/mule/commit/7bf5acf2b916502c7aa611f87f69a839f15dd810", "message": "Refactor", "committedDate": "2020-07-31T15:21:06Z", "type": "commit"}, {"oid": "b7caa0c99e4dc551028ba6e7b924a24f2f805f65", "url": "https://github.com/mulesoft/mule/commit/b7caa0c99e4dc551028ba6e7b924a24f2f805f65", "message": "Added check for domains", "committedDate": "2020-07-31T15:21:06Z", "type": "commit"}, {"oid": "4c6720a6de061e463d5217a89024fd62a900ef78", "url": "https://github.com/mulesoft/mule/commit/4c6720a6de061e463d5217a89024fd62a900ef78", "message": "Refactor", "committedDate": "2020-07-31T15:21:06Z", "type": "commit"}, {"oid": "d6ac7fae101b443611d24a56ea432d6ad2457e47", "url": "https://github.com/mulesoft/mule/commit/d6ac7fae101b443611d24a56ea432d6ad2457e47", "message": "Refactor", "committedDate": "2020-07-31T15:21:06Z", "type": "commit"}, {"oid": "59766d7ac489f073949ce2071db1e79eb313a0e0", "url": "https://github.com/mulesoft/mule/commit/59766d7ac489f073949ce2071db1e79eb313a0e0", "message": "Refactor", "committedDate": "2020-07-31T15:21:06Z", "type": "commit"}, {"oid": "c152792d43464c2dd0b4474db344aef06b77a47f", "url": "https://github.com/mulesoft/mule/commit/c152792d43464c2dd0b4474db344aef06b77a47f", "message": "Review", "committedDate": "2020-07-31T15:21:06Z", "type": "commit"}, {"oid": "bc23bc7b1fe997412d67e2599c1128341e91d3af", "url": "https://github.com/mulesoft/mule/commit/bc23bc7b1fe997412d67e2599c1128341e91d3af", "message": "MULE-18542: review.", "committedDate": "2020-07-31T15:21:06Z", "type": "commit"}, {"oid": "bc23bc7b1fe997412d67e2599c1128341e91d3af", "url": "https://github.com/mulesoft/mule/commit/bc23bc7b1fe997412d67e2599c1128341e91d3af", "message": "MULE-18542: review.", "committedDate": "2020-07-31T15:21:06Z", "type": "forcePushed"}, {"oid": "4da4746ea40026d1e0a5e364d749ed7fe796a63f", "url": "https://github.com/mulesoft/mule/commit/4da4746ea40026d1e0a5e364d749ed7fe796a63f", "message": "MULE-18542: Timer threads leak on redeploy when using Oracle Driver.", "committedDate": "2020-07-31T17:17:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzc0MDUyOQ==", "url": "https://github.com/mulesoft/mule/pull/9095#discussion_r463740529", "bodyText": "Assert that the pattern only matches starting with.", "author": "nicomz", "createdAt": "2020-07-31T17:34:39Z", "path": "modules/artifact/src/main/java/org/mule/module/artifact/classloader/JdbcResourceReleaser.java", "diffHunk": "@@ -54,9 +57,10 @@\n       getBoolean(AVOID_DISPOSE_ORACLE_THREADS_PROPERTY_NAME);\n \n   public static final String DIAGNOSABILITY_BEAN_NAME = \"diagnosability\";\n-  public static final String ORACLE_DRIVER_TIMER_THREAD_NAME = \"Timer-\";\n   public static final String ORACLE_DRIVER_TIMER_THREAD_CLASS_NAME = \"TimerThread\";\n-  private final transient Logger logger = LoggerFactory.getLogger(getClass());\n+  public static final String COMPOSITE_CLASS_LOADER_CLASS_NAME = \"CompositeClassLoader\";\n+  public static final Pattern ORACLE_DRIVER_TIMER_THREAD_PATTERN = Pattern.compile(\"Timer-\\\\d+\");", "originalCommit": "4da4746ea40026d1e0a5e364d749ed7fe796a63f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "dff9e455b6938193acd19d5f468b0254bb4e812d", "chunk": "diff --git a/modules/artifact/src/main/java/org/mule/module/artifact/classloader/JdbcResourceReleaser.java b/modules/artifact/src/main/java/org/mule/module/artifact/classloader/JdbcResourceReleaser.java\nindex e2f9f886e9d..ea4b23194d4 100644\n--- a/modules/artifact/src/main/java/org/mule/module/artifact/classloader/JdbcResourceReleaser.java\n+++ b/modules/artifact/src/main/java/org/mule/module/artifact/classloader/JdbcResourceReleaser.java\n\n@@ -59,7 +59,7 @@ public class JdbcResourceReleaser implements ResourceReleaser {\n   public static final String DIAGNOSABILITY_BEAN_NAME = \"diagnosability\";\n   public static final String ORACLE_DRIVER_TIMER_THREAD_CLASS_NAME = \"TimerThread\";\n   public static final String COMPOSITE_CLASS_LOADER_CLASS_NAME = \"CompositeClassLoader\";\n-  public static final Pattern ORACLE_DRIVER_TIMER_THREAD_PATTERN = Pattern.compile(\"Timer-\\\\d+\");\n+  public static final Pattern ORACLE_DRIVER_TIMER_THREAD_PATTERN = Pattern.compile(\"^Timer-\\\\d+\");\n   private final static Logger logger = LoggerFactory.getLogger(JdbcResourceReleaser.class);\n   private static final List<String> CONNECTION_CLEANUP_THREAD_KNOWN_CLASS_ADDRESES =\n       Arrays.asList(\"com.mysql.jdbc.AbandonedConnectionCleanupThread\", \"com.mysql.cj.jdbc.AbandonedConnectionCleanupThread\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzc0MTE5Mw==", "url": "https://github.com/mulesoft/mule/pull/9095#discussion_r463741193", "bodyText": "Please put this outside the loop.", "author": "nicomz", "createdAt": "2020-07-31T17:36:02Z", "path": "modules/artifact/src/main/java/org/mule/module/artifact/classloader/JdbcResourceReleaser.java", "diffHunk": "@@ -293,52 +297,78 @@ private void disposeOracleDriverThreads() {\n \n       /* IMPORTANT: this is done to avoid metaspace OOM caused by oracle driver\n       thread leak. This is only meant to stop TimerThread threads spawned\n-      by oracle driver's HAManger class. This timer cannot be fetched\n+      by oracle driver's HAManager class. This timer cannot be fetched\n       by reflection because, in order to do so, other oracle dependencies\n       would be required.\n       * */\n       for (Thread thread : threads) {\n-        if (isThreadApplicationTimerThread(thread)) {\n+        if (isOracleTimerThread(thread)) {\n           try {\n             thread.stop();\n             thread.interrupt();\n           } catch (Throwable e) {\n             logger\n-                .debug(\"An error occurred trying to close the '\" + thread.getName() + \"' Thread. This might cause memory leaks.\",\n-                       e);\n+                .warn(\"An error occurred trying to close the '\" + thread.getName() + \"' Thread. This might cause memory leaks.\",\n+                      e);\n           }\n         }\n       }\n     } catch (Exception e) {\n-      logger.debug(e.getMessage());\n+      logger.error(\"An exception occurred while attempting to dispose of oracle timer threads: {}\", e.getMessage());\n     }\n   }\n \n-  private boolean isThreadApplicationTimerThread(Thread thread) {\n+  private boolean isOracleTimerThread(Thread thread) {\n+    ClassLoader undeployedArtifactClassLoader = this.getClass().getClassLoader();", "originalCommit": "4da4746ea40026d1e0a5e364d749ed7fe796a63f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "dff9e455b6938193acd19d5f468b0254bb4e812d", "chunk": "diff --git a/modules/artifact/src/main/java/org/mule/module/artifact/classloader/JdbcResourceReleaser.java b/modules/artifact/src/main/java/org/mule/module/artifact/classloader/JdbcResourceReleaser.java\nindex e2f9f886e9d..ea4b23194d4 100644\n--- a/modules/artifact/src/main/java/org/mule/module/artifact/classloader/JdbcResourceReleaser.java\n+++ b/modules/artifact/src/main/java/org/mule/module/artifact/classloader/JdbcResourceReleaser.java\n\n@@ -295,6 +295,8 @@ public class JdbcResourceReleaser implements ResourceReleaser {\n         return;\n       }\n \n+      ClassLoader undeployedArtifactClassLoader = this.getClass().getClassLoader();\n+\n       /* IMPORTANT: this is done to avoid metaspace OOM caused by oracle driver\n       thread leak. This is only meant to stop TimerThread threads spawned\n       by oracle driver's HAManager class. This timer cannot be fetched\n"}}, {"oid": "dff9e455b6938193acd19d5f468b0254bb4e812d", "url": "https://github.com/mulesoft/mule/commit/dff9e455b6938193acd19d5f468b0254bb4e812d", "message": "MULE-18542: Timer threads leak on redeploy when using Oracle Driver.", "committedDate": "2020-07-31T18:02:10Z", "type": "commit"}]}