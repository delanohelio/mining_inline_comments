{"pr_number": 8538, "pr_title": "MULE-17873: do not fail on runtime when metadata keys has no type res\u2026", "pr_createdAt": "2020-01-03T17:51:10Z", "pr_url": "https://github.com/mulesoft/mule/pull/8538", "timeline": [{"oid": "262b0698b04b83431ec032a93d03335005ef4073", "url": "https://github.com/mulesoft/mule/commit/262b0698b04b83431ec032a93d03335005ef4073", "message": "MULE-17873: do not fail on runtime when metadata keys has no type resolver", "committedDate": "2020-01-03T17:50:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjkwNjE0Mw==", "url": "https://github.com/mulesoft/mule/pull/8538#discussion_r362906143", "bodyText": "make this the very first condition so that mule startup doesn't go through unnecessary processing.", "author": "marianogonzalez", "createdAt": "2020-01-03T18:09:44Z", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/loader/validation/MetadataComponentModelValidator.java", "diffHunk": "@@ -144,14 +144,15 @@ private void validateResolversName(ComponentModel model, MetadataResolverFactory\n         });\n   }\n \n-  private void validateMetadataKeyId(ComponentModel model, MetadataResolverFactory resolverFactory,\n+  private void validateMetadataKeyId(ExtensionModel extensionModel, ComponentModel model, MetadataResolverFactory resolverFactory,\n                                      ProblemsReporter problemsReporter) {\n     final String modelTypeName = capitalize(getComponentModelTypeName(model));\n     Optional<MetadataKeyIdModelProperty> keyId = model.getModelProperty(MetadataKeyIdModelProperty.class);\n     if (keyId.isPresent()) {\n \n       if (resolverFactory.getOutputResolver() instanceof NullMetadataResolver\n-          && !thereIsAnInputTypeResolverDefined(getAllInputResolvers(model, resolverFactory))) {\n+          && !thereIsAnInputTypeResolverDefined(getAllInputResolvers(model, resolverFactory))\n+          && isCompileTime(extensionModel)) {", "originalCommit": "262b0698b04b83431ec032a93d03335005ef4073", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bf73bd0ab25de91179442a3eaeaebbe54b3d0cc3", "chunk": "diff --git a/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/loader/validation/MetadataComponentModelValidator.java b/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/loader/validation/MetadataComponentModelValidator.java\nindex 540960d98b7..40ab9103f48 100644\n--- a/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/loader/validation/MetadataComponentModelValidator.java\n+++ b/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/loader/validation/MetadataComponentModelValidator.java\n\n@@ -150,9 +151,10 @@ public class MetadataComponentModelValidator implements ExtensionModelValidator\n     Optional<MetadataKeyIdModelProperty> keyId = model.getModelProperty(MetadataKeyIdModelProperty.class);\n     if (keyId.isPresent()) {\n \n-      if (resolverFactory.getOutputResolver() instanceof NullMetadataResolver\n-          && !thereIsAnInputTypeResolverDefined(getAllInputResolvers(model, resolverFactory))\n-          && isCompileTime(extensionModel)) {\n+      // This validations has been fixed for runtime since 4.3.p, so we need to keep backwards compatibility somehow for now.\n+      if (isCompileTime(extensionModel)\n+          && resolverFactory.getOutputResolver() instanceof NullMetadataResolver\n+          && !thereIsAnInputTypeResolverDefined(getAllInputResolvers(model, resolverFactory))) {\n         problemsReporter.addError(new Problem(model, format(\"%s '%s' defines a MetadataKeyId parameter but neither\"\n             + \" an Output nor Type resolver that makes use of it was defined\",\n                                                             modelTypeName, model.getName())));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjkwNjQyNA==", "url": "https://github.com/mulesoft/mule/pull/8538#discussion_r362906424", "bodyText": "this looks like something we would do (or we potentially are doing) in several places. Move this to org.mule.runtime.module.extension.api.util.MuleExtensionUtils and check for other places where this code is repeated.", "author": "marianogonzalez", "createdAt": "2020-01-03T18:10:40Z", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/loader/validation/MetadataComponentModelValidator.java", "diffHunk": "@@ -350,4 +351,8 @@ private boolean shouldValidateComponentOutputMetadata(ConnectableComponentModel\n         .orElse(true);\n   }\n \n+  private boolean isCompileTime(ExtensionModel extensionModel) {", "originalCommit": "262b0698b04b83431ec032a93d03335005ef4073", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bf73bd0ab25de91179442a3eaeaebbe54b3d0cc3", "chunk": "diff --git a/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/loader/validation/MetadataComponentModelValidator.java b/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/loader/validation/MetadataComponentModelValidator.java\nindex 540960d98b7..40ab9103f48 100644\n--- a/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/loader/validation/MetadataComponentModelValidator.java\n+++ b/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/loader/validation/MetadataComponentModelValidator.java\n\n@@ -351,8 +353,4 @@ public class MetadataComponentModelValidator implements ExtensionModelValidator\n         .orElse(true);\n   }\n \n-  private boolean isCompileTime(ExtensionModel extensionModel) {\n-    return extensionModel.getModelProperty(CompileTimeModelProperty.class).isPresent();\n-  }\n-\n }\n"}}, {"oid": "bf73bd0ab25de91179442a3eaeaebbe54b3d0cc3", "url": "https://github.com/mulesoft/mule/commit/bf73bd0ab25de91179442a3eaeaebbe54b3d0cc3", "message": "PR review feedback", "committedDate": "2020-01-03T18:45:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjkyNDE4Mw==", "url": "https://github.com/mulesoft/mule/pull/8538#discussion_r362924183", "bodyText": "add @since 4.3.0", "author": "marianogonzalez", "createdAt": "2020-01-03T19:05:20Z", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/util/MuleExtensionUtils.java", "diffHunk": "@@ -474,4 +475,14 @@ public static boolean isExpression(Object value) {\n     }\n   }\n \n+  /**\n+   * Indicates if the extension model is being built on compile time.\n+   *\n+   * @param extensionModel the extension model to check\n+   * @return a boolean indicating if the the extension model is being build on runtime or not", "originalCommit": "bf73bd0ab25de91179442a3eaeaebbe54b3d0cc3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "05c4c2a5275fb3ae1e65e142a8750c29e82d44a4", "chunk": "diff --git a/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/util/MuleExtensionUtils.java b/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/util/MuleExtensionUtils.java\nindex f7a09ae038c..213f7d74921 100644\n--- a/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/util/MuleExtensionUtils.java\n+++ b/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/util/MuleExtensionUtils.java\n\n@@ -480,6 +480,7 @@ public class MuleExtensionUtils {\n    *\n    * @param extensionModel the extension model to check\n    * @return a boolean indicating if the the extension model is being build on runtime or not\n+   * @since 4.3.0\n    */\n   public static boolean isCompileTime(ExtensionModel extensionModel) {\n     return extensionModel.getModelProperty(CompileTimeModelProperty.class).isPresent();\n"}}, {"oid": "05c4c2a5275fb3ae1e65e142a8750c29e82d44a4", "url": "https://github.com/mulesoft/mule/commit/05c4c2a5275fb3ae1e65e142a8750c29e82d44a4", "message": "More PR review feedback", "committedDate": "2020-01-03T19:07:14Z", "type": "commit"}]}