{"pr_number": 9134, "pr_title": "MULE-18623: DynamicConfigurationProvider leaks configuration instances on cache eviction", "pr_createdAt": "2020-07-29T19:55:16Z", "pr_url": "https://github.com/mulesoft/mule/pull/9134", "timeline": [{"oid": "da49cb8a123d39b443b009b710256beb8aafa9a0", "url": "https://github.com/mulesoft/mule/commit/da49cb8a123d39b443b009b710256beb8aafa9a0", "message": "fix leak", "committedDate": "2020-07-29T19:54:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU1Mzc1Ng==", "url": "https://github.com/mulesoft/mule/pull/9134#discussion_r462553756", "bodyText": "why is this the problem? Who else can remove items from the cache?", "author": "marianogonzalez", "createdAt": "2020-07-29T20:02:00Z", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/config/DynamicConfigurationProvider.java", "diffHunk": "@@ -217,7 +220,6 @@ protected void registerConfiguration(ConfigurationInstance configuration) {\n   public List<ConfigurationInstance> getExpired() {\n     return cache.asMap().entrySet().stream().filter(entry -> isExpired(entry.getValue())).map(entry -> {\n       cache.invalidate(entry.getKey());\n-      unRegisterConfiguration(entry.getValue());", "originalCommit": "da49cb8a123d39b443b009b710256beb8aafa9a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU1NDIzNQ==", "url": "https://github.com/mulesoft/mule/pull/9134#discussion_r462554235", "bodyText": "There is a list in the parent class which isn't cleaned up", "author": "eze210", "createdAt": "2020-07-29T20:02:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU1Mzc1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU1NDQyNQ==", "url": "https://github.com/mulesoft/mule/pull/9134#discussion_r462554425", "bodyText": "Sorry, the cache's removalListener", "author": "eze210", "createdAt": "2020-07-29T20:03:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU1Mzc1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU1NTg0Nw==", "url": "https://github.com/mulesoft/mule/pull/9134#discussion_r462555847", "bodyText": "that's not what I asked. Your fix is to move this from here to the remove listener. My question is, why does that fix the problem? that makes sense if the item gets removed from the cache from any place other than this. Which place is that?", "author": "marianogonzalez", "createdAt": "2020-07-29T20:05:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU1Mzc1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU1ODU0NA==", "url": "https://github.com/mulesoft/mule/pull/9134#discussion_r462558544", "bodyText": "The cache has a time-based eviction policy (see expireAfterAccess(expirationPolicy.getMaxIdleTime(), expirationPolicy.getTimeUnit()) )\nIt's automatically called on cache maintenance", "author": "eze210", "createdAt": "2020-07-29T20:09:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU1Mzc1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "877320bd6118705d25112f2f50cd71dc3160814b", "chunk": "diff --git a/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/config/DynamicConfigurationProvider.java b/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/config/DynamicConfigurationProvider.java\nindex fb0424f2dfc..3e2a622fe2e 100644\n--- a/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/config/DynamicConfigurationProvider.java\n+++ b/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/config/DynamicConfigurationProvider.java\n\n@@ -216,20 +210,6 @@ public final class DynamicConfigurationProvider extends LifecycleAwareConfigurat\n     super.registerConfiguration(configuration);\n   }\n \n-  @Override\n-  public List<ConfigurationInstance> getExpired() {\n-    return cache.asMap().entrySet().stream().filter(entry -> isExpired(entry.getValue())).map(entry -> {\n-      cache.invalidate(entry.getKey());\n-      return entry.getValue();\n-    }).collect(toImmutableList());\n-  }\n-\n-  private boolean isExpired(ConfigurationInstance configuration) {\n-    ConfigurationStats stats = configuration.getStatistics();\n-    return stats.getRunningSources() == 0 && stats.getInflightOperations() == 0\n-        && expirationPolicy.isExpired(stats.getLastUsedMillis(), MILLISECONDS);\n-  }\n-\n   @Override\n   protected void doInitialise() {\n     try {\n"}}, {"oid": "877320bd6118705d25112f2f50cd71dc3160814b", "url": "https://github.com/mulesoft/mule/commit/877320bd6118705d25112f2f50cd71dc3160814b", "message": "Remove getExpired", "committedDate": "2020-07-30T14:21:35Z", "type": "commit"}]}