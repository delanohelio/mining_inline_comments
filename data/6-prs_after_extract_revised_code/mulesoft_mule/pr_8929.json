{"pr_number": 8929, "pr_title": "MULE-18493: HTTP Connector leaking sockets in state CLOSE_WAIT when client uses HTTP/1.0", "pr_createdAt": "2020-06-16T17:15:27Z", "pr_url": "https://github.com/mulesoft/mule/pull/8929", "timeline": [{"oid": "85e336db31063297623455a0ea66e66a3a13a50d", "url": "https://github.com/mulesoft/mule/commit/85e336db31063297623455a0ea66e66a3a13a50d", "message": "MULE-18493: HTTP Connector leaking sockets in state CLOSE_WAIT when client uses HTTP/1.0\n\nThe method \"doComplete\" was being called twice (and triggered a NPE) because of a workaround in the close method in the CompletionHandler needed for most HTTP 1.0 cases that do use OutputHandlers. Added a flag to prevent it from being called twice.", "committedDate": "2020-06-17T17:18:34Z", "type": "commit"}, {"oid": "be2e3ada8b13064925c6ae45dd01bf5dbe7d4f0e", "url": "https://github.com/mulesoft/mule/commit/be2e3ada8b13064925c6ae45dd01bf5dbe7d4f0e", "message": "MULE-18493: HTTP Connector leaking sockets in state CLOSE_WAIT when client uses HTTP/1.0\n\nCreated a test to reproduce the issue and verified that the solution made the test pass. It is a flow with a listener and a soap call.", "committedDate": "2020-06-17T17:18:34Z", "type": "commit"}, {"oid": "be2e3ada8b13064925c6ae45dd01bf5dbe7d4f0e", "url": "https://github.com/mulesoft/mule/commit/be2e3ada8b13064925c6ae45dd01bf5dbe7d4f0e", "message": "MULE-18493: HTTP Connector leaking sockets in state CLOSE_WAIT when client uses HTTP/1.0\n\nCreated a test to reproduce the issue and verified that the solution made the test pass. It is a flow with a listener and a soap call.", "committedDate": "2020-06-17T17:18:34Z", "type": "forcePushed"}, {"oid": "6c757d54cc25a28ce9dc86d125e14ac68f128c58", "url": "https://github.com/mulesoft/mule/commit/6c757d54cc25a28ce9dc86d125e14ac68f128c58", "message": "MULE-18493: HTTP Connector leaking sockets in state CLOSE_WAIT when client uses HTTP/1.0\n\nRenamed the test after PR to refer to the MULE more directly", "committedDate": "2020-06-17T18:38:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc1MjcwNA==", "url": "https://github.com/mulesoft/mule/pull/8929#discussion_r441752704", "bodyText": "Use an AtomicBoolean and compareAndSet", "author": "eze210", "createdAt": "2020-06-17T18:42:42Z", "path": "modules/http/src/main/java/org/mule/module/http/internal/listener/grizzly/ResponseDeferringCompletionHandler.java", "diffHunk": "@@ -98,9 +99,12 @@ public void completed(WriteResult result)\n \n   private void doComplete()\n   {\n-    responseStatusCallback.responseSendSuccessfully();\n-    ctx.notifyDownstream(RESPONSE_COMPLETE_EVENT);\n-    resume();\n+    if(!isCompleted) {", "originalCommit": "6c757d54cc25a28ce9dc86d125e14ac68f128c58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg1MzU4NQ==", "url": "https://github.com/mulesoft/mule/pull/8929#discussion_r442853585", "bodyText": "Hecho", "author": "pabloperalta", "createdAt": "2020-06-19T13:52:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc1MjcwNA=="}], "type": "inlineReview", "revised_code": {"commit": "8eb66ff63a7db797d66d81ca7f7b6f054330c14e", "chunk": "diff --git a/modules/http/src/main/java/org/mule/module/http/internal/listener/grizzly/ResponseDeferringCompletionHandler.java b/modules/http/src/main/java/org/mule/module/http/internal/listener/grizzly/ResponseDeferringCompletionHandler.java\nindex cc4ca3b9922..e931b42fc20 100644\n--- a/modules/http/src/main/java/org/mule/module/http/internal/listener/grizzly/ResponseDeferringCompletionHandler.java\n+++ b/modules/http/src/main/java/org/mule/module/http/internal/listener/grizzly/ResponseDeferringCompletionHandler.java\n\n@@ -99,8 +100,8 @@ public class ResponseDeferringCompletionHandler extends BaseResponseCompletionHa\n \n   private void doComplete()\n   {\n-    if(!isCompleted) {\n-      isCompleted = true;\n+    //If its not completed, then complete it\n+    if(isCompleted.compareAndSet(false, true)) {\n       responseStatusCallback.responseSendSuccessfully();\n       ctx.notifyDownstream(RESPONSE_COMPLETE_EVENT);\n       resume();\n"}}, {"oid": "8eb66ff63a7db797d66d81ca7f7b6f054330c14e", "url": "https://github.com/mulesoft/mule/commit/8eb66ff63a7db797d66d81ca7f7b6f054330c14e", "message": "MULE-18493: HTTP Connector leaking sockets in state CLOSE_WAIT when client uses HTTP/1.0\n\nChanged \"isCompleted\" field type to AtomicBoolean to make the fix more thread-safe", "committedDate": "2020-06-17T19:24:31Z", "type": "commit"}, {"oid": "7d697243c761c9c89b6e2ef7d5456d3cb607d0b9", "url": "https://github.com/mulesoft/mule/commit/7d697243c761c9c89b6e2ef7d5456d3cb607d0b9", "message": "Merge branch 'support/3.x' into fix/MULE-18493", "committedDate": "2020-06-23T20:36:39Z", "type": "commit"}]}