{"pr_number": 8612, "pr_title": "MULE-17994: Allow policy dispose to finish inflight events", "pr_createdAt": "2020-01-28T21:55:38Z", "pr_url": "https://github.com/mulesoft/mule/pull/8612", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE1MzU4MQ==", "url": "https://github.com/mulesoft/mule/pull/8612#discussion_r372153581", "bodyText": "Any reason to have this set?", "author": "balbifm", "createdAt": "2020-01-29T01:51:05Z", "path": "core/src/main/java/org/mule/runtime/core/internal/policy/DefaultPolicyManager.java", "diffHunk": "@@ -92,27 +105,31 @@ public static boolean isNoPolicyOperation(OperationPolicy policy) {\n \n   private Registry registry;\n \n+  private CompositePolicyFactory compositePolicyFactory = new CompositePolicyFactory();\n+\n   private final AtomicBoolean isPoliciesAvailable = new AtomicBoolean(false);\n \n-  private final Executor syncExecutor = Runnable::run;\n+  private final ReferenceQueue<DeferredDisposable> stalePoliciesQueue = new ReferenceQueue<>();\n+\n+  private final Set<WeakReference<DeferredDisposable>> activePolicies = new HashSet<>();", "originalCommit": "34a2ff14e8a6a322910ea99cdad31925a917557f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM2NjI1NA==", "url": "https://github.com/mulesoft/mule/pull/8612#discussion_r372366254", "bodyText": "added comment", "author": "elrodro83", "createdAt": "2020-01-29T12:57:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE1MzU4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "576768408c3bd3f54dfca712fdd110b1f60317dd", "chunk": "diff --git a/core/src/main/java/org/mule/runtime/core/internal/policy/DefaultPolicyManager.java b/core/src/main/java/org/mule/runtime/core/internal/policy/DefaultPolicyManager.java\nindex 203b82541a6..0f44b30bcb5 100644\n--- a/core/src/main/java/org/mule/runtime/core/internal/policy/DefaultPolicyManager.java\n+++ b/core/src/main/java/org/mule/runtime/core/internal/policy/DefaultPolicyManager.java\n\n@@ -109,9 +109,10 @@ public class DefaultPolicyManager implements PolicyManager, Lifecycle {\n \n   private final AtomicBoolean isPoliciesAvailable = new AtomicBoolean(false);\n \n+  // This set holds the references that are needed to do the dispose after the referenced policy is no longer used.\n   private final ReferenceQueue<DeferredDisposable> stalePoliciesQueue = new ReferenceQueue<>();\n \n-  private final Set<WeakReference<DeferredDisposable>> activePolicies = new HashSet<>();\n+  private final Set<DeferredDisposableWeakReference> activePolicies = new HashSet<>();\n \n   private volatile boolean stopped = true;\n   private Future taskHandle;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE1NjQ3Nw==", "url": "https://github.com/mulesoft/mule/pull/8612#discussion_r372156477", "bodyText": "Commented code", "author": "balbifm", "createdAt": "2020-01-29T02:04:06Z", "path": "core/src/main/java/org/mule/runtime/core/internal/util/rx/TransactionAwareFluxSinkSupplier.java", "diffHunk": "@@ -36,6 +42,10 @@ public TransactionAwareFluxSinkSupplier(Supplier<FluxSink<T>> sinkFactory, FluxS\n \n   @Override\n   public FluxSink<T> get() {\n+    // if (disposed) {", "originalCommit": "34a2ff14e8a6a322910ea99cdad31925a917557f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d4193801c0f9cbb307df59d239c667a13909526e", "chunk": "diff --git a/core/src/main/java/org/mule/runtime/core/internal/util/rx/TransactionAwareFluxSinkSupplier.java b/core/src/main/java/org/mule/runtime/core/internal/util/rx/TransactionAwareFluxSinkSupplier.java\nindex 44f6107f8d4..948de349ea2 100644\n--- a/core/src/main/java/org/mule/runtime/core/internal/util/rx/TransactionAwareFluxSinkSupplier.java\n+++ b/core/src/main/java/org/mule/runtime/core/internal/util/rx/TransactionAwareFluxSinkSupplier.java\n\n@@ -42,9 +45,9 @@ public class TransactionAwareFluxSinkSupplier<T> implements FluxSinkSupplier<T>\n \n   @Override\n   public FluxSink<T> get() {\n-    // if (disposed) {\n-    // throw new MuleRuntimeException(createStaticMessage(\"FluxSinkSupplier already disposed.\"));\n-    // }\n+    if (disposed) {\n+      throw new MuleRuntimeException(createStaticMessage(\"FluxSinkSupplier already disposed.\"));\n+    }\n \n     // In case of tx we need to ensure that in use of the delegate supplier there are no 2 threads trying to use the\n     // same sink. This could cause a race condition in which the second thread simply queues the event in the busy sink.\n"}}, {"oid": "d4193801c0f9cbb307df59d239c667a13909526e", "url": "https://github.com/mulesoft/mule/commit/d4193801c0f9cbb307df59d239c667a13909526e", "message": "MULE-17994: Allow policy dispose to finish inflight events", "committedDate": "2020-01-29T12:37:36Z", "type": "commit"}, {"oid": "40e0ddbae336609adde0138f9a46fcd1e15b483f", "url": "https://github.com/mulesoft/mule/commit/40e0ddbae336609adde0138f9a46fcd1e15b483f", "message": "format", "committedDate": "2020-01-29T12:37:37Z", "type": "commit"}, {"oid": "f5d2d7ebe010f22d925b77fc0898390d2308c763", "url": "https://github.com/mulesoft/mule/commit/f5d2d7ebe010f22d925b77fc0898390d2308c763", "message": "all tests!", "committedDate": "2020-01-29T12:37:38Z", "type": "commit"}, {"oid": "052166866eccf7687bfb7e1a61ff2632ea34ab44", "url": "https://github.com/mulesoft/mule/commit/052166866eccf7687bfb7e1a61ff2632ea34ab44", "message": "no check", "committedDate": "2020-01-29T12:37:39Z", "type": "commit"}, {"oid": "b21bf3798e590744609e4215a1687b7004bc33cc", "url": "https://github.com/mulesoft/mule/commit/b21bf3798e590744609e4215a1687b7004bc33cc", "message": "self-review", "committedDate": "2020-01-29T12:37:40Z", "type": "commit"}, {"oid": "d68fb89df03805bda1a8844ef94b078901b1527e", "url": "https://github.com/mulesoft/mule/commit/d68fb89df03805bda1a8844ef94b078901b1527e", "message": "more self-review", "committedDate": "2020-01-29T12:37:41Z", "type": "commit"}, {"oid": "576768408c3bd3f54dfca712fdd110b1f60317dd", "url": "https://github.com/mulesoft/mule/commit/576768408c3bd3f54dfca712fdd110b1f60317dd", "message": "review", "committedDate": "2020-01-29T12:38:54Z", "type": "commit"}, {"oid": "576768408c3bd3f54dfca712fdd110b1f60317dd", "url": "https://github.com/mulesoft/mule/commit/576768408c3bd3f54dfca712fdd110b1f60317dd", "message": "review", "committedDate": "2020-01-29T12:38:54Z", "type": "forcePushed"}, {"oid": "03bfea1ae0e7c35b0fb94d897d5332e6edb3007b", "url": "https://github.com/mulesoft/mule/commit/03bfea1ae0e7c35b0fb94d897d5332e6edb3007b", "message": "analyze flaky", "committedDate": "2020-01-29T19:43:37Z", "type": "commit"}]}