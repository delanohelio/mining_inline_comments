{"pr_number": 8885, "pr_title": "MULE-18442: Avoid creation of DefaultPolicyManager for each applied P\u2026", "pr_createdAt": "2020-05-26T16:17:31Z", "pr_url": "https://github.com/mulesoft/mule/pull/8885", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDU4NzA2Nw==", "url": "https://github.com/mulesoft/mule/pull/8885#discussion_r430587067", "bodyText": "remove this", "author": "elrodro83", "createdAt": "2020-05-26T17:33:23Z", "path": "modules/deployment/src/test/java/org/mule/runtime/module/deployment/internal/ApplicationPolicyDeploymentTestCase.java", "diffHunk": "@@ -83,6 +90,12 @@\n \n   private static File simpleExtensionJarFile;\n   private static File withErrorDeclarationExtensionJarFile;\n+\n+  @Parameterized.Parameters(name = \"Parallel: {0}\")\n+  public static List<Boolean> params() {", "originalCommit": "52c9cf00977bf4920a8f4566f52d78aa2b894e51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDU5MDgxOA==", "url": "https://github.com/mulesoft/mule/pull/8885#discussion_r430590818", "bodyText": "Don't think we should remove. We are running policy tests twice for parallel and non-parallel deployment when that does not affect policies at all.", "author": "balbifm", "createdAt": "2020-05-26T17:39:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDU4NzA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTgyNjAyMA==", "url": "https://github.com/mulesoft/mule/pull/8885#discussion_r431826020", "bodyText": "can you add that as a comment in code?", "author": "elrodro83", "createdAt": "2020-05-28T13:16:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDU4NzA2Nw=="}], "type": "inlineReview", "revised_code": {"commit": "801fd71b108bc035d416a885164c1a6549ba333b", "chunk": "diff --git a/modules/deployment/src/test/java/org/mule/runtime/module/deployment/internal/ApplicationPolicyDeploymentTestCase.java b/modules/deployment/src/test/java/org/mule/runtime/module/deployment/internal/ApplicationPolicyDeploymentTestCase.java\nindex 24056a3ef6c..9475860729a 100644\n--- a/modules/deployment/src/test/java/org/mule/runtime/module/deployment/internal/ApplicationPolicyDeploymentTestCase.java\n+++ b/modules/deployment/src/test/java/org/mule/runtime/module/deployment/internal/ApplicationPolicyDeploymentTestCase.java\n\n@@ -93,6 +93,7 @@ public class ApplicationPolicyDeploymentTestCase extends AbstractDeploymentTestC\n \n   @Parameterized.Parameters(name = \"Parallel: {0}\")\n   public static List<Boolean> params() {\n+    // Only run without parallel deployment since this configuration does not affect policy deployment at all\n     return asList(false);\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDU4NzI5Ng==", "url": "https://github.com/mulesoft/mule/pull/8885#discussion_r430587296", "bodyText": "@Issue", "author": "elrodro83", "createdAt": "2020-05-26T17:33:49Z", "path": "modules/deployment/src/test/java/org/mule/runtime/module/deployment/internal/ApplicationPolicyDeploymentTestCase.java", "diffHunk": "@@ -119,6 +132,30 @@ public void appliesApplicationPolicy() throws Exception {\n     doApplicationPolicyExecutionTest(parameters -> true, 1, POLICY_PROPERTY_VALUE);\n   }\n \n+  @Test\n+  public void applicationPolicyHasNoOpPolicyManagerInjected() throws Exception {", "originalCommit": "52c9cf00977bf4920a8f4566f52d78aa2b894e51", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1fd6903449ee21c0b89c37616911afb778dff1b3", "chunk": "diff --git a/modules/deployment/src/test/java/org/mule/runtime/module/deployment/internal/ApplicationPolicyDeploymentTestCase.java b/modules/deployment/src/test/java/org/mule/runtime/module/deployment/internal/ApplicationPolicyDeploymentTestCase.java\nindex 24056a3ef6c..99719449bc9 100644\n--- a/modules/deployment/src/test/java/org/mule/runtime/module/deployment/internal/ApplicationPolicyDeploymentTestCase.java\n+++ b/modules/deployment/src/test/java/org/mule/runtime/module/deployment/internal/ApplicationPolicyDeploymentTestCase.java\n\n@@ -132,6 +132,32 @@ public class ApplicationPolicyDeploymentTestCase extends AbstractDeploymentTestC\n     doApplicationPolicyExecutionTest(parameters -> true, 1, POLICY_PROPERTY_VALUE);\n   }\n \n+\n+  @Test\n+  @Issue(\"MULE-18433\")\n+  public void policyWithOperationAfterPolicy() throws Exception {\n+    policyManager.registerPolicyTemplate(fooPolicyFileBuilder.getArtifactFile());\n+    policyManager.registerPolicyTemplate(policyIncludingPluginFileBuilder.getArtifactFile());\n+\n+    ApplicationFileBuilder applicationFileBuilder = createExtensionApplicationWithServices(APP_WITH_EXTENSION_PLUGIN_CONFIG,\n+                                                                                           helloExtensionV1Plugin);\n+    addPackedAppFromBuilder(applicationFileBuilder);\n+\n+    startDeployment();\n+    assertApplicationDeploymentSuccess(applicationDeploymentListener, applicationFileBuilder.getId());\n+\n+    policyManager.addPolicy(applicationFileBuilder.getId(), fooPolicyFileBuilder.getArtifactId(),\n+                            new PolicyParametrization(FOO_POLICY_ID, pointparameters -> true, 1,\n+                                                      singletonMap(POLICY_PROPERTY_KEY, POLICY_PROPERTY_VALUE),\n+                                                      getResourceFile(\"/fooPolicy.xml\"), emptyList()));\n+    policyManager.addPolicy(applicationFileBuilder.getId(), policyIncludingPluginFileBuilder.getArtifactId(),\n+                            new PolicyParametrization(BAR_POLICY_ID, poinparameters -> true, 2, emptyMap(),\n+                                                      getResourceFile(\"/policyWithOperation.xml\"), emptyList()));\n+\n+    executeApplicationFlow(\"main\");\n+    assertThat(invocationCount, equalTo(2));\n+  }\n+\n   @Test\n   public void applicationPolicyHasNoOpPolicyManagerInjected() throws Exception {\n     policyManager.registerPolicyTemplate(fooPolicyFileBuilder.getArtifactFile());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDU4NzQzOA==", "url": "https://github.com/mulesoft/mule/pull/8885#discussion_r430587438", "bodyText": "remove", "author": "elrodro83", "createdAt": "2020-05-26T17:34:04Z", "path": "modules/deployment/src/test/java/org/mule/runtime/module/deployment/internal/ApplicationPolicyRedeploymentTestCase.java", "diffHunk": "@@ -35,6 +39,11 @@\n   private static final String OS_POLICY_ID = \"object-store-policy\";\n   public static final String FLOW_NAME = \"main\";\n \n+  @Parameterized.Parameters(name = \"Parallel: {0}\")\n+  public static List<Boolean> params() {", "originalCommit": "52c9cf00977bf4920a8f4566f52d78aa2b894e51", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "801fd71b108bc035d416a885164c1a6549ba333b", "chunk": "diff --git a/modules/deployment/src/test/java/org/mule/runtime/module/deployment/internal/ApplicationPolicyRedeploymentTestCase.java b/modules/deployment/src/test/java/org/mule/runtime/module/deployment/internal/ApplicationPolicyRedeploymentTestCase.java\nindex 309a7402aea..44e2f65545e 100644\n--- a/modules/deployment/src/test/java/org/mule/runtime/module/deployment/internal/ApplicationPolicyRedeploymentTestCase.java\n+++ b/modules/deployment/src/test/java/org/mule/runtime/module/deployment/internal/ApplicationPolicyRedeploymentTestCase.java\n\n@@ -41,6 +41,7 @@ public class ApplicationPolicyRedeploymentTestCase extends AbstractDeploymentTes\n \n   @Parameterized.Parameters(name = \"Parallel: {0}\")\n   public static List<Boolean> params() {\n+    // Only run without parallel deployment since this configuration does not affect policy deployment at all\n     return asList(false);\n   }\n \n"}}, {"oid": "1fd6903449ee21c0b89c37616911afb778dff1b3", "url": "https://github.com/mulesoft/mule/commit/1fd6903449ee21c0b89c37616911afb778dff1b3", "message": "MULE-18442: Avoid creation of DefaultPolicyManager for each applied Policy", "committedDate": "2020-05-26T18:15:03Z", "type": "commit"}, {"oid": "96b35a3f474b7d7949e5a7b1b07ae2d10e15b4a2", "url": "https://github.com/mulesoft/mule/commit/96b35a3f474b7d7949e5a7b1b07ae2d10e15b4a2", "message": "Add @Issue", "committedDate": "2020-05-26T18:15:03Z", "type": "commit"}, {"oid": "96b35a3f474b7d7949e5a7b1b07ae2d10e15b4a2", "url": "https://github.com/mulesoft/mule/commit/96b35a3f474b7d7949e5a7b1b07ae2d10e15b4a2", "message": "Add @Issue", "committedDate": "2020-05-26T18:15:03Z", "type": "forcePushed"}, {"oid": "801fd71b108bc035d416a885164c1a6549ba333b", "url": "https://github.com/mulesoft/mule/commit/801fd71b108bc035d416a885164c1a6549ba333b", "message": "PR fix", "committedDate": "2020-05-28T14:37:58Z", "type": "commit"}]}