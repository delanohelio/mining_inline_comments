{"pr_number": 8693, "pr_title": "MULE-18127: Provide a mechanism to disable log separation", "pr_createdAt": "2020-02-29T21:34:11Z", "pr_url": "https://github.com/mulesoft/mule/pull/8693", "timeline": [{"oid": "7ca982982950e2846e6313d6c2da1f864011b34b", "url": "https://github.com/mulesoft/mule/commit/7ca982982950e2846e6313d6c2da1f864011b34b", "message": "MULE-18127: Provide a mechanism to disable log separation\n\n* fix", "committedDate": "2020-02-29T21:32:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA2MDc3OQ==", "url": "https://github.com/mulesoft/mule/pull/8693#discussion_r386060779", "bodyText": "where is this being called?", "author": "marianogonzalez", "createdAt": "2020-02-29T22:42:30Z", "path": "modules/launcher/src/main/java/org/mule/runtime/module/launcher/log4j2/MuleLog4jContextFactory.java", "diffHunk": "@@ -53,12 +56,22 @@\n   private static final String ASYNC_LOGGER_EXCEPTION_HANDLER_PROPERTY = \"AsyncLoggerConfig.ExceptionHandler\";\n   private static final String DEFAULT_ASYNC_LOGGER_EXCEPTION_HANDLER = AsyncLoggerExceptionHandler.class.getName();\n \n+  private static final boolean LOG_SEPARATION_ENABLED = getProperty(MULE_LOG_SEPARATION_DISABLED) == null;\n+\n+  /**\n+   * Initializes using a {@link ArtifactAwareContextSelector}\n+   * <p>\n+   * Log4j tries to instantiate this class using a default constructor.\n+   */\n+  public MuleLog4jContextFactory() {", "originalCommit": "7ca982982950e2846e6313d6c2da1f864011b34b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA2Mjc3Mg==", "url": "https://github.com/mulesoft/mule/pull/8693#discussion_r386062772", "bodyText": "This happens in embedded runtime:\n java.lang.InstantiationException: org.mule.runtime.module.launcher.log4j2.MuleLog4jContextFactory\n\tat java.lang.Class.newInstance(Class.java:427)\n\tat org.apache.logging.log4j.util.LoaderUtil.newInstanceOf(LoaderUtil.java:188)\n\tat org.apache.logging.log4j.util.LoaderUtil.newInstanceOf(LoaderUtil.java:207)\n\tat org.apache.logging.log4j.util.LoaderUtil.newCheckedInstanceOf(LoaderUtil.java:228)\n\tat org.apache.logging.log4j.LogManager.<clinit>(LogManager.java:77)\n\tat org.apache.logging.log4j.spi.AbstractLoggerAdapter.getContext(AbstractLoggerAdapter.java:138)\n\tat org.apache.logging.slf4j.Log4jLoggerFactory.getContext(Log4jLoggerFactory.java:45)\n\tat org.apache.logging.log4j.spi.AbstractLoggerAdapter.getLogger(AbstractLoggerAdapter.java:48)\n\tat org.apache.logging.slf4j.Log4jLoggerFactory.getLogger(Log4jLoggerFactory.java:30)\n\tat org.slf4j.LoggerFactory.getLogger(LoggerFactory.java:363)\n\tat org.slf4j.LoggerFactory.getLogger(LoggerFactory.java:388)\n\tat org.mule.runtime.core.api.util.FileUtils.<clinit>(FileUtils.java:58)\n\tat org.mule.runtime.module.embedded.impl.EmbeddedController.setUpEnvironment(EmbeddedController.java:165)\n\tat org.mule.runtime.module.embedded.impl.EmbeddedController.start(EmbeddedController.java:77)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:498)\n\tat org.mule.runtime.module.embedded.internal.DefaultEmbeddedContainerBuilder$1.lambda$executeUsingReflection$4(DefaultEmbeddedContainerBuilder.java:283)\n\tat java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)\n\tat java.util.concurrent.FutureTask.run(FutureTask.java:266)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\n\tat java.lang.Thread.run(Thread.java:748)\nCaused by: java.lang.NoSuchMethodException: org.mule.runtime.module.launcher.log4j2.MuleLog4jContextFactory.<init>()\n\tat java.lang.Class.getConstructor0(Class.java:3082)\n\tat java.lang.Class.newInstance(Class.java:412)\n\t... 23 more```", "author": "elrodro83", "createdAt": "2020-02-29T23:21:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA2MDc3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "6b3572586c0b4c00d4ffe7d6403a5b2e6c2f48a2", "chunk": "diff --git a/modules/launcher/src/main/java/org/mule/runtime/module/launcher/log4j2/MuleLog4jContextFactory.java b/modules/launcher/src/main/java/org/mule/runtime/module/launcher/log4j2/MuleLog4jContextFactory.java\nindex bb0f5a19fcd..f8a9d867b27 100644\n--- a/modules/launcher/src/main/java/org/mule/runtime/module/launcher/log4j2/MuleLog4jContextFactory.java\n+++ b/modules/launcher/src/main/java/org/mule/runtime/module/launcher/log4j2/MuleLog4jContextFactory.java\n\n@@ -51,13 +51,13 @@ import org.apache.logging.log4j.core.util.ShutdownCallbackRegistry;\n  */\n public class MuleLog4jContextFactory extends Log4jContextFactory implements Disposable, ShutdownCallbackRegistry {\n \n+  public static final boolean LOG_SEPARATION_ENABLED = getProperty(MULE_LOG_SEPARATION_DISABLED) == null;\n+\n   private static final String LOG_CONFIGURATION_FACTORY_PROPERTY = \"log4j.configurationFactory\";\n   private static final String DEFAULT_LOG_CONFIGURATION_FACTORY = XmlConfigurationFactory.class.getName();\n   private static final String ASYNC_LOGGER_EXCEPTION_HANDLER_PROPERTY = \"AsyncLoggerConfig.ExceptionHandler\";\n   private static final String DEFAULT_ASYNC_LOGGER_EXCEPTION_HANDLER = AsyncLoggerExceptionHandler.class.getName();\n \n-  private static final boolean LOG_SEPARATION_ENABLED = getProperty(MULE_LOG_SEPARATION_DISABLED) == null;\n-\n   /**\n    * Initializes using a {@link ArtifactAwareContextSelector}\n    * <p>\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA2MDc4OA==", "url": "https://github.com/mulesoft/mule/pull/8693#discussion_r386060788", "bodyText": "The exact same condition is already evaluated in MuleContainer class. Extract.", "author": "marianogonzalez", "createdAt": "2020-02-29T22:42:50Z", "path": "modules/launcher/src/main/java/org/mule/runtime/module/launcher/log4j2/MuleLog4jContextFactory.java", "diffHunk": "@@ -53,12 +56,22 @@\n   private static final String ASYNC_LOGGER_EXCEPTION_HANDLER_PROPERTY = \"AsyncLoggerConfig.ExceptionHandler\";\n   private static final String DEFAULT_ASYNC_LOGGER_EXCEPTION_HANDLER = AsyncLoggerExceptionHandler.class.getName();\n \n+  private static final boolean LOG_SEPARATION_ENABLED = getProperty(MULE_LOG_SEPARATION_DISABLED) == null;", "originalCommit": "7ca982982950e2846e6313d6c2da1f864011b34b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6b3572586c0b4c00d4ffe7d6403a5b2e6c2f48a2", "chunk": "diff --git a/modules/launcher/src/main/java/org/mule/runtime/module/launcher/log4j2/MuleLog4jContextFactory.java b/modules/launcher/src/main/java/org/mule/runtime/module/launcher/log4j2/MuleLog4jContextFactory.java\nindex bb0f5a19fcd..f8a9d867b27 100644\n--- a/modules/launcher/src/main/java/org/mule/runtime/module/launcher/log4j2/MuleLog4jContextFactory.java\n+++ b/modules/launcher/src/main/java/org/mule/runtime/module/launcher/log4j2/MuleLog4jContextFactory.java\n\n@@ -51,13 +51,13 @@ import org.apache.logging.log4j.core.util.ShutdownCallbackRegistry;\n  */\n public class MuleLog4jContextFactory extends Log4jContextFactory implements Disposable, ShutdownCallbackRegistry {\n \n+  public static final boolean LOG_SEPARATION_ENABLED = getProperty(MULE_LOG_SEPARATION_DISABLED) == null;\n+\n   private static final String LOG_CONFIGURATION_FACTORY_PROPERTY = \"log4j.configurationFactory\";\n   private static final String DEFAULT_LOG_CONFIGURATION_FACTORY = XmlConfigurationFactory.class.getName();\n   private static final String ASYNC_LOGGER_EXCEPTION_HANDLER_PROPERTY = \"AsyncLoggerConfig.ExceptionHandler\";\n   private static final String DEFAULT_ASYNC_LOGGER_EXCEPTION_HANDLER = AsyncLoggerExceptionHandler.class.getName();\n \n-  private static final boolean LOG_SEPARATION_ENABLED = getProperty(MULE_LOG_SEPARATION_DISABLED) == null;\n-\n   /**\n    * Initializes using a {@link ArtifactAwareContextSelector}\n    * <p>\n"}}, {"oid": "6b3572586c0b4c00d4ffe7d6403a5b2e6c2f48a2", "url": "https://github.com/mulesoft/mule/commit/6b3572586c0b4c00d4ffe7d6403a5b2e6c2f48a2", "message": "review", "committedDate": "2020-02-29T23:23:04Z", "type": "commit"}]}