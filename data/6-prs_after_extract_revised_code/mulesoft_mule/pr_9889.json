{"pr_number": 9889, "pr_title": "MULE-19088: NPE executing an intercepted extension operation", "pr_createdAt": "2020-12-28T13:48:03Z", "pr_url": "https://github.com/mulesoft/mule/pull/9889", "timeline": [{"oid": "86e1f0b884f91fe08631b459538331ec21995d92", "url": "https://github.com/mulesoft/mule/commit/86e1f0b884f91fe08631b459538331ec21995d92", "message": "MULE-19088: NPE executing an intercepted extension operation", "committedDate": "2020-12-28T12:26:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ2NjU3Mg==", "url": "https://github.com/mulesoft/mule/pull/9889#discussion_r549466572", "bodyText": "should get this securityContext from updated rather than event", "author": "elrodro83", "createdAt": "2020-12-28T19:46:45Z", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/DefaultExecutionContext.java", "diffHunk": "@@ -181,8 +183,17 @@ public CoreEvent getEvent() {\n   @Override\n   public void changeEvent(CoreEvent updated) {\n     requireNonNull(event);\n-    event = updated;\n     securityContext = event.getSecurityContext();", "originalCommit": "86e1f0b884f91fe08631b459538331ec21995d92", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ3MzI5NA==", "url": "https://github.com/mulesoft/mule/pull/9889#discussion_r549473294", "bodyText": "Nice catch :)", "author": "IvanAndresFritzler", "createdAt": "2020-12-28T20:11:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ2NjU3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "620b4fc7724f90247e37b3a34b364f536061657f", "chunk": "diff --git a/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/DefaultExecutionContext.java b/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/DefaultExecutionContext.java\nindex a9794b285ab..c905ccbdf29 100644\n--- a/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/DefaultExecutionContext.java\n+++ b/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/DefaultExecutionContext.java\n\n@@ -183,8 +183,9 @@ public class DefaultExecutionContext<M extends ComponentModel> implements Execut\n   @Override\n   public void changeEvent(CoreEvent updated) {\n     requireNonNull(event);\n-    securityContext = event.getSecurityContext();\n-    // Prevents possible lack of SdkContext if this context was generated by an interceptor (see MULE-19088)\n+    securityContext = updated.getSecurityContext();\n+    // Prevents possible lack of SdkContext if this context was generated by an interceptor\n+    // (see MULE-19088, ReactiveInterceptorAdapter#setInternalParamsForNotParamResolver and ComponentMessageProcessor#shouldUsePrecalculatedContext)\n     this.getParameters().values().forEach(parameterValue -> {\n       if (parameterValue instanceof ImmutableProcessorChainExecutor) {\n         CoreEvent originalEvent = ((ImmutableProcessorChainExecutor) parameterValue).getOriginalEvent();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ2NzI4NQ==", "url": "https://github.com/mulesoft/mule/pull/9889#discussion_r549467285", "bodyText": "in the comment, point to the place in the code where the interceptor is creating the event without the context", "author": "elrodro83", "createdAt": "2020-12-28T19:49:03Z", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/DefaultExecutionContext.java", "diffHunk": "@@ -181,8 +183,17 @@ public CoreEvent getEvent() {\n   @Override\n   public void changeEvent(CoreEvent updated) {\n     requireNonNull(event);\n-    event = updated;\n     securityContext = event.getSecurityContext();\n+    // Prevents possible lack of SdkContext if this context was generated by an interceptor (see MULE-19088)", "originalCommit": "86e1f0b884f91fe08631b459538331ec21995d92", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "620b4fc7724f90247e37b3a34b364f536061657f", "chunk": "diff --git a/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/DefaultExecutionContext.java b/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/DefaultExecutionContext.java\nindex a9794b285ab..c905ccbdf29 100644\n--- a/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/DefaultExecutionContext.java\n+++ b/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/DefaultExecutionContext.java\n\n@@ -183,8 +183,9 @@ public class DefaultExecutionContext<M extends ComponentModel> implements Execut\n   @Override\n   public void changeEvent(CoreEvent updated) {\n     requireNonNull(event);\n-    securityContext = event.getSecurityContext();\n-    // Prevents possible lack of SdkContext if this context was generated by an interceptor (see MULE-19088)\n+    securityContext = updated.getSecurityContext();\n+    // Prevents possible lack of SdkContext if this context was generated by an interceptor\n+    // (see MULE-19088, ReactiveInterceptorAdapter#setInternalParamsForNotParamResolver and ComponentMessageProcessor#shouldUsePrecalculatedContext)\n     this.getParameters().values().forEach(parameterValue -> {\n       if (parameterValue instanceof ImmutableProcessorChainExecutor) {\n         CoreEvent originalEvent = ((ImmutableProcessorChainExecutor) parameterValue).getOriginalEvent();\n"}}, {"oid": "620b4fc7724f90247e37b3a34b364f536061657f", "url": "https://github.com/mulesoft/mule/commit/620b4fc7724f90247e37b3a34b364f536061657f", "message": "MULE-19088: Code review improvements", "committedDate": "2020-12-28T20:21:45Z", "type": "commit"}, {"oid": "35c518d68b75b4f9bd72f1858778ecebd751ed87", "url": "https://github.com/mulesoft/mule/commit/35c518d68b75b4f9bd72f1858778ecebd751ed87", "message": "MULE-19088: Code review improvements", "committedDate": "2020-12-29T11:49:46Z", "type": "commit"}]}