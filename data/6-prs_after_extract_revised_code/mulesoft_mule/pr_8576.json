{"pr_number": 8576, "pr_title": "MULE-17939: Operation considers applied policies regarding thread switches", "pr_createdAt": "2020-01-14T15:09:25Z", "pr_url": "https://github.com/mulesoft/mule/pull/8576", "timeline": [{"oid": "96772979c608ba37ea3c80c1ded32ea3c0e75a33", "url": "https://github.com/mulesoft/mule/commit/96772979c608ba37ea3c80c1ded32ea3c0e75a33", "message": "fixes after review", "committedDate": "2020-01-14T14:21:14Z", "type": "commit"}, {"oid": "8bf9eb654e808f6c39caf12e370b91fa7a2639b7", "url": "https://github.com/mulesoft/mule/commit/8bf9eb654e808f6c39caf12e370b91fa7a2639b7", "message": "MULE-17939: Operation considers applied policies regarding thread\nswitches\n\n* Fix tests", "committedDate": "2020-01-14T15:08:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjM5OTYyMg==", "url": "https://github.com/mulesoft/mule/pull/8576#discussion_r366399622", "bodyText": "Potencial NPE if the map has no such entry", "author": "marianogonzalez", "createdAt": "2020-01-14T15:21:25Z", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/execution/SdkInternalContext.java", "diffHunk": "@@ -39,69 +41,122 @@ public static SdkInternalContext from(CoreEvent event) {\n     return (SdkInternalContext) ((InternalEvent) event).<SdkInternalContext>getSdkInternalContext();\n   }\n \n-  private OperationExecutionParams operationExecutionParams;\n+  /*\n+   * SDK components may be nested within each other, so some of the context must be kept separately for the component it belongs\n+   * to.\n+   */\n+  private final Map<String, LocationSpecificSdkInternalContext> locationSpecificContext = new SmallMap<>();\n \n   private Function<Context, Context> innerChainSubscriberContextMapping = identity();\n \n-  private Optional<ConfigurationInstance> configuration;\n-\n-  private Map<String, Object> resolutionResult;\n+  public void clearContextForLocation(ComponentLocation location) {\n+    locationSpecificContext.remove(resolveLocation(location));\n+  }\n \n-  private OperationPolicy policyToApply;\n+  public void setConfiguration(ComponentLocation location, Optional<ConfigurationInstance> configuration) {\n+    final LocationSpecificSdkInternalContext ctx = new LocationSpecificSdkInternalContext();\n+    ctx.setConfiguration(configuration);\n+    locationSpecificContext.put(resolveLocation(location), ctx);\n+  }\n \n-  /**\n-   * @return {@code true} if the policy to be applied is a no-op, {@code false} if a policy is actually applied.\n-   */\n-  public boolean isNoPolicyOperation() {\n-    return DefaultPolicyManager.isNoPolicyOperation(getPolicyToApply());\n+  public Optional<ConfigurationInstance> getConfiguration(ComponentLocation location) {\n+    return locationSpecificContext.get(resolveLocation(location)).getConfiguration();\n   }\n \n-  public OperationExecutionParams getOperationExecutionParams() {\n-    return operationExecutionParams;\n+  public void setOperationExecutionParams(ComponentLocation location, Optional<ConfigurationInstance> configuration,\n+                                          Map<String, Object> parameters, CoreEvent operationEvent, ExecutorCallback callback) {\n+    locationSpecificContext.get(resolveLocation(location)).setOperationExecutionParams(configuration, parameters, operationEvent,\n+                                                                                       callback);", "originalCommit": "8bf9eb654e808f6c39caf12e370b91fa7a2639b7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8ac494ec530594a7b88769e00d6ce7a2438be3f1", "chunk": "diff --git a/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/execution/SdkInternalContext.java b/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/execution/SdkInternalContext.java\nindex cb44bb3c095..a832b666c8f 100644\n--- a/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/execution/SdkInternalContext.java\n+++ b/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/execution/SdkInternalContext.java\n\n@@ -53,38 +53,72 @@ public class SdkInternalContext implements EventInternalContext<SdkInternalConte\n     locationSpecificContext.remove(resolveLocation(location));\n   }\n \n+  /**\n+   * For a given location, this method has to always be called first, so the context for this location is properly initialized.\n+   *\n+   * @param location the location that the provided configuration is for.\n+   * @param configuration the configuration of the operation.\n+   */\n   public void setConfiguration(ComponentLocation location, Optional<ConfigurationInstance> configuration) {\n     final LocationSpecificSdkInternalContext ctx = new LocationSpecificSdkInternalContext();\n     ctx.setConfiguration(configuration);\n     locationSpecificContext.put(resolveLocation(location), ctx);\n   }\n \n+  /**\n+   * @throws NullPointerException if {@link #setConfiguration(ComponentLocation, Optional)} was not previously called for the\n+   *         given {@code location}.\n+   */\n   public Optional<ConfigurationInstance> getConfiguration(ComponentLocation location) {\n     return locationSpecificContext.get(resolveLocation(location)).getConfiguration();\n   }\n \n+  /**\n+   * @throws NullPointerException if {@link #setConfiguration(ComponentLocation, Optional)} was not previously called for the\n+   *         given {@code location}.\n+   */\n   public void setOperationExecutionParams(ComponentLocation location, Optional<ConfigurationInstance> configuration,\n                                           Map<String, Object> parameters, CoreEvent operationEvent, ExecutorCallback callback) {\n     locationSpecificContext.get(resolveLocation(location)).setOperationExecutionParams(configuration, parameters, operationEvent,\n                                                                                        callback);\n   }\n \n+  /**\n+   * @throws NullPointerException if {@link #setConfiguration(ComponentLocation, Optional)} was not previously called for the\n+   *         given {@code location}.\n+   */\n   public OperationExecutionParams getOperationExecutionParams(ComponentLocation location) {\n     return locationSpecificContext.get(resolveLocation(location)).getOperationExecutionParams();\n   }\n \n+  /**\n+   * @throws NullPointerException if {@link #setConfiguration(ComponentLocation, Optional)} was not previously called for the\n+   *         given {@code location}.\n+   */\n   public Map<String, Object> getResolutionResult(ComponentLocation location) {\n     return locationSpecificContext.get(resolveLocation(location)).getResolutionResult();\n   }\n \n+  /**\n+   * @throws NullPointerException if {@link #setConfiguration(ComponentLocation, Optional)} was not previously called for the\n+   *         given {@code location}.\n+   */\n   public void setResolutionResult(ComponentLocation location, Map<String, Object> resolutionResult) {\n     locationSpecificContext.get(resolveLocation(location)).setResolutionResult(resolutionResult);\n   }\n \n+  /**\n+   * @throws NullPointerException if {@link #setConfiguration(ComponentLocation, Optional)} was not previously called for the\n+   *         given {@code location}.\n+   */\n   public OperationPolicy getPolicyToApply(ComponentLocation location) {\n     return locationSpecificContext.get(resolveLocation(location)).getPolicyToApply();\n   }\n \n+  /**\n+   * @throws NullPointerException if {@link #setConfiguration(ComponentLocation, Optional)} was not previously called for the\n+   *         given {@code location}.\n+   */\n   public void setPolicyToApply(ComponentLocation location, OperationPolicy policyToApply) {\n     locationSpecificContext.get(resolveLocation(location)).setPolicyToApply(policyToApply);\n   }\n"}}, {"oid": "8ac494ec530594a7b88769e00d6ce7a2438be3f1", "url": "https://github.com/mulesoft/mule/commit/8ac494ec530594a7b88769e00d6ce7a2438be3f1", "message": "review", "committedDate": "2020-01-14T15:26:36Z", "type": "commit"}, {"oid": "40ab3c20a28c2133f6bfe9b69ad82efae3985d75", "url": "https://github.com/mulesoft/mule/commit/40ab3c20a28c2133f6bfe9b69ad82efae3985d75", "message": "stack instead of map", "committedDate": "2020-01-14T19:03:59Z", "type": "commit"}]}