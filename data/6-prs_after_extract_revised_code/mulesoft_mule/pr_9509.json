{"pr_number": 9509, "pr_title": "MULE-18777: Multiple reconnections of a source must not occur at the same time - Part 2", "pr_createdAt": "2020-10-05T20:41:00Z", "pr_url": "https://github.com/mulesoft/mule/pull/9509", "timeline": [{"oid": "3ccbb384b17d79c1c22ab6c7949f121df81d7b73", "url": "https://github.com/mulesoft/mule/commit/3ccbb384b17d79c1c22ab6c7949f121df81d7b73", "message": "Fix", "committedDate": "2020-10-05T20:04:10Z", "type": "commit"}, {"oid": "c2ee937fcee1ff0b41dbeffa8ced62440775bb6c", "url": "https://github.com/mulesoft/mule/commit/c2ee937fcee1ff0b41dbeffa8ced62440775bb6c", "message": "Remove callback", "committedDate": "2020-10-06T15:39:13Z", "type": "commit"}, {"oid": "229edf9191c294a7a2c96decc10c4a53c030ee0a", "url": "https://github.com/mulesoft/mule/commit/229edf9191c294a7a2c96decc10c4a53c030ee0a", "message": "Add test", "committedDate": "2020-10-06T16:24:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDYxNjc0Mw==", "url": "https://github.com/mulesoft/mule/pull/9509#discussion_r500616743", "bodyText": "bad usage of scheduler:\n\nYou're creating a scheduler which you never dispose\nAll scheduling should be done through the scheduling service", "author": "marianogonzalez", "createdAt": "2020-10-06T21:51:09Z", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/ExtensionMessageSource.java", "diffHunk": "@@ -323,22 +313,25 @@ public void onException(ConnectionException exception) {\n                        sourceAdapter.getName(), getLocation().getRootContainerName()),\n                 exception);\n \n-    Mono<Void> reconnectionAction = sourceAdapter.getReconnectionAction(exception)\n-        .map(p -> from(retryPolicyTemplate.applyPolicy(p, retryScheduler)))\n-        .orElseGet(() -> create(sink -> {\n-          try {\n-            exception.getConnection().ifPresent(sourceConnectionManager::invalidate);\n-            restart(new ReactiveReconnectionCallback(sink));\n-          } catch (Exception e) {\n-            sink.error(e);\n-          }\n-        }));\n-\n-    reconnectionAction\n-        .doOnSuccess(v -> onReconnectionSuccessful())\n-        .doOnError(this::onReconnectionFailed)\n-        .doAfterTerminate(() -> reconnecting.set(false))\n-        .subscribe();\n+    Executors.newSingleThreadExecutor().submit(() -> {", "originalCommit": "229edf9191c294a7a2c96decc10c4a53c030ee0a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d4488b231f05bebf18dfc2bc5e6351c9b34a6b96", "chunk": "diff --git a/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/ExtensionMessageSource.java b/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/ExtensionMessageSource.java\nindex 45ff827aa77..09d831f5240 100644\n--- a/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/ExtensionMessageSource.java\n+++ b/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/ExtensionMessageSource.java\n\n@@ -313,7 +313,7 @@ public class ExtensionMessageSource extends ExtensionComponent<SourceModel> impl\n                        sourceAdapter.getName(), getLocation().getRootContainerName()),\n                 exception);\n \n-    Executors.newSingleThreadExecutor().submit(() -> {\n+    reconnectScheduler.submit(() -> {\n       Mono<Void> reconnectionAction = sourceAdapter.getReconnectionAction(exception)\n           .map(p -> from(retryPolicyTemplate.applyPolicy(p, retryScheduler)))\n           .orElseGet(() -> create(sink -> {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDYxNzE2Mg==", "url": "https://github.com/mulesoft/mule/pull/9509#discussion_r500617162", "bodyText": "delete and use org.mule.runtime.core.internal.util.rx.ImmediateScheduler#IMMEDIATE_SCHEDULER instead", "author": "marianogonzalez", "createdAt": "2020-10-06T21:52:06Z", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/ExtensionMessageSource.java", "diffHunk": "@@ -747,4 +707,12 @@ private void stopUsingConfiguration(CoreEvent event) {\n   public String toString() {\n     return this.getClass().getSimpleName() + \": \" + Objects.toString(sourceAdapter);\n   }\n+\n+  private class ImmediateExecutor implements Executor {", "originalCommit": "229edf9191c294a7a2c96decc10c4a53c030ee0a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d4488b231f05bebf18dfc2bc5e6351c9b34a6b96", "chunk": "diff --git a/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/ExtensionMessageSource.java b/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/ExtensionMessageSource.java\nindex 45ff827aa77..09d831f5240 100644\n--- a/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/ExtensionMessageSource.java\n+++ b/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/ExtensionMessageSource.java\n\n@@ -707,12 +719,4 @@ public class ExtensionMessageSource extends ExtensionComponent<SourceModel> impl\n   public String toString() {\n     return this.getClass().getSimpleName() + \": \" + Objects.toString(sourceAdapter);\n   }\n-\n-  private class ImmediateExecutor implements Executor {\n-\n-    @Override\n-    public void execute(Runnable command) {\n-      command.run();\n-    }\n-  }\n }\n"}}, {"oid": "d4488b231f05bebf18dfc2bc5e6351c9b34a6b96", "url": "https://github.com/mulesoft/mule/commit/d4488b231f05bebf18dfc2bc5e6351c9b34a6b96", "message": "Requested changes", "committedDate": "2020-10-06T23:05:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA0MDYxNQ==", "url": "https://github.com/mulesoft/mule/pull/9509#discussion_r501040615", "bodyText": "you already have a retry scheduler. Why not reuse that one?", "author": "marianogonzalez", "createdAt": "2020-10-07T14:05:32Z", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/ExtensionMessageSource.java", "diffHunk": "@@ -149,6 +148,7 @@\n   private SourceAdapter sourceAdapter;\n   private RetryPolicyTemplate retryPolicyTemplate;\n   private Scheduler retryScheduler;\n+  private Scheduler reconnectScheduler;", "originalCommit": "d4488b231f05bebf18dfc2bc5e6351c9b34a6b96", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA1NTYxNw==", "url": "https://github.com/mulesoft/mule/pull/9509#discussion_r501055617", "bodyText": "Done", "author": "gabrieldalborgo", "createdAt": "2020-10-07T14:24:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA0MDYxNQ=="}], "type": "inlineReview", "revised_code": {"commit": "3d8f040a6dafbaa587a57877763d4578aa4aba2a", "chunk": "diff --git a/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/ExtensionMessageSource.java b/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/ExtensionMessageSource.java\nindex 09d831f5240..606f3a384b4 100644\n--- a/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/ExtensionMessageSource.java\n+++ b/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/ExtensionMessageSource.java\n\n@@ -148,7 +148,6 @@ public class ExtensionMessageSource extends ExtensionComponent<SourceModel> impl\n   private SourceAdapter sourceAdapter;\n   private RetryPolicyTemplate retryPolicyTemplate;\n   private Scheduler retryScheduler;\n-  private Scheduler reconnectScheduler;\n   // FlowConstruct is obtained when needed because during MUnit's tooling tests and Lazy Init mode this should never be evaluated.\n   private LazyValue<FlowConstruct> flowConstruct;\n   private MessageProcessContext messageProcessContext;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA0Mjc0Ng==", "url": "https://github.com/mulesoft/mule/pull/9509#discussion_r501042746", "bodyText": "to create and destroy the scheduler on each use is not a good way of handling the lifecycle", "author": "marianogonzalez", "createdAt": "2020-10-07T14:08:22Z", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/ExtensionMessageSource.java", "diffHunk": "@@ -464,6 +468,14 @@ private void stopSchedulers() {\n         retryScheduler = null;\n       }\n     }\n+\n+    if (reconnectScheduler != null) {", "originalCommit": "d4488b231f05bebf18dfc2bc5e6351c9b34a6b96", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3d8f040a6dafbaa587a57877763d4578aa4aba2a", "chunk": "diff --git a/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/ExtensionMessageSource.java b/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/ExtensionMessageSource.java\nindex 09d831f5240..606f3a384b4 100644\n--- a/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/ExtensionMessageSource.java\n+++ b/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/ExtensionMessageSource.java\n\n@@ -468,14 +463,6 @@ public class ExtensionMessageSource extends ExtensionComponent<SourceModel> impl\n         retryScheduler = null;\n       }\n     }\n-\n-    if (reconnectScheduler != null) {\n-      try {\n-        reconnectScheduler.stop();\n-      } finally {\n-        reconnectScheduler = null;\n-      }\n-    }\n   }\n \n   private void disposeSource() {\n"}}, {"oid": "3d8f040a6dafbaa587a57877763d4578aa4aba2a", "url": "https://github.com/mulesoft/mule/commit/3d8f040a6dafbaa587a57877763d4578aa4aba2a", "message": "Requested changes", "committedDate": "2020-10-07T14:23:40Z", "type": "commit"}, {"oid": "b5ff234076134a3535937065df19cf3ef3f1a833", "url": "https://github.com/mulesoft/mule/commit/b5ff234076134a3535937065df19cf3ef3f1a833", "message": "Remove unused imports", "committedDate": "2020-10-07T22:00:42Z", "type": "commit"}, {"oid": "b40a864d98d53c1b3b3c9bc1250b368d3dddd477", "url": "https://github.com/mulesoft/mule/commit/b40a864d98d53c1b3b3c9bc1250b368d3dddd477", "message": "Fix", "committedDate": "2020-10-08T00:41:26Z", "type": "commit"}, {"oid": "172ba506ee2dd25e3ef7b19d489313436b6f34a7", "url": "https://github.com/mulesoft/mule/commit/172ba506ee2dd25e3ef7b19d489313436b6f34a7", "message": "Add 2 tests around reconnection", "committedDate": "2020-10-08T01:15:52Z", "type": "commit"}]}