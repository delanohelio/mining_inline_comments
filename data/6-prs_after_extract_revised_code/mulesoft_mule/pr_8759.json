{"pr_number": 8759, "pr_title": "MULE-18227: NPE with scatter-gather within parallel-foreach", "pr_createdAt": "2020-03-27T15:36:06Z", "pr_url": "https://github.com/mulesoft/mule/pull/8759", "timeline": [{"oid": "1e9c04e6c5a75baaf711ab5cff012345464420fe", "url": "https://github.com/mulesoft/mule/commit/1e9c04e6c5a75baaf711ab5cff012345464420fe", "message": "MULE-18227: NPE with scatter-gather within parallel-foreach", "committedDate": "2020-03-27T15:34:41Z", "type": "commit"}, {"oid": "8b7b02edae63240d17fc6589a7b5b4d15f8da051", "url": "https://github.com/mulesoft/mule/commit/8b7b02edae63240d17fc6589a7b5b4d15f8da051", "message": "unit test", "committedDate": "2020-03-27T15:44:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM4Njg4OA==", "url": "https://github.com/mulesoft/mule/pull/8759#discussion_r399386888", "bodyText": "Mmmmm... shouldn't a ConcurrentHashMap be faster than a SmallMap synchronized like this?", "author": "marianogonzalez", "createdAt": "2020-03-27T16:24:45Z", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/execution/SdkInternalContext.java", "diffHunk": "@@ -46,16 +48,17 @@ public static SdkInternalContext from(CoreEvent event) {\n    * SDK components may be nested within each other, so some of the context must be kept separately for the component it belongs\n    * to.\n    */\n-  private final Map<ComponentLocation, LocationSpecificSdkInternalContext> locationSpecificContext = new SmallMap<>();\n+  private final Map<Pair<ComponentLocation, String>, LocationSpecificSdkInternalContext> locationSpecificContext =", "originalCommit": "8b7b02edae63240d17fc6589a7b5b4d15f8da051", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f7128d7334befd380a00a150c1ac9c04abac44b9", "chunk": "diff --git a/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/execution/SdkInternalContext.java b/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/execution/SdkInternalContext.java\nindex ab1b1ffb168..ad4518bc7a6 100644\n--- a/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/execution/SdkInternalContext.java\n+++ b/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/execution/SdkInternalContext.java\n\n@@ -49,16 +48,16 @@ public class SdkInternalContext implements EventInternalContext<SdkInternalConte\n    * to.\n    */\n   private final Map<Pair<ComponentLocation, String>, LocationSpecificSdkInternalContext> locationSpecificContext =\n-      synchronizedMap(new SmallMap<>());\n+      new ConcurrentHashMap<>();\n \n   private Function<Context, Context> innerChainSubscriberContextMapping = identity();\n \n-  public void removeContext(Pair<ComponentLocation, String> locationAndEventId) {\n-    locationSpecificContext.remove(locationAndEventId);\n+  public void removeContext(ComponentLocation location, String eventId) {\n+    locationSpecificContext.remove(new Pair<>(location, eventId));\n   }\n \n-  public void putContext(Pair<ComponentLocation, String> locationAndEventId) {\n-    locationSpecificContext.put(locationAndEventId, new LocationSpecificSdkInternalContext());\n+  public void putContext(ComponentLocation location, String eventId) {\n+    locationSpecificContext.put(new Pair<>(location, eventId), new LocationSpecificSdkInternalContext());\n   }\n \n   /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM4ODU0OA==", "url": "https://github.com/mulesoft/mule/pull/8759#discussion_r399388548", "bodyText": "I think that a specific class should be created for this rather than a Pair", "author": "marianogonzalez", "createdAt": "2020-03-27T16:27:21Z", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/execution/SdkInternalContext.java", "diffHunk": "@@ -46,16 +48,17 @@ public static SdkInternalContext from(CoreEvent event) {\n    * SDK components may be nested within each other, so some of the context must be kept separately for the component it belongs\n    * to.\n    */\n-  private final Map<ComponentLocation, LocationSpecificSdkInternalContext> locationSpecificContext = new SmallMap<>();\n+  private final Map<Pair<ComponentLocation, String>, LocationSpecificSdkInternalContext> locationSpecificContext =\n+      synchronizedMap(new SmallMap<>());\n \n   private Function<Context, Context> innerChainSubscriberContextMapping = identity();\n \n-  public void removeContext(ComponentLocation location) {\n-    locationSpecificContext.remove(location);\n+  public void removeContext(Pair<ComponentLocation, String> locationAndEventId) {", "originalCommit": "8b7b02edae63240d17fc6589a7b5b4d15f8da051", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f7128d7334befd380a00a150c1ac9c04abac44b9", "chunk": "diff --git a/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/execution/SdkInternalContext.java b/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/execution/SdkInternalContext.java\nindex ab1b1ffb168..ad4518bc7a6 100644\n--- a/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/execution/SdkInternalContext.java\n+++ b/modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/execution/SdkInternalContext.java\n\n@@ -49,16 +48,16 @@ public class SdkInternalContext implements EventInternalContext<SdkInternalConte\n    * to.\n    */\n   private final Map<Pair<ComponentLocation, String>, LocationSpecificSdkInternalContext> locationSpecificContext =\n-      synchronizedMap(new SmallMap<>());\n+      new ConcurrentHashMap<>();\n \n   private Function<Context, Context> innerChainSubscriberContextMapping = identity();\n \n-  public void removeContext(Pair<ComponentLocation, String> locationAndEventId) {\n-    locationSpecificContext.remove(locationAndEventId);\n+  public void removeContext(ComponentLocation location, String eventId) {\n+    locationSpecificContext.remove(new Pair<>(location, eventId));\n   }\n \n-  public void putContext(Pair<ComponentLocation, String> locationAndEventId) {\n-    locationSpecificContext.put(locationAndEventId, new LocationSpecificSdkInternalContext());\n+  public void putContext(ComponentLocation location, String eventId) {\n+    locationSpecificContext.put(new Pair<>(location, eventId), new LocationSpecificSdkInternalContext());\n   }\n \n   /**\n"}}, {"oid": "f7128d7334befd380a00a150c1ac9c04abac44b9", "url": "https://github.com/mulesoft/mule/commit/f7128d7334befd380a00a150c1ac9c04abac44b9", "message": "review", "committedDate": "2020-03-27T16:40:50Z", "type": "commit"}]}