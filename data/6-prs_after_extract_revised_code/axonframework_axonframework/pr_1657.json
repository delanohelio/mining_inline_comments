{"pr_number": 1657, "pr_title": "[#1588] Automatic @Revision-based SnapshotFilter", "pr_createdAt": "2020-12-29T17:22:20Z", "pr_url": "https://github.com/AxonFramework/AxonFramework/pull/1657", "timeline": [{"oid": "dc6c084fdd152c997a1954450f1c4620d996a4e3", "url": "https://github.com/AxonFramework/AxonFramework/commit/dc6c084fdd152c997a1954450f1c4620d996a4e3", "message": "Add Revision based SnapshotFilter\n\nIntroduce a RevisionSnapshotFilter, which based on a given allowed\nrevision can filter out DomainEventData entries which contain that\nrevision\n\n#1588", "committedDate": "2020-12-29T16:38:17Z", "type": "commit"}, {"oid": "92203c326e2c87d3144199a6cdab4e93bff42935", "url": "https://github.com/AxonFramework/AxonFramework/commit/92203c326e2c87d3144199a6cdab4e93bff42935", "message": "Create RevisionSnapshotFilter if Revision is present\n\nWhen constructing the AggregateConfigurer, check if the aggregate Class\ncontains the Revision annotation. If it does, use the revision attribute\n on the annotation to create a RevisionSnapshotFilter as the\n SnapshotFilter for this aggregate\n\n#1588", "committedDate": "2020-12-29T17:14:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTAyMjYxNw==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1657#discussion_r555022617", "bodyText": "Wouldn't this change break backwards compatibility? I'd opt for finding a way to toggle this feature instead of using it by default.", "author": "m1l4n54v1c", "createdAt": "2021-01-11T12:47:06Z", "path": "config/src/main/java/org/axonframework/config/AggregateConfigurer.java", "diffHunk": "@@ -178,7 +182,13 @@ protected AggregateConfigurer(Class<A> aggregate) {\n         );\n         snapshotTriggerDefinition = new Component<>(() -> parent, name(\"snapshotTriggerDefinition\"),\n                                                     c -> NoSnapshotTriggerDefinition.INSTANCE);\n-        snapshotFilter = new Component<>(() -> parent, name(\"snapshotFilter\"), c -> SnapshotFilter.allowAll());\n+        snapshotFilter = new Component<>(() -> parent, name(\"snapshotFilter\"), c -> {\n+            Optional<String> revisionValue =\n+                    AnnotationUtils.findAnnotationAttribute(aggregate, Revision.class, \"revision\");\n+            return revisionValue.isPresent()\n+                    ? new RevisionSnapshotFilter(revisionValue.get())", "originalCommit": "92203c326e2c87d3144199a6cdab4e93bff42935", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTAyOTQzNQ==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1657#discussion_r555029435", "bodyText": "There was no reason to put the @Revision on an Aggregate until now. The only thing is will \"break\", is that now the default is to look at the revision of the aggregate to validate whether a snapshot is suitable for that Aggregate. If that alters any behavior, it will cause an aggregate to be streamed from its entire past events for a single time, whereafter a new snapshot is created.", "author": "abuijze", "createdAt": "2021-01-11T12:59:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTAyMjYxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTA0NzkxMw==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1657#discussion_r555047913", "bodyText": "Ah, it wasn't used. Please disregard my comment then :)", "author": "m1l4n54v1c", "createdAt": "2021-01-11T13:32:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTAyMjYxNw=="}], "type": "inlineReview", "revised_code": null}]}