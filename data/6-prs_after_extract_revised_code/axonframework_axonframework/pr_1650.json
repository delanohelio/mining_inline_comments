{"pr_number": 1650, "pr_title": "[#1647] Replace CI Services for Test Containers", "pr_createdAt": "2020-12-21T13:39:01Z", "pr_url": "https://github.com/AxonFramework/AxonFramework/pull/1650", "timeline": [{"oid": "cde7e78650dc7ffcdd9b7d57c081dce7b6c2f071", "url": "https://github.com/AxonFramework/AxonFramework/commit/cde7e78650dc7ffcdd9b7d57c081dce7b6c2f071", "message": "Introduce mysql test container\n\nIntroduce a mysql test container to replace the expectation of MySQL\nrunning in the background during tests\n\n#1647", "committedDate": "2020-12-21T13:16:53Z", "type": "commit"}, {"oid": "26c6b372df0a19ae457944d37da1185f43b93a2f", "url": "https://github.com/AxonFramework/AxonFramework/commit/26c6b372df0a19ae457944d37da1185f43b93a2f", "message": "Add test containers version to properties\n\nAdd the test containers version used to the properties section in the\nmain pom\n\n#1647", "committedDate": "2020-12-21T13:17:35Z", "type": "commit"}, {"oid": "6e6aa96620d2b48db8f985f01970207ce1b8f19f", "url": "https://github.com/AxonFramework/AxonFramework/commit/6e6aa96620d2b48db8f985f01970207ce1b8f19f", "message": "Introduce Oracle test container\n\nIntroduce an Oracle test container to replace the expectation of\nOracle11g/OracleXE running in the background during tests\n\n#1647", "committedDate": "2020-12-21T13:18:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njc3NTIxMA==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1650#discussion_r546775210", "bodyText": "With current approach we should be able to remove this try-catch block, right?\nSame applies for the other 2 tests.", "author": "lfgcampos", "createdAt": "2020-12-21T15:39:12Z", "path": "eventsourcing/src/test/java/org/axonframework/eventsourcing/eventstore/jdbc/MysqlJdbcEventStorageEngineTest.java", "diffHunk": "@@ -36,56 +37,58 @@\n  *\n  * @author Albert Attard (JavaCreed)\n  */\n+@Testcontainers\n class MysqlJdbcEventStorageEngineTest {\n \n-    private MysqlDataSource dataSource;\n+    @Container\n+    private static final MySQLContainer<?> MYSQL_CONTAINER = new MySQLContainer<>(\"mysql\")\n+            .withDatabaseName(\"axon\")\n+            .withUsername(\"admin\")\n+            .withPassword(\"some-password\");\n+\n     private JdbcEventStorageEngine testSubject;\n \n     @BeforeEach\n-    void setUp() throws Exception {\n-        /* Load the DB properties */\n-        final Properties properties = new Properties();\n-        properties.load(getClass().getResourceAsStream(\"/mysql.test.database.properties\"));\n-\n-        dataSource = new MysqlDataSource();\n-        dataSource.setUrl(properties.getProperty(\"jdbc.url\"));\n-        dataSource.setUser(properties.getProperty(\"jdbc.username\"));\n-        dataSource.setPassword(properties.getProperty(\"jdbc.password\"));\n+    void setUp() {\n+        MysqlDataSource dataSource = new MysqlDataSource();\n+        dataSource.setUrl(MYSQL_CONTAINER.getJdbcUrl());\n+        dataSource.setUser(MYSQL_CONTAINER.getUsername());\n+        dataSource.setPassword(MYSQL_CONTAINER.getPassword());\n         try {\n-            testSubject = createEngine(new SQLErrorCodesResolver(dataSource));\n+            testSubject = createEngine(dataSource);\n         } catch (Exception e) {\n             throw new TestAbortedException(\"Ignoring this test, as no valid MySQL instance is configured\", e);", "originalCommit": "6e6aa96620d2b48db8f985f01970207ce1b8f19f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM3NjA4NQ==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1650#discussion_r547376085", "bodyText": "Sure, let's put some more trust in test containers!", "author": "smcvb", "createdAt": "2020-12-22T16:31:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njc3NTIxMA=="}], "type": "inlineReview", "revised_code": {"commit": "0276949973877024eba894a5096d0dde9a258047", "chunk": "diff --git a/eventsourcing/src/test/java/org/axonframework/eventsourcing/eventstore/jdbc/MysqlJdbcEventStorageEngineTest.java b/eventsourcing/src/test/java/org/axonframework/eventsourcing/eventstore/jdbc/MysqlJdbcEventStorageEngineTest.java\nindex 5221f661c..014b7fc18 100644\n--- a/eventsourcing/src/test/java/org/axonframework/eventsourcing/eventstore/jdbc/MysqlJdbcEventStorageEngineTest.java\n+++ b/eventsourcing/src/test/java/org/axonframework/eventsourcing/eventstore/jdbc/MysqlJdbcEventStorageEngineTest.java\n\n@@ -49,16 +48,12 @@\n     private JdbcEventStorageEngine testSubject;\n \n     @BeforeEach\n-    void setUp() {\n+    void setUp() throws SQLException {\n         MysqlDataSource dataSource = new MysqlDataSource();\n         dataSource.setUrl(MYSQL_CONTAINER.getJdbcUrl());\n         dataSource.setUser(MYSQL_CONTAINER.getUsername());\n         dataSource.setPassword(MYSQL_CONTAINER.getPassword());\n-        try {\n-            testSubject = createEngine(dataSource);\n-        } catch (Exception e) {\n-            throw new TestAbortedException(\"Ignoring this test, as no valid MySQL instance is configured\", e);\n-        }\n+        testSubject = createEngine(dataSource);\n     }\n \n     /**\n"}}, {"oid": "0276949973877024eba894a5096d0dde9a258047", "url": "https://github.com/AxonFramework/AxonFramework/commit/0276949973877024eba894a5096d0dde9a258047", "message": "Remove try-catch blocks when creating a connection\n\nTest containers should simply succeed, so we can remove the try-catch\naround the connection creation in the test\n\n#1647", "committedDate": "2020-12-22T16:32:20Z", "type": "commit"}, {"oid": "08b7d53192afce227f9b615c5c08ea78f22b2a2e", "url": "https://github.com/AxonFramework/AxonFramework/commit/08b7d53192afce227f9b615c5c08ea78f22b2a2e", "message": "Add env setting to Oracle container\n\nDefine that the Oracle-XE container should not set the timezone with\nregion info, as github actions do not start a container with region\ninformation\n\n#1647", "committedDate": "2020-12-22T17:09:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQwOTIwNw==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1650#discussion_r547409207", "bodyText": "You have to set it on the connection (few lines below, on setUp)", "author": "lfgcampos", "createdAt": "2020-12-22T17:37:05Z", "path": "integrationtests/src/test/java/org/axonframework/integrationtests/eventsourcing/eventstore/jdbc/Oracle11EventTableFactoryTest.java", "diffHunk": "@@ -18,32 +18,43 @@\n \n import org.axonframework.eventsourcing.eventstore.jdbc.EventSchema;\n import org.axonframework.eventsourcing.eventstore.jdbc.Oracle11EventTableFactory;\n-import org.junit.jupiter.api.AfterEach;\n-import org.junit.jupiter.api.BeforeEach;\n-import org.junit.jupiter.api.Test;\n-import org.opentest4j.TestAbortedException;\n+import org.junit.jupiter.api.*;\n+import org.testcontainers.containers.OracleContainer;\n+import org.testcontainers.junit.jupiter.Container;\n+import org.testcontainers.junit.jupiter.Testcontainers;\n \n import java.sql.Connection;\n import java.sql.DriverManager;\n import java.sql.SQLException;\n \n import static org.axonframework.common.io.IOUtils.closeQuietly;\n \n+/**\n+ * Integration test class validating the {@link Oracle11EventTableFactory}.\n+ *\n+ * @author Joris van der Kallen\n+ */\n+@SuppressWarnings({\"SqlDialectInspection\", \"SqlNoDataSourceInspection\"})\n+@Testcontainers\n class Oracle11EventTableFactoryTest {\n \n+    private static final String USERNAME = \"system\";\n+    private static final String PASSWORD = \"oracle\";\n+\n+    @Container\n+    private static final OracleContainer ORACLE_CONTAINER = new OracleContainer(\"gautamsaggar/oracle11g:v2\")\n+            //Disable oracle.jdbc.timezoneAsRegion as when on true GHA fails to run this test due to missing region-info\n+            .withEnv(\"oracle.jdbc.timezoneAsRegion\", \"false\");", "originalCommit": "08b7d53192afce227f9b615c5c08ea78f22b2a2e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzc4NzkyMQ==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1650#discussion_r547787921", "bodyText": "If you say so. Kinda shitty to test locally, as it simply works there... Would like some resources where you've found that bit, as my Oracle knowledge doesn't extend that far tbh.", "author": "smcvb", "createdAt": "2020-12-23T08:13:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQwOTIwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzc5MTc1Ng==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1650#discussion_r547791756", "bodyText": "Pushed, let's see if you're right ;-)", "author": "smcvb", "createdAt": "2020-12-23T08:17:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQwOTIwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzgyMjczNw==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1650#discussion_r547822737", "bodyText": "It seems you were, bravo", "author": "smcvb", "createdAt": "2020-12-23T08:53:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQwOTIwNw=="}], "type": "inlineReview", "revised_code": {"commit": "05e776c36b320561d54895eb0ba1b50b95cb2cd7", "chunk": "diff --git a/integrationtests/src/test/java/org/axonframework/integrationtests/eventsourcing/eventstore/jdbc/Oracle11EventTableFactoryTest.java b/integrationtests/src/test/java/org/axonframework/integrationtests/eventsourcing/eventstore/jdbc/Oracle11EventTableFactoryTest.java\nindex a20744c71..901494c62 100644\n--- a/integrationtests/src/test/java/org/axonframework/integrationtests/eventsourcing/eventstore/jdbc/Oracle11EventTableFactoryTest.java\n+++ b/integrationtests/src/test/java/org/axonframework/integrationtests/eventsourcing/eventstore/jdbc/Oracle11EventTableFactoryTest.java\n\n@@ -26,6 +26,7 @@\n import java.sql.Connection;\n import java.sql.DriverManager;\n import java.sql.SQLException;\n+import java.util.Properties;\n \n import static org.axonframework.common.io.IOUtils.closeQuietly;\n \n"}}, {"oid": "05e776c36b320561d54895eb0ba1b50b95cb2cd7", "url": "https://github.com/AxonFramework/AxonFramework/commit/05e776c36b320561d54895eb0ba1b50b95cb2cd7", "message": "Move property to connection creation\n\nMove the timeezoneAsRegion property to the connection, as Lucas assumes\nthat to resolve the problem.\n\n#1647", "committedDate": "2020-12-23T08:17:24Z", "type": "commit"}]}