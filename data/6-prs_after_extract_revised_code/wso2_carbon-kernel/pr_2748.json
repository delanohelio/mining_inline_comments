{"pr_number": 2748, "pr_title": "Improvements to SCIM group PATCH Operation performance", "pr_createdAt": "2020-08-14T16:07:57Z", "pr_url": "https://github.com/wso2/carbon-kernel/pull/2748", "timeline": [{"oid": "07fe1053fbea713fa52071d0582a97cdda0a6c4e", "url": "https://github.com/wso2/carbon-kernel/commit/07fe1053fbea713fa52071d0582a97cdda0a6c4e", "message": "Improvements to SCIM group PATCH Operation performance", "committedDate": "2020-11-02T10:08:35Z", "type": "commit"}, {"oid": "07fe1053fbea713fa52071d0582a97cdda0a6c4e", "url": "https://github.com/wso2/carbon-kernel/commit/07fe1053fbea713fa52071d0582a97cdda0a6c4e", "message": "Improvements to SCIM group PATCH Operation performance", "committedDate": "2020-11-02T10:08:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQ5NjcxNg==", "url": "https://github.com/wso2/carbon-kernel/pull/2748#discussion_r516496716", "bodyText": "Check the comment alignment.", "author": "ShanChathusanda93", "createdAt": "2020-11-03T08:37:02Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/ldap/ActiveDirectoryUserStoreManager.java", "diffHunk": "@@ -625,6 +628,142 @@ protected void doSetUserAttribute(String userName, String attributeName, String\n         }\n     }\n \n+    @Override\n+    public String[] getUserListOfLDAPRole(RoleContext context, String filter) throws UserStoreException {\n+\n+        boolean debug = logger.isDebugEnabled();\n+\n+        if (debug) {\n+            logger.debug(\"Getting user list of role: \" + context.getRoleName() + \" with filter: \" + filter);\n+        }\n+\n+        List<String> userList = new ArrayList<String>();\n+        String[] names = new String[0];\n+        int givenMax, searchTime;\n+\n+        try {\n+            givenMax = Integer.parseInt(realmConfig\n+                    .getUserStoreProperty(UserCoreConstants.RealmConfig.PROPERTY_MAX_USER_LIST));\n+        } catch (NumberFormatException e) {\n+            if (debug) {\n+                logger.debug(\"Error occurred while reading user store property: \"\n+                        + UserCoreConstants.RealmConfig.PROPERTY_MAX_USER_LIST + \" : \" + e);\n+            }\n+            givenMax = UserCoreConstants.MAX_USER_ROLE_LIST;\n+        }\n+\n+        try {\n+            searchTime = Integer.parseInt(realmConfig\n+                    .getUserStoreProperty(UserCoreConstants.RealmConfig.PROPERTY_MAX_SEARCH_TIME));\n+        } catch (NumberFormatException e) {\n+            if (debug) {\n+                logger.debug(\"Error occurred while reading user store property: \"\n+                        + UserCoreConstants.RealmConfig.PROPERTY_MAX_SEARCH_TIME + \" : \" + e);\n+            }\n+            searchTime = UserCoreConstants.MAX_SEARCH_TIME;\n+        }\n+\n+        DirContext dirContext = null;\n+        NamingEnumeration<SearchResult> answer = null;\n+\n+        try {\n+            SearchControls searchCtls = new SearchControls();\n+            searchCtls.setSearchScope(SearchControls.SUBTREE_SCOPE);\n+            searchCtls.setTimeLimit(searchTime);\n+            searchCtls.setCountLimit(givenMax);\n+\n+            String groupSearchBase = realmConfig.getUserStoreProperty(LDAPConstants.GROUP_SEARCH_BASE);\n+            String userListFilter = realmConfig.getUserStoreProperty(LDAPConstants.USER_NAME_LIST_FILTER);\n+            String memberOFAttribute = realmConfig.getUserStoreProperty(LDAPConstants.MEMBEROF_ATTRIBUTE);\n+            String groupNameAttribute = realmConfig.getUserStoreProperty(LDAPConstants.GROUP_NAME_ATTRIBUTE);\n+            userSearchBase = realmConfig.getUserStoreProperty(LDAPConstants.USER_SEARCH_BASE);\n+            String searchFilter = \"(&\" + userListFilter + \"(\" + memberOFAttribute + \"=\" + groupNameAttribute + \"=\"\n+                    + escapeSpecialCharactersForFilter(context.getRoleName()) + \",\" + groupSearchBase + \"))\";\n+            String userNameProperty = realmConfig.getUserStoreProperty(LDAPConstants.USER_NAME_ATTRIBUTE);\n+            String displayNameAttribute = realmConfig\n+                    .getUserStoreProperty(LDAPConstants.DISPLAY_NAME_ATTRIBUTE);\n+            String returnedAtts[] = {userNameProperty, displayNameAttribute};\n+            searchCtls.setReturningAttributes(returnedAtts);\n+\n+            SearchResult sr = null;\n+            dirContext = connectionSource.getContext();\n+\n+            answer = dirContext.search(escapeDNForSearch(userSearchBase), searchFilter, searchCtls);\n+\n+            for (int index = 0; index < givenMax && answer.hasMore(); index++) {\n+                String displayName = null;\n+                String userName = null;\n+                sr = answer.next();\n+                Attributes userAttributes = sr.getAttributes();\n+                if (userAttributes != null) {\n+                    Attribute userNameAttribute = userAttributes.get(userNameProperty);\n+                    if (userNameAttribute != null) {\n+                        userName = (String) userNameAttribute.get();\n+                        if (debug) {\n+                            logger.debug(\"UserName: \" + userName);\n+                        }\n+                    }\n+                    if (StringUtils.isNotEmpty(displayNameAttribute)) {\n+                        Attribute displayAttribute = userAttributes.get(displayNameAttribute);\n+                        if (displayAttribute != null) {\n+                            displayName = (String) displayAttribute.get();\n+                        }\n+                        if (debug) {\n+                            logger.debug(\"DisplayName: \" + displayName);\n+                        }\n+                    }\n+\n+                    String domainName = realmConfig.getUserStoreProperty(\n+                            UserCoreConstants.RealmConfig.PROPERTY_DOMAIN_NAME);\n+\n+                         /*\n+                         Username will be null in the special case where the\n+                         username attribute has changed to another", "originalCommit": "07fe1053fbea713fa52071d0582a97cdda0a6c4e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjUxMjczNw==", "url": "https://github.com/wso2/carbon-kernel/pull/2748#discussion_r516512737", "bodyText": "Resolved in fac7931", "author": "gayashanbc", "createdAt": "2020-11-03T09:05:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQ5NjcxNg=="}], "type": "inlineReview", "revised_code": {"commit": "fac79311085b92b3378937bc4b20849e07868924", "chunk": "diff --git a/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/ldap/ActiveDirectoryUserStoreManager.java b/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/ldap/ActiveDirectoryUserStoreManager.java\nindex 0956c16d9..242f8f58e 100644\n--- a/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/ldap/ActiveDirectoryUserStoreManager.java\n+++ b/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/ldap/ActiveDirectoryUserStoreManager.java\n\n@@ -716,12 +716,12 @@ public class ActiveDirectoryUserStoreManager extends ReadWriteLDAPUserStoreManag\n                     String domainName = realmConfig.getUserStoreProperty(\n                             UserCoreConstants.RealmConfig.PROPERTY_DOMAIN_NAME);\n \n-                         /*\n-                         Username will be null in the special case where the\n-                         username attribute has changed to another\n-                         and having different userNameProperty than the current\n-                         user-mgt.xml\n-                          */\n+                    /*\n+                    Username will be null in the special case where the\n+                    username attribute has changed to another\n+                    and having different userNameProperty than the current\n+                    user-mgt.xml.\n+                    */\n                     if (userName != null) {\n                         userName = UserCoreUtil.getCombinedName(domainName, userName, displayName);\n                         userList.add(userName);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQ5OTc1Nw==", "url": "https://github.com/wso2/carbon-kernel/pull/2748#discussion_r516499757", "bodyText": "If we are to append more than one variable to a String, better to use String.format. WDYT?", "author": "somindatommy", "createdAt": "2020-11-03T08:42:46Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/ldap/ActiveDirectoryUserStoreManager.java", "diffHunk": "@@ -625,6 +628,142 @@ protected void doSetUserAttribute(String userName, String attributeName, String\n         }\n     }\n \n+    @Override\n+    public String[] getUserListOfLDAPRole(RoleContext context, String filter) throws UserStoreException {\n+\n+        boolean debug = logger.isDebugEnabled();\n+\n+        if (debug) {\n+            logger.debug(\"Getting user list of role: \" + context.getRoleName() + \" with filter: \" + filter);", "originalCommit": "07fe1053fbea713fa52071d0582a97cdda0a6c4e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQ5OTk2Ng==", "url": "https://github.com/wso2/carbon-kernel/pull/2748#discussion_r516499966", "bodyText": "Shall we fix this in other places as well?", "author": "somindatommy", "createdAt": "2020-11-03T08:43:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQ5OTc1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjUxNjMwOA==", "url": "https://github.com/wso2/carbon-kernel/pull/2748#discussion_r516516308", "bodyText": "Not necessary as String.format does not have a performance benefit over concatenation. Refer the second answer in [1].\nAlso single line concatenations are optimised [2] and converted to StringBuilder under the hood. Memory wise it has the same impact and to stick with consistency, I'm avoiding the use of StringBuilder.\n[1] https://stackoverflow.com/questions/925423/is-it-better-practice-to-use-string-format-over-string-concatenation-in-java\n[2] https://stackoverflow.com/questions/18453458/string-builder-vs-string-concatenation", "author": "gayashanbc", "createdAt": "2020-11-03T09:11:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQ5OTc1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "fac79311085b92b3378937bc4b20849e07868924", "chunk": "diff --git a/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/ldap/ActiveDirectoryUserStoreManager.java b/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/ldap/ActiveDirectoryUserStoreManager.java\nindex 0956c16d9..242f8f58e 100644\n--- a/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/ldap/ActiveDirectoryUserStoreManager.java\n+++ b/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/ldap/ActiveDirectoryUserStoreManager.java\n\n@@ -716,12 +716,12 @@ public class ActiveDirectoryUserStoreManager extends ReadWriteLDAPUserStoreManag\n                     String domainName = realmConfig.getUserStoreProperty(\n                             UserCoreConstants.RealmConfig.PROPERTY_DOMAIN_NAME);\n \n-                         /*\n-                         Username will be null in the special case where the\n-                         username attribute has changed to another\n-                         and having different userNameProperty than the current\n-                         user-mgt.xml\n-                          */\n+                    /*\n+                    Username will be null in the special case where the\n+                    username attribute has changed to another\n+                    and having different userNameProperty than the current\n+                    user-mgt.xml.\n+                    */\n                     if (userName != null) {\n                         userName = UserCoreUtil.getCombinedName(domainName, userName, displayName);\n                         userList.add(userName);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjUwMDQ5OA==", "url": "https://github.com/wso2/carbon-kernel/pull/2748#discussion_r516500498", "bodyText": "Formatting error. Shall we fix it?", "author": "somindatommy", "createdAt": "2020-11-03T08:44:11Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/ldap/ActiveDirectoryUserStoreManager.java", "diffHunk": "@@ -625,6 +628,142 @@ protected void doSetUserAttribute(String userName, String attributeName, String\n         }\n     }\n \n+    @Override\n+    public String[] getUserListOfLDAPRole(RoleContext context, String filter) throws UserStoreException {\n+\n+        boolean debug = logger.isDebugEnabled();\n+\n+        if (debug) {\n+            logger.debug(\"Getting user list of role: \" + context.getRoleName() + \" with filter: \" + filter);\n+        }\n+\n+        List<String> userList = new ArrayList<String>();\n+        String[] names = new String[0];\n+        int givenMax, searchTime;\n+\n+        try {\n+            givenMax = Integer.parseInt(realmConfig\n+                    .getUserStoreProperty(UserCoreConstants.RealmConfig.PROPERTY_MAX_USER_LIST));\n+        } catch (NumberFormatException e) {\n+            if (debug) {\n+                logger.debug(\"Error occurred while reading user store property: \"\n+                        + UserCoreConstants.RealmConfig.PROPERTY_MAX_USER_LIST + \" : \" + e);\n+            }\n+            givenMax = UserCoreConstants.MAX_USER_ROLE_LIST;\n+        }\n+\n+        try {\n+            searchTime = Integer.parseInt(realmConfig\n+                    .getUserStoreProperty(UserCoreConstants.RealmConfig.PROPERTY_MAX_SEARCH_TIME));\n+        } catch (NumberFormatException e) {\n+            if (debug) {\n+                logger.debug(\"Error occurred while reading user store property: \"\n+                        + UserCoreConstants.RealmConfig.PROPERTY_MAX_SEARCH_TIME + \" : \" + e);\n+            }\n+            searchTime = UserCoreConstants.MAX_SEARCH_TIME;\n+        }\n+\n+        DirContext dirContext = null;\n+        NamingEnumeration<SearchResult> answer = null;\n+\n+        try {\n+            SearchControls searchCtls = new SearchControls();\n+            searchCtls.setSearchScope(SearchControls.SUBTREE_SCOPE);\n+            searchCtls.setTimeLimit(searchTime);\n+            searchCtls.setCountLimit(givenMax);\n+\n+            String groupSearchBase = realmConfig.getUserStoreProperty(LDAPConstants.GROUP_SEARCH_BASE);\n+            String userListFilter = realmConfig.getUserStoreProperty(LDAPConstants.USER_NAME_LIST_FILTER);\n+            String memberOFAttribute = realmConfig.getUserStoreProperty(LDAPConstants.MEMBEROF_ATTRIBUTE);\n+            String groupNameAttribute = realmConfig.getUserStoreProperty(LDAPConstants.GROUP_NAME_ATTRIBUTE);\n+            userSearchBase = realmConfig.getUserStoreProperty(LDAPConstants.USER_SEARCH_BASE);\n+            String searchFilter = \"(&\" + userListFilter + \"(\" + memberOFAttribute + \"=\" + groupNameAttribute + \"=\"\n+                    + escapeSpecialCharactersForFilter(context.getRoleName()) + \",\" + groupSearchBase + \"))\";\n+            String userNameProperty = realmConfig.getUserStoreProperty(LDAPConstants.USER_NAME_ATTRIBUTE);\n+            String displayNameAttribute = realmConfig\n+                    .getUserStoreProperty(LDAPConstants.DISPLAY_NAME_ATTRIBUTE);\n+            String returnedAtts[] = {userNameProperty, displayNameAttribute};\n+            searchCtls.setReturningAttributes(returnedAtts);\n+\n+            SearchResult sr = null;\n+            dirContext = connectionSource.getContext();\n+\n+            answer = dirContext.search(escapeDNForSearch(userSearchBase), searchFilter, searchCtls);\n+\n+            for (int index = 0; index < givenMax && answer.hasMore(); index++) {\n+                String displayName = null;\n+                String userName = null;\n+                sr = answer.next();\n+                Attributes userAttributes = sr.getAttributes();\n+                if (userAttributes != null) {\n+                    Attribute userNameAttribute = userAttributes.get(userNameProperty);\n+                    if (userNameAttribute != null) {\n+                        userName = (String) userNameAttribute.get();\n+                        if (debug) {\n+                            logger.debug(\"UserName: \" + userName);\n+                        }\n+                    }\n+                    if (StringUtils.isNotEmpty(displayNameAttribute)) {\n+                        Attribute displayAttribute = userAttributes.get(displayNameAttribute);\n+                        if (displayAttribute != null) {\n+                            displayName = (String) displayAttribute.get();\n+                        }\n+                        if (debug) {\n+                            logger.debug(\"DisplayName: \" + displayName);\n+                        }\n+                    }\n+\n+                    String domainName = realmConfig.getUserStoreProperty(\n+                            UserCoreConstants.RealmConfig.PROPERTY_DOMAIN_NAME);\n+\n+                         /*", "originalCommit": "07fe1053fbea713fa52071d0582a97cdda0a6c4e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjUxMjY5Ng==", "url": "https://github.com/wso2/carbon-kernel/pull/2748#discussion_r516512696", "bodyText": "Resolved in fac7931", "author": "gayashanbc", "createdAt": "2020-11-03T09:05:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjUwMDQ5OA=="}], "type": "inlineReview", "revised_code": {"commit": "fac79311085b92b3378937bc4b20849e07868924", "chunk": "diff --git a/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/ldap/ActiveDirectoryUserStoreManager.java b/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/ldap/ActiveDirectoryUserStoreManager.java\nindex 0956c16d9..242f8f58e 100644\n--- a/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/ldap/ActiveDirectoryUserStoreManager.java\n+++ b/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/ldap/ActiveDirectoryUserStoreManager.java\n\n@@ -716,12 +716,12 @@ public class ActiveDirectoryUserStoreManager extends ReadWriteLDAPUserStoreManag\n                     String domainName = realmConfig.getUserStoreProperty(\n                             UserCoreConstants.RealmConfig.PROPERTY_DOMAIN_NAME);\n \n-                         /*\n-                         Username will be null in the special case where the\n-                         username attribute has changed to another\n-                         and having different userNameProperty than the current\n-                         user-mgt.xml\n-                          */\n+                    /*\n+                    Username will be null in the special case where the\n+                    username attribute has changed to another\n+                    and having different userNameProperty than the current\n+                    user-mgt.xml.\n+                    */\n                     if (userName != null) {\n                         userName = UserCoreUtil.getCombinedName(domainName, userName, displayName);\n                         userList.add(userName);\n"}}, {"oid": "fac79311085b92b3378937bc4b20849e07868924", "url": "https://github.com/wso2/carbon-kernel/commit/fac79311085b92b3378937bc4b20849e07868924", "message": "Address PR comments", "committedDate": "2020-11-03T09:04:55Z", "type": "commit"}]}