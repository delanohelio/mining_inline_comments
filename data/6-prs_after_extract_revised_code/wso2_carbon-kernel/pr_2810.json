{"pr_number": 2810, "pr_title": " Fix the issue of reaching the system to an inconsistent state", "pr_createdAt": "2020-10-16T03:03:13Z", "pr_url": "https://github.com/wso2/carbon-kernel/pull/2810", "timeline": [{"oid": "5c3ea485124a50a8c12d1a93229489d8b1cc2378", "url": "https://github.com/wso2/carbon-kernel/commit/5c3ea485124a50a8c12d1a93229489d8b1cc2378", "message": " Fix the issue of reaching the system to an inconsistent state", "committedDate": "2020-10-16T02:57:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIwNzYzNg==", "url": "https://github.com/wso2/carbon-kernel/pull/2810#discussion_r506207636", "bodyText": "Can we add a comment here stating the reason for both logging and throwing the exception?", "author": "mevan-karu", "createdAt": "2020-10-16T09:15:45Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/jdbc/JDBCUserStoreManager.java", "diffHunk": "@@ -1840,10 +1843,9 @@ public void doDeleteUser(String userName) throws UserStoreException {\n             }\n             dbConnection.commit();\n         } catch (SQLException e) {\n+            DatabaseUtil.rollBack(dbConnection);\n             String msg = \"Error occurred while deleting user : \" + userName;\n-            if (log.isDebugEnabled()) {\n-                log.debug(msg, e);\n-            }\n+            log.error(msg, e);", "originalCommit": "5c3ea485124a50a8c12d1a93229489d8b1cc2378", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzM5NzA3NQ==", "url": "https://github.com/wso2/carbon-kernel/pull/2810#discussion_r507397075", "bodyText": "Fixed 66bfa20", "author": "GANGANI", "createdAt": "2020-10-19T03:12:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIwNzYzNg=="}], "type": "inlineReview", "revised_code": {"commit": "66bfa2016cccc221cb3ad7fbcd1a354bd6ab6cb2", "chunk": "diff --git a/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/jdbc/JDBCUserStoreManager.java b/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/jdbc/JDBCUserStoreManager.java\nindex f70f0798a..c3ca52330 100644\n--- a/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/jdbc/JDBCUserStoreManager.java\n+++ b/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/jdbc/JDBCUserStoreManager.java\n\n@@ -1845,6 +1845,7 @@ public class JDBCUserStoreManager extends AbstractUserStoreManager {\n         } catch (SQLException e) {\n             DatabaseUtil.rollBack(dbConnection);\n             String msg = \"Error occurred while deleting user : \" + userName;\n+            // Logging error here since this will not get logged further up the call stack.\n             log.error(msg, e);\n             throw new UserStoreException(msg, e);\n         } finally {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIwODU5MQ==", "url": "https://github.com/wso2/carbon-kernel/pull/2810#discussion_r506208591", "bodyText": "In here also, put a comment stating the reason.", "author": "mevan-karu", "createdAt": "2020-10-16T09:16:58Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/jdbc/JDBCUserStoreManager.java", "diffHunk": "@@ -2568,10 +2576,9 @@ private void updateStringValuesToDatabase(Connection dbConnection, String sqlStm\n                 dbConnection.commit();\n             }\n         } catch (SQLException e) {\n+            DatabaseUtil.rollBack(dbConnection);\n             String msg = \"Error occurred while updating string values to database.\";\n-            if (log.isDebugEnabled()) {\n-                log.debug(msg, e);\n-            }\n+            log.error(msg, e);", "originalCommit": "5c3ea485124a50a8c12d1a93229489d8b1cc2378", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzM5Njk3OQ==", "url": "https://github.com/wso2/carbon-kernel/pull/2810#discussion_r507396979", "bodyText": "Fixed 66bfa20", "author": "GANGANI", "createdAt": "2020-10-19T03:11:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIwODU5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "66bfa2016cccc221cb3ad7fbcd1a354bd6ab6cb2", "chunk": "diff --git a/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/jdbc/JDBCUserStoreManager.java b/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/jdbc/JDBCUserStoreManager.java\nindex f70f0798a..c3ca52330 100644\n--- a/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/jdbc/JDBCUserStoreManager.java\n+++ b/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/jdbc/JDBCUserStoreManager.java\n\n@@ -2578,6 +2579,7 @@ public class JDBCUserStoreManager extends AbstractUserStoreManager {\n         } catch (SQLException e) {\n             DatabaseUtil.rollBack(dbConnection);\n             String msg = \"Error occurred while updating string values to database.\";\n+            // Logging error here since this will not get logged further up the call stack.\n             log.error(msg, e);\n             if (e instanceof SQLIntegrityConstraintViolationException) {\n                 // Duplicate entry\n"}}, {"oid": "66bfa2016cccc221cb3ad7fbcd1a354bd6ab6cb2", "url": "https://github.com/wso2/carbon-kernel/commit/66bfa2016cccc221cb3ad7fbcd1a354bd6ab6cb2", "message": "Add comments", "committedDate": "2020-10-19T03:10:20Z", "type": "commit"}]}