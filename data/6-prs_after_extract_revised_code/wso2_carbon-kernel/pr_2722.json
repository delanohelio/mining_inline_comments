{"pr_number": 2722, "pr_title": "Add role and group separation changes", "pr_createdAt": "2020-07-23T08:42:39Z", "pr_url": "https://github.com/wso2/carbon-kernel/pull/2722", "timeline": [{"oid": "b258be18547fe413bd111784fb28bb49dcadfc53", "url": "https://github.com/wso2/carbon-kernel/commit/b258be18547fe413bd111784fb28bb49dcadfc53", "message": "Add role and group separation changes", "committedDate": "2020-08-03T13:15:24Z", "type": "forcePushed"}, {"oid": "21355ce233d3d978073155ad9b24d45a65fd7caa", "url": "https://github.com/wso2/carbon-kernel/commit/21355ce233d3d978073155ad9b24d45a65fd7caa", "message": "Add role and group separation changes", "committedDate": "2020-08-03T19:51:30Z", "type": "forcePushed"}, {"oid": "fae7c8570d6b6753a4841e194e47a6f7713f25f8", "url": "https://github.com/wso2/carbon-kernel/commit/fae7c8570d6b6753a4841e194e47a6f7713f25f8", "message": "Add role and group separation changes", "committedDate": "2020-08-04T09:24:34Z", "type": "forcePushed"}, {"oid": "dcacfe4ba37dfb05e66388fcab390f50c0393e74", "url": "https://github.com/wso2/carbon-kernel/commit/dcacfe4ba37dfb05e66388fcab390f50c0393e74", "message": "Add role and group separation changes", "committedDate": "2020-08-04T09:41:08Z", "type": "forcePushed"}, {"oid": "f7e1598650cede7bc4ef6bdacb8bc2068cf5cf0e", "url": "https://github.com/wso2/carbon-kernel/commit/f7e1598650cede7bc4ef6bdacb8bc2068cf5cf0e", "message": "Add role and group separation changes", "committedDate": "2020-08-04T11:55:26Z", "type": "forcePushed"}, {"oid": "4328a533a409ed03266619b7e69f6ebbce8c3af3", "url": "https://github.com/wso2/carbon-kernel/commit/4328a533a409ed03266619b7e69f6ebbce8c3af3", "message": "Add role and group separation changes", "committedDate": "2020-08-04T19:20:43Z", "type": "forcePushed"}, {"oid": "5317bf35c93f7de27bf47e3f8d13d22439fb4ee5", "url": "https://github.com/wso2/carbon-kernel/commit/5317bf35c93f7de27bf47e3f8d13d22439fb4ee5", "message": "Add role and group separation changes", "committedDate": "2020-08-05T04:01:07Z", "type": "forcePushed"}, {"oid": "197f6c44f7251c77bcf440b552a8cda0ff032b3e", "url": "https://github.com/wso2/carbon-kernel/commit/197f6c44f7251c77bcf440b552a8cda0ff032b3e", "message": "Add role and group separation changes", "committedDate": "2020-08-05T07:25:10Z", "type": "forcePushed"}, {"oid": "d302bc96513f99869f7271e0eaa575ff20de2154", "url": "https://github.com/wso2/carbon-kernel/commit/d302bc96513f99869f7271e0eaa575ff20de2154", "message": "Add role and group separation changes", "committedDate": "2020-08-05T08:08:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk3OTYwMA==", "url": "https://github.com/wso2/carbon-kernel/pull/2722#discussion_r465979600", "bodyText": "why can't we do this using prepStmt?", "author": "IsuraD", "createdAt": "2020-08-05T20:18:47Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/hybrid/HybridRoleManager.java", "diffHunk": "@@ -632,6 +714,66 @@ private String truncateInternalDomainFromFilter(String filter) {\n         return hybridRoleListOfUsers;\n     }\n \n+    /**\n+     * Get hybrid role list of groups.\n+     *\n+     * @param groupNames group name list.\n+     * @return map of hybrid role list of groups.\n+     * @throws UserStoreException userStoreException.\n+     */\n+    public Map<String, List<String>> getHybridRoleListOfGroups(List<String> groupNames, String domainName)\n+            throws UserStoreException {\n+\n+        Map<String, List<String>> hybridRoleListOfGroups = new HashMap<>();\n+        String sqlStmt = realmConfig.getRealmProperty(HybridJDBCConstants.GET_ROLE_LIST_OF_GROUPS);\n+        StringBuilder groupNameParameter = new StringBuilder();\n+\n+        if (StringUtils.isEmpty(sqlStmt)) {\n+            sqlStmt = HybridJDBCConstants.GET_INTERNAL_ROLE_LIST_OF_GROUPS_SQL;\n+        }\n+        for (int i = 0; i < groupNames.size(); i++) {\n+\n+            groupNames.set(i, groupNames.get(i).replaceAll(\"'\", \"''\"));\n+            groupNameParameter.append(\"'\").append(groupNames.get(i)).append(\"'\");\n+\n+            if (i != groupNames.size() - 1) {\n+                groupNameParameter.append(\",\");\n+            }\n+        }\n+\n+        sqlStmt = sqlStmt.replaceFirst(\"\\\\?\", Matcher.quoteReplacement(groupNameParameter.toString()));", "originalCommit": "d302bc96513f99869f7271e0eaa575ff20de2154", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjIxMDU5OA==", "url": "https://github.com/wso2/carbon-kernel/pull/2722#discussion_r466210598", "bodyText": "prepStmt is not supported for comma-separated strings. So we will have to do it this way for IN (?).", "author": "ashensw", "createdAt": "2020-08-06T07:47:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk3OTYwMA=="}], "type": "inlineReview", "revised_code": {"commit": "55386bddf2c16fdd730757a9170d80e3d8079f66", "chunk": "diff --git a/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/hybrid/HybridRoleManager.java b/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/hybrid/HybridRoleManager.java\nindex 67daf6f2b..202671e05 100644\n--- a/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/hybrid/HybridRoleManager.java\n+++ b/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/hybrid/HybridRoleManager.java\n\n@@ -732,7 +732,6 @@ public class HybridRoleManager {\n             sqlStmt = HybridJDBCConstants.GET_INTERNAL_ROLE_LIST_OF_GROUPS_SQL;\n         }\n         for (int i = 0; i < groupNames.size(); i++) {\n-\n             groupNames.set(i, groupNames.get(i).replaceAll(\"'\", \"''\"));\n             groupNameParameter.append(\"'\").append(groupNames.get(i)).append(\"'\");\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk4NDEzNw==", "url": "https://github.com/wso2/carbon-kernel/pull/2722#discussion_r465984137", "bodyText": "unnecessary line.", "author": "IsuraD", "createdAt": "2020-08-05T20:27:24Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/hybrid/HybridRoleManager.java", "diffHunk": "@@ -632,6 +714,66 @@ private String truncateInternalDomainFromFilter(String filter) {\n         return hybridRoleListOfUsers;\n     }\n \n+    /**\n+     * Get hybrid role list of groups.\n+     *\n+     * @param groupNames group name list.\n+     * @return map of hybrid role list of groups.\n+     * @throws UserStoreException userStoreException.\n+     */\n+    public Map<String, List<String>> getHybridRoleListOfGroups(List<String> groupNames, String domainName)\n+            throws UserStoreException {\n+\n+        Map<String, List<String>> hybridRoleListOfGroups = new HashMap<>();\n+        String sqlStmt = realmConfig.getRealmProperty(HybridJDBCConstants.GET_ROLE_LIST_OF_GROUPS);\n+        StringBuilder groupNameParameter = new StringBuilder();\n+\n+        if (StringUtils.isEmpty(sqlStmt)) {\n+            sqlStmt = HybridJDBCConstants.GET_INTERNAL_ROLE_LIST_OF_GROUPS_SQL;\n+        }\n+        for (int i = 0; i < groupNames.size(); i++) {\n+", "originalCommit": "d302bc96513f99869f7271e0eaa575ff20de2154", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjI1NTI0MA==", "url": "https://github.com/wso2/carbon-kernel/pull/2722#discussion_r466255240", "bodyText": "Fixed and updated the PR.", "author": "ashensw", "createdAt": "2020-08-06T09:04:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk4NDEzNw=="}], "type": "inlineReview", "revised_code": {"commit": "55386bddf2c16fdd730757a9170d80e3d8079f66", "chunk": "diff --git a/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/hybrid/HybridRoleManager.java b/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/hybrid/HybridRoleManager.java\nindex 67daf6f2b..202671e05 100644\n--- a/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/hybrid/HybridRoleManager.java\n+++ b/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/hybrid/HybridRoleManager.java\n\n@@ -732,7 +732,6 @@ public class HybridRoleManager {\n             sqlStmt = HybridJDBCConstants.GET_INTERNAL_ROLE_LIST_OF_GROUPS_SQL;\n         }\n         for (int i = 0; i < groupNames.size(); i++) {\n-\n             groupNames.set(i, groupNames.get(i).replaceAll(\"'\", \"''\"));\n             groupNameParameter.append(\"'\").append(groupNames.get(i)).append(\"'\");\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk4ODM0NQ==", "url": "https://github.com/wso2/carbon-kernel/pull/2722#discussion_r465988345", "bodyText": "Is this a common requirement to use as a Util? Better use as a private method.", "author": "IsuraD", "createdAt": "2020-08-05T20:35:51Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/util/UserCoreUtil.java", "diffHunk": "@@ -120,6 +121,21 @@\n         return (String[]) h.toArray(new String[h.size()]);\n     }\n \n+    /**\n+     * Convert a map of lists to a list with unique elements.\n+     *\n+     * @param mapOfLists Map of lists.\n+     * @return list with unique elements.\n+     */\n+    public static Set<String> getList(Map<String, List<String>> mapOfLists) {", "originalCommit": "d302bc96513f99869f7271e0eaa575ff20de2154", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjI1NTI4Mg==", "url": "https://github.com/wso2/carbon-kernel/pull/2722#discussion_r466255282", "bodyText": "Fixed and updated the PR.", "author": "ashensw", "createdAt": "2020-08-06T09:04:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk4ODM0NQ=="}], "type": "inlineReview", "revised_code": {"commit": "78b857d7adb9345fe8f0761f0d542cc4fa6d7b4c", "chunk": "diff --git a/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/util/UserCoreUtil.java b/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/util/UserCoreUtil.java\nindex 79f1c5acc..3c171c3ac 100644\n--- a/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/util/UserCoreUtil.java\n+++ b/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/util/UserCoreUtil.java\n\n@@ -121,21 +121,6 @@ public final class UserCoreUtil {\n         return (String[]) h.toArray(new String[h.size()]);\n     }\n \n-    /**\n-     * Convert a map of lists to a list with unique elements.\n-     *\n-     * @param mapOfLists Map of lists.\n-     * @return list with unique elements.\n-     */\n-    public static Set<String> getList(Map<String, List<String>> mapOfLists) {\n-\n-        Set<String> fullSet = new HashSet<>();\n-        for (List<String> list : mapOfLists.values()) {\n-            fullSet.addAll(list);\n-        }\n-        return fullSet;\n-    }\n-\n     /**\n      * @param rawResourcePath\n      * @return\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk5MjI3MQ==", "url": "https://github.com/wso2/carbon-kernel/pull/2722#discussion_r465992271", "bodyText": "Why the table name is UM_HYBRID_GROUP_ROLE? We don't have HYBRID_GROUP... prefer UM_GROUP_ROLE", "author": "IsuraD", "createdAt": "2020-08-05T20:43:38Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/hybrid/HybridJDBCConstants.java", "diffHunk": "@@ -107,6 +128,12 @@\n             + \".UM_TENANT_ID=? AND UM_HYBRID_USER_ROLE.UM_DOMAIN_ID=(SELECT UM_DOMAIN_ID FROM UM_DOMAIN WHERE \"\n             + \"UM_TENANT_ID=? AND UM_DOMAIN_NAME=?)\";\n \n+    public static final String GET_INTERNAL_ROLE_LIST_OF_GROUPS_SQL = \"SELECT UM_GROUP_NAME, UM_ROLE_NAME FROM \"\n+            + \"UM_HYBRID_GROUP_ROLE, UM_HYBRID_ROLE WHERE UM_GROUP_NAME IN (?) AND UM_HYBRID_GROUP_ROLE\"", "originalCommit": "d302bc96513f99869f7271e0eaa575ff20de2154", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE1NzQzNA==", "url": "https://github.com/wso2/carbon-kernel/pull/2722#discussion_r466157434", "bodyText": "We do have a table called UM_HYBRID_USER_ROLE to maintain the role and user association. So a similar name was used for GROUP as well to maintain consistency.", "author": "ashensw", "createdAt": "2020-08-06T05:38:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk5MjI3MQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "55386bddf2c16fdd730757a9170d80e3d8079f66", "url": "https://github.com/wso2/carbon-kernel/commit/55386bddf2c16fdd730757a9170d80e3d8079f66", "message": "Add role and group separation changes", "committedDate": "2020-08-06T07:42:13Z", "type": "forcePushed"}, {"oid": "78b857d7adb9345fe8f0761f0d542cc4fa6d7b4c", "url": "https://github.com/wso2/carbon-kernel/commit/78b857d7adb9345fe8f0761f0d542cc4fa6d7b4c", "message": "Add role and group separation changes", "committedDate": "2020-08-06T09:03:49Z", "type": "forcePushed"}, {"oid": "aceb76895294c3d5b2645e1e7cd56122012506ed", "url": "https://github.com/wso2/carbon-kernel/commit/aceb76895294c3d5b2645e1e7cd56122012506ed", "message": "Add role and group separation changes", "committedDate": "2020-08-06T09:05:43Z", "type": "forcePushed"}, {"oid": "7c734dbe5ab45fa4834944351e906e18556f3a41", "url": "https://github.com/wso2/carbon-kernel/commit/7c734dbe5ab45fa4834944351e906e18556f3a41", "message": "Add role and group separation changes", "committedDate": "2020-08-07T04:45:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjgyMjQyOA==", "url": "https://github.com/wso2/carbon-kernel/pull/2722#discussion_r466822428", "bodyText": "why is this primaryDomainName? Can be differ", "author": "IsuraD", "createdAt": "2020-08-07T05:04:13Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/hybrid/HybridRoleManager.java", "diffHunk": "@@ -433,6 +434,87 @@ public void updateUserListOfHybridRole(String roleName, String[] deletedUsers, S\n         }\n     }\n \n+    /**\n+     * Update group list of role.\n+     *\n+     * @param roleName      Role name.\n+     * @param deletedGroups Deleted groups.\n+     * @param newGroups     New groups.\n+     * @throws UserStoreException UserStoreException.\n+     */\n+    public void updateGroupListOfHybridRole(String roleName, String[] deletedGroups, String[] newGroups)\n+            throws UserStoreException {\n+\n+        String sqlStmt1 = HybridJDBCConstants.REMOVE_GROUP_FROM_ROLE_SQL;\n+        String sqlStmt2 = HybridJDBCConstants.ADD_GROUP_TO_ROLE_SQL;\n+\n+        try (Connection dbConnection = DatabaseUtil.getDBConnection(dataSource)) {\n+\n+            String primaryDomainName = getMyDomainName();\n+            if (primaryDomainName != null) {", "originalCommit": "7c734dbe5ab45fa4834944351e906e18556f3a41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjgzMDM4Nw==", "url": "https://github.com/wso2/carbon-kernel/pull/2722#discussion_r466830387", "bodyText": "Changed the variable name.", "author": "ashensw", "createdAt": "2020-08-07T05:35:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjgyMjQyOA=="}], "type": "inlineReview", "revised_code": {"commit": "2e6586e113afc30eaf9738a98adc869ef869fa3a", "chunk": "diff --git a/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/hybrid/HybridRoleManager.java b/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/hybrid/HybridRoleManager.java\nindex 202671e05..dfd155b48 100644\n--- a/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/hybrid/HybridRoleManager.java\n+++ b/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/hybrid/HybridRoleManager.java\n\n@@ -450,9 +450,9 @@ public class HybridRoleManager {\n \n         try (Connection dbConnection = DatabaseUtil.getDBConnection(dataSource)) {\n \n-            String primaryDomainName = getMyDomainName();\n-            if (primaryDomainName != null) {\n-                primaryDomainName = primaryDomainName.toUpperCase();\n+            String domainName = getMyDomainName();\n+            if (domainName != null) {\n+                domainName = domainName.toUpperCase();\n             }\n \n             String type = DatabaseCreator.getDatabaseType(dbConnection);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjgyMjUyNQ==", "url": "https://github.com/wso2/carbon-kernel/pull/2722#discussion_r466822525", "bodyText": "what is OPENEDGE_TYPE ?", "author": "IsuraD", "createdAt": "2020-08-07T05:04:41Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/hybrid/HybridRoleManager.java", "diffHunk": "@@ -433,6 +434,87 @@ public void updateUserListOfHybridRole(String roleName, String[] deletedUsers, S\n         }\n     }\n \n+    /**\n+     * Update group list of role.\n+     *\n+     * @param roleName      Role name.\n+     * @param deletedGroups Deleted groups.\n+     * @param newGroups     New groups.\n+     * @throws UserStoreException UserStoreException.\n+     */\n+    public void updateGroupListOfHybridRole(String roleName, String[] deletedGroups, String[] newGroups)\n+            throws UserStoreException {\n+\n+        String sqlStmt1 = HybridJDBCConstants.REMOVE_GROUP_FROM_ROLE_SQL;\n+        String sqlStmt2 = HybridJDBCConstants.ADD_GROUP_TO_ROLE_SQL;\n+\n+        try (Connection dbConnection = DatabaseUtil.getDBConnection(dataSource)) {\n+\n+            String primaryDomainName = getMyDomainName();\n+            if (primaryDomainName != null) {\n+                primaryDomainName = primaryDomainName.toUpperCase();\n+            }\n+\n+            String type = DatabaseCreator.getDatabaseType(dbConnection);\n+            if (UserCoreConstants.MSSQL_TYPE.equals(type)) {\n+                sqlStmt2 = HybridJDBCConstants.ADD_GROUP_TO_ROLE_SQL_MSSQL;\n+            }\n+\n+            if (ArrayUtils.isNotEmpty(deletedGroups)) {\n+                DatabaseUtil.udpateUserRoleMappingInBatchModeForInternalRoles(dbConnection, sqlStmt1, primaryDomainName,\n+                        deletedGroups, roleName, tenantId, tenantId, tenantId);\n+            }\n+\n+            if (ArrayUtils.isNotEmpty(newGroups)) {\n+                if (UserCoreConstants.OPENEDGE_TYPE.equals(type)) {", "originalCommit": "7c734dbe5ab45fa4834944351e906e18556f3a41", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2e6586e113afc30eaf9738a98adc869ef869fa3a", "chunk": "diff --git a/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/hybrid/HybridRoleManager.java b/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/hybrid/HybridRoleManager.java\nindex 202671e05..dfd155b48 100644\n--- a/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/hybrid/HybridRoleManager.java\n+++ b/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/hybrid/HybridRoleManager.java\n\n@@ -450,9 +450,9 @@ public class HybridRoleManager {\n \n         try (Connection dbConnection = DatabaseUtil.getDBConnection(dataSource)) {\n \n-            String primaryDomainName = getMyDomainName();\n-            if (primaryDomainName != null) {\n-                primaryDomainName = primaryDomainName.toUpperCase();\n+            String domainName = getMyDomainName();\n+            if (domainName != null) {\n+                domainName = domainName.toUpperCase();\n             }\n \n             String type = DatabaseCreator.getDatabaseType(dbConnection);\n"}}, {"oid": "2e6586e113afc30eaf9738a98adc869ef869fa3a", "url": "https://github.com/wso2/carbon-kernel/commit/2e6586e113afc30eaf9738a98adc869ef869fa3a", "message": "Add role and group separation changes", "committedDate": "2020-08-07T05:33:19Z", "type": "commit"}, {"oid": "2e6586e113afc30eaf9738a98adc869ef869fa3a", "url": "https://github.com/wso2/carbon-kernel/commit/2e6586e113afc30eaf9738a98adc869ef869fa3a", "message": "Add role and group separation changes", "committedDate": "2020-08-07T05:33:19Z", "type": "forcePushed"}]}