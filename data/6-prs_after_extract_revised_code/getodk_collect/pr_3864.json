{"pr_number": 3864, "pr_title": "Instance map view improvements", "pr_createdAt": "2020-05-25T19:04:19Z", "pr_url": "https://github.com/getodk/collect/pull/3864", "timeline": [{"oid": "1ee38828cc8a5e53a8158bf0458748ac5a6e8ded", "url": "https://github.com/getodk/collect/commit/1ee38828cc8a5e53a8158bf0458748ac5a6e8ded", "message": "Keep submission summary visible after changing device orientation", "committedDate": "2020-05-21T13:42:46Z", "type": "commit"}, {"oid": "0d267bc7416d66ec17aaa80e0b81fb96b26943d7", "url": "https://github.com/getodk/collect/commit/0d267bc7416d66ec17aaa80e0b81fb96b26943d7", "message": "Dismiss bottom sheet on back button press", "committedDate": "2020-05-21T13:46:11Z", "type": "commit"}, {"oid": "8c4a8cd0abaf0101a95f236d9cab9a0f58db00d3", "url": "https://github.com/getodk/collect/commit/8c4a8cd0abaf0101a95f236d9cab9a0f58db00d3", "message": "Grow the selected marker icon", "committedDate": "2020-05-22T09:14:04Z", "type": "commit"}, {"oid": "5c5e321694854dc9f8c52c32403e6931bb3df56a", "url": "https://github.com/getodk/collect/commit/5c5e321694854dc9f8c52c32403e6931bb3df56a", "message": "Fixed half expanded summary", "committedDate": "2020-05-22T10:25:35Z", "type": "commit"}, {"oid": "e6d1897a712ccb075e0a2d4ae8c87c52de7cc8e3", "url": "https://github.com/getodk/collect/commit/e6d1897a712ccb075e0a2d4ae8c87c52de7cc8e3", "message": "Fixed button text for uneditable forms", "committedDate": "2020-05-22T10:34:30Z", "type": "commit"}, {"oid": "11321aa5630576a564f09abdd145d2794cd944d4", "url": "https://github.com/getodk/collect/commit/11321aa5630576a564f09abdd145d2794cd944d4", "message": "Hide the summary sheet when a user clicks on the map", "committedDate": "2020-05-25T08:41:08Z", "type": "commit"}, {"oid": "290ae854b348bd9b6d57d812bcea27b71824af53", "url": "https://github.com/getodk/collect/commit/290ae854b348bd9b6d57d812bcea27b71824af53", "message": "Code improvements", "committedDate": "2020-05-25T17:31:30Z", "type": "commit"}, {"oid": "0d4bb6cd850bf3d91dbe799010705226d8607e7b", "url": "https://github.com/getodk/collect/commit/0d4bb6cd850bf3d91dbe799010705226d8607e7b", "message": "Fixed updating icons in MapBox", "committedDate": "2020-05-25T17:31:44Z", "type": "commit"}, {"oid": "b53e05877ccff7c262aac2bd45cb0b8e80412537", "url": "https://github.com/getodk/collect/commit/b53e05877ccff7c262aac2bd45cb0b8e80412537", "message": "Fixed hiding the sheet in MapBox", "committedDate": "2020-05-25T19:04:47Z", "type": "commit"}, {"oid": "37c9a209a40961a5d22e2f92d022fff05909f738", "url": "https://github.com/getodk/collect/commit/37c9a209a40961a5d22e2f92d022fff05909f738", "message": "Fixed pmd", "committedDate": "2020-05-25T19:05:12Z", "type": "commit"}, {"oid": "37c9a209a40961a5d22e2f92d022fff05909f738", "url": "https://github.com/getodk/collect/commit/37c9a209a40961a5d22e2f92d022fff05909f738", "message": "Fixed pmd", "committedDate": "2020-05-25T19:05:12Z", "type": "forcePushed"}, {"oid": "fc9413b54d0902065c76f84b0995e746a1d5df04", "url": "https://github.com/getodk/collect/commit/fc9413b54d0902065c76f84b0995e746a1d5df04", "message": "Fixed test", "committedDate": "2020-05-25T19:43:09Z", "type": "commit"}, {"oid": "c93b2c4ca707f6032dd3fa8b561f210bdfed7f5e", "url": "https://github.com/getodk/collect/commit/c93b2c4ca707f6032dd3fa8b561f210bdfed7f5e", "message": "Code improvements", "committedDate": "2020-05-25T20:44:42Z", "type": "commit"}, {"oid": "c93b2c4ca707f6032dd3fa8b561f210bdfed7f5e", "url": "https://github.com/getodk/collect/commit/c93b2c4ca707f6032dd3fa8b561f210bdfed7f5e", "message": "Code improvements", "committedDate": "2020-05-25T20:44:42Z", "type": "forcePushed"}, {"oid": "eed06c7b23314fbb37fc6cc6c21646d0fb6b81b5", "url": "https://github.com/getodk/collect/commit/eed06c7b23314fbb37fc6cc6c21646d0fb6b81b5", "message": "Added back required onResume() method", "committedDate": "2020-06-10T10:34:29Z", "type": "commit"}, {"oid": "a66f1fc34ce28ddab2355fe1d72b0e0c749df432", "url": "https://github.com/getodk/collect/commit/a66f1fc34ce28ddab2355fe1d72b0e0c749df432", "message": "Manage SelectedSubmissionId using viewModel", "committedDate": "2020-06-10T10:42:40Z", "type": "commit"}, {"oid": "f370a61cec15db0ae8ce5214a4a84a90c7e3f012", "url": "https://github.com/getodk/collect/commit/f370a61cec15db0ae8ce5214a4a84a90c7e3f012", "message": "Code improvements", "committedDate": "2020-06-10T11:06:34Z", "type": "commit"}, {"oid": "0d0913cad0ccbaf0273716244b440c65c451a928", "url": "https://github.com/getodk/collect/commit/0d0913cad0ccbaf0273716244b440c65c451a928", "message": "Fixed updatking markers after minimizing app", "committedDate": "2020-06-10T11:13:52Z", "type": "commit"}, {"oid": "6be25c5cf419e4a8ac053985ceaf51b3c592600b", "url": "https://github.com/getodk/collect/commit/6be25c5cf419e4a8ac053985ceaf51b3c592600b", "message": "Code improvements", "committedDate": "2020-06-10T11:40:56Z", "type": "commit"}, {"oid": "6be25c5cf419e4a8ac053985ceaf51b3c592600b", "url": "https://github.com/getodk/collect/commit/6be25c5cf419e4a8ac053985ceaf51b3c592600b", "message": "Code improvements", "committedDate": "2020-06-10T11:40:56Z", "type": "forcePushed"}, {"oid": "f1b74e260e00a59d3fd7b73958b772b37a14134a", "url": "https://github.com/getodk/collect/commit/f1b74e260e00a59d3fd7b73958b772b37a14134a", "message": "Fixed pin marker icon location", "committedDate": "2020-06-18T12:45:17Z", "type": "commit"}, {"oid": "a414cd20f6a03b1ff793870df41a8b4ed8544cdc", "url": "https://github.com/getodk/collect/commit/a414cd20f6a03b1ff793870df41a8b4ed8544cdc", "message": "Fixed tests", "committedDate": "2020-06-18T13:15:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg5NjkzOA==", "url": "https://github.com/getodk/collect/pull/3864#discussion_r443896938", "bodyText": "Use Scheduler", "author": "lognaturel", "createdAt": "2020-06-23T00:34:40Z", "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormMapActivity.java", "diffHunk": "@@ -211,9 +212,11 @@ public void initMap(MapFragment newMapFragment) {\n         map.setFeatureClickListener(this::onFeatureClicked);\n         updateInstanceGeometry();\n \n-        if (selectedSubmissionId != -1) {\n-            onFeatureClicked(selectedSubmissionId);\n-        }\n+        new Handler().postDelayed(() -> {", "originalCommit": "5c5e321694854dc9f8c52c32403e6931bb3df56a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzkxMDI1Nw==", "url": "https://github.com/getodk/collect/pull/3864#discussion_r443910257", "bodyText": "Right, @seadowg? We should try not to have raw Handlers anymore so we can easily keep all those implementations consistent?", "author": "lognaturel", "createdAt": "2020-06-23T01:27:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg5NjkzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDAzNDY0Ng==", "url": "https://github.com/getodk/collect/pull/3864#discussion_r444034646", "bodyText": "It's not merged yet, so I think using Handler for the moment is best. I'm not quite sure why this code needs a postDelayed though?", "author": "seadowg", "createdAt": "2020-06-23T07:58:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg5NjkzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEyMzcwNQ==", "url": "https://github.com/getodk/collect/pull/3864#discussion_r444123705", "bodyText": "It was a fix for #3828 (comment) but now I realized  it's still not perfect so I removed this trick at all. I'll try to find a better solution or leave it as-is since it's not a big problem.", "author": "grzesiek2010", "createdAt": "2020-06-23T10:28:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg5NjkzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI0NTIyMQ==", "url": "https://github.com/getodk/collect/pull/3864#discussion_r444245221", "bodyText": "Ok I tried to figure out what's wrong but it's difficult. Since it's a small issue that affects only Mapbox and OSM let's create a separate issue to avoid blocking this pr:\n\n@mmarciniak90 @kkrawczyk123 please keep it in mind.", "author": "grzesiek2010", "createdAt": "2020-06-23T13:58:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg5NjkzOA=="}], "type": "inlineReview", "revised_code": {"commit": "9c8b1271bbef42ed88f83162fb62dc50cd0ec5d1", "chunk": "diff --git a/collect_app/src/main/java/org/odk/collect/android/activities/FormMapActivity.java b/collect_app/src/main/java/org/odk/collect/android/activities/FormMapActivity.java\nindex 92cde81b5..805edff9c 100644\n--- a/collect_app/src/main/java/org/odk/collect/android/activities/FormMapActivity.java\n+++ b/collect_app/src/main/java/org/odk/collect/android/activities/FormMapActivity.java\n\n@@ -210,15 +209,23 @@ public class FormMapActivity extends BaseGeoMapActivity {\n         }\n \n         map.setFeatureClickListener(this::onFeatureClicked);\n+        map.setClickListener(this::onClick);\n         updateInstanceGeometry();\n \n         new Handler().postDelayed(() -> {\n-            if (selectedSubmissionId != -1) {\n-                onFeatureClicked(selectedSubmissionId);\n+            if (viewModel.getSelectedSubmissionId() != -1) {\n+                onFeatureClicked(viewModel.getSelectedSubmissionId());\n             }\n         }, 500);\n     }\n \n+    @SuppressWarnings(\"PMD.UnusedFormalParameter\")\n+    private void onClick(MapPoint mapPoint) {\n+        if (summarySheet.getState() == BottomSheetBehavior.STATE_EXPANDED) {\n+            summarySheet.setState(BottomSheetBehavior.STATE_HIDDEN);\n+        }\n+    }\n+\n     private void updateInstanceGeometry() {\n         if (map == null) {\n             return;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg5ODUwMg==", "url": "https://github.com/getodk/collect/pull/3864#discussion_r443898502", "bodyText": "Great, I had a note to request this change from previous commits. \ud83d\ude0a A further enhancement would be to use a LiveData<Instance> and to drive all of the bottom sheet behavior off of that. But I think this is fine.", "author": "lognaturel", "createdAt": "2020-06-23T00:40:16Z", "path": "collect_app/src/main/java/org/odk/collect/android/activities/viewmodels/FormMapViewModel.java", "diffHunk": "@@ -26,6 +26,7 @@\n      * The count of all filled instances of this form, including unmappable ones.\n      */\n     private int totalInstanceCount;\n+    private int selectedSubmissionId = -1;", "originalCommit": "a66f1fc34ce28ddab2355fe1d72b0e0c749df432", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzkwODY5Ng==", "url": "https://github.com/getodk/collect/pull/3864#discussion_r443908696", "bodyText": "Setting the anchor should only need to happen on marker creation. In general, the API created here feels awkward to me though I know it's tricky because of the different ways the three mapping engines represent anchors. Instead of introducing setMarkerAnchorToBottomCenter, how about adding an addMarker variant? Mapbox's Property.ICON_ANCHOR is a good example of introducing a type for this (see https://guides.codepath.com/android/Replacing-Enums-with-Enumerated-Annotations for more about the pattern used there). I'm thinking addMarker(MapPoint point, boolean draggable, @ICON_ANCHOR String iconAnchor). The ICON_ANCHOR annotation can be introduced in the MapFragment interface with just a single value for BOTTOM for now. Then each MapFragment can test for BOTTOM and do whatever they need to do to pass that on.\nI like that approach better because I don't think we'd ever want the anchor changing after a marker has been added so it better captures the semantics. Most importantly, it avoids the exact duplicate setMarkerAnchorToBottomCenter implementations and the instanceOf calls. I also like that it's a bit more flexible in case we need different anchors in the future (unlikely).", "author": "lognaturel", "createdAt": "2020-06-23T01:20:50Z", "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormMapActivity.java", "diffHunk": "@@ -207,20 +248,26 @@ private void updateInstanceGeometry() {\n     private void updateMapFeatures() {\n         points.clear();\n         map.clearFeatures();\n+        instancesByFeatureId.clear();\n \n         List<MappableFormInstance> instances = viewModel.getMappableFormInstances();\n         for (MappableFormInstance instance : instances) {\n             MapPoint point = new MapPoint(instance.getLatitude(), instance.getLongitude());\n             int featureId = map.addMarker(point, false);\n \n-            int drawableId = getDrawableIdForStatus(instance.getStatus());\n-            map.setMarkerIcon(featureId, drawableId);\n+            updateSubmissionMarker(featureId, instance.getStatus(), featureId == viewModel.getSelectedSubmissionId());\n \n             instancesByFeatureId.put(featureId, instance);\n             points.add(point);\n         }\n     }\n \n+    private void updateSubmissionMarker(int featureId, String status, boolean enlarged) {\n+        int drawableId = getDrawableIdForStatus(status, enlarged);\n+        map.setMarkerIcon(featureId, drawableId);\n+        map.setMarkerAnchorToBottomCenter(featureId);", "originalCommit": "a414cd20f6a03b1ff793870df41a8b4ed8544cdc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEwOTQ3MA==", "url": "https://github.com/getodk/collect/pull/3864#discussion_r444109470", "bodyText": "I agree your approach looks better. Thanks!\nDone.", "author": "grzesiek2010", "createdAt": "2020-06-23T10:02:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzkwODY5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "9c8b1271bbef42ed88f83162fb62dc50cd0ec5d1", "chunk": "diff --git a/collect_app/src/main/java/org/odk/collect/android/activities/FormMapActivity.java b/collect_app/src/main/java/org/odk/collect/android/activities/FormMapActivity.java\nindex 6993a4424..805edff9c 100644\n--- a/collect_app/src/main/java/org/odk/collect/android/activities/FormMapActivity.java\n+++ b/collect_app/src/main/java/org/odk/collect/android/activities/FormMapActivity.java\n\n@@ -253,7 +253,7 @@ public class FormMapActivity extends BaseGeoMapActivity {\n         List<MappableFormInstance> instances = viewModel.getMappableFormInstances();\n         for (MappableFormInstance instance : instances) {\n             MapPoint point = new MapPoint(instance.getLatitude(), instance.getLongitude());\n-            int featureId = map.addMarker(point, false);\n+            int featureId = map.addMarker(point, false, MapFragment.BOTTOM);\n \n             updateSubmissionMarker(featureId, instance.getStatus(), featureId == viewModel.getSelectedSubmissionId());\n \n"}}, {"oid": "9c8b1271bbef42ed88f83162fb62dc50cd0ec5d1", "url": "https://github.com/getodk/collect/commit/9c8b1271bbef42ed88f83162fb62dc50cd0ec5d1", "message": "Improved the way we deal with anchors", "committedDate": "2020-06-23T09:38:55Z", "type": "commit"}, {"oid": "9c8b1271bbef42ed88f83162fb62dc50cd0ec5d1", "url": "https://github.com/getodk/collect/commit/9c8b1271bbef42ed88f83162fb62dc50cd0ec5d1", "message": "Improved the way we deal with anchors", "committedDate": "2020-06-23T09:38:55Z", "type": "forcePushed"}, {"oid": "db1f14174c55305ca7223d3948c7c8bad51d50c5", "url": "https://github.com/getodk/collect/commit/db1f14174c55305ca7223d3948c7c8bad51d50c5", "message": "Fixed tests", "committedDate": "2020-06-23T09:49:00Z", "type": "commit"}, {"oid": "de2d584f8c9ca5f0b0de1a952f999b2b9a3ca7a2", "url": "https://github.com/getodk/collect/commit/de2d584f8c9ca5f0b0de1a952f999b2b9a3ca7a2", "message": "Removed redundant handler", "committedDate": "2020-06-23T13:14:23Z", "type": "commit"}, {"oid": "82fc355c949079149f48be14d369177d0180f3ac", "url": "https://github.com/getodk/collect/commit/82fc355c949079149f48be14d369177d0180f3ac", "message": "Code improvements", "committedDate": "2020-06-23T13:22:38Z", "type": "commit"}, {"oid": "82fc355c949079149f48be14d369177d0180f3ac", "url": "https://github.com/getodk/collect/commit/82fc355c949079149f48be14d369177d0180f3ac", "message": "Code improvements", "committedDate": "2020-06-23T13:22:38Z", "type": "forcePushed"}, {"oid": "abe46b9de370b72564e64fca5e5ad10fdc718ec3", "url": "https://github.com/getodk/collect/commit/abe46b9de370b72564e64fca5e5ad10fdc718ec3", "message": "Fixed not fully expanded submission sheet after clikcing on different markers", "committedDate": "2020-06-30T09:01:54Z", "type": "forcePushed"}, {"oid": "792a19dd236cce9a0e10c519a20d604e3bdb23aa", "url": "https://github.com/getodk/collect/commit/792a19dd236cce9a0e10c519a20d604e3bdb23aa", "message": "Fixed not fully expanded submission sheet after clikcing on different markers", "committedDate": "2020-06-30T09:30:35Z", "type": "commit"}, {"oid": "792a19dd236cce9a0e10c519a20d604e3bdb23aa", "url": "https://github.com/getodk/collect/commit/792a19dd236cce9a0e10c519a20d604e3bdb23aa", "message": "Fixed not fully expanded submission sheet after clikcing on different markers", "committedDate": "2020-06-30T09:30:35Z", "type": "forcePushed"}]}