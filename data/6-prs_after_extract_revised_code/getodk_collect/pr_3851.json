{"pr_number": 3851, "pr_title": "Fixed Dialog Button for Experimental Magenta Theme", "pr_createdAt": "2020-05-21T06:56:15Z", "pr_url": "https://github.com/getodk/collect/pull/3851", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM0OTQ5OA==", "url": "https://github.com/getodk/collect/pull/3851#discussion_r432349498", "bodyText": "Could this not use a ProgressDialogFragment instead?", "author": "seadowg", "createdAt": "2020-05-29T08:57:20Z", "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormDownloadListActivity.java", "diffHunk": "@@ -683,7 +684,7 @@ public void onClick(DialogInterface dialog, int i) {\n     }\n \n     private void createProgressDialog() {\n-        progressDialog = new ProgressDialog(this);\n+        progressDialog = new AlertDialog.Builder(this).create();", "originalCommit": "2a9ed6bc971a2514a627613b48b12c316d57d90c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYyNTc5Nw==", "url": "https://github.com/getodk/collect/pull/3851#discussion_r432625797", "bodyText": "Oh I didn't use ProgressDialogFrgament because I thought that the lifecycle changes are handled here by the ViewModel, so, I just used an AlertDialog instead. But, as I have read  in most of the articles like here, that using a dialog instead of fragment, and handling lifecycle changes by the use of some variable, is a bad practice, so I'll just switch to ProgressDialogFragment here.", "author": "SaumiaSinghal", "createdAt": "2020-05-29T17:14:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM0OTQ5OA=="}], "type": "inlineReview", "revised_code": {"commit": "3f1f34863ab75ab0d0bbc0a6974222a616589714", "chunk": "diff --git a/collect_app/src/main/java/org/odk/collect/android/activities/FormDownloadListActivity.java b/collect_app/src/main/java/org/odk/collect/android/activities/FormDownloadListActivity.java\nindex 77f2094b6..fdbd34d46 100644\n--- a/collect_app/src/main/java/org/odk/collect/android/activities/FormDownloadListActivity.java\n+++ b/collect_app/src/main/java/org/odk/collect/android/activities/FormDownloadListActivity.java\n\n@@ -683,52 +676,6 @@ public class FormDownloadListActivity extends FormListActivity implements FormLi\n         DialogUtils.showDialog(alertDialog, this);\n     }\n \n-    private void createProgressDialog() {\n-        progressDialog = new AlertDialog.Builder(this).create();\n-        DialogInterface.OnClickListener loadingButtonListener =\n-                new DialogInterface.OnClickListener() {\n-                    @Override\n-                    public void onClick(DialogInterface dialog, int which) {\n-                        // we use the same progress dialog for both\n-                        // so whatever isn't null is running\n-                        dialog.dismiss();\n-                        if (downloadFormListTask != null) {\n-                            downloadFormListTask.setDownloaderListener(null);\n-                            downloadFormListTask.cancel(true);\n-                            downloadFormListTask = null;\n-\n-                            // Only explicitly exit if DownloadFormListTask is running since\n-                            // DownloadFormTask has a callback when cancelled and has code to handle\n-                            // cancellation when in download mode only\n-                            if (viewModel.isDownloadOnlyMode()) {\n-                                setReturnResult(false, \"User cancelled the operation\", viewModel.getFormResults());\n-                                finish();\n-                            }\n-                        }\n-\n-                        if (downloadFormsTask != null) {\n-                            createCancelDialog();\n-                            downloadFormsTask.cancel(true);\n-                        }\n-                        viewModel.setLoadingCanceled(true);\n-                        viewModel.setProgressDialogShowing(false);\n-                    }\n-                };\n-\n-        progressDialog.setTitle(getString(R.string.downloading_data));\n-\n-        View dialogView = this.getLayoutInflater().inflate(R.layout.progress_dialog, null, false);\n-        TextView textView = dialogView.findViewById(R.id.message);\n-        textView.setText(viewModel.getProgressDialogMsg());\n-\n-        progressDialog.setView(dialogView);\n-        progressDialog.setIcon(android.R.drawable.ic_dialog_info);\n-        progressDialog.setCancelable(false);\n-        progressDialog.setButton(DialogInterface.BUTTON_NEGATIVE, getString(R.string.cancel), loadingButtonListener);\n-        viewModel.setProgressDialogShowing(true);\n-        DialogUtils.showDialog(progressDialog, this);\n-    }\n-\n     private void createAuthDialog() {\n         viewModel.setAlertShowing(false);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg1MTM4OQ==", "url": "https://github.com/getodk/collect/pull/3851#discussion_r433851389", "bodyText": "This is the right thing to do, but we have a helper that does it for you! You can use DialogUtils.dismissDialog should help you out here.", "author": "seadowg", "createdAt": "2020-06-02T12:53:27Z", "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormDownloadListActivity.java", "diffHunk": "@@ -253,26 +258,18 @@ public void onClick(View v) {\n         if (getLastCustomNonConfigurationInstance() instanceof DownloadFormListTask) {\n             downloadFormListTask = (DownloadFormListTask) getLastCustomNonConfigurationInstance();\n             if (downloadFormListTask.getStatus() == AsyncTask.Status.FINISHED) {\n-                try {\n-                    if (progressDialog != null && progressDialog.isShowing()) {\n-                        progressDialog.dismiss();\n-                    }\n-                    viewModel.setProgressDialogShowing(false);\n-                } catch (IllegalArgumentException e) {\n-                    Timber.i(\"Attempting to close a dialog that was not previously opened\");\n+                Fragment dialogFragment = getSupportFragmentManager().findFragmentByTag(ProgressDialogFragment.COLLECT_PROGRESS_DIALOG_TAG);", "originalCommit": "30b6145ba5af9bbfd7da28087861efb31bb92e73", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "95637da39bb9261d5a72b307438e839f30450a5a", "chunk": "diff --git a/collect_app/src/main/java/org/odk/collect/android/activities/FormDownloadListActivity.java b/collect_app/src/main/java/org/odk/collect/android/activities/FormDownloadListActivity.java\nindex c856a1654..77f2094b6 100644\n--- a/collect_app/src/main/java/org/odk/collect/android/activities/FormDownloadListActivity.java\n+++ b/collect_app/src/main/java/org/odk/collect/android/activities/FormDownloadListActivity.java\n\n@@ -258,18 +254,26 @@ public class FormDownloadListActivity extends FormListActivity implements FormLi\n         if (getLastCustomNonConfigurationInstance() instanceof DownloadFormListTask) {\n             downloadFormListTask = (DownloadFormListTask) getLastCustomNonConfigurationInstance();\n             if (downloadFormListTask.getStatus() == AsyncTask.Status.FINISHED) {\n-                Fragment dialogFragment = getSupportFragmentManager().findFragmentByTag(ProgressDialogFragment.COLLECT_PROGRESS_DIALOG_TAG);\n-                if (dialogFragment != null) {\n-                    ((DialogFragment) dialogFragment).dismiss();\n+                try {\n+                    if (progressDialog != null && progressDialog.isShowing()) {\n+                        progressDialog.dismiss();\n+                    }\n+                    viewModel.setProgressDialogShowing(false);\n+                } catch (IllegalArgumentException e) {\n+                    Timber.i(\"Attempting to close a dialog that was not previously opened\");\n                 }\n                 downloadFormsTask = null;\n             }\n         } else if (getLastCustomNonConfigurationInstance() instanceof DownloadFormsTask) {\n             downloadFormsTask = (DownloadFormsTask) getLastCustomNonConfigurationInstance();\n             if (downloadFormsTask.getStatus() == AsyncTask.Status.FINISHED) {\n-                Fragment dialogFragment = getSupportFragmentManager().findFragmentByTag(ProgressDialogFragment.COLLECT_PROGRESS_DIALOG_TAG);\n-                if (dialogFragment != null) {\n-                    ((DialogFragment) dialogFragment).dismiss();\n+                try {\n+                    if (progressDialog != null && progressDialog.isShowing()) {\n+                        progressDialog.dismiss();\n+                    }\n+                    viewModel.setProgressDialogShowing(false);\n+                } catch (IllegalArgumentException e) {\n+                    Timber.i(\"Attempting to close a dialog that was not previously opened\");\n                 }\n                 downloadFormsTask = null;\n             }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg1MTg0Nw==", "url": "https://github.com/getodk/collect/pull/3851#discussion_r433851847", "bodyText": "Like with dismissing you can use DialogUtils.showIfNotShowing. Sorry I should have pointed those out before leading you down the ProgressDialogFragment path!", "author": "seadowg", "createdAt": "2020-06-02T12:54:16Z", "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormDownloadListActivity.java", "diffHunk": "@@ -321,11 +318,8 @@ private void downloadFormList() {\n             }\n         } else {\n             viewModel.clearFormDetailsByFormId();\n-            if (progressDialog != null) {\n-                // This is needed because onPrepareDialog() is broken in 1.6.\n-                progressDialog.setMessage(viewModel.getProgressDialogMsg());\n-            }\n-            createProgressDialog();\n+            refreshFormListDialogFragment = new RefreshFormListDialogFragment();\n+            refreshFormListDialogFragment.show(getSupportFragmentManager(), ProgressDialogFragment.COLLECT_PROGRESS_DIALOG_TAG);", "originalCommit": "30b6145ba5af9bbfd7da28087861efb31bb92e73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg3MDkxNw==", "url": "https://github.com/getodk/collect/pull/3851#discussion_r433870917", "bodyText": "That's okay! Actually I have used DialogUtils.showIfNotShowing before \ud83d\ude1e", "author": "SaumiaSinghal", "createdAt": "2020-06-02T13:23:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg1MTg0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "95637da39bb9261d5a72b307438e839f30450a5a", "chunk": "diff --git a/collect_app/src/main/java/org/odk/collect/android/activities/FormDownloadListActivity.java b/collect_app/src/main/java/org/odk/collect/android/activities/FormDownloadListActivity.java\nindex c856a1654..77f2094b6 100644\n--- a/collect_app/src/main/java/org/odk/collect/android/activities/FormDownloadListActivity.java\n+++ b/collect_app/src/main/java/org/odk/collect/android/activities/FormDownloadListActivity.java\n\n@@ -318,8 +322,11 @@ public class FormDownloadListActivity extends FormListActivity implements FormLi\n             }\n         } else {\n             viewModel.clearFormDetailsByFormId();\n-            refreshFormListDialogFragment = new RefreshFormListDialogFragment();\n-            refreshFormListDialogFragment.show(getSupportFragmentManager(), ProgressDialogFragment.COLLECT_PROGRESS_DIALOG_TAG);\n+            if (progressDialog != null) {\n+                // This is needed because onPrepareDialog() is broken in 1.6.\n+                progressDialog.setMessage(viewModel.getProgressDialogMsg());\n+            }\n+            createProgressDialog();\n \n             if (downloadFormListTask != null\n                     && downloadFormListTask.getStatus() != AsyncTask.Status.FINISHED) {\n"}}, {"oid": "95637da39bb9261d5a72b307438e839f30450a5a", "url": "https://github.com/getodk/collect/commit/95637da39bb9261d5a72b307438e839f30450a5a", "message": "used alert dialog with view progress_dialog.xml in form download list", "committedDate": "2020-06-04T11:47:44Z", "type": "commit"}, {"oid": "ebca7c6d8f197e93d12b77a8137dd4fbd4394781", "url": "https://github.com/getodk/collect/commit/ebca7c6d8f197e93d12b77a8137dd4fbd4394781", "message": "shifted text appearance attribute from xml to progress dialog fragment", "committedDate": "2020-06-04T11:47:44Z", "type": "commit"}, {"oid": "878a0307ed14c28ba4d3e30b8c9af35189ecea69", "url": "https://github.com/getodk/collect/commit/878a0307ed14c28ba4d3e30b8c9af35189ecea69", "message": "move text appearance to progress_dialog.xml file", "committedDate": "2020-06-04T11:47:44Z", "type": "commit"}, {"oid": "9f30b7e7c04fd1671e7f46ca76573148955228e9", "url": "https://github.com/getodk/collect/commit/9f30b7e7c04fd1671e7f46ca76573148955228e9", "message": "create Refresh Form dialog fragment", "committedDate": "2020-06-04T11:47:44Z", "type": "commit"}, {"oid": "9dae961c4b33f71f291e0e102736c05a71e11599", "url": "https://github.com/getodk/collect/commit/9dae961c4b33f71f291e0e102736c05a71e11599", "message": "added test", "committedDate": "2020-06-04T11:47:44Z", "type": "commit"}, {"oid": "3f1f34863ab75ab0d0bbc0a6974222a616589714", "url": "https://github.com/getodk/collect/commit/3f1f34863ab75ab0d0bbc0a6974222a616589714", "message": "replace alert dialog with RefreshFormListDialogFragment", "committedDate": "2020-06-04T11:47:44Z", "type": "commit"}, {"oid": "bafab3c3bc221f12e97ad34dffac72f70a8ec229", "url": "https://github.com/getodk/collect/commit/bafab3c3bc221f12e97ad34dffac72f70a8ec229", "message": "fixed checkstyle", "committedDate": "2020-06-04T11:47:44Z", "type": "commit"}, {"oid": "0726e5b22f2bf36000ab99dd13b4015e1944c4b9", "url": "https://github.com/getodk/collect/commit/0726e5b22f2bf36000ab99dd13b4015e1944c4b9", "message": "add unit test", "committedDate": "2020-06-04T11:47:44Z", "type": "commit"}, {"oid": "1e02111af2dc58b7dd8c7b4244bcfaa330405155", "url": "https://github.com/getodk/collect/commit/1e02111af2dc58b7dd8c7b4244bcfaa330405155", "message": "replace fargment.dismiss() by DialogUtils.dismissDialog()", "committedDate": "2020-06-04T11:47:44Z", "type": "commit"}, {"oid": "24c295bb9e3570ad1a12e8b9d9e72feefaa159f8", "url": "https://github.com/getodk/collect/commit/24c295bb9e3570ad1a12e8b9d9e72feefaa159f8", "message": "replace fragment.show() by DialogUtils.showIfNotShowing()", "committedDate": "2020-06-04T11:47:44Z", "type": "commit"}, {"oid": "24c295bb9e3570ad1a12e8b9d9e72feefaa159f8", "url": "https://github.com/getodk/collect/commit/24c295bb9e3570ad1a12e8b9d9e72feefaa159f8", "message": "replace fragment.show() by DialogUtils.showIfNotShowing()", "committedDate": "2020-06-04T11:47:44Z", "type": "forcePushed"}]}