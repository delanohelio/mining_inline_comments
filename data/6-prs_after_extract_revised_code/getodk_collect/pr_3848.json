{"pr_number": 3848, "pr_title": "Improvements to Espresso tests to make tests more stable", "pr_createdAt": "2020-05-20T11:45:32Z", "pr_url": "https://github.com/getodk/collect/pull/3848", "timeline": [{"oid": "aae44cbd87588518a4292716e7fdc4fb5a3728a5", "url": "https://github.com/getodk/collect/commit/aae44cbd87588518a4292716e7fdc4fb5a3728a5", "message": "Make tools for dealing with postValue in Espresso", "committedDate": "2020-05-18T15:38:05Z", "type": "commit"}, {"oid": "9f40ef0bd1b45a9997bf75c98fb718f3f9a42707", "url": "https://github.com/getodk/collect/commit/9f40ef0bd1b45a9997bf75c98fb718f3f9a42707", "message": "Add permissions to AdminSettingsTest", "committedDate": "2020-05-18T16:33:17Z", "type": "commit"}, {"oid": "de07ed32e95e535b975cf0ad775fba97df9f1c13", "url": "https://github.com/getodk/collect/commit/de07ed32e95e535b975cf0ad775fba97df9f1c13", "message": "Rename test rule", "committedDate": "2020-05-18T16:36:13Z", "type": "commit"}, {"oid": "5bd941813d95a0121845e98ffb6eafe341eb762a", "url": "https://github.com/getodk/collect/commit/5bd941813d95a0121845e98ffb6eafe341eb762a", "message": "Use rule chain in regression tests", "committedDate": "2020-05-18T17:01:32Z", "type": "commit"}, {"oid": "542b2f74e170e993c1e16186bf97ce81420fe19b", "url": "https://github.com/getodk/collect/commit/542b2f74e170e993c1e16186bf97ce81420fe19b", "message": "Add assertion to repeat swipes", "committedDate": "2020-05-19T12:39:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk1MjExNw==", "url": "https://github.com/getodk/collect/pull/3848#discussion_r427952117", "bodyText": "This test needed permissions but as we've seen before it's important to chain the rules so permissions are definitely granted before any Activities launch.", "author": "seadowg", "createdAt": "2020-05-20T12:00:11Z", "path": "collect_app/src/androidTest/java/org/odk/collect/android/regression/AdminSettingsTest.java", "diffHunk": "@@ -1,20 +1,38 @@\n package org.odk.collect.android.regression;\n \n+import android.Manifest;\n+\n+import androidx.test.rule.GrantPermissionRule;\n import androidx.test.runner.AndroidJUnit4;\n \n+import org.junit.Rule;\n import org.junit.Test;\n+import org.junit.rules.RuleChain;\n import org.junit.runner.RunWith;\n+import org.odk.collect.android.support.CollectTestRule;\n+import org.odk.collect.android.support.ResetStateRule;\n import org.odk.collect.android.support.pages.AdminSettingsPage;\n-import org.odk.collect.android.support.pages.MainMenuPage;\n \n //Issue NODK-239\n @RunWith(AndroidJUnit4.class)\n-public class AdminSettingsTest extends BaseRegressionTest {\n+public class AdminSettingsTest {\n+\n+    public CollectTestRule rule = new CollectTestRule();\n+\n+    @Rule\n+    public RuleChain copyFormChain = RuleChain\n+            .outerRule(GrantPermissionRule.grant(\n+                    Manifest.permission.READ_EXTERNAL_STORAGE,\n+                    Manifest.permission.WRITE_EXTERNAL_STORAGE,\n+                    Manifest.permission.READ_PHONE_STATE\n+            ))\n+            .around(new ResetStateRule())\n+            .around(rule);", "originalCommit": "542b2f74e170e993c1e16186bf97ce81420fe19b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk1MzYzOQ==", "url": "https://github.com/getodk/collect/pull/3848#discussion_r427953639", "bodyText": "There is some good docs on IdlingResource here. It seems Espresso is moving towards needing them more and more so it doesn't have to integrate with all the different scheduler mechanisms in Android (Handler, ArchTaskExectuor, coroutines and WorkManager to name a few).", "author": "seadowg", "createdAt": "2020-05-20T12:03:09Z", "path": "collect_app/src/androidTest/java/org/odk/collect/android/support/CountingTaskExecutorIdlingResource.java", "diffHunk": "@@ -0,0 +1,34 @@\n+package org.odk.collect.android.support;\n+\n+import androidx.arch.core.executor.testing.CountingTaskExecutorRule;\n+import androidx.test.espresso.IdlingResource;\n+\n+public class CountingTaskExecutorIdlingResource implements IdlingResource {", "originalCommit": "542b2f74e170e993c1e16186bf97ce81420fe19b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ1Mzk5Nw==", "url": "https://github.com/getodk/collect/pull/3848#discussion_r431453997", "bodyText": "Did the person on the issue you filed about WorkManager and Espresso ever get back to you and was this the answer?", "author": "lognaturel", "createdAt": "2020-05-27T21:30:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk1MzYzOQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk1NDEyMw==", "url": "https://github.com/getodk/collect/pull/3848#discussion_r427954123", "bodyText": "We might need to move all of our swipeToX helpers to this kind of style. It's definitely safer for us to have assertions with actions like gestures that can be performed on any screen.", "author": "seadowg", "createdAt": "2020-05-20T12:04:08Z", "path": "collect_app/src/androidTest/java/org/odk/collect/android/support/pages/FormEntryPage.java", "diffHunk": "@@ -54,6 +54,15 @@ public FormEntryPage swipeToNextQuestion(int repetitions) {\n         return this;\n     }\n \n+    public FormEntryPage swipeToNextRepeat(String repeatLabel, int repeatNumber) {\n+        tryAgainOnFail(() -> {\n+            onView(withId(R.id.questionholder)).perform(swipeLeft());", "originalCommit": "542b2f74e170e993c1e16186bf97ce81420fe19b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}