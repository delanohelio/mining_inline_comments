{"pr_number": 4221, "pr_title": "Don't always save media captured through Collect to the Media Store", "pr_createdAt": "2020-11-13T22:58:03Z", "pr_url": "https://github.com/getodk/collect/pull/4221", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ5MzU4MA==", "url": "https://github.com/getodk/collect/pull/4221#discussion_r524493580", "bodyText": "Funny, I've looked at this code and all the related methods in MediaUtils a few times wondering why we were going through a content resolver instead of just accessing the files directly and it never clicked that it was part of all this business with the Media Store. I really wonder why it was done that way.", "author": "lognaturel", "createdAt": "2020-11-16T18:45:10Z", "path": "collect_app/src/main/java/org/odk/collect/android/utilities/MediaUtils.java", "diffHunk": "@@ -91,49 +93,8 @@ public static final Uri getImageUriFromMediaProvider(String imageFile) {\n         }\n     }\n \n-    public int deleteImageFileFromMediaProvider(String imageFile) {", "originalCommit": "7d8f65f6f3e1c35a2901675d6eade4d2beb41802", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDU3MzY2MQ==", "url": "https://github.com/getodk/collect/pull/4221#discussion_r524573661", "bodyText": "Yeah it's difficult to tell what the reason was.", "author": "grzesiek2010", "createdAt": "2020-11-16T21:00:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ5MzU4MA=="}], "type": "inlineReview", "revised_code": {"commit": "e5b0d358a101d7128c112a0a7cb8268dd55dc58c", "chunk": "diff --git a/collect_app/src/main/java/org/odk/collect/android/utilities/MediaUtils.java b/collect_app/src/main/java/org/odk/collect/android/utilities/MediaUtils.java\nindex 084b1fe69..e2c5ed4e1 100644\n--- a/collect_app/src/main/java/org/odk/collect/android/utilities/MediaUtils.java\n+++ b/collect_app/src/main/java/org/odk/collect/android/utilities/MediaUtils.java\n\n@@ -93,8 +91,49 @@ public class MediaUtils {\n         }\n     }\n \n-    public void deleteImageFileFromMediaProvider(String imageFile) {\n-        deleteAndReport(new File(imageFile));\n+    public int deleteImageFileFromMediaProvider(String imageFile) {\n+        ContentResolver cr = Collect.getInstance().getContentResolver();\n+        // images\n+        int count = 0;\n+        Cursor imageCursor = null;\n+        try {\n+            String select = Images.Media.DATA + \"=?\";\n+            String[] selectArgs = {imageFile};\n+\n+            String[] projection = {Images.ImageColumns._ID};\n+            imageCursor = cr\n+                    .query(android.provider.MediaStore.Images.Media.EXTERNAL_CONTENT_URI,\n+                            projection, select, selectArgs, null);\n+            if (imageCursor.getCount() > 0) {\n+                imageCursor.moveToFirst();\n+                List<Uri> imagesToDelete = new ArrayList<>();\n+                do {\n+                    String id = imageCursor.getString(imageCursor\n+                            .getColumnIndex(Images.ImageColumns._ID));\n+\n+                    imagesToDelete\n+                            .add(Uri.withAppendedPath(\n+                                    android.provider.MediaStore.Images.Media.EXTERNAL_CONTENT_URI,\n+                                    id));\n+                } while (imageCursor.moveToNext());\n+\n+                for (Uri uri : imagesToDelete) {\n+                    Timber.i(\"attempting to delete: %s\", uri.toString());\n+                    count += cr.delete(uri, null, null);\n+                }\n+            }\n+        } catch (Exception e) {\n+            Timber.e(e, \"Unable to delete image file from media provider\");\n+        } finally {\n+            if (imageCursor != null) {\n+                imageCursor.close();\n+            }\n+        }\n+        File f = new File(imageFile);\n+        if (f.exists()) {\n+            f.delete();\n+        }\n+        return count;\n     }\n \n     public static final int deleteImagesInFolderFromMediaProvider(File folder) {\n"}}, {"oid": "e5b0d358a101d7128c112a0a7cb8268dd55dc58c", "url": "https://github.com/getodk/collect/commit/e5b0d358a101d7128c112a0a7cb8268dd55dc58c", "message": "Do not add images to mediastore", "committedDate": "2020-11-20T09:36:44Z", "type": "commit"}, {"oid": "5bbda8cd8e16b5b0150c2b6a9bb305772e32f937", "url": "https://github.com/getodk/collect/commit/5bbda8cd8e16b5b0150c2b6a9bb305772e32f937", "message": "Do not add videos to mediastore", "committedDate": "2020-11-20T09:36:44Z", "type": "commit"}, {"oid": "f1c4cb694692011f187043f6867af26f22224eff", "url": "https://github.com/getodk/collect/commit/f1c4cb694692011f187043f6867af26f22224eff", "message": "Do not add audios to mediastore", "committedDate": "2020-11-20T09:36:44Z", "type": "commit"}, {"oid": "c0f7f46def6e6d89993c865a624bebc0e8e7a9f2", "url": "https://github.com/getodk/collect/commit/c0f7f46def6e6d89993c865a624bebc0e8e7a9f2", "message": "Got rid of removing images using mediastore", "committedDate": "2020-11-20T09:36:44Z", "type": "commit"}, {"oid": "60cdde394276ee308d2d5a18e9149e62483fe4c4", "url": "https://github.com/getodk/collect/commit/60cdde394276ee308d2d5a18e9149e62483fe4c4", "message": "Do not remove media files separately using mediastore", "committedDate": "2020-11-20T09:36:44Z", "type": "commit"}, {"oid": "ebef97aeca6006a1b3673aa9911410ee317c48f8", "url": "https://github.com/getodk/collect/commit/ebef97aeca6006a1b3673aa9911410ee317c48f8", "message": "Removed unused code", "committedDate": "2020-11-20T09:36:44Z", "type": "commit"}, {"oid": "0dc5c163432f91c02e4067a443bd10f6df35e449", "url": "https://github.com/getodk/collect/commit/0dc5c163432f91c02e4067a443bd10f6df35e449", "message": "Naming improvements", "committedDate": "2020-11-20T09:36:44Z", "type": "commit"}, {"oid": "41104d55ca92510b0e2a055f443e0e65c79a858c", "url": "https://github.com/getodk/collect/commit/41104d55ca92510b0e2a055f443e0e65c79a858c", "message": "Removed redundant MediaUtil class", "committedDate": "2020-11-20T09:36:44Z", "type": "commit"}, {"oid": "6094f2303ec9adeb5ad21127b2485f7e6b797247", "url": "https://github.com/getodk/collect/commit/6094f2303ec9adeb5ad21127b2485f7e6b797247", "message": "Factored out openFile() method from ArbitraryFileWidget to MediaUtils class", "committedDate": "2020-11-20T09:36:44Z", "type": "commit"}, {"oid": "5ac48f6f7a0221dbbcb2033133dcbe0babad1639", "url": "https://github.com/getodk/collect/commit/5ac48f6f7a0221dbbcb2033133dcbe0babad1639", "message": "Open images using the same code we use in case of arbitrary files", "committedDate": "2020-11-20T09:36:44Z", "type": "commit"}, {"oid": "6e6f405a98155fa5352be93267ec68f569390dd4", "url": "https://github.com/getodk/collect/commit/6e6f405a98155fa5352be93267ec68f569390dd4", "message": "Removed unused code", "committedDate": "2020-11-20T09:36:44Z", "type": "commit"}, {"oid": "7aabb203b8e2135a9dc88d0ee5db0b13016aee39", "url": "https://github.com/getodk/collect/commit/7aabb203b8e2135a9dc88d0ee5db0b13016aee39", "message": "Moved getDestinationPathFromSourcePath() to MediaUtils", "committedDate": "2020-11-20T09:36:44Z", "type": "commit"}, {"oid": "645a1b84dea39ca98580f58c4b07609f20c440b5", "url": "https://github.com/getodk/collect/commit/645a1b84dea39ca98580f58c4b07609f20c440b5", "message": "Code improvements", "committedDate": "2020-11-20T09:36:44Z", "type": "commit"}, {"oid": "35e9473587f3f24b91a52c4553a9f4c1279bc188", "url": "https://github.com/getodk/collect/commit/35e9473587f3f24b91a52c4553a9f4c1279bc188", "message": "Fixed tests", "committedDate": "2020-11-20T09:36:44Z", "type": "commit"}, {"oid": "35e9473587f3f24b91a52c4553a9f4c1279bc188", "url": "https://github.com/getodk/collect/commit/35e9473587f3f24b91a52c4553a9f4c1279bc188", "message": "Fixed tests", "committedDate": "2020-11-20T09:36:44Z", "type": "forcePushed"}]}