{"pr_number": 4191, "pr_title": "Changes in metadata required to update the app to API 29", "pr_createdAt": "2020-10-28T15:36:18Z", "pr_url": "https://github.com/getodk/collect/pull/4191", "timeline": [{"oid": "3294e55e001c00eee450c470c612a3fd677ac995", "url": "https://github.com/getodk/collect/commit/3294e55e001c00eee450c470c612a3fd677ac995", "message": "Removed subscriberID", "committedDate": "2020-10-28T11:59:23Z", "type": "commit"}, {"oid": "88ae424672a73e72cddf717563f8645b8c764e28", "url": "https://github.com/getodk/collect/commit/88ae424672a73e72cddf717563f8645b8c764e28", "message": "Removed simserial", "committedDate": "2020-10-28T12:46:18Z", "type": "commit"}, {"oid": "acfa8712e19498ea15b8c4a9ad0b44ac1701fc89", "url": "https://github.com/getodk/collect/commit/acfa8712e19498ea15b8c4a9ad0b44ac1701fc89", "message": "Removed installId", "committedDate": "2020-10-28T13:10:40Z", "type": "commit"}, {"oid": "e268ce02970942f282ab6d2a823392e28691ad93", "url": "https://github.com/getodk/collect/commit/e268ce02970942f282ab6d2a823392e28691ad93", "message": "Replaced value of deviceID with installID", "committedDate": "2020-10-28T14:00:03Z", "type": "commit"}, {"oid": "8696564177411aae330708d5f7393279f8149a09", "url": "https://github.com/getodk/collect/commit/8696564177411aae330708d5f7393279f8149a09", "message": "Fixed tests", "committedDate": "2020-10-28T14:20:35Z", "type": "commit"}, {"oid": "799484a27910506a564810d4c4e6a8cc9ce2e0f8", "url": "https://github.com/getodk/collect/commit/799484a27910506a564810d4c4e6a8cc9ce2e0f8", "message": "No longer treat deviceId property as dangerous", "committedDate": "2020-10-28T15:26:42Z", "type": "commit"}, {"oid": "50ec197e27afa78cca6dd3eea331a5d6db74c9d0", "url": "https://github.com/getodk/collect/commit/50ec197e27afa78cca6dd3eea331a5d6db74c9d0", "message": "Code improvements", "committedDate": "2020-10-28T21:59:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYyOTU4MQ==", "url": "https://github.com/getodk/collect/pull/4191#discussion_r514629581", "bodyText": "What effect does having SCHEME_IMEI here have? Seems it should be collect, maybe?", "author": "lognaturel", "createdAt": "2020-10-29T23:44:55Z", "path": "collect_app/src/main/java/org/odk/collect/android/logic/PropertyManager.java", "diffHunk": "@@ -112,12 +92,8 @@ public PropertyManager(Application application, RxEventBus rxEventBus, Permissio\n \n     public PropertyManager reload() {\n         try {\n-            // Device-defined properties\n-            IdAndPrefix idp = findDeviceId(context, deviceDetailsProvider);\n-            putProperty(PROPMGR_DEVICE_ID,     idp.prefix,          idp.id);\n+            putProperty(PROPMGR_DEVICE_ID,     SCHEME_IMEI,         deviceDetailsProvider.getDeviceId());", "originalCommit": "50ec197e27afa78cca6dd3eea331a5d6db74c9d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTA5Nzg3MA==", "url": "https://github.com/getodk/collect/pull/4191#discussion_r515097870", "bodyText": "That's a good question, I wanted to ask about it because I'm not sure... I kept SCHEME_IMEI for now but it's not IMEI anymore so it doesn't make much sense. I could do what you say and add collect: but our new device id is already like collect:5sf45sf5dsf5d4f (it starts with collect: always) so a result the value with scheme would be collect:collect:5sf45sf5dsf5d4f\nOf course depends where we use it because in settings and in a form it would be still just collect:5sf45sf5dsf5d4f (because there we get the value without scheme) but during sending a form we use:\ndeviceId = new PropertyManager(Collect.getInstance().getApplicationContext())\n                    .getSingularProperty(PropertyManager.withUri(PropertyManager.PROPMGR_DEVICE_ID));\n\nwhat will return doubled collect:\ncollect:collect:5sf45sf5dsf5d4f \nmaybe we should get rid of that prefix collect: which now is a part of device id and add it instead of SCHEME_IMEI so as a result in settings and in a form we would have 5sf45sf5dsf5d4f but sending forms it would be collect:5sf45sf5dsf5d4f?\n@lognaturel @seadowg", "author": "grzesiek2010", "createdAt": "2020-10-30T13:31:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYyOTU4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTE1OTY1Mg==", "url": "https://github.com/getodk/collect/pull/4191#discussion_r515159652", "bodyText": "Interesting, I didn't realize there was that difference between in-form and at submission time. I think they should be consistent and both include the scheme. How about just using the literal String \"\" as the scheme here?", "author": "lognaturel", "createdAt": "2020-10-30T14:56:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYyOTU4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIxMDc3MQ==", "url": "https://github.com/getodk/collect/pull/4191#discussion_r515210771", "bodyText": "That would be a solution, what do you think @seadowg?", "author": "grzesiek2010", "createdAt": "2020-10-30T16:08:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYyOTU4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg0NDcwNQ==", "url": "https://github.com/getodk/collect/pull/4191#discussion_r515844705", "bodyText": "Ah yeah I hadn't realized PropertyManager expects a scheme here. I think passing \"\" as the scheme makes the most sense to me as because then (as @lognaturel points out) it'll be displayed consistently.\nWe could then just add a putProperty(String propName, String value) that doesn't append a scheme (or just calls the other putProperty with \"\").", "author": "seadowg", "createdAt": "2020-11-02T09:36:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYyOTU4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg5NjA2NA==", "url": "https://github.com/getodk/collect/pull/4191#discussion_r515896064", "bodyText": "Ok, I removed that scheme but I needed to add some extra changes in InstanceServerUploaderTask and InstanceSubmitter where we access that property to avoid using PropertyManager.withUri because then even if the scheme is empty we would have an extra semicolon left, like: :collect:5sf45sf5dsf5d4f .\nAll the changes are in my last commit:\n94e954c", "author": "grzesiek2010", "createdAt": "2020-11-02T11:03:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYyOTU4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "2e04b4984323989402ff7af1fdae9ce2566f50d8", "chunk": "diff --git a/collect_app/src/main/java/org/odk/collect/android/logic/PropertyManager.java b/collect_app/src/main/java/org/odk/collect/android/logic/PropertyManager.java\nindex 316abc283..e707ed791 100644\n--- a/collect_app/src/main/java/org/odk/collect/android/logic/PropertyManager.java\n+++ b/collect_app/src/main/java/org/odk/collect/android/logic/PropertyManager.java\n\n@@ -92,7 +91,7 @@ public class PropertyManager implements IPropertyManager {\n \n     public PropertyManager reload() {\n         try {\n-            putProperty(PROPMGR_DEVICE_ID,     SCHEME_IMEI,         deviceDetailsProvider.getDeviceId());\n+            putProperty(PROPMGR_DEVICE_ID,      \"\",          deviceDetailsProvider.getDeviceId());\n             putProperty(PROPMGR_PHONE_NUMBER,  SCHEME_TEL,          deviceDetailsProvider.getLine1Number());\n         } catch (SecurityException e) {\n             Timber.e(e);\n"}}, {"oid": "2e04b4984323989402ff7af1fdae9ce2566f50d8", "url": "https://github.com/getodk/collect/commit/2e04b4984323989402ff7af1fdae9ce2566f50d8", "message": "Removed deviceID scheme", "committedDate": "2020-11-02T10:43:42Z", "type": "forcePushed"}, {"oid": "50ec197e27afa78cca6dd3eea331a5d6db74c9d0", "url": "https://github.com/getodk/collect/commit/50ec197e27afa78cca6dd3eea331a5d6db74c9d0", "message": "Code improvements", "committedDate": "2020-10-28T21:59:52Z", "type": "forcePushed"}, {"oid": "94e954c9456be9b5654fc759d80c31bac9da5c28", "url": "https://github.com/getodk/collect/commit/94e954c9456be9b5654fc759d80c31bac9da5c28", "message": "Removed deviceID scheme", "committedDate": "2020-11-02T10:53:10Z", "type": "commit"}]}