{"pr_number": 4242, "pr_title": "Fixed: Minimal appearance doesn't work with \"fast external itemsets\"", "pr_createdAt": "2020-11-24T14:20:22Z", "pr_url": "https://github.com/getodk/collect/pull/4242", "timeline": [{"oid": "c59db03565d0ba8206718f06440c9cb9de4c5c7f", "url": "https://github.com/getodk/collect/commit/c59db03565d0ba8206718f06440c9cb9de4c5c7f", "message": "Factored out FastExternalItemsReader class", "committedDate": "2020-11-23T09:56:14Z", "type": "commit"}, {"oid": "4dd1c7b16732c5bd3432461121e7b6c31c060199", "url": "https://github.com/getodk/collect/commit/4dd1c7b16732c5bd3432461121e7b6c31c060199", "message": "Read fast external items in ItemsWidget using FastExternalItemsReader", "committedDate": "2020-11-23T09:59:58Z", "type": "commit"}, {"oid": "5460a71e2db8739740e222a2de60bd19a6e62dbe", "url": "https://github.com/getodk/collect/commit/5460a71e2db8739740e222a2de60bd19a6e62dbe", "message": "Removed redundant ItemsetWidget", "committedDate": "2020-11-23T10:03:08Z", "type": "commit"}, {"oid": "7f545071ac4174528f9d9c53309b254ff408e38e", "url": "https://github.com/getodk/collect/commit/7f545071ac4174528f9d9c53309b254ff408e38e", "message": "Fixed pmd issues", "committedDate": "2020-11-23T10:11:05Z", "type": "commit"}, {"oid": "de9dfb3ee05353d9f63a4ae1729e6d45fe782b1f", "url": "https://github.com/getodk/collect/commit/de9dfb3ee05353d9f63a4ae1729e6d45fe782b1f", "message": "Display a warrning when csv file is missing", "committedDate": "2020-11-23T10:20:45Z", "type": "commit"}, {"oid": "0ded299e694a554a877bd2c2ba3d6ae74fdddf18", "url": "https://github.com/getodk/collect/commit/0ded299e694a554a877bd2c2ba3d6ae74fdddf18", "message": "Handle XPathSyntaxException while reading fast external items", "committedDate": "2020-11-23T10:31:12Z", "type": "commit"}, {"oid": "3dc90ff1887801f5a7edfbaa69a2e77e46155df7", "url": "https://github.com/getodk/collect/commit/3dc90ff1887801f5a7edfbaa69a2e77e46155df7", "message": "Code improvements in ItemsWidget", "committedDate": "2020-11-23T10:32:35Z", "type": "commit"}, {"oid": "6373f647aae3d7d88f8fcbb80e75c6a1df9f2024", "url": "https://github.com/getodk/collect/commit/6373f647aae3d7d88f8fcbb80e75c6a1df9f2024", "message": "Fixed reading saved answers", "committedDate": "2020-11-23T12:42:45Z", "type": "commit"}, {"oid": "bd60362a6f910cbde564e3353354b239c2b50f01", "url": "https://github.com/getodk/collect/commit/bd60362a6f910cbde564e3353354b239c2b50f01", "message": "Removed unused ItemsetQuestionDetails class", "committedDate": "2020-11-24T10:49:00Z", "type": "commit"}, {"oid": "6d6ccf2e019abd37c0266646e6fa2aef2d0f88b4", "url": "https://github.com/getodk/collect/commit/6d6ccf2e019abd37c0266646e6fa2aef2d0f88b4", "message": "Created a separate package for fast external itemset", "committedDate": "2020-11-24T10:58:29Z", "type": "commit"}, {"oid": "4fb6a7dd3ab2ea19322af2c98f2b8e219d33355e", "url": "https://github.com/getodk/collect/commit/4fb6a7dd3ab2ea19322af2c98f2b8e219d33355e", "message": "Merged ItemsetReader and ItemsetDao", "committedDate": "2020-11-24T12:08:54Z", "type": "commit"}, {"oid": "b3724547d4cd74081fb40a94ff94bd943abe0ab8", "url": "https://github.com/getodk/collect/commit/b3724547d4cd74081fb40a94ff94bd943abe0ab8", "message": "Moved XPathParseTool to fastexternalitemset package", "committedDate": "2020-11-24T12:13:40Z", "type": "commit"}, {"oid": "2067ad8f3b3b20a25ab7d8d434913d778d536a46", "url": "https://github.com/getodk/collect/commit/2067ad8f3b3b20a25ab7d8d434913d778d536a46", "message": "Use showWarning() to display a warning if XPathSyntaxException is thrown like we do in case of FileNotFoundException", "committedDate": "2020-11-24T12:20:06Z", "type": "commit"}, {"oid": "3f3fa0ab3727ff62b4f8f28ad90ed53c9e2865dd", "url": "https://github.com/getodk/collect/commit/3f3fa0ab3727ff62b4f8f28ad90ed53c9e2865dd", "message": "Avoid NPE in isFastExternalItemsetWidget", "committedDate": "2020-11-24T13:18:10Z", "type": "commit"}, {"oid": "7d36c4d135a25a8a2b62f7f0618b93775c44dc30", "url": "https://github.com/getodk/collect/commit/7d36c4d135a25a8a2b62f7f0618b93775c44dc30", "message": "Added tests", "committedDate": "2020-11-24T14:04:32Z", "type": "commit"}, {"oid": "d643a80a0d6ab8a1038ad238d802fc3251930958", "url": "https://github.com/getodk/collect/commit/d643a80a0d6ab8a1038ad238d802fc3251930958", "message": "Fixed reading answers in ListWidget", "committedDate": "2020-11-24T14:48:37Z", "type": "commit"}, {"oid": "55ee028bff2cbe72fc26f65e37b61ddccd67186b", "url": "https://github.com/getodk/collect/commit/55ee028bff2cbe72fc26f65e37b61ddccd67186b", "message": "Fixed reading answers in SelectOneImageMapWidget", "committedDate": "2020-11-24T14:55:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTkzMTE4NA==", "url": "https://github.com/getodk/collect/pull/4242#discussion_r529931184", "bodyText": "This should be another branch along with the search() identification. Currently that is in readItems. I vaguely remember we had some back and forth about whether readItems should be separate and maybe it was related to \"fast external itemsets.\" My preference would be to have the three branches in the constructur and not have readItems at all.", "author": "lognaturel", "createdAt": "2020-11-24T22:18:15Z", "path": "collect_app/src/main/java/org/odk/collect/android/widgets/items/ItemsWidget.java", "diffHunk": "@@ -40,7 +44,15 @@\n \n     public ItemsWidget(Context context, QuestionDetails prompt) {\n         super(context, prompt);\n-        readItems();\n+        if (isFastExternalItemsetWidget()) {", "originalCommit": "4dd1c7b16732c5bd3432461121e7b6c31c060199", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTk5MDgyMA==", "url": "https://github.com/getodk/collect/pull/4242#discussion_r529990820", "bodyText": "You mean three methods for different sources what would you call them especially I have a problem with those two external sources? fastExternalItemsets and just externalItemsets or what?", "author": "grzesiek2010", "createdAt": "2020-11-24T23:16:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTkzMTE4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDAxOTY4NQ==", "url": "https://github.com/getodk/collect/pull/4242#discussion_r530019685", "bodyText": "Yes, three branches. I think searchItems or something like that would work. I'm not too picky but it should include search. It shouldn't be externalItemsets because that really sounds like external secondary instances. That one doesn't show up here because JavaRosa handles it entirely.\nThe weird thing about search() and fast external itemsets is that they live entirely outside of the XForms spec and JavaRosa. That's why they're not supported by Enketo and lead to problems like the one you saw recently on the forum where competing instances were being generated by pyxform. Internal secondary instances, external secondary instances and static choice lists in the form body are all the same as far as Collect is concerned.", "author": "lognaturel", "createdAt": "2020-11-24T23:55:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTkzMTE4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDAzMDYxNg==", "url": "https://github.com/getodk/collect/pull/4242#discussion_r530030616", "bodyText": "I'm not too picky but it should include search\n\nNow as I'm thinking about it I would rather use readFastExternalItems() and readDynamicItems() + that last one option that comes from a form file maybe readStaticItems()?\nI would rather avoid that search word because it might use search but also might use populate right it's also like search but dynamic somehow sounds better to me?", "author": "grzesiek2010", "createdAt": "2020-11-25T00:28:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTkzMTE4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA0ODAzOQ==", "url": "https://github.com/getodk/collect/pull/4242#discussion_r530048039", "bodyText": "I've seen the terms \"static\" vs \"dynamic\" to contrast choice lists that are embedded in the form body of the primary instance vs. in a secondary instance. So I think that's confusing.\n\nit might use search but also might use populate\n\nCould you please describe \"populate\"? The search() appearance/function is what identifies that external data feature in form design.\nOther ideas:\n\nitemsetsCsvDatabaseItemsets vs arbitraryCsvDatabaseItemsets\ndatabaseQueryItemsets vs databaseSearchItemsets\nreadFastExternalItems vs readSearchExternalItems\nreadFastExternalItems vs readSearchPulldataItems\nreadDatabaseItemsetsItems vs readDatabaseSearchItems", "author": "lognaturel", "createdAt": "2020-11-25T01:23:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTkzMTE4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQwMzA2OA==", "url": "https://github.com/getodk/collect/pull/4242#discussion_r530403068", "bodyText": "Could you please describe \"populate\"?\n\nsorry I meant pulldata ok readFastExternalItems vs readSearchPulldataItems seams fine.", "author": "grzesiek2010", "createdAt": "2020-11-25T14:13:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTkzMTE4NA=="}], "type": "inlineReview", "revised_code": {"commit": "6a36c3c17df50bb11ad1474102873b8cc21939f9", "chunk": "diff --git a/collect_app/src/main/java/org/odk/collect/android/widgets/items/ItemsWidget.java b/collect_app/src/main/java/org/odk/collect/android/widgets/items/ItemsWidget.java\nindex ad2c2257a..e7d127d65 100644\n--- a/collect_app/src/main/java/org/odk/collect/android/widgets/items/ItemsWidget.java\n+++ b/collect_app/src/main/java/org/odk/collect/android/widgets/items/ItemsWidget.java\n\n@@ -45,17 +46,18 @@ public abstract class ItemsWidget extends QuestionWidget {\n     public ItemsWidget(Context context, QuestionDetails prompt) {\n         super(context, prompt);\n         if (isFastExternalItemsetWidget()) {\n-            items = new FastExternalItemsReader(getFormEntryPrompt(), new XPathParseTool(), new ItemsetDbAdapter(), new FileUtil()).getItems();\n+            readFastExternalItems();\n         } else {\n             readItems();\n         }\n     }\n \n     private boolean isFastExternalItemsetWidget() {\n-        return getFormEntryPrompt().getQuestion().getAdditionalAttribute(null, \"query\") != null;\n+        QuestionDef questionDef = getFormEntryPrompt().getQuestion();\n+        return questionDef != null && questionDef.getAdditionalAttribute(null, \"query\") != null;\n     }\n \n-    protected void readItems() {\n+    private void readItems() {\n         // SurveyCTO-added support for dynamic select content (from .csv files)\n         XPathFuncExpr xpathFuncExpr = ExternalDataUtil.getSearchXPathExpression(getFormEntryPrompt().getAppearanceHint());\n         if (xpathFuncExpr != null) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTkzNjM5MQ==", "url": "https://github.com/getodk/collect/pull/4242#discussion_r529936391", "bodyText": "How was this done before? It'd be ideal not to loop through all items.", "author": "lognaturel", "createdAt": "2020-11-24T22:23:11Z", "path": "collect_app/src/main/java/org/odk/collect/android/utilities/SelectOneWidgetUtils.java", "diffHunk": "@@ -0,0 +1,34 @@\n+package org.odk.collect.android.utilities;\n+\n+import org.javarosa.core.model.SelectChoice;\n+import org.javarosa.core.model.data.IAnswerData;\n+import org.javarosa.core.model.data.SelectOneData;\n+import org.javarosa.core.model.data.StringData;\n+import org.javarosa.core.model.data.helper.Selection;\n+import org.javarosa.form.api.FormEntryPrompt;\n+\n+import java.util.List;\n+\n+public class SelectOneWidgetUtils {\n+\n+    private SelectOneWidgetUtils() {\n+\n+    }\n+\n+    public static Selection getSelectedItem(FormEntryPrompt prompt, List<SelectChoice> items) {\n+        IAnswerData answer = prompt.getAnswerValue();\n+        if (answer == null) {\n+            return null;\n+        } else if (answer instanceof SelectOneData) {\n+            return (Selection) answer.getValue();\n+        } else if (answer instanceof StringData) { // Fast external itemset\n+            for (SelectChoice item : items) {", "originalCommit": "6373f647aae3d7d88f8fcbb80e75c6a1df9f2024", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTk5NTY2MQ==", "url": "https://github.com/getodk/collect/pull/4242#discussion_r529995661", "bodyText": "We have a method in SelectOneWidget and also it was overrode in ItemsetWidget\nThe problem is that we use DATATYPE_TEXT (so different data types to read answers) in case of external itemsets probably in the future we should change it adding maybe even support for select_multiple then we won't need such checks but that's on javarosa's side.", "author": "grzesiek2010", "createdAt": "2020-11-24T23:21:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTkzNjM5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDAyMTQ5Ng==", "url": "https://github.com/getodk/collect/pull/4242#discussion_r530021496", "bodyText": "Both of the methods you linked to just return the string value. Is getSelectedItem only needed for certain appearances? The reason folks use \"fast external itemsets\" is because they're database-driven and therefore fast. I wouldn't want to add overhead for the common case which is a simple select one with no appearance.", "author": "lognaturel", "createdAt": "2020-11-25T00:00:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTkzNjM5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDAyMzc0OA==", "url": "https://github.com/getodk/collect/pull/4242#discussion_r530023748", "bodyText": "Oh sorry my mistake it's not how I wanted to explain it. The problem is that if we use fast external itemsets DATATYPE_TEXT is used which uses StringData but for normal selects we use CONTROL_SELECT_ONE which uses SelectOneData. So when we save a form with answers and open it it might receive StringData or SelectOneData and now we need to handle it since we use the same wights no matter what the source of items is.\nYou can notice that difference in methods I linked as well. That's why I said it would be good to use the same datatypes implementing changes in javarosa isn't that possible?", "author": "grzesiek2010", "createdAt": "2020-11-25T00:07:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTkzNjM5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDAyNDgzMw==", "url": "https://github.com/getodk/collect/pull/4242#discussion_r530024833", "bodyText": "Ah, I think I see what you mean.\n\nThat's why I said it would be good to use the same datatypes implementing changes in javarosa isn't that possible?\n\nJavaRosa doesn't know anything at all about either \"fast external itemsets\" or search(). They're entirely client-side features. So no, not really. Maybe you could look at how the search() code ends up with CONTROL_SELECT_ONE types?", "author": "lognaturel", "createdAt": "2020-11-25T00:10:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTkzNjM5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDAyODE4Mg==", "url": "https://github.com/getodk/collect/pull/4242#discussion_r530028182", "bodyText": "The difference is that when we convert xls to xml using search() it's still select1 element in xml but select_one_external used in xls ends up as <input query=\"... and then in Collect if such <input has query we treat it as select_one question. Probably we could add such a check earlier - on javarosa's side and treat it as CONTROL_SELECT_ONE not DATATYPE_TEXT", "author": "grzesiek2010", "createdAt": "2020-11-25T00:21:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTkzNjM5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDAzMTIyNw==", "url": "https://github.com/getodk/collect/pull/4242#discussion_r530031227", "bodyText": "Hmm. I see, the body element types are different, that's right. I really don't want us to start leaking these weird features into JavaRosa where there's already enough going on. Could you please do a quick performance check before and after your change for 5k items? I think it should be really quick to generate in Excel but let me know if not. There already was a list of SelectChoice items generated for \"fast external itemsets\" prior to your change, right?", "author": "lognaturel", "createdAt": "2020-11-25T00:29:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTkzNjM5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU2OTYwOA==", "url": "https://github.com/getodk/collect/pull/4242#discussion_r531569608", "bodyText": "I checked it using android 6 with a device which is not very fast and didn't notice any change in performance comparing this branch with the master branch. I used this form if you want to check it on your own:\nhttps://drive.google.com/file/d/1lXZtqhGyMJZW5BFrRyPdTcSwRgQ95wQZ/view?usp=sharing\nI selected one of the last choices filling the form on purpose to make the searching longer.", "author": "grzesiek2010", "createdAt": "2020-11-27T12:18:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTkzNjM5MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTk1NTU2NA==", "url": "https://github.com/getodk/collect/pull/4242#discussion_r529955564", "bodyText": "I think introducing a new package to group what you have is a great idea. I wonder whether it should be top-level, though. It could be in formentry or widgets. While here, I wonder what the itemset package and Itemset class were supposed to be for. Seems they can be removed.", "author": "lognaturel", "createdAt": "2020-11-24T22:41:07Z", "path": "collect_app/src/main/java/org/odk/collect/android/fastexternalitemset/ItemsetDbAdapter.java", "diffHunk": "@@ -1,11 +1,12 @@\n-package org.odk.collect.android.database;", "originalCommit": "55ee028bff2cbe72fc26f65e37b61ddccd67186b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDAwMjUzNA==", "url": "https://github.com/getodk/collect/pull/4242#discussion_r530002534", "bodyText": "I added it there because we have also external package it's top-level too which contains classes responsible for reading external csv files we use to handle search/pulldata.\n\nWhile here, I wonder what the itemset package and Itemset class were supposed to be for. Seems they can be removed.\n\nYes it's unused. I added it implementing storage migration to handle migrating itemsets databases but then we decided not to do that because we can clear them just and such databases will be recreated and probably I forgot to remove it.", "author": "grzesiek2010", "createdAt": "2020-11-24T23:28:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTk1NTU2NA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "6a36c3c17df50bb11ad1474102873b8cc21939f9", "url": "https://github.com/getodk/collect/commit/6a36c3c17df50bb11ad1474102873b8cc21939f9", "message": "Removed unused code", "committedDate": "2020-11-24T23:28:42Z", "type": "commit"}, {"oid": "b023c3a1a11ed8b7a8017763d7d2714ec3e28597", "url": "https://github.com/getodk/collect/commit/b023c3a1a11ed8b7a8017763d7d2714ec3e28597", "message": "Code improvements", "committedDate": "2020-11-25T14:11:01Z", "type": "commit"}]}