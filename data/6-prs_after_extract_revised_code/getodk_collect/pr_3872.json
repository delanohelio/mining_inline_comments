{"pr_number": 3872, "pr_title": "Exit form when instance file cannot be created/is null", "pr_createdAt": "2020-05-27T08:37:20Z", "pr_url": "https://github.com/getodk/collect/pull/3872", "timeline": [{"oid": "1f904d0c652f71047563af724c7d9313c9e33c76", "url": "https://github.com/getodk/collect/commit/1f904d0c652f71047563af724c7d9313c9e33c76", "message": "Stop audit event logger from ever being null", "committedDate": "2020-05-27T10:02:01Z", "type": "commit"}, {"oid": "54ace7c190b8d495d5ded2eab89ef3ffba51d9a5", "url": "https://github.com/getodk/collect/commit/54ace7c190b8d495d5ded2eab89ef3ffba51d9a5", "message": "Extract form instace creation to a use case", "committedDate": "2020-05-27T11:28:20Z", "type": "commit"}, {"oid": "7e976806de5b7394e1ca1063b600d7888263514d", "url": "https://github.com/getodk/collect/commit/7e976806de5b7394e1ca1063b600d7888263514d", "message": "Add error handling for when form instance cannot be created", "committedDate": "2020-05-27T11:36:14Z", "type": "commit"}, {"oid": "7e976806de5b7394e1ca1063b600d7888263514d", "url": "https://github.com/getodk/collect/commit/7e976806de5b7394e1ca1063b600d7888263514d", "message": "Add error handling for when form instance cannot be created", "committedDate": "2020-05-27T11:36:14Z", "type": "forcePushed"}, {"oid": "2eb5d4e2a820b138d41d5919e37fb6df6ba0da06", "url": "https://github.com/getodk/collect/commit/2eb5d4e2a820b138d41d5919e37fb6df6ba0da06", "message": "Improve error case setup", "committedDate": "2020-05-27T13:08:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ0NTAzMA==", "url": "https://github.com/getodk/collect/pull/3872#discussion_r431445030", "bodyText": "Could you also do a Timber.e(\"Error creating form instance file\") so we can see it in Crashlytics, keep an eye on how common it is, and possibly learn something from the logs?", "author": "lognaturel", "createdAt": "2020-05-27T21:12:03Z", "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java", "diffHunk": "@@ -2394,7 +2390,18 @@ public void denied() {\n                 }\n \n                 if (formController.getInstanceFile() == null) {\n-                    createInstanceDirectory(formController);\n+                    FormInstanceFileCreator formInstanceFileCreator = new FormInstanceFileCreator(\n+                            storagePathProvider,\n+                            System::currentTimeMillis\n+                    );\n+\n+                    File instanceFile = formInstanceFileCreator.createInstanceFile(formPath);\n+                    if (instanceFile != null) {\n+                        formController.setInstanceFile(instanceFile);\n+                    } else {\n+                        showFormLoadErrorAndExit(getString(R.string.form_instance_file_creation_error));", "originalCommit": "7e976806de5b7394e1ca1063b600d7888263514d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY1NTgxMQ==", "url": "https://github.com/getodk/collect/pull/3872#discussion_r431655811", "bodyText": "Yeah good call!", "author": "seadowg", "createdAt": "2020-05-28T08:08:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ0NTAzMA=="}], "type": "inlineReview", "revised_code": {"commit": "0d97e952b492e2baf40f8e4b46ac889558c7a30b", "chunk": "diff --git a/collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java b/collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java\nindex f359bc32e..ce4d3f267 100644\n--- a/collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java\n+++ b/collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java\n\n@@ -2399,7 +2399,7 @@ public class FormEntryActivity extends CollectAbstractActivity implements Animat\n                     if (instanceFile != null) {\n                         formController.setInstanceFile(instanceFile);\n                     } else {\n-                        showFormLoadErrorAndExit(getString(R.string.form_instance_file_creation_error));\n+                        showFormLoadErrorAndExit(getString(R.string.loading_form_failed));\n                     }\n \n                     formControllerAvailable(formController);\n"}}, {"oid": "378bc49eb8d17d8e2e91806aa6d962e241b524e1", "url": "https://github.com/getodk/collect/commit/378bc49eb8d17d8e2e91806aa6d962e241b524e1", "message": "Add error logging", "committedDate": "2020-05-28T08:10:16Z", "type": "commit"}, {"oid": "0d97e952b492e2baf40f8e4b46ac889558c7a30b", "url": "https://github.com/getodk/collect/commit/0d97e952b492e2baf40f8e4b46ac889558c7a30b", "message": "Use generic error when instance file creation fails", "committedDate": "2020-06-01T09:25:51Z", "type": "commit"}]}