{"pr_number": 3690, "pr_title": "Fixed Save button in Reason for changes page does not work after rotating device orientation", "pr_createdAt": "2020-03-06T14:08:16Z", "pr_url": "https://github.com/getodk/collect/pull/3690", "timeline": [{"oid": "151d73a3e5e03546b74a39e083e0248b785c738c", "url": "https://github.com/getodk/collect/commit/151d73a3e5e03546b74a39e083e0248b785c738c", "message": "Fixed Save button in Reason for changes page does not work after rotating device orientation", "committedDate": "2020-03-06T14:07:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTAxODAxMg==", "url": "https://github.com/getodk/collect/pull/3690#discussion_r389018012", "bodyText": "I think we should call this resumeFormEntry seeing as that's the \"view action\" that's occuring. I'm also thinking this should only really happen for results that end the same process (like SAVED and the errors) but not for SAVING or CHANGE_REASON_REQUIRED.", "author": "seadowg", "createdAt": "2020-03-06T16:50:21Z", "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java", "diffHunk": "@@ -1821,91 +1823,97 @@ private boolean saveForm(boolean exit, boolean complete, String updatedSaveName,\n             }\n         }\n \n-        formSaveViewModel.saveForm(getIntent().getData(), complete, updatedSaveName, exit).observe(this, result -> {\n-            switch (result.getState()) {\n-                case CHANGE_REASON_REQUIRED:\n-                    ChangesReasonPromptDialogFragment dialog = ChangesReasonPromptDialogFragment.create(getFormController().getFormTitle());\n-                    DialogUtils.showIfNotShowing(dialog, getSupportFragmentManager());\n-                    break;\n+        formSaveViewModel.saveForm(getIntent().getData(), complete, updatedSaveName, exit);\n \n-                case SAVING:\n-                    autoSaved = true;\n+        return true;\n+    }\n \n-                    SaveFormProgressDialogFragment progressDialog = DialogUtils.showIfNotShowing(\n-                            new SaveFormProgressDialogFragment(),\n-                            getSupportFragmentManager()\n-                    );\n+    private void handleSaveResult(FormSaveViewModel.SaveResult result) {\n+        if (result == null) {\n+            return;\n+        }\n+        switch (result.getState()) {\n+            case CHANGE_REASON_REQUIRED:\n+                ChangesReasonPromptDialogFragment dialog = ChangesReasonPromptDialogFragment.create(getFormController().getFormTitle());\n+                DialogUtils.showIfNotShowing(dialog, getSupportFragmentManager());\n+                break;\n \n-                    if (result.getMessage() != null) {\n-                        progressDialog.setMessage(getString(R.string.please_wait) + \"\\n\\n\" + result.getMessage());\n-                    }\n+            case SAVING:\n+                autoSaved = true;\n \n-                    break;\n+                SaveFormProgressDialogFragment progressDialog = DialogUtils.showIfNotShowing(\n+                        new SaveFormProgressDialogFragment(),\n+                        getSupportFragmentManager()\n+                );\n \n-                case SAVED:\n-                    DialogUtils.dismissDialog(SaveFormProgressDialogFragment.class, getSupportFragmentManager());\n-                    showShortToast(R.string.data_saved_ok);\n-\n-                    if (exit) {\n-                        if (complete) {\n-                            // Request auto-send if app-wide auto-send is enabled or the form that was just\n-                            // finalized specifies that it should always be auto-sent.\n-                            String formId = getFormController().getFormDef().getMainInstance().getRoot().getAttributeValue(\"\", \"id\");\n-                            if (AutoSendWorker.formShouldBeAutoSent(formId, GeneralSharedPreferences.isAutoSendEnabled())) {\n-                                requestAutoSend();\n-                            }\n-                        }\n+                if (result.getMessage() != null) {\n+                    progressDialog.setMessage(getString(R.string.please_wait) + \"\\n\\n\" + result.getMessage());\n+                }\n+\n+                break;\n \n-                        finishAndReturnInstance();\n+            case SAVED:\n+                DialogUtils.dismissDialog(SaveFormProgressDialogFragment.class, getSupportFragmentManager());\n+                showShortToast(R.string.data_saved_ok);\n+\n+                if (result.getRequest().viewExiting()) {\n+                    if (result.getRequest().shouldFinalize()) {\n+                        // Request auto-send if app-wide auto-send is enabled or the form that was just\n+                        // finalized specifies that it should always be auto-sent.\n+                        String formId = getFormController().getFormDef().getMainInstance().getRoot().getAttributeValue(\"\", \"id\");\n+                        if (AutoSendWorker.formShouldBeAutoSent(formId, GeneralSharedPreferences.isAutoSendEnabled())) {\n+                            requestAutoSend();\n+                        }\n                     }\n \n-                    break;\n+                    finishAndReturnInstance();\n+                }\n \n-                case SAVE_ERROR:\n-                    DialogUtils.dismissDialog(SaveFormProgressDialogFragment.class, getSupportFragmentManager());\n-                    String message;\n+                break;\n \n-                    if (result.getMessage() != null) {\n-                        message = getString(R.string.data_saved_error) + \" \"\n-                                + result.getMessage();\n-                    } else {\n-                        message = getString(R.string.data_saved_error);\n-                    }\n+            case SAVE_ERROR:\n+                DialogUtils.dismissDialog(SaveFormProgressDialogFragment.class, getSupportFragmentManager());\n+                String message;\n \n-                    showLongToast(message);\n-                    break;\n+                if (result.getMessage() != null) {\n+                    message = getString(R.string.data_saved_error) + \" \"\n+                            + result.getMessage();\n+                } else {\n+                    message = getString(R.string.data_saved_error);\n+                }\n \n-                case FINALIZE_ERROR:\n-                    DialogUtils.dismissDialog(SaveFormProgressDialogFragment.class, getSupportFragmentManager());\n-                    showLongToast(String.format(getString(R.string.encryption_error_message),\n-                            result.getMessage()));\n-                    finishAndReturnInstance();\n-                    break;\n+                showLongToast(message);\n+                break;\n \n-                case CONSTRAINT_ERROR: {\n-                    DialogUtils.dismissDialog(SaveFormProgressDialogFragment.class, getSupportFragmentManager());\n-                    refreshCurrentView();\n+            case FINALIZE_ERROR:\n+                DialogUtils.dismissDialog(SaveFormProgressDialogFragment.class, getSupportFragmentManager());\n+                showLongToast(String.format(getString(R.string.encryption_error_message),\n+                        result.getMessage()));\n+                finishAndReturnInstance();\n+                break;\n \n-                    // get constraint behavior preference value with appropriate default\n-                    String constraintBehavior = (String) GeneralSharedPreferences.getInstance()\n-                            .get(GeneralKeys.KEY_CONSTRAINT_BEHAVIOR);\n+            case CONSTRAINT_ERROR: {\n+                DialogUtils.dismissDialog(SaveFormProgressDialogFragment.class, getSupportFragmentManager());\n+                refreshCurrentView();\n \n-                    // an answer constraint was violated, so we need to display the proper toast(s)\n-                    // if constraint behavior is on_swipe, this will happen if we do a 'swipe' to the\n-                    // next question\n-                    if (constraintBehavior.equals(GeneralKeys.CONSTRAINT_BEHAVIOR_ON_SWIPE)) {\n-                        next();\n-                    } else {\n-                        // otherwise, we can get the proper toast(s) by saving with constraint check\n-                        saveAnswersForCurrentScreen(EVALUATE_CONSTRAINTS);\n-                    }\n+                // get constraint behavior preference value with appropriate default\n+                String constraintBehavior = (String) GeneralSharedPreferences.getInstance()\n+                        .get(GeneralKeys.KEY_CONSTRAINT_BEHAVIOR);\n \n-                    break;\n+                // an answer constraint was violated, so we need to display the proper toast(s)\n+                // if constraint behavior is on_swipe, this will happen if we do a 'swipe' to the\n+                // next question\n+                if (constraintBehavior.equals(GeneralKeys.CONSTRAINT_BEHAVIOR_ON_SWIPE)) {\n+                    next();\n+                } else {\n+                    // otherwise, we can get the proper toast(s) by saving with constraint check\n+                    saveAnswersForCurrentScreen(EVALUATE_CONSTRAINTS);\n                 }\n-            }\n-        });\n \n-        return true;\n+                break;\n+            }\n+        }\n+        formSaveViewModel.consumeSavedResult();", "originalCommit": "151d73a3e5e03546b74a39e083e0248b785c738c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTY1MTA3OA==", "url": "https://github.com/getodk/collect/pull/3690#discussion_r389651078", "bodyText": "Right, fixed.", "author": "grzesiek2010", "createdAt": "2020-03-09T13:14:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTAxODAxMg=="}], "type": "inlineReview", "revised_code": {"commit": "e5c22d411ccb2151249b1546a403ff78a6155a2d", "chunk": "diff --git a/collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java b/collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java\nindex cc90a907a..9db25ff0e 100644\n--- a/collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java\n+++ b/collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java\n\n@@ -1868,7 +1868,7 @@ public class FormEntryActivity extends CollectAbstractActivity implements Animat\n \n                     finishAndReturnInstance();\n                 }\n-\n+                formSaveViewModel.consumeSavedResult();\n                 break;\n \n             case SAVE_ERROR:\n"}}, {"oid": "e5c22d411ccb2151249b1546a403ff78a6155a2d", "url": "https://github.com/getodk/collect/commit/e5c22d411ccb2151249b1546a403ff78a6155a2d", "message": "Don't consume results like CHANGE_REASON_REQUIRED or SAVING", "committedDate": "2020-03-09T09:09:09Z", "type": "commit"}, {"oid": "8d6e18a391eb609ab45148bbced572bf4fc97589", "url": "https://github.com/getodk/collect/commit/8d6e18a391eb609ab45148bbced572bf4fc97589", "message": "Fixed tests", "committedDate": "2020-03-09T11:26:02Z", "type": "commit"}, {"oid": "b2b56149da993a523163fb335b74d6fd4fb6d87c", "url": "https://github.com/getodk/collect/commit/b2b56149da993a523163fb335b74d6fd4fb6d87c", "message": "Improved tests", "committedDate": "2020-03-09T11:33:11Z", "type": "commit"}, {"oid": "ffa78091b2888312eb6bab008510ea25a2b9f505", "url": "https://github.com/getodk/collect/commit/ffa78091b2888312eb6bab008510ea25a2b9f505", "message": "Naming impovements", "committedDate": "2020-03-09T11:34:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTY0NTE5NA==", "url": "https://github.com/getodk/collect/pull/3690#discussion_r389645194", "bodyText": "I think this should be closeSoftkeyboard() instead just so we are checking the full \"rotated\" flow.", "author": "seadowg", "createdAt": "2020-03-09T13:02:36Z", "path": "collect_app/src/androidTest/java/org/odk/collect/android/formentry/audit/TrackChangesReasonTest.java", "diffHunk": "@@ -123,7 +123,9 @@ public void openingAFormToEdit_andChangingAValue_andClickingSaveAndExit_andRotat\n                 .clickSaveAndExitWithChangesReasonPrompt()\n                 .enterReason(\"Something\")\n                 .rotateToLandscape(new ChangesReasonPromptPage(\"Track Changes Reason\", rule))\n-                .assertText(\"Something\");\n+                .assertText(\"Something\")\n+                .rotateToPortrait(new ChangesReasonPromptPage(\"Track Changes Reason\", rule))", "originalCommit": "ffa78091b2888312eb6bab008510ea25a2b9f505", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDE5NjA3Mw==", "url": "https://github.com/getodk/collect/pull/3690#discussion_r390196073", "bodyText": "Done.", "author": "grzesiek2010", "createdAt": "2020-03-10T09:46:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTY0NTE5NA=="}], "type": "inlineReview", "revised_code": {"commit": "717b50f5fef07be2f5cacd8965d42d1dd880ed7b", "chunk": "diff --git a/collect_app/src/androidTest/java/org/odk/collect/android/formentry/audit/TrackChangesReasonTest.java b/collect_app/src/androidTest/java/org/odk/collect/android/formentry/audit/TrackChangesReasonTest.java\nindex 1b8e96318..6daed3574 100644\n--- a/collect_app/src/androidTest/java/org/odk/collect/android/formentry/audit/TrackChangesReasonTest.java\n+++ b/collect_app/src/androidTest/java/org/odk/collect/android/formentry/audit/TrackChangesReasonTest.java\n\n@@ -124,7 +124,7 @@ public class TrackChangesReasonTest {\n                 .enterReason(\"Something\")\n                 .rotateToLandscape(new ChangesReasonPromptPage(\"Track Changes Reason\", rule))\n                 .assertText(\"Something\")\n-                .rotateToPortrait(new ChangesReasonPromptPage(\"Track Changes Reason\", rule))\n+                .closeSoftKeyboard()\n                 .clickSave();\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTY0NzkzMQ==", "url": "https://github.com/getodk/collect/pull/3690#discussion_r389647931", "bodyText": "I don't know if this makes sense anymore? Maybe it's best just to return when we're already saving rather than setting the result to ALREADY_SAVING just seems a little weird for the same SaveResult LiveData to go from the SAVING to ALREADY_SAVING state.", "author": "seadowg", "createdAt": "2020-03-09T13:08:24Z", "path": "collect_app/src/test/java/org/odk/collect/android/formentry/audit/FormSaveViewModelTest.java", "diffHunk": "@@ -68,38 +68,44 @@ public void setup() {\n \n     @Test\n     public void saveForm_returnsNewSaveResult_inSavingState() {\n-        LiveData<FormSaveViewModel.SaveResult> saveResult1 = viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n-        assertThat(saveResult1.getValue().getState(), equalTo(SAVING));\n+        viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n+        FormSaveViewModel.SaveResult saveResult1 = viewModel.getSavedResult().getValue();\n+        assertThat(saveResult1.getState(), equalTo(SAVING));\n \n-        LiveData<FormSaveViewModel.SaveResult> saveResult2 = viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n+        viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n+        FormSaveViewModel.SaveResult saveResult2 = viewModel.getSavedResult().getValue();\n         assertThat(saveResult2, not(equalTo(saveResult1)));\n     }\n \n     @Test\n     public void saveForm_wontRunMultipleSavesAtOnce() {", "originalCommit": "ffa78091b2888312eb6bab008510ea25a2b9f505", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDE5NjM4NQ==", "url": "https://github.com/getodk/collect/pull/3690#discussion_r390196385", "bodyText": "Done.", "author": "grzesiek2010", "createdAt": "2020-03-10T09:46:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTY0NzkzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "717b50f5fef07be2f5cacd8965d42d1dd880ed7b", "chunk": "diff --git a/collect_app/src/test/java/org/odk/collect/android/formentry/audit/FormSaveViewModelTest.java b/collect_app/src/test/java/org/odk/collect/android/formentry/audit/FormSaveViewModelTest.java\nindex e25c3ab95..2e200ea4d 100644\n--- a/collect_app/src/test/java/org/odk/collect/android/formentry/audit/FormSaveViewModelTest.java\n+++ b/collect_app/src/test/java/org/odk/collect/android/formentry/audit/FormSaveViewModelTest.java\n\n@@ -67,38 +66,29 @@ public class FormSaveViewModelTest {\n     }\n \n     @Test\n-    public void saveForm_returnsNewSaveResult_inSavingState() {\n+    public void saveForm_returnsSaveResult_inSavingState() {\n         viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n         FormSaveViewModel.SaveResult saveResult1 = viewModel.getSavedResult().getValue();\n         assertThat(saveResult1.getState(), equalTo(SAVING));\n-\n-        viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n-        FormSaveViewModel.SaveResult saveResult2 = viewModel.getSavedResult().getValue();\n-        assertThat(saveResult2, not(equalTo(saveResult1)));\n     }\n \n     @Test\n     public void saveForm_wontRunMultipleSavesAtOnce() {\n         viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n-        LiveData<FormSaveViewModel.SaveResult> saveResult1 = viewModel.getSavedResult();\n-        assertThat(saveResult1.getValue().getState(), equalTo(SAVING));\n+        FormSaveViewModel.SaveResult saveResult1 = viewModel.getSavedResult().getValue();\n+        assertThat(saveResult1.getState(), equalTo(SAVING));\n \n         viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n-        LiveData<FormSaveViewModel.SaveResult> saveResult2 = viewModel.getSavedResult();\n-        assertThat(saveResult2.getValue().getState(), equalTo(ALREADY_SAVING));\n-\n-        assertThat(Robolectric.getBackgroundThreadScheduler().size(), equalTo(1));\n-\n-        whenFormSaverFinishes(SaveFormToDisk.SAVED);\n-        assertThat(saveResult1.getValue().getState(), equalTo(SAVED));\n+        FormSaveViewModel.SaveResult saveResult2 = viewModel.getSavedResult().getValue();\n+        assertThat(saveResult2.getState(), equalTo(ALREADY_SAVING));\n     }\n \n     @Test\n     public void saveForm_whenReasonRequiredToSave_returnsSaveResult_inChangeReasonRequiredState() {\n         whenReasonRequiredToSave();\n \n-        viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n         LiveData<FormSaveViewModel.SaveResult> saveResult = viewModel.getSavedResult();\n+        viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n         assertThat(saveResult.getValue().getState(), equalTo(CHANGE_REASON_REQUIRED));\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTY0OTg5Nw==", "url": "https://github.com/getodk/collect/pull/3690#discussion_r389649897", "bodyText": "Yeah I think this test also needs to change as the LiveData will be the same between calls. Should just be that saveForm_returnsSaveResult_inSavingState and it only needs to make one call to save.", "author": "seadowg", "createdAt": "2020-03-09T13:12:17Z", "path": "collect_app/src/test/java/org/odk/collect/android/formentry/audit/FormSaveViewModelTest.java", "diffHunk": "@@ -68,38 +68,44 @@ public void setup() {\n \n     @Test\n     public void saveForm_returnsNewSaveResult_inSavingState() {\n-        LiveData<FormSaveViewModel.SaveResult> saveResult1 = viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);", "originalCommit": "ffa78091b2888312eb6bab008510ea25a2b9f505", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDE5NjE3MA==", "url": "https://github.com/getodk/collect/pull/3690#discussion_r390196170", "bodyText": "Done.", "author": "grzesiek2010", "createdAt": "2020-03-10T09:46:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTY0OTg5Nw=="}], "type": "inlineReview", "revised_code": {"commit": "717b50f5fef07be2f5cacd8965d42d1dd880ed7b", "chunk": "diff --git a/collect_app/src/test/java/org/odk/collect/android/formentry/audit/FormSaveViewModelTest.java b/collect_app/src/test/java/org/odk/collect/android/formentry/audit/FormSaveViewModelTest.java\nindex e25c3ab95..2e200ea4d 100644\n--- a/collect_app/src/test/java/org/odk/collect/android/formentry/audit/FormSaveViewModelTest.java\n+++ b/collect_app/src/test/java/org/odk/collect/android/formentry/audit/FormSaveViewModelTest.java\n\n@@ -67,38 +66,29 @@ public class FormSaveViewModelTest {\n     }\n \n     @Test\n-    public void saveForm_returnsNewSaveResult_inSavingState() {\n+    public void saveForm_returnsSaveResult_inSavingState() {\n         viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n         FormSaveViewModel.SaveResult saveResult1 = viewModel.getSavedResult().getValue();\n         assertThat(saveResult1.getState(), equalTo(SAVING));\n-\n-        viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n-        FormSaveViewModel.SaveResult saveResult2 = viewModel.getSavedResult().getValue();\n-        assertThat(saveResult2, not(equalTo(saveResult1)));\n     }\n \n     @Test\n     public void saveForm_wontRunMultipleSavesAtOnce() {\n         viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n-        LiveData<FormSaveViewModel.SaveResult> saveResult1 = viewModel.getSavedResult();\n-        assertThat(saveResult1.getValue().getState(), equalTo(SAVING));\n+        FormSaveViewModel.SaveResult saveResult1 = viewModel.getSavedResult().getValue();\n+        assertThat(saveResult1.getState(), equalTo(SAVING));\n \n         viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n-        LiveData<FormSaveViewModel.SaveResult> saveResult2 = viewModel.getSavedResult();\n-        assertThat(saveResult2.getValue().getState(), equalTo(ALREADY_SAVING));\n-\n-        assertThat(Robolectric.getBackgroundThreadScheduler().size(), equalTo(1));\n-\n-        whenFormSaverFinishes(SaveFormToDisk.SAVED);\n-        assertThat(saveResult1.getValue().getState(), equalTo(SAVED));\n+        FormSaveViewModel.SaveResult saveResult2 = viewModel.getSavedResult().getValue();\n+        assertThat(saveResult2.getState(), equalTo(ALREADY_SAVING));\n     }\n \n     @Test\n     public void saveForm_whenReasonRequiredToSave_returnsSaveResult_inChangeReasonRequiredState() {\n         whenReasonRequiredToSave();\n \n-        viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n         LiveData<FormSaveViewModel.SaveResult> saveResult = viewModel.getSavedResult();\n+        viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n         assertThat(saveResult.getValue().getState(), equalTo(CHANGE_REASON_REQUIRED));\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTY1MDY4Nw==", "url": "https://github.com/getodk/collect/pull/3690#discussion_r389650687", "bodyText": "I think having the saveResult declarations before the call to save would be good because it ensures that the same LiveData instance is being used before/after the call. This mimics how you would use the ViewModel where you make an observation before you call an action.", "author": "seadowg", "createdAt": "2020-03-09T13:13:50Z", "path": "collect_app/src/test/java/org/odk/collect/android/formentry/audit/FormSaveViewModelTest.java", "diffHunk": "@@ -68,38 +68,44 @@ public void setup() {\n \n     @Test\n     public void saveForm_returnsNewSaveResult_inSavingState() {\n-        LiveData<FormSaveViewModel.SaveResult> saveResult1 = viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n-        assertThat(saveResult1.getValue().getState(), equalTo(SAVING));\n+        viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n+        FormSaveViewModel.SaveResult saveResult1 = viewModel.getSavedResult().getValue();\n+        assertThat(saveResult1.getState(), equalTo(SAVING));\n \n-        LiveData<FormSaveViewModel.SaveResult> saveResult2 = viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n+        viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n+        FormSaveViewModel.SaveResult saveResult2 = viewModel.getSavedResult().getValue();\n         assertThat(saveResult2, not(equalTo(saveResult1)));\n     }\n \n     @Test\n     public void saveForm_wontRunMultipleSavesAtOnce() {\n-        LiveData<FormSaveViewModel.SaveResult> saveResult1 = viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n-        LiveData<FormSaveViewModel.SaveResult> saveResult2 = viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n-\n+        viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n+        LiveData<FormSaveViewModel.SaveResult> saveResult1 = viewModel.getSavedResult();\n         assertThat(saveResult1.getValue().getState(), equalTo(SAVING));\n+\n+        viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n+        LiveData<FormSaveViewModel.SaveResult> saveResult2 = viewModel.getSavedResult();\n         assertThat(saveResult2.getValue().getState(), equalTo(ALREADY_SAVING));\n+\n         assertThat(Robolectric.getBackgroundThreadScheduler().size(), equalTo(1));\n \n         whenFormSaverFinishes(SaveFormToDisk.SAVED);\n         assertThat(saveResult1.getValue().getState(), equalTo(SAVED));\n-        assertThat(saveResult2.getValue().getState(), equalTo(ALREADY_SAVING));\n     }\n \n     @Test\n     public void saveForm_whenReasonRequiredToSave_returnsSaveResult_inChangeReasonRequiredState() {\n         whenReasonRequiredToSave();\n \n-        LiveData<FormSaveViewModel.SaveResult> saveResult = viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n+        viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n+        LiveData<FormSaveViewModel.SaveResult> saveResult = viewModel.getSavedResult();", "originalCommit": "ffa78091b2888312eb6bab008510ea25a2b9f505", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDE5NjMwNA==", "url": "https://github.com/getodk/collect/pull/3690#discussion_r390196304", "bodyText": "Done.", "author": "grzesiek2010", "createdAt": "2020-03-10T09:46:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTY1MDY4Nw=="}], "type": "inlineReview", "revised_code": {"commit": "717b50f5fef07be2f5cacd8965d42d1dd880ed7b", "chunk": "diff --git a/collect_app/src/test/java/org/odk/collect/android/formentry/audit/FormSaveViewModelTest.java b/collect_app/src/test/java/org/odk/collect/android/formentry/audit/FormSaveViewModelTest.java\nindex e25c3ab95..2e200ea4d 100644\n--- a/collect_app/src/test/java/org/odk/collect/android/formentry/audit/FormSaveViewModelTest.java\n+++ b/collect_app/src/test/java/org/odk/collect/android/formentry/audit/FormSaveViewModelTest.java\n\n@@ -67,38 +66,29 @@ public class FormSaveViewModelTest {\n     }\n \n     @Test\n-    public void saveForm_returnsNewSaveResult_inSavingState() {\n+    public void saveForm_returnsSaveResult_inSavingState() {\n         viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n         FormSaveViewModel.SaveResult saveResult1 = viewModel.getSavedResult().getValue();\n         assertThat(saveResult1.getState(), equalTo(SAVING));\n-\n-        viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n-        FormSaveViewModel.SaveResult saveResult2 = viewModel.getSavedResult().getValue();\n-        assertThat(saveResult2, not(equalTo(saveResult1)));\n     }\n \n     @Test\n     public void saveForm_wontRunMultipleSavesAtOnce() {\n         viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n-        LiveData<FormSaveViewModel.SaveResult> saveResult1 = viewModel.getSavedResult();\n-        assertThat(saveResult1.getValue().getState(), equalTo(SAVING));\n+        FormSaveViewModel.SaveResult saveResult1 = viewModel.getSavedResult().getValue();\n+        assertThat(saveResult1.getState(), equalTo(SAVING));\n \n         viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n-        LiveData<FormSaveViewModel.SaveResult> saveResult2 = viewModel.getSavedResult();\n-        assertThat(saveResult2.getValue().getState(), equalTo(ALREADY_SAVING));\n-\n-        assertThat(Robolectric.getBackgroundThreadScheduler().size(), equalTo(1));\n-\n-        whenFormSaverFinishes(SaveFormToDisk.SAVED);\n-        assertThat(saveResult1.getValue().getState(), equalTo(SAVED));\n+        FormSaveViewModel.SaveResult saveResult2 = viewModel.getSavedResult().getValue();\n+        assertThat(saveResult2.getState(), equalTo(ALREADY_SAVING));\n     }\n \n     @Test\n     public void saveForm_whenReasonRequiredToSave_returnsSaveResult_inChangeReasonRequiredState() {\n         whenReasonRequiredToSave();\n \n-        viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n         LiveData<FormSaveViewModel.SaveResult> saveResult = viewModel.getSavedResult();\n+        viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n         assertThat(saveResult.getValue().getState(), equalTo(CHANGE_REASON_REQUIRED));\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTY1MzQ3OA==", "url": "https://github.com/getodk/collect/pull/3690#discussion_r389653478", "bodyText": "In my head this needs to be saveResult.setValue(null) instead. Otherwise saving multiple times won't work for observations made in onCreate of an Activity/Fragment as they'll be observing a different LiveData value. Maybe I'm reading this wrong!\nWe can verify with a test for the ViewModel:\n@Test\npublic void resumeFormEntry_clearsSaveResult() {\n    LiveData<FormSaveViewModel.SaveResult> saveResult = viewModel.getSavedResult();\n    viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n    viewModel.resumeFormEntry();\n    assertThat(saveResult.getValue(), equalTo(null));\n}", "author": "seadowg", "createdAt": "2020-03-09T13:19:05Z", "path": "collect_app/src/main/java/org/odk/collect/android/formentry/saving/FormSaveViewModel.java", "diffHunk": "@@ -181,6 +179,14 @@ private void handleTaskResult(SaveToDiskResult taskResult, SaveRequest saveReque\n         }\n     }\n \n+    public LiveData<SaveResult> getSavedResult() {\n+        return saveResult;\n+    }\n+\n+    public void resumeFormEntry() {\n+        saveResult = new MutableLiveData<>(null);", "originalCommit": "ffa78091b2888312eb6bab008510ea25a2b9f505", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDE5NjIzOA==", "url": "https://github.com/getodk/collect/pull/3690#discussion_r390196238", "bodyText": "Done.", "author": "grzesiek2010", "createdAt": "2020-03-10T09:46:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTY1MzQ3OA=="}], "type": "inlineReview", "revised_code": {"commit": "717b50f5fef07be2f5cacd8965d42d1dd880ed7b", "chunk": "diff --git a/collect_app/src/main/java/org/odk/collect/android/formentry/saving/FormSaveViewModel.java b/collect_app/src/main/java/org/odk/collect/android/formentry/saving/FormSaveViewModel.java\nindex d9e038a27..8f403d6dd 100644\n--- a/collect_app/src/main/java/org/odk/collect/android/formentry/saving/FormSaveViewModel.java\n+++ b/collect_app/src/main/java/org/odk/collect/android/formentry/saving/FormSaveViewModel.java\n\n@@ -184,7 +184,7 @@ public class FormSaveViewModel extends ViewModel implements ProgressDialogFragme\n     }\n \n     public void resumeFormEntry() {\n-        saveResult = new MutableLiveData<>(null);\n+        saveResult.setValue(null);\n     }\n \n     private boolean requiresReasonToSave() {\n"}}, {"oid": "717b50f5fef07be2f5cacd8965d42d1dd880ed7b", "url": "https://github.com/getodk/collect/commit/717b50f5fef07be2f5cacd8965d42d1dd880ed7b", "message": "Improvements", "committedDate": "2020-03-10T09:44:13Z", "type": "commit"}, {"oid": "717b50f5fef07be2f5cacd8965d42d1dd880ed7b", "url": "https://github.com/getodk/collect/commit/717b50f5fef07be2f5cacd8965d42d1dd880ed7b", "message": "Improvements", "committedDate": "2020-03-10T09:44:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIwMjE2NA==", "url": "https://github.com/getodk/collect/pull/3690#discussion_r390202164", "bodyText": "Sorry I don't think what I meant was clear here: I think we should get rid of the ALREADY_SAVING state entirely. It's unlikely that it would happen but if it did and then the user rotated the LiveData would be in the ALREADY_SAVING state rather than SAVING when the observation is setup again.\nI think we can just return in saveForm if a save is in progress.", "author": "seadowg", "createdAt": "2020-03-10T09:56:25Z", "path": "collect_app/src/test/java/org/odk/collect/android/formentry/audit/FormSaveViewModelTest.java", "diffHunk": "@@ -67,39 +66,36 @@ public void setup() {\n     }\n \n     @Test\n-    public void saveForm_returnsNewSaveResult_inSavingState() {\n-        LiveData<FormSaveViewModel.SaveResult> saveResult1 = viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n-        assertThat(saveResult1.getValue().getState(), equalTo(SAVING));\n-\n-        LiveData<FormSaveViewModel.SaveResult> saveResult2 = viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n-        assertThat(saveResult2, not(equalTo(saveResult1)));\n+    public void saveForm_returnsSaveResult_inSavingState() {\n+        viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n+        FormSaveViewModel.SaveResult saveResult1 = viewModel.getSavedResult().getValue();\n+        assertThat(saveResult1.getState(), equalTo(SAVING));\n     }\n \n     @Test\n     public void saveForm_wontRunMultipleSavesAtOnce() {\n-        LiveData<FormSaveViewModel.SaveResult> saveResult1 = viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n-        LiveData<FormSaveViewModel.SaveResult> saveResult2 = viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n-\n-        assertThat(saveResult1.getValue().getState(), equalTo(SAVING));\n-        assertThat(saveResult2.getValue().getState(), equalTo(ALREADY_SAVING));\n-        assertThat(Robolectric.getBackgroundThreadScheduler().size(), equalTo(1));\n+        viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n+        FormSaveViewModel.SaveResult saveResult1 = viewModel.getSavedResult().getValue();\n+        assertThat(saveResult1.getState(), equalTo(SAVING));\n \n-        whenFormSaverFinishes(SaveFormToDisk.SAVED);\n-        assertThat(saveResult1.getValue().getState(), equalTo(SAVED));\n-        assertThat(saveResult2.getValue().getState(), equalTo(ALREADY_SAVING));\n+        viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n+        FormSaveViewModel.SaveResult saveResult2 = viewModel.getSavedResult().getValue();\n+        assertThat(saveResult2.getState(), equalTo(ALREADY_SAVING));", "originalCommit": "717b50f5fef07be2f5cacd8965d42d1dd880ed7b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIxODQ0Ng==", "url": "https://github.com/getodk/collect/pull/3690#discussion_r390218446", "bodyText": "So you mean to remove the last three lines at all? Then the test would be equal to the one above.", "author": "grzesiek2010", "createdAt": "2020-03-10T10:25:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIwMjE2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIyNjgzMA==", "url": "https://github.com/getodk/collect/pull/3690#discussion_r390226830", "bodyText": "Yeah I don't think we need this test because my feeling is that we should remove the line that this drives out in FormSaveViewModel (saveResult.setValue(new SaveResult(SaveResult.State.ALREADY_SAVING, null))). Really we should change it so that the test checks we don't call formSaver#save again - thinking about it the original test should really have had that check as well.", "author": "seadowg", "createdAt": "2020-03-10T10:41:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIwMjE2NA=="}], "type": "inlineReview", "revised_code": {"commit": "c146d842444395511307f39f12d4feb063400780", "chunk": "diff --git a/collect_app/src/test/java/org/odk/collect/android/formentry/audit/FormSaveViewModelTest.java b/collect_app/src/test/java/org/odk/collect/android/formentry/audit/FormSaveViewModelTest.java\nindex 2e200ea4d..6885e9ee2 100644\n--- a/collect_app/src/test/java/org/odk/collect/android/formentry/audit/FormSaveViewModelTest.java\n+++ b/collect_app/src/test/java/org/odk/collect/android/formentry/audit/FormSaveViewModelTest.java\n\n@@ -61,7 +62,7 @@ public class FormSaveViewModelTest {\n         when(formController.getAuditEventLogger()).thenReturn(logger);\n         when(logger.isChangeReasonRequired()).thenReturn(false);\n \n-        viewModel = new FormSaveViewModel(() -> CURRENT_TIME, formSaver);\n+        viewModel = spy(new FormSaveViewModel(() -> CURRENT_TIME, formSaver));\n         viewModel.setFormController(formController);\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIwMjk1Nw==", "url": "https://github.com/getodk/collect/pull/3690#discussion_r390202957", "bodyText": "\ud83d\udc4d", "author": "seadowg", "createdAt": "2020-03-10T09:57:45Z", "path": "collect_app/src/test/java/org/odk/collect/android/formentry/audit/FormSaveViewModelTest.java", "diffHunk": "@@ -344,6 +346,14 @@ public void saveReason_whenReasonIsNotValid_returnsFalse() {\n         assertThat(viewModel.saveReason(), equalTo(false));\n     }\n \n+    @Test\n+    public void resumeFormEntry_clearsSaveResult() {", "originalCommit": "717b50f5fef07be2f5cacd8965d42d1dd880ed7b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "c146d842444395511307f39f12d4feb063400780", "url": "https://github.com/getodk/collect/commit/c146d842444395511307f39f12d4feb063400780", "message": "Removed redundant ALREADY_SAVING state", "committedDate": "2020-03-10T11:17:59Z", "type": "commit"}, {"oid": "ee3d2d10f6bc1a02b171238cedd54268fc3183d8", "url": "https://github.com/getodk/collect/commit/ee3d2d10f6bc1a02b171238cedd54268fc3183d8", "message": "Revise mutliple save test", "committedDate": "2020-03-10T12:27:59Z", "type": "commit"}]}