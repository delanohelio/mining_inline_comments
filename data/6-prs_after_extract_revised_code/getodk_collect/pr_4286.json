{"pr_number": 4286, "pr_title": "Handle process death during filling a form", "pr_createdAt": "2020-12-09T11:32:40Z", "pr_url": "https://github.com/getodk/collect/pull/4286", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIzNDg5Mg==", "url": "https://github.com/getodk/collect/pull/4286#discussion_r539234892", "bodyText": "The problem here was that if we were in a field-list group and we wanted to get XPath for a question to remember that that question is waiting for an answer it didn't work because we were passing it's index properly like 0,1 for example but then getEvent() (without any parameter) used our current index to return the XPath which in case of field-list groups is the index of the whole group not of that particular question.", "author": "grzesiek2010", "createdAt": "2020-12-09T11:39:27Z", "path": "collect_app/src/main/java/org/odk/collect/android/javarosawrapper/FormController.java", "diffHunk": "@@ -183,7 +183,7 @@ public AuditEventLogger getAuditEventLogger() {\n      */\n     public String getXPath(FormIndex index) {\n         String value;\n-        switch (getEvent()) {\n+        switch (getEvent(index)) {", "originalCommit": "2ef4f27a58d274adefad69ca8334f22efda83146", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI3MTk2Mw==", "url": "https://github.com/getodk/collect/pull/4286#discussion_r551271963", "bodyText": "Yeah this just seems cleaner as well!", "author": "seadowg", "createdAt": "2021-01-04T11:51:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIzNDg5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "43df56d831625686777ad6e821a7c8450d2e081b", "chunk": "diff --git a/collect_app/src/main/java/org/odk/collect/android/javarosawrapper/FormController.java b/collect_app/src/main/java/org/odk/collect/android/javarosawrapper/FormController.java\nindex d43516a16..899a5cb25 100644\n--- a/collect_app/src/main/java/org/odk/collect/android/javarosawrapper/FormController.java\n+++ b/collect_app/src/main/java/org/odk/collect/android/javarosawrapper/FormController.java\n\n@@ -183,7 +183,7 @@ public class FormController {\n      */\n     public String getXPath(FormIndex index) {\n         String value;\n-        switch (getEvent(index)) {\n+        switch (getEvent()) {\n             case FormEntryController.EVENT_BEGINNING_OF_FORM:\n                 value = \"beginningOfForm\";\n                 break;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIzNjEzNA==", "url": "https://github.com/getodk/collect/pull/4286#discussion_r539236134", "bodyText": "In 5b6ae1a I just removed this check because we nowhere use putBooleanExtra(\"start\", false); so this is always false. Please correct me if i made a mistake.\nis it possible that external apps use this for something?", "author": "grzesiek2010", "createdAt": "2020-12-09T11:41:26Z", "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java", "diffHunk": "@@ -2343,53 +2333,50 @@ public void denied() {\n                         }\n                     });\n                 } else {\n-                    Intent reqIntent = getIntent();\n-                    boolean showFirst = reqIntent.getBooleanExtra(\"start\", false);", "originalCommit": "2ef4f27a58d274adefad69ca8334f22efda83146", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI2NjgyNA==", "url": "https://github.com/getodk/collect/pull/4286#discussion_r551266824", "bodyText": "I can't find anything on it and it doesn't look like it's documented (looking here) but I'm still a little worried it could be relied on somewhere out there?\nWe can add a note to QA about this to see if they have any test cases for it. It doesn't look like the change would \"break\" anything if someone was using it - the user would just end up on the hierarchy.", "author": "seadowg", "createdAt": "2021-01-04T11:39:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIzNjEzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTkwNDkzOQ==", "url": "https://github.com/getodk/collect/pull/4286#discussion_r551904939", "bodyText": "I removed this change and I'll file a separate issue to discuss it.", "author": "grzesiek2010", "createdAt": "2021-01-05T12:35:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIzNjEzNA=="}], "type": "inlineReview", "revised_code": {"commit": "a71394f00958c37259c0928b71d081a7cdd47ea7", "chunk": "diff --git a/collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java b/collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java\nindex 7155d8117..963463345 100644\n--- a/collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java\n+++ b/collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java\n\n@@ -2325,7 +2331,6 @@ public class FormEntryActivity extends CollectAbstractActivity implements Animat\n                     }\n \n                     formControllerAvailable(formController);\n-\n                     identityPromptViewModel.requiresIdentityToContinue().observe(this, requiresIdentity -> {\n                         if (!requiresIdentity) {\n                             formController.getAuditEventLogger().logEvent(AuditEvent.AuditEventType.FORM_START, true, System.currentTimeMillis());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIzNzUxMg==", "url": "https://github.com/getodk/collect/pull/4286#discussion_r539237512", "bodyText": "If we are here (just after loading a form) and our index is in form (that mean it was saved and now restored) that means it was caused by process death. I hope there are no other cases :)", "author": "grzesiek2010", "createdAt": "2020-12-09T11:43:37Z", "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java", "diffHunk": "@@ -2343,53 +2333,50 @@ public void denied() {\n                         }\n                     });\n                 } else {\n-                    Intent reqIntent = getIntent();\n-                    boolean showFirst = reqIntent.getBooleanExtra(\"start\", false);\n-\n-                    if (!showFirst) {\n-                        // we've just loaded a saved form, so start in the hierarchy view\n-                        String formMode = reqIntent.getStringExtra(ApplicationConstants.BundleKeys.FORM_MODE);\n-                        if (formMode == null || ApplicationConstants.FormModes.EDIT_SAVED.equalsIgnoreCase(formMode)) {\n-                            formControllerAvailable(formController);\n-\n-                            identityPromptViewModel.requiresIdentityToContinue().observe(this, requiresIdentity -> {\n-                                if (!requiresIdentity) {\n-                                    if (!allowMovingBackwards) {\n-                                        // we aren't allowed to jump around the form so attempt to\n-                                        // go directly to the question we were on last time the\n-                                        // form was saved.\n-                                        // TODO: revisit the fallback. If for some reason the index\n-                                        // wasn't saved, we can now jump around which doesn't seem right.\n-                                        FormIndex formIndex = SaveFormIndexTask.loadFormIndexFromFile();\n-                                        if (formIndex != null) {\n-                                            formController.jumpToIndex(formIndex);\n-                                            onScreenRefresh();\n-                                            return;\n-                                        }\n-                                    }\n-\n-                                    formController.getAuditEventLogger().logEvent(AuditEvent.AuditEventType.FORM_RESUME, true, System.currentTimeMillis());\n-                                    formController.getAuditEventLogger().logEvent(AuditEvent.AuditEventType.HIERARCHY, true, System.currentTimeMillis());\n-                                    startActivityForResult(new Intent(this, FormHierarchyActivity.class), RequestCodes.HIERARCHY_ACTIVITY);\n-                                }\n-                            });\n+                    // Returning to the app after process death\n+                    if (formController.getFormIndex().isInForm()) {", "originalCommit": "2ef4f27a58d274adefad69ca8334f22efda83146", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI3MTYxMA==", "url": "https://github.com/getodk/collect/pull/4286#discussion_r551271610", "bodyText": "Could you add more details to the comment here? I'm not sure I follow exactly how we end up with an index in the form in this case but not if I kill the app and then open the form again?\nIt'd also good to point out here that in the activity death scenario we don't need to reload the form so we don't end up here.", "author": "seadowg", "createdAt": "2021-01-04T11:50:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIzNzUxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTkwNDY0NA==", "url": "https://github.com/getodk/collect/pull/4286#discussion_r551904644", "bodyText": "It's not relevant anymore.", "author": "grzesiek2010", "createdAt": "2021-01-05T12:35:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIzNzUxMg=="}], "type": "inlineReview", "revised_code": {"commit": "a71394f00958c37259c0928b71d081a7cdd47ea7", "chunk": "diff --git a/collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java b/collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java\nindex 7155d8117..963463345 100644\n--- a/collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java\n+++ b/collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java\n\n@@ -2325,7 +2331,6 @@ public class FormEntryActivity extends CollectAbstractActivity implements Animat\n                     }\n \n                     formControllerAvailable(formController);\n-\n                     identityPromptViewModel.requiresIdentityToContinue().observe(this, requiresIdentity -> {\n                         if (!requiresIdentity) {\n                             formController.getAuditEventLogger().logEvent(AuditEvent.AuditEventType.FORM_START, true, System.currentTimeMillis());\n"}}, {"oid": "a71394f00958c37259c0928b71d081a7cdd47ea7", "url": "https://github.com/getodk/collect/commit/a71394f00958c37259c0928b71d081a7cdd47ea7", "message": "Added a comment to getFormController() method", "committedDate": "2021-01-05T12:27:25Z", "type": "forcePushed"}, {"oid": "8e2c759200ceecc3c77709e6cabf129d4348bcf0", "url": "https://github.com/getodk/collect/commit/8e2c759200ceecc3c77709e6cabf129d4348bcf0", "message": "Added a comment to getFormController() method", "committedDate": "2021-01-05T12:33:43Z", "type": "forcePushed"}, {"oid": "43df56d831625686777ad6e821a7c8450d2e081b", "url": "https://github.com/getodk/collect/commit/43df56d831625686777ad6e821a7c8450d2e081b", "message": "Call formControllerAvailable() when pending activity result is detected", "committedDate": "2021-01-07T09:59:24Z", "type": "commit"}, {"oid": "47009d4c9343247226c7ddc3acf8e87094616d39", "url": "https://github.com/getodk/collect/commit/47009d4c9343247226c7ddc3acf8e87094616d39", "message": "Fixed FromController.getXPath() method to work well with field-list groups", "committedDate": "2021-01-07T10:00:45Z", "type": "commit"}, {"oid": "5081446191bcbf2bc9dacb5dab4526e0c5085615", "url": "https://github.com/getodk/collect/commit/5081446191bcbf2bc9dacb5dab4526e0c5085615", "message": "Access formcontroller object in FormEntryActivity via getFormController() method only", "committedDate": "2021-01-07T10:00:45Z", "type": "commit"}, {"oid": "9cbbc819d8618f45b930cc43782e0329efba0ac0", "url": "https://github.com/getodk/collect/commit/9cbbc819d8618f45b930cc43782e0329efba0ac0", "message": "Added a comment to getFormController() method", "committedDate": "2021-01-07T10:00:45Z", "type": "commit"}, {"oid": "6221d5dd0a5d9a78c38b22770cba876315775ab3", "url": "https://github.com/getodk/collect/commit/6221d5dd0a5d9a78c38b22770cba876315775ab3", "message": "Removed redundant comments", "committedDate": "2021-01-07T10:01:13Z", "type": "commit"}, {"oid": "74794a3fd7160c6c9dc7c46acb247c787e44c88a", "url": "https://github.com/getodk/collect/commit/74794a3fd7160c6c9dc7c46acb247c787e44c88a", "message": "Removed the temporary fix implemented in #4328", "committedDate": "2021-01-07T10:04:34Z", "type": "commit"}, {"oid": "74794a3fd7160c6c9dc7c46acb247c787e44c88a", "url": "https://github.com/getodk/collect/commit/74794a3fd7160c6c9dc7c46acb247c787e44c88a", "message": "Removed the temporary fix implemented in #4328", "committedDate": "2021-01-07T10:04:34Z", "type": "forcePushed"}]}