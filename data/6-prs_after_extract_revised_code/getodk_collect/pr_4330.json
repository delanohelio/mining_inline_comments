{"pr_number": 4330, "pr_title": "Prevent crash when updating buttons on Main Menu", "pr_createdAt": "2020-12-21T14:22:20Z", "pr_url": "https://github.com/getodk/collect/pull/4330", "timeline": [{"oid": "22812f195cea803a224856e4aac30f26052ce628", "url": "https://github.com/getodk/collect/commit/22812f195cea803a224856e4aac30f26052ce628", "message": "Catch and log crash", "committedDate": "2020-12-21T13:30:37Z", "type": "commit"}, {"oid": "9b2af87ba476f6f1d64906920778fada32cd1e07", "url": "https://github.com/getodk/collect/commit/9b2af87ba476f6f1d64906920778fada32cd1e07", "message": "Log storage migration state with crash", "committedDate": "2020-12-21T13:31:30Z", "type": "commit"}, {"oid": "5e04dcc89b69bda46293ce530915d2397d165a40", "url": "https://github.com/getodk/collect/commit/5e04dcc89b69bda46293ce530915d2397d165a40", "message": "Always reload cursors when updating buttons to avoid cursors pointing at old database", "committedDate": "2020-12-21T13:43:57Z", "type": "commit"}, {"oid": "49d37dc1e1b26754b5c7145d18fb388405c3c224", "url": "https://github.com/getodk/collect/commit/49d37dc1e1b26754b5c7145d18fb388405c3c224", "message": "Stop using deprecated cursor management/querying", "committedDate": "2020-12-21T14:19:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjczNTQwMw==", "url": "https://github.com/getodk/collect/pull/4330#discussion_r546735403", "bodyText": "We don't need to keep any of this state in the Activity any longer.", "author": "seadowg", "createdAt": "2020-12-21T14:27:31Z", "path": "collect_app/src/main/java/org/odk/collect/android/activities/MainMenuActivity.java", "diffHunk": "@@ -96,12 +96,7 @@\n     private Button getFormsButton;\n     private AlertDialog alertDialog;\n     private MenuItem qrcodeScannerMenuItem;\n-    private int completedCount;", "originalCommit": "49d37dc1e1b26754b5c7145d18fb388405c3c224", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjczNTc5Mw==", "url": "https://github.com/getodk/collect/pull/4330#discussion_r546735793", "bodyText": "requery is deprecated. The advice is to just open a new cursor.", "author": "seadowg", "createdAt": "2020-12-21T14:28:15Z", "path": "collect_app/src/main/java/org/odk/collect/android/activities/MainMenuActivity.java", "diffHunk": "@@ -422,46 +374,50 @@ public void onClick(DialogInterface dialog, int i) {\n     }\n \n     private void updateButtons() {\n-        if (finalizedCursor != null && !finalizedCursor.isClosed()) {\n-            finalizedCursor.requery();", "originalCommit": "49d37dc1e1b26754b5c7145d18fb388405c3c224", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3e96e17911d9128e00c86778973f023d41a6b8e9", "chunk": "diff --git a/collect_app/src/main/java/org/odk/collect/android/activities/MainMenuActivity.java b/collect_app/src/main/java/org/odk/collect/android/activities/MainMenuActivity.java\nindex 84cd8d6b7..394ec05fd 100644\n--- a/collect_app/src/main/java/org/odk/collect/android/activities/MainMenuActivity.java\n+++ b/collect_app/src/main/java/org/odk/collect/android/activities/MainMenuActivity.java\n\n@@ -374,50 +374,49 @@ public class MainMenuActivity extends CollectAbstractActivity implements AdminPa\n     }\n \n     private void updateButtons() {\n-        InstancesDao instancesDao = new InstancesDao();\n+        if (!storageMigrationRepository.isMigrationBeingPerformed()) {\n+            InstancesDao instancesDao = new InstancesDao();\n \n-        int completedCount;\n-        try (Cursor finalizedCursor = instancesDao.getFinalizedInstancesCursor()) {\n-            completedCount = finalizedCursor != null ? finalizedCursor.getCount() : 0;\n-        } catch (Exception e1) {\n-            createErrorDialog(e1.getMessage(), EXIT);\n-            return;\n-        }\n+            int completedCount;\n+            try (Cursor finalizedCursor = instancesDao.getFinalizedInstancesCursor()) {\n+                completedCount = finalizedCursor != null ? finalizedCursor.getCount() : 0;\n+            } catch (Exception ignored) {\n+                completedCount = 0;\n+            }\n \n-        try (Cursor savedCursor = instancesDao.getUnsentInstancesCursor()) {\n-            savedCount = savedCursor != null ? savedCursor.getCount() : 0;\n-        } catch (Exception e1) {\n-            createErrorDialog(e1.getMessage(), EXIT);\n-            return;\n-        }\n+            try (Cursor savedCursor = instancesDao.getUnsentInstancesCursor()) {\n+                savedCount = savedCursor != null ? savedCursor.getCount() : 0;\n+            } catch (Exception ignored) {\n+                savedCount = 0;\n+            }\n \n-        int viewSentCount;\n-        try (Cursor viewSentCursor = instancesDao.getSentInstancesCursor()) {\n-            viewSentCount = viewSentCursor != null ? viewSentCursor.getCount() : 0;\n-        } catch (Exception e1) {\n-            createErrorDialog(e1.getMessage(), EXIT);\n-            return;\n-        }\n+            int viewSentCount;\n+            try (Cursor viewSentCursor = instancesDao.getSentInstancesCursor()) {\n+                viewSentCount = viewSentCursor != null ? viewSentCursor.getCount() : 0;\n+            } catch (Exception ignored) {\n+                viewSentCount = 0;\n+            }\n \n-        if (completedCount > 0) {\n-            sendDataButton.setText(\n-                    getString(R.string.send_data_button, String.valueOf(completedCount)));\n-        } else {\n-            sendDataButton.setText(getString(R.string.send_data));\n-        }\n+            if (completedCount > 0) {\n+                sendDataButton.setText(\n+                        getString(R.string.send_data_button, String.valueOf(completedCount)));\n+            } else {\n+                sendDataButton.setText(getString(R.string.send_data));\n+            }\n \n-        if (savedCount > 0) {\n-            reviewDataButton.setText(getString(R.string.review_data_button,\n-                    String.valueOf(savedCount)));\n-        } else {\n-            reviewDataButton.setText(getString(R.string.review_data));\n-        }\n+            if (savedCount > 0) {\n+                reviewDataButton.setText(getString(R.string.review_data_button,\n+                        String.valueOf(savedCount)));\n+            } else {\n+                reviewDataButton.setText(getString(R.string.review_data));\n+            }\n \n-        if (viewSentCount > 0) {\n-            viewSentFormsButton.setText(\n-                    getString(R.string.view_sent_forms_button, String.valueOf(viewSentCount)));\n-        } else {\n-            viewSentFormsButton.setText(getString(R.string.view_sent_forms));\n+            if (viewSentCount > 0) {\n+                viewSentFormsButton.setText(\n+                        getString(R.string.view_sent_forms_button, String.valueOf(viewSentCount)));\n+            } else {\n+                viewSentFormsButton.setText(getString(R.string.view_sent_forms));\n+            }\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjczNjMxNQ==", "url": "https://github.com/getodk/collect/pull/4330#discussion_r546736315", "bodyText": "startManagingCursor is deprecated. Instead of doing this I've switched it to using try-with-resource to manage opening/closing.", "author": "seadowg", "createdAt": "2020-12-21T14:29:08Z", "path": "collect_app/src/main/java/org/odk/collect/android/activities/MainMenuActivity.java", "diffHunk": "@@ -358,48 +352,6 @@ private void initToolbar() {\n         setSupportActionBar(toolbar);\n     }\n \n-    private void countSavedForms() {\n-        InstancesDao instancesDao = new InstancesDao();\n-\n-        // count for finalized instances\n-        try {\n-            finalizedCursor = instancesDao.getFinalizedInstancesCursor();\n-        } catch (Exception e) {\n-            createErrorDialog(e.getMessage(), EXIT);\n-            return;\n-        }\n-\n-        if (finalizedCursor != null) {\n-            startManagingCursor(finalizedCursor);\n-        }\n-        completedCount = finalizedCursor != null ? finalizedCursor.getCount() : 0;\n-\n-        // count for saved instances\n-        try {\n-            savedCursor = instancesDao.getUnsentInstancesCursor();\n-        } catch (Exception e) {\n-            createErrorDialog(e.getMessage(), EXIT);\n-            return;\n-        }\n-\n-        if (savedCursor != null) {\n-            startManagingCursor(savedCursor);\n-        }\n-        savedCount = savedCursor != null ? savedCursor.getCount() : 0;\n-\n-        //count for view sent form\n-        try {\n-            viewSentCursor = instancesDao.getSentInstancesCursor();\n-        } catch (Exception e) {\n-            createErrorDialog(e.getMessage(), EXIT);\n-            return;\n-        }\n-        if (viewSentCursor != null) {\n-            startManagingCursor(viewSentCursor);", "originalCommit": "49d37dc1e1b26754b5c7145d18fb388405c3c224", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "3e96e17911d9128e00c86778973f023d41a6b8e9", "url": "https://github.com/getodk/collect/commit/3e96e17911d9128e00c86778973f023d41a6b8e9", "message": "Don't show fatal error if there is a DB error updating button counts", "committedDate": "2020-12-22T17:34:43Z", "type": "commit"}]}