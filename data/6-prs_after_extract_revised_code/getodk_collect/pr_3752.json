{"pr_number": 3752, "pr_title": "Allow null select one values", "pr_createdAt": "2020-04-01T14:46:12Z", "pr_url": "https://github.com/getodk/collect/pull/3752", "timeline": [{"oid": "6de4003fdcaaccc5c9212499789e382d272990df", "url": "https://github.com/getodk/collect/commit/6de4003fdcaaccc5c9212499789e382d272990df", "message": "Add test for blank select one choices", "committedDate": "2020-04-01T13:46:30Z", "type": "commit"}, {"oid": "dc65b259fa8436ab39bc20b9c0933f7f7e9bb6a7", "url": "https://github.com/getodk/collect/commit/dc65b259fa8436ab39bc20b9c0933f7f7e9bb6a7", "message": "Add check for null values in select one", "committedDate": "2020-04-01T13:52:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2MTAwMg==", "url": "https://github.com/getodk/collect/pull/3752#discussion_r401961002", "bodyText": "I don't understand this test! The test that is introduced should fail or crash at this point and this one passes. I don't understand \"shown\" in its name. This issue is only about the underlying value, not about what is displayed, right? If you were going to test what is displayed, innerText on getChildAt(0) wouldn't make sense because that gives you the linear layout that contains the audio-video-image-text-label view.\nI think you probably want to do something like select the first choice and verify that its value is blank. Again, it should fail or crash in this commit.", "author": "lognaturel", "createdAt": "2020-04-01T23:06:10Z", "path": "collect_app/src/test/java/org/odk/collect/android/widgets/SelectOneWidgetTest.java", "diffHunk": "@@ -104,29 +106,21 @@ public void whenChoicesHaveAudio_logsAudioChoiceEvent() throws Exception {\n                 ))\n                 .build();\n \n-        populateRecyclerView(getActualWidget());\n+        populateRecyclerView(getWidget());\n         verify(analytics).logEvent(\"Prompt\", \"AudioChoice\", \"formAnalyticsID\");\n     }\n \n-    private void overrideDependencyModule() throws Exception {\n-        ReferenceManager referenceManager = setupFakeReferenceManager(REFERENCES);\n-        RobolectricHelpers.overrideAppDependencyModule(new AppDependencyModule() {\n-\n-            @Override\n-            public ReferenceManager providesReferenceManager() {\n-                return referenceManager;\n-            }\n-\n-            @Override\n-            public AudioHelperFactory providesAudioHelperFactory() {\n-                return context -> audioHelper;\n-            }\n+    @Test\n+    public void whenAChoiceIsBlank_itIsShownAsBlank() {", "originalCommit": "6de4003fdcaaccc5c9212499789e382d272990df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2Mjc1Ng==", "url": "https://github.com/getodk/collect/pull/3752#discussion_r401962756", "bodyText": "I see from looking at the other commit that you seem to have intentionally introduced a test for a blank value that was intended to pass.", "author": "lognaturel", "createdAt": "2020-04-01T23:11:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2MTAwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE2NDY0Nw==", "url": "https://github.com/getodk/collect/pull/3752#discussion_r402164647", "bodyText": "Yeah I wanted to check the blank and null cases. It's calling widget.getChoicesList().getChildAt(0) so it is checking what is displayed for that select choice. That being said I agree that isn't really the right test here. I think when I wrote this (a wee while ago) I confused value and label. As you say the \"feature\" we're actually trying to drive out here is that when you select a blank/null value you get a blank/null answer in the widget. Rest assured a forehead has been slapped and this will be changed.", "author": "seadowg", "createdAt": "2020-04-02T09:10:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2MTAwMg=="}], "type": "inlineReview", "revised_code": {"commit": "196ebc82fcd766fed92e04e2041c328e6e2696e6", "chunk": "diff --git a/collect_app/src/test/java/org/odk/collect/android/widgets/SelectOneWidgetTest.java b/collect_app/src/test/java/org/odk/collect/android/widgets/SelectOneWidgetTest.java\nindex 65ef787f3..8b2b900aa 100644\n--- a/collect_app/src/test/java/org/odk/collect/android/widgets/SelectOneWidgetTest.java\n+++ b/collect_app/src/test/java/org/odk/collect/android/widgets/SelectOneWidgetTest.java\n\n@@ -111,16 +111,19 @@ public class SelectOneWidgetTest extends GeneralSelectOneWidgetTest<SelectOneWid\n     }\n \n     @Test\n-    public void whenAChoiceIsBlank_itIsShownAsBlank() {\n+    public void whenAChoiceValueIsNull_selecting_doesNotSetAnswer() {\n+        SelectChoice selectChoice = new SelectChoice(); // The two arg constructor protects against null values\n+        selectChoice.setTextID(\"1\");\n+\n         formEntryPrompt = new MockFormEntryPromptBuilder()\n-                .withSelectChoices(asList(\n-                        new SelectChoice(\"1\", \"\")\n-                ))\n+                .withSelectChoices(asList(selectChoice))\n                 .build();\n \n         SelectOneWidget widget = getWidget();\n         populateRecyclerView(widget);\n-        assertThat(innerText(widget.getChoicesList().getChildAt(0)), equalTo(\"\"));\n+\n+        clickChoice(widget, 0);\n+        assertThat(widget.getAnswer(), nullValue());\n     }\n \n     @Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2MjE1Mw==", "url": "https://github.com/getodk/collect/pull/3752#discussion_r401962153", "bodyText": "This test would crash without the code change so that's good. But I still don't think it's asserting something that makes sense.", "author": "lognaturel", "createdAt": "2020-04-01T23:09:38Z", "path": "collect_app/src/test/java/org/odk/collect/android/widgets/SelectOneWidgetTest.java", "diffHunk": "@@ -123,6 +123,22 @@ public void whenAChoiceIsBlank_itIsShownAsBlank() {\n         assertThat(innerText(widget.getChoicesList().getChildAt(0)), equalTo(\"\"));\n     }\n \n+    @Test\n+    public void whenAChoiceValueIsNull_itIsShownAsBlank() {\n+        SelectChoice selectChoice = new SelectChoice(); // The two arg constructor protects against null values\n+        selectChoice.setTextID(\"1\");\n+\n+        formEntryPrompt = new MockFormEntryPromptBuilder()\n+                .withSelectChoices(asList(\n+                        selectChoice\n+                ))\n+                .build();\n+\n+        SelectOneWidget widget = getWidget();\n+        populateRecyclerView(widget);\n+        assertThat(innerText(widget.getChoicesList().getChildAt(0)), equalTo(\"\"));", "originalCommit": "dc65b259fa8436ab39bc20b9c0933f7f7e9bb6a7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "196ebc82fcd766fed92e04e2041c328e6e2696e6", "chunk": "diff --git a/collect_app/src/test/java/org/odk/collect/android/widgets/SelectOneWidgetTest.java b/collect_app/src/test/java/org/odk/collect/android/widgets/SelectOneWidgetTest.java\nindex 54874ac88..8b2b900aa 100644\n--- a/collect_app/src/test/java/org/odk/collect/android/widgets/SelectOneWidgetTest.java\n+++ b/collect_app/src/test/java/org/odk/collect/android/widgets/SelectOneWidgetTest.java\n\n@@ -111,32 +111,19 @@ public class SelectOneWidgetTest extends GeneralSelectOneWidgetTest<SelectOneWid\n     }\n \n     @Test\n-    public void whenAChoiceValueIsBlank_itIsShownAsBlank() {\n-        formEntryPrompt = new MockFormEntryPromptBuilder()\n-                .withSelectChoices(asList(\n-                        new SelectChoice(\"1\", \"\")\n-                ))\n-                .build();\n-\n-        SelectOneWidget widget = getWidget();\n-        populateRecyclerView(widget);\n-        assertThat(innerText(widget.getChoicesList().getChildAt(0)), equalTo(\"\"));\n-    }\n-\n-    @Test\n-    public void whenAChoiceValueIsNull_itIsShownAsBlank() {\n+    public void whenAChoiceValueIsNull_selecting_doesNotSetAnswer() {\n         SelectChoice selectChoice = new SelectChoice(); // The two arg constructor protects against null values\n         selectChoice.setTextID(\"1\");\n \n         formEntryPrompt = new MockFormEntryPromptBuilder()\n-                .withSelectChoices(asList(\n-                        selectChoice\n-                ))\n+                .withSelectChoices(asList(selectChoice))\n                 .build();\n \n         SelectOneWidget widget = getWidget();\n         populateRecyclerView(widget);\n-        assertThat(innerText(widget.getChoicesList().getChildAt(0)), equalTo(\"\"));\n+\n+        clickChoice(widget, 0);\n+        assertThat(widget.getAnswer(), nullValue());\n     }\n \n     @Test\n"}}, {"oid": "196ebc82fcd766fed92e04e2041c328e6e2696e6", "url": "https://github.com/getodk/collect/commit/196ebc82fcd766fed92e04e2041c328e6e2696e6", "message": "Add test to check null select values can't be selected", "committedDate": "2020-04-02T16:12:00Z", "type": "commit"}]}