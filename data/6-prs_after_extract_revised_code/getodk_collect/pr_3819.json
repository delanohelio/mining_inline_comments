{"pr_number": 3819, "pr_title": "Make sure MapBox init fails silently", "pr_createdAt": "2020-05-08T16:24:03Z", "pr_url": "https://github.com/getodk/collect/pull/3819", "timeline": [{"oid": "d9aae77710ed73be9d864fe3ef74651d7e6a7117", "url": "https://github.com/getodk/collect/commit/d9aae77710ed73be9d864fe3ef74651d7e6a7117", "message": "Make sure MapBox init fails silently", "committedDate": "2020-05-08T16:18:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI0MDAzOA==", "url": "https://github.com/getodk/collect/pull/3819#discussion_r422240038", "bodyText": "I would catch Error here as well it might be needed in some cases like f6bc94e", "author": "grzesiek2010", "createdAt": "2020-05-08T16:27:46Z", "path": "collect_app/src/main/java/org/odk/collect/android/activities/SplashScreenActivity.java", "diffHunk": "@@ -231,7 +231,13 @@ public void run() {\n     }\n \n     private void initMapBox() {\n-        MapView mapView = findViewById(R.id.mapView);\n-        mapView.getMapAsync(mapBoxMap -> mapBoxMap.setStyle(Style.MAPBOX_STREETS, style -> { }));\n+        // This \"one weird trick\" lets us initialize MapBox at app start when the internet is\n+        // most likely to be available. This is annoyingly needed for offline tiles to work.\n+        try {\n+            MapView mapView = getLayoutInflater().inflate(R.layout.mapbox_init, null).findViewById(R.id.mapView);\n+            mapView.getMapAsync(mapBoxMap -> mapBoxMap.setStyle(Style.MAPBOX_STREETS, style -> { }));\n+        } catch (Exception ignored) {", "originalCommit": "d9aae77710ed73be9d864fe3ef74651d7e6a7117", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI0MDU0NQ==", "url": "https://github.com/getodk/collect/pull/3819#discussion_r422240545", "bodyText": "Good call! We want to account for everything.", "author": "seadowg", "createdAt": "2020-05-08T16:28:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI0MDAzOA=="}], "type": "inlineReview", "revised_code": {"commit": "97c219508cbcfc1c44d342932900c3a14ff28fed", "chunk": "diff --git a/collect_app/src/main/java/org/odk/collect/android/activities/SplashScreenActivity.java b/collect_app/src/main/java/org/odk/collect/android/activities/SplashScreenActivity.java\nindex 15d934ff7..1ea8368bc 100644\n--- a/collect_app/src/main/java/org/odk/collect/android/activities/SplashScreenActivity.java\n+++ b/collect_app/src/main/java/org/odk/collect/android/activities/SplashScreenActivity.java\n\n@@ -236,7 +236,7 @@ public class SplashScreenActivity extends Activity {\n         try {\n             MapView mapView = getLayoutInflater().inflate(R.layout.mapbox_init, null).findViewById(R.id.mapView);\n             mapView.getMapAsync(mapBoxMap -> mapBoxMap.setStyle(Style.MAPBOX_STREETS, style -> { }));\n-        } catch (Exception ignored) {\n+        } catch (Exception | Error ignored) {\n             // This will crash on devices where the arch for MapBox is not included\n         }\n     }\n"}}, {"oid": "97c219508cbcfc1c44d342932900c3a14ff28fed", "url": "https://github.com/getodk/collect/commit/97c219508cbcfc1c44d342932900c3a14ff28fed", "message": "Catch Error from Mapbox init fails as well", "committedDate": "2020-05-08T16:29:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI0MzkwMw==", "url": "https://github.com/getodk/collect/pull/3819#discussion_r422243903", "bodyText": "Are you sure this still does the job? I mean the map is not displayed anywhere but it might be required.", "author": "grzesiek2010", "createdAt": "2020-05-08T16:35:31Z", "path": "collect_app/src/main/java/org/odk/collect/android/activities/SplashScreenActivity.java", "diffHunk": "@@ -231,7 +231,13 @@ public void run() {\n     }\n \n     private void initMapBox() {\n-        MapView mapView = findViewById(R.id.mapView);\n-        mapView.getMapAsync(mapBoxMap -> mapBoxMap.setStyle(Style.MAPBOX_STREETS, style -> { }));\n+        // This \"one weird trick\" lets us initialize MapBox at app start when the internet is\n+        // most likely to be available. This is annoyingly needed for offline tiles to work.\n+        try {\n+            MapView mapView = getLayoutInflater().inflate(R.layout.mapbox_init, null).findViewById(R.id.mapView);", "originalCommit": "97c219508cbcfc1c44d342932900c3a14ff28fed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI0NTAxOQ==", "url": "https://github.com/getodk/collect/pull/3819#discussion_r422245019", "bodyText": "Not had a chance to double check yet. I could see that being a problem.", "author": "seadowg", "createdAt": "2020-05-08T16:37:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI0MzkwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI0NTY0MQ==", "url": "https://github.com/getodk/collect/pull/3819#discussion_r422245641", "bodyText": "@grzesiek2010 if you have basemaps already ready to go could you check? I don't have anything setup for any of this.", "author": "seadowg", "createdAt": "2020-05-08T16:39:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI0MzkwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI0Njk0OA==", "url": "https://github.com/getodk/collect/pull/3819#discussion_r422246948", "bodyText": "Ok will do.", "author": "grzesiek2010", "createdAt": "2020-05-08T16:41:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI0MzkwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI0Nzg2Mg==", "url": "https://github.com/getodk/collect/pull/3819#discussion_r422247862", "bodyText": "Thanks!", "author": "seadowg", "createdAt": "2020-05-08T16:43:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI0MzkwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI1MTU2OA==", "url": "https://github.com/getodk/collect/pull/3819#discussion_r422251568", "bodyText": "Yeah as I thought it doesn't work. It needs to be displayed.", "author": "grzesiek2010", "createdAt": "2020-05-08T16:50:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI0MzkwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI4NTY4OA==", "url": "https://github.com/getodk/collect/pull/3819#discussion_r422285688", "bodyText": "Ach really? That's weird. I wonder what part of the View's lifecycle needs to get hit. Definitely possible to inflate and then add this into the view hierarchy though. I'm not going to be able to look at this again tonight though. @lognaturel if this is getting in your way (i.e. you need to look at the app on an emulator) I'd suggest merging this or reverting #3804. Also feel free to push to this if you have a version that retains the fixes from #3804!", "author": "seadowg", "createdAt": "2020-05-08T17:58:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI0MzkwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI5NzgzMA==", "url": "https://github.com/getodk/collect/pull/3819#discussion_r422297830", "bodyText": "I'll take a look.", "author": "grzesiek2010", "createdAt": "2020-05-08T18:23:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI0MzkwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjM4NTYzNw==", "url": "https://github.com/getodk/collect/pull/3819#discussion_r422385637", "bodyText": "Ok it's done. I moved the code from the SplashScreen to the MainMenuActivity because once we merge #3813 the SplashScreen won't be displayed by default so the fix also won't work.", "author": "grzesiek2010", "createdAt": "2020-05-08T21:32:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI0MzkwMw=="}], "type": "inlineReview", "revised_code": {"commit": "9cede13f5ad9e5f060cdd2941a1a8720903b287b", "chunk": "diff --git a/collect_app/src/main/java/org/odk/collect/android/activities/SplashScreenActivity.java b/collect_app/src/main/java/org/odk/collect/android/activities/SplashScreenActivity.java\nindex 1ea8368bc..e7135477a 100644\n--- a/collect_app/src/main/java/org/odk/collect/android/activities/SplashScreenActivity.java\n+++ b/collect_app/src/main/java/org/odk/collect/android/activities/SplashScreenActivity.java\n\n@@ -229,15 +225,4 @@ public class SplashScreenActivity extends Activity {\n         };\n         t.start();\n     }\n-\n-    private void initMapBox() {\n-        // This \"one weird trick\" lets us initialize MapBox at app start when the internet is\n-        // most likely to be available. This is annoyingly needed for offline tiles to work.\n-        try {\n-            MapView mapView = getLayoutInflater().inflate(R.layout.mapbox_init, null).findViewById(R.id.mapView);\n-            mapView.getMapAsync(mapBoxMap -> mapBoxMap.setStyle(Style.MAPBOX_STREETS, style -> { }));\n-        } catch (Exception | Error ignored) {\n-            // This will crash on devices where the arch for MapBox is not included\n-        }\n-    }\n }\n"}}, {"oid": "9cede13f5ad9e5f060cdd2941a1a8720903b287b", "url": "https://github.com/getodk/collect/commit/9cede13f5ad9e5f060cdd2941a1a8720903b287b", "message": "Display mapbox map to perform initialization", "committedDate": "2020-05-08T21:26:09Z", "type": "commit"}]}