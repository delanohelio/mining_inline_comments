{"pr_number": 3814, "pr_title": "Add analytics that will help shape changes to the onboarding experience", "pr_createdAt": "2020-05-07T00:42:54Z", "pr_url": "https://github.com/getodk/collect/pull/3814", "timeline": [{"oid": "eb729cad485d1b045f05b60900ee10c663080bee", "url": "https://github.com/getodk/collect/commit/eb729cad485d1b045f05b60900ee10c663080bee", "message": "Track form download analytics", "committedDate": "2020-05-08T22:52:52Z", "type": "forcePushed"}, {"oid": "4e433628a140df6d945523a80a233bb9223378e4", "url": "https://github.com/getodk/collect/commit/4e433628a140df6d945523a80a233bb9223378e4", "message": "Track form download analytics", "committedDate": "2020-05-09T00:20:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk2NTIzNw==", "url": "https://github.com/getodk/collect/pull/3814#discussion_r422965237", "bodyText": "How would you feel about moving all of the analytics logging code to the ViewModel here? Ideally startFormDownload would be a ViewModel method and the analytics would be encapsulated within there but right now we could move logDownloadAnalyticsEvent to the ViewModel and then all the analytics testing/concern could be hidden from the Activity (you might still want a test to check the method is called).", "author": "seadowg", "createdAt": "2020-05-11T11:12:21Z", "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormDownloadListActivity.java", "diffHunk": "@@ -191,11 +204,10 @@ private void init(Bundle savedInstanceState) {\n \n         downloadButton = findViewById(R.id.add_button);\n         downloadButton.setEnabled(listView.getCheckedItemCount() > 0);\n-        downloadButton.setOnClickListener(new OnClickListener() {\n-            @Override\n-            public void onClick(View v) {\n-                downloadSelectedFiles();\n-            }\n+        downloadButton.setOnClickListener(v -> {\n+            ArrayList<FormDetails> filesToDownload = getFilesToDownload();\n+            logDownloadAnalyticsEvent();", "originalCommit": "4e433628a140df6d945523a80a233bb9223378e4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE2MjI0Mg==", "url": "https://github.com/getodk/collect/pull/3814#discussion_r424162242", "bodyText": "Makes sense. \ud83d\udc4d", "author": "lognaturel", "createdAt": "2020-05-13T04:12:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk2NTIzNw=="}], "type": "inlineReview", "revised_code": {"commit": "eed1b1e2fd2912b8272183c5ef7d2b813eb8459c", "chunk": "diff --git a/collect_app/src/main/java/org/odk/collect/android/activities/FormDownloadListActivity.java b/collect_app/src/main/java/org/odk/collect/android/activities/FormDownloadListActivity.java\nindex a7466af0a..9c3d88198 100644\n--- a/collect_app/src/main/java/org/odk/collect/android/activities/FormDownloadListActivity.java\n+++ b/collect_app/src/main/java/org/odk/collect/android/activities/FormDownloadListActivity.java\n\n@@ -206,7 +207,8 @@ public class FormDownloadListActivity extends FormListActivity implements FormLi\n         downloadButton.setEnabled(listView.getCheckedItemCount() > 0);\n         downloadButton.setOnClickListener(v -> {\n             ArrayList<FormDetails> filesToDownload = getFilesToDownload();\n-            logDownloadAnalyticsEvent();\n+            viewModel.logDownloadAnalyticsEvent(formsDao.getFormsCursor().getCount(),\n+                    webCredentialsUtils.getServerUrlFromPreferences());\n             startFormsDownload(filesToDownload);\n         });\n \n"}}, {"oid": "eed1b1e2fd2912b8272183c5ef7d2b813eb8459c", "url": "https://github.com/getodk/collect/commit/eed1b1e2fd2912b8272183c5ef7d2b813eb8459c", "message": "Fix stale comment about action format", "committedDate": "2020-05-13T04:15:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI4ODU0OA==", "url": "https://github.com/getodk/collect/pull/3814#discussion_r424288548", "bodyText": "These methods (getDownloadAnalyticsEvent and getDownloadAnalyticsDescription) feel like they should be private now as they're just used as helpers for logDownloadAnalyticsEvents and don't feel like they should be part of the external interface of the object. That would also mean reworking the tests a bit.", "author": "seadowg", "createdAt": "2020-05-13T09:09:07Z", "path": "collect_app/src/main/java/org/odk/collect/android/activities/viewmodels/FormDownloadListViewModel.java", "diffHunk": "@@ -207,4 +226,37 @@ public boolean wasLoadingCanceled() {\n     public void setLoadingCanceled(boolean loadingCanceled) {\n         this.loadingCanceled = loadingCanceled;\n     }\n+\n+    public void logDownloadAnalyticsEvent(int downloadedFormCount, String serverUrl) {\n+        String analyticsEvent = getDownloadAnalyticsEvent(downloadedFormCount);\n+        String analyticsDesc = getDownloadAnalyticsDescription(serverUrl);\n+        analytics.logEvent(analyticsEvent, analyticsDesc);\n+    }\n+\n+    String getDownloadAnalyticsEvent(int downloadedFormCount) {", "originalCommit": "eed1b1e2fd2912b8272183c5ef7d2b813eb8459c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4e19aa605e564c25895cf0f70c6b16bdb3f15b67", "chunk": "diff --git a/collect_app/src/main/java/org/odk/collect/android/activities/viewmodels/FormDownloadListViewModel.java b/collect_app/src/main/java/org/odk/collect/android/activities/viewmodels/FormDownloadListViewModel.java\nindex ebbe2abcb..c8145c385 100644\n--- a/collect_app/src/main/java/org/odk/collect/android/activities/viewmodels/FormDownloadListViewModel.java\n+++ b/collect_app/src/main/java/org/odk/collect/android/activities/viewmodels/FormDownloadListViewModel.java\n\n@@ -226,37 +212,4 @@ public class FormDownloadListViewModel extends ViewModel {\n     public void setLoadingCanceled(boolean loadingCanceled) {\n         this.loadingCanceled = loadingCanceled;\n     }\n-\n-    public void logDownloadAnalyticsEvent(int downloadedFormCount, String serverUrl) {\n-        String analyticsEvent = getDownloadAnalyticsEvent(downloadedFormCount);\n-        String analyticsDesc = getDownloadAnalyticsDescription(serverUrl);\n-        analytics.logEvent(analyticsEvent, analyticsDesc);\n-    }\n-\n-    String getDownloadAnalyticsEvent(int downloadedFormCount) {\n-        return downloadedFormCount == 0 ? FIRST_FORM_DOWNLOAD : SUBSEQUENT_FORM_DOWNLOAD;\n-    }\n-\n-    String getDownloadAnalyticsDescription(String serverUrl) {\n-        // If a URL was set by intent, use that\n-        serverUrl = getUrl() != null ? getUrl() : serverUrl;\n-\n-        String serverHash = FileUtils.getMd5Hash(new ByteArrayInputStream(serverUrl.getBytes()));\n-        return getSelectedFormIds().size() + \"/\" + getFormList().size() + \"-\" + serverHash;\n-    }\n-\n-    public static class Factory implements ViewModelProvider.Factory {\n-        private final Analytics analytics;\n-\n-        public Factory(Analytics analytics) {\n-            this.analytics = analytics;\n-        }\n-\n-        @SuppressWarnings(\"unchecked\")\n-        @NonNull\n-        @Override\n-        public <T extends ViewModel> T create(@NonNull Class<T> modelClass) {\n-            return (T) new FormDownloadListViewModel(analytics);\n-        }\n-    }\n }\n"}}, {"oid": "4e19aa605e564c25895cf0f70c6b16bdb3f15b67", "url": "https://github.com/getodk/collect/commit/4e19aa605e564c25895cf0f70c6b16bdb3f15b67", "message": "Rename fields to make contents clearer", "committedDate": "2020-05-13T21:43:22Z", "type": "commit"}, {"oid": "0c908b9d5a1beeb895ba562d145f3ad640539c99", "url": "https://github.com/getodk/collect/commit/0c908b9d5a1beeb895ba562d145f3ad640539c99", "message": "Make analytics event and description helpers private", "committedDate": "2020-05-13T21:43:55Z", "type": "forcePushed"}, {"oid": "8998327c5c573c3a9b75237cb518a9fd57371101", "url": "https://github.com/getodk/collect/commit/8998327c5c573c3a9b75237cb518a9fd57371101", "message": "Track form download analytics", "committedDate": "2020-05-13T21:54:37Z", "type": "commit"}, {"oid": "8998327c5c573c3a9b75237cb518a9fd57371101", "url": "https://github.com/getodk/collect/commit/8998327c5c573c3a9b75237cb518a9fd57371101", "message": "Track form download analytics", "committedDate": "2020-05-13T21:54:37Z", "type": "forcePushed"}]}