{"pr_number": 4035, "pr_title": "Handle NPE in DatabaseMediaFileRepository#getAll()", "pr_createdAt": "2020-08-24T08:03:54Z", "pr_url": "https://github.com/getodk/collect/pull/4035", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ1Mzc3OQ==", "url": "https://github.com/getodk/collect/pull/4035#discussion_r475453779", "bodyText": "I think we could avoid the array initialization here with an if-else on the formMediaPath != null and just returning emptyList in the else case. The new File[0] going into the asList confused me.", "author": "seadowg", "createdAt": "2020-08-24T09:17:25Z", "path": "collect_app/src/main/java/org/odk/collect/android/forms/DatabaseMediaFileRepository.java", "diffHunk": "@@ -12,7 +12,10 @@\n     @Override\n     public List<File> getAll(String jrFormID, String formVersion) {\n         String formMediaPath = new FormsDao().getFormMediaPath(jrFormID, formVersion);\n-        File[] files = new File(formMediaPath).listFiles();\n+        File[] files = new File[0];", "originalCommit": "b7ef4f8611c727f75c1ef969d8e128338784a5a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUzMjgyOQ==", "url": "https://github.com/getodk/collect/pull/4035#discussion_r475532829", "bodyText": "Done.", "author": "grzesiek2010", "createdAt": "2020-08-24T11:27:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ1Mzc3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "5bc4d0f102c608bbc5bd1dcce95d4a69ebcffdb6", "chunk": "diff --git a/collect_app/src/main/java/org/odk/collect/android/forms/DatabaseMediaFileRepository.java b/collect_app/src/main/java/org/odk/collect/android/database/DatabaseMediaFileRepository.java\nsimilarity index 59%\nrename from collect_app/src/main/java/org/odk/collect/android/forms/DatabaseMediaFileRepository.java\nrename to collect_app/src/main/java/org/odk/collect/android/database/DatabaseMediaFileRepository.java\nindex a97591386..4ef762bff 100644\n--- a/collect_app/src/main/java/org/odk/collect/android/forms/DatabaseMediaFileRepository.java\n+++ b/collect_app/src/main/java/org/odk/collect/android/database/DatabaseMediaFileRepository.java\n\n@@ -12,10 +14,8 @@ public class DatabaseMediaFileRepository implements MediaFileRepository {\n     @Override\n     public List<File> getAll(String jrFormID, String formVersion) {\n         String formMediaPath = new FormsDao().getFormMediaPath(jrFormID, formVersion);\n-        File[] files = new File[0];\n-        if (formMediaPath != null) {\n-            files = new File(formMediaPath).listFiles();\n-        }\n-        return asList(files);\n+        return formMediaPath == null\n+                ? new ArrayList<>()\n+                : asList(new File(formMediaPath).listFiles());\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ1NTk2NA==", "url": "https://github.com/getodk/collect/pull/4035#discussion_r475455964", "bodyText": "I think we need a test to drive this out so we avoid regressing at any point. As far as I can see the situation that gives us the NPE (for the previous code) was if getAll was queried for a jrFormID and formVersion not in the database. If that's right we could have a DatabaseMediaFileRepositoryTest similar to the DatabaseFormRepositoryTest and a test that just checks we get back an empty list when there is nothing in the database.", "author": "seadowg", "createdAt": "2020-08-24T09:21:03Z", "path": "collect_app/src/main/java/org/odk/collect/android/forms/DatabaseMediaFileRepository.java", "diffHunk": "@@ -12,7 +12,10 @@\n     @Override\n     public List<File> getAll(String jrFormID, String formVersion) {\n         String formMediaPath = new FormsDao().getFormMediaPath(jrFormID, formVersion);\n-        File[] files = new File(formMediaPath).listFiles();\n+        File[] files = new File[0];\n+        if (formMediaPath != null) {", "originalCommit": "b7ef4f8611c727f75c1ef969d8e128338784a5a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUzMjg3Mg==", "url": "https://github.com/getodk/collect/pull/4035#discussion_r475532872", "bodyText": "Done.", "author": "grzesiek2010", "createdAt": "2020-08-24T11:27:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ1NTk2NA=="}], "type": "inlineReview", "revised_code": {"commit": "5bc4d0f102c608bbc5bd1dcce95d4a69ebcffdb6", "chunk": "diff --git a/collect_app/src/main/java/org/odk/collect/android/forms/DatabaseMediaFileRepository.java b/collect_app/src/main/java/org/odk/collect/android/database/DatabaseMediaFileRepository.java\nsimilarity index 59%\nrename from collect_app/src/main/java/org/odk/collect/android/forms/DatabaseMediaFileRepository.java\nrename to collect_app/src/main/java/org/odk/collect/android/database/DatabaseMediaFileRepository.java\nindex a97591386..4ef762bff 100644\n--- a/collect_app/src/main/java/org/odk/collect/android/forms/DatabaseMediaFileRepository.java\n+++ b/collect_app/src/main/java/org/odk/collect/android/database/DatabaseMediaFileRepository.java\n\n@@ -12,10 +14,8 @@ public class DatabaseMediaFileRepository implements MediaFileRepository {\n     @Override\n     public List<File> getAll(String jrFormID, String formVersion) {\n         String formMediaPath = new FormsDao().getFormMediaPath(jrFormID, formVersion);\n-        File[] files = new File[0];\n-        if (formMediaPath != null) {\n-            files = new File(formMediaPath).listFiles();\n-        }\n-        return asList(files);\n+        return formMediaPath == null\n+                ? new ArrayList<>()\n+                : asList(new File(formMediaPath).listFiles());\n     }\n }\n"}}, {"oid": "c169bb048471983acaf54935446e8b9fdb197620", "url": "https://github.com/getodk/collect/commit/c169bb048471983acaf54935446e8b9fdb197620", "message": "Handle NPE in DatabaseMediaFileRepository#getAll()", "committedDate": "2020-08-26T09:16:45Z", "type": "commit"}, {"oid": "5bc4d0f102c608bbc5bd1dcce95d4a69ebcffdb6", "url": "https://github.com/getodk/collect/commit/5bc4d0f102c608bbc5bd1dcce95d4a69ebcffdb6", "message": "Code improvements", "committedDate": "2020-08-26T09:16:45Z", "type": "commit"}, {"oid": "99a2d842770bb6fc672a7c415277a04ed51f7063", "url": "https://github.com/getodk/collect/commit/99a2d842770bb6fc672a7c415277a04ed51f7063", "message": "Added tests", "committedDate": "2020-08-26T09:16:45Z", "type": "forcePushed"}, {"oid": "33f02c39263c32a4cd6673a125346bd257a9991a", "url": "https://github.com/getodk/collect/commit/33f02c39263c32a4cd6673a125346bd257a9991a", "message": "Added tests", "committedDate": "2020-08-26T10:28:22Z", "type": "forcePushed"}, {"oid": "eb35bd17a89d8a0e5d1774e48bef7e50d20377da", "url": "https://github.com/getodk/collect/commit/eb35bd17a89d8a0e5d1774e48bef7e50d20377da", "message": "Added tests", "committedDate": "2020-08-26T10:32:31Z", "type": "commit"}, {"oid": "eb35bd17a89d8a0e5d1774e48bef7e50d20377da", "url": "https://github.com/getodk/collect/commit/eb35bd17a89d8a0e5d1774e48bef7e50d20377da", "message": "Added tests", "committedDate": "2020-08-26T10:32:31Z", "type": "forcePushed"}]}