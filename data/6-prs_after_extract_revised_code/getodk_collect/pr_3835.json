{"pr_number": 3835, "pr_title": "Fixed scanning inverted QRCodes and refactored the way we scan codes", "pr_createdAt": "2020-05-14T19:17:58Z", "pr_url": "https://github.com/getodk/collect/pull/3835", "timeline": [{"oid": "bc89c8a0e63902d6426978b79d579f500dcf0e1e", "url": "https://github.com/getodk/collect/commit/bc89c8a0e63902d6426978b79d579f500dcf0e1e", "message": "Prepared QRScannerFragment to be used by BarcodeWidget as well", "committedDate": "2020-05-14T17:36:44Z", "type": "commit"}, {"oid": "2ba7062b11ca09517ef0782a363aa8b88cd75d2a", "url": "https://github.com/getodk/collect/commit/2ba7062b11ca09517ef0782a363aa8b88cd75d2a", "message": "Moved the dupicated code from ScannerWithFlashlightActivity to QRScannerFragment", "committedDate": "2020-05-14T17:47:42Z", "type": "commit"}, {"oid": "0d7f22f36ed4a277a64bfaad4547a4cbe4c92355", "url": "https://github.com/getodk/collect/commit/0d7f22f36ed4a277a64bfaad4547a4cbe4c92355", "message": "Use QRScannerFragment in ScannerWithFlashlightActivity", "committedDate": "2020-05-14T17:49:00Z", "type": "commit"}, {"oid": "afa6205fa91821e14e6dd8d1c163673fa2ad9cda", "url": "https://github.com/getodk/collect/commit/afa6205fa91821e14e6dd8d1c163673fa2ad9cda", "message": "Fix supported code formats", "committedDate": "2020-05-14T17:56:57Z", "type": "commit"}, {"oid": "7d238f07ba6c5b0fafd15b0e934ac529ce42afdb", "url": "https://github.com/getodk/collect/commit/7d238f07ba6c5b0fafd15b0e934ac529ce42afdb", "message": "Use our own translatable prompt", "committedDate": "2020-05-14T18:01:00Z", "type": "commit"}, {"oid": "f0f36f67f75970d575a6bb6dbab8fdce7e4b69ab", "url": "https://github.com/getodk/collect/commit/f0f36f67f75970d575a6bb6dbab8fdce7e4b69ab", "message": "Removed duplicated/redundant code from BarcodeWidget", "committedDate": "2020-05-14T18:03:39Z", "type": "commit"}, {"oid": "87e1fa90b9688d23fa1ebe40d516d2e9c7cf4791", "url": "https://github.com/getodk/collect/commit/87e1fa90b9688d23fa1ebe40d516d2e9c7cf4791", "message": "Fixed front camera", "committedDate": "2020-05-14T18:59:28Z", "type": "commit"}, {"oid": "3b9b3d4d00815afd2c16435d4e2d2479331f4b0b", "url": "https://github.com/getodk/collect/commit/3b9b3d4d00815afd2c16435d4e2d2479331f4b0b", "message": "Cleaned the code", "committedDate": "2020-05-14T19:10:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU1Mzk0Mw==", "url": "https://github.com/getodk/collect/pull/3835#discussion_r425553943", "bodyText": "I think we should make this a separate change for v1.28. Most translators won\u2019t have time to get to this in the next few days so the strings will show up in English where they were translated before.", "author": "lognaturel", "createdAt": "2020-05-15T04:02:20Z", "path": "collect_app/src/main/java/org/odk/collect/android/preferences/qr/QRScannerFragment.java", "diffHunk": "@@ -83,6 +83,7 @@ public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle sa\n \n         Intent intent = new IntentIntegrator(getActivity())\n                 .setDesiredBarcodeFormats(getSupportedCodeFormats())\n+                .setPrompt(getContext().getString(R.string.barcode_scanner_prompt))", "originalCommit": "7d238f07ba6c5b0fafd15b0e934ac529ce42afdb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTc5MTI1NA==", "url": "https://github.com/getodk/collect/pull/3835#discussion_r425791254", "bodyText": "We have over 20 translations for that string the default zxing message also is translatable but I noticed it contains less translations so maybe it's better to have this our own?.", "author": "grzesiek2010", "createdAt": "2020-05-15T13:12:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU1Mzk0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMwNDI5MQ==", "url": "https://github.com/getodk/collect/pull/3835#discussion_r426304291", "bodyText": "Oh, right, this string was already in use for the barcode widget. This change just also uses it in the settings QR code context. That makes a lot of sense, thanks.", "author": "lognaturel", "createdAt": "2020-05-17T20:58:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU1Mzk0Mw=="}], "type": "inlineReview", "revised_code": {"commit": "25f346b87ae6f59d56764b80125dc959b5bfd6d1", "chunk": "diff --git a/collect_app/src/main/java/org/odk/collect/android/preferences/qr/QRScannerFragment.java b/collect_app/src/main/java/org/odk/collect/android/preferences/qr/CodeScannerFragment.java\nsimilarity index 86%\nrename from collect_app/src/main/java/org/odk/collect/android/preferences/qr/QRScannerFragment.java\nrename to collect_app/src/main/java/org/odk/collect/android/preferences/qr/CodeScannerFragment.java\nindex 432b45dc6..b6d3a606c 100644\n--- a/collect_app/src/main/java/org/odk/collect/android/preferences/qr/QRScannerFragment.java\n+++ b/collect_app/src/main/java/org/odk/collect/android/preferences/qr/CodeScannerFragment.java\n\n@@ -74,29 +76,20 @@ public class QRScannerFragment extends Fragment implements DecoratedBarcodeView.\n                         ? getArguments().getSerializable(ACTION)\n                         : savedInstanceState.getSerializable(ACTION));\n \n-        View rootView = inflater.inflate(R.layout.fragment_scan, container, false);\n         beepManager = new BeepManager(getActivity());\n-        barcodeScannerView = rootView.findViewById(R.id.barcode_view);\n-        switchFlashlightButton = rootView.findViewById(R.id.switch_flashlight);\n \n+        View rootView = inflater.inflate(R.layout.fragment_scan, container, false);\n+        barcodeScannerView = rootView.findViewById(R.id.barcode_view);\n         barcodeScannerView.setTorchListener(this);\n \n-        Intent intent = new IntentIntegrator(getActivity())\n-                .setDesiredBarcodeFormats(getSupportedCodeFormats())\n-                .setPrompt(getContext().getString(R.string.barcode_scanner_prompt))\n-                .createScanIntent();\n-        intent.putExtra(Intents.Scan.SCAN_TYPE, Intents.Scan.MIXED_SCAN);\n-\n         capture = new CaptureManager(getActivity(), barcodeScannerView);\n-        capture.initializeFromIntent(intent, savedInstanceState);\n+        capture.initializeFromIntent(getIntent(), savedInstanceState);\n         capture.decode();\n \n-        switchFlashlightButton.setOnClickListener(new View.OnClickListener() {\n-            @Override\n-            public void onClick(View v) {\n-                switchFlashlight(v);\n-            }\n-        });\n+        if (frontCameraUsed()) {\n+            switchToFrontCamera();\n+        }\n+\n         new PermissionUtils().requestCameraPermission(getActivity(), new PermissionListener() {\n             @Override\n             public void granted() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU2MTA1OA==", "url": "https://github.com/getodk/collect/pull/3835#discussion_r425561058", "bodyText": "Passing in an Action to configure the fragment makes it hard to track what the different behavior is between the two types of scanners. Did you consider an abstract BarcodeScannerFragment with SettingsQRCodeScannerFragment and BarcodeWidgetScannerFragment subtypes or something like that? You'd have abstract handleBarcodeResult and getSupportedCodeFormats methods that are the only things implemented by those concrete classes, making the different behavior really clear.", "author": "lognaturel", "createdAt": "2020-05-15T04:35:20Z", "path": "collect_app/src/main/java/org/odk/collect/android/preferences/qr/QRScannerFragment.java", "diffHunk": "@@ -24,43 +26,70 @@\n \n import com.google.zxing.ResultPoint;\n import com.google.zxing.client.android.BeepManager;\n+import com.google.zxing.client.android.Intents;\n+import com.google.zxing.integration.android.IntentIntegrator;\n import com.journeyapps.barcodescanner.BarcodeCallback;\n import com.journeyapps.barcodescanner.BarcodeResult;\n+import com.journeyapps.barcodescanner.CaptureManager;\n import com.journeyapps.barcodescanner.DecoratedBarcodeView;\n+import com.journeyapps.barcodescanner.camera.CameraSettings;\n \n import org.odk.collect.android.R;\n import org.odk.collect.android.preferences.utilities.SettingsUtils;\n+import org.odk.collect.android.utilities.CameraUtils;\n import org.odk.collect.android.utilities.CompressionUtils;\n import org.odk.collect.android.utilities.ToastUtils;\n \n import org.odk.collect.android.listeners.PermissionListener;\n import org.odk.collect.android.utilities.PermissionUtils;\n+import org.odk.collect.android.utilities.WidgetAppearanceUtils;\n \n import java.io.IOException;\n+import java.util.Collection;\n+import java.util.Collections;\n import java.util.List;\n import java.util.zip.DataFormatException;\n \n public class QRScannerFragment extends Fragment implements DecoratedBarcodeView.TorchListener {\n \n-    DecoratedBarcodeView barcodeScannerView;\n+    private static final String ACTION = \"action\";\n+\n+    public enum Action { BARCODE_WIDGET, APPLY_SETTINGS };\n+\n+    private CaptureManager capture;\n+    private DecoratedBarcodeView barcodeScannerView;\n     private Button switchFlashlightButton;\n     private BeepManager beepManager;\n+    private Action action;\n+\n+    public static QRScannerFragment newInstance(Action action) {", "originalCommit": "3b9b3d4d00815afd2c16435d4e2d2479331f4b0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTg0MTU4Nw==", "url": "https://github.com/getodk/collect/pull/3835#discussion_r425841587", "bodyText": "You are right. I Implemented it in that way. Thanks.", "author": "grzesiek2010", "createdAt": "2020-05-15T14:30:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU2MTA1OA=="}], "type": "inlineReview", "revised_code": {"commit": "25f346b87ae6f59d56764b80125dc959b5bfd6d1", "chunk": "diff --git a/collect_app/src/main/java/org/odk/collect/android/preferences/qr/QRScannerFragment.java b/collect_app/src/main/java/org/odk/collect/android/preferences/qr/CodeScannerFragment.java\nsimilarity index 97%\nrename from collect_app/src/main/java/org/odk/collect/android/preferences/qr/QRScannerFragment.java\nrename to collect_app/src/main/java/org/odk/collect/android/preferences/qr/CodeScannerFragment.java\nindex a1589b026..b6d3a606c 100644\n--- a/collect_app/src/main/java/org/odk/collect/android/preferences/qr/QRScannerFragment.java\n+++ b/collect_app/src/main/java/org/odk/collect/android/preferences/qr/CodeScannerFragment.java\n\n@@ -50,7 +50,7 @@ import java.util.Collections;\n import java.util.List;\n import java.util.zip.DataFormatException;\n \n-public class QRScannerFragment extends Fragment implements DecoratedBarcodeView.TorchListener {\n+public class CodeScannerFragment extends Fragment implements DecoratedBarcodeView.TorchListener {\n \n     private static final String ACTION = \"action\";\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU2MTIxNg==", "url": "https://github.com/getodk/collect/pull/3835#discussion_r425561216", "bodyText": "This should be in a different package, now. It's also no longer just a QR code scanner.", "author": "lognaturel", "createdAt": "2020-05-15T04:36:03Z", "path": "collect_app/src/main/java/org/odk/collect/android/preferences/qr/QRScannerFragment.java", "diffHunk": "@@ -24,43 +26,70 @@\n \n import com.google.zxing.ResultPoint;\n import com.google.zxing.client.android.BeepManager;\n+import com.google.zxing.client.android.Intents;\n+import com.google.zxing.integration.android.IntentIntegrator;\n import com.journeyapps.barcodescanner.BarcodeCallback;\n import com.journeyapps.barcodescanner.BarcodeResult;\n+import com.journeyapps.barcodescanner.CaptureManager;\n import com.journeyapps.barcodescanner.DecoratedBarcodeView;\n+import com.journeyapps.barcodescanner.camera.CameraSettings;\n \n import org.odk.collect.android.R;\n import org.odk.collect.android.preferences.utilities.SettingsUtils;\n+import org.odk.collect.android.utilities.CameraUtils;\n import org.odk.collect.android.utilities.CompressionUtils;\n import org.odk.collect.android.utilities.ToastUtils;\n \n import org.odk.collect.android.listeners.PermissionListener;\n import org.odk.collect.android.utilities.PermissionUtils;\n+import org.odk.collect.android.utilities.WidgetAppearanceUtils;\n \n import java.io.IOException;\n+import java.util.Collection;\n+import java.util.Collections;\n import java.util.List;\n import java.util.zip.DataFormatException;\n \n public class QRScannerFragment extends Fragment implements DecoratedBarcodeView.TorchListener {", "originalCommit": "3b9b3d4d00815afd2c16435d4e2d2479331f4b0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTc3MjY4Mg==", "url": "https://github.com/getodk/collect/pull/3835#discussion_r425772682", "bodyText": "Right, fixed.", "author": "grzesiek2010", "createdAt": "2020-05-15T12:39:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU2MTIxNg=="}], "type": "inlineReview", "revised_code": {"commit": "25f346b87ae6f59d56764b80125dc959b5bfd6d1", "chunk": "diff --git a/collect_app/src/main/java/org/odk/collect/android/preferences/qr/QRScannerFragment.java b/collect_app/src/main/java/org/odk/collect/android/preferences/qr/CodeScannerFragment.java\nsimilarity index 97%\nrename from collect_app/src/main/java/org/odk/collect/android/preferences/qr/QRScannerFragment.java\nrename to collect_app/src/main/java/org/odk/collect/android/preferences/qr/CodeScannerFragment.java\nindex a1589b026..b6d3a606c 100644\n--- a/collect_app/src/main/java/org/odk/collect/android/preferences/qr/QRScannerFragment.java\n+++ b/collect_app/src/main/java/org/odk/collect/android/preferences/qr/CodeScannerFragment.java\n\n@@ -50,7 +50,7 @@ import java.util.Collections;\n import java.util.List;\n import java.util.zip.DataFormatException;\n \n-public class QRScannerFragment extends Fragment implements DecoratedBarcodeView.TorchListener {\n+public class CodeScannerFragment extends Fragment implements DecoratedBarcodeView.TorchListener {\n \n     private static final String ACTION = \"action\";\n \n"}}, {"oid": "25f346b87ae6f59d56764b80125dc959b5bfd6d1", "url": "https://github.com/getodk/collect/commit/25f346b87ae6f59d56764b80125dc959b5bfd6d1", "message": "Naming improvement", "committedDate": "2020-05-15T12:36:57Z", "type": "commit"}, {"oid": "f4221002e53d90076e7540957f1380e0f3c0d828", "url": "https://github.com/getodk/collect/commit/f4221002e53d90076e7540957f1380e0f3c0d828", "message": "Moved CodeScannerFragment to fragments package", "committedDate": "2020-05-15T12:37:44Z", "type": "commit"}, {"oid": "9982e40e785f727b8ee36db57b15e6ea4aeb629e", "url": "https://github.com/getodk/collect/commit/9982e40e785f727b8ee36db57b15e6ea4aeb629e", "message": "Added BaseCodeScannerFragment and fragments that extend it to improve managing scanning", "committedDate": "2020-05-15T14:25:17Z", "type": "commit"}, {"oid": "9982e40e785f727b8ee36db57b15e6ea4aeb629e", "url": "https://github.com/getodk/collect/commit/9982e40e785f727b8ee36db57b15e6ea4aeb629e", "message": "Added BaseCodeScannerFragment and fragments that extend it to improve managing scanning", "committedDate": "2020-05-15T14:25:17Z", "type": "forcePushed"}, {"oid": "e2d82ffea9471fab7a3cbb03b9cbaae8c7336ee5", "url": "https://github.com/getodk/collect/commit/e2d82ffea9471fab7a3cbb03b9cbaae8c7336ee5", "message": "Factored out BARCODE_RESULT_KEY", "committedDate": "2020-05-18T10:51:13Z", "type": "commit"}]}