{"pr_number": 4020, "pr_title": "Match exactly improvements", "pr_createdAt": "2020-08-10T14:47:09Z", "pr_url": "https://github.com/getodk/collect/pull/4020", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk1NzU0MA==", "url": "https://github.com/getodk/collect/pull/4020#discussion_r467957540", "bodyText": "It ended up being a lot simpler to move a bunch of the testing of these preferences into the fragment tests.", "author": "seadowg", "createdAt": "2020-08-10T14:49:20Z", "path": "collect_app/src/androidTest/java/org/odk/collect/android/feature/settings/FormManagementSettingsTest.java", "diffHunk": "@@ -116,22 +116,6 @@ public void whenPreviouslyDownloadedOnlyEnabled_checkingAutoDownload_downloadsUp\n                 .assertAndDismissNotification(\"ODK Collect\", \"ODK auto-download results\", \"Success\");\n     }\n \n-    @Test\n-    public void whenGoogleDriveUsingAsServer_disablesPrefsAndOnlyAllowsManualUpdates() {", "originalCommit": "8b4b6099ae62b222190a42a51a9e597cb1f521e4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e8abbe6261cf2a0dd5620b83a7f6566ced2642eb", "chunk": "diff --git a/collect_app/src/androidTest/java/org/odk/collect/android/feature/settings/FormManagementSettingsTest.java b/collect_app/src/androidTest/java/org/odk/collect/android/feature/settings/FormManagementSettingsTest.java\nindex 5b573270b..e02fd6962 100644\n--- a/collect_app/src/androidTest/java/org/odk/collect/android/feature/settings/FormManagementSettingsTest.java\n+++ b/collect_app/src/androidTest/java/org/odk/collect/android/feature/settings/FormManagementSettingsTest.java\n\n@@ -117,23 +116,18 @@ public class FormManagementSettingsTest {\n     }\n \n     @Test\n-    public void whenFormUpdatesPrefsDisabledInAdminSettings_disablesPrefs() {\n-        new MainMenuPage(rule)\n-                .clickOnMenu()\n-                .clickAdminSettings()\n-                .openUserSettings()\n-                .uncheckUserSettings(R.string.form_update_mode_title)\n-                .uncheckUserSettings(R.string.periodic_form_updates_check_title)\n-                .uncheckUserSettings(R.string.automatic_download)\n-                .uncheckUserSettings(R.string.hide_old_form_versions_setting_title)\n-                .pressBack(new AdminSettingsPage(rule))\n-                .pressBack(new MainMenuPage(rule))\n+    public void whenGoogleDriveUsingAsServer_disablesPrefsAndOnlyAllowsManualUpdates() {\n+        new MainMenuPage(rule).assertOnPage()\n+                .enablePreviouslyDownloadedOnlyUpdates() // Enabled a different mode before setting up Google\n+                .setGoogleDriveAccount(\"steph@curry.basket\")\n                 .clickOnMenu()\n                 .clickGeneralSettings()\n                 .clickFormManagement()\n-                .assertTextDoesNotExist(R.string.form_update_mode_title)\n-                .assertTextDoesNotExist(R.string.periodic_form_updates_check_title)\n-                .assertTextDoesNotExist(R.string.automatic_download)\n-                .assertTextDoesNotExist(R.string.hide_old_form_versions_setting_title);\n+                .assertDisabled(R.string.form_update_mode_title)\n+                .assertDisabled(R.string.form_update_frequency_title)\n+                .assertDisabled(R.string.automatic_download)\n+                .assertText(R.string.manually);\n+\n+        assertThat(testDependencies.scheduler.getDeferredTasks().size(), is(0));\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk1OTY5OA==", "url": "https://github.com/getodk/collect/pull/4020#discussion_r467959698", "bodyText": "To me it feels a lot simpler for us to simply display the disabled prefs with the appropriate values rather than change the underlying value. This has two advantages:\n\nThe code is more declarative - we don't have to actually change values of other prefs when a pref changes (like changing the value of form update mode when the protocol changes).\nIf the user switches between different options the disabled prefs will revert to the values they had them at before.", "author": "seadowg", "createdAt": "2020-08-10T14:52:09Z", "path": "collect_app/src/main/java/org/odk/collect/android/preferences/FormManagementPreferences.java", "diffHunk": "@@ -91,44 +92,36 @@ public void onSharedPreferenceChanged(SharedPreferences sharedPreferences, Strin\n         if (key.equals(KEY_FORM_UPDATE_MODE) || key.equals(KEY_PERIODIC_FORM_UPDATES_CHECK)) {\n             String newValue = sharedPreferences.getString(KEY_FORM_UPDATE_MODE, null);\n             updateDisabledPrefs(newValue, sharedPreferences.getString(KEY_PROTOCOL, null));\n-\n-            Preference preference = findPreference(KEY_FORM_UPDATE_MODE);\n-            preference.setSummary(((ListPreference) preference).getEntry());\n         }\n     }\n \n     private void setupFormUpdateMode() {\n         SharedPreferences sharedPreferences = preferencesProvider.getGeneralSharedPreferences();\n         updateDisabledPrefs(sharedPreferences.getString(KEY_FORM_UPDATE_MODE, null), sharedPreferences.getString(KEY_PROTOCOL, null));\n-\n-        Preference formUpdateMode = findPreference(KEY_FORM_UPDATE_MODE);\n-        formUpdateMode.setSummary(((ListPreference) formUpdateMode).getEntry());\n     }\n \n     private void updateDisabledPrefs(String formUpdateMode, String protocol) {\n         Preference updateFrequency = findPreference(KEY_PERIODIC_FORM_UPDATES_CHECK);\n         CheckBoxPreference automaticDownload = findPreference(KEY_AUTOMATIC_UPDATE);\n \n         if (Protocol.parse(getActivity(), protocol) == Protocol.GOOGLE) {\n-            findPreference(KEY_FORM_UPDATE_MODE).setEnabled(false);\n-            automaticDownload.setEnabled(false);\n+            displayDisabled(findPreference(KEY_FORM_UPDATE_MODE), getString(R.string.manually));", "originalCommit": "8b4b6099ae62b222190a42a51a9e597cb1f521e4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bbdbeddac47b1885c973139848714368a3d17008", "chunk": "diff --git a/collect_app/src/main/java/org/odk/collect/android/preferences/FormManagementPreferences.java b/collect_app/src/main/java/org/odk/collect/android/preferences/FormManagementPreferences.java\nindex 38f6a7b45..557a1ca6c 100644\n--- a/collect_app/src/main/java/org/odk/collect/android/preferences/FormManagementPreferences.java\n+++ b/collect_app/src/main/java/org/odk/collect/android/preferences/FormManagementPreferences.java\n\n@@ -92,12 +80,18 @@ public class FormManagementPreferences extends BasePreferenceFragment {\n         if (key.equals(KEY_FORM_UPDATE_MODE) || key.equals(KEY_PERIODIC_FORM_UPDATES_CHECK)) {\n             String newValue = sharedPreferences.getString(KEY_FORM_UPDATE_MODE, null);\n             updateDisabledPrefs(newValue, sharedPreferences.getString(KEY_PROTOCOL, null));\n+\n+            Preference preference = findPreference(KEY_FORM_UPDATE_MODE);\n+            preference.setSummary(((ListPreference) preference).getEntry());\n         }\n     }\n \n     private void setupFormUpdateMode() {\n         SharedPreferences sharedPreferences = preferencesProvider.getGeneralSharedPreferences();\n         updateDisabledPrefs(sharedPreferences.getString(KEY_FORM_UPDATE_MODE, null), sharedPreferences.getString(KEY_PROTOCOL, null));\n+\n+        Preference formUpdateMode = findPreference(KEY_FORM_UPDATE_MODE);\n+        formUpdateMode.setSummary(((ListPreference) formUpdateMode).getEntry());\n     }\n \n     private void updateDisabledPrefs(String formUpdateMode, String protocol) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk2MDIxMw==", "url": "https://github.com/getodk/collect/pull/4020#discussion_r467960213", "bodyText": "This is clunky but I couldn't find any other way to just display a value in a CheckBoxPreference. You'll see the String version is much simpler.", "author": "seadowg", "createdAt": "2020-08-10T14:52:48Z", "path": "collect_app/src/main/java/org/odk/collect/android/preferences/utilities/PreferencesUtils.java", "diffHunk": "@@ -0,0 +1,23 @@\n+package org.odk.collect.android.preferences.utilities;\n+\n+import androidx.preference.CheckBoxPreference;\n+import androidx.preference.Preference;\n+\n+public class PreferencesUtils {\n+\n+    private PreferencesUtils() {\n+\n+    }\n+\n+    public static void displayDisabled(CheckBoxPreference preference, boolean displayValue) {\n+        preference.setPersistent(false);", "originalCommit": "8b4b6099ae62b222190a42a51a9e597cb1f521e4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bbdbeddac47b1885c973139848714368a3d17008", "chunk": "diff --git a/collect_app/src/main/java/org/odk/collect/android/preferences/utilities/PreferencesUtils.java b/collect_app/src/main/java/org/odk/collect/android/preferences/utilities/PreferencesUtils.java\ndeleted file mode 100644\nindex fabe0f0d6..000000000\n--- a/collect_app/src/main/java/org/odk/collect/android/preferences/utilities/PreferencesUtils.java\n+++ /dev/null\n\n@@ -1,23 +0,0 @@\n-package org.odk.collect.android.preferences.utilities;\n-\n-import androidx.preference.CheckBoxPreference;\n-import androidx.preference.Preference;\n-\n-public class PreferencesUtils {\n-\n-    private PreferencesUtils() {\n-\n-    }\n-\n-    public static void displayDisabled(CheckBoxPreference preference, boolean displayValue) {\n-        preference.setPersistent(false);\n-        preference.setEnabled(false);\n-        preference.setChecked(displayValue);\n-        preference.setPersistent(true);\n-    }\n-\n-    public static void displayDisabled(Preference preference, String displayValue) {\n-        preference.setEnabled(false);\n-        preference.setSummaryProvider(pref -> displayValue);\n-    }\n-}\n"}}, {"oid": "4372dbcf4d310f7ba731e73bca87972ca5afb491", "url": "https://github.com/getodk/collect/commit/4372dbcf4d310f7ba731e73bca87972ca5afb491", "message": "Stop sync when device is offline", "committedDate": "2020-08-24T10:07:03Z", "type": "forcePushed"}, {"oid": "2aca3fb85af0543b7db82f5490dc73fb7fb959ae", "url": "https://github.com/getodk/collect/commit/2aca3fb85af0543b7db82f5490dc73fb7fb959ae", "message": "Stop sync when device is offline", "committedDate": "2020-08-24T12:16:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTYzNzg1Ng==", "url": "https://github.com/getodk/collect/pull/4020#discussion_r475637856", "bodyText": "I was incredibly tempted to add a Settings interface for abstracting away this kind of logic (and shared prefs themselves). This would be in a weird place however as in most places it's pretty simple to just grab the actual pref value to work out what \"state\" we're in. I think if these utils start to grow we can revisit the idea.", "author": "seadowg", "createdAt": "2020-08-24T14:05:37Z", "path": "collect_app/src/main/java/org/odk/collect/android/configure/SettingsUtils.java", "diffHunk": "@@ -0,0 +1,29 @@\n+package org.odk.collect.android.configure;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+\n+import androidx.annotation.NonNull;\n+\n+import org.odk.collect.android.formmanagement.FormUpdateMode;\n+import org.odk.collect.android.preferences.GeneralKeys;\n+import org.odk.collect.android.preferences.Protocol;\n+\n+public class SettingsUtils {\n+\n+    private SettingsUtils() {\n+\n+    }\n+\n+    @NonNull\n+    public static FormUpdateMode getFormUpdateMode(Context context, SharedPreferences generalSharedPreferences) {", "originalCommit": "52f818437284f9383388cc3ce94249d4aaaacf76", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bbdbeddac47b1885c973139848714368a3d17008", "chunk": "diff --git a/collect_app/src/main/java/org/odk/collect/android/configure/SettingsUtils.java b/collect_app/src/main/java/org/odk/collect/android/configure/SettingsUtils.java\ndeleted file mode 100644\nindex a50d99299..000000000\n--- a/collect_app/src/main/java/org/odk/collect/android/configure/SettingsUtils.java\n+++ /dev/null\n\n@@ -1,29 +0,0 @@\n-package org.odk.collect.android.configure;\n-\n-import android.content.Context;\n-import android.content.SharedPreferences;\n-\n-import androidx.annotation.NonNull;\n-\n-import org.odk.collect.android.formmanagement.FormUpdateMode;\n-import org.odk.collect.android.preferences.GeneralKeys;\n-import org.odk.collect.android.preferences.Protocol;\n-\n-public class SettingsUtils {\n-\n-    private SettingsUtils() {\n-\n-    }\n-\n-    @NonNull\n-    public static FormUpdateMode getFormUpdateMode(Context context, SharedPreferences generalSharedPreferences) {\n-        String protocol = generalSharedPreferences.getString(GeneralKeys.KEY_PROTOCOL, null);\n-\n-        if (Protocol.parse(context, protocol) == Protocol.GOOGLE) {\n-            return FormUpdateMode.MANUAL;\n-        } else {\n-            String mode = generalSharedPreferences.getString(GeneralKeys.KEY_FORM_UPDATE_MODE, null);\n-            return FormUpdateMode.parse(context, mode);\n-        }\n-    }\n-}\n"}}, {"oid": "e8abbe6261cf2a0dd5620b83a7f6566ced2642eb", "url": "https://github.com/getodk/collect/commit/e8abbe6261cf2a0dd5620b83a7f6566ced2642eb", "message": "Make sure manual mode is used in the app when Google Drive selected", "committedDate": "2020-08-24T15:31:10Z", "type": "forcePushed"}, {"oid": "bbdbeddac47b1885c973139848714368a3d17008", "url": "https://github.com/getodk/collect/commit/bbdbeddac47b1885c973139848714368a3d17008", "message": "Fix admin setting indentation", "committedDate": "2020-08-27T16:10:45Z", "type": "commit"}, {"oid": "5acb78eb31a8eaa85d08ba33116d957b7763b8b0", "url": "https://github.com/getodk/collect/commit/5acb78eb31a8eaa85d08ba33116d957b7763b8b0", "message": "Use helper to only display prefs as disabled with value rather than changing them", "committedDate": "2020-08-27T16:10:45Z", "type": "commit"}, {"oid": "201a303d092d42c89b05567b76981e608db88466", "url": "https://github.com/getodk/collect/commit/201a303d092d42c89b05567b76981e608db88466", "message": "Use simpler summary provider for form update mode", "committedDate": "2020-08-27T16:10:45Z", "type": "commit"}, {"oid": "4a142c619c20b6c47729f363fc8ba704882a4456", "url": "https://github.com/getodk/collect/commit/4a142c619c20b6c47729f363fc8ba704882a4456", "message": "Disable Get Blank Form when Match Exactly is enabled", "committedDate": "2020-08-27T16:14:27Z", "type": "commit"}, {"oid": "640ca84dc88cb0cb005267784912eda658b44b0c", "url": "https://github.com/getodk/collect/commit/640ca84dc88cb0cb005267784912eda658b44b0c", "message": "Make sure setting google drive as server updates form management settings", "committedDate": "2020-08-27T16:14:29Z", "type": "commit"}, {"oid": "71f437e6dead87f3c93035e028da4839c545c4f4", "url": "https://github.com/getodk/collect/commit/71f437e6dead87f3c93035e028da4839c545c4f4", "message": "Stop sync when device is offline", "committedDate": "2020-08-27T16:14:29Z", "type": "commit"}, {"oid": "d371cd50171131dd1c26e3f366df87eb285c69b0", "url": "https://github.com/getodk/collect/commit/d371cd50171131dd1c26e3f366df87eb285c69b0", "message": "Make sure manual mode is used in the app when Google Drive selected", "committedDate": "2020-08-27T16:14:29Z", "type": "commit"}, {"oid": "db44ceda19765ca4719793aa1b975b9fa8e357e4", "url": "https://github.com/getodk/collect/commit/db44ceda19765ca4719793aa1b975b9fa8e357e4", "message": "Use correct match exactly logic in admin settings", "committedDate": "2020-08-27T16:14:29Z", "type": "commit"}, {"oid": "db44ceda19765ca4719793aa1b975b9fa8e357e4", "url": "https://github.com/getodk/collect/commit/db44ceda19765ca4719793aa1b975b9fa8e357e4", "message": "Use correct match exactly logic in admin settings", "committedDate": "2020-08-27T16:14:29Z", "type": "forcePushed"}]}