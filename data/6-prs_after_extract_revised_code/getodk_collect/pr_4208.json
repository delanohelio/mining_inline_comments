{"pr_number": 4208, "pr_title": "Try using the package manager  to get a launch intent for external apps, support string uris for binary external widgets", "pr_createdAt": "2020-11-05T17:28:25Z", "pr_url": "https://github.com/getodk/collect/pull/4208", "timeline": [{"oid": "0337d67b98f0cddee876ee7c7dc234edd09f97e7", "url": "https://github.com/getodk/collect/commit/0337d67b98f0cddee876ee7c7dc234edd09f97e7", "message": "Add support for launching apps without DEFAULT category", "committedDate": "2020-11-05T17:11:50Z", "type": "commit"}, {"oid": "26b842e1c8e03ee27f0237fad77455dccfd66e29", "url": "https://github.com/getodk/collect/commit/26b842e1c8e03ee27f0237fad77455dccfd66e29", "message": "Allow string or Uri for binary extra", "committedDate": "2020-11-05T17:14:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODIzMjcwMg==", "url": "https://github.com/getodk/collect/pull/4208#discussion_r518232702", "bodyText": "I can't remember the details of why this is needed but can try to pull it up again if needed. There are flags set by default when doing getLaunchIntentForPackage and they suppress something, maybe returning a result.", "author": "lognaturel", "createdAt": "2020-11-05T17:35:28Z", "path": "collect_app/src/main/java/org/odk/collect/android/formentry/ODKView.java", "diffHunk": "@@ -405,48 +405,49 @@ private void addIntentLaunchButton(Context context, FormEntryPrompt[] questionPr\n         launchIntentButton.setText(buttonText);\n         launchIntentButton.setTextSize(TypedValue.COMPLEX_UNIT_DIP, QuestionFontSizeUtils.getQuestionFontSize() + 2);\n         launchIntentButton.setVisibility(VISIBLE);\n-        launchIntentButton.setOnClickListener(new OnClickListener() {\n-            @Override\n-            public void onClick(View v) {\n-                String intentName = ExternalAppsUtils.extractIntentName(intentString);\n-                Map<String, String> parameters = ExternalAppsUtils.extractParameters(\n-                        intentString);\n-\n-                Intent i = new Intent(intentName);\n-                try {\n-                    ExternalAppsUtils.populateParameters(i, parameters,\n-                            c.getIndex().getReference());\n-\n-                    for (FormEntryPrompt p : questionPrompts) {\n-                        IFormElement formElement = p.getFormElement();\n-                        if (formElement instanceof QuestionDef) {\n-                            TreeReference reference =\n-                                    (TreeReference) formElement.getBind().getReference();\n-                            IAnswerData answerValue = p.getAnswerValue();\n-                            Object value =\n-                                    answerValue == null ? null : answerValue.getValue();\n-                            switch (p.getDataType()) {\n-                                case Constants.DATATYPE_TEXT:\n-                                case Constants.DATATYPE_INTEGER:\n-                                case Constants.DATATYPE_DECIMAL:\n-                                case Constants.DATATYPE_BINARY:\n-                                    i.putExtra(reference.getNameLast(),\n-                                            (Serializable) value);\n-                                    break;\n-                            }\n+        launchIntentButton.setOnClickListener(view -> {\n+            String intentName = ExternalAppsUtils.extractIntentName(intentString);\n+            Map<String, String> parameters = ExternalAppsUtils.extractParameters(intentString);\n+\n+            Intent i = new Intent(intentName);\n+            if (i.resolveActivity(Collect.getInstance().getPackageManager()) == null) {\n+                i = Collect.getInstance().getPackageManager().getLaunchIntentForPackage(intentName);\n+                i.setFlags(0);", "originalCommit": "26b842e1c8e03ee27f0237fad77455dccfd66e29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY3MTQzMg==", "url": "https://github.com/getodk/collect/pull/4208#discussion_r519671432", "bodyText": "I tested the fix without the flag (not here but using external widgets) and it seems to work so would be good if you could double check it.", "author": "grzesiek2010", "createdAt": "2020-11-09T09:39:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODIzMjcwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAxNjYwOQ==", "url": "https://github.com/getodk/collect/pull/4208#discussion_r520016609", "bodyText": "Now I remember that at some point I got into a state where the OpenRDT app was immediately returning its result rather than first going through its UI flow and then returning. That led me to this Stackoverflow post. The OpenRDT examples I was sent (not public, unfortunately) do use setFlags(0).\n\ngetLaunchIntentForPackage(\"com.your.package.here\") would create an intent with Intent.FLAG_ACTIVITY_NEW_TASK added by default, so call: in.setFlags(0);\n\nAlways creating the target activity and avoiding the FLAG_ACTIVITY_NEW_TASK flag seems like the way to go to me. There are differences in Android versions with how the other launch modes work and their behavior will also depend on whether or not an activity is already in memory.", "author": "lognaturel", "createdAt": "2020-11-09T18:11:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODIzMjcwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAyMjc1OQ==", "url": "https://github.com/getodk/collect/pull/4208#discussion_r520022759", "bodyText": "Is it just me or are the docs around this particularly bad?", "author": "lognaturel", "createdAt": "2020-11-09T18:21:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODIzMjcwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA1NzQ1MA==", "url": "https://github.com/getodk/collect/pull/4208#discussion_r520057450", "bodyText": "Ok this is confusing but makes more sense now thanks!", "author": "grzesiek2010", "createdAt": "2020-11-09T19:13:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODIzMjcwMg=="}], "type": "inlineReview", "revised_code": {"commit": "d56020ba830f3198bfa70c8b443ad144af919594", "chunk": "diff --git a/collect_app/src/main/java/org/odk/collect/android/formentry/ODKView.java b/collect_app/src/main/java/org/odk/collect/android/formentry/ODKView.java\nindex 2b79923fe..1c99793d1 100644\n--- a/collect_app/src/main/java/org/odk/collect/android/formentry/ODKView.java\n+++ b/collect_app/src/main/java/org/odk/collect/android/formentry/ODKView.java\n\n@@ -411,8 +411,13 @@ public class ODKView extends FrameLayout implements OnLongClickListener, WidgetV\n \n             Intent i = new Intent(intentName);\n             if (i.resolveActivity(Collect.getInstance().getPackageManager()) == null) {\n-                i = Collect.getInstance().getPackageManager().getLaunchIntentForPackage(intentName);\n-                i.setFlags(0);\n+                Intent launchIntent = Collect.getInstance().getPackageManager().getLaunchIntentForPackage(intentName);\n+\n+                if (launchIntent != null) {\n+                    // Make sure FLAG_ACTIVITY_NEW_TASK is not set because it doesn't work with startActivityForResult\n+                    launchIntent.setFlags(0);\n+                    i = launchIntent;\n+                }\n             }\n \n             try {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY3MTg3NQ==", "url": "https://github.com/getodk/collect/pull/4208#discussion_r519671875", "bodyText": "getLaunchIntentForPackage() might return null so wee need some null check now I think.", "author": "grzesiek2010", "createdAt": "2020-11-09T09:40:20Z", "path": "collect_app/src/main/java/org/odk/collect/android/formentry/ODKView.java", "diffHunk": "@@ -405,48 +405,49 @@ private void addIntentLaunchButton(Context context, FormEntryPrompt[] questionPr\n         launchIntentButton.setText(buttonText);\n         launchIntentButton.setTextSize(TypedValue.COMPLEX_UNIT_DIP, QuestionFontSizeUtils.getQuestionFontSize() + 2);\n         launchIntentButton.setVisibility(VISIBLE);\n-        launchIntentButton.setOnClickListener(new OnClickListener() {\n-            @Override\n-            public void onClick(View v) {\n-                String intentName = ExternalAppsUtils.extractIntentName(intentString);\n-                Map<String, String> parameters = ExternalAppsUtils.extractParameters(\n-                        intentString);\n-\n-                Intent i = new Intent(intentName);\n-                try {\n-                    ExternalAppsUtils.populateParameters(i, parameters,\n-                            c.getIndex().getReference());\n-\n-                    for (FormEntryPrompt p : questionPrompts) {\n-                        IFormElement formElement = p.getFormElement();\n-                        if (formElement instanceof QuestionDef) {\n-                            TreeReference reference =\n-                                    (TreeReference) formElement.getBind().getReference();\n-                            IAnswerData answerValue = p.getAnswerValue();\n-                            Object value =\n-                                    answerValue == null ? null : answerValue.getValue();\n-                            switch (p.getDataType()) {\n-                                case Constants.DATATYPE_TEXT:\n-                                case Constants.DATATYPE_INTEGER:\n-                                case Constants.DATATYPE_DECIMAL:\n-                                case Constants.DATATYPE_BINARY:\n-                                    i.putExtra(reference.getNameLast(),\n-                                            (Serializable) value);\n-                                    break;\n-                            }\n+        launchIntentButton.setOnClickListener(view -> {\n+            String intentName = ExternalAppsUtils.extractIntentName(intentString);\n+            Map<String, String> parameters = ExternalAppsUtils.extractParameters(intentString);\n+\n+            Intent i = new Intent(intentName);\n+            if (i.resolveActivity(Collect.getInstance().getPackageManager()) == null) {\n+                i = Collect.getInstance().getPackageManager().getLaunchIntentForPackage(intentName);", "originalCommit": "26b842e1c8e03ee27f0237fad77455dccfd66e29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk3ODM4MA==", "url": "https://github.com/getodk/collect/pull/4208#discussion_r519978380", "bodyText": "YES, thank you.", "author": "lognaturel", "createdAt": "2020-11-09T17:11:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY3MTg3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "d56020ba830f3198bfa70c8b443ad144af919594", "chunk": "diff --git a/collect_app/src/main/java/org/odk/collect/android/formentry/ODKView.java b/collect_app/src/main/java/org/odk/collect/android/formentry/ODKView.java\nindex 2b79923fe..1c99793d1 100644\n--- a/collect_app/src/main/java/org/odk/collect/android/formentry/ODKView.java\n+++ b/collect_app/src/main/java/org/odk/collect/android/formentry/ODKView.java\n\n@@ -411,8 +411,13 @@ public class ODKView extends FrameLayout implements OnLongClickListener, WidgetV\n \n             Intent i = new Intent(intentName);\n             if (i.resolveActivity(Collect.getInstance().getPackageManager()) == null) {\n-                i = Collect.getInstance().getPackageManager().getLaunchIntentForPackage(intentName);\n-                i.setFlags(0);\n+                Intent launchIntent = Collect.getInstance().getPackageManager().getLaunchIntentForPackage(intentName);\n+\n+                if (launchIntent != null) {\n+                    // Make sure FLAG_ACTIVITY_NEW_TASK is not set because it doesn't work with startActivityForResult\n+                    launchIntent.setFlags(0);\n+                    i = launchIntent;\n+                }\n             }\n \n             try {\n"}}, {"oid": "d56020ba830f3198bfa70c8b443ad144af919594", "url": "https://github.com/getodk/collect/commit/d56020ba830f3198bfa70c8b443ad144af919594", "message": "Handle null launch intent", "committedDate": "2020-11-09T18:25:15Z", "type": "commit"}]}