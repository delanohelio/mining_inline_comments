{"pr_number": 1502, "pr_title": "Support Eureka data source", "pr_createdAt": "2020-05-23T13:33:28Z", "pr_url": "https://github.com/alibaba/Sentinel/pull/1502", "timeline": [{"oid": "5a7ab2eb95fd74f93d99145489954dda4b3c51df", "url": "https://github.com/alibaba/Sentinel/commit/5a7ab2eb95fd74f93d99145489954dda4b3c51df", "message": "Support Eureka data source", "committedDate": "2020-05-23T13:26:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTcyMDgzMw==", "url": "https://github.com/alibaba/Sentinel/pull/1502#discussion_r429720833", "bodyText": "Should you  add the license header here?", "author": "yunfeiyanggzq", "createdAt": "2020-05-25T03:49:59Z", "path": "sentinel-extension/sentinel-datasource-eureka/src/main/java/com/alibaba/csp/sentinel/datasource/eureka/EurekaDataSource.java", "diffHunk": "@@ -0,0 +1,200 @@\n+package com.alibaba.csp.sentinel.datasource.eureka;", "originalCommit": "5a7ab2eb95fd74f93d99145489954dda4b3c51df", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1cadd599ad6ac2545bc46014cf0d4138bc47b999", "chunk": "diff --git a/sentinel-extension/sentinel-datasource-eureka/src/main/java/com/alibaba/csp/sentinel/datasource/eureka/EurekaDataSource.java b/sentinel-extension/sentinel-datasource-eureka/src/main/java/com/alibaba/csp/sentinel/datasource/eureka/EurekaDataSource.java\nindex 1badc4a2..f7595807 100644\n--- a/sentinel-extension/sentinel-datasource-eureka/src/main/java/com/alibaba/csp/sentinel/datasource/eureka/EurekaDataSource.java\n+++ b/sentinel-extension/sentinel-datasource-eureka/src/main/java/com/alibaba/csp/sentinel/datasource/eureka/EurekaDataSource.java\n\n@@ -1,3 +1,18 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n package com.alibaba.csp.sentinel.datasource.eureka;\n \n import com.alibaba.csp.sentinel.datasource.AutoRefreshDataSource;\n"}}, {"oid": "1cadd599ad6ac2545bc46014cf0d4138bc47b999", "url": "https://github.com/alibaba/Sentinel/commit/1cadd599ad6ac2545bc46014cf0d4138bc47b999", "message": "add license header", "committedDate": "2020-05-25T04:20:17Z", "type": "commit"}, {"oid": "e54ed1d465a4661440615cce43cbe592d99e8c99", "url": "https://github.com/alibaba/Sentinel/commit/e54ed1d465a4661440615cce43cbe592d99e8c99", "message": "improve README", "committedDate": "2020-05-25T04:28:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ1MTYyNg==", "url": "https://github.com/alibaba/Sentinel/pull/1502#discussion_r430451626", "bodyText": "#Line100,#Line101 can be removed since the super constructor has checked their validation.\nValid the parameters in order seems better reading : )", "author": "cdfive", "createdAt": "2020-05-26T14:23:00Z", "path": "sentinel-extension/sentinel-datasource-eureka/src/main/java/com/alibaba/csp/sentinel/datasource/eureka/EurekaDataSource.java", "diffHunk": "@@ -0,0 +1,215 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.alibaba.csp.sentinel.datasource.eureka;\n+\n+import com.alibaba.csp.sentinel.datasource.AutoRefreshDataSource;\n+import com.alibaba.csp.sentinel.datasource.Converter;\n+import com.alibaba.csp.sentinel.datasource.ReadableDataSource;\n+import com.alibaba.csp.sentinel.log.RecordLog;\n+import com.alibaba.csp.sentinel.util.AssertUtil;\n+import com.alibaba.csp.sentinel.util.StringUtil;\n+import com.alibaba.fastjson.JSON;\n+\n+import java.io.*;\n+import java.net.HttpURLConnection;\n+import java.net.InetAddress;\n+import java.net.URL;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+/**\n+ * <p>\n+ * A {@link ReadableDataSource} based on Eureka. This class will automatically\n+ * fetches the metadata of the instance every period.\n+ * </p>\n+ * <p>\n+ * Limitations: Default refresh interval is 10s. Because there is synchronization between eureka servers,\n+ * it may take longer to take effect.\n+ * </p>\n+ *\n+ * @author: liyang\n+ * @create: 2020-05-23 12:01\n+ */\n+public class EurekaDataSource<T> extends AutoRefreshDataSource<String, T> {\n+\n+    private static final long DEFAULT_REFRESH_MS = 10000;\n+\n+    /**\n+     * connect timeout: 3s\n+     */\n+    private static final int DEFAULT_CONNECT_TIMEOUT_MS = 3000;\n+\n+    /**\n+     * read timeout: 30s\n+     */\n+    private static final int DEFAULT_READ_TIMEOUT_MS = 30000;\n+\n+\n+    private int connectTimeoutMills;\n+\n+\n+    private int readTimeoutMills;\n+\n+    /**\n+     * eureka instance appid\n+     */\n+    private String appId;\n+    /**\n+     * eureka instance id\n+     */\n+    private String instanceId;\n+\n+    /**\n+     * collect of eureka server urls\n+     */\n+    private List<String> serviceUrls;\n+\n+    /**\n+     * metadata key of the rule source\n+     */\n+    private String ruleKey;\n+\n+\n+    public EurekaDataSource(String appId, String instanceId, List<String> serviceUrls, String ruleKey,\n+                            Converter<String, T> configParser) {\n+        this(appId, instanceId, serviceUrls, ruleKey, configParser, DEFAULT_REFRESH_MS, DEFAULT_CONNECT_TIMEOUT_MS, DEFAULT_READ_TIMEOUT_MS);\n+    }\n+\n+\n+    public EurekaDataSource(String appId, String instanceId, List<String> serviceUrls, String ruleKey,\n+                            Converter<String, T> configParser, long refreshMs, int connectTimeoutMills,\n+                            int readTimeoutMills) {\n+        super(configParser, refreshMs);\n+        AssertUtil.notNull(appId, \"appId can't be null\");\n+        AssertUtil.notNull(instanceId, \"instanceId can't be null\");\n+        AssertUtil.notNull(ruleKey, \"ruleKey can't be null\");\n+        AssertUtil.notNull(configParser, \"configParser can't be null\");\n+        AssertUtil.assertState(refreshMs > 0, \"refreshMs must be greater than 0\");\n+        AssertUtil.assertState(connectTimeoutMills > 0, \"connectTimeoutMills must be greater than 0\");\n+        AssertUtil.assertState(readTimeoutMills > 0, \"readTimeoutMills must be greater than 0\");\n+        AssertUtil.assertNotEmpty(serviceUrls, \"serviceUrls can't be empty\");", "originalCommit": "e54ed1d465a4661440615cce43cbe592d99e8c99", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU0NDE3MQ==", "url": "https://github.com/alibaba/Sentinel/pull/1502#discussion_r431544171", "bodyText": "Good idea!", "author": "pleasecheckhere2016", "createdAt": "2020-05-28T02:15:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ1MTYyNg=="}], "type": "inlineReview", "revised_code": {"commit": "82f3c5ae459b166309b0d51bb524991abb24e122", "chunk": "diff --git a/sentinel-extension/sentinel-datasource-eureka/src/main/java/com/alibaba/csp/sentinel/datasource/eureka/EurekaDataSource.java b/sentinel-extension/sentinel-datasource-eureka/src/main/java/com/alibaba/csp/sentinel/datasource/eureka/EurekaDataSource.java\nindex f7595807..8029e8e9 100644\n--- a/sentinel-extension/sentinel-datasource-eureka/src/main/java/com/alibaba/csp/sentinel/datasource/eureka/EurekaDataSource.java\n+++ b/sentinel-extension/sentinel-datasource-eureka/src/main/java/com/alibaba/csp/sentinel/datasource/eureka/EurekaDataSource.java\n\n@@ -96,20 +96,18 @@ public class EurekaDataSource<T> extends AutoRefreshDataSource<String, T> {\n         super(configParser, refreshMs);\n         AssertUtil.notNull(appId, \"appId can't be null\");\n         AssertUtil.notNull(instanceId, \"instanceId can't be null\");\n+        AssertUtil.assertNotEmpty(serviceUrls, \"serviceUrls can't be empty\");\n         AssertUtil.notNull(ruleKey, \"ruleKey can't be null\");\n-        AssertUtil.notNull(configParser, \"configParser can't be null\");\n-        AssertUtil.assertState(refreshMs > 0, \"refreshMs must be greater than 0\");\n         AssertUtil.assertState(connectTimeoutMills > 0, \"connectTimeoutMills must be greater than 0\");\n         AssertUtil.assertState(readTimeoutMills > 0, \"readTimeoutMills must be greater than 0\");\n-        AssertUtil.assertNotEmpty(serviceUrls, \"serviceUrls can't be empty\");\n \n         this.appId = appId;\n         this.instanceId = instanceId;\n+        this.serviceUrls = ensureEndWithSlash(serviceUrls);\n+        AssertUtil.assertNotEmpty(this.serviceUrls, \"No available service url\");\n         this.ruleKey = ruleKey;\n         this.connectTimeoutMills = connectTimeoutMills;\n         this.readTimeoutMills = readTimeoutMills;\n-        serviceUrls = ensureEndWithSlash(serviceUrls);\n-        this.serviceUrls = serviceUrls;\n     }\n \n \n"}}, {"oid": "82f3c5ae459b166309b0d51bb524991abb24e122", "url": "https://github.com/alibaba/Sentinel/commit/82f3c5ae459b166309b0d51bb524991abb24e122", "message": "improve constructor args validation", "committedDate": "2020-05-28T02:16:13Z", "type": "commit"}, {"oid": "c19192cee33444b2f4c8be7f6afb92b405265e51", "url": "https://github.com/alibaba/Sentinel/commit/c19192cee33444b2f4c8be7f6afb92b405265e51", "message": "add EurekaDataSourceTest", "committedDate": "2020-06-05T10:47:03Z", "type": "commit"}, {"oid": "a98fb2b19ff9d136773421a6d3e3822c24acaaea", "url": "https://github.com/alibaba/Sentinel/commit/a98fb2b19ff9d136773421a6d3e3822c24acaaea", "message": "use 127.0.0.1 instead of localhost", "committedDate": "2020-06-05T13:19:09Z", "type": "commit"}, {"oid": "e791bb916ef016cbbde093d6884b6d1ec6eba547", "url": "https://github.com/alibaba/Sentinel/commit/e791bb916ef016cbbde093d6884b6d1ec6eba547", "message": "set eureka client fetch-registry false", "committedDate": "2020-06-05T14:03:25Z", "type": "commit"}, {"oid": "6bae731f68c4e89a10c7b629395b51ec7aa3254e", "url": "https://github.com/alibaba/Sentinel/commit/6bae731f68c4e89a10c7b629395b51ec7aa3254e", "message": "use await...util code pattern instead of Thread.sleep().", "committedDate": "2020-06-07T04:03:26Z", "type": "commit"}, {"oid": "f1198a637ad82d48c94593b8b643438240173b19", "url": "https://github.com/alibaba/Sentinel/commit/f1198a637ad82d48c94593b8b643438240173b19", "message": "Merge branch 'master' of https://github.com/alibaba/Sentinel into datasource-eureka\n\n\u0001 Conflicts:\n\u0001\tsentinel-extension/pom.xml", "committedDate": "2020-06-16T05:43:10Z", "type": "commit"}, {"oid": "1ae4e10a3022ace5f864931369631b1913b7d1ed", "url": "https://github.com/alibaba/Sentinel/commit/1ae4e10a3022ace5f864931369631b1913b7d1ed", "message": "Merge branch 'master' of https://github.com/alibaba/Sentinel into datasource-eureka", "committedDate": "2020-06-18T06:08:07Z", "type": "commit"}]}