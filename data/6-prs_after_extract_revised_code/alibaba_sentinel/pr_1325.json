{"pr_number": 1325, "pr_title": "Fixes #1321 \u65b0\u589eClient IP \u548c Remote Host\u7684\u5177\u4f53\u5c5e\u6027\u503c", "pr_createdAt": "2020-03-07T03:56:25Z", "pr_url": "https://github.com/alibaba/Sentinel/pull/1325", "timeline": [{"oid": "42f1293397b1ba97fb4fab37f2a46baea65b8a9d", "url": "https://github.com/alibaba/Sentinel/commit/42f1293397b1ba97fb4fab37f2a46baea65b8a9d", "message": "Fixes #1321\n\u5728\u7f16\u8f91\u7f51\u5173\u6d41\u63a7\u89c4\u5219\u4e2d\n\u53c2\u6570\u5c5e\u6027\u4e2d\u7684Client IP \u548c Remote Host\u4e0d\u80fd\u8bbe\u7f6e\u5177\u4f53\u7684\u5c5e\u6027\u503c\uff0cHearder\u3001URL\u53c2\u6570\u3001Cookie\u4e2d\u53ef\u4ee5\u8bbe\u7f6e", "committedDate": "2020-03-07T03:53:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI1MjQ1MA==", "url": "https://github.com/alibaba/Sentinel/pull/1325#discussion_r389252450", "bodyText": "\u5df2\u6d4b\u8bd5\uff0c\u529f\u80fd\u4e0a\u6ca1\u95ee\u9898\uff0c\u8d5e\uff01\n\u8fd9\u91cc}else if\u5efa\u8bae\u518d\u683c\u5f0f\u5316\u4e0b\uff0celse\u524d\u9762\u52a0\u4e2a\u7a7a\u683c\u4f1a\u66f4\u597d\u770b\u3002\n\u8fd9\u4e2aelse if\u5206\u652f\u91cc\u7684\u4ee3\u7801\uff0c\u8ddf\u4e0a\u9762\u7684if\u91cc\u7684\u6709\u4e00\u4e9b\u91cd\u590d\uff0c\u5b83\u4eec\u7684\u533a\u522b\u662fparseStrategy\u4e3a2-Header 3-URL\u53c2\u6570 4-Cookie\u65f6\uff0c\u754c\u9762\u4e0a\u8981\u586b\u5199\u53c2\u6570\u540d\u79f0\uff0c\u5176\u5b83\u903b\u8f91\u662f\u4e00\u6837\u7684\u3002\u5982\u679c\u60f3\u6d88\u9664\u91cd\u590d\u4ee3\u7801\uff0c\u53ef\u4ee5\u8003\u8651\u91cd\u6784\u4e00\u4e0b\u3002\n\u62c6\u5206\u5f00\u4e5f\u884c\uff0c\u5efa\u8bae\u6ce8\u91ca\u8fd9\u91cc\u53ef\u4ee5\u5199\u66f4\u6e05\u695a\u4e9b\uff0c\u6bd4\u5982// \u5f53\u53c2\u6570\u5c5e\u6027\u4e3a0-ClientIp 1-Host\u65f6\uff0c\u4e0d\u7528\u586b\u5199\u53c2\u6570\u540d\u79f0\uff0c\u53ef\u4ee5\u9009\u62e9\u5c5e\u6027\u503c\u5339\u914d\u3002", "author": "cdfive", "createdAt": "2020-03-07T12:45:40Z", "path": "sentinel-dashboard/src/main/java/com/alibaba/csp/sentinel/dashboard/controller/gateway/GatewayFlowRuleController.java", "diffHunk": "@@ -158,6 +158,20 @@\n                     }\n                     itemEntity.setMatchStrategy(matchStrategy);\n                 }\n+\n+                // \u5f53\u53c2\u6570\u5c5e\u6027\u4e3a0-ClientIp 1-Host\u65f6\uff0c\u53ef\u4ee5\u9009\u62e9\u5339\u914d\n+            }else if (Arrays.asList(PARAM_PARSE_STRATEGY_CLIENT_IP, PARAM_PARSE_STRATEGY_HOST).contains(parseStrategy)){", "originalCommit": "42f1293397b1ba97fb4fab37f2a46baea65b8a9d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI1NDI3MQ==", "url": "https://github.com/alibaba/Sentinel/pull/1325#discussion_r389254271", "bodyText": "+1", "author": "sczyh30", "createdAt": "2020-03-07T13:19:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI1MjQ1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQzMTE4OA==", "url": "https://github.com/alibaba/Sentinel/pull/1325#discussion_r389431188", "bodyText": "@cdfive \u5df2\u7ecf\u91cd\u6784", "author": "jy2156121", "createdAt": "2020-03-09T01:38:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI1MjQ1MA=="}], "type": "inlineReview", "revised_code": {"commit": "76d5db4fcf3e80dedbc16cc27fb84a3a272ab74c", "chunk": "diff --git a/sentinel-dashboard/src/main/java/com/alibaba/csp/sentinel/dashboard/controller/gateway/GatewayFlowRuleController.java b/sentinel-dashboard/src/main/java/com/alibaba/csp/sentinel/dashboard/controller/gateway/GatewayFlowRuleController.java\nindex e5b22da7..03db89f2 100644\n--- a/sentinel-dashboard/src/main/java/com/alibaba/csp/sentinel/dashboard/controller/gateway/GatewayFlowRuleController.java\n+++ b/sentinel-dashboard/src/main/java/com/alibaba/csp/sentinel/dashboard/controller/gateway/GatewayFlowRuleController.java\n\n@@ -146,32 +146,17 @@ public class GatewayFlowRuleController {\n                     return Result.ofFail(-1, \"fieldName can't be null or empty\");\n                 }\n                 itemEntity.setFieldName(paramItem.getFieldName());\n-\n-                String pattern = paramItem.getPattern();\n-                // \u5982\u679c\u5339\u914d\u4e32\u4e0d\u4e3a\u7a7a\uff0c\u9a8c\u8bc1\u5339\u914d\u6a21\u5f0f\n-                if (StringUtil.isNotEmpty(pattern)) {\n-                    itemEntity.setPattern(pattern);\n-\n-                    Integer matchStrategy = paramItem.getMatchStrategy();\n-                    if (!Arrays.asList(PARAM_MATCH_STRATEGY_EXACT, PARAM_MATCH_STRATEGY_CONTAINS, PARAM_MATCH_STRATEGY_REGEX).contains(matchStrategy)) {\n-                        return Result.ofFail(-1, \"invalid matchStrategy: \" + matchStrategy);\n-                    }\n-                    itemEntity.setMatchStrategy(matchStrategy);\n-                }\n-\n-                // \u5f53\u53c2\u6570\u5c5e\u6027\u4e3a0-ClientIp 1-Host\u65f6\uff0c\u53ef\u4ee5\u9009\u62e9\u5339\u914d\n-            }else if (Arrays.asList(PARAM_PARSE_STRATEGY_CLIENT_IP, PARAM_PARSE_STRATEGY_HOST).contains(parseStrategy)){\n-                String pattern = paramItem.getPattern();\n-                // \u5982\u679c\u5339\u914d\u4e32\u4e0d\u4e3a\u7a7a\uff0c\u9a8c\u8bc1\u5339\u914d\u6a21\u5f0f\n-                if (StringUtil.isNotEmpty(pattern)) {\n-                    itemEntity.setPattern(pattern);\n-\n-                    Integer matchStrategy = paramItem.getMatchStrategy();\n-                    if (!Arrays.asList(PARAM_MATCH_STRATEGY_EXACT, PARAM_MATCH_STRATEGY_CONTAINS, PARAM_MATCH_STRATEGY_REGEX).contains(matchStrategy)) {\n-                        return Result.ofFail(-1, \"invalid matchStrategy: \" + matchStrategy);\n-                    }\n-                    itemEntity.setMatchStrategy(matchStrategy);\n+            }\n+            String pattern = paramItem.getPattern();\n+\n+            // \u5982\u679c\u5339\u914d\u4e32\u4e0d\u4e3a\u7a7a\uff0c\u9a8c\u8bc1\u5339\u914d\u6a21\u5f0f\n+            if (StringUtil.isNotEmpty(pattern)) {\n+                itemEntity.setPattern(pattern);\n+                Integer matchStrategy = paramItem.getMatchStrategy();\n+                if (!Arrays.asList(PARAM_MATCH_STRATEGY_EXACT, PARAM_MATCH_STRATEGY_CONTAINS, PARAM_MATCH_STRATEGY_REGEX).contains(matchStrategy)) {\n+                    return Result.ofFail(-1, \"invalid matchStrategy: \" + matchStrategy);\n                 }\n+                itemEntity.setMatchStrategy(matchStrategy);\n             }\n         }\n \n"}}, {"oid": "76d5db4fcf3e80dedbc16cc27fb84a3a272ab74c", "url": "https://github.com/alibaba/Sentinel/commit/76d5db4fcf3e80dedbc16cc27fb84a3a272ab74c", "message": "Fixes #1321 \u65b0\u589eClient IP \u548c Remote Host\u7684\u5177\u4f53\u5c5e\u6027\u503c\n\u6309\u8981\u6c42\u91cd\u6784\u4ee3\u7801", "committedDate": "2020-03-09T01:37:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQzNTEyOA==", "url": "https://github.com/alibaba/Sentinel/pull/1325#discussion_r389435128", "bodyText": "\u91cd\u590d\u4ee3\u7801\u5df2\u6d88\u9664\uff0c\u770b\u7740\u66f4\u6e05\u6670\u7b80\u6d01\u4e86\u3002\n\u80fd\u5426\u9ebb\u70e6\u628a\u8fd9\u91cc\u518d\u4f18\u5316\u4e0b\uff1a\nString pattern = paramItem.getPattern();\u8fd9\u53e5\u662f\u5c5e\u4e8e\u4e0b\u9762\u7684\u903b\u8f91\uff0c\u7a7a\u884c\u5e94\u8be5\u5728\u4e0a\u9762\uff0c\u4e0b\u9762\u662f\u7d27\u5bc6\u76f8\u8fde\u7684\u903b\u8f91\uff0c\u7a7a\u884c\u53ef\u4ee5\u5220\u9664\uff0c\u5efa\u8bae\u628a\u8fd9\u53e5\u653e\u5230\u4e0b\u9762\u7684\u6ce8\u91ca\u4e4b\u540e\uff0cif\u7684\u4e0a\u9762\u3002\n\u56e0\u4e3a\u7a7a\u884c\u4e3a\u4e86\u533a\u5206\u903b\u8f91\u5757\uff0c\u589e\u5f3a\u53ef\u8bfb\u6027\u54c8\u3002", "author": "cdfive", "createdAt": "2020-03-09T02:04:29Z", "path": "sentinel-dashboard/src/main/java/com/alibaba/csp/sentinel/dashboard/controller/gateway/GatewayFlowRuleController.java", "diffHunk": "@@ -146,18 +146,17 @@\n                     return Result.ofFail(-1, \"fieldName can't be null or empty\");\n                 }\n                 itemEntity.setFieldName(paramItem.getFieldName());\n-\n-                String pattern = paramItem.getPattern();\n-                // \u5982\u679c\u5339\u914d\u4e32\u4e0d\u4e3a\u7a7a\uff0c\u9a8c\u8bc1\u5339\u914d\u6a21\u5f0f\n-                if (StringUtil.isNotEmpty(pattern)) {\n-                    itemEntity.setPattern(pattern);\n-\n-                    Integer matchStrategy = paramItem.getMatchStrategy();\n-                    if (!Arrays.asList(PARAM_MATCH_STRATEGY_EXACT, PARAM_MATCH_STRATEGY_CONTAINS, PARAM_MATCH_STRATEGY_REGEX).contains(matchStrategy)) {\n-                        return Result.ofFail(-1, \"invalid matchStrategy: \" + matchStrategy);\n-                    }\n-                    itemEntity.setMatchStrategy(matchStrategy);\n+            }\n+            String pattern = paramItem.getPattern();\n+\n+            // \u5982\u679c\u5339\u914d\u4e32\u4e0d\u4e3a\u7a7a\uff0c\u9a8c\u8bc1\u5339\u914d\u6a21\u5f0f\n+            if (StringUtil.isNotEmpty(pattern)) {", "originalCommit": "76d5db4fcf3e80dedbc16cc27fb84a3a272ab74c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQzODgyMg==", "url": "https://github.com/alibaba/Sentinel/pull/1325#discussion_r389438822", "bodyText": "\u597d\u4e86", "author": "jy2156121", "createdAt": "2020-03-09T02:26:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQzNTEyOA=="}], "type": "inlineReview", "revised_code": {"commit": "b2d72baa5789421c283f401f2ae873dd1b1bd15e", "chunk": "diff --git a/sentinel-dashboard/src/main/java/com/alibaba/csp/sentinel/dashboard/controller/gateway/GatewayFlowRuleController.java b/sentinel-dashboard/src/main/java/com/alibaba/csp/sentinel/dashboard/controller/gateway/GatewayFlowRuleController.java\nindex 03db89f2..b0a53e73 100644\n--- a/sentinel-dashboard/src/main/java/com/alibaba/csp/sentinel/dashboard/controller/gateway/GatewayFlowRuleController.java\n+++ b/sentinel-dashboard/src/main/java/com/alibaba/csp/sentinel/dashboard/controller/gateway/GatewayFlowRuleController.java\n\n@@ -147,8 +147,8 @@ public class GatewayFlowRuleController {\n                 }\n                 itemEntity.setFieldName(paramItem.getFieldName());\n             }\n-            String pattern = paramItem.getPattern();\n \n+            String pattern = paramItem.getPattern();\n             // \u5982\u679c\u5339\u914d\u4e32\u4e0d\u4e3a\u7a7a\uff0c\u9a8c\u8bc1\u5339\u914d\u6a21\u5f0f\n             if (StringUtil.isNotEmpty(pattern)) {\n                 itemEntity.setPattern(pattern);\n"}}, {"oid": "b2d72baa5789421c283f401f2ae873dd1b1bd15e", "url": "https://github.com/alibaba/Sentinel/commit/b2d72baa5789421c283f401f2ae873dd1b1bd15e", "message": "Fixes #1321 \u65b0\u589eClient IP \u548c Remote Host\u7684\u5177\u4f53\u5c5e\u6027\u503c\n\u6309\u8981\u6c42\u91cd\u6784\u4ee3\u7801", "committedDate": "2020-03-09T02:25:45Z", "type": "commit"}]}