{"pr_number": 1365, "pr_title": "Set default log level to INFO of JDK logging and improve log info and comment in SpiLoader", "pr_createdAt": "2020-03-27T16:11:38Z", "pr_url": "https://github.com/alibaba/Sentinel/pull/1365", "timeline": [{"oid": "1bdbbe78bb766e52fb8baf3ed53ddcec97eaf2f7", "url": "https://github.com/alibaba/Sentinel/commit/1bdbbe78bb766e52fb8baf3ed53ddcec97eaf2f7", "message": "Improve log info in SpiLoader, improve comment and test case", "committedDate": "2020-03-27T15:36:14Z", "type": "commit"}, {"oid": "84de476fdb5c7908ec398e11eeddc6aac6ec3781", "url": "https://github.com/alibaba/Sentinel/commit/84de476fdb5c7908ec398e11eeddc6aac6ec3781", "message": "Fix comment", "committedDate": "2020-03-27T16:25:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY4MjA5Ng==", "url": "https://github.com/alibaba/Sentinel/pull/1365#discussion_r399682096", "bodyText": "Although these codes are not changed in this PR but i should point out there are two ways to optimize a little, just FYI:\n\nlist should have an initial capacity specified because we know it(Same to orderWrappers)\nIt's an in order copying so add(T obj) is enough and will make sense.", "author": "jasonjoo2010", "createdAt": "2020-03-28T16:37:06Z", "path": "sentinel-core/src/main/java/com/alibaba/csp/sentinel/util/SpiLoader.java", "diffHunk": "@@ -219,16 +233,16 @@\n                 int order = SpiOrderResolver.resolveOrder(spi);\n                 // Since SPI is lazy initialized in ServiceLoader, we use online sort algorithm here.\n                 SpiOrderResolver.insertSorted(orderWrappers, spi, order);\n-                RecordLog.info(\"[SpiLoader] Found {0} SPI: {1} with order \" + order, clazz.getSimpleName(),\n-                        spi.getClass().getCanonicalName());\n+                RecordLog.debug(\"[SpiLoader] Found {} SPI: {} with order {}\", clazz.getSimpleName(),\n+                        spi.getClass().getCanonicalName(), order);\n             }\n             List<T> list = new ArrayList<>();\n             for (int i = 0; i < orderWrappers.size(); i++) {\n                 list.add(i, orderWrappers.get(i).spi);", "originalCommit": "84de476fdb5c7908ec398e11eeddc6aac6ec3781", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTczNTA4Ng==", "url": "https://github.com/alibaba/Sentinel/pull/1365#discussion_r399735086", "bodyText": "Good idea! They have been improved, please check.", "author": "cdfive", "createdAt": "2020-03-29T02:29:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY4MjA5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "2c2375141cebc07458eeca196acf91dd9b491175", "chunk": "diff --git a/sentinel-core/src/main/java/com/alibaba/csp/sentinel/util/SpiLoader.java b/sentinel-core/src/main/java/com/alibaba/csp/sentinel/util/SpiLoader.java\nindex f3569e3e..47b3342a 100644\n--- a/sentinel-core/src/main/java/com/alibaba/csp/sentinel/util/SpiLoader.java\n+++ b/sentinel-core/src/main/java/com/alibaba/csp/sentinel/util/SpiLoader.java\n\n@@ -236,13 +236,13 @@ public final class SpiLoader {\n                 RecordLog.debug(\"[SpiLoader] Found {} SPI: {} with order {}\", clazz.getSimpleName(),\n                         spi.getClass().getCanonicalName(), order);\n             }\n-            List<T> list = new ArrayList<>();\n+            List<T> list = new ArrayList<>(orderWrappers.size());\n             for (int i = 0; i < orderWrappers.size(); i++) {\n-                list.add(i, orderWrappers.get(i).spi);\n+                list.add(orderWrappers.get(i).spi);\n             }\n             return list;\n         } catch (Throwable t) {\n-            RecordLog.warn(\"[SpiLoader] ERROR: loadPrototypeInstanceListSorted failed\", t);\n+            RecordLog.error(\"[SpiLoader] ERROR: loadPrototypeInstanceListSorted failed\", t);\n             t.printStackTrace();\n             return new ArrayList<>();\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY4MjY0OQ==", "url": "https://github.com/alibaba/Sentinel/pull/1365#discussion_r399682649", "bodyText": "warn and ERROR are a little confused(Although it's also not included in this PR actually).\nAnd after several iterations enhancing logging of Sentinel is it still necessary to use printStackTrace() directly? We just make a decision and go.", "author": "jasonjoo2010", "createdAt": "2020-03-28T16:42:04Z", "path": "sentinel-core/src/main/java/com/alibaba/csp/sentinel/util/SpiLoader.java", "diffHunk": "@@ -219,16 +233,16 @@\n                 int order = SpiOrderResolver.resolveOrder(spi);\n                 // Since SPI is lazy initialized in ServiceLoader, we use online sort algorithm here.\n                 SpiOrderResolver.insertSorted(orderWrappers, spi, order);\n-                RecordLog.info(\"[SpiLoader] Found {0} SPI: {1} with order \" + order, clazz.getSimpleName(),\n-                        spi.getClass().getCanonicalName());\n+                RecordLog.debug(\"[SpiLoader] Found {} SPI: {} with order {}\", clazz.getSimpleName(),\n+                        spi.getClass().getCanonicalName(), order);\n             }\n             List<T> list = new ArrayList<>();\n             for (int i = 0; i < orderWrappers.size(); i++) {\n                 list.add(i, orderWrappers.get(i).spi);\n             }\n             return list;\n         } catch (Throwable t) {\n-            RecordLog.warn(\"[SpiLoader] ERROR: loadDifferentInstanceListSorted failed\", t);\n+            RecordLog.warn(\"[SpiLoader] ERROR: loadPrototypeInstanceListSorted failed\", t);", "originalCommit": "84de476fdb5c7908ec398e11eeddc6aac6ec3781", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTczNTY3NQ==", "url": "https://github.com/alibaba/Sentinel/pull/1365#discussion_r399735675", "bodyText": "Yes, in Exception catch block, use ERROR is better, it has been fixed, please check.\n\nAnd after several iterations enhancing logging of Sentinel is it still necessary to use printStackTrace() directly? We just make a decision and go.\n\nUse printStackTrace() directly doesn't look good indeed, maybe printStackTrace() is useful for users to view directly, since RecordLog log the message info file by default, so I haven't removed it, and waiting for your confirm.I also wonder that if we could throw RuntimeException in the catch block.\nBTW, the catch block seems to be never happen or extremely small probability.", "author": "cdfive", "createdAt": "2020-03-29T02:37:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY4MjY0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTczNTkyOA==", "url": "https://github.com/alibaba/Sentinel/pull/1365#discussion_r399735928", "bodyText": "Yes, in Exception catch block, use ERROR is better, it has been fixed, please check.\n\nAnd after several iterations enhancing logging of Sentinel is it still necessary to use printStackTrace() directly? We just make a decision and go.\n\nUse printStackTrace() directly doesn't look good indeed, maybe printStackTrace() is useful for users to view directly, since RecordLog log the message info file by default, so I haven't removed it, and waiting for your confirm.I also wonder that if we could throw RuntimeException in the catch block.\nBTW, the catch block seems to be never happen or extremely small probability.\n\nYeah actually i have no position here and we could keep it then", "author": "jasonjoo2010", "createdAt": "2020-03-29T02:41:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY4MjY0OQ=="}], "type": "inlineReview", "revised_code": {"commit": "2c2375141cebc07458eeca196acf91dd9b491175", "chunk": "diff --git a/sentinel-core/src/main/java/com/alibaba/csp/sentinel/util/SpiLoader.java b/sentinel-core/src/main/java/com/alibaba/csp/sentinel/util/SpiLoader.java\nindex f3569e3e..47b3342a 100644\n--- a/sentinel-core/src/main/java/com/alibaba/csp/sentinel/util/SpiLoader.java\n+++ b/sentinel-core/src/main/java/com/alibaba/csp/sentinel/util/SpiLoader.java\n\n@@ -236,13 +236,13 @@ public final class SpiLoader {\n                 RecordLog.debug(\"[SpiLoader] Found {} SPI: {} with order {}\", clazz.getSimpleName(),\n                         spi.getClass().getCanonicalName(), order);\n             }\n-            List<T> list = new ArrayList<>();\n+            List<T> list = new ArrayList<>(orderWrappers.size());\n             for (int i = 0; i < orderWrappers.size(); i++) {\n-                list.add(i, orderWrappers.get(i).spi);\n+                list.add(orderWrappers.get(i).spi);\n             }\n             return list;\n         } catch (Throwable t) {\n-            RecordLog.warn(\"[SpiLoader] ERROR: loadPrototypeInstanceListSorted failed\", t);\n+            RecordLog.error(\"[SpiLoader] ERROR: loadPrototypeInstanceListSorted failed\", t);\n             t.printStackTrace();\n             return new ArrayList<>();\n         }\n"}}, {"oid": "2c2375141cebc07458eeca196acf91dd9b491175", "url": "https://github.com/alibaba/Sentinel/commit/2c2375141cebc07458eeca196acf91dd9b491175", "message": "Use error level in catch block, init ArrayList with capacity and improve add item to list", "committedDate": "2020-03-29T02:28:49Z", "type": "commit"}, {"oid": "0b87c4840571323a99934481383f9aeba89b921f", "url": "https://github.com/alibaba/Sentinel/commit/0b87c4840571323a99934481383f9aeba89b921f", "message": "Remove static block for print log in DefaultSlotChainBuilder", "committedDate": "2020-04-02T12:54:56Z", "type": "commit"}, {"oid": "f8c5bf02118c7e0bc77f20e70f33afa10ff8d392", "url": "https://github.com/alibaba/Sentinel/commit/f8c5bf02118c7e0bc77f20e70f33afa10ff8d392", "message": "Fix comment in test case", "committedDate": "2020-04-02T12:57:24Z", "type": "commit"}]}