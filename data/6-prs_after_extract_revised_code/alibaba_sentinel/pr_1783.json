{"pr_number": 1783, "pr_title": "fix the potential concurrence issue when rules updates", "pr_createdAt": "2020-10-06T16:42:47Z", "pr_url": "https://github.com/alibaba/Sentinel/pull/1783", "timeline": [{"oid": "6a845eeda3bd597bb4a94a5546d03a96f3b80c0a", "url": "https://github.com/alibaba/Sentinel/commit/6a845eeda3bd597bb4a94a5546d03a96f3b80c0a", "message": "Merge pull request #1 from alibaba/master\n\nsync with alibaba master", "committedDate": "2020-10-06T14:58:24Z", "type": "commit"}, {"oid": "edd3b80f6fb8011338519cd654c173c311f9857f", "url": "https://github.com/alibaba/Sentinel/commit/edd3b80f6fb8011338519cd654c173c311f9857f", "message": "fix the potential concurrence issue when rules updates", "committedDate": "2020-10-06T16:35:02Z", "type": "commit"}, {"oid": "c72752f233d231e2522fecc063e64ec1462c4796", "url": "https://github.com/alibaba/Sentinel/commit/c72752f233d231e2522fecc063e64ec1462c4796", "message": "add license statement and remove wrong version", "committedDate": "2020-10-06T16:45:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ1ODI5Ng==", "url": "https://github.com/alibaba/Sentinel/pull/1783#discussion_r500458296", "bodyText": "Maybe the variable in logging message should be updated now.", "author": "jasonjoo2010", "createdAt": "2020-10-06T17:04:51Z", "path": "sentinel-core/src/main/java/com/alibaba/csp/sentinel/slots/block/flow/FlowRuleManager.java", "diffHunk": "@@ -129,20 +130,16 @@ public static boolean isOtherOrigin(String origin, String resourceName) {\n         @Override\n         public void configUpdate(List<FlowRule> value) {\n             Map<String, List<FlowRule>> rules = FlowRuleUtil.buildFlowRuleMap(value);\n-            if (rules != null) {\n-                flowRules.clear();\n-                flowRules.putAll(rules);\n-            }\n+            //the rules was always not null, it's no need to check nullable\n+            //remove checking to avoid IDE warning\n+            flowRules.set(rules);\n             RecordLog.info(\"[FlowRuleManager] Flow rules received: {}\", flowRules);", "originalCommit": "c72752f233d231e2522fecc063e64ec1462c4796", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA2MjcyNw==", "url": "https://github.com/alibaba/Sentinel/pull/1783#discussion_r501062727", "bodyText": "fixed", "author": "vipweihua", "createdAt": "2020-10-07T14:33:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ1ODI5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "78ce0773ab90bd11c8a04b8bf390b3c95ee06ad7", "chunk": "diff --git a/sentinel-core/src/main/java/com/alibaba/csp/sentinel/slots/block/flow/FlowRuleManager.java b/sentinel-core/src/main/java/com/alibaba/csp/sentinel/slots/block/flow/FlowRuleManager.java\nindex 6f06e555..c6f7a9e3 100755\n--- a/sentinel-core/src/main/java/com/alibaba/csp/sentinel/slots/block/flow/FlowRuleManager.java\n+++ b/sentinel-core/src/main/java/com/alibaba/csp/sentinel/slots/block/flow/FlowRuleManager.java\n\n@@ -133,14 +133,14 @@ public class FlowRuleManager {\n             //the rules was always not null, it's no need to check nullable\n             //remove checking to avoid IDE warning\n             flowRules.set(rules);\n-            RecordLog.info(\"[FlowRuleManager] Flow rules received: {}\", flowRules);\n+            RecordLog.info(\"[FlowRuleManager] Flow rules received: {}\", flowRules.get());\n         }\n \n         @Override\n         public void configLoad(List<FlowRule> conf) {\n             Map<String, List<FlowRule>> rules = FlowRuleUtil.buildFlowRuleMap(conf);\n             flowRules.set(rules);\n-            RecordLog.info(\"[FlowRuleManager] Flow rules loaded: {}\", flowRules);\n+            RecordLog.info(\"[FlowRuleManager] Flow rules loaded: {}\", flowRules.get());\n         }\n     }\n \n"}}, {"oid": "78ce0773ab90bd11c8a04b8bf390b3c95ee06ad7", "url": "https://github.com/alibaba/Sentinel/commit/78ce0773ab90bd11c8a04b8bf390b3c95ee06ad7", "message": "update message in logging", "committedDate": "2020-10-07T01:06:44Z", "type": "commit"}, {"oid": "703e6cc1c161ad0c78bda590e401ca0fa69167b2", "url": "https://github.com/alibaba/Sentinel/commit/703e6cc1c161ad0c78bda590e401ca0fa69167b2", "message": "remove system.out", "committedDate": "2020-10-07T13:53:15Z", "type": "commit"}, {"oid": "815f049341361009383bb84af0baba447e9a3ce9", "url": "https://github.com/alibaba/Sentinel/commit/815f049341361009383bb84af0baba447e9a3ce9", "message": "make compatible with low jdk version", "committedDate": "2020-10-07T14:29:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE2NzA1MQ==", "url": "https://github.com/alibaba/Sentinel/pull/1783#discussion_r501167051", "bodyText": "Is it necessary to initial its value (flowRules) to be an empty map obviously?\nIt's tricky now because the initial empty value is initialized by currentProperty.addListener(LISTENER); in static block. It may trigger a bug if anyone change any of them in future.", "author": "jasonjoo2010", "createdAt": "2020-10-07T16:56:07Z", "path": "sentinel-core/src/main/java/com/alibaba/csp/sentinel/slots/block/flow/FlowRuleManager.java", "diffHunk": "@@ -83,7 +85,7 @@ public static void register2Property(SentinelProperty<List<FlowRule>> property)\n      */\n     public static List<FlowRule> getRules() {\n         List<FlowRule> rules = new ArrayList<FlowRule>();\n-        for (Map.Entry<String, List<FlowRule>> entry : flowRules.entrySet()) {\n+        for (Map.Entry<String, List<FlowRule>> entry : flowRules.get().entrySet()) {", "originalCommit": "815f049341361009383bb84af0baba447e9a3ce9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQyMzU2Mw==", "url": "https://github.com/alibaba/Sentinel/pull/1783#discussion_r501423563", "bodyText": "Totally agree.", "author": "vipweihua", "createdAt": "2020-10-08T03:13:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE2NzA1MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE2OTAzOA==", "url": "https://github.com/alibaba/Sentinel/pull/1783#discussion_r501169038", "bodyText": "For eventual consistency maybe rules is better. Because there may be duplicated logs with same content when races occurred.", "author": "jasonjoo2010", "createdAt": "2020-10-07T16:59:07Z", "path": "sentinel-core/src/main/java/com/alibaba/csp/sentinel/slots/block/flow/FlowRuleManager.java", "diffHunk": "@@ -129,21 +131,17 @@ public static boolean isOtherOrigin(String origin, String resourceName) {\n         @Override\n         public void configUpdate(List<FlowRule> value) {\n             Map<String, List<FlowRule>> rules = FlowRuleUtil.buildFlowRuleMap(value);\n-            if (rules != null) {\n-                flowRules.clear();\n-                flowRules.putAll(rules);\n-            }\n-            RecordLog.info(\"[FlowRuleManager] Flow rules received: {}\", flowRules);\n+            //the rules was always not null, it's no need to check nullable\n+            //remove checking to avoid IDE warning\n+            flowRules.set(rules);\n+            RecordLog.info(\"[FlowRuleManager] Flow rules received: {}\", flowRules.get());", "originalCommit": "815f049341361009383bb84af0baba447e9a3ce9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQyNDI4MA==", "url": "https://github.com/alibaba/Sentinel/pull/1783#discussion_r501424280", "bodyText": "Agree.", "author": "vipweihua", "createdAt": "2020-10-08T03:15:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE2OTAzOA=="}], "type": "inlineReview", "revised_code": {"commit": "3fab0863e1ef5630cc2ab229d0ed7843ecab0918", "chunk": "diff --git a/sentinel-core/src/main/java/com/alibaba/csp/sentinel/slots/block/flow/FlowRuleManager.java b/sentinel-core/src/main/java/com/alibaba/csp/sentinel/slots/block/flow/FlowRuleManager.java\nindex 953bbda6..7d3884e0 100755\n--- a/sentinel-core/src/main/java/com/alibaba/csp/sentinel/slots/block/flow/FlowRuleManager.java\n+++ b/sentinel-core/src/main/java/com/alibaba/csp/sentinel/slots/block/flow/FlowRuleManager.java\n\n@@ -134,14 +134,14 @@ public class FlowRuleManager {\n             //the rules was always not null, it's no need to check nullable\n             //remove checking to avoid IDE warning\n             flowRules.set(rules);\n-            RecordLog.info(\"[FlowRuleManager] Flow rules received: {}\", flowRules.get());\n+            RecordLog.info(\"[FlowRuleManager] Flow rules received: {}\", rules);\n         }\n \n         @Override\n         public void configLoad(List<FlowRule> conf) {\n             Map<String, List<FlowRule>> rules = FlowRuleUtil.buildFlowRuleMap(conf);\n             flowRules.set(rules);\n-            RecordLog.info(\"[FlowRuleManager] Flow rules loaded: {}\", flowRules.get());\n+            RecordLog.info(\"[FlowRuleManager] Flow rules loaded: {}\", rules);\n         }\n     }\n \n"}}, {"oid": "3fab0863e1ef5630cc2ab229d0ed7843ecab0918", "url": "https://github.com/alibaba/Sentinel/commit/3fab0863e1ef5630cc2ab229d0ed7843ecab0918", "message": "initialize flowRules map", "committedDate": "2020-10-08T04:43:05Z", "type": "commit"}, {"oid": "35282f63a2329e5af90a51fb376a4f92a8d24e0e", "url": "https://github.com/alibaba/Sentinel/commit/35282f63a2329e5af90a51fb376a4f92a8d24e0e", "message": "initialize flowRules map", "committedDate": "2020-10-08T04:47:23Z", "type": "commit"}]}