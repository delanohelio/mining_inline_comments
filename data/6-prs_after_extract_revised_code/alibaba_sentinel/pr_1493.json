{"pr_number": 1493, "pr_title": "Support setting class-level defaultFallback for annotation extension", "pr_createdAt": "2020-05-21T03:54:34Z", "pr_url": "https://github.com/alibaba/Sentinel/pull/1493", "timeline": [{"oid": "d1d944c1a50ea1a2eb610fac7e874d7807b40c4b", "url": "https://github.com/alibaba/Sentinel/commit/d1d944c1a50ea1a2eb610fac7e874d7807b40c4b", "message": "tmp sumbit", "committedDate": "2020-05-21T03:50:23Z", "type": "commit"}, {"oid": "dc414a371f0894b58c4380fd9d288dffb471e0bb", "url": "https://github.com/alibaba/Sentinel/commit/dc414a371f0894b58c4380fd9d288dffb471e0bb", "message": "fix", "committedDate": "2020-05-21T06:32:30Z", "type": "commit"}, {"oid": "dc86fbf122e9093bddae4c24da369f485afcd8cc", "url": "https://github.com/alibaba/Sentinel/commit/dc86fbf122e9093bddae4c24da369f485afcd8cc", "message": "fix ci", "committedDate": "2020-05-21T06:40:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTUzMDkzNg==", "url": "https://github.com/alibaba/Sentinel/pull/1493#discussion_r429530936", "bodyText": "Could you please add licese header(1999-2020) for the class and remove this unused blank line", "author": "cdfive", "createdAt": "2020-05-23T09:30:07Z", "path": "sentinel-extension/sentinel-annotation-aspectj/src/test/java/com/alibaba/csp/sentinel/annotation/aspectj/integration/service/GlobalFallback.java", "diffHunk": "@@ -0,0 +1,12 @@\n+package com.alibaba.csp.sentinel.annotation.aspectj.integration.service;\n+\n+/**\n+ * @author zhaoyuguang\n+ */\n+", "originalCommit": "dc86fbf122e9093bddae4c24da369f485afcd8cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY0NzYzOQ==", "url": "https://github.com/alibaba/Sentinel/pull/1493#discussion_r429647639", "bodyText": "fixed", "author": "zhaoyuguang", "createdAt": "2020-05-24T15:24:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTUzMDkzNg=="}], "type": "inlineReview", "revised_code": {"commit": "0124edf76afd6d173d0b894f72d0221ec546322d", "chunk": "diff --git a/sentinel-extension/sentinel-annotation-aspectj/src/test/java/com/alibaba/csp/sentinel/annotation/aspectj/integration/service/GlobalFallback.java b/sentinel-extension/sentinel-annotation-aspectj/src/test/java/com/alibaba/csp/sentinel/annotation/aspectj/integration/service/GlobalFallback.java\nindex e7f79a1a..3571b577 100644\n--- a/sentinel-extension/sentinel-annotation-aspectj/src/test/java/com/alibaba/csp/sentinel/annotation/aspectj/integration/service/GlobalFallback.java\n+++ b/sentinel-extension/sentinel-annotation-aspectj/src/test/java/com/alibaba/csp/sentinel/annotation/aspectj/integration/service/GlobalFallback.java\n\n@@ -1,9 +1,23 @@\n+/*\n+ * Copyright 1999-2020 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n package com.alibaba.csp.sentinel.annotation.aspectj.integration.service;\n \n /**\n  * @author zhaoyuguang\n  */\n-\n public class GlobalFallback {\n \n     public static String doFallback(Throwable t) {\n"}}, {"oid": "0124edf76afd6d173d0b894f72d0221ec546322d", "url": "https://github.com/alibaba/Sentinel/commit/0124edf76afd6d173d0b894f72d0221ec546322d", "message": "fix", "committedDate": "2020-05-24T15:24:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTgwMjM0Ng==", "url": "https://github.com/alibaba/Sentinel/pull/1493#discussion_r429802346", "bodyText": "The priority of method-level annotation is higher than class-level annotation, so maybe here we need to check whether original locationClass is absent.", "author": "sczyh30", "createdAt": "2020-05-25T08:26:09Z", "path": "sentinel-extension/sentinel-annotation-aspectj/src/main/java/com/alibaba/csp/sentinel/annotation/aspectj/AbstractSentinelAspectSupport.java", "diffHunk": "@@ -186,7 +187,13 @@ private Method extractFallbackMethod(ProceedingJoinPoint pjp, String fallbackNam\n     private Method extractDefaultFallbackMethod(ProceedingJoinPoint pjp, String defaultFallback,\n                                                 Class<?>[] locationClass) {\n         if (StringUtil.isBlank(defaultFallback)) {\n-            return null;\n+            SentinelResource annotationClass = pjp.getTarget().getClass().getAnnotation(SentinelResource.class);\n+            if (annotationClass != null && StringUtil.isNotBlank(annotationClass.defaultFallback())) {\n+                defaultFallback = annotationClass.defaultFallback();\n+                locationClass = annotationClass.fallbackClass();", "originalCommit": "0124edf76afd6d173d0b894f72d0221ec546322d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTgwODA3MQ==", "url": "https://github.com/alibaba/Sentinel/pull/1493#discussion_r429808071", "bodyText": "\u5982\u679c locationClass \u6ca1\u6709\u914d\u7f6e\uff0c\u90a3\u4e48\u5c31\u662f\u7528\u5f53\u524d\u7c7b\u7684\u4f5c\u4e3a\u9ed8\u8ba4\uff0c\u8fd9\u6837\u7684\u903b\u8f91\u5408\u9002\u4e48\uff1f", "author": "zhaoyuguang", "createdAt": "2020-05-25T08:38:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTgwMjM0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTgyODg5MQ==", "url": "https://github.com/alibaba/Sentinel/pull/1493#discussion_r429828891", "bodyText": "\u89e3\u6790\u4f18\u5148\u7ea7\uff1a\u65b9\u6cd5\u7ea7\u522b\u7684 fallbackClass > \u7c7b\u7ea7\u522b\u7684 fallbackClass\uff0c\u82e5\u4e0d\u5b58\u5728\u5219\u7528\u5f53\u524d\u7c7b\u66ff\u4ee3\u3002", "author": "sczyh30", "createdAt": "2020-05-25T09:18:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTgwMjM0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg5MjA1MA==", "url": "https://github.com/alibaba/Sentinel/pull/1493#discussion_r429892050", "bodyText": "\u5047\u5982\u65b9\u6cd5\u6ce8\u89e3 \u5199\u4e86\u7684locationClass \u6ca1\u5199defaultFallback\n\u800c\u7c7b\u6ce8\u89e3\u5199\u4e86\u7684locationClass \u548cdefaultFallback\n\u5728\u8fd9\u79cdcase\u4e0b\u662f\u4e0d\u662f \u4f7f\u7528\u8005\u914d\u7f6e\u9519\u8bef \u5e94\u8be5\u5168\u90e8\u4f7f\u7528\u7c7b\u6ce8\u89e3\u4e0a\u7684locationClass \u548cdefaultFallback\u6bd4\u8f83\u597d\uff1f", "author": "zhaoyuguang", "createdAt": "2020-05-25T11:47:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTgwMjM0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg5Nzg3MA==", "url": "https://github.com/alibaba/Sentinel/pull/1493#discussion_r429897870", "bodyText": "\u8003\u8651\u4e00\u4e0b\u8fd9\u79cd\u573a\u666f\uff08\u4e0d\u4e00\u5b9a\u5408\u7406\uff09\uff1a\u67d0\u4e2a\u65b9\u6cd5\u5e0c\u671b override \u5bf9\u5e94\u7684 fallbackClass\uff0c\u8fd9\u79cd\u60c5\u51b5\u7684\u8bdd \u53ef\u80fd\u8fd8\u4e0d\u80fd\u5224\u5b9a\u4e3a\u914d\u7f6e\u9519\u8bef", "author": "sczyh30", "createdAt": "2020-05-25T12:01:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTgwMjM0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE3OTI2MA==", "url": "https://github.com/alibaba/Sentinel/pull/1493#discussion_r430179260", "bodyText": "\u6539\u4e86\u4e0b\u903b\u8f91 \u5982\u679c\u53d6\u65b9\u6cd5\u6ce8\u89e3 ->  \u53d6\u7c7b\u6ce8\u89e3 -> \u53d6\u672c\u7c7b", "author": "zhaoyuguang", "createdAt": "2020-05-26T06:20:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTgwMjM0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIwMjIwOA==", "url": "https://github.com/alibaba/Sentinel/pull/1493#discussion_r430202208", "bodyText": "\u65b9\u6cd5\u7ea7\u522b\u7684 fallbackClass > \u7c7b\u7ea7\u522b\u7684 fallbackClass\n\n\u770b\u76ee\u524d\u4ee3\u7801\u5df2\u7b26\u5408\u6ee1\u8db3\u8be5\u573a\u666f\u4e86\n\n\u6539\u4e86\u4e0b\u903b\u8f91 \u5982\u679c\u53d6\u65b9\u6cd5\u6ce8\u89e3 -> \u53d6\u7c7b\u6ce8\u89e3 -> \u53d6\u672c\u7c7b\n\n\u4e0d\u8fc7\u8fd9\u53e5\u597d\u50cf\u5e76\u6ca1\u6709\u5b8c\u5168\u8986\u76d6\u5230\u3002\n\u6bd4\u5982\u65b9\u6cd5\u7ea7\u7684defaultFallback\u4e0d\u4e3a\u7a7a\uff0c\u4f46\u65b9\u6cd5\u7ea7\u7684fallbackClass\u4e3a\u7a7a\uff0c\u76ee\u524d\u6ca1\u6709\u53d6\u7c7b\u7ea7\u522b\u7684\uff0c\u53d6\u7684\u672c\u7c7b\u3002\u56e0\u4e3a\u7b2c\u4e00\u4e2aif\u5224\u65ad\u662f\u65b9\u6cd5\u7ea7\u522b\u7684defaultFallback\u3002\n\u8fd9\u4e2a\u573a\u666f\u4e5f\u4e0d\u4e00\u5b9a\u5408\u7406\uff0c\u5c31\u770b\u662f\u5426\u9700\u8981\u5b8c\u5168\u6309\u65b9\u6cd5\u6ce8\u89e3 -> \u53d6\u7c7b\u6ce8\u89e3 -> \u53d6\u672c\u7c7b\u4f18\u5148\u7ea7\u4e86\u3002\nBTW\uff0c\u6709\u4e2a\u7591\u95ee\uff1a\nSentinelResource\u6ce8\u89e3:\nClass<?>[] blockHandlerClass() default {};\nClass<?>[] fallbackClass() default {};\n\u4e3a\u4f55\u8981\u8bbe\u8ba1\u6210\u6570\u7ec4\u5462\uff1f\u770b\u4ee3\u7801\u91cc\u53ea\u53d6\u4e86[0]\u7b2c\u4e00\u4e2a\uff0c\u662f\u4e0d\u662f\u7528Class<?>\u5c31\u597d", "author": "cdfive", "createdAt": "2020-05-26T07:15:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTgwMjM0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjI2ODE1Ng==", "url": "https://github.com/alibaba/Sentinel/pull/1493#discussion_r432268156", "bodyText": "\u65b9\u6cd5\u7ea7\u522b\u7684 fallbackClass > \u7c7b\u7ea7\u522b\u7684 fallbackClass\n\n\u770b\u76ee\u524d\u4ee3\u7801\u5df2\u7b26\u5408\u6ee1\u8db3\u8be5\u573a\u666f\u4e86\n\n\u6539\u4e86\u4e0b\u903b\u8f91 \u5982\u679c\u53d6\u65b9\u6cd5\u6ce8\u89e3 -> \u53d6\u7c7b\u6ce8\u89e3 -> \u53d6\u672c\u7c7b\n\n\u4e0d\u8fc7\u8fd9\u53e5\u597d\u50cf\u5e76\u6ca1\u6709\u5b8c\u5168\u8986\u76d6\u5230\u3002\n\u6bd4\u5982\u65b9\u6cd5\u7ea7\u7684defaultFallback\u4e0d\u4e3a\u7a7a\uff0c\u4f46\u65b9\u6cd5\u7ea7\u7684fallbackClass\u4e3a\u7a7a\uff0c\u76ee\u524d\u6ca1\u6709\u53d6\u7c7b\u7ea7\u522b\u7684\uff0c\u53d6\u7684\u672c\u7c7b\u3002\u56e0\u4e3a\u7b2c\u4e00\u4e2aif\u5224\u65ad\u662f\u65b9\u6cd5\u7ea7\u522b\u7684defaultFallback\u3002\n\u8fd9\u4e2a\u573a\u666f\u4e5f\u4e0d\u4e00\u5b9a\u5408\u7406\uff0c\u5c31\u770b\u662f\u5426\u9700\u8981\u5b8c\u5168\u6309\u65b9\u6cd5\u6ce8\u89e3 -> \u53d6\u7c7b\u6ce8\u89e3 -> \u53d6\u672c\u7c7b\u4f18\u5148\u7ea7\u4e86\u3002\n\nWe may improve this later.\n\nBTW\uff0c\u6709\u4e2a\u7591\u95ee\uff1a\nSentinelResource\u6ce8\u89e3:\nClass<?>[] blockHandlerClass() default {};\nClass<?>[] fallbackClass() default {};\n\u4e3a\u4f55\u8981\u8bbe\u8ba1\u6210\u6570\u7ec4\u5462\uff1f\u770b\u4ee3\u7801\u91cc\u53ea\u53d6\u4e86[0]\u7b2c\u4e00\u4e2a\uff0c\u662f\u4e0d\u662f\u7528Class<?>\u5c31\u597d\n\nActually fallbackClass is optional. If using Class<?>, it cannot be null anymore.", "author": "sczyh30", "createdAt": "2020-05-29T05:48:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTgwMjM0Ng=="}], "type": "inlineReview", "revised_code": {"commit": "cad7ed9d9ab9a87ff6ec577f2f810c900315e7f6", "chunk": "diff --git a/sentinel-extension/sentinel-annotation-aspectj/src/main/java/com/alibaba/csp/sentinel/annotation/aspectj/AbstractSentinelAspectSupport.java b/sentinel-extension/sentinel-annotation-aspectj/src/main/java/com/alibaba/csp/sentinel/annotation/aspectj/AbstractSentinelAspectSupport.java\nindex 108d3b03..b2040dca 100644\n--- a/sentinel-extension/sentinel-annotation-aspectj/src/main/java/com/alibaba/csp/sentinel/annotation/aspectj/AbstractSentinelAspectSupport.java\n+++ b/sentinel-extension/sentinel-annotation-aspectj/src/main/java/com/alibaba/csp/sentinel/annotation/aspectj/AbstractSentinelAspectSupport.java\n\n@@ -190,7 +190,9 @@ public abstract class AbstractSentinelAspectSupport {\n             SentinelResource annotationClass = pjp.getTarget().getClass().getAnnotation(SentinelResource.class);\n             if (annotationClass != null && StringUtil.isNotBlank(annotationClass.defaultFallback())) {\n                 defaultFallback = annotationClass.defaultFallback();\n-                locationClass = annotationClass.fallbackClass();\n+                if (locationClass == null || locationClass.length < 1) {\n+                    locationClass = annotationClass.fallbackClass();\n+                }\n             } else {\n                 return null;\n             }\n"}}, {"oid": "cad7ed9d9ab9a87ff6ec577f2f810c900315e7f6", "url": "https://github.com/alibaba/Sentinel/commit/cad7ed9d9ab9a87ff6ec577f2f810c900315e7f6", "message": "fix", "committedDate": "2020-05-26T06:16:02Z", "type": "commit"}]}