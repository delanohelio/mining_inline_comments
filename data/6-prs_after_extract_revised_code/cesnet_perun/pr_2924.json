{"pr_number": 2924, "pr_title": "Searching for users by strings with spaces", "pr_createdAt": "2020-10-09T09:46:10Z", "pr_url": "https://github.com/CESNET/perun/pull/2924", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM0NjI2OQ==", "url": "https://github.com/CESNET/perun/pull/2924#discussion_r502346269", "bodyText": "I am not sure if this will help. On the left side, you have data from the database. So, for example:\nfirst_name = 'Michal'\nmiddle_name = ''\nlast_name = 'Stava'\nthe operation || will join these Strings, and I expect something like 'MichalStava'. Then we expect that it should be the same as the input from the user (the variable :nameString) where I would expect something like \"Michal Stava\". So replacing spaces on the left side is ok, but shouldn't you do the same on the right side?\nSame for the other situations.\nIt looks like this works in tests below only because there is a quick fix that is doing replacing of spaces in the parameter itself.", "author": "stavamichal", "createdAt": "2020-10-09T10:50:34Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/Utils.java", "diffHunk": "@@ -1682,9 +1682,9 @@ public static void validateGroupName(String name, String regex) throws InvalidGr\n \t */\n \tpublic static String prepareUserSearchQueryExactMatch() {\n \t\tif (Compatibility.isPostgreSql()) {\n-\t\t\treturn \" lower(\"+Compatibility.convertToAscii(\"COALESCE(users.first_name,'') || COALESCE(users.middle_name,'') || COALESCE(users.last_name,'')\")+\")=:nameString\";\n+\t\t\treturn \" replace(lower(\"+Compatibility.convertToAscii(\"COALESCE(users.first_name,'') || COALESCE(users.middle_name,'') || COALESCE(users.last_name,'')\")+\"), ' ', '')=:nameString\";", "originalCommit": "92f5c2cb9fa856a8ca9318088c537aadd79465bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc3MTY2MQ==", "url": "https://github.com/CESNET/perun/pull/2924#discussion_r503771661", "bodyText": "In that case shouldn't we use lower() on the right side as well? Because only the parameter itself is turned to lower case.", "author": "cuadradek", "createdAt": "2020-10-13T08:40:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM0NjI2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc3MjcyMQ==", "url": "https://github.com/CESNET/perun/pull/2924#discussion_r503772721", "bodyText": "In my opinion, we should do the same operations (database operations) on both sides.", "author": "stavamichal", "createdAt": "2020-10-13T08:42:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM0NjI2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "3bfa8626eb87c45b6c1268944339548d45bfd4d6", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/impl/Utils.java b/perun-core/src/main/java/cz/metacentrum/perun/core/impl/Utils.java\nindex 9718bf692..e8c782d27 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/impl/Utils.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/impl/Utils.java\n\n@@ -1682,9 +1682,9 @@ public class Utils {\n \t */\n \tpublic static String prepareUserSearchQueryExactMatch() {\n \t\tif (Compatibility.isPostgreSql()) {\n-\t\t\treturn \" replace(lower(\"+Compatibility.convertToAscii(\"COALESCE(users.first_name,'') || COALESCE(users.middle_name,'') || COALESCE(users.last_name,'')\")+\"), ' ', '')=:nameString\";\n+\t\t\treturn \" replace(lower(\"+Compatibility.convertToAscii(\"COALESCE(users.first_name,'') || COALESCE(users.middle_name,'') || COALESCE(users.last_name,'')\")+\"), ' ', '')=replace(lower(:nameString), ' ', '')\";\n \t\t} else if (Compatibility.isHSQLDB()) {\n-\t\t\treturn \" replace(lower(\"+Compatibility.convertToAscii(\"COALESCE(users.first_name,'') || COALESCE(users.middle_name,'') || COALESCE(users.last_name,'')\")+\"), ' ', '')=:nameString\";\n+\t\t\treturn \" replace(lower(\"+Compatibility.convertToAscii(\"COALESCE(users.first_name,'') || COALESCE(users.middle_name,'') || COALESCE(users.last_name,'')\")+\"), ' ', '')=replace(lower(:nameString), ' ', '')\";\n \t\t} else {\n \t\t\tthrow new InternalErrorException(\"Unsupported db type\");\n \t\t}\n"}}, {"oid": "de83d1489b0d2f74d3848a1e48621063f1386a6c", "url": "https://github.com/CESNET/perun/commit/de83d1489b0d2f74d3848a1e48621063f1386a6c", "message": "Searching for users by strings with spaces\n\n- This is fix for outcome of quickfix in #2915. Quickfix caused that when\nsearching for users, who have a space in one part of name (e.g. in lastName),\nthey were not found.\n- Also when searching for user by his name in reverse order, the user was not\nfound.\n- Now when searching by similar match, both issues were fixed.\n- When searching by exact match, only the bug with spaces in one part of name\nwas fixed.\n- Tests for searching by string with a space were added too.", "committedDate": "2020-10-13T08:29:20Z", "type": "commit"}, {"oid": "3bfa8626eb87c45b6c1268944339548d45bfd4d6", "url": "https://github.com/CESNET/perun/commit/3bfa8626eb87c45b6c1268944339548d45bfd4d6", "message": "Fix based on review\n\n- The same database operations (replace, lower) are now used on both sides\nof the comparision.", "committedDate": "2020-10-13T09:03:03Z", "type": "commit"}, {"oid": "3bfa8626eb87c45b6c1268944339548d45bfd4d6", "url": "https://github.com/CESNET/perun/commit/3bfa8626eb87c45b6c1268944339548d45bfd4d6", "message": "Fix based on review\n\n- The same database operations (replace, lower) are now used on both sides\nof the comparision.", "committedDate": "2020-10-13T09:03:03Z", "type": "forcePushed"}]}