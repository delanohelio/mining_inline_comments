{"pr_number": 2761, "pr_title": "Group structure sync - additional attributes", "pr_createdAt": "2020-06-24T13:12:29Z", "pr_url": "https://github.com/CESNET/perun/pull/2761", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDkwMTk0NA==", "url": "https://github.com/CESNET/perun/pull/2761#discussion_r444901944", "bodyText": "You probably want to change name of this variable. It is a little confusing now.", "author": "stavamichal", "createdAt": "2020-06-24T13:41:38Z", "path": "perun-core/src/test/java/cz/metacentrum/perun/core/entry/GroupStructureSynchronizationIntegrationTest.java", "diffHunk": "@@ -447,6 +454,104 @@ public void removeAllGroupsTest() throws Exception {\n \t\tassertTrue(\"List of sub groups of base group should be empty!\", subGroups.isEmpty());\n \t}\n \n+\t@Test\n+\tpublic void additionalStringAttributeIsSet() throws Exception {\n+        System.out.println(CLASS_NAME + \"additionalStringAttributeIsSet\");\n+\n+\t\tAttributeDefinition loginAttrDef = setGroupAttribute(ADDITIONAL_STRING);", "originalCommit": "d0def6685ac94ac9b6da9bf8807533bc71a5475c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDkzMDg1Nw==", "url": "https://github.com/CESNET/perun/pull/2761#discussion_r444930857", "bodyText": "Yes, I do. I have changed it.", "author": "Vojtech-Sassmann", "createdAt": "2020-06-24T14:22:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDkwMTk0NA=="}], "type": "inlineReview", "revised_code": {"commit": "a010e260ed0ab6602f1636b3018d462770975840", "chunk": "diff --git a/perun-core/src/test/java/cz/metacentrum/perun/core/entry/GroupStructureSynchronizationIntegrationTest.java b/perun-core/src/test/java/cz/metacentrum/perun/core/entry/GroupStructureSynchronizationIntegrationTest.java\nindex 0b623f9f9..94e7b25a6 100644\n--- a/perun-core/src/test/java/cz/metacentrum/perun/core/entry/GroupStructureSynchronizationIntegrationTest.java\n+++ b/perun-core/src/test/java/cz/metacentrum/perun/core/entry/GroupStructureSynchronizationIntegrationTest.java\n\n@@ -458,12 +458,12 @@ public class GroupStructureSynchronizationIntegrationTest extends AbstractPerunI\n \tpublic void additionalStringAttributeIsSet() throws Exception {\n         System.out.println(CLASS_NAME + \"additionalStringAttributeIsSet\");\n \n-\t\tAttributeDefinition loginAttrDef = setGroupAttribute(ADDITIONAL_STRING);\n+\t\tAttributeDefinition additionalAttr = setGroupAttribute(ADDITIONAL_STRING);\n \n \t\t// setup\n \t\tfinal TestGroup testGroup = new TestGroup(\"createdGroup\", \"createdGroup\", null, \"group is child of base group\");\n \t\tList<Map<String, String>> subjects = Collections.singletonList(testGroup.toMap());\n-\t\tsubjects.get(0).put(loginAttrDef.getName(), \"val1\");\n+\t\tsubjects.get(0).put(additionalAttr.getName(), \"val1\");\n \t\twhen(essa.getSubjectGroups(anyMap())).thenReturn(subjects);\n \n \t\t// tested method\n"}}, {"oid": "a010e260ed0ab6602f1636b3018d462770975840", "url": "https://github.com/CESNET/perun/commit/a010e260ed0ab6602f1636b3018d462770975840", "message": "Group structure sync - additional attributes\n\n* Implemented loading of additional attributes data returned from the\nquery.\n* Now, from the extsource, it is possible to load additional attribute\ndata, if the columns have a correct name.\n* Loaded data will be set as group def attributes, other attributes\ncannot be set right now, although it is possible to load them from the\nextSourceSql.", "committedDate": "2020-06-24T14:21:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQwNjAyMg==", "url": "https://github.com/CESNET/perun/pull/2761#discussion_r445406022", "bodyText": "I would prefer to return the new resulting Map instead of just changing the input one.", "author": "balcirakpeter", "createdAt": "2020-06-25T08:50:30Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/ExtSourceSql.java", "diffHunk": "@@ -358,6 +323,94 @@ public void close() {\n \t\t}\n \t}\n \n+\t/**\n+\t * Decodes a full attribute name from the given value. For used mappings,\n+\t * see attributeNameMapping.\n+\t *\n+\t * @param value which will be mapped\n+\t * @return attribute full name\n+\t */\n+\tprivate String mapAttributeNames(String value) {\n+\t\tString[] attributeRaw = value.split(\":\", 3);\n+\t\tString attributeName = null;\n+\t\tif (!attributeNameMapping.containsKey(attributeRaw[0])) {\n+\t\t\tlog.warn(\"Unknown attribute type '{}', attributeRaw {}\", attributeRaw[0], attributeRaw);\n+\t\t} else if (!attributeNameMapping.containsKey(attributeRaw[1])) {\n+\t\t\tlog.warn(\"Unknown attribute type '{}', attributeRaw {}\", attributeRaw[1], attributeRaw);\n+\t\t} else {\n+\t\t\tattributeName = attributeNameMapping.get(attributeRaw[0]) + attributeNameMapping.get(attributeRaw[1]) +\n+\t\t\t\t\tattributeRaw[2];\n+\t\t}\n+\t\treturn attributeName;\n+\t}\n+\n+\t/**\n+\t * Add additional data from the given result set to the given map.\n+\t *\n+\t * @param map map with attributeName-value entries\n+\t * @param rs result set with attribute data\n+\t * @throws SQLException SQLException\n+\t */\n+\tprivate void addAdditionalAttributeData(Map<String, String> map, ResultSet rs) throws SQLException {", "originalCommit": "a010e260ed0ab6602f1636b3018d462770975840", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQ1OTI2Nw==", "url": "https://github.com/CESNET/perun/pull/2761#discussion_r445459267", "bodyText": "I have changed it so it returns the data.", "author": "Vojtech-Sassmann", "createdAt": "2020-06-25T10:24:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQwNjAyMg=="}], "type": "inlineReview", "revised_code": {"commit": "5c3c52de1e3b6667e03664eef5f0babedd9499b6", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/impl/ExtSourceSql.java b/perun-core/src/main/java/cz/metacentrum/perun/core/impl/ExtSourceSql.java\nindex 03b177fcc..2e6897d57 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/impl/ExtSourceSql.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/impl/ExtSourceSql.java\n\n@@ -345,13 +345,13 @@ public class ExtSourceSql extends ExtSource implements ExtSourceSimpleApi {\n \t}\n \n \t/**\n-\t * Add additional data from the given result set to the given map.\n+\t * Parse additional data from the given result set.\n \t *\n-\t * @param map map with attributeName-value entries\n \t * @param rs result set with attribute data\n \t * @throws SQLException SQLException\n \t */\n-\tprivate void addAdditionalAttributeData(Map<String, String> map, ResultSet rs) throws SQLException {\n+\tprivate Map<String, String> addAdditionalAttributeData(ResultSet rs) throws SQLException {\n+\t\tMap<String, String> additionalAttributes = new HashMap<>();\n \t\tfor (int i = 1; i <= rs.getMetaData().getColumnCount(); i++) {\n \t\t\tString columnName = rs.getMetaData().getColumnLabel(i);\n \t\t\tif (columnName.contains(\":\")) {\n"}}, {"oid": "5c3c52de1e3b6667e03664eef5f0babedd9499b6", "url": "https://github.com/CESNET/perun/commit/5c3c52de1e3b6667e03664eef5f0babedd9499b6", "message": "Group structure sync - additional attributes\n\n* Implemented loading of additional attributes data returned from the\nquery.\n* Now, from the extsource, it is possible to load additional attribute\ndata, if the columns have a correct name.\n* Loaded data will be set as group def attributes, other attributes\ncannot be set right now, although it is possible to load them from the\nextSourceSql.", "committedDate": "2020-06-25T10:22:58Z", "type": "forcePushed"}, {"oid": "6a0bf75141979af682f2e3250f698ecd962516d0", "url": "https://github.com/CESNET/perun/commit/6a0bf75141979af682f2e3250f698ecd962516d0", "message": "Group structure sync - additional attributes\n\n* Implemented loading of additional attributes data returned from the\nquery.\n* Now, from the extsource, it is possible to load additional attribute\ndata, if the columns have a correct name.\n* Loaded data will be set as group def attributes, other attributes\ncannot be set right now, although it is possible to load them from the\nextSourceSql.", "committedDate": "2020-06-25T10:24:23Z", "type": "commit"}, {"oid": "6a0bf75141979af682f2e3250f698ecd962516d0", "url": "https://github.com/CESNET/perun/commit/6a0bf75141979af682f2e3250f698ecd962516d0", "message": "Group structure sync - additional attributes\n\n* Implemented loading of additional attributes data returned from the\nquery.\n* Now, from the extsource, it is possible to load additional attribute\ndata, if the columns have a correct name.\n* Loaded data will be set as group def attributes, other attributes\ncannot be set right now, although it is possible to load them from the\nextSourceSql.", "committedDate": "2020-06-25T10:24:23Z", "type": "forcePushed"}]}