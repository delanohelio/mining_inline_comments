{"pr_number": 3025, "pr_title": "Validation window for account activation", "pr_createdAt": "2020-12-08T09:24:48Z", "pr_url": "https://github.com/CESNET/perun/pull/3025", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE4NzMxMw==", "url": "https://github.com/CESNET/perun/pull/3025#discussion_r538187313", "bodyText": "I would prefer using >=.", "author": "zlamalp", "createdAt": "2020-12-08T09:44:39Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/UsersManagerImpl.java", "diffHunk": "@@ -1280,14 +1280,12 @@ public void checkPasswordResetRequestIsValid(PerunSession sess, User user, int r\n \t\t\t\tthrow new ConsistencyErrorException(\"Password reset request \" + requestId + \" exists more than once.\");\n \t\t\t}\n \n-\t\t\tint validWindow = BeansUtils.getCoreConfig().getPwdresetValidationWindow();\n-\n \t\t\tPair<String,String> result;\n \t\t\tif (Compatibility.isPostgreSql()) {\n-\t\t\t\tresult = jdbc.queryForObject(\"select namespace, mail from pwdreset where user_id=? and id=? and (created_at > (now() - interval '\" + validWindow + \" hours'))\",\n+\t\t\t\tresult = jdbc.queryForObject(\"select namespace, mail from pwdreset where user_id=? and id=? and validity_to > now()\",", "originalCommit": "fe7531f0d20dccc614ab20451ba790ce0895b81b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIxMDgzMQ==", "url": "https://github.com/CESNET/perun/pull/3025#discussion_r538210831", "bodyText": "Fixed.", "author": "cuadradek", "createdAt": "2020-12-08T10:17:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE4NzMxMw=="}], "type": "inlineReview", "revised_code": {"commit": "ee9ec6df9bd40a60d9eb03fe53c16a30b1909a8a", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/impl/UsersManagerImpl.java b/perun-core/src/main/java/cz/metacentrum/perun/core/impl/UsersManagerImpl.java\nindex 7e12a732b..0af279e18 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/impl/UsersManagerImpl.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/impl/UsersManagerImpl.java\n\n@@ -1282,10 +1282,10 @@ public class UsersManagerImpl implements UsersManagerImplApi {\n \n \t\t\tPair<String,String> result;\n \t\t\tif (Compatibility.isPostgreSql()) {\n-\t\t\t\tresult = jdbc.queryForObject(\"select namespace, mail from pwdreset where user_id=? and id=? and validity_to > now()\",\n+\t\t\t\tresult = jdbc.queryForObject(\"select namespace, mail from pwdreset where user_id=? and id=? and validity_to >= now()\",\n \t\t\t\t\t(resultSet, i) -> new Pair<>(resultSet.getString(\"namespace\"), resultSet.getString(\"mail\")), user.getId(), requestId);\n \t\t\t} else {\n-\t\t\t\tresult =  jdbc.queryForObject(\"select namespace, mail from pwdreset where user_id=? and id=? and validity_to > SYSTIMESTAMP\",\n+\t\t\t\tresult =  jdbc.queryForObject(\"select namespace, mail from pwdreset where user_id=? and id=? and validity_to >= SYSTIMESTAMP\",\n \t\t\t\t\t(resultSet, i) -> new Pair<>(resultSet.getString(\"namespace\"), resultSet.getString(\"mail\")), user.getId(), requestId);\n \t\t\t}\n \n"}}, {"oid": "ee9ec6df9bd40a60d9eb03fe53c16a30b1909a8a", "url": "https://github.com/CESNET/perun/commit/ee9ec6df9bd40a60d9eb03fe53c16a30b1909a8a", "message": "Validation window for account activation\n\n- Links for password reset and account activation use the same logic, but account\nvalidation should have different validation window.\n- New config property was created to specify account activation validation window\nwith default value 3 days.\n- New column validity_to was added to table pwdreset to specify till when\npassword reset or account activation is valid.", "committedDate": "2020-12-08T10:15:24Z", "type": "commit"}, {"oid": "ee9ec6df9bd40a60d9eb03fe53c16a30b1909a8a", "url": "https://github.com/CESNET/perun/commit/ee9ec6df9bd40a60d9eb03fe53c16a30b1909a8a", "message": "Validation window for account activation\n\n- Links for password reset and account activation use the same logic, but account\nvalidation should have different validation window.\n- New config property was created to specify account activation validation window\nwith default value 3 days.\n- New column validity_to was added to table pwdreset to specify till when\npassword reset or account activation is valid.", "committedDate": "2020-12-08T10:15:24Z", "type": "forcePushed"}]}