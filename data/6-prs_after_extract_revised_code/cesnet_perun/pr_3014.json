{"pr_number": 3014, "pr_title": "REGISTRAR: Support editing submitted form by user", "pr_createdAt": "2020-11-30T20:40:04Z", "pr_url": "https://github.com/CESNET/perun/pull/3014", "timeline": [{"oid": "afa34af1c4432a0d9ba4f4ce76bcc4b3de8e38f1", "url": "https://github.com/CESNET/perun/commit/afa34af1c4432a0d9ba4f4ce76bcc4b3de8e38f1", "message": "REGISTRAR: Support editing submitted form by user\n\n- Added updateFormItemsData() which will update form items\n  data with new values by its IDs. Only application submitter\n  can use this.\n- Updating form items sets application state to NEW\n  and starts verification and auto-approval if possible.\n- Method updateFormItemData() used from old GUI is now\n  marked as deprecated.", "committedDate": "2020-11-30T20:38:07Z", "type": "commit"}, {"oid": "7e2f76f2cfb93003948449af020ea3a56462639b", "url": "https://github.com/CESNET/perun/commit/7e2f76f2cfb93003948449af020ea3a56462639b", "message": "Added OpenAPI specification for updateFormItemsData()", "committedDate": "2020-12-01T07:56:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzI2NjgxNw==", "url": "https://github.com/CESNET/perun/pull/3014#discussion_r533266817", "bodyText": "Just a reminder that by calling only selfAuthorizedForApplication, PERUNADMIN will not be allowed to call this method. I suppose it is ok if the whole method will be used only for perun-wui, but it could be insufficient when for example NGUI would want to use it.", "author": "balcirakpeter", "createdAt": "2020-12-01T10:07:23Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java", "diffHunk": "@@ -2552,16 +2552,71 @@ public void updateFormItemData(PerunSession sess, int appId, ApplicationFormItem\n \n \t\tif (notAllowed.contains(existingData.getFormItem().getType())) throw new RegistrarException(\"You are not allowed to modify \"+existingData.getFormItem().getType()+\" type of form items.\");\n \n+\t\tupdateFormItemData(sess, data);\n+\n+\t}\n+\n+\t@Transactional(rollbackFor = Exception.class)\n+\tpublic void updateFormItemsData(PerunSession sess, int appId, List<ApplicationFormItemData> data) throws PerunException {\n+\n+\t\tApplication app = getApplicationById(appId);\n+\n+\t\tif (app == null) throw new InternalErrorException(\"Application with ID=\"+appId+\" doesn't exist.\");\n+\n+\t\tif (!AuthzResolver.selfAuthorizedForApplication(sess, app)) {", "originalCommit": "7e2f76f2cfb93003948449af020ea3a56462639b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM2NjQ1Mw==", "url": "https://github.com/CESNET/perun/pull/3014#discussion_r533366453", "bodyText": "Thanks for the insight. Use-cases for admin gui are not yet defined, I'll let this to be decided once its needed.", "author": "zlamalp", "createdAt": "2020-12-01T12:19:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzI2NjgxNw=="}], "type": "inlineReview", "revised_code": {"commit": "68a80cc7e048c91d2da2748a485d62a260b4e818", "chunk": "diff --git a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\nindex cc96e5424..939a5eee5 100644\n--- a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\n+++ b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\n\n@@ -2545,8 +2545,8 @@ public class RegistrarManagerImpl implements RegistrarManager {\n \t\tApplication app = getApplicationById(sess, appId);\n \t\tif (AppState.APPROVED.equals(app.getState()) || AppState.REJECTED.equals(app.getState())) throw new RegistrarException(\"Form items of once approved or rejected applications can't be modified.\");\n \n-\t\tApplicationFormItemData existingData = getFormItemDataById(data.getId());\n-\t\tif (existingData == null) throw new RegistrarException(\"Form item data specified by ID: \"+ data.getId() + \" not found in the DB.\");\n+\t\tApplicationFormItemData existingData = getFormItemDataById(data.getId(), appId);\n+\t\tif (existingData == null) throw new RegistrarException(\"Form item data specified by ID: \"+ data.getId() + \" not found or doesn't belong to the application \"+appId);\n \n \t\tList<Type> notAllowed = Arrays.asList(FROM_FEDERATION_HIDDEN, FROM_FEDERATION_SHOW, USERNAME, PASSWORD, HEADING, HTML_COMMENT, SUBMIT_BUTTON, AUTO_SUBMIT_BUTTON);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzI4MzM4OQ==", "url": "https://github.com/CESNET/perun/pull/3014#discussion_r533283389", "bodyText": "I think you should check here that all of the given data is for the given application. This would allow some users to change someone else's data.", "author": "Vojtech-Sassmann", "createdAt": "2020-12-01T10:21:27Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java", "diffHunk": "@@ -2552,16 +2552,71 @@ public void updateFormItemData(PerunSession sess, int appId, ApplicationFormItem\n \n \t\tif (notAllowed.contains(existingData.getFormItem().getType())) throw new RegistrarException(\"You are not allowed to modify \"+existingData.getFormItem().getType()+\" type of form items.\");\n \n+\t\tupdateFormItemData(sess, data);\n+\n+\t}\n+\n+\t@Transactional(rollbackFor = Exception.class)\n+\tpublic void updateFormItemsData(PerunSession sess, int appId, List<ApplicationFormItemData> data) throws PerunException {\n+\n+\t\tApplication app = getApplicationById(appId);\n+\n+\t\tif (app == null) throw new InternalErrorException(\"Application with ID=\"+appId+\" doesn't exist.\");\n+\n+\t\tif (!AuthzResolver.selfAuthorizedForApplication(sess, app)) {\n+\t\t\tthrow new PrivilegeException(sess, \"updateFormItemsData\");\n+\t\t}\n+\n+\t\tif (AppState.APPROVED.equals(app.getState()) || AppState.REJECTED.equals(app.getState())) throw new RegistrarException(\"Form items of once approved or rejected applications can't be modified.\");\n+\n+\t\t// no data to change\n+\t\tif (data == null || data.isEmpty()) return;\n+\n+\t\tfor (ApplicationFormItemData dataItem : data) {", "originalCommit": "7e2f76f2cfb93003948449af020ea3a56462639b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM2NjgwNw==", "url": "https://github.com/CESNET/perun/pull/3014#discussion_r533366807", "bodyText": "Should be fixed. Now we pass also application id in order to get form item data from the DB.", "author": "zlamalp", "createdAt": "2020-12-01T12:20:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzI4MzM4OQ=="}], "type": "inlineReview", "revised_code": {"commit": "68a80cc7e048c91d2da2748a485d62a260b4e818", "chunk": "diff --git a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\nindex cc96e5424..939a5eee5 100644\n--- a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\n+++ b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\n\n@@ -2545,8 +2545,8 @@ public class RegistrarManagerImpl implements RegistrarManager {\n \t\tApplication app = getApplicationById(sess, appId);\n \t\tif (AppState.APPROVED.equals(app.getState()) || AppState.REJECTED.equals(app.getState())) throw new RegistrarException(\"Form items of once approved or rejected applications can't be modified.\");\n \n-\t\tApplicationFormItemData existingData = getFormItemDataById(data.getId());\n-\t\tif (existingData == null) throw new RegistrarException(\"Form item data specified by ID: \"+ data.getId() + \" not found in the DB.\");\n+\t\tApplicationFormItemData existingData = getFormItemDataById(data.getId(), appId);\n+\t\tif (existingData == null) throw new RegistrarException(\"Form item data specified by ID: \"+ data.getId() + \" not found or doesn't belong to the application \"+appId);\n \n \t\tList<Type> notAllowed = Arrays.asList(FROM_FEDERATION_HIDDEN, FROM_FEDERATION_SHOW, USERNAME, PASSWORD, HEADING, HTML_COMMENT, SUBMIT_BUTTON, AUTO_SUBMIT_BUTTON);\n \n"}}, {"oid": "68a80cc7e048c91d2da2748a485d62a260b4e818", "url": "https://github.com/CESNET/perun/commit/68a80cc7e048c91d2da2748a485d62a260b4e818", "message": "Check that form item belong to the application\n\n- User could send faked form items data and update\n  items of others. Now we check, that item belongs\n  to the application, upon which we perform authorization.", "committedDate": "2020-12-01T12:17:42Z", "type": "commit"}]}