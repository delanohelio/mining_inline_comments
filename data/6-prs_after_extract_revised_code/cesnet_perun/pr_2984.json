{"pr_number": 2984, "pr_title": "Method setSponsorshipForMember should validate members", "pr_createdAt": "2020-11-13T08:15:59Z", "pr_url": "https://github.com/CESNET/perun/pull/2984", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjc4ODIxMg==", "url": "https://github.com/CESNET/perun/pull/2984#discussion_r522788212", "bodyText": "This is about existing member, right? What about membership expiration? Above methods do nothing with it, so the member would be switched back to expired after midnight if his expiration date is in the past.\nAlso I'm not sure if we don't want to have also \"sync\" validation for the purpose of the tests, since it creates thread outside of the test scope (rollback), but tests passed, since they test only sponsorship validity, not members validity. @martin-kuba ?", "author": "zlamalp", "createdAt": "2020-11-13T08:26:11Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/MembersManagerBlImpl.java", "diffHunk": "@@ -2216,6 +2216,9 @@ public Member setSponsorshipForMember(PerunSession session, Member sponsoredMemb\n \t\tgetPerunBl().getAuditer().log(session, new SponsoredMemberSet(sponsoredMember));\n \t\tgetPerunBl().getAuditer().log(session, new SponsorshipEstablished(sponsoredMember, sponsor, validityTo));\n \n+\t\t//validate sponsored member in the VO (you can do it asynchronous) - if member was already valid, it will not change anything\n+\t\tvalidateMemberAsync(session, sponsoredMember);", "originalCommit": "f0157e596c213cea81064533cc04af62a003aedb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjc5MDgxMA==", "url": "https://github.com/CESNET/perun/pull/2984#discussion_r522790810", "bodyText": "Right I will check the expiration too.\nThere is no problem to do it synchronously instead, I just wanted to save the time of sponsor here.", "author": "stavamichal", "createdAt": "2020-11-13T08:28:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjc4ODIxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjg4MDc3NQ==", "url": "https://github.com/CESNET/perun/pull/2984#discussion_r522880775", "bodyText": "I changed that to copy logic from sponsorMember method.", "author": "stavamichal", "createdAt": "2020-11-13T11:04:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjc4ODIxMg=="}], "type": "inlineReview", "revised_code": {"commit": "d2f4bdc0db3b9b03edd1820d6f8412f7da3838b5", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/MembersManagerBlImpl.java b/perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/MembersManagerBlImpl.java\nindex e8f6a4847..b3be47702 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/MembersManagerBlImpl.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/MembersManagerBlImpl.java\n\n@@ -2216,8 +2216,18 @@ public class MembersManagerBlImpl implements MembersManagerBl {\n \t\tgetPerunBl().getAuditer().log(session, new SponsoredMemberSet(sponsoredMember));\n \t\tgetPerunBl().getAuditer().log(session, new SponsorshipEstablished(sponsoredMember, sponsor, validityTo));\n \n-\t\t//validate sponsored member in the VO (you can do it asynchronous) - if member was already valid, it will not change anything\n-\t\tvalidateMemberAsync(session, sponsoredMember);\n+\t\t//remove expiration and validate member\n+\t\ttry {\n+\t\t\tAttributeDefinition expiration = getPerunBl().getAttributesManagerBl().getAttributeDefinition(session, EXPIRATION);\n+\t\t\tgetPerunBl().getAttributesManagerBl().removeAttribute(session, sponsoredMember, expiration);\n+\t\t} catch (WrongAttributeAssignmentException | AttributeNotExistsException| WrongAttributeValueException | WrongReferenceAttributeValueException ex) {\n+\t\t\tthrow new InternalErrorException(\"cannot remove expiration date for sponsored member \" + sponsoredMember.getId(), ex);\n+\t\t}\n+\t\ttry {\n+\t\t\tvalidateMember(session, sponsoredMember);\n+\t\t} catch (WrongReferenceAttributeValueException | WrongAttributeValueException ex) {\n+\t\t\tthrow new InternalErrorException(\"cannot validate sponsored member \" + sponsoredMember.getId(), ex);\n+\t\t}\n \n \t\treturn sponsoredMember;\n \t}\n"}}, {"oid": "d2f4bdc0db3b9b03edd1820d6f8412f7da3838b5", "url": "https://github.com/CESNET/perun/commit/d2f4bdc0db3b9b03edd1820d6f8412f7da3838b5", "message": "Method setSponsorshipForMember should validate members\n\n - when member get new sponsor, his status in VO should be set to VALID\n again if was different (also expiration need to be removed)", "committedDate": "2020-11-13T11:03:56Z", "type": "commit"}, {"oid": "d2f4bdc0db3b9b03edd1820d6f8412f7da3838b5", "url": "https://github.com/CESNET/perun/commit/d2f4bdc0db3b9b03edd1820d6f8412f7da3838b5", "message": "Method setSponsorshipForMember should validate members\n\n - when member get new sponsor, his status in VO should be set to VALID\n again if was different (also expiration need to be removed)", "committedDate": "2020-11-13T11:03:56Z", "type": "forcePushed"}]}