{"pr_number": 2656, "pr_title": "Added method to reactivate member in group", "pr_createdAt": "2020-04-03T16:27:50Z", "pr_url": "https://github.com/CESNET/perun/pull/2656", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU3ODk0OA==", "url": "https://github.com/CESNET/perun/pull/2656#discussion_r404578948", "bodyText": "I just wonder, if setting group membership expiration to null and calling extendMembershipInGroup() wouldn't do the same job, so we could prevent code duplicity?", "author": "zlamalp", "createdAt": "2020-04-07T07:01:08Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/GroupsManagerBlImpl.java", "diffHunk": "@@ -4948,4 +4948,61 @@ private boolean isMemberInGracePeriod(Map<String, String> membershipExpirationRu\n \tpublic List<Facility> getFacilitiesWhereGroupIsAdmin(PerunSession perunSession, Group group) throws InternalErrorException {\n \t\treturn this.getGroupsManagerImpl().getFacilitiesWhereGroupIsAdmin(perunSession, group);\n \t}\n+\n+\t@Override\n+\tpublic void reactivateMember(PerunSession sess, Member member, Group group) throws InternalErrorException, MemberNotExistsException {\n+\t\tif (!isGroupMember(sess, group, member)) throw new MemberNotExistsException(\"Member does not belong to this group\");\n+\n+\t\tvalidateMemberInGroup(sess, member, group);\n+\n+\t\tAttribute membershipExpirationRulesAttribute = getMembershipExpirationRulesAttribute(sess, group);", "originalCommit": "4833eb997f8c91e8305691aa449972f7514f9497", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYwODk5Ng==", "url": "https://github.com/CESNET/perun/pull/2656#discussion_r404608996", "bodyText": "We should definitely prevent code duplicity if possible.", "author": "stavamichal", "createdAt": "2020-04-07T07:54:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU3ODk0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDcxOTI4NQ==", "url": "https://github.com/CESNET/perun/pull/2656#discussion_r404719285", "bodyText": "Yes, it would, thank you, it should be fixed now.", "author": "metodej", "createdAt": "2020-04-07T10:56:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU3ODk0OA=="}], "type": "inlineReview", "revised_code": {"commit": "cb81de7258aebd1ae5e87f038a513c27fcb1697d", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/GroupsManagerBlImpl.java b/perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/GroupsManagerBlImpl.java\nindex b6dd36978..3615512d2 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/GroupsManagerBlImpl.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/GroupsManagerBlImpl.java\n\n@@ -4955,48 +4955,11 @@ public class GroupsManagerBlImpl implements GroupsManagerBl {\n \n \t\tvalidateMemberInGroup(sess, member, group);\n \n-\t\tAttribute membershipExpirationRulesAttribute = getMembershipExpirationRulesAttribute(sess, group);\n-\t\tif (membershipExpirationRulesAttribute == null) {\n-\t\t\treturn;\n-\t\t}\n-\t\tLinkedHashMap<String, String> membershipExpirationRules = membershipExpirationRulesAttribute.valueAsMap();\n-\n-\t\tLocalDate localDate = LocalDate.now();\n-\n-\t\tString period = null;\n-\t\t// Default extension\n-\t\tif (membershipExpirationRules.get(AbstractMembershipExpirationRulesModule.membershipPeriodKeyName) != null) {\n-\t\t\tperiod = membershipExpirationRules.get(AbstractMembershipExpirationRulesModule.membershipPeriodKeyName);\n-\t\t}\n-\n-\t\ttry {\n-\t\t\tString loaPeriod = getLoaPeriod(sess, member, membershipExpirationRules, null);\n-\t\t\tif (loaPeriod != null) {\n-\t\t\t\tperiod = loaPeriod;\n-\t\t\t}\n-\t\t} catch (ExtendMembershipException e) {\n-\t\t\t// The membershipExpirationAttribute is null and so this exception should not be thrown\n-\t\t}\n-\n-\t\t// Do we extend for x months or for static date?\n-\t\tif (period != null) {\n-\t\t\tif (period.startsWith(\"+\")) {\n-\t\t\t\tlocalDate = Utils.extendDateByPeriod(localDate, period);\n-\t\t\t} else {\n-\t\t\t\t// We will extend to particular date\n-\t\t\t\tPattern p = Pattern.compile(\"([0-9]+).([0-9]+).\");\n-\t\t\t\tMatcher m = p.matcher(period);\n-\t\t\t\tif (!m.matches()) {\n-\t\t\t\t\tthrow new InternalErrorException(\"Wrong format of period in VO membershipExpirationRules attribute. Period: \" + period);\n-\t\t\t\t}\n-\t\t\t\tlocalDate = Utils.getClosestExpirationFromStaticDate(m);\n-\t\t\t}\n-\t\t}\n-\n \t\t// Get current membershipExpiration date attribute\n \t\tAttribute membershipExpirationAttribute = getMemberExpiration(sess, member, group);\n \t\t// Set new value of the membershipExpiration for the member\n-\t\tmembershipExpirationAttribute.setValue(localDate.toString());\n+\t\tmembershipExpirationAttribute.setValue(null);\n+\n \t\ttry {\n \t\t\tgetPerunBl().getAttributesManagerBl().setAttribute(sess, member, group, membershipExpirationAttribute);\n \t\t} catch (WrongAttributeValueException e) {\n"}}, {"oid": "cb81de7258aebd1ae5e87f038a513c27fcb1697d", "url": "https://github.com/CESNET/perun/commit/cb81de7258aebd1ae5e87f038a513c27fcb1697d", "message": "Added method to reactivate member in group\n\n- the method validates member and then sets membershipExpirationAttribute based on membershipExpirationRules as if he was added to group today\n- also added tests for this method", "committedDate": "2020-04-07T10:43:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTMyMTE0OQ==", "url": "https://github.com/CESNET/perun/pull/2656#discussion_r405321149", "bodyText": "If exception shouldn't be thrown (you are not expecting it), you should throw an InternalErrorException otherwise.", "author": "stavamichal", "createdAt": "2020-04-08T07:43:20Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/GroupsManagerBlImpl.java", "diffHunk": "@@ -4948,4 +4948,30 @@ private boolean isMemberInGracePeriod(Map<String, String> membershipExpirationRu\n \tpublic List<Facility> getFacilitiesWhereGroupIsAdmin(PerunSession perunSession, Group group) throws InternalErrorException {\n \t\treturn this.getGroupsManagerImpl().getFacilitiesWhereGroupIsAdmin(perunSession, group);\n \t}\n+\n+\t@Override\n+\tpublic void reactivateMember(PerunSession sess, Member member, Group group) throws InternalErrorException, MemberNotExistsException {\n+\t\tif (!isGroupMember(sess, group, member)) throw new MemberNotExistsException(\"Member does not belong to this group\");\n+\n+\t\tvalidateMemberInGroup(sess, member, group);\n+\n+\t\t// Get current membershipExpiration date attribute\n+\t\tAttribute membershipExpirationAttribute = getMemberExpiration(sess, member, group);\n+\t\t// Set new value of the membershipExpiration for the member\n+\t\tmembershipExpirationAttribute.setValue(null);\n+\n+\t\ttry {\n+\t\t\tgetPerunBl().getAttributesManagerBl().setAttribute(sess, member, group, membershipExpirationAttribute);\n+\t\t} catch (WrongAttributeValueException e) {\n+\t\t\tthrow new InternalErrorException(\"Wrong value: \" + membershipExpirationAttribute.getValue(),e);\n+\t\t} catch (WrongReferenceAttributeValueException | WrongAttributeAssignmentException e) {\n+\t\t\tthrow new InternalErrorException(e);\n+\t\t}\n+\n+\t\ttry {\n+\t\t\textendMembershipInGroup(sess, member, group);\n+\t\t} catch (ExtendMembershipException ex) {\n+\t\t\t// This exception should not be thrown for null membershipExpiration attribute", "originalCommit": "cb81de7258aebd1ae5e87f038a513c27fcb1697d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQwNjAwOQ==", "url": "https://github.com/CESNET/perun/pull/2656#discussion_r405406009", "bodyText": "Okay, it should be fixed now.", "author": "metodej", "createdAt": "2020-04-08T09:59:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTMyMTE0OQ=="}], "type": "inlineReview", "revised_code": {"commit": "98ccf5e3e43061b83f60235c990e2eb822bf8bdd", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/GroupsManagerBlImpl.java b/perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/GroupsManagerBlImpl.java\nindex 3615512d2..78b67f7f6 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/GroupsManagerBlImpl.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/GroupsManagerBlImpl.java\n\n@@ -4972,6 +4972,7 @@ public class GroupsManagerBlImpl implements GroupsManagerBl {\n \t\t\textendMembershipInGroup(sess, member, group);\n \t\t} catch (ExtendMembershipException ex) {\n \t\t\t// This exception should not be thrown for null membershipExpiration attribute\n+\t\t\tthrow new InternalErrorException(ex);\n \t\t}\n \t}\n }\n"}}, {"oid": "98ccf5e3e43061b83f60235c990e2eb822bf8bdd", "url": "https://github.com/CESNET/perun/commit/98ccf5e3e43061b83f60235c990e2eb822bf8bdd", "message": "Added method to reactivate member in group\n\n- the method validates member and then sets membershipExpirationAttribute based on membershipExpirationRules as if he was added to group today\n- also added tests for this method", "committedDate": "2020-04-08T09:56:33Z", "type": "commit"}, {"oid": "98ccf5e3e43061b83f60235c990e2eb822bf8bdd", "url": "https://github.com/CESNET/perun/commit/98ccf5e3e43061b83f60235c990e2eb822bf8bdd", "message": "Added method to reactivate member in group\n\n- the method validates member and then sets membershipExpirationAttribute based on membershipExpirationRules as if he was added to group today\n- also added tests for this method", "committedDate": "2020-04-08T09:56:33Z", "type": "forcePushed"}]}