{"pr_number": 2676, "pr_title": "remove support for multiple engines", "pr_createdAt": "2020-04-27T07:41:23Z", "pr_url": "https://github.com/CESNET/perun/pull/2676", "timeline": [{"oid": "51a51650963c872ab50adf496ad048ad087a7620", "url": "https://github.com/CESNET/perun/commit/51a51650963c872ab50adf496ad048ad087a7620", "message": "remove support for multiple engines", "committedDate": "2020-05-04T12:22:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg4Njg5MQ==", "url": "https://github.com/CESNET/perun/pull/2676#discussion_r430886891", "bodyText": "Please remove engineId variable definition from this file and its usage in EventParserImplTest. Its no longer part of passed \"event\" and it fails that event parsing test.", "author": "zlamalp", "createdAt": "2020-05-27T06:34:38Z", "path": "perun-engine/src/test/java/cz/metacentrum/perun/engine/AbstractEngineTest.java", "diffHunk": "@@ -116,15 +116,15 @@ public void setup() throws Exception {\n \t\ttask1.setService(service);\n \t\ttask1.setSchedule(LocalDateTime.now());\n \t\ttask1.setStatus(Task.TaskStatus.PLANNED);\n-\t\ttask1.setId(tasksManagerImpl.scheduleNewTask(task1, engineId));\n+\t\ttask1.setId(tasksManagerImpl.scheduleNewTask(task1));", "originalCommit": "51a51650963c872ab50adf496ad048ad087a7620", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzgzODU0Mg==", "url": "https://github.com/CESNET/perun/pull/2676#discussion_r433838542", "bodyText": "Done.", "author": "mvocu", "createdAt": "2020-06-02T12:31:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg4Njg5MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg5NDI1MQ==", "url": "https://github.com/CESNET/perun/pull/2676#discussion_r430894251", "bodyText": "Since this method is in public API with docs, that it should return all tasks for engine, it shouldn't return only those in \"processing\" state. We keep all Tasks in memory. I see the reason for this change (usage from closeTasksForEngine()), but I suggest to move implementation inside such method (since its only usage) and just remove this method from the implementation and the interface. Its not necessary now, since interface inherits TaskStore with getAllTasks(), which  (should) does the same.", "author": "zlamalp", "createdAt": "2020-05-27T06:53:12Z", "path": "perun-dispatcher/src/main/java/cz/metacentrum/perun/dispatcher/scheduling/impl/SchedulingPoolImpl.java", "diffHunk": "@@ -479,40 +452,25 @@ public void reloadTasks() {\n \t}\n \n \t@Override\n-\tpublic void setEngineMessageProducerForTask(Task task, EngineMessageProducer messageProducer) throws InternalErrorException {\n-\t\tTask found = getTask(task.getId());\n-\t\tif (found == null) {\n-\t\t\tthrow new InternalErrorException(\"no task by id \" + task.getId());\n-\t\t} else {\n-\t\t\tenginesByTaskId.put(task.getId(), messageProducer);\n-\t\t}\n-\t\t// if queue is removed, set -1 to task as it's done on task creation if queue is null\n-\t\tint queueId = (messageProducer != null) ? messageProducer.getClientID() : -1;\n-\t\ttasksManagerBl.updateTaskEngine(task, queueId);\n+\tpublic List<Task> getTasksForEngine() {", "originalCommit": "51a51650963c872ab50adf496ad048ad087a7620", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg0MTY1OQ==", "url": "https://github.com/CESNET/perun/pull/2676#discussion_r433841659", "bodyText": "Done.", "author": "mvocu", "createdAt": "2020-06-02T12:37:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg5NDI1MQ=="}], "type": "inlineReview", "revised_code": {"commit": "104e87ac2b09dba35c65145e69dde095c96aba45", "chunk": "diff --git a/perun-dispatcher/src/main/java/cz/metacentrum/perun/dispatcher/scheduling/impl/SchedulingPoolImpl.java b/perun-dispatcher/src/main/java/cz/metacentrum/perun/dispatcher/scheduling/impl/SchedulingPoolImpl.java\nindex 290fe7a1b..644da1669 100644\n--- a/perun-dispatcher/src/main/java/cz/metacentrum/perun/dispatcher/scheduling/impl/SchedulingPoolImpl.java\n+++ b/perun-dispatcher/src/main/java/cz/metacentrum/perun/dispatcher/scheduling/impl/SchedulingPoolImpl.java\n\n@@ -451,21 +451,16 @@ public class SchedulingPoolImpl implements SchedulingPool {\n \n \t}\n \n-\t@Override\n-\tpublic List<Task> getTasksForEngine() {\n-\t\treturn taskStore.getTasksWithStatus(\n-\t\t\t\t\tTaskStatus.PLANNED, \n-\t\t\t\t\tTaskStatus.GENERATING,\n-\t\t\t\t\tTaskStatus.GENERATED,\n-\t\t\t\t\tTaskStatus.SENDING\n-\t\t\t\t\t);\n-\t}\n-\n \t@Override\n \tpublic void closeTasksForEngine() {\n \n-\t\tList<Task> tasks = getTasksForEngine();\n-\n+\t\tList<Task> tasks = taskStore.getTasksWithStatus(\n+\t\t\t\tTaskStatus.PLANNED, \n+\t\t\t\tTaskStatus.GENERATING,\n+\t\t\t\tTaskStatus.GENERATED,\n+\t\t\t\tTaskStatus.SENDING\n+\t\t\t\t);\n+ \n \t\t// switch all processing tasks to error, remove the engine queue association\n \t\tlog.debug(\"Switching processing tasks on engine to ERROR, the engine went down...\");\n \t\tfor (Task task : tasks) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg5NTgxOQ==", "url": "https://github.com/CESNET/perun/pull/2676#discussion_r430895819", "bodyText": "As mentioned on impl class, this API method is probably no longer required.", "author": "zlamalp", "createdAt": "2020-05-27T06:56:44Z", "path": "perun-dispatcher/src/main/java/cz/metacentrum/perun/dispatcher/scheduling/SchedulingPool.java", "diffHunk": "@@ -79,37 +78,17 @@\n \tString getReport();\n \n \t/**\n-\t * Return EngineMessageProducer queue associated with a Task\n+\t * Get all Tasks associated with Engine.\n \t *\n-\t * @param task Task to get EngineMessageProducer for\n-\t * @return EngineMessageProducer queue or throws exception\n-\t * @throws InternalErrorException When Task has no EngineMessageProducer associated\n+\t * @return Tasks associated with Engine\n \t */\n-\tEngineMessageProducer getEngineMessageProducerForTask(Task task) throws InternalErrorException;\n-\n-\t/**\n-\t * Set EngineMessageProducer queue for a Task.\n-\t *\n-\t * @param task Task to set EngineMessageProducer queue\n-\t * @param queueForTask EngineMessageProducer queue to set\n-\t * @throws InternalErrorException When Task doesn't exists in a pool\n-\t */\n-\tvoid setEngineMessageProducerForTask(Task task, EngineMessageProducer queueForTask) throws InternalErrorException;\n-\n-\t/**\n-\t * Get all Tasks associated with Engine by its ID\n-\t *\n-\t * @param clientID ID of Engine\n-\t * @return Tasks associated with Engine by its ID\n-\t */\n-\tList<Task> getTasksForEngine(int clientID);\n+\tList<Task> getTasksForEngine();\n \n \t/**\n \t * Switch all processing Tasks to ERROR if engine was restarted.\n \t *\n-\t * @param clientID ID of Engine\n \t */\n-\tvoid closeTasksForEngine(int clientID);\n+\tvoid closeTasksForEngine();", "originalCommit": "51a51650963c872ab50adf496ad048ad087a7620", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg0Mjk0MA==", "url": "https://github.com/CESNET/perun/pull/2676#discussion_r433842940", "bodyText": "This method is called from EngineMessageProcessor.processEngineMessage().", "author": "mvocu", "createdAt": "2020-06-02T12:39:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg5NTgxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg0OTgwMw==", "url": "https://github.com/CESNET/perun/pull/2676#discussion_r434849803", "bodyText": "You are right, I marked the wrong method. It supposed to be getTasksForEngine(), which is now removed, so its OK.", "author": "zlamalp", "createdAt": "2020-06-03T20:58:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg5NTgxOQ=="}], "type": "inlineReview", "revised_code": {"commit": "104e87ac2b09dba35c65145e69dde095c96aba45", "chunk": "diff --git a/perun-dispatcher/src/main/java/cz/metacentrum/perun/dispatcher/scheduling/SchedulingPool.java b/perun-dispatcher/src/main/java/cz/metacentrum/perun/dispatcher/scheduling/SchedulingPool.java\nindex 559818c01..b882c8307 100644\n--- a/perun-dispatcher/src/main/java/cz/metacentrum/perun/dispatcher/scheduling/SchedulingPool.java\n+++ b/perun-dispatcher/src/main/java/cz/metacentrum/perun/dispatcher/scheduling/SchedulingPool.java\n\n@@ -77,13 +77,6 @@ public interface SchedulingPool extends TaskStore {\n \t */\n \tString getReport();\n \n-\t/**\n-\t * Get all Tasks associated with Engine.\n-\t *\n-\t * @return Tasks associated with Engine\n-\t */\n-\tList<Task> getTasksForEngine();\n-\n \t/**\n \t * Switch all processing Tasks to ERROR if engine was restarted.\n \t *\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkwMjY0Mg==", "url": "https://github.com/CESNET/perun/pull/2676#discussion_r430902642", "bodyText": "We must default to 1 with engine_id, since we are not changing DB schema yet and we have constraint on existing engine entry with ID=1 on each instance.", "author": "zlamalp", "createdAt": "2020-05-27T07:12:10Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/TasksManagerImpl.java", "diffHunk": "@@ -125,40 +125,25 @@ public int insertNewTaskResult(TaskResult taskResult, int engineID) throws Inter\n \t\t\t\t\"insert into tasks_results(\" +\n \t\t\t\t\t\"id, \" +\n \t\t\t\t\t\"task_id, \" +\n+\t\t\t\t\t\"engine_id, \" +\n \t\t\t\t\t\"destination_id, \" +\n \t\t\t\t\t\"status, \" +\n \t\t\t\t\t\"err_message, \" +\n \t\t\t\t\t\"std_message, \" +\n \t\t\t\t\t\"return_code, \" +\n-\t\t\t\t\t\"timestamp, \" +\n-\t\t\t\t\t\"engine_id) values (?,?,?,?,?,?,?, \" + Compatibility.toDate(\"?\",\"'DD-MM-YYYY HH24:MI:SS'\") + \" ,?)\",\n+\t\t\t\t\t\"timestamp) values (?,?,?,?,?,?,?, \" + Compatibility.toDate(\"?\",\"'DD-MM-YYYY HH24:MI:SS'\") + \")\",\n \t\t\t\tnewTaskResultId,\n \t\t\t\ttaskResult.getTaskId(),\n+\t\t\t\t0,", "originalCommit": "51a51650963c872ab50adf496ad048ad087a7620", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg0Mzc5Mw==", "url": "https://github.com/CESNET/perun/pull/2676#discussion_r433843793", "bodyText": "Fixed.", "author": "mvocu", "createdAt": "2020-06-02T12:40:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkwMjY0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "104e87ac2b09dba35c65145e69dde095c96aba45", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/impl/TasksManagerImpl.java b/perun-core/src/main/java/cz/metacentrum/perun/core/impl/TasksManagerImpl.java\nindex 8826bedb1..90e0abeb3 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/impl/TasksManagerImpl.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/impl/TasksManagerImpl.java\n\n@@ -134,7 +134,7 @@ public class TasksManagerImpl implements TasksManagerImplApi {\n \t\t\t\t\t\"timestamp) values (?,?,?,?,?,?,?, \" + Compatibility.toDate(\"?\",\"'DD-MM-YYYY HH24:MI:SS'\") + \")\",\n \t\t\t\tnewTaskResultId,\n \t\t\t\ttaskResult.getTaskId(),\n-\t\t\t\t0,\n+\t\t\t\t1,\n \t\t\t\ttaskResult.getDestinationId(),\n \t\t\t\ttaskResult.getStatus().toString(),\n \t\t\t\terrorMessage == null ? null : new String(errorMessage, StandardCharsets.UTF_8),\n"}}, {"oid": "104e87ac2b09dba35c65145e69dde095c96aba45", "url": "https://github.com/CESNET/perun/commit/104e87ac2b09dba35c65145e69dde095c96aba45", "message": "remove support for multiple engines", "committedDate": "2020-06-02T12:43:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg1MjUwNQ==", "url": "https://github.com/CESNET/perun/pull/2676#discussion_r434852505", "bodyText": "Please remove also variable definition on line 45, since its now completely unused.", "author": "zlamalp", "createdAt": "2020-06-03T21:02:13Z", "path": "perun-engine/src/test/java/cz/metacentrum/perun/engine/AbstractEngineTest.java", "diffHunk": "@@ -66,10 +66,6 @@\n \t@Before\n \tpublic void setup() throws Exception {\n \n-\t\t// determine engine ID\n-\n-\t\tengineId = Integer.parseInt(propertiesBean.getProperty(\"engine.unique.id\"));", "originalCommit": "104e87ac2b09dba35c65145e69dde095c96aba45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAzMzgzOQ==", "url": "https://github.com/CESNET/perun/pull/2676#discussion_r435033839", "bodyText": "Done", "author": "mvocu", "createdAt": "2020-06-04T07:01:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg1MjUwNQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "a6c392edfa2e24ab22a738903d024fd37063e9fb", "url": "https://github.com/CESNET/perun/commit/a6c392edfa2e24ab22a738903d024fd37063e9fb", "message": "remove support for multiple engines", "committedDate": "2020-06-04T06:58:34Z", "type": "commit"}, {"oid": "a6c392edfa2e24ab22a738903d024fd37063e9fb", "url": "https://github.com/CESNET/perun/commit/a6c392edfa2e24ab22a738903d024fd37063e9fb", "message": "remove support for multiple engines", "committedDate": "2020-06-04T06:58:34Z", "type": "forcePushed"}]}