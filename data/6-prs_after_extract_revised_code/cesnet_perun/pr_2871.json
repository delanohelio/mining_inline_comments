{"pr_number": 2871, "pr_title": "Core - new method to gen data", "pr_createdAt": "2020-08-26T10:18:52Z", "pr_url": "https://github.com/CESNET/perun/pull/2871", "timeline": [{"oid": "04a5474a741640721a0608e39ecdd13bc50f41e1", "url": "https://github.com/CESNET/perun/commit/04a5474a741640721a0608e39ecdd13bc50f41e1", "message": "Core - new method to gen data\n\n* Created a new method `getHashedHierarchicalData` that can be used to\n generate data for provisioning. It doesn't duplicated attributes data,\nwhich was a problem with the old implementation.\n* The method is meant for testing, it might change in the future.", "committedDate": "2020-08-26T10:32:33Z", "type": "forcePushed"}, {"oid": "07998616c34ab9d2d0aac1838258a68c495594d7", "url": "https://github.com/CESNET/perun/commit/07998616c34ab9d2d0aac1838258a68c495594d7", "message": "TODO", "committedDate": "2020-08-27T12:07:21Z", "type": "forcePushed"}, {"oid": "24199ebaf54073b48a59f6d9a14f68e8e2b036fd", "url": "https://github.com/CESNET/perun/commit/24199ebaf54073b48a59f6d9a14f68e8e2b036fd", "message": "Core - new method to gen data\n\n* Created a new method `getHashedHierarchicalData` that can be used to\n generate data for provisioning. It doesn't duplicated attributes data,\nwhich was a problem with the old implementation.\n* The method is meant for testing, it might change in the future.", "committedDate": "2020-08-27T15:34:07Z", "type": "forcePushed"}, {"oid": "c2faa05babe96e44e45a7474a2e2aaa1ba2ab49b", "url": "https://github.com/CESNET/perun/commit/c2faa05babe96e44e45a7474a2e2aaa1ba2ab49b", "message": "Core - new method to gen data\n\n* Created a new method `getHashedHierarchicalData` that can be used to\n generate data for provisioning. It doesn't duplicated attributes data,\nwhich was a problem with the old implementation.\n* The method is meant for testing, it might change in the future.", "committedDate": "2020-08-28T06:41:29Z", "type": "forcePushed"}, {"oid": "7f59310aa6193cfa2868982917ce3c2214861b70", "url": "https://github.com/CESNET/perun/commit/7f59310aa6193cfa2868982917ce3c2214861b70", "message": "Core - new method to gen data\n\n* Created a new method `getHashedHierarchicalData` that can be used to\n generate data for provisioning. It doesn't duplicated attributes data,\nwhich was a problem with the old implementation.\n* The method is meant for testing, it might change in the future.", "committedDate": "2020-08-28T06:43:23Z", "type": "forcePushed"}, {"oid": "e22e9f2e20a80a2a5741fb90d05091f6fd7fe082", "url": "https://github.com/CESNET/perun/commit/e22e9f2e20a80a2a5741fb90d05091f6fd7fe082", "message": "Core - new method to gen data\n\n* Created new methods `getHashedHierarchicalData` and `getHashedDataWithGroups`\nthat can be used to generate data for provisioning. It doesn't duplicate\nattributes data, which was a problem with the old implementation.\n* These methods are meant for testing, they might change in the future.\n* Created new methods in attributesManager to load attributes in a\nsingle query to increase performance.", "committedDate": "2020-08-28T09:05:38Z", "type": "forcePushed"}, {"oid": "60b1d983a5622bc75fd5839f6e4ef4dbb2dd04c5", "url": "https://github.com/CESNET/perun/commit/60b1d983a5622bc75fd5839f6e4ef4dbb2dd04c5", "message": "Core - new method to gen data\n\n* Created new methods `getHashedHierarchicalData` and `getHashedDataWithGroups`\nthat can be used to generate data for provisioning. It doesn't duplicate\nattributes data, which was a problem with the old implementation.\n* These methods are meant for testing, they might change in the future.\n* Created new methods in attributesManager to load attributes in a\nsingle query to increase performance.", "committedDate": "2020-08-28T09:10:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA0NzQ4MA==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r480047480", "bodyText": "Not service but facility.", "author": "balcirakpeter", "createdAt": "2020-08-31T10:51:42Z", "path": "perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/ServicesManagerMethod.java", "diffHunk": "@@ -525,6 +529,82 @@ public ServiceAttributes call(ApiCaller ac, Deserializer parms) throws PerunExce\n \t\t}\n \t},\n \n+\t/*#\n+\t * Generates hashed hierarchical data structure for given service and resource.", "originalCommit": "60b1d983a5622bc75fd5839f6e4ef4dbb2dd04c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0MjA2MA==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r481142060", "bodyText": "Fixed.", "author": "Vojtech-Sassmann", "createdAt": "2020-09-01T13:35:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA0NzQ4MA=="}], "type": "inlineReview", "revised_code": {"commit": "c2360fc907b21688fc99c389718c4561a6c5d1aa", "chunk": "diff --git a/perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/ServicesManagerMethod.java b/perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/ServicesManagerMethod.java\nindex 0253e3220..7212b7511 100644\n--- a/perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/ServicesManagerMethod.java\n+++ b/perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/ServicesManagerMethod.java\n\n@@ -530,7 +530,7 @@ public enum ServicesManagerMethod implements ManagerMethod {\n \t},\n \n \t/*#\n-\t * Generates hashed hierarchical data structure for given service and resource.\n+\t * Generates hashed hierarchical data structure for given service and facility.\n \t *\n \t * @param service service\n \t * @param facility facility\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA0NzczNg==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r480047736", "bodyText": "Same as previous", "author": "balcirakpeter", "createdAt": "2020-08-31T10:52:22Z", "path": "perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/ServicesManagerMethod.java", "diffHunk": "@@ -525,6 +529,82 @@ public ServiceAttributes call(ApiCaller ac, Deserializer parms) throws PerunExce\n \t\t}\n \t},\n \n+\t/*#\n+\t * Generates hashed hierarchical data structure for given service and resource.\n+\t *\n+\t * @param service service\n+\t * @param facility facility\n+\t * @param filterExpiredMembers if the generator should filter expired members\n+\t * @return generated hashed data structure\n+\t * @throw FacilityNotExistsException if there is no such facility\n+\t * @throw ServiceNotExistsException if there is no such service\n+\t * @throw PrivilegeException insufficient permissions\n+\t */\n+\t/*#\n+\t * Generates hashed hierarchical data structure for given service and resource.\n+\t *\n+\t * @param service service\n+\t * @param facility facility\n+\t * @return generated hashed data structure\n+\t * @throw FacilityNotExistsException if there is no such facility\n+\t * @throw ServiceNotExistsException if there is no such service\n+\t * @throw PrivilegeException insufficient permissions\n+\t */\n+\tgetHashedHierarchicalData {\n+\t\t@Override\n+\t\tpublic HashedGenData call(ApiCaller ac, Deserializer parms) throws PerunException {\n+\t\t\tif (parms.contains(\"filterExpiredMembers\")) {\n+\t\t\t\treturn ac.getServicesManager().getHashedHierarchicalData(ac.getSession(),\n+\t\t\t\t\t\tac.getServiceById(parms.readInt(\"service\")),\n+\t\t\t\t\t\tac.getFacilityById(parms.readInt(\"facility\")),\n+\t\t\t\t\t\tparms.readBoolean(\"filterExpiredMembers\"));\n+\t\t\t} else {\n+\t\t\t\treturn ac.getServicesManager().getHashedHierarchicalData(ac.getSession(),\n+\t\t\t\t\t\tac.getServiceById(parms.readInt(\"service\")),\n+\t\t\t\t\t\tac.getFacilityById(parms.readInt(\"facility\")),\n+\t\t\t\t\t\tfalse);\n+\t\t\t}\n+\t\t}\n+\t},\n+\n+\t/*#\n+\t * Generates hashed data with group structure for given service and resource.", "originalCommit": "60b1d983a5622bc75fd5839f6e4ef4dbb2dd04c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0MjEwOQ==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r481142109", "bodyText": "Fixed.", "author": "Vojtech-Sassmann", "createdAt": "2020-09-01T13:35:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA0NzczNg=="}], "type": "inlineReview", "revised_code": {"commit": "c2360fc907b21688fc99c389718c4561a6c5d1aa", "chunk": "diff --git a/perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/ServicesManagerMethod.java b/perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/ServicesManagerMethod.java\nindex 0253e3220..7212b7511 100644\n--- a/perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/ServicesManagerMethod.java\n+++ b/perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/ServicesManagerMethod.java\n\n@@ -530,7 +530,7 @@ public enum ServicesManagerMethod implements ManagerMethod {\n \t},\n \n \t/*#\n-\t * Generates hashed hierarchical data structure for given service and resource.\n+\t * Generates hashed hierarchical data structure for given service and facility.\n \t *\n \t * @param service service\n \t * @param facility facility\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA2NTc5OA==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r480065798", "bodyText": "service and facility", "author": "balcirakpeter", "createdAt": "2020-08-31T11:21:59Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/bl/ServicesManagerBl.java", "diffHunk": "@@ -333,6 +334,28 @@\n \t */\n \tServiceAttributes getHierarchicalData(PerunSession perunSession, Service service, Facility facility, boolean filterExpiredMembers);\n \n+\t/**\n+\t * Generates hashed hierarchical data structure for given service and resource.", "originalCommit": "60b1d983a5622bc75fd5839f6e4ef4dbb2dd04c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0MjE3OQ==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r481142179", "bodyText": "Fixed.", "author": "Vojtech-Sassmann", "createdAt": "2020-09-01T13:36:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA2NTc5OA=="}], "type": "inlineReview", "revised_code": {"commit": "d1fe8e4df1f3aa6d69a0de18c3c8728df6fa3372", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/bl/ServicesManagerBl.java b/perun-core/src/main/java/cz/metacentrum/perun/core/bl/ServicesManagerBl.java\nindex 14d8e7aa9..781a05c87 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/bl/ServicesManagerBl.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/bl/ServicesManagerBl.java\n\n@@ -337,6 +337,34 @@ public interface ServicesManagerBl {\n \t/**\n \t * Generates hashed hierarchical data structure for given service and resource.\n \t *\n+\t * attributes: {...hashes...}\n+\t * hierarchy: {\n+\t *    ** facility **\n+\t *    hashes: [...hashes...]\n+\t *    members: []\n+\t *    children: [\n+\t *      {\n+\t *        ** resource1 **\n+\t *        hashes: [...hashes...]\n+\t *        children: []\n+\t *        members: [\n+\t *          {\n+\t *            ** member 1 **\n+\t *            hashes: [...hashes...]\n+\t *          },\n+\t *          {\n+\t *            ** member 2 **\n+\t *            ...\n+\t *          }\n+\t *        ]\n+\t *      },\n+\t *      {\n+\t *        ** resource2 **\n+\t *        ...\n+\t *      }\n+\t *    ]\n+\t * }\n+\t *\n \t * @param perunSession perun session\n \t * @param service service\n \t * @param facility facility\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA2NTg4OQ==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r480065889", "bodyText": "same as above", "author": "balcirakpeter", "createdAt": "2020-08-31T11:22:11Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/bl/ServicesManagerBl.java", "diffHunk": "@@ -333,6 +334,28 @@\n \t */\n \tServiceAttributes getHierarchicalData(PerunSession perunSession, Service service, Facility facility, boolean filterExpiredMembers);\n \n+\t/**\n+\t * Generates hashed hierarchical data structure for given service and resource.\n+\t *\n+\t * @param perunSession perun session\n+\t * @param service service\n+\t * @param facility facility\n+\t * @param filterExpiredMembers if the generator should filter expired members\n+\t * @return generated hashed data structure\n+\t */\n+\tHashedGenData getHashedHierarchicalData(PerunSession perunSession, Service service, Facility facility, boolean filterExpiredMembers);\n+\n+\t/**\n+\t * Generates hashed data with group structure for given service and resource.", "originalCommit": "60b1d983a5622bc75fd5839f6e4ef4dbb2dd04c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0MjIzMw==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r481142233", "bodyText": "Fixed.", "author": "Vojtech-Sassmann", "createdAt": "2020-09-01T13:36:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA2NTg4OQ=="}], "type": "inlineReview", "revised_code": {"commit": "d1fe8e4df1f3aa6d69a0de18c3c8728df6fa3372", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/bl/ServicesManagerBl.java b/perun-core/src/main/java/cz/metacentrum/perun/core/bl/ServicesManagerBl.java\nindex 14d8e7aa9..781a05c87 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/bl/ServicesManagerBl.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/bl/ServicesManagerBl.java\n\n@@ -337,6 +337,34 @@ public interface ServicesManagerBl {\n \t/**\n \t * Generates hashed hierarchical data structure for given service and resource.\n \t *\n+\t * attributes: {...hashes...}\n+\t * hierarchy: {\n+\t *    ** facility **\n+\t *    hashes: [...hashes...]\n+\t *    members: []\n+\t *    children: [\n+\t *      {\n+\t *        ** resource1 **\n+\t *        hashes: [...hashes...]\n+\t *        children: []\n+\t *        members: [\n+\t *          {\n+\t *            ** member 1 **\n+\t *            hashes: [...hashes...]\n+\t *          },\n+\t *          {\n+\t *            ** member 2 **\n+\t *            ...\n+\t *          }\n+\t *        ]\n+\t *      },\n+\t *      {\n+\t *        ** resource2 **\n+\t *        ...\n+\t *      }\n+\t *    ]\n+\t * }\n+\t *\n \t * @param perunSession perun session\n \t * @param service service\n \t * @param facility facility\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA2NjUyMQ==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r480066521", "bodyText": "service and facility", "author": "balcirakpeter", "createdAt": "2020-08-31T11:23:36Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/api/ServicesManager.java", "diffHunk": "@@ -375,6 +375,34 @@\n \t */\n \tServiceAttributes getHierarchicalData(PerunSession perunSession, Service service, Facility facility, boolean filterExpiredMembers) throws FacilityNotExistsException, ServiceNotExistsException, PrivilegeException;\n \n+\t/**\n+\t * Generates hashed hierarchical data structure for given service and resource.", "originalCommit": "60b1d983a5622bc75fd5839f6e4ef4dbb2dd04c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0MjI3NA==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r481142274", "bodyText": "Fixed.", "author": "Vojtech-Sassmann", "createdAt": "2020-09-01T13:36:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA2NjUyMQ=="}], "type": "inlineReview", "revised_code": {"commit": "c2360fc907b21688fc99c389718c4561a6c5d1aa", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/api/ServicesManager.java b/perun-core/src/main/java/cz/metacentrum/perun/core/api/ServicesManager.java\nindex a08e2065e..6dd89e677 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/api/ServicesManager.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/api/ServicesManager.java\n\n@@ -376,7 +376,7 @@ public interface ServicesManager {\n \tServiceAttributes getHierarchicalData(PerunSession perunSession, Service service, Facility facility, boolean filterExpiredMembers) throws FacilityNotExistsException, ServiceNotExistsException, PrivilegeException;\n \n \t/**\n-\t * Generates hashed hierarchical data structure for given service and resource.\n+\t * Generates hashed hierarchical data structure for given service and facility.\n \t *\n \t * @param perunSession perun session\n \t * @param service service\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA2NjU5MQ==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r480066591", "bodyText": "same as above", "author": "balcirakpeter", "createdAt": "2020-08-31T11:23:46Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/api/ServicesManager.java", "diffHunk": "@@ -375,6 +375,34 @@\n \t */\n \tServiceAttributes getHierarchicalData(PerunSession perunSession, Service service, Facility facility, boolean filterExpiredMembers) throws FacilityNotExistsException, ServiceNotExistsException, PrivilegeException;\n \n+\t/**\n+\t * Generates hashed hierarchical data structure for given service and resource.\n+\t *\n+\t * @param perunSession perun session\n+\t * @param service service\n+\t * @param facility facility\n+\t * @param filterExpiredMembers if the generator should filter expired members\n+\t * @return generated hashed data structure\n+\t * @throws FacilityNotExistsException if there is no such facility\n+\t * @throws ServiceNotExistsException if there is no such service\n+\t * @throws PrivilegeException insufficient permissions\n+\t */\n+\tHashedGenData getHashedHierarchicalData(PerunSession perunSession, Service service, Facility facility, boolean filterExpiredMembers) throws FacilityNotExistsException, ServiceNotExistsException, PrivilegeException;\n+\n+\t/**\n+\t * Generates hashed data with group structure for given service and resource.", "originalCommit": "60b1d983a5622bc75fd5839f6e4ef4dbb2dd04c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0MjM1Mw==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r481142353", "bodyText": "Fixed.", "author": "Vojtech-Sassmann", "createdAt": "2020-09-01T13:36:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA2NjU5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "c2360fc907b21688fc99c389718c4561a6c5d1aa", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/api/ServicesManager.java b/perun-core/src/main/java/cz/metacentrum/perun/core/api/ServicesManager.java\nindex a08e2065e..6dd89e677 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/api/ServicesManager.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/api/ServicesManager.java\n\n@@ -376,7 +376,7 @@ public interface ServicesManager {\n \tServiceAttributes getHierarchicalData(PerunSession perunSession, Service service, Facility facility, boolean filterExpiredMembers) throws FacilityNotExistsException, ServiceNotExistsException, PrivilegeException;\n \n \t/**\n-\t * Generates hashed hierarchical data structure for given service and resource.\n+\t * Generates hashed hierarchical data structure for given service and facility.\n \t *\n \t * @param perunSession perun session\n \t * @param service service\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEyMjc4MQ==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r480122781", "bodyText": "This looks weird", "author": "balcirakpeter", "createdAt": "2020-08-31T13:16:34Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/AttributesManagerImpl.java", "diffHunk": "@@ -2775,6 +2901,31 @@ public void deleteAllAttributeAuthz(PerunSession sess, AttributeDefinition attri\n \t\treturn getRequiredAttributes(sess, Collections.singletonList(service), group);\n \t}\n \n+\t@Override\n+\tpublic Map<Group, List<Attribute>> getRequiredAttributesForGroups(PerunSession sess, Service service, List<Group> groups) {\n+\t\ttry {\n+\t\t\treturn jdbc.execute(\"SELECT \" + getAttributeMappingSelectQuery(\"grp\") + \", groups.id FROM attr_names \" +\n+\t\t\t\t\t\"JOIN service_required_attrs ON attr_names.id=service_required_attrs.attr_id AND service_required_attrs.service_id=? \" +\n+\t\t\t\t\t\"JOIN groups ON groups.id \" + Compatibility.getStructureForInClause() +\n+\t\t\t\t\t\"LEFT JOIN group_attr_values grp ON attr_names.id=grp.attr_id \" +\n+\t\t\t\t\t\"AND grp.group_id=groups.id WHERE namespace IN (?,?,?,?)\",\n+\t\t\t\t\t(PreparedStatementCallback<HashMap<Group, List<Attribute>>>) preparedStatement -> {\n+\t\t\t\tArray sqlArray = DatabaseManagerBl.prepareSQLArrayOfNumbers(groups, preparedStatement);\n+\t\t\t\tpreparedStatement.setInt(1, service.getId());\n+\t\t\t\tpreparedStatement.setArray(2, sqlArray);\n+\t\t\t\tpreparedStatement.setString(3, AttributesManager.NS_GROUP_ATTR_CORE);\n+\t\t\t\tpreparedStatement.setString(4, AttributesManager.NS_GROUP_ATTR_DEF);\n+\t\t\t\tpreparedStatement.setString(5, AttributesManager.NS_GROUP_ATTR_OPT);\n+\t\t\t\tpreparedStatement.setString(6, AttributesManager.NS_GROUP_ATTR_VIRT);\n+\t\t\t\tGroupAttributeExtractor groupAttributeExtractor = new GroupAttributeExtractor(sess, this, groups);\n+\t\t\t\treturn groupAttributeExtractor.extractData(preparedStatement.executeQuery());\n+\t\t\t});\n+\t\t} catch (InternalErrorException ex) {", "originalCommit": "60b1d983a5622bc75fd5839f6e4ef4dbb2dd04c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0MjQ3NA==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r481142474", "bodyText": "Removed the try block completely.", "author": "Vojtech-Sassmann", "createdAt": "2020-09-01T13:36:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEyMjc4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "c2360fc907b21688fc99c389718c4561a6c5d1aa", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/impl/AttributesManagerImpl.java b/perun-core/src/main/java/cz/metacentrum/perun/core/impl/AttributesManagerImpl.java\nindex 0c6af475b..81590d266 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/impl/AttributesManagerImpl.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/impl/AttributesManagerImpl.java\n\n@@ -2903,27 +2903,22 @@ public class AttributesManagerImpl implements AttributesManagerImplApi {\n \n \t@Override\n \tpublic Map<Group, List<Attribute>> getRequiredAttributesForGroups(PerunSession sess, Service service, List<Group> groups) {\n-\t\ttry {\n-\t\t\treturn jdbc.execute(\"SELECT \" + getAttributeMappingSelectQuery(\"grp\") + \", groups.id FROM attr_names \" +\n-\t\t\t\t\t\"JOIN service_required_attrs ON attr_names.id=service_required_attrs.attr_id AND service_required_attrs.service_id=? \" +\n-\t\t\t\t\t\"JOIN groups ON groups.id \" + Compatibility.getStructureForInClause() +\n-\t\t\t\t\t\"LEFT JOIN group_attr_values grp ON attr_names.id=grp.attr_id \" +\n-\t\t\t\t\t\"AND grp.group_id=groups.id WHERE namespace IN (?,?,?,?)\",\n-\t\t\t\t\t(PreparedStatementCallback<HashMap<Group, List<Attribute>>>) preparedStatement -> {\n-\t\t\t\tArray sqlArray = DatabaseManagerBl.prepareSQLArrayOfNumbers(groups, preparedStatement);\n-\t\t\t\tpreparedStatement.setInt(1, service.getId());\n-\t\t\t\tpreparedStatement.setArray(2, sqlArray);\n-\t\t\t\tpreparedStatement.setString(3, AttributesManager.NS_GROUP_ATTR_CORE);\n-\t\t\t\tpreparedStatement.setString(4, AttributesManager.NS_GROUP_ATTR_DEF);\n-\t\t\t\tpreparedStatement.setString(5, AttributesManager.NS_GROUP_ATTR_OPT);\n-\t\t\t\tpreparedStatement.setString(6, AttributesManager.NS_GROUP_ATTR_VIRT);\n-\t\t\t\tGroupAttributeExtractor groupAttributeExtractor = new GroupAttributeExtractor(sess, this, groups);\n-\t\t\t\treturn groupAttributeExtractor.extractData(preparedStatement.executeQuery());\n-\t\t\t});\n-\t\t} catch (InternalErrorException ex) {\n-\t\t\t//Finding or invoking oracle array method was unsuccessful\n-\t\t\tthrow new InternalErrorException(ex);\n-\t\t}\n+\t\treturn jdbc.execute(\"SELECT \" + getAttributeMappingSelectQuery(\"grp\") + \", groups.id FROM attr_names \" +\n+\t\t\t\t\"JOIN service_required_attrs ON attr_names.id=service_required_attrs.attr_id AND service_required_attrs.service_id=? \" +\n+\t\t\t\t\"JOIN groups ON groups.id \" + Compatibility.getStructureForInClause() +\n+\t\t\t\t\"LEFT JOIN group_attr_values grp ON attr_names.id=grp.attr_id \" +\n+\t\t\t\t\"AND grp.group_id=groups.id WHERE namespace IN (?,?,?,?)\",\n+\t\t\t\t(PreparedStatementCallback<HashMap<Group, List<Attribute>>>) preparedStatement -> {\n+\t\t\tArray sqlArray = DatabaseManagerBl.prepareSQLArrayOfNumbers(groups, preparedStatement);\n+\t\t\tpreparedStatement.setInt(1, service.getId());\n+\t\t\tpreparedStatement.setArray(2, sqlArray);\n+\t\t\tpreparedStatement.setString(3, AttributesManager.NS_GROUP_ATTR_CORE);\n+\t\t\tpreparedStatement.setString(4, AttributesManager.NS_GROUP_ATTR_DEF);\n+\t\t\tpreparedStatement.setString(5, AttributesManager.NS_GROUP_ATTR_OPT);\n+\t\t\tpreparedStatement.setString(6, AttributesManager.NS_GROUP_ATTR_VIRT);\n+\t\t\tGroupAttributeExtractor groupAttributeExtractor = new GroupAttributeExtractor(sess, this, groups);\n+\t\t\treturn groupAttributeExtractor.extractData(preparedStatement.executeQuery());\n+\t\t});\n \t}\n \n \t@Override\n"}}, {"oid": "c2360fc907b21688fc99c389718c4561a6c5d1aa", "url": "https://github.com/CESNET/perun/commit/c2360fc907b21688fc99c389718c4561a6c5d1aa", "message": "Core - new method to gen data\n\n* Created new methods `getHashedHierarchicalData` and `getHashedDataWithGroups`\nthat can be used to generate data for provisioning. It doesn't duplicate\nattributes data, which was a problem with the old implementation.\n* These methods are meant for testing, they might change in the future.\n* Created new methods in attributesManager to load attributes in a\nsingle query to increase performance.", "committedDate": "2020-09-01T13:35:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEwNzg4Nw==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r480107887", "bodyText": "Is there any reason to use just 1 letter from the whole name?\nH - Hashes\nC - Children\nM - Members", "author": "stavamichal", "createdAt": "2020-08-31T12:50:27Z", "path": "perun-base/src/main/java/cz/metacentrum/perun/core/api/GenDataNode.java", "diffHunk": "@@ -0,0 +1,59 @@\n+package cz.metacentrum.perun.core.api;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+/**\n+ * @author Vojtech Sassmann <vojtech.sassmann@gmail.com>\n+ */\n+public class GenDataNode {\n+\n+\tprivate final List<String> hashes;\n+\tprivate final List<GenDataNode> children;\n+\tprivate final List<GenMemberDataNode> members;\n+\n+\tprivate GenDataNode(List<String> hashes, List<GenDataNode> children, List<GenMemberDataNode> members) {\n+\t\tthis.hashes = hashes;\n+\t\tthis.children = children;\n+\t\tthis.members = members;\n+\t}\n+\n+\tpublic List<String> getH() {\n+\t\treturn Collections.unmodifiableList(hashes);\n+\t}\n+\n+\tpublic List<GenDataNode> getC() {\n+\t\treturn Collections.unmodifiableList(children);\n+\t}\n+\n+\tpublic List<GenMemberDataNode> getM() {\n+\t\treturn Collections.unmodifiableList(members);\n+\t}", "originalCommit": "60b1d983a5622bc75fd5839f6e4ef4dbb2dd04c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjAxNjU4MA==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r482016580", "bodyText": "This was done so the generated JSON file is as smallest as possible. But it's true that the getter doesn't need to be named like it. I have replaced the names in the getters with their full names and added annotations to make sure the generated file contains only the one letter keys.", "author": "Vojtech-Sassmann", "createdAt": "2020-09-02T12:05:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEwNzg4Nw=="}], "type": "inlineReview", "revised_code": {"commit": "c2360fc907b21688fc99c389718c4561a6c5d1aa", "chunk": "diff --git a/perun-base/src/main/java/cz/metacentrum/perun/core/api/GenDataNode.java b/perun-base/src/main/java/cz/metacentrum/perun/core/api/GenDataNode.java\nindex 29f1c6782..32b95ff4e 100644\n--- a/perun-base/src/main/java/cz/metacentrum/perun/core/api/GenDataNode.java\n+++ b/perun-base/src/main/java/cz/metacentrum/perun/core/api/GenDataNode.java\n\n@@ -3,6 +3,7 @@ package cz.metacentrum.perun.core.api;\n import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n+import java.util.Objects;\n \n /**\n  * @author Vojtech Sassmann <vojtech.sassmann@gmail.com>\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEwOTA1OQ==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r480109059", "bodyText": "For all new classes, you should add some Javadoc about usage.", "author": "stavamichal", "createdAt": "2020-08-31T12:52:39Z", "path": "perun-base/src/main/java/cz/metacentrum/perun/core/api/GenDataNode.java", "diffHunk": "@@ -0,0 +1,59 @@\n+package cz.metacentrum.perun.core.api;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+/**\n+ * @author Vojtech Sassmann <vojtech.sassmann@gmail.com>", "originalCommit": "60b1d983a5622bc75fd5839f6e4ef4dbb2dd04c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjAxNjY4Mg==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r482016682", "bodyText": "Added.", "author": "Vojtech-Sassmann", "createdAt": "2020-09-02T12:05:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEwOTA1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "c2360fc907b21688fc99c389718c4561a6c5d1aa", "chunk": "diff --git a/perun-base/src/main/java/cz/metacentrum/perun/core/api/GenDataNode.java b/perun-base/src/main/java/cz/metacentrum/perun/core/api/GenDataNode.java\nindex 29f1c6782..32b95ff4e 100644\n--- a/perun-base/src/main/java/cz/metacentrum/perun/core/api/GenDataNode.java\n+++ b/perun-base/src/main/java/cz/metacentrum/perun/core/api/GenDataNode.java\n\n@@ -3,6 +3,7 @@ package cz.metacentrum.perun.core.api;\n import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n+import java.util.Objects;\n \n /**\n  * @author Vojtech Sassmann <vojtech.sassmann@gmail.com>\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDExMzExMg==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r480113112", "bodyText": "Because the structure of every \"getData\" method is different, you need to define it more specifically. For example, you have different objects on different levels in the hierarchy, somewhere you are using groups, somewhere not. We need to know this information without reading the code itself. I would add this information for both methods to the entry layer, RPC, and open API.\nFor the business layer, you can use a link to the entry layer.", "author": "stavamichal", "createdAt": "2020-08-31T12:59:55Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/api/ServicesManager.java", "diffHunk": "@@ -375,6 +375,34 @@\n \t */\n \tServiceAttributes getHierarchicalData(PerunSession perunSession, Service service, Facility facility, boolean filterExpiredMembers) throws FacilityNotExistsException, ServiceNotExistsException, PrivilegeException;\n \n+\t/**\n+\t * Generates hashed hierarchical data structure for given service and resource.", "originalCommit": "60b1d983a5622bc75fd5839f6e4ef4dbb2dd04c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjAxNzIxMw==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r482017213", "bodyText": "I have added the javadoc to all places, except OpenAPI. I don't think it is necessary right now.", "author": "Vojtech-Sassmann", "createdAt": "2020-09-02T12:06:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDExMzExMg=="}], "type": "inlineReview", "revised_code": {"commit": "c2360fc907b21688fc99c389718c4561a6c5d1aa", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/api/ServicesManager.java b/perun-core/src/main/java/cz/metacentrum/perun/core/api/ServicesManager.java\nindex a08e2065e..6dd89e677 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/api/ServicesManager.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/api/ServicesManager.java\n\n@@ -376,7 +376,7 @@ public interface ServicesManager {\n \tServiceAttributes getHierarchicalData(PerunSession perunSession, Service service, Facility facility, boolean filterExpiredMembers) throws FacilityNotExistsException, ServiceNotExistsException, PrivilegeException;\n \n \t/**\n-\t * Generates hashed hierarchical data structure for given service and resource.\n+\t * Generates hashed hierarchical data structure for given service and facility.\n \t *\n \t * @param perunSession perun session\n \t * @param service service\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEyMTMzMA==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r480121330", "bodyText": "Please add tests for both these methods.", "author": "stavamichal", "createdAt": "2020-08-31T13:14:38Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/AttributesManagerBlImpl.java", "diffHunk": "@@ -3115,6 +3126,11 @@ public void deleteAttribute(PerunSession sess, AttributeDefinition attributeDefi\n \t\treturn getAttributesManagerImpl().getRequiredAttributes(sess, service, group);\n \t}\n \n+\t@Override\n+\tpublic Map<Group, List<Attribute>> getRequiredAttributesForGroups(PerunSession sess, Service service, List<Group> groups) {\n+\t\treturn getAttributesManagerImpl().getRequiredAttributesForGroups(sess, service, groups);\n+\t}\n+", "originalCommit": "60b1d983a5622bc75fd5839f6e4ef4dbb2dd04c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjAxNzI4MA==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r482017280", "bodyText": "Tests created.", "author": "Vojtech-Sassmann", "createdAt": "2020-09-02T12:06:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEyMTMzMA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEyMTg0NA==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r480121844", "bodyText": "Should you also add tests for both these methods? To at least test expected attributes are there and expected objects are in the structure?", "author": "stavamichal", "createdAt": "2020-08-31T13:15:32Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/bl/ServicesManagerBl.java", "diffHunk": "@@ -333,6 +334,28 @@\n \t */\n \tServiceAttributes getHierarchicalData(PerunSession perunSession, Service service, Facility facility, boolean filterExpiredMembers);\n \n+\t/**\n+\t * Generates hashed hierarchical data structure for given service and resource.\n+\t *\n+\t * @param perunSession perun session\n+\t * @param service service\n+\t * @param facility facility\n+\t * @param filterExpiredMembers if the generator should filter expired members\n+\t * @return generated hashed data structure\n+\t */\n+\tHashedGenData getHashedHierarchicalData(PerunSession perunSession, Service service, Facility facility, boolean filterExpiredMembers);\n+\n+\t/**\n+\t * Generates hashed data with group structure for given service and resource.\n+\t *\n+\t * @param perunSession perun session\n+\t * @param service service\n+\t * @param facility facility\n+\t * @param filterExpiredMembers if the generator should filter expired members\n+\t * @return generated hashed data structure\n+\t */\n+\tHashedGenData getHashedDataWithGroups(PerunSession perunSession, Service service, Facility facility, boolean filterExpiredMembers);", "originalCommit": "60b1d983a5622bc75fd5839f6e4ef4dbb2dd04c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjAxNzM4Ng==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r482017386", "bodyText": "Tests created.", "author": "Vojtech-Sassmann", "createdAt": "2020-09-02T12:06:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEyMTg0NA=="}], "type": "inlineReview", "revised_code": {"commit": "d1fe8e4df1f3aa6d69a0de18c3c8728df6fa3372", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/bl/ServicesManagerBl.java b/perun-core/src/main/java/cz/metacentrum/perun/core/bl/ServicesManagerBl.java\nindex 14d8e7aa9..781a05c87 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/bl/ServicesManagerBl.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/bl/ServicesManagerBl.java\n\n@@ -337,6 +337,34 @@ public interface ServicesManagerBl {\n \t/**\n \t * Generates hashed hierarchical data structure for given service and resource.\n \t *\n+\t * attributes: {...hashes...}\n+\t * hierarchy: {\n+\t *    ** facility **\n+\t *    hashes: [...hashes...]\n+\t *    members: []\n+\t *    children: [\n+\t *      {\n+\t *        ** resource1 **\n+\t *        hashes: [...hashes...]\n+\t *        children: []\n+\t *        members: [\n+\t *          {\n+\t *            ** member 1 **\n+\t *            hashes: [...hashes...]\n+\t *          },\n+\t *          {\n+\t *            ** member 2 **\n+\t *            ...\n+\t *          }\n+\t *        ]\n+\t *      },\n+\t *      {\n+\t *        ** resource2 **\n+\t *        ...\n+\t *      }\n+\t *    ]\n+\t * }\n+\t *\n \t * @param perunSession perun session\n \t * @param service service\n \t * @param facility facility\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEzMTQ5NA==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r480131494", "bodyText": "We don't need to throw InternalErrorException any more. You can skip this part.", "author": "stavamichal", "createdAt": "2020-08-31T13:29:36Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/AttributesManagerImpl.java", "diffHunk": "@@ -2440,6 +2441,30 @@ public void deleteAllAttributeAuthz(PerunSession sess, AttributeDefinition attri\n \t\t}\n \t}\n \n+\t@Override\n+\tpublic Map<Member, List<Attribute>> getRequiredAttributes(PerunSession sess, Service service, List<Member> members, Group group) {\n+\t\ttry {\n+\t\t\treturn jdbc.execute(\"SELECT \" + getAttributeMappingSelectQuery(\"mem_gr\") + \", members.id FROM attr_names \" +\n+\t\t\t\t\t\"JOIN service_required_attrs ON attr_names.id=service_required_attrs.attr_id AND service_required_attrs.service_id=? \" +\n+\t\t\t\t\t\"JOIN members ON members.id \" + Compatibility.getStructureForInClause() +\n+\t\t\t\t\t\"LEFT JOIN member_group_attr_values mem_gr ON attr_names.id=mem_gr.attr_id AND group_id=? AND member_id=members.id \" +\n+\t\t\t\t\t\"WHERE namespace IN (?,?,?)\", (PreparedStatementCallback<HashMap<Member, List<Attribute>>>) preparedStatement -> {\n+\t\t\t\tArray sqlArray = DatabaseManagerBl.prepareSQLArrayOfNumbers(members, preparedStatement);\n+\t\t\t\tpreparedStatement.setInt(1, service.getId());\n+\t\t\t\tpreparedStatement.setArray(2, sqlArray);\n+\t\t\t\tpreparedStatement.setInt(3, group.getId());\n+\t\t\t\tpreparedStatement.setString(4, AttributesManager.NS_MEMBER_GROUP_ATTR_DEF);\n+\t\t\t\tpreparedStatement.setString(5, AttributesManager.NS_MEMBER_GROUP_ATTR_OPT);\n+\t\t\t\tpreparedStatement.setString(6, AttributesManager.NS_MEMBER_GROUP_ATTR_VIRT);\n+\t\t\t\tMemberGroupAttributeExtractor memberAttributeExtractor = new MemberGroupAttributeExtractor(sess, this, members, group);\n+\t\t\t\treturn memberAttributeExtractor.extractData(preparedStatement.executeQuery());\n+\t\t\t});\n+\t\t} catch (InternalErrorException ex) {\n+\t\t\t//Finding or invoking oracle array method was unsuccessful\n+\t\t\tthrow new InternalErrorException(ex);\n+\t\t}", "originalCommit": "60b1d983a5622bc75fd5839f6e4ef4dbb2dd04c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjAxNzQyOQ==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r482017429", "bodyText": "Removed.", "author": "Vojtech-Sassmann", "createdAt": "2020-09-02T12:06:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEzMTQ5NA=="}], "type": "inlineReview", "revised_code": {"commit": "d1fe8e4df1f3aa6d69a0de18c3c8728df6fa3372", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/impl/AttributesManagerImpl.java b/perun-core/src/main/java/cz/metacentrum/perun/core/impl/AttributesManagerImpl.java\nindex 0c6af475b..915048cb4 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/impl/AttributesManagerImpl.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/impl/AttributesManagerImpl.java\n\n@@ -2443,26 +2443,21 @@ public class AttributesManagerImpl implements AttributesManagerImplApi {\n \n \t@Override\n \tpublic Map<Member, List<Attribute>> getRequiredAttributes(PerunSession sess, Service service, List<Member> members, Group group) {\n-\t\ttry {\n-\t\t\treturn jdbc.execute(\"SELECT \" + getAttributeMappingSelectQuery(\"mem_gr\") + \", members.id FROM attr_names \" +\n-\t\t\t\t\t\"JOIN service_required_attrs ON attr_names.id=service_required_attrs.attr_id AND service_required_attrs.service_id=? \" +\n-\t\t\t\t\t\"JOIN members ON members.id \" + Compatibility.getStructureForInClause() +\n-\t\t\t\t\t\"LEFT JOIN member_group_attr_values mem_gr ON attr_names.id=mem_gr.attr_id AND group_id=? AND member_id=members.id \" +\n-\t\t\t\t\t\"WHERE namespace IN (?,?,?)\", (PreparedStatementCallback<HashMap<Member, List<Attribute>>>) preparedStatement -> {\n-\t\t\t\tArray sqlArray = DatabaseManagerBl.prepareSQLArrayOfNumbers(members, preparedStatement);\n-\t\t\t\tpreparedStatement.setInt(1, service.getId());\n-\t\t\t\tpreparedStatement.setArray(2, sqlArray);\n-\t\t\t\tpreparedStatement.setInt(3, group.getId());\n-\t\t\t\tpreparedStatement.setString(4, AttributesManager.NS_MEMBER_GROUP_ATTR_DEF);\n-\t\t\t\tpreparedStatement.setString(5, AttributesManager.NS_MEMBER_GROUP_ATTR_OPT);\n-\t\t\t\tpreparedStatement.setString(6, AttributesManager.NS_MEMBER_GROUP_ATTR_VIRT);\n-\t\t\t\tMemberGroupAttributeExtractor memberAttributeExtractor = new MemberGroupAttributeExtractor(sess, this, members, group);\n-\t\t\t\treturn memberAttributeExtractor.extractData(preparedStatement.executeQuery());\n-\t\t\t});\n-\t\t} catch (InternalErrorException ex) {\n-\t\t\t//Finding or invoking oracle array method was unsuccessful\n-\t\t\tthrow new InternalErrorException(ex);\n-\t\t}\n+\t\treturn jdbc.execute(\"SELECT \" + getAttributeMappingSelectQuery(\"mem_gr\") + \", members.id FROM attr_names \" +\n+\t\t\t\t\"JOIN service_required_attrs ON attr_names.id=service_required_attrs.attr_id AND service_required_attrs.service_id=? \" +\n+\t\t\t\t\"JOIN members ON members.id \" + Compatibility.getStructureForInClause() +\n+\t\t\t\t\"LEFT JOIN member_group_attr_values mem_gr ON attr_names.id=mem_gr.attr_id AND group_id=? AND member_id=members.id \" +\n+\t\t\t\t\"WHERE namespace IN (?,?,?)\", (PreparedStatementCallback<HashMap<Member, List<Attribute>>>) preparedStatement -> {\n+\t\t\tArray sqlArray = DatabaseManagerBl.prepareSQLArrayOfNumbers(members, preparedStatement);\n+\t\t\tpreparedStatement.setInt(1, service.getId());\n+\t\t\tpreparedStatement.setArray(2, sqlArray);\n+\t\t\tpreparedStatement.setInt(3, group.getId());\n+\t\t\tpreparedStatement.setString(4, AttributesManager.NS_MEMBER_GROUP_ATTR_DEF);\n+\t\t\tpreparedStatement.setString(5, AttributesManager.NS_MEMBER_GROUP_ATTR_OPT);\n+\t\t\tpreparedStatement.setString(6, AttributesManager.NS_MEMBER_GROUP_ATTR_VIRT);\n+\t\t\tMemberGroupAttributeExtractor memberAttributeExtractor = new MemberGroupAttributeExtractor(sess, this, members, group);\n+\t\t\treturn memberAttributeExtractor.extractData(preparedStatement.executeQuery());\n+\t\t});\n \t}\n \n \t@Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEzMTU3NQ==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r480131575", "bodyText": "We don't need to throw InternalErrorException any more. You can skip this part.", "author": "stavamichal", "createdAt": "2020-08-31T13:29:44Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/AttributesManagerImpl.java", "diffHunk": "@@ -2775,6 +2901,31 @@ public void deleteAllAttributeAuthz(PerunSession sess, AttributeDefinition attri\n \t\treturn getRequiredAttributes(sess, Collections.singletonList(service), group);\n \t}\n \n+\t@Override\n+\tpublic Map<Group, List<Attribute>> getRequiredAttributesForGroups(PerunSession sess, Service service, List<Group> groups) {\n+\t\ttry {\n+\t\t\treturn jdbc.execute(\"SELECT \" + getAttributeMappingSelectQuery(\"grp\") + \", groups.id FROM attr_names \" +\n+\t\t\t\t\t\"JOIN service_required_attrs ON attr_names.id=service_required_attrs.attr_id AND service_required_attrs.service_id=? \" +\n+\t\t\t\t\t\"JOIN groups ON groups.id \" + Compatibility.getStructureForInClause() +\n+\t\t\t\t\t\"LEFT JOIN group_attr_values grp ON attr_names.id=grp.attr_id \" +\n+\t\t\t\t\t\"AND grp.group_id=groups.id WHERE namespace IN (?,?,?,?)\",\n+\t\t\t\t\t(PreparedStatementCallback<HashMap<Group, List<Attribute>>>) preparedStatement -> {\n+\t\t\t\tArray sqlArray = DatabaseManagerBl.prepareSQLArrayOfNumbers(groups, preparedStatement);\n+\t\t\t\tpreparedStatement.setInt(1, service.getId());\n+\t\t\t\tpreparedStatement.setArray(2, sqlArray);\n+\t\t\t\tpreparedStatement.setString(3, AttributesManager.NS_GROUP_ATTR_CORE);\n+\t\t\t\tpreparedStatement.setString(4, AttributesManager.NS_GROUP_ATTR_DEF);\n+\t\t\t\tpreparedStatement.setString(5, AttributesManager.NS_GROUP_ATTR_OPT);\n+\t\t\t\tpreparedStatement.setString(6, AttributesManager.NS_GROUP_ATTR_VIRT);\n+\t\t\t\tGroupAttributeExtractor groupAttributeExtractor = new GroupAttributeExtractor(sess, this, groups);\n+\t\t\t\treturn groupAttributeExtractor.extractData(preparedStatement.executeQuery());\n+\t\t\t});\n+\t\t} catch (InternalErrorException ex) {\n+\t\t\t//Finding or invoking oracle array method was unsuccessful\n+\t\t\tthrow new InternalErrorException(ex);\n+\t\t}", "originalCommit": "60b1d983a5622bc75fd5839f6e4ef4dbb2dd04c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjAxNzQ1OQ==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r482017459", "bodyText": "Removed.", "author": "Vojtech-Sassmann", "createdAt": "2020-09-02T12:07:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEzMTU3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "c2360fc907b21688fc99c389718c4561a6c5d1aa", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/impl/AttributesManagerImpl.java b/perun-core/src/main/java/cz/metacentrum/perun/core/impl/AttributesManagerImpl.java\nindex 0c6af475b..81590d266 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/impl/AttributesManagerImpl.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/impl/AttributesManagerImpl.java\n\n@@ -2903,27 +2903,22 @@ public class AttributesManagerImpl implements AttributesManagerImplApi {\n \n \t@Override\n \tpublic Map<Group, List<Attribute>> getRequiredAttributesForGroups(PerunSession sess, Service service, List<Group> groups) {\n-\t\ttry {\n-\t\t\treturn jdbc.execute(\"SELECT \" + getAttributeMappingSelectQuery(\"grp\") + \", groups.id FROM attr_names \" +\n-\t\t\t\t\t\"JOIN service_required_attrs ON attr_names.id=service_required_attrs.attr_id AND service_required_attrs.service_id=? \" +\n-\t\t\t\t\t\"JOIN groups ON groups.id \" + Compatibility.getStructureForInClause() +\n-\t\t\t\t\t\"LEFT JOIN group_attr_values grp ON attr_names.id=grp.attr_id \" +\n-\t\t\t\t\t\"AND grp.group_id=groups.id WHERE namespace IN (?,?,?,?)\",\n-\t\t\t\t\t(PreparedStatementCallback<HashMap<Group, List<Attribute>>>) preparedStatement -> {\n-\t\t\t\tArray sqlArray = DatabaseManagerBl.prepareSQLArrayOfNumbers(groups, preparedStatement);\n-\t\t\t\tpreparedStatement.setInt(1, service.getId());\n-\t\t\t\tpreparedStatement.setArray(2, sqlArray);\n-\t\t\t\tpreparedStatement.setString(3, AttributesManager.NS_GROUP_ATTR_CORE);\n-\t\t\t\tpreparedStatement.setString(4, AttributesManager.NS_GROUP_ATTR_DEF);\n-\t\t\t\tpreparedStatement.setString(5, AttributesManager.NS_GROUP_ATTR_OPT);\n-\t\t\t\tpreparedStatement.setString(6, AttributesManager.NS_GROUP_ATTR_VIRT);\n-\t\t\t\tGroupAttributeExtractor groupAttributeExtractor = new GroupAttributeExtractor(sess, this, groups);\n-\t\t\t\treturn groupAttributeExtractor.extractData(preparedStatement.executeQuery());\n-\t\t\t});\n-\t\t} catch (InternalErrorException ex) {\n-\t\t\t//Finding or invoking oracle array method was unsuccessful\n-\t\t\tthrow new InternalErrorException(ex);\n-\t\t}\n+\t\treturn jdbc.execute(\"SELECT \" + getAttributeMappingSelectQuery(\"grp\") + \", groups.id FROM attr_names \" +\n+\t\t\t\t\"JOIN service_required_attrs ON attr_names.id=service_required_attrs.attr_id AND service_required_attrs.service_id=? \" +\n+\t\t\t\t\"JOIN groups ON groups.id \" + Compatibility.getStructureForInClause() +\n+\t\t\t\t\"LEFT JOIN group_attr_values grp ON attr_names.id=grp.attr_id \" +\n+\t\t\t\t\"AND grp.group_id=groups.id WHERE namespace IN (?,?,?,?)\",\n+\t\t\t\t(PreparedStatementCallback<HashMap<Group, List<Attribute>>>) preparedStatement -> {\n+\t\t\tArray sqlArray = DatabaseManagerBl.prepareSQLArrayOfNumbers(groups, preparedStatement);\n+\t\t\tpreparedStatement.setInt(1, service.getId());\n+\t\t\tpreparedStatement.setArray(2, sqlArray);\n+\t\t\tpreparedStatement.setString(3, AttributesManager.NS_GROUP_ATTR_CORE);\n+\t\t\tpreparedStatement.setString(4, AttributesManager.NS_GROUP_ATTR_DEF);\n+\t\t\tpreparedStatement.setString(5, AttributesManager.NS_GROUP_ATTR_OPT);\n+\t\t\tpreparedStatement.setString(6, AttributesManager.NS_GROUP_ATTR_VIRT);\n+\t\t\tGroupAttributeExtractor groupAttributeExtractor = new GroupAttributeExtractor(sess, this, groups);\n+\t\t\treturn groupAttributeExtractor.extractData(preparedStatement.executeQuery());\n+\t\t});\n \t}\n \n \t@Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEzNDY1Mg==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r480134652", "bodyText": "For the given members and the given group.", "author": "stavamichal", "createdAt": "2020-08-31T13:34:49Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/implApi/AttributesManagerImplApi.java", "diffHunk": "@@ -1312,6 +1312,19 @@\n \t */\n \tList<Attribute> getRequiredAttributes(PerunSession sess, Service service, Member member, Group group);\n \n+\t/**\n+\t * Get member-group attributes which are required by the service, for given members.", "originalCommit": "60b1d983a5622bc75fd5839f6e4ef4dbb2dd04c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjAxNzUxMw==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r482017513", "bodyText": "Fixed.", "author": "Vojtech-Sassmann", "createdAt": "2020-09-02T12:07:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEzNDY1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "d1fe8e4df1f3aa6d69a0de18c3c8728df6fa3372", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/implApi/AttributesManagerImplApi.java b/perun-core/src/main/java/cz/metacentrum/perun/core/implApi/AttributesManagerImplApi.java\nindex ca301c482..c1ed22011 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/implApi/AttributesManagerImplApi.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/implApi/AttributesManagerImplApi.java\n\n@@ -1313,7 +1313,7 @@ public interface AttributesManagerImplApi {\n \tList<Attribute> getRequiredAttributes(PerunSession sess, Service service, Member member, Group group);\n \n \t/**\n-\t * Get member-group attributes which are required by the service, for given members.\n+\t * Get member-group attributes which are required by the service, for the given members and the given group.\n \t *\n \t * @param sess perun session\n \t * @param members you get attributes for this member and the group\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTEyMjEwNg==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r481122106", "bodyText": "I don't think there is a good reason to separate this line.", "author": "stavamichal", "createdAt": "2020-09-01T13:05:45Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java", "diffHunk": "@@ -0,0 +1,358 @@\n+package cz.metacentrum.perun.core.provisioning;\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.Facility;\n+import cz.metacentrum.perun.core.api.Group;\n+import cz.metacentrum.perun.core.api.Member;\n+import cz.metacentrum.perun.core.api.Resource;\n+import cz.metacentrum.perun.core.api.Service;\n+import cz.metacentrum.perun.core.api.User;\n+import cz.metacentrum.perun.core.api.Vo;\n+import cz.metacentrum.perun.core.api.exceptions.GroupResourceMismatchException;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.MemberGroupMismatchException;\n+import cz.metacentrum.perun.core.api.exceptions.VoNotExistsException;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.function.Function;\n+\n+import static java.util.Collections.emptyList;\n+import static java.util.Collections.singletonList;\n+import static java.util.stream.Collectors.toList;\n+import static java.util.stream.Collectors.toMap;\n+\n+/**\n+ * @author Vojtech Sassmann <vojtech.sassmann@gmail.com>\n+ */\n+public class GenDataProviderImpl implements GenDataProvider {\n+\n+\tprivate final PerunSessionImpl sess;\n+\tprivate final Service service;\n+\tprivate final Facility facility;\n+\n+\tprivate final Map<String, List<Attribute>> attributesByHash = new HashMap<>();\n+\n+\tprivate List<Attribute> facilityAttrs;\n+\n+\t/**\n+\t * Map of Member-Resource attributes. This map is overwritten when data for new resource are loaded!!!\n+\t */\n+\tprivate Map<Member, List<Attribute>> memberResourceAttrs = new HashMap<>();\n+\n+\t/**\n+\t * Map of Group-Resource attributes. This map is overwritten when data for new resource are loaded!!!\n+\t */\n+\tprivate Map<Group, List<Attribute>> groupResourceAttrs = new HashMap<>();\n+\n+\t/**\n+\t * Map of Member-Group attributes. This map is overwritten when data for new group are loaded!!!\n+\t */\n+\tprivate Map<Member, List<Attribute>> memberGroupAttrs = new HashMap<>();\n+\n+\t/**\n+\t * These maps are not overwritten, because they do not depend on currently loaded entities.\n+\t */\n+\tprivate final Map<Member, List<Attribute>> memberAttrs = new HashMap<>();\n+\tprivate final Map<Group, List<Attribute>> groupAttrs = new HashMap<>();\n+\tprivate final Map<User, List<Attribute>> userAttrs = new HashMap<>();\n+\tprivate final Map<User, List<Attribute>> userFacilityAttrs = new HashMap<>();\n+\tprivate final Map<Resource, List<Attribute>> resourceAttrs = new HashMap<>();\n+\n+\t/**\n+\t * Vos has to contain only ids, or only vos loaded from DB. Because of the equals and hashCode\n+\t * implementations. If they were mixed, it would cause data duplicity.\n+\t */\n+\tprivate final Map<Vo, List<Attribute>> voAttrs = new HashMap<>();\n+\n+\tprivate Group lastLoadedGroup;\n+\tprivate Resource lastLoadedResource;\n+\n+\tprivate final Map<Integer, User> loadedUsersById = new HashMap<>();\n+\tprivate final Set<Member> processedMembers = new HashSet<>();\n+\tprivate final Set<Group> processedGroups = new HashSet<>();\n+\n+\tprivate final Hasher hasher = new IdHasher();\n+\n+\tpublic GenDataProviderImpl(PerunSessionImpl sess, Service service, Facility facility) {\n+\t\tthis.sess = sess;\n+\t\tthis.service = service;\n+\t\tthis.facility = facility;\n+\t}\n+\n+\t@Override\n+\tpublic void loadFacilityAttributes() {\n+\t\tfacilityAttrs =\n+\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, facility);", "originalCommit": "60b1d983a5622bc75fd5839f6e4ef4dbb2dd04c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjAxNzU3NA==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r482017574", "bodyText": "Fixed.", "author": "Vojtech-Sassmann", "createdAt": "2020-09-02T12:07:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTEyMjEwNg=="}], "type": "inlineReview", "revised_code": {"commit": "d1fe8e4df1f3aa6d69a0de18c3c8728df6fa3372", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java b/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java\nindex be3dece02..a781abde7 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java\n\n@@ -87,13 +87,13 @@ public class GenDataProviderImpl implements GenDataProvider {\n \n \t@Override\n \tpublic void loadFacilityAttributes() {\n-\t\tfacilityAttrs =\n-\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, facility);\n+\t\tfacilityAttrs = sess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, facility);\n \t}\n \n \t@Override\n \tpublic void loadGroupsAttributes(Resource resource, List<Group> groups) {\n \t\tgroupResourceAttrs = new HashMap<>();\n+\t\tlastLoadedResource = resource;\n \n \t\tfor (Group group: groups) {\n \t\t\ttry {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTEyNjI5Ng==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r481126296", "bodyText": "You would probably want to use list of notYetProcessedGroups here instead of list of groups.", "author": "stavamichal", "createdAt": "2020-09-01T13:12:24Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java", "diffHunk": "@@ -0,0 +1,358 @@\n+package cz.metacentrum.perun.core.provisioning;\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.Facility;\n+import cz.metacentrum.perun.core.api.Group;\n+import cz.metacentrum.perun.core.api.Member;\n+import cz.metacentrum.perun.core.api.Resource;\n+import cz.metacentrum.perun.core.api.Service;\n+import cz.metacentrum.perun.core.api.User;\n+import cz.metacentrum.perun.core.api.Vo;\n+import cz.metacentrum.perun.core.api.exceptions.GroupResourceMismatchException;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.MemberGroupMismatchException;\n+import cz.metacentrum.perun.core.api.exceptions.VoNotExistsException;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.function.Function;\n+\n+import static java.util.Collections.emptyList;\n+import static java.util.Collections.singletonList;\n+import static java.util.stream.Collectors.toList;\n+import static java.util.stream.Collectors.toMap;\n+\n+/**\n+ * @author Vojtech Sassmann <vojtech.sassmann@gmail.com>\n+ */\n+public class GenDataProviderImpl implements GenDataProvider {\n+\n+\tprivate final PerunSessionImpl sess;\n+\tprivate final Service service;\n+\tprivate final Facility facility;\n+\n+\tprivate final Map<String, List<Attribute>> attributesByHash = new HashMap<>();\n+\n+\tprivate List<Attribute> facilityAttrs;\n+\n+\t/**\n+\t * Map of Member-Resource attributes. This map is overwritten when data for new resource are loaded!!!\n+\t */\n+\tprivate Map<Member, List<Attribute>> memberResourceAttrs = new HashMap<>();\n+\n+\t/**\n+\t * Map of Group-Resource attributes. This map is overwritten when data for new resource are loaded!!!\n+\t */\n+\tprivate Map<Group, List<Attribute>> groupResourceAttrs = new HashMap<>();\n+\n+\t/**\n+\t * Map of Member-Group attributes. This map is overwritten when data for new group are loaded!!!\n+\t */\n+\tprivate Map<Member, List<Attribute>> memberGroupAttrs = new HashMap<>();\n+\n+\t/**\n+\t * These maps are not overwritten, because they do not depend on currently loaded entities.\n+\t */\n+\tprivate final Map<Member, List<Attribute>> memberAttrs = new HashMap<>();\n+\tprivate final Map<Group, List<Attribute>> groupAttrs = new HashMap<>();\n+\tprivate final Map<User, List<Attribute>> userAttrs = new HashMap<>();\n+\tprivate final Map<User, List<Attribute>> userFacilityAttrs = new HashMap<>();\n+\tprivate final Map<Resource, List<Attribute>> resourceAttrs = new HashMap<>();\n+\n+\t/**\n+\t * Vos has to contain only ids, or only vos loaded from DB. Because of the equals and hashCode\n+\t * implementations. If they were mixed, it would cause data duplicity.\n+\t */\n+\tprivate final Map<Vo, List<Attribute>> voAttrs = new HashMap<>();\n+\n+\tprivate Group lastLoadedGroup;\n+\tprivate Resource lastLoadedResource;\n+\n+\tprivate final Map<Integer, User> loadedUsersById = new HashMap<>();\n+\tprivate final Set<Member> processedMembers = new HashSet<>();\n+\tprivate final Set<Group> processedGroups = new HashSet<>();\n+\n+\tprivate final Hasher hasher = new IdHasher();\n+\n+\tpublic GenDataProviderImpl(PerunSessionImpl sess, Service service, Facility facility) {\n+\t\tthis.sess = sess;\n+\t\tthis.service = service;\n+\t\tthis.facility = facility;\n+\t}\n+\n+\t@Override\n+\tpublic void loadFacilityAttributes() {\n+\t\tfacilityAttrs =\n+\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, facility);\n+\t}\n+\n+\t@Override\n+\tpublic void loadGroupsAttributes(Resource resource, List<Group> groups) {\n+\t\tgroupResourceAttrs = new HashMap<>();\n+\n+\t\tfor (Group group: groups) {\n+\t\t\ttry {\n+\t\t\t\t// FIXME - attributes could be loaded at once to get a better performance\n+\t\t\t\tgroupResourceAttrs.put(group,\n+\t\t\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, resource, group));\n+\t\t\t} catch (GroupResourceMismatchException e) {\n+\t\t\t\tthrow new InternalErrorException(e);\n+\t\t\t}\n+\t\t}\n+\n+\t\tList<Group> notYetProcessedGroups = new ArrayList<>(groups);\n+\t\tnotYetProcessedGroups.removeAll(processedGroups);\n+\t\tprocessedGroups.addAll(notYetProcessedGroups);\n+\n+\t\tgroupAttrs.putAll(\n+\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributesForGroups(sess, service, groups)", "originalCommit": "60b1d983a5622bc75fd5839f6e4ef4dbb2dd04c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjAxNzY0OQ==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r482017649", "bodyText": "Yes, fixed.", "author": "Vojtech-Sassmann", "createdAt": "2020-09-02T12:07:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTEyNjI5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "d1fe8e4df1f3aa6d69a0de18c3c8728df6fa3372", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java b/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java\nindex be3dece02..a781abde7 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java\n\n@@ -87,13 +87,13 @@ public class GenDataProviderImpl implements GenDataProvider {\n \n \t@Override\n \tpublic void loadFacilityAttributes() {\n-\t\tfacilityAttrs =\n-\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, facility);\n+\t\tfacilityAttrs = sess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, facility);\n \t}\n \n \t@Override\n \tpublic void loadGroupsAttributes(Resource resource, List<Group> groups) {\n \t\tgroupResourceAttrs = new HashMap<>();\n+\t\tlastLoadedResource = resource;\n \n \t\tfor (Group group: groups) {\n \t\t\ttry {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTgxNjU2Nw==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r481816567", "bodyText": "There is probably missing assigning of actual processed resource object to variable lastLoadedResource.", "author": "stavamichal", "createdAt": "2020-09-02T07:11:40Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java", "diffHunk": "@@ -0,0 +1,358 @@\n+package cz.metacentrum.perun.core.provisioning;\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.Facility;\n+import cz.metacentrum.perun.core.api.Group;\n+import cz.metacentrum.perun.core.api.Member;\n+import cz.metacentrum.perun.core.api.Resource;\n+import cz.metacentrum.perun.core.api.Service;\n+import cz.metacentrum.perun.core.api.User;\n+import cz.metacentrum.perun.core.api.Vo;\n+import cz.metacentrum.perun.core.api.exceptions.GroupResourceMismatchException;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.MemberGroupMismatchException;\n+import cz.metacentrum.perun.core.api.exceptions.VoNotExistsException;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.function.Function;\n+\n+import static java.util.Collections.emptyList;\n+import static java.util.Collections.singletonList;\n+import static java.util.stream.Collectors.toList;\n+import static java.util.stream.Collectors.toMap;\n+\n+/**\n+ * @author Vojtech Sassmann <vojtech.sassmann@gmail.com>\n+ */\n+public class GenDataProviderImpl implements GenDataProvider {\n+\n+\tprivate final PerunSessionImpl sess;\n+\tprivate final Service service;\n+\tprivate final Facility facility;\n+\n+\tprivate final Map<String, List<Attribute>> attributesByHash = new HashMap<>();\n+\n+\tprivate List<Attribute> facilityAttrs;\n+\n+\t/**\n+\t * Map of Member-Resource attributes. This map is overwritten when data for new resource are loaded!!!\n+\t */\n+\tprivate Map<Member, List<Attribute>> memberResourceAttrs = new HashMap<>();\n+\n+\t/**\n+\t * Map of Group-Resource attributes. This map is overwritten when data for new resource are loaded!!!\n+\t */\n+\tprivate Map<Group, List<Attribute>> groupResourceAttrs = new HashMap<>();\n+\n+\t/**\n+\t * Map of Member-Group attributes. This map is overwritten when data for new group are loaded!!!\n+\t */\n+\tprivate Map<Member, List<Attribute>> memberGroupAttrs = new HashMap<>();\n+\n+\t/**\n+\t * These maps are not overwritten, because they do not depend on currently loaded entities.\n+\t */\n+\tprivate final Map<Member, List<Attribute>> memberAttrs = new HashMap<>();\n+\tprivate final Map<Group, List<Attribute>> groupAttrs = new HashMap<>();\n+\tprivate final Map<User, List<Attribute>> userAttrs = new HashMap<>();\n+\tprivate final Map<User, List<Attribute>> userFacilityAttrs = new HashMap<>();\n+\tprivate final Map<Resource, List<Attribute>> resourceAttrs = new HashMap<>();\n+\n+\t/**\n+\t * Vos has to contain only ids, or only vos loaded from DB. Because of the equals and hashCode\n+\t * implementations. If they were mixed, it would cause data duplicity.\n+\t */\n+\tprivate final Map<Vo, List<Attribute>> voAttrs = new HashMap<>();\n+\n+\tprivate Group lastLoadedGroup;\n+\tprivate Resource lastLoadedResource;\n+\n+\tprivate final Map<Integer, User> loadedUsersById = new HashMap<>();\n+\tprivate final Set<Member> processedMembers = new HashSet<>();\n+\tprivate final Set<Group> processedGroups = new HashSet<>();\n+\n+\tprivate final Hasher hasher = new IdHasher();\n+\n+\tpublic GenDataProviderImpl(PerunSessionImpl sess, Service service, Facility facility) {\n+\t\tthis.sess = sess;\n+\t\tthis.service = service;\n+\t\tthis.facility = facility;\n+\t}\n+\n+\t@Override\n+\tpublic void loadFacilityAttributes() {\n+\t\tfacilityAttrs =\n+\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, facility);\n+\t}\n+\n+\t@Override\n+\tpublic void loadGroupsAttributes(Resource resource, List<Group> groups) {\n+\t\tgroupResourceAttrs = new HashMap<>();\n+\n+\t\tfor (Group group: groups) {\n+\t\t\ttry {\n+\t\t\t\t// FIXME - attributes could be loaded at once to get a better performance\n+\t\t\t\tgroupResourceAttrs.put(group,\n+\t\t\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, resource, group));\n+\t\t\t} catch (GroupResourceMismatchException e) {\n+\t\t\t\tthrow new InternalErrorException(e);\n+\t\t\t}\n+\t\t}\n+\n+\t\tList<Group> notYetProcessedGroups = new ArrayList<>(groups);\n+\t\tnotYetProcessedGroups.removeAll(processedGroups);\n+\t\tprocessedGroups.addAll(notYetProcessedGroups);\n+\n+\t\tgroupAttrs.putAll(\n+\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributesForGroups(sess, service, groups)\n+\t\t);", "originalCommit": "c2360fc907b21688fc99c389718c4561a6c5d1aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjAxNzcxOA==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r482017718", "bodyText": "Yes, fixed.", "author": "Vojtech-Sassmann", "createdAt": "2020-09-02T12:07:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTgxNjU2Nw=="}], "type": "inlineReview", "revised_code": {"commit": "d1fe8e4df1f3aa6d69a0de18c3c8728df6fa3372", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java b/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java\nindex be3dece02..a781abde7 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java\n\n@@ -87,13 +87,13 @@ public class GenDataProviderImpl implements GenDataProvider {\n \n \t@Override\n \tpublic void loadFacilityAttributes() {\n-\t\tfacilityAttrs =\n-\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, facility);\n+\t\tfacilityAttrs = sess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, facility);\n \t}\n \n \t@Override\n \tpublic void loadGroupsAttributes(Resource resource, List<Group> groups) {\n \t\tgroupResourceAttrs = new HashMap<>();\n+\t\tlastLoadedResource = resource;\n \n \t\tfor (Group group: groups) {\n \t\t\ttry {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTgyNDI4Mw==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r481824283", "bodyText": "This is misleading. This VO is not really a fake. In my opinion, fake means that such an ID does not exist at all. This is just uncomplete VO object with only the ID set.", "author": "stavamichal", "createdAt": "2020-09-02T07:20:59Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java", "diffHunk": "@@ -0,0 +1,358 @@\n+package cz.metacentrum.perun.core.provisioning;\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.Facility;\n+import cz.metacentrum.perun.core.api.Group;\n+import cz.metacentrum.perun.core.api.Member;\n+import cz.metacentrum.perun.core.api.Resource;\n+import cz.metacentrum.perun.core.api.Service;\n+import cz.metacentrum.perun.core.api.User;\n+import cz.metacentrum.perun.core.api.Vo;\n+import cz.metacentrum.perun.core.api.exceptions.GroupResourceMismatchException;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.MemberGroupMismatchException;\n+import cz.metacentrum.perun.core.api.exceptions.VoNotExistsException;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.function.Function;\n+\n+import static java.util.Collections.emptyList;\n+import static java.util.Collections.singletonList;\n+import static java.util.stream.Collectors.toList;\n+import static java.util.stream.Collectors.toMap;\n+\n+/**\n+ * @author Vojtech Sassmann <vojtech.sassmann@gmail.com>\n+ */\n+public class GenDataProviderImpl implements GenDataProvider {\n+\n+\tprivate final PerunSessionImpl sess;\n+\tprivate final Service service;\n+\tprivate final Facility facility;\n+\n+\tprivate final Map<String, List<Attribute>> attributesByHash = new HashMap<>();\n+\n+\tprivate List<Attribute> facilityAttrs;\n+\n+\t/**\n+\t * Map of Member-Resource attributes. This map is overwritten when data for new resource are loaded!!!\n+\t */\n+\tprivate Map<Member, List<Attribute>> memberResourceAttrs = new HashMap<>();\n+\n+\t/**\n+\t * Map of Group-Resource attributes. This map is overwritten when data for new resource are loaded!!!\n+\t */\n+\tprivate Map<Group, List<Attribute>> groupResourceAttrs = new HashMap<>();\n+\n+\t/**\n+\t * Map of Member-Group attributes. This map is overwritten when data for new group are loaded!!!\n+\t */\n+\tprivate Map<Member, List<Attribute>> memberGroupAttrs = new HashMap<>();\n+\n+\t/**\n+\t * These maps are not overwritten, because they do not depend on currently loaded entities.\n+\t */\n+\tprivate final Map<Member, List<Attribute>> memberAttrs = new HashMap<>();\n+\tprivate final Map<Group, List<Attribute>> groupAttrs = new HashMap<>();\n+\tprivate final Map<User, List<Attribute>> userAttrs = new HashMap<>();\n+\tprivate final Map<User, List<Attribute>> userFacilityAttrs = new HashMap<>();\n+\tprivate final Map<Resource, List<Attribute>> resourceAttrs = new HashMap<>();\n+\n+\t/**\n+\t * Vos has to contain only ids, or only vos loaded from DB. Because of the equals and hashCode\n+\t * implementations. If they were mixed, it would cause data duplicity.\n+\t */\n+\tprivate final Map<Vo, List<Attribute>> voAttrs = new HashMap<>();\n+\n+\tprivate Group lastLoadedGroup;\n+\tprivate Resource lastLoadedResource;\n+\n+\tprivate final Map<Integer, User> loadedUsersById = new HashMap<>();\n+\tprivate final Set<Member> processedMembers = new HashSet<>();\n+\tprivate final Set<Group> processedGroups = new HashSet<>();\n+\n+\tprivate final Hasher hasher = new IdHasher();\n+\n+\tpublic GenDataProviderImpl(PerunSessionImpl sess, Service service, Facility facility) {\n+\t\tthis.sess = sess;\n+\t\tthis.service = service;\n+\t\tthis.facility = facility;\n+\t}\n+\n+\t@Override\n+\tpublic void loadFacilityAttributes() {\n+\t\tfacilityAttrs =\n+\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, facility);\n+\t}\n+\n+\t@Override\n+\tpublic void loadGroupsAttributes(Resource resource, List<Group> groups) {\n+\t\tgroupResourceAttrs = new HashMap<>();\n+\n+\t\tfor (Group group: groups) {\n+\t\t\ttry {\n+\t\t\t\t// FIXME - attributes could be loaded at once to get a better performance\n+\t\t\t\tgroupResourceAttrs.put(group,\n+\t\t\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, resource, group));\n+\t\t\t} catch (GroupResourceMismatchException e) {\n+\t\t\t\tthrow new InternalErrorException(e);\n+\t\t\t}\n+\t\t}\n+\n+\t\tList<Group> notYetProcessedGroups = new ArrayList<>(groups);\n+\t\tnotYetProcessedGroups.removeAll(processedGroups);\n+\t\tprocessedGroups.addAll(notYetProcessedGroups);\n+\n+\t\tgroupAttrs.putAll(\n+\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributesForGroups(sess, service, groups)\n+\t\t);\n+\t}\n+\n+\t@Override\n+\tpublic void loadMemberGroupAttributes(Group group, List<Member> members) {\n+\t\tlastLoadedGroup = group;\n+\t\tmemberGroupAttrs = new HashMap<>();\n+\t\ttry {\n+\t\t\tmemberGroupAttrs.putAll(\n+\t\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, members, group)\n+\t\t\t);\n+\t\t} catch (MemberGroupMismatchException e) {\n+\t\t\tthrow new InternalErrorException(e);\n+\t\t}\n+\t}\n+\n+\t@Override\n+\tpublic void loadResourceAttributes(Resource resource, List<Member> members, boolean loadVoAttributes) {\n+\t\tlastLoadedResource = resource;\n+\n+\t\tif (!resourceAttrs.containsKey(resource)) {\n+\t\t\tresourceAttrs.put(resource,\n+\t\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, resource));\n+\t\t}\n+\n+\t\tif (loadVoAttributes) {\n+\t\t\tloadVoSpecificAttributes(resource);\n+\t\t}\n+\n+\t\tmemberResourceAttrs =\n+\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, resource, members);\n+\n+\t\t// we don't need to load again attributes for the already processed members\n+\t\tList<Member> notYetProcessedMembers = new ArrayList<>(members);\n+\t\tnotYetProcessedMembers.removeAll(processedMembers);\n+\t\tprocessedMembers.addAll(notYetProcessedMembers);\n+\n+\t\tloadMemberSpecificAttributes(notYetProcessedMembers);\n+\t}\n+\n+\t@Override\n+\tpublic List<String> getFacilityAttributesHashes() {\n+\t\tString hash = hasher.hashFacility(facility);\n+\n+\t\tif (!attributesByHash.containsKey(hash)) {\n+\t\t\tif (facilityAttrs == null) {\n+\t\t\t\tthrow new IllegalStateException(\"Facility attributes need to be loaded first.\");\n+\t\t\t}\n+\t\t\tattributesByHash.put(hash, facilityAttrs);\n+\t\t}\n+\n+\t\treturn attributesByHash.get(hash).isEmpty() ? emptyList() : singletonList(hash);\n+\t}\n+\n+\t@Override\n+\tpublic List<String> getResourceAttributesHashes(Resource resource, boolean addVoAttributes) {\n+\t\tList<String> hashes = getResourceAttributesHashes(resource);\n+\n+\t\t// create fake vo for optimization", "originalCommit": "c2360fc907b21688fc99c389718c4561a6c5d1aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjAxNzgwMA==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r482017800", "bodyText": "Comment changed.", "author": "Vojtech-Sassmann", "createdAt": "2020-09-02T12:07:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTgyNDI4Mw=="}], "type": "inlineReview", "revised_code": {"commit": "d1fe8e4df1f3aa6d69a0de18c3c8728df6fa3372", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java b/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java\nindex be3dece02..a781abde7 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java\n\n@@ -87,13 +87,13 @@ public class GenDataProviderImpl implements GenDataProvider {\n \n \t@Override\n \tpublic void loadFacilityAttributes() {\n-\t\tfacilityAttrs =\n-\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, facility);\n+\t\tfacilityAttrs = sess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, facility);\n \t}\n \n \t@Override\n \tpublic void loadGroupsAttributes(Resource resource, List<Group> groups) {\n \t\tgroupResourceAttrs = new HashMap<>();\n+\t\tlastLoadedResource = resource;\n \n \t\tfor (Group group: groups) {\n \t\t\ttry {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTgyNTEzNw==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r481825137", "bodyText": "You can create the VO object only inside this if clause.", "author": "stavamichal", "createdAt": "2020-09-02T07:21:59Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java", "diffHunk": "@@ -0,0 +1,358 @@\n+package cz.metacentrum.perun.core.provisioning;\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.Facility;\n+import cz.metacentrum.perun.core.api.Group;\n+import cz.metacentrum.perun.core.api.Member;\n+import cz.metacentrum.perun.core.api.Resource;\n+import cz.metacentrum.perun.core.api.Service;\n+import cz.metacentrum.perun.core.api.User;\n+import cz.metacentrum.perun.core.api.Vo;\n+import cz.metacentrum.perun.core.api.exceptions.GroupResourceMismatchException;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.MemberGroupMismatchException;\n+import cz.metacentrum.perun.core.api.exceptions.VoNotExistsException;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.function.Function;\n+\n+import static java.util.Collections.emptyList;\n+import static java.util.Collections.singletonList;\n+import static java.util.stream.Collectors.toList;\n+import static java.util.stream.Collectors.toMap;\n+\n+/**\n+ * @author Vojtech Sassmann <vojtech.sassmann@gmail.com>\n+ */\n+public class GenDataProviderImpl implements GenDataProvider {\n+\n+\tprivate final PerunSessionImpl sess;\n+\tprivate final Service service;\n+\tprivate final Facility facility;\n+\n+\tprivate final Map<String, List<Attribute>> attributesByHash = new HashMap<>();\n+\n+\tprivate List<Attribute> facilityAttrs;\n+\n+\t/**\n+\t * Map of Member-Resource attributes. This map is overwritten when data for new resource are loaded!!!\n+\t */\n+\tprivate Map<Member, List<Attribute>> memberResourceAttrs = new HashMap<>();\n+\n+\t/**\n+\t * Map of Group-Resource attributes. This map is overwritten when data for new resource are loaded!!!\n+\t */\n+\tprivate Map<Group, List<Attribute>> groupResourceAttrs = new HashMap<>();\n+\n+\t/**\n+\t * Map of Member-Group attributes. This map is overwritten when data for new group are loaded!!!\n+\t */\n+\tprivate Map<Member, List<Attribute>> memberGroupAttrs = new HashMap<>();\n+\n+\t/**\n+\t * These maps are not overwritten, because they do not depend on currently loaded entities.\n+\t */\n+\tprivate final Map<Member, List<Attribute>> memberAttrs = new HashMap<>();\n+\tprivate final Map<Group, List<Attribute>> groupAttrs = new HashMap<>();\n+\tprivate final Map<User, List<Attribute>> userAttrs = new HashMap<>();\n+\tprivate final Map<User, List<Attribute>> userFacilityAttrs = new HashMap<>();\n+\tprivate final Map<Resource, List<Attribute>> resourceAttrs = new HashMap<>();\n+\n+\t/**\n+\t * Vos has to contain only ids, or only vos loaded from DB. Because of the equals and hashCode\n+\t * implementations. If they were mixed, it would cause data duplicity.\n+\t */\n+\tprivate final Map<Vo, List<Attribute>> voAttrs = new HashMap<>();\n+\n+\tprivate Group lastLoadedGroup;\n+\tprivate Resource lastLoadedResource;\n+\n+\tprivate final Map<Integer, User> loadedUsersById = new HashMap<>();\n+\tprivate final Set<Member> processedMembers = new HashSet<>();\n+\tprivate final Set<Group> processedGroups = new HashSet<>();\n+\n+\tprivate final Hasher hasher = new IdHasher();\n+\n+\tpublic GenDataProviderImpl(PerunSessionImpl sess, Service service, Facility facility) {\n+\t\tthis.sess = sess;\n+\t\tthis.service = service;\n+\t\tthis.facility = facility;\n+\t}\n+\n+\t@Override\n+\tpublic void loadFacilityAttributes() {\n+\t\tfacilityAttrs =\n+\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, facility);\n+\t}\n+\n+\t@Override\n+\tpublic void loadGroupsAttributes(Resource resource, List<Group> groups) {\n+\t\tgroupResourceAttrs = new HashMap<>();\n+\n+\t\tfor (Group group: groups) {\n+\t\t\ttry {\n+\t\t\t\t// FIXME - attributes could be loaded at once to get a better performance\n+\t\t\t\tgroupResourceAttrs.put(group,\n+\t\t\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, resource, group));\n+\t\t\t} catch (GroupResourceMismatchException e) {\n+\t\t\t\tthrow new InternalErrorException(e);\n+\t\t\t}\n+\t\t}\n+\n+\t\tList<Group> notYetProcessedGroups = new ArrayList<>(groups);\n+\t\tnotYetProcessedGroups.removeAll(processedGroups);\n+\t\tprocessedGroups.addAll(notYetProcessedGroups);\n+\n+\t\tgroupAttrs.putAll(\n+\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributesForGroups(sess, service, groups)\n+\t\t);\n+\t}\n+\n+\t@Override\n+\tpublic void loadMemberGroupAttributes(Group group, List<Member> members) {\n+\t\tlastLoadedGroup = group;\n+\t\tmemberGroupAttrs = new HashMap<>();\n+\t\ttry {\n+\t\t\tmemberGroupAttrs.putAll(\n+\t\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, members, group)\n+\t\t\t);\n+\t\t} catch (MemberGroupMismatchException e) {\n+\t\t\tthrow new InternalErrorException(e);\n+\t\t}\n+\t}\n+\n+\t@Override\n+\tpublic void loadResourceAttributes(Resource resource, List<Member> members, boolean loadVoAttributes) {\n+\t\tlastLoadedResource = resource;\n+\n+\t\tif (!resourceAttrs.containsKey(resource)) {\n+\t\t\tresourceAttrs.put(resource,\n+\t\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, resource));\n+\t\t}\n+\n+\t\tif (loadVoAttributes) {\n+\t\t\tloadVoSpecificAttributes(resource);\n+\t\t}\n+\n+\t\tmemberResourceAttrs =\n+\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, resource, members);\n+\n+\t\t// we don't need to load again attributes for the already processed members\n+\t\tList<Member> notYetProcessedMembers = new ArrayList<>(members);\n+\t\tnotYetProcessedMembers.removeAll(processedMembers);\n+\t\tprocessedMembers.addAll(notYetProcessedMembers);\n+\n+\t\tloadMemberSpecificAttributes(notYetProcessedMembers);\n+\t}\n+\n+\t@Override\n+\tpublic List<String> getFacilityAttributesHashes() {\n+\t\tString hash = hasher.hashFacility(facility);\n+\n+\t\tif (!attributesByHash.containsKey(hash)) {\n+\t\t\tif (facilityAttrs == null) {\n+\t\t\t\tthrow new IllegalStateException(\"Facility attributes need to be loaded first.\");\n+\t\t\t}\n+\t\t\tattributesByHash.put(hash, facilityAttrs);\n+\t\t}\n+\n+\t\treturn attributesByHash.get(hash).isEmpty() ? emptyList() : singletonList(hash);\n+\t}\n+\n+\t@Override\n+\tpublic List<String> getResourceAttributesHashes(Resource resource, boolean addVoAttributes) {\n+\t\tList<String> hashes = getResourceAttributesHashes(resource);\n+\n+\t\t// create fake vo for optimization\n+\t\tVo vo = new Vo();\n+\t\tvo.setId(resource.getVoId());\n+\n+\t\tif (addVoAttributes) {\n+\t\t\thashes.addAll(getVoAttributesHashes(vo));", "originalCommit": "c2360fc907b21688fc99c389718c4561a6c5d1aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjAxNzg2Ng==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r482017866", "bodyText": "Moved.", "author": "Vojtech-Sassmann", "createdAt": "2020-09-02T12:07:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTgyNTEzNw=="}], "type": "inlineReview", "revised_code": {"commit": "d1fe8e4df1f3aa6d69a0de18c3c8728df6fa3372", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java b/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java\nindex be3dece02..a781abde7 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java\n\n@@ -87,13 +87,13 @@ public class GenDataProviderImpl implements GenDataProvider {\n \n \t@Override\n \tpublic void loadFacilityAttributes() {\n-\t\tfacilityAttrs =\n-\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, facility);\n+\t\tfacilityAttrs = sess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, facility);\n \t}\n \n \t@Override\n \tpublic void loadGroupsAttributes(Resource resource, List<Group> groups) {\n \t\tgroupResourceAttrs = new HashMap<>();\n+\t\tlastLoadedResource = resource;\n \n \t\tfor (Group group: groups) {\n \t\t\ttry {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTgyNzA3Ng==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r481827076", "bodyText": "I know it would be double-check, but you should check if resource=lastLoadedResource here too.", "author": "stavamichal", "createdAt": "2020-09-02T07:24:23Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java", "diffHunk": "@@ -0,0 +1,358 @@\n+package cz.metacentrum.perun.core.provisioning;\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.Facility;\n+import cz.metacentrum.perun.core.api.Group;\n+import cz.metacentrum.perun.core.api.Member;\n+import cz.metacentrum.perun.core.api.Resource;\n+import cz.metacentrum.perun.core.api.Service;\n+import cz.metacentrum.perun.core.api.User;\n+import cz.metacentrum.perun.core.api.Vo;\n+import cz.metacentrum.perun.core.api.exceptions.GroupResourceMismatchException;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.MemberGroupMismatchException;\n+import cz.metacentrum.perun.core.api.exceptions.VoNotExistsException;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.function.Function;\n+\n+import static java.util.Collections.emptyList;\n+import static java.util.Collections.singletonList;\n+import static java.util.stream.Collectors.toList;\n+import static java.util.stream.Collectors.toMap;\n+\n+/**\n+ * @author Vojtech Sassmann <vojtech.sassmann@gmail.com>\n+ */\n+public class GenDataProviderImpl implements GenDataProvider {\n+\n+\tprivate final PerunSessionImpl sess;\n+\tprivate final Service service;\n+\tprivate final Facility facility;\n+\n+\tprivate final Map<String, List<Attribute>> attributesByHash = new HashMap<>();\n+\n+\tprivate List<Attribute> facilityAttrs;\n+\n+\t/**\n+\t * Map of Member-Resource attributes. This map is overwritten when data for new resource are loaded!!!\n+\t */\n+\tprivate Map<Member, List<Attribute>> memberResourceAttrs = new HashMap<>();\n+\n+\t/**\n+\t * Map of Group-Resource attributes. This map is overwritten when data for new resource are loaded!!!\n+\t */\n+\tprivate Map<Group, List<Attribute>> groupResourceAttrs = new HashMap<>();\n+\n+\t/**\n+\t * Map of Member-Group attributes. This map is overwritten when data for new group are loaded!!!\n+\t */\n+\tprivate Map<Member, List<Attribute>> memberGroupAttrs = new HashMap<>();\n+\n+\t/**\n+\t * These maps are not overwritten, because they do not depend on currently loaded entities.\n+\t */\n+\tprivate final Map<Member, List<Attribute>> memberAttrs = new HashMap<>();\n+\tprivate final Map<Group, List<Attribute>> groupAttrs = new HashMap<>();\n+\tprivate final Map<User, List<Attribute>> userAttrs = new HashMap<>();\n+\tprivate final Map<User, List<Attribute>> userFacilityAttrs = new HashMap<>();\n+\tprivate final Map<Resource, List<Attribute>> resourceAttrs = new HashMap<>();\n+\n+\t/**\n+\t * Vos has to contain only ids, or only vos loaded from DB. Because of the equals and hashCode\n+\t * implementations. If they were mixed, it would cause data duplicity.\n+\t */\n+\tprivate final Map<Vo, List<Attribute>> voAttrs = new HashMap<>();\n+\n+\tprivate Group lastLoadedGroup;\n+\tprivate Resource lastLoadedResource;\n+\n+\tprivate final Map<Integer, User> loadedUsersById = new HashMap<>();\n+\tprivate final Set<Member> processedMembers = new HashSet<>();\n+\tprivate final Set<Group> processedGroups = new HashSet<>();\n+\n+\tprivate final Hasher hasher = new IdHasher();\n+\n+\tpublic GenDataProviderImpl(PerunSessionImpl sess, Service service, Facility facility) {\n+\t\tthis.sess = sess;\n+\t\tthis.service = service;\n+\t\tthis.facility = facility;\n+\t}\n+\n+\t@Override\n+\tpublic void loadFacilityAttributes() {\n+\t\tfacilityAttrs =\n+\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, facility);\n+\t}\n+\n+\t@Override\n+\tpublic void loadGroupsAttributes(Resource resource, List<Group> groups) {\n+\t\tgroupResourceAttrs = new HashMap<>();\n+\n+\t\tfor (Group group: groups) {\n+\t\t\ttry {\n+\t\t\t\t// FIXME - attributes could be loaded at once to get a better performance\n+\t\t\t\tgroupResourceAttrs.put(group,\n+\t\t\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, resource, group));\n+\t\t\t} catch (GroupResourceMismatchException e) {\n+\t\t\t\tthrow new InternalErrorException(e);\n+\t\t\t}\n+\t\t}\n+\n+\t\tList<Group> notYetProcessedGroups = new ArrayList<>(groups);\n+\t\tnotYetProcessedGroups.removeAll(processedGroups);\n+\t\tprocessedGroups.addAll(notYetProcessedGroups);\n+\n+\t\tgroupAttrs.putAll(\n+\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributesForGroups(sess, service, groups)\n+\t\t);\n+\t}\n+\n+\t@Override\n+\tpublic void loadMemberGroupAttributes(Group group, List<Member> members) {\n+\t\tlastLoadedGroup = group;\n+\t\tmemberGroupAttrs = new HashMap<>();\n+\t\ttry {\n+\t\t\tmemberGroupAttrs.putAll(\n+\t\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, members, group)\n+\t\t\t);\n+\t\t} catch (MemberGroupMismatchException e) {\n+\t\t\tthrow new InternalErrorException(e);\n+\t\t}\n+\t}\n+\n+\t@Override\n+\tpublic void loadResourceAttributes(Resource resource, List<Member> members, boolean loadVoAttributes) {\n+\t\tlastLoadedResource = resource;\n+\n+\t\tif (!resourceAttrs.containsKey(resource)) {\n+\t\t\tresourceAttrs.put(resource,\n+\t\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, resource));\n+\t\t}\n+\n+\t\tif (loadVoAttributes) {\n+\t\t\tloadVoSpecificAttributes(resource);\n+\t\t}\n+\n+\t\tmemberResourceAttrs =\n+\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, resource, members);\n+\n+\t\t// we don't need to load again attributes for the already processed members\n+\t\tList<Member> notYetProcessedMembers = new ArrayList<>(members);\n+\t\tnotYetProcessedMembers.removeAll(processedMembers);\n+\t\tprocessedMembers.addAll(notYetProcessedMembers);\n+\n+\t\tloadMemberSpecificAttributes(notYetProcessedMembers);\n+\t}\n+\n+\t@Override\n+\tpublic List<String> getFacilityAttributesHashes() {\n+\t\tString hash = hasher.hashFacility(facility);\n+\n+\t\tif (!attributesByHash.containsKey(hash)) {\n+\t\t\tif (facilityAttrs == null) {\n+\t\t\t\tthrow new IllegalStateException(\"Facility attributes need to be loaded first.\");\n+\t\t\t}\n+\t\t\tattributesByHash.put(hash, facilityAttrs);\n+\t\t}\n+\n+\t\treturn attributesByHash.get(hash).isEmpty() ? emptyList() : singletonList(hash);\n+\t}\n+\n+\t@Override\n+\tpublic List<String> getResourceAttributesHashes(Resource resource, boolean addVoAttributes) {\n+\t\tList<String> hashes = getResourceAttributesHashes(resource);\n+\n+\t\t// create fake vo for optimization\n+\t\tVo vo = new Vo();\n+\t\tvo.setId(resource.getVoId());\n+\n+\t\tif (addVoAttributes) {\n+\t\t\thashes.addAll(getVoAttributesHashes(vo));\n+\t\t}\n+\n+\t\treturn hashes;\n+\t}\n+\n+\t@Override\n+\tpublic List<String> getMemberAttributesHashes(Resource resource, Member member) {\n+\t\tList<String> hashes = new ArrayList<>();\n+\n+\t\tUser user = loadedUsersById.get(member.getUserId());", "originalCommit": "c2360fc907b21688fc99c389718c4561a6c5d1aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjAxNzk1NQ==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r482017955", "bodyText": "Check added.", "author": "Vojtech-Sassmann", "createdAt": "2020-09-02T12:08:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTgyNzA3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "d1fe8e4df1f3aa6d69a0de18c3c8728df6fa3372", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java b/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java\nindex be3dece02..a781abde7 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java\n\n@@ -87,13 +87,13 @@ public class GenDataProviderImpl implements GenDataProvider {\n \n \t@Override\n \tpublic void loadFacilityAttributes() {\n-\t\tfacilityAttrs =\n-\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, facility);\n+\t\tfacilityAttrs = sess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, facility);\n \t}\n \n \t@Override\n \tpublic void loadGroupsAttributes(Resource resource, List<Group> groups) {\n \t\tgroupResourceAttrs = new HashMap<>();\n+\t\tlastLoadedResource = resource;\n \n \t\tfor (Group group: groups) {\n \t\t\ttry {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTgyNzMzNA==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r481827334", "bodyText": "I know it would be double-check, but you should check if group=lastLoadedGroup here too.", "author": "stavamichal", "createdAt": "2020-09-02T07:24:41Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java", "diffHunk": "@@ -0,0 +1,358 @@\n+package cz.metacentrum.perun.core.provisioning;\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.Facility;\n+import cz.metacentrum.perun.core.api.Group;\n+import cz.metacentrum.perun.core.api.Member;\n+import cz.metacentrum.perun.core.api.Resource;\n+import cz.metacentrum.perun.core.api.Service;\n+import cz.metacentrum.perun.core.api.User;\n+import cz.metacentrum.perun.core.api.Vo;\n+import cz.metacentrum.perun.core.api.exceptions.GroupResourceMismatchException;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.MemberGroupMismatchException;\n+import cz.metacentrum.perun.core.api.exceptions.VoNotExistsException;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.function.Function;\n+\n+import static java.util.Collections.emptyList;\n+import static java.util.Collections.singletonList;\n+import static java.util.stream.Collectors.toList;\n+import static java.util.stream.Collectors.toMap;\n+\n+/**\n+ * @author Vojtech Sassmann <vojtech.sassmann@gmail.com>\n+ */\n+public class GenDataProviderImpl implements GenDataProvider {\n+\n+\tprivate final PerunSessionImpl sess;\n+\tprivate final Service service;\n+\tprivate final Facility facility;\n+\n+\tprivate final Map<String, List<Attribute>> attributesByHash = new HashMap<>();\n+\n+\tprivate List<Attribute> facilityAttrs;\n+\n+\t/**\n+\t * Map of Member-Resource attributes. This map is overwritten when data for new resource are loaded!!!\n+\t */\n+\tprivate Map<Member, List<Attribute>> memberResourceAttrs = new HashMap<>();\n+\n+\t/**\n+\t * Map of Group-Resource attributes. This map is overwritten when data for new resource are loaded!!!\n+\t */\n+\tprivate Map<Group, List<Attribute>> groupResourceAttrs = new HashMap<>();\n+\n+\t/**\n+\t * Map of Member-Group attributes. This map is overwritten when data for new group are loaded!!!\n+\t */\n+\tprivate Map<Member, List<Attribute>> memberGroupAttrs = new HashMap<>();\n+\n+\t/**\n+\t * These maps are not overwritten, because they do not depend on currently loaded entities.\n+\t */\n+\tprivate final Map<Member, List<Attribute>> memberAttrs = new HashMap<>();\n+\tprivate final Map<Group, List<Attribute>> groupAttrs = new HashMap<>();\n+\tprivate final Map<User, List<Attribute>> userAttrs = new HashMap<>();\n+\tprivate final Map<User, List<Attribute>> userFacilityAttrs = new HashMap<>();\n+\tprivate final Map<Resource, List<Attribute>> resourceAttrs = new HashMap<>();\n+\n+\t/**\n+\t * Vos has to contain only ids, or only vos loaded from DB. Because of the equals and hashCode\n+\t * implementations. If they were mixed, it would cause data duplicity.\n+\t */\n+\tprivate final Map<Vo, List<Attribute>> voAttrs = new HashMap<>();\n+\n+\tprivate Group lastLoadedGroup;\n+\tprivate Resource lastLoadedResource;\n+\n+\tprivate final Map<Integer, User> loadedUsersById = new HashMap<>();\n+\tprivate final Set<Member> processedMembers = new HashSet<>();\n+\tprivate final Set<Group> processedGroups = new HashSet<>();\n+\n+\tprivate final Hasher hasher = new IdHasher();\n+\n+\tpublic GenDataProviderImpl(PerunSessionImpl sess, Service service, Facility facility) {\n+\t\tthis.sess = sess;\n+\t\tthis.service = service;\n+\t\tthis.facility = facility;\n+\t}\n+\n+\t@Override\n+\tpublic void loadFacilityAttributes() {\n+\t\tfacilityAttrs =\n+\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, facility);\n+\t}\n+\n+\t@Override\n+\tpublic void loadGroupsAttributes(Resource resource, List<Group> groups) {\n+\t\tgroupResourceAttrs = new HashMap<>();\n+\n+\t\tfor (Group group: groups) {\n+\t\t\ttry {\n+\t\t\t\t// FIXME - attributes could be loaded at once to get a better performance\n+\t\t\t\tgroupResourceAttrs.put(group,\n+\t\t\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, resource, group));\n+\t\t\t} catch (GroupResourceMismatchException e) {\n+\t\t\t\tthrow new InternalErrorException(e);\n+\t\t\t}\n+\t\t}\n+\n+\t\tList<Group> notYetProcessedGroups = new ArrayList<>(groups);\n+\t\tnotYetProcessedGroups.removeAll(processedGroups);\n+\t\tprocessedGroups.addAll(notYetProcessedGroups);\n+\n+\t\tgroupAttrs.putAll(\n+\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributesForGroups(sess, service, groups)\n+\t\t);\n+\t}\n+\n+\t@Override\n+\tpublic void loadMemberGroupAttributes(Group group, List<Member> members) {\n+\t\tlastLoadedGroup = group;\n+\t\tmemberGroupAttrs = new HashMap<>();\n+\t\ttry {\n+\t\t\tmemberGroupAttrs.putAll(\n+\t\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, members, group)\n+\t\t\t);\n+\t\t} catch (MemberGroupMismatchException e) {\n+\t\t\tthrow new InternalErrorException(e);\n+\t\t}\n+\t}\n+\n+\t@Override\n+\tpublic void loadResourceAttributes(Resource resource, List<Member> members, boolean loadVoAttributes) {\n+\t\tlastLoadedResource = resource;\n+\n+\t\tif (!resourceAttrs.containsKey(resource)) {\n+\t\t\tresourceAttrs.put(resource,\n+\t\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, resource));\n+\t\t}\n+\n+\t\tif (loadVoAttributes) {\n+\t\t\tloadVoSpecificAttributes(resource);\n+\t\t}\n+\n+\t\tmemberResourceAttrs =\n+\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, resource, members);\n+\n+\t\t// we don't need to load again attributes for the already processed members\n+\t\tList<Member> notYetProcessedMembers = new ArrayList<>(members);\n+\t\tnotYetProcessedMembers.removeAll(processedMembers);\n+\t\tprocessedMembers.addAll(notYetProcessedMembers);\n+\n+\t\tloadMemberSpecificAttributes(notYetProcessedMembers);\n+\t}\n+\n+\t@Override\n+\tpublic List<String> getFacilityAttributesHashes() {\n+\t\tString hash = hasher.hashFacility(facility);\n+\n+\t\tif (!attributesByHash.containsKey(hash)) {\n+\t\t\tif (facilityAttrs == null) {\n+\t\t\t\tthrow new IllegalStateException(\"Facility attributes need to be loaded first.\");\n+\t\t\t}\n+\t\t\tattributesByHash.put(hash, facilityAttrs);\n+\t\t}\n+\n+\t\treturn attributesByHash.get(hash).isEmpty() ? emptyList() : singletonList(hash);\n+\t}\n+\n+\t@Override\n+\tpublic List<String> getResourceAttributesHashes(Resource resource, boolean addVoAttributes) {\n+\t\tList<String> hashes = getResourceAttributesHashes(resource);\n+\n+\t\t// create fake vo for optimization\n+\t\tVo vo = new Vo();\n+\t\tvo.setId(resource.getVoId());\n+\n+\t\tif (addVoAttributes) {\n+\t\t\thashes.addAll(getVoAttributesHashes(vo));\n+\t\t}\n+\n+\t\treturn hashes;\n+\t}\n+\n+\t@Override\n+\tpublic List<String> getMemberAttributesHashes(Resource resource, Member member) {\n+\t\tList<String> hashes = new ArrayList<>();\n+\n+\t\tUser user = loadedUsersById.get(member.getUserId());\n+\n+\t\thashes.addAll(getMemberAttributesHashes(member));\n+\t\thashes.addAll(getUserAttributesHashes(user));\n+\t\thashes.addAll(getUserFacilityAttributesHashes(user, facility));\n+\t\thashes.addAll(getMemberResourceAttributesHashes(member, resource));\n+\n+\t\treturn hashes;\n+\t}\n+\n+\t@Override\n+\tpublic List<String> getMemberAttributesHashes(Resource resource, Member member, Group group) {\n+\t\tList<String> hashes = getMemberAttributesHashes(resource, member);", "originalCommit": "c2360fc907b21688fc99c389718c4561a6c5d1aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjAxODAxNA==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r482018014", "bodyText": "Check added.", "author": "Vojtech-Sassmann", "createdAt": "2020-09-02T12:08:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTgyNzMzNA=="}], "type": "inlineReview", "revised_code": {"commit": "d1fe8e4df1f3aa6d69a0de18c3c8728df6fa3372", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java b/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java\nindex be3dece02..a781abde7 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java\n\n@@ -87,13 +87,13 @@ public class GenDataProviderImpl implements GenDataProvider {\n \n \t@Override\n \tpublic void loadFacilityAttributes() {\n-\t\tfacilityAttrs =\n-\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, facility);\n+\t\tfacilityAttrs = sess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, facility);\n \t}\n \n \t@Override\n \tpublic void loadGroupsAttributes(Resource resource, List<Group> groups) {\n \t\tgroupResourceAttrs = new HashMap<>();\n+\t\tlastLoadedResource = resource;\n \n \t\tfor (Group group: groups) {\n \t\t\ttry {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTgyNzY0MQ==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r481827641", "bodyText": "I know it would be double-check, but you should check if resource=lastLoadedResource and group=lastLoadedGroup here too.", "author": "stavamichal", "createdAt": "2020-09-02T07:24:59Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java", "diffHunk": "@@ -0,0 +1,358 @@\n+package cz.metacentrum.perun.core.provisioning;\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.Facility;\n+import cz.metacentrum.perun.core.api.Group;\n+import cz.metacentrum.perun.core.api.Member;\n+import cz.metacentrum.perun.core.api.Resource;\n+import cz.metacentrum.perun.core.api.Service;\n+import cz.metacentrum.perun.core.api.User;\n+import cz.metacentrum.perun.core.api.Vo;\n+import cz.metacentrum.perun.core.api.exceptions.GroupResourceMismatchException;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.MemberGroupMismatchException;\n+import cz.metacentrum.perun.core.api.exceptions.VoNotExistsException;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.function.Function;\n+\n+import static java.util.Collections.emptyList;\n+import static java.util.Collections.singletonList;\n+import static java.util.stream.Collectors.toList;\n+import static java.util.stream.Collectors.toMap;\n+\n+/**\n+ * @author Vojtech Sassmann <vojtech.sassmann@gmail.com>\n+ */\n+public class GenDataProviderImpl implements GenDataProvider {\n+\n+\tprivate final PerunSessionImpl sess;\n+\tprivate final Service service;\n+\tprivate final Facility facility;\n+\n+\tprivate final Map<String, List<Attribute>> attributesByHash = new HashMap<>();\n+\n+\tprivate List<Attribute> facilityAttrs;\n+\n+\t/**\n+\t * Map of Member-Resource attributes. This map is overwritten when data for new resource are loaded!!!\n+\t */\n+\tprivate Map<Member, List<Attribute>> memberResourceAttrs = new HashMap<>();\n+\n+\t/**\n+\t * Map of Group-Resource attributes. This map is overwritten when data for new resource are loaded!!!\n+\t */\n+\tprivate Map<Group, List<Attribute>> groupResourceAttrs = new HashMap<>();\n+\n+\t/**\n+\t * Map of Member-Group attributes. This map is overwritten when data for new group are loaded!!!\n+\t */\n+\tprivate Map<Member, List<Attribute>> memberGroupAttrs = new HashMap<>();\n+\n+\t/**\n+\t * These maps are not overwritten, because they do not depend on currently loaded entities.\n+\t */\n+\tprivate final Map<Member, List<Attribute>> memberAttrs = new HashMap<>();\n+\tprivate final Map<Group, List<Attribute>> groupAttrs = new HashMap<>();\n+\tprivate final Map<User, List<Attribute>> userAttrs = new HashMap<>();\n+\tprivate final Map<User, List<Attribute>> userFacilityAttrs = new HashMap<>();\n+\tprivate final Map<Resource, List<Attribute>> resourceAttrs = new HashMap<>();\n+\n+\t/**\n+\t * Vos has to contain only ids, or only vos loaded from DB. Because of the equals and hashCode\n+\t * implementations. If they were mixed, it would cause data duplicity.\n+\t */\n+\tprivate final Map<Vo, List<Attribute>> voAttrs = new HashMap<>();\n+\n+\tprivate Group lastLoadedGroup;\n+\tprivate Resource lastLoadedResource;\n+\n+\tprivate final Map<Integer, User> loadedUsersById = new HashMap<>();\n+\tprivate final Set<Member> processedMembers = new HashSet<>();\n+\tprivate final Set<Group> processedGroups = new HashSet<>();\n+\n+\tprivate final Hasher hasher = new IdHasher();\n+\n+\tpublic GenDataProviderImpl(PerunSessionImpl sess, Service service, Facility facility) {\n+\t\tthis.sess = sess;\n+\t\tthis.service = service;\n+\t\tthis.facility = facility;\n+\t}\n+\n+\t@Override\n+\tpublic void loadFacilityAttributes() {\n+\t\tfacilityAttrs =\n+\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, facility);\n+\t}\n+\n+\t@Override\n+\tpublic void loadGroupsAttributes(Resource resource, List<Group> groups) {\n+\t\tgroupResourceAttrs = new HashMap<>();\n+\n+\t\tfor (Group group: groups) {\n+\t\t\ttry {\n+\t\t\t\t// FIXME - attributes could be loaded at once to get a better performance\n+\t\t\t\tgroupResourceAttrs.put(group,\n+\t\t\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, resource, group));\n+\t\t\t} catch (GroupResourceMismatchException e) {\n+\t\t\t\tthrow new InternalErrorException(e);\n+\t\t\t}\n+\t\t}\n+\n+\t\tList<Group> notYetProcessedGroups = new ArrayList<>(groups);\n+\t\tnotYetProcessedGroups.removeAll(processedGroups);\n+\t\tprocessedGroups.addAll(notYetProcessedGroups);\n+\n+\t\tgroupAttrs.putAll(\n+\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributesForGroups(sess, service, groups)\n+\t\t);\n+\t}\n+\n+\t@Override\n+\tpublic void loadMemberGroupAttributes(Group group, List<Member> members) {\n+\t\tlastLoadedGroup = group;\n+\t\tmemberGroupAttrs = new HashMap<>();\n+\t\ttry {\n+\t\t\tmemberGroupAttrs.putAll(\n+\t\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, members, group)\n+\t\t\t);\n+\t\t} catch (MemberGroupMismatchException e) {\n+\t\t\tthrow new InternalErrorException(e);\n+\t\t}\n+\t}\n+\n+\t@Override\n+\tpublic void loadResourceAttributes(Resource resource, List<Member> members, boolean loadVoAttributes) {\n+\t\tlastLoadedResource = resource;\n+\n+\t\tif (!resourceAttrs.containsKey(resource)) {\n+\t\t\tresourceAttrs.put(resource,\n+\t\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, resource));\n+\t\t}\n+\n+\t\tif (loadVoAttributes) {\n+\t\t\tloadVoSpecificAttributes(resource);\n+\t\t}\n+\n+\t\tmemberResourceAttrs =\n+\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, resource, members);\n+\n+\t\t// we don't need to load again attributes for the already processed members\n+\t\tList<Member> notYetProcessedMembers = new ArrayList<>(members);\n+\t\tnotYetProcessedMembers.removeAll(processedMembers);\n+\t\tprocessedMembers.addAll(notYetProcessedMembers);\n+\n+\t\tloadMemberSpecificAttributes(notYetProcessedMembers);\n+\t}\n+\n+\t@Override\n+\tpublic List<String> getFacilityAttributesHashes() {\n+\t\tString hash = hasher.hashFacility(facility);\n+\n+\t\tif (!attributesByHash.containsKey(hash)) {\n+\t\t\tif (facilityAttrs == null) {\n+\t\t\t\tthrow new IllegalStateException(\"Facility attributes need to be loaded first.\");\n+\t\t\t}\n+\t\t\tattributesByHash.put(hash, facilityAttrs);\n+\t\t}\n+\n+\t\treturn attributesByHash.get(hash).isEmpty() ? emptyList() : singletonList(hash);\n+\t}\n+\n+\t@Override\n+\tpublic List<String> getResourceAttributesHashes(Resource resource, boolean addVoAttributes) {\n+\t\tList<String> hashes = getResourceAttributesHashes(resource);\n+\n+\t\t// create fake vo for optimization\n+\t\tVo vo = new Vo();\n+\t\tvo.setId(resource.getVoId());\n+\n+\t\tif (addVoAttributes) {\n+\t\t\thashes.addAll(getVoAttributesHashes(vo));\n+\t\t}\n+\n+\t\treturn hashes;\n+\t}\n+\n+\t@Override\n+\tpublic List<String> getMemberAttributesHashes(Resource resource, Member member) {\n+\t\tList<String> hashes = new ArrayList<>();\n+\n+\t\tUser user = loadedUsersById.get(member.getUserId());\n+\n+\t\thashes.addAll(getMemberAttributesHashes(member));\n+\t\thashes.addAll(getUserAttributesHashes(user));\n+\t\thashes.addAll(getUserFacilityAttributesHashes(user, facility));\n+\t\thashes.addAll(getMemberResourceAttributesHashes(member, resource));\n+\n+\t\treturn hashes;\n+\t}\n+\n+\t@Override\n+\tpublic List<String> getMemberAttributesHashes(Resource resource, Member member, Group group) {\n+\t\tList<String> hashes = getMemberAttributesHashes(resource, member);\n+\n+\t\thashes.addAll(getMemberGroupAttributesHashes(member, group));\n+\n+\t\treturn hashes;\n+\t}\n+\n+\t@Override\n+\tpublic List<String> getGroupAttributesHashes(Resource resource, Group group) {\n+\t\tList<String> hashes = new ArrayList<>();", "originalCommit": "c2360fc907b21688fc99c389718c4561a6c5d1aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjAxMTQ1MA==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r482011450", "bodyText": "The group=lastLoadedGroup check shouldn't be here. The lastLoadedGroup is set when loading attributes for one group and multiple members. In this case, you are getting attributes that were loaded for one resource and multiple groups. The fact that the last loaded resource is the given one should prevent most of the errors (it is still possible that the load method wasn't called with this exactly given group, but this is more complex and it should be solved in the future refactorization.)\nI will add at least a comment that this should be fixed during the refactorization.", "author": "Vojtech-Sassmann", "createdAt": "2020-09-02T11:55:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTgyNzY0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA2ODM4NA==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r482068384", "bodyText": "Ok.", "author": "stavamichal", "createdAt": "2020-09-02T13:28:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTgyNzY0MQ=="}], "type": "inlineReview", "revised_code": {"commit": "d1fe8e4df1f3aa6d69a0de18c3c8728df6fa3372", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java b/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java\nindex be3dece02..a781abde7 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java\n\n@@ -87,13 +87,13 @@ public class GenDataProviderImpl implements GenDataProvider {\n \n \t@Override\n \tpublic void loadFacilityAttributes() {\n-\t\tfacilityAttrs =\n-\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, facility);\n+\t\tfacilityAttrs = sess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, facility);\n \t}\n \n \t@Override\n \tpublic void loadGroupsAttributes(Resource resource, List<Group> groups) {\n \t\tgroupResourceAttrs = new HashMap<>();\n+\t\tlastLoadedResource = resource;\n \n \t\tfor (Group group: groups) {\n \t\t\ttry {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg1OTIzNg==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r481859236", "bodyText": "Same as the misleading info about the fake above.", "author": "stavamichal", "createdAt": "2020-09-02T08:01:44Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java", "diffHunk": "@@ -0,0 +1,358 @@\n+package cz.metacentrum.perun.core.provisioning;\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.Facility;\n+import cz.metacentrum.perun.core.api.Group;\n+import cz.metacentrum.perun.core.api.Member;\n+import cz.metacentrum.perun.core.api.Resource;\n+import cz.metacentrum.perun.core.api.Service;\n+import cz.metacentrum.perun.core.api.User;\n+import cz.metacentrum.perun.core.api.Vo;\n+import cz.metacentrum.perun.core.api.exceptions.GroupResourceMismatchException;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.MemberGroupMismatchException;\n+import cz.metacentrum.perun.core.api.exceptions.VoNotExistsException;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.function.Function;\n+\n+import static java.util.Collections.emptyList;\n+import static java.util.Collections.singletonList;\n+import static java.util.stream.Collectors.toList;\n+import static java.util.stream.Collectors.toMap;\n+\n+/**\n+ * @author Vojtech Sassmann <vojtech.sassmann@gmail.com>\n+ */\n+public class GenDataProviderImpl implements GenDataProvider {\n+\n+\tprivate final PerunSessionImpl sess;\n+\tprivate final Service service;\n+\tprivate final Facility facility;\n+\n+\tprivate final Map<String, List<Attribute>> attributesByHash = new HashMap<>();\n+\n+\tprivate List<Attribute> facilityAttrs;\n+\n+\t/**\n+\t * Map of Member-Resource attributes. This map is overwritten when data for new resource are loaded!!!\n+\t */\n+\tprivate Map<Member, List<Attribute>> memberResourceAttrs = new HashMap<>();\n+\n+\t/**\n+\t * Map of Group-Resource attributes. This map is overwritten when data for new resource are loaded!!!\n+\t */\n+\tprivate Map<Group, List<Attribute>> groupResourceAttrs = new HashMap<>();\n+\n+\t/**\n+\t * Map of Member-Group attributes. This map is overwritten when data for new group are loaded!!!\n+\t */\n+\tprivate Map<Member, List<Attribute>> memberGroupAttrs = new HashMap<>();\n+\n+\t/**\n+\t * These maps are not overwritten, because they do not depend on currently loaded entities.\n+\t */\n+\tprivate final Map<Member, List<Attribute>> memberAttrs = new HashMap<>();\n+\tprivate final Map<Group, List<Attribute>> groupAttrs = new HashMap<>();\n+\tprivate final Map<User, List<Attribute>> userAttrs = new HashMap<>();\n+\tprivate final Map<User, List<Attribute>> userFacilityAttrs = new HashMap<>();\n+\tprivate final Map<Resource, List<Attribute>> resourceAttrs = new HashMap<>();\n+\n+\t/**\n+\t * Vos has to contain only ids, or only vos loaded from DB. Because of the equals and hashCode\n+\t * implementations. If they were mixed, it would cause data duplicity.\n+\t */\n+\tprivate final Map<Vo, List<Attribute>> voAttrs = new HashMap<>();\n+\n+\tprivate Group lastLoadedGroup;\n+\tprivate Resource lastLoadedResource;\n+\n+\tprivate final Map<Integer, User> loadedUsersById = new HashMap<>();\n+\tprivate final Set<Member> processedMembers = new HashSet<>();\n+\tprivate final Set<Group> processedGroups = new HashSet<>();\n+\n+\tprivate final Hasher hasher = new IdHasher();\n+\n+\tpublic GenDataProviderImpl(PerunSessionImpl sess, Service service, Facility facility) {\n+\t\tthis.sess = sess;\n+\t\tthis.service = service;\n+\t\tthis.facility = facility;\n+\t}\n+\n+\t@Override\n+\tpublic void loadFacilityAttributes() {\n+\t\tfacilityAttrs =\n+\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, facility);\n+\t}\n+\n+\t@Override\n+\tpublic void loadGroupsAttributes(Resource resource, List<Group> groups) {\n+\t\tgroupResourceAttrs = new HashMap<>();\n+\n+\t\tfor (Group group: groups) {\n+\t\t\ttry {\n+\t\t\t\t// FIXME - attributes could be loaded at once to get a better performance\n+\t\t\t\tgroupResourceAttrs.put(group,\n+\t\t\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, resource, group));\n+\t\t\t} catch (GroupResourceMismatchException e) {\n+\t\t\t\tthrow new InternalErrorException(e);\n+\t\t\t}\n+\t\t}\n+\n+\t\tList<Group> notYetProcessedGroups = new ArrayList<>(groups);\n+\t\tnotYetProcessedGroups.removeAll(processedGroups);\n+\t\tprocessedGroups.addAll(notYetProcessedGroups);\n+\n+\t\tgroupAttrs.putAll(\n+\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributesForGroups(sess, service, groups)\n+\t\t);\n+\t}\n+\n+\t@Override\n+\tpublic void loadMemberGroupAttributes(Group group, List<Member> members) {\n+\t\tlastLoadedGroup = group;\n+\t\tmemberGroupAttrs = new HashMap<>();\n+\t\ttry {\n+\t\t\tmemberGroupAttrs.putAll(\n+\t\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, members, group)\n+\t\t\t);\n+\t\t} catch (MemberGroupMismatchException e) {\n+\t\t\tthrow new InternalErrorException(e);\n+\t\t}\n+\t}\n+\n+\t@Override\n+\tpublic void loadResourceAttributes(Resource resource, List<Member> members, boolean loadVoAttributes) {\n+\t\tlastLoadedResource = resource;\n+\n+\t\tif (!resourceAttrs.containsKey(resource)) {\n+\t\t\tresourceAttrs.put(resource,\n+\t\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, resource));\n+\t\t}\n+\n+\t\tif (loadVoAttributes) {\n+\t\t\tloadVoSpecificAttributes(resource);\n+\t\t}\n+\n+\t\tmemberResourceAttrs =\n+\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, resource, members);\n+\n+\t\t// we don't need to load again attributes for the already processed members\n+\t\tList<Member> notYetProcessedMembers = new ArrayList<>(members);\n+\t\tnotYetProcessedMembers.removeAll(processedMembers);\n+\t\tprocessedMembers.addAll(notYetProcessedMembers);\n+\n+\t\tloadMemberSpecificAttributes(notYetProcessedMembers);\n+\t}\n+\n+\t@Override\n+\tpublic List<String> getFacilityAttributesHashes() {\n+\t\tString hash = hasher.hashFacility(facility);\n+\n+\t\tif (!attributesByHash.containsKey(hash)) {\n+\t\t\tif (facilityAttrs == null) {\n+\t\t\t\tthrow new IllegalStateException(\"Facility attributes need to be loaded first.\");\n+\t\t\t}\n+\t\t\tattributesByHash.put(hash, facilityAttrs);\n+\t\t}\n+\n+\t\treturn attributesByHash.get(hash).isEmpty() ? emptyList() : singletonList(hash);\n+\t}\n+\n+\t@Override\n+\tpublic List<String> getResourceAttributesHashes(Resource resource, boolean addVoAttributes) {\n+\t\tList<String> hashes = getResourceAttributesHashes(resource);\n+\n+\t\t// create fake vo for optimization\n+\t\tVo vo = new Vo();\n+\t\tvo.setId(resource.getVoId());\n+\n+\t\tif (addVoAttributes) {\n+\t\t\thashes.addAll(getVoAttributesHashes(vo));\n+\t\t}\n+\n+\t\treturn hashes;\n+\t}\n+\n+\t@Override\n+\tpublic List<String> getMemberAttributesHashes(Resource resource, Member member) {\n+\t\tList<String> hashes = new ArrayList<>();\n+\n+\t\tUser user = loadedUsersById.get(member.getUserId());\n+\n+\t\thashes.addAll(getMemberAttributesHashes(member));\n+\t\thashes.addAll(getUserAttributesHashes(user));\n+\t\thashes.addAll(getUserFacilityAttributesHashes(user, facility));\n+\t\thashes.addAll(getMemberResourceAttributesHashes(member, resource));\n+\n+\t\treturn hashes;\n+\t}\n+\n+\t@Override\n+\tpublic List<String> getMemberAttributesHashes(Resource resource, Member member, Group group) {\n+\t\tList<String> hashes = getMemberAttributesHashes(resource, member);\n+\n+\t\thashes.addAll(getMemberGroupAttributesHashes(member, group));\n+\n+\t\treturn hashes;\n+\t}\n+\n+\t@Override\n+\tpublic List<String> getGroupAttributesHashes(Resource resource, Group group) {\n+\t\tList<String> hashes = new ArrayList<>();\n+\n+\t\thashes.addAll(getGroupAttributesHashes(group));\n+\t\thashes.addAll(getGroupResourceAttributesHashes(group, resource));\n+\n+\t\treturn hashes;\n+\t}\n+\n+\t@Override\n+\tpublic Map<String, List<Attribute>> getAllFetchedAttributes() {\n+\t\treturn attributesByHash.entrySet().stream()\n+\t\t\t\t.filter(entry -> !entry.getValue().isEmpty())\n+\t\t\t\t.collect(toMap(Map.Entry::getKey, Map.Entry::getValue));\n+\t}\n+\n+\tprivate List<String> getVoAttributesHashes(Vo vo) {\n+\t\tString hash = hasher.hashVo(vo);\n+\n+\t\treturn getAndStoreHash(hash, vo, voAttrs);\n+\t}\n+\n+\tprivate List<String> getMemberGroupAttributesHashes(Member member, Group group) {\n+\t\tif (!group.equals(lastLoadedGroup)) {\n+\t\t\tthrow new IllegalStateException(\"Cannot load member-group attributes for group \" + group + \", because last\" +\n+\t\t\t\t\t\"loaded group is: \" + lastLoadedGroup);\n+\t\t}\n+\t\tString hash = hasher.hashMemberGroup(member, group);\n+\n+\t\treturn getAndStoreHash(hash, member, memberGroupAttrs);\n+\t}\n+\n+\tprivate List<String> getMemberResourceAttributesHashes(Member member, Resource resource) {\n+\t\tif (!resource.equals(lastLoadedResource)) {\n+\t\t\tthrow new IllegalStateException(\"The last loaded resource is different than the required one. Required: \" +\n+\t\t\t\t\tresource + \", Last loaded: \" + lastLoadedResource);\n+\t\t}\n+\t\tString hash = hasher.hashMemberResource(member, resource);\n+\n+\t\treturn getAndStoreHash(hash, member, memberResourceAttrs);\n+\t}\n+\n+\tprivate List<String> getResourceAttributesHashes(Resource resource) {\n+\t\tString hash = hasher.hashResource(resource);\n+\n+\t\treturn getAndStoreHash(hash, resource, resourceAttrs);\n+\t}\n+\n+\tprivate List<String> getMemberAttributesHashes(Member member) {\n+\t\tString hash = hasher.hashMember(member);\n+\n+\t\treturn getAndStoreHash(hash, member, memberAttrs);\n+\t}\n+\n+\n+\tprivate List<String> getGroupAttributesHashes(Group group) {\n+\t\tString hash = hasher.hashGroup(group);\n+\n+\t\treturn getAndStoreHash(hash, group, groupAttrs);\n+\t}\n+\n+\tprivate List<String> getGroupResourceAttributesHashes(Group group, Resource resource) {\n+\t\tif (!resource.equals(lastLoadedResource)) {\n+\t\t\tthrow new IllegalStateException(\"The last loaded resource is different than the required one. Required: \" +\n+\t\t\t\t\tresource + \", Last loaded: \" + lastLoadedResource);\n+\t\t}\n+\n+\t\tString hash = hasher.hashGroupResource(group, resource);\n+\n+\t\treturn getAndStoreHash(hash, group, groupResourceAttrs);\n+\t}\n+\n+\tprivate List<String> getUserAttributesHashes(User user) {\n+\t\tString hash = hasher.hashUser(user);\n+\n+\t\treturn getAndStoreHash(hash, user, userAttrs);\n+\t}\n+\n+\tprivate List<String> getUserFacilityAttributesHashes(User user, Facility facility) {\n+\t\tString hash = hasher.hashUserFacility(user, facility);\n+\n+\t\treturn getAndStoreHash(hash, user, userFacilityAttrs);\n+\t}\n+\n+\t/**\n+\t * Get a list of attributes for given hash, and loads appropriate entity attributes from given map\n+\t * into the map of all processed attributes.\n+\t *\n+\t * If the map doesn't contain attributes for the given entity, or the list is empty,\n+\t * this method returns an empty list. Otherwise, it returns a List with the given hash.\n+\t *\n+\t * @param hash entity hash\n+\t * @param entity the entity which the hash belongs\n+\t * @param map map of attributes for the entity\n+\t * @param <T> the type of the entity User, Member, ...\n+\t * @return List with the hash or empty list if the map doesn't contain any attributes for the given entity\n+\t */\n+\tprivate <T> List<String> getAndStoreHash(String hash, T entity, Map<T, List<Attribute>> map) {\n+\t\tif (!attributesByHash.containsKey(hash)) {\n+\t\t\tif (!map.containsKey(entity)) {\n+\t\t\t\treturn emptyList();\n+\t\t\t}\n+\t\t\tattributesByHash.put(hash, map.get(entity));\n+\t\t}\n+\t\treturn attributesByHash.get(hash).isEmpty() ? emptyList() : singletonList(hash);\n+\t}\n+\n+\tprivate void loadMemberSpecificAttributes(List<Member> members) {\n+\t\tmemberAttrs.putAll(\n+\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, null, service, members)\n+\t\t);\n+\n+\t\tList<Integer> userIds = members.stream()\n+\t\t\t\t.map(Member::getUserId)\n+\t\t\t\t.collect(toList());\n+\n+\t\tList<User> users = sess.getPerunBl().getUsersManagerBl().getUsersByIds(sess, userIds);\n+\n+\t\tMap<Integer, User> usersById = users.stream()\n+\t\t\t\t.collect(toMap(User::getId, Function.identity()));\n+\t\tloadedUsersById.putAll(usersById);\n+\n+\t\tloadUserSpecificAttributes(users);\n+\t}\n+\n+\tprivate void loadUserSpecificAttributes(List<User> users) {\n+\t\tuserAttrs.putAll(\n+\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, users)\n+\t\t);\n+\n+\t\tuserFacilityAttrs.putAll(\n+\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, facility, users)\n+\t\t);\n+\t}\n+\n+\tprivate void loadVoSpecificAttributes(Resource resource) {\n+\t\t// create fake vo for map, because of optimization", "originalCommit": "c2360fc907b21688fc99c389718c4561a6c5d1aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjAxODEyMg==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r482018122", "bodyText": "Fixed.", "author": "Vojtech-Sassmann", "createdAt": "2020-09-02T12:08:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg1OTIzNg=="}], "type": "inlineReview", "revised_code": {"commit": "d1fe8e4df1f3aa6d69a0de18c3c8728df6fa3372", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java b/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java\nindex be3dece02..a781abde7 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java\n\n@@ -87,13 +87,13 @@ public class GenDataProviderImpl implements GenDataProvider {\n \n \t@Override\n \tpublic void loadFacilityAttributes() {\n-\t\tfacilityAttrs =\n-\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, facility);\n+\t\tfacilityAttrs = sess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, facility);\n \t}\n \n \t@Override\n \tpublic void loadGroupsAttributes(Resource resource, List<Group> groups) {\n \t\tgroupResourceAttrs = new HashMap<>();\n+\t\tlastLoadedResource = resource;\n \n \t\tfor (Group group: groups) {\n \t\t\ttry {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg2MDc0Mg==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r481860742", "bodyText": "There is probably missing assigning of actual processed resource object to variable lastLoadedResource.", "author": "stavamichal", "createdAt": "2020-09-02T08:03:30Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java", "diffHunk": "@@ -0,0 +1,358 @@\n+package cz.metacentrum.perun.core.provisioning;\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.Facility;\n+import cz.metacentrum.perun.core.api.Group;\n+import cz.metacentrum.perun.core.api.Member;\n+import cz.metacentrum.perun.core.api.Resource;\n+import cz.metacentrum.perun.core.api.Service;\n+import cz.metacentrum.perun.core.api.User;\n+import cz.metacentrum.perun.core.api.Vo;\n+import cz.metacentrum.perun.core.api.exceptions.GroupResourceMismatchException;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.MemberGroupMismatchException;\n+import cz.metacentrum.perun.core.api.exceptions.VoNotExistsException;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.function.Function;\n+\n+import static java.util.Collections.emptyList;\n+import static java.util.Collections.singletonList;\n+import static java.util.stream.Collectors.toList;\n+import static java.util.stream.Collectors.toMap;\n+\n+/**\n+ * @author Vojtech Sassmann <vojtech.sassmann@gmail.com>\n+ */\n+public class GenDataProviderImpl implements GenDataProvider {\n+\n+\tprivate final PerunSessionImpl sess;\n+\tprivate final Service service;\n+\tprivate final Facility facility;\n+\n+\tprivate final Map<String, List<Attribute>> attributesByHash = new HashMap<>();\n+\n+\tprivate List<Attribute> facilityAttrs;\n+\n+\t/**\n+\t * Map of Member-Resource attributes. This map is overwritten when data for new resource are loaded!!!\n+\t */\n+\tprivate Map<Member, List<Attribute>> memberResourceAttrs = new HashMap<>();\n+\n+\t/**\n+\t * Map of Group-Resource attributes. This map is overwritten when data for new resource are loaded!!!\n+\t */\n+\tprivate Map<Group, List<Attribute>> groupResourceAttrs = new HashMap<>();\n+\n+\t/**\n+\t * Map of Member-Group attributes. This map is overwritten when data for new group are loaded!!!\n+\t */\n+\tprivate Map<Member, List<Attribute>> memberGroupAttrs = new HashMap<>();\n+\n+\t/**\n+\t * These maps are not overwritten, because they do not depend on currently loaded entities.\n+\t */\n+\tprivate final Map<Member, List<Attribute>> memberAttrs = new HashMap<>();\n+\tprivate final Map<Group, List<Attribute>> groupAttrs = new HashMap<>();\n+\tprivate final Map<User, List<Attribute>> userAttrs = new HashMap<>();\n+\tprivate final Map<User, List<Attribute>> userFacilityAttrs = new HashMap<>();\n+\tprivate final Map<Resource, List<Attribute>> resourceAttrs = new HashMap<>();\n+\n+\t/**\n+\t * Vos has to contain only ids, or only vos loaded from DB. Because of the equals and hashCode\n+\t * implementations. If they were mixed, it would cause data duplicity.\n+\t */\n+\tprivate final Map<Vo, List<Attribute>> voAttrs = new HashMap<>();\n+\n+\tprivate Group lastLoadedGroup;\n+\tprivate Resource lastLoadedResource;\n+\n+\tprivate final Map<Integer, User> loadedUsersById = new HashMap<>();\n+\tprivate final Set<Member> processedMembers = new HashSet<>();\n+\tprivate final Set<Group> processedGroups = new HashSet<>();\n+\n+\tprivate final Hasher hasher = new IdHasher();\n+\n+\tpublic GenDataProviderImpl(PerunSessionImpl sess, Service service, Facility facility) {\n+\t\tthis.sess = sess;\n+\t\tthis.service = service;\n+\t\tthis.facility = facility;\n+\t}\n+\n+\t@Override\n+\tpublic void loadFacilityAttributes() {\n+\t\tfacilityAttrs =\n+\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, facility);\n+\t}\n+\n+\t@Override\n+\tpublic void loadGroupsAttributes(Resource resource, List<Group> groups) {\n+\t\tgroupResourceAttrs = new HashMap<>();\n+\n+\t\tfor (Group group: groups) {\n+\t\t\ttry {\n+\t\t\t\t// FIXME - attributes could be loaded at once to get a better performance\n+\t\t\t\tgroupResourceAttrs.put(group,\n+\t\t\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, resource, group));\n+\t\t\t} catch (GroupResourceMismatchException e) {\n+\t\t\t\tthrow new InternalErrorException(e);\n+\t\t\t}\n+\t\t}\n+\n+\t\tList<Group> notYetProcessedGroups = new ArrayList<>(groups);\n+\t\tnotYetProcessedGroups.removeAll(processedGroups);\n+\t\tprocessedGroups.addAll(notYetProcessedGroups);\n+\n+\t\tgroupAttrs.putAll(\n+\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributesForGroups(sess, service, groups)\n+\t\t);\n+\t}\n+\n+\t@Override\n+\tpublic void loadMemberGroupAttributes(Group group, List<Member> members) {\n+\t\tlastLoadedGroup = group;\n+\t\tmemberGroupAttrs = new HashMap<>();\n+\t\ttry {\n+\t\t\tmemberGroupAttrs.putAll(\n+\t\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, members, group)\n+\t\t\t);\n+\t\t} catch (MemberGroupMismatchException e) {\n+\t\t\tthrow new InternalErrorException(e);\n+\t\t}\n+\t}\n+\n+\t@Override\n+\tpublic void loadResourceAttributes(Resource resource, List<Member> members, boolean loadVoAttributes) {\n+\t\tlastLoadedResource = resource;\n+\n+\t\tif (!resourceAttrs.containsKey(resource)) {\n+\t\t\tresourceAttrs.put(resource,\n+\t\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, resource));\n+\t\t}\n+\n+\t\tif (loadVoAttributes) {\n+\t\t\tloadVoSpecificAttributes(resource);\n+\t\t}\n+\n+\t\tmemberResourceAttrs =\n+\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, resource, members);\n+\n+\t\t// we don't need to load again attributes for the already processed members\n+\t\tList<Member> notYetProcessedMembers = new ArrayList<>(members);\n+\t\tnotYetProcessedMembers.removeAll(processedMembers);\n+\t\tprocessedMembers.addAll(notYetProcessedMembers);\n+\n+\t\tloadMemberSpecificAttributes(notYetProcessedMembers);\n+\t}\n+\n+\t@Override\n+\tpublic List<String> getFacilityAttributesHashes() {\n+\t\tString hash = hasher.hashFacility(facility);\n+\n+\t\tif (!attributesByHash.containsKey(hash)) {\n+\t\t\tif (facilityAttrs == null) {\n+\t\t\t\tthrow new IllegalStateException(\"Facility attributes need to be loaded first.\");\n+\t\t\t}\n+\t\t\tattributesByHash.put(hash, facilityAttrs);\n+\t\t}\n+\n+\t\treturn attributesByHash.get(hash).isEmpty() ? emptyList() : singletonList(hash);\n+\t}\n+\n+\t@Override\n+\tpublic List<String> getResourceAttributesHashes(Resource resource, boolean addVoAttributes) {\n+\t\tList<String> hashes = getResourceAttributesHashes(resource);\n+\n+\t\t// create fake vo for optimization\n+\t\tVo vo = new Vo();\n+\t\tvo.setId(resource.getVoId());\n+\n+\t\tif (addVoAttributes) {\n+\t\t\thashes.addAll(getVoAttributesHashes(vo));\n+\t\t}\n+\n+\t\treturn hashes;\n+\t}\n+\n+\t@Override\n+\tpublic List<String> getMemberAttributesHashes(Resource resource, Member member) {\n+\t\tList<String> hashes = new ArrayList<>();\n+\n+\t\tUser user = loadedUsersById.get(member.getUserId());\n+\n+\t\thashes.addAll(getMemberAttributesHashes(member));\n+\t\thashes.addAll(getUserAttributesHashes(user));\n+\t\thashes.addAll(getUserFacilityAttributesHashes(user, facility));\n+\t\thashes.addAll(getMemberResourceAttributesHashes(member, resource));\n+\n+\t\treturn hashes;\n+\t}\n+\n+\t@Override\n+\tpublic List<String> getMemberAttributesHashes(Resource resource, Member member, Group group) {\n+\t\tList<String> hashes = getMemberAttributesHashes(resource, member);\n+\n+\t\thashes.addAll(getMemberGroupAttributesHashes(member, group));\n+\n+\t\treturn hashes;\n+\t}\n+\n+\t@Override\n+\tpublic List<String> getGroupAttributesHashes(Resource resource, Group group) {\n+\t\tList<String> hashes = new ArrayList<>();\n+\n+\t\thashes.addAll(getGroupAttributesHashes(group));\n+\t\thashes.addAll(getGroupResourceAttributesHashes(group, resource));\n+\n+\t\treturn hashes;\n+\t}\n+\n+\t@Override\n+\tpublic Map<String, List<Attribute>> getAllFetchedAttributes() {\n+\t\treturn attributesByHash.entrySet().stream()\n+\t\t\t\t.filter(entry -> !entry.getValue().isEmpty())\n+\t\t\t\t.collect(toMap(Map.Entry::getKey, Map.Entry::getValue));\n+\t}\n+\n+\tprivate List<String> getVoAttributesHashes(Vo vo) {\n+\t\tString hash = hasher.hashVo(vo);\n+\n+\t\treturn getAndStoreHash(hash, vo, voAttrs);\n+\t}\n+\n+\tprivate List<String> getMemberGroupAttributesHashes(Member member, Group group) {\n+\t\tif (!group.equals(lastLoadedGroup)) {\n+\t\t\tthrow new IllegalStateException(\"Cannot load member-group attributes for group \" + group + \", because last\" +\n+\t\t\t\t\t\"loaded group is: \" + lastLoadedGroup);\n+\t\t}\n+\t\tString hash = hasher.hashMemberGroup(member, group);\n+\n+\t\treturn getAndStoreHash(hash, member, memberGroupAttrs);\n+\t}\n+\n+\tprivate List<String> getMemberResourceAttributesHashes(Member member, Resource resource) {\n+\t\tif (!resource.equals(lastLoadedResource)) {\n+\t\t\tthrow new IllegalStateException(\"The last loaded resource is different than the required one. Required: \" +\n+\t\t\t\t\tresource + \", Last loaded: \" + lastLoadedResource);\n+\t\t}\n+\t\tString hash = hasher.hashMemberResource(member, resource);\n+\n+\t\treturn getAndStoreHash(hash, member, memberResourceAttrs);\n+\t}\n+\n+\tprivate List<String> getResourceAttributesHashes(Resource resource) {\n+\t\tString hash = hasher.hashResource(resource);\n+\n+\t\treturn getAndStoreHash(hash, resource, resourceAttrs);\n+\t}\n+\n+\tprivate List<String> getMemberAttributesHashes(Member member) {\n+\t\tString hash = hasher.hashMember(member);\n+\n+\t\treturn getAndStoreHash(hash, member, memberAttrs);\n+\t}\n+\n+\n+\tprivate List<String> getGroupAttributesHashes(Group group) {\n+\t\tString hash = hasher.hashGroup(group);\n+\n+\t\treturn getAndStoreHash(hash, group, groupAttrs);\n+\t}\n+\n+\tprivate List<String> getGroupResourceAttributesHashes(Group group, Resource resource) {\n+\t\tif (!resource.equals(lastLoadedResource)) {\n+\t\t\tthrow new IllegalStateException(\"The last loaded resource is different than the required one. Required: \" +\n+\t\t\t\t\tresource + \", Last loaded: \" + lastLoadedResource);\n+\t\t}\n+\n+\t\tString hash = hasher.hashGroupResource(group, resource);\n+\n+\t\treturn getAndStoreHash(hash, group, groupResourceAttrs);\n+\t}\n+\n+\tprivate List<String> getUserAttributesHashes(User user) {\n+\t\tString hash = hasher.hashUser(user);\n+\n+\t\treturn getAndStoreHash(hash, user, userAttrs);\n+\t}\n+\n+\tprivate List<String> getUserFacilityAttributesHashes(User user, Facility facility) {\n+\t\tString hash = hasher.hashUserFacility(user, facility);\n+\n+\t\treturn getAndStoreHash(hash, user, userFacilityAttrs);\n+\t}\n+\n+\t/**\n+\t * Get a list of attributes for given hash, and loads appropriate entity attributes from given map\n+\t * into the map of all processed attributes.\n+\t *\n+\t * If the map doesn't contain attributes for the given entity, or the list is empty,\n+\t * this method returns an empty list. Otherwise, it returns a List with the given hash.\n+\t *\n+\t * @param hash entity hash\n+\t * @param entity the entity which the hash belongs\n+\t * @param map map of attributes for the entity\n+\t * @param <T> the type of the entity User, Member, ...\n+\t * @return List with the hash or empty list if the map doesn't contain any attributes for the given entity\n+\t */\n+\tprivate <T> List<String> getAndStoreHash(String hash, T entity, Map<T, List<Attribute>> map) {\n+\t\tif (!attributesByHash.containsKey(hash)) {\n+\t\t\tif (!map.containsKey(entity)) {\n+\t\t\t\treturn emptyList();\n+\t\t\t}\n+\t\t\tattributesByHash.put(hash, map.get(entity));\n+\t\t}\n+\t\treturn attributesByHash.get(hash).isEmpty() ? emptyList() : singletonList(hash);\n+\t}\n+\n+\tprivate void loadMemberSpecificAttributes(List<Member> members) {\n+\t\tmemberAttrs.putAll(\n+\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, null, service, members)\n+\t\t);\n+\n+\t\tList<Integer> userIds = members.stream()\n+\t\t\t\t.map(Member::getUserId)\n+\t\t\t\t.collect(toList());\n+\n+\t\tList<User> users = sess.getPerunBl().getUsersManagerBl().getUsersByIds(sess, userIds);\n+\n+\t\tMap<Integer, User> usersById = users.stream()\n+\t\t\t\t.collect(toMap(User::getId, Function.identity()));\n+\t\tloadedUsersById.putAll(usersById);\n+\n+\t\tloadUserSpecificAttributes(users);\n+\t}\n+\n+\tprivate void loadUserSpecificAttributes(List<User> users) {\n+\t\tuserAttrs.putAll(\n+\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, users)\n+\t\t);\n+\n+\t\tuserFacilityAttrs.putAll(\n+\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, facility, users)\n+\t\t);\n+\t}\n+\n+\tprivate void loadVoSpecificAttributes(Resource resource) {\n+\t\t// create fake vo for map, because of optimization\n+\t\tVo vo = new Vo();\n+\t\tvo.setId(resource.getVoId());\n+\t\tif (!voAttrs.containsKey(vo)) {", "originalCommit": "c2360fc907b21688fc99c389718c4561a6c5d1aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjAxMzQ4NQ==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r482013485", "bodyText": "I was missing because this was a private method and at the place where it was used, the last loaded resource was set. But I have added it here as well just to make sure.", "author": "Vojtech-Sassmann", "createdAt": "2020-09-02T11:59:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg2MDc0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "d1fe8e4df1f3aa6d69a0de18c3c8728df6fa3372", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java b/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java\nindex be3dece02..a781abde7 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GenDataProviderImpl.java\n\n@@ -87,13 +87,13 @@ public class GenDataProviderImpl implements GenDataProvider {\n \n \t@Override\n \tpublic void loadFacilityAttributes() {\n-\t\tfacilityAttrs =\n-\t\t\t\tsess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, facility);\n+\t\tfacilityAttrs = sess.getPerunBl().getAttributesManagerBl().getRequiredAttributes(sess, service, facility);\n \t}\n \n \t@Override\n \tpublic void loadGroupsAttributes(Resource resource, List<Group> groups) {\n \t\tgroupResourceAttrs = new HashMap<>();\n+\t\tlastLoadedResource = resource;\n \n \t\tfor (Group group: groups) {\n \t\t\ttry {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg2MzA5MQ==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r481863091", "bodyText": "Please add at least a simple Javadoc about this class.", "author": "stavamichal", "createdAt": "2020-09-02T08:06:15Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/IdHasher.java", "diffHunk": "@@ -0,0 +1,64 @@\n+package cz.metacentrum.perun.core.provisioning;\n+\n+import cz.metacentrum.perun.core.api.Facility;\n+import cz.metacentrum.perun.core.api.Group;\n+import cz.metacentrum.perun.core.api.Member;\n+import cz.metacentrum.perun.core.api.Resource;\n+import cz.metacentrum.perun.core.api.User;\n+import cz.metacentrum.perun.core.api.Vo;\n+\n+/**\n+ * @author Vojtech Sassmann <vojtech.sassmann@gmail.com>\n+ */\n+public class IdHasher implements Hasher {", "originalCommit": "c2360fc907b21688fc99c389718c4561a6c5d1aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjAxMzgxMg==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r482013812", "bodyText": "Done.", "author": "Vojtech-Sassmann", "createdAt": "2020-09-02T11:59:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg2MzA5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "d1fe8e4df1f3aa6d69a0de18c3c8728df6fa3372", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/IdHasher.java b/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/IdHasher.java\nindex 8d652a63e..0ec19efa2 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/IdHasher.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/IdHasher.java\n\n@@ -8,6 +8,8 @@ import cz.metacentrum.perun.core.api.User;\n import cz.metacentrum.perun.core.api.Vo;\n \n /**\n+ * Generates hashes based on ids of the beans.\n+ *\n  * @author Vojtech Sassmann <vojtech.sassmann@gmail.com>\n  */\n public class IdHasher implements Hasher {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg3NDY4Ng==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r481874686", "bodyText": "You can use FacilitiesManager.getAssignedResources(sess, facility, specificVo, specificService) instead and call it as:\nList<Resource> resources = sess.getPerunBl().getFacilitiesManagerBl().getAssignedResources(sess, facility, null, service);", "author": "stavamichal", "createdAt": "2020-09-02T08:19:22Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/HierarchicalHashedDataGenerator.java", "diffHunk": "@@ -0,0 +1,149 @@\n+package cz.metacentrum.perun.core.provisioning;\n+\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.Facility;\n+import cz.metacentrum.perun.core.api.GenDataNode;\n+import cz.metacentrum.perun.core.api.GenMemberDataNode;\n+import cz.metacentrum.perun.core.api.HashedGenData;\n+import cz.metacentrum.perun.core.api.Member;\n+import cz.metacentrum.perun.core.api.Resource;\n+import cz.metacentrum.perun.core.api.Service;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Generates data in format:\n+ *\n+ * attributes: {...hashes...}\n+ * hierarchy: {\n+ *    ** facility **\n+ *    hashes: [...hashes...]\n+ *    members: []\n+ *    children: [\n+ *      {\n+ *        ** resource1 **\n+ *        hashes: [...hashes...]\n+ *        children: []\n+ *        members: [\n+ *          {\n+ *            ** member 1 **\n+ *            hashes: [...hashes...]\n+ *          },\n+ *          {\n+ *            ** member 2 **\n+ *            ...\n+ *          }\n+ *        ]\n+ *      },\n+ *      {\n+ *        ** resource2 **\n+ *        ...\n+ *      }\n+ *    ]\n+ * }\n+ *\n+ * @author Vojtech Sassmann <vojtech.sassmann@gmail.com>\n+ */\n+public class HierarchicalHashedDataGenerator implements HashedDataGenerator {\n+\n+\tprivate final PerunSessionImpl sess;\n+\tprivate final Service service;\n+\tprivate final Facility facility;\n+\tprivate final GenDataProvider dataProvider;\n+\tprivate final boolean filterExpiredMembers;\n+\n+\tprivate HierarchicalHashedDataGenerator(PerunSessionImpl sess, Service service, Facility facility,\n+\t                                        boolean filterExpiredMembers) {\n+\t\tthis.sess = sess;\n+\t\tthis.service = service;\n+\t\tthis.facility = facility;\n+\t\tthis.filterExpiredMembers = filterExpiredMembers;\n+\t\tdataProvider = new GenDataProviderImpl(sess, service, facility);\n+\t}\n+\n+\t@Override\n+\tpublic HashedGenData generateData() {\n+\t\tdataProvider.loadFacilityAttributes();\n+\n+\t\tList<Resource> resources = sess.getPerunBl().getFacilitiesManagerBl().getAssignedResources(sess, facility);\n+\t\tresources.retainAll(sess.getPerunBl().getServicesManagerBl().getAssignedResources(sess, service));", "originalCommit": "c2360fc907b21688fc99c389718c4561a6c5d1aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjAxODU5Nw==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r482018597", "bodyText": "replaced", "author": "Vojtech-Sassmann", "createdAt": "2020-09-02T12:09:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg3NDY4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "d1fe8e4df1f3aa6d69a0de18c3c8728df6fa3372", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/HierarchicalHashedDataGenerator.java b/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/HierarchicalHashedDataGenerator.java\nindex 106980dec..83ef5d17c 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/HierarchicalHashedDataGenerator.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/HierarchicalHashedDataGenerator.java\n\n@@ -69,8 +69,8 @@ public class HierarchicalHashedDataGenerator implements HashedDataGenerator {\n \tpublic HashedGenData generateData() {\n \t\tdataProvider.loadFacilityAttributes();\n \n-\t\tList<Resource> resources = sess.getPerunBl().getFacilitiesManagerBl().getAssignedResources(sess, facility);\n-\t\tresources.retainAll(sess.getPerunBl().getServicesManagerBl().getAssignedResources(sess, service));\n+\t\tList<Resource> resources =\n+\t\t\t\tsess.getPerunBl().getFacilitiesManagerBl().getAssignedResources(sess, facility, null, service);\n \n \t\tList<GenDataNode> childNodes = resources.stream()\n \t\t\t\t.map(this::getDataForResource)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg3NDkxMw==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r481874913", "bodyText": "You can use FacilitiesManager.getAssignedResources(sess, facility, specificVo, specificService) instead and call it as:\nList<Resource> resources = sess.getPerunBl().getFacilitiesManagerBl().getAssignedResources(sess, facility, null, service);", "author": "stavamichal", "createdAt": "2020-09-02T08:19:36Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GroupsHashedDataGenerator.java", "diffHunk": "@@ -0,0 +1,209 @@\n+package cz.metacentrum.perun.core.provisioning;\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.Facility;\n+import cz.metacentrum.perun.core.api.GenDataNode;\n+import cz.metacentrum.perun.core.api.GenMemberDataNode;\n+import cz.metacentrum.perun.core.api.Group;\n+import cz.metacentrum.perun.core.api.HashedGenData;\n+import cz.metacentrum.perun.core.api.Member;\n+import cz.metacentrum.perun.core.api.Resource;\n+import cz.metacentrum.perun.core.api.Service;\n+import cz.metacentrum.perun.core.api.VosManager;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Generates data in format:\n+ *\n+ * attributes: {...hashes...}\n+ * hierarchy: {\n+ *    ** facility **\n+ *    hashes: [...hashes...]\n+ *    members: []\n+ *    children: [\n+ *      {\n+ *        ** resource1 **\n+ *        hashes: [...hashes...]\n+ *        children: [\n+ *          {\n+ *            ** group A **\n+ *            hashes: [...hashes...]\n+ *            members: [...group members...]\n+ *            children: [...sub groups...]\n+ *          },\n+ *          {\n+ *            ** group B **\n+ *            ...\n+ *          }\n+ *        ]\n+ *        members: [\n+ *          {\n+ *            ** member 1 **\n+ *            hashes: [...hashes...]\n+ *          },\n+ *          {\n+ *            ** member 2 **\n+ *            ...\n+ *          }\n+ *        ]\n+ *      },\n+ *      {\n+ *        ** resource2 **\n+ *        ...\n+ *      }\n+ *    ]\n+ * }\n+ *\n+ * @author Vojtech Sassmann <vojtech.sassmann@gmail.com>\n+ */\n+public class GroupsHashedDataGenerator implements HashedDataGenerator {\n+\n+\tprivate final PerunSessionImpl sess;\n+\tprivate final Service service;\n+\tprivate final Facility facility;\n+\tprivate final GenDataProvider dataProvider;\n+\tprivate final boolean filterExpiredMembers;\n+\n+\tprivate GroupsHashedDataGenerator(PerunSessionImpl sess, Service service, Facility facility,\n+\t                                 boolean filterExpiredMembers) {\n+\t\tthis.sess = sess;\n+\t\tthis.service = service;\n+\t\tthis.facility = facility;\n+\t\tthis.filterExpiredMembers = filterExpiredMembers;\n+\t\tdataProvider = new GenDataProviderImpl(sess, service, facility);\n+\t}\n+\n+\t@Override\n+\tpublic HashedGenData generateData() {\n+\t\tdataProvider.loadFacilityAttributes();\n+\n+\t\tList<Resource> resources = sess.getPerunBl().getFacilitiesManagerBl().getAssignedResources(sess, facility);\n+\t\tresources.retainAll(sess.getPerunBl().getServicesManagerBl().getAssignedResources(sess, service));", "originalCommit": "c2360fc907b21688fc99c389718c4561a6c5d1aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjAxODc3MA==", "url": "https://github.com/CESNET/perun/pull/2871#discussion_r482018770", "bodyText": "Fixed.", "author": "Vojtech-Sassmann", "createdAt": "2020-09-02T12:09:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg3NDkxMw=="}], "type": "inlineReview", "revised_code": {"commit": "d1fe8e4df1f3aa6d69a0de18c3c8728df6fa3372", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GroupsHashedDataGenerator.java b/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GroupsHashedDataGenerator.java\nindex 94c2350a1..9cd9dbfa1 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GroupsHashedDataGenerator.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GroupsHashedDataGenerator.java\n\n@@ -82,8 +82,7 @@ public class GroupsHashedDataGenerator implements HashedDataGenerator {\n \tpublic HashedGenData generateData() {\n \t\tdataProvider.loadFacilityAttributes();\n \n-\t\tList<Resource> resources = sess.getPerunBl().getFacilitiesManagerBl().getAssignedResources(sess, facility);\n-\t\tresources.retainAll(sess.getPerunBl().getServicesManagerBl().getAssignedResources(sess, service));\n+\t\tList<Resource> resources = sess.getPerunBl().getFacilitiesManagerBl().getAssignedResources(sess, facility, null, service);\n \n \t\tList<GenDataNode> childNodes = resources.stream()\n \t\t\t\t.map(this::getDataForResource)\n"}}, {"oid": "d1fe8e4df1f3aa6d69a0de18c3c8728df6fa3372", "url": "https://github.com/CESNET/perun/commit/d1fe8e4df1f3aa6d69a0de18c3c8728df6fa3372", "message": "Core - new method to gen data\n\n* Created new methods `getHashedHierarchicalData` and `getHashedDataWithGroups`\nthat can be used to generate data for provisioning. It doesn't duplicate\nattributes data, which was a problem with the old implementation.\n* These methods are meant for testing, they might change in the future.\n* Created new methods in attributesManager to load attributes in a\nsingle query to increase performance.", "committedDate": "2020-09-02T12:09:56Z", "type": "forcePushed"}, {"oid": "1d897e7ecef9b25dc09aa2a8abd3b2d07fe035ee", "url": "https://github.com/CESNET/perun/commit/1d897e7ecef9b25dc09aa2a8abd3b2d07fe035ee", "message": "Core - new method to gen data\n\n* Created new methods `getHashedHierarchicalData` and `getHashedDataWithGroups`\nthat can be used to generate data for provisioning. It doesn't duplicate\nattributes data, which was a problem with the old implementation.\n* These methods are meant for testing, they might change in the future.\n* Created new methods in attributesManager to load attributes in a\nsingle query to increase performance.", "committedDate": "2020-09-02T14:31:07Z", "type": "forcePushed"}, {"oid": "de9b3f6207ad6c1893790fe0aa9c97d2aa348c3d", "url": "https://github.com/CESNET/perun/commit/de9b3f6207ad6c1893790fe0aa9c97d2aa348c3d", "message": "Core - new method to gen data\n\n* Created new methods `getHashedHierarchicalData` and `getHashedDataWithGroups`\nthat can be used to generate data for provisioning. It doesn't duplicate\nattributes data, which was a problem with the old implementation.\n* These methods are meant for testing, they might change in the future.\n* Created new methods in attributesManager to load attributes in a\nsingle query to increase performance.", "committedDate": "2020-09-02T15:43:29Z", "type": "forcePushed"}, {"oid": "38555656c8acddd0247e6c05161c190bab61b5b4", "url": "https://github.com/CESNET/perun/commit/38555656c8acddd0247e6c05161c190bab61b5b4", "message": "Core - new method to gen data\n\n* Created new methods `getHashedHierarchicalData` and `getHashedDataWithGroups`\nthat can be used to generate data for provisioning. It doesn't duplicate\nattributes data, which was a problem with the old implementation.\n* These methods are meant for testing, they might change in the future.\n* Created new methods in attributesManager to load attributes in a\nsingle query to increase performance.", "committedDate": "2020-09-02T15:50:57Z", "type": "commit"}, {"oid": "38555656c8acddd0247e6c05161c190bab61b5b4", "url": "https://github.com/CESNET/perun/commit/38555656c8acddd0247e6c05161c190bab61b5b4", "message": "Core - new method to gen data\n\n* Created new methods `getHashedHierarchicalData` and `getHashedDataWithGroups`\nthat can be used to generate data for provisioning. It doesn't duplicate\nattributes data, which was a problem with the old implementation.\n* These methods are meant for testing, they might change in the future.\n* Created new methods in attributesManager to load attributes in a\nsingle query to increase performance.", "committedDate": "2020-09-02T15:50:57Z", "type": "forcePushed"}]}