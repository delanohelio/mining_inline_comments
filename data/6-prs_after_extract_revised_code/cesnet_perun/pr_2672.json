{"pr_number": 2672, "pr_title": "additional identifiers support in RegistrarModule", "pr_createdAt": "2020-04-23T15:56:42Z", "pr_url": "https://github.com/CESNET/perun/pull/2672", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDMzOTM1Mw==", "url": "https://github.com/CESNET/perun/pull/2672#discussion_r414339353", "bodyText": "If you create member like this, you must explicitly set user/member attributes, which were originally passed inside candidate object. See:\n// store all attributes (but not logins)\nstoreApplicationAttributes(app);", "author": "zlamalp", "createdAt": "2020-04-24T06:55:37Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java", "diffHunk": "@@ -1789,21 +1792,31 @@ public Application approveApplicationInternal(PerunSession sess, int appId) thro\n \t\t\t\tUtils.checkMaxLength(\"TitleBefore\", candidate.getTitleBefore(), 40);\n \t\t\t\tUtils.checkMaxLength(\"TitleAfter\", candidate.getTitleAfter(), 40);\n \n-\t\t\t\tmember = membersManager.createMember(sess, app.getVo(), app.getExtSourceName(), app.getExtSourceType(), app.getExtSourceLoa(), app.getCreatedBy(), candidate);\n-\t\t\t\tUser u = usersManager.getUserById(registrarSession, member.getUserId());\n-\n+\t\t\t\tUser u;\n \t\t\t\tif (app.getUser() != null) {\n+\t\t\t\t\tu = app.getUser();\n+\t\t\t\t\tmember = membersManager.createMember(sess, app.getVo(), u);", "originalCommit": "4575226a29f608297cc188e41e6d28f4eddcaf43", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDY4NjM0Ng==", "url": "https://github.com/CESNET/perun/pull/2672#discussion_r414686346", "bodyText": "Fixed", "author": "balcirakpeter", "createdAt": "2020-04-24T15:58:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDMzOTM1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "62f54c8c61989cb991a471aeaf578a95385faa39", "chunk": "diff --git a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\nindex 8a6bb5fff..886d8f90d 100644\n--- a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\n+++ b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\n\n@@ -1717,85 +1718,15 @@ public class RegistrarManagerImpl implements RegistrarManager {\n \n \t\t\t} else {\n \n-\t\t\t\t// put application data into Candidate\n-\t\t\t\tfinal Map<String, String> attributes = new HashMap<>();\n-\t\t\t\tjdbc.query(\"select dst_attr,value from application_data d, application_form_items i where d.item_id=i.id \"\n-\t\t\t\t\t\t\t\t+ \"and i.dst_attr is not null and d.value is not null and app_id=?\",\n-\t\t\t\t\t\t(resultSet, i) -> {\n-\t\t\t\t\t\t\tattributes.put(resultSet.getString(\"dst_attr\"), resultSet.getString(\"value\"));\n-\t\t\t\t\t\t\treturn null;\n-\t\t\t\t\t\t}, appId);\n-\n-\t\t\t\t// DO NOT STORE LOGINS THROUGH CANDIDATE\n-\t\t\t\t// we do not set logins by candidate object to prevent accidental overwrite while joining identities in process\n-\t\t\t\tattributes.entrySet().removeIf(entry -> entry.getKey().contains(\"urn:perun:user:attribute-def:def:login-namespace:\"));\n-\n-\t\t\t\tCandidate candidate = new Candidate();\n-\t\t\t\tcandidate.setAttributes(attributes);\n-\n-\t\t\t\tlog.debug(\"[REGISTRAR] Retrieved candidate from DB {}\", candidate);\n-\n-\t\t\t\t// first try to parse display_name if not null and not empty\n-\t\t\t\tif (attributes.containsKey(URN_USER_DISPLAY_NAME) && attributes.get(URN_USER_DISPLAY_NAME) != null &&\n-\t\t\t\t\t\t!attributes.get(URN_USER_DISPLAY_NAME).isEmpty()) {\n-\t\t\t\t\t// parse\n-\t\t\t\t\tMap<String, String> commonName = Utils.parseCommonName(attributes.get(URN_USER_DISPLAY_NAME));\n-\t\t\t\t\tif (commonName.get(\"titleBefore\") != null\n-\t\t\t\t\t\t\t&& !commonName.get(\"titleBefore\").isEmpty()) {\n-\t\t\t\t\t\tcandidate.setTitleBefore(commonName.get(\"titleBefore\"));\n-\t\t\t\t\t}\n-\t\t\t\t\tif (commonName.get(\"firstName\") != null\n-\t\t\t\t\t\t\t&& !commonName.get(\"firstName\").isEmpty()) {\n-\t\t\t\t\t\tcandidate.setFirstName(commonName.get(\"firstName\"));\n-\t\t\t\t\t}\n-\t\t\t\t\t// FIXME - ? there is no middleName in Utils.parseCommonName() implementation\n-\t\t\t\t\tif (commonName.get(\"middleName\") != null\n-\t\t\t\t\t\t\t&& !commonName.get(\"middleName\").isEmpty()) {\n-\t\t\t\t\t\tcandidate.setMiddleName(commonName.get(\"middleName\"));\n-\t\t\t\t\t}\n-\t\t\t\t\tif (commonName.get(\"lastName\") != null\n-\t\t\t\t\t\t\t&& !commonName.get(\"lastName\").isEmpty()) {\n-\t\t\t\t\t\tcandidate.setLastName(commonName.get(\"lastName\"));\n-\t\t\t\t\t}\n-\t\t\t\t\tif (commonName.get(\"titleAfter\") != null\n-\t\t\t\t\t\t\t&& !commonName.get(\"titleAfter\").isEmpty()) {\n-\t\t\t\t\t\tcandidate.setTitleAfter(commonName.get(\"titleAfter\"));\n-\t\t\t\t\t}\n-\t\t\t\t}\n-\n-\t\t\t\t// if names are separated, used them after\n-\t\t\t\tfor (String attrName : attributes.keySet()) {\n-\t\t\t\t\t// if value not null or empty - set to candidate\n-\t\t\t\t\tif (attributes.get(attrName) != null\n-\t\t\t\t\t\t\t&& !attributes.get(attrName).isEmpty()) {\n-\t\t\t\t\t\tif (URN_USER_TITLE_BEFORE.equals(attrName)) {\n-\t\t\t\t\t\t\tcandidate.setTitleBefore(attributes.get(attrName));\n-\t\t\t\t\t\t} else if (URN_USER_TITLE_AFTER.equals(attrName)) {\n-\t\t\t\t\t\t\tcandidate.setTitleAfter(attributes.get(attrName));\n-\t\t\t\t\t\t} else if (URN_USER_FIRST_NAME.equals(attrName)) {\n-\t\t\t\t\t\t\tcandidate.setFirstName(attributes.get(attrName));\n-\t\t\t\t\t\t} else if (URN_USER_LAST_NAME.equals(attrName)) {\n-\t\t\t\t\t\t\tcandidate.setLastName(attributes.get(attrName));\n-\t\t\t\t\t\t} else if (URN_USER_MIDDLE_NAME.equals(attrName)) {\n-\t\t\t\t\t\t\tcandidate.setMiddleName(attributes.get(attrName));\n-\t\t\t\t\t\t}\n-\t\t\t\t\t}\n-\t\t\t\t}\n-\n \t\t\t\t// free reserved logins so they can be set as attributes\n \t\t\t\tjdbc.update(\"delete from application_reserved_logins where app_id=?\", appId);\n \n-\t\t\t\t// create member and user\n-\t\t\t\tlog.debug(\"[REGISTRAR] Trying to make member from candidate {}\", candidate);\n-\n-\t\t\t\t// added duplicit check, since we switched from entry to bl call of createMember()\n-\t\t\t\tUtils.checkMaxLength(\"TitleBefore\", candidate.getTitleBefore(), 40);\n-\t\t\t\tUtils.checkMaxLength(\"TitleAfter\", candidate.getTitleAfter(), 40);\n-\n \t\t\t\tUser u;\n \t\t\t\tif (app.getUser() != null) {\n \t\t\t\t\tu = app.getUser();\n \t\t\t\t\tmember = membersManager.createMember(sess, app.getVo(), u);\n+\t\t\t\t\t// store all attributes (but not logins)\n+\t\t\t\t\tstoreApplicationAttributes(app);\n \t\t\t\t\t// if user was already known to perun, createMember() will set attributes\n \t\t\t\t\t// via setAttributes() method so core attributes are skipped\n \t\t\t\t\t// ==> updateNameTitles() in case of change in appForm.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDMzOTY1MA==", "url": "https://github.com/CESNET/perun/pull/2672#discussion_r414339650", "bodyText": "If you create member like this, you must explicitly set user/member attributes, which were originally passed inside candidate object. See:\n// store all attributes (but not logins)\nstoreApplicationAttributes(app);", "author": "zlamalp", "createdAt": "2020-04-24T06:56:12Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java", "diffHunk": "@@ -1789,21 +1792,31 @@ public Application approveApplicationInternal(PerunSession sess, int appId) thro\n \t\t\t\tUtils.checkMaxLength(\"TitleBefore\", candidate.getTitleBefore(), 40);\n \t\t\t\tUtils.checkMaxLength(\"TitleAfter\", candidate.getTitleAfter(), 40);\n \n-\t\t\t\tmember = membersManager.createMember(sess, app.getVo(), app.getExtSourceName(), app.getExtSourceType(), app.getExtSourceLoa(), app.getCreatedBy(), candidate);\n-\t\t\t\tUser u = usersManager.getUserById(registrarSession, member.getUserId());\n-\n+\t\t\t\tUser u;\n \t\t\t\tif (app.getUser() != null) {\n+\t\t\t\t\tu = app.getUser();\n+\t\t\t\t\tmember = membersManager.createMember(sess, app.getVo(), u);\n \t\t\t\t\t// if user was already known to perun, createMember() will set attributes\n \t\t\t\t\t// via setAttributes() method so core attributes are skipped\n \t\t\t\t\t// ==> updateNameTitles() in case of change in appForm.\n \t\t\t\t\tupdateUserNameTitles(app);\n \t\t\t\t} else {\n+\t\t\t\t\tu = perun.getUsersManagerBl().getUserByExtSourceInformation(registrarSession, applicationPrincipal);\n+\t\t\t\t\tif (u == null) {\n+\t\t\t\t\t\tmember = membersManager.createMember(sess, app.getVo(), app.getExtSourceName(), app.getExtSourceType(), app.getExtSourceLoa(), app.getCreatedBy(), candidate);\n+\t\t\t\t\t\tu = usersManager.getUserById(registrarSession, member.getUserId());\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\tmember = membersManager.createMember(sess, app.getVo(), u);", "originalCommit": "4575226a29f608297cc188e41e6d28f4eddcaf43", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDY4NjI4MQ==", "url": "https://github.com/CESNET/perun/pull/2672#discussion_r414686281", "bodyText": "Fixed", "author": "balcirakpeter", "createdAt": "2020-04-24T15:58:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDMzOTY1MA=="}], "type": "inlineReview", "revised_code": {"commit": "62f54c8c61989cb991a471aeaf578a95385faa39", "chunk": "diff --git a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\nindex 8a6bb5fff..886d8f90d 100644\n--- a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\n+++ b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\n\n@@ -1717,85 +1718,15 @@ public class RegistrarManagerImpl implements RegistrarManager {\n \n \t\t\t} else {\n \n-\t\t\t\t// put application data into Candidate\n-\t\t\t\tfinal Map<String, String> attributes = new HashMap<>();\n-\t\t\t\tjdbc.query(\"select dst_attr,value from application_data d, application_form_items i where d.item_id=i.id \"\n-\t\t\t\t\t\t\t\t+ \"and i.dst_attr is not null and d.value is not null and app_id=?\",\n-\t\t\t\t\t\t(resultSet, i) -> {\n-\t\t\t\t\t\t\tattributes.put(resultSet.getString(\"dst_attr\"), resultSet.getString(\"value\"));\n-\t\t\t\t\t\t\treturn null;\n-\t\t\t\t\t\t}, appId);\n-\n-\t\t\t\t// DO NOT STORE LOGINS THROUGH CANDIDATE\n-\t\t\t\t// we do not set logins by candidate object to prevent accidental overwrite while joining identities in process\n-\t\t\t\tattributes.entrySet().removeIf(entry -> entry.getKey().contains(\"urn:perun:user:attribute-def:def:login-namespace:\"));\n-\n-\t\t\t\tCandidate candidate = new Candidate();\n-\t\t\t\tcandidate.setAttributes(attributes);\n-\n-\t\t\t\tlog.debug(\"[REGISTRAR] Retrieved candidate from DB {}\", candidate);\n-\n-\t\t\t\t// first try to parse display_name if not null and not empty\n-\t\t\t\tif (attributes.containsKey(URN_USER_DISPLAY_NAME) && attributes.get(URN_USER_DISPLAY_NAME) != null &&\n-\t\t\t\t\t\t!attributes.get(URN_USER_DISPLAY_NAME).isEmpty()) {\n-\t\t\t\t\t// parse\n-\t\t\t\t\tMap<String, String> commonName = Utils.parseCommonName(attributes.get(URN_USER_DISPLAY_NAME));\n-\t\t\t\t\tif (commonName.get(\"titleBefore\") != null\n-\t\t\t\t\t\t\t&& !commonName.get(\"titleBefore\").isEmpty()) {\n-\t\t\t\t\t\tcandidate.setTitleBefore(commonName.get(\"titleBefore\"));\n-\t\t\t\t\t}\n-\t\t\t\t\tif (commonName.get(\"firstName\") != null\n-\t\t\t\t\t\t\t&& !commonName.get(\"firstName\").isEmpty()) {\n-\t\t\t\t\t\tcandidate.setFirstName(commonName.get(\"firstName\"));\n-\t\t\t\t\t}\n-\t\t\t\t\t// FIXME - ? there is no middleName in Utils.parseCommonName() implementation\n-\t\t\t\t\tif (commonName.get(\"middleName\") != null\n-\t\t\t\t\t\t\t&& !commonName.get(\"middleName\").isEmpty()) {\n-\t\t\t\t\t\tcandidate.setMiddleName(commonName.get(\"middleName\"));\n-\t\t\t\t\t}\n-\t\t\t\t\tif (commonName.get(\"lastName\") != null\n-\t\t\t\t\t\t\t&& !commonName.get(\"lastName\").isEmpty()) {\n-\t\t\t\t\t\tcandidate.setLastName(commonName.get(\"lastName\"));\n-\t\t\t\t\t}\n-\t\t\t\t\tif (commonName.get(\"titleAfter\") != null\n-\t\t\t\t\t\t\t&& !commonName.get(\"titleAfter\").isEmpty()) {\n-\t\t\t\t\t\tcandidate.setTitleAfter(commonName.get(\"titleAfter\"));\n-\t\t\t\t\t}\n-\t\t\t\t}\n-\n-\t\t\t\t// if names are separated, used them after\n-\t\t\t\tfor (String attrName : attributes.keySet()) {\n-\t\t\t\t\t// if value not null or empty - set to candidate\n-\t\t\t\t\tif (attributes.get(attrName) != null\n-\t\t\t\t\t\t\t&& !attributes.get(attrName).isEmpty()) {\n-\t\t\t\t\t\tif (URN_USER_TITLE_BEFORE.equals(attrName)) {\n-\t\t\t\t\t\t\tcandidate.setTitleBefore(attributes.get(attrName));\n-\t\t\t\t\t\t} else if (URN_USER_TITLE_AFTER.equals(attrName)) {\n-\t\t\t\t\t\t\tcandidate.setTitleAfter(attributes.get(attrName));\n-\t\t\t\t\t\t} else if (URN_USER_FIRST_NAME.equals(attrName)) {\n-\t\t\t\t\t\t\tcandidate.setFirstName(attributes.get(attrName));\n-\t\t\t\t\t\t} else if (URN_USER_LAST_NAME.equals(attrName)) {\n-\t\t\t\t\t\t\tcandidate.setLastName(attributes.get(attrName));\n-\t\t\t\t\t\t} else if (URN_USER_MIDDLE_NAME.equals(attrName)) {\n-\t\t\t\t\t\t\tcandidate.setMiddleName(attributes.get(attrName));\n-\t\t\t\t\t\t}\n-\t\t\t\t\t}\n-\t\t\t\t}\n-\n \t\t\t\t// free reserved logins so they can be set as attributes\n \t\t\t\tjdbc.update(\"delete from application_reserved_logins where app_id=?\", appId);\n \n-\t\t\t\t// create member and user\n-\t\t\t\tlog.debug(\"[REGISTRAR] Trying to make member from candidate {}\", candidate);\n-\n-\t\t\t\t// added duplicit check, since we switched from entry to bl call of createMember()\n-\t\t\t\tUtils.checkMaxLength(\"TitleBefore\", candidate.getTitleBefore(), 40);\n-\t\t\t\tUtils.checkMaxLength(\"TitleAfter\", candidate.getTitleAfter(), 40);\n-\n \t\t\t\tUser u;\n \t\t\t\tif (app.getUser() != null) {\n \t\t\t\t\tu = app.getUser();\n \t\t\t\t\tmember = membersManager.createMember(sess, app.getVo(), u);\n+\t\t\t\t\t// store all attributes (but not logins)\n+\t\t\t\t\tstoreApplicationAttributes(app);\n \t\t\t\t\t// if user was already known to perun, createMember() will set attributes\n \t\t\t\t\t// via setAttributes() method so core attributes are skipped\n \t\t\t\t\t// ==> updateNameTitles() in case of change in appForm.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDM1NTI2OQ==", "url": "https://github.com/CESNET/perun/pull/2672#discussion_r414355269", "bodyText": "You can probably take a lot of code above, starting with // put application data into Candidate comment and make it a private method, then use it only for the case when member is really created from the candidate object.", "author": "zlamalp", "createdAt": "2020-04-24T07:25:54Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java", "diffHunk": "@@ -1789,21 +1792,31 @@ public Application approveApplicationInternal(PerunSession sess, int appId) thro\n \t\t\t\tUtils.checkMaxLength(\"TitleBefore\", candidate.getTitleBefore(), 40);\n \t\t\t\tUtils.checkMaxLength(\"TitleAfter\", candidate.getTitleAfter(), 40);", "originalCommit": "4575226a29f608297cc188e41e6d28f4eddcaf43", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDY4NjE1MQ==", "url": "https://github.com/CESNET/perun/pull/2672#discussion_r414686151", "bodyText": "Done. You are right, I just did not want to refactor the code too much because there would be lots of changes.", "author": "balcirakpeter", "createdAt": "2020-04-24T15:58:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDM1NTI2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "62f54c8c61989cb991a471aeaf578a95385faa39", "chunk": "diff --git a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\nindex 8a6bb5fff..886d8f90d 100644\n--- a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\n+++ b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\n\n@@ -1717,85 +1718,15 @@ public class RegistrarManagerImpl implements RegistrarManager {\n \n \t\t\t} else {\n \n-\t\t\t\t// put application data into Candidate\n-\t\t\t\tfinal Map<String, String> attributes = new HashMap<>();\n-\t\t\t\tjdbc.query(\"select dst_attr,value from application_data d, application_form_items i where d.item_id=i.id \"\n-\t\t\t\t\t\t\t\t+ \"and i.dst_attr is not null and d.value is not null and app_id=?\",\n-\t\t\t\t\t\t(resultSet, i) -> {\n-\t\t\t\t\t\t\tattributes.put(resultSet.getString(\"dst_attr\"), resultSet.getString(\"value\"));\n-\t\t\t\t\t\t\treturn null;\n-\t\t\t\t\t\t}, appId);\n-\n-\t\t\t\t// DO NOT STORE LOGINS THROUGH CANDIDATE\n-\t\t\t\t// we do not set logins by candidate object to prevent accidental overwrite while joining identities in process\n-\t\t\t\tattributes.entrySet().removeIf(entry -> entry.getKey().contains(\"urn:perun:user:attribute-def:def:login-namespace:\"));\n-\n-\t\t\t\tCandidate candidate = new Candidate();\n-\t\t\t\tcandidate.setAttributes(attributes);\n-\n-\t\t\t\tlog.debug(\"[REGISTRAR] Retrieved candidate from DB {}\", candidate);\n-\n-\t\t\t\t// first try to parse display_name if not null and not empty\n-\t\t\t\tif (attributes.containsKey(URN_USER_DISPLAY_NAME) && attributes.get(URN_USER_DISPLAY_NAME) != null &&\n-\t\t\t\t\t\t!attributes.get(URN_USER_DISPLAY_NAME).isEmpty()) {\n-\t\t\t\t\t// parse\n-\t\t\t\t\tMap<String, String> commonName = Utils.parseCommonName(attributes.get(URN_USER_DISPLAY_NAME));\n-\t\t\t\t\tif (commonName.get(\"titleBefore\") != null\n-\t\t\t\t\t\t\t&& !commonName.get(\"titleBefore\").isEmpty()) {\n-\t\t\t\t\t\tcandidate.setTitleBefore(commonName.get(\"titleBefore\"));\n-\t\t\t\t\t}\n-\t\t\t\t\tif (commonName.get(\"firstName\") != null\n-\t\t\t\t\t\t\t&& !commonName.get(\"firstName\").isEmpty()) {\n-\t\t\t\t\t\tcandidate.setFirstName(commonName.get(\"firstName\"));\n-\t\t\t\t\t}\n-\t\t\t\t\t// FIXME - ? there is no middleName in Utils.parseCommonName() implementation\n-\t\t\t\t\tif (commonName.get(\"middleName\") != null\n-\t\t\t\t\t\t\t&& !commonName.get(\"middleName\").isEmpty()) {\n-\t\t\t\t\t\tcandidate.setMiddleName(commonName.get(\"middleName\"));\n-\t\t\t\t\t}\n-\t\t\t\t\tif (commonName.get(\"lastName\") != null\n-\t\t\t\t\t\t\t&& !commonName.get(\"lastName\").isEmpty()) {\n-\t\t\t\t\t\tcandidate.setLastName(commonName.get(\"lastName\"));\n-\t\t\t\t\t}\n-\t\t\t\t\tif (commonName.get(\"titleAfter\") != null\n-\t\t\t\t\t\t\t&& !commonName.get(\"titleAfter\").isEmpty()) {\n-\t\t\t\t\t\tcandidate.setTitleAfter(commonName.get(\"titleAfter\"));\n-\t\t\t\t\t}\n-\t\t\t\t}\n-\n-\t\t\t\t// if names are separated, used them after\n-\t\t\t\tfor (String attrName : attributes.keySet()) {\n-\t\t\t\t\t// if value not null or empty - set to candidate\n-\t\t\t\t\tif (attributes.get(attrName) != null\n-\t\t\t\t\t\t\t&& !attributes.get(attrName).isEmpty()) {\n-\t\t\t\t\t\tif (URN_USER_TITLE_BEFORE.equals(attrName)) {\n-\t\t\t\t\t\t\tcandidate.setTitleBefore(attributes.get(attrName));\n-\t\t\t\t\t\t} else if (URN_USER_TITLE_AFTER.equals(attrName)) {\n-\t\t\t\t\t\t\tcandidate.setTitleAfter(attributes.get(attrName));\n-\t\t\t\t\t\t} else if (URN_USER_FIRST_NAME.equals(attrName)) {\n-\t\t\t\t\t\t\tcandidate.setFirstName(attributes.get(attrName));\n-\t\t\t\t\t\t} else if (URN_USER_LAST_NAME.equals(attrName)) {\n-\t\t\t\t\t\t\tcandidate.setLastName(attributes.get(attrName));\n-\t\t\t\t\t\t} else if (URN_USER_MIDDLE_NAME.equals(attrName)) {\n-\t\t\t\t\t\t\tcandidate.setMiddleName(attributes.get(attrName));\n-\t\t\t\t\t\t}\n-\t\t\t\t\t}\n-\t\t\t\t}\n-\n \t\t\t\t// free reserved logins so they can be set as attributes\n \t\t\t\tjdbc.update(\"delete from application_reserved_logins where app_id=?\", appId);\n \n-\t\t\t\t// create member and user\n-\t\t\t\tlog.debug(\"[REGISTRAR] Trying to make member from candidate {}\", candidate);\n-\n-\t\t\t\t// added duplicit check, since we switched from entry to bl call of createMember()\n-\t\t\t\tUtils.checkMaxLength(\"TitleBefore\", candidate.getTitleBefore(), 40);\n-\t\t\t\tUtils.checkMaxLength(\"TitleAfter\", candidate.getTitleAfter(), 40);\n-\n \t\t\t\tUser u;\n \t\t\t\tif (app.getUser() != null) {\n \t\t\t\t\tu = app.getUser();\n \t\t\t\t\tmember = membersManager.createMember(sess, app.getVo(), u);\n+\t\t\t\t\t// store all attributes (but not logins)\n+\t\t\t\t\tstoreApplicationAttributes(app);\n \t\t\t\t\t// if user was already known to perun, createMember() will set attributes\n \t\t\t\t\t// via setAttributes() method so core attributes are skipped\n \t\t\t\t\t// ==> updateNameTitles() in case of change in appForm.\n"}}, {"oid": "62f54c8c61989cb991a471aeaf578a95385faa39", "url": "https://github.com/CESNET/perun/commit/62f54c8c61989cb991a471aeaf578a95385faa39", "message": "additional identifiers support in RegistrarModule\n\n- Managers in registrar module did not work with additional identifiers\n  yet. Therefore, the functionality was added.\n- Method checkDuplicateRegistrationAttempt is now looking for existing\n  applications also according to additional identifiers in new application\n  and already stored ones.\n- Method approveApplicationInternal() was using method createMember()\n  which could not find user when additional identifiers were used.\n  So this part tries to find user first. If it succeeds, createMember() is\n  called with user parameter. Otherwise is used createMember() with\n  candidate parameter as it was before.\n- To prevent duplicities, method getUserByExtSourceInformation was\n  created in UsersManagerBl.\n- New method stringToMapOfAttributes was created in BeansUtils, which\n  converts String representation of map attribute back to Map attribute.", "committedDate": "2020-04-24T15:47:44Z", "type": "forcePushed"}, {"oid": "1f9daa054e66ec3b9bc66d416aed33938e8e0b62", "url": "https://github.com/CESNET/perun/commit/1f9daa054e66ec3b9bc66d416aed33938e8e0b62", "message": "additional identifiers support in RegistrarModule\n\n- Managers in registrar module did not work with additional identifiers\n  yet. Therefore, the functionality was added.\n- Method checkDuplicateRegistrationAttempt is now looking for existing\n  applications also according to additional identifiers in new application\n  and already stored ones.\n- Method approveApplicationInternal() was using method createMember()\n  which could not find user when additional identifiers were used.\n  So this part tries to find user first. If it succeeds, createMember() is\n  called with user parameter. Otherwise is used createMember() with\n  candidate parameter as it was before.\n- To prevent duplicities, method getUserByExtSourceInformation was\n  created in UsersManagerBl.\n- New method stringToMapOfAttributes was created in BeansUtils, which\n  converts String representation of map attribute back to Map attribute.", "committedDate": "2020-04-25T11:44:14Z", "type": "forcePushed"}, {"oid": "aaf431200a460776759bcac3426d2c2d1caab208", "url": "https://github.com/CESNET/perun/commit/aaf431200a460776759bcac3426d2c2d1caab208", "message": "additional identifiers support in RegistrarModule\n\n- Managers in registrar module did not work with additional identifiers\n  yet. Therefore, the functionality was added.\n- Method checkDuplicateRegistrationAttempt is now looking for existing\n  applications also according to additional identifiers in new application\n  and already stored ones.\n- Method approveApplicationInternal() was using method createMember()\n  which could not find user when additional identifiers were used.\n  So this part tries to find user first. If it succeeds, createMember() is\n  called with user parameter. Otherwise is used createMember() with\n  candidate parameter as it was before.\n- To prevent duplicities, method getUserByExtSourceInformation was\n  created in UsersManagerBl.\n- New method stringToMapOfAttributes was created in BeansUtils, which\n  converts String representation of map attribute back to Map attribute.", "committedDate": "2020-04-26T12:36:00Z", "type": "forcePushed"}, {"oid": "cdb70f74b03f79b84be60a128e62b6d15663b583", "url": "https://github.com/CESNET/perun/commit/cdb70f74b03f79b84be60a128e62b6d15663b583", "message": "additional identifiers support in RegistrarModule\n\n- Managers in registrar module did not work with additional identifiers\n  yet. Therefore, the functionality was added.\n- Method checkDuplicateRegistrationAttempt is now looking for existing\n  applications also according to additional identifiers in new application\n  and already stored ones.\n- Method approveApplicationInternal() was using method createMember()\n  which could not find user when additional identifiers were used.\n  So this part tries to find user first. If it succeeds, createMember() is\n  called with user parameter. Otherwise is used createMember() with\n  candidate parameter as it was before.\n- To prevent duplicities, method getUserByExtSourceInformation was\n  created in UsersManagerBl.\n- New method stringToMapOfAttributes was created in BeansUtils, which\n  converts String representation of map attribute back to Map attribute.", "committedDate": "2020-04-27T07:54:04Z", "type": "forcePushed"}, {"oid": "9d78947b13f4d8a8926e2242f32df6f22cc28562", "url": "https://github.com/CESNET/perun/commit/9d78947b13f4d8a8926e2242f32df6f22cc28562", "message": "additional identifiers support in RegistrarModule\n\n- Managers in registrar module did not work with additional identifiers\n  yet. Therefore, the functionality was added.\n- Method checkDuplicateRegistrationAttempt is now looking for existing\n  applications also according to additional identifiers in new application\n  and already stored ones.\n- Method approveApplicationInternal() was using method createMember()\n  which could not find user when additional identifiers were used.\n  So this part tries to find user first. If it succeeds, createMember() is\n  called with user parameter. Otherwise is used createMember() with\n  candidate parameter as it was before.\n- To prevent duplicities, method getUserByExtSourceInformation was\n  created in UsersManagerBl.\n- New method stringToMapOfAttributes was created in BeansUtils, which\n  converts String representation of map attribute back to Map attribute.", "committedDate": "2020-05-05T09:01:50Z", "type": "forcePushed"}, {"oid": "741d7d934ee2d7b4d59a70167c8c604a9a256f44", "url": "https://github.com/CESNET/perun/commit/741d7d934ee2d7b4d59a70167c8c604a9a256f44", "message": "additional identifiers support in RegistrarModule\n\n- Managers in registrar module did not work with additional identifiers\n  yet. Therefore, the functionality was added.\n- Method checkDuplicateRegistrationAttempt is now looking for existing\n  applications also according to additional identifiers in new application\n  and already stored ones.\n- Method approveApplicationInternal() was using method createMember()\n  which could not find user when additional identifiers were used.\n  So this part tries to find user first. If it succeeds, createMember() is\n  called with user parameter. Otherwise is used createMember() with\n  candidate parameter as it was before.\n- To prevent duplicities, method getUserByExtSourceInformation was\n  created in UsersManagerBl.\n- New method stringToMapOfAttributes was created in BeansUtils, which\n  converts String representation of map attribute back to Map attribute.", "committedDate": "2020-05-05T09:28:19Z", "type": "forcePushed"}, {"oid": "238696c289156c1713e2e34893d3a20fceed970c", "url": "https://github.com/CESNET/perun/commit/238696c289156c1713e2e34893d3a20fceed970c", "message": "additional identifiers support in RegistrarModule\n\n- Managers in registrar module did not work with additional identifiers\n  yet. Therefore, the functionality was added.\n- Method checkDuplicateRegistrationAttempt is now looking for existing\n  applications also according to additional identifiers in new application\n  and already stored ones.\n- Method approveApplicationInternal() was using method createMember()\n  which could not find user when additional identifiers were used.\n  So this part tries to find user first. If it succeeds, createMember() is\n  called with user parameter. Otherwise is used createMember() with\n  candidate parameter as it was before.\n- To prevent duplicities, method getUserByExtSourceInformation was\n  created in UsersManagerBl.\n- New method stringToMapOfAttributes was created in BeansUtils, which\n  converts String representation of map attribute back to Map attribute.", "committedDate": "2020-05-05T13:03:01Z", "type": "forcePushed"}, {"oid": "7a985a3100269398f6d20e1a0b3457b990fa4f96", "url": "https://github.com/CESNET/perun/commit/7a985a3100269398f6d20e1a0b3457b990fa4f96", "message": "additional identifiers support in RegistrarModule\n\n- Managers in registrar module did not work with additional identifiers\n  yet. Therefore, the functionality was added.\n- Method checkDuplicateRegistrationAttempt is now looking for existing\n  applications also according to additional identifiers in new application\n  and already stored ones.\n- Method approveApplicationInternal() was using method createMember()\n  which could not find user when additional identifiers were used.\n  So this part tries to find user first. If it succeeds, createMember() is\n  called with user parameter. Otherwise is used createMember() with\n  candidate parameter as it was before.\n- To prevent duplicities, method getUserByExtSourceInformation was\n  created in UsersManagerBl.\n- New method stringToMapOfAttributes was created in BeansUtils, which\n  converts String representation of map attribute back to Map attribute.", "committedDate": "2020-05-06T09:51:42Z", "type": "forcePushed"}, {"oid": "32c61471e2ad05f2b4fd6eaaa57d40243f56629e", "url": "https://github.com/CESNET/perun/commit/32c61471e2ad05f2b4fd6eaaa57d40243f56629e", "message": "additional identifiers support in RegistrarModule\n\n- Managers in registrar module did not work with additional identifiers\n  yet. Therefore, the functionality was added.\n- Method checkDuplicateRegistrationAttempt is now looking for existing\n  applications also according to additional identifiers in new application\n  and already stored ones.\n- Method approveApplicationInternal() was using method createMember()\n  which could not find user when additional identifiers were used.\n  So this part tries to find user first. If it succeeds, createMember() is\n  called with user parameter. Otherwise is used createMember() with\n  candidate parameter as it was before.\n- To prevent duplicities, method getUserByExtSourceInformation was\n  created in UsersManagerBl.\n- New method stringToMapOfAttributes was created in BeansUtils, which\n  converts String representation of map attribute back to Map attribute.", "committedDate": "2020-05-06T11:26:46Z", "type": "forcePushed"}, {"oid": "f6d31d69b35311c4bb8b59a7fff259e04b9de555", "url": "https://github.com/CESNET/perun/commit/f6d31d69b35311c4bb8b59a7fff259e04b9de555", "message": "additional identifiers support in RegistrarModule\n\n- Managers in registrar module did not work with additional identifiers\n  yet. Therefore, the functionality was added.\n- Method checkDuplicateRegistrationAttempt is now looking for existing\n  applications also according to additional identifiers in new application\n  and already stored ones.\n- Method approveApplicationInternal() was using method createMember()\n  which could not find user when additional identifiers were used.\n  So this part tries to find user first. If it succeeds, createMember() is\n  called with user parameter. Otherwise is used createMember() with\n  candidate parameter as it was before.\n- To prevent duplicities, method getUserByExtSourceInformation was\n  created in UsersManagerBl.\n- New method stringToMapOfAttributes was created in BeansUtils, which\n  converts String representation of map attribute back to Map attribute.", "committedDate": "2020-05-06T11:50:07Z", "type": "forcePushed"}, {"oid": "bb4fd4012688f4bce407cfe3577c39ee8031f7ce", "url": "https://github.com/CESNET/perun/commit/bb4fd4012688f4bce407cfe3577c39ee8031f7ce", "message": "additional identifiers support in RegistrarModule\n\n- Managers in registrar module did not work with additional identifiers\n  yet. Therefore, the functionality was added.\n- Method checkDuplicateRegistrationAttempt is now looking for existing\n  applications also according to additional identifiers in new application\n  and already stored ones.\n- Method approveApplicationInternal() was using method createMember()\n  which could not find user when additional identifiers were used.\n  So this part tries to find user first. If it succeeds, createMember() is\n  called with user parameter. Otherwise is used createMember() with\n  candidate parameter as it was before.\n- To prevent duplicities, method getUserByExtSourceInformation was\n  created in UsersManagerBl.\n- New method stringToMapOfAttributes was created in BeansUtils, which\n  converts String representation of map attribute back to Map attribute.", "committedDate": "2020-05-06T16:57:04Z", "type": "forcePushed"}, {"oid": "041bb5dc9df020eb569ccac0b9ad0e181f7d0236", "url": "https://github.com/CESNET/perun/commit/041bb5dc9df020eb569ccac0b9ad0e181f7d0236", "message": "additional identifiers support in RegistrarModule\n\n- Managers in registrar module did not work with additional identifiers\n  yet. Therefore, the functionality was added.\n- Method checkDuplicateRegistrationAttempt is now looking for existing\n  applications also according to additional identifiers in new application\n  and already stored ones.\n- Method approveApplicationInternal() was using method createMember()\n  which could not find user when additional identifiers were used.\n  So this part tries to find user first. If it succeeds, createMember() is\n  called with user parameter. Otherwise is used createMember() with\n  candidate parameter as it was before.\n- To prevent duplicities, method getUserByExtSourceInformation was\n  created in UsersManagerBl.\n- New method stringToMapOfAttributes was created in BeansUtils, which\n  converts String representation of map attribute back to Map attribute.", "committedDate": "2020-05-10T09:05:30Z", "type": "forcePushed"}, {"oid": "2553671069a9177c3f4ca7d2e354d8b7ea338606", "url": "https://github.com/CESNET/perun/commit/2553671069a9177c3f4ca7d2e354d8b7ea338606", "message": "additional identifiers support in RegistrarModule\n\n- Managers in registrar module did not work with additional identifiers\n  yet. Therefore, the functionality was added.\n- Method checkDuplicateRegistrationAttempt is now looking for existing\n  applications also according to additional identifiers in new application\n  and already stored ones.\n- Method approveApplicationInternal() was using method createMember()\n  which could not find user when additional identifiers were used.\n  So this part tries to find user first. If it succeeds, createMember() is\n  called with user parameter. Otherwise is used createMember() with\n  candidate parameter as it was before.\n- To prevent duplicities, method getUserByExtSourceInformation was\n  created in UsersManagerBl.\n- New method stringToMapOfAttributes was created in BeansUtils, which\n  converts String representation of map attribute back to Map attribute.", "committedDate": "2020-05-10T09:24:38Z", "type": "forcePushed"}, {"oid": "54551a90af40b06d30070614399ab0f2632f498b", "url": "https://github.com/CESNET/perun/commit/54551a90af40b06d30070614399ab0f2632f498b", "message": "additional identifiers support in RegistrarModule\n\n- Managers in registrar module did not work with additional identifiers\n  yet. Therefore, the functionality was added.\n- Method checkDuplicateRegistrationAttempt is now looking for existing\n  applications also according to additional identifiers in new application\n  and already stored ones.\n- Method approveApplicationInternal() was using method createMember()\n  which could not find user when additional identifiers were used.\n  So this part tries to find user first. If it succeeds, createMember() is\n  called with user parameter. Otherwise is used createMember() with\n  candidate parameter as it was before.\n- To prevent duplicities, method getUserByExtSourceInformation was\n  created in UsersManagerBl.\n- New method stringToMapOfAttributes was created in BeansUtils, which\n  converts String representation of map attribute back to Map attribute.", "committedDate": "2020-05-11T14:10:49Z", "type": "forcePushed"}, {"oid": "4fc0d6103d45fada494f7a012627c854754a92e4", "url": "https://github.com/CESNET/perun/commit/4fc0d6103d45fada494f7a012627c854754a92e4", "message": "additional identifiers support in RegistrarModule\n\n- Managers in registrar module did not work with additional identifiers\n  yet. Therefore, the functionality was added.\n- Method checkDuplicateRegistrationAttempt is now looking for existing\n  applications also according to additional identifiers in new application\n  and already stored ones.\n- Method approveApplicationInternal() was using method createMember()\n  which could not find user when additional identifiers were used.\n  So this part tries to find user first. If it succeeds, createMember() is\n  called with user parameter. Otherwise is used createMember() with\n  candidate parameter as it was before.\n- To prevent duplicities, method getUserByExtSourceInformation was\n  created in UsersManagerBl.\n- New method stringToMapOfAttributes was created in BeansUtils, which\n  converts String representation of map attribute back to Map attribute.", "committedDate": "2020-05-12T13:45:01Z", "type": "forcePushed"}, {"oid": "3368f55e4877a07ed44b040e05c529406e65280d", "url": "https://github.com/CESNET/perun/commit/3368f55e4877a07ed44b040e05c529406e65280d", "message": "additional identifiers support in RegistrarModule\n\n- Managers in registrar module did not work with additional identifiers\n  yet. Therefore, the functionality was added.\n- Method checkDuplicateRegistrationAttempt is now looking for existing\n  applications also according to additional identifiers in new application\n  and already stored ones.\n- Method approveApplicationInternal() was using method createMember()\n  which could not find user when additional identifiers were used.\n  So this part tries to find user first. If it succeeds, createMember() is\n  called with user parameter. Otherwise is used createMember() with\n  candidate parameter as it was before.\n- To prevent duplicities, method getUserByExtSourceInformation was\n  created in UsersManagerBl.\n- New method stringToMapOfAttributes was created in BeansUtils, which\n  converts String representation of map attribute back to Map attribute.", "committedDate": "2020-05-13T12:50:21Z", "type": "forcePushed"}, {"oid": "d2b5165f92b261556614e958a9d8cf3d3be6354a", "url": "https://github.com/CESNET/perun/commit/d2b5165f92b261556614e958a9d8cf3d3be6354a", "message": "additional identifiers support in RegistrarModule\n\n- Managers in registrar module did not work with additional identifiers\n  yet. Therefore, the functionality was added.\n- Method checkDuplicateRegistrationAttempt is now looking for existing\n  applications also according to additional identifiers in new application\n  and already stored ones.\n- Method approveApplicationInternal() was using method createMember()\n  which could not find user when additional identifiers were used.\n  So this part tries to find user first. If it succeeds, createMember() is\n  called with user parameter. Otherwise is used createMember() with\n  candidate parameter as it was before.\n- To prevent duplicities, method getUserByExtSourceInformation was\n  created in UsersManagerBl.\n- New method stringToMapOfAttributes was created in BeansUtils, which\n  converts String representation of map attribute back to Map attribute.", "committedDate": "2020-05-14T13:47:52Z", "type": "forcePushed"}, {"oid": "1c080d40824d3be64ef80f5163f560108c74b7b9", "url": "https://github.com/CESNET/perun/commit/1c080d40824d3be64ef80f5163f560108c74b7b9", "message": "additional identifiers support in RegistrarModule\n\n- Managers in registrar module did not work with additional identifiers\n  yet. Therefore, the functionality was added.\n- Method checkDuplicateRegistrationAttempt is now looking for existing\n  applications also according to additional identifiers in new application\n  and already stored ones.\n- Method approveApplicationInternal() was using method createMember()\n  which could not find user when additional identifiers were used.\n  So this part tries to find user first. If it succeeds, createMember() is\n  called with user parameter. Otherwise is used createMember() with\n  candidate parameter as it was before.\n- To prevent duplicities, method getUserByExtSourceInformation was\n  created in UsersManagerBl.\n- New method stringToMapOfAttributes was created in BeansUtils, which\n  converts String representation of map attribute back to Map attribute.", "committedDate": "2020-07-09T14:12:06Z", "type": "forcePushed"}, {"oid": "76f5f08861b7a1cb885b58a1627abc9ff79218c2", "url": "https://github.com/CESNET/perun/commit/76f5f08861b7a1cb885b58a1627abc9ff79218c2", "message": "additional identifiers support in RegistrarModule\n\n- Managers in registrar module did not work with additional identifiers\n  yet. Therefore, the functionality was added.\n- Method checkDuplicateRegistrationAttempt is now looking for existing\n  applications also according to additional identifiers in new application\n  and already stored ones.\n- Method approveApplicationInternal() was using method createMember()\n  which could not find user when additional identifiers were used.\n  So this part tries to find user first. If it succeeds, createMember() is\n  called with user parameter. Otherwise is used createMember() with\n  candidate parameter as it was before.\n- To prevent duplicities, method getUserByExtSourceInformation was\n  created in UsersManagerBl.\n- New method stringToMapOfAttributes was created in BeansUtils, which\n  converts String representation of map attribute back to Map attribute.", "committedDate": "2020-07-10T08:26:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg3NjIyNw==", "url": "https://github.com/CESNET/perun/pull/2672#discussion_r457876227", "bodyText": "This previously returned latest application of the user. Now it returns only latest application of the same type in the same vo/group, but not necessarily from the same user. You later only filter retrieved applications. Hence this is not likely to return any application for the user, if somebody else submitted same application (vo/group/type) afterwards.", "author": "zlamalp", "createdAt": "2020-07-21T06:54:32Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/ConsolidatorManagerImpl.java", "diffHunk": "@@ -472,36 +484,23 @@ private UserExtSource createExtSourceAndUserExtSource(User user, String actor, S\n \t * @return application object / null if not exists\n \t */\n \tprivate Application getLatestApplication(PerunSession sess, Vo vo, Group group, Application.AppType type) {\n-\t\ttry {\n-\n-\t\t\tif (sess.getPerunPrincipal().getUser() != null) {\n-\n-\t\t\t\tif (group != null) {\n-\n-\t\t\t\t\treturn jdbc.queryForObject(RegistrarManagerImpl.APP_SELECT + \" where a.id=(select max(id) from application where vo_id=? and group_id=? and apptype=? and user_id=? )\", RegistrarManagerImpl.APP_MAPPER, vo.getId(), group.getId(), String.valueOf(type), sess.getPerunPrincipal().getUserId());\n-\n-\t\t\t\t} else {\n-\n-\t\t\t\t\treturn jdbc.queryForObject(RegistrarManagerImpl.APP_SELECT + \" where a.id=(select max(id) from application where vo_id=? and apptype=? and user_id=? )\", RegistrarManagerImpl.APP_MAPPER, vo.getId(), String.valueOf(type), sess.getPerunPrincipal().getUserId());\n-\n-\t\t\t\t}\n-\n-\t\t\t} else {\n-\n-\t\t\t\tif (group != null) {\n-\n-\t\t\t\t\treturn jdbc.queryForObject(RegistrarManagerImpl.APP_SELECT + \" where a.id=(select max(id) from application where vo_id=? and group_id=? and apptype=? and created_by=? and extsourcename=? )\", RegistrarManagerImpl.APP_MAPPER, vo.getId(), group.getId(), String.valueOf(type), sess.getPerunPrincipal().getActor(), sess.getPerunPrincipal().getExtSourceName());\n-\n-\t\t\t\t} else {\n-\n-\t\t\t\t\treturn jdbc.queryForObject(RegistrarManagerImpl.APP_SELECT + \" where a.id=(select max(id) from application where vo_id=? and apptype=? and created_by=? and extsourcename=? )\", RegistrarManagerImpl.APP_MAPPER, vo.getId(), String.valueOf(type), sess.getPerunPrincipal().getActor(), sess.getPerunPrincipal().getExtSourceName());\n-\n-\t\t\t\t}\n+\t\tList<Application> allAplications = new ArrayList<>();\n+\t\tif (group != null) {\n+\t\t\tallAplications.addAll(jdbc.query(RegistrarManagerImpl.APP_SELECT + \" where a.id=(select max(id) from application where vo_id=? and group_id=? and apptype=?)\", RegistrarManagerImpl.APP_MAPPER, vo.getId(), group.getId(), String.valueOf(type)));", "originalCommit": "76f5f08861b7a1cb885b58a1627abc9ff79218c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzkxNTM0NQ==", "url": "https://github.com/CESNET/perun/pull/2672#discussion_r457915345", "bodyText": "Fixed.", "author": "balcirakpeter", "createdAt": "2020-07-21T08:10:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg3NjIyNw=="}], "type": "inlineReview", "revised_code": {"commit": "d169049e57a37eded4b7bacc028caac42488e99b", "chunk": "diff --git a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/ConsolidatorManagerImpl.java b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/ConsolidatorManagerImpl.java\nindex 11bb4bf87..9b00ddeba 100644\n--- a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/ConsolidatorManagerImpl.java\n+++ b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/ConsolidatorManagerImpl.java\n\n@@ -484,23 +486,21 @@ public class ConsolidatorManagerImpl implements ConsolidatorManager {\n \t * @return application object / null if not exists\n \t */\n \tprivate Application getLatestApplication(PerunSession sess, Vo vo, Group group, Application.AppType type) {\n-\t\tList<Application> allAplications = new ArrayList<>();\n+\t\tList<Application> allApplications = new ArrayList<>();\n \t\tif (group != null) {\n-\t\t\tallAplications.addAll(jdbc.query(RegistrarManagerImpl.APP_SELECT + \" where a.id=(select max(id) from application where vo_id=? and group_id=? and apptype=?)\", RegistrarManagerImpl.APP_MAPPER, vo.getId(), group.getId(), String.valueOf(type)));\n+\t\t\tallApplications.addAll(jdbc.query(RegistrarManagerImpl.APP_SELECT + \" where a.vo_id=? and a.group_id=? and a.apptype=?\", RegistrarManagerImpl.APP_MAPPER, vo.getId(), group.getId(), String.valueOf(type)));\n \t\t} else {\n-\t\t\tallAplications.addAll(jdbc.query(RegistrarManagerImpl.APP_SELECT + \" where a.id=(select max(id) from application where vo_id=? and apptype=?)\", RegistrarManagerImpl.APP_MAPPER, vo.getId(), String.valueOf(type)));\n+\t\t\tallApplications.addAll(jdbc.query(RegistrarManagerImpl.APP_SELECT + \" where a.vo_id=? and a.apptype=?\", RegistrarManagerImpl.APP_MAPPER, vo.getId(), String.valueOf(type)));\n \t\t}\n \n-\t\tList<Application> userApplications = registrarManager.filterPrincipalApplications(sess, allAplications);\n+\t\tList<Application> userApplications = registrarManager.filterPrincipalApplications(sess, allApplications);\n \n \t\tif (userApplications.isEmpty()) {\n \t\t\treturn null;\n-\t\t} else if (userApplications.size() > 1) {\n-\t\t\tList<Integer> ids = new ArrayList<>();\n-\t\t\tuserApplications.forEach(application -> ids.add(application.getId()));\n-\t\t\tthrow new InternalErrorException(\"User has created more than one application. Ids of the duplicate applications are: \" + ids.toString());\n-\t\t} else {\n-\t\t\treturn userApplications.get(0);\n+\t\t} else  {\n+\t\t\treturn userApplications.stream()\n+\t\t\t\t.max(comparing(Application::getId))\n+\t\t\t\t.get();\n \t\t}\n \t}\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg4NTQwNA==", "url": "https://github.com/CESNET/perun/pull/2672#discussion_r457885404", "bodyText": "Private method checkDuplicateRegistration() is no longer used and its implementation should be removed too.", "author": "zlamalp", "createdAt": "2020-07-21T07:14:26Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java", "diffHunk": "@@ -2495,64 +2396,43 @@ private void checkDuplicateRegistrationAttempt(PerunSession sess, AppType appTyp\n \t\t\t\t} catch (MemberNotExistsException ex) {\n \t\t\t\t\t// user is not member of vo\n \t\t\t\t\tif (group != null) {\n-\t\t\t\t\t\t// not member of VO - check for unprocessed applications to Group\n-\t\t\t\t\t\tcheckDuplicateRegistration(\"Initial application for Group: \"+group.getName()+\" already exists.\",\n-\t\t\t\t\t\t\t\tAppType.INITIAL, vo.getId(), group.getId(), user.getId(), actor, extSourceName);\n+\t\t\t\t\t\tcheckDupplicateGroupApplications(sess, vo, group, AppType.INITIAL);\n+\t\t\t\t\t\t//throw new InternalErrorException(\"You must be member of vo: \"+vo.getName()+\" to apply for membership in group: \"+group.getName());\n \t\t\t\t\t} else {\n-\t\t\t\t\t\t// not member of VO - check for unprocessed applications\n-\t\t\t\t\t\tcheckDuplicateRegistration(\"Initial application for Vo: \"+vo.getName()+\" already exists.\",\n-\t\t\t\t\t\t\t\tAppType.INITIAL, vo.getId(), 0, user.getId(), actor, extSourceName);\n+\t\t\t\t\t\tcheckDupplicateVoApplications(sess, vo, AppType.INITIAL);\n+\t\t\t\t\t\t// pass not member and have only approved or rejected apps\n \t\t\t\t\t}\n \t\t\t\t}\n \t\t\t} else {\n-\n \t\t\t\t// user is not known\n \t\t\t\tif (group != null) {\n-\t\t\t\t\t// group application\n-\t\t\t\t\tcheckDuplicateRegistration(\"Initial application for Group: \"+group.getName()+\" already exists.\",", "originalCommit": "76f5f08861b7a1cb885b58a1627abc9ff79218c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzkxNTI0MA==", "url": "https://github.com/CESNET/perun/pull/2672#discussion_r457915240", "bodyText": "removed", "author": "balcirakpeter", "createdAt": "2020-07-21T08:09:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg4NTQwNA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "d169049e57a37eded4b7bacc028caac42488e99b", "url": "https://github.com/CESNET/perun/commit/d169049e57a37eded4b7bacc028caac42488e99b", "message": "additional identifiers support in RegistrarModule\n\n- Managers in registrar module did not work with additional identifiers\n  yet. Therefore, the functionality was added.\n- Method checkDuplicateRegistrationAttempt is now looking for existing\n  applications also according to additional identifiers in new application\n  and already stored ones.\n- Method approveApplicationInternal() was using method createMember()\n  which could not find user when additional identifiers were used.\n  So this part tries to find user first. If it succeeds, createMember() is\n  called with user parameter. Otherwise is used createMember() with\n  candidate parameter as it was before.\n- To prevent duplicities, method getUserByExtSourceInformation was\n  created in UsersManagerBl.\n- New method stringToMapOfAttributes was created in BeansUtils, which\n  converts String representation of map attribute back to Map attribute.", "committedDate": "2020-07-21T08:09:13Z", "type": "commit"}, {"oid": "d169049e57a37eded4b7bacc028caac42488e99b", "url": "https://github.com/CESNET/perun/commit/d169049e57a37eded4b7bacc028caac42488e99b", "message": "additional identifiers support in RegistrarModule\n\n- Managers in registrar module did not work with additional identifiers\n  yet. Therefore, the functionality was added.\n- Method checkDuplicateRegistrationAttempt is now looking for existing\n  applications also according to additional identifiers in new application\n  and already stored ones.\n- Method approveApplicationInternal() was using method createMember()\n  which could not find user when additional identifiers were used.\n  So this part tries to find user first. If it succeeds, createMember() is\n  called with user parameter. Otherwise is used createMember() with\n  candidate parameter as it was before.\n- To prevent duplicities, method getUserByExtSourceInformation was\n  created in UsersManagerBl.\n- New method stringToMapOfAttributes was created in BeansUtils, which\n  converts String representation of map attribute back to Map attribute.", "committedDate": "2020-07-21T08:09:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzk3OTE1Mg==", "url": "https://github.com/CESNET/perun/pull/2672#discussion_r457979152", "bodyText": "Not your change and I'm not sure it matters, but second select retrieve also all group applications in that vo, since group_id is null is not part of the SQL.\nResult is later used to get similar users. So depending on the application content it might be more or less successful in finding similar users. I guess using only VO applications, one might be more successful. I'm not sure its relevant though, since I don't know callers (outside) context.", "author": "zlamalp", "createdAt": "2020-07-21T09:57:31Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/ConsolidatorManagerImpl.java", "diffHunk": "@@ -472,36 +486,21 @@ private UserExtSource createExtSourceAndUserExtSource(User user, String actor, S\n \t * @return application object / null if not exists\n \t */\n \tprivate Application getLatestApplication(PerunSession sess, Vo vo, Group group, Application.AppType type) {\n-\t\ttry {\n-\n-\t\t\tif (sess.getPerunPrincipal().getUser() != null) {\n-\n-\t\t\t\tif (group != null) {\n-\n-\t\t\t\t\treturn jdbc.queryForObject(RegistrarManagerImpl.APP_SELECT + \" where a.id=(select max(id) from application where vo_id=? and group_id=? and apptype=? and user_id=? )\", RegistrarManagerImpl.APP_MAPPER, vo.getId(), group.getId(), String.valueOf(type), sess.getPerunPrincipal().getUserId());\n-\n-\t\t\t\t} else {\n-\n-\t\t\t\t\treturn jdbc.queryForObject(RegistrarManagerImpl.APP_SELECT + \" where a.id=(select max(id) from application where vo_id=? and apptype=? and user_id=? )\", RegistrarManagerImpl.APP_MAPPER, vo.getId(), String.valueOf(type), sess.getPerunPrincipal().getUserId());\n-\n-\t\t\t\t}\n-\n-\t\t\t} else {\n-\n-\t\t\t\tif (group != null) {\n-\n-\t\t\t\t\treturn jdbc.queryForObject(RegistrarManagerImpl.APP_SELECT + \" where a.id=(select max(id) from application where vo_id=? and group_id=? and apptype=? and created_by=? and extsourcename=? )\", RegistrarManagerImpl.APP_MAPPER, vo.getId(), group.getId(), String.valueOf(type), sess.getPerunPrincipal().getActor(), sess.getPerunPrincipal().getExtSourceName());\n-\n-\t\t\t\t} else {\n-\n-\t\t\t\t\treturn jdbc.queryForObject(RegistrarManagerImpl.APP_SELECT + \" where a.id=(select max(id) from application where vo_id=? and apptype=? and created_by=? and extsourcename=? )\", RegistrarManagerImpl.APP_MAPPER, vo.getId(), String.valueOf(type), sess.getPerunPrincipal().getActor(), sess.getPerunPrincipal().getExtSourceName());\n-\n-\t\t\t\t}\n+\t\tList<Application> allApplications = new ArrayList<>();\n+\t\tif (group != null) {\n+\t\t\tallApplications.addAll(jdbc.query(RegistrarManagerImpl.APP_SELECT + \" where a.vo_id=? and a.group_id=? and a.apptype=?\", RegistrarManagerImpl.APP_MAPPER, vo.getId(), group.getId(), String.valueOf(type)));\n+\t\t} else {\n+\t\t\tallApplications.addAll(jdbc.query(RegistrarManagerImpl.APP_SELECT + \" where a.vo_id=? and a.apptype=?\", RegistrarManagerImpl.APP_MAPPER, vo.getId(), String.valueOf(type)));", "originalCommit": "d169049e57a37eded4b7bacc028caac42488e99b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}