{"pr_number": 3035, "pr_title": "add methods for getting applications within specified date period", "pr_createdAt": "2020-12-13T13:36:33Z", "pr_url": "https://github.com/CESNET/perun/pull/3035", "timeline": [{"oid": "3f5bcf3eee2fa92e469ae7428d1b60a239b207e2", "url": "https://github.com/CESNET/perun/commit/3f5bcf3eee2fa92e469ae7428d1b60a239b207e2", "message": "add methods for getting applications within specified date period", "committedDate": "2020-12-13T13:31:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjIxNDAxMg==", "url": "https://github.com/CESNET/perun/pull/3035#discussion_r542214012", "bodyText": "Generally, we want to use one policy for one method. Please, create a new policy in the perun-base/src/main/resources/perun-roles.yml file.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForVo_Vo_List<String>_policy\", Collections.singletonList(vo))) {\n          \n          \n            \n            \t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForVo_Vo_List<String>_String_String_policy\", Collections.singletonList(vo))) {", "author": "Vojtech-Sassmann", "createdAt": "2020-12-14T08:58:59Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java", "diffHunk": "@@ -1899,6 +1899,37 @@ public Application getApplicationById(PerunSession sess, int appId) throws Regis\n \n \t}\n \n+\t@Override\n+\tpublic List<Application> getApplicationsForVo(PerunSession userSession, Vo vo, List<String> state, String dateFrom, String dateTo) throws PerunException {\n+\t\tvosManager.checkVoExists(userSession, vo);\n+\n+\t\t//Authorization\n+\t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForVo_Vo_List<String>_policy\", Collections.singletonList(vo))) {", "originalCommit": "3f5bcf3eee2fa92e469ae7428d1b60a239b207e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjM2NTM4Mw==", "url": "https://github.com/CESNET/perun/pull/3035#discussion_r542365383", "bodyText": "I can hardly see the the reason why the two should differ, but doing it anyway.", "author": "mvocu", "createdAt": "2020-12-14T13:01:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjIxNDAxMg=="}], "type": "inlineReview", "revised_code": {"commit": "58d166abc09e7093427302192cb54957da548da3", "chunk": "diff --git a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\nindex 44a9053b5..1e266b97f 100644\n--- a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\n+++ b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\n\n@@ -1904,28 +1904,31 @@ public class RegistrarManagerImpl implements RegistrarManager {\n \t\tvosManager.checkVoExists(userSession, vo);\n \n \t\t//Authorization\n-\t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForVo_Vo_List<String>_policy\", Collections.singletonList(vo))) {\n+\t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForVo_Vo_List<String>_String_String_policy\", Collections.singletonList(vo))) {\n \t\t\tthrow new PrivilegeException(userSession, \"getApplicationsForVo\");\n \t\t}\n-\t\tif (state == null || state.isEmpty()) {\n-\t\t\t// list all\n-\t\t\ttry {\n-\t\t\t\treturn jdbc.query(APP_SELECT + \" where a.vo_id=? and a.created_at::date >= date ? and a.create_at::date <= date ? order by a.id desc\", APP_MAPPER, vo.getId(), dateFrom, dateTo);\n-\t\t\t} catch (EmptyResultDataAccessException ex) {\n-\t\t\t\treturn new ArrayList<>();\n-\t\t\t}\n-\t\t} else {\n-\t\t\t// filter by state\n-\t\t\ttry {\n-\t\t\t\tMapSqlParameterSource sqlParameterSource = new MapSqlParameterSource();\n-\t\t\t\tsqlParameterSource.addValue(\"voId\", vo.getId());\n+\t\ttry {\n+\t\t\tMapSqlParameterSource sqlParameterSource = new MapSqlParameterSource();\n+\t\t\tStringBuilder query = new StringBuilder(APP_SELECT);\n+\t\t\tquery.append(\" where a.vo_id=:voId\");\n+\t\t\tsqlParameterSource.addValue(\"voId\", vo.getId());\n+\t\t\tif (state != null && !state.isEmpty()) {\n+\t\t\t\t// list all\n \t\t\t\tsqlParameterSource.addValue(\"states\", state);\n+\t\t\t\tquery.append(\" and state in ( :states )\");\n+\t\t\t}\n+\t\t\tif(dateFrom != null && !dateFrom.isEmpty()) {\n \t\t\t\tsqlParameterSource.addValue(\"from\", dateFrom);\n+\t\t\t\tquery.append(\" and and a.created_at::date >= date :from \");\n+\t\t\t}\n+\t\t\tif(dateTo != null && !dateTo.isEmpty()) {\n \t\t\t\tsqlParameterSource.addValue(\"to\", dateTo);\n-\t\t\t\treturn namedJdbc.query(APP_SELECT + \" where a.vo_id=:voId and state in ( :states ) and a.created_at::date >= date :from and a.create_at::date <= date :to order by a.id desc\", sqlParameterSource, APP_MAPPER);\n-\t\t\t} catch (EmptyResultDataAccessException ex) {\n-\t\t\t\treturn new ArrayList<>();\n+\t\t\t\tquery.append(\" and a.create_at::date <= date :to \");\n \t\t\t}\n+\t\t\tquery.append(\" order by a.id desc\");\n+\t\t\treturn namedJdbc.query(query.toString(), sqlParameterSource, APP_MAPPER);\n+\t\t} catch (EmptyResultDataAccessException ex) {\n+\t\t\treturn new ArrayList<>();\n \t\t}\n \n \t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjIxNzk4Nw==", "url": "https://github.com/CESNET/perun/pull/3035#discussion_r542217987", "bodyText": "Same for this policy.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForGroup_Vo_List<String>_policy\", Collections.singletonList(group))) {\n          \n          \n            \n            \t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForGroup_Vo_List<String>_String_String_policy\", Collections.singletonList(group))) {", "author": "Vojtech-Sassmann", "createdAt": "2020-12-14T09:05:25Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java", "diffHunk": "@@ -1928,6 +1959,37 @@ public Application getApplicationById(PerunSession sess, int appId) throws Regis\n \n \t}\n \n+\t@Override\n+\tpublic List<Application> getApplicationsForGroup(PerunSession userSession, Group group, List<String> state, String dateFrom, String dateTo) throws PerunException {\n+\t\tgroupsManager.checkGroupExists(userSession, group);\n+\n+\t\t//Authorization\n+\t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForGroup_Vo_List<String>_policy\", Collections.singletonList(group))) {", "originalCommit": "3f5bcf3eee2fa92e469ae7428d1b60a239b207e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjM2NzIzNA==", "url": "https://github.com/CESNET/perun/pull/3035#discussion_r542367234", "bodyText": "Added.", "author": "mvocu", "createdAt": "2020-12-14T13:04:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjIxNzk4Nw=="}], "type": "inlineReview", "revised_code": {"commit": "58d166abc09e7093427302192cb54957da548da3", "chunk": "diff --git a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\nindex 44a9053b5..1e266b97f 100644\n--- a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\n+++ b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\n\n@@ -1964,28 +1967,31 @@ public class RegistrarManagerImpl implements RegistrarManager {\n \t\tgroupsManager.checkGroupExists(userSession, group);\n \n \t\t//Authorization\n-\t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForGroup_Vo_List<String>_policy\", Collections.singletonList(group))) {\n+\t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForGroup_Vo_List<String>_String_String_policy\", Collections.singletonList(group))) {\n \t\t\tthrow new PrivilegeException(userSession, \"getApplicationsForGroup\");\n \t\t}\n-\t\tif (state == null || state.isEmpty()) {\n-\t\t\t// list all\n-\t\t\ttry {\n-\t\t\t\treturn jdbc.query(APP_SELECT + \" where a.group_id=? and a.created_at::date >= date ? and a.create_at::date <= date ? order by a.id desc\", APP_MAPPER, group.getId(), dateFrom, dateTo);\n-\t\t\t} catch (EmptyResultDataAccessException ex) {\n-\t\t\t\treturn new ArrayList<>();\n-\t\t\t}\n-\t\t} else {\n-\t\t\t// filter by state\n-\t\t\ttry {\n-\t\t\t\tMapSqlParameterSource sqlParameterSource = new MapSqlParameterSource();\n-\t\t\t\tsqlParameterSource.addValue(\"groupId\", group.getId());\n+\t\ttry {\n+\t\t\tMapSqlParameterSource sqlParameterSource = new MapSqlParameterSource();\n+\t\t\tStringBuilder query = new StringBuilder(APP_SELECT);\n+\t\t\tquery.append(\" where a.group_id=:groupId\");\n+\t\t\tsqlParameterSource.addValue(\"groupId\", group.getId());\n+\t\t\tif (state != null && !state.isEmpty()) {\n+\t\t\t\t// list all\n \t\t\t\tsqlParameterSource.addValue(\"states\", state);\n+\t\t\t\tquery.append(\" and state in ( :states )\");\n+\t\t\t}\n+\t\t\tif(dateFrom != null && !dateFrom.isEmpty()) {\n \t\t\t\tsqlParameterSource.addValue(\"from\", dateFrom);\n+\t\t\t\tquery.append(\" and and a.created_at::date >= date :from \");\n+\t\t\t}\n+\t\t\tif(dateTo != null && !dateTo.isEmpty()) {\n \t\t\t\tsqlParameterSource.addValue(\"to\", dateTo);\n-\t\t\t\treturn namedJdbc.query(APP_SELECT + \" where a.group_id=:groupId and state in ( :states ) and a.created_at::date >= date :from and a.create_at::date <= date :to order by a.id desc\", sqlParameterSource, APP_MAPPER);\n-\t\t\t} catch (EmptyResultDataAccessException ex) {\n-\t\t\t\treturn new ArrayList<>();\n+\t\t\t\tquery.append(\" and a.create_at::date <= date :to \");\n \t\t\t}\n+\t\t\tquery.append(\" order by a.id desc\");\n+\t\t\treturn namedJdbc.query(query.toString(), sqlParameterSource, APP_MAPPER);\n+\t\t} catch (EmptyResultDataAccessException ex) {\n+\t\t\treturn new ArrayList<>();\n \t\t}\n \n \t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwMDE4Ng==", "url": "https://github.com/CESNET/perun/pull/3035#discussion_r542300186", "bodyText": "This SQL seems to be invalid. If you would use the LocalDate, you can fix it like this\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\treturn jdbc.query(APP_SELECT + \" where a.vo_id=? and a.created_at::date >= date ? and a.create_at::date <= date ? order by a.id desc\", APP_MAPPER, vo.getId(), dateFrom, dateTo);\n          \n          \n            \n            \t\t\t\treturn jdbc.query(APP_SELECT + \" where a.vo_id=? and a.created_at::date >= ? and a.created_at::date <= ? order by a.id desc\", APP_MAPPER, vo.getId(), dateFrom, dateTo);", "author": "Vojtech-Sassmann", "createdAt": "2020-12-14T11:07:49Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java", "diffHunk": "@@ -1899,6 +1899,37 @@ public Application getApplicationById(PerunSession sess, int appId) throws Regis\n \n \t}\n \n+\t@Override\n+\tpublic List<Application> getApplicationsForVo(PerunSession userSession, Vo vo, List<String> state, String dateFrom, String dateTo) throws PerunException {\n+\t\tvosManager.checkVoExists(userSession, vo);\n+\n+\t\t//Authorization\n+\t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForVo_Vo_List<String>_policy\", Collections.singletonList(vo))) {\n+\t\t\tthrow new PrivilegeException(userSession, \"getApplicationsForVo\");\n+\t\t}\n+\t\tif (state == null || state.isEmpty()) {\n+\t\t\t// list all\n+\t\t\ttry {\n+\t\t\t\treturn jdbc.query(APP_SELECT + \" where a.vo_id=? and a.created_at::date >= date ? and a.create_at::date <= date ? order by a.id desc\", APP_MAPPER, vo.getId(), dateFrom, dateTo);", "originalCommit": "3f5bcf3eee2fa92e469ae7428d1b60a239b207e2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "58d166abc09e7093427302192cb54957da548da3", "chunk": "diff --git a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\nindex 44a9053b5..1e266b97f 100644\n--- a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\n+++ b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\n\n@@ -1904,28 +1904,31 @@ public class RegistrarManagerImpl implements RegistrarManager {\n \t\tvosManager.checkVoExists(userSession, vo);\n \n \t\t//Authorization\n-\t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForVo_Vo_List<String>_policy\", Collections.singletonList(vo))) {\n+\t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForVo_Vo_List<String>_String_String_policy\", Collections.singletonList(vo))) {\n \t\t\tthrow new PrivilegeException(userSession, \"getApplicationsForVo\");\n \t\t}\n-\t\tif (state == null || state.isEmpty()) {\n-\t\t\t// list all\n-\t\t\ttry {\n-\t\t\t\treturn jdbc.query(APP_SELECT + \" where a.vo_id=? and a.created_at::date >= date ? and a.create_at::date <= date ? order by a.id desc\", APP_MAPPER, vo.getId(), dateFrom, dateTo);\n-\t\t\t} catch (EmptyResultDataAccessException ex) {\n-\t\t\t\treturn new ArrayList<>();\n-\t\t\t}\n-\t\t} else {\n-\t\t\t// filter by state\n-\t\t\ttry {\n-\t\t\t\tMapSqlParameterSource sqlParameterSource = new MapSqlParameterSource();\n-\t\t\t\tsqlParameterSource.addValue(\"voId\", vo.getId());\n+\t\ttry {\n+\t\t\tMapSqlParameterSource sqlParameterSource = new MapSqlParameterSource();\n+\t\t\tStringBuilder query = new StringBuilder(APP_SELECT);\n+\t\t\tquery.append(\" where a.vo_id=:voId\");\n+\t\t\tsqlParameterSource.addValue(\"voId\", vo.getId());\n+\t\t\tif (state != null && !state.isEmpty()) {\n+\t\t\t\t// list all\n \t\t\t\tsqlParameterSource.addValue(\"states\", state);\n+\t\t\t\tquery.append(\" and state in ( :states )\");\n+\t\t\t}\n+\t\t\tif(dateFrom != null && !dateFrom.isEmpty()) {\n \t\t\t\tsqlParameterSource.addValue(\"from\", dateFrom);\n+\t\t\t\tquery.append(\" and and a.created_at::date >= date :from \");\n+\t\t\t}\n+\t\t\tif(dateTo != null && !dateTo.isEmpty()) {\n \t\t\t\tsqlParameterSource.addValue(\"to\", dateTo);\n-\t\t\t\treturn namedJdbc.query(APP_SELECT + \" where a.vo_id=:voId and state in ( :states ) and a.created_at::date >= date :from and a.create_at::date <= date :to order by a.id desc\", sqlParameterSource, APP_MAPPER);\n-\t\t\t} catch (EmptyResultDataAccessException ex) {\n-\t\t\t\treturn new ArrayList<>();\n+\t\t\t\tquery.append(\" and a.create_at::date <= date :to \");\n \t\t\t}\n+\t\t\tquery.append(\" order by a.id desc\");\n+\t\t\treturn namedJdbc.query(query.toString(), sqlParameterSource, APP_MAPPER);\n+\t\t} catch (EmptyResultDataAccessException ex) {\n+\t\t\treturn new ArrayList<>();\n \t\t}\n \n \t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwMDY2Nw==", "url": "https://github.com/CESNET/perun/pull/3035#discussion_r542300667", "bodyText": "This SQL seems to be invalid. If you would use the LocalDate, you can fix it like this\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\treturn namedJdbc.query(APP_SELECT + \" where a.vo_id=:voId and state in ( :states ) and a.created_at::date >= date :from and a.create_at::date <= date :to order by a.id desc\", sqlParameterSource, APP_MAPPER);\n          \n          \n            \n            \t\t\t\treturn namedJdbc.query(APP_SELECT + \" where a.vo_id=:voId and state in ( :states ) and a.created_at::date >= :from and a.created_at::date <= :to order by a.id desc\", sqlParameterSource, APP_MAPPER);", "author": "Vojtech-Sassmann", "createdAt": "2020-12-14T11:08:41Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java", "diffHunk": "@@ -1899,6 +1899,37 @@ public Application getApplicationById(PerunSession sess, int appId) throws Regis\n \n \t}\n \n+\t@Override\n+\tpublic List<Application> getApplicationsForVo(PerunSession userSession, Vo vo, List<String> state, String dateFrom, String dateTo) throws PerunException {\n+\t\tvosManager.checkVoExists(userSession, vo);\n+\n+\t\t//Authorization\n+\t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForVo_Vo_List<String>_policy\", Collections.singletonList(vo))) {\n+\t\t\tthrow new PrivilegeException(userSession, \"getApplicationsForVo\");\n+\t\t}\n+\t\tif (state == null || state.isEmpty()) {\n+\t\t\t// list all\n+\t\t\ttry {\n+\t\t\t\treturn jdbc.query(APP_SELECT + \" where a.vo_id=? and a.created_at::date >= date ? and a.create_at::date <= date ? order by a.id desc\", APP_MAPPER, vo.getId(), dateFrom, dateTo);\n+\t\t\t} catch (EmptyResultDataAccessException ex) {\n+\t\t\t\treturn new ArrayList<>();\n+\t\t\t}\n+\t\t} else {\n+\t\t\t// filter by state\n+\t\t\ttry {\n+\t\t\t\tMapSqlParameterSource sqlParameterSource = new MapSqlParameterSource();\n+\t\t\t\tsqlParameterSource.addValue(\"voId\", vo.getId());\n+\t\t\t\tsqlParameterSource.addValue(\"states\", state);\n+\t\t\t\tsqlParameterSource.addValue(\"from\", dateFrom);\n+\t\t\t\tsqlParameterSource.addValue(\"to\", dateTo);\n+\t\t\t\treturn namedJdbc.query(APP_SELECT + \" where a.vo_id=:voId and state in ( :states ) and a.created_at::date >= date :from and a.create_at::date <= date :to order by a.id desc\", sqlParameterSource, APP_MAPPER);", "originalCommit": "3f5bcf3eee2fa92e469ae7428d1b60a239b207e2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "58d166abc09e7093427302192cb54957da548da3", "chunk": "diff --git a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\nindex 44a9053b5..1e266b97f 100644\n--- a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\n+++ b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\n\n@@ -1904,28 +1904,31 @@ public class RegistrarManagerImpl implements RegistrarManager {\n \t\tvosManager.checkVoExists(userSession, vo);\n \n \t\t//Authorization\n-\t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForVo_Vo_List<String>_policy\", Collections.singletonList(vo))) {\n+\t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForVo_Vo_List<String>_String_String_policy\", Collections.singletonList(vo))) {\n \t\t\tthrow new PrivilegeException(userSession, \"getApplicationsForVo\");\n \t\t}\n-\t\tif (state == null || state.isEmpty()) {\n-\t\t\t// list all\n-\t\t\ttry {\n-\t\t\t\treturn jdbc.query(APP_SELECT + \" where a.vo_id=? and a.created_at::date >= date ? and a.create_at::date <= date ? order by a.id desc\", APP_MAPPER, vo.getId(), dateFrom, dateTo);\n-\t\t\t} catch (EmptyResultDataAccessException ex) {\n-\t\t\t\treturn new ArrayList<>();\n-\t\t\t}\n-\t\t} else {\n-\t\t\t// filter by state\n-\t\t\ttry {\n-\t\t\t\tMapSqlParameterSource sqlParameterSource = new MapSqlParameterSource();\n-\t\t\t\tsqlParameterSource.addValue(\"voId\", vo.getId());\n+\t\ttry {\n+\t\t\tMapSqlParameterSource sqlParameterSource = new MapSqlParameterSource();\n+\t\t\tStringBuilder query = new StringBuilder(APP_SELECT);\n+\t\t\tquery.append(\" where a.vo_id=:voId\");\n+\t\t\tsqlParameterSource.addValue(\"voId\", vo.getId());\n+\t\t\tif (state != null && !state.isEmpty()) {\n+\t\t\t\t// list all\n \t\t\t\tsqlParameterSource.addValue(\"states\", state);\n+\t\t\t\tquery.append(\" and state in ( :states )\");\n+\t\t\t}\n+\t\t\tif(dateFrom != null && !dateFrom.isEmpty()) {\n \t\t\t\tsqlParameterSource.addValue(\"from\", dateFrom);\n+\t\t\t\tquery.append(\" and and a.created_at::date >= date :from \");\n+\t\t\t}\n+\t\t\tif(dateTo != null && !dateTo.isEmpty()) {\n \t\t\t\tsqlParameterSource.addValue(\"to\", dateTo);\n-\t\t\t\treturn namedJdbc.query(APP_SELECT + \" where a.vo_id=:voId and state in ( :states ) and a.created_at::date >= date :from and a.create_at::date <= date :to order by a.id desc\", sqlParameterSource, APP_MAPPER);\n-\t\t\t} catch (EmptyResultDataAccessException ex) {\n-\t\t\t\treturn new ArrayList<>();\n+\t\t\t\tquery.append(\" and a.create_at::date <= date :to \");\n \t\t\t}\n+\t\t\tquery.append(\" order by a.id desc\");\n+\t\t\treturn namedJdbc.query(query.toString(), sqlParameterSource, APP_MAPPER);\n+\t\t} catch (EmptyResultDataAccessException ex) {\n+\t\t\treturn new ArrayList<>();\n \t\t}\n \n \t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwMTc1MA==", "url": "https://github.com/CESNET/perun/pull/3035#discussion_r542301750", "bodyText": "This is not necessary, but there is also a method for parsing LocalDates. I would suggest using it instead of the String. Same for other similar usages.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\t\t\tparms.readString(\"dateFrom\"), \n          \n          \n            \n            \t\t\t\t\t\tparms.readLocalDate(\"dateFrom\"),", "author": "Vojtech-Sassmann", "createdAt": "2020-12-14T11:10:22Z", "path": "perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/RegistrarManagerMethod.java", "diffHunk": "@@ -479,14 +498,33 @@ public ApplicationFormItem call(ApiCaller ac, Deserializer parms) throws PerunEx\n \t * @param state List<String> List of states: NEW, VERIFIED, APPROVED, REJECTED\n \t * @return List<Application> Found applications\n \t */\n+\t/*#\n+\t * Gets all applications in a given state for a given Group in a given date period.\n+\t *\n+\t * @param group int Group <code>id</code>\n+\t * @param state List<String> List of states: NEW, VERIFIED, APPROVED, REJECTED\n+\t * @param dateFrom String Earliest date for applications\n+\t * @param dateTo String Latest date for applications\n+\t * @return List<Application> Found applications\n+\t */\n \tgetApplicationsForGroup {\n \n \t\t@Override\n \t\tpublic List<Application> call(ApiCaller ac, Deserializer parms) throws PerunException {\n-\t\t\tif (parms.contains(\"state\")) {\n-\t\t\t\treturn ac.getRegistrarManager().getApplicationsForGroup(ac.getSession(), ac.getGroupById(parms.readInt(\"group\")), parms.readList(\"state\", String.class));\n+\t\t\tif (parms.contains(\"dateFrom\")) {\n+\t\t\t\treturn ac.getRegistrarManager().getApplicationsForGroup(\n+\t\t\t\t\t\tac.getSession(), \n+\t\t\t\t\t\tac.getGroupById(parms.readInt(\"group\")), \n+\t\t\t\t\t\tparms.contains(\"state\") ? parms.readList(\"state\", String.class) : null,\n+\t\t\t\t\t\tparms.readString(\"dateFrom\"), ", "originalCommit": "3f5bcf3eee2fa92e469ae7428d1b60a239b207e2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "58d166abc09e7093427302192cb54957da548da3", "chunk": "diff --git a/perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/RegistrarManagerMethod.java b/perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/RegistrarManagerMethod.java\nindex bb2516884..d315e7c95 100644\n--- a/perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/RegistrarManagerMethod.java\n+++ b/perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/RegistrarManagerMethod.java\n\n@@ -511,7 +511,7 @@ public enum RegistrarManagerMethod implements ManagerMethod {\n \n \t\t@Override\n \t\tpublic List<Application> call(ApiCaller ac, Deserializer parms) throws PerunException {\n-\t\t\tif (parms.contains(\"dateFrom\")) {\n+\t\t\tif (parms.contains(\"dateFrom\") || parms.contains(\"dateTo\")) {\n \t\t\t\treturn ac.getRegistrarManager().getApplicationsForGroup(\n \t\t\t\t\t\tac.getSession(), \n \t\t\t\t\t\tac.getGroupById(parms.readInt(\"group\")), \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwMzg5NA==", "url": "https://github.com/CESNET/perun/pull/3035#discussion_r542303894", "bodyText": "This way, you can specify only one bound.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\tif (parms.contains(\"dateFrom\")) {\n          \n          \n            \n            \t\t\tif (parms.contains(\"dateFrom\") || parms.contains(\"dateTo\")) {", "author": "Vojtech-Sassmann", "createdAt": "2020-12-14T11:14:03Z", "path": "perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/RegistrarManagerMethod.java", "diffHunk": "@@ -479,14 +498,33 @@ public ApplicationFormItem call(ApiCaller ac, Deserializer parms) throws PerunEx\n \t * @param state List<String> List of states: NEW, VERIFIED, APPROVED, REJECTED\n \t * @return List<Application> Found applications\n \t */\n+\t/*#\n+\t * Gets all applications in a given state for a given Group in a given date period.\n+\t *\n+\t * @param group int Group <code>id</code>\n+\t * @param state List<String> List of states: NEW, VERIFIED, APPROVED, REJECTED\n+\t * @param dateFrom String Earliest date for applications\n+\t * @param dateTo String Latest date for applications\n+\t * @return List<Application> Found applications\n+\t */\n \tgetApplicationsForGroup {\n \n \t\t@Override\n \t\tpublic List<Application> call(ApiCaller ac, Deserializer parms) throws PerunException {\n-\t\t\tif (parms.contains(\"state\")) {\n-\t\t\t\treturn ac.getRegistrarManager().getApplicationsForGroup(ac.getSession(), ac.getGroupById(parms.readInt(\"group\")), parms.readList(\"state\", String.class));\n+\t\t\tif (parms.contains(\"dateFrom\")) {", "originalCommit": "3f5bcf3eee2fa92e469ae7428d1b60a239b207e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjM2ODA1MQ==", "url": "https://github.com/CESNET/perun/pull/3035#discussion_r542368051", "bodyText": "Added.", "author": "mvocu", "createdAt": "2020-12-14T13:06:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwMzg5NA=="}], "type": "inlineReview", "revised_code": {"commit": "58d166abc09e7093427302192cb54957da548da3", "chunk": "diff --git a/perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/RegistrarManagerMethod.java b/perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/RegistrarManagerMethod.java\nindex bb2516884..d315e7c95 100644\n--- a/perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/RegistrarManagerMethod.java\n+++ b/perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/RegistrarManagerMethod.java\n\n@@ -511,7 +511,7 @@ public enum RegistrarManagerMethod implements ManagerMethod {\n \n \t\t@Override\n \t\tpublic List<Application> call(ApiCaller ac, Deserializer parms) throws PerunException {\n-\t\t\tif (parms.contains(\"dateFrom\")) {\n+\t\t\tif (parms.contains(\"dateFrom\") || parms.contains(\"dateTo\")) {\n \t\t\t\treturn ac.getRegistrarManager().getApplicationsForGroup(\n \t\t\t\t\t\tac.getSession(), \n \t\t\t\t\t\tac.getGroupById(parms.readInt(\"group\")), \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwNzAxOQ==", "url": "https://github.com/CESNET/perun/pull/3035#discussion_r542307019", "bodyText": "With this change, it will work even if only one bound is specified.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t}\n          \n          \n            \n            \t\t}\n          \n          \n            \n            \t\tif (dateTo == null) {\n          \n          \n            \n            \t\t\tdateTo = LocalDate.MAX;\n          \n          \n            \n            \t\t}\n          \n          \n            \n            \t\tif (dateFrom == null {\n          \n          \n            \n            \t\t\tdateFrom = LocalDate.MIN;\n          \n          \n            \n            \t\t}", "author": "Vojtech-Sassmann", "createdAt": "2020-12-14T11:19:05Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java", "diffHunk": "@@ -1899,6 +1899,37 @@ public Application getApplicationById(PerunSession sess, int appId) throws Regis\n \n \t}\n \n+\t@Override\n+\tpublic List<Application> getApplicationsForVo(PerunSession userSession, Vo vo, List<String> state, String dateFrom, String dateTo) throws PerunException {\n+\t\tvosManager.checkVoExists(userSession, vo);\n+\n+\t\t//Authorization\n+\t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForVo_Vo_List<String>_policy\", Collections.singletonList(vo))) {\n+\t\t\tthrow new PrivilegeException(userSession, \"getApplicationsForVo\");\n+\t\t}", "originalCommit": "3f5bcf3eee2fa92e469ae7428d1b60a239b207e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjM4NzAyMQ==", "url": "https://github.com/CESNET/perun/pull/3035#discussion_r542387021", "bodyText": "This is extremely ugly from the SQL point of view. I rewrote it.", "author": "mvocu", "createdAt": "2020-12-14T13:35:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwNzAxOQ=="}], "type": "inlineReview", "revised_code": {"commit": "58d166abc09e7093427302192cb54957da548da3", "chunk": "diff --git a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\nindex 44a9053b5..1e266b97f 100644\n--- a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\n+++ b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\n\n@@ -1904,28 +1904,31 @@ public class RegistrarManagerImpl implements RegistrarManager {\n \t\tvosManager.checkVoExists(userSession, vo);\n \n \t\t//Authorization\n-\t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForVo_Vo_List<String>_policy\", Collections.singletonList(vo))) {\n+\t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForVo_Vo_List<String>_String_String_policy\", Collections.singletonList(vo))) {\n \t\t\tthrow new PrivilegeException(userSession, \"getApplicationsForVo\");\n \t\t}\n-\t\tif (state == null || state.isEmpty()) {\n-\t\t\t// list all\n-\t\t\ttry {\n-\t\t\t\treturn jdbc.query(APP_SELECT + \" where a.vo_id=? and a.created_at::date >= date ? and a.create_at::date <= date ? order by a.id desc\", APP_MAPPER, vo.getId(), dateFrom, dateTo);\n-\t\t\t} catch (EmptyResultDataAccessException ex) {\n-\t\t\t\treturn new ArrayList<>();\n-\t\t\t}\n-\t\t} else {\n-\t\t\t// filter by state\n-\t\t\ttry {\n-\t\t\t\tMapSqlParameterSource sqlParameterSource = new MapSqlParameterSource();\n-\t\t\t\tsqlParameterSource.addValue(\"voId\", vo.getId());\n+\t\ttry {\n+\t\t\tMapSqlParameterSource sqlParameterSource = new MapSqlParameterSource();\n+\t\t\tStringBuilder query = new StringBuilder(APP_SELECT);\n+\t\t\tquery.append(\" where a.vo_id=:voId\");\n+\t\t\tsqlParameterSource.addValue(\"voId\", vo.getId());\n+\t\t\tif (state != null && !state.isEmpty()) {\n+\t\t\t\t// list all\n \t\t\t\tsqlParameterSource.addValue(\"states\", state);\n+\t\t\t\tquery.append(\" and state in ( :states )\");\n+\t\t\t}\n+\t\t\tif(dateFrom != null && !dateFrom.isEmpty()) {\n \t\t\t\tsqlParameterSource.addValue(\"from\", dateFrom);\n+\t\t\t\tquery.append(\" and and a.created_at::date >= date :from \");\n+\t\t\t}\n+\t\t\tif(dateTo != null && !dateTo.isEmpty()) {\n \t\t\t\tsqlParameterSource.addValue(\"to\", dateTo);\n-\t\t\t\treturn namedJdbc.query(APP_SELECT + \" where a.vo_id=:voId and state in ( :states ) and a.created_at::date >= date :from and a.create_at::date <= date :to order by a.id desc\", sqlParameterSource, APP_MAPPER);\n-\t\t\t} catch (EmptyResultDataAccessException ex) {\n-\t\t\t\treturn new ArrayList<>();\n+\t\t\t\tquery.append(\" and a.create_at::date <= date :to \");\n \t\t\t}\n+\t\t\tquery.append(\" order by a.id desc\");\n+\t\t\treturn namedJdbc.query(query.toString(), sqlParameterSource, APP_MAPPER);\n+\t\t} catch (EmptyResultDataAccessException ex) {\n+\t\t\treturn new ArrayList<>();\n \t\t}\n \n \t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwNzY0Nw==", "url": "https://github.com/CESNET/perun/pull/3035#discussion_r542307647", "bodyText": "This SQL also seems to be incorrect. This will again work only if you use LocalDates.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\treturn jdbc.query(APP_SELECT + \" where a.group_id=? and a.created_at::date >= date ? and a.create_at::date <= date ? order by a.id desc\", APP_MAPPER, group.getId(), dateFrom, dateTo);\n          \n          \n            \n            \t\t\t\treturn jdbc.query(APP_SELECT + \" where a.group_id=? and a.created_at::date >= ? and a.created_at::date <= ? order by a.id desc\", APP_MAPPER, group.getId(), dateFrom, dateTo);", "author": "Vojtech-Sassmann", "createdAt": "2020-12-14T11:20:05Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java", "diffHunk": "@@ -1928,6 +1959,37 @@ public Application getApplicationById(PerunSession sess, int appId) throws Regis\n \n \t}\n \n+\t@Override\n+\tpublic List<Application> getApplicationsForGroup(PerunSession userSession, Group group, List<String> state, String dateFrom, String dateTo) throws PerunException {\n+\t\tgroupsManager.checkGroupExists(userSession, group);\n+\n+\t\t//Authorization\n+\t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForGroup_Vo_List<String>_policy\", Collections.singletonList(group))) {\n+\t\t\tthrow new PrivilegeException(userSession, \"getApplicationsForGroup\");\n+\t\t}\n+\t\tif (state == null || state.isEmpty()) {\n+\t\t\t// list all\n+\t\t\ttry {\n+\t\t\t\treturn jdbc.query(APP_SELECT + \" where a.group_id=? and a.created_at::date >= date ? and a.create_at::date <= date ? order by a.id desc\", APP_MAPPER, group.getId(), dateFrom, dateTo);", "originalCommit": "3f5bcf3eee2fa92e469ae7428d1b60a239b207e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjM3NDM4MQ==", "url": "https://github.com/CESNET/perun/pull/3035#discussion_r542374381", "bodyText": "I do not understand. AFAIK the SQL is correct and works (tested on command line).", "author": "mvocu", "createdAt": "2020-12-14T13:16:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwNzY0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzE4MDY1Mw==", "url": "https://github.com/CESNET/perun/pull/3035#discussion_r543180653", "bodyText": "The column create_at is incorrect. Also, the notation date ? doesn't work in JDBC. I have run it, and it just throws PSQLException: ERROR: syntax error at or near \"$2\".\nRewritting it to date(?) or ?::date seemed to fix it.", "author": "Vojtech-Sassmann", "createdAt": "2020-12-15T09:26:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwNzY0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI4NDg1OA==", "url": "https://github.com/CESNET/perun/pull/3035#discussion_r543284858", "bodyText": "Changed to 'date(:param)'", "author": "mvocu", "createdAt": "2020-12-15T12:02:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwNzY0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "58d166abc09e7093427302192cb54957da548da3", "chunk": "diff --git a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\nindex 44a9053b5..1e266b97f 100644\n--- a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\n+++ b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\n\n@@ -1964,28 +1967,31 @@ public class RegistrarManagerImpl implements RegistrarManager {\n \t\tgroupsManager.checkGroupExists(userSession, group);\n \n \t\t//Authorization\n-\t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForGroup_Vo_List<String>_policy\", Collections.singletonList(group))) {\n+\t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForGroup_Vo_List<String>_String_String_policy\", Collections.singletonList(group))) {\n \t\t\tthrow new PrivilegeException(userSession, \"getApplicationsForGroup\");\n \t\t}\n-\t\tif (state == null || state.isEmpty()) {\n-\t\t\t// list all\n-\t\t\ttry {\n-\t\t\t\treturn jdbc.query(APP_SELECT + \" where a.group_id=? and a.created_at::date >= date ? and a.create_at::date <= date ? order by a.id desc\", APP_MAPPER, group.getId(), dateFrom, dateTo);\n-\t\t\t} catch (EmptyResultDataAccessException ex) {\n-\t\t\t\treturn new ArrayList<>();\n-\t\t\t}\n-\t\t} else {\n-\t\t\t// filter by state\n-\t\t\ttry {\n-\t\t\t\tMapSqlParameterSource sqlParameterSource = new MapSqlParameterSource();\n-\t\t\t\tsqlParameterSource.addValue(\"groupId\", group.getId());\n+\t\ttry {\n+\t\t\tMapSqlParameterSource sqlParameterSource = new MapSqlParameterSource();\n+\t\t\tStringBuilder query = new StringBuilder(APP_SELECT);\n+\t\t\tquery.append(\" where a.group_id=:groupId\");\n+\t\t\tsqlParameterSource.addValue(\"groupId\", group.getId());\n+\t\t\tif (state != null && !state.isEmpty()) {\n+\t\t\t\t// list all\n \t\t\t\tsqlParameterSource.addValue(\"states\", state);\n+\t\t\t\tquery.append(\" and state in ( :states )\");\n+\t\t\t}\n+\t\t\tif(dateFrom != null && !dateFrom.isEmpty()) {\n \t\t\t\tsqlParameterSource.addValue(\"from\", dateFrom);\n+\t\t\t\tquery.append(\" and and a.created_at::date >= date :from \");\n+\t\t\t}\n+\t\t\tif(dateTo != null && !dateTo.isEmpty()) {\n \t\t\t\tsqlParameterSource.addValue(\"to\", dateTo);\n-\t\t\t\treturn namedJdbc.query(APP_SELECT + \" where a.group_id=:groupId and state in ( :states ) and a.created_at::date >= date :from and a.create_at::date <= date :to order by a.id desc\", sqlParameterSource, APP_MAPPER);\n-\t\t\t} catch (EmptyResultDataAccessException ex) {\n-\t\t\t\treturn new ArrayList<>();\n+\t\t\t\tquery.append(\" and a.create_at::date <= date :to \");\n \t\t\t}\n+\t\t\tquery.append(\" order by a.id desc\");\n+\t\t\treturn namedJdbc.query(query.toString(), sqlParameterSource, APP_MAPPER);\n+\t\t} catch (EmptyResultDataAccessException ex) {\n+\t\t\treturn new ArrayList<>();\n \t\t}\n \n \t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwODA1OQ==", "url": "https://github.com/CESNET/perun/pull/3035#discussion_r542308059", "bodyText": "This SQL also seems to be incorrect. This will again work only if you use LocalDates.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\treturn namedJdbc.query(APP_SELECT + \" where a.group_id=:groupId and state in ( :states ) and a.created_at::date >= date :from and a.create_at::date <= date :to order by a.id desc\", sqlParameterSource, APP_MAPPER);\n          \n          \n            \n            \t\t\t\treturn namedJdbc.query(APP_SELECT + \" where a.group_id=:groupId and state in ( :states ) and a.created_at::date >= :from and a.created_at::date <= :to order by a.id desc\", sqlParameterSource, APP_MAPPER);", "author": "Vojtech-Sassmann", "createdAt": "2020-12-14T11:20:49Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java", "diffHunk": "@@ -1928,6 +1959,37 @@ public Application getApplicationById(PerunSession sess, int appId) throws Regis\n \n \t}\n \n+\t@Override\n+\tpublic List<Application> getApplicationsForGroup(PerunSession userSession, Group group, List<String> state, String dateFrom, String dateTo) throws PerunException {\n+\t\tgroupsManager.checkGroupExists(userSession, group);\n+\n+\t\t//Authorization\n+\t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForGroup_Vo_List<String>_policy\", Collections.singletonList(group))) {\n+\t\t\tthrow new PrivilegeException(userSession, \"getApplicationsForGroup\");\n+\t\t}\n+\t\tif (state == null || state.isEmpty()) {\n+\t\t\t// list all\n+\t\t\ttry {\n+\t\t\t\treturn jdbc.query(APP_SELECT + \" where a.group_id=? and a.created_at::date >= date ? and a.create_at::date <= date ? order by a.id desc\", APP_MAPPER, group.getId(), dateFrom, dateTo);\n+\t\t\t} catch (EmptyResultDataAccessException ex) {\n+\t\t\t\treturn new ArrayList<>();\n+\t\t\t}\n+\t\t} else {\n+\t\t\t// filter by state\n+\t\t\ttry {\n+\t\t\t\tMapSqlParameterSource sqlParameterSource = new MapSqlParameterSource();\n+\t\t\t\tsqlParameterSource.addValue(\"groupId\", group.getId());\n+\t\t\t\tsqlParameterSource.addValue(\"states\", state);\n+\t\t\t\tsqlParameterSource.addValue(\"from\", dateFrom);\n+\t\t\t\tsqlParameterSource.addValue(\"to\", dateTo);\n+\t\t\t\treturn namedJdbc.query(APP_SELECT + \" where a.group_id=:groupId and state in ( :states ) and a.created_at::date >= date :from and a.create_at::date <= date :to order by a.id desc\", sqlParameterSource, APP_MAPPER);", "originalCommit": "3f5bcf3eee2fa92e469ae7428d1b60a239b207e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjM3NDUwOA==", "url": "https://github.com/CESNET/perun/pull/3035#discussion_r542374508", "bodyText": "See above.", "author": "mvocu", "createdAt": "2020-12-14T13:16:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwODA1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI4NTA3NA==", "url": "https://github.com/CESNET/perun/pull/3035#discussion_r543285074", "bodyText": "Changed to 'date(:param)'", "author": "mvocu", "createdAt": "2020-12-15T12:02:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwODA1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "58d166abc09e7093427302192cb54957da548da3", "chunk": "diff --git a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\nindex 44a9053b5..1e266b97f 100644\n--- a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\n+++ b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\n\n@@ -1964,28 +1967,31 @@ public class RegistrarManagerImpl implements RegistrarManager {\n \t\tgroupsManager.checkGroupExists(userSession, group);\n \n \t\t//Authorization\n-\t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForGroup_Vo_List<String>_policy\", Collections.singletonList(group))) {\n+\t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForGroup_Vo_List<String>_String_String_policy\", Collections.singletonList(group))) {\n \t\t\tthrow new PrivilegeException(userSession, \"getApplicationsForGroup\");\n \t\t}\n-\t\tif (state == null || state.isEmpty()) {\n-\t\t\t// list all\n-\t\t\ttry {\n-\t\t\t\treturn jdbc.query(APP_SELECT + \" where a.group_id=? and a.created_at::date >= date ? and a.create_at::date <= date ? order by a.id desc\", APP_MAPPER, group.getId(), dateFrom, dateTo);\n-\t\t\t} catch (EmptyResultDataAccessException ex) {\n-\t\t\t\treturn new ArrayList<>();\n-\t\t\t}\n-\t\t} else {\n-\t\t\t// filter by state\n-\t\t\ttry {\n-\t\t\t\tMapSqlParameterSource sqlParameterSource = new MapSqlParameterSource();\n-\t\t\t\tsqlParameterSource.addValue(\"groupId\", group.getId());\n+\t\ttry {\n+\t\t\tMapSqlParameterSource sqlParameterSource = new MapSqlParameterSource();\n+\t\t\tStringBuilder query = new StringBuilder(APP_SELECT);\n+\t\t\tquery.append(\" where a.group_id=:groupId\");\n+\t\t\tsqlParameterSource.addValue(\"groupId\", group.getId());\n+\t\t\tif (state != null && !state.isEmpty()) {\n+\t\t\t\t// list all\n \t\t\t\tsqlParameterSource.addValue(\"states\", state);\n+\t\t\t\tquery.append(\" and state in ( :states )\");\n+\t\t\t}\n+\t\t\tif(dateFrom != null && !dateFrom.isEmpty()) {\n \t\t\t\tsqlParameterSource.addValue(\"from\", dateFrom);\n+\t\t\t\tquery.append(\" and and a.created_at::date >= date :from \");\n+\t\t\t}\n+\t\t\tif(dateTo != null && !dateTo.isEmpty()) {\n \t\t\t\tsqlParameterSource.addValue(\"to\", dateTo);\n-\t\t\t\treturn namedJdbc.query(APP_SELECT + \" where a.group_id=:groupId and state in ( :states ) and a.created_at::date >= date :from and a.create_at::date <= date :to order by a.id desc\", sqlParameterSource, APP_MAPPER);\n-\t\t\t} catch (EmptyResultDataAccessException ex) {\n-\t\t\t\treturn new ArrayList<>();\n+\t\t\t\tquery.append(\" and a.create_at::date <= date :to \");\n \t\t\t}\n+\t\t\tquery.append(\" order by a.id desc\");\n+\t\t\treturn namedJdbc.query(query.toString(), sqlParameterSource, APP_MAPPER);\n+\t\t} catch (EmptyResultDataAccessException ex) {\n+\t\t\treturn new ArrayList<>();\n \t\t}\n \n \t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwODk0OA==", "url": "https://github.com/CESNET/perun/pull/3035#discussion_r542308948", "bodyText": "I would suggest the same changes as for the getApplicationsForGroup method here.", "author": "Vojtech-Sassmann", "createdAt": "2020-12-14T11:22:11Z", "path": "perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/RegistrarManagerMethod.java", "diffHunk": "@@ -452,14 +452,33 @@ public ApplicationFormItem call(ApiCaller ac, Deserializer parms) throws PerunEx\n \t * @param state List<String> List of states: NEW, VERIFIED, APPROVED, REJECTED\n \t * @return List<Application> Found applications\n \t */\n+\t/*#\n+\t * Gets all applications in a given state for a given VO in a given date period.\n+\t *\n+\t * @param vo int VO <code>id</code>\n+\t * @param state List<String> List of states: NEW, VERIFIED, APPROVED, REJECTED\n+\t * @param dateFrom String Earliest date for applications\n+\t * @param dateTo String Latest date for applications\n+\t * @return List<Application> Found applications\n+\t */\n \tgetApplicationsForVo {\n \n \t\t@Override\n \t\tpublic List<Application> call(ApiCaller ac, Deserializer parms) throws PerunException {\n-\t\t\tif (parms.contains(\"state\")) {\n-\t\t\t\treturn ac.getRegistrarManager().getApplicationsForVo(ac.getSession(), ac.getVoById(parms.readInt(\"vo\")), parms.readList(\"state\", String.class));\n+\t\t\tif(parms.contains(\"dateFrom\")) {", "originalCommit": "3f5bcf3eee2fa92e469ae7428d1b60a239b207e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjM3NDY2OA==", "url": "https://github.com/CESNET/perun/pull/3035#discussion_r542374668", "bodyText": "OK", "author": "mvocu", "createdAt": "2020-12-14T13:16:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwODk0OA=="}], "type": "inlineReview", "revised_code": {"commit": "58d166abc09e7093427302192cb54957da548da3", "chunk": "diff --git a/perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/RegistrarManagerMethod.java b/perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/RegistrarManagerMethod.java\nindex bb2516884..d315e7c95 100644\n--- a/perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/RegistrarManagerMethod.java\n+++ b/perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/RegistrarManagerMethod.java\n\n@@ -465,7 +465,7 @@ public enum RegistrarManagerMethod implements ManagerMethod {\n \n \t\t@Override\n \t\tpublic List<Application> call(ApiCaller ac, Deserializer parms) throws PerunException {\n-\t\t\tif(parms.contains(\"dateFrom\")) {\n+\t\t\tif(parms.contains(\"dateFrom\") || parms.contains(\"dateTo\")) {\n \t\t\t\t\treturn ac.getRegistrarManager().getApplicationsForVo(\n \t\t\t\t\t\t\tac.getSession(), \n \t\t\t\t\t\t\tac.getVoById(parms.readInt(\"vo\")), \n"}}, {"oid": "58d166abc09e7093427302192cb54957da548da3", "url": "https://github.com/CESNET/perun/commit/58d166abc09e7093427302192cb54957da548da3", "message": "fixes and changes from review", "committedDate": "2020-12-14T16:33:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA5NzI4Mg==", "url": "https://github.com/CESNET/perun/pull/3035#discussion_r543097282", "bodyText": "There is an extra and", "author": "balcirakpeter", "createdAt": "2020-12-15T07:08:27Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java", "diffHunk": "@@ -1899,6 +1899,40 @@ public Application getApplicationById(PerunSession sess, int appId) throws Regis\n \n \t}\n \n+\t@Override\n+\tpublic List<Application> getApplicationsForVo(PerunSession userSession, Vo vo, List<String> state, String dateFrom, String dateTo) throws PerunException {\n+\t\tvosManager.checkVoExists(userSession, vo);\n+\n+\t\t//Authorization\n+\t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForVo_Vo_List<String>_String_String_policy\", Collections.singletonList(vo))) {\n+\t\t\tthrow new PrivilegeException(userSession, \"getApplicationsForVo\");\n+\t\t}\n+\t\ttry {\n+\t\t\tMapSqlParameterSource sqlParameterSource = new MapSqlParameterSource();\n+\t\t\tStringBuilder query = new StringBuilder(APP_SELECT);\n+\t\t\tquery.append(\" where a.vo_id=:voId\");\n+\t\t\tsqlParameterSource.addValue(\"voId\", vo.getId());\n+\t\t\tif (state != null && !state.isEmpty()) {\n+\t\t\t\t// list all\n+\t\t\t\tsqlParameterSource.addValue(\"states\", state);\n+\t\t\t\tquery.append(\" and state in ( :states )\");\n+\t\t\t}\n+\t\t\tif(dateFrom != null && !dateFrom.isEmpty()) {\n+\t\t\t\tsqlParameterSource.addValue(\"from\", dateFrom);\n+\t\t\t\tquery.append(\" and and a.created_at::date >= date :from \");", "originalCommit": "58d166abc09e7093427302192cb54957da548da3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI4MzMwNQ==", "url": "https://github.com/CESNET/perun/pull/3035#discussion_r543283305", "bodyText": "Fixed.", "author": "mvocu", "createdAt": "2020-12-15T11:59:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA5NzI4Mg=="}], "type": "inlineReview", "revised_code": {"commit": "c882107ee2cc92852c9841a32f4ba99597af9fea", "chunk": "diff --git a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\nindex 1e266b97f..f73ce31d6 100644\n--- a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\n+++ b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\n\n@@ -1900,11 +1901,11 @@ public class RegistrarManagerImpl implements RegistrarManager {\n \t}\n \n \t@Override\n-\tpublic List<Application> getApplicationsForVo(PerunSession userSession, Vo vo, List<String> state, String dateFrom, String dateTo) throws PerunException {\n+\tpublic List<Application> getApplicationsForVo(PerunSession userSession, Vo vo, List<String> state, LocalDate dateFrom, LocalDate dateTo) throws PerunException {\n \t\tvosManager.checkVoExists(userSession, vo);\n \n \t\t//Authorization\n-\t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForVo_Vo_List<String>_String_String_policy\", Collections.singletonList(vo))) {\n+\t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForVo_Vo_List<String>_LocalDate_LocalDate_policy\", Collections.singletonList(vo))) {\n \t\t\tthrow new PrivilegeException(userSession, \"getApplicationsForVo\");\n \t\t}\n \t\ttry {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA5NzkyNg==", "url": "https://github.com/CESNET/perun/pull/3035#discussion_r543097926", "bodyText": "I think the correct column should be created_at", "author": "balcirakpeter", "createdAt": "2020-12-15T07:09:48Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java", "diffHunk": "@@ -1899,6 +1899,40 @@ public Application getApplicationById(PerunSession sess, int appId) throws Regis\n \n \t}\n \n+\t@Override\n+\tpublic List<Application> getApplicationsForVo(PerunSession userSession, Vo vo, List<String> state, String dateFrom, String dateTo) throws PerunException {\n+\t\tvosManager.checkVoExists(userSession, vo);\n+\n+\t\t//Authorization\n+\t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForVo_Vo_List<String>_String_String_policy\", Collections.singletonList(vo))) {\n+\t\t\tthrow new PrivilegeException(userSession, \"getApplicationsForVo\");\n+\t\t}\n+\t\ttry {\n+\t\t\tMapSqlParameterSource sqlParameterSource = new MapSqlParameterSource();\n+\t\t\tStringBuilder query = new StringBuilder(APP_SELECT);\n+\t\t\tquery.append(\" where a.vo_id=:voId\");\n+\t\t\tsqlParameterSource.addValue(\"voId\", vo.getId());\n+\t\t\tif (state != null && !state.isEmpty()) {\n+\t\t\t\t// list all\n+\t\t\t\tsqlParameterSource.addValue(\"states\", state);\n+\t\t\t\tquery.append(\" and state in ( :states )\");\n+\t\t\t}\n+\t\t\tif(dateFrom != null && !dateFrom.isEmpty()) {\n+\t\t\t\tsqlParameterSource.addValue(\"from\", dateFrom);\n+\t\t\t\tquery.append(\" and and a.created_at::date >= date :from \");\n+\t\t\t}\n+\t\t\tif(dateTo != null && !dateTo.isEmpty()) {\n+\t\t\t\tsqlParameterSource.addValue(\"to\", dateTo);\n+\t\t\t\tquery.append(\" and a.create_at::date <= date :to \");", "originalCommit": "58d166abc09e7093427302192cb54957da548da3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI4MzY5OQ==", "url": "https://github.com/CESNET/perun/pull/3035#discussion_r543283699", "bodyText": "Fixed.", "author": "mvocu", "createdAt": "2020-12-15T12:00:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA5NzkyNg=="}], "type": "inlineReview", "revised_code": {"commit": "c882107ee2cc92852c9841a32f4ba99597af9fea", "chunk": "diff --git a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\nindex 1e266b97f..f73ce31d6 100644\n--- a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\n+++ b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\n\n@@ -1900,11 +1901,11 @@ public class RegistrarManagerImpl implements RegistrarManager {\n \t}\n \n \t@Override\n-\tpublic List<Application> getApplicationsForVo(PerunSession userSession, Vo vo, List<String> state, String dateFrom, String dateTo) throws PerunException {\n+\tpublic List<Application> getApplicationsForVo(PerunSession userSession, Vo vo, List<String> state, LocalDate dateFrom, LocalDate dateTo) throws PerunException {\n \t\tvosManager.checkVoExists(userSession, vo);\n \n \t\t//Authorization\n-\t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForVo_Vo_List<String>_String_String_policy\", Collections.singletonList(vo))) {\n+\t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForVo_Vo_List<String>_LocalDate_LocalDate_policy\", Collections.singletonList(vo))) {\n \t\t\tthrow new PrivilegeException(userSession, \"getApplicationsForVo\");\n \t\t}\n \t\ttry {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA5ODI1Mg==", "url": "https://github.com/CESNET/perun/pull/3035#discussion_r543098252", "bodyText": "Same as in the previous method", "author": "balcirakpeter", "createdAt": "2020-12-15T07:10:31Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java", "diffHunk": "@@ -1928,6 +1962,40 @@ public Application getApplicationById(PerunSession sess, int appId) throws Regis\n \n \t}\n \n+\t@Override\n+\tpublic List<Application> getApplicationsForGroup(PerunSession userSession, Group group, List<String> state, String dateFrom, String dateTo) throws PerunException {\n+\t\tgroupsManager.checkGroupExists(userSession, group);\n+\n+\t\t//Authorization\n+\t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForGroup_Vo_List<String>_String_String_policy\", Collections.singletonList(group))) {\n+\t\t\tthrow new PrivilegeException(userSession, \"getApplicationsForGroup\");\n+\t\t}\n+\t\ttry {\n+\t\t\tMapSqlParameterSource sqlParameterSource = new MapSqlParameterSource();\n+\t\t\tStringBuilder query = new StringBuilder(APP_SELECT);\n+\t\t\tquery.append(\" where a.group_id=:groupId\");\n+\t\t\tsqlParameterSource.addValue(\"groupId\", group.getId());\n+\t\t\tif (state != null && !state.isEmpty()) {\n+\t\t\t\t// list all\n+\t\t\t\tsqlParameterSource.addValue(\"states\", state);\n+\t\t\t\tquery.append(\" and state in ( :states )\");\n+\t\t\t}\n+\t\t\tif(dateFrom != null && !dateFrom.isEmpty()) {\n+\t\t\t\tsqlParameterSource.addValue(\"from\", dateFrom);\n+\t\t\t\tquery.append(\" and and a.created_at::date >= date :from \");", "originalCommit": "58d166abc09e7093427302192cb54957da548da3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI4MzY1Mg==", "url": "https://github.com/CESNET/perun/pull/3035#discussion_r543283652", "bodyText": "Fixed.", "author": "mvocu", "createdAt": "2020-12-15T12:00:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA5ODI1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "c882107ee2cc92852c9841a32f4ba99597af9fea", "chunk": "diff --git a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\nindex 1e266b97f..f73ce31d6 100644\n--- a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\n+++ b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\n\n@@ -1963,11 +1964,11 @@ public class RegistrarManagerImpl implements RegistrarManager {\n \t}\n \n \t@Override\n-\tpublic List<Application> getApplicationsForGroup(PerunSession userSession, Group group, List<String> state, String dateFrom, String dateTo) throws PerunException {\n+\tpublic List<Application> getApplicationsForGroup(PerunSession userSession, Group group, List<String> state, LocalDate dateFrom, LocalDate dateTo) throws PerunException {\n \t\tgroupsManager.checkGroupExists(userSession, group);\n \n \t\t//Authorization\n-\t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForGroup_Vo_List<String>_String_String_policy\", Collections.singletonList(group))) {\n+\t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForGroup_Group_List<String>_LocalDate_LocalDate_policy\", Collections.singletonList(group))) {\n \t\t\tthrow new PrivilegeException(userSession, \"getApplicationsForGroup\");\n \t\t}\n \t\ttry {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA5ODUyMQ==", "url": "https://github.com/CESNET/perun/pull/3035#discussion_r543098521", "bodyText": "Same as in the previous method", "author": "balcirakpeter", "createdAt": "2020-12-15T07:11:06Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java", "diffHunk": "@@ -1928,6 +1962,40 @@ public Application getApplicationById(PerunSession sess, int appId) throws Regis\n \n \t}\n \n+\t@Override\n+\tpublic List<Application> getApplicationsForGroup(PerunSession userSession, Group group, List<String> state, String dateFrom, String dateTo) throws PerunException {\n+\t\tgroupsManager.checkGroupExists(userSession, group);\n+\n+\t\t//Authorization\n+\t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForGroup_Vo_List<String>_String_String_policy\", Collections.singletonList(group))) {\n+\t\t\tthrow new PrivilegeException(userSession, \"getApplicationsForGroup\");\n+\t\t}\n+\t\ttry {\n+\t\t\tMapSqlParameterSource sqlParameterSource = new MapSqlParameterSource();\n+\t\t\tStringBuilder query = new StringBuilder(APP_SELECT);\n+\t\t\tquery.append(\" where a.group_id=:groupId\");\n+\t\t\tsqlParameterSource.addValue(\"groupId\", group.getId());\n+\t\t\tif (state != null && !state.isEmpty()) {\n+\t\t\t\t// list all\n+\t\t\t\tsqlParameterSource.addValue(\"states\", state);\n+\t\t\t\tquery.append(\" and state in ( :states )\");\n+\t\t\t}\n+\t\t\tif(dateFrom != null && !dateFrom.isEmpty()) {\n+\t\t\t\tsqlParameterSource.addValue(\"from\", dateFrom);\n+\t\t\t\tquery.append(\" and and a.created_at::date >= date :from \");\n+\t\t\t}\n+\t\t\tif(dateTo != null && !dateTo.isEmpty()) {\n+\t\t\t\tsqlParameterSource.addValue(\"to\", dateTo);\n+\t\t\t\tquery.append(\" and a.create_at::date <= date :to \");", "originalCommit": "58d166abc09e7093427302192cb54957da548da3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c882107ee2cc92852c9841a32f4ba99597af9fea", "chunk": "diff --git a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\nindex 1e266b97f..f73ce31d6 100644\n--- a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\n+++ b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\n\n@@ -1963,11 +1964,11 @@ public class RegistrarManagerImpl implements RegistrarManager {\n \t}\n \n \t@Override\n-\tpublic List<Application> getApplicationsForGroup(PerunSession userSession, Group group, List<String> state, String dateFrom, String dateTo) throws PerunException {\n+\tpublic List<Application> getApplicationsForGroup(PerunSession userSession, Group group, List<String> state, LocalDate dateFrom, LocalDate dateTo) throws PerunException {\n \t\tgroupsManager.checkGroupExists(userSession, group);\n \n \t\t//Authorization\n-\t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForGroup_Vo_List<String>_String_String_policy\", Collections.singletonList(group))) {\n+\t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForGroup_Group_List<String>_LocalDate_LocalDate_policy\", Collections.singletonList(group))) {\n \t\t\tthrow new PrivilegeException(userSession, \"getApplicationsForGroup\");\n \t\t}\n \t\ttry {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzEwMDA5Ng==", "url": "https://github.com/CESNET/perun/pull/3035#discussion_r543100096", "bodyText": "I think that when you specify only the VO, it will also return all group applications within that VO. I know that this is how also the old method works but I am not sure if it is correct. What do you think @zlamalp ?", "author": "balcirakpeter", "createdAt": "2020-12-15T07:14:25Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java", "diffHunk": "@@ -1899,6 +1899,40 @@ public Application getApplicationById(PerunSession sess, int appId) throws Regis\n \n \t}\n \n+\t@Override\n+\tpublic List<Application> getApplicationsForVo(PerunSession userSession, Vo vo, List<String> state, String dateFrom, String dateTo) throws PerunException {\n+\t\tvosManager.checkVoExists(userSession, vo);\n+\n+\t\t//Authorization\n+\t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForVo_Vo_List<String>_String_String_policy\", Collections.singletonList(vo))) {\n+\t\t\tthrow new PrivilegeException(userSession, \"getApplicationsForVo\");\n+\t\t}\n+\t\ttry {\n+\t\t\tMapSqlParameterSource sqlParameterSource = new MapSqlParameterSource();\n+\t\t\tStringBuilder query = new StringBuilder(APP_SELECT);\n+\t\t\tquery.append(\" where a.vo_id=:voId\");\n+\t\t\tsqlParameterSource.addValue(\"voId\", vo.getId());", "originalCommit": "58d166abc09e7093427302192cb54957da548da3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzEyNzczMg==", "url": "https://github.com/CESNET/perun/pull/3035#discussion_r543127732", "bodyText": "@balcirakpeter you are right. Original method returns also group applications within the VO on purpose. So the new method should do the same as its expected to be used from the same part of GUI. It was probably just not reflected in javadoc.\n@mvocu we should add some kind of boolean flag in API of those methods (defaulting to old behaviour), since I see we use it from AppAutoRejectionScheduler, where it should process only VO applications, but like this it works also on group applications. For now it doesn't have to be in outer API (openAPI/RPC). Its just for the purpose of AppAutoRejectionScheduler.", "author": "zlamalp", "createdAt": "2020-12-15T08:06:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzEwMDA5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM1MzQwMg==", "url": "https://github.com/CESNET/perun/pull/3035#discussion_r543353402", "bodyText": "OK, parameter added, references fixed.", "author": "mvocu", "createdAt": "2020-12-15T13:46:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzEwMDA5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "c882107ee2cc92852c9841a32f4ba99597af9fea", "chunk": "diff --git a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\nindex 1e266b97f..f73ce31d6 100644\n--- a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\n+++ b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java\n\n@@ -1900,11 +1901,11 @@ public class RegistrarManagerImpl implements RegistrarManager {\n \t}\n \n \t@Override\n-\tpublic List<Application> getApplicationsForVo(PerunSession userSession, Vo vo, List<String> state, String dateFrom, String dateTo) throws PerunException {\n+\tpublic List<Application> getApplicationsForVo(PerunSession userSession, Vo vo, List<String> state, LocalDate dateFrom, LocalDate dateTo) throws PerunException {\n \t\tvosManager.checkVoExists(userSession, vo);\n \n \t\t//Authorization\n-\t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForVo_Vo_List<String>_String_String_policy\", Collections.singletonList(vo))) {\n+\t\tif (!AuthzResolver.authorizedInternal(userSession, \"getApplicationsForVo_Vo_List<String>_LocalDate_LocalDate_policy\", Collections.singletonList(vo))) {\n \t\t\tthrow new PrivilegeException(userSession, \"getApplicationsForVo\");\n \t\t}\n \t\ttry {\n"}}, {"oid": "c882107ee2cc92852c9841a32f4ba99597af9fea", "url": "https://github.com/CESNET/perun/commit/c882107ee2cc92852c9841a32f4ba99597af9fea", "message": "changed type of additional parameters to LocalDate, modified SQL, updated parameter parsing from request, updated policy names to reflect parameter types", "committedDate": "2020-12-15T13:14:06Z", "type": "commit"}, {"oid": "65f5888f357b2a7571ed453b674acd0e81d63a3e", "url": "https://github.com/CESNET/perun/commit/65f5888f357b2a7571ed453b674acd0e81d63a3e", "message": "add boolean parameter indicating whether to include group applications", "committedDate": "2020-12-15T13:45:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU4OTQyOQ==", "url": "https://github.com/CESNET/perun/pull/3035#discussion_r543589429", "bodyText": "Please add includeGroupApplications param to the javadoc. Same for the method above.", "author": "zlamalp", "createdAt": "2020-12-15T18:36:23Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/RegistrarManager.java", "diffHunk": "@@ -274,7 +275,23 @@\n \t * @return list of applications\n \t * @throws PerunException\n \t */\n-\tList<Application> getApplicationsForVo(PerunSession sess, Vo vo, List<String> state) throws PerunException;\n+\tList<Application> getApplicationsForVo(PerunSession sess, Vo vo, List<String> state, Boolean includeGroupApplications) throws PerunException;\n+\n+\n+\t/**\n+\t * Gets all applications in a given state for a given VO.\n+\t * If state is null, returns all applications for a given VO.\n+\t *\n+\t * @param sess who is asking\n+\t * @param vo VO to get applications for\n+\t * @param state application state to filter by\n+\t * @param dateFrom return only applications with this date or newer\n+\t * @param dateTo return only applications with this date or older\n+\t * @return list of applications", "originalCommit": "65f5888f357b2a7571ed453b674acd0e81d63a3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDEwNjU0Mg==", "url": "https://github.com/CESNET/perun/pull/3035#discussion_r544106542", "bodyText": "Fixed.", "author": "mvocu", "createdAt": "2020-12-16T08:33:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU4OTQyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "923b5c46de6bedc3fe7124dd3dec3283535a4ed1", "chunk": "diff --git a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/RegistrarManager.java b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/RegistrarManager.java\nindex f9c98af5a..e13c6bcc8 100644\n--- a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/RegistrarManager.java\n+++ b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/RegistrarManager.java\n\n@@ -272,6 +272,7 @@ public interface RegistrarManager {\n \t * @param sess who is asking\n \t * @param vo VO to get applications for\n \t * @param state application state to filter by\n+\t * @param includeGroupApplications boolean flag whether to include group applications\n \t * @return list of applications\n \t * @throws PerunException\n \t */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU5NTg3NQ==", "url": "https://github.com/CESNET/perun/pull/3035#discussion_r543595875", "bodyText": "Maybe suggest format for date string like YYYY-MM-DD. Same for the VO version of the method.", "author": "zlamalp", "createdAt": "2020-12-15T18:45:16Z", "path": "perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/RegistrarManagerMethod.java", "diffHunk": "@@ -479,14 +500,33 @@ public ApplicationFormItem call(ApiCaller ac, Deserializer parms) throws PerunEx\n \t * @param state List<String> List of states: NEW, VERIFIED, APPROVED, REJECTED\n \t * @return List<Application> Found applications\n \t */\n+\t/*#\n+\t * Gets all applications in a given state for a given Group in a given date period.\n+\t *\n+\t * @param group int Group <code>id</code>\n+\t * @param state List<String> List of states: NEW, VERIFIED, APPROVED, REJECTED\n+\t * @param dateFrom String Earliest date for applications", "originalCommit": "65f5888f357b2a7571ed453b674acd0e81d63a3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDEwODk4Mw==", "url": "https://github.com/CESNET/perun/pull/3035#discussion_r544108983", "bodyText": "Fixed.", "author": "mvocu", "createdAt": "2020-12-16T08:37:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU5NTg3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "923b5c46de6bedc3fe7124dd3dec3283535a4ed1", "chunk": "diff --git a/perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/RegistrarManagerMethod.java b/perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/RegistrarManagerMethod.java\nindex 0cecc4bd6..5d38b3754 100644\n--- a/perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/RegistrarManagerMethod.java\n+++ b/perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/RegistrarManagerMethod.java\n\n@@ -505,8 +505,8 @@ public enum RegistrarManagerMethod implements ManagerMethod {\n \t *\n \t * @param group int Group <code>id</code>\n \t * @param state List<String> List of states: NEW, VERIFIED, APPROVED, REJECTED\n-\t * @param dateFrom String Earliest date for applications\n-\t * @param dateTo String Latest date for applications\n+\t * @param dateFrom LocalDate Earliest date for applications (format \"YYYY-MM-DD\")\n+\t * @param dateTo LocalDate Latest date for applications (format \"YYYY-MM-DD\")\n \t * @return List<Application> Found applications\n \t */\n \tgetApplicationsForGroup {\n"}}, {"oid": "923b5c46de6bedc3fe7124dd3dec3283535a4ed1", "url": "https://github.com/CESNET/perun/commit/923b5c46de6bedc3fe7124dd3dec3283535a4ed1", "message": "fix documentation", "committedDate": "2020-12-16T08:38:28Z", "type": "commit"}]}