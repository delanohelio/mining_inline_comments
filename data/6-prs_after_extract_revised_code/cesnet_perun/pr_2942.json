{"pr_number": 2942, "pr_title": "New hash data format", "pr_createdAt": "2020-10-23T12:13:06Z", "pr_url": "https://github.com/CESNET/perun/pull/2942", "timeline": [{"oid": "1aa797ba99b4e7e7105f4ccfa71c8a6a8d1cfb1b", "url": "https://github.com/CESNET/perun/commit/1aa797ba99b4e7e7105f4ccfa71c8a6a8d1cfb1b", "message": "New has data format\n\n* We needed to adjust to generated format so it can be easily proccessed\nin scripts.\n* The generator logic should be refactored since the generated format\nhas changed and it could be much better designed.", "committedDate": "2020-10-23T12:25:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk1NjIyNw==", "url": "https://github.com/CESNET/perun/pull/2942#discussion_r511956227", "bodyText": "These are all members on the facility, right?", "author": "stavamichal", "createdAt": "2020-10-26T13:25:33Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/api/ServicesManager.java", "diffHunk": "@@ -380,30 +380,24 @@\n \t *\n \t * attributes: {...hashes...}\n \t * hierarchy: {\n-\t *    ** facility **\n-\t *    hashes: [...hashes...]\n-\t *    members: []\n-\t *    children: [\n-\t *      {\n-\t *        ** resource1 **\n-\t *        hashes: [...hashes...]\n-\t *        children: []\n-\t *        members: [\n-\t *          {\n-\t *            ** member 1 **\n-\t *            hashes: [...hashes...]\n-\t *          },\n-\t *          {\n-\t *            ** member 2 **\n-\t *            ...\n-\t *          }\n-\t *        ]\n-\t *      },\n-\t *      {\n-\t *        ** resource2 **\n-\t *        ...\n-\t *      }\n-\t *    ]\n+\t *   \"1\": {    ** facility id **\n+\t *     members: {    ** all members on resource **", "originalCommit": "1aa797ba99b4e7e7105f4ccfa71c8a6a8d1cfb1b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk1Njg4NA==", "url": "https://github.com/CESNET/perun/pull/2942#discussion_r511956884", "bodyText": "The same for all other places where this Javadoc is used.", "author": "stavamichal", "createdAt": "2020-10-26T13:26:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk1NjIyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5MDI4NQ==", "url": "https://github.com/CESNET/perun/pull/2942#discussion_r512090285", "bodyText": "Yes, I have updated the javadocs.", "author": "Vojtech-Sassmann", "createdAt": "2020-10-26T16:20:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk1NjIyNw=="}], "type": "inlineReview", "revised_code": {"commit": "0c282819932fece1a9b52603b124f9ba4edd83e2", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/api/ServicesManager.java b/perun-core/src/main/java/cz/metacentrum/perun/core/api/ServicesManager.java\nindex 79b9ddf63..25bcef87d 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/api/ServicesManager.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/api/ServicesManager.java\n\n@@ -381,7 +381,7 @@ public interface ServicesManager {\n \t * attributes: {...hashes...}\n \t * hierarchy: {\n \t *   \"1\": {    ** facility id **\n-\t *     members: {    ** all members on resource **\n+\t *     members: {    ** all members on the facility **\n \t *        \"4\" : 5,    ** member id : user id **\n \t *        \"6\" : 7,    ** member id : user id **\n \t *       ...\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk1NjQ5NQ==", "url": "https://github.com/CESNET/perun/pull/2942#discussion_r511956495", "bodyText": "These should be all members on the resource 2.", "author": "stavamichal", "createdAt": "2020-10-26T13:25:58Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/api/ServicesManager.java", "diffHunk": "@@ -380,30 +380,24 @@\n \t *\n \t * attributes: {...hashes...}\n \t * hierarchy: {\n-\t *    ** facility **\n-\t *    hashes: [...hashes...]\n-\t *    members: []\n-\t *    children: [\n-\t *      {\n-\t *        ** resource1 **\n-\t *        hashes: [...hashes...]\n-\t *        children: []\n-\t *        members: [\n-\t *          {\n-\t *            ** member 1 **\n-\t *            hashes: [...hashes...]\n-\t *          },\n-\t *          {\n-\t *            ** member 2 **\n-\t *            ...\n-\t *          }\n-\t *        ]\n-\t *      },\n-\t *      {\n-\t *        ** resource2 **\n-\t *        ...\n-\t *      }\n-\t *    ]\n+\t *   \"1\": {    ** facility id **\n+\t *     members: {    ** all members on resource **\n+\t *        \"4\" : 5,    ** member id : user id **\n+\t *        \"6\" : 7,    ** member id : user id **\n+\t *       ...\n+\t *     }\n+\t *     children: [\n+\t *       \"2\": {    ** resource id **\n+\t *         children: []\n+\t *         members: {", "originalCommit": "1aa797ba99b4e7e7105f4ccfa71c8a6a8d1cfb1b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5MDQ1NQ==", "url": "https://github.com/CESNET/perun/pull/2942#discussion_r512090455", "bodyText": "I have added a comment in the javadocs.", "author": "Vojtech-Sassmann", "createdAt": "2020-10-26T16:20:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk1NjQ5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "0c282819932fece1a9b52603b124f9ba4edd83e2", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/api/ServicesManager.java b/perun-core/src/main/java/cz/metacentrum/perun/core/api/ServicesManager.java\nindex 79b9ddf63..25bcef87d 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/api/ServicesManager.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/api/ServicesManager.java\n\n@@ -381,7 +381,7 @@ public interface ServicesManager {\n \t * attributes: {...hashes...}\n \t * hierarchy: {\n \t *   \"1\": {    ** facility id **\n-\t *     members: {    ** all members on resource **\n+\t *     members: {    ** all members on the facility **\n \t *        \"4\" : 5,    ** member id : user id **\n \t *        \"6\" : 7,    ** member id : user id **\n \t *       ...\n"}}, {"oid": "0c282819932fece1a9b52603b124f9ba4edd83e2", "url": "https://github.com/CESNET/perun/commit/0c282819932fece1a9b52603b124f9ba4edd83e2", "message": "New has data format\n\n* We needed to adjust to generated format so it can be easily proccessed\nin scripts.\n* The generator logic should be refactored since the generated format\nhas changed and it could be much better designed.", "committedDate": "2020-10-26T16:20:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU4NzkwMA==", "url": "https://github.com/CESNET/perun/pull/2942#discussion_r512587900", "bodyText": "Shouldn't hashes: [...hashes...] be removed also from this class javadoc? It was removed from services manager methods API docs.", "author": "zlamalp", "createdAt": "2020-10-27T10:50:06Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/HierarchicalHashedDataGenerator.java", "diffHunk": "@@ -54,6 +56,7 @@\n \tprivate final Service service;\n \tprivate final Facility facility;\n \tprivate final GenDataProvider dataProvider;\n+\tprivate final Set<Member> allMembers = new HashSet<>();", "originalCommit": "0c282819932fece1a9b52603b124f9ba4edd83e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk3MzgzOA==", "url": "https://github.com/CESNET/perun/pull/2942#discussion_r514973838", "bodyText": "Yes, I have removed it.", "author": "Vojtech-Sassmann", "createdAt": "2020-10-30T09:38:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU4NzkwMA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU5MDIzMw==", "url": "https://github.com/CESNET/perun/pull/2942#discussion_r512590233", "bodyText": "Shouldn't hashes: [...hashes...] be removed also from this class javadoc? It was removed from services manager methods API docs.", "author": "zlamalp", "createdAt": "2020-10-27T10:53:01Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GroupsHashedDataGenerator.java", "diffHunk": "@@ -68,6 +68,7 @@\n \tprivate final Facility facility;", "originalCommit": "0c282819932fece1a9b52603b124f9ba4edd83e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk3Mzk1MQ==", "url": "https://github.com/CESNET/perun/pull/2942#discussion_r514973951", "bodyText": "Yes, I have removed it.", "author": "Vojtech-Sassmann", "createdAt": "2020-10-30T09:38:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU5MDIzMw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU5MTczNA==", "url": "https://github.com/CESNET/perun/pull/2942#discussion_r512591734", "bodyText": "Variable resourceAttrHashes is not used.", "author": "zlamalp", "createdAt": "2020-10-27T10:55:07Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/HierarchicalHashedDataGenerator.java", "diffHunk": "@@ -94,18 +99,19 @@ private GenDataNode getDataForResource(Resource resource) {\n \t\t} else {\n \t\t\tmembers = sess.getPerunBl().getResourcesManagerBl().getAllowedMembers(sess, resource);\n \t\t}\n+\t\tallMembers.addAll(members);\n \n \t\tdataProvider.loadResourceAttributes(resource, members, false);\n \n \t\tList<String> resourceAttrHashes = dataProvider.getResourceAttributesHashes(resource, false);", "originalCommit": "0c282819932fece1a9b52603b124f9ba4edd83e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk3NDA1OA==", "url": "https://github.com/CESNET/perun/pull/2942#discussion_r514974058", "bodyText": "Variable removed.", "author": "Vojtech-Sassmann", "createdAt": "2020-10-30T09:39:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU5MTczNA=="}], "type": "inlineReview", "revised_code": {"commit": "1f3a4deb322c1c49bb8c059046ad13fe79d044c4", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/HierarchicalHashedDataGenerator.java b/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/HierarchicalHashedDataGenerator.java\nindex 726c527bd..4050cf1cc 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/HierarchicalHashedDataGenerator.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/HierarchicalHashedDataGenerator.java\n\n@@ -103,7 +97,7 @@ public class HierarchicalHashedDataGenerator implements HashedDataGenerator {\n \n \t\tdataProvider.loadResourceAttributes(resource, members, false);\n \n-\t\tList<String> resourceAttrHashes = dataProvider.getResourceAttributesHashes(resource, false);\n+\t\tdataProvider.getResourceAttributesHashes(resource, false);\n \n \t\tmembers.forEach(member -> getDataForMember(resource, member));\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU5MjI3MQ==", "url": "https://github.com/CESNET/perun/pull/2942#discussion_r512592271", "bodyText": "facilityAttrHashes is not used anywhere.", "author": "zlamalp", "createdAt": "2020-10-27T10:55:51Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/HierarchicalHashedDataGenerator.java", "diffHunk": "@@ -72,19 +75,21 @@ public HashedGenData generateData() {\n \t\tList<Resource> resources =\n \t\t\t\tsess.getPerunBl().getFacilitiesManagerBl().getAssignedResources(sess, facility, null, service);\n \n-\t\tList<GenDataNode> childNodes = resources.stream()\n-\t\t\t\t.map(this::getDataForResource)\n-\t\t\t\t.collect(Collectors.toList());\n+\t\tMap<Integer, GenDataNode> childNodes = resources.stream()\n+\t\t\t\t.collect(toMap(Resource::getId, this::getDataForResource));\n \n \t\tList<String> facilityAttrHashes = dataProvider.getFacilityAttributesHashes();", "originalCommit": "0c282819932fece1a9b52603b124f9ba4edd83e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk3NDA4Nw==", "url": "https://github.com/CESNET/perun/pull/2942#discussion_r514974087", "bodyText": "Variable removed.", "author": "Vojtech-Sassmann", "createdAt": "2020-10-30T09:39:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU5MjI3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "1f3a4deb322c1c49bb8c059046ad13fe79d044c4", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/HierarchicalHashedDataGenerator.java b/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/HierarchicalHashedDataGenerator.java\nindex 726c527bd..4050cf1cc 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/HierarchicalHashedDataGenerator.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/HierarchicalHashedDataGenerator.java\n\n@@ -78,7 +72,7 @@ public class HierarchicalHashedDataGenerator implements HashedDataGenerator {\n \t\tMap<Integer, GenDataNode> childNodes = resources.stream()\n \t\t\t\t.collect(toMap(Resource::getId, this::getDataForResource));\n \n-\t\tList<String> facilityAttrHashes = dataProvider.getFacilityAttributesHashes();\n+\t\tdataProvider.getFacilityAttributesHashes();\n \t\tMap<String, Map<String, Object>> attributes = dataProvider.getAllFetchedAttributes();\n \n \t\tMap<Integer, Integer> memberIdsToUserIds = allMembers.stream()\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU5MzI4NA==", "url": "https://github.com/CESNET/perun/pull/2942#discussion_r512593284", "bodyText": "resourceAttrHashes is not used.", "author": "zlamalp", "createdAt": "2020-10-27T10:57:10Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GroupsHashedDataGenerator.java", "diffHunk": "@@ -106,26 +109,27 @@ private GenDataNode getDataForResource(Resource resource) {\n \t\t} else {\n \t\t\tmembers = sess.getPerunBl().getResourcesManagerBl().getAllowedMembers(sess, resource);\n \t\t}\n+\t\tallMembers.addAll(members);\n \n \t\tdataProvider.loadResourceAttributes(resource, members, true);\n \n \t\tList<String> resourceAttrHashes = dataProvider.getResourceAttributesHashes(resource, true);", "originalCommit": "0c282819932fece1a9b52603b124f9ba4edd83e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk3NDE0MA==", "url": "https://github.com/CESNET/perun/pull/2942#discussion_r514974140", "bodyText": "Variable removed.", "author": "Vojtech-Sassmann", "createdAt": "2020-10-30T09:39:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU5MzI4NA=="}], "type": "inlineReview", "revised_code": {"commit": "1f3a4deb322c1c49bb8c059046ad13fe79d044c4", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GroupsHashedDataGenerator.java b/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GroupsHashedDataGenerator.java\nindex 2608244d0..1b98ce972 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GroupsHashedDataGenerator.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GroupsHashedDataGenerator.java\n\n@@ -113,7 +105,7 @@ public class GroupsHashedDataGenerator implements HashedDataGenerator {\n \n \t\tdataProvider.loadResourceAttributes(resource, members, true);\n \n-\t\tList<String> resourceAttrHashes = dataProvider.getResourceAttributesHashes(resource, true);\n+\t\tdataProvider.getResourceAttributesHashes(resource, true);\n \n \t\t// This must be called so the hashes are added!!\n \t\tmembers.forEach(member -> getDataForMember(resource, member));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU5MzQ4MQ==", "url": "https://github.com/CESNET/perun/pull/2942#discussion_r512593481", "bodyText": "facilityAttrHashes is not used.", "author": "zlamalp", "createdAt": "2020-10-27T10:57:23Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GroupsHashedDataGenerator.java", "diffHunk": "@@ -84,19 +85,21 @@ public HashedGenData generateData() {\n \n \t\tList<Resource> resources = sess.getPerunBl().getFacilitiesManagerBl().getAssignedResources(sess, facility, null, service);\n \n-\t\tList<GenDataNode> childNodes = resources.stream()\n-\t\t\t\t.map(this::getDataForResource)\n-\t\t\t\t.collect(Collectors.toList());\n+\t\tMap<Integer, GenDataNode> childNodes = resources.stream()\n+\t\t\t\t.collect(toMap(Resource::getId, this::getDataForResource));\n \n \t\tList<String> facilityAttrHashes = dataProvider.getFacilityAttributesHashes();", "originalCommit": "0c282819932fece1a9b52603b124f9ba4edd83e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk3NDE5Ng==", "url": "https://github.com/CESNET/perun/pull/2942#discussion_r514974196", "bodyText": "Variable removed.", "author": "Vojtech-Sassmann", "createdAt": "2020-10-30T09:39:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU5MzQ4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "1f3a4deb322c1c49bb8c059046ad13fe79d044c4", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GroupsHashedDataGenerator.java b/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GroupsHashedDataGenerator.java\nindex 2608244d0..1b98ce972 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GroupsHashedDataGenerator.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/provisioning/GroupsHashedDataGenerator.java\n\n@@ -88,7 +80,7 @@ public class GroupsHashedDataGenerator implements HashedDataGenerator {\n \t\tMap<Integer, GenDataNode> childNodes = resources.stream()\n \t\t\t\t.collect(toMap(Resource::getId, this::getDataForResource));\n \n-\t\tList<String> facilityAttrHashes = dataProvider.getFacilityAttributesHashes();\n+\t\tdataProvider.getFacilityAttributesHashes();\n \t\tMap<String, Map<String, Object>> attributes = dataProvider.getAllFetchedAttributes();\n \n \t\tMap<Integer, Integer> memberIdsToUserIds = allMembers.stream()\n"}}, {"oid": "1f3a4deb322c1c49bb8c059046ad13fe79d044c4", "url": "https://github.com/CESNET/perun/commit/1f3a4deb322c1c49bb8c059046ad13fe79d044c4", "message": "New has data format\n\n* We needed to adjust to generated format so it can be easily proccessed\nin scripts.\n* The generator logic should be refactored since the generated format\nhas changed and it could be much better designed.", "committedDate": "2020-10-30T09:38:01Z", "type": "commit"}, {"oid": "1f3a4deb322c1c49bb8c059046ad13fe79d044c4", "url": "https://github.com/CESNET/perun/commit/1f3a4deb322c1c49bb8c059046ad13fe79d044c4", "message": "New has data format\n\n* We needed to adjust to generated format so it can be easily proccessed\nin scripts.\n* The generator logic should be refactored since the generated format\nhas changed and it could be much better designed.", "committedDate": "2020-10-30T09:38:01Z", "type": "forcePushed"}]}