{"pr_number": 2831, "pr_title": "Edit of findUsers", "pr_createdAt": "2020-08-04T10:37:06Z", "pr_url": "https://github.com/CESNET/perun/pull/2831", "timeline": [{"oid": "0ab2fc222daa94de71223a897227df3aebecdbdf", "url": "https://github.com/CESNET/perun/commit/0ab2fc222daa94de71223a897227df3aebecdbdf", "message": "Edit of findUsers\n\n- findUsers now uses only one query with multiple joins and conditions\n- the attributes to search users or members by are now stored in perun.properties and loaded by CoreConfig (it supports only full names of attributes)\n- these changes were also applied to findMembers\n- findUsers and findUsersByExactMatch now use private method with switch which selects whether name should be search only by exact match or not\n- also added tests for this method and fixed existing tests that were affected", "committedDate": "2020-08-04T10:20:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk3MDA0OQ==", "url": "https://github.com/CESNET/perun/pull/2831#discussion_r464970049", "bodyText": "There is possible SQL injection, since you put values from the config right into the SQL. Please use ? placeholder instead and pass it as a lists of strings. If necessary, you can use namedParameterJdbcTemplate instead of jdbc, but I believe query() should be able to work with the list params.", "author": "zlamalp", "createdAt": "2020-08-04T11:01:47Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/MembersManagerImpl.java", "diffHunk": "@@ -533,18 +548,18 @@ public MemberGroupStatus getUnifiedMemberGroupStatus(PerunSession sess, User use\n \t\tSet<Member> members = new HashSet<>(jdbc.query(\"select distinct \" + memberMappingSelectQuery +\n \t\t\t\t\" from members \" +\n \t\t\t\t\" left join users u on members.user_id=u.id \" +\n-\t\t\t\t\" left join member_attr_values mav1 on members.id=mav1.member_id and mav1.attr_id in (select id from attr_names where attr_name='\" + MembersManagerImpl.A_D_MEMBER_MAIl + \"') \" +\n-\t\t\t\t\" left join user_attr_values uav1 on u.id=uav1.user_id and uav1.attr_id in (select id from attr_names where attr_name='\" + MembersManagerImpl.A_D_USER_PREFERRED_MAIL + \"') \" +\n-\t\t\t\t\" left join user_attr_values uav2 on u.id=uav2.user_id and uav2.attr_id in (select id from attr_names where friendly_name like 'login-namespace:%') \" +\n+\t\t\t\t\" left join member_attr_values mav on members.id=mav.member_id and mav.attr_id in (select id from attr_names where attr_name in (\" + memberAttributes.toString() + \"))\" +", "originalCommit": "0ab2fc222daa94de71223a897227df3aebecdbdf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM3NTAwMw==", "url": "https://github.com/CESNET/perun/pull/2831#discussion_r465375003", "bodyText": "Oh, thank you, it should be fixed now, although I was unable to make it work without namedParameterJdbcTemplate .", "author": "metodej", "createdAt": "2020-08-04T22:55:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk3MDA0OQ=="}], "type": "inlineReview", "revised_code": {"commit": "72a3ab5cdef57f473fc25bdcd494975140b21da3", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/impl/MembersManagerImpl.java b/perun-core/src/main/java/cz/metacentrum/perun/core/impl/MembersManagerImpl.java\nindex ff649445c..9cdd20c32 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/impl/MembersManagerImpl.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/impl/MembersManagerImpl.java\n\n@@ -526,43 +527,63 @@ public class MembersManagerImpl implements MembersManagerImplApi {\n \n \t\t// Divide attributes received from CoreConfig into member, user and userExtSource attributes\n \t\tList<String> allAttributes = BeansUtils.getCoreConfig().getAttributesToSearchUsersAndMembersBy();\n-\t\tStringBuilder memberAttributes = new StringBuilder(\"''\");\n-\t\tStringBuilder userAttributes = new StringBuilder(\"''\");\n-\t\tStringBuilder uesAttributes = new StringBuilder(\"''\");\n+\t\tList<String> memberAttributes = new ArrayList<>();\n+\t\tList<String> userAttributes = new ArrayList<>();\n+\t\tList<String> uesAttributes = new ArrayList<>();\n \t\tfor (String attribute : allAttributes) {\n \t\t\tif (attribute.startsWith(AttributesManager.NS_MEMBER_ATTR)) {\n-\t\t\t\tmemberAttributes.append(\",'\").append(attribute).append(\"'\");\n+\t\t\t\tmemberAttributes.add(attribute);\n \t\t\t} else if (attribute.startsWith(AttributesManager.NS_USER_ATTR)) {\n-\t\t\t\tuserAttributes.append(\",'\").append(attribute).append(\"'\");\n+\t\t\t\tuserAttributes.add(attribute);\n \t\t\t} else if (attribute.startsWith(AttributesManager.NS_UES_ATTR)) {\n-\t\t\t\tuesAttributes.append(\",'\").append(attribute).append(\"'\");\n+\t\t\t\tuesAttributes.add(attribute);\n \t\t\t}\n \t\t}\n \n-\t\t//searching by member mail\n-\t\t//searching by user preferredMail\n+\t\tPair<String, String> memberAttributesQueryString = new Pair<>(\"\", \"\");\n+\t\tif (!memberAttributes.isEmpty()) {\n+\t\t\tmemberAttributesQueryString.put(\" left join member_attr_values mav on members.id=mav.member_id and mav.attr_id in (select id from attr_names where attr_name in (:memberAttributes))\", \" lower(mav.attr_value)=lower(:searchString) or \" );\n+\t\t}\n+\t\tPair<String, String> userAttributesQueryString = new Pair<>(\"\", \"\");\n+\t\tif (!userAttributes.isEmpty()) {\n+\t\t\tuserAttributesQueryString.put(\" left join user_attr_values uav on users.id=uav.user_id and uav.attr_id in (select id from attr_names where attr_name in (:userAttributes))\" , \" lower(uav.attr_value)=lower(:searchString) or \");\n+\t\t}\n+\t\tPair<String, String> uesAttributesQueryString = new Pair<>(\"\", \"\");\n+\t\tif (!uesAttributes.isEmpty()) {\n+\t\t\tuesAttributesQueryString.put(\" left join user_ext_source_attr_values uesav on uesav.user_ext_source_id=ues.id and uesav.attr_id in (select id from attr_names where attr_name in (:uesAttributes))\", \" lower(uesav.attr_value)=lower(:searchString) or \");\n+\t\t}\n+\n+\t\tMapSqlParameterSource namedParams = new MapSqlParameterSource();\n+\t\tnamedParams.addValue(\"searchString\", searchString);\n+\t\tnamedParams.addValue(\"nameString\", Utils.utftoasci(searchString.toLowerCase()));\n+\t\tnamedParams.addValue(\"memberAttributes\", memberAttributes);\n+\t\tnamedParams.addValue(\"userAttributes\", userAttributes);\n+\t\tnamedParams.addValue(\"uesAttributes\", uesAttributes);\n+\n+\t\t//searching by member attributes\n+\t\t//searching by user attributes\n \t\t//searching by login in userExtSources\n-\t\t//searching by login in logins (all namespaces)\n+\t\t//searching by userExtSource attributes\n \t\t//searching by name for user\n \t\t//searching by user and member id\n-\t\tSet<Member> members = new HashSet<>(jdbc.query(\"select distinct \" + memberMappingSelectQuery +\n+\t\tSet<Member> members = new HashSet<>(namedParameterJdbcTemplate.query(\"select distinct \" + memberMappingSelectQuery +\n \t\t\t\t\" from members \" +\n-\t\t\t\t\" left join users u on members.user_id=u.id \" +\n-\t\t\t\t\" left join member_attr_values mav on members.id=mav.member_id and mav.attr_id in (select id from attr_names where attr_name in (\" + memberAttributes.toString() + \"))\" +\n-\t\t\t\t\" left join user_attr_values uav on u.id=uav.user_id and uav.attr_id in (select id from attr_names where attr_name in (\" + userAttributes.toString() + \"))\" +\n-\t\t\t\t\" left join user_ext_sources ues on ues.user_id=u.id \" +\n-\t\t\t\t\" left join user_ext_source_attr_values uesav on uesav.user_ext_source_id=ues.id and uesav.attr_id in (select id from attr_names where attr_name in (\" + uesAttributes.toString() + \"))\" +\n+\t\t\t\t\" left join users on members.user_id=users.id \" +\n+\t\t\t\t\" left join user_ext_sources ues on ues.user_id=users.id \" +\n+\t\t\t\tmemberAttributesQueryString.getLeft() +\n+\t\t\t\tuserAttributesQueryString.getLeft() +\n+\t\t\t\tuesAttributesQueryString.getLeft() +\n \t\t\t\t\" where \" +\n \t\t\t\tvoIdQueryString +\n \t\t\t\tsponsoredQueryString +\n \t\t\t\t\" ( \" +\n-\t\t\t\t\" lower(mav.attr_value)=lower(?) or \" +\n-\t\t\t\t\" lower(uav.attr_value)=lower(?) or \" +\n-\t\t\t\t\" lower(ues.login_ext)=lower(?) or \" +\n-\t\t\t\t\" lower(uesav.attr_value)=lower(?) or \" +\n+\t\t\t\t\" lower(ues.login_ext)=lower(:searchString) or \" +\n+\t\t\t\tmemberAttributesQueryString.getRight() +\n+\t\t\t\tuserAttributesQueryString.getRight() +\n+\t\t\t\tuesAttributesQueryString.getRight() +\n \t\t\t\tidQueryString +\n \t\t\t\tuserNameQueryString +\n-\t\t\t\t\" ) \", MEMBER_MAPPER, searchString, searchString, searchString, searchString, Utils.utftoasci(searchString.toLowerCase())));\n+\t\t\t\t\" ) \", namedParams, MEMBER_MAPPER));\n \n \t\tif (vo != null) {\n \t\t\tlog.debug(\"Searching members of VO '{}' using searchString '{}', sponsored '{}'. Found: {} member(s).\", vo.getShortName(), searchString, onlySponsored, members.size());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk3MDk1MQ==", "url": "https://github.com/CESNET/perun/pull/2831#discussion_r464970951", "bodyText": "Same as in MembersManagerImpl, please use ? placeholders.", "author": "zlamalp", "createdAt": "2020-08-04T11:03:40Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/UsersManagerImpl.java", "diffHunk": "@@ -794,90 +795,92 @@ public void removeAllUserExtSources(PerunSession sess, User user) {\n \n \t@Override\n \tpublic List<User> findUsers(PerunSession sess, String searchString) {\n-\t\tSet<User> users = new HashSet<>();\n-\n-\t\tlog.debug(\"Searching for users using searchString '{}'\", searchString);\n-\n-\t\t// Search by mail (member)\n-\t\tusers.addAll(jdbc.query(\"select \" + userMappingSelectQuery +\n-\t\t\t\t\t\" from users, members, member_attr_values, attr_names \" +\n-\t\t\t\t\t\"where members.user_id=users.id and members.id=member_attr_values.member_id and member_attr_values.attr_id=attr_names.id and \" +\n-\t\t\t\t\t\"attr_names.attr_name='urn:perun:member:attribute-def:def:mail' and \" +\n-\t\t\t\t\t\"lower(member_attr_values.attr_value)=lower(?)\", USER_MAPPER, searchString));\n-\n-\t\t// Search preferred email (user)\n-\t\tusers.addAll(jdbc.query(\"select \" + userMappingSelectQuery +\n-\t\t\t\t\t\" from users, user_attr_values, attr_names \" +\n-\t\t\t\t\t\"where users.id=user_attr_values.user_id and user_attr_values.attr_id=attr_names.id and \" +\n-\t\t\t\t\t\"attr_names.attr_name='urn:perun:user:attribute-def:def:preferredMail' and \" +\n-\t\t\t\t\t\"lower(user_attr_values.attr_value)=lower(?)\", USER_MAPPER, searchString));\n-\n-\t\t// Search logins in userExtSources\n-\t\tusers.addAll(jdbc.query(\"select \" + userMappingSelectQuery +\n-\t\t\t\t\t\" from users, user_ext_sources \" +\n-\t\t\t\t\t\"where lower(user_ext_sources.login_ext)=lower(?) and user_ext_sources.user_id=users.id\", USER_MAPPER, searchString));\n-\n-\t\t// Search logins in attributes: login-namespace:*\n-\t\tusers.addAll(jdbc.query(\"select distinct \" + userMappingSelectQuery +\n-\t\t\t\t\t\" from attr_names, user_attr_values, users \" +\n-\t\t\t\t\t\"where attr_names.friendly_name like 'login-namespace:%' and lower(user_attr_values.attr_value)=lower(?) \" +\n-\t\t\t\t\t\"and attr_names.id=user_attr_values.attr_id and user_attr_values.user_id=users.id\",\n-\t\t\t\t\tUSER_MAPPER, searchString));\n-\n-\t\t// Search by userId\n-\t\ttry {\n-\t\t\tint userId = Integer.parseInt(searchString);\n-\t\t\tusers.addAll(jdbc.query(\"select \" + userMappingSelectQuery + \" from users where id=?\", USER_MAPPER, userId));\n-\t\t} catch (NumberFormatException e) {\n-\t\t\t// IGNORE\n-\t\t}\n-\n-\t\tusers.addAll(findUsersByName(sess, searchString));\n-\n-\t\treturn new ArrayList<>(users);\n+\t\treturn findUsers(searchString, false);\n \t}\n \n \t@Override\n \tpublic List<User> findUsersByExactMatch(PerunSession sess, String searchString) {\n-\t\tSet<User> users = new HashSet<>();\n+\t\treturn findUsers(searchString, true);\n+\t}\n \n-\t\tlog.debug(\"Searching for users using searchString '{}'\", searchString);\n+\t/**\n+\t * Returns list of users who matches the searchString, searching name, id, member attributes, user attributes\n+\t * and userExtSource attributes (listed in CoreConfig).\n+\t *\n+\t * @param searchString string used to search by\n+\t * @param exactMatch if true, searches name only by exact match\n+\t * @return list of users\n+\t */\n+\tprivate List<User> findUsers(String searchString, boolean exactMatch) {\n+\t\tString userNameQueryString;\n+\t\tif (exactMatch) {\n+\t\t\t// Part of query to search by user name (exact)\n+\t\t\tif (Compatibility.isPostgreSql()) {\n+\t\t\t\tuserNameQueryString= \" strpos(lower(\"+Compatibility.convertToAscii(\"COALESCE(users.first_name,'') || COALESCE(users.middle_name,'') || COALESCE(users.last_name,'')\") + \")=?\";\n+\t\t\t} else if (Compatibility.isHSQLDB()) {\n+\t\t\t\tuserNameQueryString=\" lower(\"+Compatibility.convertToAscii(\"COALESCE(users.first_name,'') || COALESCE(users.middle_name,'') || COALESCE(users.last_name,'')\")+\")=?\";\n+\t\t\t} else {\n+\t\t\t\tthrow new InternalErrorException(\"Unsupported db type\");\n+\t\t\t}\n+\t\t} else {\n+\t\t\t// Part of query to search by user name (not exact)\n+\t\t\tif (Compatibility.isPostgreSql()) {\n+\t\t\t\tuserNameQueryString = \" strpos(lower(\" + Compatibility.convertToAscii(\"COALESCE(users.first_name,'') || COALESCE(users.middle_name,'') || COALESCE(users.last_name,'')\") + \"),?) > 0 \";\n+\t\t\t} else if (Compatibility.isHSQLDB()) {\n+\t\t\t\tuserNameQueryString = \" lower(\" + Compatibility.convertToAscii(\"COALESCE(users.first_name,'') || COALESCE(users.middle_name,'') || COALESCE(users.last_name,'')\") + \") like '%' || ? || '%' \";\n+\t\t\t} else {\n+\t\t\t\tthrow new InternalErrorException(\"Unsupported db type\");\n+\t\t\t}\n+\t\t}\n \n-\t\t// Search by mail (member)\n-\t\tusers.addAll(jdbc.query(\"select \" + userMappingSelectQuery +\n-\t\t\t\t\" from users, members, member_attr_values, attr_names \" +\n-\t\t\t\t\"where members.user_id=users.id and members.id=member_attr_values.member_id and member_attr_values.attr_id=attr_names.id and \" +\n-\t\t\t\t\"attr_names.attr_name='urn:perun:member:attribute-def:def:mail' and \" +\n-\t\t\t\t\"lower(member_attr_values.attr_value)=lower(?)\", USER_MAPPER, searchString));\n-\n-\t\t// Search preferred email (user)\n-\t\tusers.addAll(jdbc.query(\"select \" + userMappingSelectQuery +\n-\t\t\t\t\" from users, user_attr_values, attr_names \" +\n-\t\t\t\t\"where users.id=user_attr_values.user_id and user_attr_values.attr_id=attr_names.id and \" +\n-\t\t\t\t\"attr_names.attr_name='urn:perun:user:attribute-def:def:preferredMail' and \" +\n-\t\t\t\t\"lower(user_attr_values.attr_value)=lower(?)\", USER_MAPPER, searchString));\n-\n-\t\t// Search logins in userExtSources\n-\t\tusers.addAll(jdbc.query(\"select \" + userMappingSelectQuery +\n-\t\t\t\t\" from users, user_ext_sources \" +\n-\t\t\t\t\"where lower(user_ext_sources.login_ext)=lower(?) and user_ext_sources.user_id=users.id\", USER_MAPPER, searchString));\n-\n-\t\t// Search logins in attributes: login-namespace:*\n-\t\tusers.addAll(jdbc.query(\"select distinct \" + userMappingSelectQuery +\n-\t\t\t\t\t\t\" from attr_names, user_attr_values, users \" +\n-\t\t\t\t\t\t\"where attr_names.friendly_name like 'login-namespace:%' and lower(user_attr_values.attr_value)=lower(?) \" +\n-\t\t\t\t\t\t\"and attr_names.id=user_attr_values.attr_id and user_attr_values.user_id=users.id\",\n-\t\t\t\tUSER_MAPPER, searchString));\n-\n-\t\t// Search by userId\n+\t\t// Part of query to search by user id\n+\t\tString idQueryString = \"\";\n \t\ttry {\n-\t\t\tint userId = Integer.parseInt(searchString);\n-\t\t\tusers.addAll(jdbc.query(\"select \" + userMappingSelectQuery + \" from users where id=?\", USER_MAPPER, userId));\n+\t\t\tint id = Integer.parseInt(searchString);\n+\t\t\tidQueryString = \" users.id=\" + id + \" or \";\n \t\t} catch (NumberFormatException e) {\n-\t\t\t// IGNORE\n+\t\t\t// IGNORE wrong format of ID\n+\t\t}\n+\n+\t\t// Divide attributes received from CoreConfig into member, user and userExtSource attributes\n+\t\tList<String> allAttributes = BeansUtils.getCoreConfig().getAttributesToSearchUsersAndMembersBy();\n+\t\tStringBuilder memberAttributes = new StringBuilder(\"''\");\n+\t\tStringBuilder userAttributes = new StringBuilder(\"''\");\n+\t\tStringBuilder uesAttributes = new StringBuilder(\"''\");\n+\t\tfor (String attribute : allAttributes) {\n+\t\t\tif (attribute.startsWith(AttributesManager.NS_MEMBER_ATTR)) {\n+\t\t\t\tmemberAttributes.append(\",'\").append(attribute).append(\"'\");\n+\t\t\t} else if (attribute.startsWith(AttributesManager.NS_USER_ATTR)) {\n+\t\t\t\tuserAttributes.append(\",'\").append(attribute).append(\"'\");\n+\t\t\t} else if (attribute.startsWith(AttributesManager.NS_UES_ATTR)) {\n+\t\t\t\tuesAttributes.append(\",'\").append(attribute).append(\"'\");\n+\t\t\t}\n \t\t}\n \n-\t\tusers.addAll(findUsersByExactName(sess, searchString));\n+\t\t// Search by member attributes\n+\t\t// Search by user attributes\n+\t\t// Search by login in userExtSources\n+\t\t// Search by userExtSource attributes\n+\t\t// Search by user id\n+\t\t// Search by name for user\n+\t\tSet<User> users = new HashSet<>(jdbc.query(\"select distinct \" + userMappingSelectQuery +\n+\t\t\t\" from users \" +\n+\t\t\t\" left join members m on users.id=m.user_id \" +\n+\t\t\t\" left join member_attr_values mav on m.id=mav.member_id and mav.attr_id in (select id from attr_names where attr_name in (\" + memberAttributes.toString() + \"))\" +", "originalCommit": "0ab2fc222daa94de71223a897227df3aebecdbdf", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "72a3ab5cdef57f473fc25bdcd494975140b21da3", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/impl/UsersManagerImpl.java b/perun-core/src/main/java/cz/metacentrum/perun/core/impl/UsersManagerImpl.java\nindex 019b47b28..c473caa17 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/impl/UsersManagerImpl.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/impl/UsersManagerImpl.java\n\n@@ -816,18 +816,18 @@ public class UsersManagerImpl implements UsersManagerImplApi {\n \t\tif (exactMatch) {\n \t\t\t// Part of query to search by user name (exact)\n \t\t\tif (Compatibility.isPostgreSql()) {\n-\t\t\t\tuserNameQueryString= \" strpos(lower(\"+Compatibility.convertToAscii(\"COALESCE(users.first_name,'') || COALESCE(users.middle_name,'') || COALESCE(users.last_name,'')\") + \")=?\";\n+\t\t\t\tuserNameQueryString= \" strpos(lower(\"+Compatibility.convertToAscii(\"COALESCE(users.first_name,'') || COALESCE(users.middle_name,'') || COALESCE(users.last_name,'')\") + \")=:nameString\";\n \t\t\t} else if (Compatibility.isHSQLDB()) {\n-\t\t\t\tuserNameQueryString=\" lower(\"+Compatibility.convertToAscii(\"COALESCE(users.first_name,'') || COALESCE(users.middle_name,'') || COALESCE(users.last_name,'')\")+\")=?\";\n+\t\t\t\tuserNameQueryString=\" lower(\"+Compatibility.convertToAscii(\"COALESCE(users.first_name,'') || COALESCE(users.middle_name,'') || COALESCE(users.last_name,'')\")+\")=:nameString\";\n \t\t\t} else {\n \t\t\t\tthrow new InternalErrorException(\"Unsupported db type\");\n \t\t\t}\n \t\t} else {\n \t\t\t// Part of query to search by user name (not exact)\n \t\t\tif (Compatibility.isPostgreSql()) {\n-\t\t\t\tuserNameQueryString = \" strpos(lower(\" + Compatibility.convertToAscii(\"COALESCE(users.first_name,'') || COALESCE(users.middle_name,'') || COALESCE(users.last_name,'')\") + \"),?) > 0 \";\n+\t\t\t\tuserNameQueryString = \" strpos(lower(\" + Compatibility.convertToAscii(\"COALESCE(users.first_name,'') || COALESCE(users.middle_name,'') || COALESCE(users.last_name,'')\") + \"),:nameString) > 0 \";\n \t\t\t} else if (Compatibility.isHSQLDB()) {\n-\t\t\t\tuserNameQueryString = \" lower(\" + Compatibility.convertToAscii(\"COALESCE(users.first_name,'') || COALESCE(users.middle_name,'') || COALESCE(users.last_name,'')\") + \") like '%' || ? || '%' \";\n+\t\t\t\tuserNameQueryString = \" lower(\" + Compatibility.convertToAscii(\"COALESCE(users.first_name,'') || COALESCE(users.middle_name,'') || COALESCE(users.last_name,'')\") + \") like '%' || :nameString || '%' \";\n \t\t\t} else {\n \t\t\t\tthrow new InternalErrorException(\"Unsupported db type\");\n \t\t\t}\n"}}, {"oid": "72a3ab5cdef57f473fc25bdcd494975140b21da3", "url": "https://github.com/CESNET/perun/commit/72a3ab5cdef57f473fc25bdcd494975140b21da3", "message": "Fixes based on review\n\n- changed query creation of findUsers and findMembers to namedParameterJdbcTemplate to pass values of lists\n- also fixed some comments", "committedDate": "2020-08-04T22:46:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM0OTU2OA==", "url": "https://github.com/CESNET/perun/pull/2831#discussion_r466349568", "bodyText": "The next lines of code seem to be the same as in MembersManagerImpl. Could you extract it to a separate method that can be used in both managers?", "author": "balcirakpeter", "createdAt": "2020-08-06T11:35:04Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/UsersManagerImpl.java", "diffHunk": "@@ -794,90 +795,112 @@ public void removeAllUserExtSources(PerunSession sess, User user) {\n \n \t@Override\n \tpublic List<User> findUsers(PerunSession sess, String searchString) {\n-\t\tSet<User> users = new HashSet<>();\n-\n-\t\tlog.debug(\"Searching for users using searchString '{}'\", searchString);\n-\n-\t\t// Search by mail (member)\n-\t\tusers.addAll(jdbc.query(\"select \" + userMappingSelectQuery +\n-\t\t\t\t\t\" from users, members, member_attr_values, attr_names \" +\n-\t\t\t\t\t\"where members.user_id=users.id and members.id=member_attr_values.member_id and member_attr_values.attr_id=attr_names.id and \" +\n-\t\t\t\t\t\"attr_names.attr_name='urn:perun:member:attribute-def:def:mail' and \" +\n-\t\t\t\t\t\"lower(member_attr_values.attr_value)=lower(?)\", USER_MAPPER, searchString));\n-\n-\t\t// Search preferred email (user)\n-\t\tusers.addAll(jdbc.query(\"select \" + userMappingSelectQuery +\n-\t\t\t\t\t\" from users, user_attr_values, attr_names \" +\n-\t\t\t\t\t\"where users.id=user_attr_values.user_id and user_attr_values.attr_id=attr_names.id and \" +\n-\t\t\t\t\t\"attr_names.attr_name='urn:perun:user:attribute-def:def:preferredMail' and \" +\n-\t\t\t\t\t\"lower(user_attr_values.attr_value)=lower(?)\", USER_MAPPER, searchString));\n-\n-\t\t// Search logins in userExtSources\n-\t\tusers.addAll(jdbc.query(\"select \" + userMappingSelectQuery +\n-\t\t\t\t\t\" from users, user_ext_sources \" +\n-\t\t\t\t\t\"where lower(user_ext_sources.login_ext)=lower(?) and user_ext_sources.user_id=users.id\", USER_MAPPER, searchString));\n-\n-\t\t// Search logins in attributes: login-namespace:*\n-\t\tusers.addAll(jdbc.query(\"select distinct \" + userMappingSelectQuery +\n-\t\t\t\t\t\" from attr_names, user_attr_values, users \" +\n-\t\t\t\t\t\"where attr_names.friendly_name like 'login-namespace:%' and lower(user_attr_values.attr_value)=lower(?) \" +\n-\t\t\t\t\t\"and attr_names.id=user_attr_values.attr_id and user_attr_values.user_id=users.id\",\n-\t\t\t\t\tUSER_MAPPER, searchString));\n-\n-\t\t// Search by userId\n-\t\ttry {\n-\t\t\tint userId = Integer.parseInt(searchString);\n-\t\t\tusers.addAll(jdbc.query(\"select \" + userMappingSelectQuery + \" from users where id=?\", USER_MAPPER, userId));\n-\t\t} catch (NumberFormatException e) {\n-\t\t\t// IGNORE\n-\t\t}\n-\n-\t\tusers.addAll(findUsersByName(sess, searchString));\n-\n-\t\treturn new ArrayList<>(users);\n+\t\treturn findUsers(searchString, false);\n \t}\n \n \t@Override\n \tpublic List<User> findUsersByExactMatch(PerunSession sess, String searchString) {\n-\t\tSet<User> users = new HashSet<>();\n+\t\treturn findUsers(searchString, true);\n+\t}\n \n-\t\tlog.debug(\"Searching for users using searchString '{}'\", searchString);\n+\t/**\n+\t * Returns list of users who matches the searchString, searching name, id, member attributes, user attributes\n+\t * and userExtSource attributes (listed in CoreConfig).\n+\t *\n+\t * @param searchString string used to search by\n+\t * @param exactMatch if true, searches name only by exact match\n+\t * @return list of users\n+\t */\n+\tprivate List<User> findUsers(String searchString, boolean exactMatch) {\n+\t\tString userNameQueryString;\n+\t\tif (exactMatch) {\n+\t\t\t// Part of query to search by user name (exact)\n+\t\t\tif (Compatibility.isPostgreSql()) {\n+\t\t\t\tuserNameQueryString= \" strpos(lower(\"+Compatibility.convertToAscii(\"COALESCE(users.first_name,'') || COALESCE(users.middle_name,'') || COALESCE(users.last_name,'')\") + \")=:nameString\";\n+\t\t\t} else if (Compatibility.isHSQLDB()) {\n+\t\t\t\tuserNameQueryString=\" lower(\"+Compatibility.convertToAscii(\"COALESCE(users.first_name,'') || COALESCE(users.middle_name,'') || COALESCE(users.last_name,'')\")+\")=:nameString\";\n+\t\t\t} else {\n+\t\t\t\tthrow new InternalErrorException(\"Unsupported db type\");\n+\t\t\t}\n+\t\t} else {\n+\t\t\t// Part of query to search by user name (not exact)\n+\t\t\tif (Compatibility.isPostgreSql()) {\n+\t\t\t\tuserNameQueryString = \" strpos(lower(\" + Compatibility.convertToAscii(\"COALESCE(users.first_name,'') || COALESCE(users.middle_name,'') || COALESCE(users.last_name,'')\") + \"),:nameString) > 0 \";\n+\t\t\t} else if (Compatibility.isHSQLDB()) {\n+\t\t\t\tuserNameQueryString = \" lower(\" + Compatibility.convertToAscii(\"COALESCE(users.first_name,'') || COALESCE(users.middle_name,'') || COALESCE(users.last_name,'')\") + \") like '%' || :nameString || '%' \";\n+\t\t\t} else {\n+\t\t\t\tthrow new InternalErrorException(\"Unsupported db type\");\n+\t\t\t}\n+\t\t}\n \n-\t\t// Search by mail (member)\n-\t\tusers.addAll(jdbc.query(\"select \" + userMappingSelectQuery +\n-\t\t\t\t\" from users, members, member_attr_values, attr_names \" +\n-\t\t\t\t\"where members.user_id=users.id and members.id=member_attr_values.member_id and member_attr_values.attr_id=attr_names.id and \" +\n-\t\t\t\t\"attr_names.attr_name='urn:perun:member:attribute-def:def:mail' and \" +\n-\t\t\t\t\"lower(member_attr_values.attr_value)=lower(?)\", USER_MAPPER, searchString));\n-\n-\t\t// Search preferred email (user)\n-\t\tusers.addAll(jdbc.query(\"select \" + userMappingSelectQuery +\n-\t\t\t\t\" from users, user_attr_values, attr_names \" +\n-\t\t\t\t\"where users.id=user_attr_values.user_id and user_attr_values.attr_id=attr_names.id and \" +\n-\t\t\t\t\"attr_names.attr_name='urn:perun:user:attribute-def:def:preferredMail' and \" +\n-\t\t\t\t\"lower(user_attr_values.attr_value)=lower(?)\", USER_MAPPER, searchString));\n-\n-\t\t// Search logins in userExtSources\n-\t\tusers.addAll(jdbc.query(\"select \" + userMappingSelectQuery +\n-\t\t\t\t\" from users, user_ext_sources \" +\n-\t\t\t\t\"where lower(user_ext_sources.login_ext)=lower(?) and user_ext_sources.user_id=users.id\", USER_MAPPER, searchString));\n-\n-\t\t// Search logins in attributes: login-namespace:*\n-\t\tusers.addAll(jdbc.query(\"select distinct \" + userMappingSelectQuery +\n-\t\t\t\t\t\t\" from attr_names, user_attr_values, users \" +\n-\t\t\t\t\t\t\"where attr_names.friendly_name like 'login-namespace:%' and lower(user_attr_values.attr_value)=lower(?) \" +\n-\t\t\t\t\t\t\"and attr_names.id=user_attr_values.attr_id and user_attr_values.user_id=users.id\",\n-\t\t\t\tUSER_MAPPER, searchString));\n-\n-\t\t// Search by userId\n+\t\t// Part of query to search by user id\n+\t\tString idQueryString = \"\";\n \t\ttry {\n-\t\t\tint userId = Integer.parseInt(searchString);\n-\t\t\tusers.addAll(jdbc.query(\"select \" + userMappingSelectQuery + \" from users where id=?\", USER_MAPPER, userId));\n+\t\t\tint id = Integer.parseInt(searchString);\n+\t\t\tidQueryString = \" users.id=\" + id + \" or \";\n \t\t} catch (NumberFormatException e) {\n-\t\t\t// IGNORE\n+\t\t\t// IGNORE wrong format of ID\n+\t\t}\n+\n+\t\t// Divide attributes received from CoreConfig into member, user and userExtSource attributes\n+\t\tList<String> allAttributes = BeansUtils.getCoreConfig().getAttributesToSearchUsersAndMembersBy();", "originalCommit": "72a3ab5cdef57f473fc25bdcd494975140b21da3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc0MjM4MQ==", "url": "https://github.com/CESNET/perun/pull/2831#discussion_r467742381", "bodyText": "Ok, I've created new methods in Utils, although I'm not sure if it is not too complicated, I couldn't think of anything nicer.", "author": "metodej", "createdAt": "2020-08-10T08:00:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM0OTU2OA=="}], "type": "inlineReview", "revised_code": {"commit": "79e21f981ef4a46965903c1a9f950f4bb9fb9254", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/impl/UsersManagerImpl.java b/perun-core/src/main/java/cz/metacentrum/perun/core/impl/UsersManagerImpl.java\nindex c473caa17..bef60dd5c 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/impl/UsersManagerImpl.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/impl/UsersManagerImpl.java\n\n@@ -815,22 +815,10 @@ public class UsersManagerImpl implements UsersManagerImplApi {\n \t\tString userNameQueryString;\n \t\tif (exactMatch) {\n \t\t\t// Part of query to search by user name (exact)\n-\t\t\tif (Compatibility.isPostgreSql()) {\n-\t\t\t\tuserNameQueryString= \" strpos(lower(\"+Compatibility.convertToAscii(\"COALESCE(users.first_name,'') || COALESCE(users.middle_name,'') || COALESCE(users.last_name,'')\") + \")=:nameString\";\n-\t\t\t} else if (Compatibility.isHSQLDB()) {\n-\t\t\t\tuserNameQueryString=\" lower(\"+Compatibility.convertToAscii(\"COALESCE(users.first_name,'') || COALESCE(users.middle_name,'') || COALESCE(users.last_name,'')\")+\")=:nameString\";\n-\t\t\t} else {\n-\t\t\t\tthrow new InternalErrorException(\"Unsupported db type\");\n-\t\t\t}\n+\t\t\tuserNameQueryString = Utils.prepareUserSearchQueryExactMatch();\n \t\t} else {\n \t\t\t// Part of query to search by user name (not exact)\n-\t\t\tif (Compatibility.isPostgreSql()) {\n-\t\t\t\tuserNameQueryString = \" strpos(lower(\" + Compatibility.convertToAscii(\"COALESCE(users.first_name,'') || COALESCE(users.middle_name,'') || COALESCE(users.last_name,'')\") + \"),:nameString) > 0 \";\n-\t\t\t} else if (Compatibility.isHSQLDB()) {\n-\t\t\t\tuserNameQueryString = \" lower(\" + Compatibility.convertToAscii(\"COALESCE(users.first_name,'') || COALESCE(users.middle_name,'') || COALESCE(users.last_name,'')\") + \") like '%' || :nameString || '%' \";\n-\t\t\t} else {\n-\t\t\t\tthrow new InternalErrorException(\"Unsupported db type\");\n-\t\t\t}\n+\t\t\tuserNameQueryString = Utils.prepareUserSearchQuerySimilarMatch();\n \t\t}\n \n \t\t// Part of query to search by user id\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM1MTY4NA==", "url": "https://github.com/CESNET/perun/pull/2831#discussion_r466351684", "bodyText": "Both conditional branches can be extracted to separate methods. One could be called something like \"prepareUserSearchQueryExactMatch\" and the second one \"prepareUserSearchQuerySimilarMatch\" or something like that. It will be more readable. Moreover, the second method can be used also in MembersManagerImpl so you eliminate duplicities.", "author": "balcirakpeter", "createdAt": "2020-08-06T11:39:34Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/UsersManagerImpl.java", "diffHunk": "@@ -794,90 +795,112 @@ public void removeAllUserExtSources(PerunSession sess, User user) {\n \n \t@Override\n \tpublic List<User> findUsers(PerunSession sess, String searchString) {\n-\t\tSet<User> users = new HashSet<>();\n-\n-\t\tlog.debug(\"Searching for users using searchString '{}'\", searchString);\n-\n-\t\t// Search by mail (member)\n-\t\tusers.addAll(jdbc.query(\"select \" + userMappingSelectQuery +\n-\t\t\t\t\t\" from users, members, member_attr_values, attr_names \" +\n-\t\t\t\t\t\"where members.user_id=users.id and members.id=member_attr_values.member_id and member_attr_values.attr_id=attr_names.id and \" +\n-\t\t\t\t\t\"attr_names.attr_name='urn:perun:member:attribute-def:def:mail' and \" +\n-\t\t\t\t\t\"lower(member_attr_values.attr_value)=lower(?)\", USER_MAPPER, searchString));\n-\n-\t\t// Search preferred email (user)\n-\t\tusers.addAll(jdbc.query(\"select \" + userMappingSelectQuery +\n-\t\t\t\t\t\" from users, user_attr_values, attr_names \" +\n-\t\t\t\t\t\"where users.id=user_attr_values.user_id and user_attr_values.attr_id=attr_names.id and \" +\n-\t\t\t\t\t\"attr_names.attr_name='urn:perun:user:attribute-def:def:preferredMail' and \" +\n-\t\t\t\t\t\"lower(user_attr_values.attr_value)=lower(?)\", USER_MAPPER, searchString));\n-\n-\t\t// Search logins in userExtSources\n-\t\tusers.addAll(jdbc.query(\"select \" + userMappingSelectQuery +\n-\t\t\t\t\t\" from users, user_ext_sources \" +\n-\t\t\t\t\t\"where lower(user_ext_sources.login_ext)=lower(?) and user_ext_sources.user_id=users.id\", USER_MAPPER, searchString));\n-\n-\t\t// Search logins in attributes: login-namespace:*\n-\t\tusers.addAll(jdbc.query(\"select distinct \" + userMappingSelectQuery +\n-\t\t\t\t\t\" from attr_names, user_attr_values, users \" +\n-\t\t\t\t\t\"where attr_names.friendly_name like 'login-namespace:%' and lower(user_attr_values.attr_value)=lower(?) \" +\n-\t\t\t\t\t\"and attr_names.id=user_attr_values.attr_id and user_attr_values.user_id=users.id\",\n-\t\t\t\t\tUSER_MAPPER, searchString));\n-\n-\t\t// Search by userId\n-\t\ttry {\n-\t\t\tint userId = Integer.parseInt(searchString);\n-\t\t\tusers.addAll(jdbc.query(\"select \" + userMappingSelectQuery + \" from users where id=?\", USER_MAPPER, userId));\n-\t\t} catch (NumberFormatException e) {\n-\t\t\t// IGNORE\n-\t\t}\n-\n-\t\tusers.addAll(findUsersByName(sess, searchString));\n-\n-\t\treturn new ArrayList<>(users);\n+\t\treturn findUsers(searchString, false);\n \t}\n \n \t@Override\n \tpublic List<User> findUsersByExactMatch(PerunSession sess, String searchString) {\n-\t\tSet<User> users = new HashSet<>();\n+\t\treturn findUsers(searchString, true);\n+\t}\n \n-\t\tlog.debug(\"Searching for users using searchString '{}'\", searchString);\n+\t/**\n+\t * Returns list of users who matches the searchString, searching name, id, member attributes, user attributes\n+\t * and userExtSource attributes (listed in CoreConfig).\n+\t *\n+\t * @param searchString string used to search by\n+\t * @param exactMatch if true, searches name only by exact match\n+\t * @return list of users\n+\t */\n+\tprivate List<User> findUsers(String searchString, boolean exactMatch) {\n+\t\tString userNameQueryString;\n+\t\tif (exactMatch) {", "originalCommit": "72a3ab5cdef57f473fc25bdcd494975140b21da3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc0MTg1Ng==", "url": "https://github.com/CESNET/perun/pull/2831#discussion_r467741856", "bodyText": "Ok, I've created new methods in Utils.", "author": "metodej", "createdAt": "2020-08-10T07:59:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM1MTY4NA=="}], "type": "inlineReview", "revised_code": {"commit": "79e21f981ef4a46965903c1a9f950f4bb9fb9254", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/impl/UsersManagerImpl.java b/perun-core/src/main/java/cz/metacentrum/perun/core/impl/UsersManagerImpl.java\nindex c473caa17..bef60dd5c 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/impl/UsersManagerImpl.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/impl/UsersManagerImpl.java\n\n@@ -815,22 +815,10 @@ public class UsersManagerImpl implements UsersManagerImplApi {\n \t\tString userNameQueryString;\n \t\tif (exactMatch) {\n \t\t\t// Part of query to search by user name (exact)\n-\t\t\tif (Compatibility.isPostgreSql()) {\n-\t\t\t\tuserNameQueryString= \" strpos(lower(\"+Compatibility.convertToAscii(\"COALESCE(users.first_name,'') || COALESCE(users.middle_name,'') || COALESCE(users.last_name,'')\") + \")=:nameString\";\n-\t\t\t} else if (Compatibility.isHSQLDB()) {\n-\t\t\t\tuserNameQueryString=\" lower(\"+Compatibility.convertToAscii(\"COALESCE(users.first_name,'') || COALESCE(users.middle_name,'') || COALESCE(users.last_name,'')\")+\")=:nameString\";\n-\t\t\t} else {\n-\t\t\t\tthrow new InternalErrorException(\"Unsupported db type\");\n-\t\t\t}\n+\t\t\tuserNameQueryString = Utils.prepareUserSearchQueryExactMatch();\n \t\t} else {\n \t\t\t// Part of query to search by user name (not exact)\n-\t\t\tif (Compatibility.isPostgreSql()) {\n-\t\t\t\tuserNameQueryString = \" strpos(lower(\" + Compatibility.convertToAscii(\"COALESCE(users.first_name,'') || COALESCE(users.middle_name,'') || COALESCE(users.last_name,'')\") + \"),:nameString) > 0 \";\n-\t\t\t} else if (Compatibility.isHSQLDB()) {\n-\t\t\t\tuserNameQueryString = \" lower(\" + Compatibility.convertToAscii(\"COALESCE(users.first_name,'') || COALESCE(users.middle_name,'') || COALESCE(users.last_name,'')\") + \") like '%' || :nameString || '%' \";\n-\t\t\t} else {\n-\t\t\t\tthrow new InternalErrorException(\"Unsupported db type\");\n-\t\t\t}\n+\t\t\tuserNameQueryString = Utils.prepareUserSearchQuerySimilarMatch();\n \t\t}\n \n \t\t// Part of query to search by user id\n"}}, {"oid": "79e21f981ef4a46965903c1a9f950f4bb9fb9254", "url": "https://github.com/CESNET/perun/commit/79e21f981ef4a46965903c1a9f950f4bb9fb9254", "message": "Fixes based on review\n\n- elimination of duplicate code by creating methods in Utils", "committedDate": "2020-08-10T07:57:24Z", "type": "commit"}]}