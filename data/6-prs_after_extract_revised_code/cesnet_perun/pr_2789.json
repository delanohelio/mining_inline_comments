{"pr_number": 2789, "pr_title": "Core - secondary regex for group name", "pr_createdAt": "2020-07-15T08:58:30Z", "pr_url": "https://github.com/CESNET/perun/pull/2789", "timeline": [{"oid": "60961d3010e9f9af6f8fc5477eeba0689bf00e64", "url": "https://github.com/CESNET/perun/commit/60961d3010e9f9af6f8fc5477eeba0689bf00e64", "message": "Core - secondary regex for group name\n\n* On some instances, we need to be able to restrict the group names\neven more. For this purpose, I have added an implementation of\nvalidation against a secondary regexes. If the secondary regex is not\nspecified, it is skipped during the validation.\n* Secondary regex for short name can be specified with the\n`perun.group.nameSecondaryRegex` core property.\n* Secondary regex for full name can be specified with the\n`perun.group.fullNameSecondaryRegex` core property.\n* One should define both, or none of this properties to ensure a correct\nbehaviour of the whole system.", "committedDate": "2020-07-15T08:59:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk3MzAyMQ==", "url": "https://github.com/CESNET/perun/pull/2789#discussion_r454973021", "bodyText": "Not sure why added if not used.", "author": "zlamalp", "createdAt": "2020-07-15T11:10:21Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/bl/GroupsManagerBl.java", "diffHunk": "@@ -45,6 +45,7 @@\n import cz.metacentrum.perun.core.api.exceptions.WrongAttributeAssignmentException;\n import cz.metacentrum.perun.core.api.exceptions.WrongAttributeValueException;\n import cz.metacentrum.perun.core.api.exceptions.WrongReferenceAttributeValueException;\n+import cz.metacentrum.perun.core.api.exceptions.InvalidGroupNameException;", "originalCommit": "60961d3010e9f9af6f8fc5477eeba0689bf00e64", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzE3MTM2Mg==", "url": "https://github.com/CESNET/perun/pull/2789#discussion_r457171362", "bodyText": "Import removed.", "author": "Vojtech-Sassmann", "createdAt": "2020-07-20T08:27:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk3MzAyMQ=="}], "type": "inlineReview", "revised_code": {"commit": "f295c967bb8e718a15bfee2f453ea1efb97ec0f8", "chunk": "diff --git a/perun-core/src/main/java/cz/metacentrum/perun/core/bl/GroupsManagerBl.java b/perun-core/src/main/java/cz/metacentrum/perun/core/bl/GroupsManagerBl.java\nindex c806ddfdb..01e0151dd 100644\n--- a/perun-core/src/main/java/cz/metacentrum/perun/core/bl/GroupsManagerBl.java\n+++ b/perun-core/src/main/java/cz/metacentrum/perun/core/bl/GroupsManagerBl.java\n\n@@ -45,7 +45,6 @@ import cz.metacentrum.perun.core.api.exceptions.UserNotExistsException;\n import cz.metacentrum.perun.core.api.exceptions.WrongAttributeAssignmentException;\n import cz.metacentrum.perun.core.api.exceptions.WrongAttributeValueException;\n import cz.metacentrum.perun.core.api.exceptions.WrongReferenceAttributeValueException;\n-import cz.metacentrum.perun.core.api.exceptions.InvalidGroupNameException;\n \n import java.util.List;\n import java.util.Map;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk3NTMzNA==", "url": "https://github.com/CESNET/perun/pull/2789#discussion_r454975334", "bodyText": "You should probably fail with InternalErrorException here, since module wants to add you as an admin of the members group, not just give you generic groupadmin role (with null group).", "author": "zlamalp", "createdAt": "2020-07-15T11:15:08Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/modules/EduGain.java", "diffHunk": "@@ -34,7 +35,12 @@ public Application approveApplication(PerunSession session, Application app) thr\n \n \t\t\tAuthzResolver.setRole(session, user, vo, Role.TOPGROUPCREATOR);\n \n-\t\t\tGroup membersGroup = session.getPerun().getGroupsManager().getGroupByName(session, vo, \"members\");\n+\t\t\tGroup membersGroup = null;\n+\t\t\ttry {\n+\t\t\t\tmembersGroup = session.getPerun().getGroupsManager().getGroupByName(session, vo, \"members\");\n+\t\t\t} catch (InvalidGroupNameException e) {\n+\t\t\t\t// shouldn't happen, \"members\" is a valid name", "originalCommit": "60961d3010e9f9af6f8fc5477eeba0689bf00e64", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzE3MTU1NA==", "url": "https://github.com/CESNET/perun/pull/2789#discussion_r457171554", "bodyText": "Fixed.", "author": "Vojtech-Sassmann", "createdAt": "2020-07-20T08:27:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk3NTMzNA=="}], "type": "inlineReview", "revised_code": {"commit": "f295c967bb8e718a15bfee2f453ea1efb97ec0f8", "chunk": "diff --git a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/modules/EduGain.java b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/modules/EduGain.java\nindex 928000466..56fa45674 100644\n--- a/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/modules/EduGain.java\n+++ b/perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/modules/EduGain.java\n\n@@ -40,6 +40,7 @@ public class EduGain extends DefaultRegistrarModule {\n \t\t\t\tmembersGroup = session.getPerun().getGroupsManager().getGroupByName(session, vo, \"members\");\n \t\t\t} catch (InvalidGroupNameException e) {\n \t\t\t\t// shouldn't happen, \"members\" is a valid name\n+\t\t\t\tthrow new InternalErrorException(e);\n \t\t\t}\n \t\t\tAuthzResolver.setRole(session, user, membersGroup, Role.GROUPADMIN);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk3ODA4OQ==", "url": "https://github.com/CESNET/perun/pull/2789#discussion_r454978089", "bodyText": "This check is a safe-guard repetition of check from entry layer. Maybe we should add the same check for updateGroup().", "author": "zlamalp", "createdAt": "2020-07-15T11:21:00Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/GroupsManagerImpl.java", "diffHunk": "@@ -122,9 +123,10 @@ public Group createGroup(PerunSession sess, Vo vo, Group group) throws GroupExis\n \t\t\t}\n \t\t}\n \n-\t\t// Check the group name, it can contain only a-Z0-9_- and space\n-\t\tif (!group.getShortName().matches(\"^[- a-zA-Z.0-9_]+$\")) {\n-\t\t\tthrow new InternalErrorException(new IllegalArgumentException(\"Wrong group name, group name can contain only a-Z0-9.-_: and space characters. \" + group));\n+\t\ttry {\n+\t\t\tUtils.validateGroupName(group.getShortName());", "originalCommit": "60961d3010e9f9af6f8fc5477eeba0689bf00e64", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzE3MTc3Ng==", "url": "https://github.com/CESNET/perun/pull/2789#discussion_r457171776", "bodyText": "I have added the check also to the update group method.", "author": "Vojtech-Sassmann", "createdAt": "2020-07-20T08:27:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk3ODA4OQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "f295c967bb8e718a15bfee2f453ea1efb97ec0f8", "url": "https://github.com/CESNET/perun/commit/f295c967bb8e718a15bfee2f453ea1efb97ec0f8", "message": "Core - secondary regex for group name\n\n* On some instances, we need to be able to restrict the group names\neven more. For this purpose, I have added an implementation of\nvalidation against a secondary regexes. If the secondary regex is not\nspecified, it is skipped during the validation.\n* Secondary regex for short name can be specified with the\n`perun.group.nameSecondaryRegex` core property.\n* Secondary regex for full name can be specified with the\n`perun.group.fullNameSecondaryRegex` core property.\n* One should define both, or none of this properties to ensure a correct\nbehaviour of the whole system.", "committedDate": "2020-07-20T08:25:54Z", "type": "commit"}, {"oid": "f295c967bb8e718a15bfee2f453ea1efb97ec0f8", "url": "https://github.com/CESNET/perun/commit/f295c967bb8e718a15bfee2f453ea1efb97ec0f8", "message": "Core - secondary regex for group name\n\n* On some instances, we need to be able to restrict the group names\neven more. For this purpose, I have added an implementation of\nvalidation against a secondary regexes. If the secondary regex is not\nspecified, it is skipped during the validation.\n* Secondary regex for short name can be specified with the\n`perun.group.nameSecondaryRegex` core property.\n* Secondary regex for full name can be specified with the\n`perun.group.fullNameSecondaryRegex` core property.\n* One should define both, or none of this properties to ensure a correct\nbehaviour of the whole system.", "committedDate": "2020-07-20T08:25:54Z", "type": "forcePushed"}]}