{"pr_number": 3322, "pr_title": "GH-3320: Refine lifecycle control in StdIntFlow", "pr_createdAt": "2020-07-02T17:28:10Z", "pr_url": "https://github.com/spring-projects/spring-integration/pull/3322", "timeline": [{"oid": "fc7cfa5dfa4603b42bbd90792097478b4352e877", "url": "https://github.com/spring-projects/spring-integration/commit/fc7cfa5dfa4603b42bbd90792097478b4352e877", "message": "GH-3320: Refine lifecycle control in StdIntFlow\n\nFixes https://github.com/spring-projects/spring-integration/issues/3320\n\nTurns out that lifecycle control for the whole bunch of components\nin one `IntegrationFlow` is useful in fields.\n\n* Change the logic in the `StandardIntegrationFlow` to let to call\n`start()` and `stop()` independently how the flow was registered in\nthe application context.\nThis way it can be autowired as a `Lifecycle` to let end-user to\navoid the search for proper component in the flow to stop or start\nmanually - all the components registered with the flow are going\nto be stopped or started respectively", "committedDate": "2020-07-02T17:27:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE3OTYxOQ==", "url": "https://github.com/spring-projects/spring-integration/pull/3322#discussion_r449179619", "bodyText": "I didn't notice this, but stopping right to left was wrong; corrected in the new code.", "author": "garyrussell", "createdAt": "2020-07-02T17:51:26Z", "path": "spring-integration-core/src/main/java/org/springframework/integration/dsl/StandardIntegrationFlow.java", "diffHunk": "@@ -127,30 +124,29 @@ public void start() {\n \n \t@Override\n \tpublic void stop(Runnable callback) {\n-\t\tif (this.lifecycles.size() > 0) {\n-\t\t\tAggregatingCallback aggregatingCallback = new AggregatingCallback(this.lifecycles.size(), callback);\n-\t\t\tListIterator<SmartLifecycle> iterator = this.lifecycles.listIterator(this.lifecycles.size());\n-\t\t\twhile (iterator.hasPrevious()) {", "originalCommit": "fc7cfa5dfa4603b42bbd90792097478b4352e877", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE4ODM3MQ==", "url": "https://github.com/spring-projects/spring-integration/pull/3322#discussion_r449188371", "bodyText": "No, Gary, it was right. Because we started before from right to left and filled out the local lifecycles property.\nThen we used this lifecycles in the stop() and therefore the first one in the flow was in the end of that list, so we again should iterate it backwards to stop in proper order.\nRight now indeed we don't have an intermediate list therefore the logic is changed around a normal integrationComponents state.", "author": "artembilan", "createdAt": "2020-07-02T18:08:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE3OTYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIyNTc1OA==", "url": "https://github.com/spring-projects/spring-integration/pull/3322#discussion_r449225758", "bodyText": "Ah... right.", "author": "garyrussell", "createdAt": "2020-07-02T19:29:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE3OTYxOQ=="}], "type": "inlineReview", "revised_code": {"commit": "1faa55f897e77c7690122068b43203d5dc364e15", "chunk": "diff --git a/spring-integration-core/src/main/java/org/springframework/integration/dsl/StandardIntegrationFlow.java b/spring-integration-core/src/main/java/org/springframework/integration/dsl/StandardIntegrationFlow.java\nindex d2f48d984a..c3af2f9e61 100644\n--- a/spring-integration-core/src/main/java/org/springframework/integration/dsl/StandardIntegrationFlow.java\n+++ b/spring-integration-core/src/main/java/org/springframework/integration/dsl/StandardIntegrationFlow.java\n\n@@ -125,7 +125,7 @@ public class StandardIntegrationFlow implements IntegrationFlow, SmartLifecycle\n \t@Override\n \tpublic void stop(Runnable callback) {\n \t\tAggregatingCallback aggregatingCallback = new AggregatingCallback(this.integrationComponents.size(), callback);\n-\t\tfor (Object component : integrationComponents.keySet()) {\n+\t\tfor (Object component : this.integrationComponents.keySet()) {\n \t\t\tif (component instanceof SmartLifecycle) {\n \t\t\t\tSmartLifecycle lifecycle = (SmartLifecycle) component;\n \t\t\t\tif (lifecycle.isRunning()) {\n"}}, {"oid": "1faa55f897e77c7690122068b43203d5dc364e15", "url": "https://github.com/spring-projects/spring-integration/commit/1faa55f897e77c7690122068b43203d5dc364e15", "message": "* Add `this.` to class property usage to satisfy Checkstyle", "committedDate": "2020-07-02T18:09:29Z", "type": "commit"}]}