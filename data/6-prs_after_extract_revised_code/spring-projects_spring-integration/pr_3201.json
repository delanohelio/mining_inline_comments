{"pr_number": 3201, "pr_title": "Add Reactive TX Manager support", "pr_createdAt": "2020-02-28T21:50:02Z", "pr_url": "https://github.com/spring-projects/spring-integration/pull/3201", "timeline": [{"oid": "acd996cdc5f2570d073de8be07e4c24fc0e1c4b3", "url": "https://github.com/spring-projects/spring-integration/commit/acd996cdc5f2570d073de8be07e4c24fc0e1c4b3", "message": "* Revert `MongoDbTests` change -\nto support transactions we need the latest MongoDb server with replica enabled\n* Document reactive transactions", "committedDate": "2020-03-03T15:59:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE0ODA3Mw==", "url": "https://github.com/spring-projects/spring-integration/pull/3201#discussion_r387148073", "bodyText": "Need final overrides of these to call from a CTOR - even though Spring is in violation of that rule in the super class.", "author": "garyrussell", "createdAt": "2020-03-03T16:40:02Z", "path": "spring-integration-core/src/main/java/org/springframework/integration/transaction/TransactionHandleMessageAdvice.java", "diffHunk": "@@ -46,12 +46,16 @@\n \tpublic TransactionHandleMessageAdvice() {\n \t}\n \n-\tpublic TransactionHandleMessageAdvice(PlatformTransactionManager ptm, Properties attributes) {\n-\t\tsuper(ptm, attributes);\n+\tpublic TransactionHandleMessageAdvice(TransactionManager transactionManager, Properties transactionAttributes) {\n+\t\tsetTransactionManager(transactionManager);\n+\t\tsetTransactionAttributes(transactionAttributes);\n \t}", "originalCommit": "acd996cdc5f2570d073de8be07e4c24fc0e1c4b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE1NDM0MA==", "url": "https://github.com/spring-projects/spring-integration/pull/3201#discussion_r387154340", "bodyText": "Well, I think we can live with this for a while.\nSee here: spring-projects/spring-framework#24612\nWhen that is fixed, we can revert this change to rely on super ctors.", "author": "artembilan", "createdAt": "2020-03-03T16:49:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE0ODA3Mw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE0OTYyMA==", "url": "https://github.com/spring-projects/spring-integration/pull/3201#discussion_r387149620", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\tReactiveMessageHandler reactiveMessageHandler =\n          \n          \n            \n            \t\t\t\t\t((ReactiveMessageHandlerAdapter) this.handler).getDelegate();\n          \n          \n            \n            \t\t\treactiveMessageHandler = adviceChain(reactiveMessageHandler);\n          \n          \n            \n            \t\t\tthis.handler = new ReactiveMessageHandlerAdapter(reactiveMessageHandler);\n          \n          \n            \n                    this.handler = new ReactiveMessageHandlerAdapter(adviceChain(((ReactiveMessageHandlerAdapter) this.handler).getDelegate())));", "author": "garyrussell", "createdAt": "2020-03-03T16:42:18Z", "path": "spring-integration-core/src/main/java/org/springframework/integration/config/ConsumerEndpointFactoryBean.java", "diffHunk": "@@ -200,10 +200,13 @@ public void afterPropertiesSet() {\n \t\t}\n \n \t\tif (!(this.handler instanceof ReactiveMessageHandlerAdapter)) {\n-\t\t\tadviceChain();\n+\t\t\tthis.handler = adviceChain(this.handler);\n \t\t}\n \t\telse if (!CollectionUtils.isEmpty(this.adviceChain)) {\n-\t\t\tLOGGER.warn(\"the advice chain cannot be applied to a 'ReactiveMessageHandler'\");\n+\t\t\tReactiveMessageHandler reactiveMessageHandler =\n+\t\t\t\t\t((ReactiveMessageHandlerAdapter) this.handler).getDelegate();\n+\t\t\treactiveMessageHandler = adviceChain(reactiveMessageHandler);\n+\t\t\tthis.handler = new ReactiveMessageHandlerAdapter(reactiveMessageHandler);", "originalCommit": "acd996cdc5f2570d073de8be07e4c24fc0e1c4b3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bdb29d823e1a569ad99482ce692e62c26e6e9658", "chunk": "diff --git a/spring-integration-core/src/main/java/org/springframework/integration/config/ConsumerEndpointFactoryBean.java b/spring-integration-core/src/main/java/org/springframework/integration/config/ConsumerEndpointFactoryBean.java\nindex 4b89e87f6f..acc1a70a81 100644\n--- a/spring-integration-core/src/main/java/org/springframework/integration/config/ConsumerEndpointFactoryBean.java\n+++ b/spring-integration-core/src/main/java/org/springframework/integration/config/ConsumerEndpointFactoryBean.java\n\n@@ -203,10 +203,9 @@ public class ConsumerEndpointFactoryBean\n \t\t\tthis.handler = adviceChain(this.handler);\n \t\t}\n \t\telse if (!CollectionUtils.isEmpty(this.adviceChain)) {\n-\t\t\tReactiveMessageHandler reactiveMessageHandler =\n-\t\t\t\t\t((ReactiveMessageHandlerAdapter) this.handler).getDelegate();\n-\t\t\treactiveMessageHandler = adviceChain(reactiveMessageHandler);\n-\t\t\tthis.handler = new ReactiveMessageHandlerAdapter(reactiveMessageHandler);\n+\t\t\tthis.handler =\n+\t\t\t\t\tnew ReactiveMessageHandlerAdapter(\n+\t\t\t\t\t\t\tadviceChain(((ReactiveMessageHandlerAdapter) this.handler).getDelegate()));\n \t\t}\n \t\tif (this.channelResolver == null) {\n \t\t\tthis.channelResolver = ChannelResolverUtils.getChannelResolver(this.beanFactory);\n"}}, {"oid": "85b3fa05b03469cbee9cddf3d5f940b9d7a89156", "url": "https://github.com/spring-projects/spring-integration/commit/85b3fa05b03469cbee9cddf3d5f940b9d7a89156", "message": "Add Reactive TX Manager support\n\n* Change `TransactionInterceptorBuilder` and `TransactionHandleMessageAdvice` to reply\non a generic `TransactionManager`, so we can configure reactive one as well\n* Change a `<transactional>` XML element to support a generic `TransactionManager` reference,\nso we can configure reactive one as well\n* Support `adviceChain` configuration for the `ReactiveMessageHandler` in the `ConsumerEndpointFactoryBean`\n* Attemp to apply reactive transaction for the Reactive MongoDB channel adapter", "committedDate": "2020-03-03T16:49:56Z", "type": "commit"}, {"oid": "a1627f8c69ebefc1d3a37ce9edbc9ef1bdd96380", "url": "https://github.com/spring-projects/spring-integration/commit/a1627f8c69ebefc1d3a37ce9edbc9ef1bdd96380", "message": "* Revert `MongoDbTests` change -\nto support transactions we need the latest MongoDb server with replica enabled\n* Document reactive transactions", "committedDate": "2020-03-03T16:49:56Z", "type": "commit"}, {"oid": "bdb29d823e1a569ad99482ce692e62c26e6e9658", "url": "https://github.com/spring-projects/spring-integration/commit/bdb29d823e1a569ad99482ce692e62c26e6e9658", "message": "* Address PR reviews", "committedDate": "2020-03-03T16:51:29Z", "type": "commit"}, {"oid": "bdb29d823e1a569ad99482ce692e62c26e6e9658", "url": "https://github.com/spring-projects/spring-integration/commit/bdb29d823e1a569ad99482ce692e62c26e6e9658", "message": "* Address PR reviews", "committedDate": "2020-03-03T16:51:29Z", "type": "forcePushed"}]}