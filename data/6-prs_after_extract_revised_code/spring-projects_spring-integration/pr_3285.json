{"pr_number": 3285, "pr_title": "GH-3282: Fix JdbcMetadataStore for DuplicateKeyEx", "pr_createdAt": "2020-05-19T22:03:36Z", "pr_url": "https://github.com/spring-projects/spring-integration/pull/3285", "timeline": [{"oid": "b360c02c63e92faf7bc029f660488d91a96987eb", "url": "https://github.com/spring-projects/spring-integration/commit/b360c02c63e92faf7bc029f660488d91a96987eb", "message": "GH-3282: Fix JdbcMetadataStore for DuplicateKeyEx\n\nFixes: https://github.com/spring-projects/spring-integration/issues/3282\n\nThe `INSERT INTO ... SELECT ... FROM ... HAVING` may fail with\n`DuplicateKeyException` in between transactions.\n* Catch `DuplicateKeyException` from in the `tryToPutIfAbsent()`\nand return `0` as a fact of not inserted to let other logic to work\nas expected.\n\nThere is no test coverage for this since it is almost impossible to\nreproduce such a race condition on DB\n\n**Cherry-pick to 5.3.x & 5.2.x**", "committedDate": "2020-05-19T22:02:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA3MjY3MQ==", "url": "https://github.com/spring-projects/spring-integration/pull/3285#discussion_r428072671", "bodyText": "? This comment seems wrong; we return 0 on the DKE and go to the else block.", "author": "garyrussell", "createdAt": "2020-05-20T14:46:54Z", "path": "spring-integration-jdbc/src/main/java/org/springframework/integration/jdbc/metadata/JdbcMetadataStore.java", "diffHunk": "@@ -142,7 +147,7 @@ public String putIfAbsent(String key, String value) {\n \t\t\t//try to insert if does not exists\n \t\t\tint affectedRows = tryToPutIfAbsent(key, value);\n \t\t\tif (affectedRows > 0) {\n-\t\t\t\t//it was not in the table, so we have just inserted it\n+\t\t\t\t//it was not in the table, so we have just inserted it or DuplicateKeyException has been thrown", "originalCommit": "b360c02c63e92faf7bc029f660488d91a96987eb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "592f7863f984d8add79060b42d1a1147c9b5ba0c", "chunk": "diff --git a/spring-integration-jdbc/src/main/java/org/springframework/integration/jdbc/metadata/JdbcMetadataStore.java b/spring-integration-jdbc/src/main/java/org/springframework/integration/jdbc/metadata/JdbcMetadataStore.java\nindex 67683fcfd2..18c0956fa0 100644\n--- a/spring-integration-jdbc/src/main/java/org/springframework/integration/jdbc/metadata/JdbcMetadataStore.java\n+++ b/spring-integration-jdbc/src/main/java/org/springframework/integration/jdbc/metadata/JdbcMetadataStore.java\n\n@@ -147,7 +147,7 @@ public class JdbcMetadataStore implements ConcurrentMetadataStore, InitializingB\n \t\t\t//try to insert if does not exists\n \t\t\tint affectedRows = tryToPutIfAbsent(key, value);\n \t\t\tif (affectedRows > 0) {\n-\t\t\t\t//it was not in the table, so we have just inserted it or DuplicateKeyException has been thrown\n+\t\t\t\t//it was not in the table, so we have just inserted\n \t\t\t\treturn null;\n \t\t\t}\n \t\t\telse {\n"}}, {"oid": "592f7863f984d8add79060b42d1a1147c9b5ba0c", "url": "https://github.com/spring-projects/spring-integration/commit/592f7863f984d8add79060b42d1a1147c9b5ba0c", "message": "* Remove misleading message in the comment sentence", "committedDate": "2020-05-20T15:43:51Z", "type": "commit"}]}