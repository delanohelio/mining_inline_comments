{"pr_number": 3342, "pr_title": "GH-3334: Add \"embedded reaper\" into CorrelationMH", "pr_createdAt": "2020-07-16T17:35:22Z", "pr_url": "https://github.com/spring-projects/spring-integration/pull/3342", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjA0MjgxNg==", "url": "https://github.com/spring-projects/spring-integration/pull/3342#discussion_r456042816", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * When the {@link #expireTimeout} is more than 0, the groups which older then this timeout\n          \n          \n            \n             * is purged from the store on start up (or when {@link #purgeOrphanedGroups()} is called).\n          \n          \n            \n             * If {@link #expireDuration} is provide, the task is scheduled to perform\n          \n          \n            \n             * {@link #purgeOrphanedGroups()} periodically.\n          \n          \n            \n             * When the {@link #expireTimeout} is greater than 0, groups which are older than this timeout\n          \n          \n            \n             * are purged from the store on start up (or when {@link #purgeOrphanedGroups()} is called).\n          \n          \n            \n             * If {@link #expireDuration} is provides, the task is scheduled to perform\n          \n          \n            \n             * {@link #purgeOrphanedGroups()} periodically.", "author": "garyrussell", "createdAt": "2020-07-16T19:58:49Z", "path": "spring-integration-core/src/main/java/org/springframework/integration/aggregator/AbstractCorrelatingMessageHandler.java", "diffHunk": "@@ -82,6 +84,11 @@\n  * Use proper {@link CorrelationStrategy} for cases when same\n  * {@link org.springframework.integration.store.MessageStore} is used\n  * for multiple handlers to ensure uniqueness of message groups across handlers.\n+ * <p>\n+ * When the {@link #expireTimeout} is more than 0, the groups which older then this timeout\n+ * is purged from the store on start up (or when {@link #purgeOrphanedGroups()} is called).\n+ * If {@link #expireDuration} is provide, the task is scheduled to perform\n+ * {@link #purgeOrphanedGroups()} periodically.", "originalCommit": "1bb5419b4eeeb1f68a19872a9b10a8aa9ee5cf92", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "65198f0bcc897df709e32eca2ab6c40d600f0a72", "chunk": "diff --git a/spring-integration-core/src/main/java/org/springframework/integration/aggregator/AbstractCorrelatingMessageHandler.java b/spring-integration-core/src/main/java/org/springframework/integration/aggregator/AbstractCorrelatingMessageHandler.java\nindex 7387f347e4..882d7ad2d4 100644\n--- a/spring-integration-core/src/main/java/org/springframework/integration/aggregator/AbstractCorrelatingMessageHandler.java\n+++ b/spring-integration-core/src/main/java/org/springframework/integration/aggregator/AbstractCorrelatingMessageHandler.java\n\n@@ -85,9 +85,9 @@ import org.springframework.util.ObjectUtils;\n  * {@link org.springframework.integration.store.MessageStore} is used\n  * for multiple handlers to ensure uniqueness of message groups across handlers.\n  * <p>\n- * When the {@link #expireTimeout} is more than 0, the groups which older then this timeout\n- * is purged from the store on start up (or when {@link #purgeOrphanedGroups()} is called).\n- * If {@link #expireDuration} is provide, the task is scheduled to perform\n+ * When the {@link #expireTimeout} is greater than 0, groups which are older than this timeout\n+ * are purged from the store on start up (or when {@link #purgeOrphanedGroups()} is called).\n+ * If {@link #expireDuration} is provided, the task is scheduled to perform\n  * {@link #purgeOrphanedGroups()} periodically.\n  *\n  * @author Iwein Fuld\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjA0NDQ4Mw==", "url": "https://github.com/spring-projects/spring-integration/pull/3342#discussion_r456044483", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t * Used on startup and if {@link #expireDuration} is provided the task for {@link #purgeOrphanedGroups()}\n          \n          \n            \n            \t * is scheduled with that period.\n          \n          \n            \n            \t * The {@link #forceReleaseProcessor} is used to process those expired groups according\n          \n          \n            \n            \t * the \"force complete\" options.\n          \n          \n            \n            \t * Used on startup and when an {@link #expireDuration} is provided, the task for running\n          \n          \n            \n            \t * {@link #purgeOrphanedGroups()} is scheduled with that period.\n          \n          \n            \n            \t * The {@link #forceReleaseProcessor} is used to process those expired groups according\n          \n          \n            \n            \t * the \"force complete\" options. A group can be orphaned if a persistent message group\n          \n          \n            \n            \t * store is used and no new messages arrive for that group after a restart.", "author": "garyrussell", "createdAt": "2020-07-16T20:02:04Z", "path": "spring-integration-core/src/main/java/org/springframework/integration/aggregator/AbstractCorrelatingMessageHandler.java", "diffHunk": "@@ -310,6 +322,32 @@ public void setReleaseLockBeforeSend(boolean releaseLockBeforeSend) {\n \t\tthis.releaseLockBeforeSend = releaseLockBeforeSend;\n \t}\n \n+\t/**\n+\t * Configure a timeout in milliseconds for purging old orphaned groups from the store.\n+\t * Used on startup and if {@link #expireDuration} is provided the task for {@link #purgeOrphanedGroups()}\n+\t * is scheduled with that period.\n+\t * The {@link #forceReleaseProcessor} is used to process those expired groups according\n+\t * the \"force complete\" options.", "originalCommit": "1bb5419b4eeeb1f68a19872a9b10a8aa9ee5cf92", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "65198f0bcc897df709e32eca2ab6c40d600f0a72", "chunk": "diff --git a/spring-integration-core/src/main/java/org/springframework/integration/aggregator/AbstractCorrelatingMessageHandler.java b/spring-integration-core/src/main/java/org/springframework/integration/aggregator/AbstractCorrelatingMessageHandler.java\nindex 7387f347e4..882d7ad2d4 100644\n--- a/spring-integration-core/src/main/java/org/springframework/integration/aggregator/AbstractCorrelatingMessageHandler.java\n+++ b/spring-integration-core/src/main/java/org/springframework/integration/aggregator/AbstractCorrelatingMessageHandler.java\n\n@@ -324,10 +324,11 @@ public abstract class AbstractCorrelatingMessageHandler extends AbstractMessageP\n \n \t/**\n \t * Configure a timeout in milliseconds for purging old orphaned groups from the store.\n-\t * Used on startup and if {@link #expireDuration} is provided the task for {@link #purgeOrphanedGroups()}\n-\t * is scheduled with that period.\n+\t * Used on startup and when an {@link #expireDuration} is provided, the task for running\n+\t * {@link #purgeOrphanedGroups()} is scheduled with that period.\n \t * The {@link #forceReleaseProcessor} is used to process those expired groups according\n-\t * the \"force complete\" options.\n+\t * the \"force complete\" options. A group can be orphaned if a persistent message group\n+\t * store is used and no new messages arrive for that group after a restart.\n \t * @param expireTimeout the number of milliseconds to determine old orphaned groups in the store to purge.\n \t * @since 5.4\n \t * @see #purgeOrphanedGroups()\n"}}, {"oid": "08dc0a3f56f61a40b8f86f2b85f45c84b0b2a404", "url": "https://github.com/spring-projects/spring-integration/commit/08dc0a3f56f61a40b8f86f2b85f45c84b0b2a404", "message": "GH-3334: Add \"embedded reaper\" into CorrelationMH\n\nFixes https://github.com/spring-projects/spring-integration/issues/3334\n\n* Add `expireTimeout` property into `AbstractCorrelatingMessageHandler`\nto call newly introduced `purgeOrphanedGroups()` API for removing old\ngroups from the store\n* Add `expireDuration` to perform `purgeOrphanedGroups()` task periodically", "committedDate": "2020-07-17T18:40:34Z", "type": "commit"}, {"oid": "65198f0bcc897df709e32eca2ab6c40d600f0a72", "url": "https://github.com/spring-projects/spring-integration/commit/65198f0bcc897df709e32eca2ab6c40d600f0a72", "message": "* Add Java DSL and XML support for `expireTimeout` and `expireDuration` options\n* Document the new feature", "committedDate": "2020-07-17T19:40:35Z", "type": "forcePushed"}, {"oid": "2a458a755c5196d74bc11807d900d54ae0f26122", "url": "https://github.com/spring-projects/spring-integration/commit/2a458a755c5196d74bc11807d900d54ae0f26122", "message": "* Add Java DSL and XML support for `expireTimeout` and `expireDuration` options\n* Document the new feature", "committedDate": "2020-07-17T20:41:39Z", "type": "commit"}, {"oid": "2a458a755c5196d74bc11807d900d54ae0f26122", "url": "https://github.com/spring-projects/spring-integration/commit/2a458a755c5196d74bc11807d900d54ae0f26122", "message": "* Add Java DSL and XML support for `expireTimeout` and `expireDuration` options\n* Document the new feature", "committedDate": "2020-07-17T20:41:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU5NDA3NA==", "url": "https://github.com/spring-projects/spring-integration/pull/3342#discussion_r457594074", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t * Configure a {@link Duration} (ini millis) how often to clean up old orphaned groups from the store.\n          \n          \n            \n            \t * Configure a {@link Duration} (in millis) how often to clean up old orphaned groups from the store.", "author": "garyrussell", "createdAt": "2020-07-20T18:01:36Z", "path": "spring-integration-core/src/main/java/org/springframework/integration/aggregator/AbstractCorrelatingMessageHandler.java", "diffHunk": "@@ -337,6 +338,18 @@ public void setExpireTimeout(long expireTimeout) {\n \t\tthis.expireTimeout = expireTimeout;\n \t}\n \n+\t/**\n+\t * Configure a {@link Duration} (ini millis) how often to clean up old orphaned groups from the store.", "originalCommit": "2a458a755c5196d74bc11807d900d54ae0f26122", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "37ec61b2bab543840006fc59e346afda1154e6bd", "chunk": "diff --git a/spring-integration-core/src/main/java/org/springframework/integration/aggregator/AbstractCorrelatingMessageHandler.java b/spring-integration-core/src/main/java/org/springframework/integration/aggregator/AbstractCorrelatingMessageHandler.java\nindex 882d7ad2d4..eea9ceaf76 100644\n--- a/spring-integration-core/src/main/java/org/springframework/integration/aggregator/AbstractCorrelatingMessageHandler.java\n+++ b/spring-integration-core/src/main/java/org/springframework/integration/aggregator/AbstractCorrelatingMessageHandler.java\n\n@@ -339,7 +339,7 @@ public abstract class AbstractCorrelatingMessageHandler extends AbstractMessageP\n \t}\n \n \t/**\n-\t * Configure a {@link Duration} (ini millis) how often to clean up old orphaned groups from the store.\n+\t * Configure a {@link Duration} (in millis) how often to clean up old orphaned groups from the store.\n \t * @param expireDuration the delay how often to call {@link #purgeOrphanedGroups()}.\n \t * @since 5.4\n \t * @see #purgeOrphanedGroups()\n"}}, {"oid": "37ec61b2bab543840006fc59e346afda1154e6bd", "url": "https://github.com/spring-projects/spring-integration/commit/37ec61b2bab543840006fc59e346afda1154e6bd", "message": "* Fix language in docs\n\nCo-authored-by: Gary Russell <grussell@vmware.com>", "committedDate": "2020-07-20T19:31:02Z", "type": "commit"}]}