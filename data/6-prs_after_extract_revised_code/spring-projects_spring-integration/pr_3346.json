{"pr_number": 3346, "pr_title": "GH-3344: Treat kotlin.Unit return as null in MMIH", "pr_createdAt": "2020-07-17T18:39:33Z", "pr_url": "https://github.com/spring-projects/spring-integration/pull/3346", "timeline": [{"oid": "e69f4d374e422ed83ec6449e1ac035995e30a7ce", "url": "https://github.com/spring-projects/spring-integration/commit/e69f4d374e422ed83ec6449e1ac035995e30a7ce", "message": "GH-3344: Treat kotlin.Unit return as null in MMIH\n\nFixes https://github.com/spring-projects/spring-integration/issues/3344\n\nWhen function lambda doesn't return anything (e.g. a `void` method call is the last one),\nKotlin produces a `kotlin.Unit` instance as a return value which is not null and produced\nas a reply message payload.\n\n* Fix `MessagingMethodInvokerHelper` to treat a `kotlin.Unit` as `null` for reply\nmaking Kotlin lambdas working the same way as Java lambdas when we don't return anything\nfrom from there\n\n**Cherry-pick to `5.3.x`**", "committedDate": "2020-07-17T18:39:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ2MzczNA==", "url": "https://github.com/spring-projects/spring-integration/pull/3346#discussion_r457463734", "bodyText": "Can we not capture this condition as a final boolean by checking the return type in a CTOR (to avoid running this code on every non-null return)?", "author": "garyrussell", "createdAt": "2020-07-20T14:55:44Z", "path": "spring-integration-core/src/main/java/org/springframework/integration/handler/support/MessagingMethodInvokerHelper.java", "diffHunk": "@@ -1093,13 +1094,18 @@ void setInvocableHandlerMethod(InvocableHandlerMethod newInvocableHandlerMethod)\n \t\t\tthis.invocableHandlerMethod = newInvocableHandlerMethod;\n \t\t}\n \n+\t\t@Nullable\n \t\tpublic Object invoke(ParametersWrapper parameters) {\n \t\t\tMessage<?> message = parameters.getMessage();\n \t\t\tif (this.canProcessMessageList) {\n \t\t\t\tmessage = new MutableMessage<>(parameters.getMessages(), parameters.getHeaders());\n \t\t\t}\n \t\t\ttry {\n-\t\t\t\treturn this.invocableHandlerMethod.invoke(message);\n+\t\t\t\tObject result = this.invocableHandlerMethod.invoke(message);\n+\t\t\t\tif (result != null && result.getClass().getName().equals(\"kotlin.Unit\")) {", "originalCommit": "e69f4d374e422ed83ec6449e1ac035995e30a7ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ4MzE3Nw==", "url": "https://github.com/spring-projects/spring-integration/pull/3346#discussion_r457483177", "bodyText": "Well, we can avoid something indeed, when a return type is void  or Unit. However in this case the return type is Object so end-user can return null ()or just don't have return in the function lambda and we don't produce a reply message.\nIn this case Kotlin for non-return in function lambda produces for us that Unit which is not a null apparently.\nSo, we produce some weird reply message.\nTherefore even if we have some final checks for return type, we still would have some logic to check the returned value to be sure that we don't produce a reply message with Unit payload.\nTo summarize: when have void return this result is always going to be null, therefore we don't go to check a class name for Unit. If the value not null, it already doesn't matter what void check we have in advance: we still have to check this result for Unit type.\nDoes it make sense?", "author": "artembilan", "createdAt": "2020-07-20T15:16:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ2MzczNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ4OTY4MQ==", "url": "https://github.com/spring-projects/spring-integration/pull/3346#discussion_r457489681", "bodyText": "Could we at least do something like...\nif (result != null && this.isKotlinLambda && result.getClass().getName().equals(\"kotlin.Unit\")) {\n?\nThis result.getClass().getName().equals(\"kotlin.Unit\") just seems like a lot of overhead for this one corner case and not good for the 99.9% of calls.", "author": "garyrussell", "createdAt": "2020-07-20T15:23:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ2MzczNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ5MjA4NA==", "url": "https://github.com/spring-projects/spring-integration/pull/3346#discussion_r457492084", "bodyText": "Ah! OK. Makes sense.\nI'll think what we can do...\nThanks for the pointer!", "author": "artembilan", "createdAt": "2020-07-20T15:25:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ2MzczNA=="}], "type": "inlineReview", "revised_code": {"commit": "14caf0fdf7056cc54c915f58bb1e03063186d344", "chunk": "diff --git a/spring-integration-core/src/main/java/org/springframework/integration/handler/support/MessagingMethodInvokerHelper.java b/spring-integration-core/src/main/java/org/springframework/integration/handler/support/MessagingMethodInvokerHelper.java\nindex 0864773910..94616b3b78 100644\n--- a/spring-integration-core/src/main/java/org/springframework/integration/handler/support/MessagingMethodInvokerHelper.java\n+++ b/spring-integration-core/src/main/java/org/springframework/integration/handler/support/MessagingMethodInvokerHelper.java\n\n@@ -1102,7 +1102,9 @@ public class MessagingMethodInvokerHelper extends AbstractExpressionEvaluator im\n \t\t\t}\n \t\t\ttry {\n \t\t\t\tObject result = this.invocableHandlerMethod.invoke(message);\n-\t\t\t\tif (result != null && result.getClass().getName().equals(\"kotlin.Unit\")) {\n+\t\t\t\tif (result != null\n+\t\t\t\t\t\t&& org.springframework.integration.util.ClassUtils.isKotlinUnit(result.getClass())) {\n+\n \t\t\t\t\tresult = null;\n \t\t\t\t}\n \t\t\t\treturn result;\n"}}, {"oid": "14caf0fdf7056cc54c915f58bb1e03063186d344", "url": "https://github.com/spring-projects/spring-integration/commit/14caf0fdf7056cc54c915f58bb1e03063186d344", "message": "* Introduce `ClassUtils.isKotlinUnit(Class)` API;\nuse it in the `MessagingMethodInvokerHelper` instead of\n`.getName().equals()`", "committedDate": "2020-07-20T16:53:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU4MTQ4Nw==", "url": "https://github.com/spring-projects/spring-integration/pull/3346#discussion_r457581487", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t * @since 5.4\n          \n          \n            \n            \t * @since 5.3.2", "author": "artembilan", "createdAt": "2020-07-20T17:39:55Z", "path": "spring-integration-core/src/main/java/org/springframework/integration/util/ClassUtils.java", "diffHunk": "@@ -247,4 +264,14 @@ public static boolean isKotlinFaction1(Class<?> aClass) {\n \t\treturn KOTLIN_FUNCTION_1_CLASS != null && KOTLIN_FUNCTION_1_CLASS.isAssignableFrom(aClass);\n \t}\n \n+\t/**\n+\t * Check if class is {@code kotlin.Unit}.\n+\t * @param aClass the {@link Class} to check.\n+\t * @return true if class is a {@code kotlin.Unit} implementation.\n+\t * @since 5.4", "originalCommit": "14caf0fdf7056cc54c915f58bb1e03063186d344", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "db6786c462b7425f7b866461511f418ad7c23347", "chunk": "diff --git a/spring-integration-core/src/main/java/org/springframework/integration/util/ClassUtils.java b/spring-integration-core/src/main/java/org/springframework/integration/util/ClassUtils.java\nindex 4403a1f865..85dda3b067 100644\n--- a/spring-integration-core/src/main/java/org/springframework/integration/util/ClassUtils.java\n+++ b/spring-integration-core/src/main/java/org/springframework/integration/util/ClassUtils.java\n\n@@ -268,7 +268,7 @@ public abstract class ClassUtils {\n \t * Check if class is {@code kotlin.Unit}.\n \t * @param aClass the {@link Class} to check.\n \t * @return true if class is a {@code kotlin.Unit} implementation.\n-\t * @since 5.4\n+\t * @since 5.3.2\n \t */\n \tpublic static boolean isKotlinUnit(Class<?> aClass) {\n \t\treturn KOTLIN_UNIT_CLASS != null && KOTLIN_UNIT_CLASS.isAssignableFrom(aClass);\n"}}, {"oid": "db6786c462b7425f7b866461511f418ad7c23347", "url": "https://github.com/spring-projects/spring-integration/commit/db6786c462b7425f7b866461511f418ad7c23347", "message": "* Fix since on new `isKotlinUnit()` API", "committedDate": "2020-07-20T17:40:22Z", "type": "commit"}]}