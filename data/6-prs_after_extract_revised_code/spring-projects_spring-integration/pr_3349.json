{"pr_number": 3349, "pr_title": "Add gauges for queue channel size", "pr_createdAt": "2020-07-28T15:41:46Z", "pr_url": "https://github.com/spring-projects/spring-integration/pull/3349", "timeline": [{"oid": "558dea45ab3aedfa18acab495b5d755ad74a773c", "url": "https://github.com/spring-projects/spring-integration/commit/558dea45ab3aedfa18acab495b5d755ad74a773c", "message": "Add gauges for queue channel size\n\nThe `QueueChannel` provides a current size and remaining capacity metrics\n\n* Add Micrometer gauges into `QueueChannel` to expose the current values\nof the size and remaining capacity\n\n**Cherry-pick to 5.3.x, 5.2.x & 5.1.x**", "committedDate": "2020-07-28T15:41:21Z", "type": "commit"}, {"oid": "e14ef35f101d8189dc6af37e0fefb8bf371dc579", "url": "https://github.com/spring-projects/spring-integration/commit/e14ef35f101d8189dc6af37e0fefb8bf371dc579", "message": "* Revert `@SuppressWarnings(\"unchecked\")` for test\n* Document new gauges for queue channel", "committedDate": "2020-07-28T16:21:56Z", "type": "commit"}, {"oid": "101387132c2056b3a1b3af7fa32cd000330de165", "url": "https://github.com/spring-projects/spring-integration/commit/101387132c2056b3a1b3af7fa32cd000330de165", "message": "* Fix IntegrationManagementConfigurer for NPE on `metricsCaptor`", "committedDate": "2020-07-28T19:42:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg1NDAzNA==", "url": "https://github.com/spring-projects/spring-integration/pull/3349#discussion_r461854034", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\t\t\t.description(\"The remaining.capacity of queue channel\")\n          \n          \n            \n            \t\t\t\t\t\t.description(\"The remaining capacity of the queue channel\")", "author": "micheljung", "createdAt": "2020-07-28T20:19:58Z", "path": "spring-integration-core/src/main/java/org/springframework/integration/channel/QueueChannel.java", "diffHunk": "@@ -79,6 +87,26 @@ public QueueChannel() {\n \t\tthis(new LinkedBlockingQueue<>());\n \t}\n \n+\t@Override\n+\tpublic void registerMetricsCaptor(MetricsCaptor metricsCaptor) {\n+\t\tsuper.registerMetricsCaptor(metricsCaptor);\n+\t\tthis.sizeGauge =\n+\t\t\t\tmetricsCaptor.gaugeBuilder(\"spring.integration.channel.queue.size\", this,\n+\t\t\t\t\t\t(channel) -> getQueueSize())\n+\t\t\t\t\t\t.tag(\"name\", getComponentName() == null ? \"unknown\" : getComponentName())\n+\t\t\t\t\t\t.tag(\"type\", \"channel\")\n+\t\t\t\t\t\t.description(\"The size of queue channel\")\n+\t\t\t\t\t\t.build();\n+\n+\t\tthis.remainingCapacityGauge =\n+\t\t\t\tmetricsCaptor.gaugeBuilder(\"spring.integration.channel.queue.remaining.capacity\", this,\n+\t\t\t\t\t\t(channel) -> getRemainingCapacity())\n+\t\t\t\t\t\t.tag(\"name\", getComponentName() == null ? \"unknown\" : getComponentName())\n+\t\t\t\t\t\t.tag(\"type\", \"channel\")\n+\t\t\t\t\t\t.description(\"The remaining.capacity of queue channel\")", "originalCommit": "101387132c2056b3a1b3af7fa32cd000330de165", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "79038289ab4bc2e0baaff68b8c98def825129a30", "chunk": "diff --git a/spring-integration-core/src/main/java/org/springframework/integration/channel/QueueChannel.java b/spring-integration-core/src/main/java/org/springframework/integration/channel/QueueChannel.java\nindex 0bd6a2708a..09f5e89661 100644\n--- a/spring-integration-core/src/main/java/org/springframework/integration/channel/QueueChannel.java\n+++ b/spring-integration-core/src/main/java/org/springframework/integration/channel/QueueChannel.java\n\n@@ -95,7 +95,7 @@ public class QueueChannel extends AbstractPollableChannel implements QueueChanne\n \t\t\t\t\t\t(channel) -> getQueueSize())\n \t\t\t\t\t\t.tag(\"name\", getComponentName() == null ? \"unknown\" : getComponentName())\n \t\t\t\t\t\t.tag(\"type\", \"channel\")\n-\t\t\t\t\t\t.description(\"The size of queue channel\")\n+\t\t\t\t\t\t.description(\"The size of the queue channel\")\n \t\t\t\t\t\t.build();\n \n \t\tthis.remainingCapacityGauge =\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg1NTMzMw==", "url": "https://github.com/spring-projects/spring-integration/pull/3349#discussion_r461855333", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\t\t\t.description(\"The size of queue channel\")\n          \n          \n            \n            \t\t\t\t\t\t.description(\"The size of the queue channel\")", "author": "artembilan", "createdAt": "2020-07-28T20:22:31Z", "path": "spring-integration-core/src/main/java/org/springframework/integration/channel/QueueChannel.java", "diffHunk": "@@ -79,6 +87,26 @@ public QueueChannel() {\n \t\tthis(new LinkedBlockingQueue<>());\n \t}\n \n+\t@Override\n+\tpublic void registerMetricsCaptor(MetricsCaptor metricsCaptor) {\n+\t\tsuper.registerMetricsCaptor(metricsCaptor);\n+\t\tthis.sizeGauge =\n+\t\t\t\tmetricsCaptor.gaugeBuilder(\"spring.integration.channel.queue.size\", this,\n+\t\t\t\t\t\t(channel) -> getQueueSize())\n+\t\t\t\t\t\t.tag(\"name\", getComponentName() == null ? \"unknown\" : getComponentName())\n+\t\t\t\t\t\t.tag(\"type\", \"channel\")\n+\t\t\t\t\t\t.description(\"The size of queue channel\")", "originalCommit": "101387132c2056b3a1b3af7fa32cd000330de165", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "79038289ab4bc2e0baaff68b8c98def825129a30", "chunk": "diff --git a/spring-integration-core/src/main/java/org/springframework/integration/channel/QueueChannel.java b/spring-integration-core/src/main/java/org/springframework/integration/channel/QueueChannel.java\nindex 0bd6a2708a..09f5e89661 100644\n--- a/spring-integration-core/src/main/java/org/springframework/integration/channel/QueueChannel.java\n+++ b/spring-integration-core/src/main/java/org/springframework/integration/channel/QueueChannel.java\n\n@@ -95,7 +95,7 @@ public class QueueChannel extends AbstractPollableChannel implements QueueChanne\n \t\t\t\t\t\t(channel) -> getQueueSize())\n \t\t\t\t\t\t.tag(\"name\", getComponentName() == null ? \"unknown\" : getComponentName())\n \t\t\t\t\t\t.tag(\"type\", \"channel\")\n-\t\t\t\t\t\t.description(\"The size of queue channel\")\n+\t\t\t\t\t\t.description(\"The size of the queue channel\")\n \t\t\t\t\t\t.build();\n \n \t\tthis.remainingCapacityGauge =\n"}}, {"oid": "79038289ab4bc2e0baaff68b8c98def825129a30", "url": "https://github.com/spring-projects/spring-integration/commit/79038289ab4bc2e0baaff68b8c98def825129a30", "message": "Fix wording in meter descriptions\n\nCo-authored-by: Michel Jung <michel.jung89@gmail.com>", "committedDate": "2020-07-28T20:23:05Z", "type": "commit"}]}