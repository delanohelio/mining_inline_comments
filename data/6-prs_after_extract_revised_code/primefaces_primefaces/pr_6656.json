{"pr_number": 6656, "pr_title": "Fix #6575 - Datatable : Clean up selection", "pr_createdAt": "2020-12-13T20:06:44Z", "pr_url": "https://github.com/primefaces/primefaces/pull/6656", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQwNjYzMA==", "url": "https://github.com/primefaces/primefaces/pull/6656#discussion_r542406630", "bodyText": "@tandraschko @melloware I remember you guys faced an issue with this code recently, but I can't recall what it was... Can you remind me what was the issue number?", "author": "Rapster", "createdAt": "2020-12-14T14:02:31Z", "path": "src/main/java/org/primefaces/component/datatable/DataTable.java", "diffHunk": "@@ -294,18 +297,6 @@ public void processValidators(FacesContext context) {\n         }\n     }\n \n-    @Override\n-    public void processUpdates(FacesContext context) {\n-        super.processUpdates(context);\n-\n-        ValueExpression selectionVE = getValueExpression(PropertyKeys.selection.toString());\n-\n-        if (selectionVE != null) {\n-            selectionVE.setValue(context.getELContext(), getLocalSelection());\n-            setSelection(null);\n-        }\n-    }\n-", "originalCommit": "39e3407ff6ca30dfe3b5b21cc08e1814236a8603", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQwOTM5Nw==", "url": "https://github.com/primefaces/primefaces/pull/6656#discussion_r542409397", "bodyText": "can only remember that the selection attr was broken in ui:repeat.", "author": "tandraschko", "createdAt": "2020-12-14T14:06:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQwNjYzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk0ODE1OQ==", "url": "https://github.com/primefaces/primefaces/pull/6656#discussion_r542948159", "bodyText": "Got it #3812", "author": "Rapster", "createdAt": "2020-12-15T00:17:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQwNjYzMA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "1dda17dc688f85055ddbbbf9432ffa4aec9d88d4", "url": "https://github.com/primefaces/primefaces/commit/1dda17dc688f85055ddbbbf9432ffa4aec9d88d4", "message": "Fix #6575 - DataTable: selection gets lost after update only (but not processed)", "committedDate": "2020-12-19T00:36:25Z", "type": "forcePushed"}, {"oid": "43f58e9d2cc03d53165370b3cbb5c5b132480546", "url": "https://github.com/primefaces/primefaces/commit/43f58e9d2cc03d53165370b3cbb5c5b132480546", "message": "Fix #6575 - DataTable: selection gets lost after update only (but not processed)", "committedDate": "2020-12-21T23:30:23Z", "type": "forcePushed"}, {"oid": "77f06bc1769855b1bf31ee920c42c656dc4084c2", "url": "https://github.com/primefaces/primefaces/commit/77f06bc1769855b1bf31ee920c42c656dc4084c2", "message": "fix merge", "committedDate": "2020-12-27T19:33:45Z", "type": "forcePushed"}, {"oid": "e13815ae5abb2c9eb334664ead7431abd4337d61", "url": "https://github.com/primefaces/primefaces/commit/e13815ae5abb2c9eb334664ead7431abd4337d61", "message": "Fix #6575 - DataTable: selection gets lost after update only (but not processed)", "committedDate": "2020-12-29T15:44:41Z", "type": "commit"}, {"oid": "3ea632228564a62c461fc857ee60a97b133b9a87", "url": "https://github.com/primefaces/primefaces/commit/3ea632228564a62c461fc857ee60a97b133b9a87", "message": "Fix #6575 - DataTable: selection gets lost after update only (but not processed)", "committedDate": "2020-12-29T15:44:42Z", "type": "commit"}, {"oid": "9d5637f9c225bc0bb3350a649b980f2de8abc5f6", "url": "https://github.com/primefaces/primefaces/commit/9d5637f9c225bc0bb3350a649b980f2de8abc5f6", "message": "Fix #6575 - DataTable: selection gets lost after update only (but not processed)", "committedDate": "2020-12-29T15:44:43Z", "type": "commit"}, {"oid": "46ef5d86cc64610a9c4ea2119e38305f23bec255", "url": "https://github.com/primefaces/primefaces/commit/46ef5d86cc64610a9c4ea2119e38305f23bec255", "message": "Fix #6575 - DataTable: selection gets lost after update only", "committedDate": "2020-12-29T15:44:44Z", "type": "commit"}, {"oid": "4cea0514a68a714edf74533ac6a37e2f862ab278", "url": "https://github.com/primefaces/primefaces/commit/4cea0514a68a714edf74533ac6a37e2f862ab278", "message": "fix merge", "committedDate": "2020-12-29T15:44:45Z", "type": "commit"}, {"oid": "85ea0cf49e922debd7453dc76f14b65110a5f7ea", "url": "https://github.com/primefaces/primefaces/commit/85ea0cf49e922debd7453dc76f14b65110a5f7ea", "message": "Fix #6575 - DataTable: selection gets lost after update only (but not processed)", "committedDate": "2020-12-29T15:44:45Z", "type": "commit"}, {"oid": "dfe32377c02c93d7a3f7f39d161a4d1abf9de004", "url": "https://github.com/primefaces/primefaces/commit/dfe32377c02c93d7a3f7f39d161a4d1abf9de004", "message": "Fix #6575 - DataTable: selection gets lost after update only (but not processed)", "committedDate": "2020-12-29T15:44:46Z", "type": "commit"}, {"oid": "b1f617d39f066563ecf216919c5fd27fd4578b3b", "url": "https://github.com/primefaces/primefaces/commit/b1f617d39f066563ecf216919c5fd27fd4578b3b", "message": "Fix #6575 - DataTable: selection gets lost after update only (but not processed)", "committedDate": "2020-12-29T16:43:02Z", "type": "commit"}, {"oid": "b1f617d39f066563ecf216919c5fd27fd4578b3b", "url": "https://github.com/primefaces/primefaces/commit/b1f617d39f066563ecf216919c5fd27fd4578b3b", "message": "Fix #6575 - DataTable: selection gets lost after update only (but not processed)", "committedDate": "2020-12-29T16:43:02Z", "type": "forcePushed"}, {"oid": "75ec52474a25dae7a5289d8dcc73afbeea2fb662", "url": "https://github.com/primefaces/primefaces/commit/75ec52474a25dae7a5289d8dcc73afbeea2fb662", "message": "Fix #6575 - DataTable: selection gets lost after update only (but not processed)", "committedDate": "2020-12-29T17:05:40Z", "type": "commit"}, {"oid": "ec822e0bd0e59c66464060150c381b6900054a68", "url": "https://github.com/primefaces/primefaces/commit/ec822e0bd0e59c66464060150c381b6900054a68", "message": "Fix #6575 - DataTable: selection gets lost after update only (but not processed)", "committedDate": "2020-12-31T00:24:11Z", "type": "commit"}, {"oid": "c5112d147bd89191ae942d43ef0fcc4cf4938147", "url": "https://github.com/primefaces/primefaces/commit/c5112d147bd89191ae942d43ef0fcc4cf4938147", "message": "Fix #6575 - DataTable: selection gets lost after update only (but not processed)", "committedDate": "2020-12-31T00:28:35Z", "type": "commit"}, {"oid": "a1d8864fe2addad5542dddf2771a90bf5c900246", "url": "https://github.com/primefaces/primefaces/commit/a1d8864fe2addad5542dddf2771a90bf5c900246", "message": "Merge branch 'master' into fix-6575v2", "committedDate": "2021-01-04T16:12:00Z", "type": "commit"}, {"oid": "2c02cf417da62f8550258b940b7510f57f67e1f2", "url": "https://github.com/primefaces/primefaces/commit/2c02cf417da62f8550258b940b7510f57f67e1f2", "message": "Fix #6575 - DataTable: selection gets lost after update only (but not processed)", "committedDate": "2021-01-04T18:05:18Z", "type": "commit"}, {"oid": "16ad626fd5669f903c1eff7dd0303f2d6fa5d78f", "url": "https://github.com/primefaces/primefaces/commit/16ad626fd5669f903c1eff7dd0303f2d6fa5d78f", "message": "Fix #6575 - DataTable: selection gets lost after update only (but not processed)", "committedDate": "2021-01-04T18:05:19Z", "type": "commit"}, {"oid": "aadf493a0c963a9d6a39b36d858f7c71c2f9f952", "url": "https://github.com/primefaces/primefaces/commit/aadf493a0c963a9d6a39b36d858f7c71c2f9f952", "message": "Fix #6575 - DataTable: selection gets lost after update only (but not processed)", "committedDate": "2021-01-04T18:05:21Z", "type": "commit"}, {"oid": "fc7012d8326688aa1a1dbf9e53c2afaa4799945c", "url": "https://github.com/primefaces/primefaces/commit/fc7012d8326688aa1a1dbf9e53c2afaa4799945c", "message": "Fix #6575 - DataTable: selection gets lost after update only", "committedDate": "2021-01-04T18:05:22Z", "type": "commit"}, {"oid": "218cd5ccafa3e8b14369136080dd651eeab35f0a", "url": "https://github.com/primefaces/primefaces/commit/218cd5ccafa3e8b14369136080dd651eeab35f0a", "message": "fix merge", "committedDate": "2021-01-04T18:05:22Z", "type": "commit"}, {"oid": "830b65fec611f819246f3c995d54adebe6d8d269", "url": "https://github.com/primefaces/primefaces/commit/830b65fec611f819246f3c995d54adebe6d8d269", "message": "Fix #6575 - DataTable: selection gets lost after update only (but not processed)", "committedDate": "2021-01-04T18:05:23Z", "type": "commit"}, {"oid": "fefa49ef1e0c911af5849de2f9c1af536eb3691a", "url": "https://github.com/primefaces/primefaces/commit/fefa49ef1e0c911af5849de2f9c1af536eb3691a", "message": "Fix #6575 - DataTable: selection gets lost after update only (but not processed)", "committedDate": "2021-01-04T18:05:24Z", "type": "commit"}, {"oid": "79c83e482f70e70415fe3da001eeeee9fad11904", "url": "https://github.com/primefaces/primefaces/commit/79c83e482f70e70415fe3da001eeeee9fad11904", "message": "Fix #6575 - DataTable: selection gets lost after update only (but not processed)", "committedDate": "2021-01-04T18:05:25Z", "type": "commit"}, {"oid": "0b56a03096e4454aa365c6efae885e40e7c1d1be", "url": "https://github.com/primefaces/primefaces/commit/0b56a03096e4454aa365c6efae885e40e7c1d1be", "message": "Fix #6575 - DataTable: selection gets lost after update only (but not processed)", "committedDate": "2021-01-04T18:05:26Z", "type": "commit"}, {"oid": "a6ec4fe2517e64c501c329c3f7e5d90ed44f0b3e", "url": "https://github.com/primefaces/primefaces/commit/a6ec4fe2517e64c501c329c3f7e5d90ed44f0b3e", "message": "Fix #6575 - DataTable: selection gets lost after update only (but not processed)", "committedDate": "2021-01-04T18:05:27Z", "type": "commit"}, {"oid": "4f7f6e4f273e1a1a95ec6e605a8e808571545a40", "url": "https://github.com/primefaces/primefaces/commit/4f7f6e4f273e1a1a95ec6e605a8e808571545a40", "message": "Fix #6575 - DataTable: selection gets lost after update only (but not processed)", "committedDate": "2021-01-04T18:05:28Z", "type": "commit"}, {"oid": "c23c48c7ce16068f23ef2c336dc722c4c501ab9d", "url": "https://github.com/primefaces/primefaces/commit/c23c48c7ce16068f23ef2c336dc722c4c501ab9d", "message": "Fix #6575 - DataTable: selection gets lost after update only (but not processed)", "committedDate": "2021-01-04T18:33:21Z", "type": "commit"}, {"oid": "79855ea277b79a68ca99688a988cc5bdb3e0033c", "url": "https://github.com/primefaces/primefaces/commit/79855ea277b79a68ca99688a988cc5bdb3e0033c", "message": "Merge branch 'fix-6575v2' of https://github.com/Rapster/primefaces into fix-6575v2", "committedDate": "2021-01-04T18:34:14Z", "type": "commit"}, {"oid": "187ff040dd63f95638575e9c5f6dd4dd4547d44b", "url": "https://github.com/primefaces/primefaces/commit/187ff040dd63f95638575e9c5f6dd4dd4547d44b", "message": "Fix #6575 - DataTable: selection gets lost after update only (but not processed)", "committedDate": "2021-01-04T18:36:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTc4NDAxNg==", "url": "https://github.com/primefaces/primefaces/pull/6656#discussion_r551784016", "bodyText": "Why did you change all this features?\nIn the past we always decodde SelectionFeature, just if selection is enabled and indepdent if the current request is a selection request.\nSo in each request the SelectionFeature was called and decoded if the _selection param is available", "author": "tandraschko", "createdAt": "2021-01-05T08:32:01Z", "path": "src/main/java/org/primefaces/component/datatable/feature/ScrollFeature.java", "diffHunk": "@@ -82,7 +78,7 @@ public void encode(FacesContext context, DataTableRenderer renderer, DataTable t\n \n     @Override\n     public boolean shouldDecode(FacesContext context, DataTable table) {\n-        return false;\n+        return table.isScrollingRequest(context) && table.isSelectionEnabled();", "originalCommit": "187ff040dd63f95638575e9c5f6dd4dd4547d44b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTgyNTUzNQ==", "url": "https://github.com/primefaces/primefaces/pull/6656#discussion_r551825535", "bodyText": "Why did you change all this features?\n\nI don't think I change anything, I just adapt according to my changes and move decode stuff in decode method instead of encode method. Arf now that I see it, loading data is also done in encode method... I'll have to change that\n\nIn the past we always decodde SelectionFeature, just if selection is enabled and indepdent if the current request is a selection request.\n\nMaybe, but as of today you have a few features just like this one that requires decoding selection (ex-findSelectedRowKeys). Right now, I just adapt according to my changes, tomorrow everything should probably be done in SelectionFeature", "author": "Rapster", "createdAt": "2021-01-05T09:52:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTc4NDAxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTgzMDgwMA==", "url": "https://github.com/primefaces/primefaces/pull/6656#discussion_r551830800", "bodyText": "Hmmm thats weird actually.\nSelectionFeature#decode runs before all encode, so why does ScrollFeature#encode needs a findSelectedRowKeys call?\nMaybe we can remove this calls with your refactoring.", "author": "tandraschko", "createdAt": "2021-01-05T10:01:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTc4NDAxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjk1NjAwMA==", "url": "https://github.com/primefaces/primefaces/pull/6656#discussion_r552956000", "bodyText": "I think those calls are to cover default selection, where items has been added right away to the DataTable#selection value. For example, you add a new row, and this row should be selected by default, that's what findSelectedRowKeys used to do (and I'm still doing) it's setting new rowKeys through DataTable#selection value. But I feel it would be a lot more simple if a new attribute selectedRow was added to DataTable, to allow default selection. Item would be then added to DataTable#selection once component processed, doing so it would prevent reading DataTable#selection at all and figure out what are the rowKeys", "author": "Rapster", "createdAt": "2021-01-06T20:53:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTc4NDAxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE3NDQ4MA==", "url": "https://github.com/primefaces/primefaces/pull/6656#discussion_r553174480", "bodyText": "That something for V11. I think its better to add this code to DataTableRenderer#preRender or similar isntead of in multiple XXXFeature which are not related to selection.", "author": "tandraschko", "createdAt": "2021-01-07T08:25:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTc4NDAxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDE0NTU0OA==", "url": "https://github.com/primefaces/primefaces/pull/6656#discussion_r554145548", "bodyText": "Not that simple, I'd rather come up with a clean solution in V11 than fiddling something now.", "author": "Rapster", "createdAt": "2021-01-08T19:25:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTc4NDAxNg=="}], "type": "inlineReview", "revised_code": {"commit": "028a320471a59d198610edceacf8d59ed4b4a059", "chunk": "diff --git a/src/main/java/org/primefaces/component/datatable/feature/ScrollFeature.java b/src/main/java/org/primefaces/component/datatable/feature/ScrollFeature.java\nindex 15cc05456..6b7f6ac0d 100644\n--- a/src/main/java/org/primefaces/component/datatable/feature/ScrollFeature.java\n+++ b/src/main/java/org/primefaces/component/datatable/feature/ScrollFeature.java\n\n@@ -78,7 +83,7 @@ public class ScrollFeature implements DataTableFeature {\n \n     @Override\n     public boolean shouldDecode(FacesContext context, DataTable table) {\n-        return table.isScrollingRequest(context) && table.isSelectionEnabled();\n+        return false;\n     }\n \n     @Override\n"}}, {"oid": "028a320471a59d198610edceacf8d59ed4b4a059", "url": "https://github.com/primefaces/primefaces/commit/028a320471a59d198610edceacf8d59ed4b4a059", "message": "Fix #6575 - DataTable: clean up selection", "committedDate": "2021-01-09T00:27:58Z", "type": "commit"}, {"oid": "c593691355dc6416e30774457c611555ba6349ee", "url": "https://github.com/primefaces/primefaces/commit/c593691355dc6416e30774457c611555ba6349ee", "message": "DataTable: clean up selection", "committedDate": "2021-01-09T10:23:17Z", "type": "commit"}, {"oid": "00316a24a466301f033fb60ca27be0255dd2e7c5", "url": "https://github.com/primefaces/primefaces/commit/00316a24a466301f033fb60ca27be0255dd2e7c5", "message": "DataTable: clean up selection", "committedDate": "2021-01-09T10:32:02Z", "type": "commit"}, {"oid": "aef6fa79703481b6c9002617c55c553decd5bb4a", "url": "https://github.com/primefaces/primefaces/commit/aef6fa79703481b6c9002617c55c553decd5bb4a", "message": "DataTable: clean up selection", "committedDate": "2021-01-10T21:11:20Z", "type": "commit"}, {"oid": "a4d49e8cd91df2cad656fb8ee628ef88439df244", "url": "https://github.com/primefaces/primefaces/commit/a4d49e8cd91df2cad656fb8ee628ef88439df244", "message": "DataTable: clean up selection", "committedDate": "2021-01-10T21:14:15Z", "type": "commit"}, {"oid": "ce0889225784a6c1ac386114dcb5da5976751ab9", "url": "https://github.com/primefaces/primefaces/commit/ce0889225784a6c1ac386114dcb5da5976751ab9", "message": "DataTable: clean up selection", "committedDate": "2021-01-11T22:17:33Z", "type": "commit"}, {"oid": "85b7e80168123fa195ffa46a2bd7bb0afcfe56bf", "url": "https://github.com/primefaces/primefaces/commit/85b7e80168123fa195ffa46a2bd7bb0afcfe56bf", "message": "DataTable: clean up selection", "committedDate": "2021-01-11T22:19:45Z", "type": "commit"}]}