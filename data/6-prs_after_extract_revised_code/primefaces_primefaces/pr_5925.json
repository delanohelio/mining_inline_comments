{"pr_number": 5925, "pr_title": "Fix #5923: Prevent native date converter errors", "pr_createdAt": "2020-05-20T11:53:40Z", "pr_url": "https://github.com/primefaces/primefaces/pull/5925", "timeline": [{"oid": "c9bc0399b23cf70004ea14c899737f2969c6f236", "url": "https://github.com/primefaces/primefaces/commit/c9bc0399b23cf70004ea14c899737f2969c6f236", "message": "Fix #5923: Prevent native date converter errors", "committedDate": "2020-05-20T11:52:24Z", "type": "commit"}, {"oid": "5158e6e3730493d6ac42f7b09e68ec91b889de49", "url": "https://github.com/primefaces/primefaces/commit/5158e6e3730493d6ac42f7b09e68ec91b889de49", "message": "Fix #5923: Prevent native date converter errors", "committedDate": "2020-05-20T12:06:10Z", "type": "commit"}, {"oid": "24b7ca4b04f362df61d70d0d3dd4a2be11cccede", "url": "https://github.com/primefaces/primefaces/commit/24b7ca4b04f362df61d70d0d3dd4a2be11cccede", "message": "Fix #5923: Prevent native date converter errors", "committedDate": "2020-05-20T16:32:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE5MjQwMQ==", "url": "https://github.com/primefaces/primefaces/pull/5925#discussion_r428192401", "bodyText": "LocalTime?", "author": "christophs78", "createdAt": "2020-05-20T17:40:20Z", "path": "src/main/java/org/primefaces/util/CalendarUtils.java", "diffHunk": "@@ -532,4 +533,26 @@ public static Temporal now(UICalendar uicalendar) {\n         ZoneId zone = calculateZoneId(uicalendar.getTimeZone());\n         return hasTime ? LocalDateTime.now(zone) : LocalDate.now(zone);\n     }\n+\n+    /**\n+     * Calculates NOW based on the calendar's current timezone or will default to system timezone if none set.\n+     *\n+     * @param uicalendar the base calendar to calculate NOW for\n+     * @return an Object representing either a Date or Temporal\n+     */\n+    public static Object now(UICalendar uicalendar, Class<?> dateType) {\n+        Temporal now = now(uicalendar);\n+        if (dateType.isAssignableFrom(java.util.Date.class)) {\n+            ZoneId zone = calculateZoneId(uicalendar.getTimeZone());\n+            java.util.Date date;\n+            if (now instanceof LocalDate) {\n+                date = java.util.Date.from(((LocalDate) now).atStartOfDay(zone).toInstant());\n+            }\n+            else {\n+                date = java.util.Date.from(((LocalDateTime) now).atZone(zone).toInstant());\n+            }", "originalCommit": "24b7ca4b04f362df61d70d0d3dd4a2be11cccede", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e4ef6d112004d1d56144e0697403d532c57ea227", "chunk": "diff --git a/src/main/java/org/primefaces/util/CalendarUtils.java b/src/main/java/org/primefaces/util/CalendarUtils.java\nindex 2fe9e435c..cf6e0c1e8 100644\n--- a/src/main/java/org/primefaces/util/CalendarUtils.java\n+++ b/src/main/java/org/primefaces/util/CalendarUtils.java\n\n@@ -530,7 +530,11 @@ public class CalendarUtils {\n      */\n     public static Temporal now(UICalendar uicalendar) {\n         boolean hasTime = uicalendar.hasTime();\n+        boolean timeOnly = uicalendar.isTimeOnly();\n         ZoneId zone = calculateZoneId(uicalendar.getTimeZone());\n+        if (hasTime && timeOnly) {\n+            return LocalTime.now(zone);\n+        }\n         return hasTime ? LocalDateTime.now(zone) : LocalDate.now(zone);\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE5MzEzNQ==", "url": "https://github.com/primefaces/primefaces/pull/5925#discussion_r428193135", "bodyText": "we should remove the  \"if it fails ....\"", "author": "christophs78", "createdAt": "2020-05-20T17:41:32Z", "path": "src/main/java/org/primefaces/util/CalendarUtils.java", "diffHunk": "@@ -235,7 +236,7 @@ public static final String getValueAsString(FacesContext context, UICalendar cal\n     }\n \n     public static final String getValue(FacesContext context, UICalendar calendar, Object value, String pattern) {\n-        //first ask the converter\n+      //first ask the converter, if it fails fall back to built-in conversion", "originalCommit": "24b7ca4b04f362df61d70d0d3dd4a2be11cccede", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e4ef6d112004d1d56144e0697403d532c57ea227", "chunk": "diff --git a/src/main/java/org/primefaces/util/CalendarUtils.java b/src/main/java/org/primefaces/util/CalendarUtils.java\nindex 2fe9e435c..cf6e0c1e8 100644\n--- a/src/main/java/org/primefaces/util/CalendarUtils.java\n+++ b/src/main/java/org/primefaces/util/CalendarUtils.java\n\n@@ -236,7 +236,7 @@ public class CalendarUtils {\n     }\n \n     public static final String getValue(FacesContext context, UICalendar calendar, Object value, String pattern) {\n-      //first ask the converter, if it fails fall back to built-in conversion\n+        //first ask the converter\n         if (calendar.getConverter() != null) {\n             return calendar.getConverter().getAsString(context, calendar, value);\n         }\n"}}, {"oid": "e4ef6d112004d1d56144e0697403d532c57ea227", "url": "https://github.com/primefaces/primefaces/commit/e4ef6d112004d1d56144e0697403d532c57ea227", "message": "Fix #5923: Prevent native date converter errors", "committedDate": "2020-05-20T17:55:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIxMDc3MQ==", "url": "https://github.com/primefaces/primefaces/pull/5925#discussion_r428210771", "bodyText": "One last thing. :-)\nhasTime = date and time\ntimeOnly = time\n(I know this is a bit confusing.)\n--> if (timeOnly) {", "author": "christophs78", "createdAt": "2020-05-20T18:11:13Z", "path": "src/main/java/org/primefaces/util/CalendarUtils.java", "diffHunk": "@@ -530,7 +530,11 @@ public static LocalDateTime toLocalDateTime(ZoneId zoneId, String isoDateString)\n      */\n     public static Temporal now(UICalendar uicalendar) {\n         boolean hasTime = uicalendar.hasTime();\n+        boolean timeOnly = uicalendar.isTimeOnly();\n         ZoneId zone = calculateZoneId(uicalendar.getTimeZone());\n+        if (hasTime && timeOnly) {", "originalCommit": "e4ef6d112004d1d56144e0697403d532c57ea227", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4b952ab05d915b3408764d729c8cfb81704ac408", "chunk": "diff --git a/src/main/java/org/primefaces/util/CalendarUtils.java b/src/main/java/org/primefaces/util/CalendarUtils.java\nindex cf6e0c1e8..233bcc613 100644\n--- a/src/main/java/org/primefaces/util/CalendarUtils.java\n+++ b/src/main/java/org/primefaces/util/CalendarUtils.java\n\n@@ -529,12 +529,12 @@ public class CalendarUtils {\n      * @return a Temporal representing either a Date or DateTime\n      */\n     public static Temporal now(UICalendar uicalendar) {\n-        boolean hasTime = uicalendar.hasTime();\n         boolean timeOnly = uicalendar.isTimeOnly();\n         ZoneId zone = calculateZoneId(uicalendar.getTimeZone());\n-        if (hasTime && timeOnly) {\n+        if (timeOnly) {\n             return LocalTime.now(zone);\n         }\n+        boolean hasTime = uicalendar.hasTime();\n         return hasTime ? LocalDateTime.now(zone) : LocalDate.now(zone);\n     }\n \n"}}, {"oid": "4b952ab05d915b3408764d729c8cfb81704ac408", "url": "https://github.com/primefaces/primefaces/commit/4b952ab05d915b3408764d729c8cfb81704ac408", "message": "Fix #5923: Prevent native date converter errors", "committedDate": "2020-05-20T19:03:39Z", "type": "commit"}, {"oid": "f486b169548f791897e3e15006313f4f6216e4e9", "url": "https://github.com/primefaces/primefaces/commit/f486b169548f791897e3e15006313f4f6216e4e9", "message": "Fix #5923: Prevent native date converter errors", "committedDate": "2020-05-21T14:11:34Z", "type": "commit"}, {"oid": "25b19c67712b17766f3f6a61a7e116fe0c542db5", "url": "https://github.com/primefaces/primefaces/commit/25b19c67712b17766f3f6a61a7e116fe0c542db5", "message": "Fix #5923: Prevent native date converter errors", "committedDate": "2020-05-21T20:20:45Z", "type": "commit"}, {"oid": "5df8f14b1043e3a8edc51195ac84efb3175202a6", "url": "https://github.com/primefaces/primefaces/commit/5df8f14b1043e3a8edc51195ac84efb3175202a6", "message": "Fix #5923: Prevent native date converter errors", "committedDate": "2020-05-21T20:21:55Z", "type": "commit"}]}