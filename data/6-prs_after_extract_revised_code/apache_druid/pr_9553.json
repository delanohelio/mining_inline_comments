{"pr_number": 9553, "pr_title": "fix Hadoop ingestion fails due to error 'JavaScript is disabled' on certain config", "pr_createdAt": "2020-03-21T08:49:27Z", "pr_url": "https://github.com/apache/druid/pull/9553", "timeline": [{"oid": "ad58b07b985d21f26f6f0b5cdbb0005d909d33a6", "url": "https://github.com/apache/druid/commit/ad58b07b985d21f26f6f0b5cdbb0005d909d33a6", "message": "fix Hadoop ingestion fails due to error 'JavaScript is disabled', if determine partition hadoop job is run", "committedDate": "2020-03-21T08:39:53Z", "type": "commit"}, {"oid": "7d00d3ca478b71ddf7beca0b0becdc2b021b4c88", "url": "https://github.com/apache/druid/commit/7d00d3ca478b71ddf7beca0b0becdc2b021b4c88", "message": "add test", "committedDate": "2020-03-21T08:40:00Z", "type": "commit"}, {"oid": "aa2eba25c5c5bb8c03e8bff1d4db77fcd6c4a4e2", "url": "https://github.com/apache/druid/commit/aa2eba25c5c5bb8c03e8bff1d4db77fcd6c4a4e2", "message": "fix checkstyle", "committedDate": "2020-03-21T08:48:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY3NzI5MA==", "url": "https://github.com/apache/druid/pull/9553#discussion_r396677290", "bodyText": "injectDruidProperties has an almost same block with this. How about adding a new method HadoopDruidIndexerConfig.getAllowedProperties() which returns a map of a property name to a property? And this new method can be used both in injectDruidProperties() and this method.", "author": "jihoonson", "createdAt": "2020-03-23T18:43:40Z", "path": "indexing-hadoop/src/main/java/org/apache/druid/indexer/JobHelper.java", "diffHunk": "@@ -343,11 +338,18 @@ public static void injectDruidProperties(Configuration configuration, List<Strin\n     }\n   }\n \n-  public static Configuration injectSystemProperties(Configuration conf)\n+  public static Configuration injectSystemProperties(Configuration conf, List<String> listOfAllowedPrefix)\n   {\n     for (String propName : HadoopDruidIndexerConfig.PROPERTIES.stringPropertyNames()) {\n       if (propName.startsWith(\"hadoop.\")) {\n         conf.set(propName.substring(\"hadoop.\".length()), HadoopDruidIndexerConfig.PROPERTIES.getProperty(propName));\n+      } else {\n+        for (String prefix : listOfAllowedPrefix) {\n+          if (propName.equals(prefix) || propName.startsWith(prefix + \".\")) {\n+            conf.set(propName, HadoopDruidIndexerConfig.PROPERTIES.getProperty(propName));\n+            break;\n+          }\n+        }", "originalCommit": "aa2eba25c5c5bb8c03e8bff1d4db77fcd6c4a4e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcwMDM4MQ==", "url": "https://github.com/apache/druid/pull/9553#discussion_r396700381", "bodyText": "Done", "author": "maytasm", "createdAt": "2020-03-23T19:24:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY3NzI5MA=="}], "type": "inlineReview", "revised_code": {"commit": "e5a4faff040ccb2136c3614ee908771f7994d82c", "chunk": "diff --git a/indexing-hadoop/src/main/java/org/apache/druid/indexer/JobHelper.java b/indexing-hadoop/src/main/java/org/apache/druid/indexer/JobHelper.java\nindex 3f84bc9f46..1d173ca9eb 100644\n--- a/indexing-hadoop/src/main/java/org/apache/druid/indexer/JobHelper.java\n+++ b/indexing-hadoop/src/main/java/org/apache/druid/indexer/JobHelper.java\n\n@@ -343,15 +338,13 @@ public class JobHelper\n     for (String propName : HadoopDruidIndexerConfig.PROPERTIES.stringPropertyNames()) {\n       if (propName.startsWith(\"hadoop.\")) {\n         conf.set(propName.substring(\"hadoop.\".length()), HadoopDruidIndexerConfig.PROPERTIES.getProperty(propName));\n-      } else {\n-        for (String prefix : listOfAllowedPrefix) {\n-          if (propName.equals(prefix) || propName.startsWith(prefix + \".\")) {\n-            conf.set(propName, HadoopDruidIndexerConfig.PROPERTIES.getProperty(propName));\n-            break;\n-          }\n-        }\n       }\n     }\n+\n+    for (Map.Entry<String, String> allowedProperties : HadoopDruidIndexerConfig.getAllowedProperties(listOfAllowedPrefix).entrySet()) {\n+      conf.set(allowedProperties.getKey(), allowedProperties.getValue());\n+    }\n+\n     return conf;\n   }\n \n"}}, {"oid": "e5a4faff040ccb2136c3614ee908771f7994d82c", "url": "https://github.com/apache/druid/commit/e5a4faff040ccb2136c3614ee908771f7994d82c", "message": "address comments", "committedDate": "2020-03-23T19:25:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcxMTIxNA==", "url": "https://github.com/apache/druid/pull/9553#discussion_r396711214", "bodyText": "listOfAllowedPrefix seems to always be the allowedHadoopPrefix of this class. Can it be a non-static method?", "author": "jihoonson", "createdAt": "2020-03-23T19:42:19Z", "path": "indexing-hadoop/src/main/java/org/apache/druid/indexer/HadoopDruidIndexerConfig.java", "diffHunk": "@@ -138,6 +138,20 @@\n     ROWS_THROWN_AWAY_COUNTER\n   }\n \n+  public static Map<String, String> getAllowedProperties(List<String> listOfAllowedPrefix)", "originalCommit": "e5a4faff040ccb2136c3614ee908771f7994d82c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjczMDE5NA==", "url": "https://github.com/apache/druid/pull/9553#discussion_r396730194", "bodyText": "JobHelper.injectSystemProperties and JobHelper.injectDruidProperties methods are static. If we change those to non-static then yes, getAllowedProperties can be non-static since listOfAllowedPrefix are always allowedHadoopPrefix. But maybe leaving it like this is more flexible as the caller might pass something other than allowedHadoopPrefix for listOfAllowedPrefix", "author": "maytasm", "createdAt": "2020-03-23T20:16:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcxMTIxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjczMTA0Mw==", "url": "https://github.com/apache/druid/pull/9553#discussion_r396731043", "bodyText": "Leaving as is unless you have strong opinion on changing all those to non-static and having JobHelper instances. @jihoonson", "author": "maytasm", "createdAt": "2020-03-23T20:17:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcxMTIxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjczMjQ5Mg==", "url": "https://github.com/apache/druid/pull/9553#discussion_r396732492", "bodyText": "I guess you can make this method non-static while keeping those methods as static if they accept HadoopDruidIndexerConfig instead of listOfAllowedPrefix?", "author": "jihoonson", "createdAt": "2020-03-23T20:20:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcxMTIxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njc0MjU5MA==", "url": "https://github.com/apache/druid/pull/9553#discussion_r396742590", "bodyText": "I like that. Done", "author": "maytasm", "createdAt": "2020-03-23T20:39:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcxMTIxNA=="}], "type": "inlineReview", "revised_code": {"commit": "6f38001a37851a00a802d4a633514be70bebe7b8", "chunk": "diff --git a/indexing-hadoop/src/main/java/org/apache/druid/indexer/HadoopDruidIndexerConfig.java b/indexing-hadoop/src/main/java/org/apache/druid/indexer/HadoopDruidIndexerConfig.java\nindex 1cfb2df874..0b69b33098 100644\n--- a/indexing-hadoop/src/main/java/org/apache/druid/indexer/HadoopDruidIndexerConfig.java\n+++ b/indexing-hadoop/src/main/java/org/apache/druid/indexer/HadoopDruidIndexerConfig.java\n\n@@ -138,20 +138,6 @@ public class HadoopDruidIndexerConfig\n     ROWS_THROWN_AWAY_COUNTER\n   }\n \n-  public static Map<String, String> getAllowedProperties(List<String> listOfAllowedPrefix)\n-  {\n-    Map<String, String> allowedPropertiesMap = new HashMap<>();\n-    for (String propName : PROPERTIES.stringPropertyNames()) {\n-      for (String prefix : listOfAllowedPrefix) {\n-        if (propName.equals(prefix) || propName.startsWith(prefix + \".\")) {\n-          allowedPropertiesMap.put(propName, PROPERTIES.getProperty(propName));\n-          break;\n-        }\n-      }\n-    }\n-    return allowedPropertiesMap;\n-  }\n-\n   public static HadoopDruidIndexerConfig fromSpec(HadoopIngestionSpec spec)\n   {\n     return new HadoopDruidIndexerConfig(spec);\n"}}, {"oid": "6f38001a37851a00a802d4a633514be70bebe7b8", "url": "https://github.com/apache/druid/commit/6f38001a37851a00a802d4a633514be70bebe7b8", "message": "address comments", "committedDate": "2020-03-23T20:40:19Z", "type": "commit"}]}