{"pr_number": 10120, "pr_title": "Fix Stack overflow with infinite loop in ReduceExpressionsRule of HepProgram", "pr_createdAt": "2020-07-01T19:05:08Z", "pr_url": "https://github.com/apache/druid/pull/10120", "timeline": [{"oid": "f2475d637e9a8e86fc000fe70c2196fe66c3804e", "url": "https://github.com/apache/druid/commit/f2475d637e9a8e86fc000fe70c2196fe66c3804e", "message": "Fix Stack overflow with SELECT ARRAY ['Hello', NULL]", "committedDate": "2020-07-01T19:00:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU3MDY0Nw==", "url": "https://github.com/apache/druid/pull/10120#discussion_r448570647", "bodyText": "Is it possible to make this a system property? Having to restart the broker sounds like a lot less pain than having to make a new patch if this estimated HEP_DEFAULT_MATCH_LIMIT is incorrect for some edge case that we don't have tests for.", "author": "suneet-s", "createdAt": "2020-07-01T19:25:17Z", "path": "sql/src/main/java/org/apache/druid/sql/calcite/planner/Rules.java", "diffHunk": "@@ -85,6 +88,13 @@\n   public static final int DRUID_CONVENTION_RULES = 0;\n   public static final int BINDABLE_CONVENTION_RULES = 1;\n \n+  // Due to Calcite bug (CALCITE-3845), ReduceExpressionsRule can considered expression which is the same as the\n+  // previous input expression as reduced. Basically, the expression is actually not reduced but is still considered as\n+  // reduced. Hence, this resulted in an infinite loop of Calcite trying to reducing the same expression over and over.\n+  // Calcite 1.23.0 fixes this issue by not consider expression as reduced if this case happens. However, while\n+  // we are still using Calcite 1.21.0, a workaround is to limit the number of pattern matches to avoid infinite loop.\n+  private static final int HEP_DEFAULT_MATCH_LIMIT = 1200;", "originalCommit": "f2475d637e9a8e86fc000fe70c2196fe66c3804e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU4NzQ0Mg==", "url": "https://github.com/apache/druid/pull/10120#discussion_r448587442", "bodyText": "Added a override system property druid.sql.planner.hepMatchLimit that can override the default value of 1200\nThis system property is not documented though as it should not be modify by user without deep investigation into Calcite/HepProgram use by Druid. Assuming you are doing investigation on determining new value for matchLimit in Druid code, then you will see this system property anyway.", "author": "maytasm", "createdAt": "2020-07-01T20:02:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU3MDY0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "e34ab211183edf934f553aa2c04e0a2227c89de5", "chunk": "diff --git a/sql/src/main/java/org/apache/druid/sql/calcite/planner/Rules.java b/sql/src/main/java/org/apache/druid/sql/calcite/planner/Rules.java\nindex 7125cb4b25..c9135d5275 100644\n--- a/sql/src/main/java/org/apache/druid/sql/calcite/planner/Rules.java\n+++ b/sql/src/main/java/org/apache/druid/sql/calcite/planner/Rules.java\n\n@@ -93,7 +93,10 @@ public class Rules\n   // reduced. Hence, this resulted in an infinite loop of Calcite trying to reducing the same expression over and over.\n   // Calcite 1.23.0 fixes this issue by not consider expression as reduced if this case happens. However, while\n   // we are still using Calcite 1.21.0, a workaround is to limit the number of pattern matches to avoid infinite loop.\n-  private static final int HEP_DEFAULT_MATCH_LIMIT = 1200;\n+  private static final String HEP_DEFAULT_MATCH_LIMIT_CONFIG_STRING = \"druid.sql.planner.hepMatchLimit\";\n+  private static final int HEP_DEFAULT_MATCH_LIMIT = Integer.valueOf(\n+      System.getProperty(HEP_DEFAULT_MATCH_LIMIT_CONFIG_STRING, \"1200\")\n+  );\n \n   // Rules from RelOptUtil's registerBaseRules, minus:\n   //\n"}}, {"oid": "e34ab211183edf934f553aa2c04e0a2227c89de5", "url": "https://github.com/apache/druid/commit/e34ab211183edf934f553aa2c04e0a2227c89de5", "message": "address comments", "committedDate": "2020-07-01T19:58:29Z", "type": "commit"}]}