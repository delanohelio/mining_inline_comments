{"pr_number": 9644, "pr_title": "Add missing integration tests for the compaction by the coordinator", "pr_createdAt": "2020-04-08T02:39:19Z", "pr_url": "https://github.com/apache/druid/pull/9644", "timeline": [{"oid": "b5714a89dab7f4f6599015461c01140d213558da", "url": "https://github.com/apache/druid/commit/b5714a89dab7f4f6599015461c01140d213558da", "message": "Add API to trigger a compaction by the coordinator for integration tests", "committedDate": "2020-04-08T02:37:29Z", "type": "commit"}, {"oid": "83fb3b2ec64eb93d38f3e312dad0928fdbb45857", "url": "https://github.com/apache/druid/commit/83fb3b2ec64eb93d38f3e312dad0928fdbb45857", "message": "Add API to trigger a compaction by the coordinator for integration tests", "committedDate": "2020-04-09T03:17:53Z", "type": "commit"}, {"oid": "279dae41416a1d6f8bd2ae43e3e3bb6993cf7c03", "url": "https://github.com/apache/druid/commit/279dae41416a1d6f8bd2ae43e3e3bb6993cf7c03", "message": "Add API to trigger a compaction by the coordinator for integration tests", "committedDate": "2020-04-09T03:25:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM1ODk4NA==", "url": "https://github.com/apache/druid/pull/9644#discussion_r406358984", "bodyText": "Should these APIs be documented?", "author": "ccaominh", "createdAt": "2020-04-09T17:23:22Z", "path": "server/src/main/java/org/apache/druid/server/http/CompactionResource.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.server.http;\n+\n+import com.google.common.collect.ImmutableMap;\n+import com.google.inject.Inject;\n+import com.sun.jersey.spi.container.ResourceFilters;\n+import org.apache.druid.server.coordinator.DruidCoordinator;\n+import org.apache.druid.server.http.security.ConfigResourceFilter;\n+import org.apache.druid.server.http.security.StateResourceFilter;\n+\n+import javax.ws.rs.GET;\n+import javax.ws.rs.POST;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.QueryParam;\n+import javax.ws.rs.core.MediaType;\n+import javax.ws.rs.core.Response;\n+\n+@Path(\"/druid/coordinator/v1/compaction\")", "originalCommit": "279dae41416a1d6f8bd2ae43e3e3bb6993cf7c03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjYwMzI2Mg==", "url": "https://github.com/apache/druid/pull/9644#discussion_r406603262", "bodyText": "The new /druid/coordinator/v1/compaction/compact will not be a public API and will not be documented. It is exclusively only use for integration test. The /druid/coordinator/v1/compaction/progress is an old endpoint. Seems like it does not originally have any documentation. I can add it.", "author": "maytasm", "createdAt": "2020-04-10T05:03:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM1ODk4NA=="}], "type": "inlineReview", "revised_code": {"commit": "4c3976f074690dd6ff4055c709f5d2f4d8812898", "chunk": "diff --git a/server/src/main/java/org/apache/druid/server/http/CompactionResource.java b/server/src/main/java/org/apache/druid/server/http/CompactionResource.java\nindex b7d29b47a8..fd4cf4fcb9 100644\n--- a/server/src/main/java/org/apache/druid/server/http/CompactionResource.java\n+++ b/server/src/main/java/org/apache/druid/server/http/CompactionResource.java\n\n@@ -19,6 +19,7 @@\n \n package org.apache.druid.server.http;\n \n+import com.google.common.annotations.VisibleForTesting;\n import com.google.common.collect.ImmutableMap;\n import com.google.inject.Inject;\n import com.sun.jersey.spi.container.ResourceFilters;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM1OTQ5Nw==", "url": "https://github.com/apache/druid/pull/9644#discussion_r406359497", "bodyText": "This endpoint has been renamed. What happens to old clients that are calling the removed endpoint?", "author": "ccaominh", "createdAt": "2020-04-09T17:24:08Z", "path": "server/src/main/java/org/apache/druid/server/http/CompactionResource.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.server.http;\n+\n+import com.google.common.collect.ImmutableMap;\n+import com.google.inject.Inject;\n+import com.sun.jersey.spi.container.ResourceFilters;\n+import org.apache.druid.server.coordinator.DruidCoordinator;\n+import org.apache.druid.server.http.security.ConfigResourceFilter;\n+import org.apache.druid.server.http.security.StateResourceFilter;\n+\n+import javax.ws.rs.GET;\n+import javax.ws.rs.POST;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.QueryParam;\n+import javax.ws.rs.core.MediaType;\n+import javax.ws.rs.core.Response;\n+\n+@Path(\"/druid/coordinator/v1/compaction\")\n+public class CompactionResource\n+{\n+  private final DruidCoordinator coordinator;\n+\n+  @Inject\n+  public CompactionResource(\n+      DruidCoordinator coordinator\n+  )\n+  {\n+    this.coordinator = coordinator;\n+  }\n+\n+  @POST\n+  @Path(\"/compact\")\n+  @ResourceFilters(ConfigResourceFilter.class)\n+  public Response forceTriggerCompaction()\n+  {\n+    coordinator.runCompactSegmentsDuty();\n+    return Response.ok().build();\n+  }\n+\n+  @GET\n+  @Path(\"/progress\")", "originalCommit": "279dae41416a1d6f8bd2ae43e3e3bb6993cf7c03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjYwNjQxMw==", "url": "https://github.com/apache/druid/pull/9644#discussion_r406606413", "bodyText": "I talked to @jihoonson (who added this API). He mentioned that this API is to be used by the web console but web console is not using it yet.", "author": "maytasm", "createdAt": "2020-04-10T05:18:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM1OTQ5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg1OTc3OA==", "url": "https://github.com/apache/druid/pull/9644#discussion_r406859778", "bodyText": "Oh the old API is not documented. I think it's safe to assume that no one is using it.", "author": "jihoonson", "createdAt": "2020-04-10T17:28:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM1OTQ5Nw=="}], "type": "inlineReview", "revised_code": {"commit": "4c3976f074690dd6ff4055c709f5d2f4d8812898", "chunk": "diff --git a/server/src/main/java/org/apache/druid/server/http/CompactionResource.java b/server/src/main/java/org/apache/druid/server/http/CompactionResource.java\nindex b7d29b47a8..fd4cf4fcb9 100644\n--- a/server/src/main/java/org/apache/druid/server/http/CompactionResource.java\n+++ b/server/src/main/java/org/apache/druid/server/http/CompactionResource.java\n\n@@ -19,6 +19,7 @@\n \n package org.apache.druid.server.http;\n \n+import com.google.common.annotations.VisibleForTesting;\n import com.google.common.collect.ImmutableMap;\n import com.google.inject.Inject;\n import com.sun.jersey.spi.container.ResourceFilters;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM1OTk2Ng==", "url": "https://github.com/apache/druid/pull/9644#discussion_r406359966", "bodyText": "Indentation for ) seems off", "author": "ccaominh", "createdAt": "2020-04-09T17:24:55Z", "path": "server/src/test/java/org/apache/druid/server/http/security/SecurityResourceFilterTest.java", "diffHunk": "@@ -72,8 +73,9 @@\n             getRequestPathsWithAuthorizer(StatusResource.class),\n             getRequestPathsWithAuthorizer(SelfDiscoveryResource.class),\n             getRequestPathsWithAuthorizer(BrokerQueryResource.class),\n-            getRequestPathsWithAuthorizer(RouterResource.class)\n-        )\n+            getRequestPathsWithAuthorizer(RouterResource.class),\n+            getRequestPathsWithAuthorizer(CompactionResource.class)\n+            )", "originalCommit": "279dae41416a1d6f8bd2ae43e3e3bb6993cf7c03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjYwNjUwNg==", "url": "https://github.com/apache/druid/pull/9644#discussion_r406606506", "bodyText": "Fixed", "author": "maytasm", "createdAt": "2020-04-10T05:18:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM1OTk2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "4c3976f074690dd6ff4055c709f5d2f4d8812898", "chunk": "diff --git a/server/src/test/java/org/apache/druid/server/http/security/SecurityResourceFilterTest.java b/server/src/test/java/org/apache/druid/server/http/security/SecurityResourceFilterTest.java\nindex b4743e155a..c0b83145d3 100644\n--- a/server/src/test/java/org/apache/druid/server/http/security/SecurityResourceFilterTest.java\n+++ b/server/src/test/java/org/apache/druid/server/http/security/SecurityResourceFilterTest.java\n\n@@ -75,7 +75,7 @@ public class SecurityResourceFilterTest extends ResourceFilterTestHelper\n             getRequestPathsWithAuthorizer(BrokerQueryResource.class),\n             getRequestPathsWithAuthorizer(RouterResource.class),\n             getRequestPathsWithAuthorizer(CompactionResource.class)\n-            )\n+        )\n     );\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM2NTgzMg==", "url": "https://github.com/apache/druid/pull/9644#discussion_r406365832", "bodyText": "Why not return ImmutableList.of(compactSegments); instead?", "author": "ccaominh", "createdAt": "2020-04-09T17:35:22Z", "path": "server/src/main/java/org/apache/druid/server/coordinator/DruidCoordinator.java", "diffHunk": "@@ -621,13 +628,20 @@ private void stopBeingLeader()\n     return ImmutableList.copyOf(duties);\n   }\n \n-  public class DutiesRunnable implements Runnable\n+  private List<CoordinatorDuty> makeCompactSegmentsDuty()\n+  {\n+    List<CoordinatorDuty> duties = new ArrayList<>();\n+    duties.add(compactSegments);\n+    return ImmutableList.copyOf(duties);", "originalCommit": "279dae41416a1d6f8bd2ae43e3e3bb6993cf7c03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjYwNjU5NA==", "url": "https://github.com/apache/druid/pull/9644#discussion_r406606594", "bodyText": "Done", "author": "maytasm", "createdAt": "2020-04-10T05:18:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM2NTgzMg=="}], "type": "inlineReview", "revised_code": {"commit": "4c3976f074690dd6ff4055c709f5d2f4d8812898", "chunk": "diff --git a/server/src/main/java/org/apache/druid/server/coordinator/DruidCoordinator.java b/server/src/main/java/org/apache/druid/server/coordinator/DruidCoordinator.java\nindex 23f3dc9bb2..f8c3f43c76 100644\n--- a/server/src/main/java/org/apache/druid/server/coordinator/DruidCoordinator.java\n+++ b/server/src/main/java/org/apache/druid/server/coordinator/DruidCoordinator.java\n\n@@ -630,9 +630,7 @@ public class DruidCoordinator\n \n   private List<CoordinatorDuty> makeCompactSegmentsDuty()\n   {\n-    List<CoordinatorDuty> duties = new ArrayList<>();\n-    duties.add(compactSegments);\n-    return ImmutableList.copyOf(duties);\n+    return ImmutableList.of(compactSegments);\n   }\n \n   private class DutiesRunnable implements Runnable\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM2ODk2Mw==", "url": "https://github.com/apache/druid/pull/9644#discussion_r406368963", "bodyText": "Can we add tests for these?", "author": "ccaominh", "createdAt": "2020-04-09T17:40:56Z", "path": "server/src/main/java/org/apache/druid/server/http/CompactionResource.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.server.http;\n+\n+import com.google.common.collect.ImmutableMap;\n+import com.google.inject.Inject;\n+import com.sun.jersey.spi.container.ResourceFilters;\n+import org.apache.druid.server.coordinator.DruidCoordinator;\n+import org.apache.druid.server.http.security.ConfigResourceFilter;\n+import org.apache.druid.server.http.security.StateResourceFilter;\n+\n+import javax.ws.rs.GET;\n+import javax.ws.rs.POST;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.QueryParam;\n+import javax.ws.rs.core.MediaType;\n+import javax.ws.rs.core.Response;\n+\n+@Path(\"/druid/coordinator/v1/compaction\")\n+public class CompactionResource\n+{\n+  private final DruidCoordinator coordinator;\n+\n+  @Inject\n+  public CompactionResource(\n+      DruidCoordinator coordinator\n+  )\n+  {\n+    this.coordinator = coordinator;\n+  }\n+\n+  @POST", "originalCommit": "279dae41416a1d6f8bd2ae43e3e3bb6993cf7c03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjYwNzcyMA==", "url": "https://github.com/apache/druid/pull/9644#discussion_r406607720", "bodyText": "/progress is an old API (I simply renamed it), hence didn't add any tests for it.\nAdded integration tests for /compact", "author": "maytasm", "createdAt": "2020-04-10T05:24:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM2ODk2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "4c3976f074690dd6ff4055c709f5d2f4d8812898", "chunk": "diff --git a/server/src/main/java/org/apache/druid/server/http/CompactionResource.java b/server/src/main/java/org/apache/druid/server/http/CompactionResource.java\nindex b7d29b47a8..fd4cf4fcb9 100644\n--- a/server/src/main/java/org/apache/druid/server/http/CompactionResource.java\n+++ b/server/src/main/java/org/apache/druid/server/http/CompactionResource.java\n\n@@ -19,6 +19,7 @@\n \n package org.apache.druid.server.http;\n \n+import com.google.common.annotations.VisibleForTesting;\n import com.google.common.collect.ImmutableMap;\n import com.google.inject.Inject;\n import com.sun.jersey.spi.container.ResourceFilters;\n"}}, {"oid": "4c3976f074690dd6ff4055c709f5d2f4d8812898", "url": "https://github.com/apache/druid/commit/4c3976f074690dd6ff4055c709f5d2f4d8812898", "message": "Add API to trigger a compaction by the coordinator for integration tests", "committedDate": "2020-04-10T07:18:50Z", "type": "commit"}, {"oid": "fefee057063e154faba5f83f773fc0e476337d7b", "url": "https://github.com/apache/druid/commit/fefee057063e154faba5f83f773fc0e476337d7b", "message": "Add API to trigger a compaction by the coordinator for integration tests", "committedDate": "2020-04-11T03:13:16Z", "type": "commit"}, {"oid": "745e0db9b7a713829ee42522d66dfa5c190ac33f", "url": "https://github.com/apache/druid/commit/745e0db9b7a713829ee42522d66dfa5c190ac33f", "message": "Add missing integration tests for the compaction by the coordinator", "committedDate": "2020-04-11T03:20:16Z", "type": "commit"}, {"oid": "e3f9a8d2c6810ffe8467f87091de55643743b6e9", "url": "https://github.com/apache/druid/commit/e3f9a8d2c6810ffe8467f87091de55643743b6e9", "message": "Add API to trigger a compaction by the coordinator for integration tests", "committedDate": "2020-04-11T03:48:34Z", "type": "commit"}, {"oid": "a87a34aed84c1682e957f60ed6054134ef90a49a", "url": "https://github.com/apache/druid/commit/a87a34aed84c1682e957f60ed6054134ef90a49a", "message": "Add missing integration tests for the compaction by the coordinator", "committedDate": "2020-04-11T08:42:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzAzNzE0Mg==", "url": "https://github.com/apache/druid/pull/9644#discussion_r407037142", "bodyText": "@jihoonson Not sure if this is expected but when I call the API for get compaction progress here I got status[400 Bad Request] content[{\"error\":\"unknown dataSource\"}] instead of 0. I expected 0 since all segments of the datasource have been compacted.", "author": "maytasm", "createdAt": "2020-04-11T08:44:56Z", "path": "integration-tests/src/test/java/org/apache/druid/tests/coordinator/duty/ITAutoCompactionTest.java", "diffHunk": "@@ -0,0 +1,351 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.tests.coordinator.duty;\n+\n+import com.google.inject.Inject;\n+import org.apache.commons.io.IOUtils;\n+import org.apache.druid.indexer.partitions.SecondaryPartitionType;\n+import org.apache.druid.java.util.common.ISE;\n+import org.apache.druid.java.util.common.StringUtils;\n+import org.apache.druid.java.util.common.logger.Logger;\n+import org.apache.druid.server.coordinator.CoordinatorCompactionConfig;\n+import org.apache.druid.server.coordinator.DataSourceCompactionConfig;\n+import org.apache.druid.testing.IntegrationTestingConfig;\n+import org.apache.druid.testing.clients.CompactionResourceTestClient;\n+import org.apache.druid.testing.guice.DruidTestModuleFactory;\n+import org.apache.druid.testing.utils.ITRetryUtil;\n+import org.apache.druid.tests.TestNGGroup;\n+import org.apache.druid.tests.indexer.AbstractITBatchIndexTest;\n+import org.apache.druid.tests.indexer.AbstractIndexerTest;\n+import org.apache.druid.timeline.DataSegment;\n+import org.joda.time.Period;\n+import org.testng.Assert;\n+import org.testng.annotations.BeforeMethod;\n+import org.testng.annotations.Guice;\n+import org.testng.annotations.Test;\n+\n+import java.io.Closeable;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.UUID;\n+\n+@Test(groups = {TestNGGroup.OTHER_INDEX})\n+@Guice(moduleFactory = DruidTestModuleFactory.class)\n+public class ITAutoCompactionTest extends AbstractIndexerTest\n+{\n+  private static final Logger LOG = new Logger(ITAutoCompactionTest.class);\n+  private static final String INDEX_TASK = \"/indexer/wikipedia_index_task.json\";\n+  private static final String INDEX_QUERIES_RESOURCE = \"/indexer/wikipedia_index_queries.json\";\n+  private static final int MAX_ROWS_PER_SEGMENT_COMPACTED = 10000;\n+  private static final Period SKIP_OFFSET_FROM_LATEST = Period.seconds(0);\n+\n+  @Inject\n+  protected CompactionResourceTestClient compactionResource;\n+\n+  @Inject\n+  private IntegrationTestingConfig config;\n+\n+  private String fullDatasourceName;\n+\n+  @BeforeMethod\n+  public void setup() throws Exception\n+  {\n+    // Set comapction slot to 10\n+    updateCompactionTaskSlot(0.5, 10);\n+    fullDatasourceName = \"wikipedia_index_test_\" + UUID.randomUUID() + config.getExtraDatasourceNameSuffix();\n+  }\n+\n+  @Test\n+  public void testAutoCompactionDutySubmitAndVerifyCompaction() throws Exception\n+  {\n+    loadData(INDEX_TASK);\n+    try (final Closeable ignored = unloader(fullDatasourceName)) {\n+      final List<String> intervalsBeforeCompaction = coordinator.getSegmentIntervals(fullDatasourceName);\n+      intervalsBeforeCompaction.sort(null);\n+      // 4 segments across 2 days (4 total)...\n+      verifySegmentsCount(4);\n+      verifyQuery(INDEX_QUERIES_RESOURCE);\n+\n+      submitCompactionConfig(MAX_ROWS_PER_SEGMENT_COMPACTED, Period.days(1));\n+      forceTriggerAutoCompaction();\n+      //...compacted into 1 new segment for 1 day. 1 day compacted and 1 day skipped/remains uncompacted. (5 total)\n+      verifySegmentsCount(5);\n+      verifyQuery(INDEX_QUERIES_RESOURCE);\n+      verifySegmentsCompacted(1, MAX_ROWS_PER_SEGMENT_COMPACTED);\n+      checkCompactionIntervals(intervalsBeforeCompaction);\n+\n+      submitCompactionConfig(MAX_ROWS_PER_SEGMENT_COMPACTED, SKIP_OFFSET_FROM_LATEST);\n+      forceTriggerAutoCompaction();\n+      //...compacted into 1 new segment for the remaining one day. 2 day compacted and 0 day uncompacted. (6 total)\n+      verifySegmentsCount(6);\n+      verifyQuery(INDEX_QUERIES_RESOURCE);\n+      verifySegmentsCompacted(2, MAX_ROWS_PER_SEGMENT_COMPACTED);\n+      checkCompactionIntervals(intervalsBeforeCompaction);\n+    }\n+  }\n+\n+  @Test\n+  public void testAutoCompactionDutyCanUpdateCompactionConfig() throws Exception\n+  {\n+    loadData(INDEX_TASK);\n+    try (final Closeable ignored = unloader(fullDatasourceName)) {\n+      final List<String> intervalsBeforeCompaction = coordinator.getSegmentIntervals(fullDatasourceName);\n+      intervalsBeforeCompaction.sort(null);\n+      // 4 segments across 2 days (4 total)...\n+      verifySegmentsCount(4);\n+      verifyQuery(INDEX_QUERIES_RESOURCE);\n+\n+      // Dummy compaction config which will be overwritten\n+      submitCompactionConfig(10000, SKIP_OFFSET_FROM_LATEST);\n+      // New compaction config should overwrites the existing compaction config\n+      submitCompactionConfig(1, SKIP_OFFSET_FROM_LATEST);\n+      forceTriggerAutoCompaction();\n+\n+      // Instead of merging segments, the updated config will split segments!\n+      //...compacted into 10 new segments across 2 days. 5 new segments each day (14 total)\n+      verifySegmentsCount(14);\n+      verifyQuery(INDEX_QUERIES_RESOURCE);\n+      verifySegmentsCompacted(10, 2);\n+\n+      checkCompactionIntervals(intervalsBeforeCompaction);\n+    }\n+  }\n+\n+  @Test\n+  public void testAutoCompactionDutyCanDeleteCompactionConfig() throws Exception\n+  {\n+    loadData(INDEX_TASK);\n+    try (final Closeable ignored = unloader(fullDatasourceName)) {\n+      final List<String> intervalsBeforeCompaction = coordinator.getSegmentIntervals(fullDatasourceName);\n+      intervalsBeforeCompaction.sort(null);\n+      // 4 segments across 2 days (4 total)...\n+      verifySegmentsCount(4);\n+      verifyQuery(INDEX_QUERIES_RESOURCE);\n+\n+      submitCompactionConfig(MAX_ROWS_PER_SEGMENT_COMPACTED, SKIP_OFFSET_FROM_LATEST);\n+      deleteCompactionConfig();\n+      forceTriggerAutoCompaction();\n+\n+      // ...should remains unchanged (4 total)\n+      verifySegmentsCount(4);\n+      verifyQuery(INDEX_QUERIES_RESOURCE);\n+      verifySegmentsCompacted(0, null);\n+\n+      checkCompactionIntervals(intervalsBeforeCompaction);\n+    }\n+  }\n+\n+  @Test\n+  public void testAutoCompactionDutyCanUpdateTaskSlots() throws Exception\n+  {\n+    loadData(INDEX_TASK);\n+    try (final Closeable ignored = unloader(fullDatasourceName)) {\n+      final List<String> intervalsBeforeCompaction = coordinator.getSegmentIntervals(fullDatasourceName);\n+      intervalsBeforeCompaction.sort(null);\n+      // 4 segments across 2 days (4 total)...\n+      verifySegmentsCount(4);\n+      verifyQuery(INDEX_QUERIES_RESOURCE);\n+\n+      // Skips first day. Should only compact one out of two days.\n+      submitCompactionConfig(MAX_ROWS_PER_SEGMENT_COMPACTED, SKIP_OFFSET_FROM_LATEST);\n+\n+      // Set compactionTaskSlotRatio to 0 to prevent any compaction\n+      updateCompactionTaskSlot(0, 100);\n+      forceTriggerAutoCompaction();\n+      // ...should remains unchanged (4 total)\n+      verifySegmentsCount(4);\n+      verifyQuery(INDEX_QUERIES_RESOURCE);\n+      verifySegmentsCompacted(0, null);\n+      checkCompactionIntervals(intervalsBeforeCompaction);\n+\n+      // Set maxCompactionTaskSlots to 0 to prevent any compaction\n+      updateCompactionTaskSlot(0.1, 0);\n+      forceTriggerAutoCompaction();\n+      // ...should remains unchanged (4 total)\n+      verifySegmentsCount(4);\n+      verifyQuery(INDEX_QUERIES_RESOURCE);\n+      verifySegmentsCompacted(0, null);\n+      checkCompactionIntervals(intervalsBeforeCompaction);\n+\n+      // Update compaction slots to be 1\n+      updateCompactionTaskSlot(1, 1);\n+      forceTriggerAutoCompaction();\n+      // One day compacted (1 new segment) and one day remains uncompacted. (5 total)\n+      verifySegmentsCount(5);\n+      verifyQuery(INDEX_QUERIES_RESOURCE);\n+      verifySegmentsCompacted(1, MAX_ROWS_PER_SEGMENT_COMPACTED);\n+      checkCompactionIntervals(intervalsBeforeCompaction);\n+      Assert.assertEquals(compactionResource.getCompactionProgress(fullDatasourceName).get(\"remainingSegmentSize\"), \"14312\");\n+      // Run compaction again to compact the remaining day\n+      forceTriggerAutoCompaction();\n+      // Remaining day compacted (1 new segment). Now both days compacted (6 total)\n+      verifySegmentsCount(6);\n+      verifyQuery(INDEX_QUERIES_RESOURCE);\n+      verifySegmentsCompacted(2, MAX_ROWS_PER_SEGMENT_COMPACTED);\n+      checkCompactionIntervals(intervalsBeforeCompaction);\n+//      Assert.assertEquals(compactionResource.getCompactionProgress(fullDatasourceName).get(\"remainingSegmentSize\"), \"0\");", "originalCommit": "a87a34aed84c1682e957f60ed6054134ef90a49a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3eb94c1b5995e26b2c8e95c1b5cf7aa58f964c3c", "chunk": "diff --git a/integration-tests/src/test/java/org/apache/druid/tests/coordinator/duty/ITAutoCompactionTest.java b/integration-tests/src/test/java/org/apache/druid/tests/coordinator/duty/ITAutoCompactionTest.java\nindex 9968805044..592c91034d 100644\n--- a/integration-tests/src/test/java/org/apache/druid/tests/coordinator/duty/ITAutoCompactionTest.java\n+++ b/integration-tests/src/test/java/org/apache/druid/tests/coordinator/duty/ITAutoCompactionTest.java\n\n@@ -125,7 +125,7 @@ public class ITAutoCompactionTest extends AbstractIndexerTest\n       //...compacted into 10 new segments across 2 days. 5 new segments each day (14 total)\n       verifySegmentsCount(14);\n       verifyQuery(INDEX_QUERIES_RESOURCE);\n-      verifySegmentsCompacted(10, 2);\n+      verifySegmentsCompacted(10, 1);\n \n       checkCompactionIntervals(intervalsBeforeCompaction);\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc5MjEyMQ==", "url": "https://github.com/apache/druid/pull/9644#discussion_r407792121", "bodyText": "Should the message say something about updating compaction task slots instead?", "author": "ccaominh", "createdAt": "2020-04-14T00:16:48Z", "path": "integration-tests/src/main/java/org/apache/druid/testing/clients/CompactionResourceTestClient.java", "diffHunk": "@@ -0,0 +1,179 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.testing.clients;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.google.inject.Inject;\n+import org.apache.druid.java.util.common.ISE;\n+import org.apache.druid.java.util.common.StringUtils;\n+import org.apache.druid.java.util.http.client.HttpClient;\n+import org.apache.druid.java.util.http.client.Request;\n+import org.apache.druid.java.util.http.client.response.StatusResponseHandler;\n+import org.apache.druid.java.util.http.client.response.StatusResponseHolder;\n+import org.apache.druid.server.coordinator.CoordinatorCompactionConfig;\n+import org.apache.druid.server.coordinator.DataSourceCompactionConfig;\n+import org.apache.druid.testing.IntegrationTestingConfig;\n+import org.apache.druid.testing.guice.TestClient;\n+import org.jboss.netty.handler.codec.http.HttpMethod;\n+import org.jboss.netty.handler.codec.http.HttpResponseStatus;\n+\n+import javax.ws.rs.QueryParam;\n+import java.net.URL;\n+import java.util.Map;\n+\n+public class CompactionResourceTestClient\n+{\n+  private final ObjectMapper jsonMapper;\n+  private final HttpClient httpClient;\n+  private final String coordinator;\n+  private final StatusResponseHandler responseHandler;\n+\n+  @Inject\n+  CompactionResourceTestClient(\n+      ObjectMapper jsonMapper,\n+      @TestClient HttpClient httpClient,\n+      IntegrationTestingConfig config\n+  )\n+  {\n+    this.jsonMapper = jsonMapper;\n+    this.httpClient = httpClient;\n+    this.coordinator = config.getCoordinatorUrl();\n+    this.responseHandler = StatusResponseHandler.getInstance();\n+  }\n+\n+  private String getCoordinatorURL()\n+  {\n+    return StringUtils.format(\n+        \"%s/druid/coordinator/v1/\",\n+        coordinator\n+    );\n+  }\n+\n+  public void submitCompactionConfig(final DataSourceCompactionConfig dataSourceCompactionConfig) throws Exception\n+  {\n+    String url = StringUtils.format(\"%sconfig/compaction\", getCoordinatorURL());\n+    StatusResponseHolder response = httpClient.go(\n+        new Request(HttpMethod.POST, new URL(url)).setContent(\n+            \"application/json\",\n+            jsonMapper.writeValueAsBytes(dataSourceCompactionConfig)\n+        ), responseHandler\n+    ).get();\n+\n+    if (!response.getStatus().equals(HttpResponseStatus.OK)) {\n+      throw new ISE(\n+          \"Error while submiting compaction config status[%s] content[%s]\",\n+          response.getStatus(),\n+          response.getContent()\n+      );\n+    }\n+  }\n+\n+  public void deleteCompactionConfig(final String dataSource) throws Exception\n+  {\n+    String url = StringUtils.format(\"%sconfig/compaction/%s\", getCoordinatorURL(), StringUtils.urlEncode(dataSource));\n+    StatusResponseHolder response = httpClient.go(new Request(HttpMethod.DELETE, new URL(url)), responseHandler).get();\n+\n+    if (!response.getStatus().equals(HttpResponseStatus.OK)) {\n+      throw new ISE(\n+          \"Error while deleting compaction config status[%s] content[%s]\",\n+          response.getStatus(),\n+          response.getContent()\n+      );\n+    }\n+  }\n+\n+  public CoordinatorCompactionConfig getCoordinatorCompactionConfigs() throws Exception\n+  {\n+    String url = StringUtils.format(\"%sconfig/compaction\", getCoordinatorURL());\n+    StatusResponseHolder response = httpClient.go(\n+        new Request(HttpMethod.GET, new URL(url)), responseHandler\n+    ).get();\n+    if (!response.getStatus().equals(HttpResponseStatus.OK)) {\n+      throw new ISE(\n+          \"Error while getting compaction config status[%s] content[%s]\",\n+          response.getStatus(),\n+          response.getContent()\n+      );\n+    }\n+    return jsonMapper.readValue(response.getContent(), new TypeReference<CoordinatorCompactionConfig>() {});\n+  }\n+\n+  public DataSourceCompactionConfig getDataSourceCompactionConfig(String dataSource) throws Exception\n+  {\n+    String url = StringUtils.format(\"%sconfig/compaction/%s\", getCoordinatorURL(), StringUtils.urlEncode(dataSource));\n+    StatusResponseHolder response = httpClient.go(\n+        new Request(HttpMethod.GET, new URL(url)), responseHandler\n+    ).get();\n+    if (!response.getStatus().equals(HttpResponseStatus.OK)) {\n+      throw new ISE(\n+          \"Error while getting compaction config status[%s] content[%s]\",\n+          response.getStatus(),\n+          response.getContent()\n+      );\n+    }\n+    return jsonMapper.readValue(response.getContent(), new TypeReference<DataSourceCompactionConfig>() {});\n+  }\n+\n+  public void forceTriggerAutoCompaction() throws Exception\n+  {\n+    String url = StringUtils.format(\"%scompaction/compact\", getCoordinatorURL());\n+    StatusResponseHolder response = httpClient.go(new Request(HttpMethod.POST, new URL(url)), responseHandler).get();\n+    if (!response.getStatus().equals(HttpResponseStatus.OK)) {\n+      throw new ISE(\n+          \"Error while force trigger auto compaction status[%s] content[%s]\",\n+          response.getStatus(),\n+          response.getContent()\n+      );\n+    }\n+  }\n+\n+  public void updateCompactionTaskSlot(Double compactionTaskSlotRatio, Integer maxCompactionTaskSlots) throws Exception\n+  {\n+    String url = StringUtils.format(\"%sconfig/compaction/taskslots?ratio=%s&max=%s\",\n+                                    getCoordinatorURL(),\n+                                    StringUtils.urlEncode(compactionTaskSlotRatio.toString()),\n+                                    StringUtils.urlEncode(maxCompactionTaskSlots.toString()));\n+    StatusResponseHolder response = httpClient.go(new Request(HttpMethod.POST, new URL(url)), responseHandler).get();\n+    if (!response.getStatus().equals(HttpResponseStatus.OK)) {\n+      throw new ISE(\n+          \"Error while force trigger auto compaction status[%s] content[%s]\",", "originalCommit": "a87a34aed84c1682e957f60ed6054134ef90a49a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUwNjU2Mw==", "url": "https://github.com/apache/druid/pull/9644#discussion_r408506563", "bodyText": "Done", "author": "maytasm", "createdAt": "2020-04-15T00:09:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc5MjEyMQ=="}], "type": "inlineReview", "revised_code": {"commit": "3eb94c1b5995e26b2c8e95c1b5cf7aa58f964c3c", "chunk": "diff --git a/integration-tests/src/main/java/org/apache/druid/testing/clients/CompactionResourceTestClient.java b/integration-tests/src/main/java/org/apache/druid/testing/clients/CompactionResourceTestClient.java\nindex 81d57b5258..60f3930edb 100644\n--- a/integration-tests/src/main/java/org/apache/druid/testing/clients/CompactionResourceTestClient.java\n+++ b/integration-tests/src/main/java/org/apache/druid/testing/clients/CompactionResourceTestClient.java\n\n@@ -35,7 +35,6 @@ import org.apache.druid.testing.guice.TestClient;\n import org.jboss.netty.handler.codec.http.HttpMethod;\n import org.jboss.netty.handler.codec.http.HttpResponseStatus;\n \n-import javax.ws.rs.QueryParam;\n import java.net.URL;\n import java.util.Map;\n \n"}}, {"oid": "3eb94c1b5995e26b2c8e95c1b5cf7aa58f964c3c", "url": "https://github.com/apache/druid/commit/3eb94c1b5995e26b2c8e95c1b5cf7aa58f964c3c", "message": "address comments", "committedDate": "2020-04-15T00:09:40Z", "type": "commit"}]}