{"pr_number": 10046, "pr_title": "Fix missing temp dir for native single_dim", "pr_createdAt": "2020-06-17T22:55:54Z", "pr_url": "https://github.com/apache/druid/pull/10046", "timeline": [{"oid": "5dec32a32142cff410591e318e588f86f833792a", "url": "https://github.com/apache/druid/commit/5dec32a32142cff410591e318e588f86f833792a", "message": "Fix missing temp dir for native single_dim\n\nNative single dim indexing throws a file not found exception from\nInputEntityIteratingReader.java:81.  This MR creates the required\ntemporary directory when setting up the\nPartialDimensionDistributionTask.  The change was tested on a Druid\ncluster.  After installing the change native single_dim indexing\ncompletes successfully.", "committedDate": "2020-06-17T22:32:00Z", "type": "commit"}, {"oid": "bd619ec072ee46e17f3cb6c840a4975dd333eff6", "url": "https://github.com/apache/druid/commit/bd619ec072ee46e17f3cb6c840a4975dd333eff6", "message": "Fix indentation", "committedDate": "2020-06-18T18:03:22Z", "type": "commit"}, {"oid": "4d0ce86a1ba2a44adddb54f67ced320859938f8e", "url": "https://github.com/apache/druid/commit/4d0ce86a1ba2a44adddb54f67ced320859938f8e", "message": "Use SinglePhaseSubTask as example for creating the temp dir", "committedDate": "2020-06-18T18:27:17Z", "type": "commit"}, {"oid": "62909739a51f91ea2a2a955d4b1df2abc77bbdd5", "url": "https://github.com/apache/druid/commit/62909739a51f91ea2a2a955d4b1df2abc77bbdd5", "message": "Merge branch 'master' of https://github.com/apache/druid into missing-indexing-tmp-dir", "committedDate": "2020-06-18T19:51:15Z", "type": "commit"}, {"oid": "36e7fafdb1660b317d7302f5f3bf5b4f18c353f7", "url": "https://github.com/apache/druid/commit/36e7fafdb1660b317d7302f5f3bf5b4f18c353f7", "message": "Merge branch 'master' of https://github.com/apache/druid into missing-indexing-tmp-dir", "committedDate": "2020-06-23T23:07:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU3NTg3Mw==", "url": "https://github.com/apache/druid/pull/10046#discussion_r444575873", "bodyText": "How about pushing this code into TaskToolbox.getIndexingTmpDir()? We can check if the directory exists first and then create one.", "author": "jihoonson", "createdAt": "2020-06-24T00:16:01Z", "path": "indexing-service/src/main/java/org/apache/druid/indexing/common/task/batch/parallel/PartialDimensionDistributionTask.java", "diffHunk": "@@ -200,6 +202,10 @@ public TaskStatus runTask(TaskToolbox toolbox) throws Exception\n     Preconditions.checkNotNull(partitionDimension, \"partitionDimension required in partitionsSpec\");\n     boolean isAssumeGrouped = partitionsSpec.isAssumeGrouped();\n \n+    final File tmpDir = toolbox.getIndexingTmpDir();\n+    // Temporary directory is automatically removed when this IndexTask completes.\n+    FileUtils.forceMkdir(tmpDir);", "originalCommit": "62909739a51f91ea2a2a955d4b1df2abc77bbdd5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk4NjI4OQ==", "url": "https://github.com/apache/druid/pull/10046#discussion_r444986289", "bodyText": "Good idea.  forceMkdir has guards to check if the directory already exists and is actually a directory rather than a file, so I didn't add any extra guards in TaskToolbox.", "author": "morrifeldman", "createdAt": "2020-06-24T15:35:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU3NTg3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "055bd2674f9976d6dee1f30f3a696518a9a7309e", "chunk": "diff --git a/indexing-service/src/main/java/org/apache/druid/indexing/common/task/batch/parallel/PartialDimensionDistributionTask.java b/indexing-service/src/main/java/org/apache/druid/indexing/common/task/batch/parallel/PartialDimensionDistributionTask.java\nindex 25b14a3747..99304c281b 100644\n--- a/indexing-service/src/main/java/org/apache/druid/indexing/common/task/batch/parallel/PartialDimensionDistributionTask.java\n+++ b/indexing-service/src/main/java/org/apache/druid/indexing/common/task/batch/parallel/PartialDimensionDistributionTask.java\n\n@@ -202,10 +200,6 @@ public class PartialDimensionDistributionTask extends PerfectRollupWorkerTask\n     Preconditions.checkNotNull(partitionDimension, \"partitionDimension required in partitionsSpec\");\n     boolean isAssumeGrouped = partitionsSpec.isAssumeGrouped();\n \n-    final File tmpDir = toolbox.getIndexingTmpDir();\n-    // Temporary directory is automatically removed when this IndexTask completes.\n-    FileUtils.forceMkdir(tmpDir);\n-\n     InputSource inputSource = ingestionSchema.getIOConfig().getNonNullInputSource(\n         ingestionSchema.getDataSchema().getParser()\n     );\n"}}, {"oid": "055bd2674f9976d6dee1f30f3a696518a9a7309e", "url": "https://github.com/apache/druid/commit/055bd2674f9976d6dee1f30f3a696518a9a7309e", "message": "Move temporary indexing dir creation in to TaskToolbox", "committedDate": "2020-06-24T15:12:24Z", "type": "commit"}, {"oid": "7c50fd918d9f71ee46c3ad1aa31078289775c026", "url": "https://github.com/apache/druid/commit/7c50fd918d9f71ee46c3ad1aa31078289775c026", "message": "Remove unused dependency", "committedDate": "2020-06-24T20:33:39Z", "type": "commit"}, {"oid": "9cd65ca87df39786f13a04c7c420df2a11fc8a6a", "url": "https://github.com/apache/druid/commit/9cd65ca87df39786f13a04c7c420df2a11fc8a6a", "message": "Merge remote-tracking branch 'upstream/master' into missing-indexing-tmp-dir", "committedDate": "2020-06-24T21:51:51Z", "type": "commit"}]}