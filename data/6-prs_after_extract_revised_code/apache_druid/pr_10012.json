{"pr_number": 10012, "pr_title": "Set the core partition set size properly for batch ingestion with dynamic partitioning", "pr_createdAt": "2020-06-10T00:25:55Z", "pr_url": "https://github.com/apache/druid/pull/10012", "timeline": [{"oid": "edafd1617b27eff2eef812e46976930d75fd09e8", "url": "https://github.com/apache/druid/commit/edafd1617b27eff2eef812e46976930d75fd09e8", "message": "Fill in the core partition set size properly for batch ingestion with\ndynamic partitioning", "committedDate": "2020-06-10T00:19:40Z", "type": "commit"}, {"oid": "771eec1364aa3e2707a4c10d97cb372b15807842", "url": "https://github.com/apache/druid/commit/771eec1364aa3e2707a4c10d97cb372b15807842", "message": "Merge branch 'master' of github.com:apache/druid into dynamic-partition-atomic-update", "committedDate": "2020-06-10T00:21:58Z", "type": "commit"}, {"oid": "f1aeddb63487c4e646acc7b541fd00a3079479df", "url": "https://github.com/apache/druid/commit/f1aeddb63487c4e646acc7b541fd00a3079479df", "message": "incomplete javadoc", "committedDate": "2020-06-10T00:37:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ1NDkwMA==", "url": "https://github.com/apache/druid/pull/10012#discussion_r438454900", "bodyText": "Suggest mentioning here that overwrites with segment locking use NumberedOverwriteShardSpec", "author": "jon-wei", "createdAt": "2020-06-10T23:07:03Z", "path": "core/src/main/java/org/apache/druid/timeline/partition/BuildingNumberedShardSpec.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.timeline.partition;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.google.common.base.Preconditions;\n+import com.google.common.collect.RangeSet;\n+import org.apache.druid.data.input.InputRow;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * This is a special shardSpec which is temporarily used during batch ingestion. In Druid, there is a concept\n+ * of core partition set which is a set of segments atomically becoming queryable together in Brokers. The core\n+ * partition set is represented as a range of partitionIds. For {@link NumberedShardSpec}, the core partition set\n+ * is [0, {@link NumberedShardSpec#partitions}).\n+ *\n+ * The NumberedShardSpec is used for dynamic partitioning which is based on the number of rows in each segment.\n+ * In streaming ingestion, the core partition set size cannot be determined since it's impossible to know how many\n+ * segments will be created per time chunk. However, in batch ingestion with time chunk locking, the core partition\n+ * set is the set of segments created by an initial task or an overwriting task. Since the core partition set is\n+ * determined when the task publishes segments at the end, the task postpones creating proper NumberedShardSpec\n+ * until the end.\n+ *\n+ * This shardSpec is used for such use case. A non-appending batch task can use this shardSpec until it publishes\n+ * segments at last. When it publishes segments, it should convert the shardSpec of those segments to NumberedShardSpec.\n+ * See {@code SegmentPublisherHelper#annotateShardSpec} for converting to NumberedShardSpec. Note that, when\n+ * the segment lock is used, the Overlord coordinates the segment allocation and this class is never used. See\n+ * {@link PartialShardSpec} for that case.", "originalCommit": "f1aeddb63487c4e646acc7b541fd00a3079479df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ4OTYzOA==", "url": "https://github.com/apache/druid/pull/10012#discussion_r438489638", "bodyText": "In segment locking, any implementation of OverwriteShardSpec can be used when you overwrite segments. Rephrased the last sentence.", "author": "jihoonson", "createdAt": "2020-06-11T01:13:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ1NDkwMA=="}], "type": "inlineReview", "revised_code": {"commit": "42e37e2e85f58af0b0da4c7fcf6cfad29af4dadb", "chunk": "diff --git a/core/src/main/java/org/apache/druid/timeline/partition/BuildingNumberedShardSpec.java b/core/src/main/java/org/apache/druid/timeline/partition/BuildingNumberedShardSpec.java\nindex 478db2d28b..43098aae61 100644\n--- a/core/src/main/java/org/apache/druid/timeline/partition/BuildingNumberedShardSpec.java\n+++ b/core/src/main/java/org/apache/druid/timeline/partition/BuildingNumberedShardSpec.java\n\n@@ -44,8 +44,10 @@ import java.util.Map;\n  * This shardSpec is used for such use case. A non-appending batch task can use this shardSpec until it publishes\n  * segments at last. When it publishes segments, it should convert the shardSpec of those segments to NumberedShardSpec.\n  * See {@code SegmentPublisherHelper#annotateShardSpec} for converting to NumberedShardSpec. Note that, when\n- * the segment lock is used, the Overlord coordinates the segment allocation and this class is never used. See\n- * {@link PartialShardSpec} for that case.\n+ * the segment lock is used, the Overlord coordinates the segment allocation and this class is never used. Instead,\n+ * the task sends {@link PartialShardSpec} to the Overlord to allocate a new segment. The result segment could have\n+ * either a {@link ShardSpec} (for root generation segments) or an {@link OverwriteShardSpec} (for non-root\n+ * generation segments).\n  *\n  * This class should be Jackson-serializable as the subtasks can send it to the parallel task in parallel ingestion.\n  *\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ1NTE0Mg==", "url": "https://github.com/apache/druid/pull/10012#discussion_r438455142", "bodyText": "determins -> determines", "author": "jon-wei", "createdAt": "2020-06-10T23:07:49Z", "path": "core/src/main/java/org/apache/druid/timeline/partition/PartialShardSpec.java", "diffHunk": "@@ -29,7 +29,10 @@\n \n /**\n  * Class to contain all information of a {@link ShardSpec} except for the partition ID.\n- * This class is mainly used by the indexing tasks to allocate new segments using the Overlord.\n+ * This class is used when the segment allocation is coordinated by the Overlord; when appending segments to an\n+ * existing datasource (either streaming ingestion or batch append) or when using segment locking.\n+ * The ingestion tasks send all information required for allocating a new segment using this class and the Overlord\n+ * determins the partition ID to create a new segment.", "originalCommit": "f1aeddb63487c4e646acc7b541fd00a3079479df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ4OTY1Nw==", "url": "https://github.com/apache/druid/pull/10012#discussion_r438489657", "bodyText": "Fixed, thanks.", "author": "jihoonson", "createdAt": "2020-06-11T01:13:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ1NTE0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "42e37e2e85f58af0b0da4c7fcf6cfad29af4dadb", "chunk": "diff --git a/core/src/main/java/org/apache/druid/timeline/partition/PartialShardSpec.java b/core/src/main/java/org/apache/druid/timeline/partition/PartialShardSpec.java\nindex 9ba9ac579c..6afaa93947 100644\n--- a/core/src/main/java/org/apache/druid/timeline/partition/PartialShardSpec.java\n+++ b/core/src/main/java/org/apache/druid/timeline/partition/PartialShardSpec.java\n\n@@ -28,11 +28,12 @@ import com.fasterxml.jackson.databind.ObjectMapper;\n import javax.annotation.Nullable;\n \n /**\n- * Class to contain all information of a {@link ShardSpec} except for the partition ID.\n- * This class is used when the segment allocation is coordinated by the Overlord; when appending segments to an\n- * existing datasource (either streaming ingestion or batch append) or when using segment locking.\n- * The ingestion tasks send all information required for allocating a new segment using this class and the Overlord\n- * determins the partition ID to create a new segment.\n+ * This interface is used in the segment allocation protocol when it is coordinated by the Overlord; when appending\n+ * segments to an existing datasource (either streaming ingestion or batch append) or any case when segment\n+ * lock is used. The implementations of this interface contain all information of the corresponding {@link ShardSpec}\n+ * except the partition ID.\n+ * The ingestion tasks send all information required for allocating a new segment using this interface and the Overlord\n+ * determines the partition ID to create a new segment.\n  */\n @JsonTypeInfo(use = JsonTypeInfo.Id.NAME, property = \"type\")\n @JsonSubTypes({\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ1NTcyMg==", "url": "https://github.com/apache/druid/pull/10012#discussion_r438455722", "bodyText": "Is this used for all segment locking cases? (is PartialShardSpec also involved in overwrites with segment locking, or is that just OverwriteShardSpec?)", "author": "jon-wei", "createdAt": "2020-06-10T23:09:42Z", "path": "core/src/main/java/org/apache/druid/timeline/partition/PartialShardSpec.java", "diffHunk": "@@ -29,7 +29,10 @@\n \n /**\n  * Class to contain all information of a {@link ShardSpec} except for the partition ID.\n- * This class is mainly used by the indexing tasks to allocate new segments using the Overlord.\n+ * This class is used when the segment allocation is coordinated by the Overlord; when appending segments to an\n+ * existing datasource (either streaming ingestion or batch append) or when using segment locking.", "originalCommit": "f1aeddb63487c4e646acc7b541fd00a3079479df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ4OTc0NQ==", "url": "https://github.com/apache/druid/pull/10012#discussion_r438489745", "bodyText": "Yes, it's used all cases when segment lock is used. PartialShardSpec is used in the segment allocation protocol when the overlord coordinates the allocation. So, it is involved in 1) all cases with segment locking and 2) appending with time chunk locking. OverwriteShardSpec is a special shard spec used with segment locking for the segments overwriting others. Added some more details.", "author": "jihoonson", "createdAt": "2020-06-11T01:13:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ1NTcyMg=="}], "type": "inlineReview", "revised_code": {"commit": "42e37e2e85f58af0b0da4c7fcf6cfad29af4dadb", "chunk": "diff --git a/core/src/main/java/org/apache/druid/timeline/partition/PartialShardSpec.java b/core/src/main/java/org/apache/druid/timeline/partition/PartialShardSpec.java\nindex 9ba9ac579c..6afaa93947 100644\n--- a/core/src/main/java/org/apache/druid/timeline/partition/PartialShardSpec.java\n+++ b/core/src/main/java/org/apache/druid/timeline/partition/PartialShardSpec.java\n\n@@ -28,11 +28,12 @@ import com.fasterxml.jackson.databind.ObjectMapper;\n import javax.annotation.Nullable;\n \n /**\n- * Class to contain all information of a {@link ShardSpec} except for the partition ID.\n- * This class is used when the segment allocation is coordinated by the Overlord; when appending segments to an\n- * existing datasource (either streaming ingestion or batch append) or when using segment locking.\n- * The ingestion tasks send all information required for allocating a new segment using this class and the Overlord\n- * determins the partition ID to create a new segment.\n+ * This interface is used in the segment allocation protocol when it is coordinated by the Overlord; when appending\n+ * segments to an existing datasource (either streaming ingestion or batch append) or any case when segment\n+ * lock is used. The implementations of this interface contain all information of the corresponding {@link ShardSpec}\n+ * except the partition ID.\n+ * The ingestion tasks send all information required for allocating a new segment using this interface and the Overlord\n+ * determines the partition ID to create a new segment.\n  */\n @JsonTypeInfo(use = JsonTypeInfo.Id.NAME, property = \"type\")\n @JsonSubTypes({\n"}}, {"oid": "42e37e2e85f58af0b0da4c7fcf6cfad29af4dadb", "url": "https://github.com/apache/druid/commit/42e37e2e85f58af0b0da4c7fcf6cfad29af4dadb", "message": "Address comments", "committedDate": "2020-06-10T23:51:06Z", "type": "commit"}, {"oid": "d5e197ea19b23d8cd68d61d9c5bb12da66a53332", "url": "https://github.com/apache/druid/commit/d5e197ea19b23d8cd68d61d9c5bb12da66a53332", "message": "fix tests", "committedDate": "2020-06-11T00:20:19Z", "type": "commit"}, {"oid": "99842f9d4793e185ab5c156ea1ff66b8ee187737", "url": "https://github.com/apache/druid/commit/99842f9d4793e185ab5c156ea1ff66b8ee187737", "message": "fix json serde, add tests", "committedDate": "2020-06-11T01:13:07Z", "type": "commit"}, {"oid": "b2222b9a6596a88a9f44aa966adc364ba087c10e", "url": "https://github.com/apache/druid/commit/b2222b9a6596a88a9f44aa966adc364ba087c10e", "message": "checkstyle", "committedDate": "2020-06-11T03:18:48Z", "type": "commit"}]}