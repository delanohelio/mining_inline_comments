{"pr_number": 9698, "pr_title": "fixes for inline subqueries when multi-value dimension is present", "pr_createdAt": "2020-04-14T00:47:36Z", "pr_url": "https://github.com/apache/druid/pull/9698", "timeline": [{"oid": "c10dfc8423c502c8825f47b79ec5375d32ae4ec0", "url": "https://github.com/apache/druid/commit/c10dfc8423c502c8825f47b79ec5375d32ae4ec0", "message": "fixes for inline subqueries when multi-value dimension is present", "committedDate": "2020-04-13T23:36:48Z", "type": "commit"}, {"oid": "9c05b0434848b96c23eb5ff71658f3d6526213d0", "url": "https://github.com/apache/druid/commit/9c05b0434848b96c23eb5ff71658f3d6526213d0", "message": "fix test", "committedDate": "2020-04-14T01:40:19Z", "type": "commit"}, {"oid": "ce05094e62d588db41b8f3d3dc8ff4b536c6524c", "url": "https://github.com/apache/druid/commit/ce05094e62d588db41b8f3d3dc8ff4b536c6524c", "message": "allow missing capabilities for vectorized group by queries to be treated as single dims since it means that column doesnt exist", "committedDate": "2020-04-14T04:28:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwNzM3NA==", "url": "https://github.com/apache/druid/pull/9698#discussion_r410507374", "bodyText": "nit: maybe nice to comment when columnCapabilities can be null?", "author": "jihoonson", "createdAt": "2020-04-17T23:00:39Z", "path": "processing/src/main/java/org/apache/druid/query/topn/TopNQueryEngine.java", "diffHunk": "@@ -132,7 +132,7 @@ private TopNMapFn getMapFn(\n       topNAlgorithm = new TimeExtractionTopNAlgorithm(adapter, query);\n     } else if (selector.isHasExtractionFn()) {\n       topNAlgorithm = new HeapBasedTopNAlgorithm(adapter, query);\n-    } else if (columnCapabilities != null && !(columnCapabilities.getType() == ValueType.STRING\n+    } else if (columnCapabilities == null || !(columnCapabilities.getType() == ValueType.STRING", "originalCommit": "ce05094e62d588db41b8f3d3dc8ff4b536c6524c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQ4NDEzMw==", "url": "https://github.com/apache/druid/pull/9698#discussion_r412484133", "bodyText": "added additional information to existing comment", "author": "clintropolis", "createdAt": "2020-04-21T20:53:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwNzM3NA=="}], "type": "inlineReview", "revised_code": {"commit": "238d32685b7c6777288c6c5ded6fcacf93374c0a", "chunk": "diff --git a/processing/src/main/java/org/apache/druid/query/topn/TopNQueryEngine.java b/processing/src/main/java/org/apache/druid/query/topn/TopNQueryEngine.java\nindex 3b247f5c6b..1d1bccdd7b 100644\n--- a/processing/src/main/java/org/apache/druid/query/topn/TopNQueryEngine.java\n+++ b/processing/src/main/java/org/apache/druid/query/topn/TopNQueryEngine.java\n\n@@ -134,7 +134,8 @@ public class TopNQueryEngine\n       topNAlgorithm = new HeapBasedTopNAlgorithm(adapter, query);\n     } else if (columnCapabilities == null || !(columnCapabilities.getType() == ValueType.STRING\n                                                && columnCapabilities.isDictionaryEncoded())) {\n-      // Use HeapBasedTopNAlgorithm for non-Strings and for non-dictionary-encoded Strings.\n+      // Use HeapBasedTopNAlgorithm for non-Strings and for non-dictionary-encoded Strings, and for things we don't know\n+      // which can happen for 'inline' data sources when this is run on the broker\n       topNAlgorithm = new HeapBasedTopNAlgorithm(adapter, query);\n     } else if (query.getDimensionSpec().getOutputType() != ValueType.STRING) {\n       // Use HeapBasedTopNAlgorithm when the dimension output type is a non-String. (It's like an extractionFn: there can be\n"}}, {"oid": "238d32685b7c6777288c6c5ded6fcacf93374c0a", "url": "https://github.com/apache/druid/commit/238d32685b7c6777288c6c5ded6fcacf93374c0a", "message": "add comment", "committedDate": "2020-04-21T20:53:14Z", "type": "commit"}]}