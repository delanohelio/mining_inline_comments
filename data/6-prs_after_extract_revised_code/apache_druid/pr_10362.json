{"pr_number": 10362, "pr_title": "Fix negative queuedSize problem in CuratorLoadQueuePeon", "pr_createdAt": "2020-09-06T14:37:42Z", "pr_url": "https://github.com/apache/druid/pull/10362", "timeline": [{"oid": "9aa57a1e0e43a6bc513405765e3d84421ec269a0", "url": "https://github.com/apache/druid/commit/9aa57a1e0e43a6bc513405765e3d84421ec269a0", "message": "fix negative queuedSize problem in CuratorLoadQueuePeon", "committedDate": "2020-09-06T14:00:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA1Njc1Ng==", "url": "https://github.com/apache/druid/pull/10362#discussion_r491056756", "bodyText": "Instead of this, would it be better to have a separate countdown latch of size 2 and decrement it in the CuratorLoadQueuePeon callback and do an Assert with awaitLatch?", "author": "a2l007", "createdAt": "2020-09-18T16:19:49Z", "path": "server/src/test/java/org/apache/druid/server/coordinator/LoadQueuePeonTest.java", "diffHunk": "@@ -336,6 +336,12 @@ public void execute()\n     Assert.assertTrue(timing.forWaiting().awaitLatch(segmentLoadedSignal));\n     Assert.assertEquals(0, loadQueuePeon.getSegmentsToLoad().size());\n     Assert.assertEquals(0L, loadQueuePeon.getLoadQueueSize());\n+    curator.delete().guaranteed().forPath(loadRequestPath);\n+    while (null != curator.checkExists().forPath(loadRequestPath)) {\n+      Thread.sleep(5);", "originalCommit": "9aa57a1e0e43a6bc513405765e3d84421ec269a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkzNDcwMQ==", "url": "https://github.com/apache/druid/pull/10362#discussion_r491934701", "bodyText": "Done", "author": "viongpanzi", "createdAt": "2020-09-21T10:18:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA1Njc1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "6a75ad49546242efd9bf8aa0b9d9023fb0b11135", "chunk": "diff --git a/server/src/test/java/org/apache/druid/server/coordinator/LoadQueuePeonTest.java b/server/src/test/java/org/apache/druid/server/coordinator/LoadQueuePeonTest.java\nindex 9c88c0577a..9020264818 100644\n--- a/server/src/test/java/org/apache/druid/server/coordinator/LoadQueuePeonTest.java\n+++ b/server/src/test/java/org/apache/druid/server/coordinator/LoadQueuePeonTest.java\n\n@@ -337,9 +345,7 @@ public class LoadQueuePeonTest extends CuratorTestBase\n     Assert.assertEquals(0, loadQueuePeon.getSegmentsToLoad().size());\n     Assert.assertEquals(0L, loadQueuePeon.getLoadQueueSize());\n     curator.delete().guaranteed().forPath(loadRequestPath);\n-    while (null != curator.checkExists().forPath(loadRequestPath)) {\n-      Thread.sleep(5);\n-    }\n+    Assert.assertTrue(timing.forWaiting().awaitLatch(loadRequestRemoveSignal));\n     Assert.assertEquals(0, loadQueuePeon.getSegmentsToLoad().size());\n     Assert.assertEquals(0L, loadQueuePeon.getLoadQueueSize());\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA1NjkxMQ==", "url": "https://github.com/apache/druid/pull/10362#discussion_r491056911", "bodyText": "Could you please add a comment here?", "author": "a2l007", "createdAt": "2020-09-18T16:20:06Z", "path": "server/src/main/java/org/apache/druid/server/coordinator/CuratorLoadQueuePeon.java", "diffHunk": "@@ -302,8 +302,9 @@ private void actionCompleted(SegmentHolder segmentHolder)\n   {\n     switch (segmentHolder.getType()) {\n       case LOAD:\n-        segmentsToLoad.remove(segmentHolder.getSegment());\n-        queuedSize.addAndGet(-segmentHolder.getSegmentSize());\n+        if (null != segmentsToLoad.remove(segmentHolder.getSegment())) {", "originalCommit": "9aa57a1e0e43a6bc513405765e3d84421ec269a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkzNDQ2MQ==", "url": "https://github.com/apache/druid/pull/10362#discussion_r491934461", "bodyText": "Done", "author": "viongpanzi", "createdAt": "2020-09-21T10:18:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA1NjkxMQ=="}], "type": "inlineReview", "revised_code": {"commit": "6a75ad49546242efd9bf8aa0b9d9023fb0b11135", "chunk": "diff --git a/server/src/main/java/org/apache/druid/server/coordinator/CuratorLoadQueuePeon.java b/server/src/main/java/org/apache/druid/server/coordinator/CuratorLoadQueuePeon.java\nindex 86a7af5518..b96213e804 100644\n--- a/server/src/main/java/org/apache/druid/server/coordinator/CuratorLoadQueuePeon.java\n+++ b/server/src/main/java/org/apache/druid/server/coordinator/CuratorLoadQueuePeon.java\n\n@@ -302,6 +302,9 @@ public class CuratorLoadQueuePeon extends LoadQueuePeon\n   {\n     switch (segmentHolder.getType()) {\n       case LOAD:\n+        // When load failed a segment will be removed from the segmentsToLoad twice and\n+        // null value will be returned at the second time in which case queueSize may be negitive.\n+        // See https://github.com/apache/druid/pull/10362 for more details.\n         if (null != segmentsToLoad.remove(segmentHolder.getSegment())) {\n           queuedSize.addAndGet(-segmentHolder.getSegmentSize());\n         }\n"}}, {"oid": "6a75ad49546242efd9bf8aa0b9d9023fb0b11135", "url": "https://github.com/apache/druid/commit/6a75ad49546242efd9bf8aa0b9d9023fb0b11135", "message": "add comment and optimize test case", "committedDate": "2020-09-21T10:17:13Z", "type": "commit"}, {"oid": "e8d9d1d0c25031b2fa66e92a6ee2e1efd30961ed", "url": "https://github.com/apache/druid/commit/e8d9d1d0c25031b2fa66e92a6ee2e1efd30961ed", "message": "Merge remote-tracking branch 'upstream/master' into bug-fix-coordinator-negative-queue-size", "committedDate": "2020-09-21T12:10:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzU5NDA4MA==", "url": "https://github.com/apache/druid/pull/10362#discussion_r493594080", "bodyText": "Typo for negative", "author": "a2l007", "createdAt": "2020-09-23T13:34:13Z", "path": "server/src/main/java/org/apache/druid/server/coordinator/CuratorLoadQueuePeon.java", "diffHunk": "@@ -302,8 +302,12 @@ private void actionCompleted(SegmentHolder segmentHolder)\n   {\n     switch (segmentHolder.getType()) {\n       case LOAD:\n-        segmentsToLoad.remove(segmentHolder.getSegment());\n-        queuedSize.addAndGet(-segmentHolder.getSegmentSize());\n+        // When load failed a segment will be removed from the segmentsToLoad twice and\n+        // null value will be returned at the second time in which case queueSize may be negitive.", "originalCommit": "e8d9d1d0c25031b2fa66e92a6ee2e1efd30961ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA3NjM4Mw==", "url": "https://github.com/apache/druid/pull/10362#discussion_r494076383", "bodyText": "Fixed", "author": "viongpanzi", "createdAt": "2020-09-24T06:49:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzU5NDA4MA=="}], "type": "inlineReview", "revised_code": {"commit": "271fc0bfa931200edb481367c9cb0ecba4a4b8fb", "chunk": "diff --git a/server/src/main/java/org/apache/druid/server/coordinator/CuratorLoadQueuePeon.java b/server/src/main/java/org/apache/druid/server/coordinator/CuratorLoadQueuePeon.java\nindex b96213e804..85573b6f13 100644\n--- a/server/src/main/java/org/apache/druid/server/coordinator/CuratorLoadQueuePeon.java\n+++ b/server/src/main/java/org/apache/druid/server/coordinator/CuratorLoadQueuePeon.java\n\n@@ -303,7 +303,7 @@ public class CuratorLoadQueuePeon extends LoadQueuePeon\n     switch (segmentHolder.getType()) {\n       case LOAD:\n         // When load failed a segment will be removed from the segmentsToLoad twice and\n-        // null value will be returned at the second time in which case queueSize may be negitive.\n+        // null value will be returned at the second time in which case queueSize may be negative.\n         // See https://github.com/apache/druid/pull/10362 for more details.\n         if (null != segmentsToLoad.remove(segmentHolder.getSegment())) {\n           queuedSize.addAndGet(-segmentHolder.getSegmentSize());\n"}}, {"oid": "271fc0bfa931200edb481367c9cb0ecba4a4b8fb", "url": "https://github.com/apache/druid/commit/271fc0bfa931200edb481367c9cb0ecba4a4b8fb", "message": "fix typo", "committedDate": "2020-09-24T06:48:00Z", "type": "commit"}, {"oid": "18cb5123031a534d483dc034c6b5c1054500b58a", "url": "https://github.com/apache/druid/commit/18cb5123031a534d483dc034c6b5c1054500b58a", "message": "Merge remote-tracking branch 'upstream/master' into bug-fix-coordinator-negative-queue-size", "committedDate": "2020-09-24T06:48:46Z", "type": "commit"}, {"oid": "0c469dae4d232749ae1ad2a7b1c05c2f3f339098", "url": "https://github.com/apache/druid/commit/0c469dae4d232749ae1ad2a7b1c05c2f3f339098", "message": "Merge remote-tracking branch 'upstream/master' into bug-fix-coordinator-negative-queue-size", "committedDate": "2020-09-26T12:06:07Z", "type": "commit"}]}