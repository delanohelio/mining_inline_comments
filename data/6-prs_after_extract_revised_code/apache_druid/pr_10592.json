{"pr_number": 10592, "pr_title": "Allow missing intervals for Parallel task with hash/range partitioning", "pr_createdAt": "2020-11-18T02:26:16Z", "pr_url": "https://github.com/apache/druid/pull/10592", "timeline": [{"oid": "5b31ba4c9b6704ad02f66c6ca7a2c4bade120beb", "url": "https://github.com/apache/druid/commit/5b31ba4c9b6704ad02f66c6ca7a2c4bade120beb", "message": "Allow missing intervals for Parallel task", "committedDate": "2020-11-18T02:20:18Z", "type": "commit"}, {"oid": "ff116a436d03ea5edccb6c1777e1c8121f51cc92", "url": "https://github.com/apache/druid/commit/ff116a436d03ea5edccb6c1777e1c8121f51cc92", "message": "fix row filter", "committedDate": "2020-11-18T02:34:19Z", "type": "commit"}, {"oid": "9bef2ff2a03384f77d312ff8a13cf7f98da6f3b0", "url": "https://github.com/apache/druid/commit/9bef2ff2a03384f77d312ff8a13cf7f98da6f3b0", "message": "fix tests", "committedDate": "2020-11-18T05:19:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTg3NjYzOA==", "url": "https://github.com/apache/druid/pull/10592#discussion_r525876638", "bodyText": "this log statement needs a change now", "author": "abhishekagarwal87", "createdAt": "2020-11-18T07:55:03Z", "path": "indexing-service/src/main/java/org/apache/druid/indexing/common/task/batch/parallel/ParallelIndexSupervisorTask.java", "diffHunk": "@@ -541,9 +561,12 @@ private TaskStatus runHashPartitionMultiPhaseParallel(TaskToolbox toolbox) throw\n       );\n     }\n \n-    final Integer numShardsOverride;\n+    final Map<Interval, Integer> intervalToNumShards;\n     HashedPartitionsSpec partitionsSpec = (HashedPartitionsSpec) ingestionSchema.getTuningConfig().getPartitionsSpec();\n-    if (partitionsSpec.getNumShards() == null) {\n+    final boolean needsInputSampling =\n+        partitionsSpec.getNumShards() == null\n+        || ingestionSchemaToUse.getDataSchema().getGranularitySpec().inputIntervals().isEmpty();\n+    if (needsInputSampling) {\n       // 0. need to determine numShards by scanning the data\n       LOG.info(\"numShards is unspecified, beginning %s phase.\", PartialDimensionCardinalityTask.TYPE);", "originalCommit": "9bef2ff2a03384f77d312ff8a13cf7f98da6f3b0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM2NjY5MA==", "url": "https://github.com/apache/druid/pull/10592#discussion_r526366690", "bodyText": "\ud83d\udc4d", "author": "jihoonson", "createdAt": "2020-11-18T19:35:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTg3NjYzOA=="}], "type": "inlineReview", "revised_code": {"commit": "ec3b49411828db74c1db36eaa719af8335138bf3", "chunk": "diff --git a/indexing-service/src/main/java/org/apache/druid/indexing/common/task/batch/parallel/ParallelIndexSupervisorTask.java b/indexing-service/src/main/java/org/apache/druid/indexing/common/task/batch/parallel/ParallelIndexSupervisorTask.java\nindex 1db7e0e998..3d272b4381 100644\n--- a/indexing-service/src/main/java/org/apache/druid/indexing/common/task/batch/parallel/ParallelIndexSupervisorTask.java\n+++ b/indexing-service/src/main/java/org/apache/druid/indexing/common/task/batch/parallel/ParallelIndexSupervisorTask.java\n\n@@ -567,8 +567,8 @@ public class ParallelIndexSupervisorTask extends AbstractBatchIndexTask implemen\n         partitionsSpec.getNumShards() == null\n         || ingestionSchemaToUse.getDataSchema().getGranularitySpec().inputIntervals().isEmpty();\n     if (needsInputSampling) {\n-      // 0. need to determine numShards by scanning the data\n-      LOG.info(\"numShards is unspecified, beginning %s phase.\", PartialDimensionCardinalityTask.TYPE);\n+      // 0. need to determine intervals and numShards by scanning the data\n+      LOG.info(\"Needs to determine intervals or numShards, beginning %s phase.\", PartialDimensionCardinalityTask.TYPE);\n       ParallelIndexTaskRunner<PartialDimensionCardinalityTask, DimensionCardinalityReport> cardinalityRunner =\n           createRunner(\n               toolbox,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTg3OTk3Ng==", "url": "https://github.com/apache/druid/pull/10592#discussion_r525879976", "bodyText": "is there an equivalent info being logged somewhere now?", "author": "abhishekagarwal87", "createdAt": "2020-11-18T08:01:21Z", "path": "indexing-service/src/main/java/org/apache/druid/indexing/common/task/batch/parallel/ParallelIndexSupervisorTask.java", "diffHunk": "@@ -552,38 +575,50 @@ private TaskStatus runHashPartitionMultiPhaseParallel(TaskToolbox toolbox) throw\n               this::createPartialDimensionCardinalityRunner\n           );\n \n-      if (cardinalityRunner == null) {\n-        throw new ISE(\"Could not create cardinality runner for hash partitioning.\");\n-      }\n-\n       state = runNextPhase(cardinalityRunner);\n       if (state.isFailure()) {\n         return TaskStatus.failure(getId());\n       }\n \n-      int effectiveMaxRowsPerSegment = partitionsSpec.getMaxRowsPerSegment() == null\n-                                       ? PartitionsSpec.DEFAULT_MAX_ROWS_PER_SEGMENT\n-                                       : partitionsSpec.getMaxRowsPerSegment();\n-      LOG.info(\"effective maxRowsPerSegment is: \" + effectiveMaxRowsPerSegment);\n+      if (cardinalityRunner.getReports().isEmpty()) {\n+        String msg = \"No valid rows for hash partitioning.\"\n+                     + \" All rows may have invalid timestamps or have been filtered out.\";\n+        LOG.warn(msg);\n+        return TaskStatus.success(getId(), msg);\n+      }\n+\n+      if (partitionsSpec.getNumShards() == null) {\n+        int effectiveMaxRowsPerSegment = partitionsSpec.getMaxRowsPerSegment() == null\n+                                         ? PartitionsSpec.DEFAULT_MAX_ROWS_PER_SEGMENT\n+                                         : partitionsSpec.getMaxRowsPerSegment();\n+        LOG.info(\"effective maxRowsPerSegment is: \" + effectiveMaxRowsPerSegment);\n \n-      if (cardinalityRunner.getReports() == null) {\n-        throw new ISE(\"Could not determine cardinalities for hash partitioning.\");\n+        intervalToNumShards = determineNumShardsFromCardinalityReport(\n+            cardinalityRunner.getReports().values(),\n+            effectiveMaxRowsPerSegment\n+        );\n+      } else {\n+        intervalToNumShards = CollectionUtils.mapValues(\n+            mergeCardinalityReports(cardinalityRunner.getReports().values()),\n+            k -> partitionsSpec.getNumShards()\n+        );\n       }\n-      numShardsOverride = determineNumShardsFromCardinalityReport(\n-          cardinalityRunner.getReports().values(),\n-          effectiveMaxRowsPerSegment\n-      );\n \n-      LOG.info(\"Automatically determined numShards: \" + numShardsOverride);", "originalCommit": "9bef2ff2a03384f77d312ff8a13cf7f98da6f3b0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM2NjY5Ng==", "url": "https://github.com/apache/druid/pull/10592#discussion_r526366696", "bodyText": "No, I didn't add one for intervalToNumShards because it could have lots of intervals.", "author": "jihoonson", "createdAt": "2020-11-18T19:35:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTg3OTk3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "ec3b49411828db74c1db36eaa719af8335138bf3", "chunk": "diff --git a/indexing-service/src/main/java/org/apache/druid/indexing/common/task/batch/parallel/ParallelIndexSupervisorTask.java b/indexing-service/src/main/java/org/apache/druid/indexing/common/task/batch/parallel/ParallelIndexSupervisorTask.java\nindex 1db7e0e998..3d272b4381 100644\n--- a/indexing-service/src/main/java/org/apache/druid/indexing/common/task/batch/parallel/ParallelIndexSupervisorTask.java\n+++ b/indexing-service/src/main/java/org/apache/druid/indexing/common/task/batch/parallel/ParallelIndexSupervisorTask.java\n\n@@ -567,8 +567,8 @@ public class ParallelIndexSupervisorTask extends AbstractBatchIndexTask implemen\n         partitionsSpec.getNumShards() == null\n         || ingestionSchemaToUse.getDataSchema().getGranularitySpec().inputIntervals().isEmpty();\n     if (needsInputSampling) {\n-      // 0. need to determine numShards by scanning the data\n-      LOG.info(\"numShards is unspecified, beginning %s phase.\", PartialDimensionCardinalityTask.TYPE);\n+      // 0. need to determine intervals and numShards by scanning the data\n+      LOG.info(\"Needs to determine intervals or numShards, beginning %s phase.\", PartialDimensionCardinalityTask.TYPE);\n       ParallelIndexTaskRunner<PartialDimensionCardinalityTask, DimensionCardinalityReport> cardinalityRunner =\n           createRunner(\n               toolbox,\n"}}, {"oid": "ec3b49411828db74c1db36eaa719af8335138bf3", "url": "https://github.com/apache/druid/commit/ec3b49411828db74c1db36eaa719af8335138bf3", "message": "fix log", "committedDate": "2020-11-18T19:34:57Z", "type": "commit"}]}