{"pr_number": 10280, "pr_title": "recreate the balancer executor only when needed", "pr_createdAt": "2020-08-14T07:01:58Z", "pr_url": "https://github.com/apache/druid/pull/10280", "timeline": [{"oid": "babe78eafee7a70c996eeecab946a933b4746a07", "url": "https://github.com/apache/druid/commit/babe78eafee7a70c996eeecab946a933b4746a07", "message": "recreate the balancer executor only when needed", "committedDate": "2020-08-14T06:58:47Z", "type": "commit"}, {"oid": "b92157c1427b373243ba0ed8229decb3d5332804", "url": "https://github.com/apache/druid/commit/b92157c1427b373243ba0ed8229decb3d5332804", "message": "fix UT error", "committedDate": "2020-08-14T18:18:29Z", "type": "commit"}, {"oid": "77b81b6bef3e62d48a0565a1cc7379c2a1ddfafd", "url": "https://github.com/apache/druid/commit/77b81b6bef3e62d48a0565a1cc7379c2a1ddfafd", "message": "Merge branch 'master' into druid-10273", "committedDate": "2020-08-14T21:15:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTE0NjIyNA==", "url": "https://github.com/apache/druid/pull/10280#discussion_r471146224", "bodyText": "do we need to worry about abandoning resources after removing this? Should the exec possibly be shutdown in stopBeingLeader() in your patch?", "author": "capistrant", "createdAt": "2020-08-16T18:56:58Z", "path": "server/src/main/java/org/apache/druid/server/coordinator/DruidCoordinator.java", "diffHunk": "@@ -733,11 +762,24 @@ public void run()\n       catch (Exception e) {\n         log.makeAlert(e, \"Caught exception, ignoring so that schedule keeps going.\").emit();\n       }\n-      finally {\n-        if (balancerExec != null) {\n-          balancerExec.shutdownNow();", "originalCommit": "77b81b6bef3e62d48a0565a1cc7379c2a1ddfafd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ebd0666acee5e3cc46186626755278d42df1ce32", "chunk": "diff --git a/server/src/main/java/org/apache/druid/server/coordinator/DruidCoordinator.java b/server/src/main/java/org/apache/druid/server/coordinator/DruidCoordinator.java\nindex 5329e88fc9..70a2a9c21f 100644\n--- a/server/src/main/java/org/apache/druid/server/coordinator/DruidCoordinator.java\n+++ b/server/src/main/java/org/apache/druid/server/coordinator/DruidCoordinator.java\n\n@@ -763,24 +793,6 @@ public class DruidCoordinator\n         log.makeAlert(e, \"Caught exception, ignoring so that schedule keeps going.\").emit();\n       }\n     }\n-\n-    /**\n-     * This method should be used for only testing.\n-     */\n-    @VisibleForTesting\n-    public int getCachedBalancerThreadNumber()\n-    {\n-      return cachedBalancerThreadNumber;\n-    }\n-\n-    /**\n-     * This method should be used for only testing.\n-     */\n-    @VisibleForTesting\n-    public ListeningExecutorService getBalancerExec()\n-    {\n-      return balancerExec;\n-    }\n   }\n \n   /**\n"}}, {"oid": "ebd0666acee5e3cc46186626755278d42df1ce32", "url": "https://github.com/apache/druid/commit/ebd0666acee5e3cc46186626755278d42df1ce32", "message": "shutdown the balancer executor in stopBeingLeader and stop", "committedDate": "2020-08-18T06:02:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE0NTAyMg==", "url": "https://github.com/apache/druid/pull/10280#discussion_r485145022", "bodyText": "I see DutiesRunnable used to be public with a protected constructor but was flipped to private/private in pull 9644 ... Now we are flipping the class and constructor to protected. I want to make sure @maytasm sees this PR and can comment on the idea of going back to protected from private.", "author": "capistrant", "createdAt": "2020-09-08T19:23:44Z", "path": "server/src/main/java/org/apache/druid/server/coordinator/DruidCoordinator.java", "diffHunk": "@@ -647,22 +678,53 @@ private void stopBeingLeader()\n     return ImmutableList.of(compactSegments);\n   }\n \n-  private class DutiesRunnable implements Runnable\n+  protected class DutiesRunnable implements Runnable", "originalCommit": "ebd0666acee5e3cc46186626755278d42df1ce32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY3NzY0OQ==", "url": "https://github.com/apache/druid/pull/10280#discussion_r486677649", "bodyText": "LGTM. Maybe add @VisibleForTesting too", "author": "maytasm", "createdAt": "2020-09-10T22:54:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE0NTAyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njc2MTMwNw==", "url": "https://github.com/apache/druid/pull/10280#discussion_r486761307", "bodyText": "added, and thanks for your time.", "author": "ArvinZheng", "createdAt": "2020-09-11T04:06:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE0NTAyMg=="}], "type": "inlineReview", "revised_code": {"commit": "1e502cb45efd86ff505976ce0b4df73bf2ce25f1", "chunk": "diff --git a/server/src/main/java/org/apache/druid/server/coordinator/DruidCoordinator.java b/server/src/main/java/org/apache/druid/server/coordinator/DruidCoordinator.java\nindex 70a2a9c21f..d897fde7c6 100644\n--- a/server/src/main/java/org/apache/druid/server/coordinator/DruidCoordinator.java\n+++ b/server/src/main/java/org/apache/druid/server/coordinator/DruidCoordinator.java\n\n@@ -683,8 +683,6 @@ public class DruidCoordinator\n     private final long startTimeNanos = System.nanoTime();\n     private final List<CoordinatorDuty> duties;\n     private final int startingLeaderCounter;\n-    //private int cachedBalancerThreadNumber;\n-    //private ListeningExecutorService balancerExec;\n \n     protected DutiesRunnable(List<CoordinatorDuty> duties, final int startingLeaderCounter)\n     {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIwNTY2MA==", "url": "https://github.com/apache/druid/pull/10280#discussion_r485205660", "bodyText": "unused variables should be removed instead of commented", "author": "capistrant", "createdAt": "2020-09-08T21:27:22Z", "path": "server/src/main/java/org/apache/druid/server/coordinator/DruidCoordinator.java", "diffHunk": "@@ -653,8 +683,8 @@ private void stopBeingLeader()\n     private final long startTimeNanos = System.nanoTime();\n     private final List<CoordinatorDuty> duties;\n     private final int startingLeaderCounter;\n-    private int cachedBalancerThreadNumber;\n-    private ListeningExecutorService balancerExec;\n+    //private int cachedBalancerThreadNumber;", "originalCommit": "ebd0666acee5e3cc46186626755278d42df1ce32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkxMzY4NQ==", "url": "https://github.com/apache/druid/pull/10280#discussion_r485913685", "bodyText": "oh, good catch, will remove them, thanks for reviewing", "author": "ArvinZheng", "createdAt": "2020-09-09T20:49:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIwNTY2MA=="}], "type": "inlineReview", "revised_code": {"commit": "1e502cb45efd86ff505976ce0b4df73bf2ce25f1", "chunk": "diff --git a/server/src/main/java/org/apache/druid/server/coordinator/DruidCoordinator.java b/server/src/main/java/org/apache/druid/server/coordinator/DruidCoordinator.java\nindex 70a2a9c21f..d897fde7c6 100644\n--- a/server/src/main/java/org/apache/druid/server/coordinator/DruidCoordinator.java\n+++ b/server/src/main/java/org/apache/druid/server/coordinator/DruidCoordinator.java\n\n@@ -683,8 +683,6 @@ public class DruidCoordinator\n     private final long startTimeNanos = System.nanoTime();\n     private final List<CoordinatorDuty> duties;\n     private final int startingLeaderCounter;\n-    //private int cachedBalancerThreadNumber;\n-    //private ListeningExecutorService balancerExec;\n \n     protected DutiesRunnable(List<CoordinatorDuty> duties, final int startingLeaderCounter)\n     {\n"}}, {"oid": "1e502cb45efd86ff505976ce0b4df73bf2ce25f1", "url": "https://github.com/apache/druid/commit/1e502cb45efd86ff505976ce0b4df73bf2ce25f1", "message": "remove commented code", "committedDate": "2020-09-09T20:51:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY3Njg2Mg==", "url": "https://github.com/apache/druid/pull/10280#discussion_r486676862", "bodyText": "nit: comment is not needed since we already have @VisibleForTesting annotation", "author": "maytasm", "createdAt": "2020-09-10T22:52:24Z", "path": "server/src/main/java/org/apache/druid/server/coordinator/DruidCoordinator.java", "diffHunk": "@@ -483,6 +487,24 @@ public void moveSegment(\n     }\n   }\n \n+  /**\n+   * This method should be used for only testing.", "originalCommit": "1e502cb45efd86ff505976ce0b4df73bf2ce25f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njc2MTQyMg==", "url": "https://github.com/apache/druid/pull/10280#discussion_r486761422", "bodyText": "addressed", "author": "ArvinZheng", "createdAt": "2020-09-11T04:07:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY3Njg2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "85575950e46ea8ab767d0b63b9ea18ce1e9c4550", "chunk": "diff --git a/server/src/main/java/org/apache/druid/server/coordinator/DruidCoordinator.java b/server/src/main/java/org/apache/druid/server/coordinator/DruidCoordinator.java\nindex d897fde7c6..a406761445 100644\n--- a/server/src/main/java/org/apache/druid/server/coordinator/DruidCoordinator.java\n+++ b/server/src/main/java/org/apache/druid/server/coordinator/DruidCoordinator.java\n\n@@ -487,18 +487,12 @@ public class DruidCoordinator\n     }\n   }\n \n-  /**\n-   * This method should be used for only testing.\n-   */\n   @VisibleForTesting\n   public int getCachedBalancerThreadNumber()\n   {\n     return cachedBalancerThreadNumber;\n   }\n-\n-  /**\n-   * This method should be used for only testing.\n-   */\n+  \n   @VisibleForTesting\n   public ListeningExecutorService getBalancerExec()\n   {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY3Njk0Mw==", "url": "https://github.com/apache/druid/pull/10280#discussion_r486676943", "bodyText": "nit: same here as above", "author": "maytasm", "createdAt": "2020-09-10T22:52:38Z", "path": "server/src/main/java/org/apache/druid/server/coordinator/DruidCoordinator.java", "diffHunk": "@@ -483,6 +487,24 @@ public void moveSegment(\n     }\n   }\n \n+  /**\n+   * This method should be used for only testing.\n+   */\n+  @VisibleForTesting\n+  public int getCachedBalancerThreadNumber()\n+  {\n+    return cachedBalancerThreadNumber;\n+  }\n+\n+  /**\n+   * This method should be used for only testing.", "originalCommit": "1e502cb45efd86ff505976ce0b4df73bf2ce25f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njc2MTQzOQ==", "url": "https://github.com/apache/druid/pull/10280#discussion_r486761439", "bodyText": "addressed", "author": "ArvinZheng", "createdAt": "2020-09-11T04:07:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY3Njk0Mw=="}], "type": "inlineReview", "revised_code": {"commit": "85575950e46ea8ab767d0b63b9ea18ce1e9c4550", "chunk": "diff --git a/server/src/main/java/org/apache/druid/server/coordinator/DruidCoordinator.java b/server/src/main/java/org/apache/druid/server/coordinator/DruidCoordinator.java\nindex d897fde7c6..a406761445 100644\n--- a/server/src/main/java/org/apache/druid/server/coordinator/DruidCoordinator.java\n+++ b/server/src/main/java/org/apache/druid/server/coordinator/DruidCoordinator.java\n\n@@ -487,18 +487,12 @@ public class DruidCoordinator\n     }\n   }\n \n-  /**\n-   * This method should be used for only testing.\n-   */\n   @VisibleForTesting\n   public int getCachedBalancerThreadNumber()\n   {\n     return cachedBalancerThreadNumber;\n   }\n-\n-  /**\n-   * This method should be used for only testing.\n-   */\n+  \n   @VisibleForTesting\n   public ListeningExecutorService getBalancerExec()\n   {\n"}}, {"oid": "85575950e46ea8ab767d0b63b9ea18ce1e9c4550", "url": "https://github.com/apache/druid/commit/85575950e46ea8ab767d0b63b9ea18ce1e9c4550", "message": "remove comments", "committedDate": "2020-09-11T04:06:15Z", "type": "commit"}]}