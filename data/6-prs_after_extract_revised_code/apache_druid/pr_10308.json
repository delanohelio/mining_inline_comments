{"pr_number": 10308, "pr_title": "Move tools for indexing to TaskToolbox instead of injecting them in constructor", "pr_createdAt": "2020-08-21T22:26:07Z", "pr_url": "https://github.com/apache/druid/pull/10308", "timeline": [{"oid": "67d20eb8322a87eb1cd9e40e7dc9258c09b47204", "url": "https://github.com/apache/druid/commit/67d20eb8322a87eb1cd9e40e7dc9258c09b47204", "message": "Move tools for indexing to TaskToolbox instead of injecting them in constructor", "committedDate": "2020-08-21T22:16:52Z", "type": "commit"}, {"oid": "a86481d7cfaf01ee7fe0393c9118939155c8643d", "url": "https://github.com/apache/druid/commit/a86481d7cfaf01ee7fe0393c9118939155c8643d", "message": "oops, other changes", "committedDate": "2020-08-21T22:33:27Z", "type": "commit"}, {"oid": "bc30fa94586e68648f5c8d2d25e04c303a20e8d0", "url": "https://github.com/apache/druid/commit/bc30fa94586e68648f5c8d2d25e04c303a20e8d0", "message": "fix test", "committedDate": "2020-08-24T21:05:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjkxMTYxNQ==", "url": "https://github.com/apache/druid/pull/10308#discussion_r476911615", "bodyText": "Could this be javax.annotation.Nonnull instead? That seems more common in the codebase, and these objects don't really seem \"monotonic\"", "author": "jon-wei", "createdAt": "2020-08-26T00:28:57Z", "path": "indexing-service/src/main/java/org/apache/druid/indexing/common/task/IndexTask.java", "diffHunk": "@@ -160,46 +156,33 @@ private static String makeGroupId(boolean isAppendToExisting, String dataSource)\n     }\n   }\n \n-  @JsonIgnore\n   private final IndexIngestionSpec ingestionSchema;\n \n-  @JsonIgnore\n   private IngestionState ingestionState;\n \n-  @JsonIgnore\n-  private final AuthorizerMapper authorizerMapper;\n-\n-  @JsonIgnore\n-  private final Optional<ChatHandlerProvider> chatHandlerProvider;\n+  private final CircularBuffer<Throwable> buildSegmentsSavedParseExceptions;\n \n-  @JsonIgnore\n-  private final RowIngestionMeters determinePartitionsMeters;\n+  private final CircularBuffer<Throwable> determinePartitionsSavedParseExceptions;\n \n-  @JsonIgnore\n-  private final RowIngestionMeters buildSegmentsMeters;\n+  @MonotonicNonNull", "originalCommit": "bc30fa94586e68648f5c8d2d25e04c303a20e8d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjkzNzU2Nw==", "url": "https://github.com/apache/druid/pull/10308#discussion_r476937567", "bodyText": "I think Nonnull and MonotonicNonNull are different. The javadoc of Nonnull says \"The annotated element must not be null. Annotated fields must not be null after construction has completed.\", while the one of MonotonicNonNull says \"Indicates that once the field (or variable) becomes non-null, it never becomes null again.\". For the variables annotated as MonotonicNonNull in this class, they are nulls when the class is constructed and initialized later in runTask(). Once they are initialized, they never become nulls again until the task is finished. So, I think MonotonicNonNull is more proper for these variables.", "author": "jihoonson", "createdAt": "2020-08-26T01:07:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjkxMTYxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njk0MTc1Ng==", "url": "https://github.com/apache/druid/pull/10308#discussion_r476941756", "bodyText": "Ah, I see, that's good then", "author": "jon-wei", "createdAt": "2020-08-26T01:13:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjkxMTYxNQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjkxNDczMQ==", "url": "https://github.com/apache/druid/pull/10308#discussion_r476914731", "bodyText": "Is this class currently used anywhere?", "author": "jon-wei", "createdAt": "2020-08-26T00:33:42Z", "path": "indexing-service/src/main/java/org/apache/druid/indexing/common/task/batch/parallel/PartialSegmentMergeTaskSuccessReport.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.indexing.common.task.batch.parallel;\n+\n+import org.apache.druid.timeline.DataSegment;\n+\n+import java.util.Set;\n+\n+public class PartialSegmentMergeTaskSuccessReport", "originalCommit": "bc30fa94586e68648f5c8d2d25e04c303a20e8d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjkzNzQ4NQ==", "url": "https://github.com/apache/druid/pull/10308#discussion_r476937485", "bodyText": "Oops, accidentally included.", "author": "jihoonson", "createdAt": "2020-08-26T01:07:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjkxNDczMQ=="}], "type": "inlineReview", "revised_code": {"commit": "60b8dad7bccf58c7dfb24083b66680c52dcbdf88", "chunk": "diff --git a/indexing-service/src/main/java/org/apache/druid/indexing/common/task/batch/parallel/PartialSegmentMergeTaskSuccessReport.java b/indexing-service/src/main/java/org/apache/druid/indexing/common/task/batch/parallel/PartialSegmentMergeTaskSuccessReport.java\ndeleted file mode 100644\nindex 3ba87068fb..0000000000\n--- a/indexing-service/src/main/java/org/apache/druid/indexing/common/task/batch/parallel/PartialSegmentMergeTaskSuccessReport.java\n+++ /dev/null\n\n@@ -1,47 +0,0 @@\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one\n- * or more contributor license agreements.  See the NOTICE file\n- * distributed with this work for additional information\n- * regarding copyright ownership.  The ASF licenses this file\n- * to you under the Apache License, Version 2.0 (the\n- * \"License\"); you may not use this file except in compliance\n- * with the License.  You may obtain a copy of the License at\n- *\n- *   http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing,\n- * software distributed under the License is distributed on an\n- * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n- * KIND, either express or implied.  See the License for the\n- * specific language governing permissions and limitations\n- * under the License.\n- */\n-\n-package org.apache.druid.indexing.common.task.batch.parallel;\n-\n-import org.apache.druid.timeline.DataSegment;\n-\n-import java.util.Set;\n-\n-public class PartialSegmentMergeTaskSuccessReport\n-{\n-  private final String taskId;\n-  private final Set<DataSegment> oldSegments;\n-  private final Set<DataSegment> newSegments;\n-\n-  // TODO: Total input/output bytes/rows\n-  // TODO: Num of disk spills, spill time (for tertiary partitioning)\n-\n-  // TODO: class for fetching. probably need more details than just fetchTime for fetches\n-\n-  public PartialSegmentMergeTaskSuccessReport(\n-      String taskId,\n-      Set<DataSegment> oldSegments,\n-      Set<DataSegment> newSegments\n-  )\n-  {\n-    this.taskId = taskId;\n-    this.oldSegments = oldSegments;\n-    this.newSegments = newSegments;\n-  }\n-}\n"}}, {"oid": "60b8dad7bccf58c7dfb24083b66680c52dcbdf88", "url": "https://github.com/apache/druid/commit/60b8dad7bccf58c7dfb24083b66680c52dcbdf88", "message": "unnecessary new file", "committedDate": "2020-08-26T00:54:37Z", "type": "commit"}, {"oid": "dcb8023425e9cd6fe98f8ebfce145bd516d6c8a8", "url": "https://github.com/apache/druid/commit/dcb8023425e9cd6fe98f8ebfce145bd516d6c8a8", "message": "fix test", "committedDate": "2020-08-26T19:03:34Z", "type": "commit"}, {"oid": "d7c6a48474ee771c0f79fe084627aeba462f912b", "url": "https://github.com/apache/druid/commit/d7c6a48474ee771c0f79fe084627aeba462f912b", "message": "Merge branch 'master' of github.com:apache/druid into toolbox-cleanup", "committedDate": "2020-08-26T20:47:35Z", "type": "commit"}, {"oid": "779c4c4fd26b545a15154f9e16b767c123337c45", "url": "https://github.com/apache/druid/commit/779c4c4fd26b545a15154f9e16b767c123337c45", "message": "fix build", "committedDate": "2020-08-26T21:17:34Z", "type": "commit"}, {"oid": "2c1d966975adbd8708eb13b8a46b8833b259f925", "url": "https://github.com/apache/druid/commit/2c1d966975adbd8708eb13b8a46b8833b259f925", "message": "Merge branch 'master' of github.com:apache/druid into toolbox-cleanup", "committedDate": "2020-08-26T21:32:54Z", "type": "commit"}]}