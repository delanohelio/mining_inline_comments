{"pr_number": 9525, "pr_title": "Azure deep storage does not work with datasource name containing non-ASCII chars", "pr_createdAt": "2020-03-17T08:16:55Z", "pr_url": "https://github.com/apache/druid/pull/9525", "timeline": [{"oid": "85d0bb75742008d42cf2912a630eef6d3cab23e3", "url": "https://github.com/apache/druid/commit/85d0bb75742008d42cf2912a630eef6d3cab23e3", "message": "Azure deep storage does not work with datasource name containing non-ASCII chars\n\nFixed a bug where recording the segment file location fails when\nusing Azure Deep Storage, if the datasource has any special\ncharacters", "committedDate": "2020-03-17T08:12:41Z", "type": "commit"}, {"oid": "b542a65c291e99a75704ffae707bd4b954196b32", "url": "https://github.com/apache/druid/commit/b542a65c291e99a75704ffae707bd4b954196b32", "message": "* update jacoco thresholds", "committedDate": "2020-03-18T22:28:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDczMzI0Mw==", "url": "https://github.com/apache/druid/pull/9525#discussion_r394733243", "bodyText": "Could you make the other makeLoadSpec delegate to this method instead of duplicating it?\n  @Override\n  public Map<String, Object> makeLoadSpec(URI uri)\n  {\n    return makeLoadSpec(segmentConfig.getContainer(), uri.toString());\n  }\n\nAlso, is it necessary to pass container in since both invocations are using the same value (if you make the suggested modification)?", "author": "clintropolis", "createdAt": "2020-03-19T01:08:40Z", "path": "extensions-core/azure-extensions/src/main/java/org/apache/druid/storage/azure/AzureDataSegmentPusher.java", "diffHunk": "@@ -186,12 +186,24 @@ DataSegment uploadDataSegment(\n \n     final DataSegment outSegment = segment\n         .withSize(size)\n-        .withLoadSpec(this.makeLoadSpec(new URI(azurePath)))\n+        .withLoadSpec(this.makeLoadSpec(segmentConfig.getContainer(), azurePath))\n         .withBinaryVersion(binaryVersion);\n \n     log.debug(\"Deleting file [%s]\", compressedSegmentData);\n     compressedSegmentData.delete();\n \n     return outSegment;\n   }\n+\n+  private Map<String, Object> makeLoadSpec(String container, String prefix)", "originalCommit": "b542a65c291e99a75704ffae707bd4b954196b32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDgzMTM1Nw==", "url": "https://github.com/apache/druid/pull/9525#discussion_r394831357", "bodyText": "done", "author": "zachjsh", "createdAt": "2020-03-19T07:23:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDczMzI0Mw=="}], "type": "inlineReview", "revised_code": {"commit": "01124d26ad8ac79e9e35e532ba47b173757ed3d5", "chunk": "diff --git a/extensions-core/azure-extensions/src/main/java/org/apache/druid/storage/azure/AzureDataSegmentPusher.java b/extensions-core/azure-extensions/src/main/java/org/apache/druid/storage/azure/AzureDataSegmentPusher.java\nindex beec9f37a3..461b107b16 100644\n--- a/extensions-core/azure-extensions/src/main/java/org/apache/druid/storage/azure/AzureDataSegmentPusher.java\n+++ b/extensions-core/azure-extensions/src/main/java/org/apache/druid/storage/azure/AzureDataSegmentPusher.java\n\n@@ -186,7 +179,7 @@ public class AzureDataSegmentPusher implements DataSegmentPusher\n \n     final DataSegment outSegment = segment\n         .withSize(size)\n-        .withLoadSpec(this.makeLoadSpec(segmentConfig.getContainer(), azurePath))\n+        .withLoadSpec(this.makeLoadSpec(azurePath))\n         .withBinaryVersion(binaryVersion);\n \n     log.debug(\"Deleting file [%s]\", compressedSegmentData);\n"}}, {"oid": "6a4c772599e99696dea40b1cfcd7bb16e53c3e06", "url": "https://github.com/apache/druid/commit/6a4c772599e99696dea40b1cfcd7bb16e53c3e06", "message": "Merge remote-tracking branch 'zach-druid/master' into IMPLY-2441", "committedDate": "2020-03-19T07:05:15Z", "type": "commit"}, {"oid": "01124d26ad8ac79e9e35e532ba47b173757ed3d5", "url": "https://github.com/apache/druid/commit/01124d26ad8ac79e9e35e532ba47b173757ed3d5", "message": "* resolve merge conflicts\n* address review comments", "committedDate": "2020-03-19T07:22:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI3MDc2MQ==", "url": "https://github.com/apache/druid/pull/9525#discussion_r395270761", "bodyText": "It looks like hadoop indexing would still call this method so it might have issues with funny characters, but I don't think it is worth refactoring to fix the issue at this point.", "author": "clintropolis", "createdAt": "2020-03-19T19:31:58Z", "path": "extensions-core/azure-extensions/src/main/java/org/apache/druid/storage/azure/AzureDataSegmentPusher.java", "diffHunk": "@@ -153,14 +153,7 @@ public DataSegment push(final File indexFilesDir, final DataSegment segment, fin\n   @Override\n   public Map<String, Object> makeLoadSpec(URI uri)\n   {\n-    return ImmutableMap.of(\n-        \"type\",\n-        AzureStorageDruidModule.SCHEME,\n-        \"containerName\",\n-        segmentConfig.getContainer(),\n-        \"blobPath\",\n-        uri.toString()\n-    );\n+    return makeLoadSpec(uri.toString());", "originalCommit": "01124d26ad8ac79e9e35e532ba47b173757ed3d5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}