{"pr_number": 10653, "pr_title": "Fix post-aggregator computation when used with subtotals", "pr_createdAt": "2020-12-08T12:08:03Z", "pr_url": "https://github.com/apache/druid/pull/10653", "timeline": [{"oid": "c69361b92fbdc78c5e37d9d625ed6a4cbde7514e", "url": "https://github.com/apache/druid/commit/c69361b92fbdc78c5e37d9d625ed6a4cbde7514e", "message": "Fix post-aggregator computation", "committedDate": "2020-12-08T06:35:14Z", "type": "commit"}, {"oid": "a7847a16944e2360956c40882c9209e6ec5252b6", "url": "https://github.com/apache/druid/commit/a7847a16944e2360956c40882c9209e6ec5252b6", "message": "remove commented code", "committedDate": "2020-12-08T11:21:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODU4NzI1Mg==", "url": "https://github.com/apache/druid/pull/10653#discussion_r538587252", "bodyText": "Why did you change this test case? (As opposed to introducing a new test case.)", "author": "gianm", "createdAt": "2020-12-08T16:46:09Z", "path": "sql/src/test/java/org/apache/druid/sql/calcite/CalciteQueryTest.java", "diffHunk": "@@ -12159,23 +12159,23 @@ public void testGroupingAggregatorWithPostAggregator() throws Exception\n     List<Object[]> resultList;\n     if (NullHandling.sqlCompatible()) {\n       resultList = ImmutableList.of(\n-          new Object[]{NULL_STRING, 2L, 0L, \"INDIVIDUAL\"},\n-          new Object[]{\"\", 1L, 0L, \"INDIVIDUAL\"},\n-          new Object[]{\"a\", 2L, 0L, \"INDIVIDUAL\"},\n-          new Object[]{\"abc\", 1L, 0L, \"INDIVIDUAL\"},\n+          new Object[]{NULL_STRING, 2L, 0L, NULL_STRING},\n+          new Object[]{\"\", 1L, 0L, \"\"},\n+          new Object[]{\"a\", 2L, 0L, \"a\"},\n+          new Object[]{\"abc\", 1L, 0L, \"abc\"},\n           new Object[]{NULL_STRING, 6L, 1L, \"ALL\"}\n       );\n     } else {\n       resultList = ImmutableList.of(\n-          new Object[]{\"\", 3L, 0L, \"INDIVIDUAL\"},\n-          new Object[]{\"a\", 2L, 0L, \"INDIVIDUAL\"},\n-          new Object[]{\"abc\", 1L, 0L, \"INDIVIDUAL\"},\n+          new Object[]{\"\", 3L, 0L, \"\"},\n+          new Object[]{\"a\", 2L, 0L, \"a\"},\n+          new Object[]{\"abc\", 1L, 0L, \"abc\"},\n           new Object[]{NULL_STRING, 6L, 1L, \"ALL\"}\n       );\n     }\n     testQuery(\n         \"SELECT dim2, SUM(cnt), GROUPING(dim2), \\n\"\n-        + \"CASE WHEN GROUPING(dim2) = 1 THEN 'ALL' ELSE 'INDIVIDUAL' END\\n\"\n+        + \"CASE WHEN GROUPING(dim2) = 1 THEN 'ALL' ELSE dim2 END\\n\"", "originalCommit": "c69361b92fbdc78c5e37d9d625ed6a4cbde7514e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODYxMjg4OA==", "url": "https://github.com/apache/druid/pull/10653#discussion_r538612888", "bodyText": "I wrote this test when I submitted the patch for the grouping function. I had wanted to write it this way (as is in PR) but couldn't because of the post-aggregation bug. Now changing it as I am fixing the bug. BTW There are two more tests for the grouping function.", "author": "abhishekagarwal87", "createdAt": "2020-12-08T17:08:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODU4NzI1Mg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODU4NzQ2NA==", "url": "https://github.com/apache/druid/pull/10653#discussion_r538587464", "bodyText": "Please don't include commented-out code.", "author": "gianm", "createdAt": "2020-12-08T16:46:22Z", "path": "processing/src/main/java/org/apache/druid/query/groupby/strategy/GroupByStrategyV2.java", "diffHunk": "@@ -442,8 +425,8 @@ public boolean doMergeResults(final GroupByQuery query)\n         }\n \n         GroupByQuery subtotalQuery = baseSubtotalQuery\n-            .withLimitSpec(subtotalQueryLimitSpec)\n-            .withDimensionSpecs(newDimensions);\n+            .withLimitSpec(subtotalQueryLimitSpec);\n+            //.withDimensionSpecs(newDimensions);", "originalCommit": "c69361b92fbdc78c5e37d9d625ed6a4cbde7514e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODYwMjUwMA==", "url": "https://github.com/apache/druid/pull/10653#discussion_r538602500", "bodyText": "Yup. I had removed it on my local but forgot to push.", "author": "abhishekagarwal87", "createdAt": "2020-12-08T16:59:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODU4NzQ2NA=="}], "type": "inlineReview", "revised_code": {"commit": "a21e287cc745caa957437e8bfee5b0ceba9ed025", "chunk": "diff --git a/processing/src/main/java/org/apache/druid/query/groupby/strategy/GroupByStrategyV2.java b/processing/src/main/java/org/apache/druid/query/groupby/strategy/GroupByStrategyV2.java\nindex 8a4673d58c..af452eb39c 100644\n--- a/processing/src/main/java/org/apache/druid/query/groupby/strategy/GroupByStrategyV2.java\n+++ b/processing/src/main/java/org/apache/druid/query/groupby/strategy/GroupByStrategyV2.java\n\n@@ -426,7 +426,6 @@ public class GroupByStrategyV2 implements GroupByStrategy\n \n         GroupByQuery subtotalQuery = baseSubtotalQuery\n             .withLimitSpec(subtotalQueryLimitSpec);\n-            //.withDimensionSpecs(newDimensions);\n \n         final GroupByRowProcessor.ResultSupplier resultSupplierOneFinal = resultSupplierOne;\n         if (Utils.isPrefix(subtotalSpec, queryDimNames)) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODU5MTA2Ng==", "url": "https://github.com/apache/druid/pull/10653#discussion_r538591066", "bodyText": "Is this concern no longer valid?\nIIRC, it was necessary because otherwise the ResultRows would be different lengths and so the final results wouldn't be correct.", "author": "gianm", "createdAt": "2020-12-08T16:49:32Z", "path": "processing/src/main/java/org/apache/druid/query/groupby/strategy/GroupByStrategyV2.java", "diffHunk": "@@ -408,27 +408,10 @@ public boolean doMergeResults(final GroupByQuery query)\n         // Dimension spec including dimension name and output name\n         final List<DimensionSpec> subTotalDimensionSpec = new ArrayList<>(dimsInSubtotalSpec.size());\n         final List<DimensionSpec> dimensions = query.getDimensions();\n-        final List<DimensionSpec> newDimensions = new ArrayList<>();\n \n-        for (int i = 0; i < dimensions.size(); i++) {\n-          DimensionSpec dimensionSpec = dimensions.get(i);\n+        for (DimensionSpec dimensionSpec : dimensions) {\n           if (dimsInSubtotalSpec.contains(dimensionSpec.getOutputName())) {\n-            newDimensions.add(\n-                new DefaultDimensionSpec(\n-                    dimensionSpec.getOutputName(),\n-                    dimensionSpec.getOutputName(),\n-                    dimensionSpec.getOutputType()\n-                )\n-            );\n             subTotalDimensionSpec.add(dimensionSpec);\n-          } else {\n-            // Insert dummy dimension so all subtotals queries have ResultRows with the same shape.", "originalCommit": "c69361b92fbdc78c5e37d9d625ed6a4cbde7514e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODYyMDg4NQ==", "url": "https://github.com/apache/druid/pull/10653#discussion_r538620885", "bodyText": "https://github.com/apache/druid/blob/master/processing/src/main/java/org/apache/druid/query/groupby/epinephelinae/RowBasedGrouperHelper.java#L581\nWe are still keeping all the original dimensions in the query. So result row size should be the same. I think you were concerned that the result should be null for dimensions not part of the subtotal. We are not carrying over the result for those dimensions so it should work out.\nhttps://github.com/apache/druid/blob/master/processing/src/main/java/org/apache/druid/query/groupby/epinephelinae/RowBasedGrouperHelper.java#L593", "author": "abhishekagarwal87", "createdAt": "2020-12-08T17:15:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODU5MTA2Ng=="}], "type": "inlineReview", "revised_code": null}, {"oid": "a21e287cc745caa957437e8bfee5b0ceba9ed025", "url": "https://github.com/apache/druid/commit/a21e287cc745caa957437e8bfee5b0ceba9ed025", "message": "Fix numeric null handling", "committedDate": "2020-12-14T19:53:12Z", "type": "commit"}, {"oid": "dbd6526ebef123b947d00207a697ddd5b927ddbc", "url": "https://github.com/apache/druid/commit/dbd6526ebef123b947d00207a697ddd5b927ddbc", "message": "Add test when subquery returns null long", "committedDate": "2020-12-15T08:13:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDk0NzI1Nw==", "url": "https://github.com/apache/druid/pull/10653#discussion_r544947257", "bodyText": "FYI, this change could cause a dip in performance when columns are actually strings and being read as a number. Since the parsing first happens in  isNull function and then again in getLong", "author": "abhishekagarwal87", "createdAt": "2020-12-17T09:41:56Z", "path": "processing/src/main/java/org/apache/druid/query/groupby/epinephelinae/RowBasedGrouperHelper.java", "diffHunk": "@@ -712,13 +712,13 @@ public InputRawSupplierColumnSelectorStrategy makeColumnSelectorStrategy(\n           return new StringInputRawSupplierColumnSelectorStrategy();\n         case LONG:\n           return (InputRawSupplierColumnSelectorStrategy<BaseLongColumnValueSelector>)\n-              columnSelector -> columnSelector::getLong;\n+              columnSelector -> () -> columnSelector.isNull() ? null : columnSelector.getLong();", "originalCommit": "dbd6526ebef123b947d00207a697ddd5b927ddbc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMzNjIxMQ==", "url": "https://github.com/apache/druid/pull/10653#discussion_r545336211", "bodyText": "IMO, the selectors themselves should ideally cache this computation, similar to the changes being made in #10614. Therefore, I think this change is OK, and if there are any issues it should be fixed at the selector level.", "author": "gianm", "createdAt": "2020-12-17T19:10:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDk0NzI1Nw=="}], "type": "inlineReview", "revised_code": null}]}