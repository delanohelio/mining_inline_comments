{"pr_number": 10091, "pr_title": "Make 0.19 brokers compatible with 0.18 router", "pr_createdAt": "2020-06-29T01:58:47Z", "pr_url": "https://github.com/apache/druid/pull/10091", "timeline": [{"oid": "f53edb61e0d8b7408f798471d7dd2edd50ce8994", "url": "https://github.com/apache/druid/commit/f53edb61e0d8b7408f798471d7dd2edd50ce8994", "message": "Make brokers backwards compatible\n\nIn 0.19, Brokers gained the ability to serve segments. To support this change,\na `BROKER` ServerType was added to `druid.server.coordination`.\n\nDruid nodes prior to this change do not know of this new server type and so\nthey would fail to deserialize this node's announcement.\n\nThis change makes it so that the broker only announces itself if the segment\ncache is configured on the broker. It is expected that a Druid admin will only\nconfigure the segment cache on the broker once the cluster has been upgraded\nto a version that supports a broker using the segment cache.", "committedDate": "2020-06-29T01:47:22Z", "type": "commit"}, {"oid": "a21f20bd2375538562f15b1108bdf46393623767", "url": "https://github.com/apache/druid/commit/a21f20bd2375538562f15b1108bdf46393623767", "message": "make code nicer", "committedDate": "2020-06-29T05:03:29Z", "type": "commit"}, {"oid": "640c4867be1dddc3aa6f93c0b1a03ca77a176acb", "url": "https://github.com/apache/druid/commit/640c4867be1dddc3aa6f93c0b1a03ca77a176acb", "message": "Add tests", "committedDate": "2020-06-29T17:02:16Z", "type": "commit"}, {"oid": "aeec0c2ac2b07c1b9262e32201913c7194167271", "url": "https://github.com/apache/druid/commit/aeec0c2ac2b07c1b9262e32201913c7194167271", "message": "Ignore icode coverage for nitialization classes", "committedDate": "2020-06-29T17:46:34Z", "type": "commit"}, {"oid": "8962df87adac39ff2ac67a8eb7337994b3c72dd2", "url": "https://github.com/apache/druid/commit/8962df87adac39ff2ac67a8eb7337994b3c72dd2", "message": "Revert \"Ignore icode coverage for nitialization classes\"\n\nThis reverts commit aeec0c2ac2b07c1b9262e32201913c7194167271.", "committedDate": "2020-06-29T18:04:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMwOTQ5NQ==", "url": "https://github.com/apache/druid/pull/10091#discussion_r447309495", "bodyText": "Is it possible to make the private constructor delegate to this one?", "author": "ccaominh", "createdAt": "2020-06-29T23:08:42Z", "path": "services/src/main/java/org/apache/druid/cli/ServerRunnable.java", "diffHunk": "@@ -194,15 +202,40 @@ private DiscoverySideEffectsProvider(\n       this.useLegacyAnnouncer = useLegacyAnnouncer;\n     }\n \n+    @VisibleForTesting\n+    DiscoverySideEffectsProvider(", "originalCommit": "8962df87adac39ff2ac67a8eb7337994b3c72dd2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMyMzI5Mg==", "url": "https://github.com/apache/druid/pull/10091#discussion_r447323292", "bodyText": "I'd need to refactor this to use Guice's AssistedInject Factory to avoid having 2 constructors - It's why I don't really like injected field members.\nIf you think it's worth the refactoring, I can make that change. I'll wait to see if there are any other comments before pushing up a new patch", "author": "suneet-s", "createdAt": "2020-06-29T23:50:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMwOTQ5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMyNzQ2NA==", "url": "https://github.com/apache/druid/pull/10091#discussion_r447327464", "bodyText": "Since this is a release blocker for 0.19, I don't think refactoring is necessary. FWIW I don't really like AssistedInject, it's a bit too magical for my taste.", "author": "clintropolis", "createdAt": "2020-06-30T00:02:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMwOTQ5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMyODYzNg==", "url": "https://github.com/apache/druid/pull/10091#discussion_r447328636", "bodyText": "If it's complicated, I'm ok with doing the refactoring in a follow up PR.", "author": "ccaominh", "createdAt": "2020-06-30T00:06:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMwOTQ5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM0NTE3Mg==", "url": "https://github.com/apache/druid/pull/10091#discussion_r447345172", "bodyText": "I'll make this change in a follow up PR so we can push this through quickly", "author": "suneet-s", "createdAt": "2020-06-30T00:59:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMwOTQ5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "c22c972cd7ba6a9e0655a14055447d1bf3e2aed6", "chunk": "diff --git a/services/src/main/java/org/apache/druid/cli/ServerRunnable.java b/services/src/main/java/org/apache/druid/cli/ServerRunnable.java\nindex af20538249..70b93824f2 100644\n--- a/services/src/main/java/org/apache/druid/cli/ServerRunnable.java\n+++ b/services/src/main/java/org/apache/druid/cli/ServerRunnable.java\n\n@@ -233,7 +233,10 @@ public abstract class ServerRunnable extends GuiceRunnable\n         if (service.isDiscoverable()) {\n           builder.put(service.getName(), service);\n         } else {\n-          log.info(\"Service[%s] is not discoverable\", service.getName());\n+          log.info(\n+              \"Service[%s] is not discoverable. This will not be listed as a service provided by this node.\",\n+              service.getName()\n+          );\n         }\n       }\n       DiscoveryDruidNode discoveryDruidNode = new DiscoveryDruidNode(druidNode, nodeRole, builder.build());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMxNDkyMQ==", "url": "https://github.com/apache/druid/pull/10091#discussion_r447314921", "bodyText": "Should the code that asserts isAllServicesDiscoverable be moved from setUp to here? When I was reading just this test, it was not clear to me how it was checking that the announcements were getting added.", "author": "ccaominh", "createdAt": "2020-06-29T23:25:07Z", "path": "services/src/test/java/org/apache/druid/cli/DiscoverySideEffectsProviderTest.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.cli;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.inject.Injector;\n+import org.apache.druid.curator.discovery.ServiceAnnouncer;\n+import org.apache.druid.discovery.DiscoveryDruidNode;\n+import org.apache.druid.discovery.DruidNodeAnnouncer;\n+import org.apache.druid.discovery.DruidService;\n+import org.apache.druid.discovery.NodeRole;\n+import org.apache.druid.java.util.common.lifecycle.Lifecycle;\n+import org.apache.druid.server.DruidNode;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.ArgumentMatchers;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.junit.MockitoJUnitRunner;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+@RunWith(MockitoJUnitRunner.class)\n+public class DiscoverySideEffectsProviderTest\n+{\n+  private static final boolean USE_LEGACY_ANNOUNCER = true;\n+\n+  private NodeRole nodeRole;\n+  @Mock\n+  private DruidNode druidNode;\n+  @Mock\n+  private DruidNodeAnnouncer announcer;\n+  @Mock\n+  private ServiceAnnouncer legacyAnnouncer;\n+  @Mock\n+  private Lifecycle lifecycle;\n+  @Mock\n+  private Injector injector;\n+  private List<Lifecycle.Handler> lifecycleHandlers;\n+\n+  private ServerRunnable.DiscoverySideEffectsProvider target;\n+\n+  @Before\n+  public void setUp()\n+  {\n+    nodeRole = NodeRole.HISTORICAL;\n+    lifecycleHandlers = new ArrayList<>();\n+    Mockito.when(injector.getInstance(DiscoverableDruidService.class)).thenReturn(new DiscoverableDruidService());\n+    Mockito.when(injector.getInstance(UnDiscoverableDruidService.class)).thenReturn(new UnDiscoverableDruidService());\n+    Mockito.doAnswer((invocation) -> {\n+      DiscoveryDruidNode discoveryDruidNode = invocation.getArgument(0);\n+      boolean isAllServicesDiscoverable =\n+          discoveryDruidNode.getServices().values().stream().allMatch(DruidService::isDiscoverable);\n+      Assert.assertTrue(isAllServicesDiscoverable);\n+      return null;\n+    }).when(announcer).announce(ArgumentMatchers.any(DiscoveryDruidNode.class));\n+    Mockito.doAnswer((invocation) -> lifecycleHandlers.add(invocation.getArgument(0)))\n+           .when(lifecycle).addHandler(\n+        ArgumentMatchers.any(Lifecycle.Handler.class),\n+        ArgumentMatchers.eq(Lifecycle.Stage.ANNOUNCEMENTS)\n+      );\n+    target = new ServerRunnable.DiscoverySideEffectsProvider(\n+        nodeRole,\n+        ImmutableList.of(DiscoverableDruidService.class, UnDiscoverableDruidService.class),\n+        USE_LEGACY_ANNOUNCER,\n+        druidNode,\n+        announcer,\n+        legacyAnnouncer,\n+        lifecycle,\n+        injector\n+    );\n+  }\n+\n+  @Test\n+  public void testGetShouldAddAnnouncementsForDiscoverableServices() throws Exception\n+  {\n+    ServerRunnable.DiscoverySideEffectsProvider.Child child = target.get();\n+    Assert.assertNotNull(child);\n+    Assert.assertEquals(1, lifecycleHandlers.size());\n+    lifecycleHandlers.get(0).start();\n+  }", "originalCommit": "8962df87adac39ff2ac67a8eb7337994b3c72dd2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMyMjQ2Mg==", "url": "https://github.com/apache/druid/pull/10091#discussion_r447322462", "bodyText": "Fair point. I wrote this so that the announcer is wired up to fail if it tries to announce an undiscoverable service.\nIt was tricky to wire up the validation because DiscoveryDruidNode is instantiated when the provider is called and the Child object that is returned just appears to be an empty object. I couldn't think of a better way to wire up the validations without refactoring some production code.", "author": "suneet-s", "createdAt": "2020-06-29T23:47:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMxNDkyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMzOTY3Nw==", "url": "https://github.com/apache/druid/pull/10091#discussion_r447339677", "bodyText": "Added comments to try and describe the behavior better.", "author": "suneet-s", "createdAt": "2020-06-30T00:40:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMxNDkyMQ=="}], "type": "inlineReview", "revised_code": {"commit": "c22c972cd7ba6a9e0655a14055447d1bf3e2aed6", "chunk": "diff --git a/services/src/test/java/org/apache/druid/cli/DiscoverySideEffectsProviderTest.java b/services/src/test/java/org/apache/druid/cli/DiscoverySideEffectsProviderTest.java\nindex f0eb32b1b1..8832da2867 100644\n--- a/services/src/test/java/org/apache/druid/cli/DiscoverySideEffectsProviderTest.java\n+++ b/services/src/test/java/org/apache/druid/cli/DiscoverySideEffectsProviderTest.java\n\n@@ -48,8 +48,11 @@ public class DiscoverySideEffectsProviderTest\n   private NodeRole nodeRole;\n   @Mock\n   private DruidNode druidNode;\n+  /**\n+   * This announcer is mocked to fail if it tries to announce a Druid service that is not discoverable.\n+   */\n   @Mock\n-  private DruidNodeAnnouncer announcer;\n+  private DruidNodeAnnouncer discoverableOnlyAnnouncer;\n   @Mock\n   private ServiceAnnouncer legacyAnnouncer;\n   @Mock\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMyNjE4OQ==", "url": "https://github.com/apache/druid/pull/10091#discussion_r447326189", "bodyText": "nit: this log should probably include the implications, such as it will not be assignable for segment placement.", "author": "clintropolis", "createdAt": "2020-06-29T23:59:18Z", "path": "server/src/main/java/org/apache/druid/guice/StorageNodeModule.java", "diffHunk": "@@ -74,17 +82,36 @@ public DruidServerMetadata getMetadata(\n \n   @Provides\n   @LazySingleton\n-  public DataNodeService getDataNodeService(@Nullable ServerTypeConfig serverTypeConfig, DruidServerConfig config)\n+  public DataNodeService getDataNodeService(\n+      @Nullable ServerTypeConfig serverTypeConfig,\n+      DruidServerConfig config,\n+      @Named(IS_SEGMENT_CACHE_CONFIGURED) Boolean isSegmentCacheConfigured\n+  )\n   {\n     if (serverTypeConfig == null) {\n-      throw new ProvisionException(\"Must override the binding for ServerTypeConfig if you want a DruidServerMetadata.\");\n+      throw new ProvisionException(\"Must override the binding for ServerTypeConfig if you want a DataNodeService.\");\n+    }\n+    if (!isSegmentCacheConfigured) {\n+      log.info(\"Segment cache not configured on ServerType [%s]\", serverTypeConfig.getServerType());", "originalCommit": "8962df87adac39ff2ac67a8eb7337994b3c72dd2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMzODIyNw==", "url": "https://github.com/apache/druid/pull/10091#discussion_r447338227", "bodyText": "Done", "author": "suneet-s", "createdAt": "2020-06-30T00:35:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMyNjE4OQ=="}], "type": "inlineReview", "revised_code": {"commit": "c22c972cd7ba6a9e0655a14055447d1bf3e2aed6", "chunk": "diff --git a/server/src/main/java/org/apache/druid/guice/StorageNodeModule.java b/server/src/main/java/org/apache/druid/guice/StorageNodeModule.java\nindex f26810c381..d3750a735a 100644\n--- a/server/src/main/java/org/apache/druid/guice/StorageNodeModule.java\n+++ b/server/src/main/java/org/apache/druid/guice/StorageNodeModule.java\n\n@@ -92,7 +92,10 @@ public class StorageNodeModule implements Module\n       throw new ProvisionException(\"Must override the binding for ServerTypeConfig if you want a DataNodeService.\");\n     }\n     if (!isSegmentCacheConfigured) {\n-      log.info(\"Segment cache not configured on ServerType [%s]\", serverTypeConfig.getServerType());\n+      log.info(\n+          \"Segment cache not configured on ServerType [%s]. It will not be assignable for segment placement\",\n+          serverTypeConfig.getServerType()\n+      );\n       if (ServerType.HISTORICAL.equals(serverTypeConfig.getServerType())) {\n         throw new ProvisionException(\"Segment cache locations must be set on historicals.\");\n       }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMyNzc1NQ==", "url": "https://github.com/apache/druid/pull/10091#discussion_r447327755", "bodyText": "nit: this log should also maybe be more informative that the service is being skipped and will not be listed as a service the node provides i think", "author": "clintropolis", "createdAt": "2020-06-30T00:03:47Z", "path": "services/src/main/java/org/apache/druid/cli/ServerRunnable.java", "diffHunk": "@@ -194,15 +202,40 @@ private DiscoverySideEffectsProvider(\n       this.useLegacyAnnouncer = useLegacyAnnouncer;\n     }\n \n+    @VisibleForTesting\n+    DiscoverySideEffectsProvider(\n+        final NodeRole nodeRole,\n+        final List<Class<? extends DruidService>> serviceClasses,\n+        final boolean useLegacyAnnouncer,\n+        final DruidNode druidNode,\n+        final DruidNodeAnnouncer announcer,\n+        final ServiceAnnouncer legacyAnnouncer,\n+        final Lifecycle lifecycle,\n+        final Injector injector\n+    )\n+    {\n+      this.nodeRole = nodeRole;\n+      this.serviceClasses = serviceClasses;\n+      this.useLegacyAnnouncer = useLegacyAnnouncer;\n+      this.druidNode = druidNode;\n+      this.announcer = announcer;\n+      this.legacyAnnouncer = legacyAnnouncer;\n+      this.lifecycle = lifecycle;\n+      this.injector = injector;\n+    }\n+\n     @Override\n     public Child get()\n     {\n       ImmutableMap.Builder<String, DruidService> builder = new ImmutableMap.Builder<>();\n       for (Class<? extends DruidService> clazz : serviceClasses) {\n         DruidService service = injector.getInstance(clazz);\n-        builder.put(service.getName(), service);\n+        if (service.isDiscoverable()) {\n+          builder.put(service.getName(), service);\n+        } else {\n+          log.info(\"Service[%s] is not discoverable\", service.getName());", "originalCommit": "8962df87adac39ff2ac67a8eb7337994b3c72dd2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMzODUwNg==", "url": "https://github.com/apache/druid/pull/10091#discussion_r447338506", "bodyText": "Done", "author": "suneet-s", "createdAt": "2020-06-30T00:36:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMyNzc1NQ=="}], "type": "inlineReview", "revised_code": {"commit": "c22c972cd7ba6a9e0655a14055447d1bf3e2aed6", "chunk": "diff --git a/services/src/main/java/org/apache/druid/cli/ServerRunnable.java b/services/src/main/java/org/apache/druid/cli/ServerRunnable.java\nindex af20538249..70b93824f2 100644\n--- a/services/src/main/java/org/apache/druid/cli/ServerRunnable.java\n+++ b/services/src/main/java/org/apache/druid/cli/ServerRunnable.java\n\n@@ -233,7 +233,10 @@ public abstract class ServerRunnable extends GuiceRunnable\n         if (service.isDiscoverable()) {\n           builder.put(service.getName(), service);\n         } else {\n-          log.info(\"Service[%s] is not discoverable\", service.getName());\n+          log.info(\n+              \"Service[%s] is not discoverable. This will not be listed as a service provided by this node.\",\n+              service.getName()\n+          );\n         }\n       }\n       DiscoveryDruidNode discoveryDruidNode = new DiscoveryDruidNode(druidNode, nodeRole, builder.build());\n"}}, {"oid": "ec5efee455ca53af6727984c35b0d5420daa34a7", "url": "https://github.com/apache/druid/commit/ec5efee455ca53af6727984c35b0d5420daa34a7", "message": "Merge remote-tracking branch 'upstream/master' into rolling-upgrade", "committedDate": "2020-06-30T00:33:03Z", "type": "commit"}, {"oid": "c22c972cd7ba6a9e0655a14055447d1bf3e2aed6", "url": "https://github.com/apache/druid/commit/c22c972cd7ba6a9e0655a14055447d1bf3e2aed6", "message": "code review", "committedDate": "2020-06-30T01:00:38Z", "type": "commit"}]}