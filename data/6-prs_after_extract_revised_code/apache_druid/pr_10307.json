{"pr_number": 10307, "pr_title": "Add support for all partitioing schemes for auto compaction ", "pr_createdAt": "2020-08-21T19:20:23Z", "pr_url": "https://github.com/apache/druid/pull/10307", "timeline": [{"oid": "d7cee4e1c73396aa1a3fb09814a65a4324a230f5", "url": "https://github.com/apache/druid/commit/d7cee4e1c73396aa1a3fb09814a65a4324a230f5", "message": "Add support for all partitioing schemes for auto compaction", "committedDate": "2020-08-21T07:20:34Z", "type": "commit"}, {"oid": "3853ed3a8f4689ba06b8e252a3a03abe183abe9a", "url": "https://github.com/apache/druid/commit/3853ed3a8f4689ba06b8e252a3a03abe183abe9a", "message": "annotate last compaction state for multi phase parallel indexing", "committedDate": "2020-08-21T19:05:22Z", "type": "commit"}, {"oid": "d091e6a1dd239bc424b1f84deae9dd91391b3c42", "url": "https://github.com/apache/druid/commit/d091e6a1dd239bc424b1f84deae9dd91391b3c42", "message": "Merge branch 'master' of github.com:apache/druid into repartitioning-auto-compaction", "committedDate": "2020-08-21T19:07:19Z", "type": "commit"}, {"oid": "eb0eafb47f5545fe28c2f8b63e9ffa593d6f177e", "url": "https://github.com/apache/druid/commit/eb0eafb47f5545fe28c2f8b63e9ffa593d6f177e", "message": "fix build and tests", "committedDate": "2020-08-21T21:09:35Z", "type": "commit"}, {"oid": "d4c491b1ae54f366df100451e8ba749abed3e6eb", "url": "https://github.com/apache/druid/commit/d4c491b1ae54f366df100451e8ba749abed3e6eb", "message": "test", "committedDate": "2020-08-21T22:42:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTExMTU5OQ==", "url": "https://github.com/apache/druid/pull/10307#discussion_r475111599", "bodyText": "should this rather stay inside AbstractBatchIndexTask so that concrete Task classes remain unaware of each other?", "author": "abhishekagarwal87", "createdAt": "2020-08-22T17:21:18Z", "path": "indexing-service/src/main/java/org/apache/druid/indexing/common/task/batch/parallel/ParallelIndexSupervisorTask.java", "diffHunk": "@@ -764,7 +765,28 @@ private PartitionBoundaries determineRangePartition(Collection<StringDistributio\n     return Pair.of(start, stop);\n   }\n \n-  private static void publishSegments(TaskToolbox toolbox, Map<String, PushedSegmentsReport> reportsMap)\n+  public static Function<Set<DataSegment>, Set<DataSegment>> compactionStateAnnotateFunction(", "originalCommit": "d4c491b1ae54f366df100451e8ba749abed3e6eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg4MjU0OQ==", "url": "https://github.com/apache/druid/pull/10307#discussion_r475882549", "bodyText": "Good idea! Moved this method.", "author": "jihoonson", "createdAt": "2020-08-24T20:43:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTExMTU5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "59c15caf5f9854e64c34a364e98372d6893c9b93", "chunk": "diff --git a/indexing-service/src/main/java/org/apache/druid/indexing/common/task/batch/parallel/ParallelIndexSupervisorTask.java b/indexing-service/src/main/java/org/apache/druid/indexing/common/task/batch/parallel/ParallelIndexSupervisorTask.java\nindex 7b872d3e6b..e551df49ff 100644\n--- a/indexing-service/src/main/java/org/apache/druid/indexing/common/task/batch/parallel/ParallelIndexSupervisorTask.java\n+++ b/indexing-service/src/main/java/org/apache/druid/indexing/common/task/batch/parallel/ParallelIndexSupervisorTask.java\n\n@@ -765,24 +764,6 @@ public class ParallelIndexSupervisorTask extends AbstractBatchIndexTask implemen\n     return Pair.of(start, stop);\n   }\n \n-  public static Function<Set<DataSegment>, Set<DataSegment>> compactionStateAnnotateFunction(\n-      boolean storeCompactionState,\n-      TaskToolbox toolbox,\n-      IndexTuningConfig tuningConfig\n-  )\n-  {\n-    if (storeCompactionState) {\n-      final Map<String, Object> indexSpecMap = tuningConfig.getIndexSpec().asMap(toolbox.getJsonMapper());\n-      final CompactionState compactionState = new CompactionState(tuningConfig.getPartitionsSpec(), indexSpecMap);\n-      return segments -> segments\n-          .stream()\n-          .map(s -> s.withLastCompactionState(compactionState))\n-          .collect(Collectors.toSet());\n-    } else {\n-      return Function.identity();\n-    }\n-  }\n-\n   private void publishSegments(\n       TaskToolbox toolbox,\n       Map<String, PushedSegmentsReport> reportsMap\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTExMjkyMA==", "url": "https://github.com/apache/druid/pull/10307#discussion_r475112920", "bodyText": "should this be marked JsonProperty?", "author": "abhishekagarwal87", "createdAt": "2020-08-22T17:36:02Z", "path": "server/src/main/java/org/apache/druid/client/indexing/ClientCompactionTaskQueryTuningConfig.java", "diffHunk": "@@ -158,27 +222,90 @@ public IndexSpec getIndexSpec()\n     return indexSpec;\n   }\n \n+  @JsonProperty\n+  @Nullable\n+  public IndexSpec getIndexSpecForIntermediatePersists()\n+  {\n+    return indexSpecForIntermediatePersists;\n+  }\n+\n   @JsonProperty\n   @Nullable\n   public Integer getMaxPendingPersists()\n   {\n     return maxPendingPersists;\n   }\n \n+  @JsonProperty", "originalCommit": "d4c491b1ae54f366df100451e8ba749abed3e6eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg4MjU3MA==", "url": "https://github.com/apache/druid/pull/10307#discussion_r475882570", "bodyText": "Yes, this should be passed properly when this class is deserialized as ParallelIndexTuningConfig.", "author": "jihoonson", "createdAt": "2020-08-24T20:43:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTExMjkyMA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTExNTg3Mw==", "url": "https://github.com/apache/druid/pull/10307#discussion_r475115873", "bodyText": "so if the partition spec is defined in compaction config and is dynamic partition spec, MaxRowsPerSegment is taken from partition spec. if its not dynamic partition and single dimension for example, then MaxRowsPerSegment is taken from tuning config?\nand it the same for MaxTotalRows?", "author": "abhishekagarwal87", "createdAt": "2020-08-22T18:09:23Z", "path": "server/src/main/java/org/apache/druid/server/coordinator/duty/NewestSegmentFirstIterator.java", "diffHunk": "@@ -247,17 +248,30 @@ public boolean hasNext()\n     }\n   }\n \n-  private boolean needsCompaction(DataSourceCompactionConfig config, SegmentsToCompact candidates)\n+  @VisibleForTesting\n+  static PartitionsSpec findPartitinosSpecFromConfig(ClientCompactionTaskQueryTuningConfig tuningConfig)\n+  {", "originalCommit": "d4c491b1ae54f366df100451e8ba749abed3e6eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTExNzIwMQ==", "url": "https://github.com/apache/druid/pull/10307#discussion_r475117201", "bodyText": "Misread the code. if the maxTotalRows is null in partition spec, should it be read from tuningConfig instead of using the Long.Max?", "author": "abhishekagarwal87", "createdAt": "2020-08-22T18:24:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTExNTg3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg4MjU5NQ==", "url": "https://github.com/apache/druid/pull/10307#discussion_r475882595", "bodyText": "The auto compaction supported only dynamic partitioning before this PR. The deprecated maxRowsPerSegment and maxTotalRows in DataSourceCompactionConfig are for dynamic partitioning. Users are recommended to use partitionsSpec instead of them.\n\nMisread the code. if the maxTotalRows is null in partition spec, should it be read from tuningConfig instead of using the Long.Max?\n\nMy intention is using partitionsSpec if it's specified and ignoring deprecated ones. I will add docs for this behaviour as well as the newly supported tuning configurations.", "author": "jihoonson", "createdAt": "2020-08-24T20:43:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTExNTg3Mw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "59c15caf5f9854e64c34a364e98372d6893c9b93", "url": "https://github.com/apache/druid/commit/59c15caf5f9854e64c34a364e98372d6893c9b93", "message": "better home", "committedDate": "2020-08-24T20:40:38Z", "type": "commit"}]}