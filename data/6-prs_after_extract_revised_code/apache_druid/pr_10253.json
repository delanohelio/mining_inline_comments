{"pr_number": 10253, "pr_title": "Allow forceLimitPushDown in SQL", "pr_createdAt": "2020-08-07T05:22:51Z", "pr_url": "https://github.com/apache/druid/pull/10253", "timeline": [{"oid": "0a1081f723f4e7429702802d5b355379d3b7170d", "url": "https://github.com/apache/druid/commit/0a1081f723f4e7429702802d5b355379d3b7170d", "message": "Allow forceLimitPushDown in SQL", "committedDate": "2020-08-07T05:20:11Z", "type": "commit"}, {"oid": "04da9cfe14e23e3d5f0eea7678d8c331c9af7497", "url": "https://github.com/apache/druid/commit/04da9cfe14e23e3d5f0eea7678d8c331c9af7497", "message": "fix test", "committedDate": "2020-08-07T16:30:16Z", "type": "commit"}, {"oid": "8f63335e145685d2af61493da22ad3f6cf4c061f", "url": "https://github.com/apache/druid/commit/8f63335e145685d2af61493da22ad3f6cf4c061f", "message": "fix test", "committedDate": "2020-08-07T18:45:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk3MzU0OQ==", "url": "https://github.com/apache/druid/pull/10253#discussion_r467973549", "bodyText": "Can we default to false instead of making this nullable?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private Boolean forceLimitPushDown;\n          \n          \n            \n              private boolean forceLimitPushDown;", "author": "suneet-s", "createdAt": "2020-08-10T15:11:32Z", "path": "processing/src/main/java/org/apache/druid/query/groupby/GroupByQuery.java", "diffHunk": "@@ -121,6 +120,10 @@ public static Builder builder()\n   @Nullable\n   private final DateTime universalTimestamp;\n \n+  private final boolean canPushDownLimit;\n+  @Nullable\n+  private Boolean forceLimitPushDown;", "originalCommit": "8f63335e145685d2af61493da22ad3f6cf4c061f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODgxMTY1Ng==", "url": "https://github.com/apache/druid/pull/10253#discussion_r468811656", "bodyText": "I think this would cause extra calls to validateAndGetForceLimitPushDown whenever isApplyLimitPushdown is called because of being unable to distinguish between an actual false and the value not being computed yet. It's probably not especially harmful, but it also seems unnecessary.", "author": "clintropolis", "createdAt": "2020-08-11T19:22:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk3MzU0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTY5MzAzNw==", "url": "https://github.com/apache/druid/pull/10253#discussion_r469693037", "bodyText": "Yeah, it's nullable to lazily initialize and cache it. Checking the value of forceLimitPushDown is needed a couple of times during a query. Even though it's not very harmful, I don't see any reason to not cache it.", "author": "jihoonson", "createdAt": "2020-08-13T04:43:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk3MzU0OQ=="}], "type": "inlineReview", "revised_code": {"commit": "e3bc9b260f08fa91fcf63f4709230d354806c885", "chunk": "diff --git a/processing/src/main/java/org/apache/druid/query/groupby/GroupByQuery.java b/processing/src/main/java/org/apache/druid/query/groupby/GroupByQuery.java\nindex fc87c72b01..091dada6a9 100644\n--- a/processing/src/main/java/org/apache/druid/query/groupby/GroupByQuery.java\n+++ b/processing/src/main/java/org/apache/druid/query/groupby/GroupByQuery.java\n\n@@ -120,7 +120,12 @@ public class GroupByQuery extends BaseQuery<ResultRow>\n   @Nullable\n   private final DateTime universalTimestamp;\n \n-  private final boolean canPushDownLimit;\n+  private final boolean canDoLimitPushDown;\n+\n+  /**\n+   * A flag to force limit pushdown to historicals.\n+   * Lazily initialized when calling {@link #validateAndGetForceLimitPushDown()}.\n+   */\n   @Nullable\n   private Boolean forceLimitPushDown;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODgxMzI1Mg==", "url": "https://github.com/apache/druid/pull/10253#discussion_r468813252", "bodyText": "super nit: it seems funny to have ...LimitPushDown and ...PushDownLimit, but I'm not really sure what is the best way to square these up. I guess ...LimitPushDown is more prevalent, so maybe renaming to canDoLimitPushDown to be more consistent?", "author": "clintropolis", "createdAt": "2020-08-11T19:25:28Z", "path": "processing/src/main/java/org/apache/druid/query/groupby/GroupByQuery.java", "diffHunk": "@@ -409,7 +412,10 @@ public boolean getContextSortByDimsFirst()\n   @JsonIgnore\n   public boolean isApplyLimitPushDown()\n   {\n-    return applyLimitPushDown;\n+    if (forceLimitPushDown == null) {\n+      forceLimitPushDown = validateAndGetForceLimitPushDown();\n+    }\n+    return forceLimitPushDown || canPushDownLimit;", "originalCommit": "8f63335e145685d2af61493da22ad3f6cf4c061f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTY5MzA1OQ==", "url": "https://github.com/apache/druid/pull/10253#discussion_r469693059", "bodyText": "Renamed.", "author": "jihoonson", "createdAt": "2020-08-13T04:43:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODgxMzI1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "e3bc9b260f08fa91fcf63f4709230d354806c885", "chunk": "diff --git a/processing/src/main/java/org/apache/druid/query/groupby/GroupByQuery.java b/processing/src/main/java/org/apache/druid/query/groupby/GroupByQuery.java\nindex fc87c72b01..091dada6a9 100644\n--- a/processing/src/main/java/org/apache/druid/query/groupby/GroupByQuery.java\n+++ b/processing/src/main/java/org/apache/druid/query/groupby/GroupByQuery.java\n\n@@ -415,7 +424,7 @@ public class GroupByQuery extends BaseQuery<ResultRow>\n     if (forceLimitPushDown == null) {\n       forceLimitPushDown = validateAndGetForceLimitPushDown();\n     }\n-    return forceLimitPushDown || canPushDownLimit;\n+    return forceLimitPushDown || canDoLimitPushDown;\n   }\n \n   @JsonIgnore\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODgxNTE1OA==", "url": "https://github.com/apache/druid/pull/10253#discussion_r468815158", "bodyText": "nit: this method name should probably include LimitPushDown or at least Limit somehow to make it clearer that it applies to limits, maybe canDoLimitPushDown() if you decide to rename the field as well?", "author": "clintropolis", "createdAt": "2020-08-11T19:29:11Z", "path": "processing/src/main/java/org/apache/druid/query/groupby/GroupByQuery.java", "diffHunk": "@@ -474,14 +480,12 @@ private RowSignature computeResultRowSignature()\n                   .build();\n   }\n \n-  private boolean determineApplyLimitPushDown()\n+  private boolean canPushDown()", "originalCommit": "8f63335e145685d2af61493da22ad3f6cf4c061f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTY5MzIyNw==", "url": "https://github.com/apache/druid/pull/10253#discussion_r469693227", "bodyText": "Added limitSpec, havingSpec, and subtotalsSpec as params and renamed.", "author": "jihoonson", "createdAt": "2020-08-13T04:43:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODgxNTE1OA=="}], "type": "inlineReview", "revised_code": {"commit": "e3bc9b260f08fa91fcf63f4709230d354806c885", "chunk": "diff --git a/processing/src/main/java/org/apache/druid/query/groupby/GroupByQuery.java b/processing/src/main/java/org/apache/druid/query/groupby/GroupByQuery.java\nindex fc87c72b01..091dada6a9 100644\n--- a/processing/src/main/java/org/apache/druid/query/groupby/GroupByQuery.java\n+++ b/processing/src/main/java/org/apache/druid/query/groupby/GroupByQuery.java\n\n@@ -480,9 +489,13 @@ public class GroupByQuery extends BaseQuery<ResultRow>\n                   .build();\n   }\n \n-  private boolean canPushDown()\n+  private boolean canDoLimitPushDown(\n+      @Nullable LimitSpec limitSpec,\n+      @Nullable HavingSpec havingSpec,\n+      @Nullable List<List<String>> subtotalsSpec\n+  )\n   {\n-    if (subtotalsSpec != null) {\n+    if (subtotalsSpec != null && !subtotalsSpec.isEmpty()) {\n       return false;\n     }\n \n"}}, {"oid": "e3bc9b260f08fa91fcf63f4709230d354806c885", "url": "https://github.com/apache/druid/commit/e3bc9b260f08fa91fcf63f4709230d354806c885", "message": "review comments", "committedDate": "2020-08-13T04:35:10Z", "type": "commit"}, {"oid": "62f4d0080f67659c458466fb84f259e58cdde9d6", "url": "https://github.com/apache/druid/commit/62f4d0080f67659c458466fb84f259e58cdde9d6", "message": "fix test", "committedDate": "2020-08-13T17:01:43Z", "type": "commit"}]}