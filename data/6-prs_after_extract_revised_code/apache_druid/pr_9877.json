{"pr_number": 9877, "pr_title": "Number based columns representing time in custom format cannot be used as timestamp column in Druid.", "pr_createdAt": "2020-05-15T21:28:46Z", "pr_url": "https://github.com/apache/druid/pull/9877", "timeline": [{"oid": "c0937c4f2a7c3a089e4876d338245f5e51757767", "url": "https://github.com/apache/druid/commit/c0937c4f2a7c3a089e4876d338245f5e51757767", "message": "Number based columns representing time in custom format cannot be used as timestamp column in Druid.\n\nPrior to this fix, if an integer column in parquet is storing dateint in format yyyyMMdd, it cannot be used as\ntimestamp column in Druid as the timestamp parser interprets it as a number storing UTC time\ninstead of treating it as a number representing time in yyyyMMdd format. Data formats like TSV or\nCSV don't suffer from this problem as the timestamp is passed in an as string\nwhich the timestamp parser is able to parse correctly.", "committedDate": "2020-05-15T21:23:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjEwMzExNg==", "url": "https://github.com/apache/druid/pull/9877#discussion_r426103116", "bodyText": "isNumericFormat(format) does not need to be computed for each object. You can compute this outside the function that is applied per object (on line 125)", "author": "suneet-s", "createdAt": "2020-05-16T01:19:41Z", "path": "core/src/main/java/org/apache/druid/java/util/common/parsers/TimestampParser.java", "diffHunk": "@@ -126,14 +126,24 @@\n     return o -> {\n       Preconditions.checkNotNull(o, \"null timestamp\");\n \n-      if (o instanceof Number) {\n+      if (o instanceof Number && isNumericFormat(format)) {", "originalCommit": "c0937c4f2a7c3a089e4876d338245f5e51757767", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8194abbe982a3898927e1cb8bc078621bd891337", "chunk": "diff --git a/core/src/main/java/org/apache/druid/java/util/common/parsers/TimestampParser.java b/core/src/main/java/org/apache/druid/java/util/common/parsers/TimestampParser.java\nindex 1f269980c5..e5a9520c63 100644\n--- a/core/src/main/java/org/apache/druid/java/util/common/parsers/TimestampParser.java\n+++ b/core/src/main/java/org/apache/druid/java/util/common/parsers/TimestampParser.java\n\n@@ -122,11 +122,12 @@ public class TimestampParser\n   {\n     final Function<String, DateTime> stringFun = createTimestampParser(format);\n     final Function<Number, DateTime> numericFun = createNumericTimestampParser(format);\n+    final boolean isNumericFormat = isNumericFormat(format);\n \n     return o -> {\n       Preconditions.checkNotNull(o, \"null timestamp\");\n \n-      if (o instanceof Number && isNumericFormat(format)) {\n+      if (o instanceof Number && isNumericFormat) {\n         return numericFun.apply((Number) o);\n       } else {\n         return stringFun.apply(o.toString());\n"}}, {"oid": "8194abbe982a3898927e1cb8bc078621bd891337", "url": "https://github.com/apache/druid/commit/8194abbe982a3898927e1cb8bc078621bd891337", "message": "Evaluate isNumeric only once", "committedDate": "2020-05-18T08:03:53Z", "type": "commit"}]}