{"pr_number": 10085, "pr_title": "Filter http requests by http method", "pr_createdAt": "2020-06-26T16:48:53Z", "pr_url": "https://github.com/apache/druid/pull/10085", "timeline": [{"oid": "01e2eff2cec4681d7ee741be6e400220c6a11af7", "url": "https://github.com/apache/druid/commit/01e2eff2cec4681d7ee741be6e400220c6a11af7", "message": "Filter http requests by http method\n\nAdd a config that allows a user which http methods to allow against their\nDruid server.\n\nDruid will only accept http requests with the method: GET, PUT, POST, DELETE\nand OPTIONS.\nIf a Druid admin wants to allow other methods, they can do so by using the\nServerConfig#allowedHttpMethods config.\n\nIf a Druid user would like to disallow OPTIONS, this can be done by changing\nthe AuthConfig#allowUnauthenticatedHttpOptions config", "committedDate": "2020-06-26T16:46:52Z", "type": "commit"}, {"oid": "29c2a873635a93da365aba3174101ecfea7b8238", "url": "https://github.com/apache/druid/commit/29c2a873635a93da365aba3174101ecfea7b8238", "message": "Exclude OPTIONS from always supported HTTP methods\n\nAdd HEAD as an allowed method for web console e2e tests", "committedDate": "2020-06-27T00:21:42Z", "type": "commit"}, {"oid": "8ee669c0dfa40e17f228c49975899367b4fce0a8", "url": "https://github.com/apache/druid/commit/8ee669c0dfa40e17f228c49975899367b4fce0a8", "message": "Merge remote-tracking branch 'upstream/master' into jetty", "committedDate": "2020-06-27T01:10:33Z", "type": "commit"}, {"oid": "61b257be845a5c13796790bffdaee42210b12182", "url": "https://github.com/apache/druid/commit/61b257be845a5c13796790bffdaee42210b12182", "message": "fix docs", "committedDate": "2020-06-27T02:54:34Z", "type": "commit"}, {"oid": "d60f42e68150c328b19a18ef20adadfc75da0486", "url": "https://github.com/apache/druid/commit/d60f42e68150c328b19a18ef20adadfc75da0486", "message": "fix security IT", "committedDate": "2020-06-27T03:03:07Z", "type": "commit"}, {"oid": "a024e3c57ab9e8b0218e334a6065dfc5c62d15a3", "url": "https://github.com/apache/druid/commit/a024e3c57ab9e8b0218e334a6065dfc5c62d15a3", "message": "Actually fix the web console e2e tests", "committedDate": "2020-06-27T03:50:48Z", "type": "commit"}, {"oid": "f8029cf6a4f807f925e5f8367862782392cbb34d", "url": "https://github.com/apache/druid/commit/f8029cf6a4f807f925e5f8367862782392cbb34d", "message": "Ignore icode coverage for nitialization classes", "committedDate": "2020-06-29T18:03:01Z", "type": "commit"}, {"oid": "4b968ab8559573000de60ebbaa6716976b11c4ef", "url": "https://github.com/apache/druid/commit/4b968ab8559573000de60ebbaa6716976b11c4ef", "message": "Merge remote-tracking branch 'upstream/master' into jetty", "committedDate": "2020-06-29T18:03:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2MzM1MQ==", "url": "https://github.com/apache/druid/pull/10085#discussion_r447163351", "bodyText": "This functionality isn't related to authentication. It would more properly belong in JettyServerInitUtils.", "author": "gianm", "createdAt": "2020-06-29T18:18:54Z", "path": "server/src/main/java/org/apache/druid/server/security/AuthenticationUtils.java", "diffHunk": "@@ -27,6 +27,16 @@\n \n public class AuthenticationUtils\n {\n+  public static void addAllowHttpMethodsFilter(ServletContextHandler root, List<String> allowedHttpMethods)", "originalCommit": "4b968ab8559573000de60ebbaa6716976b11c4ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIzMTY2MA==", "url": "https://github.com/apache/druid/pull/10085#discussion_r447231660", "bodyText": "Done", "author": "suneet-s", "createdAt": "2020-06-29T20:24:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2MzM1MQ=="}], "type": "inlineReview", "revised_code": {"commit": "857443866ff47feb034edea233db0548ca8ca828", "chunk": "diff --git a/server/src/main/java/org/apache/druid/server/security/AuthenticationUtils.java b/server/src/main/java/org/apache/druid/server/security/AuthenticationUtils.java\nindex f4cd45e798..d4fba7388a 100644\n--- a/server/src/main/java/org/apache/druid/server/security/AuthenticationUtils.java\n+++ b/server/src/main/java/org/apache/druid/server/security/AuthenticationUtils.java\n\n@@ -27,16 +27,6 @@ import java.util.List;\n \n public class AuthenticationUtils\n {\n-  public static void addAllowHttpMethodsFilter(ServletContextHandler root, List<String> allowedHttpMethods)\n-  {\n-    FilterHolder holder = new FilterHolder(new AllowHttpMethodsResourceFilter(allowedHttpMethods));\n-    root.addFilter(\n-        holder,\n-        \"/*\",\n-        null\n-    );\n-  }\n-\n   public static void addAllowOptionsFilter(ServletContextHandler root, boolean allowUnauthenticatedHttpOptions)\n   {\n     FilterHolder holder = new FilterHolder(new AllowOptionsResourceFilter(allowUnauthenticatedHttpOptions));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2NDAxMQ==", "url": "https://github.com/apache/druid/pull/10085#discussion_r447164011", "bodyText": "Very small nit: HttpMethod.OPTIONS is better than the bare string.", "author": "gianm", "createdAt": "2020-06-29T18:20:07Z", "path": "server/src/test/java/org/apache/druid/initialization/ServerConfigTest.java", "diffHunk": "@@ -51,13 +54,27 @@ public void testSerde() throws Exception\n         defaultConfig.getUnannouncePropagationDelay(),\n         defaultConfig.getInflateBufferSize(),\n         defaultConfig.getCompressionLevel(),\n-        true\n+        true,\n+        ImmutableList.of(\"OPTIONS\")", "originalCommit": "4b968ab8559573000de60ebbaa6716976b11c4ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIzMTYxNA==", "url": "https://github.com/apache/druid/pull/10085#discussion_r447231614", "bodyText": "Done", "author": "suneet-s", "createdAt": "2020-06-29T20:24:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2NDAxMQ=="}], "type": "inlineReview", "revised_code": {"commit": "857443866ff47feb034edea233db0548ca8ca828", "chunk": "diff --git a/server/src/test/java/org/apache/druid/initialization/ServerConfigTest.java b/server/src/test/java/org/apache/druid/initialization/ServerConfigTest.java\nindex 420a2623a5..4c8c908349 100644\n--- a/server/src/test/java/org/apache/druid/initialization/ServerConfigTest.java\n+++ b/server/src/test/java/org/apache/druid/initialization/ServerConfigTest.java\n\n@@ -55,7 +57,7 @@ public class ServerConfigTest\n         defaultConfig.getInflateBufferSize(),\n         defaultConfig.getCompressionLevel(),\n         true,\n-        ImmutableList.of(\"OPTIONS\")\n+        ImmutableList.of(HttpMethod.OPTIONS)\n     );\n     String modifiedConfigJson = OBJECT_MAPPER.writeValueAsString(modifiedConfig);\n     ServerConfig modifiedConfig2 = OBJECT_MAPPER.readValue(modifiedConfigJson, ServerConfig.class);\n"}}, {"oid": "857443866ff47feb034edea233db0548ca8ca828", "url": "https://github.com/apache/druid/commit/857443866ff47feb034edea233db0548ca8ca828", "message": "code review", "committedDate": "2020-06-29T20:38:28Z", "type": "commit"}]}