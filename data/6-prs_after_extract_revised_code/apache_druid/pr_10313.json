{"pr_number": 10313, "pr_title": "Remove NUMERIC_HASHING_THRESHOLD", "pr_createdAt": "2020-08-24T06:08:28Z", "pr_url": "https://github.com/apache/druid/pull/10313", "timeline": [{"oid": "69a2dbfb4319c05f063ec05e82eb2e66ecab55f3", "url": "https://github.com/apache/druid/commit/69a2dbfb4319c05f063ec05e82eb2e66ecab55f3", "message": "Make NUMERIC_HASHING_THRESHOLD configurable\n\nChange the default numeric hashing threshold to 1 and make it configurable.\n\nBenchmarks attached to this PR show that binary searches are not more faster\nthan doing a set contains check. The attached flamegraph shows the amount of\ntime a query spent in the binary search. Given the benchmarks, we can expect\nto see roughly a 2x speed up in this part of the query which works out to\n~ a 10% faster query in this instance.", "committedDate": "2020-08-24T04:48:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjE5Mjg5NQ==", "url": "https://github.com/apache/druid/pull/10313#discussion_r476192895", "bodyText": "I don't think we should have a property for this, but if we did, it should be set through Guice injection rather than through System.getProperty. That way, it'd work in either a runtime props file or a system property.\nWe won't actually see \"1\" in practice AFAIK, since optimize() will get run, and that'll turn the In filter into a Selector filter.\nSo if this is the right default, I think it'd be better to remove the code.", "author": "gianm", "createdAt": "2020-08-25T05:49:59Z", "path": "processing/src/main/java/org/apache/druid/query/filter/InDimFilter.java", "diffHunk": "@@ -80,7 +80,8 @@\n {\n   // determined through benchmark that binary search on long[] is faster than HashSet until ~16 elements\n   // Hashing threshold is not applied to String for now, String still uses ImmutableSortedSet\n-  public static final int NUMERIC_HASHING_THRESHOLD = 16;\n+  public static final int NUMERIC_HASHING_THRESHOLD =\n+      Integer.parseInt(System.getProperty(\"druid.query.filter.inDimFilter.numericHashingThreshold\", \"1\"));", "originalCommit": "69a2dbfb4319c05f063ec05e82eb2e66ecab55f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjUwMTkyNQ==", "url": "https://github.com/apache/druid/pull/10313#discussion_r476501925", "bodyText": "ha I didn't look at the optimize code in the InDimFilter before.\nSelectorDimFilter.optimize() produces an InDimFilter and InDimFilter.optimize() produces a SelectorDimFilter. One of those must be wrong \ud83d\ude05\nEither way, it probably doesn't make a difference with 1 element.\nI put the default in mainly because of my paranoia, just in case this causes a perf degradation for a specific shape of query that isn't covered by my benchmarks. I'll run them a few more times and then just drop this code path.", "author": "suneet-s", "createdAt": "2020-08-25T14:39:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjE5Mjg5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYwOTU0OQ==", "url": "https://github.com/apache/druid/pull/10313#discussion_r476609549", "bodyText": "One of those must be wrong \ud83d\ude05\n\nSelectorDimFilter calls new InDimFilter(dimension, Collections.singleton(value), extractionFn, filterTuning).optimize(), so you get another SelectorDimFilter back \ud83d\ude42\nThere's no comment about why, but I assume it's because InDimFilter has the optimizeLookup() code.\n\nI put the default in mainly because of my paranoia, just in case this causes a perf degradation for a specific shape of query that isn't covered by my benchmarks.\n\nPeople generally aren't going to have the patience to research each of these settings, so it's usually better if we do some diligence to find something that should work (relatively) universally. If that involves removing code paths then it also helps us reduce the amount of code that needs to be tested.", "author": "gianm", "createdAt": "2020-08-25T17:16:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjE5Mjg5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "eabcbce8b40b5845c1e115f4cee63609a6e80e92", "chunk": "diff --git a/processing/src/main/java/org/apache/druid/query/filter/InDimFilter.java b/processing/src/main/java/org/apache/druid/query/filter/InDimFilter.java\nindex 97ced939b4..817b19badf 100644\n--- a/processing/src/main/java/org/apache/druid/query/filter/InDimFilter.java\n+++ b/processing/src/main/java/org/apache/druid/query/filter/InDimFilter.java\n\n@@ -78,11 +77,6 @@ import java.util.stream.Collectors;\n \n public class InDimFilter extends AbstractOptimizableDimFilter implements Filter\n {\n-  // determined through benchmark that binary search on long[] is faster than HashSet until ~16 elements\n-  // Hashing threshold is not applied to String for now, String still uses ImmutableSortedSet\n-  public static final int NUMERIC_HASHING_THRESHOLD =\n-      Integer.parseInt(System.getProperty(\"druid.query.filter.inDimFilter.numericHashingThreshold\", \"1\"));\n-\n   // Values can contain `null` object\n   private final Set<String> values;\n   private final String dimension;\n"}}, {"oid": "eabcbce8b40b5845c1e115f4cee63609a6e80e92", "url": "https://github.com/apache/druid/commit/eabcbce8b40b5845c1e115f4cee63609a6e80e92", "message": "Remove NUMERIC_HASHING_THRESHOLD", "committedDate": "2020-08-25T17:36:18Z", "type": "commit"}, {"oid": "1c6b6abcdc7d06ee490ecfac1d7ee0492bcbc81a", "url": "https://github.com/apache/druid/commit/1c6b6abcdc7d06ee490ecfac1d7ee0492bcbc81a", "message": "Remove stale docs", "committedDate": "2020-08-25T21:09:21Z", "type": "commit"}]}