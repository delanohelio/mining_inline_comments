{"pr_number": 1580, "pr_title": "TagWorkflowOperationHandler now allows wildcards in target flavor", "pr_createdAt": "2020-05-12T15:33:09Z", "pr_url": "https://github.com/opencast/opencast/pull/1580", "timeline": [{"oid": "7ecfc38080d7a392d5e3553fc61b7d469fa912f1", "url": "https://github.com/opencast/opencast/commit/7ecfc38080d7a392d5e3553fc61b7d469fa912f1", "message": "TagWorkflowOperationHandler now allows wildcards in type and subtype.", "committedDate": "2020-06-09T17:49:00Z", "type": "forcePushed"}, {"oid": "ae3986b8d69562a72ac9fcae6bd211139952ad32", "url": "https://github.com/opencast/opencast/commit/ae3986b8d69562a72ac9fcae6bd211139952ad32", "message": "TagWorkflowOperationHandler now allows wildcards in target flavor type and subtype.", "committedDate": "2020-06-10T18:40:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA0MDc3Mg==", "url": "https://github.com/opencast/opencast/pull/1580#discussion_r496040772", "bodyText": "This should be WorkflowOperationException", "author": "gregorydlogan", "createdAt": "2020-09-28T15:28:24Z", "path": "modules/workflow-workflowoperation/src/main/java/org/opencastproject/workflow/handler/workflow/TagWorkflowOperationHandler.java", "diffHunk": "@@ -119,6 +119,20 @@ public WorkflowOperationResult start(WorkflowInstance workflowInstance, JobConte\n       elementSelector.addTag(tag);\n     }\n \n+    boolean wildcardInTargetFlavorType = false;\n+    boolean wildcardInTargetFlavorSubtype = false;\n+    if (configuredTargetFlavor != null) {\n+      String[] targetFlavorTypes = configuredTargetFlavor.split(\"/\");\n+      if (targetFlavorTypes.length != 2) {\n+        String errorMsg = String.format(\"The configured target flavor has a wrong format. \"\n+                + \"The configured target flavor: '%s'.\", configuredTargetFlavor);\n+        logger.error(errorMsg);\n+        throw new RuntimeException(errorMsg);", "originalCommit": "ae3986b8d69562a72ac9fcae6bd211139952ad32", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f66c688d021c80aabdbee54fcae98c91cc0fc7a7", "chunk": "diff --git a/modules/workflow-workflowoperation/src/main/java/org/opencastproject/workflow/handler/workflow/TagWorkflowOperationHandler.java b/modules/workflow-workflowoperation/src/main/java/org/opencastproject/workflow/handler/workflow/TagWorkflowOperationHandler.java\nindex 8b177d7e86..a7d3ad0cdb 100644\n--- a/modules/workflow-workflowoperation/src/main/java/org/opencastproject/workflow/handler/workflow/TagWorkflowOperationHandler.java\n+++ b/modules/workflow-workflowoperation/src/main/java/org/opencastproject/workflow/handler/workflow/TagWorkflowOperationHandler.java\n\n@@ -119,20 +119,6 @@ public class TagWorkflowOperationHandler extends AbstractWorkflowOperationHandle\n       elementSelector.addTag(tag);\n     }\n \n-    boolean wildcardInTargetFlavorType = false;\n-    boolean wildcardInTargetFlavorSubtype = false;\n-    if (configuredTargetFlavor != null) {\n-      String[] targetFlavorTypes = configuredTargetFlavor.split(\"/\");\n-      if (targetFlavorTypes.length != 2) {\n-        String errorMsg = String.format(\"The configured target flavor has a wrong format. \"\n-                + \"The configured target flavor: '%s'.\", configuredTargetFlavor);\n-        logger.error(errorMsg);\n-        throw new RuntimeException(errorMsg);\n-      }\n-      wildcardInTargetFlavorType = \"*\".equals(targetFlavorTypes[0]);\n-      wildcardInTargetFlavorSubtype = \"*\".equals(targetFlavorTypes[1]);\n-    }\n-\n     Collection<MediaPackageElement> elements = elementSelector.select(mediaPackage, false);\n     for (MediaPackageElement e : elements) {\n       MediaPackageElement element = e;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA0MTE2MA==", "url": "https://github.com/opencast/opencast/pull/1580#discussion_r496041160", "bodyText": "Ideally this should be a class level constant.", "author": "gregorydlogan", "createdAt": "2020-09-28T15:28:52Z", "path": "modules/workflow-workflowoperation/src/main/java/org/opencastproject/workflow/handler/workflow/TagWorkflowOperationHandler.java", "diffHunk": "@@ -119,6 +119,20 @@ public WorkflowOperationResult start(WorkflowInstance workflowInstance, JobConte\n       elementSelector.addTag(tag);\n     }\n \n+    boolean wildcardInTargetFlavorType = false;\n+    boolean wildcardInTargetFlavorSubtype = false;\n+    if (configuredTargetFlavor != null) {\n+      String[] targetFlavorTypes = configuredTargetFlavor.split(\"/\");\n+      if (targetFlavorTypes.length != 2) {\n+        String errorMsg = String.format(\"The configured target flavor has a wrong format. \"\n+                + \"The configured target flavor: '%s'.\", configuredTargetFlavor);\n+        logger.error(errorMsg);\n+        throw new RuntimeException(errorMsg);\n+      }\n+      wildcardInTargetFlavorType = \"*\".equals(targetFlavorTypes[0]);", "originalCommit": "ae3986b8d69562a72ac9fcae6bd211139952ad32", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f66c688d021c80aabdbee54fcae98c91cc0fc7a7", "chunk": "diff --git a/modules/workflow-workflowoperation/src/main/java/org/opencastproject/workflow/handler/workflow/TagWorkflowOperationHandler.java b/modules/workflow-workflowoperation/src/main/java/org/opencastproject/workflow/handler/workflow/TagWorkflowOperationHandler.java\nindex 8b177d7e86..a7d3ad0cdb 100644\n--- a/modules/workflow-workflowoperation/src/main/java/org/opencastproject/workflow/handler/workflow/TagWorkflowOperationHandler.java\n+++ b/modules/workflow-workflowoperation/src/main/java/org/opencastproject/workflow/handler/workflow/TagWorkflowOperationHandler.java\n\n@@ -119,20 +119,6 @@ public class TagWorkflowOperationHandler extends AbstractWorkflowOperationHandle\n       elementSelector.addTag(tag);\n     }\n \n-    boolean wildcardInTargetFlavorType = false;\n-    boolean wildcardInTargetFlavorSubtype = false;\n-    if (configuredTargetFlavor != null) {\n-      String[] targetFlavorTypes = configuredTargetFlavor.split(\"/\");\n-      if (targetFlavorTypes.length != 2) {\n-        String errorMsg = String.format(\"The configured target flavor has a wrong format. \"\n-                + \"The configured target flavor: '%s'.\", configuredTargetFlavor);\n-        logger.error(errorMsg);\n-        throw new RuntimeException(errorMsg);\n-      }\n-      wildcardInTargetFlavorType = \"*\".equals(targetFlavorTypes[0]);\n-      wildcardInTargetFlavorSubtype = \"*\".equals(targetFlavorTypes[1]);\n-    }\n-\n     Collection<MediaPackageElement> elements = elementSelector.select(mediaPackage, false);\n     for (MediaPackageElement e : elements) {\n       MediaPackageElement element = e;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA0MTc2OA==", "url": "https://github.com/opencast/opencast/pull/1580#discussion_r496041768", "bodyText": "This call escapes the *, the following one does not.  They should be the same, right?", "author": "gregorydlogan", "createdAt": "2020-09-28T15:29:44Z", "path": "modules/workflow-workflowoperation/src/main/java/org/opencastproject/workflow/handler/workflow/TagWorkflowOperationHandler.java", "diffHunk": "@@ -127,8 +141,21 @@ public WorkflowOperationResult start(WorkflowInstance workflowInstance, JobConte\n         element.setIdentifier(null);\n         element.setURI(e.getURI()); // use the same URI as the original\n       }\n-      if (configuredTargetFlavor != null)\n-        element.setFlavor(MediaPackageElementFlavor.parseFlavor(configuredTargetFlavor));\n+\n+      if (configuredTargetFlavor != null) {\n+        String targetFlavor = configuredTargetFlavor;\n+\n+        if (wildcardInTargetFlavorType) {\n+          targetFlavor = targetFlavor.replaceFirst(\"\\\\*\", element.getFlavor().getType());", "originalCommit": "ae3986b8d69562a72ac9fcae6bd211139952ad32", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f66c688d021c80aabdbee54fcae98c91cc0fc7a7", "chunk": "diff --git a/modules/workflow-workflowoperation/src/main/java/org/opencastproject/workflow/handler/workflow/TagWorkflowOperationHandler.java b/modules/workflow-workflowoperation/src/main/java/org/opencastproject/workflow/handler/workflow/TagWorkflowOperationHandler.java\nindex 8b177d7e86..a7d3ad0cdb 100644\n--- a/modules/workflow-workflowoperation/src/main/java/org/opencastproject/workflow/handler/workflow/TagWorkflowOperationHandler.java\n+++ b/modules/workflow-workflowoperation/src/main/java/org/opencastproject/workflow/handler/workflow/TagWorkflowOperationHandler.java\n\n@@ -143,18 +129,21 @@ public class TagWorkflowOperationHandler extends AbstractWorkflowOperationHandle\n       }\n \n       if (configuredTargetFlavor != null) {\n-        String targetFlavor = configuredTargetFlavor;\n \n-        if (wildcardInTargetFlavorType) {\n-          targetFlavor = targetFlavor.replaceFirst(\"\\\\*\", element.getFlavor().getType());\n+        MediaPackageElementFlavor resultingFlavor = MediaPackageElementFlavor.parseFlavor(configuredTargetFlavor);\n+        String resultingFlavorType = resultingFlavor.getType();\n+        String resultingFlavorSubtype = resultingFlavor.getSubtype();\n+\n+        if(MediaPackageElementFlavor.WILDCARD.equals(resultingFlavorType)) {\n+          resultingFlavorType = element.getFlavor().getType();\n         }\n \n-        if (wildcardInTargetFlavorSubtype) {\n-          // at this point there should only be one '*' remaining and it should be the subtype wildcard.\n-          targetFlavor = targetFlavor.replace(\"*\", element.getFlavor().getSubtype());\n+        if(MediaPackageElementFlavor.WILDCARD.equals(resultingFlavorSubtype)) {\n+          resultingFlavorSubtype = element.getFlavor().getSubtype();\n         }\n \n-        element.setFlavor(MediaPackageElementFlavor.parseFlavor(targetFlavor));\n+        resultingFlavor = MediaPackageElementFlavor.parseFlavor(resultingFlavorType + \"/\" + resultingFlavorSubtype);\n+        element.setFlavor(resultingFlavor);\n       }\n \n       if (overrideTags.size() > 0) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA4NzMwMw==", "url": "https://github.com/opencast/opencast/pull/1580#discussion_r496087303", "bodyText": "Don't log an error when you throw an exception anyway. The result will just be that you see the same error twice in the logs. Also, I like short messages ;-)\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    String errorMsg = String.format(\"The configured target flavor has a wrong format. \"\n          \n          \n            \n                            + \"The configured target flavor: '%s'.\", configuredTargetFlavor);\n          \n          \n            \n                    logger.error(errorMsg);\n          \n          \n            \n                    throw new RuntimeException(errorMsg);\n          \n          \n            \n                    final String errorMsg = String.format(\"The configured target flavor `%s` has a wrong format.\", configuredTargetFlavor);\n          \n          \n            \n                    throw new RuntimeException(errorMsg);", "author": "lkiesow", "createdAt": "2020-09-28T16:38:45Z", "path": "modules/workflow-workflowoperation/src/main/java/org/opencastproject/workflow/handler/workflow/TagWorkflowOperationHandler.java", "diffHunk": "@@ -119,6 +119,20 @@ public WorkflowOperationResult start(WorkflowInstance workflowInstance, JobConte\n       elementSelector.addTag(tag);\n     }\n \n+    boolean wildcardInTargetFlavorType = false;\n+    boolean wildcardInTargetFlavorSubtype = false;\n+    if (configuredTargetFlavor != null) {\n+      String[] targetFlavorTypes = configuredTargetFlavor.split(\"/\");\n+      if (targetFlavorTypes.length != 2) {\n+        String errorMsg = String.format(\"The configured target flavor has a wrong format. \"\n+                + \"The configured target flavor: '%s'.\", configuredTargetFlavor);\n+        logger.error(errorMsg);\n+        throw new RuntimeException(errorMsg);", "originalCommit": "ae3986b8d69562a72ac9fcae6bd211139952ad32", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f66c688d021c80aabdbee54fcae98c91cc0fc7a7", "chunk": "diff --git a/modules/workflow-workflowoperation/src/main/java/org/opencastproject/workflow/handler/workflow/TagWorkflowOperationHandler.java b/modules/workflow-workflowoperation/src/main/java/org/opencastproject/workflow/handler/workflow/TagWorkflowOperationHandler.java\nindex 8b177d7e86..a7d3ad0cdb 100644\n--- a/modules/workflow-workflowoperation/src/main/java/org/opencastproject/workflow/handler/workflow/TagWorkflowOperationHandler.java\n+++ b/modules/workflow-workflowoperation/src/main/java/org/opencastproject/workflow/handler/workflow/TagWorkflowOperationHandler.java\n\n@@ -119,20 +119,6 @@ public class TagWorkflowOperationHandler extends AbstractWorkflowOperationHandle\n       elementSelector.addTag(tag);\n     }\n \n-    boolean wildcardInTargetFlavorType = false;\n-    boolean wildcardInTargetFlavorSubtype = false;\n-    if (configuredTargetFlavor != null) {\n-      String[] targetFlavorTypes = configuredTargetFlavor.split(\"/\");\n-      if (targetFlavorTypes.length != 2) {\n-        String errorMsg = String.format(\"The configured target flavor has a wrong format. \"\n-                + \"The configured target flavor: '%s'.\", configuredTargetFlavor);\n-        logger.error(errorMsg);\n-        throw new RuntimeException(errorMsg);\n-      }\n-      wildcardInTargetFlavorType = \"*\".equals(targetFlavorTypes[0]);\n-      wildcardInTargetFlavorSubtype = \"*\".equals(targetFlavorTypes[1]);\n-    }\n-\n     Collection<MediaPackageElement> elements = elementSelector.select(mediaPackage, false);\n     for (MediaPackageElement e : elements) {\n       MediaPackageElement element = e;\n"}}, {"oid": "f66c688d021c80aabdbee54fcae98c91cc0fc7a7", "url": "https://github.com/opencast/opencast/commit/f66c688d021c80aabdbee54fcae98c91cc0fc7a7", "message": "TagWorkflowOperationHandler now allows wildcards in target flavor type and subtype.", "committedDate": "2020-09-30T14:33:44Z", "type": "forcePushed"}, {"oid": "d8953199f672eec83d36ac6a939d7fa0ae69174f", "url": "https://github.com/opencast/opencast/commit/d8953199f672eec83d36ac6a939d7fa0ae69174f", "message": "TagWorkflowOperationHandler now allows wildcards in target flavor type and subtype.", "committedDate": "2020-09-30T14:43:00Z", "type": "forcePushed"}, {"oid": "9757ef62aa0ea7ba0c853a7ef4c400368133336e", "url": "https://github.com/opencast/opencast/commit/9757ef62aa0ea7ba0c853a7ef4c400368133336e", "message": "TagWorkflowOperationHandler now allows wildcards in target flavor type and subtype.", "committedDate": "2020-09-30T14:59:45Z", "type": "commit"}, {"oid": "9757ef62aa0ea7ba0c853a7ef4c400368133336e", "url": "https://github.com/opencast/opencast/commit/9757ef62aa0ea7ba0c853a7ef4c400368133336e", "message": "TagWorkflowOperationHandler now allows wildcards in target flavor type and subtype.", "committedDate": "2020-09-30T14:59:45Z", "type": "forcePushed"}]}