{"pr_number": 1791, "pr_title": "Add with acl option to series api", "pr_createdAt": "2020-08-20T09:56:25Z", "pr_url": "https://github.com/opencast/opencast/pull/1791", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg2NjQ2NQ==", "url": "https://github.com/opencast/opencast/pull/1791#discussion_r495866465", "bodyText": "I remember a mailing list discussion about brace style and I think the vast majority of responses were in favor of Greg's proposal to make braces mandatory.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  if (series.getAccessPolicy() != null)\n          \n          \n            \n                    activeAcl = AccessControlParser.parseAcl(series.getAccessPolicy());\n          \n          \n            \n                  if (series.getAccessPolicy() != null) {\n          \n          \n            \n                    activeAcl = AccessControlParser.parseAcl(series.getAccessPolicy());\n          \n          \n            \n                  }", "author": "LukasKalbertodt", "createdAt": "2020-09-28T11:21:32Z", "path": "modules/external-api/src/main/java/org/opencastproject/external/endpoint/SeriesEndpoint.java", "diffHunk": "@@ -344,15 +359,45 @@ public JValue apply(SearchResultItem<Series> a) {\n     }\n   }\n \n+  /**\n+   * Get an {@link AccessControlList} from a {@link Series}.\n+   *\n+   * @param series\n+   *          The {@link Series} to get the ACL from.\n+   * @return The {@link AccessControlList} stored in the {@link Series}\n+   */\n+  private static AccessControlList getAclFromSeries(Series series) {\n+    AccessControlList activeAcl = new AccessControlList();\n+    try {\n+      if (series.getAccessPolicy() != null)\n+        activeAcl = AccessControlParser.parseAcl(series.getAccessPolicy());", "originalCommit": "661fab6c39d8ab045ba1e59cce4363ae4164be8a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY2MTMzNw==", "url": "https://github.com/opencast/opencast/pull/1791#discussion_r498661337", "bodyText": "You're right. I simply copied this over from the EventsEndpoint, but I'll add some braces (I like braces!)", "author": "KatrinIhler", "createdAt": "2020-10-02T07:40:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg2NjQ2NQ=="}], "type": "inlineReview", "revised_code": {"commit": "26fe93d5b93c28fb1e49095738edca57e3e72307", "chunk": "diff --git a/modules/external-api/src/main/java/org/opencastproject/external/endpoint/SeriesEndpoint.java b/modules/external-api/src/main/java/org/opencastproject/external/endpoint/SeriesEndpoint.java\nindex 85b0a6fdab..721903a778 100644\n--- a/modules/external-api/src/main/java/org/opencastproject/external/endpoint/SeriesEndpoint.java\n+++ b/modules/external-api/src/main/java/org/opencastproject/external/endpoint/SeriesEndpoint.java\n\n@@ -369,8 +371,9 @@ public class SeriesEndpoint {\n   private static AccessControlList getAclFromSeries(Series series) {\n     AccessControlList activeAcl = new AccessControlList();\n     try {\n-      if (series.getAccessPolicy() != null)\n+      if (series.getAccessPolicy() != null) {\n         activeAcl = AccessControlParser.parseAcl(series.getAccessPolicy());\n+      }\n     } catch (Exception e) {\n       logger.error(\"Unable to parse access policy\", e);\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg2NzI0Ng==", "url": "https://github.com/opencast/opencast/pull/1791#discussion_r495867246", "bodyText": "Is \"log error and continue with dummy value\" a valid error handling style in Opencast? I would assume the API should respond with 5xx if parsing the ACL fails. But I am not sure, as I have no experience on how the API code usually handles these things.", "author": "LukasKalbertodt", "createdAt": "2020-09-28T11:23:12Z", "path": "modules/external-api/src/main/java/org/opencastproject/external/endpoint/SeriesEndpoint.java", "diffHunk": "@@ -344,15 +359,45 @@ public JValue apply(SearchResultItem<Series> a) {\n     }\n   }\n \n+  /**\n+   * Get an {@link AccessControlList} from a {@link Series}.\n+   *\n+   * @param series\n+   *          The {@link Series} to get the ACL from.\n+   * @return The {@link AccessControlList} stored in the {@link Series}\n+   */\n+  private static AccessControlList getAclFromSeries(Series series) {\n+    AccessControlList activeAcl = new AccessControlList();\n+    try {\n+      if (series.getAccessPolicy() != null)\n+        activeAcl = AccessControlParser.parseAcl(series.getAccessPolicy());\n+    } catch (Exception e) {\n+      logger.error(\"Unable to parse access policy\", e);\n+    }\n+    return activeAcl;", "originalCommit": "661fab6c39d8ab045ba1e59cce4363ae4164be8a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY2NzI4MA==", "url": "https://github.com/opencast/opencast/pull/1791#discussion_r498667280", "bodyText": "This is a tricky one. In general, this is probably not a good idea. However, if asking for a list of a series fails with 500 only because one ACL is broken, that's also gonna suck. I guess it would be possible not to include an ACL if it can't be parsed. However, then the series API and the event API will behave differently there. And changing the latter is not something I want to spend time on right now. So maybe this is okay since it falls back to the default ACL, which is \"allow nothing\". Opinions?", "author": "KatrinIhler", "createdAt": "2020-10-02T07:53:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg2NzI0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODcxODYyMg==", "url": "https://github.com/opencast/opencast/pull/1791#discussion_r498718622", "bodyText": "However, then the series API and the event API will behave differently there.\n\nThat's a shame. When was that part of the API added? Would it still be possible to change it without breaking backwards compatibility?\nI do think that using the default ACL as fallback is not a good idea. For software using the API, this can easily lead to strange errors down the line. Even if these programs would explicitly check for an empty ACL and interpret it as \"ACL cannot be parsed\", then we have no way of actually communicating an empty ACL. (Not sure if that can ever happen.)\nIn my opinion, if parsing the ACL should never happen (as in: if it fails, there is a bug somewhere else in Opencast), then the API should return 5xx in that case. If parsing failure is somewhat expected and does not imply a bug in Opencast, then the API should explicitly return acl: null or something like that to clearly indicate broken ACL.\nIn this week alone, strange and unexpected behaviors of the API were brought up twice in our internal meetings. Everyone just sighs, maybe laughs, but then carries on. If the Opencast community just keeps adding to the pile of strange API things, the situation is only gonna get worse. I am obviously not blaming you by the way; it's just the community's stance on this issue that I kind of criticize.\nSo I personally would not merge this PR, but fix the behavior as stated above and if somehow possible also fix the behavior of the event API to make them consistent. That said, this is not for me to decide. Maybe the benefits of having this API in 9.x outweighs the disadvantages of the strangeness. Maybe this can still be fixed after the feature freeze. And I probably just lack experience in this community to know what's best.", "author": "LukasKalbertodt", "createdAt": "2020-10-02T09:37:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg2NzI0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODc0ODc1Mg==", "url": "https://github.com/opencast/opencast/pull/1791#discussion_r498748752", "bodyText": "I understands your frustration with the API in general and swallowing errors specifically , though I think this case isn't quite as bad. At least this way, Opencast offers a reasonable fallback (deny everything) instead of leaving every external system to figure this out for themselves.\nThe point of changing behaviour of existing API endpoints is that this can (per our rules) only be done for new API versions, so you would have to add a condition to the events API that handles broken ACLs differently for different versions. This is a general problem which stems from the trade-off between a stable API and improving things. Not sure if this case is worth it.", "author": "KatrinIhler", "createdAt": "2020-10-02T10:45:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg2NzI0Ng=="}], "type": "inlineReview", "revised_code": {"commit": "26fe93d5b93c28fb1e49095738edca57e3e72307", "chunk": "diff --git a/modules/external-api/src/main/java/org/opencastproject/external/endpoint/SeriesEndpoint.java b/modules/external-api/src/main/java/org/opencastproject/external/endpoint/SeriesEndpoint.java\nindex 85b0a6fdab..721903a778 100644\n--- a/modules/external-api/src/main/java/org/opencastproject/external/endpoint/SeriesEndpoint.java\n+++ b/modules/external-api/src/main/java/org/opencastproject/external/endpoint/SeriesEndpoint.java\n\n@@ -369,8 +371,9 @@ public class SeriesEndpoint {\n   private static AccessControlList getAclFromSeries(Series series) {\n     AccessControlList activeAcl = new AccessControlList();\n     try {\n-      if (series.getAccessPolicy() != null)\n+      if (series.getAccessPolicy() != null) {\n         activeAcl = AccessControlParser.parseAcl(series.getAccessPolicy());\n+      }\n     } catch (Exception e) {\n       logger.error(\"Unable to parse access policy\", e);\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg3Mjc0MQ==", "url": "https://github.com/opencast/opencast/pull/1791#discussion_r495872741", "bodyText": "Opencast doesn't have to be any enforced line length limit, but maybe it's time to break this line? This also applies to other places in this PR.", "author": "LukasKalbertodt", "createdAt": "2020-09-28T11:34:31Z", "path": "modules/external-api/src/main/java/org/opencastproject/external/endpoint/CaptureAgentsEndpoint.java", "diffHunk": "@@ -55,7 +55,7 @@\n import javax.ws.rs.core.Response;\n \n @Path(\"/\")\n-@Produces({ ApiMediaType.JSON, ApiMediaType.VERSION_1_1_0, ApiMediaType.VERSION_1_2_0, ApiMediaType.VERSION_1_3_0, ApiMediaType.VERSION_1_4_0 })\n+@Produces({ ApiMediaType.JSON, ApiMediaType.VERSION_1_1_0, ApiMediaType.VERSION_1_2_0, ApiMediaType.VERSION_1_3_0, ApiMediaType.VERSION_1_4_0, ApiMediaType.VERSION_1_5_0 })", "originalCommit": "661fab6c39d8ab045ba1e59cce4363ae4164be8a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY2NDg3Ng==", "url": "https://github.com/opencast/opencast/pull/1791#discussion_r498664876", "bodyText": "I'll break the lines containing the API versions. The rest I'll leave as is for now, otherwise I'll still be here tomorrow. ;)", "author": "KatrinIhler", "createdAt": "2020-10-02T07:48:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg3Mjc0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODcxMTY3Ng==", "url": "https://github.com/opencast/opencast/pull/1791#discussion_r498711676", "bodyText": "Looks good now. Apparently I can't \"resolve\" these PR comments. Feel free to resolve this one yourself.", "author": "LukasKalbertodt", "createdAt": "2020-10-02T09:22:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg3Mjc0MQ=="}], "type": "inlineReview", "revised_code": {"commit": "26fe93d5b93c28fb1e49095738edca57e3e72307", "chunk": "diff --git a/modules/external-api/src/main/java/org/opencastproject/external/endpoint/CaptureAgentsEndpoint.java b/modules/external-api/src/main/java/org/opencastproject/external/endpoint/CaptureAgentsEndpoint.java\nindex 9dff740b24..dd484e83d5 100644\n--- a/modules/external-api/src/main/java/org/opencastproject/external/endpoint/CaptureAgentsEndpoint.java\n+++ b/modules/external-api/src/main/java/org/opencastproject/external/endpoint/CaptureAgentsEndpoint.java\n\n@@ -55,7 +55,8 @@ import javax.ws.rs.QueryParam;\n import javax.ws.rs.core.Response;\n \n @Path(\"/\")\n-@Produces({ ApiMediaType.JSON, ApiMediaType.VERSION_1_1_0, ApiMediaType.VERSION_1_2_0, ApiMediaType.VERSION_1_3_0, ApiMediaType.VERSION_1_4_0, ApiMediaType.VERSION_1_5_0 })\n+@Produces({ ApiMediaType.JSON, ApiMediaType.VERSION_1_1_0, ApiMediaType.VERSION_1_2_0, ApiMediaType.VERSION_1_3_0,\n+            ApiMediaType.VERSION_1_4_0, ApiMediaType.VERSION_1_5_0 })\n @RestService(\n     name = \"externalapicaptureagents\",\n     title = \"External API Capture Agents Service\",\n"}}, {"oid": "26fe93d5b93c28fb1e49095738edca57e3e72307", "url": "https://github.com/opencast/opencast/commit/26fe93d5b93c28fb1e49095738edca57e3e72307", "message": "Review fixes", "committedDate": "2020-10-02T08:00:05Z", "type": "forcePushed"}, {"oid": "f3491bdbf344b36e09ea2818f69028b05557a763", "url": "https://github.com/opencast/opencast/commit/f3491bdbf344b36e09ea2818f69028b05557a763", "message": "Increase External API Version to 1.5.0", "committedDate": "2020-10-05T12:13:38Z", "type": "commit"}, {"oid": "4cd45962eb5976be6d4696a4186cf9efb9454e17", "url": "https://github.com/opencast/opencast/commit/4cd45962eb5976be6d4696a4186cf9efb9454e17", "message": "Add withacl option to API for series\n\nAdd withacl option to api/series/ and api/series/{seriesid} to\nadditionally receive the acl(s) of the series from the external API\nindex.", "committedDate": "2020-10-05T12:13:38Z", "type": "commit"}, {"oid": "09b606010405bfc4fa74e860fb501a070b161893", "url": "https://github.com/opencast/opencast/commit/09b606010405bfc4fa74e860fb501a070b161893", "message": "Review fixes", "committedDate": "2020-10-05T12:13:38Z", "type": "commit"}, {"oid": "09b606010405bfc4fa74e860fb501a070b161893", "url": "https://github.com/opencast/opencast/commit/09b606010405bfc4fa74e860fb501a070b161893", "message": "Review fixes", "committedDate": "2020-10-05T12:13:38Z", "type": "forcePushed"}]}