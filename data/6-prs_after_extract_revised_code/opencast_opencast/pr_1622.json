{"pr_number": 1622, "pr_title": "Fix LTI Without Persistence", "pr_createdAt": "2020-06-05T17:52:56Z", "pr_url": "https://github.com/opencast/opencast/pull/1622", "timeline": [{"oid": "b2dfd61aa1c46242ec93463c06b486628d308b7e", "url": "https://github.com/opencast/opencast/commit/b2dfd61aa1c46242ec93463c06b486628d308b7e", "message": "Reset LTI to 071f935\n\nThis patch resets the LtiLaunchAuthenticationHandler to git commit\n071f935, removing the introduced caching of requests which completely\nbroke LTI without persistent references (the default configuration).", "committedDate": "2020-06-05T14:48:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc5MjgzNA==", "url": "https://github.com/opencast/opencast/pull/1622#discussion_r436792834", "bodyText": "IMO the \"scare quotes\" should go, it's considered bad form.", "author": "gregorydlogan", "createdAt": "2020-06-08T15:24:16Z", "path": "modules/security-lti/src/main/java/org/opencastproject/security/lti/LtiLaunchAuthenticationHandler.java", "diffHunk": "@@ -290,42 +280,25 @@ public Authentication createAuthentication(HttpServletRequest request, ConsumerA\n       logger.debug(\"LTI user id is : {}\", username);\n     }\n \n-    UserDetails userDetails = null;\n-    Collection<GrantedAuthority> userAuthorities = new HashSet<>();\n+    UserDetails userDetails;\n+    Collection<GrantedAuthority> userAuthorities;\n     try {\n+      userDetails = userDetailsService.loadUserByUsername(username);\n \n-      userDetailsCache = CacheBuilder.newBuilder().expireAfterWrite(1, TimeUnit.MINUTES).build(new CacheLoader<String, Object>() {\n-\n-        @Override\n-        public Object load(String username) {\n-          logger.trace(\"Loading user '{}' from cache or by service\", username);\n-          UserDetails userDetails = userDetailsService.loadUserByUsername(username);\n-          return userDetails == null ? nullToken : userDetails;\n-        }\n-      });\n-\n-      try {\n-        // use #getUnchecked since the loader does not throw any checked exceptions\n-        userDetails = (UserDetails)userDetailsCache.getUnchecked(username);\n-        if (userDetails != nullToken) {\n-          // userDetails returns a Collection<? extends GrantedAuthority>, which cannot be directly casted to a\n-          // Collection<GrantedAuthority>.\n-          // On the other hand, one cannot add non-null elements or modify the existing ones in a Collection<? extends\n-          // GrantedAuthority>. Therefore, we *must* instantiate a new Collection<GrantedAuthority> (an ArrayList in this\n-          // case) and populate it with whatever elements are returned by getAuthorities()\n-          userAuthorities = new HashSet<>(userDetails.getAuthorities());\n-\n-          // we still need to enrich this user with the LTI Roles\n-          String roles = request.getParameter(ROLES);\n-          String context = request.getParameter(CONTEXT_ID);\n-          enrichRoleGrants(roles, context, userAuthorities);\n-        }\n-      } catch (UncheckedExecutionException e) {\n-        logger.warn(\"Exception while loading UserDetails from cache \" + username, e);\n-      }\n+      // userDetails returns a Collection<? extends GrantedAuthority>, which cannot be directly casted to a\n+      // Collection<GrantedAuthority>.\n+      // On the other hand, one cannot add non-null elements or modify the existing ones in a Collection<? extends\n+      // GrantedAuthority>. Therefore, we *must* instantiate a new Collection<GrantedAuthority> (an ArrayList in this\n+      // case) and populate it with whatever elements are returned by getAuthorities()\n+      userAuthorities = new HashSet<>(userDetails.getAuthorities());\n \n+      // we still need to enrich this user with the LTI Roles\n+      String roles = request.getParameter(ROLES);\n+      String context = request.getParameter(CONTEXT_ID);\n+      enrichRoleGrants(roles, context, userAuthorities);\n     } catch (UsernameNotFoundException e) {\n-      // This user is known to the tool consumer, but not to Opencast. Create a user \"on the fly\"\n+      logger.trace(\"This user is known to the tool consumer, but not to Opencast. Create a user `on the fly`\", e);", "originalCommit": "b217dfaff4e4417d53a0b1119836fd32543baa5f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "177334e0f03db53499acd29d07a11a45e6dbe4b5", "chunk": "diff --git a/modules/security-lti/src/main/java/org/opencastproject/security/lti/LtiLaunchAuthenticationHandler.java b/modules/security-lti/src/main/java/org/opencastproject/security/lti/LtiLaunchAuthenticationHandler.java\nindex b557b7c2c2..4b372df88e 100644\n--- a/modules/security-lti/src/main/java/org/opencastproject/security/lti/LtiLaunchAuthenticationHandler.java\n+++ b/modules/security-lti/src/main/java/org/opencastproject/security/lti/LtiLaunchAuthenticationHandler.java\n\n@@ -297,7 +297,7 @@ public class LtiLaunchAuthenticationHandler implements OAuthAuthenticationHandle\n       String context = request.getParameter(CONTEXT_ID);\n       enrichRoleGrants(roles, context, userAuthorities);\n     } catch (UsernameNotFoundException e) {\n-      logger.trace(\"This user is known to the tool consumer, but not to Opencast. Create a user `on the fly`\", e);\n+      logger.trace(\"This user is known to the tool consumer only. Creating an Opencast user on the fly.\", e);\n \n       userAuthorities = new HashSet<>();\n       // We should add the authorities passed in from the tool consumer?\n"}}, {"oid": "177334e0f03db53499acd29d07a11a45e6dbe4b5", "url": "https://github.com/opencast/opencast/commit/177334e0f03db53499acd29d07a11a45e6dbe4b5", "message": "Fix LTI Without persistence\n\nThis patch fixes LTI which was completely broken if persisting user\nreferences was not enabled and partly broken if it was enabled but the\nuser was not yet persisted.\n\nThis problem was caused by pull request #1532 which this pull request\ncomplete reverts.\n\nIn addition, this pull request fixes the problem #1532 was originally\nsupposed to fix: On concurrent LTI requests it could happen that\nOpencast would try to create the same user multiple times in parallel.\nThis patch fixes the problem by using an optimistic approach,\ndeliberately allowing an insert to fail, if an entry already exist.", "committedDate": "2020-06-08T16:04:24Z", "type": "commit"}, {"oid": "177334e0f03db53499acd29d07a11a45e6dbe4b5", "url": "https://github.com/opencast/opencast/commit/177334e0f03db53499acd29d07a11a45e6dbe4b5", "message": "Fix LTI Without persistence\n\nThis patch fixes LTI which was completely broken if persisting user\nreferences was not enabled and partly broken if it was enabled but the\nuser was not yet persisted.\n\nThis problem was caused by pull request #1532 which this pull request\ncomplete reverts.\n\nIn addition, this pull request fixes the problem #1532 was originally\nsupposed to fix: On concurrent LTI requests it could happen that\nOpencast would try to create the same user multiple times in parallel.\nThis patch fixes the problem by using an optimistic approach,\ndeliberately allowing an insert to fail, if an entry already exist.", "committedDate": "2020-06-08T16:04:24Z", "type": "forcePushed"}]}