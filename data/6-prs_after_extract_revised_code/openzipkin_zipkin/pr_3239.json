{"pr_number": 3239, "pr_title": "disallow trace requests", "pr_createdAt": "2020-10-15T19:01:03Z", "pr_url": "https://github.com/openzipkin/zipkin/pull/3239", "timeline": [{"oid": "51a8a53578f4c44d7458d8b682937cfa6fbca111", "url": "https://github.com/openzipkin/zipkin/commit/51a8a53578f4c44d7458d8b682937cfa6fbca111", "message": "add note about handling retention", "committedDate": "2020-07-25T13:13:55Z", "type": "commit"}, {"oid": "af182b80ba2a5a05272c0897acbbe17fbf6187df", "url": "https://github.com/openzipkin/zipkin/commit/af182b80ba2a5a05272c0897acbbe17fbf6187df", "message": "Merge pull request #2 from openzipkin/elastic-retention\n\nadd note about handling retention", "committedDate": "2020-07-25T13:17:48Z", "type": "commit"}, {"oid": "b9b8603bb2727c25f4792ffe84e012728115e5a0", "url": "https://github.com/openzipkin/zipkin/commit/b9b8603bb2727c25f4792ffe84e012728115e5a0", "message": "Merge branch 'master' of https://github.com/jorgheymans/zipkin", "committedDate": "2020-07-29T10:01:59Z", "type": "commit"}, {"oid": "13b5ee021dde3010dfec18bd21b3847f87e849e2", "url": "https://github.com/openzipkin/zipkin/commit/13b5ee021dde3010dfec18bd21b3847f87e849e2", "message": "Merge branch 'master' of https://github.com/openzipkin/zipkin", "committedDate": "2020-08-08T07:17:45Z", "type": "commit"}, {"oid": "674e82c2ffb569ed335a97deaa7f94ff9584bbc5", "url": "https://github.com/openzipkin/zipkin/commit/674e82c2ffb569ed335a97deaa7f94ff9584bbc5", "message": "Merge branch 'master' of https://github.com/openzipkin/zipkin", "committedDate": "2020-09-10T07:14:22Z", "type": "commit"}, {"oid": "66885b6a7a90b7ea5c30b76cf93499a288792105", "url": "https://github.com/openzipkin/zipkin/commit/66885b6a7a90b7ea5c30b76cf93499a288792105", "message": "Merge branch 'master' of https://github.com/openzipkin/zipkin", "committedDate": "2020-10-03T10:10:42Z", "type": "commit"}, {"oid": "7ad853d033919b6aa29763e6331bb0967286a246", "url": "https://github.com/openzipkin/zipkin/commit/7ad853d033919b6aa29763e6331bb0967286a246", "message": "Merge branch 'master' of https://github.com/openzipkin/zipkin", "committedDate": "2020-10-13T12:01:52Z", "type": "commit"}, {"oid": "d26e57ec7bfb0ddb3ee1339d63d43bd8d1a2d8a9", "url": "https://github.com/openzipkin/zipkin/commit/d26e57ec7bfb0ddb3ee1339d63d43bd8d1a2d8a9", "message": "Merge branch 'master' of https://github.com/openzipkin/zipkin", "committedDate": "2020-10-15T11:51:02Z", "type": "commit"}, {"oid": "4d031d59b42ce9d88145282c964806cb0ee11c17", "url": "https://github.com/openzipkin/zipkin/commit/4d031d59b42ce9d88145282c964806cb0ee11c17", "message": "add @Trace annotated method with regexp matching anything", "committedDate": "2020-10-15T18:37:13Z", "type": "commit"}, {"oid": "23b37654d8ed15b5038a8a48bf60d7c13802f89c", "url": "https://github.com/openzipkin/zipkin/commit/23b37654d8ed15b5038a8a48bf60d7c13802f89c", "message": "add test", "committedDate": "2020-10-15T18:58:32Z", "type": "commit"}, {"oid": "52903c44c018353b9403c850c297a5689bd8cc87", "url": "https://github.com/openzipkin/zipkin/commit/52903c44c018353b9403c850c297a5689bd8cc87", "message": "don't even need leading slash here", "committedDate": "2020-10-15T19:21:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc4NDgxMA==", "url": "https://github.com/openzipkin/zipkin/pull/3239#discussion_r505784810", "bodyText": "couldn't find a global toggle to disallow it, hence this workaround. @anuraaga does this please you ?", "author": "jorgheymans", "createdAt": "2020-10-15T19:23:14Z", "path": "zipkin-server/src/main/java/zipkin2/server/internal/ZipkinQueryApiV2.java", "diffHunk": "@@ -202,6 +204,12 @@ public AggregatedHttpResponse getAutocompleteValues(\n     return maybeCacheNames(values.size() > 3, values, ctx.alloc());\n   }\n \n+  @Trace(\"regex:^.*$\")", "originalCommit": "52903c44c018353b9403c850c297a5689bd8cc87", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk3NDk3OQ==", "url": "https://github.com/openzipkin/zipkin/pull/3239#discussion_r505974979", "bodyText": "@ikhoon @minwoox ^^", "author": "codefromthecrypt", "createdAt": "2020-10-16T01:49:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc4NDgxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk4MDAzMQ==", "url": "https://github.com/openzipkin/zipkin/pull/3239#discussion_r505980031", "bodyText": "How about using route?\nin ZipkinHttpConfiguration.java\n\nsb.route()\n  .methods(HttpMethod.TRACE)\n  .pathPrefix(\"/\")\n  .build((ctx, req) -> HttpResponse.of(HttpStatus.FORBIDDEN));", "author": "minwoox", "createdAt": "2020-10-16T01:59:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc4NDgxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk4MjM3OQ==", "url": "https://github.com/openzipkin/zipkin/pull/3239#discussion_r505982379", "bodyText": "@jorgheymans Created an issue for that. \ud83d\ude04\nline/armeria#3114", "author": "minwoox", "createdAt": "2020-10-16T02:05:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc4NDgxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk5MzI3Mw==", "url": "https://github.com/openzipkin/zipkin/pull/3239#discussion_r505993273", "bodyText": "I think a decorator would be better to forbid TRACE requests because it could have higher priority than HTTP services.\nsb.routeDecorator()\n  .methods(HttpMethod.TRACE)\n  .pathPrefix(\"/\")\n  .build((delegate, ctx, req) -> HttpResponse.of(HttpStatus.FORBIDDEN));", "author": "ikhoon", "createdAt": "2020-10-16T02:25:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc4NDgxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk2NjEwNA==", "url": "https://github.com/openzipkin/zipkin/pull/3239#discussion_r506966104", "bodyText": "thanks for the suggestions, i added the routeDecorator.", "author": "jorgheymans", "createdAt": "2020-10-17T17:39:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc4NDgxMA=="}], "type": "inlineReview", "revised_code": {"commit": "b5952f42c89433728f487aa0b44c3ac57af86a86", "chunk": "diff --git a/zipkin-server/src/main/java/zipkin2/server/internal/ZipkinQueryApiV2.java b/zipkin-server/src/main/java/zipkin2/server/internal/ZipkinQueryApiV2.java\nindex 24dbbbdec..542d3ec14 100644\n--- a/zipkin-server/src/main/java/zipkin2/server/internal/ZipkinQueryApiV2.java\n+++ b/zipkin-server/src/main/java/zipkin2/server/internal/ZipkinQueryApiV2.java\n\n@@ -204,12 +202,6 @@ public class ZipkinQueryApiV2 {\n     return maybeCacheNames(values.size() > 3, values, ctx.alloc());\n   }\n \n-  @Trace(\"regex:^.*$\")\n-  public AggregatedHttpResponse disallowTraceRequests() {\n-    // because https://github.com/openzipkin/zipkin/issues/2286\n-    return AggregatedHttpResponse.of(HttpStatus.FORBIDDEN);\n-  }\n-\n   /**\n    * We cache names if there are more than 3 names. This helps people getting started: if we cache\n    * empty results, users have more questions. We assume caching becomes a concern when zipkin is in\n"}}, {"oid": "b5952f42c89433728f487aa0b44c3ac57af86a86", "url": "https://github.com/openzipkin/zipkin/commit/b5952f42c89433728f487aa0b44c3ac57af86a86", "message": "follow recommendation of Armeria devs on how to disallow TRACE requests", "committedDate": "2020-10-17T17:37:22Z", "type": "commit"}]}