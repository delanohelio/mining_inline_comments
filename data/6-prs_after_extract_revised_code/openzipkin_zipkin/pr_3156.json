{"pr_number": 3156, "pr_title": "Stops using prepared or query builder statements for simple queries", "pr_createdAt": "2020-08-02T06:21:25Z", "pr_url": "https://github.com/openzipkin/zipkin/pull/3156", "timeline": [{"oid": "83421cb8edeb7d1b1927a3aff0d290fd9098cfb9", "url": "https://github.com/openzipkin/zipkin/commit/83421cb8edeb7d1b1927a3aff0d290fd9098cfb9", "message": "Stops using prepared or query builder statements for simply queries\n\nBefore, we needlessly prepared service name query, which would have no\nparameters. While, this is being followed up below, it is unlikely that\npreparing is better than directly executing the statement:\nhttps://groups.google.com/a/lists.datastax.com/forum/#!topic/java-driver-user/d6wLkH3xDLI\n\nMore importantly, there is a bug in the cassandra driver >v3.6 which\ncrashes on `QueryBuilder` statements that have no parameters. This\nuses a simple statement for that instead (healthcheck). Moreover, the\nlog category that shows connection failures is now suggested in our\ndocs.\n\nSee https://github.com/datastax/java-driver/pull/1138 for the NPE", "committedDate": "2020-08-02T06:45:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDAzOTc5Mw==", "url": "https://github.com/openzipkin/zipkin/pull/3156#discussion_r464039793", "bodyText": "Guess the world still builds SQL by concatenate strings :)", "author": "anuraaga", "createdAt": "2020-08-02T06:45:11Z", "path": "zipkin-storage/cassandra-v1/src/main/java/zipkin2/storage/cassandra/v1/CassandraStorage.java", "diffHunk": "@@ -384,7 +383,11 @@ public SpanConsumer spanConsumer() {\n   public CheckResult check() {\n     if (closeCalled) throw new IllegalStateException(\"closed\");\n     try {\n-      session.get().execute(QueryBuilder.select(\"trace_id\").from(\"traces\").limit(1));\n+      // Use direct CQL instead of query builder for simple statements.", "originalCommit": "213802671eec281c2dabeaf066dcc73aecc7752c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "83421cb8edeb7d1b1927a3aff0d290fd9098cfb9", "url": "https://github.com/openzipkin/zipkin/commit/83421cb8edeb7d1b1927a3aff0d290fd9098cfb9", "message": "Stops using prepared or query builder statements for simply queries\n\nBefore, we needlessly prepared service name query, which would have no\nparameters. While, this is being followed up below, it is unlikely that\npreparing is better than directly executing the statement:\nhttps://groups.google.com/a/lists.datastax.com/forum/#!topic/java-driver-user/d6wLkH3xDLI\n\nMore importantly, there is a bug in the cassandra driver >v3.6 which\ncrashes on `QueryBuilder` statements that have no parameters. This\nuses a simple statement for that instead (healthcheck). Moreover, the\nlog category that shows connection failures is now suggested in our\ndocs.\n\nSee https://github.com/datastax/java-driver/pull/1138 for the NPE", "committedDate": "2020-08-02T06:45:11Z", "type": "forcePushed"}, {"oid": "60d63a17d852fa22527d832eebc2ef4bddb46301", "url": "https://github.com/openzipkin/zipkin/commit/60d63a17d852fa22527d832eebc2ef4bddb46301", "message": "revise logging", "committedDate": "2020-08-02T07:06:33Z", "type": "commit"}]}