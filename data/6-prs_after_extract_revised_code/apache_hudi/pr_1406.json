{"pr_number": 1406, "pr_title": "[HUDI-713] Fix conversion of Spark array of struct type to Avro schema", "pr_createdAt": "2020-03-15T01:59:52Z", "pr_url": "https://github.com/apache/hudi/pull/1406", "timeline": [{"oid": "dec5a88fbc287d95fc2277167ad9f44b53a00060", "url": "https://github.com/apache/hudi/commit/dec5a88fbc287d95fc2277167ad9f44b53a00060", "message": "[HUDI-713] Fix conversion of Spark array of struct type to Avro schema", "committedDate": "2020-03-16T17:35:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA2OTgyOA==", "url": "https://github.com/apache/hudi/pull/1406#discussion_r394069828", "bodyText": "From what I understand, and if you look at the schema generated by Hudi as well..shouldn't the record name tip also be tip_history instead ?", "author": "umehrot2", "createdAt": "2020-03-18T02:14:04Z", "path": "hudi-client/src/test/java/org/apache/hudi/common/HoodieTestDataGenerator.java", "diffHunk": "@@ -81,10 +82,12 @@\n       + \"{\\\"name\\\": \\\"end_lat\\\", \\\"type\\\": \\\"double\\\"},\" + \"{\\\"name\\\": \\\"end_lon\\\", \\\"type\\\": \\\"double\\\"},\"\n       + \"{\\\"name\\\": \\\"fare\\\",\\\"type\\\": {\\\"type\\\":\\\"record\\\", \\\"name\\\":\\\"fare\\\",\\\"fields\\\": [\"\n       + \"{\\\"name\\\": \\\"amount\\\",\\\"type\\\": \\\"double\\\"},{\\\"name\\\": \\\"currency\\\", \\\"type\\\": \\\"string\\\"}]}},\"\n+      + \"{\\\"name\\\": \\\"tip_history\\\", \\\"type\\\": {\\\"type\\\": \\\"array\\\", \\\"items\\\": {\\\"type\\\": \\\"record\\\", \\\"name\\\": \\\"tip\\\", \\\"fields\\\": [\"\n+      + \"{\\\"name\\\": \\\"amount\\\", \\\"type\\\": \\\"double\\\"}, {\\\"name\\\": \\\"currency\\\", \\\"type\\\": \\\"string\\\"}]}}},\"", "originalCommit": "dec5a88fbc287d95fc2277167ad9f44b53a00060", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc4OTEyMA==", "url": "https://github.com/apache/hudi/pull/1406#discussion_r395789120", "bodyText": "Right. Replaced now.", "author": "zhedoubushishi", "createdAt": "2020-03-20T17:31:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA2OTgyOA=="}], "type": "inlineReview", "revised_code": {"commit": "2183ad041de499157a252873d71b23ea21348250", "chunk": "diff --git a/hudi-client/src/test/java/org/apache/hudi/common/HoodieTestDataGenerator.java b/hudi-client/src/test/java/org/apache/hudi/common/HoodieTestDataGenerator.java\nindex f777b7f05a..44547e9494 100644\n--- a/hudi-client/src/test/java/org/apache/hudi/common/HoodieTestDataGenerator.java\n+++ b/hudi-client/src/test/java/org/apache/hudi/common/HoodieTestDataGenerator.java\n\n@@ -75,22 +76,33 @@ public class HoodieTestDataGenerator {\n   public static final String[] DEFAULT_PARTITION_PATHS =\n       {DEFAULT_FIRST_PARTITION_PATH, DEFAULT_SECOND_PARTITION_PATH, DEFAULT_THIRD_PARTITION_PATH};\n   public static final int DEFAULT_PARTITION_DEPTH = 3;\n-  public static final String TRIP_EXAMPLE_SCHEMA = \"{\\\"type\\\": \\\"record\\\",\" + \"\\\"name\\\": \\\"triprec\\\",\" + \"\\\"fields\\\": [ \"\n+  public static final String TRIP_SCHEMA_PREFIX = \"{\\\"type\\\": \\\"record\\\",\" + \"\\\"name\\\": \\\"triprec\\\",\" + \"\\\"fields\\\": [ \"\n       + \"{\\\"name\\\": \\\"timestamp\\\",\\\"type\\\": \\\"double\\\"},\" + \"{\\\"name\\\": \\\"_row_key\\\", \\\"type\\\": \\\"string\\\"},\"\n       + \"{\\\"name\\\": \\\"rider\\\", \\\"type\\\": \\\"string\\\"},\" + \"{\\\"name\\\": \\\"driver\\\", \\\"type\\\": \\\"string\\\"},\"\n       + \"{\\\"name\\\": \\\"begin_lat\\\", \\\"type\\\": \\\"double\\\"},\" + \"{\\\"name\\\": \\\"begin_lon\\\", \\\"type\\\": \\\"double\\\"},\"\n-      + \"{\\\"name\\\": \\\"end_lat\\\", \\\"type\\\": \\\"double\\\"},\" + \"{\\\"name\\\": \\\"end_lon\\\", \\\"type\\\": \\\"double\\\"},\"\n-      + \"{\\\"name\\\": \\\"fare\\\",\\\"type\\\": {\\\"type\\\":\\\"record\\\", \\\"name\\\":\\\"fare\\\",\\\"fields\\\": [\"\n-      + \"{\\\"name\\\": \\\"amount\\\",\\\"type\\\": \\\"double\\\"},{\\\"name\\\": \\\"currency\\\", \\\"type\\\": \\\"string\\\"}]}},\"\n-      + \"{\\\"name\\\": \\\"tip_history\\\", \\\"type\\\": {\\\"type\\\": \\\"array\\\", \\\"items\\\": {\\\"type\\\": \\\"record\\\", \\\"name\\\": \\\"tip\\\", \\\"fields\\\": [\"\n-      + \"{\\\"name\\\": \\\"amount\\\", \\\"type\\\": \\\"double\\\"}, {\\\"name\\\": \\\"currency\\\", \\\"type\\\": \\\"string\\\"}]}}},\"\n-      + \"{\\\"name\\\": \\\"_hoodie_is_deleted\\\", \\\"type\\\": \\\"boolean\\\", \\\"default\\\": false} ]}\";\n+      + \"{\\\"name\\\": \\\"end_lat\\\", \\\"type\\\": \\\"double\\\"},\" + \"{\\\"name\\\": \\\"end_lon\\\", \\\"type\\\": \\\"double\\\"},\";\n+  public static final String TRIP_SCHEMA_SUFFIX = \"{\\\"name\\\": \\\"_hoodie_is_deleted\\\", \\\"type\\\": \\\"boolean\\\", \\\"default\\\": false} ]}\";\n+  public static final String FARE_NESTED_SCHEMA = \"{\\\"name\\\": \\\"fare\\\",\\\"type\\\": {\\\"type\\\":\\\"record\\\", \\\"name\\\":\\\"fare\\\",\\\"fields\\\": [\"\n+      + \"{\\\"name\\\": \\\"amount\\\",\\\"type\\\": \\\"double\\\"},{\\\"name\\\": \\\"currency\\\", \\\"type\\\": \\\"string\\\"}]}},\";\n+  public static final String FARE_FLATTENED_SCHEMA = \"{\\\"name\\\": \\\"fare\\\", \\\"type\\\": \\\"double\\\"},\"\n+      + \"{\\\"name\\\": \\\"currency\\\", \\\"type\\\": \\\"string\\\"},\";\n+  public static final String TIP_NESTED_SCHEMA = \"{\\\"name\\\": \\\"tip_history\\\", \\\"type\\\": {\\\"type\\\": \\\"array\\\", \\\"items\\\": {\\\"type\\\": \\\"record\\\", \\\"name\\\": \\\"tip_history\\\", \\\"fields\\\": [\"\n+      + \"{\\\"name\\\": \\\"amount\\\", \\\"type\\\": \\\"double\\\"}, {\\\"name\\\": \\\"currency\\\", \\\"type\\\": \\\"string\\\"}]}}},\";\n+  public static final String MAP_TYPE_SCHEMA = \"{\\\"name\\\": \\\"city_to_state\\\", \\\"type\\\": {\\\"type\\\": \\\"map\\\", \\\"values\\\": \\\"string\\\"}},\";\n+\n+  public static final String TRIP_EXAMPLE_SCHEMA =\n+      TRIP_SCHEMA_PREFIX + MAP_TYPE_SCHEMA + FARE_NESTED_SCHEMA + TIP_NESTED_SCHEMA + TRIP_SCHEMA_SUFFIX;\n+  public static final String TRIP_FLATTENED_SCHEMA =\n+      TRIP_SCHEMA_PREFIX + FARE_FLATTENED_SCHEMA + TRIP_SCHEMA_SUFFIX;\n+\n   public static final String NULL_SCHEMA = Schema.create(Schema.Type.NULL).toString();\n   public static final String TRIP_HIVE_COLUMN_TYPES = \"double,string,string,string,double,double,double,double,\"\n-                                                  + \"struct<amount:double,currency:string>,array<struct<amount:double,currency:string>>,boolean\";\n+      + \"map<string,string>,struct<amount:double,currency:string>,array<struct<amount:double,currency:string>>,boolean\";\n+\n   public static final Schema AVRO_SCHEMA = new Schema.Parser().parse(TRIP_EXAMPLE_SCHEMA);\n   public static final Schema AVRO_SCHEMA_WITH_METADATA_FIELDS =\n       HoodieAvroUtils.addMetadataFields(AVRO_SCHEMA);\n+  public static final Schema FLATTENED_AVRO_SCHEMA = new Schema.Parser().parse(TRIP_FLATTENED_SCHEMA);\n \n   private static final Random RAND = new Random(46474747);\n \n"}}, {"oid": "2183ad041de499157a252873d71b23ea21348250", "url": "https://github.com/apache/hudi/commit/2183ad041de499157a252873d71b23ea21348250", "message": "[HUDI-713] Fix conversion of Spark array of struct type to Avro schema", "committedDate": "2020-03-20T05:43:12Z", "type": "commit"}, {"oid": "2183ad041de499157a252873d71b23ea21348250", "url": "https://github.com/apache/hudi/commit/2183ad041de499157a252873d71b23ea21348250", "message": "[HUDI-713] Fix conversion of Spark array of struct type to Avro schema", "committedDate": "2020-03-20T05:43:12Z", "type": "forcePushed"}]}