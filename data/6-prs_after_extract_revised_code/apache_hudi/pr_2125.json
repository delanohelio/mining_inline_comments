{"pr_number": 2125, "pr_title": "[HUDI-1301] use spark INCREMENTAL mode query hudi dataset support sch\u2026", "pr_createdAt": "2020-09-28T02:13:31Z", "pr_url": "https://github.com/apache/hudi/pull/2125", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjgwMjgxMA==", "url": "https://github.com/apache/hudi/pull/2125#discussion_r496802810", "bodyText": "Is getTableAvroSchemaWithoutMetadataFields more proper?", "author": "leesf", "createdAt": "2020-09-29T15:16:31Z", "path": "hudi-common/src/main/java/org/apache/hudi/common/table/TableSchemaResolver.java", "diffHunk": "@@ -175,20 +175,45 @@ public MessageType getTableParquetSchema() throws Exception {\n    * @throws Exception\n    */\n   public Schema getTableAvroSchemaWithoutMetadataFields() throws Exception {\n-    Option<Schema> schemaFromCommitMetadata = getTableSchemaFromCommitMetadata(false);\n+    HoodieTimeline timeline = metaClient.getActiveTimeline().getCommitsTimeline().filterCompletedInstants();\n+    Option<Schema> schemaFromCommitMetadata = getTableSchemaFromCommitMetadata(timeline.lastInstant().get(), false);\n     return schemaFromCommitMetadata.isPresent() ? schemaFromCommitMetadata.get() :\n            HoodieAvroUtils.removeMetadataFields(getTableAvroSchemaFromDataFile());\n   }\n \n+  /**\n+   * Gets users data schema for a hoodie table in Avro format of the instant.\n+   *\n+   * @param instant will get the instant data schema\n+   * @return  Avro user data schema\n+   * @throws Exception\n+   */\n+  public Schema getTableAvroSchemaWithoutMetadataFieldsForInstant(HoodieInstant instant) throws Exception {", "originalCommit": "1cbd9a4e2dc0210cc02b3e31ee2bdbce060c3781", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjgzMTk3NA==", "url": "https://github.com/apache/hudi/pull/2125#discussion_r496831974", "bodyText": "ok", "author": "lw309637554", "createdAt": "2020-09-29T15:44:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjgwMjgxMA=="}], "type": "inlineReview", "revised_code": {"commit": "6a508f4da106b50c67cebdd0b700184994848079", "chunk": "diff --git a/hudi-common/src/main/java/org/apache/hudi/common/table/TableSchemaResolver.java b/hudi-common/src/main/java/org/apache/hudi/common/table/TableSchemaResolver.java\nindex a6dc8de162..372b3936b5 100644\n--- a/hudi-common/src/main/java/org/apache/hudi/common/table/TableSchemaResolver.java\n+++ b/hudi-common/src/main/java/org/apache/hudi/common/table/TableSchemaResolver.java\n\n@@ -188,8 +188,8 @@ public class TableSchemaResolver {\n    * @return  Avro user data schema\n    * @throws Exception\n    */\n-  public Schema getTableAvroSchemaWithoutMetadataFieldsForInstant(HoodieInstant instant) throws Exception {\n-    Option<Schema> schemaFromCommitMetadata = getTableSchemaFromCommitMetadata(instant,false);\n+  public Schema getTableAvroSchemaWithoutMetadataFields(HoodieInstant instant) throws Exception {\n+    Option<Schema> schemaFromCommitMetadata = getTableSchemaFromCommitMetadata(instant, false);\n     return schemaFromCommitMetadata.isPresent() ? schemaFromCommitMetadata.get() :\n         HoodieAvroUtils.removeMetadataFields(getTableAvroSchemaFromDataFile());\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjgwNDUwMQ==", "url": "https://github.com/apache/hudi/pull/2125#discussion_r496804501", "bodyText": "instant,false -> instant, false", "author": "leesf", "createdAt": "2020-09-29T15:18:53Z", "path": "hudi-common/src/main/java/org/apache/hudi/common/table/TableSchemaResolver.java", "diffHunk": "@@ -175,20 +175,45 @@ public MessageType getTableParquetSchema() throws Exception {\n    * @throws Exception\n    */\n   public Schema getTableAvroSchemaWithoutMetadataFields() throws Exception {\n-    Option<Schema> schemaFromCommitMetadata = getTableSchemaFromCommitMetadata(false);\n+    HoodieTimeline timeline = metaClient.getActiveTimeline().getCommitsTimeline().filterCompletedInstants();\n+    Option<Schema> schemaFromCommitMetadata = getTableSchemaFromCommitMetadata(timeline.lastInstant().get(), false);\n     return schemaFromCommitMetadata.isPresent() ? schemaFromCommitMetadata.get() :\n            HoodieAvroUtils.removeMetadataFields(getTableAvroSchemaFromDataFile());\n   }\n \n+  /**\n+   * Gets users data schema for a hoodie table in Avro format of the instant.\n+   *\n+   * @param instant will get the instant data schema\n+   * @return  Avro user data schema\n+   * @throws Exception\n+   */\n+  public Schema getTableAvroSchemaWithoutMetadataFieldsForInstant(HoodieInstant instant) throws Exception {\n+    Option<Schema> schemaFromCommitMetadata = getTableSchemaFromCommitMetadata(instant,false);", "originalCommit": "1cbd9a4e2dc0210cc02b3e31ee2bdbce060c3781", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjgzMTgwMw==", "url": "https://github.com/apache/hudi/pull/2125#discussion_r496831803", "bodyText": "ok", "author": "lw309637554", "createdAt": "2020-09-29T15:44:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjgwNDUwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "6a508f4da106b50c67cebdd0b700184994848079", "chunk": "diff --git a/hudi-common/src/main/java/org/apache/hudi/common/table/TableSchemaResolver.java b/hudi-common/src/main/java/org/apache/hudi/common/table/TableSchemaResolver.java\nindex a6dc8de162..372b3936b5 100644\n--- a/hudi-common/src/main/java/org/apache/hudi/common/table/TableSchemaResolver.java\n+++ b/hudi-common/src/main/java/org/apache/hudi/common/table/TableSchemaResolver.java\n\n@@ -188,8 +188,8 @@ public class TableSchemaResolver {\n    * @return  Avro user data schema\n    * @throws Exception\n    */\n-  public Schema getTableAvroSchemaWithoutMetadataFieldsForInstant(HoodieInstant instant) throws Exception {\n-    Option<Schema> schemaFromCommitMetadata = getTableSchemaFromCommitMetadata(instant,false);\n+  public Schema getTableAvroSchemaWithoutMetadataFields(HoodieInstant instant) throws Exception {\n+    Option<Schema> schemaFromCommitMetadata = getTableSchemaFromCommitMetadata(instant, false);\n     return schemaFromCommitMetadata.isPresent() ? schemaFromCommitMetadata.get() :\n         HoodieAvroUtils.removeMetadataFields(getTableAvroSchemaFromDataFile());\n   }\n"}}, {"oid": "6a508f4da106b50c67cebdd0b700184994848079", "url": "https://github.com/apache/hudi/commit/6a508f4da106b50c67cebdd0b700184994848079", "message": "[HUDI-1301] use spark INCREMENTAL mode query hudi dataset support schema version", "committedDate": "2020-09-29T15:48:21Z", "type": "forcePushed"}, {"oid": "0202e025d210f54fd8252641fa7101a2e63e71dc", "url": "https://github.com/apache/hudi/commit/0202e025d210f54fd8252641fa7101a2e63e71dc", "message": "[HUDI-1301] use spark INCREMENTAL mode query hudi dataset support schema version.", "committedDate": "2020-09-30T02:00:55Z", "type": "forcePushed"}, {"oid": "a8002b43c7edb4e19d3b32b87614d63cdbf81f56", "url": "https://github.com/apache/hudi/commit/a8002b43c7edb4e19d3b32b87614d63cdbf81f56", "message": "[HUDI-1301] use spark INCREMENTAL mode query hudi dataset support schema version.", "committedDate": "2020-10-03T14:11:12Z", "type": "forcePushed"}, {"oid": "04408df5e8351dc9411f6f7180d38400fa9dd5cb", "url": "https://github.com/apache/hudi/commit/04408df5e8351dc9411f6f7180d38400fa9dd5cb", "message": "[HUDI-1301]  use spark INCREMENTAL mode query hudi dataset support schema version.", "committedDate": "2020-10-03T15:10:59Z", "type": "forcePushed"}, {"oid": "a28e7a1461ca9df16ffa11b42c07082f17aa2e47", "url": "https://github.com/apache/hudi/commit/a28e7a1461ca9df16ffa11b42c07082f17aa2e47", "message": "[HUDI-1301]  use  spark INCREMENTAL mode query hudi dataset support schema version.", "committedDate": "2020-10-03T16:22:15Z", "type": "forcePushed"}, {"oid": "8d2f66b36b1ffb0476443c131db066d1bbcbc3d6", "url": "https://github.com/apache/hudi/commit/8d2f66b36b1ffb0476443c131db066d1bbcbc3d6", "message": "[HUDI-1301]  use  spark INCREMENTAL mode query hudi dataset support schema version.", "committedDate": "2020-10-08T15:18:05Z", "type": "forcePushed"}, {"oid": "a33b191a4b1ddc9cb2e592aa3a1af5c491b465b0", "url": "https://github.com/apache/hudi/commit/a33b191a4b1ddc9cb2e592aa3a1af5c491b465b0", "message": "[HUDI-1301]  use  spark INCREMENTAL mode query hudi dataset support schema version.", "committedDate": "2020-10-10T09:12:13Z", "type": "forcePushed"}, {"oid": "0b5c440655d07172a8a4c1243503cb8ca4f555f5", "url": "https://github.com/apache/hudi/commit/0b5c440655d07172a8a4c1243503cb8ca4f555f5", "message": "[HUDI-1301]  use  spark INCREMENTAL mode query hudi dataset support schema version.", "committedDate": "2020-10-10T11:23:04Z", "type": "commit"}, {"oid": "0b5c440655d07172a8a4c1243503cb8ca4f555f5", "url": "https://github.com/apache/hudi/commit/0b5c440655d07172a8a4c1243503cb8ca4f555f5", "message": "[HUDI-1301]  use  spark INCREMENTAL mode query hudi dataset support schema version.", "committedDate": "2020-10-10T11:23:04Z", "type": "forcePushed"}]}