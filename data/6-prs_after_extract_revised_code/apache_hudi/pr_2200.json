{"pr_number": 2200, "pr_title": "[HUDI-912]Refactor and relocate KeyGenerator to support more engines", "pr_createdAt": "2020-10-22T13:51:53Z", "pr_url": "https://github.com/apache/hudi/pull/2200", "timeline": [{"oid": "c34ace12afae11a6011a6d4933c4c554118cc82e", "url": "https://github.com/apache/hudi/commit/c34ace12afae11a6011a6d4933c4c554118cc82e", "message": "[HUDI-912][WIP]Refactor and relocate KeyGenerator to support more engines", "committedDate": "2020-10-22T13:55:20Z", "type": "forcePushed"}, {"oid": "26d6459163dc0e1afa93fd9ace47fa23f7cd1cac", "url": "https://github.com/apache/hudi/commit/26d6459163dc0e1afa93fd9ace47fa23f7cd1cac", "message": "[HUDI-912][WIP]Refactor and relocate KeyGenerator to support more engines", "committedDate": "2020-10-23T03:05:03Z", "type": "forcePushed"}, {"oid": "de9dc93ff7341d9f818727c984f9a9989b0b4be6", "url": "https://github.com/apache/hudi/commit/de9dc93ff7341d9f818727c984f9a9989b0b4be6", "message": "[HUDI-912][WIP]Refactor and relocate KeyGenerator to support more engines", "committedDate": "2020-10-23T03:41:41Z", "type": "forcePushed"}, {"oid": "1d7b1778c0acc7c42867230b2cd0500a33cacf10", "url": "https://github.com/apache/hudi/commit/1d7b1778c0acc7c42867230b2cd0500a33cacf10", "message": "[HUDI-912][WIP]Refactor and relocate KeyGenerator to support more engines", "committedDate": "2020-10-23T04:32:38Z", "type": "forcePushed"}, {"oid": "66aea93da8c1aa3254b835cfa5e4fa8593f7b094", "url": "https://github.com/apache/hudi/commit/66aea93da8c1aa3254b835cfa5e4fa8593f7b094", "message": "[HUDI-912][WIP]Refactor and relocate KeyGenerator to support more engines", "committedDate": "2020-10-23T05:00:40Z", "type": "forcePushed"}, {"oid": "a7c54a88e0426f25665624b25cbe7efebea54f6e", "url": "https://github.com/apache/hudi/commit/a7c54a88e0426f25665624b25cbe7efebea54f6e", "message": "[HUDI-912][WIP]Refactor and relocate KeyGenerator to support more engines", "committedDate": "2020-10-23T05:04:43Z", "type": "forcePushed"}, {"oid": "8bdea5d0f14ad0c47f671f01cf5fef4457c87677", "url": "https://github.com/apache/hudi/commit/8bdea5d0f14ad0c47f671f01cf5fef4457c87677", "message": "[HUDI-912][WIP]Refactor and relocate KeyGenerator to support more engines", "committedDate": "2020-10-23T05:09:38Z", "type": "forcePushed"}, {"oid": "12d34b1c1f89d2a48de04d52ec925d9d9733cc1f", "url": "https://github.com/apache/hudi/commit/12d34b1c1f89d2a48de04d52ec925d9d9733cc1f", "message": "[HUDI-912][WIP]Refactor and relocate KeyGenerator to support more engines", "committedDate": "2020-10-23T05:12:22Z", "type": "forcePushed"}, {"oid": "970a6e5ba50e003576f08b889d8d9552945f8e7d", "url": "https://github.com/apache/hudi/commit/970a6e5ba50e003576f08b889d8d9552945f8e7d", "message": "[HUDI-912][WIP]Refactor and relocate KeyGenerator to support more engines", "committedDate": "2020-10-23T05:16:14Z", "type": "forcePushed"}, {"oid": "7dcd1156d0a8ec55cdcaf1125bf4d568e6062c32", "url": "https://github.com/apache/hudi/commit/7dcd1156d0a8ec55cdcaf1125bf4d568e6062c32", "message": "[HUDI-912][WIP]Refactor and relocate KeyGenerator to support more engines", "committedDate": "2020-10-23T14:28:02Z", "type": "forcePushed"}, {"oid": "f1a0256db22b786983f49c5d0a8e704ab1c74ece", "url": "https://github.com/apache/hudi/commit/f1a0256db22b786983f49c5d0a8e704ab1c74ece", "message": "[HUDI-912][WIP]Refactor and relocate KeyGenerator to support more engines", "committedDate": "2020-10-23T15:25:47Z", "type": "forcePushed"}, {"oid": "9edd7ea4edde76b31e61ec44d75401d939d4275f", "url": "https://github.com/apache/hudi/commit/9edd7ea4edde76b31e61ec44d75401d939d4275f", "message": "[HUDI-912] Refactor and relocate KeyGenerator to support more engines", "committedDate": "2020-10-24T02:01:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQ4MDM5MQ==", "url": "https://github.com/apache/hudi/pull/2200#discussion_r513480391", "bodyText": "would this change the above behavior? above would also get row.get", "author": "leesf", "createdAt": "2020-10-28T14:18:20Z", "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/keygen/CustomKeyGenerator.java", "diffHunk": "@@ -94,27 +82,18 @@ private String getPartitionPath(Option<GenericRecord> record, Option<Row> row) {\n       PartitionKeyType keyType = PartitionKeyType.valueOf(fieldWithType[1].toUpperCase());\n       switch (keyType) {\n         case SIMPLE:\n-          if (record.isPresent()) {\n-            partitionPath.append(new SimpleKeyGenerator(config, partitionPathField).getPartitionPath(record.get()));\n-          } else {\n-            partitionPath.append(new SimpleKeyGenerator(config, partitionPathField).getPartitionPath(row.get()));\n-          }\n+          partitionPath.append(new SimpleKeyGenerator(config, partitionPathField).getPartitionPath(record));", "originalCommit": "9edd7ea4edde76b31e61ec44d75401d939d4275f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6be7a546e1c4ef26be51602c1ce9a08d88250d74", "chunk": "diff --git a/hudi-client/hudi-client-common/src/main/java/org/apache/hudi/keygen/CustomKeyGenerator.java b/hudi-client/hudi-client-common/src/main/java/org/apache/hudi/keygen/CommonCustomKeyGenerator.java\nsimilarity index 83%\nrename from hudi-client/hudi-client-common/src/main/java/org/apache/hudi/keygen/CustomKeyGenerator.java\nrename to hudi-client/hudi-client-common/src/main/java/org/apache/hudi/keygen/CommonCustomKeyGenerator.java\nindex e57313dcc5..76c8b82acd 100644\n--- a/hudi-client/hudi-client-common/src/main/java/org/apache/hudi/keygen/CustomKeyGenerator.java\n+++ b/hudi-client/hudi-client-common/src/main/java/org/apache/hudi/keygen/CommonCustomKeyGenerator.java\n\n@@ -82,17 +82,17 @@ public class CustomKeyGenerator extends BuiltinKeyGenerator {\n       PartitionKeyType keyType = PartitionKeyType.valueOf(fieldWithType[1].toUpperCase());\n       switch (keyType) {\n         case SIMPLE:\n-          partitionPath.append(new SimpleKeyGenerator(config, partitionPathField).getPartitionPath(record));\n+          partitionPath.append(new CommonSimpleKeyGenerator(config, partitionPathField).getPartitionPath(record));\n           break;\n         case TIMESTAMP:\n           try {\n-            partitionPath.append(new TimestampBasedKeyGenerator(config, partitionPathField).getPartitionPath(record));\n+            partitionPath.append(new CommonTimestampBasedKeyGenerator(config, partitionPathField).getPartitionPath(record));\n           } catch (IOException e) {\n-            throw new HoodieDeltaStreamerException(\"Unable to initialise TimestampBasedKeyGenerator class\");\n+            throw new HoodieKeyGenerateException(\"Unable to initialise TimestampBasedKeyGenerator class\");\n           }\n           break;\n         default:\n-          throw new HoodieDeltaStreamerException(\"Please provide valid PartitionKeyType with fields! You provided: \" + keyType);\n+          throw new HoodieKeyGenerateException(\"Please provide valid PartitionKeyType with fields! You provided: \" + keyType);\n       }\n       partitionPath.append(DEFAULT_PARTITION_PATH_SEPARATOR);\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQ4MzkwNA==", "url": "https://github.com/apache/hudi/pull/2200#discussion_r513483904", "bodyText": "looks like the above logic move to this place.", "author": "leesf", "createdAt": "2020-10-28T14:22:41Z", "path": "hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/keygen/SparkCustomKeyGenerator.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.keygen;\n+\n+import org.apache.avro.generic.GenericRecord;\n+import org.apache.hudi.common.config.TypedProperties;\n+import org.apache.hudi.common.util.Option;\n+import org.apache.hudi.exception.HoodieDeltaStreamerException;\n+import org.apache.hudi.exception.HoodieKeyException;\n+import org.apache.hudi.keygen.common.KeyGeneratorOptions;\n+import org.apache.spark.sql.Row;\n+\n+import java.io.IOException;\n+import java.util.Arrays;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * This is a generic implementation of KeyGenerator where users can configure record key as a single field or a combination of fields. Similarly partition path can be configured to have multiple\n+ * fields or only one field. This class expects value for prop \"hoodie.datasource.write.partitionpath.field\" in a specific format. For example:\n+ *\n+ * properties.put(\"hoodie.datasource.write.partitionpath.field\", \"field1:PartitionKeyType1,field2:PartitionKeyType2\").\n+ *\n+ * The complete partition path is created as <value for field1 basis PartitionKeyType1>/<value for field2 basis PartitionKeyType2> and so on.\n+ *\n+ * Few points to consider: 1. If you want to customize some partition path field on a timestamp basis, you can use field1:timestampBased 2. If you simply want to have the value of your configured\n+ * field in the partition path, use field1:simple 3. If you want your table to be non partitioned, simply leave it as blank.\n+ *\n+ * RecordKey is internally generated using either SimpleKeyGenerator or ComplexKeyGenerator.\n+ */\n+public class SparkCustomKeyGenerator extends BaseSparkKeyGenerator {\n+\n+  private CustomKeyGenerator customKeyGenerator;\n+\n+  public SparkCustomKeyGenerator(TypedProperties props) {\n+    super(props);\n+    this.recordKeyFields = Arrays.stream(props.getString(KeyGeneratorOptions.RECORDKEY_FIELD_OPT_KEY).split(\",\")).map(String::trim).collect(Collectors.toList());\n+    this.partitionPathFields = Arrays.stream(props.getString(KeyGeneratorOptions.PARTITIONPATH_FIELD_OPT_KEY).split(\",\")).map(String::trim).collect(Collectors.toList());\n+    customKeyGenerator = new CustomKeyGenerator(props);\n+  }\n+\n+  @Override\n+  public String getRecordKey(GenericRecord record) {\n+    return customKeyGenerator.getRecordKey(record);\n+  }\n+\n+  @Override\n+  public String getPartitionPath(GenericRecord record) {\n+    return customKeyGenerator.getPartitionPath(record);\n+  }\n+\n+  @Override\n+  public String getRecordKey(Row row) {\n+    validateRecordKeyFields();\n+    return getRecordKeyFields().size() == 1\n+        ? new SparkSimpleKeyGenerator(config).getRecordKey(row)\n+        : new SparkComplexKeyGenerator(config).getRecordKey(row);\n+  }\n+\n+  @Override\n+  public String getPartitionPath(Row row) {\n+    return getPartitionPath(Option.empty(), Option.of(row));\n+  }\n+\n+  private String getPartitionPath(Option<GenericRecord> record, Option<Row> row) {\n+    if (getPartitionPathFields() == null) {\n+      throw new HoodieKeyException(\"Unable to find field names for partition path in cfg\");\n+    }\n+\n+    String partitionPathField;\n+    StringBuilder partitionPath = new StringBuilder();\n+\n+    //Corresponds to no partition case\n+    if (getPartitionPathFields().size() == 1 && getPartitionPathFields().get(0).isEmpty()) {\n+      return \"\";\n+    }\n+    for (String field : getPartitionPathFields()) {\n+      String[] fieldWithType = field.split(customKeyGenerator.getSplitRegex());\n+      if (fieldWithType.length != 2) {\n+        throw new HoodieKeyException(\"Unable to find field names for partition path in proper format\");\n+      }\n+\n+      partitionPathField = fieldWithType[0];\n+      CustomKeyGenerator.PartitionKeyType keyType = CustomKeyGenerator.PartitionKeyType.valueOf(fieldWithType[1].toUpperCase());\n+      switch (keyType) {\n+        case SIMPLE:\n+          if (record.isPresent()) {\n+            partitionPath.append(new SparkSimpleKeyGenerator(config, partitionPathField).getPartitionPath(record.get()));\n+          } else {\n+            partitionPath.append(new SparkSimpleKeyGenerator(config, partitionPathField).getPartitionPath(row.get()));\n+          }\n+          break;\n+        case TIMESTAMP:\n+          try {\n+            if (record.isPresent()) {\n+              partitionPath.append(new SparkTimestampBasedKeyGenerator(config, partitionPathField).getPartitionPath(record.get()));\n+            } else {\n+              partitionPath.append(new SparkTimestampBasedKeyGenerator(config, partitionPathField).getPartitionPath(row.get()));\n+            }", "originalCommit": "9edd7ea4edde76b31e61ec44d75401d939d4275f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg1NjY5Nw==", "url": "https://github.com/apache/hudi/pull/2200#discussion_r513856697", "bodyText": "looks like the above logic move to this place.\n\nyes, moved here", "author": "wangxianghu", "createdAt": "2020-10-29T01:23:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQ4MzkwNA=="}], "type": "inlineReview", "revised_code": {"commit": "6be7a546e1c4ef26be51602c1ce9a08d88250d74", "chunk": "diff --git a/hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/keygen/SparkCustomKeyGenerator.java b/hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/keygen/CustomKeyGenerator.java\nsimilarity index 70%\nrename from hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/keygen/SparkCustomKeyGenerator.java\nrename to hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/keygen/CustomKeyGenerator.java\nindex 5e14c0df40..44f30745c0 100644\n--- a/hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/keygen/SparkCustomKeyGenerator.java\n+++ b/hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/keygen/CustomKeyGenerator.java\n\n@@ -21,9 +21,9 @@ package org.apache.hudi.keygen;\n import org.apache.avro.generic.GenericRecord;\n import org.apache.hudi.common.config.TypedProperties;\n import org.apache.hudi.common.util.Option;\n-import org.apache.hudi.exception.HoodieDeltaStreamerException;\n import org.apache.hudi.exception.HoodieKeyException;\n-import org.apache.hudi.keygen.common.KeyGeneratorOptions;\n+import org.apache.hudi.exception.HoodieKeyGenerateException;\n+import org.apache.hudi.keygen.constant.KeyGeneratorOptions;\n import org.apache.spark.sql.Row;\n \n import java.io.IOException;\n"}}, {"oid": "74dbcf94b8f8ea50877f8fa27632cb8625e56eb4", "url": "https://github.com/apache/hudi/commit/74dbcf94b8f8ea50877f8fa27632cb8625e56eb4", "message": "[HUDI-912] Refactor and relocate KeyGenerator to support more engines", "committedDate": "2020-10-29T08:45:14Z", "type": "forcePushed"}, {"oid": "9a9c9d2b26863b4165d93f9ffc85f61a80ec21f9", "url": "https://github.com/apache/hudi/commit/9a9c9d2b26863b4165d93f9ffc85f61a80ec21f9", "message": "[HUDI-912] Refactor and relocate KeyGenerator to support more engines", "committedDate": "2020-10-29T13:54:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDc2Mzk0Mg==", "url": "https://github.com/apache/hudi/pull/2200#discussion_r514763942", "bodyText": "This is what I meant in the first comment. we have to be backwards compatible with existing clients. It will be disruptive change for everyone to reconfigure all their jobs. Can we avoid renaming of keygenerator classes or changing their package names", "author": "vinothchandar", "createdAt": "2020-10-30T03:13:37Z", "path": "hudi-cli/src/main/java/org/apache/hudi/cli/commands/BootstrapCommand.java", "diffHunk": "@@ -68,7 +68,7 @@ public String bootstrap(\n           help = \"Bootstrap Index Class\") final String bootstrapIndexClass,\n       @CliOption(key = {\"selectorClass\"}, unspecifiedDefaultValue = \"org.apache.hudi.client.bootstrap.selector.MetadataOnlyBootstrapModeSelector\",\n           help = \"Selector class for bootstrap\") final String selectorClass,\n-      @CliOption(key = {\"keyGeneratorClass\"}, unspecifiedDefaultValue = \"org.apache.hudi.keygen.SimpleKeyGenerator\",\n+      @CliOption(key = {\"keyGeneratorClass\"}, unspecifiedDefaultValue = \"org.apache.hudi.keygen.SparkSimpleKeyGenerator\",", "originalCommit": "9a9c9d2b26863b4165d93f9ffc85f61a80ec21f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDc4MjU0Mg==", "url": "https://github.com/apache/hudi/pull/2200#discussion_r514782542", "bodyText": "This is what I meant in the first comment. we have to be backwards compatible with existing clients. It will be disruptive change for everyone to reconfigure all their jobs. Can we avoid renaming of keygenerator classes or changing their package names\n\ngot it.\nfor speak, we leave the ket generator names untouched and rename it for other engines.", "author": "wangxianghu", "createdAt": "2020-10-30T03:32:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDc2Mzk0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "6be7a546e1c4ef26be51602c1ce9a08d88250d74", "chunk": "diff --git a/hudi-cli/src/main/java/org/apache/hudi/cli/commands/BootstrapCommand.java b/hudi-cli/src/main/java/org/apache/hudi/cli/commands/BootstrapCommand.java\nindex d5dfc241b8..015743d2f2 100644\n--- a/hudi-cli/src/main/java/org/apache/hudi/cli/commands/BootstrapCommand.java\n+++ b/hudi-cli/src/main/java/org/apache/hudi/cli/commands/BootstrapCommand.java\n\n@@ -68,7 +68,7 @@ public class BootstrapCommand implements CommandMarker {\n           help = \"Bootstrap Index Class\") final String bootstrapIndexClass,\n       @CliOption(key = {\"selectorClass\"}, unspecifiedDefaultValue = \"org.apache.hudi.client.bootstrap.selector.MetadataOnlyBootstrapModeSelector\",\n           help = \"Selector class for bootstrap\") final String selectorClass,\n-      @CliOption(key = {\"keyGeneratorClass\"}, unspecifiedDefaultValue = \"org.apache.hudi.keygen.SparkSimpleKeyGenerator\",\n+      @CliOption(key = {\"keyGeneratorClass\"}, unspecifiedDefaultValue = \"org.apache.hudi.keygen.SimpleKeyGenerator\",\n           help = \"Key generator class for bootstrap\") final String keyGeneratorClass,\n       @CliOption(key = {\"fullBootstrapInputProvider\"}, unspecifiedDefaultValue = \"org.apache.hudi.bootstrap.SparkParquetBootstrapDataProvider\",\n           help = \"Class for Full bootstrap input provider\") final String fullBootstrapInputProvider,\n"}}, {"oid": "6be7a546e1c4ef26be51602c1ce9a08d88250d74", "url": "https://github.com/apache/hudi/commit/6be7a546e1c4ef26be51602c1ce9a08d88250d74", "message": "[HUDI-912] Refactor and relocate KeyGenerator to support more engines", "committedDate": "2020-10-30T08:30:38Z", "type": "commit"}, {"oid": "6be7a546e1c4ef26be51602c1ce9a08d88250d74", "url": "https://github.com/apache/hudi/commit/6be7a546e1c4ef26be51602c1ce9a08d88250d74", "message": "[HUDI-912] Refactor and relocate KeyGenerator to support more engines", "committedDate": "2020-10-30T08:30:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk1MDMzNw==", "url": "https://github.com/apache/hudi/pull/2200#discussion_r514950337", "bodyText": "Those CommonKeyGenerators can be used for both flink and java engine.\nI will add some flink specific KeyGenerators  when flink implementation(#2176) is  landed", "author": "wangxianghu", "createdAt": "2020-10-30T08:53:54Z", "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/keygen/CommonComplexKeyGenerator.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*", "originalCommit": "6be7a546e1c4ef26be51602c1ce9a08d88250d74", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "de8169d1a29552232b7bfb5ebfb22286204260ce", "chunk": "diff --git a/hudi-client/hudi-client-common/src/main/java/org/apache/hudi/keygen/CommonComplexKeyGenerator.java b/hudi-client/hudi-client-common/src/main/java/org/apache/hudi/keygen/ComplexAvroKeyGenerator.java\nsimilarity index 88%\nrename from hudi-client/hudi-client-common/src/main/java/org/apache/hudi/keygen/CommonComplexKeyGenerator.java\nrename to hudi-client/hudi-client-common/src/main/java/org/apache/hudi/keygen/ComplexAvroKeyGenerator.java\nindex a3b1e5ec85..edc1ad9ceb 100644\n--- a/hudi-client/hudi-client-common/src/main/java/org/apache/hudi/keygen/CommonComplexKeyGenerator.java\n+++ b/hudi-client/hudi-client-common/src/main/java/org/apache/hudi/keygen/ComplexAvroKeyGenerator.java\n\n@@ -25,12 +25,12 @@ import java.util.Arrays;\n import java.util.stream.Collectors;\n \n /**\n- * Common complex key generator, which takes names of fields to be used for recordKey and partitionPath as configs.\n+ * Avro complex key generator, which takes names of fields to be used for recordKey and partitionPath as configs.\n  */\n-public class CommonComplexKeyGenerator extends BaseKeyGenerator {\n+public class ComplexAvroKeyGenerator extends BaseKeyGenerator {\n   public static final String DEFAULT_RECORD_KEY_SEPARATOR = \":\";\n \n-  public CommonComplexKeyGenerator(TypedProperties props) {\n+  public ComplexAvroKeyGenerator(TypedProperties props) {\n     super(props);\n     this.recordKeyFields = Arrays.stream(props.getString(KeyGeneratorOptions.RECORDKEY_FIELD_OPT_KEY)\n         .split(\",\")).map(String::trim).filter(s -> !s.isEmpty()).collect(Collectors.toList());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIzNTEzNg==", "url": "https://github.com/apache/hudi/pull/2200#discussion_r515235136", "bodyText": "rename: HoodieKeyGeneratorException", "author": "vinothchandar", "createdAt": "2020-10-30T16:48:27Z", "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/exception/HoodieKeyGenerateException.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.exception;\n+\n+/**\n+ * Exception thrown for any higher level errors when {@link org.apache.hudi.keygen.KeyGeneratorInterface} is generating\n+ * a {@link org.apache.hudi.common.model.HoodieKey}.\n+ */\n+public class HoodieKeyGenerateException extends HoodieException {", "originalCommit": "6be7a546e1c4ef26be51602c1ce9a08d88250d74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQyNDk5OQ==", "url": "https://github.com/apache/hudi/pull/2200#discussion_r515424999", "bodyText": "rename: HoodieKeyGeneratorException\n\ndone", "author": "wangxianghu", "createdAt": "2020-10-30T23:41:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIzNTEzNg=="}], "type": "inlineReview", "revised_code": {"commit": "de8169d1a29552232b7bfb5ebfb22286204260ce", "chunk": "diff --git a/hudi-client/hudi-client-common/src/main/java/org/apache/hudi/exception/HoodieKeyGenerateException.java b/hudi-client/hudi-client-common/src/main/java/org/apache/hudi/exception/HoodieKeyGeneratorException.java\nsimilarity index 85%\nrename from hudi-client/hudi-client-common/src/main/java/org/apache/hudi/exception/HoodieKeyGenerateException.java\nrename to hudi-client/hudi-client-common/src/main/java/org/apache/hudi/exception/HoodieKeyGeneratorException.java\nindex 40d30a2771..5bf06e2e46 100644\n--- a/hudi-client/hudi-client-common/src/main/java/org/apache/hudi/exception/HoodieKeyGenerateException.java\n+++ b/hudi-client/hudi-client-common/src/main/java/org/apache/hudi/exception/HoodieKeyGeneratorException.java\n\n@@ -21,13 +21,13 @@ package org.apache.hudi.exception;\n  * Exception thrown for any higher level errors when {@link org.apache.hudi.keygen.KeyGeneratorInterface} is generating\n  * a {@link org.apache.hudi.common.model.HoodieKey}.\n  */\n-public class HoodieKeyGenerateException extends HoodieException {\n+public class HoodieKeyGeneratorException extends HoodieException {\n \n-  public HoodieKeyGenerateException(String msg, Throwable e) {\n+  public HoodieKeyGeneratorException(String msg, Throwable e) {\n     super(msg, e);\n   }\n \n-  public HoodieKeyGenerateException(String msg) {\n+  public HoodieKeyGeneratorException(String msg) {\n     super(msg);\n   }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM5NDk4Ng==", "url": "https://github.com/apache/hudi/pull/2200#discussion_r515394986", "bodyText": "what the user sets is is actually DataSourceWriteOptions.RECORDKEY_FIELD_OPT_KEY(). So might be good to avoid duplicating this in KeyGeneratorOptions.RECORDKEY_FIELD_OPT_KEY . can we revert?", "author": "vinothchandar", "createdAt": "2020-10-30T21:40:44Z", "path": "hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/keygen/ComplexKeyGenerator.java", "diffHunk": "@@ -18,38 +17,38 @@\n \n package org.apache.hudi.keygen;\n \n-import org.apache.hudi.DataSourceWriteOptions;\n-import org.apache.hudi.common.config.TypedProperties;\n-\n import org.apache.avro.generic.GenericRecord;\n+import org.apache.hudi.common.config.TypedProperties;\n+import org.apache.hudi.keygen.constant.KeyGeneratorOptions;\n+import org.apache.spark.sql.Row;\n \n import java.util.Arrays;\n import java.util.stream.Collectors;\n-import org.apache.spark.sql.Row;\n \n /**\n  * Complex key generator, which takes names of fields to be used for recordKey and partitionPath as configs.\n  */\n public class ComplexKeyGenerator extends BuiltinKeyGenerator {\n \n-  public static final String DEFAULT_RECORD_KEY_SEPARATOR = \":\";\n+  private CommonComplexKeyGenerator commonComplexKeyGenerator;\n \n   public ComplexKeyGenerator(TypedProperties props) {\n     super(props);\n-    this.recordKeyFields = Arrays.stream(props.getString(DataSourceWriteOptions.RECORDKEY_FIELD_OPT_KEY())\n+    this.recordKeyFields = Arrays.stream(props.getString(KeyGeneratorOptions.RECORDKEY_FIELD_OPT_KEY)", "originalCommit": "6be7a546e1c4ef26be51602c1ce9a08d88250d74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQyNjg1NQ==", "url": "https://github.com/apache/hudi/pull/2200#discussion_r515426855", "bodyText": "what the user sets is is actually DataSourceWriteOptions.RECORDKEY_FIELD_OPT_KEY(). So might be good to avoid duplicating this in KeyGeneratorOptions.RECORDKEY_FIELD_OPT_KEY . can we revert?\n\nDataSourceWriteOptions has some hive and spark references in it.  it is a little inconvenient to move to hudi-client-common. should I refactor DataSourceWriteOptions ?", "author": "wangxianghu", "createdAt": "2020-10-30T23:51:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM5NDk4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI1NjQ5OQ==", "url": "https://github.com/apache/hudi/pull/2200#discussion_r516256499", "bodyText": "ah ok. no problem. this makes sense", "author": "vinothchandar", "createdAt": "2020-11-02T21:12:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM5NDk4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "de8169d1a29552232b7bfb5ebfb22286204260ce", "chunk": "diff --git a/hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/keygen/ComplexKeyGenerator.java b/hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/keygen/ComplexKeyGenerator.java\nindex 04ba9a9f83..36c8345593 100644\n--- a/hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/keygen/ComplexKeyGenerator.java\n+++ b/hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/keygen/ComplexKeyGenerator.java\n\n@@ -30,7 +30,7 @@ import java.util.stream.Collectors;\n  */\n public class ComplexKeyGenerator extends BuiltinKeyGenerator {\n \n-  private CommonComplexKeyGenerator commonComplexKeyGenerator;\n+  private final ComplexAvroKeyGenerator complexAvroKeyGenerator;\n \n   public ComplexKeyGenerator(TypedProperties props) {\n     super(props);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM5NTA4OA==", "url": "https://github.com/apache/hudi/pull/2200#discussion_r515395088", "bodyText": "can all these members be final (intellij tip)", "author": "vinothchandar", "createdAt": "2020-10-30T21:41:01Z", "path": "hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/keygen/ComplexKeyGenerator.java", "diffHunk": "@@ -18,38 +17,38 @@\n \n package org.apache.hudi.keygen;\n \n-import org.apache.hudi.DataSourceWriteOptions;\n-import org.apache.hudi.common.config.TypedProperties;\n-\n import org.apache.avro.generic.GenericRecord;\n+import org.apache.hudi.common.config.TypedProperties;\n+import org.apache.hudi.keygen.constant.KeyGeneratorOptions;\n+import org.apache.spark.sql.Row;\n \n import java.util.Arrays;\n import java.util.stream.Collectors;\n-import org.apache.spark.sql.Row;\n \n /**\n  * Complex key generator, which takes names of fields to be used for recordKey and partitionPath as configs.\n  */\n public class ComplexKeyGenerator extends BuiltinKeyGenerator {\n \n-  public static final String DEFAULT_RECORD_KEY_SEPARATOR = \":\";\n+  private CommonComplexKeyGenerator commonComplexKeyGenerator;", "originalCommit": "6be7a546e1c4ef26be51602c1ce9a08d88250d74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQyNTAzNg==", "url": "https://github.com/apache/hudi/pull/2200#discussion_r515425036", "bodyText": "can all these members be final (intellij tip)\n\ndone", "author": "wangxianghu", "createdAt": "2020-10-30T23:41:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM5NTA4OA=="}], "type": "inlineReview", "revised_code": {"commit": "de8169d1a29552232b7bfb5ebfb22286204260ce", "chunk": "diff --git a/hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/keygen/ComplexKeyGenerator.java b/hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/keygen/ComplexKeyGenerator.java\nindex 04ba9a9f83..36c8345593 100644\n--- a/hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/keygen/ComplexKeyGenerator.java\n+++ b/hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/keygen/ComplexKeyGenerator.java\n\n@@ -30,7 +30,7 @@ import java.util.stream.Collectors;\n  */\n public class ComplexKeyGenerator extends BuiltinKeyGenerator {\n \n-  private CommonComplexKeyGenerator commonComplexKeyGenerator;\n+  private final ComplexAvroKeyGenerator complexAvroKeyGenerator;\n \n   public ComplexKeyGenerator(TypedProperties props) {\n     super(props);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM5NTg1Ng==", "url": "https://github.com/apache/hudi/pull/2200#discussion_r515395856", "bodyText": "all the Common generators. are avro based. So let's name them like SimpleAvroKeyGenerator , TimestampBasedAvroKeyGenerator ?", "author": "vinothchandar", "createdAt": "2020-10-30T21:43:08Z", "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/keygen/CommonTimestampBasedKeyGenerator.java", "diffHunk": "@@ -46,15 +42,11 @@\n \n import static java.util.concurrent.TimeUnit.MILLISECONDS;\n import static java.util.concurrent.TimeUnit.SECONDS;\n-import static org.apache.hudi.keygen.KeyGenUtils.DEFAULT_PARTITION_PATH;\n-import static org.apache.hudi.keygen.KeyGenUtils.EMPTY_RECORDKEY_PLACEHOLDER;\n-import static org.apache.hudi.keygen.KeyGenUtils.NULL_RECORDKEY_PLACEHOLDER;\n \n /**\n- * Key generator, that relies on timestamps for partitioning field. Still picks record key by name.\n+ * Common Key generator, that relies on timestamps for partitioning field. Still picks record key by name.\n  */\n-public class TimestampBasedKeyGenerator extends SimpleKeyGenerator {\n-\n+public class CommonTimestampBasedKeyGenerator extends CommonSimpleKeyGenerator {", "originalCommit": "6be7a546e1c4ef26be51602c1ce9a08d88250d74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQyNTA2NA==", "url": "https://github.com/apache/hudi/pull/2200#discussion_r515425064", "bodyText": "all the Common generators. are avro based. So let's name them like SimpleAvroKeyGenerator , TimestampBasedAvroKeyGenerator ?\n\ndone", "author": "wangxianghu", "createdAt": "2020-10-30T23:41:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM5NTg1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "de8169d1a29552232b7bfb5ebfb22286204260ce", "chunk": "diff --git a/hudi-client/hudi-client-common/src/main/java/org/apache/hudi/keygen/CommonTimestampBasedKeyGenerator.java b/hudi-client/hudi-client-common/src/main/java/org/apache/hudi/keygen/TimestampBasedAvroKeyGenerator.java\nsimilarity index 93%\nrename from hudi-client/hudi-client-common/src/main/java/org/apache/hudi/keygen/CommonTimestampBasedKeyGenerator.java\nrename to hudi-client/hudi-client-common/src/main/java/org/apache/hudi/keygen/TimestampBasedAvroKeyGenerator.java\nindex d56c8d05ce..28048a16b8 100644\n--- a/hudi-client/hudi-client-common/src/main/java/org/apache/hudi/keygen/CommonTimestampBasedKeyGenerator.java\n+++ b/hudi-client/hudi-client-common/src/main/java/org/apache/hudi/keygen/TimestampBasedAvroKeyGenerator.java\n\n@@ -44,9 +44,9 @@ import static java.util.concurrent.TimeUnit.MILLISECONDS;\n import static java.util.concurrent.TimeUnit.SECONDS;\n \n /**\n- * Common Key generator, that relies on timestamps for partitioning field. Still picks record key by name.\n+ * Avro Key generator, that relies on timestamps for partitioning field. Still picks record key by name.\n  */\n-public class CommonTimestampBasedKeyGenerator extends CommonSimpleKeyGenerator {\n+public class TimestampBasedAvroKeyGenerator extends SimpleAvroKeyGenerator {\n   public enum TimestampType implements Serializable {\n     UNIX_TIMESTAMP, DATE_STRING, MIXED, EPOCHMILLISECONDS, SCALAR\n   }\n"}}, {"oid": "de8169d1a29552232b7bfb5ebfb22286204260ce", "url": "https://github.com/apache/hudi/commit/de8169d1a29552232b7bfb5ebfb22286204260ce", "message": "Rename KeyGenerators", "committedDate": "2020-10-30T23:39:20Z", "type": "commit"}]}