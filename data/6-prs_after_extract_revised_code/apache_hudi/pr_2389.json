{"pr_number": 2389, "pr_title": "[HUDI-1498] Read clustering plan from requested for inflight instant", "pr_createdAt": "2020-12-29T01:50:02Z", "pr_url": "https://github.com/apache/hudi/pull/2389", "timeline": [{"oid": "6f24a4911757f510c3d3c3687dee13f7d6146711", "url": "https://github.com/apache/hudi/commit/6f24a4911757f510c3d3c3687dee13f7d6146711", "message": "[HUDI-1498] Read clustering plan from requested file for inflight instant", "committedDate": "2020-12-29T02:24:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU1NzUzNA==", "url": "https://github.com/apache/hudi/pull/2389#discussion_r549557534", "bodyText": "can we add some annotation such as \"do not have content in inflight instant\"", "author": "lw309637554", "createdAt": "2020-12-29T03:46:05Z", "path": "hudi-common/src/main/java/org/apache/hudi/common/util/ClusteringUtils.java", "diffHunk": "@@ -68,21 +69,27 @@\n         .filter(Option::isPresent).map(Option::get);\n   }\n \n-  public static Option<Pair<HoodieInstant, HoodieClusteringPlan>> getClusteringPlan(HoodieTableMetaClient metaClient, HoodieInstant requestedReplaceInstant) {\n+  public static Option<Pair<HoodieInstant, HoodieClusteringPlan>> getClusteringPlan(HoodieTableMetaClient metaClient, HoodieInstant pendingReplaceInstant) {\n     try {\n-      Option<byte[]> content = metaClient.getActiveTimeline().getInstantDetails(requestedReplaceInstant);\n+      final HoodieInstant requestedInstant;\n+      if (!pendingReplaceInstant.isRequested()) {", "originalCommit": "6f24a4911757f510c3d3c3687dee13f7d6146711", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDMzOTAzMQ==", "url": "https://github.com/apache/hudi/pull/2389#discussion_r550339031", "bodyText": "@satishkotha Can you add a comment here as to why this is needed ?", "author": "n3nash", "createdAt": "2020-12-30T22:00:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU1NzUzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDk1MzI2OA==", "url": "https://github.com/apache/hudi/pull/2389#discussion_r550953268", "bodyText": "Added comment. PTAL", "author": "satishkotha", "createdAt": "2021-01-03T04:12:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU1NzUzNA=="}], "type": "inlineReview", "revised_code": {"commit": "2d237e988f083c9d6cfe2e2c093cd0d63ecd1aa5", "chunk": "diff --git a/hudi-common/src/main/java/org/apache/hudi/common/util/ClusteringUtils.java b/hudi-common/src/main/java/org/apache/hudi/common/util/ClusteringUtils.java\nindex 9f76a88d0..fcc327403 100644\n--- a/hudi-common/src/main/java/org/apache/hudi/common/util/ClusteringUtils.java\n+++ b/hudi-common/src/main/java/org/apache/hudi/common/util/ClusteringUtils.java\n\n@@ -73,6 +73,9 @@ public class ClusteringUtils {\n     try {\n       final HoodieInstant requestedInstant;\n       if (!pendingReplaceInstant.isRequested()) {\n+        // inflight replacecommit files don't have clustering plan.\n+        // This is because replacecommit inflight can have workload profile for 'insert_overwrite'.\n+        // Get the plan from corresponding requested instant.\n         requestedInstant = HoodieTimeline.getReplaceCommitRequestedInstant(pendingReplaceInstant.getTimestamp());\n       } else {\n         requestedInstant = pendingReplaceInstant;\n"}}, {"oid": "2d237e988f083c9d6cfe2e2c093cd0d63ecd1aa5", "url": "https://github.com/apache/hudi/commit/2d237e988f083c9d6cfe2e2c093cd0d63ecd1aa5", "message": "[HUDI-1498] Read clustering plan from requested file for inflight instant", "committedDate": "2021-01-03T04:10:15Z", "type": "commit"}, {"oid": "2d237e988f083c9d6cfe2e2c093cd0d63ecd1aa5", "url": "https://github.com/apache/hudi/commit/2d237e988f083c9d6cfe2e2c093cd0d63ecd1aa5", "message": "[HUDI-1498] Read clustering plan from requested file for inflight instant", "committedDate": "2021-01-03T04:10:15Z", "type": "forcePushed"}]}