{"pr_number": 2172, "pr_title": "[HUDI-1338] Adding Delete support to test suite framework", "pr_createdAt": "2020-10-11T14:12:12Z", "pr_url": "https://github.com/apache/hudi/pull/2172", "timeline": [{"oid": "8832628562139b75906c9cff38edecac215b1669", "url": "https://github.com/apache/hudi/commit/8832628562139b75906c9cff38edecac215b1669", "message": "Adding Delete support to test suite", "committedDate": "2020-10-11T14:12:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcwNzYzMw==", "url": "https://github.com/apache/hudi/pull/2172#discussion_r511707633", "bodyText": "What does default value \"1\" mean in this case ?", "author": "n3nash", "createdAt": "2020-10-26T03:54:10Z", "path": "hudi-integ-test/src/main/java/org/apache/hudi/integ/testsuite/configuration/DeltaConfig.java", "diffHunk": "@@ -118,6 +125,10 @@ public int getNumUpsertPartitions() {\n       return Integer.valueOf(configsMap.getOrDefault(NUM_PARTITIONS_UPSERT, 0).toString());\n     }\n \n+    public int getNumDeletePartitions() {\n+      return Integer.valueOf(configsMap.getOrDefault(NUM_PARTITIONS_DELETE, 1).toString());", "originalCommit": "8832628562139b75906c9cff38edecac215b1669", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9d59ffd065756417474337ae24d9c4c886b057f9", "chunk": "diff --git a/hudi-integ-test/src/main/java/org/apache/hudi/integ/testsuite/configuration/DeltaConfig.java b/hudi-integ-test/src/main/java/org/apache/hudi/integ/testsuite/configuration/DeltaConfig.java\nindex 605dc61fb..db1560464 100644\n--- a/hudi-integ-test/src/main/java/org/apache/hudi/integ/testsuite/configuration/DeltaConfig.java\n+++ b/hudi-integ-test/src/main/java/org/apache/hudi/integ/testsuite/configuration/DeltaConfig.java\n\n@@ -125,12 +119,12 @@ public class DeltaConfig implements Serializable {\n       return Integer.valueOf(configsMap.getOrDefault(NUM_PARTITIONS_UPSERT, 0).toString());\n     }\n \n-    public int getNumDeletePartitions() {\n-      return Integer.valueOf(configsMap.getOrDefault(NUM_PARTITIONS_DELETE, 1).toString());\n+    public int getStartPartition() {\n+      return Integer.valueOf(configsMap.getOrDefault(START_PARTITION, 0).toString());\n     }\n \n     public int getNumUpsertFiles() {\n-      return Integer.valueOf(configsMap.getOrDefault(NUM_FILES_UPSERT, 1).toString());\n+      return Integer.valueOf(configsMap.getOrDefault(NUM_FILES_UPSERT, 0).toString());\n     }\n \n     public double getFractionUpsertPerFile() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcwNzc4Mg==", "url": "https://github.com/apache/hudi/pull/2172#discussion_r511707782", "bodyText": "Nit: revert whitespace changes", "author": "n3nash", "createdAt": "2020-10-26T03:55:00Z", "path": "hudi-integ-test/src/main/java/org/apache/hudi/integ/testsuite/dag/nodes/UpsertNode.java", "diffHunk": "@@ -23,6 +23,7 @@\n import org.apache.hudi.integ.testsuite.HoodieTestSuiteWriter;\n import org.apache.hudi.integ.testsuite.configuration.DeltaConfig.Config;\n import org.apache.hudi.integ.testsuite.generator.DeltaGenerator;\n+", "originalCommit": "8832628562139b75906c9cff38edecac215b1669", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bede6f88f1964b87a68bf18babb7348d6ba4f614", "chunk": "diff --git a/hudi-integ-test/src/main/java/org/apache/hudi/integ/testsuite/dag/nodes/UpsertNode.java b/hudi-integ-test/src/main/java/org/apache/hudi/integ/testsuite/dag/nodes/UpsertNode.java\nindex 18baa0d44..1377a4d6b 100644\n--- a/hudi-integ-test/src/main/java/org/apache/hudi/integ/testsuite/dag/nodes/UpsertNode.java\n+++ b/hudi-integ-test/src/main/java/org/apache/hudi/integ/testsuite/dag/nodes/UpsertNode.java\n\n@@ -23,7 +23,6 @@ import org.apache.hudi.common.util.Option;\n import org.apache.hudi.integ.testsuite.HoodieTestSuiteWriter;\n import org.apache.hudi.integ.testsuite.configuration.DeltaConfig.Config;\n import org.apache.hudi.integ.testsuite.generator.DeltaGenerator;\n-\n import org.apache.spark.api.java.JavaRDD;\n \n /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcwODM1NA==", "url": "https://github.com/apache/hudi/pull/2172#discussion_r511708354", "bodyText": "Should this be renamed from adjustedRDD to something else ?", "author": "n3nash", "createdAt": "2020-10-26T03:57:52Z", "path": "hudi-integ-test/src/main/java/org/apache/hudi/integ/testsuite/generator/DeltaGenerator.java", "diffHunk": "@@ -155,6 +156,42 @@ public DeltaGenerator(DeltaConfig deltaOutputConfig, JavaSparkContext jsc, Spark\n     }\n   }\n \n+  public JavaRDD<GenericRecord> generateDeletes(Config config) throws IOException {\n+    if (deltaOutputConfig.getDeltaOutputMode() == DeltaOutputMode.DFS) {\n+      DeltaInputReader deltaInputReader = null;\n+      JavaRDD<GenericRecord> adjustedRDD = null;\n+\n+      if (config.getNumDeletePartitions() < 1) {\n+        // randomly generate deletes for a given number of records without regard to partitions and files\n+        deltaInputReader = new DFSAvroDeltaInputReader(sparkSession, schemaStr,\n+            ((DFSDeltaConfig) deltaOutputConfig).getDeltaBasePath(), Option.empty(), Option.empty());\n+        adjustedRDD = deltaInputReader.read(config.getNumRecordsDelete());", "originalCommit": "8832628562139b75906c9cff38edecac215b1669", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcwODQyMg==", "url": "https://github.com/apache/hudi/pull/2172#discussion_r511708422", "bodyText": "Ohh I see, you are trying to reduce number of variables used...", "author": "n3nash", "createdAt": "2020-10-26T03:58:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcwODM1NA=="}], "type": "inlineReview", "revised_code": {"commit": "9d59ffd065756417474337ae24d9c4c886b057f9", "chunk": "diff --git a/hudi-integ-test/src/main/java/org/apache/hudi/integ/testsuite/generator/DeltaGenerator.java b/hudi-integ-test/src/main/java/org/apache/hudi/integ/testsuite/generator/DeltaGenerator.java\nindex 5915076c3..dc991b11e 100644\n--- a/hudi-integ-test/src/main/java/org/apache/hudi/integ/testsuite/generator/DeltaGenerator.java\n+++ b/hudi-integ-test/src/main/java/org/apache/hudi/integ/testsuite/generator/DeltaGenerator.java\n\n@@ -156,42 +185,6 @@ public class DeltaGenerator implements Serializable {\n     }\n   }\n \n-  public JavaRDD<GenericRecord> generateDeletes(Config config) throws IOException {\n-    if (deltaOutputConfig.getDeltaOutputMode() == DeltaOutputMode.DFS) {\n-      DeltaInputReader deltaInputReader = null;\n-      JavaRDD<GenericRecord> adjustedRDD = null;\n-\n-      if (config.getNumDeletePartitions() < 1) {\n-        // randomly generate deletes for a given number of records without regard to partitions and files\n-        deltaInputReader = new DFSAvroDeltaInputReader(sparkSession, schemaStr,\n-            ((DFSDeltaConfig) deltaOutputConfig).getDeltaBasePath(), Option.empty(), Option.empty());\n-        adjustedRDD = deltaInputReader.read(config.getNumRecordsDelete());\n-        adjustedRDD = adjustRDDToGenerateExactNumUpdates(adjustedRDD, jsc, config.getNumRecordsDelete());\n-      } else {\n-        deltaInputReader =\n-            new DFSHoodieDatasetInputReader(jsc, ((DFSDeltaConfig) deltaOutputConfig).getDatasetOutputPath(),\n-                schemaStr);\n-        if (config.getFractionUpsertPerFile() > 0) {\n-          adjustedRDD = deltaInputReader.read(config.getNumDeletePartitions(), config.getNumUpsertFiles(),\n-              config.getFractionUpsertPerFile());\n-        } else {\n-          adjustedRDD = deltaInputReader.read(config.getNumDeletePartitions(), config.getNumUpsertFiles(), config\n-              .getNumRecordsDelete());\n-        }\n-      }\n-      log.info(\"Repartitioning records for delete\");\n-      // persist this since we will make multiple passes over this\n-      adjustedRDD = adjustedRDD.repartition(jsc.defaultParallelism());\n-      Converter converter = new DeleteConverter(schemaStr, config.getRecordSize());\n-      JavaRDD<GenericRecord> deletes = converter.convert(adjustedRDD);\n-      deletes.persist(StorageLevel.DISK_ONLY());\n-      return deletes;\n-    } else {\n-      throw new IllegalArgumentException(\"Other formats are not supported at the moment\");\n-    }\n-  }\n-\n-\n   public Map<Integer, Long> getPartitionToCountMap(JavaRDD<GenericRecord> records) {\n     // Requires us to keep the partitioner the same\n     return records.mapPartitionsWithIndex((index, itr) -> {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcwODkxNA==", "url": "https://github.com/apache/hudi/pull/2172#discussion_r511708914", "bodyText": "Make this an inline else-if ?", "author": "n3nash", "createdAt": "2020-10-26T04:00:52Z", "path": "hudi-integ-test/src/main/java/org/apache/hudi/integ/testsuite/generator/GenericRecordFullPayloadGenerator.java", "diffHunk": "@@ -130,43 +132,60 @@ public GenericRecord getUpdatePayload(GenericRecord record, List<String> blackli\n   }\n \n   /**\n-   * Create a new {@link GenericRecord} with random values. Not all the fields have value, it is random, and its value\n-   * is random too.\n+   * Create a new {@link GenericRecord} with random values. Not all the fields have value, it is random, and its value is random too.\n    *\n    * @param schema Schema to create with.\n    * @return A {@link GenericRecord} with random value.\n    */\n   protected GenericRecord convertPartial(Schema schema) {\n     GenericRecord result = new GenericData.Record(schema);\n     for (Schema.Field f : schema.getFields()) {\n-      boolean setNull = random.nextBoolean();\n-      if (!setNull) {\n-        result.put(f.name(), typeConvert(f));\n+      if (f.name().equals(DEFAULT_HOODIE_IS_DELETED_COL)) {\n+        result.put(f.name(), false);\n       } else {\n-        result.put(f.name(), null);\n+        boolean setNull = random.nextBoolean();\n+        if (!setNull) {\n+          result.put(f.name(), typeConvert(f));\n+        } else {\n+          result.put(f.name(), null);\n+        }\n       }\n     }\n     // TODO : pack remaining bytes into a complex field\n     return result;\n   }\n \n   /**\n-   * Set random value to {@link GenericRecord} according to the schema type of field.\n-   * The field in blacklist will not be set.\n+   * Set random value to {@link GenericRecord} according to the schema type of field. The field in blacklist will not be set.\n    *\n-   * @param record          GenericRecord to randomize.\n+   * @param record GenericRecord to randomize.\n    * @param blacklistFields blacklistFields where the filed will not be randomized.\n    * @return Randomized GenericRecord.\n    */\n   protected GenericRecord randomize(GenericRecord record, List<String> blacklistFields) {\n     for (Schema.Field f : record.getSchema().getFields()) {\n-      if (blacklistFields == null || !blacklistFields.contains(f.name())) {\n-        record.put(f.name(), typeConvert(f));\n+      if (f.name().equals(DEFAULT_HOODIE_IS_DELETED_COL)) {\n+        record.put(f.name(), false);\n+      } else {", "originalCommit": "8832628562139b75906c9cff38edecac215b1669", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bede6f88f1964b87a68bf18babb7348d6ba4f614", "chunk": "diff --git a/hudi-integ-test/src/main/java/org/apache/hudi/integ/testsuite/generator/GenericRecordFullPayloadGenerator.java b/hudi-integ-test/src/main/java/org/apache/hudi/integ/testsuite/generator/GenericRecordFullPayloadGenerator.java\nindex b53badec0..8ce8d1c55 100644\n--- a/hudi-integ-test/src/main/java/org/apache/hudi/integ/testsuite/generator/GenericRecordFullPayloadGenerator.java\n+++ b/hudi-integ-test/src/main/java/org/apache/hudi/integ/testsuite/generator/GenericRecordFullPayloadGenerator.java\n\n@@ -166,10 +166,8 @@ public class GenericRecordFullPayloadGenerator implements Serializable {\n     for (Schema.Field f : record.getSchema().getFields()) {\n       if (f.name().equals(DEFAULT_HOODIE_IS_DELETED_COL)) {\n         record.put(f.name(), false);\n-      } else {\n-        if (blacklistFields == null || !blacklistFields.contains(f.name())) {\n-          record.put(f.name(), typeConvert(f));\n-        }\n+      } else if (blacklistFields == null || !blacklistFields.contains(f.name())) {\n+        record.put(f.name(), typeConvert(f));\n       }\n     }\n     return record;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcwOTEzNA==", "url": "https://github.com/apache/hudi/pull/2172#discussion_r511709134", "bodyText": "Should these be uncommented or removed ?", "author": "n3nash", "createdAt": "2020-10-26T04:02:07Z", "path": "hudi-integ-test/src/main/java/org/apache/hudi/integ/testsuite/writer/DFSDeltaWriterAdapter.java", "diffHunk": "@@ -40,10 +40,12 @@ public DFSDeltaWriterAdapter(DeltaInputWriter<GenericRecord> deltaInputGenerator\n   @Override\n   public List<DeltaWriteStats> write(Iterator<GenericRecord> input) throws IOException {\n     while (input.hasNext()) {\n+      //GenericRecord next = input.next();", "originalCommit": "8832628562139b75906c9cff38edecac215b1669", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bede6f88f1964b87a68bf18babb7348d6ba4f614", "chunk": "diff --git a/hudi-integ-test/src/main/java/org/apache/hudi/integ/testsuite/writer/DFSDeltaWriterAdapter.java b/hudi-integ-test/src/main/java/org/apache/hudi/integ/testsuite/writer/DFSDeltaWriterAdapter.java\nindex 25d5da5c7..65e4ee13c 100644\n--- a/hudi-integ-test/src/main/java/org/apache/hudi/integ/testsuite/writer/DFSDeltaWriterAdapter.java\n+++ b/hudi-integ-test/src/main/java/org/apache/hudi/integ/testsuite/writer/DFSDeltaWriterAdapter.java\n\n@@ -40,12 +40,12 @@ public class DFSDeltaWriterAdapter implements DeltaWriterAdapter<GenericRecord>\n   @Override\n   public List<DeltaWriteStats> write(Iterator<GenericRecord> input) throws IOException {\n     while (input.hasNext()) {\n-      //GenericRecord next = input.next();\n+      GenericRecord next = input.next();\n       if (this.deltaInputGenerator.canWrite()) {\n-        this.deltaInputGenerator.writeData(input.next());\n+        this.deltaInputGenerator.writeData(next);\n       } else if (input.hasNext()) {\n         rollOver();\n-        // this.deltaInputGenerator.writeData(next);\n+        this.deltaInputGenerator.writeData(next);\n       }\n     }\n     close();\n"}}, {"oid": "bede6f88f1964b87a68bf18babb7348d6ba4f614", "url": "https://github.com/apache/hudi/commit/bede6f88f1964b87a68bf18babb7348d6ba4f614", "message": "Addressing feedback", "committedDate": "2020-10-29T03:32:38Z", "type": "forcePushed"}, {"oid": "9d59ffd065756417474337ae24d9c4c886b057f9", "url": "https://github.com/apache/hudi/commit/9d59ffd065756417474337ae24d9c4c886b057f9", "message": "trigger rebuild", "committedDate": "2020-10-30T13:07:01Z", "type": "commit"}, {"oid": "e7e5c71d9446a63ec7c354e6f38d9e8df7718d2f", "url": "https://github.com/apache/hudi/commit/e7e5c71d9446a63ec7c354e6f38d9e8df7718d2f", "message": "[HUDI-1156] Remove unused dependencies from HoodieDeltaStreamerWrapper Class (#1927)", "committedDate": "2020-10-30T13:07:01Z", "type": "commit"}, {"oid": "86fe78daba7e80e82a0ce0b7af6179ffbb4383ef", "url": "https://github.com/apache/hudi/commit/86fe78daba7e80e82a0ce0b7af6179ffbb4383ef", "message": "Adding Delete support to test suite", "committedDate": "2020-10-30T13:17:54Z", "type": "commit"}, {"oid": "cc65d9502c6fcba59be7c20e7ac495ea2dcf02dc", "url": "https://github.com/apache/hudi/commit/cc65d9502c6fcba59be7c20e7ac495ea2dcf02dc", "message": "Addressing feedback", "committedDate": "2020-10-30T13:17:59Z", "type": "commit"}, {"oid": "7b8d2bcfd62a80df39ef84ea8235bc5831781838", "url": "https://github.com/apache/hudi/commit/7b8d2bcfd62a80df39ef84ea8235bc5831781838", "message": "Fixing test.properties instructions in README", "committedDate": "2020-10-30T13:18:29Z", "type": "forcePushed"}, {"oid": "9f24856b379b371c882e215c9fabd0992d126652", "url": "https://github.com/apache/hudi/commit/9f24856b379b371c882e215c9fabd0992d126652", "message": "Fixing test.properties instructions in README", "committedDate": "2020-10-30T18:37:22Z", "type": "commit"}, {"oid": "9f24856b379b371c882e215c9fabd0992d126652", "url": "https://github.com/apache/hudi/commit/9f24856b379b371c882e215c9fabd0992d126652", "message": "Fixing test.properties instructions in README", "committedDate": "2020-10-30T18:37:22Z", "type": "forcePushed"}]}