{"pr_number": 1396, "pr_title": "[HUDI-687] Stop incremental reader on RO table before a pending compaction", "pr_createdAt": "2020-03-11T03:08:50Z", "pr_url": "https://github.com/apache/hudi/pull/1396", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjA0MjY3MQ==", "url": "https://github.com/apache/hudi/pull/1396#discussion_r392042671", "bodyText": "rename: instantTime", "author": "vinothchandar", "createdAt": "2020-03-13T05:56:20Z", "path": "hudi-common/src/main/java/org/apache/hudi/common/table/HoodieTimeline.java", "diffHunk": "@@ -144,6 +162,11 @@\n    */\n   HoodieTimeline findInstantsAfter(String commitTime, int numCommits);\n \n+  /**\n+   * Create a new Timeline with all instants before specified time.\n+   */\n+  HoodieTimeline findInstantsBefore(String time);", "originalCommit": "a023c310341f954ef3a9ee91e12853ca9376fe19", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQzNjQ2MQ==", "url": "https://github.com/apache/hudi/pull/1396#discussion_r392436461", "bodyText": "done", "author": "satishkotha", "createdAt": "2020-03-13T19:50:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjA0MjY3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "692604937ad658192c2518e0be1e6a1cd4bae993", "chunk": "diff --git a/hudi-common/src/main/java/org/apache/hudi/common/table/HoodieTimeline.java b/hudi-common/src/main/java/org/apache/hudi/common/table/timeline/HoodieTimeline.java\nsimilarity index 84%\nrename from hudi-common/src/main/java/org/apache/hudi/common/table/HoodieTimeline.java\nrename to hudi-common/src/main/java/org/apache/hudi/common/table/timeline/HoodieTimeline.java\nindex f24f1ad2b..05d41f99e 100755\n--- a/hudi-common/src/main/java/org/apache/hudi/common/table/HoodieTimeline.java\n+++ b/hudi-common/src/main/java/org/apache/hudi/common/table/timeline/HoodieTimeline.java\n\n@@ -160,12 +141,12 @@ public interface HoodieTimeline extends Serializable {\n   /**\n    * Create a new Timeline with all the instants after startTs.\n    */\n-  HoodieTimeline findInstantsAfter(String commitTime, int numCommits);\n+  HoodieTimeline findInstantsAfter(String instantTime, int numCommits);\n \n   /**\n    * Create a new Timeline with all instants before specified time.\n    */\n-  HoodieTimeline findInstantsBefore(String time);\n+  HoodieTimeline findInstantsBefore(String instantTime);\n \n   /**\n    * Custom Filter of Instants.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjA0MzA1NA==", "url": "https://github.com/apache/hudi/pull/1396#discussion_r392043054", "bodyText": "Should this belong in the HoodieTimeline class itself? It seems like you can easily build this using other methods, outside of HoodieTimeline?\nGiven this is an interim fix, I would like this to be as isolated as possible from the core classes..", "author": "vinothchandar", "createdAt": "2020-03-13T05:57:58Z", "path": "hudi-common/src/main/java/org/apache/hudi/common/table/HoodieTimeline.java", "diffHunk": "@@ -127,6 +127,24 @@\n    */\n   HoodieTimeline getCommitsAndCompactionTimeline();\n \n+\n+  /**\n+   * Get all instants (commits, delta commits) that produce new data, in the active timeline.\n+   */\n+  HoodieTimeline getCommitsTimeline();\n+\n+  /**\n+   * Timeline to include all instants before the first 'requested compaction'.\n+   *\n+   * For example, say timeline: commit at t0, deltacommit at t1, compaction requested at t2, deltacommit at t3,\n+   * this method would return t0, t1\n+   *\n+   * If there is no pending compaction this is equivalent to getting all instants in the timeline.\n+   *\n+   * @return\n+   */\n+  HoodieTimeline filterInstantsBeforePendingCompaction();", "originalCommit": "a023c310341f954ef3a9ee91e12853ca9376fe19", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjA0MzE1MA==", "url": "https://github.com/apache/hudi/pull/1396#discussion_r392043150", "bodyText": "In any case, rename to filterInstantsBeforeFirstPendingCompaction?", "author": "vinothchandar", "createdAt": "2020-03-13T05:58:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjA0MzA1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQzNjYzMA==", "url": "https://github.com/apache/hudi/pull/1396#discussion_r392436630", "bodyText": "Moved it to HoodieParquetInputFormat as suggested", "author": "satishkotha", "createdAt": "2020-03-13T19:50:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjA0MzA1NA=="}], "type": "inlineReview", "revised_code": {"commit": "692604937ad658192c2518e0be1e6a1cd4bae993", "chunk": "diff --git a/hudi-common/src/main/java/org/apache/hudi/common/table/HoodieTimeline.java b/hudi-common/src/main/java/org/apache/hudi/common/table/timeline/HoodieTimeline.java\nsimilarity index 84%\nrename from hudi-common/src/main/java/org/apache/hudi/common/table/HoodieTimeline.java\nrename to hudi-common/src/main/java/org/apache/hudi/common/table/timeline/HoodieTimeline.java\nindex f24f1ad2b..05d41f99e 100755\n--- a/hudi-common/src/main/java/org/apache/hudi/common/table/HoodieTimeline.java\n+++ b/hudi-common/src/main/java/org/apache/hudi/common/table/timeline/HoodieTimeline.java\n\n@@ -127,24 +126,6 @@ public interface HoodieTimeline extends Serializable {\n    */\n   HoodieTimeline getCommitsAndCompactionTimeline();\n \n-\n-  /**\n-   * Get all instants (commits, delta commits) that produce new data, in the active timeline.\n-   */\n-  HoodieTimeline getCommitsTimeline();\n-\n-  /**\n-   * Timeline to include all instants before the first 'requested compaction'.\n-   *\n-   * For example, say timeline: commit at t0, deltacommit at t1, compaction requested at t2, deltacommit at t3,\n-   * this method would return t0, t1\n-   *\n-   * If there is no pending compaction this is equivalent to getting all instants in the timeline.\n-   *\n-   * @return\n-   */\n-  HoodieTimeline filterInstantsBeforePendingCompaction();\n-\n   /**\n    * Filter this timeline to just include requested and inflight compaction instants.\n    * \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjA0MzI0MA==", "url": "https://github.com/apache/hudi/pull/1396#discussion_r392043240", "bodyText": "getCommitsAndCompactionTimeline wont do?", "author": "vinothchandar", "createdAt": "2020-03-13T05:58:51Z", "path": "hudi-common/src/main/java/org/apache/hudi/common/table/HoodieTimeline.java", "diffHunk": "@@ -127,6 +127,24 @@\n    */\n   HoodieTimeline getCommitsAndCompactionTimeline();\n \n+\n+  /**\n+   * Get all instants (commits, delta commits) that produce new data, in the active timeline.\n+   */\n+  HoodieTimeline getCommitsTimeline();", "originalCommit": "a023c310341f954ef3a9ee91e12853ca9376fe19", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQzNjg1NQ==", "url": "https://github.com/apache/hudi/pull/1396#discussion_r392436855", "bodyText": "I removed it", "author": "satishkotha", "createdAt": "2020-03-13T19:51:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjA0MzI0MA=="}], "type": "inlineReview", "revised_code": {"commit": "692604937ad658192c2518e0be1e6a1cd4bae993", "chunk": "diff --git a/hudi-common/src/main/java/org/apache/hudi/common/table/HoodieTimeline.java b/hudi-common/src/main/java/org/apache/hudi/common/table/timeline/HoodieTimeline.java\nsimilarity index 84%\nrename from hudi-common/src/main/java/org/apache/hudi/common/table/HoodieTimeline.java\nrename to hudi-common/src/main/java/org/apache/hudi/common/table/timeline/HoodieTimeline.java\nindex f24f1ad2b..05d41f99e 100755\n--- a/hudi-common/src/main/java/org/apache/hudi/common/table/HoodieTimeline.java\n+++ b/hudi-common/src/main/java/org/apache/hudi/common/table/timeline/HoodieTimeline.java\n\n@@ -127,24 +126,6 @@ public interface HoodieTimeline extends Serializable {\n    */\n   HoodieTimeline getCommitsAndCompactionTimeline();\n \n-\n-  /**\n-   * Get all instants (commits, delta commits) that produce new data, in the active timeline.\n-   */\n-  HoodieTimeline getCommitsTimeline();\n-\n-  /**\n-   * Timeline to include all instants before the first 'requested compaction'.\n-   *\n-   * For example, say timeline: commit at t0, deltacommit at t1, compaction requested at t2, deltacommit at t3,\n-   * this method would return t0, t1\n-   *\n-   * If there is no pending compaction this is equivalent to getting all instants in the timeline.\n-   *\n-   * @return\n-   */\n-  HoodieTimeline filterInstantsBeforePendingCompaction();\n-\n   /**\n    * Filter this timeline to just include requested and inflight compaction instants.\n    * \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjA0MzQwNA==", "url": "https://github.com/apache/hudi/pull/1396#discussion_r392043404", "bodyText": "lets move the code from HoodieDefaultTimeline here?", "author": "vinothchandar", "createdAt": "2020-03-13T05:59:42Z", "path": "hudi-hadoop-mr/src/main/java/org/apache/hudi/hadoop/HoodieParquetInputFormat.java", "diffHunk": "@@ -116,6 +117,24 @@\n     return returns.toArray(new FileStatus[returns.size()]);\n   }\n \n+  /**\n+   * Filter any specific instants that we do not want to process.\n+   * example timeline:\n+   *\n+   * t0 -> create bucket1.parquet\n+   * t1 -> create and append updates bucket1.log\n+   * t2 -> request compaction\n+   * t3 -> create bucket2.parquet\n+   *\n+   * if compaction at t2 takes a long time, incremental readers on RO tables can move to t3 and would skip updates in t1\n+   *\n+   * To workaround this problem, we want to stop returning data belonging to commits > t2.\n+   * After compaction is complete, incremental reader would see updates in t2, t3, so on.\n+   */\n+  protected HoodieTimeline filterInstantsTimeline(HoodieTimeline timeline) {", "originalCommit": "a023c310341f954ef3a9ee91e12853ca9376fe19", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQzNjkwOA==", "url": "https://github.com/apache/hudi/pull/1396#discussion_r392436908", "bodyText": "done", "author": "satishkotha", "createdAt": "2020-03-13T19:51:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjA0MzQwNA=="}], "type": "inlineReview", "revised_code": {"commit": "692604937ad658192c2518e0be1e6a1cd4bae993", "chunk": "diff --git a/hudi-hadoop-mr/src/main/java/org/apache/hudi/hadoop/HoodieParquetInputFormat.java b/hudi-hadoop-mr/src/main/java/org/apache/hudi/hadoop/HoodieParquetInputFormat.java\nindex ea3401dbd..6b0ecb9b0 100644\n--- a/hudi-hadoop-mr/src/main/java/org/apache/hudi/hadoop/HoodieParquetInputFormat.java\n+++ b/hudi-hadoop-mr/src/main/java/org/apache/hudi/hadoop/HoodieParquetInputFormat.java\n\n@@ -131,8 +133,20 @@ public class HoodieParquetInputFormat extends MapredParquetInputFormat implement\n    * To workaround this problem, we want to stop returning data belonging to commits > t2.\n    * After compaction is complete, incremental reader would see updates in t2, t3, so on.\n    */\n-  protected HoodieTimeline filterInstantsTimeline(HoodieTimeline timeline) {\n-    return timeline.filterInstantsBeforePendingCompaction();\n+  protected HoodieDefaultTimeline filterInstantsTimeline(HoodieDefaultTimeline timeline) {\n+    HoodieDefaultTimeline commitsAndCompactionTimeline = timeline.getCommitsAndCompactionTimeline();\n+    Option<HoodieInstant> pendingCompactionInstant = commitsAndCompactionTimeline.filterPendingCompactionTimeline().firstInstant();\n+    if (pendingCompactionInstant.isPresent()) {\n+      HoodieDefaultTimeline instantsTimeline = commitsAndCompactionTimeline.findInstantsBefore(pendingCompactionInstant.get().getTimestamp());\n+      int numCommitsFilteredByCompaction = commitsAndCompactionTimeline.getCommitsTimeline().countInstants()\n+          - instantsTimeline.getCommitsTimeline().countInstants();\n+      LOG.info(\"Earliest pending compaction instant is: \" + pendingCompactionInstant.get().getTimestamp()\n+              + \" skipping \" + numCommitsFilteredByCompaction + \" commits\");\n+\n+      return instantsTimeline;\n+    } else {\n+      return timeline;\n+    }\n   }\n \n   /**\n"}}, {"oid": "692604937ad658192c2518e0be1e6a1cd4bae993", "url": "https://github.com/apache/hudi/commit/692604937ad658192c2518e0be1e6a1cd4bae993", "message": "[HUDI-687] Stop incremental reader on RO table when there is a pending compaction", "committedDate": "2020-04-09T21:54:15Z", "type": "commit"}, {"oid": "692604937ad658192c2518e0be1e6a1cd4bae993", "url": "https://github.com/apache/hudi/commit/692604937ad658192c2518e0be1e6a1cd4bae993", "message": "[HUDI-687] Stop incremental reader on RO table when there is a pending compaction", "committedDate": "2020-04-09T21:54:15Z", "type": "forcePushed"}]}