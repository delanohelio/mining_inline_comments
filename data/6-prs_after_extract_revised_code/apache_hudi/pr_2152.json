{"pr_number": 2152, "pr_title": "[HUDI-1326] Added an API to force publish metrics and flush them.", "pr_createdAt": "2020-10-08T00:42:26Z", "pr_url": "https://github.com/apache/hudi/pull/2152", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE3OTU4NA==", "url": "https://github.com/apache/hudi/pull/2152#discussion_r502179584", "bodyText": "Can we do LOG.error ?", "author": "n3nash", "createdAt": "2020-10-09T04:12:49Z", "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/metrics/Metrics.java", "diffHunk": "@@ -68,8 +69,20 @@ private void reportAndCloseReporter() {\n     }\n   }\n \n+  private void reportAndFlushMetrics() {\n+    try {\n+      LOG.info(\"Reporting and flushing all metrics\");\n+\n+      this.registerHoodieCommonMetrics();\n+      this.reporter.report();\n+      this.registry.getNames().forEach(name -> this.registry.remove(name));\n+    } catch (Exception e) {\n+      Metrics.LOG.warn((Object)\"Error while reporting and flushing metrics\", (Throwable)e);", "originalCommit": "45d75c6ad92d9a4ee0478c9c3703b74ebd8fc738", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTAxNjk0OQ==", "url": "https://github.com/apache/hudi/pull/2152#discussion_r509016949", "bodyText": "+1", "author": "vinothchandar", "createdAt": "2020-10-21T06:22:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE3OTU4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTkwNzY2Nw==", "url": "https://github.com/apache/hudi/pull/2152#discussion_r509907667", "bodyText": "Done", "author": "prashantwason", "createdAt": "2020-10-22T06:25:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE3OTU4NA=="}], "type": "inlineReview", "revised_code": {"commit": "306bf62c3f0b80da791788ca9ddacc1aef9ea6a5", "chunk": "diff --git a/hudi-client/hudi-client-common/src/main/java/org/apache/hudi/metrics/Metrics.java b/hudi-client/hudi-client-common/src/main/java/org/apache/hudi/metrics/Metrics.java\nindex 8028c1c24..626e33b37 100644\n--- a/hudi-client/hudi-client-common/src/main/java/org/apache/hudi/metrics/Metrics.java\n+++ b/hudi-client/hudi-client-common/src/main/java/org/apache/hudi/metrics/Metrics.java\n\n@@ -77,7 +77,7 @@ public class Metrics {\n       this.reporter.report();\n       this.registry.getNames().forEach(name -> this.registry.remove(name));\n     } catch (Exception e) {\n-      Metrics.LOG.warn((Object)\"Error while reporting and flushing metrics\", (Throwable)e);\n+      Metrics.LOG.error((Object)\"Error while reporting and flushing metrics\", (Throwable)e);\n     }\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE3OTcyMg==", "url": "https://github.com/apache/hudi/pull/2152#discussion_r502179722", "bodyText": "What should be the right expectation if it's not initialized ? Simply returning gives a false impression to the client that it's flushed.", "author": "n3nash", "createdAt": "2020-10-09T04:13:28Z", "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/metrics/Metrics.java", "diffHunk": "@@ -97,6 +110,14 @@ public static synchronized void shutdown() {\n     initialized = false;\n   }\n \n+  public static synchronized void flush() {\n+    if (!Metrics.initialized) {\n+      return;", "originalCommit": "45d75c6ad92d9a4ee0478c9c3703b74ebd8fc738", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTkwODQxNg==", "url": "https://github.com/apache/hudi/pull/2152#discussion_r509908416", "bodyText": "This is inline with the shutdown() and init() functions which are fail-safe. Unless metrics are initialized there is no effect of calling these.", "author": "prashantwason", "createdAt": "2020-10-22T06:27:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE3OTcyMg=="}], "type": "inlineReview", "revised_code": {"commit": "cd02a8bfd91146c3ea35988b8760799c27191769", "chunk": "diff --git a/hudi-client/hudi-client-common/src/main/java/org/apache/hudi/metrics/Metrics.java b/hudi-client/hudi-client-common/src/main/java/org/apache/hudi/metrics/Metrics.java\nindex 8028c1c24..5667a66a5 100644\n--- a/hudi-client/hudi-client-common/src/main/java/org/apache/hudi/metrics/Metrics.java\n+++ b/hudi-client/hudi-client-common/src/main/java/org/apache/hudi/metrics/Metrics.java\n\n@@ -106,7 +106,7 @@ public class Metrics {\n     if (!initialized) {\n       return;\n     }\n-    metrics.reportAndCloseReporter();\n+    instance.reportAndCloseReporter();\n     initialized = false;\n   }\n \n"}}, {"oid": "306bf62c3f0b80da791788ca9ddacc1aef9ea6a5", "url": "https://github.com/apache/hudi/commit/306bf62c3f0b80da791788ca9ddacc1aef9ea6a5", "message": "[HUDI-1326] Added an API to force publish metrics and flush them.\n\nUsing the added API, publish metrics after each level of the DAG completed in hudi-test-suite.", "committedDate": "2020-10-22T06:42:14Z", "type": "commit"}, {"oid": "306bf62c3f0b80da791788ca9ddacc1aef9ea6a5", "url": "https://github.com/apache/hudi/commit/306bf62c3f0b80da791788ca9ddacc1aef9ea6a5", "message": "[HUDI-1326] Added an API to force publish metrics and flush them.\n\nUsing the added API, publish metrics after each level of the DAG completed in hudi-test-suite.", "committedDate": "2020-10-22T06:42:14Z", "type": "forcePushed"}, {"oid": "cd02a8bfd91146c3ea35988b8760799c27191769", "url": "https://github.com/apache/hudi/commit/cd02a8bfd91146c3ea35988b8760799c27191769", "message": "Code cleanups", "committedDate": "2020-10-24T22:18:11Z", "type": "commit"}]}