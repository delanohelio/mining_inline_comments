{"pr_number": 1515, "pr_title": "[HUDI-795] Ignoring missing aux folder", "pr_createdAt": "2020-04-14T21:41:47Z", "pr_url": "https://github.com/apache/hudi/pull/1515", "timeline": [{"oid": "fe29645d312200a4dca8d33e4ba5ec099f7e8f4e", "url": "https://github.com/apache/hudi/commit/fe29645d312200a4dca8d33e4ba5ec099f7e8f4e", "message": "Ignoring missing aux folde", "committedDate": "2020-04-14T21:37:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk3ODkwMw==", "url": "https://github.com/apache/hudi/pull/1515#discussion_r408978903", "bodyText": "Can you please provide specific pointers on how the folder gets removed on GCS? Is it GCS specific?", "author": "pratyakshsharma", "createdAt": "2020-04-15T16:35:01Z", "path": "hudi-client/src/main/java/org/apache/hudi/table/HoodieCommitArchiveLog.java", "diffHunk": "@@ -219,14 +220,23 @@ private boolean deleteArchivedInstants(List<HoodieInstant> archivedInstants) thr\n    * @throws IOException in case of error\n    */\n   private boolean deleteAllInstantsOlderorEqualsInAuxMetaFolder(HoodieInstant thresholdInstant) throws IOException {\n-    List<HoodieInstant> instants = metaClient.scanHoodieInstantsFromFileSystem(\n-        new Path(metaClient.getMetaAuxiliaryPath()), HoodieActiveTimeline.VALID_EXTENSIONS_IN_ACTIVE_TIMELINE, false);\n+    List<HoodieInstant> instants = null;\n+    boolean success = true;\n+    try {\n+      instants =\n+          metaClient.scanHoodieInstantsFromFileSystem(\n+              new Path(metaClient.getMetaAuxiliaryPath()),\n+              HoodieActiveTimeline.VALID_EXTENSIONS_IN_ACTIVE_TIMELINE,\n+              false);\n+    } catch (FileNotFoundException e) {", "originalCommit": "fe29645d312200a4dca8d33e4ba5ec099f7e8f4e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIwODAzMg==", "url": "https://github.com/apache/hudi/pull/1515#discussion_r409208032", "bodyText": "not sure about it. Did see that folder disappears/reappears sometimes. Can be related to the way GCS connector treats a situation when all the files from the folder are removed.\nOn gcs folders are not real, they are just logical. So, file with name: gs://bucket/folder/file doesn't live in the folder \"folder\", it just has a long \"/\" separated name. I saw some logic in the GCS FS java implementation that creates fake file \"/\" when everything is removed from the logical folder. So, my speculation is that if this call fails or not enabled, that removing all the files from the folder will end up if folder being removed as well.", "author": "afilipchik", "createdAt": "2020-04-16T00:19:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk3ODkwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ5MDE0MA==", "url": "https://github.com/apache/hudi/pull/1515#discussion_r411490140", "bodyText": "@afilipchik : Can you add the above comment in the Exception code block. Easy to understand the reason for this code. Also, Does this mean, we need to create the \"aux\" folder next time we create a file under aux ?", "author": "bvaradar", "createdAt": "2020-04-20T15:51:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk3ODkwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTUzNjkyNA==", "url": "https://github.com/apache/hudi/pull/1515#discussion_r411536924", "bodyText": "Will add comment. On create folder -> no, as GCS will create \"folder\" automatically.", "author": "afilipchik", "createdAt": "2020-04-20T16:54:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk3ODkwMw=="}], "type": "inlineReview", "revised_code": {"commit": "aa7850d7e3d3398205e41dfd0c1a1569449daee1", "chunk": "diff --git a/hudi-client/src/main/java/org/apache/hudi/table/HoodieCommitArchiveLog.java b/hudi-client/src/main/java/org/apache/hudi/table/HoodieCommitArchiveLog.java\nindex 613e199d4..8db260872 100644\n--- a/hudi-client/src/main/java/org/apache/hudi/table/HoodieCommitArchiveLog.java\n+++ b/hudi-client/src/main/java/org/apache/hudi/table/HoodieCommitArchiveLog.java\n\n@@ -229,6 +229,12 @@ public class HoodieCommitArchiveLog {\n               HoodieActiveTimeline.VALID_EXTENSIONS_IN_ACTIVE_TIMELINE,\n               false);\n     } catch (FileNotFoundException e) {\n+      // On some FSs deletion of all files in the directory can auto remove the directory itself.\n+      // GCS is one example, as it doesn't have real directories and subdirectories. When client\n+      // removes all the files from a \"folder\" on GCS is has to create a special \"/\" to keep the folder\n+      // around. If this doesn't happen (timeout, misconfigured client, ...) folder will be deleted and\n+      // in this case we should not break when aux folder is not found.\n+      // GCS information: (https://cloud.google.com/storage/docs/gsutil/addlhelp/HowSubdirectoriesWork)\n       LOG.warn(\"Aux path not found. Skipping: \" + metaClient.getMetaAuxiliaryPath());\n       return success;\n     }\n"}}, {"oid": "aa7850d7e3d3398205e41dfd0c1a1569449daee1", "url": "https://github.com/apache/hudi/commit/aa7850d7e3d3398205e41dfd0c1a1569449daee1", "message": "Updated comment", "committedDate": "2020-04-20T17:06:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU5MjExOQ==", "url": "https://github.com/apache/hudi/pull/1515#discussion_r411592119", "bodyText": "Guess it would be better to use multi line comments here like\n/*\n*\n*/", "author": "pratyakshsharma", "createdAt": "2020-04-20T18:19:37Z", "path": "hudi-client/src/main/java/org/apache/hudi/table/HoodieCommitArchiveLog.java", "diffHunk": "@@ -219,14 +220,29 @@ private boolean deleteArchivedInstants(List<HoodieInstant> archivedInstants) thr\n    * @throws IOException in case of error\n    */\n   private boolean deleteAllInstantsOlderorEqualsInAuxMetaFolder(HoodieInstant thresholdInstant) throws IOException {\n-    List<HoodieInstant> instants = metaClient.scanHoodieInstantsFromFileSystem(\n-        new Path(metaClient.getMetaAuxiliaryPath()), HoodieActiveTimeline.VALID_EXTENSIONS_IN_ACTIVE_TIMELINE, false);\n+    List<HoodieInstant> instants = null;\n+    boolean success = true;\n+    try {\n+      instants =\n+          metaClient.scanHoodieInstantsFromFileSystem(\n+              new Path(metaClient.getMetaAuxiliaryPath()),\n+              HoodieActiveTimeline.VALID_EXTENSIONS_IN_ACTIVE_TIMELINE,\n+              false);\n+    } catch (FileNotFoundException e) {\n+      // On some FSs deletion of all files in the directory can auto remove the directory itself.\n+      // GCS is one example, as it doesn't have real directories and subdirectories. When client\n+      // removes all the files from a \"folder\" on GCS is has to create a special \"/\" to keep the folder\n+      // around. If this doesn't happen (timeout, misconfigured client, ...) folder will be deleted and\n+      // in this case we should not break when aux folder is not found.\n+      // GCS information: (https://cloud.google.com/storage/docs/gsutil/addlhelp/HowSubdirectoriesWork)", "originalCommit": "aa7850d7e3d3398205e41dfd0c1a1569449daee1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU3MTU4NA==", "url": "https://github.com/apache/hudi/pull/1515#discussion_r412571584", "bodyText": "updated", "author": "afilipchik", "createdAt": "2020-04-21T23:57:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU5MjExOQ=="}], "type": "inlineReview", "revised_code": {"commit": "7500d06e325cef1a50e8812058da7f02c0470c15", "chunk": "diff --git a/hudi-client/src/main/java/org/apache/hudi/table/HoodieCommitArchiveLog.java b/hudi-client/src/main/java/org/apache/hudi/table/HoodieCommitArchiveLog.java\nindex 8db260872..5bd81eeed 100644\n--- a/hudi-client/src/main/java/org/apache/hudi/table/HoodieCommitArchiveLog.java\n+++ b/hudi-client/src/main/java/org/apache/hudi/table/HoodieCommitArchiveLog.java\n\n@@ -229,12 +229,14 @@ public class HoodieCommitArchiveLog {\n               HoodieActiveTimeline.VALID_EXTENSIONS_IN_ACTIVE_TIMELINE,\n               false);\n     } catch (FileNotFoundException e) {\n-      // On some FSs deletion of all files in the directory can auto remove the directory itself.\n-      // GCS is one example, as it doesn't have real directories and subdirectories. When client\n-      // removes all the files from a \"folder\" on GCS is has to create a special \"/\" to keep the folder\n-      // around. If this doesn't happen (timeout, misconfigured client, ...) folder will be deleted and\n-      // in this case we should not break when aux folder is not found.\n-      // GCS information: (https://cloud.google.com/storage/docs/gsutil/addlhelp/HowSubdirectoriesWork)\n+      /*\n+       * On some FSs deletion of all files in the directory can auto remove the directory itself.\n+       * GCS is one example, as it doesn't have real directories and subdirectories. When client\n+       * removes all the files from a \"folder\" on GCS is has to create a special \"/\" to keep the folder\n+       * around. If this doesn't happen (timeout, misconfigured client, ...) folder will be deleted and\n+       * in this case we should not break when aux folder is not found.\n+       * GCS information: (https://cloud.google.com/storage/docs/gsutil/addlhelp/HowSubdirectoriesWork)\n+       */\n       LOG.warn(\"Aux path not found. Skipping: \" + metaClient.getMetaAuxiliaryPath());\n       return success;\n     }\n"}}, {"oid": "7500d06e325cef1a50e8812058da7f02c0470c15", "url": "https://github.com/apache/hudi/commit/7500d06e325cef1a50e8812058da7f02c0470c15", "message": "Changed comments style", "committedDate": "2020-04-21T23:56:10Z", "type": "commit"}]}