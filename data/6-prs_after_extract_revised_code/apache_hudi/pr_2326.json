{"pr_number": 2326, "pr_title": "[HUDI-1450] [RFC-15] Use metadata table for listing in HoodieROTablePathFilter", "pr_createdAt": "2020-12-11T02:06:46Z", "pr_url": "https://github.com/apache/hudi/pull/2326", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDA4MzM2NA==", "url": "https://github.com/apache/hudi/pull/2326#discussion_r544083364", "bodyText": "minor: these seen to be duplicated from metadata code. If there is a simple way of moving them to a common class and accessing from there, that would be better.", "author": "prashantwason", "createdAt": "2020-12-16T07:53:09Z", "path": "hudi-hadoop-mr/src/main/java/org/apache/hudi/hadoop/HoodieROTablePathFilter.java", "diffHunk": "@@ -56,6 +58,15 @@\n public class HoodieROTablePathFilter implements Configurable, PathFilter, Serializable {\n \n   private static final long serialVersionUID = 1L;\n+  public static final String METADATA_PREFIX = \"hoodie.metadata\";", "originalCommit": "877c4d60acdb9dd23dbd60b0b4e8d6db46098409", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc2MjYxMw==", "url": "https://github.com/apache/hudi/pull/2326#discussion_r544762613", "bodyText": "I have moved the HoodieMetadataConfig class to hudi-common.", "author": "umehrot2", "createdAt": "2020-12-17T02:23:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDA4MzM2NA=="}], "type": "inlineReview", "revised_code": {"commit": "b08957f6270caf4e4392ce344fe8b24fa33bf8ec", "chunk": "diff --git a/hudi-hadoop-mr/src/main/java/org/apache/hudi/hadoop/HoodieROTablePathFilter.java b/hudi-hadoop-mr/src/main/java/org/apache/hudi/hadoop/HoodieROTablePathFilter.java\nindex fc5b50dbd..50fd0e1ce 100644\n--- a/hudi-hadoop-mr/src/main/java/org/apache/hudi/hadoop/HoodieROTablePathFilter.java\n+++ b/hudi-hadoop-mr/src/main/java/org/apache/hudi/hadoop/HoodieROTablePathFilter.java\n\n@@ -58,15 +63,6 @@ import java.util.stream.Collectors;\n public class HoodieROTablePathFilter implements Configurable, PathFilter, Serializable {\n \n   private static final long serialVersionUID = 1L;\n-  public static final String METADATA_PREFIX = \"hoodie.metadata\";\n-\n-  // List using internal metadata table which saves file listings\n-  public static final String METADATA_ENABLE_PROP = METADATA_PREFIX + \".enable\";\n-  public static final boolean DEFAULT_METADATA_ENABLE = false;\n-\n-  // Validate contents of Metadata Table on each access against the actual filesystem\n-  public static final String METADATA_VALIDATE_PROP = METADATA_PREFIX + \".validate\";\n-  public static final boolean DEFAULT_METADATA_VALIDATE = false;\n   private static final Logger LOG = LogManager.getLogger(HoodieROTablePathFilter.class);\n \n   /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDA4NTU0MA==", "url": "https://github.com/apache/hudi/pull/2326#discussion_r544085540", "bodyText": "This default can be true as within HoodieTableMetadata - If the metadata table does not exist, RPC calls are used to retrieve file listings from the file system.", "author": "prashantwason", "createdAt": "2020-12-16T07:57:23Z", "path": "hudi-hadoop-mr/src/main/java/org/apache/hudi/hadoop/HoodieROTablePathFilter.java", "diffHunk": "@@ -56,6 +58,15 @@\n public class HoodieROTablePathFilter implements Configurable, PathFilter, Serializable {\n \n   private static final long serialVersionUID = 1L;\n+  public static final String METADATA_PREFIX = \"hoodie.metadata\";\n+\n+  // List using internal metadata table which saves file listings\n+  public static final String METADATA_ENABLE_PROP = METADATA_PREFIX + \".enable\";\n+  public static final boolean DEFAULT_METADATA_ENABLE = false;", "originalCommit": "877c4d60acdb9dd23dbd60b0b4e8d6db46098409", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc2OTEwMw==", "url": "https://github.com/apache/hudi/pull/2326#discussion_r544769103", "bodyText": "Makes sense. I introduced a true default for the readers, but just a but concerned about the additional overhead this introduces in the regular (non metadata table) hudi path, as it would keep checking for the metadata folder and call getFileStatus() and then fail. This can be an overhead for S3.", "author": "umehrot2", "createdAt": "2020-12-17T02:41:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDA4NTU0MA=="}], "type": "inlineReview", "revised_code": {"commit": "b08957f6270caf4e4392ce344fe8b24fa33bf8ec", "chunk": "diff --git a/hudi-hadoop-mr/src/main/java/org/apache/hudi/hadoop/HoodieROTablePathFilter.java b/hudi-hadoop-mr/src/main/java/org/apache/hudi/hadoop/HoodieROTablePathFilter.java\nindex fc5b50dbd..50fd0e1ce 100644\n--- a/hudi-hadoop-mr/src/main/java/org/apache/hudi/hadoop/HoodieROTablePathFilter.java\n+++ b/hudi-hadoop-mr/src/main/java/org/apache/hudi/hadoop/HoodieROTablePathFilter.java\n\n@@ -58,15 +63,6 @@ import java.util.stream.Collectors;\n public class HoodieROTablePathFilter implements Configurable, PathFilter, Serializable {\n \n   private static final long serialVersionUID = 1L;\n-  public static final String METADATA_PREFIX = \"hoodie.metadata\";\n-\n-  // List using internal metadata table which saves file listings\n-  public static final String METADATA_ENABLE_PROP = METADATA_PREFIX + \".enable\";\n-  public static final boolean DEFAULT_METADATA_ENABLE = false;\n-\n-  // Validate contents of Metadata Table on each access against the actual filesystem\n-  public static final String METADATA_VALIDATE_PROP = METADATA_PREFIX + \".validate\";\n-  public static final boolean DEFAULT_METADATA_VALIDATE = false;\n   private static final Logger LOG = LogManager.getLogger(HoodieROTablePathFilter.class);\n \n   /**\n"}}, {"oid": "b08957f6270caf4e4392ce344fe8b24fa33bf8ec", "url": "https://github.com/apache/hudi/commit/b08957f6270caf4e4392ce344fe8b24fa33bf8ec", "message": "Use metadata table for listing in HoodieROTablePathFilter", "committedDate": "2020-12-17T02:19:38Z", "type": "forcePushed"}, {"oid": "a3701aaf95988e65de3c45652f71f164a52b13fd", "url": "https://github.com/apache/hudi/commit/a3701aaf95988e65de3c45652f71f164a52b13fd", "message": "Use metadata table for listing in HoodieROTablePathFilter", "committedDate": "2020-12-17T02:38:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTE0NTA2Nw==", "url": "https://github.com/apache/hudi/pull/2326#discussion_r545145067", "bodyText": "trying to understand these formatting changes. can we use whichever aligns with checkstyle?", "author": "vinothchandar", "createdAt": "2020-12-17T14:46:26Z", "path": "hudi-common/src/main/java/org/apache/hudi/common/config/HoodieMetadataConfig.java", "diffHunk": "@@ -128,24 +128,23 @@ public Builder retainCommits(int commitsRetained) {\n     public HoodieMetadataConfig build() {\n       HoodieMetadataConfig config = new HoodieMetadataConfig(props);\n       setDefaultOnCondition(props, !props.containsKey(METADATA_ENABLE_PROP), METADATA_ENABLE_PROP,\n-          String.valueOf(DEFAULT_METADATA_ENABLE));\n+              String.valueOf(DEFAULT_METADATA_ENABLE));", "originalCommit": "a3701aaf95988e65de3c45652f71f164a52b13fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTUwODAzNw==", "url": "https://github.com/apache/hudi/pull/2326#discussion_r545508037", "bodyText": "Reverted it back. The earlier one aligns better with Hudi checkstyle.", "author": "umehrot2", "createdAt": "2020-12-18T01:10:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTE0NTA2Nw=="}], "type": "inlineReview", "revised_code": {"commit": "0b566fd933f40c1705b0fee5eb7e53328d8ab4b4", "chunk": "diff --git a/hudi-common/src/main/java/org/apache/hudi/common/config/HoodieMetadataConfig.java b/hudi-common/src/main/java/org/apache/hudi/common/config/HoodieMetadataConfig.java\nindex 9857d6985..cc6d89d08 100644\n--- a/hudi-common/src/main/java/org/apache/hudi/common/config/HoodieMetadataConfig.java\n+++ b/hudi-common/src/main/java/org/apache/hudi/common/config/HoodieMetadataConfig.java\n\n@@ -128,21 +128,21 @@ public final class HoodieMetadataConfig extends DefaultHoodieConfig {\n     public HoodieMetadataConfig build() {\n       HoodieMetadataConfig config = new HoodieMetadataConfig(props);\n       setDefaultOnCondition(props, !props.containsKey(METADATA_ENABLE_PROP), METADATA_ENABLE_PROP,\n-              String.valueOf(DEFAULT_METADATA_ENABLE));\n+          String.valueOf(DEFAULT_METADATA_ENABLE));\n       setDefaultOnCondition(props, !props.containsKey(METADATA_VALIDATE_PROP), METADATA_VALIDATE_PROP,\n-              String.valueOf(DEFAULT_METADATA_VALIDATE));\n+          String.valueOf(DEFAULT_METADATA_VALIDATE));\n       setDefaultOnCondition(props, !props.containsKey(METADATA_INSERT_PARALLELISM_PROP), METADATA_INSERT_PARALLELISM_PROP,\n-              String.valueOf(DEFAULT_METADATA_INSERT_PARALLELISM));\n+          String.valueOf(DEFAULT_METADATA_INSERT_PARALLELISM));\n       setDefaultOnCondition(props, !props.containsKey(METADATA_ASYNC_CLEAN_PROP), METADATA_ASYNC_CLEAN_PROP,\n-              String.valueOf(DEFAULT_METADATA_ASYNC_CLEAN));\n+          String.valueOf(DEFAULT_METADATA_ASYNC_CLEAN));\n       setDefaultOnCondition(props, !props.containsKey(METADATA_COMPACT_NUM_DELTA_COMMITS_PROP),\n-              METADATA_COMPACT_NUM_DELTA_COMMITS_PROP, String.valueOf(DEFAULT_METADATA_COMPACT_NUM_DELTA_COMMITS));\n+          METADATA_COMPACT_NUM_DELTA_COMMITS_PROP, String.valueOf(DEFAULT_METADATA_COMPACT_NUM_DELTA_COMMITS));\n       setDefaultOnCondition(props, !props.containsKey(CLEANER_COMMITS_RETAINED_PROP), CLEANER_COMMITS_RETAINED_PROP,\n-              String.valueOf(DEFAULT_CLEANER_COMMITS_RETAINED));\n+          String.valueOf(DEFAULT_CLEANER_COMMITS_RETAINED));\n       setDefaultOnCondition(props, !props.containsKey(MAX_COMMITS_TO_KEEP_PROP), MAX_COMMITS_TO_KEEP_PROP,\n-              String.valueOf(DEFAULT_MAX_COMMITS_TO_KEEP));\n+          String.valueOf(DEFAULT_MAX_COMMITS_TO_KEEP));\n       setDefaultOnCondition(props, !props.containsKey(MIN_COMMITS_TO_KEEP_PROP), MIN_COMMITS_TO_KEEP_PROP,\n-              String.valueOf(DEFAULT_MIN_COMMITS_TO_KEEP));\n+          String.valueOf(DEFAULT_MIN_COMMITS_TO_KEEP));\n \n       return config;\n     }\n"}}, {"oid": "0b566fd933f40c1705b0fee5eb7e53328d8ab4b4", "url": "https://github.com/apache/hudi/commit/0b566fd933f40c1705b0fee5eb7e53328d8ab4b4", "message": "Use metadata table for listing in HoodieROTablePathFilter", "committedDate": "2020-12-18T01:05:41Z", "type": "commit"}, {"oid": "0b566fd933f40c1705b0fee5eb7e53328d8ab4b4", "url": "https://github.com/apache/hudi/commit/0b566fd933f40c1705b0fee5eb7e53328d8ab4b4", "message": "Use metadata table for listing in HoodieROTablePathFilter", "committedDate": "2020-12-18T01:05:41Z", "type": "forcePushed"}]}