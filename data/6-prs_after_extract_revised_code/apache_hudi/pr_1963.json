{"pr_number": 1963, "pr_title": "[HUDI-1188] Hbase index MOR tables records not being deduplicated", "pr_createdAt": "2020-08-13T23:16:51Z", "pr_url": "https://github.com/apache/hudi/pull/1963", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQzMTU2Ng==", "url": "https://github.com/apache/hudi/pull/1963#discussion_r470431566", "bodyText": "we could use the metaClient.getCommitsTimeline() or one of those methods which will automatically determine the commit instant type based on table type?", "author": "vinothchandar", "createdAt": "2020-08-14T06:19:25Z", "path": "hudi-client/src/main/java/org/apache/hudi/index/hbase/HBaseIndex.java", "diffHunk": "@@ -182,6 +182,7 @@ private boolean checkIfValidCommit(HoodieTableMetaClient metaClient, String comm\n     // 2) is less than the first commit ts in the timeline\n     return !commitTimeline.empty()\n         && (commitTimeline.containsInstant(new HoodieInstant(false, HoodieTimeline.COMMIT_ACTION, commitTs))", "originalCommit": "c97410397d0214b7171cd17b42ba636fecb2a92d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc2ODU3NQ==", "url": "https://github.com/apache/hudi/pull/1963#discussion_r470768575", "bodyText": "Yes, @rmpifer please use the above API Vinoth mentioned to refactor this code so we can include both DELTA_COMMIT & COMMIT actions", "author": "n3nash", "createdAt": "2020-08-14T17:49:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQzMTU2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkxNTU3MQ==", "url": "https://github.com/apache/hudi/pull/1963#discussion_r471915571", "bodyText": "Thanks for the suggestion. Updated to address comment", "author": "rmpifer", "createdAt": "2020-08-18T05:03:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQzMTU2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "93db938649e6a7bd07e1be4c95e4ff132c56b839", "chunk": "diff --git a/hudi-client/src/main/java/org/apache/hudi/index/hbase/HBaseIndex.java b/hudi-client/src/main/java/org/apache/hudi/index/hbase/HBaseIndex.java\nindex f452b86a5..af37e495d 100644\n--- a/hudi-client/src/main/java/org/apache/hudi/index/hbase/HBaseIndex.java\n+++ b/hudi-client/src/main/java/org/apache/hudi/index/hbase/HBaseIndex.java\n\n@@ -177,14 +177,11 @@ public class HBaseIndex<T extends HoodieRecordPayload> extends HoodieIndex<T> {\n   }\n \n   private boolean checkIfValidCommit(HoodieTableMetaClient metaClient, String commitTs) {\n-    HoodieTimeline commitTimeline = metaClient.getActiveTimeline().filterCompletedInstants();\n+    HoodieTimeline commitTimeline = metaClient.getCommitsTimeline();\n     // Check if the last commit ts for this row is 1) present in the timeline or\n     // 2) is less than the first commit ts in the timeline\n     return !commitTimeline.empty()\n-        && (commitTimeline.containsInstant(new HoodieInstant(false, HoodieTimeline.COMMIT_ACTION, commitTs))\n-            || commitTimeline.containsInstant(new HoodieInstant(false, HoodieTimeline.DELTA_COMMIT_ACTION, commitTs))\n-            || HoodieTimeline.compareTimestamps(commitTimeline.firstInstant().get().getTimestamp(), HoodieTimeline.GREATER_THAN, commitTs\n-    ));\n+        && commitTimeline.containsOrBeforeTimelineStarts(commitTs);\n   }\n \n   /**\n"}}, {"oid": "124b9324b0cc2eabac6ecbd60883220dbd0b0b35", "url": "https://github.com/apache/hudi/commit/124b9324b0cc2eabac6ecbd60883220dbd0b0b35", "message": "Fix HBASE index MOR tables not considering record index valid", "committedDate": "2020-08-18T00:22:10Z", "type": "forcePushed"}, {"oid": "93db938649e6a7bd07e1be4c95e4ff132c56b839", "url": "https://github.com/apache/hudi/commit/93db938649e6a7bd07e1be4c95e4ff132c56b839", "message": "Fix HBASE index MOR tables not considering record index valid", "committedDate": "2020-08-18T00:25:43Z", "type": "forcePushed"}, {"oid": "0ded9dba8cff584fbbf31494bebecf4d9f199d68", "url": "https://github.com/apache/hudi/commit/0ded9dba8cff584fbbf31494bebecf4d9f199d68", "message": "Fix HBASE index MOR tables not considering record index valid", "committedDate": "2020-08-18T03:18:14Z", "type": "commit"}, {"oid": "0ded9dba8cff584fbbf31494bebecf4d9f199d68", "url": "https://github.com/apache/hudi/commit/0ded9dba8cff584fbbf31494bebecf4d9f199d68", "message": "Fix HBASE index MOR tables not considering record index valid", "committedDate": "2020-08-18T03:18:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY4NzQwMQ==", "url": "https://github.com/apache/hudi/pull/1963#discussion_r472687401", "bodyText": "Can you please change this to -> metaClient.getActiveTimeline().getCommitsTimeline(). For context, the getActiveTimeline() loads the timeline once and then caches it. The getCommitsTimeline() call will not force this, in this case it's working by coincidence because the metaClient passed already has the loaded timeline from the caller but I would want to avoid having that assumption.\n@rmpifer", "author": "n3nash", "createdAt": "2020-08-19T04:45:44Z", "path": "hudi-client/src/main/java/org/apache/hudi/index/hbase/HBaseIndex.java", "diffHunk": "@@ -177,13 +176,11 @@ private Get generateStatement(String key) throws IOException {\n   }\n \n   private boolean checkIfValidCommit(HoodieTableMetaClient metaClient, String commitTs) {\n-    HoodieTimeline commitTimeline = metaClient.getActiveTimeline().filterCompletedInstants();\n+    HoodieTimeline commitTimeline = metaClient.getCommitsTimeline().filterCompletedInstants();", "originalCommit": "0ded9dba8cff584fbbf31494bebecf4d9f199d68", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI0NzM4Nw==", "url": "https://github.com/apache/hudi/pull/1963#discussion_r473247387", "bodyText": "@n3nash It looks like HoodieTableMetaClient.getCommitsTimeline internally calls getActiveTimeline()\nhttps://github.com/rmpifer/hudi/blob/master/hudi-common/src/main/java/org/apache/hudi/common/table/HoodieTableMetaClient.java#L478", "author": "rmpifer", "createdAt": "2020-08-19T18:47:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY4NzQwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzM2MjM0Mg==", "url": "https://github.com/apache/hudi/pull/1963#discussion_r473362342", "bodyText": "okay, great, thanks for checking.", "author": "n3nash", "createdAt": "2020-08-19T21:55:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY4NzQwMQ=="}], "type": "inlineReview", "revised_code": null}]}