{"pr_number": 1968, "pr_title": "[HUDI-1192] Make create hive database automatically configurable", "pr_createdAt": "2020-08-14T10:48:12Z", "pr_url": "https://github.com/apache/hudi/pull/1968", "timeline": [{"oid": "fe312436062c0ef0b7a67a1fed641ee99de5d8f1", "url": "https://github.com/apache/hudi/commit/fe312436062c0ef0b7a67a1fed641ee99de5d8f1", "message": "HUDI-1192\nFix the failure of creating hive database", "committedDate": "2020-08-14T10:45:10Z", "type": "commit"}, {"oid": "694cb35d0192440e0e786a2cca15f6ea546e12b6", "url": "https://github.com/apache/hudi/commit/694cb35d0192440e0e786a2cca15f6ea546e12b6", "message": "HUDI-1193\nUpgrade http dependent version", "committedDate": "2020-08-14T11:27:34Z", "type": "commit"}, {"oid": "c28e4801807d6dad4e904c5e154526af943399c7", "url": "https://github.com/apache/hudi/commit/c28e4801807d6dad4e904c5e154526af943399c7", "message": "HUDI-1192", "committedDate": "2020-08-19T09:59:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM0ODU4OQ==", "url": "https://github.com/apache/hudi/pull/1968#discussion_r474348589", "bodyText": "\"Create hive database\" -> \"Enable create hive database\"", "author": "yanghua", "createdAt": "2020-08-21T00:51:47Z", "path": "hudi-sync/hudi-hive-sync/src/main/java/org/apache/hudi/hive/HiveSyncConfig.java", "diffHunk": "@@ -71,6 +71,9 @@\n   @Parameter(names = {\"--use-jdbc\"}, description = \"Hive jdbc connect url\")\n   public Boolean useJdbc = true;\n \n+  @Parameter(names = {\"--enable-create-database\"}, description = \"Create hive database\")", "originalCommit": "c28e4801807d6dad4e904c5e154526af943399c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQzNzk3Mw==", "url": "https://github.com/apache/hudi/pull/1968#discussion_r474437973", "bodyText": "ok", "author": "liujinhui1994", "createdAt": "2020-08-21T06:39:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM0ODU4OQ=="}], "type": "inlineReview", "revised_code": {"commit": "cbf33682e63ce84e1b9a83689065846d4170ccc9", "chunk": "diff --git a/hudi-sync/hudi-hive-sync/src/main/java/org/apache/hudi/hive/HiveSyncConfig.java b/hudi-sync/hudi-hive-sync/src/main/java/org/apache/hudi/hive/HiveSyncConfig.java\nindex ad27a6aa7..c4953a134 100644\n--- a/hudi-sync/hudi-hive-sync/src/main/java/org/apache/hudi/hive/HiveSyncConfig.java\n+++ b/hudi-sync/hudi-hive-sync/src/main/java/org/apache/hudi/hive/HiveSyncConfig.java\n\n@@ -71,7 +71,7 @@ public class HiveSyncConfig implements Serializable {\n   @Parameter(names = {\"--use-jdbc\"}, description = \"Hive jdbc connect url\")\n   public Boolean useJdbc = true;\n \n-  @Parameter(names = {\"--enable-create-database\"}, description = \"Create hive database\")\n+  @Parameter(names = {\"--enable-create-database\"}, description = \"Enable create hive database\")\n   public Boolean enableCreateDatabase = false;\n \n   @Parameter(names = {\"--skip-ro-suffix\"}, description = \"Skip the `_ro` suffix for Read optimized table, when registering\")\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM0OTg0Ng==", "url": "https://github.com/apache/hudi/pull/1968#discussion_r474349846", "bodyText": "I still have a question here. If we do not allow initializing hive database. Or if the database does not exist. Would affect the subsequent business logic?", "author": "yanghua", "createdAt": "2020-08-21T00:56:49Z", "path": "hudi-sync/hudi-hive-sync/src/main/java/org/apache/hudi/hive/HiveSyncTool.java", "diffHunk": "@@ -117,11 +117,13 @@ private void syncHoodieTable(String tableName, boolean useRealtimeInputFormat) {\n     boolean tableExists = hoodieHiveClient.doesTableExist(tableName);\n \n     // check if the database exists else create it\n-    try {\n-      hoodieHiveClient.updateHiveSQL(\"create database if not exists \" + cfg.databaseName);\n-    } catch (Exception e) {\n-      // this is harmless since table creation will fail anyways, creation of DB is needed for in-memory testing\n-      LOG.warn(\"Unable to create database\", e);\n+    if (cfg.enableCreateDatabase) {\n+      try {\n+        hoodieHiveClient.updateHiveSQL(\"create database if not exists \" + cfg.databaseName);", "originalCommit": "c28e4801807d6dad4e904c5e154526af943399c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQzNjE5Nw==", "url": "https://github.com/apache/hudi/pull/1968#discussion_r474436197", "bodyText": "The choice to create a database here is because hive database is usually only created by hive users, and other users have no permission to create hive tables.", "author": "liujinhui1994", "createdAt": "2020-08-21T06:34:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM0OTg0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI2MTA0Mw==", "url": "https://github.com/apache/hudi/pull/1968#discussion_r480261043", "bodyText": "Should we just throw an error and exit if enableCreateDatabase=false and the database does not exist?", "author": "vinothchandar", "createdAt": "2020-08-31T16:56:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM0OTg0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ5MjYxNw==", "url": "https://github.com/apache/hudi/pull/1968#discussion_r480492617", "bodyText": "Yes, I have discussed with @liujinhui1994 off-line about this issue and asked him to find a way to check whether the database exists or not.", "author": "yanghua", "createdAt": "2020-09-01T00:22:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM0OTg0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkxMDM2Nw==", "url": "https://github.com/apache/hudi/pull/1968#discussion_r485910367", "bodyText": "+1 on throwing the error.", "author": "pratyakshsharma", "createdAt": "2020-09-09T20:43:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM0OTg0Ng=="}], "type": "inlineReview", "revised_code": {"commit": "1dc085721c15e064c53c73c2a66661458bf76011", "chunk": "diff --git a/hudi-sync/hudi-hive-sync/src/main/java/org/apache/hudi/hive/HiveSyncTool.java b/hudi-sync/hudi-hive-sync/src/main/java/org/apache/hudi/hive/HiveSyncTool.java\nindex 674e0eead..366b03c42 100644\n--- a/hudi-sync/hudi-hive-sync/src/main/java/org/apache/hudi/hive/HiveSyncTool.java\n+++ b/hudi-sync/hudi-hive-sync/src/main/java/org/apache/hudi/hive/HiveSyncTool.java\n\n@@ -117,13 +117,17 @@ public class HiveSyncTool extends AbstractSyncTool {\n     boolean tableExists = hoodieHiveClient.doesTableExist(tableName);\n \n     // check if the database exists else create it\n-    if (cfg.enableCreateDatabase) {\n+    if (cfg.autoCreateDatabase) {\n       try {\n         hoodieHiveClient.updateHiveSQL(\"create database if not exists \" + cfg.databaseName);\n       } catch (Exception e) {\n         // this is harmless since table creation will fail anyways, creation of DB is needed for in-memory testing\n         LOG.warn(\"Unable to create database\", e);\n       }\n+    } else {\n+      if (!hoodieHiveClient.doesDataBaseExist(cfg.databaseName)) {\n+        throw new HoodieHiveSyncException(\"hive database does not exist\");\n+      }\n     }\n \n     // Get the parquet schema for this table looking at the latest commit\n"}}, {"oid": "cbf33682e63ce84e1b9a83689065846d4170ccc9", "url": "https://github.com/apache/hudi/commit/cbf33682e63ce84e1b9a83689065846d4170ccc9", "message": "HUDI-1192", "committedDate": "2020-08-21T06:36:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI1OTE0Nw==", "url": "https://github.com/apache/hudi/pull/1968#discussion_r480259147", "bodyText": "rename: autoCreateDatabase ?", "author": "vinothchandar", "createdAt": "2020-08-31T16:54:02Z", "path": "hudi-sync/hudi-hive-sync/src/main/java/org/apache/hudi/hive/HiveSyncConfig.java", "diffHunk": "@@ -71,6 +71,9 @@\n   @Parameter(names = {\"--use-jdbc\"}, description = \"Hive jdbc connect url\")\n   public Boolean useJdbc = true;\n \n+  @Parameter(names = {\"--enable-create-database\"}, description = \"Enable create hive database\")\n+  public Boolean enableCreateDatabase = false;", "originalCommit": "cbf33682e63ce84e1b9a83689065846d4170ccc9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI2MDAxNw==", "url": "https://github.com/apache/hudi/pull/1968#discussion_r480260017", "bodyText": "Also should the value be true by default to preserve existing behavior", "author": "vinothchandar", "createdAt": "2020-08-31T16:54:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI1OTE0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkwOTYyNA==", "url": "https://github.com/apache/hudi/pull/1968#discussion_r485909624", "bodyText": "@vinothchandar We do not let hudi create databases by default. So false seems to be ok :) @bvaradar to chime in here.", "author": "pratyakshsharma", "createdAt": "2020-09-09T20:41:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI1OTE0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkyMTk4Mg==", "url": "https://github.com/apache/hudi/pull/1968#discussion_r485921982", "bodyText": "https://lists.apache.org/thread.html/e1b7f97c774e1d7d7fc54fbb46db49aaf2e217303a50d9885150242d%40%3Cdev.hudi.apache.org%3E - this is what I am referring to. :)", "author": "pratyakshsharma", "createdAt": "2020-09-09T21:06:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI1OTE0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzkxNTk3NQ==", "url": "https://github.com/apache/hudi/pull/1968#discussion_r487915975", "bodyText": "Ok, my bad. Missed changes for creation of hive database.", "author": "pratyakshsharma", "createdAt": "2020-09-14T13:32:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI1OTE0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "1dc085721c15e064c53c73c2a66661458bf76011", "chunk": "diff --git a/hudi-sync/hudi-hive-sync/src/main/java/org/apache/hudi/hive/HiveSyncConfig.java b/hudi-sync/hudi-hive-sync/src/main/java/org/apache/hudi/hive/HiveSyncConfig.java\nindex c4953a134..c861a53b1 100644\n--- a/hudi-sync/hudi-hive-sync/src/main/java/org/apache/hudi/hive/HiveSyncConfig.java\n+++ b/hudi-sync/hudi-hive-sync/src/main/java/org/apache/hudi/hive/HiveSyncConfig.java\n\n@@ -71,8 +71,8 @@ public class HiveSyncConfig implements Serializable {\n   @Parameter(names = {\"--use-jdbc\"}, description = \"Hive jdbc connect url\")\n   public Boolean useJdbc = true;\n \n-  @Parameter(names = {\"--enable-create-database\"}, description = \"Enable create hive database\")\n-  public Boolean enableCreateDatabase = false;\n+  @Parameter(names = {\"--auto-create-database\"}, description = \"Auto create hive database\")\n+  public Boolean autoCreateDatabase = true;\n \n   @Parameter(names = {\"--skip-ro-suffix\"}, description = \"Skip the `_ro` suffix for Read optimized table, when registering\")\n   public Boolean skipROSuffix = false;\n"}}, {"oid": "1dc085721c15e064c53c73c2a66661458bf76011", "url": "https://github.com/apache/hudi/commit/1dc085721c15e064c53c73c2a66661458bf76011", "message": "HUDI-1192", "committedDate": "2020-09-14T03:29:41Z", "type": "commit"}, {"oid": "257b80a4040816c91a72a71e94315c90ec2d625c", "url": "https://github.com/apache/hudi/commit/257b80a4040816c91a72a71e94315c90ec2d625c", "message": "Merge branch 'master' into HUDI-1192\n\n# Conflicts:\n#\thudi-spark/src/main/java/org/apache/hudi/DataSourceUtils.java\n#\thudi-spark/src/main/scala/org/apache/hudi/DataSourceOptions.scala", "committedDate": "2020-09-14T03:38:30Z", "type": "commit"}, {"oid": "a41f071bc9c9165bce75cd877233ef5126d08588", "url": "https://github.com/apache/hudi/commit/a41f071bc9c9165bce75cd877233ef5126d08588", "message": "HUDI-1192", "committedDate": "2020-09-14T07:00:46Z", "type": "commit"}, {"oid": "7e9d601a48344761bd3300b802776d2feb971cde", "url": "https://github.com/apache/hudi/commit/7e9d601a48344761bd3300b802776d2feb971cde", "message": "HUDI-1192", "committedDate": "2020-09-14T08:01:59Z", "type": "commit"}, {"oid": "25e24ab3c36f17eaa95425168b94023f7962d8e1", "url": "https://github.com/apache/hudi/commit/25e24ab3c36f17eaa95425168b94023f7962d8e1", "message": "HUDI-1192", "committedDate": "2020-09-14T08:43:46Z", "type": "commit"}, {"oid": "02636454ed565aed12f1fbf9310d2f759cf40ea9", "url": "https://github.com/apache/hudi/commit/02636454ed565aed12f1fbf9310d2f759cf40ea9", "message": "HUDI-1192", "committedDate": "2020-09-14T09:05:37Z", "type": "commit"}, {"oid": "6c9deb3ac5c821b4455a64ae59481957921a2cb1", "url": "https://github.com/apache/hudi/commit/6c9deb3ac5c821b4455a64ae59481957921a2cb1", "message": "HUDI-1192", "committedDate": "2020-09-14T09:42:48Z", "type": "commit"}, {"oid": "f134be68e3c7746aaea59c4df0a198e516ea559c", "url": "https://github.com/apache/hudi/commit/f134be68e3c7746aaea59c4df0a198e516ea559c", "message": "HUDI-1192", "committedDate": "2020-09-22T02:55:09Z", "type": "commit"}, {"oid": "b613380156f77051b2f8c44b2066aabad83026e9", "url": "https://github.com/apache/hudi/commit/b613380156f77051b2f8c44b2066aabad83026e9", "message": "hudi-1192", "committedDate": "2020-09-26T06:59:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUxNTEyNw==", "url": "https://github.com/apache/hudi/pull/1968#discussion_r495515127", "bodyText": "It's an open topic. IMHO, checkDatabaseExist is a better method name. WDYT?", "author": "yanghua", "createdAt": "2020-09-27T01:49:01Z", "path": "hudi-sync/hudi-hive-sync/src/main/java/org/apache/hudi/hive/HoodieHiveClient.java", "diffHunk": "@@ -336,6 +337,22 @@ public boolean doesTableExist(String tableName) {\n     }\n   }\n \n+  /**\n+   * @param databaseName\n+   * @return  true if the configured database exists\n+   */\n+  public boolean doesDataBaseExist(String databaseName) {", "originalCommit": "b613380156f77051b2f8c44b2066aabad83026e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUxNTQ4Ng==", "url": "https://github.com/apache/hudi/pull/1968#discussion_r495515486", "bodyText": "I refer to other names in the source code that also have similar functions", "author": "liujinhui1994", "createdAt": "2020-09-27T01:54:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUxNTEyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUxNTYyNA==", "url": "https://github.com/apache/hudi/pull/1968#discussion_r495515624", "bodyText": "What do you think\uff1f if checkDatabaseExist is better, I am very willing to modify\n@yanghua", "author": "liujinhui1994", "createdAt": "2020-09-27T01:56:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUxNTEyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUzMzkzNw==", "url": "https://github.com/apache/hudi/pull/1968#discussion_r495533937", "bodyText": "What do you think\uff1f if checkDatabaseExist is better, I am very willing to modify\n@yanghua\n\nOK, keep the current name.", "author": "yanghua", "createdAt": "2020-09-27T06:07:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUxNTEyNw=="}], "type": "inlineReview", "revised_code": null}]}