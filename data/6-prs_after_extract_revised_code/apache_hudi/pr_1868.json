{"pr_number": 1868, "pr_title": "[HUDI-1083] Optimization in determining insert bucket location for a given key", "pr_createdAt": "2020-07-24T02:08:07Z", "pr_url": "https://github.com/apache/hudi/pull/1868", "timeline": [{"oid": "fda721a60bfa67d8b3729dbd0dd11e2a3cd900ca", "url": "https://github.com/apache/hudi/commit/fda721a60bfa67d8b3729dbd0dd11e2a3cd900ca", "message": "[HUDI-1083] Minor optimization in determining insert bucket location for a given key", "committedDate": "2020-07-25T23:44:46Z", "type": "forcePushed"}, {"oid": "3bddd74c390b760dc2e6e17fc88f306ac3610aed", "url": "https://github.com/apache/hudi/commit/3bddd74c390b760dc2e6e17fc88f306ac3610aed", "message": "[HUDI-1083] Optimization in determining insert bucket location for a given key", "committedDate": "2020-07-25T23:51:09Z", "type": "forcePushed"}, {"oid": "f0bb6c70e8ab7192d10bfb2adba202d0a77b3973", "url": "https://github.com/apache/hudi/commit/f0bb6c70e8ab7192d10bfb2adba202d0a77b3973", "message": "[HUDI-1083] Optimization in determining insert bucket location for a given key", "committedDate": "2020-07-26T11:01:55Z", "type": "forcePushed"}, {"oid": "73c63f1205a1d90b7f103390bb3aa180f1e4d79c", "url": "https://github.com/apache/hudi/commit/73c63f1205a1d90b7f103390bb3aa180f1e4d79c", "message": "[HUDI-1083] Optimization in determining insert bucket location for a given key", "committedDate": "2020-07-26T12:41:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDUzNDA1Nw==", "url": "https://github.com/apache/hudi/pull/1868#discussion_r460534057", "bodyText": "Somehow I don't feel comfortable adding cumulative weights to InsertBucket class. Each Insert bucket doesn't have anything to do with strict ordering wrt other buckets. UpsertPartitioner has some ordering for its own purpose.\nCan we try something like this.\npartitionPathToInsertBucketInfo : Map<String, List/Array of Pair of <Insert Bucket number, cumulative weight> >\nInsertBucketMap: Map of insert bucket number to InsertBucket object.\ngetPartition(key)\nwill first look at partitionPathToInsertBucketInfo to fetch list of cumulative weights of all insert buckets along with insert bucket nos. Once we found the target bucket number, we can look into other map.\nOr you can store InsertBucket itself in the value of partitionPathToInsertBucketInfo to avoid another look up. Tuple3<cumulativeWeight, InsetBucket>", "author": "nsivabalan", "createdAt": "2020-07-26T14:25:47Z", "path": "hudi-client/src/main/java/org/apache/hudi/table/action/commit/InsertBucket.java", "diffHunk": "@@ -18,24 +18,31 @@\n \n package org.apache.hudi.table.action.commit;\n \n+import org.jetbrains.annotations.NotNull;\n+\n import java.io.Serializable;\n \n /**\n  * Helper class for an insert bucket along with the weight [0.0, 1.0] that defines the amount of incoming inserts that\n  * should be allocated to the bucket.\n  */\n-public class InsertBucket implements Serializable {\n+public class InsertBucket implements Serializable, Comparable<InsertBucket> {\n \n   int bucketNumber;\n-  // fraction of total inserts, that should go into this bucket\n-  double weight;\n+  // cumulate fraction of total inserts, that should go into this bucket and the previous bucket.\n+  double cumulativeWeight;", "originalCommit": "73c63f1205a1d90b7f103390bb3aa180f1e4d79c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1c08902e9f7dc0caaadc36b1e2b614d927e4168d", "chunk": "diff --git a/hudi-client/src/main/java/org/apache/hudi/table/action/commit/InsertBucket.java b/hudi-client/src/main/java/org/apache/hudi/table/action/commit/InsertBucket.java\nindex d25655bf1..2cedbe865 100644\n--- a/hudi-client/src/main/java/org/apache/hudi/table/action/commit/InsertBucket.java\n+++ b/hudi-client/src/main/java/org/apache/hudi/table/action/commit/InsertBucket.java\n\n@@ -18,31 +18,24 @@\n \n package org.apache.hudi.table.action.commit;\n \n-import org.jetbrains.annotations.NotNull;\n-\n import java.io.Serializable;\n \n /**\n  * Helper class for an insert bucket along with the weight [0.0, 1.0] that defines the amount of incoming inserts that\n  * should be allocated to the bucket.\n  */\n-public class InsertBucket implements Serializable, Comparable<InsertBucket> {\n+public class InsertBucket implements Serializable {\n \n   int bucketNumber;\n-  // cumulate fraction of total inserts, that should go into this bucket and the previous bucket.\n-  double cumulativeWeight;\n+  // fraction of total inserts, that should go into this bucket\n+  double weight;\n \n   @Override\n   public String toString() {\n     final StringBuilder sb = new StringBuilder(\"InsertBucket {\");\n     sb.append(\"bucketNumber=\").append(bucketNumber).append(\", \");\n-    sb.append(\"cumulativeWeight=\").append(cumulativeWeight);\n+    sb.append(\"weight=\").append(weight);\n     sb.append('}');\n     return sb.toString();\n   }\n-\n-  @Override\n-  public int compareTo(@NotNull InsertBucket o) {\n-    return Double.compare(this.cumulativeWeight, o.cumulativeWeight);\n-  }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDUzNDI2NQ==", "url": "https://github.com/apache/hudi/pull/1868#discussion_r460534265", "bodyText": "why not Collections.binarySearch() ?", "author": "nsivabalan", "createdAt": "2020-07-26T14:27:58Z", "path": "hudi-client/src/main/java/org/apache/hudi/table/action/commit/UpsertPartitioner.java", "diffHunk": "@@ -272,21 +275,44 @@ public int getPartition(Object key) {\n       String partitionPath = keyLocation._1().getPartitionPath();\n       List<InsertBucket> targetBuckets = partitionPathToInsertBuckets.get(partitionPath);\n       // pick the target bucket to use based on the weights.\n-      double totalWeight = 0.0;\n       final long totalInserts = Math.max(1, profile.getWorkloadStat(partitionPath).getNumInserts());\n       final long hashOfKey = NumericUtils.getMessageDigestHash(\"MD5\", keyLocation._1().getRecordKey());\n       final double r = 1.0 * Math.floorMod(hashOfKey, totalInserts) / totalInserts;\n-      for (InsertBucket insertBucket : targetBuckets) {\n-        totalWeight += insertBucket.weight;\n-        if (r <= totalWeight) {\n-          return insertBucket.bucketNumber;\n-        }\n+\n+      int index = binarySearch(targetBuckets, r);", "originalCommit": "73c63f1205a1d90b7f103390bb3aa180f1e4d79c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDg0NzIwMA==", "url": "https://github.com/apache/hudi/pull/1868#discussion_r460847200", "bodyText": "Yes, it should be Collections.binarySearch().", "author": "shenh062326", "createdAt": "2020-07-27T12:15:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDUzNDI2NQ=="}], "type": "inlineReview", "revised_code": {"commit": "1c08902e9f7dc0caaadc36b1e2b614d927e4168d", "chunk": "diff --git a/hudi-client/src/main/java/org/apache/hudi/table/action/commit/UpsertPartitioner.java b/hudi-client/src/main/java/org/apache/hudi/table/action/commit/UpsertPartitioner.java\nindex 1adf53532..e113841f5 100644\n--- a/hudi-client/src/main/java/org/apache/hudi/table/action/commit/UpsertPartitioner.java\n+++ b/hudi-client/src/main/java/org/apache/hudi/table/action/commit/UpsertPartitioner.java\n\n@@ -273,46 +273,28 @@ public class UpsertPartitioner<T extends HoodieRecordPayload<T>> extends Partiti\n       return updateLocationToBucket.get(location.getFileId());\n     } else {\n       String partitionPath = keyLocation._1().getPartitionPath();\n-      List<InsertBucket> targetBuckets = partitionPathToInsertBuckets.get(partitionPath);\n+      List<Pair<InsertBucket, Double>> targetBuckets = partitionPathToInsertBucketInfos.get(partitionPath);\n       // pick the target bucket to use based on the weights.\n       final long totalInserts = Math.max(1, profile.getWorkloadStat(partitionPath).getNumInserts());\n       final long hashOfKey = NumericUtils.getMessageDigestHash(\"MD5\", keyLocation._1().getRecordKey());\n       final double r = 1.0 * Math.floorMod(hashOfKey, totalInserts) / totalInserts;\n \n-      int index = binarySearch(targetBuckets, r);\n+      Pair<InsertBucket, Double> pair = new InsertBucket2CumulativeWeight(new InsertBucket(), r);\n+\n+      int index = Collections.binarySearch(targetBuckets, pair);\n       if (index >= 0) {\n-        return targetBuckets.get(index).bucketNumber;\n+        return targetBuckets.get(index).getKey().bucketNumber;\n       }\n \n       if (-1 * index - 1 < targetBuckets.size()) {\n-        return targetBuckets.get(-1 * index - 1).bucketNumber;\n+        return targetBuckets.get(-1 * index - 1).getKey().bucketNumber;\n       }\n \n       // return first one, by default\n-      return targetBuckets.get(0).bucketNumber;\n-    }\n-  }\n-\n-  private static int binarySearch(List<InsertBucket> list, double insertWeight) {\n-    int low = 0;\n-    int high = list.size() - 1;\n-\n-    while (low <= high) {\n-      int mid = (low + high) >>> 1;\n-      InsertBucket midVal = list.get(mid);\n-\n-      if (midVal.cumulativeWeight < insertWeight) {\n-        low = mid + 1;\n-      } else if (midVal.cumulativeWeight > insertWeight) {\n-        high = mid - 1;\n-      } else {\n-        return mid; // key found\n-      }\n+      return targetBuckets.get(0).getKey().bucketNumber;\n     }\n-    return -(low + 1);  // key not found\n   }\n \n-\n   /**\n    * Obtains the average record size based on records written during previous commits. Used for estimating how many\n    * records pack into one file.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDUzNDMxNQ==", "url": "https://github.com/apache/hudi/pull/1868#discussion_r460534315", "bodyText": "sorry why do we need this? if not found, why not return the first bucket ?", "author": "nsivabalan", "createdAt": "2020-07-26T14:28:37Z", "path": "hudi-client/src/main/java/org/apache/hudi/table/action/commit/UpsertPartitioner.java", "diffHunk": "@@ -272,21 +275,44 @@ public int getPartition(Object key) {\n       String partitionPath = keyLocation._1().getPartitionPath();\n       List<InsertBucket> targetBuckets = partitionPathToInsertBuckets.get(partitionPath);\n       // pick the target bucket to use based on the weights.\n-      double totalWeight = 0.0;\n       final long totalInserts = Math.max(1, profile.getWorkloadStat(partitionPath).getNumInserts());\n       final long hashOfKey = NumericUtils.getMessageDigestHash(\"MD5\", keyLocation._1().getRecordKey());\n       final double r = 1.0 * Math.floorMod(hashOfKey, totalInserts) / totalInserts;\n-      for (InsertBucket insertBucket : targetBuckets) {\n-        totalWeight += insertBucket.weight;\n-        if (r <= totalWeight) {\n-          return insertBucket.bucketNumber;\n-        }\n+\n+      int index = binarySearch(targetBuckets, r);\n+      if (index >= 0) {\n+        return targetBuckets.get(index).bucketNumber;\n+      }\n+\n+      if (-1 * index - 1 < targetBuckets.size()) {", "originalCommit": "73c63f1205a1d90b7f103390bb3aa180f1e4d79c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDUzNDgxOQ==", "url": "https://github.com/apache/hudi/pull/1868#discussion_r460534819", "bodyText": "also, ideally we should not hit this scenario only. If our bin packing is good, cumulative weight of last entry should be 1.0.", "author": "nsivabalan", "createdAt": "2020-07-26T14:31:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDUzNDMxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk2OTc3MQ==", "url": "https://github.com/apache/hudi/pull/1868#discussion_r460969771", "bodyText": "sorry why do we need this? if not found, why not return the first bucket ?\n\nCollections.binarySearch() will return the index of the search key, if it is contained in the list;   otherwise, (-(insertion point) - 1).  The insertion point is defined as the point at which the key would be inserted into the list: the index of the first element greater than the key, or list.size() if all  elements in the list are less than the specified key.", "author": "shenh062326", "createdAt": "2020-07-27T15:20:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDUzNDMxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzU1NTQwNQ==", "url": "https://github.com/apache/hudi/pull/1868#discussion_r463555405", "bodyText": "gotcha. can we add braces. ((-1*index) -1) in both if condition and in the return statement", "author": "nsivabalan", "createdAt": "2020-07-31T11:25:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDUzNDMxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkzMjk4OQ==", "url": "https://github.com/apache/hudi/pull/1868#discussion_r463932989", "bodyText": "Sure, I will fix the comments.", "author": "shenh062326", "createdAt": "2020-08-01T07:08:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDUzNDMxNQ=="}], "type": "inlineReview", "revised_code": {"commit": "1c08902e9f7dc0caaadc36b1e2b614d927e4168d", "chunk": "diff --git a/hudi-client/src/main/java/org/apache/hudi/table/action/commit/UpsertPartitioner.java b/hudi-client/src/main/java/org/apache/hudi/table/action/commit/UpsertPartitioner.java\nindex 1adf53532..e113841f5 100644\n--- a/hudi-client/src/main/java/org/apache/hudi/table/action/commit/UpsertPartitioner.java\n+++ b/hudi-client/src/main/java/org/apache/hudi/table/action/commit/UpsertPartitioner.java\n\n@@ -273,46 +273,28 @@ public class UpsertPartitioner<T extends HoodieRecordPayload<T>> extends Partiti\n       return updateLocationToBucket.get(location.getFileId());\n     } else {\n       String partitionPath = keyLocation._1().getPartitionPath();\n-      List<InsertBucket> targetBuckets = partitionPathToInsertBuckets.get(partitionPath);\n+      List<Pair<InsertBucket, Double>> targetBuckets = partitionPathToInsertBucketInfos.get(partitionPath);\n       // pick the target bucket to use based on the weights.\n       final long totalInserts = Math.max(1, profile.getWorkloadStat(partitionPath).getNumInserts());\n       final long hashOfKey = NumericUtils.getMessageDigestHash(\"MD5\", keyLocation._1().getRecordKey());\n       final double r = 1.0 * Math.floorMod(hashOfKey, totalInserts) / totalInserts;\n \n-      int index = binarySearch(targetBuckets, r);\n+      Pair<InsertBucket, Double> pair = new InsertBucket2CumulativeWeight(new InsertBucket(), r);\n+\n+      int index = Collections.binarySearch(targetBuckets, pair);\n       if (index >= 0) {\n-        return targetBuckets.get(index).bucketNumber;\n+        return targetBuckets.get(index).getKey().bucketNumber;\n       }\n \n       if (-1 * index - 1 < targetBuckets.size()) {\n-        return targetBuckets.get(-1 * index - 1).bucketNumber;\n+        return targetBuckets.get(-1 * index - 1).getKey().bucketNumber;\n       }\n \n       // return first one, by default\n-      return targetBuckets.get(0).bucketNumber;\n-    }\n-  }\n-\n-  private static int binarySearch(List<InsertBucket> list, double insertWeight) {\n-    int low = 0;\n-    int high = list.size() - 1;\n-\n-    while (low <= high) {\n-      int mid = (low + high) >>> 1;\n-      InsertBucket midVal = list.get(mid);\n-\n-      if (midVal.cumulativeWeight < insertWeight) {\n-        low = mid + 1;\n-      } else if (midVal.cumulativeWeight > insertWeight) {\n-        high = mid - 1;\n-      } else {\n-        return mid; // key found\n-      }\n+      return targetBuckets.get(0).getKey().bucketNumber;\n     }\n-    return -(low + 1);  // key not found\n   }\n \n-\n   /**\n    * Obtains the average record size based on records written during previous commits. Used for estimating how many\n    * records pack into one file.\n"}}, {"oid": "1c08902e9f7dc0caaadc36b1e2b614d927e4168d", "url": "https://github.com/apache/hudi/commit/1c08902e9f7dc0caaadc36b1e2b614d927e4168d", "message": "[HUDI-1083] Optimization in determining insert bucket location for a given key", "committedDate": "2020-07-27T15:23:46Z", "type": "forcePushed"}, {"oid": "5120a6c6dd275d4bcd4985697774b1a1b2f0c8e4", "url": "https://github.com/apache/hudi/commit/5120a6c6dd275d4bcd4985697774b1a1b2f0c8e4", "message": "[HUDI-1083] Optimization in determining insert bucket location for a given key", "committedDate": "2020-07-27T16:00:14Z", "type": "forcePushed"}, {"oid": "66d3e808986b90275e0cbbac3f858333b02c4ebe", "url": "https://github.com/apache/hudi/commit/66d3e808986b90275e0cbbac3f858333b02c4ebe", "message": "[HUDI-1083] Optimization in determining insert bucket location for a given key", "committedDate": "2020-07-27T16:01:06Z", "type": "forcePushed"}, {"oid": "cebca40c724b4daddb07cbfb46b8e5769b93f843", "url": "https://github.com/apache/hudi/commit/cebca40c724b4daddb07cbfb46b8e5769b93f843", "message": "[HUDI-1083] Optimization in determining insert bucket location for a given key", "committedDate": "2020-07-28T01:27:27Z", "type": "forcePushed"}, {"oid": "6d46c9f569fdbd9641bea70779d6e93c1e6695f6", "url": "https://github.com/apache/hudi/commit/6d46c9f569fdbd9641bea70779d6e93c1e6695f6", "message": "[HUDI-1083] Optimization in determining insert bucket location for a given key", "committedDate": "2020-07-28T06:19:56Z", "type": "forcePushed"}, {"oid": "f3137754443e9739530f125ae99a560fa616fd54", "url": "https://github.com/apache/hudi/commit/f3137754443e9739530f125ae99a560fa616fd54", "message": "[HUDI-1083] Optimization in determining insert bucket location for a given key", "committedDate": "2020-07-28T14:35:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzU1MzA0Mg==", "url": "https://github.com/apache/hudi/pull/1868#discussion_r463553042", "bodyText": "may be InsertBucketCumulativeWeightPair", "author": "nsivabalan", "createdAt": "2020-07-31T11:18:45Z", "path": "hudi-client/src/main/java/org/apache/hudi/table/action/commit/InsertBucket2CumulativeWeight.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.table.action.commit;\n+\n+import org.apache.hudi.common.util.collection.Pair;\n+\n+public class InsertBucket2CumulativeWeight extends Pair<InsertBucket, Double> {", "originalCommit": "f3137754443e9739530f125ae99a560fa616fd54", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "24c4106e2d42f016dad9168155d4cac1c23fcd8f", "chunk": "diff --git a/hudi-client/src/main/java/org/apache/hudi/table/action/commit/InsertBucket2CumulativeWeight.java b/hudi-client/src/main/java/org/apache/hudi/table/action/commit/InsertBucketCumulativeWeightPair.java\nsimilarity index 88%\nrename from hudi-client/src/main/java/org/apache/hudi/table/action/commit/InsertBucket2CumulativeWeight.java\nrename to hudi-client/src/main/java/org/apache/hudi/table/action/commit/InsertBucketCumulativeWeightPair.java\nindex 1eb6000d4..e7ae4c6d0 100644\n--- a/hudi-client/src/main/java/org/apache/hudi/table/action/commit/InsertBucket2CumulativeWeight.java\n+++ b/hudi-client/src/main/java/org/apache/hudi/table/action/commit/InsertBucketCumulativeWeightPair.java\n\n@@ -20,11 +20,11 @@ package org.apache.hudi.table.action.commit;\n \n import org.apache.hudi.common.util.collection.Pair;\n \n-public class InsertBucket2CumulativeWeight extends Pair<InsertBucket, Double> {\n+public class InsertBucketCumulativeWeightPair extends Pair<InsertBucket, Double> {\n   InsertBucket insertBucket;\n   Double cumulativeWeight;\n \n-  public InsertBucket2CumulativeWeight(final InsertBucket insertBucket, final Double cumulativeWeight) {\n+  public InsertBucketCumulativeWeightPair(final InsertBucket insertBucket, final Double cumulativeWeight) {\n     super();\n     this.insertBucket = insertBucket;\n     this.cumulativeWeight = cumulativeWeight;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzU1MzQzNw==", "url": "https://github.com/apache/hudi/pull/1868#discussion_r463553437", "bodyText": "we might as well store InsertBucket2CumulativeWeight in this list since you have a class.", "author": "nsivabalan", "createdAt": "2020-07-31T11:19:49Z", "path": "hudi-client/src/main/java/org/apache/hudi/table/action/commit/UpsertPartitioner.java", "diffHunk": "@@ -193,15 +194,17 @@ private void assignInserts(WorkloadProfile profile, JavaSparkContext jsc) {\n         }\n \n         // Go over all such buckets, and assign weights as per amount of incoming inserts.\n-        List<InsertBucket> insertBuckets = new ArrayList<>();\n+        List<Pair<InsertBucket, Double>> insertBuckets = new ArrayList<>();", "originalCommit": "f3137754443e9739530f125ae99a560fa616fd54", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "24c4106e2d42f016dad9168155d4cac1c23fcd8f", "chunk": "diff --git a/hudi-client/src/main/java/org/apache/hudi/table/action/commit/UpsertPartitioner.java b/hudi-client/src/main/java/org/apache/hudi/table/action/commit/UpsertPartitioner.java\nindex e113841f5..86fa1bfd7 100644\n--- a/hudi-client/src/main/java/org/apache/hudi/table/action/commit/UpsertPartitioner.java\n+++ b/hudi-client/src/main/java/org/apache/hudi/table/action/commit/UpsertPartitioner.java\n\n@@ -194,14 +194,14 @@ public class UpsertPartitioner<T extends HoodieRecordPayload<T>> extends Partiti\n         }\n \n         // Go over all such buckets, and assign weights as per amount of incoming inserts.\n-        List<Pair<InsertBucket, Double>> insertBuckets = new ArrayList<>();\n+        List<InsertBucketCumulativeWeightPair> insertBuckets = new ArrayList<>();\n         double curentCumulativeWeight = 0;\n         for (int i = 0; i < bucketNumbers.size(); i++) {\n           InsertBucket bkt = new InsertBucket();\n           bkt.bucketNumber = bucketNumbers.get(i);\n           bkt.weight = (1.0 * recordsPerBucket.get(i)) / pStat.getNumInserts();\n           curentCumulativeWeight += bkt.weight;\n-          insertBuckets.add(new InsertBucket2CumulativeWeight(bkt, curentCumulativeWeight));\n+          insertBuckets.add(new InsertBucketCumulativeWeightPair(bkt, curentCumulativeWeight));\n         }\n         LOG.info(\"Total insert buckets for partition path \" + partitionPath + \" => \" + insertBuckets);\n         partitionPathToInsertBucketInfos.put(partitionPath, insertBuckets);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzU1NTg2NQ==", "url": "https://github.com/apache/hudi/pull/1868#discussion_r463555865", "bodyText": "you don't need to declare. We could directly call.\nint index = Collections.binarySearch(targetBuckets, new InsertBucket2CumulativeWeight(new InsertBucket(), r));", "author": "nsivabalan", "createdAt": "2020-07-31T11:26:26Z", "path": "hudi-client/src/main/java/org/apache/hudi/table/action/commit/UpsertPartitioner.java", "diffHunk": "@@ -270,20 +273,25 @@ public int getPartition(Object key) {\n       return updateLocationToBucket.get(location.getFileId());\n     } else {\n       String partitionPath = keyLocation._1().getPartitionPath();\n-      List<InsertBucket> targetBuckets = partitionPathToInsertBuckets.get(partitionPath);\n+      List<Pair<InsertBucket, Double>> targetBuckets = partitionPathToInsertBucketInfos.get(partitionPath);\n       // pick the target bucket to use based on the weights.\n-      double totalWeight = 0.0;\n       final long totalInserts = Math.max(1, profile.getWorkloadStat(partitionPath).getNumInserts());\n       final long hashOfKey = NumericUtils.getMessageDigestHash(\"MD5\", keyLocation._1().getRecordKey());\n       final double r = 1.0 * Math.floorMod(hashOfKey, totalInserts) / totalInserts;\n-      for (InsertBucket insertBucket : targetBuckets) {\n-        totalWeight += insertBucket.weight;\n-        if (r <= totalWeight) {\n-          return insertBucket.bucketNumber;\n-        }\n+\n+      Pair<InsertBucket, Double> pair = new InsertBucket2CumulativeWeight(new InsertBucket(), r);", "originalCommit": "f3137754443e9739530f125ae99a560fa616fd54", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "24c4106e2d42f016dad9168155d4cac1c23fcd8f", "chunk": "diff --git a/hudi-client/src/main/java/org/apache/hudi/table/action/commit/UpsertPartitioner.java b/hudi-client/src/main/java/org/apache/hudi/table/action/commit/UpsertPartitioner.java\nindex e113841f5..86fa1bfd7 100644\n--- a/hudi-client/src/main/java/org/apache/hudi/table/action/commit/UpsertPartitioner.java\n+++ b/hudi-client/src/main/java/org/apache/hudi/table/action/commit/UpsertPartitioner.java\n\n@@ -273,21 +273,20 @@ public class UpsertPartitioner<T extends HoodieRecordPayload<T>> extends Partiti\n       return updateLocationToBucket.get(location.getFileId());\n     } else {\n       String partitionPath = keyLocation._1().getPartitionPath();\n-      List<Pair<InsertBucket, Double>> targetBuckets = partitionPathToInsertBucketInfos.get(partitionPath);\n+      List<InsertBucketCumulativeWeightPair> targetBuckets = partitionPathToInsertBucketInfos.get(partitionPath);\n       // pick the target bucket to use based on the weights.\n       final long totalInserts = Math.max(1, profile.getWorkloadStat(partitionPath).getNumInserts());\n       final long hashOfKey = NumericUtils.getMessageDigestHash(\"MD5\", keyLocation._1().getRecordKey());\n       final double r = 1.0 * Math.floorMod(hashOfKey, totalInserts) / totalInserts;\n \n-      Pair<InsertBucket, Double> pair = new InsertBucket2CumulativeWeight(new InsertBucket(), r);\n+      int index = Collections.binarySearch(targetBuckets, new InsertBucketCumulativeWeightPair(new InsertBucket(), r));\n \n-      int index = Collections.binarySearch(targetBuckets, pair);\n       if (index >= 0) {\n         return targetBuckets.get(index).getKey().bucketNumber;\n       }\n \n-      if (-1 * index - 1 < targetBuckets.size()) {\n-        return targetBuckets.get(-1 * index - 1).getKey().bucketNumber;\n+      if ((-1 * index - 1) < targetBuckets.size()) {\n+        return targetBuckets.get((-1 * index - 1)).getKey().bucketNumber;\n       }\n \n       // return first one, by default\n"}}, {"oid": "24c4106e2d42f016dad9168155d4cac1c23fcd8f", "url": "https://github.com/apache/hudi/commit/24c4106e2d42f016dad9168155d4cac1c23fcd8f", "message": "[HUDI-1083] Optimization in determining insert bucket location for a given key", "committedDate": "2020-08-01T07:23:57Z", "type": "forcePushed"}, {"oid": "feb77c51617ca9dda8f08a5a2a20ea4ed764f602", "url": "https://github.com/apache/hudi/commit/feb77c51617ca9dda8f08a5a2a20ea4ed764f602", "message": "[HUDI-1083] Optimization in determining insert bucket location for a given key", "committedDate": "2020-08-01T08:49:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk3NzU5Mg==", "url": "https://github.com/apache/hudi/pull/1868#discussion_r463977592", "bodyText": "java docs as to what does cumulative weight means.", "author": "nsivabalan", "createdAt": "2020-08-01T16:25:43Z", "path": "hudi-client/src/main/java/org/apache/hudi/table/action/commit/InsertBucketCumulativeWeightPair.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.table.action.commit;\n+\n+import org.apache.hudi.common.util.collection.Pair;\n+\n+public class InsertBucketCumulativeWeightPair extends Pair<InsertBucket, Double> {", "originalCommit": "feb77c51617ca9dda8f08a5a2a20ea4ed764f602", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "44c13f3eb9e8c723a916721b20dbc2f84e65a49c", "chunk": "diff --git a/hudi-client/src/main/java/org/apache/hudi/table/action/commit/InsertBucketCumulativeWeightPair.java b/hudi-client/src/main/java/org/apache/hudi/table/action/commit/InsertBucketCumulativeWeightPair.java\nindex e7ae4c6d0..11db69a95 100644\n--- a/hudi-client/src/main/java/org/apache/hudi/table/action/commit/InsertBucketCumulativeWeightPair.java\n+++ b/hudi-client/src/main/java/org/apache/hudi/table/action/commit/InsertBucketCumulativeWeightPair.java\n\n@@ -20,6 +20,21 @@ package org.apache.hudi.table.action.commit;\n \n import org.apache.hudi.common.util.collection.Pair;\n \n+/**\n+ * Each InsertBucket has a weight, InsertBucketCumulativeWeightPair stored here is the cumulativeWeight of the\n+ * InsertBucket. If there are multiple InsertBuckets in a partition, the InsertBuckets are numbered from 1,\n+ * the cumulativeWeight of a InsertBucket is the sum of the InsertBucket weights from number 1 to its own number.\n+ *\n+ * Example, there are three InsertBucket in a partition, each bucketNumber and weight is:\n+ * 1) bucketNumber: 1, weight: 0.2\n+ * 2) bucketNumber: 2, weight: 0.3\n+ * 3) bucketNumber: 3, weight: 0.5\n+ *\n+ * Each cumulativeWeight of the bucket is:\n+ * 1) bucketNumber: 1, cumulativeWeight: 0.2\n+ * 2) bucketNumber: 2, cumulativeWeight: 0.5\n+ * 3) bucketNumber: 3, cumulativeWeight: 1.0\n+ */\n public class InsertBucketCumulativeWeightPair extends Pair<InsertBucket, Double> {\n   InsertBucket insertBucket;\n   Double cumulativeWeight;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk3NzY3Nw==", "url": "https://github.com/apache/hudi/pull/1868#discussion_r463977677", "bodyText": "did you check if this prints the value or the hash value for InsertBucketCumulativeWeightPair? if hash value, you may need to override toString for InsertBucketCumulativeWeightPair", "author": "nsivabalan", "createdAt": "2020-08-01T16:27:01Z", "path": "hudi-client/src/main/java/org/apache/hudi/table/action/commit/UpsertPartitioner.java", "diffHunk": "@@ -99,7 +100,7 @@ public UpsertPartitioner(WorkloadProfile profile, JavaSparkContext jsc, HoodieTa\n     assignInserts(profile, jsc);\n \n     LOG.info(\"Total Buckets :\" + totalBuckets + \", buckets info => \" + bucketInfoMap + \", \\n\"\n-        + \"Partition to insert buckets => \" + partitionPathToInsertBuckets + \", \\n\"\n+        + \"Partition to insert buckets => \" + partitionPathToInsertBucketInfos + \", \\n\"", "originalCommit": "feb77c51617ca9dda8f08a5a2a20ea4ed764f602", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDAxMzY2MQ==", "url": "https://github.com/apache/hudi/pull/1868#discussion_r464013661", "bodyText": "The parent class Pair has toString() method:\n  @Override\n  public String toString() {\n    return new StringBuilder().append('(').append(getLeft()).append(',').append(getRight()).append(')').toString();\n  }", "author": "shenh062326", "createdAt": "2020-08-02T00:19:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk3NzY3Nw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk3Nzg0NQ==", "url": "https://github.com/apache/hudi/pull/1868#discussion_r463977845", "bodyText": "sorry, probably I mis guided you. (should not happen) but incase the last buckets cumulative weight is not 1.0, there are chances that index value could be equal to size of collection when entry searched for is greater than all entries. Can we accommodate that as well.", "author": "nsivabalan", "createdAt": "2020-08-01T16:29:35Z", "path": "hudi-client/src/main/java/org/apache/hudi/table/action/commit/UpsertPartitioner.java", "diffHunk": "@@ -270,20 +273,24 @@ public int getPartition(Object key) {\n       return updateLocationToBucket.get(location.getFileId());\n     } else {\n       String partitionPath = keyLocation._1().getPartitionPath();\n-      List<InsertBucket> targetBuckets = partitionPathToInsertBuckets.get(partitionPath);\n+      List<InsertBucketCumulativeWeightPair> targetBuckets = partitionPathToInsertBucketInfos.get(partitionPath);\n       // pick the target bucket to use based on the weights.\n-      double totalWeight = 0.0;\n       final long totalInserts = Math.max(1, profile.getWorkloadStat(partitionPath).getNumInserts());\n       final long hashOfKey = NumericUtils.getMessageDigestHash(\"MD5\", keyLocation._1().getRecordKey());\n       final double r = 1.0 * Math.floorMod(hashOfKey, totalInserts) / totalInserts;\n-      for (InsertBucket insertBucket : targetBuckets) {\n-        totalWeight += insertBucket.weight;\n-        if (r <= totalWeight) {\n-          return insertBucket.bucketNumber;\n-        }\n+\n+      int index = Collections.binarySearch(targetBuckets, new InsertBucketCumulativeWeightPair(new InsertBucket(), r));\n+\n+      if (index >= 0) {", "originalCommit": "feb77c51617ca9dda8f08a5a2a20ea4ed764f602", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDAxNDU2Ng==", "url": "https://github.com/apache/hudi/pull/1868#discussion_r464014566", "bodyText": "The last buckets cumulative weight should be 1, and the search entry should not greater than the last entry.\nEven if the search entry greater than all entries, it will return the last bucketNumber.", "author": "shenh062326", "createdAt": "2020-08-02T00:33:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk3Nzg0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQ2ODI1Ng==", "url": "https://github.com/apache/hudi/pull/1868#discussion_r464468256", "bodyText": "From docs, I see that list.size() will be returned.\nthe index of the first element greater than the key, or list.size() if all elements in the list are less than the specified key.\n\nwhich means, it could throw ArrayIndexOutOfBounds. Let me know if I am missing something.", "author": "nsivabalan", "createdAt": "2020-08-03T14:57:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk3Nzg0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc3NTc1Mw==", "url": "https://github.com/apache/hudi/pull/1868#discussion_r464775753", "bodyText": "Below add a testcase for Collections.binarySearch.\n  @Test\n  public void test() {\n    List<Double> cumulativeWeighs = new ArrayList<>();\n    cumulativeWeighs.add(0.1);\n    cumulativeWeighs.add(0.5);\n    cumulativeWeighs.add(1.0);\n\n    assertEquals (0, Collections.binarySearch(cumulativeWeighs, 0.1));\n    assertEquals (1, Collections.binarySearch(cumulativeWeighs, 0.5));\n    assertEquals (2, Collections.binarySearch(cumulativeWeighs, 1.0));\n\n    assertEquals (-1, Collections.binarySearch(cumulativeWeighs, 0.01));\n    assertEquals (-2, Collections.binarySearch(cumulativeWeighs, 0.2));\n    assertEquals (-3, Collections.binarySearch(cumulativeWeighs, 0.6));\n    assertEquals (-4, Collections.binarySearch(cumulativeWeighs, 1.1));\n  }\n\nIf the the search key is bigger than all the elements in the list, it will return (-(insertion point) - 1)= -3 -1 = -4 .\nSo I have to add the following judge:\n      if ((-1 * index - 1) < targetBuckets.size()) {\n        return targetBuckets.get((-1 * index - 1)).getKey().bucketNumber;\n      }", "author": "shenh062326", "createdAt": "2020-08-04T03:22:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk3Nzg0NQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk3ODgxOQ==", "url": "https://github.com/apache/hudi/pull/1868#discussion_r463978819", "bodyText": "typo. weight is 0.08", "author": "nsivabalan", "createdAt": "2020-08-01T16:41:27Z", "path": "hudi-client/src/test/java/org/apache/hudi/table/action/commit/TestUpsertPartitioner.java", "diffHunk": "@@ -269,8 +267,8 @@ public void testUpsertPartitionerWithSmallInsertHandling() throws Exception {\n     assertEquals(BucketType.INSERT, partitioner.getBucketInfo(3).bucketType,\n         \"Bucket 3 is INSERT\");\n     assertEquals(4, insertBuckets.size(), \"Total of 4 insert buckets\");\n-    assertEquals(0, insertBuckets.get(0).bucketNumber, \"First insert bucket must be same as update bucket\");\n-    assertEquals(200.0 / 2400, insertBuckets.get(0).weight, 0.01, \"First insert bucket should have weight 0.5\");\n+    assertEquals(0, insertBuckets.get(0).getKey().bucketNumber, \"First insert bucket must be same as update bucket\");\n+    assertEquals(200.0 / 2400, insertBuckets.get(0).getKey().weight, 0.01, \"First insert bucket should have weight 0.5\");", "originalCommit": "feb77c51617ca9dda8f08a5a2a20ea4ed764f602", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk3ODg5OA==", "url": "https://github.com/apache/hudi/pull/1868#discussion_r463978898", "bodyText": "just curious, why not asserting every buckets weight?", "author": "nsivabalan", "createdAt": "2020-08-01T16:42:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk3ODgxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDAxNDg3Mg==", "url": "https://github.com/apache/hudi/pull/1868#discussion_r464014872", "bodyText": "Yes, it should be 0.08, the testcase is not add by me, I am also curious.", "author": "shenh062326", "createdAt": "2020-08-02T00:38:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk3ODgxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQ3MDYzNw==", "url": "https://github.com/apache/hudi/pull/1868#discussion_r464470637", "bodyText": "it is fine. Would you mind adding assertions for all buckets.", "author": "nsivabalan", "createdAt": "2020-08-03T15:00:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk3ODgxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc2ODk4NA==", "url": "https://github.com/apache/hudi/pull/1868#discussion_r464768984", "bodyText": "Sure, I will add for all buckets.", "author": "shenh062326", "createdAt": "2020-08-04T02:55:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk3ODgxOQ=="}], "type": "inlineReview", "revised_code": {"commit": "44c13f3eb9e8c723a916721b20dbc2f84e65a49c", "chunk": "diff --git a/hudi-client/src/test/java/org/apache/hudi/table/action/commit/TestUpsertPartitioner.java b/hudi-client/src/test/java/org/apache/hudi/table/action/commit/TestUpsertPartitioner.java\nindex cbca0d5ea..4b57e0824 100644\n--- a/hudi-client/src/test/java/org/apache/hudi/table/action/commit/TestUpsertPartitioner.java\n+++ b/hudi-client/src/test/java/org/apache/hudi/table/action/commit/TestUpsertPartitioner.java\n\n@@ -268,7 +268,7 @@ public class TestUpsertPartitioner extends HoodieClientTestBase {\n         \"Bucket 3 is INSERT\");\n     assertEquals(4, insertBuckets.size(), \"Total of 4 insert buckets\");\n     assertEquals(0, insertBuckets.get(0).getKey().bucketNumber, \"First insert bucket must be same as update bucket\");\n-    assertEquals(200.0 / 2400, insertBuckets.get(0).getKey().weight, 0.01, \"First insert bucket should have weight 0.5\");\n+    assertEquals(200.0 / 2400, insertBuckets.get(0).getKey().weight, 0.01, \"First insert bucket should have weight 0.8\");\n   }\n \n   private HoodieWriteConfig.Builder makeHoodieClientConfigBuilder() throws Exception {\n"}}, {"oid": "44c13f3eb9e8c723a916721b20dbc2f84e65a49c", "url": "https://github.com/apache/hudi/commit/44c13f3eb9e8c723a916721b20dbc2f84e65a49c", "message": "[HUDI-1083] Optimization in determining insert bucket location for a given key", "committedDate": "2020-08-02T00:39:24Z", "type": "forcePushed"}, {"oid": "9b28cdb8a5d4263fc37be7733e3b3578f4a24572", "url": "https://github.com/apache/hudi/commit/9b28cdb8a5d4263fc37be7733e3b3578f4a24572", "message": "[HUDI-1083] Optimization in determining insert bucket location for a given key", "committedDate": "2020-08-03T01:33:28Z", "type": "forcePushed"}, {"oid": "56ac25dac0913b2a682d9cb9e39ec7968a863f0d", "url": "https://github.com/apache/hudi/commit/56ac25dac0913b2a682d9cb9e39ec7968a863f0d", "message": "[HUDI-1083] Optimization in determining insert bucket location for a given key", "committedDate": "2020-08-04T12:17:21Z", "type": "forcePushed"}, {"oid": "556ab6370c37925d036fe700a83370e81f53db8d", "url": "https://github.com/apache/hudi/commit/556ab6370c37925d036fe700a83370e81f53db8d", "message": "[HUDI-1083] Optimization in determining insert bucket location for a given key", "committedDate": "2020-08-04T14:04:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTE1MjAwNw==", "url": "https://github.com/apache/hudi/pull/1868#discussion_r465152007", "bodyText": "lets avoid doing one at a time w/ hardcoded expected values. I mean, we should try to do in a loop. Can we build a map of <index -> ExpectedValue>. ExpectedValue should contain bucketNo, bucketType, weight, cumulativeWeight. Once we have this, these 20 lines of assertions will be folded to just 4 to 5 lines.", "author": "nsivabalan", "createdAt": "2020-08-04T15:50:06Z", "path": "hudi-client/src/test/java/org/apache/hudi/table/action/commit/TestUpsertPartitioner.java", "diffHunk": "@@ -252,8 +250,27 @@ public void testUpsertPartitionerWithSmallInsertHandling() throws Exception {\n     assertEquals(BucketType.INSERT, partitioner.getBucketInfo(2).bucketType,\n         \"Bucket 2 is INSERT\");\n     assertEquals(3, insertBuckets.size(), \"Total of 3 insert buckets\");\n-    assertEquals(0, insertBuckets.get(0).bucketNumber, \"First insert bucket must be same as update bucket\");\n-    assertEquals(0.5, insertBuckets.get(0).weight, 0.01, \"First insert bucket should have weight 0.5\");\n+\n+    assertEquals(0, insertBuckets.get(0).getKey().bucketNumber,\n+        \"First insert bucket must be same as update bucket\");", "originalCommit": "556ab6370c37925d036fe700a83370e81f53db8d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQyODgwNQ==", "url": "https://github.com/apache/hudi/pull/1868#discussion_r465428805", "bodyText": "Got it.", "author": "shenh062326", "createdAt": "2020-08-05T02:04:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTE1MjAwNw=="}], "type": "inlineReview", "revised_code": {"commit": "c878d00f0c17bc49961b287305219a0a95ff8234", "chunk": "diff --git a/hudi-client/src/test/java/org/apache/hudi/table/action/commit/TestUpsertPartitioner.java b/hudi-client/src/test/java/org/apache/hudi/table/action/commit/TestUpsertPartitioner.java\nindex 06c6d7392..104fe982e 100644\n--- a/hudi-client/src/test/java/org/apache/hudi/table/action/commit/TestUpsertPartitioner.java\n+++ b/hudi-client/src/test/java/org/apache/hudi/table/action/commit/TestUpsertPartitioner.java\n\n@@ -251,26 +264,9 @@ public class TestUpsertPartitioner extends HoodieClientTestBase {\n         \"Bucket 2 is INSERT\");\n     assertEquals(3, insertBuckets.size(), \"Total of 3 insert buckets\");\n \n-    assertEquals(0, insertBuckets.get(0).getKey().bucketNumber,\n-        \"First insert bucket must be same as update bucket\");\n-    assertEquals(0.5, insertBuckets.get(0).getKey().weight, 0.01,\n-        \"First insert bucket should have weight 0.5\");\n-    assertEquals(0.5, insertBuckets.get(0).getValue(), 0.01,\n-        \"First insert bucket should have cumulativeWeight 0.5\");\n-\n-    assertEquals(1, insertBuckets.get(1).getKey().bucketNumber,\n-        \"Second insert bucket must be same as insert bucket\");\n-    assertEquals(0.25, insertBuckets.get(1).getKey().weight, 0.01,\n-        \"Second insert bucket should have weight 0.25\");\n-    assertEquals(0.75, insertBuckets.get(1).getValue(), 0.01,\n-        \"Second insert bucket should have cumulativeWeight 0.75\");\n-\n-    assertEquals(2, insertBuckets.get(2).getKey().bucketNumber,\n-        \"Third insert bucket must be same as insert bucket\");\n-    assertEquals(0.25, insertBuckets.get(2).getKey().weight, 0.01,\n-        \"Third insert bucket should have weight 0.25\");\n-    assertEquals(1.0, insertBuckets.get(2).getValue(), 0.01,\n-        \"Third insert bucket should have cumulativeWeight 1.0\");\n+    Double[] weights = { 0.5, 0.25, 0.25};\n+    Double[] cumulativeWeight = { 0.5, 0.75, 1.0};\n+    assertInsertBuckets(weights, cumulativeWeight, insertBuckets);\n \n     // Now with insert split size auto tuned\n     partitioner = getUpsertPartitioner(1000 * 1024, 2400, 100, 800 * 1024, testPartitionPath, true);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTE1MjQzMw==", "url": "https://github.com/apache/hudi/pull/1868#discussion_r465152433", "bodyText": "same as above. Can we try to fold this up in a loop.", "author": "nsivabalan", "createdAt": "2020-08-04T15:50:46Z", "path": "hudi-client/src/test/java/org/apache/hudi/table/action/commit/TestUpsertPartitioner.java", "diffHunk": "@@ -269,8 +286,34 @@ public void testUpsertPartitionerWithSmallInsertHandling() throws Exception {\n     assertEquals(BucketType.INSERT, partitioner.getBucketInfo(3).bucketType,\n         \"Bucket 3 is INSERT\");\n     assertEquals(4, insertBuckets.size(), \"Total of 4 insert buckets\");\n-    assertEquals(0, insertBuckets.get(0).bucketNumber, \"First insert bucket must be same as update bucket\");\n-    assertEquals(200.0 / 2400, insertBuckets.get(0).weight, 0.01, \"First insert bucket should have weight 0.5\");\n+\n+    assertEquals(0, insertBuckets.get(0).getKey().bucketNumber,", "originalCommit": "556ab6370c37925d036fe700a83370e81f53db8d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c878d00f0c17bc49961b287305219a0a95ff8234", "chunk": "diff --git a/hudi-client/src/test/java/org/apache/hudi/table/action/commit/TestUpsertPartitioner.java b/hudi-client/src/test/java/org/apache/hudi/table/action/commit/TestUpsertPartitioner.java\nindex 06c6d7392..104fe982e 100644\n--- a/hudi-client/src/test/java/org/apache/hudi/table/action/commit/TestUpsertPartitioner.java\n+++ b/hudi-client/src/test/java/org/apache/hudi/table/action/commit/TestUpsertPartitioner.java\n\n@@ -287,33 +283,9 @@ public class TestUpsertPartitioner extends HoodieClientTestBase {\n         \"Bucket 3 is INSERT\");\n     assertEquals(4, insertBuckets.size(), \"Total of 4 insert buckets\");\n \n-    assertEquals(0, insertBuckets.get(0).getKey().bucketNumber,\n-        \"First insert bucket must be same as update bucket\");\n-    assertEquals(200.0 / 2400, insertBuckets.get(0).getKey().weight, 0.01,\n-        \"First insert bucket should have weight 0.08\");\n-    assertEquals(200.0 / 2400, insertBuckets.get(0).getValue(), 0.01,\n-        \"First insert bucket should have cumulativeWeight 0.08\");\n-\n-    assertEquals(1, insertBuckets.get(1).getKey().bucketNumber,\n-        \"Second insert bucket must be same as insert bucket\");\n-    assertEquals(2200.0 / 3 / 2400, insertBuckets.get(1).getKey().weight, 0.01,\n-        \"Second insert bucket should have weight 0.31\");\n-    assertEquals(0.39, insertBuckets.get(1).getValue(), 0.01,\n-        \"Second insert bucket should have cumulativeWeight 0.39\");\n-\n-    assertEquals(2, insertBuckets.get(2).getKey().bucketNumber,\n-        \"Third insert bucket must be same as insert bucket\");\n-    assertEquals(2200.0 / 3 / 2400, insertBuckets.get(2).getKey().weight, 0.01,\n-        \"Third insert bucket should have weight 0.31\");\n-    assertEquals(0.69, insertBuckets.get(2).getValue(), 0.01,\n-        \"Third insert bucket should have cumulativeWeight 0.69\");\n-\n-    assertEquals(3, insertBuckets.get(3).getKey().bucketNumber,\n-        \"Fourth insert bucket must be same as insert bucket\");\n-    assertEquals(2200.0 / 3 / 2400, insertBuckets.get(3).getKey().weight, 0.01,\n-        \"Fourth insert bucket should have weight 0.31\");\n-    assertEquals(1.0, insertBuckets.get(3).getValue(), 0.01,\n-        \"Fourth insert bucket should have cumulativeWeight 1.0\");\n+    Double[] weights1 = { 0.08, 0.31, 0.31, 0.31};\n+    Double[] cumulativeWeight1 = { 0.08, 0.39, 0.69, 1.0};\n+    assertInsertBuckets(weights1, cumulativeWeight1, insertBuckets);\n   }\n \n   private HoodieWriteConfig.Builder makeHoodieClientConfigBuilder() throws Exception {\n"}}, {"oid": "c878d00f0c17bc49961b287305219a0a95ff8234", "url": "https://github.com/apache/hudi/commit/c878d00f0c17bc49961b287305219a0a95ff8234", "message": "[HUDI-1083] Optimization in determining insert bucket location for a given key", "committedDate": "2020-08-06T01:37:18Z", "type": "forcePushed"}, {"oid": "32124abf97f87521f6514ed22186d85885b03968", "url": "https://github.com/apache/hudi/commit/32124abf97f87521f6514ed22186d85885b03968", "message": "[HUDI-1083] Optimization in determining insert bucket location for a given key", "committedDate": "2020-08-06T01:42:04Z", "type": "forcePushed"}, {"oid": "aa713efe8362aa0c682be59fbdf377ff1c7bbd74", "url": "https://github.com/apache/hudi/commit/aa713efe8362aa0c682be59fbdf377ff1c7bbd74", "message": "[HUDI-1083] Optimization in determining insert bucket location for a given key", "committedDate": "2020-08-07T01:55:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzYxNTg4Nw==", "url": "https://github.com/apache/hudi/pull/1868#discussion_r467615887", "bodyText": "Can't you reuse the same variable ?\nweights = { 0.08, 0.31, 0.31, 0.31};\ncumulativeWeights = { 0.08, 0.39, 0.69, 1.0};", "author": "nsivabalan", "createdAt": "2020-08-09T18:48:50Z", "path": "hudi-client/src/test/java/org/apache/hudi/table/action/commit/TestUpsertPartitioner.java", "diffHunk": "@@ -269,8 +282,10 @@ public void testUpsertPartitionerWithSmallInsertHandling() throws Exception {\n     assertEquals(BucketType.INSERT, partitioner.getBucketInfo(3).bucketType,\n         \"Bucket 3 is INSERT\");\n     assertEquals(4, insertBuckets.size(), \"Total of 4 insert buckets\");\n-    assertEquals(0, insertBuckets.get(0).bucketNumber, \"First insert bucket must be same as update bucket\");\n-    assertEquals(200.0 / 2400, insertBuckets.get(0).weight, 0.01, \"First insert bucket should have weight 0.5\");\n+\n+    Double[] weights1 = { 0.08, 0.31, 0.31, 0.31};", "originalCommit": "aa713efe8362aa0c682be59fbdf377ff1c7bbd74", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6bd8412968bb66edcef0947c1432a711320e66ca", "chunk": "diff --git a/hudi-client/src/test/java/org/apache/hudi/table/action/commit/TestUpsertPartitioner.java b/hudi-client/src/test/java/org/apache/hudi/table/action/commit/TestUpsertPartitioner.java\nindex ccbcec91d..03b6478fb 100644\n--- a/hudi-client/src/test/java/org/apache/hudi/table/action/commit/TestUpsertPartitioner.java\n+++ b/hudi-client/src/test/java/org/apache/hudi/table/action/commit/TestUpsertPartitioner.java\n\n@@ -283,9 +283,9 @@ public class TestUpsertPartitioner extends HoodieClientTestBase {\n         \"Bucket 3 is INSERT\");\n     assertEquals(4, insertBuckets.size(), \"Total of 4 insert buckets\");\n \n-    Double[] weights1 = { 0.08, 0.31, 0.31, 0.31};\n-    Double[] cumulativeWeights1 = { 0.08, 0.39, 0.69, 1.0};\n-    assertInsertBuckets(weights1, cumulativeWeights1, insertBuckets);\n+    weights = new Double[] { 0.08, 0.31, 0.31, 0.31};\n+    cumulativeWeights = new Double[] { 0.08, 0.39, 0.69, 1.0};\n+    assertInsertBuckets(weights, cumulativeWeights, insertBuckets);\n   }\n \n   private HoodieWriteConfig.Builder makeHoodieClientConfigBuilder() throws Exception {\n"}}, {"oid": "6bd8412968bb66edcef0947c1432a711320e66ca", "url": "https://github.com/apache/hudi/commit/6bd8412968bb66edcef0947c1432a711320e66ca", "message": "[HUDI-1083] Optimization in determining insert bucket location for a given key", "committedDate": "2020-08-10T05:20:12Z", "type": "commit"}, {"oid": "6bd8412968bb66edcef0947c1432a711320e66ca", "url": "https://github.com/apache/hudi/commit/6bd8412968bb66edcef0947c1432a711320e66ca", "message": "[HUDI-1083] Optimization in determining insert bucket location for a given key", "committedDate": "2020-08-10T05:20:12Z", "type": "forcePushed"}]}