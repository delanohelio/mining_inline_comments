{"pr_number": 774, "pr_title": "Add option for avro json encoding, issue #643", "pr_createdAt": "2020-08-19T11:08:26Z", "pr_url": "https://github.com/Apicurio/apicurio-registry/pull/774", "timeline": [{"oid": "c9c545dac88c6166a95ff44df1830a20e69411df", "url": "https://github.com/Apicurio/apicurio-registry/commit/c9c545dac88c6166a95ff44df1830a20e69411df", "message": "Add option for avro json encoding, issue #643\n\nAdd option to encode message using json encoding.\nIncludes an enum ith constants to switch according to\nthe config specified\n\nSigned-off-by: A. Garrard <GARRARD@uk.ibm.com>", "committedDate": "2020-08-19T11:04:31Z", "type": "commit"}, {"oid": "899357fa32afbe9748841891564ae585e76bd16d", "url": "https://github.com/Apicurio/apicurio-registry/commit/899357fa32afbe9748841891564ae585e76bd16d", "message": "Merge branch 'master' into master", "committedDate": "2020-08-19T12:26:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA5ODQ3Mw==", "url": "https://github.com/Apicurio/apicurio-registry/pull/774#discussion_r473098473", "bodyText": "I think it would be good to check these bytes here to ensure the data has been encoded as json. I think this test would currently still pass if the encoding was avro-binary.", "author": "ajborley", "createdAt": "2020-08-19T15:02:32Z", "path": "app/src/test/java/io/apicurio/registry/RegistrySerdeTest.java", "diffHunk": "@@ -209,6 +208,33 @@ public void testAvro(Supplier<RegistryService> supplier) throws Exception {\n         }\n     }\n \n+    @RegistryServiceTest\n+    public void testAvroJSON(Supplier<RegistryService> supplier) throws Exception {\n+        Schema schema = new Schema.Parser().parse(\"{\\\"type\\\":\\\"record\\\",\\\"name\\\":\\\"myrecord3\\\",\\\"fields\\\":[{\\\"name\\\":\\\"bar\\\",\\\"type\\\":\\\"string\\\"}]}\");\n+        try (AvroKafkaSerializer<GenericData.Record> serializer = new AvroKafkaSerializer<GenericData.Record>(supplier.get());\n+             Deserializer<GenericData.Record> deserializer = new AvroKafkaDeserializer<>(supplier.get())) {\n+            HashMap<String, String> config = new HashMap();\n+            config.put(AvroEncoding.AVRO_ENCODING, AvroEncoding.AVRO_JSON );\n+            serializer.configure(config,false);\n+            deserializer.configure(config, false);\n+            serializer.setGlobalIdStrategy(new AutoRegisterIdStrategy<>());\n+\n+            GenericData.Record record = new GenericData.Record(schema);\n+            record.put(\"bar\", \"somebar\");\n+\n+            String subject = generateArtifactId();\n+\n+            byte[] bytes = serializer.serialize(subject, record);", "originalCommit": "899357fa32afbe9748841891564ae585e76bd16d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzExNTQ1Nw==", "url": "https://github.com/Apicurio/apicurio-registry/pull/774#discussion_r473115457", "bodyText": "Agreed.", "author": "EricWittmann", "createdAt": "2020-08-19T15:25:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA5ODQ3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "a7dee196ad8df892594387af76b5b5c268ce479f", "chunk": "diff --git a/app/src/test/java/io/apicurio/registry/RegistrySerdeTest.java b/app/src/test/java/io/apicurio/registry/RegistrySerdeTest.java\nindex de4b9dcc..2c6c5ab3 100644\n--- a/app/src/test/java/io/apicurio/registry/RegistrySerdeTest.java\n+++ b/app/src/test/java/io/apicurio/registry/RegistrySerdeTest.java\n\n@@ -217,6 +219,7 @@ public class RegistrySerdeTest extends AbstractResourceTestBase {\n             config.put(AvroEncoding.AVRO_ENCODING, AvroEncoding.AVRO_JSON );\n             serializer.configure(config,false);\n             deserializer.configure(config, false);\n+\n             serializer.setGlobalIdStrategy(new AutoRegisterIdStrategy<>());\n \n             GenericData.Record record = new GenericData.Record(schema);\n"}}, {"oid": "a7dee196ad8df892594387af76b5b5c268ce479f", "url": "https://github.com/Apicurio/apicurio-registry/commit/a7dee196ad8df892594387af76b5b5c268ce479f", "message": "Add option for avro json encoding, issue #643\n\nAdd check in test that msg is encoded as json\n\nSigned-off-by: A. Garrard <GARRARD@uk.ibm.com>", "committedDate": "2020-08-19T16:03:48Z", "type": "commit"}, {"oid": "8eb80a48601737237524deffd40f3c3ef8623a11", "url": "https://github.com/Apicurio/apicurio-registry/commit/8eb80a48601737237524deffd40f3c3ef8623a11", "message": "Merge branch 'master' of https://github.com/tagarr/apicurio-registry", "committedDate": "2020-08-19T16:06:56Z", "type": "commit"}, {"oid": "cd58e25fbb7fa1eff7e3a1036d697231206f9792", "url": "https://github.com/Apicurio/apicurio-registry/commit/cd58e25fbb7fa1eff7e3a1036d697231206f9792", "message": "Add option for avro json encoding, issue #643\n\nAdd option to encode message using json encoding.\nIncludes an enum ith constants to switch according to\nthe config specified\n\nSigned-off-by: A. Garrard <GARRARD@uk.ibm.com>", "committedDate": "2020-08-19T18:21:27Z", "type": "commit"}, {"oid": "8ffd6f3633f90d77ee6f28dc7262c4944d22fdf5", "url": "https://github.com/Apicurio/apicurio-registry/commit/8ffd6f3633f90d77ee6f28dc7262c4944d22fdf5", "message": "Add option for avro json encoding, issue #643\n\nAdd check in test that msg is encoded as json\n\nSigned-off-by: A. Garrard <GARRARD@uk.ibm.com>", "committedDate": "2020-08-19T18:21:27Z", "type": "commit"}, {"oid": "5239a32ebd58265c15d6567495c94a777db688c4", "url": "https://github.com/Apicurio/apicurio-registry/commit/5239a32ebd58265c15d6567495c94a777db688c4", "message": "Merge branch 'master' of https://github.com/tagarr/apicurio-registry", "committedDate": "2020-08-19T18:31:11Z", "type": "commit"}, {"oid": "a9384781dbacf8c0aabfd6d4867f8eb0b8d58cf9", "url": "https://github.com/Apicurio/apicurio-registry/commit/a9384781dbacf8c0aabfd6d4867f8eb0b8d58cf9", "message": "Merge branch 'master' into master", "committedDate": "2020-08-19T18:55:35Z", "type": "commit"}, {"oid": "b4d0381c55ef2e28ae52d5abf4229345a8cfcad8", "url": "https://github.com/Apicurio/apicurio-registry/commit/b4d0381c55ef2e28ae52d5abf4229345a8cfcad8", "message": "Add option for avro json encoding, issue #643\n\nRemove hard coded length on array copy\n\nSigned-off-by: A. Garrard <GARRARD@uk.ibm.com>", "committedDate": "2020-08-20T10:18:28Z", "type": "commit"}, {"oid": "690d088d8570b02905d90a31951b41e0b45f22c1", "url": "https://github.com/Apicurio/apicurio-registry/commit/690d088d8570b02905d90a31951b41e0b45f22c1", "message": "Merge branch 'master' of https://github.com/tagarr/apicurio-registry", "committedDate": "2020-08-20T10:19:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzk1MDI5MQ==", "url": "https://github.com/Apicurio/apicurio-registry/pull/774#discussion_r473950291", "bodyText": "Extra space at the end ...", "author": "alesj", "createdAt": "2020-08-20T13:00:07Z", "path": "app/src/test/java/io/apicurio/registry/RegistrySerdeTest.java", "diffHunk": "@@ -209,6 +210,38 @@ public void testAvro(Supplier<RegistryService> supplier) throws Exception {\n         }\n     }\n \n+    @RegistryServiceTest\n+    public void testAvroJSON(Supplier<RegistryService> supplier) throws Exception {\n+        Schema schema = new Schema.Parser().parse(\"{\\\"type\\\":\\\"record\\\",\\\"name\\\":\\\"myrecord3\\\",\\\"fields\\\":[{\\\"name\\\":\\\"bar\\\",\\\"type\\\":\\\"string\\\"}]}\");\n+        try (AvroKafkaSerializer<GenericData.Record> serializer = new AvroKafkaSerializer<GenericData.Record>(supplier.get());\n+             Deserializer<GenericData.Record> deserializer = new AvroKafkaDeserializer<>(supplier.get())) {\n+            HashMap<String, String> config = new HashMap();\n+            config.put(AvroEncoding.AVRO_ENCODING, AvroEncoding.AVRO_JSON );", "originalCommit": "a9384781dbacf8c0aabfd6d4867f8eb0b8d58cf9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0f195851f8ac505c69b9ed69fb87a8f566c6bec1", "chunk": "diff --git a/app/src/test/java/io/apicurio/registry/RegistrySerdeTest.java b/app/src/test/java/io/apicurio/registry/RegistrySerdeTest.java\nindex 2c6c5ab3..cada5e99 100644\n--- a/app/src/test/java/io/apicurio/registry/RegistrySerdeTest.java\n+++ b/app/src/test/java/io/apicurio/registry/RegistrySerdeTest.java\n\n@@ -216,7 +216,7 @@ public class RegistrySerdeTest extends AbstractResourceTestBase {\n         try (AvroKafkaSerializer<GenericData.Record> serializer = new AvroKafkaSerializer<GenericData.Record>(supplier.get());\n              Deserializer<GenericData.Record> deserializer = new AvroKafkaDeserializer<>(supplier.get())) {\n             HashMap<String, String> config = new HashMap();\n-            config.put(AvroEncoding.AVRO_ENCODING, AvroEncoding.AVRO_JSON );\n+            config.put(AvroEncoding.AVRO_ENCODING, AvroEncoding.AVRO_JSON);\n             serializer.configure(config,false);\n             deserializer.configure(config, false);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzk1MTE4MQ==", "url": "https://github.com/Apicurio/apicurio-registry/pull/774#discussion_r473951181", "bodyText": "No need for this, it's already set to this", "author": "alesj", "createdAt": "2020-08-20T13:01:32Z", "path": "utils/serde/src/main/java/io/apicurio/registry/utils/serde/AvroEncoding.java", "diffHunk": "@@ -0,0 +1,28 @@\n+package io.apicurio.registry.utils.serde;\n+\n+import java.util.Map;\n+\n+public enum AvroEncoding {\n+\n+    BINARY,\n+    JSON;\n+\n+    public static final String AVRO_ENCODING = \"apicurio.avro.encoding\";\n+\n+    public static final String AVRO_JSON = \"JSON\";\n+\n+    public static final String AVRO_BINARY = \"BINARY\";\n+\n+    public static AvroEncoding fromConfig(Map<String, ?> config){\n+        AvroEncoding encoding = AvroEncoding.BINARY;\n+        if(config.containsKey(AVRO_ENCODING)){\n+            try {\n+                encoding = AvroEncoding.valueOf((String) config.get(AVRO_ENCODING));\n+            }\n+            catch (IllegalArgumentException ex){\n+                encoding = AvroEncoding.BINARY;", "originalCommit": "a9384781dbacf8c0aabfd6d4867f8eb0b8d58cf9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0f195851f8ac505c69b9ed69fb87a8f566c6bec1", "chunk": "diff --git a/utils/serde/src/main/java/io/apicurio/registry/utils/serde/AvroEncoding.java b/utils/serde/src/main/java/io/apicurio/registry/utils/serde/AvroEncoding.java\nindex 1f100870..0a9d8605 100644\n--- a/utils/serde/src/main/java/io/apicurio/registry/utils/serde/AvroEncoding.java\n+++ b/utils/serde/src/main/java/io/apicurio/registry/utils/serde/AvroEncoding.java\n\n@@ -20,7 +20,6 @@ public enum AvroEncoding {\n                 encoding = AvroEncoding.valueOf((String) config.get(AVRO_ENCODING));\n             }\n             catch (IllegalArgumentException ex){\n-                encoding = AvroEncoding.BINARY;\n             }\n         }\n         return encoding;\n"}}, {"oid": "0f195851f8ac505c69b9ed69fb87a8f566c6bec1", "url": "https://github.com/Apicurio/apicurio-registry/commit/0f195851f8ac505c69b9ed69fb87a8f566c6bec1", "message": "Add option for avro json encoding, issue #643\n\nMake changes according to comments\n\nSigned-off-by: A. Garrard <GARRARD@uk.ibm.com>", "committedDate": "2020-08-20T13:19:58Z", "type": "commit"}, {"oid": "42c9424d3315e298472db998fc84a4a98aee997f", "url": "https://github.com/Apicurio/apicurio-registry/commit/42c9424d3315e298472db998fc84a4a98aee997f", "message": "Add option for avro json encoding, issue #643\n\nAdd option to encode message using json encoding.\nIncludes an enum ith constants to switch according to\nthe config specified\n\nSigned-off-by: A. Garrard <GARRARD@uk.ibm.com>", "committedDate": "2020-08-20T13:28:20Z", "type": "commit"}, {"oid": "f941a0b978fb0583706484bf658cddbf059c8018", "url": "https://github.com/Apicurio/apicurio-registry/commit/f941a0b978fb0583706484bf658cddbf059c8018", "message": "Add option for avro json encoding, issue #643\n\nAdd check in test that msg is encoded as json\n\nSigned-off-by: A. Garrard <GARRARD@uk.ibm.com>", "committedDate": "2020-08-20T13:28:20Z", "type": "commit"}, {"oid": "ada4fe3752765a902119697c0be4b82244cb0340", "url": "https://github.com/Apicurio/apicurio-registry/commit/ada4fe3752765a902119697c0be4b82244cb0340", "message": "Add option for avro json encoding, issue #643\n\nAdd option to encode message using json encoding.\nIncludes an enum ith constants to switch according to\nthe config specified\n\nSigned-off-by: A. Garrard <GARRARD@uk.ibm.com>", "committedDate": "2020-08-20T13:34:31Z", "type": "commit"}, {"oid": "632e06cc2e133638bb6dc4808880cd0fbeed418b", "url": "https://github.com/Apicurio/apicurio-registry/commit/632e06cc2e133638bb6dc4808880cd0fbeed418b", "message": "Add option for avro json encoding, issue #643\n\nRemove hard coded length on array copy\n\nSigned-off-by: A. Garrard <GARRARD@uk.ibm.com>", "committedDate": "2020-08-20T13:34:31Z", "type": "commit"}, {"oid": "610791d4e7810f19273dd5147d7bc3ced412cd8a", "url": "https://github.com/Apicurio/apicurio-registry/commit/610791d4e7810f19273dd5147d7bc3ced412cd8a", "message": "Add option for avro json encoding, issue #643\n\nMake changes according to comments\n\nSigned-off-by: A. Garrard <GARRARD@uk.ibm.com>", "committedDate": "2020-08-20T13:34:31Z", "type": "commit"}, {"oid": "5228d39c61194c7f01387d0a40776e1533debac4", "url": "https://github.com/Apicurio/apicurio-registry/commit/5228d39c61194c7f01387d0a40776e1533debac4", "message": "Merge branch 'master' of https://github.com/tagarr/apicurio-registry", "committedDate": "2020-08-20T13:35:04Z", "type": "commit"}, {"oid": "e9061bc81010516964c1e9104c308d6ab5193b0e", "url": "https://github.com/Apicurio/apicurio-registry/commit/e9061bc81010516964c1e9104c308d6ab5193b0e", "message": "Merge branch 'master' into master", "committedDate": "2020-08-21T12:55:07Z", "type": "commit"}, {"oid": "de51fa71ddc5b027f68a1758ae62c020d7d644f4", "url": "https://github.com/Apicurio/apicurio-registry/commit/de51fa71ddc5b027f68a1758ae62c020d7d644f4", "message": "Merge branch 'master' into master", "committedDate": "2020-08-21T16:17:57Z", "type": "commit"}, {"oid": "f107a73fb20ea06ae3560d5495c7e1aa73721b4d", "url": "https://github.com/Apicurio/apicurio-registry/commit/f107a73fb20ea06ae3560d5495c7e1aa73721b4d", "message": "Merge branch 'master' into master", "committedDate": "2020-08-21T20:20:13Z", "type": "commit"}, {"oid": "1119fba95031bb24c96608ef8a27d92cc2aa98ad", "url": "https://github.com/Apicurio/apicurio-registry/commit/1119fba95031bb24c96608ef8a27d92cc2aa98ad", "message": "Merge branch 'master' into master", "committedDate": "2020-08-24T15:34:22Z", "type": "commit"}]}