{"pr_number": 1528, "pr_title": "SOLR-12823: remove /clusterstate.json", "pr_createdAt": "2020-05-18T22:47:33Z", "pr_url": "https://github.com/apache/lucene-solr/pull/1528", "timeline": [{"oid": "a769d663828e4767900c17f7ea00777546a150d7", "url": "https://github.com/apache/lucene-solr/commit/a769d663828e4767900c17f7ea00777546a150d7", "message": "SOLR-12823: remove /clusterstate.json\n\nRemove all code dealing with Zookeeper's /clusterstate.json, remove Collection API's MIGRATESTATEVERSION, remove legacyCloud option.\n\nNotes:\n- org.apache.solr.cloud.autoscaling.sim is non functional, requires more work.\n- TestZkChroot requires more work\n- BasicZkTest requires more work (or better: be deleted)\n\nAlso fixes SOLR-11877 DocCollection.getStateFormat is buggy", "committedDate": "2020-05-19T00:03:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU4MDAyMw==", "url": "https://github.com/apache/lucene-solr/pull/1528#discussion_r427580023", "bodyText": "Can we be more rigorous on the test here?", "author": "madrob", "createdAt": "2020-05-19T20:28:54Z", "path": "solr/core/src/java/org/apache/solr/cloud/ZkController.java", "diffHunk": "@@ -491,6 +493,40 @@ public boolean isClosed() {\n     assert ObjectReleaseTracker.track(this);\n   }\n \n+  /**\n+   * <p>Verifies if /clusterstate.json exists in Zookeepeer, and if it does and is not empty, refuses to start and outputs\n+   * a helpful message regarding collection migration.</p>\n+   *\n+   * <p>If /clusterstate.json exists and is empty, it is removed.</p>\n+   */\n+  private void checkNoOldClusterstate(final SolrZkClient zkClient) throws InterruptedException {\n+    try {\n+      if (!zkClient.exists(ZkStateReader.UNSUPPORTED_CLUSTER_STATE, true)) {\n+        return;\n+      }\n+\n+      final byte[] data = zkClient.getData(ZkStateReader.UNSUPPORTED_CLUSTER_STATE, null, null, true);\n+\n+      if (data.length < 5) {", "originalCommit": "14f7db461bc9d8663717cedd7ae08408a4a0b696", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY1NTYwMg==", "url": "https://github.com/apache/lucene-solr/pull/1528#discussion_r427655602", "bodyText": "updated.", "author": "murblanc", "createdAt": "2020-05-19T23:25:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU4MDAyMw=="}], "type": "inlineReview", "revised_code": {"commit": "03f657fe3b08903b056afc607cd602233b178577", "chunk": "diff --git a/solr/core/src/java/org/apache/solr/cloud/ZkController.java b/solr/core/src/java/org/apache/solr/cloud/ZkController.java\nindex 778bcb13fd8..972727245f1 100644\n--- a/solr/core/src/java/org/apache/solr/cloud/ZkController.java\n+++ b/solr/core/src/java/org/apache/solr/cloud/ZkController.java\n\n@@ -507,8 +508,8 @@ public class ZkController implements Closeable {\n \n       final byte[] data = zkClient.getData(ZkStateReader.UNSUPPORTED_CLUSTER_STATE, null, null, true);\n \n-      if (data.length < 5) {\n-        // less than 5 chars is empty (it's likely just \"{}\"). This log will only occur once.\n+      if (Arrays.equals(\"{}\".getBytes(StandardCharsets.UTF_8), data)) {\n+        // Empty json. This log will only occur once.\n         log.warn(\"{} no longer supported starting with Solr 9. Found empty file on Zookeeper, deleting it.\", ZkStateReader.UNSUPPORTED_CLUSTER_STATE);\n         zkClient.delete(ZkStateReader.UNSUPPORTED_CLUSTER_STATE, -1, true);\n       } else {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU4MDUyNw==", "url": "https://github.com/apache/lucene-solr/pull/1528#discussion_r427580527", "bodyText": "What are the conditions where this happens? log-and-throw is usually an anti-pattern.", "author": "madrob", "createdAt": "2020-05-19T20:29:50Z", "path": "solr/core/src/java/org/apache/solr/cloud/ZkController.java", "diffHunk": "@@ -491,6 +493,40 @@ public boolean isClosed() {\n     assert ObjectReleaseTracker.track(this);\n   }\n \n+  /**\n+   * <p>Verifies if /clusterstate.json exists in Zookeepeer, and if it does and is not empty, refuses to start and outputs\n+   * a helpful message regarding collection migration.</p>\n+   *\n+   * <p>If /clusterstate.json exists and is empty, it is removed.</p>\n+   */\n+  private void checkNoOldClusterstate(final SolrZkClient zkClient) throws InterruptedException {\n+    try {\n+      if (!zkClient.exists(ZkStateReader.UNSUPPORTED_CLUSTER_STATE, true)) {\n+        return;\n+      }\n+\n+      final byte[] data = zkClient.getData(ZkStateReader.UNSUPPORTED_CLUSTER_STATE, null, null, true);\n+\n+      if (data.length < 5) {\n+        // less than 5 chars is empty (it's likely just \"{}\"). This log will only occur once.\n+        log.warn(\"{} no longer supported starting with Solr 9. Found empty file on Zookeeper, deleting it.\", ZkStateReader.UNSUPPORTED_CLUSTER_STATE);\n+        zkClient.delete(ZkStateReader.UNSUPPORTED_CLUSTER_STATE, -1, true);\n+      } else {\n+        // /clusterstate.json not empty: refuse to start but do not automatically delete. A bit of a pain but user shouldn't\n+        // have older collections at this stage anyway.\n+        String message = ZkStateReader.UNSUPPORTED_CLUSTER_STATE + \" no longer supported starting with Solr 9. \"\n+            + \"It is present and not empty. Cannot start Solr. Please first migrate collections to stateFormat=2 using an \"\n+            + \"older version of Solr or if you don't care about the data then delete the file from \"\n+            + \"Zookeeper using a command line tool, for example: bin/solr zk rm /clusterstate.json -z host:port\";\n+        log.error(message);\n+        throw new SolrException(SolrException.ErrorCode.INVALID_STATE, message);\n+      }\n+    } catch (KeeperException e) {\n+      log.error(\"\", e);", "originalCommit": "14f7db461bc9d8663717cedd7ae08408a4a0b696", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYyNzI3Ng==", "url": "https://github.com/apache/lucene-solr/pull/1528#discussion_r427627276", "bodyText": "Converting checked to unchecked exception. copied from init() further down that deals with the same problem on access to ZK.", "author": "murblanc", "createdAt": "2020-05-19T22:04:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU4MDUyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDU5NjU0MA==", "url": "https://github.com/apache/lucene-solr/pull/1528#discussion_r430596540", "bodyText": "Makes sense. If we throw anything here it will still propagate up to SolrDispatchFilter where it will be logged, so we don't need to double up on that here. We should probably clean that up in the other places where it happens, but that's out of scope for this PR.", "author": "madrob", "createdAt": "2020-05-26T17:49:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU4MDUyNw=="}], "type": "inlineReview", "revised_code": {"commit": "03f657fe3b08903b056afc607cd602233b178577", "chunk": "diff --git a/solr/core/src/java/org/apache/solr/cloud/ZkController.java b/solr/core/src/java/org/apache/solr/cloud/ZkController.java\nindex 778bcb13fd8..972727245f1 100644\n--- a/solr/core/src/java/org/apache/solr/cloud/ZkController.java\n+++ b/solr/core/src/java/org/apache/solr/cloud/ZkController.java\n\n@@ -507,8 +508,8 @@ public class ZkController implements Closeable {\n \n       final byte[] data = zkClient.getData(ZkStateReader.UNSUPPORTED_CLUSTER_STATE, null, null, true);\n \n-      if (data.length < 5) {\n-        // less than 5 chars is empty (it's likely just \"{}\"). This log will only occur once.\n+      if (Arrays.equals(\"{}\".getBytes(StandardCharsets.UTF_8), data)) {\n+        // Empty json. This log will only occur once.\n         log.warn(\"{} no longer supported starting with Solr 9. Found empty file on Zookeeper, deleting it.\", ZkStateReader.UNSUPPORTED_CLUSTER_STATE);\n         zkClient.delete(ZkStateReader.UNSUPPORTED_CLUSTER_STATE, -1, true);\n       } else {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU4MTQ2Mw==", "url": "https://github.com/apache/lucene-solr/pull/1528#discussion_r427581463", "bodyText": "s/clusterstate/state?", "author": "madrob", "createdAt": "2020-05-19T20:31:38Z", "path": "solr/core/src/java/org/apache/solr/cloud/api/collections/CreateCollectionCmd.java", "diffHunk": "@@ -236,21 +235,19 @@ public void call(ClusterState clusterState, ZkNodeProps message, NamedList resul\n         }\n \n         String baseUrl = zkStateReader.getBaseUrlForNodeName(nodeName);\n-        //in the new mode, create the replica in clusterstate prior to creating the core.\n+        //create the replica in clusterstate (i.e. ZK) prior to creating the core.", "originalCommit": "14f7db461bc9d8663717cedd7ae08408a4a0b696", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYyNTc2Ng==", "url": "https://github.com/apache/lucene-solr/pull/1528#discussion_r427625766", "bodyText": "\"clusterstate\" is used all over (including in the docs) to refer in general to the state of the cluster or collection stored in ZK.\nWill replace with state.json here.", "author": "murblanc", "createdAt": "2020-05-19T22:01:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU4MTQ2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYyNzI0MA==", "url": "https://github.com/apache/lucene-solr/pull/1528#discussion_r427627240", "bodyText": "I think we still can use 'clusterstate' as a generic term? When I read it in a sentence like this I do not read it as the file clusterstate.json, but as the cluster state. Perhaps we could consistenly write it as \"cluster state\" instead?", "author": "janhoy", "createdAt": "2020-05-19T22:04:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU4MTQ2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYzNjQzMA==", "url": "https://github.com/apache/lucene-solr/pull/1528#discussion_r427636430", "bodyText": "Agreed, we should rename in many places. Although here state.json is appropriate since that's what happens.", "author": "murblanc", "createdAt": "2020-05-19T22:28:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU4MTQ2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "03f657fe3b08903b056afc607cd602233b178577", "chunk": "diff --git a/solr/core/src/java/org/apache/solr/cloud/api/collections/CreateCollectionCmd.java b/solr/core/src/java/org/apache/solr/cloud/api/collections/CreateCollectionCmd.java\nindex aef67eafa5b..f6ef23e8992 100644\n--- a/solr/core/src/java/org/apache/solr/cloud/api/collections/CreateCollectionCmd.java\n+++ b/solr/core/src/java/org/apache/solr/cloud/api/collections/CreateCollectionCmd.java\n\n@@ -235,7 +235,7 @@ public class CreateCollectionCmd implements OverseerCollectionMessageHandler.Cmd\n         }\n \n         String baseUrl = zkStateReader.getBaseUrlForNodeName(nodeName);\n-        //create the replica in clusterstate (i.e. ZK) prior to creating the core.\n+        // create the replica in the collection's state.json in ZK prior to creating the core.\n         // Otherwise the core creation fails\n         ZkNodeProps props = new ZkNodeProps(\n             Overseer.QUEUE_OPERATION, ADDREPLICA.toString(),\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU4MTY0OA==", "url": "https://github.com/apache/lucene-solr/pull/1528#discussion_r427581648", "bodyText": "Yay!", "author": "madrob", "createdAt": "2020-05-19T20:32:03Z", "path": "solr/core/src/java/org/apache/solr/cloud/api/collections/OverseerCollectionMessageHandler.java", "diffHunk": "@@ -468,36 +467,6 @@ void checkResults(String label, NamedList<Object> results, boolean failureIsFata\n     }\n   }\n \n-\n-  //TODO should we not remove in the next release ?\n-  private void migrateStateFormat(ClusterState state, ZkNodeProps message, NamedList results) throws Exception {", "originalCommit": "14f7db461bc9d8663717cedd7ae08408a4a0b696", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY1NTk3MA==", "url": "https://github.com/apache/lucene-solr/pull/1528#discussion_r427655970", "bodyText": "Had to remove 1,660 lines and add 568 to get rid of that comment :)", "author": "murblanc", "createdAt": "2020-05-19T23:26:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU4MTY0OA=="}], "type": "inlineReview", "revised_code": {"commit": "1732ea8a2c15a71ac89529060683a86e5fd32769", "chunk": "diff --git a/solr/core/src/java/org/apache/solr/cloud/api/collections/OverseerCollectionMessageHandler.java b/solr/core/src/java/org/apache/solr/cloud/api/collections/OverseerCollectionMessageHandler.java\nindex a136f25f810..07ce33d27be 100644\n--- a/solr/core/src/java/org/apache/solr/cloud/api/collections/OverseerCollectionMessageHandler.java\n+++ b/solr/core/src/java/org/apache/solr/cloud/api/collections/OverseerCollectionMessageHandler.java\n\n@@ -467,7 +470,8 @@ public class OverseerCollectionMessageHandler implements OverseerMessageHandler,\n     }\n   }\n \n-  void commit(NamedList results, String slice, Replica parentShardLeader) {\n+  @SuppressWarnings({\"unchecked\"})\n+  void commit(@SuppressWarnings({\"rawtypes\"})NamedList results, String slice, Replica parentShardLeader) {\n     log.debug(\"Calling soft commit to make sub shard updates visible\");\n     String coreUrl = new ZkCoreNodeProps(parentShardLeader).getCoreUrl();\n     // HttpShardHandler is hard coded to send a QueryRequest hence we go direct\n"}}, {"oid": "03f657fe3b08903b056afc607cd602233b178577", "url": "https://github.com/apache/lucene-solr/commit/03f657fe3b08903b056afc607cd602233b178577", "message": "Update comment and test for empty /clusterstate in ZK", "committedDate": "2020-05-19T22:48:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc2OTY5Mw==", "url": "https://github.com/apache/lucene-solr/pull/1528#discussion_r429769693", "bodyText": "I was thinking of the rolling upgrade scenario - if someone upgrades from 8.x to 9.0 one node at a time. Then the first node upgraded will delete /clusterstate.json. Will that cause any kind of failures or exceptions in the remaining nodes, if they have a watch on the znode or something?\nA way to mitigate it could be to let only the Overseer do the delete, and tell people to upgrade overseer last?", "author": "janhoy", "createdAt": "2020-05-25T07:18:03Z", "path": "solr/core/src/java/org/apache/solr/cloud/ZkController.java", "diffHunk": "@@ -491,6 +494,41 @@ public boolean isClosed() {\n     assert ObjectReleaseTracker.track(this);\n   }\n \n+  /**\n+   * <p>Verifies if /clusterstate.json exists in Zookeepeer, and if it does and is not empty, refuses to start and outputs\n+   * a helpful message regarding collection migration.</p>\n+   *\n+   * <p>If /clusterstate.json exists and is empty, it is removed.</p>\n+   */\n+  private void checkNoOldClusterstate(final SolrZkClient zkClient) throws InterruptedException {\n+    try {\n+      if (!zkClient.exists(ZkStateReader.UNSUPPORTED_CLUSTER_STATE, true)) {\n+        return;\n+      }\n+\n+      final byte[] data = zkClient.getData(ZkStateReader.UNSUPPORTED_CLUSTER_STATE, null, null, true);\n+\n+      if (Arrays.equals(\"{}\".getBytes(StandardCharsets.UTF_8), data)) {\n+        // Empty json. This log will only occur once.\n+        log.warn(\"{} no longer supported starting with Solr 9. Found empty file on Zookeeper, deleting it.\", ZkStateReader.UNSUPPORTED_CLUSTER_STATE);\n+        zkClient.delete(ZkStateReader.UNSUPPORTED_CLUSTER_STATE, -1, true);", "originalCommit": "c5d47bbfdd8f867a8c1006ad3b90a53c4b74844b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTgxMTcwMA==", "url": "https://github.com/apache/lucene-solr/pull/1528#discussion_r429811700", "bodyText": "I don't think that's an issue: if /clusterstate.json is non empty, no node running 9.0 will start.\nIf /clusterstate.json exists and is empty, the first starting node on 9.0 will delete it as it starts.\n8.x nodes that might start afterwards (who knows) will I believe recreate the file (that will be deleted again when a 9.0 node starts).", "author": "murblanc", "createdAt": "2020-05-25T08:45:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc2OTY5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTgyOTM1Nw==", "url": "https://github.com/apache/lucene-solr/pull/1528#discussion_r429829357", "bodyText": "Running 8.x nodes might get a callback since they have a watch. Have not checked the callback handling code, but if the code don't handle DELETE operation then either nothing happens or an exception is thrown...", "author": "janhoy", "createdAt": "2020-05-25T09:19:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc2OTY5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDAxMjA0Ng==", "url": "https://github.com/apache/lucene-solr/pull/1528#discussion_r430012046", "bodyText": "Looking at pre PR master branch.\nThe watcher on /clusterstate.json is an instance of LegacyClusterStateWatcher (subclass of ZkStateReader).\nThe watcher processing is done in refreshAndWatch() that calls ZkStateReader.refreshLegacyClusterState() and does some exception handling.\nEven though refreshAndWatch() handles KeeperException.NoNodeException by throwing a SolrException SERVICE_UNAVAILABLE, this never happens: refreshLegacyClusterState() catches that exception, a comment says \"Ignore missing legacy clusterstate.json.\" and the catch builds what would be an empty clusterstate.\nWe should be fine.", "author": "murblanc", "createdAt": "2020-05-25T16:32:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc2OTY5Mw=="}], "type": "inlineReview", "revised_code": {"commit": "add479f8cfdb23a0dc23ef0f7d93f0a15efa4666", "chunk": "diff --git a/solr/core/src/java/org/apache/solr/cloud/ZkController.java b/solr/core/src/java/org/apache/solr/cloud/ZkController.java\nindex 972727245f1..1ecb95557cc 100644\n--- a/solr/core/src/java/org/apache/solr/cloud/ZkController.java\n+++ b/solr/core/src/java/org/apache/solr/cloud/ZkController.java\n\n@@ -508,8 +507,8 @@ public class ZkController implements Closeable {\n \n       final byte[] data = zkClient.getData(ZkStateReader.UNSUPPORTED_CLUSTER_STATE, null, null, true);\n \n-      if (Arrays.equals(\"{}\".getBytes(StandardCharsets.UTF_8), data)) {\n-        // Empty json. This log will only occur once.\n+      if (data.length < 5) {\n+        // less than 5 chars is empty (it's likely just \"{}\"). This log will only occur once.\n         log.warn(\"{} no longer supported starting with Solr 9. Found empty file on Zookeeper, deleting it.\", ZkStateReader.UNSUPPORTED_CLUSTER_STATE);\n         zkClient.delete(ZkStateReader.UNSUPPORTED_CLUSTER_STATE, -1, true);\n       } else {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc3NDcxNA==", "url": "https://github.com/apache/lucene-solr/pull/1528#discussion_r429774714", "bodyText": "What happens if someone backs up a 8.5 collection with stateFormat=1 and then tries to restore in 9.0? Not very likely since that collection was probably created pre-7.0 and it would not load in 9.0 anyway. But should we simply throw an exception here if STATE_FORMAT is 1?", "author": "janhoy", "createdAt": "2020-05-25T07:29:18Z", "path": "solr/core/src/java/org/apache/solr/cloud/api/collections/RestoreCmd.java", "diffHunk": "@@ -160,9 +159,6 @@ public void call(ClusterState state, ZkNodeProps message, NamedList results) thr\n       Map<String, Object> propMap = new HashMap<>();\n       propMap.put(Overseer.QUEUE_OPERATION, CREATE.toString());\n       propMap.put(\"fromApi\", \"true\"); // mostly true.  Prevents autoCreated=true in the collection state.\n-      if (properties.get(STATE_FORMAT) == null) {", "originalCommit": "c5d47bbfdd8f867a8c1006ad3b90a53c4b74844b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTgxMjA2Nw==", "url": "https://github.com/apache/lucene-solr/pull/1528#discussion_r429812067", "bodyText": "Good point. Will update.", "author": "murblanc", "createdAt": "2020-05-25T08:45:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc3NDcxNA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc3NTE2Mw==", "url": "https://github.com/apache/lucene-solr/pull/1528#discussion_r429775163", "bodyText": "???", "author": "janhoy", "createdAt": "2020-05-25T07:30:18Z", "path": "solr/core/src/java/org/apache/solr/cloud/autoscaling/sim/SimClusterStateProvider.java", "diffHunk": "@@ -790,6 +790,33 @@ public void simRemoveReplica(String nodeId, String collection, String coreNodeNa\n   }\n \n   /**\n+<<<<<<< HEAD\n+=======\n+   * Save clusterstate.json to {@link DistribStateManager}.\n+   * @return saved state\n+   */\n+  private ClusterState saveClusterState(ClusterState state) throws IOException {\n+    ensureNotClosed();\n+\n+    // TODO: this method is emptied of its content in order to compile. We're not saving the cluster state that has to be saved collection per collection in separate state.json files.\n+    // TODO: DO NOT CHECK THIS IN. Check with AB how to update sim to stateFormat 2\n+\n+//    byte[] data = Utils.toJSON(state);\n+//    try {\n+//      VersionedData oldData = stateManager.getData(ZkStateReader.CLUSTER_STATE);\n+//      int version = oldData != null ? oldData.getVersion() : 0;\n+//      assert clusterStateVersion == version : \"local clusterStateVersion out of sync\";\n+//      stateManager.setData(ZkStateReader.CLUSTER_STATE, data, version);\n+//      log.debug(\"** saved cluster state version {}\", version);\n+//      clusterStateVersion++;\n+//    } catch (Exception e) {\n+//      throw new IOException(e);\n+//    }\n+    return state;\n+  }\n+\n+  /**\n+>>>>>>> SOLR-12823: remove /clusterstate.json", "originalCommit": "c5d47bbfdd8f867a8c1006ad3b90a53c4b74844b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTgxMzU0Ng==", "url": "https://github.com/apache/lucene-solr/pull/1528#discussion_r429813546", "bodyText": "Ouch.", "author": "murblanc", "createdAt": "2020-05-25T08:48:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc3NTE2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "97cb97674daf090b593cc0f7bdc7b74c9bc0f67a", "chunk": "diff --git a/solr/core/src/java/org/apache/solr/cloud/autoscaling/sim/SimClusterStateProvider.java b/solr/core/src/java/org/apache/solr/cloud/autoscaling/sim/SimClusterStateProvider.java\nindex 94e7908332a..0769d064180 100644\n--- a/solr/core/src/java/org/apache/solr/cloud/autoscaling/sim/SimClusterStateProvider.java\n+++ b/solr/core/src/java/org/apache/solr/cloud/autoscaling/sim/SimClusterStateProvider.java\n\n@@ -790,33 +790,6 @@ public class SimClusterStateProvider implements ClusterStateProvider {\n   }\n \n   /**\n-<<<<<<< HEAD\n-=======\n-   * Save clusterstate.json to {@link DistribStateManager}.\n-   * @return saved state\n-   */\n-  private ClusterState saveClusterState(ClusterState state) throws IOException {\n-    ensureNotClosed();\n-\n-    // TODO: this method is emptied of its content in order to compile. We're not saving the cluster state that has to be saved collection per collection in separate state.json files.\n-    // TODO: DO NOT CHECK THIS IN. Check with AB how to update sim to stateFormat 2\n-\n-//    byte[] data = Utils.toJSON(state);\n-//    try {\n-//      VersionedData oldData = stateManager.getData(ZkStateReader.CLUSTER_STATE);\n-//      int version = oldData != null ? oldData.getVersion() : 0;\n-//      assert clusterStateVersion == version : \"local clusterStateVersion out of sync\";\n-//      stateManager.setData(ZkStateReader.CLUSTER_STATE, data, version);\n-//      log.debug(\"** saved cluster state version {}\", version);\n-//      clusterStateVersion++;\n-//    } catch (Exception e) {\n-//      throw new IOException(e);\n-//    }\n-    return state;\n-  }\n-\n-  /**\n->>>>>>> SOLR-12823: remove /clusterstate.json\n    * Delay an operation by a configured amount.\n    * @param collection collection name\n    * @param op operation name.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc4MzQxNg==", "url": "https://github.com/apache/lucene-solr/pull/1528#discussion_r429783416", "bodyText": "We should have plenty of coverage elsewhere, so +1 to remove this test?", "author": "janhoy", "createdAt": "2020-05-25T07:47:53Z", "path": "solr/core/src/test/org/apache/solr/cloud/BasicZkTest.java", "diffHunk": "@@ -43,8 +44,12 @@\n   public static void beforeClass() {\n \n   }\n-  \n+\n   @Test\n+  @Ignore\n+  // This test doesn't work (anymore) following https://issues.apache.org/jira/browse/SOLR-12823", "originalCommit": "c5d47bbfdd8f867a8c1006ad3b90a53c4b74844b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "97cb97674daf090b593cc0f7bdc7b74c9bc0f67a", "chunk": "diff --git a/solr/core/src/test/org/apache/solr/cloud/BasicZkTest.java b/solr/core/src/test/org/apache/solr/cloud/BasicZkTest.java\ndeleted file mode 100644\nindex 3d12d7089b5..00000000000\n--- a/solr/core/src/test/org/apache/solr/cloud/BasicZkTest.java\n+++ /dev/null\n\n@@ -1,186 +0,0 @@\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one or more\n- * contributor license agreements.  See the NOTICE file distributed with\n- * this work for additional information regarding copyright ownership.\n- * The ASF licenses this file to You under the Apache License, Version 2.0\n- * (the \"License\"); you may not use this file except in compliance with\n- * the License.  You may obtain a copy of the License at\n- *\n- *     http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-package org.apache.solr.cloud;\n-\n-import java.util.Map;\n-\n-import com.codahale.metrics.Gauge;\n-import com.codahale.metrics.Metric;\n-import org.apache.lucene.util.LuceneTestCase.Slow;\n-import org.apache.solr.common.SolrException;\n-import org.apache.solr.common.params.CommonParams;\n-import org.apache.solr.common.params.ModifiableSolrParams;\n-import org.apache.solr.core.SolrCore;\n-import org.apache.solr.request.LocalSolrQueryRequest;\n-import org.apache.solr.request.SolrQueryRequest;\n-import org.junit.BeforeClass;\n-import org.junit.Ignore;\n-import org.junit.Test;\n-\n-/**\n- * This test is not fully functional - the port registered is illegal - \n- * so you cannot hit this with http - a nice side benefit is that it will\n- * detect if a node is trying to do an update to itself with http - it shouldn't\n- * do that.\n- */\n-@Slow\n-public class BasicZkTest extends AbstractZkTestCase {\n-  \n-  @BeforeClass\n-  public static void beforeClass() {\n-\n-  }\n-\n-  @Test\n-  @Ignore\n-  // This test doesn't work (anymore) following https://issues.apache.org/jira/browse/SOLR-12823\n-  // Should be evaluated to see if it's worth rewriting or if features are already tested by other more recent tests\n-  // Doesn't seem to be a SolrCloud test yet use of Zookeeper tricks the code into thinking it is?\n-  public void testBasic() throws Exception {\n-    \n-    // test using ZooKeeper\n-    assertTrue(\"Not using ZooKeeper\", h.getCoreContainer().isZooKeeperAware());\n-    \n-    // for the really slow/busy computer, we wait to make sure we have a leader before starting\n-    h.getCoreContainer().getZkController().getZkStateReader().getLeaderUrl(\"collection1\", \"shard1\", 30000);\n-    \n-    ZkController zkController = h.getCoreContainer().getZkController();\n-\n-    SolrCore core = h.getCore();\n-\n-    // test that we got the expected config, not just hardcoded defaults\n-    assertNotNull(core.getRequestHandler(\"/mock\"));\n-\n-    lrf.args.put(CommonParams.VERSION, \"2.2\");\n-    assertQ(\"test query on empty index\", request(\"qlkciyopsbgzyvkylsjhchghjrdf\"),\n-        \"//result[@numFound='0']\");\n-\n-    // test escaping of \";\"\n-    assertU(\"deleting 42 for no reason at all\", delI(\"42\"));\n-    assertU(\"adding doc#42\", adoc(\"id\", \"42\", \"val_s\", \"aa;bb\"));\n-    assertU(\"does commit work?\", commit());\n-\n-    assertQ(\"backslash escaping semicolon\", request(\"id:42 AND val_s:aa\\\\;bb\"),\n-        \"//*[@numFound='1']\", \"//str[@name='id'][.='42']\");\n-\n-    assertQ(\"quote escaping semicolon\", request(\"id:42 AND val_s:\\\"aa;bb\\\"\"),\n-        \"//*[@numFound='1']\", \"//str[@name='id'][.='42']\");\n-\n-    assertQ(\"no escaping semicolon\", request(\"id:42 AND val_s:aa\"),\n-        \"//*[@numFound='0']\");\n-\n-    assertU(delI(\"42\"));\n-    assertU(commit());\n-    assertQ(request(\"id:42\"), \"//*[@numFound='0']\");\n-\n-    // test overwrite default of true\n-\n-    assertU(adoc(\"id\", \"42\", \"val_s\", \"AAA\"));\n-    assertU(adoc(\"id\", \"42\", \"val_s\", \"BBB\"));\n-    assertU(commit());\n-    assertQ(request(\"id:42\"), \"//*[@numFound='1']\", \"//str[.='BBB']\");\n-    assertU(adoc(\"id\", \"42\", \"val_s\", \"CCC\"));\n-    assertU(adoc(\"id\", \"42\", \"val_s\", \"DDD\"));\n-    assertU(commit());\n-    assertQ(request(\"id:42\"), \"//*[@numFound='1']\", \"//str[.='DDD']\");\n-\n-    // test deletes\n-    String[] adds = new String[] { add(doc(\"id\", \"101\"), \"overwrite\", \"true\"),\n-        add(doc(\"id\", \"101\"), \"overwrite\", \"true\"),\n-        add(doc(\"id\", \"105\"), \"overwrite\", \"false\"),\n-        add(doc(\"id\", \"102\"), \"overwrite\", \"true\"),\n-        add(doc(\"id\", \"103\"), \"overwrite\", \"false\"),\n-        add(doc(\"id\", \"101\"), \"overwrite\", \"true\"), };\n-    for (String a : adds) {\n-      assertU(a, a);\n-    }\n-    assertU(commit());\n-    int zkPort = zkServer.getPort();\n-\n-    zkServer.shutdown();\n-\n-    // document indexing shouldn't stop immediately after a ZK disconnect\n-    assertU(adoc(\"id\", \"201\"));\n-\n-    Thread.sleep(300);\n-    \n-    // try a reconnect from disconnect\n-    zkServer = new ZkTestServer(zkDir, zkPort);\n-    zkServer.run(false);\n-    \n-    Thread.sleep(300);\n-    \n-    // ensure zk still thinks node is up\n-    assertTrue(\n-        zkController.getClusterState().getLiveNodes().toString(),\n-        zkController.getClusterState().liveNodesContain(\n-            zkController.getNodeName()));\n-\n-    // test maxint\n-    assertQ(request(\"q\", \"id:[100 TO 110]\", \"rows\", \"2147483647\"),\n-        \"//*[@numFound='4']\");\n-\n-    // test big limit\n-    assertQ(request(\"q\", \"id:[100 TO 111]\", \"rows\", \"1147483647\"),\n-        \"//*[@numFound='4']\");\n-\n-    assertQ(request(\"id:[100 TO 110]\"), \"//*[@numFound='4']\");\n-    assertU(delI(\"102\"));\n-    assertU(commit());\n-    assertQ(request(\"id:[100 TO 110]\"), \"//*[@numFound='3']\");\n-    assertU(delI(\"105\"));\n-    assertU(commit());\n-    assertQ(request(\"id:[100 TO 110]\"), \"//*[@numFound='2']\");\n-    assertU(delQ(\"id:[100 TO 110]\"));\n-    assertU(commit());\n-    assertQ(request(\"id:[100 TO 110]\"), \"//*[@numFound='0']\");\n-\n-\n-\n-    // SOLR-2651: test that reload still gets config files from zookeeper \n-    zkController.getZkClient().setData(\"/configs/conf1/solrconfig.xml\", new byte[0], true);\n- \n-    // we set the solrconfig to nothing, so this reload should fail\n-    SolrException e = expectThrows(SolrException.class,\n-        \"The reloaded SolrCore did not pick up configs from zookeeper\",\n-        () -> {\n-      ignoreException(\"solrconfig.xml\");\n-      h.getCoreContainer().reload(h.getCore().getName());\n-    });\n-    resetExceptionIgnores();\n-    assertTrue(e.getMessage().contains(\"Unable to reload core [collection1]\"));\n-    assertTrue(e.getCause().getMessage().contains(\"Error loading solr config from solrconfig.xml\"));\n-    \n-    // test stats call\n-    Map<String, Metric> metrics = h.getCore().getCoreMetricManager().getRegistry().getMetrics();\n-    assertEquals(\"collection1\", ((Gauge)metrics.get(\"CORE.coreName\")).getValue());\n-    assertEquals(\"collection1\", ((Gauge)metrics.get(\"CORE.collection\")).getValue());\n-    assertEquals(\"shard1\", ((Gauge)metrics.get(\"CORE.shard\")).getValue());\n-    assertTrue(metrics.get(\"CORE.refCount\") != null);\n-\n-    //zkController.getZkClient().printLayoutToStdOut();\n-  }\n-  \n-  public SolrQueryRequest request(String... q) {\n-    LocalSolrQueryRequest req = lrf.makeRequest(q);\n-    ModifiableSolrParams params = new ModifiableSolrParams();\n-    params.add(req.getParams());\n-    params.set(\"distrib\", false);\n-    req.setParams(params);\n-    return req;\n-  }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc4NzM4Mg==", "url": "https://github.com/apache/lucene-solr/pull/1528#discussion_r429787382", "bodyText": "Did you consider alernatives to creating a new method with same signature and 95% same code? If duplication is necessary perhaps give the new method a more descriptive name?", "author": "janhoy", "createdAt": "2020-05-25T07:55:49Z", "path": "solr/core/src/test/org/apache/solr/cloud/OverseerTest.java", "diffHunk": "@@ -181,16 +180,21 @@ public void close() {\n       zkStateReader.close();\n     }\n \n+    /**\n+     * Create a collection.\n+     * Note there's a similar but slightly different {@link OverseerTest#createCollection(String, int)}.", "originalCommit": "c5d47bbfdd8f867a8c1006ad3b90a53c4b74844b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTgxNTczOQ==", "url": "https://github.com/apache/lucene-solr/pull/1528#discussion_r429815739", "bodyText": "I hesitated. There are a few variations in how collections are created. I don't know if these variations are in purpose or end up doing the same thing and are there for historical reasons, and I tried to keep tests as identical to the way they were before as possible. IIRC the method was created where previously the code was just duplicated around, so there's some progress :), but I didn't want to change the logic of any test beyond what was strictly necessary.", "author": "murblanc", "createdAt": "2020-05-25T08:53:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc4NzM4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTgzMDQ5MQ==", "url": "https://github.com/apache/lucene-solr/pull/1528#discussion_r429830491", "bodyText": "Ok. If/when the big Overseer / Curator rewrite happens, then I guess it will be cleaned up then...", "author": "janhoy", "createdAt": "2020-05-25T09:22:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc4NzM4Mg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc5MDk3MQ==", "url": "https://github.com/apache/lucene-solr/pull/1528#discussion_r429790971", "bodyText": "Perhaps MiniSolrCloud should have a .withChroot option which can be asserted somewhere? What about deleting this test and create a separate followup JIRA \"Add zk chroot test\" which can be fixed as a followup?", "author": "janhoy", "createdAt": "2020-05-25T08:03:13Z", "path": "solr/core/src/test/org/apache/solr/cloud/TestZkChroot.java", "diffHunk": "@@ -27,8 +27,10 @@\n import org.apache.solr.core.CoreContainer;\n import org.junit.After;\n import org.junit.Before;\n+import org.junit.Ignore;\n import org.junit.Test;\n \n+// TODO: this class tries to test Zookeeper using Solr abstractions, but ZK implies the code is running in cloud mode. It doesn't work.", "originalCommit": "c5d47bbfdd8f867a8c1006ad3b90a53c4b74844b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTgxNjY5NA==", "url": "https://github.com/apache/lucene-solr/pull/1528#discussion_r429816694", "bodyText": "I agree (on the followup option).\nI tried to see if there's a way to do the chroot on the mini cluster or elsewhere but nothing obvious came after an hour or two of hacking, that's why I suggest to leave it for later.", "author": "murblanc", "createdAt": "2020-05-25T08:55:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc5MDk3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "97cb97674daf090b593cc0f7bdc7b74c9bc0f67a", "chunk": "diff --git a/solr/core/src/test/org/apache/solr/cloud/TestZkChroot.java b/solr/core/src/test/org/apache/solr/cloud/TestZkChroot.java\ndeleted file mode 100644\nindex b20f79ed4f2..00000000000\n--- a/solr/core/src/test/org/apache/solr/cloud/TestZkChroot.java\n+++ /dev/null\n\n@@ -1,171 +0,0 @@\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one or more\n- * contributor license agreements.  See the NOTICE file distributed with\n- * this work for additional information regarding copyright ownership.\n- * The ASF licenses this file to You under the Apache License, Version 2.0\n- * (the \"License\"); you may not use this file except in compliance with\n- * the License.  You may obtain a copy of the License at\n- *\n- *     http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-package org.apache.solr.cloud;\n-\n-import java.nio.file.Path;\n-import java.nio.file.Paths;\n-\n-import org.apache.solr.SolrJettyTestBase;\n-import org.apache.solr.SolrTestCaseJ4;\n-import org.apache.solr.common.cloud.SolrZkClient;\n-import org.apache.solr.common.cloud.ZkConfigManager;\n-import org.apache.solr.common.cloud.ZooKeeperException;\n-import org.apache.solr.core.CoreContainer;\n-import org.junit.After;\n-import org.junit.Before;\n-import org.junit.Ignore;\n-import org.junit.Test;\n-\n-// TODO: this class tries to test Zookeeper using Solr abstractions, but ZK implies the code is running in cloud mode. It doesn't work.\n-public class TestZkChroot extends SolrTestCaseJ4 {\n-  protected CoreContainer cores = null;\n-  private Path home;\n-  \n-  protected ZkTestServer zkServer;\n-  protected Path zkDir;\n-  \n-  @Override\n-  @Before\n-  public void setUp() throws Exception {\n-    super.setUp();\n-\n-    assumeWorkingMockito(); // precommit requires this, I don't understand.\n-\n-    zkDir = createTempDir(\"zkData\");\n-    zkServer = new ZkTestServer(zkDir);\n-    zkServer.run();\n-    home = Paths.get(SolrJettyTestBase.legacyExampleCollection1SolrHome());\n-    \n-  }\n-  \n-  @Override\n-  @After\n-  public void tearDown() throws Exception {\n-    System.clearProperty(\"zkHost\");\n-    \n-    if (cores != null) {\n-      cores.shutdown();\n-      cores = null;\n-    }\n-    \n-    if (null != zkServer) {\n-      zkServer.shutdown();\n-      zkServer = null;\n-    }\n-    zkDir = null;\n-    \n-    super.tearDown();\n-  }\n-  \n-  @Test\n-  @Ignore // See comment in testInitPathExists at the bottom\n-  public void testChrootBootstrap() throws Exception {\n-    String chroot = \"/foo/bar\";\n-    \n-    System.setProperty(\"bootstrap_conf\", \"true\");\n-    System.setProperty(\"zkHost\", zkServer.getZkHost() + chroot);\n-    SolrZkClient zkClient = null;\n-    SolrZkClient zkClient2 = null;\n-    \n-    try {\n-      cores = CoreContainer.createAndLoad(home);\n-      zkClient = cores.getZkController().getZkClient();\n-      \n-      assertTrue(zkClient.exists(\"/clusterstate.json\", true));\n-      assertFalse(zkClient.exists(chroot + \"/clusterstate.json\", true));\n-      \n-      zkClient2 = new SolrZkClient(zkServer.getZkHost(),\n-          AbstractZkTestCase.TIMEOUT);\n-      assertTrue(zkClient2.exists(chroot + \"/clusterstate.json\", true));\n-      assertFalse(zkClient2.exists(\"/clusterstate.json\", true));\n-    } finally {\n-      if (zkClient != null) zkClient.close();\n-      if (zkClient2 != null) zkClient2.close();\n-    }\n-  }\n-  \n-  @Test // This test passes but it doesn't test much...\n-  public void testNoBootstrapConf() throws Exception {\n-    String chroot = \"/foo/bar2\";\n-    \n-    System.setProperty(\"bootstrap_conf\", \"false\");\n-    System.setProperty(\"zkHost\", zkServer.getZkHost() + chroot);\n-\n-    try (SolrZkClient zkClient = new SolrZkClient(zkServer.getZkHost(), AbstractZkTestCase.TIMEOUT)) {\n-      expectThrows(ZooKeeperException.class,\n-          \"did not get a top level exception when more then 4 updates failed\",\n-          () -> {\n-        assertFalse(\"Path '\" + chroot + \"' should not exist before the test\",\n-            zkClient.exists(chroot, true));\n-        cores = CoreContainer.createAndLoad(home);\n-      });\n-      assertFalse(\"Path shouldn't have been created\",\n-          zkClient.exists(chroot, true));// check the path was not created\n-    }\n-  }\n-  \n-  @Test\n-  public void testWithUploadDir() throws Exception {\n-    String chroot = \"/foo/bar3\";\n-    String configName = \"testWithUploadDir\";\n-    \n-    System.setProperty(\"bootstrap_conf\", \"false\");\n-    System.setProperty(\"bootstrap_confdir\", home + \"/collection1/conf\");\n-    System.setProperty(\"collection.configName\", configName);\n-    System.setProperty(\"zkHost\", zkServer.getZkHost() + chroot);\n-\n-    try (SolrZkClient zkClient = new SolrZkClient(zkServer.getZkHost(), AbstractZkTestCase.TIMEOUT)) {\n-      assertFalse(\"Path '\" + chroot + \"' should not exist before the test\",\n-          zkClient.exists(chroot, true));\n-      cores = CoreContainer.createAndLoad(home);\n-      assertTrue(\n-          \"solrconfig.xml should have been uploaded to zk to the correct config directory\",\n-          zkClient.exists(chroot + ZkConfigManager.CONFIGS_ZKNODE + \"/\"\n-              + configName + \"/solrconfig.xml\", true));\n-    }\n-  }\n-  \n-  @Test\n-  @Ignore\n-  public void testInitPathExists() throws Exception {\n-    String chroot = \"/foo/bar4\";\n-    \n-    System.setProperty(\"bootstrap_conf\", \"true\");\n-    System.setProperty(\"zkHost\", zkServer.getZkHost() + chroot);\n-\n-    try (SolrZkClient zkClient = new SolrZkClient(zkServer.getZkHost(), AbstractZkTestCase.TIMEOUT)) {\n-      zkClient.makePath(\"/foo/bar4\", true);\n-      assertTrue(zkClient.exists(chroot, true));\n-      assertFalse(zkClient.exists(chroot + \"/clusterstate.json\", true));\n-\n-      // CoreContainer.createAndLoad(home) breaks: code is based on non SolrCloud assumptions, but runs SolrCloud code:\n-      // in CoreContainer.createFromDescriptor() we test zkSys.getZkController() != null which is exactly what\n-      // isZooKeeperAware() does. And isZooKeeperAware() is used to tell if we're running in standalone Solr or SolrCloud.\n-      //\n-      // We can't just create data on a node and assume SolrCloud will load it. Doesn't work that way anymore.\n-      // Need instead to properly start SolrCloud (Overseer essentially) with the given chroot, then crete a collection\n-      // for example and verify its state.json went to the correct place (by using a non chrooted zk client).\n-      //\n-      // Unfortunately the test framework + thee mockito parts of it (see OverseerTest) do not lend themselves well\n-      // to this. Testing that SolrCloud honors chroot correctly (any chroot, not only the hard coded /solr for tests)\n-      // required more work.\n-\n-      cores = CoreContainer.createAndLoad(home);\n-      assertTrue(zkClient.exists(chroot + \"/clusterstate.json\", true));\n-    }\n-  }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc5NDAwNw==", "url": "https://github.com/apache/lucene-solr/pull/1528#discussion_r429794007", "bodyText": "Remember to close SOLR-11877 after this", "author": "janhoy", "createdAt": "2020-05-25T08:09:32Z", "path": "solr/solrj/src/java/org/apache/solr/client/solrj/impl/BaseHttpClusterStateProvider.java", "diffHunk": "@@ -138,8 +138,7 @@ private ClusterState fetchClusterState(SolrClient client, String collection, Map\n     Set<String> liveNodes = new HashSet((List<String>)(cluster.get(\"live_nodes\")));\n     this.liveNodes = liveNodes;\n     liveNodesTimestamp = System.nanoTime();\n-    //TODO SOLR-11877 we don't know the znode path; CLUSTER_STATE is probably wrong leading to bad stateFormat", "originalCommit": "c5d47bbfdd8f867a8c1006ad3b90a53c4b74844b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTgxNzEzMA==", "url": "https://github.com/apache/lucene-solr/pull/1528#discussion_r429817130", "bodyText": "Yes, it's mentioned in the PR description.", "author": "murblanc", "createdAt": "2020-05-25T08:55:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc5NDAwNw=="}], "type": "inlineReview", "revised_code": {"commit": "97cb97674daf090b593cc0f7bdc7b74c9bc0f67a", "chunk": "diff --git a/solr/solrj/src/java/org/apache/solr/client/solrj/impl/BaseHttpClusterStateProvider.java b/solr/solrj/src/java/org/apache/solr/client/solrj/impl/BaseHttpClusterStateProvider.java\nindex 2e03d27d33b..8ed7854ff9b 100644\n--- a/solr/solrj/src/java/org/apache/solr/client/solrj/impl/BaseHttpClusterStateProvider.java\n+++ b/solr/solrj/src/java/org/apache/solr/client/solrj/impl/BaseHttpClusterStateProvider.java\n\n@@ -138,7 +138,7 @@ public abstract class BaseHttpClusterStateProvider implements ClusterStateProvid\n     Set<String> liveNodes = new HashSet((List<String>)(cluster.get(\"live_nodes\")));\n     this.liveNodes = liveNodes;\n     liveNodesTimestamp = System.nanoTime();\n-    ClusterState cs = ClusterState.createFromData(znodeVersion, collectionsMap, liveNodes);\n+    ClusterState cs = ClusterState.createFromCollectionMap(znodeVersion, collectionsMap, liveNodes);\n     if (clusterProperties != null) {\n       Map<String, Object> properties = (Map<String, Object>) cluster.get(\"properties\");\n       if (properties != null) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc5NTU2Mw==", "url": "https://github.com/apache/lucene-solr/pull/1528#discussion_r429795563", "bodyText": "Would createFromMap be a more descriptive name?", "author": "janhoy", "createdAt": "2020-05-25T08:12:51Z", "path": "solr/solrj/src/java/org/apache/solr/common/cloud/ClusterState.java", "diffHunk": "@@ -210,47 +200,42 @@ public boolean liveNodesContain(String name) {\n   @Override\n   public String toString() {\n     StringBuilder sb = new StringBuilder();\n-    sb.append(\"znodeVersion: \").append(znodeVersion);\n-    sb.append(\"\\n\");\n     sb.append(\"live nodes:\").append(liveNodes);\n     sb.append(\"\\n\");\n     sb.append(\"collections:\").append(collectionStates);\n     return sb.toString();\n   }\n \n-  public static ClusterState load(Integer version, byte[] bytes, Set<String> liveNodes) {\n-    return load(version, bytes, liveNodes, ZkStateReader.CLUSTER_STATE);\n-  }\n   /**\n-   * Create ClusterState from json string that is typically stored in zookeeper.\n+   * Create a ClusterState from Json.\n    * \n-   * @param version zk version of the clusterstate.json file (bytes)\n-   * @param bytes clusterstate.json as a byte array\n+   * @param bytes a byte array of a Json representation of a mapping from collection name to the Json representation of a\n+   *              {@link DocCollection} as written by {@link #write(JSONWriter)}. It can represent\n+   *              one or more collections.\n    * @param liveNodes list of live nodes\n    * @return the ClusterState\n    */\n-  public static ClusterState load(Integer version, byte[] bytes, Set<String> liveNodes, String znode) {\n-    // System.out.println(\"######## ClusterState.load:\" + (bytes==null ? null : new String(bytes)));\n+  public static ClusterState createFromJson(int version, byte[] bytes, Set<String> liveNodes) {\n     if (bytes == null || bytes.length == 0) {\n-      return new ClusterState(version, liveNodes, Collections.<String, DocCollection>emptyMap());\n+      return new ClusterState(liveNodes, Collections.<String, DocCollection>emptyMap());\n     }\n     Map<String, Object> stateMap = (Map<String, Object>) Utils.fromJSON(bytes);\n-    return load(version, stateMap, liveNodes, znode);\n+    return createFromData(version, stateMap, liveNodes);\n   }\n \n-  public static ClusterState load(Integer version, Map<String, Object> stateMap, Set<String> liveNodes, String znode) {\n+  public static ClusterState createFromData(int version, Map<String, Object> stateMap, Set<String> liveNodes) {", "originalCommit": "c5d47bbfdd8f867a8c1006ad3b90a53c4b74844b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTgxNzcyNQ==", "url": "https://github.com/apache/lucene-solr/pull/1528#discussion_r429817725", "bodyText": "As you wish, let me know and I'll change it as I rework the other comments.\ncreateFromIntMapAndSet :)", "author": "murblanc", "createdAt": "2020-05-25T08:56:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc5NTU2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTgzMTE3MQ==", "url": "https://github.com/apache/lucene-solr/pull/1528#discussion_r429831171", "bodyText": "I don't have strong feeelings, just that 'data' could be anything :)", "author": "janhoy", "createdAt": "2020-05-25T09:23:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc5NTU2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDAxMjkzMA==", "url": "https://github.com/apache/lucene-solr/pull/1528#discussion_r430012930", "bodyText": "createFromCollectionMap", "author": "murblanc", "createdAt": "2020-05-25T16:35:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc5NTU2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "97cb97674daf090b593cc0f7bdc7b74c9bc0f67a", "chunk": "diff --git a/solr/solrj/src/java/org/apache/solr/common/cloud/ClusterState.java b/solr/solrj/src/java/org/apache/solr/common/cloud/ClusterState.java\nindex 1cd0f5af676..2ac25f6201d 100644\n--- a/solr/solrj/src/java/org/apache/solr/common/cloud/ClusterState.java\n+++ b/solr/solrj/src/java/org/apache/solr/common/cloud/ClusterState.java\n\n@@ -220,10 +220,10 @@ public class ClusterState implements JSONWriter.Writable {\n       return new ClusterState(liveNodes, Collections.<String, DocCollection>emptyMap());\n     }\n     Map<String, Object> stateMap = (Map<String, Object>) Utils.fromJSON(bytes);\n-    return createFromData(version, stateMap, liveNodes);\n+    return createFromCollectionMap(version, stateMap, liveNodes);\n   }\n \n-  public static ClusterState createFromData(int version, Map<String, Object> stateMap, Set<String> liveNodes) {\n+  public static ClusterState createFromCollectionMap(int version, Map<String, Object> stateMap, Set<String> liveNodes) {\n     Map<String,CollectionRef> collections = new LinkedHashMap<>(stateMap.size());\n     for (Entry<String, Object> entry : stateMap.entrySet()) {\n       String collectionName = entry.getKey();\n"}}, {"oid": "97cb97674daf090b593cc0f7bdc7b74c9bc0f67a", "url": "https://github.com/apache/lucene-solr/commit/97cb97674daf090b593cc0f7bdc7b74c9bc0f67a", "message": "PR comments by janhoy. Deleted tests BasicZkTest and TestZkChroot", "committedDate": "2020-05-25T15:35:52Z", "type": "forcePushed"}, {"oid": "add479f8cfdb23a0dc23ef0f7d93f0a15efa4666", "url": "https://github.com/apache/lucene-solr/commit/add479f8cfdb23a0dc23ef0f7d93f0a15efa4666", "message": "SOLR-12823: remove /clusterstate.json\n\nRemove all code dealing with Zookeeper's /clusterstate.json, remove Collection API's MIGRATESTATEVERSION, remove legacyCloud option.\n\nNotes:\n- org.apache.solr.cloud.autoscaling.sim is non functional, requires more work.\n- TestZkChroot requires more work\n- BasicZkTest requires more work (or better: be deleted)\n\nAlso fixes SOLR-11877 DocCollection.getStateFormat is buggy", "committedDate": "2020-05-29T09:41:16Z", "type": "commit"}, {"oid": "7ab0d868ee642d1c3fc3ad643bc4bfd428266ab0", "url": "https://github.com/apache/lucene-solr/commit/7ab0d868ee642d1c3fc3ad643bc4bfd428266ab0", "message": "Remove Javadoc link to no longer existing symbol", "committedDate": "2020-05-29T09:41:16Z", "type": "commit"}, {"oid": "984f6d8a8c367e7eba7dbd4f65d026b88f2eb537", "url": "https://github.com/apache/lucene-solr/commit/984f6d8a8c367e7eba7dbd4f65d026b88f2eb537", "message": "removed unused import missed in rebase", "committedDate": "2020-05-29T09:41:17Z", "type": "commit"}, {"oid": "9641a49313f1276aa5d5b77c1099b81cb5396ce5", "url": "https://github.com/apache/lucene-solr/commit/9641a49313f1276aa5d5b77c1099b81cb5396ce5", "message": "Update comment and test for empty /clusterstate in ZK", "committedDate": "2020-05-29T09:41:17Z", "type": "commit"}, {"oid": "8a68dfebd2c034ffac719ab0945b5c78dcd0d675", "url": "https://github.com/apache/lucene-solr/commit/8a68dfebd2c034ffac719ab0945b5c78dcd0d675", "message": "PR comments by janhoy. Deleted tests BasicZkTest and TestZkChroot", "committedDate": "2020-05-29T09:41:17Z", "type": "commit"}, {"oid": "8a68dfebd2c034ffac719ab0945b5c78dcd0d675", "url": "https://github.com/apache/lucene-solr/commit/8a68dfebd2c034ffac719ab0945b5c78dcd0d675", "message": "PR comments by janhoy. Deleted tests BasicZkTest and TestZkChroot", "committedDate": "2020-05-29T09:41:17Z", "type": "forcePushed"}, {"oid": "de3f7464cf4f608eb1ac2eddc6aeb46fd36857ad", "url": "https://github.com/apache/lucene-solr/commit/de3f7464cf4f608eb1ac2eddc6aeb46fd36857ad", "message": "Merge branch 'master' into SOLR-12823", "committedDate": "2020-06-04T16:33:55Z", "type": "commit"}, {"oid": "1732ea8a2c15a71ac89529060683a86e5fd32769", "url": "https://github.com/apache/lucene-solr/commit/1732ea8a2c15a71ac89529060683a86e5fd32769", "message": "Merge branch 'master' into SOLR-12823", "committedDate": "2020-06-07T16:06:46Z", "type": "commit"}, {"oid": "98c9c4ae5e01d511f3e50dd671485cd2f2e08674", "url": "https://github.com/apache/lucene-solr/commit/98c9c4ae5e01d511f3e50dd671485cd2f2e08674", "message": "Update CHANGES.txt", "committedDate": "2020-06-09T18:58:29Z", "type": "commit"}]}