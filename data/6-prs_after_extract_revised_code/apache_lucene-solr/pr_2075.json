{"pr_number": 2075, "pr_title": "LUCENE-9599 Disable sort optim on index sort", "pr_createdAt": "2020-11-10T22:02:44Z", "pr_url": "https://github.com/apache/lucene-solr/pull/2075", "timeline": [{"oid": "ae33ff237f656cbed3a21f50621d9b58f862b521", "url": "https://github.com/apache/lucene-solr/commit/ae33ff237f656cbed3a21f50621d9b58f862b521", "message": "LUCENE-9599 Disable sort optim on index sort\n\nDisable sort optimization in comparators on index sort.\n\nCurrently, if search sort is equal or a part of the index sort, we have\nan early termination in TopFieldCollector.\nBut comparators are not aware of the index sort, and may run\nsort optimization even if the search sort is congruent with\nthe index sort.\n\nThis patch:\n- make leaf comparators aware that search sort is congruent\nwith the index sort.\n- disables sort optimization in comparators in this case.\n- removes a private  MultiComparatorLeafCollector class as the only\nclass that extended that class was TopFieldLeafCollector that\nnow incorporates the logic of the deleted class.\n\nRelates to #1351", "committedDate": "2020-11-10T21:54:46Z", "type": "commit"}, {"oid": "34eeba52174c3b6394630d2ddcee3c8f8d5724d0", "url": "https://github.com/apache/lucene-solr/commit/34eeba52174c3b6394630d2ddcee3c8f8d5724d0", "message": "TopFieldCollector informs FieldComparator on index sort", "committedDate": "2020-11-20T19:47:27Z", "type": "forcePushed"}, {"oid": "5aa08f51bd997050f17bbc3ef08d6c6a281ad4ac", "url": "https://github.com/apache/lucene-solr/commit/5aa08f51bd997050f17bbc3ef08d6c6a281ad4ac", "message": "TopFieldCollector informs FieldComparator on index sort", "committedDate": "2020-11-20T19:49:38Z", "type": "commit"}, {"oid": "5aa08f51bd997050f17bbc3ef08d6c6a281ad4ac", "url": "https://github.com/apache/lucene-solr/commit/5aa08f51bd997050f17bbc3ef08d6c6a281ad4ac", "message": "TopFieldCollector informs FieldComparator on index sort", "committedDate": "2020-11-20T19:49:38Z", "type": "forcePushed"}, {"oid": "ae710614d1c7fba925ad2ab6ef59dfdb1ab23508", "url": "https://github.com/apache/lucene-solr/commit/ae710614d1c7fba925ad2ab6ef59dfdb1ab23508", "message": "Rename usesIndexSort to disableSkipping", "committedDate": "2020-12-03T13:36:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI1MzI3Mw==", "url": "https://github.com/apache/lucene-solr/pull/2075#discussion_r535253273", "bodyText": "Can we avoid the cast here", "author": "jimczi", "createdAt": "2020-12-03T14:05:40Z", "path": "lucene/core/src/java/org/apache/lucene/search/TopFieldCollector.java", "diffHunk": "@@ -360,8 +352,8 @@ protected void updateMinCompetitiveScore(Scorable scorer) throws IOException {\n     if (canSetMinScore\n           && queueFull\n           && hitsThresholdChecker.isThresholdReached()) {\n-      assert bottom != null && relevanceComparator != null;\n-      float minScore = relevanceComparator.value(bottom.slot);\n+      assert bottom != null;\n+      float minScore = ((FieldComparator.RelevanceComparator) firstComparator).value(bottom.slot);", "originalCommit": "ae710614d1c7fba925ad2ab6ef59dfdb1ab23508", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c5e0362b36fe98e35d3b96aa27a5580292cf31c5", "chunk": "diff --git a/lucene/core/src/java/org/apache/lucene/search/TopFieldCollector.java b/lucene/core/src/java/org/apache/lucene/search/TopFieldCollector.java\nindex 2ea0986caef..a47c7bb253c 100644\n--- a/lucene/core/src/java/org/apache/lucene/search/TopFieldCollector.java\n+++ b/lucene/core/src/java/org/apache/lucene/search/TopFieldCollector.java\n\n@@ -353,7 +353,7 @@ public abstract class TopFieldCollector extends TopDocsCollector<Entry> {\n           && queueFull\n           && hitsThresholdChecker.isThresholdReached()) {\n       assert bottom != null;\n-      float minScore = ((FieldComparator.RelevanceComparator) firstComparator).value(bottom.slot);\n+      float minScore = (float) firstComparator.value(bottom.slot);\n       if (minScore > minCompetitiveScore) {\n         scorer.setMinCompetitiveScore(minScore);\n         minCompetitiveScore = minScore;\n"}}, {"oid": "c5e0362b36fe98e35d3b96aa27a5580292cf31c5", "url": "https://github.com/apache/lucene-solr/commit/c5e0362b36fe98e35d3b96aa27a5580292cf31c5", "message": "Avoid cast", "committedDate": "2020-12-03T15:14:24Z", "type": "commit"}]}