{"pr_number": 1932, "pr_title": "Reuse crypto keys in reference impl", "pr_createdAt": "2020-09-30T02:37:12Z", "pr_url": "https://github.com/apache/lucene-solr/pull/1932", "timeline": [{"oid": "a94f02d46caaa50d1da50199cf5ac123be94b815", "url": "https://github.com/apache/lucene-solr/commit/a94f02d46caaa50d1da50199cf5ac123be94b815", "message": "Reuse key pair instead of disabling PublicKeyHandler", "committedDate": "2020-09-30T02:35:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzcxOTUyNQ==", "url": "https://github.com/apache/lucene-solr/pull/1932#discussion_r497719525", "bodyText": "Why not use the key-pair that's already on disk? See https://github.com/apache/lucene-solr/blob/master/solr/test-framework/src/java/org/apache/solr/SolrTestCaseJ4.java#L289-L290", "author": "madrob", "createdAt": "2020-09-30T18:34:24Z", "path": "solr/test-framework/src/java/org/apache/solr/SolrTestCase.java", "diffHunk": "@@ -124,6 +126,17 @@\n \n   protected volatile static PerThreadExecService testExecutor;\n \n+  private static final CryptoKeys.RSAKeyPair reusedKeys = new CryptoKeys.RSAKeyPair();", "originalCommit": "a94f02d46caaa50d1da50199cf5ac123be94b815", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8566f28e53cfe637880f0827e8038aaa540c18e1", "chunk": "diff --git a/solr/test-framework/src/java/org/apache/solr/SolrTestCase.java b/solr/test-framework/src/java/org/apache/solr/SolrTestCase.java\nindex 77b673b476c..c1a83e5089a 100644\n--- a/solr/test-framework/src/java/org/apache/solr/SolrTestCase.java\n+++ b/solr/test-framework/src/java/org/apache/solr/SolrTestCase.java\n\n@@ -126,7 +129,23 @@ public class SolrTestCase extends LuceneTestCase {\n \n   protected volatile static PerThreadExecService testExecutor;\n \n-  private static final CryptoKeys.RSAKeyPair reusedKeys = new CryptoKeys.RSAKeyPair();\n+  private static final CryptoKeys.RSAKeyPair reusedKeys = getRsaKeyPair();\n+\n+  private static CryptoKeys.RSAKeyPair getRsaKeyPair() {\n+    String publicKey = System.getProperty(\"pkiHandlerPublicKeyPath\");\n+    String privateKey = System.getProperty(\"pkiHandlerPrivateKeyPath\");\n+    // If both properties unset, then we fall back to generating a new key pair\n+    if (StringUtils.isEmpty(publicKey) && StringUtils.isEmpty(privateKey)) {\n+      return new CryptoKeys.RSAKeyPair();\n+    }\n+\n+    try {\n+      return new CryptoKeys.RSAKeyPair(new URL(privateKey), new URL(publicKey));\n+    } catch (Exception e) {\n+      log.error(\"Error in pblic key/private key URLs\", e);\n+    }\n+    return new CryptoKeys.RSAKeyPair();\n+  }\n \n   public static void enableReuseOfCryptoKeys() {\n     PublicKeyHandler.REUSABLE_KEYPAIR = reusedKeys;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgyNzAxMg==", "url": "https://github.com/apache/lucene-solr/pull/1932#discussion_r497827012", "bodyText": "Looks like I had this reversed. We should likely enable reuse below in the non Nightly run and disable for the closer to prod Nightly run.", "author": "markrmiller", "createdAt": "2020-09-30T22:04:02Z", "path": "solr/test-framework/src/java/org/apache/solr/SolrTestCase.java", "diffHunk": "@@ -225,7 +238,7 @@ public static void setDefaultConfigDirSysPropIfNotSet() throws Exception {\n     System.setProperty(\"solr.clustering.enabled\", \"false\");\n     System.setProperty(\"solr.peerSync.useRangeVersions\", String.valueOf(random().nextBoolean()));\n     System.setProperty(\"zookeeper.nio.directBufferBytes\", Integer.toString(32 * 1024 * 2));\n-    System.setProperty(\"solr.disablePublicKeyHandler\", \"true\");\n+    enableReuseOfCryptoKeys();", "originalCommit": "a94f02d46caaa50d1da50199cf5ac123be94b815", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgyNzg2MQ==", "url": "https://github.com/apache/lucene-solr/pull/1932#discussion_r497827861", "bodyText": "Let's enable reuse here instead.", "author": "markrmiller", "createdAt": "2020-09-30T22:06:07Z", "path": "solr/test-framework/src/java/org/apache/solr/SolrTestCase.java", "diffHunk": "@@ -225,7 +238,7 @@ public static void setDefaultConfigDirSysPropIfNotSet() throws Exception {\n     System.setProperty(\"solr.clustering.enabled\", \"false\");\n     System.setProperty(\"solr.peerSync.useRangeVersions\", String.valueOf(random().nextBoolean()));\n     System.setProperty(\"zookeeper.nio.directBufferBytes\", Integer.toString(32 * 1024 * 2));\n-    System.setProperty(\"solr.disablePublicKeyHandler\", \"true\");\n+    enableReuseOfCryptoKeys();\n \n     if (!TEST_NIGHTLY) {", "originalCommit": "a94f02d46caaa50d1da50199cf5ac123be94b815", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "8566f28e53cfe637880f0827e8038aaa540c18e1", "url": "https://github.com/apache/lucene-solr/commit/8566f28e53cfe637880f0827e8038aaa540c18e1", "message": "read from provided public/private keys in tests", "committedDate": "2020-10-09T04:08:35Z", "type": "commit"}]}