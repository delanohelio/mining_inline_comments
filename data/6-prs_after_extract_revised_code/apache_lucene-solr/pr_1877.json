{"pr_number": 1877, "pr_title": "SOLR-13181: param macro expansion could throw", "pr_createdAt": "2020-09-16T06:25:35Z", "pr_url": "https://github.com/apache/lucene-solr/pull/1877", "timeline": [{"oid": "7312cef7fdd269c863dfec36d4916a368597148b", "url": "https://github.com/apache/lucene-solr/commit/7312cef7fdd269c863dfec36d4916a368597148b", "message": "SOLR-13181: param macro expansion could throw\nStringIndexOutOfBoundsException on bad syntax", "committedDate": "2020-09-16T06:21:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQ2NTIwOA==", "url": "https://github.com/apache/lucene-solr/pull/1877#discussion_r489465208", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  int matchedStart = idx;\n          \n          \n            \n                  final int matchedStart = idx;", "author": "cpoerschke", "createdAt": "2020-09-16T14:06:20Z", "path": "solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java", "diffHunk": "@@ -136,11 +136,12 @@ private String _expand(String val) {\n       }\n       else if (idx < 0) {\n         if (sb == null) return val;\n-        sb.append(val.substring(start));\n+        sb.append(val, start, val.length());\n         return sb.toString();\n       }\n \n       // found unescaped \"${\"\n+      int matchedStart = idx;", "originalCommit": "7312cef7fdd269c863dfec36d4916a368597148b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "68083e1d5a54d44521417887553610f689dff9f1", "chunk": "diff --git a/solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java b/solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java\nindex 75855868514..2dc9f26d866 100644\n--- a/solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java\n+++ b/solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java\n\n@@ -141,7 +141,7 @@ public class MacroExpander {\n       }\n \n       // found unescaped \"${\"\n-      int matchedStart = idx;\n+      final int matchedStart = idx;\n       idx += macroStart.length();\n \n       int rbrace = val.indexOf('}', idx);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQ2NTc3OA==", "url": "https://github.com/apache/lucene-solr/pull/1877#discussion_r489465778", "bodyText": "How about removing rather than amending the // String inbetween = val.substring(idx, rbrace); commented out code line?", "author": "cpoerschke", "createdAt": "2020-09-16T14:07:05Z", "path": "solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java", "diffHunk": "@@ -154,14 +155,14 @@ else if (idx < 0) {\n       }\n \n       if (matchedStart > 0) {\n-        sb.append(val.substring(start, matchedStart));\n+        sb.append(val, start, matchedStart);\n       }\n \n       // update \"start\" to be at the end of ${...}\n-      start = rbrace + 1;\n+      idx = start = rbrace + 1;\n \n-      // String inbetween = val.substring(idx, rbrace);\n-      StrParser parser = new StrParser(val, idx, rbrace);\n+      // String in-between = val.substring(idx, rbrace);", "originalCommit": "7312cef7fdd269c863dfec36d4916a368597148b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9e6dd9d31bdc662ae39c592e8a59bfeb7edc95d0", "chunk": "diff --git a/solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java b/solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java\nindex 75855868514..97673f2fd62 100644\n--- a/solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java\n+++ b/solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java\n\n@@ -161,7 +160,7 @@ public class MacroExpander {\n       // update \"start\" to be at the end of ${...}\n       idx = start = rbrace + 1;\n \n-      // String in-between = val.substring(idx, rbrace);\n+      // String in-between braces\n       StrParser parser = new StrParser(val, matchedStart + macroStart.length(), rbrace);\n       try {\n         String paramName = parser.getId();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQ3MDE3Mg==", "url": "https://github.com/apache/lucene-solr/pull/1877#discussion_r489470172", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  int rbrace = val.indexOf('}', idx);\n          \n          \n            \n                  int rbrace = val.indexOf('}', matchedStart + macroStart.length());\n          \n      \n    \n    \n  \n\nsimilar to line 165 below and then the idx += macroStart.length(); assignment would not be needed since there would be no use of idx between that incrementing assigment and the idx = start = rbrace + 1; resetting assignment below.", "author": "cpoerschke", "createdAt": "2020-09-16T14:13:08Z", "path": "solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java", "diffHunk": "@@ -136,11 +136,12 @@ private String _expand(String val) {\n       }\n       else if (idx < 0) {\n         if (sb == null) return val;\n-        sb.append(val.substring(start));\n+        sb.append(val, start, val.length());\n         return sb.toString();\n       }\n \n       // found unescaped \"${\"\n+      int matchedStart = idx;\n       idx += macroStart.length();\n \n       int rbrace = val.indexOf('}', idx);", "originalCommit": "7312cef7fdd269c863dfec36d4916a368597148b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "68083e1d5a54d44521417887553610f689dff9f1", "chunk": "diff --git a/solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java b/solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java\nindex 75855868514..2dc9f26d866 100644\n--- a/solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java\n+++ b/solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java\n\n@@ -141,7 +141,7 @@ public class MacroExpander {\n       }\n \n       // found unescaped \"${\"\n-      int matchedStart = idx;\n+      final int matchedStart = idx;\n       idx += macroStart.length();\n \n       int rbrace = val.indexOf('}', idx);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQ3NDg1NA==", "url": "https://github.com/apache/lucene-solr/pull/1877#discussion_r489474854", "bodyText": "observation: foo.append(bar.substring(x,y)); is also found in other places in the code base, not sure how it might work implementation wise but it would be lovely if tooling would flag up that there's a more efficient alternative", "author": "cpoerschke", "createdAt": "2020-09-16T14:19:20Z", "path": "solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java", "diffHunk": "@@ -188,7 +189,7 @@ else if (failOnMissingParams) {\n \n       } catch (SyntaxError syntaxError) {\n         // append the part we would have skipped\n-        sb.append( val.substring(matchedStart, start) );\n+        sb.append(val, matchedStart, start);", "originalCommit": "7312cef7fdd269c863dfec36d4916a368597148b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQzMDEwMA==", "url": "https://github.com/apache/lucene-solr/pull/1877#discussion_r490430100", "bodyText": "IntelliJ pointed this out to me :-)  It didn't know about the val.substring(start) (implied val.length()) so I did those manually.  Yes, it'd be nice if everywhere we could do this in one go.  Feel free to file an issue to do so if you have time.  IntelliJ can make quick work of that.", "author": "dsmiley", "createdAt": "2020-09-17T17:20:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQ3NDg1NA=="}], "type": "inlineReview", "revised_code": {"commit": "72e2d6cd4df90d7dc59f1cdbf3e7ab48cdf98daa", "chunk": "diff --git a/solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java b/solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java\nindex 75855868514..144ce06b22c 100644\n--- a/solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java\n+++ b/solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java\n\n@@ -188,13 +188,19 @@ public class MacroExpander {\n         }\n \n       } catch (SyntaxError syntaxError) {\n+        if (failOnMissingParams) {\n+          return null;\n+        }\n         // append the part we would have skipped\n         sb.append(val, matchedStart, start);\n-        continue;\n       }\n+    } // loop idx\n \n+    if (sb == null) {\n+      return val;\n     }\n-\n+    sb.append(val, start, val.length());\n+    return sb.toString();\n   }\n \n \n"}}, {"oid": "68083e1d5a54d44521417887553610f689dff9f1", "url": "https://github.com/apache/lucene-solr/commit/68083e1d5a54d44521417887553610f689dff9f1", "message": "Update solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java\n\nCo-authored-by: Christine Poerschke <cpoerschke@apache.org>", "committedDate": "2020-09-17T17:18:13Z", "type": "commit"}, {"oid": "c04ae84543bd80fe8adf6e5724c68ac8793bd263", "url": "https://github.com/apache/lucene-solr/commit/c04ae84543bd80fe8adf6e5724c68ac8793bd263", "message": "Update solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java\n\nCo-authored-by: Christine Poerschke <cpoerschke@apache.org>", "committedDate": "2020-09-17T17:19:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQzODI2OA==", "url": "https://github.com/apache/lucene-solr/pull/1877#discussion_r490438268", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  // String in-between = val.substring(idx, rbrace);\n          \n          \n            \n                  // String in-between braces", "author": "dsmiley", "createdAt": "2020-09-17T17:33:42Z", "path": "solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java", "diffHunk": "@@ -154,14 +155,14 @@ else if (idx < 0) {\n       }\n \n       if (matchedStart > 0) {\n-        sb.append(val.substring(start, matchedStart));\n+        sb.append(val, start, matchedStart);\n       }\n \n       // update \"start\" to be at the end of ${...}\n-      start = rbrace + 1;\n+      idx = start = rbrace + 1;\n \n-      // String inbetween = val.substring(idx, rbrace);\n-      StrParser parser = new StrParser(val, idx, rbrace);\n+      // String in-between = val.substring(idx, rbrace);", "originalCommit": "c04ae84543bd80fe8adf6e5724c68ac8793bd263", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9e6dd9d31bdc662ae39c592e8a59bfeb7edc95d0", "chunk": "diff --git a/solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java b/solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java\nindex 5c2137d09c7..97673f2fd62 100644\n--- a/solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java\n+++ b/solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java\n\n@@ -161,7 +160,7 @@ public class MacroExpander {\n       // update \"start\" to be at the end of ${...}\n       idx = start = rbrace + 1;\n \n-      // String in-between = val.substring(idx, rbrace);\n+      // String in-between braces\n       StrParser parser = new StrParser(val, matchedStart + macroStart.length(), rbrace);\n       try {\n         String paramName = parser.getId();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQ4MDI5Mg==", "url": "https://github.com/apache/lucene-solr/pull/1877#discussion_r490480292", "bodyText": "Can now remove idx manipulation until later when idx & start are changed in one line\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  idx += macroStart.length();", "author": "dsmiley", "createdAt": "2020-09-17T18:48:18Z", "path": "solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java", "diffHunk": "@@ -136,14 +136,15 @@ private String _expand(String val) {\n       }\n       else if (idx < 0) {\n         if (sb == null) return val;\n-        sb.append(val.substring(start));\n+        sb.append(val, start, val.length());\n         return sb.toString();\n       }\n \n       // found unescaped \"${\"\n+      final int matchedStart = idx;\n       idx += macroStart.length();", "originalCommit": "c04ae84543bd80fe8adf6e5724c68ac8793bd263", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9e6dd9d31bdc662ae39c592e8a59bfeb7edc95d0", "chunk": "diff --git a/solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java b/solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java\nindex 5c2137d09c7..97673f2fd62 100644\n--- a/solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java\n+++ b/solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java\n\n@@ -142,7 +142,6 @@ public class MacroExpander {\n \n       // found unescaped \"${\"\n       final int matchedStart = idx;\n-      idx += macroStart.length();\n \n       int rbrace = val.indexOf('}', matchedStart + macroStart.length());\n       if (rbrace == -1) {\n"}}, {"oid": "9e6dd9d31bdc662ae39c592e8a59bfeb7edc95d0", "url": "https://github.com/apache/lucene-solr/commit/9e6dd9d31bdc662ae39c592e8a59bfeb7edc95d0", "message": "Apply suggestions from code review", "committedDate": "2020-09-17T18:49:11Z", "type": "commit"}, {"oid": "72e2d6cd4df90d7dc59f1cdbf3e7ab48cdf98daa", "url": "https://github.com/apache/lucene-solr/commit/72e2d6cd4df90d7dc59f1cdbf3e7ab48cdf98daa", "message": "fix infinite loop when no close.\nfailOnMissingParams: should have been returning null in more cases.", "committedDate": "2020-09-18T21:56:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIxMTMzMA==", "url": "https://github.com/apache/lucene-solr/pull/1877#discussion_r492211330", "bodyText": "... fix infinite loop when no close ...\n\nAh, yes, good catch!\nAnd since the logic in the loop is quite complex the \"infinite loop\" wording inspired me to go lookup again about the loop invariants and loop variants concepts and work it through here:\n\nval.size() - idx looks like the loops variant and to ensure loop termination it must decrease i.e. idx must advance (or we must break or return out of the loop)\nidx > 0 leads to advancing\nidx < 0 previously returned and now it breaks i.e. either gets us out of the loop\nidx == 0 if combined with rbrace == -1 i.e. no closing would get us stuck in the loop if continue is used but both return null or break get us out of the loop", "author": "cpoerschke", "createdAt": "2020-09-21T16:59:25Z", "path": "solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java", "diffHunk": "@@ -135,33 +135,34 @@ private String _expand(String val) {\n         }\n       }\n       else if (idx < 0) {\n-        if (sb == null) return val;\n-        sb.append(val.substring(start));\n-        return sb.toString();\n+        break;\n       }\n \n       // found unescaped \"${\"\n-      idx += macroStart.length();\n+      final int matchedStart = idx;\n \n-      int rbrace = val.indexOf('}', idx);\n+      int rbrace = val.indexOf('}', matchedStart + macroStart.length());\n       if (rbrace == -1) {\n         // no matching close brace...\n-        continue;", "originalCommit": "72e2d6cd4df90d7dc59f1cdbf3e7ab48cdf98daa", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIxNjU3NQ==", "url": "https://github.com/apache/lucene-solr/pull/1877#discussion_r492216575", "bodyText": "How about adding (say) ${goodAnswer} ${noClose as another case and it turning into 42 ${noClose if there is a goodAnswer=42 mapping i.e. to demonstrate that absence of closing curly bracket partially affects expansion (as opposed to no expansion at all happening)?", "author": "cpoerschke", "createdAt": "2020-09-21T17:08:36Z", "path": "solr/core/src/test/org/apache/solr/request/macro/TestMacroExpander.java", "diffHunk": "@@ -143,15 +142,31 @@ public void testMapExprExpandOn() {\n     String oldVal = System.getProperty(\"StreamingExpressionMacros\",\"false\");\n     System.setProperty(\"StreamingExpressionMacros\", \"true\");\n     try {\n-      @SuppressWarnings({\"rawtypes\"})\n-      Map expanded = MacroExpander.expand(request);\n-      assertEquals(\"zero\", ((String[])expanded.get(\"fq\"))[0]);\n-      assertEquals(\"one\", ((String[])expanded.get(\"fq\"))[1]);\n-      assertEquals(\"two\", ((String[]) expanded.get(\"fq\"))[2]);\n-      assertEquals(\"three\", ((String[]) expanded.get(\"fq\"))[3]);\n-      assertEquals(\"one\", ((String[])expanded.get(\"expr\"))[0]);\n+      Map<String, String[]> expanded = MacroExpander.expand(request);\n+      assertEquals(\"zero\", expanded.get(\"fq\")[0]);\n+      assertEquals(\"one\", expanded.get(\"fq\")[1]);\n+      assertEquals(\"two\", expanded.get(\"fq\")[2]);\n+      assertEquals(\"three\", expanded.get(\"fq\")[3]);\n+      assertEquals(\"one\", expanded.get(\"expr\")[0]);\n     } finally {\n       System.setProperty(\"StreamingExpressionMacros\", oldVal);\n     }\n   }\n+\n+  @Test\n+  public void testUnbalanced() { // SOLR-13181\n+    final MacroExpander meSkipOnMissingParams = new MacroExpander(Collections.emptyMap());\n+    final MacroExpander meFailOnMissingParams = new MacroExpander(Collections.emptyMap(), true);\n+    assertEquals(\"${noClose\", meSkipOnMissingParams.expand(\"${noClose\"));", "originalCommit": "72e2d6cd4df90d7dc59f1cdbf3e7ab48cdf98daa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIyNjc2OQ==", "url": "https://github.com/apache/lucene-solr/pull/1877#discussion_r492226769", "bodyText": "I'm not 100% clear what you suggest; let me try to guess.  Let's say the parameter map has exactly one param == goodAnswer with value 42.\n    assertEquals(\"42\", meSkipOnMissingParams.expand(\"${goodAnswer}\"));\n    assertEquals(\"42\", meFailOnMissingParams.expand(\"${goodAnswer}\"));\n\nIs that what you suggest?", "author": "dsmiley", "createdAt": "2020-09-21T17:25:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIxNjU3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjg0MzI0Mw==", "url": "https://github.com/apache/lucene-solr/pull/1877#discussion_r492843243", "bodyText": "${goodAnswer} ${noClose is what I had in mind. Pushed a corresponding commit to the PR's branch, hope you don't mind.", "author": "cpoerschke", "createdAt": "2020-09-22T15:44:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIxNjU3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk5MDI4MA==", "url": "https://github.com/apache/lucene-solr/pull/1877#discussion_r492990280", "bodyText": "Ah; thanks!", "author": "dsmiley", "createdAt": "2020-09-22T19:44:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIxNjU3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "178afd045d14302386c2d2730577ca031979d214", "chunk": "diff --git a/solr/core/src/test/org/apache/solr/request/macro/TestMacroExpander.java b/solr/core/src/test/org/apache/solr/request/macro/TestMacroExpander.java\nindex f9d4a9e1ee4..99717e25318 100644\n--- a/solr/core/src/test/org/apache/solr/request/macro/TestMacroExpander.java\n+++ b/solr/core/src/test/org/apache/solr/request/macro/TestMacroExpander.java\n\n@@ -155,10 +155,15 @@ public class TestMacroExpander extends SolrTestCase {\n \n   @Test\n   public void testUnbalanced() { // SOLR-13181\n-    final MacroExpander meSkipOnMissingParams = new MacroExpander(Collections.emptyMap());\n-    final MacroExpander meFailOnMissingParams = new MacroExpander(Collections.emptyMap(), true);\n+    final Map<String, String[]> request = Collections.singletonMap(\"answer\", new String[]{ \"42\" });\n+    final MacroExpander meSkipOnMissingParams = new MacroExpander(request);\n+    final MacroExpander meFailOnMissingParams = new MacroExpander(request, true);\n     assertEquals(\"${noClose\", meSkipOnMissingParams.expand(\"${noClose\"));\n+    assertEquals(\"42 ${noClose\", meSkipOnMissingParams.expand(\"${answer} ${noClose\"));\n+    assertEquals(\"42 ${noClose fooBar\", meSkipOnMissingParams.expand(\"${answer} ${noClose fooBar\"));\n     assertNull(meFailOnMissingParams.expand(\"${noClose\"));\n+    assertNull(meFailOnMissingParams.expand(\"${answer} ${noClose\"));\n+    assertNull(meFailOnMissingParams.expand(\"${answer} ${noClose fooBar\"));\n \n     assertEquals(\"${${b}}\", meSkipOnMissingParams.expand(\"${${b}}\"));\n     assertNull(meFailOnMissingParams.expand(\"${${b}}\"));\n"}}, {"oid": "0eb63f6f4a71c292e0492e85e2ec52d2e35f891e", "url": "https://github.com/apache/lucene-solr/commit/0eb63f6f4a71c292e0492e85e2ec52d2e35f891e", "message": "CHANGES.txt", "committedDate": "2020-09-21T17:17:26Z", "type": "commit"}, {"oid": "178afd045d14302386c2d2730577ca031979d214", "url": "https://github.com/apache/lucene-solr/commit/178afd045d14302386c2d2730577ca031979d214", "message": "demonstrate partial expansion behaviour in TestMacroExpander.testUnbalanced", "committedDate": "2020-09-22T15:39:20Z", "type": "commit"}]}