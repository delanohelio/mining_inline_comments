{"pr_number": 1731, "pr_title": "LUCENE-9451 Sort.rewrite does not always return this when unchanged", "pr_createdAt": "2020-08-10T16:31:30Z", "pr_url": "https://github.com/apache/lucene-solr/pull/1731", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODAzMTU5Mg==", "url": "https://github.com/apache/lucene-solr/pull/1731#discussion_r468031592", "bodyText": "This might be better as an object equality check instead of reference equality, I'm not sure.", "author": "madrob", "createdAt": "2020-08-10T16:31:55Z", "path": "lucene/core/src/java/org/apache/lucene/search/DoubleValuesSource.java", "diffHunk": "@@ -456,13 +456,16 @@ public String toString() {\n \n     @Override\n     public SortField rewrite(IndexSearcher searcher) throws IOException {\n-      DoubleValuesSortField rewritten = new DoubleValuesSortField(producer.rewrite(searcher), reverse);\n+      DoubleValuesSource rewrittenSource = producer.rewrite(searcher);\n+      if (rewrittenSource == producer) {", "originalCommit": "9035c95dd0b3ac7b8bf9687d8f2173d4ceca02fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIyNDM1NQ==", "url": "https://github.com/apache/lucene-solr/pull/1731#discussion_r469224355", "bodyText": "Reference equality is the right check.", "author": "jpountz", "createdAt": "2020-08-12T12:31:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODAzMTU5Mg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIyNTIzNw==", "url": "https://github.com/apache/lucene-solr/pull/1731#discussion_r469225237", "bodyText": "this should remain a reference equality check", "author": "jpountz", "createdAt": "2020-08-12T12:33:27Z", "path": "lucene/core/src/java/org/apache/lucene/search/Sort.java", "diffHunk": "@@ -177,12 +177,12 @@ public Sort rewrite(IndexSearcher searcher) throws IOException {\n     SortField[] rewrittenSortFields = new SortField[fields.length];\n     for (int i = 0; i < fields.length; i++) {\n       rewrittenSortFields[i] = fields[i].rewrite(searcher);\n-      if (fields[i] != rewrittenSortFields[i]) {\n+      if (! fields[i].equals(rewrittenSortFields[i])) {", "originalCommit": "6c6da31797c931a42b2c381e4b1164b2a6b98384", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e8205edcda046b8d98093db868fda901bdb70f11", "chunk": "diff --git a/lucene/core/src/java/org/apache/lucene/search/Sort.java b/lucene/core/src/java/org/apache/lucene/search/Sort.java\nindex 569f119ee90..f09fcc953da 100644\n--- a/lucene/core/src/java/org/apache/lucene/search/Sort.java\n+++ b/lucene/core/src/java/org/apache/lucene/search/Sort.java\n\n@@ -177,7 +177,7 @@ public class Sort {\n     SortField[] rewrittenSortFields = new SortField[fields.length];\n     for (int i = 0; i < fields.length; i++) {\n       rewrittenSortFields[i] = fields[i].rewrite(searcher);\n-      if (! fields[i].equals(rewrittenSortFields[i])) {\n+      if (fields[i] != rewrittenSortFields[i]) {\n         changed = true;\n       }\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIyNjQwNA==", "url": "https://github.com/apache/lucene-solr/pull/1731#discussion_r469226404", "bodyText": "This test looks like it belongs to TestDoubleValuesSource/TestLongValuesSource more than it belongs to TestSort?", "author": "jpountz", "createdAt": "2020-08-12T12:35:34Z", "path": "lucene/core/src/test/org/apache/lucene/search/TestSort.java", "diffHunk": "@@ -878,4 +878,22 @@ public void testMultiSort() throws IOException {\n     ir.close();\n     dir.close();\n   }\n+\n+  public void testRewrite() throws IOException {\n+    try (Directory dir = newDirectory()) {\n+      RandomIndexWriter writer = new RandomIndexWriter(random(), dir);\n+      IndexSearcher searcher = newSearcher(writer.getReader());\n+      writer.close();\n+\n+      LongValuesSource longSource = LongValuesSource.constant(1L);\n+      Sort sort = new Sort(longSource.getSortField(false));\n+\n+      assertSame(sort, sort.rewrite(searcher));\n+\n+      DoubleValuesSource doubleSource = DoubleValuesSource.constant(1.0);\n+      sort = new Sort(doubleSource.getSortField(false));\n+\n+      assertSame(sort, sort.rewrite(searcher));\n+    }\n+  }", "originalCommit": "6c6da31797c931a42b2c381e4b1164b2a6b98384", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "c5a859615c95c9f629077129880d08ab1ace11e3", "url": "https://github.com/apache/lucene-solr/commit/c5a859615c95c9f629077129880d08ab1ace11e3", "message": "LUCENE-9451 Sort.rewrite does not always return this when unchanged", "committedDate": "2020-08-17T15:37:47Z", "type": "commit"}, {"oid": "14ec015e22cc3c8e0bcad50c277a440346b8464d", "url": "https://github.com/apache/lucene-solr/commit/14ec015e22cc3c8e0bcad50c277a440346b8464d", "message": "precommit", "committedDate": "2020-08-17T15:37:48Z", "type": "commit"}, {"oid": "e8205edcda046b8d98093db868fda901bdb70f11", "url": "https://github.com/apache/lucene-solr/commit/e8205edcda046b8d98093db868fda901bdb70f11", "message": "Review feedback", "committedDate": "2020-08-17T15:47:44Z", "type": "commit"}, {"oid": "e8205edcda046b8d98093db868fda901bdb70f11", "url": "https://github.com/apache/lucene-solr/commit/e8205edcda046b8d98093db868fda901bdb70f11", "message": "Review feedback", "committedDate": "2020-08-17T15:47:44Z", "type": "forcePushed"}]}