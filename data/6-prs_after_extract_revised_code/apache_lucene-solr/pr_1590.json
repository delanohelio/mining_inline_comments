{"pr_number": 1590, "pr_title": "LUCENE-9408: Ensure OneMerge#mergeFinished is only called once", "pr_createdAt": "2020-06-17T21:52:15Z", "pr_url": "https://github.com/apache/lucene-solr/pull/1590", "timeline": [{"oid": "34ab53072911ac346bded7bbf8ec7140248f331f", "url": "https://github.com/apache/lucene-solr/commit/34ab53072911ac346bded7bbf8ec7140248f331f", "message": "LUCENE-9408: Ensure OneMerge#mergeFinished is only called once\n\nin the case of an exception it's possible that some OneMerge instances\nwill be closed multiple times. This commit ensures that mergeFinished is\nreally just called once instead of multiple times.", "committedDate": "2020-06-17T21:51:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzUzODI2Mw==", "url": "https://github.com/apache/lucene-solr/pull/1590#discussion_r443538263", "bodyText": "It is a little weird that we don't then have a merge.setDone() or something inside this if to make the idempotency really clear.  But I understand this code is pre-existingly already hairy so it is not simple to fix that, so progress not perfection!", "author": "mikemccand", "createdAt": "2020-06-22T12:57:01Z", "path": "lucene/core/src/java/org/apache/lucene/index/IndexWriter.java", "diffHunk": "@@ -4286,25 +4287,30 @@ private synchronized void mergeFinish(MergePolicy.OneMerge merge) {\n \n   @SuppressWarnings(\"try\")\n   private synchronized void closeMergeReaders(MergePolicy.OneMerge merge, boolean suppressExceptions) throws IOException {\n-    final boolean drop = suppressExceptions == false;\n-    try (Closeable finalizer = () -> merge.mergeFinished(suppressExceptions == false)) {\n-      IOUtils.applyToAll(merge.readers, sr -> {\n-        final ReadersAndUpdates rld = getPooledInstance(sr.getOriginalSegmentInfo(), false);\n-        // We still hold a ref so it should not have been removed:\n-        assert rld != null;\n-        if (drop) {\n-          rld.dropChanges();\n-        } else {\n-          rld.dropMergingUpdates();\n-        }\n-        rld.release(sr);\n-        release(rld);\n-        if (drop) {\n-          readerPool.drop(rld.info);\n-        }\n-      });\n-    } finally {\n-      Collections.fill(merge.readers, null);\n+    if (merge.isDone() == false) {", "originalCommit": "34ab53072911ac346bded7bbf8ec7140248f331f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcyODYxMA==", "url": "https://github.com/apache/lucene-solr/pull/1590#discussion_r443728610", "bodyText": "I can call it hasFinished() that would make it more clear? WDYT", "author": "s1monw", "createdAt": "2020-06-22T17:50:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzUzODI2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTAxMDM0Ng==", "url": "https://github.com/apache/lucene-solr/pull/1590#discussion_r445010346", "bodyText": "@mikemccand I pushed a new commit to address this", "author": "s1monw", "createdAt": "2020-06-24T16:11:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzUzODI2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "22fe4968077f8707c2150403a6e96b36bc7db5dc", "chunk": "diff --git a/lucene/core/src/java/org/apache/lucene/index/IndexWriter.java b/lucene/core/src/java/org/apache/lucene/index/IndexWriter.java\nindex b60dc5ca9ab..fd1722022a7 100644\n--- a/lucene/core/src/java/org/apache/lucene/index/IndexWriter.java\n+++ b/lucene/core/src/java/org/apache/lucene/index/IndexWriter.java\n\n@@ -4287,7 +4287,7 @@ public class IndexWriter implements Closeable, TwoPhaseCommit, Accountable,\n \n   @SuppressWarnings(\"try\")\n   private synchronized void closeMergeReaders(MergePolicy.OneMerge merge, boolean suppressExceptions) throws IOException {\n-    if (merge.isDone() == false) {\n+    if (merge.hasFinished() == false) {\n       final boolean drop = suppressExceptions == false;\n       try (Closeable finalizer = () -> merge.mergeFinished(suppressExceptions == false)) {\n         IOUtils.applyToAll(merge.readers, sr -> {\n"}}, {"oid": "ad1cb7f3f6aa56ff9e4fa033a299bfb3d8ccce30", "url": "https://github.com/apache/lucene-solr/commit/ad1cb7f3f6aa56ff9e4fa033a299bfb3d8ccce30", "message": "Merge branch 'master' into LUCENE-9408", "committedDate": "2020-06-24T16:09:56Z", "type": "commit"}, {"oid": "22fe4968077f8707c2150403a6e96b36bc7db5dc", "url": "https://github.com/apache/lucene-solr/commit/22fe4968077f8707c2150403a6e96b36bc7db5dc", "message": "apply feedback", "committedDate": "2020-06-24T16:11:28Z", "type": "commit"}]}