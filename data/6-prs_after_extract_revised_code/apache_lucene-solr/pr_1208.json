{"pr_number": 1208, "pr_title": "SOLR-13101: Convert nanotime to ms", "pr_createdAt": "2020-01-24T23:07:08Z", "pr_url": "https://github.com/apache/lucene-solr/pull/1208", "timeline": [{"oid": "9f12a8c617015ef36d46d2d875eaf15cc0d20c2a", "url": "https://github.com/apache/lucene-solr/commit/9f12a8c617015ef36d46d2d875eaf15cc0d20c2a", "message": "Convert nanoseconds to milliseconds", "committedDate": "2020-01-24T22:07:12Z", "type": "commit"}, {"oid": "6c0e904cb4f94fc5bb21f7e03ef288744f582dde", "url": "https://github.com/apache/lucene-solr/commit/6c0e904cb4f94fc5bb21f7e03ef288744f582dde", "message": "Clean up from incorrect merge", "committedDate": "2020-01-24T22:18:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg4MTMyNg==", "url": "https://github.com/apache/lucene-solr/pull/1208#discussion_r370881326", "bodyText": "From what I could find, deletedAt and deleteDelay is only set using System.nanoTime/1000000, so there should not be any mismatch from comparing times that used nanoTime and times that used currentTimeMillis", "author": "ebehrendt", "createdAt": "2020-01-24T23:10:23Z", "path": "solr/core/src/java/org/apache/solr/store/blob/metadata/CorePushPull.java", "diffHunk": "@@ -499,7 +500,7 @@ void enqueueForHardDelete(BlobCoreMetadataBuilder bcmBuilder) throws Exception {\n     @VisibleForTesting\n     protected boolean okForHardDelete(BlobCoreMetadata.BlobFileToDelete file) {\n       // For now we only check how long ago the file was marked for delete.\n-      return System.nanoTime() - file.getDeletedAt() >= deleteManager.getDeleteDelayMs();\n+      return (System.nanoTime() / 1000000) - file.getDeletedAt() >= deleteManager.getDeleteDelayMs();", "originalCommit": "6c0e904cb4f94fc5bb21f7e03ef288744f582dde", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg5MTc4Nw==", "url": "https://github.com/apache/lucene-solr/pull/1208#discussion_r370891787", "bodyText": "It might be a good idea to update the BlobFileToDelete class to make it explicit via the javadoc (actually it doesn't have any) that the getDeletedAt() returns the timestamp in milliseconds", "author": "andyvuong", "createdAt": "2020-01-25T00:02:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg4MTMyNg=="}], "type": "inlineReview", "revised_code": {"commit": "cf4bbfeac67a4493b24cefbf74cf60dd885db6a5", "chunk": "diff --git a/solr/core/src/java/org/apache/solr/store/blob/metadata/CorePushPull.java b/solr/core/src/java/org/apache/solr/store/blob/metadata/CorePushPull.java\nindex c733d9c96c1..53a604d556c 100644\n--- a/solr/core/src/java/org/apache/solr/store/blob/metadata/CorePushPull.java\n+++ b/solr/core/src/java/org/apache/solr/store/blob/metadata/CorePushPull.java\n\n@@ -500,7 +499,7 @@ public class CorePushPull {\n     @VisibleForTesting\n     protected boolean okForHardDelete(BlobCoreMetadata.BlobFileToDelete file) {\n       // For now we only check how long ago the file was marked for delete.\n-      return (System.nanoTime() / 1000000) - file.getDeletedAt() >= deleteManager.getDeleteDelayMs();\n+      return BlobStoreUtils.getCurrentNanoTimeInMs() - file.getDeletedAt() >= deleteManager.getDeleteDelayMs();\n     }\n     \n     @VisibleForTesting\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg5MTkxMw==", "url": "https://github.com/apache/lucene-solr/pull/1208#discussion_r370891913", "bodyText": "I'd consider making System.nanoTime() / 1000000 a util method in BlobStoreUtils", "author": "andyvuong", "createdAt": "2020-01-25T00:03:00Z", "path": "solr/core/src/java/org/apache/solr/store/blob/metadata/CorePushPull.java", "diffHunk": "@@ -114,7 +114,7 @@ protected CoreContainer getContainerFromServerMetadata(ServerSideMetadata solrSe\n      * @param newMetadataSuffix suffix of the new core.metadata file to be created as part of this push\n      */\n     public BlobCoreMetadata pushToBlobStore(String currentMetadataSuffix, String newMetadataSuffix) throws Exception {\n-      long startTimeMs = System.nanoTime();\n+      long startTimeMs = System.nanoTime() / 1000000;", "originalCommit": "6c0e904cb4f94fc5bb21f7e03ef288744f582dde", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cf4bbfeac67a4493b24cefbf74cf60dd885db6a5", "chunk": "diff --git a/solr/core/src/java/org/apache/solr/store/blob/metadata/CorePushPull.java b/solr/core/src/java/org/apache/solr/store/blob/metadata/CorePushPull.java\nindex c733d9c96c1..53a604d556c 100644\n--- a/solr/core/src/java/org/apache/solr/store/blob/metadata/CorePushPull.java\n+++ b/solr/core/src/java/org/apache/solr/store/blob/metadata/CorePushPull.java\n\n@@ -114,7 +114,7 @@ public class CorePushPull {\n      * @param newMetadataSuffix suffix of the new core.metadata file to be created as part of this push\n      */\n     public BlobCoreMetadata pushToBlobStore(String currentMetadataSuffix, String newMetadataSuffix) throws Exception {\n-      long startTimeMs = System.nanoTime() / 1000000;\n+      long startTimeMs = BlobStoreUtils.getCurrentNanoTimeInMs();\n       SolrCore solrCore = container.getCore(pushPullData.getCoreName());\n       if (solrCore == null) {\n         throw new Exception(\"Can't find core \" + pushPullData.getCoreName());\n"}}, {"oid": "cf4bbfeac67a4493b24cefbf74cf60dd885db6a5", "url": "https://github.com/apache/lucene-solr/commit/cf4bbfeac67a4493b24cefbf74cf60dd885db6a5", "message": "Incorporate CR feedback to move time to a utility function. Use TimeUnit java util to convert from nanoseconds to milliseconds.", "committedDate": "2020-02-04T00:05:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgzOTIxNQ==", "url": "https://github.com/apache/lucene-solr/pull/1208#discussion_r374839215", "bodyText": "Why not just call it getCurrentTimeMs and let the javadoc make it clear it's not the same as System.currentTimeMillis(), the main reason being it was changed originally to fix ant precommit failures?", "author": "andyvuong", "createdAt": "2020-02-04T18:17:10Z", "path": "solr/core/src/java/org/apache/solr/store/blob/util/BlobStoreUtils.java", "diffHunk": "@@ -75,6 +76,16 @@ public static String generateMetadataSuffix() {\n     return UUID.randomUUID().toString();\n   }\n \n+  /**\n+   * Returns current nano time in millisecond resolution for use in measuring elapsed time.\n+   * \n+   * Note: Do not combine this value with currentTimeMillis - currentTimeMillis will return ms relative to epoch\n+   * while this method returns ms relative to some arbitrary time\n+   */\n+  public static long getCurrentNanoTimeInMs() {", "originalCommit": "cf4bbfeac67a4493b24cefbf74cf60dd885db6a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg4MzIwNQ==", "url": "https://github.com/apache/lucene-solr/pull/1208#discussion_r374883205", "bodyText": "Sure - I had named this way to avoid combining with currentTimeMillis but if the javadoc is good enough for that I'll rename", "author": "ebehrendt", "createdAt": "2020-02-04T19:42:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgzOTIxNQ=="}], "type": "inlineReview", "revised_code": {"commit": "d211e360f43c4bfa930bc156f7d361d01032075b", "chunk": "diff --git a/solr/core/src/java/org/apache/solr/store/blob/util/BlobStoreUtils.java b/solr/core/src/java/org/apache/solr/store/blob/util/BlobStoreUtils.java\nindex 3bcd1eed92c..7eb1fb341c4 100644\n--- a/solr/core/src/java/org/apache/solr/store/blob/util/BlobStoreUtils.java\n+++ b/solr/core/src/java/org/apache/solr/store/blob/util/BlobStoreUtils.java\n\n@@ -77,12 +77,11 @@ public class BlobStoreUtils {\n   }\n \n   /**\n-   * Returns current nano time in millisecond resolution for use in measuring elapsed time.\n-   * \n-   * Note: Do not combine this value with currentTimeMillis - currentTimeMillis will return ms relative to epoch\n+   * Returns current time in milliseconds for use in measuring elapsed time.\n+   * Cannot be combined with currentTimeMillis - currentTimeMillis will return ms relative to epoch\n    * while this method returns ms relative to some arbitrary time\n    */\n-  public static long getCurrentNanoTimeInMs() {\n+  public static long getCurrentTimeMs() {\n     return TimeUnit.MILLISECONDS.convert(System.nanoTime(), TimeUnit.NANOSECONDS);\n   }\n \n"}}, {"oid": "d211e360f43c4bfa930bc156f7d361d01032075b", "url": "https://github.com/apache/lucene-solr/commit/d211e360f43c4bfa930bc156f7d361d01032075b", "message": "Rename method from getCurrentNanoTimeInMs to getCurrentTimeMs", "committedDate": "2020-02-04T23:29:51Z", "type": "commit"}, {"oid": "f4e54811314065715cd4500481b2ec649ece12c7", "url": "https://github.com/apache/lucene-solr/commit/f4e54811314065715cd4500481b2ec649ece12c7", "message": "Resolve merge conflict", "committedDate": "2020-02-04T23:38:20Z", "type": "commit"}]}