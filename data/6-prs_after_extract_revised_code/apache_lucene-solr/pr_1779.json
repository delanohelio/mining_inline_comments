{"pr_number": 1779, "pr_title": "LUCENE-9478: Prevent DWPTDeleteQueue from referencing itself and leaking memory", "pr_createdAt": "2020-08-24T16:14:05Z", "pr_url": "https://github.com/apache/lucene-solr/pull/1779", "timeline": [{"oid": "51f6440aff00ccc6a009b982af8981b4abd38c25", "url": "https://github.com/apache/lucene-solr/commit/51f6440aff00ccc6a009b982af8981b4abd38c25", "message": "LUCENE-9478: Prevent DWPTDeleteQueue from referencing itself and leaking memory\n\nIn LUCENE-9304 we introduced some fixes that unfortunately hold on to the previous\nDWPTDeleteQueue which is essentially leaking IW memory and cause applications to fail.\nThis fixes the memory leak and adds a test to ensure it's not leaking memory.", "committedDate": "2020-08-24T16:08:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTczNzYzOA==", "url": "https://github.com/apache/lucene-solr/pull/1779#discussion_r475737638", "bodyText": "this is terrible but I don't know of a better way of doing this. this at least works on my machine :) and would have found the issue", "author": "s1monw", "createdAt": "2020-08-24T16:25:43Z", "path": "lucene/core/src/test/org/apache/lucene/index/TestDocumentsWriterDeleteQueue.java", "diffHunk": "@@ -36,6 +37,26 @@\n  */\n public class TestDocumentsWriterDeleteQueue extends LuceneTestCase {\n \n+\n+  public void testAdvanceReferencesOriginal() {\n+    WeakAndNext weakAndNext = new WeakAndNext();\n+    DocumentsWriterDeleteQueue next = weakAndNext.next;\n+    assertNotNull(next);\n+    System.gc();", "originalCommit": "51f6440aff00ccc6a009b982af8981b4abd38c25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTczNzg1MQ==", "url": "https://github.com/apache/lucene-solr/pull/1779#discussion_r475737851", "bodyText": "@uschindler @dweiss maybe you have better ideas", "author": "s1monw", "createdAt": "2020-08-24T16:26:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTczNzYzOA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc0NDY1Nw==", "url": "https://github.com/apache/lucene-solr/pull/1779#discussion_r475744657", "bodyText": "Maybe add a comment to this method referencing the issue, Simon?", "author": "dweiss", "createdAt": "2020-08-24T16:35:00Z", "path": "lucene/core/src/java/org/apache/lucene/index/DocumentsWriterDeleteQueue.java", "diffHunk": "@@ -573,6 +573,10 @@ long getMaxCompletedSeqNo() {\n     }\n   }\n \n+  private static LongSupplier getPrevMaxSeqIdSupplier(AtomicLong nextSeqNo) {", "originalCommit": "51f6440aff00ccc6a009b982af8981b4abd38c25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTgxMTc5OA==", "url": "https://github.com/apache/lucene-solr/pull/1779#discussion_r475811798", "bodyText": "done", "author": "s1monw", "createdAt": "2020-08-24T18:26:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc0NDY1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "d2de2209007d6c93e03f5bba6011408662e63e42", "chunk": "diff --git a/lucene/core/src/java/org/apache/lucene/index/DocumentsWriterDeleteQueue.java b/lucene/core/src/java/org/apache/lucene/index/DocumentsWriterDeleteQueue.java\nindex 18d68af14c5..cb3db7a0ff7 100644\n--- a/lucene/core/src/java/org/apache/lucene/index/DocumentsWriterDeleteQueue.java\n+++ b/lucene/core/src/java/org/apache/lucene/index/DocumentsWriterDeleteQueue.java\n\n@@ -573,6 +573,8 @@ final class DocumentsWriterDeleteQueue implements Accountable, Closeable {\n     }\n   }\n \n+  // we use a static method to get this lambda since we previously introduced a memory leak since it would\n+  // implicitly reference this.nextSeqNo which holds on to this del queue. see LUCENE-9478 for reference\n   private static LongSupplier getPrevMaxSeqIdSupplier(AtomicLong nextSeqNo) {\n     return () -> nextSeqNo.get() - 1;\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc1NTAyMw==", "url": "https://github.com/apache/lucene-solr/pull/1779#discussion_r475755023", "bodyText": "I checked openjdk sources and they use System.gc() with a similar expectation that it will always try to flush all weak refs before returning, so this seems fine. The test itself could maybe be made more explicit by utilizing an explicit ReferenceQueue rather than asserting the reference has been cleared but this is a matter of taste - if this works, it will in both cases.", "author": "dweiss", "createdAt": "2020-08-24T16:50:32Z", "path": "lucene/core/src/test/org/apache/lucene/index/TestDocumentsWriterDeleteQueue.java", "diffHunk": "@@ -36,6 +37,26 @@\n  */\n public class TestDocumentsWriterDeleteQueue extends LuceneTestCase {\n \n+\n+  public void testAdvanceReferencesOriginal() {\n+    WeakAndNext weakAndNext = new WeakAndNext();\n+    DocumentsWriterDeleteQueue next = weakAndNext.next;\n+    assertNotNull(next);\n+    System.gc();", "originalCommit": "51f6440aff00ccc6a009b982af8981b4abd38c25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTgxMjAyMw==", "url": "https://github.com/apache/lucene-solr/pull/1779#discussion_r475812023", "bodyText": "cool! I think the simpler the better", "author": "s1monw", "createdAt": "2020-08-24T18:26:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc1NTAyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTgyMDg5MQ==", "url": "https://github.com/apache/lucene-solr/pull/1779#discussion_r475820891", "bodyText": "I would also use a ReferenceQueue to do the check. The weak.get() has a bad taste to me.\nI did not check that System.gc() tries to cleanup weak refs, but if it does and we can rely on this, I am fine.", "author": "uschindler", "createdAt": "2020-08-24T18:43:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc1NTAyMw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "adb173107f78b878fdf419ce1ad72dd4656c5a10", "url": "https://github.com/apache/lucene-solr/commit/adb173107f78b878fdf419ce1ad72dd4656c5a10", "message": "Merge branch 'master' into fix_fuckedup_lambda", "committedDate": "2020-08-24T18:24:26Z", "type": "commit"}, {"oid": "d2de2209007d6c93e03f5bba6011408662e63e42", "url": "https://github.com/apache/lucene-solr/commit/d2de2209007d6c93e03f5bba6011408662e63e42", "message": "add comment", "committedDate": "2020-08-24T18:26:05Z", "type": "commit"}, {"oid": "e75fd13086db9519263791a31da8d014683d6efe", "url": "https://github.com/apache/lucene-solr/commit/e75fd13086db9519263791a31da8d014683d6efe", "message": "add changes", "committedDate": "2020-08-24T19:25:06Z", "type": "commit"}]}