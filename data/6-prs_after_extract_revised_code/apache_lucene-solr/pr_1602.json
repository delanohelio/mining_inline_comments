{"pr_number": 1602, "pr_title": "SOLR-14582: Expose IWC.setMaxCommitMergeWaitMillis in Solr's index config", "pr_createdAt": "2020-06-22T22:33:42Z", "pr_url": "https://github.com/apache/lucene-solr/pull/1602", "timeline": [{"oid": "93e8a6a679615b1278a5705c3a8dcb14649273ab", "url": "https://github.com/apache/lucene-solr/commit/93e8a6a679615b1278a5705c3a8dcb14649273ab", "message": "Use updated Lucene API\n\nAlso, be explicit about no support in default MP", "committedDate": "2020-06-29T18:04:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ1MTA4Ng==", "url": "https://github.com/apache/lucene-solr/pull/1602#discussion_r448451086", "bodyText": "I don't think we need to clear this, the test runner takes care of it and will reset it to whatever it was previously if it had been set?", "author": "madrob", "createdAt": "2020-07-01T15:39:50Z", "path": "solr/core/src/test/org/apache/solr/update/SolrIndexConfigTest.java", "diffHunk": "@@ -208,4 +210,16 @@ public void testToMap() throws Exception {\n \n     assertEquals(mSizeExpected, m.size());\n   }\n+  \n+  public void testMaxCommitMergeWaitSeconds() throws Exception {\n+    SolrConfig sc = new SolrConfig(TEST_PATH().resolve(\"collection1\"), \"solrconfig-test-misc.xml\");\n+    assertEquals(-1, sc.indexConfig.maxCommitMergeWaitMillis);\n+    assertEquals(IndexWriterConfig.DEFAULT_MAX_COMMIT_MERGE_WAIT_MILLIS, sc.indexConfig.toIndexWriterConfig(h.getCore()).getMaxCommitMergeWaitMillis());\n+    System.setProperty(\"solr.tests.maxCommitMergeWait\", \"10\");\n+    sc = new SolrConfig(TEST_PATH().resolve(\"collection1\"), \"solrconfig-test-misc.xml\");\n+    assertEquals(10, sc.indexConfig.maxCommitMergeWaitMillis);\n+    assertEquals(10, sc.indexConfig.toIndexWriterConfig(h.getCore()).getMaxCommitMergeWaitMillis());\n+    System.clearProperty(\"solr.tests.maxCommitMergeWait\");", "originalCommit": "93e8a6a679615b1278a5705c3a8dcb14649273ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU4OTI5NA==", "url": "https://github.com/apache/lucene-solr/pull/1602#discussion_r466589294", "bodyText": "Please verify if this is so before removing.  Perhaps there may be a difference in behavior between gradle & IntelliJ; so try both.  I thought clearing wasn't necessary as well but I recall hearing from someone (@dweiss ?) that the auto-clearing wasn't working.", "author": "dsmiley", "createdAt": "2020-08-06T17:58:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ1MTA4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwMzU0NQ==", "url": "https://github.com/apache/lucene-solr/pull/1602#discussion_r466603545", "bodyText": "Yes, I checked. I believe the cleanup is after the class. I discussed with @madrob, and I'll move the cleanup to a tearDown() method", "author": "tflobbe", "createdAt": "2020-08-06T18:24:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ1MTA4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "b669aee2fffa5027eef71d87187f51541b94aab8", "chunk": "diff --git a/solr/core/src/test/org/apache/solr/update/SolrIndexConfigTest.java b/solr/core/src/test/org/apache/solr/update/SolrIndexConfigTest.java\nindex c6e74c44f65..2e4e59759c1 100644\n--- a/solr/core/src/test/org/apache/solr/update/SolrIndexConfigTest.java\n+++ b/solr/core/src/test/org/apache/solr/update/SolrIndexConfigTest.java\n\n@@ -211,15 +218,13 @@ public class SolrIndexConfigTest extends SolrTestCaseJ4 {\n     assertEquals(mSizeExpected, m.size());\n   }\n   \n-  public void testMaxCommitMergeWaitSeconds() throws Exception {\n+  public void testMaxCommitMergeWaitTime() throws Exception {\n     SolrConfig sc = new SolrConfig(TEST_PATH().resolve(\"collection1\"), \"solrconfig-test-misc.xml\");\n     assertEquals(-1, sc.indexConfig.maxCommitMergeWaitMillis);\n     assertEquals(IndexWriterConfig.DEFAULT_MAX_COMMIT_MERGE_WAIT_MILLIS, sc.indexConfig.toIndexWriterConfig(h.getCore()).getMaxCommitMergeWaitMillis());\n-    System.setProperty(\"solr.tests.maxCommitMergeWait\", \"10\");\n+    System.setProperty(\"solr.tests.maxCommitMergeWaitTime\", \"10\");\n     sc = new SolrConfig(TEST_PATH().resolve(\"collection1\"), \"solrconfig-test-misc.xml\");\n     assertEquals(10, sc.indexConfig.maxCommitMergeWaitMillis);\n     assertEquals(10, sc.indexConfig.toIndexWriterConfig(h.getCore()).getMaxCommitMergeWaitMillis());\n-    System.clearProperty(\"solr.tests.maxCommitMergeWait\");\n-    \n   }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUyNjk2Ng==", "url": "https://github.com/apache/lucene-solr/pull/1602#discussion_r466526966", "bodyText": "Lets use org.apache.lucene.index.IndexWriterConfig#DEFAULT_MAX_COMMIT_MERGE_WAIT_MILLIS.  In the future, this constant might change, and that's good.", "author": "dsmiley", "createdAt": "2020-08-06T16:13:41Z", "path": "solr/core/src/java/org/apache/solr/update/SolrIndexConfig.java", "diffHunk": "@@ -87,6 +100,7 @@ private SolrIndexConfig(SolrConfig solrConfig) {\n     maxBufferedDocs = -1;\n     ramBufferSizeMB = 100;\n     ramPerThreadHardLimitMB = -1;\n+    maxCommitMergeWaitMillis = -1;", "originalCommit": "93e8a6a679615b1278a5705c3a8dcb14649273ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU2MTc4NA==", "url": "https://github.com/apache/lucene-solr/pull/1602#discussion_r466561784", "bodyText": "I don't think that's a good idea. \"-1\" from the Solr perspective means \"don't set the value\".  If someone has a custom merge policy where they have a different value set by code, we would be changing it to org.apache.lucene.index.IndexWriterConfig#DEFAULT_MAX_COMMIT_MERGE_WAIT_MILLIS without them having set anything on solrconfig.xml.\n\nIn the future, this constant might change, and that's good.\n\nThat's fine, since we aren't calling iwc.setMaxCommitMergeWaitMillis(...) in the default case, we'll be taking the new default for all cores where no alternative configuration has been provided.", "author": "tflobbe", "createdAt": "2020-08-06T17:13:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUyNjk2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjgxODc5NQ==", "url": "https://github.com/apache/lucene-solr/pull/1602#discussion_r466818795", "bodyText": "ok, good point.", "author": "dsmiley", "createdAt": "2020-08-07T04:49:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUyNjk2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "30784033c53edcacce4b7aa4e088c3d8ef9b396e", "chunk": "diff --git a/solr/core/src/java/org/apache/solr/update/SolrIndexConfig.java b/solr/core/src/java/org/apache/solr/update/SolrIndexConfig.java\nindex d2e303b28f5..a4e3d494074 100644\n--- a/solr/core/src/java/org/apache/solr/update/SolrIndexConfig.java\n+++ b/solr/core/src/java/org/apache/solr/update/SolrIndexConfig.java\n\n@@ -100,7 +94,7 @@ public class SolrIndexConfig implements MapSerializable {\n     maxBufferedDocs = -1;\n     ramBufferSizeMB = 100;\n     ramPerThreadHardLimitMB = -1;\n-    maxCommitMergeWaitMillis = -1;\n+    maxCommitMergeWaitSeconds = -1;\n     writeLockTimeout = -1;\n     lockType = DirectoryFactory.LOCK_TYPE_NATIVE;\n     mergePolicyFactoryInfo = null;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUyODA1NA==", "url": "https://github.com/apache/lucene-solr/pull/1602#discussion_r466528054", "bodyText": "I appreciate documentation but redundant documentation -- not so much.  Can't you do a @see or @link to one place -- org.apache.lucene.index.IndexWriterConfig#setMaxCommitMergeWaitMillis", "author": "dsmiley", "createdAt": "2020-08-06T16:15:24Z", "path": "solr/core/src/java/org/apache/solr/update/SolrIndexConfig.java", "diffHunk": "@@ -68,6 +68,19 @@\n \n   public final double ramBufferSizeMB;\n   public final int ramPerThreadHardLimitMB;\n+  /**", "originalCommit": "93e8a6a679615b1278a5705c3a8dcb14649273ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwNjE2Ng==", "url": "https://github.com/apache/lucene-solr/pull/1602#discussion_r466606166", "bodyText": "I didn't want to drop the link/see by itself, so I added a single line introducing the functionality. After that I added specifics about Solr (solrconfig configuration and the warning setting). I honestly don't see the problem here.", "author": "tflobbe", "createdAt": "2020-08-06T18:28:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUyODA1NA=="}], "type": "inlineReview", "revised_code": {"commit": "b669aee2fffa5027eef71d87187f51541b94aab8", "chunk": "diff --git a/solr/core/src/java/org/apache/solr/update/SolrIndexConfig.java b/solr/core/src/java/org/apache/solr/update/SolrIndexConfig.java\nindex d2e303b28f5..50bda0ef67f 100644\n--- a/solr/core/src/java/org/apache/solr/update/SolrIndexConfig.java\n+++ b/solr/core/src/java/org/apache/solr/update/SolrIndexConfig.java\n\n@@ -72,7 +72,7 @@ public class SolrIndexConfig implements MapSerializable {\n    * <p>\n    * When using a custom merge policy that allows triggering synchronous merges on commit\n    * (see {@link MergePolicy#findFullFlushMerges(org.apache.lucene.index.MergeTrigger, org.apache.lucene.index.SegmentInfos, org.apache.lucene.index.MergePolicy.MergeContext)}),\n-   * a timeout (in milliseconds) can be set for those merges to finish. Use {@code <maxCommitMergeWait>1000</maxCommitMergeWait>} in the {@code <indexConfig>} section.\n+   * a timeout (in milliseconds) can be set for those merges to finish. Use {@code <maxCommitMergeWaitTime>1000</maxCommitMergeWaitTime>} in the {@code <indexConfig>} section.\n    * See {@link IndexWriterConfig#setMaxCommitMergeWaitMillis(long)}.\n    * </p>\n    * <p>\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUzMDE1Mg==", "url": "https://github.com/apache/lucene-solr/pull/1602#discussion_r466530152", "bodyText": "I noticed you omitted a \"Millis\" setting.  I think either you should add this for clarity, or for consistency with some other times I see in solrconfig (e.g. maxTime), use suffix \"Time\".", "author": "dsmiley", "createdAt": "2020-08-06T16:18:56Z", "path": "solr/core/src/java/org/apache/solr/update/SolrIndexConfig.java", "diffHunk": "@@ -129,8 +143,9 @@ public SolrIndexConfig(SolrConfig solrConfig, String prefix, SolrIndexConfig def\n         true);\n \n     useCompoundFile = solrConfig.getBool(prefix+\"/useCompoundFile\", def.useCompoundFile);\n-    maxBufferedDocs=solrConfig.getInt(prefix+\"/maxBufferedDocs\",def.maxBufferedDocs);\n+    maxBufferedDocs = solrConfig.getInt(prefix+\"/maxBufferedDocs\", def.maxBufferedDocs);\n     ramBufferSizeMB = solrConfig.getDouble(prefix+\"/ramBufferSizeMB\", def.ramBufferSizeMB);\n+    maxCommitMergeWaitMillis = solrConfig.getInt(prefix+\"/maxCommitMergeWait\", def.maxCommitMergeWaitMillis);", "originalCommit": "93e8a6a679615b1278a5705c3a8dcb14649273ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU2NTY1Mw==", "url": "https://github.com/apache/lucene-solr/pull/1602#discussion_r466565653", "bodyText": "I had it with MIllis and I removed that because I didn't see anything else in the solrconfig that included the unit for time (it's always milliseconds). You are suggesting maxCommitMergeWaitMillis or maxCommitMergeTime?", "author": "tflobbe", "createdAt": "2020-08-06T17:19:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUzMDE1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU4NzcwNQ==", "url": "https://github.com/apache/lucene-solr/pull/1602#discussion_r466587705", "bodyText": "The \"Wait\" part is important too too.  \"maxCommitMergeWaitTime\" is my preference", "author": "dsmiley", "createdAt": "2020-08-06T17:55:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUzMDE1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "b669aee2fffa5027eef71d87187f51541b94aab8", "chunk": "diff --git a/solr/core/src/java/org/apache/solr/update/SolrIndexConfig.java b/solr/core/src/java/org/apache/solr/update/SolrIndexConfig.java\nindex d2e303b28f5..50bda0ef67f 100644\n--- a/solr/core/src/java/org/apache/solr/update/SolrIndexConfig.java\n+++ b/solr/core/src/java/org/apache/solr/update/SolrIndexConfig.java\n\n@@ -145,7 +145,7 @@ public class SolrIndexConfig implements MapSerializable {\n     useCompoundFile = solrConfig.getBool(prefix+\"/useCompoundFile\", def.useCompoundFile);\n     maxBufferedDocs = solrConfig.getInt(prefix+\"/maxBufferedDocs\", def.maxBufferedDocs);\n     ramBufferSizeMB = solrConfig.getDouble(prefix+\"/ramBufferSizeMB\", def.ramBufferSizeMB);\n-    maxCommitMergeWaitMillis = solrConfig.getInt(prefix+\"/maxCommitMergeWait\", def.maxCommitMergeWaitMillis);\n+    maxCommitMergeWaitMillis = solrConfig.getInt(prefix+\"/maxCommitMergeWaitTime\", def.maxCommitMergeWaitMillis);\n \n     // how do we validate the value??\n     ramPerThreadHardLimitMB = solrConfig.getInt(prefix+\"/ramPerThreadHardLimitMB\", def.ramPerThreadHardLimitMB);\n"}}, {"oid": "b669aee2fffa5027eef71d87187f51541b94aab8", "url": "https://github.com/apache/lucene-solr/commit/b669aee2fffa5027eef71d87187f51541b94aab8", "message": "Address PR comments", "committedDate": "2020-08-06T21:31:18Z", "type": "forcePushed"}, {"oid": "30784033c53edcacce4b7aa4e088c3d8ef9b396e", "url": "https://github.com/apache/lucene-solr/commit/30784033c53edcacce4b7aa4e088c3d8ef9b396e", "message": "Expose IWC.setMaxCommitMergeWaitSeconds in Solr's index config", "committedDate": "2020-08-07T17:10:32Z", "type": "commit"}, {"oid": "007b23bba3a02fe36751c206284a9c8e9e3c6223", "url": "https://github.com/apache/lucene-solr/commit/007b23bba3a02fe36751c206284a9c8e9e3c6223", "message": "Use updated Lucene API\n\nAlso, be explicit about no support in default MP", "committedDate": "2020-08-07T17:10:32Z", "type": "commit"}, {"oid": "54382ae7885cf9e638055316f142608a51ee119f", "url": "https://github.com/apache/lucene-solr/commit/54382ae7885cf9e638055316f142608a51ee119f", "message": "Address PR comments", "committedDate": "2020-08-07T17:10:32Z", "type": "commit"}, {"oid": "b12455151592a47ea57f2a1bd6ec906178aef9d6", "url": "https://github.com/apache/lucene-solr/commit/b12455151592a47ea57f2a1bd6ec906178aef9d6", "message": "Add CHANGES entry", "committedDate": "2020-08-07T17:22:50Z", "type": "commit"}, {"oid": "b12455151592a47ea57f2a1bd6ec906178aef9d6", "url": "https://github.com/apache/lucene-solr/commit/b12455151592a47ea57f2a1bd6ec906178aef9d6", "message": "Add CHANGES entry", "committedDate": "2020-08-07T17:22:50Z", "type": "forcePushed"}]}