{"pr_number": 1598, "pr_title": "SOLR-14409: Existing violations allow bypassing policy rules when add\u2026", "pr_createdAt": "2020-06-22T02:58:17Z", "pr_url": "https://github.com/apache/lucene-solr/pull/1598", "timeline": [{"oid": "a8e9e5789beba6fdc344d618edf596318efd0bbc", "url": "https://github.com/apache/lucene-solr/commit/a8e9e5789beba6fdc344d618edf596318efd0bbc", "message": "SOLR-14409: Existing violations allow bypassing policy rules when adding new replicas", "committedDate": "2020-06-22T02:57:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMyMzMyOQ==", "url": "https://github.com/apache/lucene-solr/pull/1598#discussion_r444323329", "bodyText": "assertThat(exp.getMessage(), contains(\"...\"))", "author": "madrob", "createdAt": "2020-06-23T15:43:13Z", "path": "solr/solrj/src/test/org/apache/solr/client/solrj/cloud/autoscaling/TestPolicy2.java", "diffHunk": "@@ -516,6 +517,16 @@ public void testInfiniteLoop() {\n     System.out.println(suggestions);\n   }\n \n+  public void testAddTooManyPerPolicy() {\n+    Map<String, Object> m = (Map<String, Object>) loadFromResource(\"testAddTooManyPerPolicy.json\");\n+    SolrCloudManager cloudManagerFromDiagnostics = createCloudManagerFromDiagnostics(m);\n+    AutoScalingConfig autoScalingConfig = new AutoScalingConfig((Map<String, Object>) getObjectByPath(m, false, \"diagnostics/config\"));\n+    SolrException exp =  expectThrows(SolrException.class, () -> PolicyHelper.getReplicaLocations(\"TooManyPerPolicy\", autoScalingConfig, cloudManagerFromDiagnostics,\n+            EMPTY_MAP, Collections.singletonList(\"shard1\"), 1, 0, 0, null));\n+    assertTrue(exp.getMessage().contains(\"No node can satisfy the rules\"));", "originalCommit": "a8e9e5789beba6fdc344d618edf596318efd0bbc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU3NTEyNA==", "url": "https://github.com/apache/lucene-solr/pull/1598#discussion_r444575124", "bodyText": "what's the difference?", "author": "noblepaul", "createdAt": "2020-06-24T00:13:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMyMzMyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY1MzcxNw==", "url": "https://github.com/apache/lucene-solr/pull/1598#discussion_r445653717", "bodyText": "You get a better error message when the test fails.", "author": "madrob", "createdAt": "2020-06-25T15:40:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMyMzMyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "2a966a4bf002f477eb58b8a38ada7c1205f183cb", "chunk": "diff --git a/solr/solrj/src/test/org/apache/solr/client/solrj/cloud/autoscaling/TestPolicy2.java b/solr/solrj/src/test/org/apache/solr/client/solrj/cloud/autoscaling/TestPolicy2.java\nindex 0369a0fdd18..b61719366c9 100644\n--- a/solr/solrj/src/test/org/apache/solr/client/solrj/cloud/autoscaling/TestPolicy2.java\n+++ b/solr/solrj/src/test/org/apache/solr/client/solrj/cloud/autoscaling/TestPolicy2.java\n\n@@ -517,6 +517,7 @@ public class TestPolicy2 extends SolrTestCaseJ4 {\n     System.out.println(suggestions);\n   }\n \n+  @SuppressWarnings({\"unchecked\"})\n   public void testAddTooManyPerPolicy() {\n     Map<String, Object> m = (Map<String, Object>) loadFromResource(\"testAddTooManyPerPolicy.json\");\n     SolrCloudManager cloudManagerFromDiagnostics = createCloudManagerFromDiagnostics(m);\n"}}, {"oid": "2a966a4bf002f477eb58b8a38ada7c1205f183cb", "url": "https://github.com/apache/lucene-solr/commit/2a966a4bf002f477eb58b8a38ada7c1205f183cb", "message": "SuppressWarnings", "committedDate": "2020-06-24T12:58:43Z", "type": "commit"}, {"oid": "170f0f88b0b63fffc6b3c4b8d3c818cd8289c50c", "url": "https://github.com/apache/lucene-solr/commit/170f0f88b0b63fffc6b3c4b8d3c818cd8289c50c", "message": "CHANGES.txt", "committedDate": "2020-06-25T00:31:57Z", "type": "commit"}, {"oid": "a9c33710a66637b0aa4877e179379f7f8abd9a03", "url": "https://github.com/apache/lucene-solr/commit/a9c33710a66637b0aa4877e179379f7f8abd9a03", "message": "Merge branch 'master' into jira/solr14409", "committedDate": "2020-06-25T00:33:05Z", "type": "commit"}]}