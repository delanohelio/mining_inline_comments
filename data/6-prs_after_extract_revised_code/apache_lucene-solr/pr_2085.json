{"pr_number": 2085, "pr_title": "LUCENE-9508: Fix DocumentsWriter to block threads until unstalled", "pr_createdAt": "2020-11-18T11:55:48Z", "pr_url": "https://github.com/apache/lucene-solr/pull/2085", "timeline": [{"oid": "25a13d2eef68c047ae4ce5d17c5b830cf6a520b7", "url": "https://github.com/apache/lucene-solr/commit/25a13d2eef68c047ae4ce5d17c5b830cf6a520b7", "message": "LUCENE-9508: Fix DocumentsWriter to block threads until unstalled\n\nDWStallControl expects the caller to loop on top of the wait call to make\nprogress with flushing if the DW is stalled. This logic wasn't applied such that\nDW only stalled for one second and then released the indexing thread. This can cause\nOOM if for instance during a full flush one DWPT gets stuck and onther threads keep on\nindexing.", "committedDate": "2020-11-18T11:49:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjAzMjk0Mg==", "url": "https://github.com/apache/lucene-solr/pull/2085#discussion_r526032942", "bodyText": "pull it up into the same try (semicolon-separated)?", "author": "dweiss", "createdAt": "2020-11-18T12:00:54Z", "path": "lucene/core/src/test/org/apache/lucene/index/TestIndexWriter.java", "diffHunk": "@@ -4258,4 +4258,47 @@ public void testPendingNumDocs() throws Exception {\n       }\n     }\n   }\n+\n+  public void testIndexWriterBlocksOnStall() throws IOException, InterruptedException {\n+    try (Directory dir = newDirectory()) {\n+      try (IndexWriter writer = new IndexWriter(dir, newIndexWriterConfig())) {", "originalCommit": "25a13d2eef68c047ae4ce5d17c5b830cf6a520b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjA1ODEzOA==", "url": "https://github.com/apache/lucene-solr/pull/2085#discussion_r526058138", "bodyText": "it's more clear that way what is closed first which is important here. That's why I do it this way.", "author": "s1monw", "createdAt": "2020-11-18T12:44:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjAzMjk0Mg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjAzMzgzNw==", "url": "https://github.com/apache/lucene-solr/pull/2085#discussion_r526033837", "bodyText": "oh, wonderful.", "author": "dweiss", "createdAt": "2020-11-18T12:02:27Z", "path": "lucene/core/src/java/org/apache/lucene/index/DocumentsWriter.java", "diffHunk": "@@ -371,19 +371,15 @@ public void close() throws IOException {\n   private boolean preUpdate() throws IOException {\n     ensureOpen();\n     boolean hasEvents = false;\n-\n-    if (flushControl.anyStalledThreads() || (flushControl.numQueuedFlushes() > 0 && config.checkPendingFlushOnUpdate)) {", "originalCommit": "25a13d2eef68c047ae4ce5d17c5b830cf6a520b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjA1ODI5OA==", "url": "https://github.com/apache/lucene-solr/pull/2085#discussion_r526058298", "bodyText": "yeah, details...", "author": "s1monw", "createdAt": "2020-11-18T12:44:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjAzMzgzNw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "a8b74923629772d4a40507a93058bca0c53eb1f5", "url": "https://github.com/apache/lucene-solr/commit/a8b74923629772d4a40507a93058bca0c53eb1f5", "message": "Merge branch 'master' into LUCENE-9508", "committedDate": "2020-11-24T10:52:17Z", "type": "commit"}]}