{"pr_number": 1350, "pr_title": "Cleanup DWPT for readability", "pr_createdAt": "2020-03-13T20:04:32Z", "pr_url": "https://github.com/apache/lucene-solr/pull/1350", "timeline": [{"oid": "faf185ab97d3b030f83072aa48d3b73d71d59118", "url": "https://github.com/apache/lucene-solr/commit/faf185ab97d3b030f83072aa48d3b73d71d59118", "message": "Cleanup DWPT for readability\n\nDWPT had some complicated logic to account for failures etc.\nThis change cleans up this logic and simplifies the document processing\nloop", "committedDate": "2020-03-13T20:02:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU4OTY0OQ==", "url": "https://github.com/apache/lucene-solr/pull/1350#discussion_r392589649", "bodyText": "nit:  add spaces around -", "author": "dnhatn", "createdAt": "2020-03-14T13:46:46Z", "path": "lucene/core/src/java/org/apache/lucene/index/DocumentsWriterPerThread.java", "diffHunk": "@@ -249,34 +247,19 @@ public long updateDocuments(Iterable<? extends Iterable<? extends IndexableField\n           reserveOneDoc();\n           docState.doc = doc;\n           docState.docID = numDocsInRAM;\n-          docCount++;\n-\n-          boolean success = false;\n           try {\n             consumer.processDocument();\n-            success = true;\n           } finally {\n-            if (!success) {\n-              // Incr here because finishDocument will not\n-              // be called (because an exc is being thrown):\n-              numDocsInRAM++;\n-            }\n+            numDocsInRAM++; // we count the doc anyway even in the case of an exception\n           }\n-\n-          numDocsInRAM++;\n         }\n         allDocsIndexed = true;\n-        return finishDocuments(deleteNode, docCount);\n+        return finishDocuments(deleteNode, docsInRamBefore);\n       } finally {\n         if (!allDocsIndexed && !aborted) {\n           // the iterator threw an exception that is not aborting\n           // go and mark all docs from this block as deleted\n-          int docID = numDocsInRAM - 1;\n-          final int endDocID = docID - docCount;\n-          while (docID > endDocID) {\n-            deleteDocID(docID);\n-            docID--;\n-          }\n+          deleteLastDocs(numDocsInRAM-docsInRamBefore);", "originalCommit": "faf185ab97d3b030f83072aa48d3b73d71d59118", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8cc383d6a2c3808238954fe8e9a4d208884e5947", "chunk": "diff --git a/lucene/core/src/java/org/apache/lucene/index/DocumentsWriterPerThread.java b/lucene/core/src/java/org/apache/lucene/index/DocumentsWriterPerThread.java\nindex 73e6971fde7..697ced31bde 100644\n--- a/lucene/core/src/java/org/apache/lucene/index/DocumentsWriterPerThread.java\n+++ b/lucene/core/src/java/org/apache/lucene/index/DocumentsWriterPerThread.java\n\n@@ -259,7 +259,7 @@ final class DocumentsWriterPerThread {\n         if (!allDocsIndexed && !aborted) {\n           // the iterator threw an exception that is not aborting\n           // go and mark all docs from this block as deleted\n-          deleteLastDocs(numDocsInRAM-docsInRamBefore);\n+          deleteLastDocs(numDocsInRAM - docsInRamBefore);\n         }\n         docState.clear();\n       }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU4OTY4NA==", "url": "https://github.com/apache/lucene-solr/pull/1350#discussion_r392589684", "bodyText": "Can you update the javadocs (it's a bit stale: a specific docID).", "author": "dnhatn", "createdAt": "2020-03-14T13:47:24Z", "path": "lucene/core/src/java/org/apache/lucene/index/DocumentsWriterPerThread.java", "diffHunk": "@@ -318,8 +301,10 @@ private long finishDocuments(DocumentsWriterDeleteQueue.Node<?> deleteNode, int\n \n   // Buffer a specific docID for deletion. Currently only\n   // used when we hit an exception when adding a document\n-  void deleteDocID(int docIDUpto) {\n-    pendingUpdates.addDocID(docIDUpto);\n+  private void deleteLastDocs(int docCount) {", "originalCommit": "faf185ab97d3b030f83072aa48d3b73d71d59118", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8cc383d6a2c3808238954fe8e9a4d208884e5947", "chunk": "diff --git a/lucene/core/src/java/org/apache/lucene/index/DocumentsWriterPerThread.java b/lucene/core/src/java/org/apache/lucene/index/DocumentsWriterPerThread.java\nindex 73e6971fde7..697ced31bde 100644\n--- a/lucene/core/src/java/org/apache/lucene/index/DocumentsWriterPerThread.java\n+++ b/lucene/core/src/java/org/apache/lucene/index/DocumentsWriterPerThread.java\n\n@@ -299,8 +299,13 @@ final class DocumentsWriterPerThread {\n     return seqNo;\n   }\n \n-  // Buffer a specific docID for deletion. Currently only\n-  // used when we hit an exception when adding a document\n+  // This method marks the last N docs as deleted. This is used\n+  // in the case of a non-aborting exception. There are several cases\n+  // where we fail a document ie. due to an exception during analysis\n+  // that causes the doc to be rejected but won't cause the DWPT to be\n+  // stale nor the entire IW to abort and shutdown. In such a case\n+  // we only mark these docs as deleted and turn it into a livedocs\n+  // during flush\n   private void deleteLastDocs(int docCount) {\n     for (int docId = numDocsInRAM - docCount; docId < numDocsInRAM; docId++) {\n       pendingUpdates.addDocID(docId);\n"}}, {"oid": "ee0e53bc996d129006bb193596ca6df53e41d9a4", "url": "https://github.com/apache/lucene-solr/commit/ee0e53bc996d129006bb193596ca6df53e41d9a4", "message": "Merge branch 'master' into small_dwpt_cleanup", "committedDate": "2020-03-15T07:32:15Z", "type": "commit"}, {"oid": "8cc383d6a2c3808238954fe8e9a4d208884e5947", "url": "https://github.com/apache/lucene-solr/commit/8cc383d6a2c3808238954fe8e9a4d208884e5947", "message": "apply feedback", "committedDate": "2020-03-15T07:36:44Z", "type": "commit"}, {"oid": "e57fa36b19e77ef6d675842d3087d07a3afdb723", "url": "https://github.com/apache/lucene-solr/commit/e57fa36b19e77ef6d675842d3087d07a3afdb723", "message": "some more small nits", "committedDate": "2020-03-15T08:01:39Z", "type": "commit"}, {"oid": "da567eaf41045c95c9f1c580e445dfa54cc4d92d", "url": "https://github.com/apache/lucene-solr/commit/da567eaf41045c95c9f1c580e445dfa54cc4d92d", "message": "Merge branch 'master' into small_dwpt_cleanup", "committedDate": "2020-03-15T08:08:48Z", "type": "commit"}]}