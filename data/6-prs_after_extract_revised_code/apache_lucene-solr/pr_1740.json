{"pr_number": 1740, "pr_title": "LUCENE-9458: WDGF and WDF should tie-break by endOffset", "pr_createdAt": "2020-08-11T21:45:00Z", "pr_url": "https://github.com/apache/lucene-solr/pull/1740", "timeline": [{"oid": "8be34cd3337bb5b9e7a4e892130f2e3cb7e9c28b", "url": "https://github.com/apache/lucene-solr/commit/8be34cd3337bb5b9e7a4e892130f2e3cb7e9c28b", "message": "LUCENE-9458: WDGF and WDF should tie-break by endOffset\nCan happen with catenateAll and not generating word xor number part when the input ends with the non-generated sub-token.", "committedDate": "2020-08-11T21:42:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE2MzMxOQ==", "url": "https://github.com/apache/lucene-solr/pull/1740#discussion_r470163319", "bodyText": "@bruno-roustant pointed out to me that the existing comparison here looks faulty -- notice it's doing the later position due to the swap of \"j\" and \"i\".  This is how it was before.  I think it's wrong, and makes me suspect that it's likely this comparison yields a zero.  If true, this is more evidence that suggest the sort can merely look at start & end offsets.", "author": "dsmiley", "createdAt": "2020-08-13T18:33:10Z", "path": "lucene/analysis/common/src/java/org/apache/lucene/analysis/miscellaneous/WordDelimiterFilter.java", "diffHunk": "@@ -398,10 +399,20 @@ public void reset() throws IOException {\n   private class OffsetSorter extends InPlaceMergeSorter {\n     @Override\n     protected int compare(int i, int j) {\n+      // earlier start offset\n       int cmp = Integer.compare(startOff[i], startOff[j]);\n-      if (cmp == 0) {\n-        cmp = Integer.compare(posInc[j], posInc[i]);\n+      if (cmp != 0) {\n+        return cmp;\n       }\n+      \n+      // earlier position\n+      cmp = Integer.compare(posInc[j], posInc[i]);", "originalCommit": "8be34cd3337bb5b9e7a4e892130f2e3cb7e9c28b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6c6a6bc519e4631f41d657d602f0b28be9470c16", "chunk": "diff --git a/lucene/analysis/common/src/java/org/apache/lucene/analysis/miscellaneous/WordDelimiterFilter.java b/lucene/analysis/common/src/java/org/apache/lucene/analysis/miscellaneous/WordDelimiterFilter.java\nindex aedd250abac..4124e846c46 100644\n--- a/lucene/analysis/common/src/java/org/apache/lucene/analysis/miscellaneous/WordDelimiterFilter.java\n+++ b/lucene/analysis/common/src/java/org/apache/lucene/analysis/miscellaneous/WordDelimiterFilter.java\n\n@@ -399,20 +398,10 @@ public final class WordDelimiterFilter extends TokenFilter {\n   private class OffsetSorter extends InPlaceMergeSorter {\n     @Override\n     protected int compare(int i, int j) {\n-      // earlier start offset\n       int cmp = Integer.compare(startOff[i], startOff[j]);\n-      if (cmp != 0) {\n-        return cmp;\n+      if (cmp == 0) {\n+        cmp = Integer.compare(posInc[j], posInc[i]);\n       }\n-      \n-      // earlier position\n-      cmp = Integer.compare(posInc[j], posInc[i]);\n-      if (cmp != 0) {\n-        return cmp;\n-      }\n-      \n-      // later end offset\n-      cmp = Integer.compare(endOff[j], endOff[i]);\n       return cmp;\n     }\n \n"}}, {"oid": "4663df971931090b56542804178c34bac8a579b7", "url": "https://github.com/apache/lucene-solr/commit/4663df971931090b56542804178c34bac8a579b7", "message": "Fuzzing revealed that only start & end offsets are needed to order sub-tokens.", "committedDate": "2020-09-21T19:53:18Z", "type": "commit"}, {"oid": "6c6a6bc519e4631f41d657d602f0b28be9470c16", "url": "https://github.com/apache/lucene-solr/commit/6c6a6bc519e4631f41d657d602f0b28be9470c16", "message": "Reverted WDF changes.\n WDF is a problem still but left it as-is because I'm suspicious my solution introduces a bug.", "committedDate": "2020-09-21T19:59:18Z", "type": "commit"}, {"oid": "4a338f0b18efa5df612ab693f332ea84e622cf03", "url": "https://github.com/apache/lucene-solr/commit/4a338f0b18efa5df612ab693f332ea84e622cf03", "message": "Merge branch 'master' into lucene9458_wdf_useEndOffsetForOrder", "committedDate": "2020-10-02T02:20:21Z", "type": "commit"}, {"oid": "abb2aeba17d3a92854be0a63e6dfb9234137d3b3", "url": "https://github.com/apache/lucene-solr/commit/abb2aeba17d3a92854be0a63e6dfb9234137d3b3", "message": "CHANGES.txt", "committedDate": "2020-10-02T02:24:36Z", "type": "commit"}]}