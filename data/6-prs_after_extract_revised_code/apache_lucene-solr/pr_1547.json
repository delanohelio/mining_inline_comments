{"pr_number": 1547, "pr_title": "SOLR-14525 For components loaded from packages SolrCoreAware, ResourceLoaderAware are not honored", "pr_createdAt": "2020-05-31T09:54:38Z", "pr_url": "https://github.com/apache/lucene-solr/pull/1547", "timeline": [{"oid": "3ebe3861d079a70431dd165ce65f099cde156521", "url": "https://github.com/apache/lucene-solr/commit/3ebe3861d079a70431dd165ce65f099cde156521", "message": "For components loaded from packages SolrCoreAware, ResourceLoaderAware are not honored", "committedDate": "2020-05-31T09:53:33Z", "type": "commit"}, {"oid": "918cb0c81cfc3ff4161eca4221aef617c167a587", "url": "https://github.com/apache/lucene-solr/commit/918cb0c81cfc3ff4161eca4221aef617c167a587", "message": "removed unused imports", "committedDate": "2020-06-01T00:34:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzAyNjQ5Nw==", "url": "https://github.com/apache/lucene-solr/pull/1547#discussion_r433026497", "bodyText": "Can you please configure your IDE to put java.* import statements up front instead of below?", "author": "dsmiley", "createdAt": "2020-06-01T03:23:18Z", "path": "solr/core/src/java/org/apache/solr/pkg/PackageLoader.java", "diffHunk": "@@ -17,31 +17,25 @@\n \n package org.apache.solr.pkg;\n \n-import java.io.Closeable;\n-import java.io.IOException;\n-import java.lang.invoke.MethodHandles;\n-import java.nio.file.Path;\n-import java.nio.file.Paths;\n-import java.util.ArrayList;\n-import java.util.Collection;\n-import java.util.Collections;\n-import java.util.HashMap;\n-import java.util.HashSet;\n-import java.util.List;\n-import java.util.Map;\n-import java.util.Objects;\n-import java.util.Set;\n-import java.util.concurrent.ConcurrentHashMap;\n-import java.util.concurrent.CopyOnWriteArrayList;\n-\n+import org.apache.lucene.analysis.util.ResourceLoaderAware;\n import org.apache.solr.common.MapWriter;\n+import org.apache.solr.common.SolrException;\n import org.apache.solr.common.cloud.ZkStateReader;\n import org.apache.solr.core.CoreContainer;\n import org.apache.solr.core.SolrCore;\n import org.apache.solr.core.SolrResourceLoader;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n+import java.io.Closeable;", "originalCommit": "918cb0c81cfc3ff4161eca4221aef617c167a587", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE0Njk4NA==", "url": "https://github.com/apache/lucene-solr/pull/1547#discussion_r433146984", "bodyText": "OK", "author": "noblepaul", "createdAt": "2020-06-01T10:02:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzAyNjQ5Nw=="}], "type": "inlineReview", "revised_code": {"commit": "4efd54232b796f33d46060efb367a568ae55a810", "chunk": "diff --git a/solr/core/src/java/org/apache/solr/pkg/PackageLoader.java b/solr/core/src/java/org/apache/solr/pkg/PackageLoader.java\nindex 7c3104adff2..92fe587f49d 100644\n--- a/solr/core/src/java/org/apache/solr/pkg/PackageLoader.java\n+++ b/solr/core/src/java/org/apache/solr/pkg/PackageLoader.java\n\n@@ -17,16 +17,6 @@\n \n package org.apache.solr.pkg;\n \n-import org.apache.lucene.analysis.util.ResourceLoaderAware;\n-import org.apache.solr.common.MapWriter;\n-import org.apache.solr.common.SolrException;\n-import org.apache.solr.common.cloud.ZkStateReader;\n-import org.apache.solr.core.CoreContainer;\n-import org.apache.solr.core.SolrCore;\n-import org.apache.solr.core.SolrResourceLoader;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n-\n import java.io.Closeable;\n import java.io.IOException;\n import java.lang.invoke.MethodHandles;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzAyNjc3NQ==", "url": "https://github.com/apache/lucene-solr/pull/1547#discussion_r433026775", "bodyText": "incomplete comment?  Could use an explanation as to why. SolrCoreAware isn't handled here.", "author": "dsmiley", "createdAt": "2020-06-01T03:25:14Z", "path": "solr/core/src/java/org/apache/solr/pkg/PackageLoader.java", "diffHunk": "@@ -301,6 +295,32 @@ public String toString() {\n       }\n     }\n   }\n+  static class PackageResourceLoader extends SolrResourceLoader {\n+\n+    PackageResourceLoader(String name, List<Path> classpath, Path instanceDir, ClassLoader parent) {\n+      super(name, classpath, instanceDir, parent);\n+    }\n+\n+    @Override\n+    public <T> boolean addToCoreAware(T obj) {\n+      //do not do anything\n+      //this class is", "originalCommit": "918cb0c81cfc3ff4161eca4221aef617c167a587", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4efd54232b796f33d46060efb367a568ae55a810", "chunk": "diff --git a/solr/core/src/java/org/apache/solr/pkg/PackageLoader.java b/solr/core/src/java/org/apache/solr/pkg/PackageLoader.java\nindex 7c3104adff2..92fe587f49d 100644\n--- a/solr/core/src/java/org/apache/solr/pkg/PackageLoader.java\n+++ b/solr/core/src/java/org/apache/solr/pkg/PackageLoader.java\n\n@@ -304,21 +301,18 @@ public class PackageLoader implements Closeable {\n     @Override\n     public <T> boolean addToCoreAware(T obj) {\n       //do not do anything\n-      //this class is\n+      //this class is not aware of a SolrCore and it is totally not tied to\n+      // the lifecycle of SolrCore. So, this returns 'false' & it should be\n+      // taken care of by the caller\n       return false;\n     }\n \n     @Override\n     public <T> boolean addToResourceLoaderAware(T obj) {\n-      if (obj instanceof ResourceLoaderAware) {\n-        assertAwareCompatibility(ResourceLoaderAware.class, obj);\n-        try {\n-          ((ResourceLoaderAware) obj).inform(this);\n-        } catch (IOException e) {\n-          throw new SolrException(SolrException.ErrorCode.SERVER_ERROR, e);\n-        }\n-      }\n-     return true;\n+      // do not do anything\n+      // this should be invoked only after the init() is invoked.\n+      // The caller should take care of that\n+      return false;\n     }\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzAyNzk3MA==", "url": "https://github.com/apache/lucene-solr/pull/1547#discussion_r433027970", "bodyText": "Lets figure out why the base class doesn't just immediately call inform like this here.  What test then fails?  I've read an interesting JIRA issue: https://issues.apache.org/jira/browse/SOLR-8311  (lots of info there; I recommend reading all of it)  It's been on my mind for some time now actually since when I was cleaning up SolrResourceLoader since this \"live\" wart seems like a hack.", "author": "dsmiley", "createdAt": "2020-06-01T03:33:15Z", "path": "solr/core/src/java/org/apache/solr/pkg/PackageLoader.java", "diffHunk": "@@ -301,6 +295,32 @@ public String toString() {\n       }\n     }\n   }\n+  static class PackageResourceLoader extends SolrResourceLoader {\n+\n+    PackageResourceLoader(String name, List<Path> classpath, Path instanceDir, ClassLoader parent) {\n+      super(name, classpath, instanceDir, parent);\n+    }\n+\n+    @Override\n+    public <T> boolean addToCoreAware(T obj) {\n+      //do not do anything\n+      //this class is\n+      return false;\n+    }\n+\n+    @Override\n+    public <T> boolean addToResourceLoaderAware(T obj) {\n+      if (obj instanceof ResourceLoaderAware) {\n+        assertAwareCompatibility(ResourceLoaderAware.class, obj);\n+        try {\n+          ((ResourceLoaderAware) obj).inform(this);", "originalCommit": "918cb0c81cfc3ff4161eca4221aef617c167a587", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE1NjQyMg==", "url": "https://github.com/apache/lucene-solr/pull/1547#discussion_r433156422", "bodyText": "I think the order has to be\n\ncreate instance\ninit()\nSolrCoreAware.inform() , ResourceLoaderAware.inform()\n\nI've made the relevant changes. Pls review", "author": "noblepaul", "createdAt": "2020-06-01T10:25:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzAyNzk3MA=="}], "type": "inlineReview", "revised_code": {"commit": "4efd54232b796f33d46060efb367a568ae55a810", "chunk": "diff --git a/solr/core/src/java/org/apache/solr/pkg/PackageLoader.java b/solr/core/src/java/org/apache/solr/pkg/PackageLoader.java\nindex 7c3104adff2..92fe587f49d 100644\n--- a/solr/core/src/java/org/apache/solr/pkg/PackageLoader.java\n+++ b/solr/core/src/java/org/apache/solr/pkg/PackageLoader.java\n\n@@ -304,21 +301,18 @@ public class PackageLoader implements Closeable {\n     @Override\n     public <T> boolean addToCoreAware(T obj) {\n       //do not do anything\n-      //this class is\n+      //this class is not aware of a SolrCore and it is totally not tied to\n+      // the lifecycle of SolrCore. So, this returns 'false' & it should be\n+      // taken care of by the caller\n       return false;\n     }\n \n     @Override\n     public <T> boolean addToResourceLoaderAware(T obj) {\n-      if (obj instanceof ResourceLoaderAware) {\n-        assertAwareCompatibility(ResourceLoaderAware.class, obj);\n-        try {\n-          ((ResourceLoaderAware) obj).inform(this);\n-        } catch (IOException e) {\n-          throw new SolrException(SolrException.ErrorCode.SERVER_ERROR, e);\n-        }\n-      }\n-     return true;\n+      // do not do anything\n+      // this should be invoked only after the init() is invoked.\n+      // The caller should take care of that\n+      return false;\n     }\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzAyODU5Nw==", "url": "https://github.com/apache/lucene-solr/pull/1547#discussion_r433028597", "bodyText": "Aha; makes sense.", "author": "dsmiley", "createdAt": "2020-06-01T03:37:30Z", "path": "solr/core/src/java/org/apache/solr/pkg/PackagePluginHolder.java", "diffHunk": "@@ -117,6 +114,13 @@ protected void initNewInstance(PackageLoader.Package.Version newest) {\n     Object instance = SolrCore.createInstance(pluginInfo.className,\n         pluginMeta.clazz, pluginMeta.getCleanTag(), core, newest.getLoader());\n     PluginBag.initInstance(instance, pluginInfo);\n+    if (instance instanceof SolrCoreAware) {", "originalCommit": "918cb0c81cfc3ff4161eca4221aef617c167a587", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4efd54232b796f33d46060efb367a568ae55a810", "chunk": "diff --git a/solr/core/src/java/org/apache/solr/pkg/PackagePluginHolder.java b/solr/core/src/java/org/apache/solr/pkg/PackagePluginHolder.java\nindex 852daf4d05f..64282bed3f1 100644\n--- a/solr/core/src/java/org/apache/solr/pkg/PackagePluginHolder.java\n+++ b/solr/core/src/java/org/apache/solr/pkg/PackagePluginHolder.java\n\n@@ -114,13 +116,7 @@ public class PackagePluginHolder<T> extends PluginBag.PluginHolder<T> {\n     Object instance = SolrCore.createInstance(pluginInfo.className,\n         pluginMeta.clazz, pluginMeta.getCleanTag(), core, newest.getLoader());\n     PluginBag.initInstance(instance, pluginInfo);\n-    if (instance instanceof SolrCoreAware) {\n-      SolrCoreAware coreAware = (SolrCoreAware) instance;\n-      if (!core.getResourceLoader().addToCoreAware(coreAware)) {\n-        //returns false if the core was fully initialized\n-        coreAware.inform(core);\n-      }\n-    }\n+    handleAwareCallbacks(newest.getLoader(), instance);\n     T old = inst;\n     inst = (T) instance;\n     if (old instanceof AutoCloseable) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzAyOTM3Mg==", "url": "https://github.com/apache/lucene-solr/pull/1547#discussion_r433029372", "bodyText": "Should this not be in its own method now too?", "author": "dsmiley", "createdAt": "2020-06-01T03:42:27Z", "path": "solr/core/src/java/org/apache/solr/core/SolrResourceLoader.java", "diffHunk": "@@ -566,25 +566,42 @@ static void clearCache() {\n \n     } catch (Exception e) {\n       throw new SolrException(SolrException.ErrorCode.SERVER_ERROR,\n-          \"Error instantiating class: '\" + clazz.getName() + \"'\", e);\n+              \"Error instantiating class: '\" + clazz.getName() + \"'\", e);\n     }\n \n-    if (!live) {\n-      if (obj instanceof SolrCoreAware) {\n-        assertAwareCompatibility(SolrCoreAware.class, obj);\n-        waitingForCore.add((SolrCoreAware) obj);\n+    addToCoreAware(obj);\n+    addToResourceLoaderAware(obj);\n+    if(!live) {", "originalCommit": "918cb0c81cfc3ff4161eca4221aef617c167a587", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4efd54232b796f33d46060efb367a568ae55a810", "chunk": "diff --git a/solr/core/src/java/org/apache/solr/core/SolrResourceLoader.java b/solr/core/src/java/org/apache/solr/core/SolrResourceLoader.java\nindex 991b1c78e48..2cd35e82d01 100644\n--- a/solr/core/src/java/org/apache/solr/core/SolrResourceLoader.java\n+++ b/solr/core/src/java/org/apache/solr/core/SolrResourceLoader.java\n\n@@ -592,6 +577,10 @@ public class SolrResourceLoader implements ResourceLoader, Closeable {\n     }\n   }\n \n+  /** the inform() callback should be invoked on the listener.\n+   * If this is 'live', the callback is not called so currently this returns 'false'\n+   *\n+   */\n   public <T> boolean addToCoreAware(T obj) {\n     if (!live) {\n       if (obj instanceof SolrCoreAware) {\n"}}, {"oid": "4efd54232b796f33d46060efb367a568ae55a810", "url": "https://github.com/apache/lucene-solr/commit/4efd54232b796f33d46060efb367a568ae55a810", "message": "change the invocation order of ResourceLoader.infor()", "committedDate": "2020-06-01T10:26:48Z", "type": "commit"}, {"oid": "4c7e03f55f177851215716c43d2fc15eeafa4b46", "url": "https://github.com/apache/lucene-solr/commit/4c7e03f55f177851215716c43d2fc15eeafa4b46", "message": "move adding info beans to separate method", "committedDate": "2020-06-01T23:15:11Z", "type": "commit"}, {"oid": "4ef305b94a16a694742da78c7fe0129fbfb736e9", "url": "https://github.com/apache/lucene-solr/commit/4ef305b94a16a694742da78c7fe0129fbfb736e9", "message": "merging with master", "committedDate": "2020-06-01T23:17:54Z", "type": "commit"}, {"oid": "0fbb4c26de45f00c4fae4ad88d6dc53b88885ade", "url": "https://github.com/apache/lucene-solr/commit/0fbb4c26de45f00c4fae4ad88d6dc53b88885ade", "message": "Revert \"merging with master\"\n\nThis reverts commit 4ef305b94a16a694742da78c7fe0129fbfb736e9.\n\nreverting last commit", "committedDate": "2020-06-01T23:21:16Z", "type": "commit"}, {"oid": "610ae82bebcb88e1c228372380c38732826279b0", "url": "https://github.com/apache/lucene-solr/commit/610ae82bebcb88e1c228372380c38732826279b0", "message": "CHANGES.txt", "committedDate": "2020-06-01T23:24:47Z", "type": "commit"}, {"oid": "fff3a6b7d92efbe4b7040d39b686680ce26bd8f4", "url": "https://github.com/apache/lucene-solr/commit/fff3a6b7d92efbe4b7040d39b686680ce26bd8f4", "message": "Merge branch 'master' into jira/solr14525", "committedDate": "2020-06-01T23:26:03Z", "type": "commit"}]}