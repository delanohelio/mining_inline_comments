{"pr_number": 1359, "pr_title": "SOLR-13101: Make dir hash computation optional and resilient", "pr_createdAt": "2020-03-18T00:17:55Z", "pr_url": "https://github.com/apache/lucene-solr/pull/1359", "timeline": [{"oid": "68988462cb3472345a60c914c8423b63f6e879c3", "url": "https://github.com/apache/lucene-solr/commit/68988462cb3472345a60c914c8423b63f6e879c3", "message": "Make dir hash computation optional and resilient", "committedDate": "2020-03-18T00:12:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU4OTIzNQ==", "url": "https://github.com/apache/lucene-solr/pull/1359#discussion_r394589235", "bodyText": "If directory hash was not computed I would throw IllegalStateException instead of returning false. This will help identify the programming error faster.", "author": "mbwaheed", "createdAt": "2020-03-18T19:28:46Z", "path": "solr/core/src/java/org/apache/solr/store/blob/metadata/ServerSideMetadata.java", "diffHunk": "@@ -214,23 +228,23 @@ public String getDirectoryHash() {\n \n   /**\n    * Returns <code>true</code> if the contents of the directory passed into this method is identical to the contents of\n-   * the directory of the Solr core of this instance, taken at instance creation time.<p>\n+   * the directory of the Solr core of this instance, taken at instance creation time. If the directory hash was not \n+   * computed at the instance creation time, then this returns <code>false</code>", "originalCommit": "68988462cb3472345a60c914c8423b63f6e879c3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c52294675d52b408a98d227dfa9a40a36b237440", "chunk": "diff --git a/solr/core/src/java/org/apache/solr/store/blob/metadata/ServerSideMetadata.java b/solr/core/src/java/org/apache/solr/store/blob/metadata/ServerSideMetadata.java\nindex f1160bb5468..d12797bda3e 100644\n--- a/solr/core/src/java/org/apache/solr/store/blob/metadata/ServerSideMetadata.java\n+++ b/solr/core/src/java/org/apache/solr/store/blob/metadata/ServerSideMetadata.java\n\n@@ -229,13 +232,18 @@ public class ServerSideMetadata {\n   /**\n    * Returns <code>true</code> if the contents of the directory passed into this method is identical to the contents of\n    * the directory of the Solr core of this instance, taken at instance creation time. If the directory hash was not \n-   * computed at the instance creation time, then this returns <code>false</code>\n+   * computed at the instance creation time, then we throw an IllegalStateException indicating a programming error.\n    *\n    * Passing in the Directory (expected to be the directory of the same core used during construction) because it seems\n    * safer than trying to get it again here...\n+   * \n+   * @throw IllegalStateException is this instance was not created with a computed directoryHash \n    */\n   public boolean isSameDirectoryContent(Directory coreDir) throws NoSuchAlgorithmException, IOException {\n-    return directoryHash != null ? directoryHash.equals(getSolrDirectoryHash(coreDir, coreDir.listAll())) : false;\n+    if (directoryHash == null) {\n+      throw new IllegalStateException(\"Directory hash was not computed for the given core\");\n+    }\n+    return directoryHash.equals(getSolrDirectoryHash(coreDir, coreDir.listAll()));\n   }\n \n   /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU5MTEzNA==", "url": "https://github.com/apache/lucene-solr/pull/1359#discussion_r394591134", "bodyText": "Maybe add a short comment explaining the passed value of captureDirHash. Same comment for BlobStoreUtils.java and CorePusher.java.", "author": "mbwaheed", "createdAt": "2020-03-18T19:32:34Z", "path": "solr/core/src/java/org/apache/solr/store/blob/process/CorePullTask.java", "diffHunk": "@@ -286,7 +286,7 @@ void pullCoreFromBlob(boolean isLeaderPulling) throws InterruptedException {\n       }\n \n       // Get local metadata + resolve with blob metadata. Given we're doing a pull, don't need to reserve commit point\n-      ServerSideMetadata serverMetadata = new ServerSideMetadata(pullCoreInfo.getCoreName(), storeManager.getCoreContainer(), false);\n+      ServerSideMetadata serverMetadata = new ServerSideMetadata(pullCoreInfo.getCoreName(), storeManager.getCoreContainer(), false, true);", "originalCommit": "68988462cb3472345a60c914c8423b63f6e879c3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c52294675d52b408a98d227dfa9a40a36b237440", "chunk": "diff --git a/solr/core/src/java/org/apache/solr/store/blob/process/CorePullTask.java b/solr/core/src/java/org/apache/solr/store/blob/process/CorePullTask.java\nindex 0af591b0264..a5aeed58005 100644\n--- a/solr/core/src/java/org/apache/solr/store/blob/process/CorePullTask.java\n+++ b/solr/core/src/java/org/apache/solr/store/blob/process/CorePullTask.java\n\n@@ -286,7 +286,10 @@ public class CorePullTask implements DeduplicatingList.Deduplicatable<String> {\n       }\n \n       // Get local metadata + resolve with blob metadata. Given we're doing a pull, don't need to reserve commit point\n-      ServerSideMetadata serverMetadata = new ServerSideMetadata(pullCoreInfo.getCoreName(), storeManager.getCoreContainer(), false, true);\n+      // We do need to compute a directory hash to verify after pulling or before switching index dirs that no local \n+      // changes occurred concurrently\n+      ServerSideMetadata serverMetadata = new ServerSideMetadata(pullCoreInfo.getCoreName(), storeManager.getCoreContainer(), \n+          /* reserveCommit */ false, /* captureDirHash */ true);\n       SharedMetadataResolutionResult resolutionResult = SharedStoreResolutionUtil.resolveMetadata(\n           serverMetadata, blobMetadata);\n       \n"}}, {"oid": "c52294675d52b408a98d227dfa9a40a36b237440", "url": "https://github.com/apache/lucene-solr/commit/c52294675d52b408a98d227dfa9a40a36b237440", "message": "Throw illegalstateexception and update comments", "committedDate": "2020-03-18T22:53:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcwNTAzNA==", "url": "https://github.com/apache/lucene-solr/pull/1359#discussion_r394705034", "bodyText": "typo: is=if?", "author": "mbwaheed", "createdAt": "2020-03-18T23:55:16Z", "path": "solr/core/src/java/org/apache/solr/store/blob/metadata/ServerSideMetadata.java", "diffHunk": "@@ -212,9 +212,12 @@ public long getGeneration() {\n   }\n \n   /**\n-   * @return Null if the directory hash was not computed for the given Core \n+   * @throw IllegalStateException is this instance was not created with a computed directoryHash ", "originalCommit": "c52294675d52b408a98d227dfa9a40a36b237440", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcwNzIwNg==", "url": "https://github.com/apache/lucene-solr/pull/1359#discussion_r394707206", "bodyText": "Actually I don't see this method being used any where. It'll be better to delete the method.", "author": "mbwaheed", "createdAt": "2020-03-19T00:02:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcwNTAzNA=="}], "type": "inlineReview", "revised_code": {"commit": "ae7b23302c77d0c29804a3d15c7ab7893f5d9196", "chunk": "diff --git a/solr/core/src/java/org/apache/solr/store/blob/metadata/ServerSideMetadata.java b/solr/core/src/java/org/apache/solr/store/blob/metadata/ServerSideMetadata.java\nindex d12797bda3e..0ccb93a9168 100644\n--- a/solr/core/src/java/org/apache/solr/store/blob/metadata/ServerSideMetadata.java\n+++ b/solr/core/src/java/org/apache/solr/store/blob/metadata/ServerSideMetadata.java\n\n@@ -211,16 +211,6 @@ public class ServerSideMetadata {\n     return this.generation;\n   }\n \n-  /**\n-   * @throw IllegalStateException is this instance was not created with a computed directoryHash \n-   */\n-  public String getDirectoryHash() {\n-    if (this.directoryHash == null) {\n-      throw new IllegalStateException(\"Directory hash was not computed for the given core\");\n-    }\n-    return this.directoryHash;\n-  }\n-\n   public ImmutableCollection<CoreFileData> getLatestCommitFiles(){\n     return this.latestCommitFiles;\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcwNzQ2MQ==", "url": "https://github.com/apache/lucene-solr/pull/1359#discussion_r394707461", "bodyText": "typo is=if?", "author": "mbwaheed", "createdAt": "2020-03-19T00:03:26Z", "path": "solr/core/src/java/org/apache/solr/store/blob/metadata/ServerSideMetadata.java", "diffHunk": "@@ -229,13 +232,18 @@ public String getDirectoryHash() {\n   /**\n    * Returns <code>true</code> if the contents of the directory passed into this method is identical to the contents of\n    * the directory of the Solr core of this instance, taken at instance creation time. If the directory hash was not \n-   * computed at the instance creation time, then this returns <code>false</code>\n+   * computed at the instance creation time, then we throw an IllegalStateException indicating a programming error.\n    *\n    * Passing in the Directory (expected to be the directory of the same core used during construction) because it seems\n    * safer than trying to get it again here...\n+   * \n+   * @throw IllegalStateException is this instance was not created with a computed directoryHash ", "originalCommit": "c52294675d52b408a98d227dfa9a40a36b237440", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ae7b23302c77d0c29804a3d15c7ab7893f5d9196", "chunk": "diff --git a/solr/core/src/java/org/apache/solr/store/blob/metadata/ServerSideMetadata.java b/solr/core/src/java/org/apache/solr/store/blob/metadata/ServerSideMetadata.java\nindex d12797bda3e..0ccb93a9168 100644\n--- a/solr/core/src/java/org/apache/solr/store/blob/metadata/ServerSideMetadata.java\n+++ b/solr/core/src/java/org/apache/solr/store/blob/metadata/ServerSideMetadata.java\n\n@@ -237,7 +227,7 @@ public class ServerSideMetadata {\n    * Passing in the Directory (expected to be the directory of the same core used during construction) because it seems\n    * safer than trying to get it again here...\n    * \n-   * @throw IllegalStateException is this instance was not created with a computed directoryHash \n+   * @throw IllegalStateException if this instance was not created with a computed directoryHash \n    */\n   public boolean isSameDirectoryContent(Directory coreDir) throws NoSuchAlgorithmException, IOException {\n     if (directoryHash == null) {\n"}}, {"oid": "ae7b23302c77d0c29804a3d15c7ab7893f5d9196", "url": "https://github.com/apache/lucene-solr/commit/ae7b23302c77d0c29804a3d15c7ab7893f5d9196", "message": "Delete unused method, fix typo", "committedDate": "2020-03-19T00:14:41Z", "type": "commit"}]}