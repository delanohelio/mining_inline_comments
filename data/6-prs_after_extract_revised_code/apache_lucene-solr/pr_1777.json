{"pr_number": 1777, "pr_title": "LUCENE-9477: Don't leave potentially broken segments file behind", "pr_createdAt": "2020-08-24T10:07:45Z", "pr_url": "https://github.com/apache/lucene-solr/pull/1777", "timeline": [{"oid": "b8f68e9b019151391dda1d93f08b8d2f66eff9ed", "url": "https://github.com/apache/lucene-solr/commit/b8f68e9b019151391dda1d93f08b8d2f66eff9ed", "message": "LUCENE-9477: Don't leave potentially broken segments file behind\n\nIf we fail to rollback an already renamed pending segments file during\ncommit due to a failure in directory syncing we might not fully roll back\nto a proper state if we hit a failure during rollback which leaves the index\nin a broken state. This is a best effort approach to remove the renamed file\nin the case of a failure during sync.", "committedDate": "2020-08-24T10:05:00Z", "type": "commit"}, {"oid": "c1fcf00f2e314b51a82ac8914084c80f68925e54", "url": "https://github.com/apache/lucene-solr/commit/c1fcf00f2e314b51a82ac8914084c80f68925e54", "message": "remove sysout", "committedDate": "2020-08-24T10:08:21Z", "type": "commit"}, {"oid": "8aff469b99dea98a94e9b8d0600cf51b0280f590", "url": "https://github.com/apache/lucene-solr/commit/8aff469b99dea98a94e9b8d0600cf51b0280f590", "message": "fix test", "committedDate": "2020-08-24T10:12:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU1NjE4MA==", "url": "https://github.com/apache/lucene-solr/pull/1777#discussion_r475556180", "bodyText": "Our wild randomized testing infra was throwing an exception, rarely, in syncMetaData?", "author": "mikemccand", "createdAt": "2020-08-24T12:15:50Z", "path": "lucene/core/src/java/org/apache/lucene/index/SegmentInfos.java", "diffHunk": "@@ -836,16 +835,24 @@ final String finishCommit(Directory dir) throws IOException {\n     if (pendingCommit == false) {\n       throw new IllegalStateException(\"prepareCommit was not called\");\n     }\n-    boolean success = false;\n+    boolean successRenameAndSync = false;\n     final String dest;\n     try {\n       final String src = IndexFileNames.fileNameFromGeneration(IndexFileNames.PENDING_SEGMENTS, \"\", generation);\n       dest = IndexFileNames.fileNameFromGeneration(IndexFileNames.SEGMENTS, \"\", generation);\n       dir.rename(src, dest);\n-      dir.syncMetaData();\n-      success = true;\n+      try {\n+        dir.syncMetaData();", "originalCommit": "8aff469b99dea98a94e9b8d0600cf51b0280f590", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}