{"pr_number": 1384, "pr_title": "Remove CurrentCoreDescriptorProvider", "pr_createdAt": "2020-03-27T14:48:09Z", "pr_url": "https://github.com/apache/lucene-solr/pull/1384", "timeline": [{"oid": "a07bcd7e18498acd43c8ec18fd94a1fb8b0dd3fc", "url": "https://github.com/apache/lucene-solr/commit/a07bcd7e18498acd43c8ec18fd94a1fb8b0dd3fc", "message": "Remove CurrentCoreDescriptorProvider\n\nReplace `CurrentCoreDescriptorProvider` with a functional interface so\nthat it is easier to construct since all implementations in our code\nbase were anonymous classes anyway. Added Javadocs explaining the\nusage instead of relying on class name to convey information.", "committedDate": "2020-03-27T14:47:18Z", "type": "commit"}, {"oid": "2451b0a0951599fd9497de771939efa0e7689c8c", "url": "https://github.com/apache/lucene-solr/commit/2451b0a0951599fd9497de771939efa0e7689c8c", "message": "precommit", "committedDate": "2020-03-27T15:35:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2NTAxNA==", "url": "https://github.com/apache/lucene-solr/pull/1384#discussion_r399365014", "bodyText": "I'd prefer that you declare that last parameter as a local typed variable and then pass it in.  This makes it clearer what it is that is being passed to ZkController's c'tor.", "author": "dsmiley", "createdAt": "2020-03-27T15:52:32Z", "path": "solr/core/src/java/org/apache/solr/core/ZkContainer.java", "diffHunk": "@@ -112,20 +111,14 @@ public void initZooKeeper(final CoreContainer cc, CloudConfig config) {\n           throw new ZooKeeperException(SolrException.ErrorCode.SERVER_ERROR,\n               \"A chroot was specified in ZkHost but the znode doesn't exist. \" + zookeeperHost);\n         }\n-        ZkController zkController = new ZkController(cc, zookeeperHost, zkClientConnectTimeout, config,\n-            new CurrentCoreDescriptorProvider() {\n-\n-              @Override\n-              public List<CoreDescriptor> getCurrentDescriptors() {\n-                List<CoreDescriptor> descriptors = new ArrayList<>(\n-                    cc.getLoadedCoreNames().size());\n-                Collection<SolrCore> cores = cc.getCores();\n-                for (SolrCore core : cores) {\n-                  descriptors.add(core.getCoreDescriptor());\n-                }\n-                return descriptors;\n-              }\n-            });\n+        ZkController zkController = new ZkController(cc, zookeeperHost, zkClientConnectTimeout, config, () -> {", "originalCommit": "2451b0a0951599fd9497de771939efa0e7689c8c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "925746521eda200767bc0fa548811302b7807f45", "chunk": "diff --git a/solr/core/src/java/org/apache/solr/core/ZkContainer.java b/solr/core/src/java/org/apache/solr/core/ZkContainer.java\nindex 33c336b4239..e866869e1f8 100644\n--- a/solr/core/src/java/org/apache/solr/core/ZkContainer.java\n+++ b/solr/core/src/java/org/apache/solr/core/ZkContainer.java\n\n@@ -111,15 +112,17 @@ public class ZkContainer {\n           throw new ZooKeeperException(SolrException.ErrorCode.SERVER_ERROR,\n               \"A chroot was specified in ZkHost but the znode doesn't exist. \" + zookeeperHost);\n         }\n-        ZkController zkController = new ZkController(cc, zookeeperHost, zkClientConnectTimeout, config, () -> {\n+\n+        Supplier<List<CoreDescriptor>> descriptorsSupplier = () -> {\n           List<CoreDescriptor> descriptors = new ArrayList<>(cc.getLoadedCoreNames().size());\n           Collection<SolrCore> cores = cc.getCores();\n           for (SolrCore core : cores) {\n             descriptors.add(core.getCoreDescriptor());\n           }\n           return descriptors;\n-        });\n+        };\n \n+        ZkController zkController = new ZkController(cc, zookeeperHost, zkClientConnectTimeout, config, descriptorsSupplier);\n \n         if (zkRun != null && zkServer.getServers().size() > 1 && confDir == null && boostrapConf == false) {\n           // we are part of an ensemble and we are not uploading the config - pause to give the config time\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2ODMxOQ==", "url": "https://github.com/apache/lucene-solr/pull/1384#discussion_r399368319", "bodyText": "I wonder if \"registerOnReconnect\" is not appropriate for the name.  It's named how it's being used but not for what it is.  Imagine how silly if all things were named with such an approach.  Perhaps simply \"descriptorProvider\".  Any way, leave or change as you wish.", "author": "dsmiley", "createdAt": "2020-03-27T15:57:18Z", "path": "solr/core/src/java/org/apache/solr/cloud/ZkController.java", "diffHunk": "@@ -287,7 +288,14 @@ public Object call() throws Exception {\n     }\n   }\n \n-  public ZkController(final CoreContainer cc, String zkServerAddress, int zkClientConnectTimeout, CloudConfig cloudConfig, final CurrentCoreDescriptorProvider registerOnReconnect)\n+  /**\n+   * @param cc Core container associated with this controller. cannot be null.\n+   * @param zkServerAddress where to connect to the zk server\n+   * @param zkClientConnectTimeout timeout in ms\n+   * @param cloudConfig configuration for this controller. TODO: possibly redundant with CoreContainer\n+   * @param registerOnReconnect a provider of the current core descriptors. used to know what to reregister after a reconnect", "originalCommit": "2451b0a0951599fd9497de771939efa0e7689c8c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "925746521eda200767bc0fa548811302b7807f45", "chunk": "diff --git a/solr/core/src/java/org/apache/solr/cloud/ZkController.java b/solr/core/src/java/org/apache/solr/cloud/ZkController.java\nindex 8ac82208d0a..843236a9163 100644\n--- a/solr/core/src/java/org/apache/solr/cloud/ZkController.java\n+++ b/solr/core/src/java/org/apache/solr/cloud/ZkController.java\n\n@@ -293,9 +293,9 @@ public class ZkController implements Closeable {\n    * @param zkServerAddress where to connect to the zk server\n    * @param zkClientConnectTimeout timeout in ms\n    * @param cloudConfig configuration for this controller. TODO: possibly redundant with CoreContainer\n-   * @param registerOnReconnect a provider of the current core descriptors. used to know what to reregister after a reconnect\n+   * @param descriptorsSupplier a supplier of the current core descriptors. used to know which cores to re-register on reconnect\n    */\n-  public ZkController(final CoreContainer cc, String zkServerAddress, int zkClientConnectTimeout, CloudConfig cloudConfig, final Supplier<List<CoreDescriptor>> registerOnReconnect)\n+  public ZkController(final CoreContainer cc, String zkServerAddress, int zkClientConnectTimeout, CloudConfig cloudConfig, final Supplier<List<CoreDescriptor>> descriptorsSupplier)\n       throws InterruptedException, TimeoutException, IOException {\n \n     if (cc == null) throw new IllegalArgumentException(\"CoreContainer cannot be null.\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2ODc2Ng==", "url": "https://github.com/apache/lucene-solr/pull/1384#discussion_r399368766", "bodyText": "Just looking in GitHub review here but did you omit this param because it's already in scope?", "author": "dsmiley", "createdAt": "2020-03-27T15:57:55Z", "path": "solr/core/src/java/org/apache/solr/cloud/ZkController.java", "diffHunk": "@@ -469,7 +477,7 @@ public boolean isClosed() {\n       if (cc != null) cc.securityNodeChanged();\n     });\n \n-    init(registerOnReconnect);\n+    init();", "originalCommit": "2451b0a0951599fd9497de771939efa0e7689c8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM3MDIyOA==", "url": "https://github.com/apache/lucene-solr/pull/1384#discussion_r399370228", "bodyText": "It was unused in the method.", "author": "madrob", "createdAt": "2020-03-27T15:59:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2ODc2Ng=="}], "type": "inlineReview", "revised_code": null}, {"oid": "925746521eda200767bc0fa548811302b7807f45", "url": "https://github.com/apache/lucene-solr/commit/925746521eda200767bc0fa548811302b7807f45", "message": "Review feedback", "committedDate": "2020-03-27T16:36:32Z", "type": "commit"}]}