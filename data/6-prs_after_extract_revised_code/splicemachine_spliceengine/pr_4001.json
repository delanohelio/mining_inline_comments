{"pr_number": 4001, "pr_title": "DB-9897 Change the default schema of CTEs from current to SESSION", "pr_createdAt": "2020-08-18T13:06:10Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/4001", "timeline": [{"oid": "669deb6b6f55e3d291d2874ed3588f973ddaae2f", "url": "https://github.com/splicemachine/spliceengine/commit/669deb6b6f55e3d291d2874ed3588f973ddaae2f", "message": "DB-9897 Change the default schema of CTEs from current to SESSION", "committedDate": "2020-08-18T12:40:36Z", "type": "commit"}, {"oid": "226b78c6bcb17840eb24bf4867a44d55c38dfd86", "url": "https://github.com/splicemachine/spliceengine/commit/226b78c6bcb17840eb24bf4867a44d55c38dfd86", "message": "DB-9897 Fix test", "committedDate": "2020-08-18T13:38:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjcwNTAyMg==", "url": "https://github.com/splicemachine/spliceengine/pull/4001#discussion_r472705022", "bodyText": "I think we should not remove this check completely, we allow dynamic view to be in session schema, but not regular views. Right now with the change, regular view will be created successfully using the session schema:\nsplice> create view session.v1 as select a1 from t1;\n0 rows inserted/updated/deleted\nELAPSED TIME = 129 milliseconds\nsplice> select * from session.v1;\nERROR XJ001: DERBY SQL error: SQLCODE: -1, SQLSTATE: XJ001, SQLERRMC: java.lang.NullPointerExceptionXJ001.U\nsplice> quit;", "author": "yxia92", "createdAt": "2020-08-19T05:13:47Z", "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/CreateViewNode.java", "diffHunk": "@@ -291,9 +291,6 @@ public void bindStatement() throws StandardException\n \t\t\t//cannot define views on temporary tables\n \t\t\tif (queryExpr instanceof SelectNode)\n \t\t\t{\n-\t\t\t\t//If attempting to reference a SESSION schema table (temporary or permanent) in the view, throw an exception", "originalCommit": "226b78c6bcb17840eb24bf4867a44d55c38dfd86", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk4NjIwMQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4001#discussion_r472986201", "bodyText": "Hmm, I agree that removing the check is not correct. Basically, we want to allow a CTE to reference another CTE, which could be in SESSION schema. But we don't want to allow a normal view to reference any objects in SESSION. I fix this part in the new commit by adding an isDynamic flag to CreateViewNode.\nHowever, the example you showed is also very interesting. Since the check is queryExpr.referencesSessionSchema(), we only check if the view definition references any objects in SESSION schema, not if the view is created under SESSION schema. I tried your example on the latest master, and it causes the same error.\nI think we should definitely disallow this case, too. So in the latest commit, I also improved the condition to make sure we throw if users want to create a view under SESSION. Please take a look if it is good enough.", "author": "ascend1", "createdAt": "2020-08-19T12:21:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjcwNTAyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzM3NzU0Nw==", "url": "https://github.com/splicemachine/spliceengine/pull/4001#discussion_r473377547", "bodyText": "The change looks good to me. A minor comment is that the call with the updated version of this.referencesSessionSchema() completely covers queryExpr.referencesSessionSchema(), so there is some redundancy. Maybe you can leave unchanged, and directly add the check getObjectName().schemaName.equals(SchemaDescriptor.STD_DECLARED_GLOBAL_TEMPORARY_TABLES_SCHEMA_NAME) here?", "author": "yxia92", "createdAt": "2020-08-19T22:14:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjcwNTAyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDA1NTQyNA==", "url": "https://github.com/splicemachine/spliceengine/pull/4001#discussion_r474055424", "bodyText": "Sure, done in the latest commit.", "author": "ascend1", "createdAt": "2020-08-20T15:06:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjcwNTAyMg=="}], "type": "inlineReview", "revised_code": {"commit": "0cd7560726a94cdb92b3f3fc4e5485098ba55653", "chunk": "diff --git a/db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/CreateViewNode.java b/db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/CreateViewNode.java\nindex 9f598100ab..e70344d853 100644\n--- a/db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/CreateViewNode.java\n+++ b/db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/CreateViewNode.java\n\n@@ -291,6 +294,9 @@ public class CreateViewNode extends DDLStatementNode\n \t\t\t//cannot define views on temporary tables\n \t\t\tif (queryExpr instanceof SelectNode)\n \t\t\t{\n+\t\t\t\t//If attempting to reference a SESSION schema table (temporary or permanent) in the view, throw an exception\n+\t\t\t\tif (!isDynamic && (queryExpr.referencesSessionSchema() || this.referencesSessionSchema()))\n+\t\t\t\t\tthrow StandardException.newException(SQLState.LANG_OPERATION_NOT_ALLOWED_ON_SESSION_SCHEMA_TABLES);\n                 // check that no provider is a temp table (whether or not it's in SESSION schema)\n                 for (Provider provider : apl.values()) {\n                     if (provider instanceof TableDescriptor && ! provider.isPersistent()) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjcwNjcwNg==", "url": "https://github.com/splicemachine/spliceengine/pull/4001#discussion_r472706706", "bodyText": "Could you add a test case to test that in two concurrent connections, we can create two dynamic views using the same name under the session schema, and they will not interfere with each other? Thanks!", "author": "yxia92", "createdAt": "2020-08-19T05:16:31Z", "path": "splice_machine/src/test/java/com/splicemachine/derby/impl/sql/execute/operations/WithStatementIT.java", "diffHunk": "@@ -209,5 +231,34 @@ public void testInsertContainingWith() throws Exception {\n         assertEquals(expectedResult, TestUtils.FormattedResult.ResultFactory.toString(rs));\n     }\n \n+    @Test\n+    public void testWithInSchemaNotSufficientPrivilege() throws Exception {\n+        methodWatcher.executeUpdate(\"insert into t12 values (1)\");\n+        String expected = \"I |\\n\" +\n+                \"----\\n\" +\n+                \" 1 |\";\n+\n+        // user with enough privilege, dynamic view in SESSION schema\n+        try (ResultSet rs = methodWatcher.executeQuery(\"with dt as (select * from t12) select * from dt\")) {\n+            assertEquals(expected, TestUtils.FormattedResult.ResultFactory.toString(rs));\n+        }\n+        // user with enough privilege, dynamic view in current schema\n+        try (ResultSet rs = methodWatcher.executeQuery(format(\"with %s.dt as (select * from t12) select * from dt\", SCHEMA))) {\n+            assertEquals(expected, TestUtils.FormattedResult.ResultFactory.toString(rs));\n+        }\n+\n+        try (ResultSet rs = testUserConn.createStatement().executeQuery(\"values current schema\")) {\n+            String expectedSchema = \"1        |\\n\" +\n+                    \"-----------------\\n\" +\n+                    \"WITHSTATEMENTIT |\";\n+            assertEquals(expectedSchema, TestUtils.FormattedResult.ResultFactory.toString(rs));\n+        }\n \n+        // user with no write privilege, dynamic view in SESSION schema\n+        try (ResultSet rs = testUserConn.createStatement().executeQuery(format(\"with dt as (select * from t12) select * from dt\"))) {\n+            assertEquals(expected, TestUtils.FormattedResult.ResultFactory.toString(rs));\n+        }\n+        // user with no write privilege, dynamic view in current schema\n+        assertFailed(testUserConn, format(\"with %s.dt as (select * from t12) select * from dt\", SCHEMA), SQLState.AUTH_NO_ACCESS_NOT_OWNER);\n+    }", "originalCommit": "226b78c6bcb17840eb24bf4867a44d55c38dfd86", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk4MTU4Nw==", "url": "https://github.com/splicemachine/spliceengine/pull/4001#discussion_r472981587", "bodyText": "Done.", "author": "ascend1", "createdAt": "2020-08-19T12:13:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjcwNjcwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzM3ODU2Mg==", "url": "https://github.com/splicemachine/spliceengine/pull/4001#discussion_r473378562", "bodyText": "Thanks!", "author": "yxia92", "createdAt": "2020-08-19T22:16:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjcwNjcwNg=="}], "type": "inlineReview", "revised_code": {"commit": "0cd7560726a94cdb92b3f3fc4e5485098ba55653", "chunk": "diff --git a/splice_machine/src/test/java/com/splicemachine/derby/impl/sql/execute/operations/WithStatementIT.java b/splice_machine/src/test/java/com/splicemachine/derby/impl/sql/execute/operations/WithStatementIT.java\nindex 8959f23315..ac81ec16af 100644\n--- a/splice_machine/src/test/java/com/splicemachine/derby/impl/sql/execute/operations/WithStatementIT.java\n+++ b/splice_machine/src/test/java/com/splicemachine/derby/impl/sql/execute/operations/WithStatementIT.java\n\n@@ -261,4 +280,14 @@ public class WithStatementIT extends SpliceUnitTest {\n         // user with no write privilege, dynamic view in current schema\n         assertFailed(testUserConn, format(\"with %s.dt as (select * from t12) select * from dt\", SCHEMA), SQLState.AUTH_NO_ACCESS_NOT_OWNER);\n     }\n+\n+    @Test\n+    public void testConcurrentDynamicViewCreationWithTheSameName() throws Exception {\n+        Thread t1 = new Thread(new CreateDynamicViewTask(spliceClassWatcher.getOrCreateConnection(), \"dt\"));\n+        Thread t2 = new Thread(new CreateDynamicViewTask(testUserConn, \"dt\"));\n+        t1.start();\n+        t2.start();\n+        t1.join();\n+        t2.join();\n+    }\n }\n"}}, {"oid": "0cd7560726a94cdb92b3f3fc4e5485098ba55653", "url": "https://github.com/splicemachine/spliceengine/commit/0cd7560726a94cdb92b3f3fc4e5485098ba55653", "message": "DB-9897 Address comments", "committedDate": "2020-08-19T10:09:42Z", "type": "commit"}, {"oid": "5ca27a8cc617f1748602bd8d5185d4d639c2d47b", "url": "https://github.com/splicemachine/spliceengine/commit/5ca27a8cc617f1748602bd8d5185d4d639c2d47b", "message": "DB-9897 Address minor comments", "committedDate": "2020-08-20T14:52:59Z", "type": "commit"}]}