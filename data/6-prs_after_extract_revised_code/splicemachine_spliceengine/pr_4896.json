{"pr_number": 4896, "pr_title": "DB-11067/DB-11111 SpliceCatalogUpgradeScripts UpgradeScriptForTablePriorities fix, cleanup, tests", "pr_createdAt": "2020-12-18T17:34:13Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/4896", "timeline": [{"oid": "f13ac8b92e6afa3511ca90ba0c878cfbc3c5008b", "url": "https://github.com/splicemachine/spliceengine/commit/f13ac8b92e6afa3511ca90ba0c878cfbc3c5008b", "message": "DB-11067 SpliceCatalogUpgradeScripts can run multiple scripts for one version", "committedDate": "2020-12-18T17:36:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTk4OTk3OQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4896#discussion_r545989979", "bodyText": "Nitpick, you can use Long.compare(v1, v2);", "author": "dgomezferro", "createdAt": "2020-12-18T17:46:47Z", "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/Splice_DD_Version.java", "diffHunk": "@@ -117,4 +117,15 @@ public long toLong() {\n         return majorVersionNumber * 10000000000l + minorVersionNumber * 10000000l + patchVersionNumber * 10000l + sprintVersionNumber;\n     }\n \n+    static public int compare(Splice_DD_Version version1,Splice_DD_Version version2){\n+        long v1=version1.toLong();\n+        long v2=version2.toLong();\n+\n+        if(v1<v2)\n+            return -1;\n+        else if(v1==v2)\n+            return 0;\n+        else\n+            return 1;", "originalCommit": "f13ac8b92e6afa3511ca90ba0c878cfbc3c5008b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjIzMzk4Ng==", "url": "https://github.com/splicemachine/spliceengine/pull/4896#discussion_r552233986", "bodyText": "done", "author": "martinrupp", "createdAt": "2021-01-05T22:21:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTk4OTk3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "6a028375093b261c33da358050b85371d032b50e", "chunk": "diff --git a/splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/Splice_DD_Version.java b/splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/Splice_DD_Version.java\nindex 136e222400..99dc709f70 100644\n--- a/splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/Splice_DD_Version.java\n+++ b/splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/Splice_DD_Version.java\n\n@@ -120,12 +120,6 @@ public class Splice_DD_Version extends DD_Version {\n     static public int compare(Splice_DD_Version version1,Splice_DD_Version version2){\n         long v1=version1.toLong();\n         long v2=version2.toLong();\n-\n-        if(v1<v2)\n-            return -1;\n-        else if(v1==v2)\n-            return 0;\n-        else\n-            return 1;\n+        return Long.compare(v1, v2);\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTk5MTM3MA==", "url": "https://github.com/splicemachine/spliceengine/pull/4896#discussion_r545991370", "bodyText": "Move this one to the current version so that it gets executed with the new fixed logic. I think it already handles tables that have the expected priority, right?", "author": "dgomezferro", "createdAt": "2020-12-18T17:49:19Z", "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/upgrade/SpliceCatalogUpgradeScripts.java", "diffHunk": "@@ -35,52 +32,53 @@\n     SpliceDataDictionary sdd;\n     Splice_DD_Version catalogVersion;\n     TransactionController tc;\n-    TreeMap<Splice_DD_Version, UpgradeScript> scripts;\n-    Comparator<Splice_DD_Version> ddComparator;\n-    \n+\n+    List<VersionAndUpgrade> scripts;\n+\n+    static class VersionAndUpgrade {\n+        Splice_DD_Version version;\n+        UpgradeScript script;\n+\n+        public VersionAndUpgrade(Splice_DD_Version version,UpgradeScript script) {\n+            this.version = version;\n+            this.script = script;\n+        }\n+    }\n+\n+    public void addUpgradeScript(int major, int minor, int patch, int sprint, UpgradeScript script)\n+    {\n+        scripts.add(new VersionAndUpgrade(new Splice_DD_Version(sdd, major, minor, patch, sprint), script));\n+    }\n+\n     public SpliceCatalogUpgradeScripts(SpliceDataDictionary sdd,Splice_DD_Version catalogVersion,TransactionController tc){\n         this.sdd=sdd;\n         this.catalogVersion=catalogVersion;\n         this.tc=tc;\n \n-        ddComparator=new Comparator<Splice_DD_Version>(){\n-            @Override\n-            public int compare(Splice_DD_Version version1,Splice_DD_Version version2){\n-                long v1=version1.toLong();\n-                long v2=version2.toLong();\n-\n-                if(v1<v2)\n-                    return -1;\n-                else if(v1==v2)\n-                    return 0;\n-                else\n-                    return 1;\n-            }\n-        };\n-        scripts=new TreeMap<>(ddComparator);\n-        scripts.put(new Splice_DD_Version(sdd,2,8,0, 1901), new UpgradeScriptToRemoveUnusedBackupTables(sdd,tc));\n-        scripts.put(new Splice_DD_Version(sdd,2,8,0, 1909), new UpgradeScriptForReplication(sdd, tc));\n-        scripts.put(new Splice_DD_Version(sdd,2,8,0, 1917), new UpgradeScriptForMultiTenancy(sdd,tc));\n-        scripts.put(new Splice_DD_Version(sdd,2,8,0, 1924), new UpgradeScriptToAddPermissionViewsForMultiTenancy(sdd,tc));\n+        scripts = new ArrayList<>();\n+        addUpgradeScript(2,8,0, 1901, new UpgradeScriptToRemoveUnusedBackupTables(sdd,tc));\n+        addUpgradeScript(2,8,0, 1909, new UpgradeScriptForReplication(sdd, tc));\n+        addUpgradeScript(2,8,0, 1917, new UpgradeScriptForMultiTenancy(sdd,tc));\n+        addUpgradeScript(2,8,0, 1924, new UpgradeScriptToAddPermissionViewsForMultiTenancy(sdd,tc));\n \n-        scripts.put(new Splice_DD_Version(sdd,3,1,0, 1933), new UpgradeScriptToUpdateViewForSYSCONGLOMERATEINSCHEMAS(sdd,tc));\n-        scripts.put(new Splice_DD_Version(sdd,3,1,0, 1938), new UpgradeScriptForTriggerWhenClause(sdd,tc));\n-        scripts.put(new Splice_DD_Version(sdd,3,1,0, 1940), new UpgradeScriptForReplicationSystemTables(sdd,tc));\n-        scripts.put(new Splice_DD_Version(sdd,3,1,0, 1941), new UpgradeScriptForTableColumnViewInSYSIBM(sdd,tc));\n-        scripts.put(new Splice_DD_Version(sdd,3,1,0, 1948), new UpgradeScriptForAddDefaultToColumnViewInSYSIBM(sdd,tc));\n-        scripts.put(new Splice_DD_Version(sdd,3,1,0, 1953), new UpgradeScriptForRemoveUnusedIndexInSYSFILESTable(sdd,tc));\n-        scripts.put(new Splice_DD_Version(sdd,3,1,0, 1959), new UpgradeScriptForTriggerMultipleStatements(sdd,tc));\n-        scripts.put(new Splice_DD_Version(sdd,3,1,0, 1962), new UpgradeScriptForAddDefaultToColumnViewInSYSVW(sdd,tc));\n-        scripts.put(new Splice_DD_Version(sdd,3,1,0, 1964), new UpgradeScriptForAliasToTableView(sdd,tc));\n-        scripts.put(new Splice_DD_Version(sdd,3,1,0, 1970), new UpgradeScriptForAddTablesAndViewsInSYSIBMADM(sdd,tc));\n-        scripts.put(new Splice_DD_Version(sdd,3,1,0, 1971), new UpgradeScriptToAddCatalogVersion(sdd,tc));\n-        scripts.put(new Splice_DD_Version(sdd,3,1,0, 1974), new UpgradeScriptToAddMinRetentionPeriodColumnToSYSTABLES(sdd, tc));\n-        scripts.put(new Splice_DD_Version(sdd,3,1,0, 1977), new UpgradeScriptToAddSysKeyColUseViewInSYSIBM(sdd, tc));\n-        scripts.put(new Splice_DD_Version(sdd,3,1,0, 1979), new UpgradeScriptForTablePriorities(sdd, tc));\n-        scripts.put(new Splice_DD_Version(sdd,3,1,0, 1979), new UpgradeScriptToSetJavaClassNameColumnInSYSALIASES(sdd, tc));\n-        scripts.put(new Splice_DD_Version(sdd,3,2,0, 1983), new UpgradeScriptToAddBaseTableSchemaColumnsToSysTablesInSYSIBM(sdd,tc));\n-        scripts.put(new Splice_DD_Version(sdd,3,2,0, 1985), new UpgradeScriptToAddSysNaturalNumbersTable(sdd, tc));\n-        scripts.put(new Splice_DD_Version(sdd,3,2,0, 1989), new UpgradeScriptToAddIndexColUseViewInSYSCAT(sdd, tc));\n+        addUpgradeScript(3,1,0, 1933, new UpgradeScriptToUpdateViewForSYSCONGLOMERATEINSCHEMAS(sdd,tc));\n+        addUpgradeScript(3,1,0, 1938, new UpgradeScriptForTriggerWhenClause(sdd,tc));\n+        addUpgradeScript(3,1,0, 1940, new UpgradeScriptForReplicationSystemTables(sdd,tc));\n+        addUpgradeScript(3,1,0, 1941, new UpgradeScriptForTableColumnViewInSYSIBM(sdd,tc));\n+        addUpgradeScript(3,1,0, 1948, new UpgradeScriptForAddDefaultToColumnViewInSYSIBM(sdd,tc));\n+        addUpgradeScript(3,1,0, 1953, new UpgradeScriptForRemoveUnusedIndexInSYSFILESTable(sdd,tc));\n+        addUpgradeScript(3,1,0, 1959, new UpgradeScriptForTriggerMultipleStatements(sdd,tc));\n+        addUpgradeScript(3,1,0, 1962, new UpgradeScriptForAddDefaultToColumnViewInSYSVW(sdd,tc));\n+        addUpgradeScript(3,1,0, 1964, new UpgradeScriptForAliasToTableView(sdd,tc));\n+        addUpgradeScript(3,1,0, 1970, new UpgradeScriptForAddTablesAndViewsInSYSIBMADM(sdd,tc));\n+        addUpgradeScript(3,1,0, 1971, new UpgradeScriptToAddCatalogVersion(sdd,tc));\n+        addUpgradeScript(3,1,0, 1974, new UpgradeScriptToAddMinRetentionPeriodColumnToSYSTABLES(sdd, tc));\n+        addUpgradeScript(3,1,0, 1977, new UpgradeScriptToAddSysKeyColUseViewInSYSIBM(sdd, tc));\n+        addUpgradeScript(3,1,0, 1979, new UpgradeScriptForTablePriorities(sdd, tc));", "originalCommit": "f13ac8b92e6afa3511ca90ba0c878cfbc3c5008b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjIzNTQ3NQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4896#discussion_r552235475", "bodyText": "done", "author": "martinrupp", "createdAt": "2021-01-05T22:24:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTk5MTM3MA=="}], "type": "inlineReview", "revised_code": {"commit": "dbe9d76f96466805e8995fdb7d52d62b1cd73fd4", "chunk": "diff --git a/splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/upgrade/SpliceCatalogUpgradeScripts.java b/splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/upgrade/SpliceCatalogUpgradeScripts.java\nindex 705bd3cd42..340ae92814 100644\n--- a/splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/upgrade/SpliceCatalogUpgradeScripts.java\n+++ b/splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/upgrade/SpliceCatalogUpgradeScripts.java\n\n@@ -74,11 +74,11 @@ public class SpliceCatalogUpgradeScripts{\n         addUpgradeScript(3,1,0, 1971, new UpgradeScriptToAddCatalogVersion(sdd,tc));\n         addUpgradeScript(3,1,0, 1974, new UpgradeScriptToAddMinRetentionPeriodColumnToSYSTABLES(sdd, tc));\n         addUpgradeScript(3,1,0, 1977, new UpgradeScriptToAddSysKeyColUseViewInSYSIBM(sdd, tc));\n-        addUpgradeScript(3,1,0, 1979, new UpgradeScriptForTablePriorities(sdd, tc));\n         addUpgradeScript(3,1,0, 1979, new UpgradeScriptToSetJavaClassNameColumnInSYSALIASES(sdd, tc));\n         addUpgradeScript(3,2,0, 1983, new UpgradeScriptToAddBaseTableSchemaColumnsToSysTablesInSYSIBM(sdd,tc));\n         addUpgradeScript(3,2,0, 1985, new UpgradeScriptToAddSysNaturalNumbersTable(sdd, tc));\n         addUpgradeScript(3,2,0, 1989, new UpgradeScriptToAddIndexColUseViewInSYSCAT(sdd, tc));\n+        addUpgradeScript(3,2,0, 1990, new UpgradeScriptForTablePriorities(sdd, tc));\n     }\n     public void run() throws StandardException{\n \n"}}, {"oid": "dbe9d76f96466805e8995fdb7d52d62b1cd73fd4", "url": "https://github.com/splicemachine/spliceengine/commit/dbe9d76f96466805e8995fdb7d52d62b1cd73fd4", "message": "DB-11067 SpliceCatalogUpgradeScripts can run multiple scripts for one version", "committedDate": "2020-12-18T17:56:24Z", "type": "forcePushed"}, {"oid": "d80de21e0d5fc1f9d3ed5e119f2565e9b3436b7a", "url": "https://github.com/splicemachine/spliceengine/commit/d80de21e0d5fc1f9d3ed5e119f2565e9b3436b7a", "message": "DB-11067 add tests for parts of SpliceCatalogUpgradeScripts", "committedDate": "2020-12-21T21:37:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE4NjMyOQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4896#discussion_r547186329", "bodyText": "Start method names with lowerCase", "author": "dgomezferro", "createdAt": "2020-12-22T10:08:25Z", "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/upgrade/SpliceCatalogUpgradeScripts.java", "diffHunk": "@@ -33,56 +30,81 @@\n     protected static final Logger LOG=Logger.getLogger(SpliceCatalogUpgradeScripts.class);\n \n     SpliceDataDictionary sdd;\n-    Splice_DD_Version catalogVersion;\n     TransactionController tc;\n-    TreeMap<Splice_DD_Version, UpgradeScript> scripts;\n-    Comparator<Splice_DD_Version> ddComparator;\n-    \n-    public SpliceCatalogUpgradeScripts(SpliceDataDictionary sdd,Splice_DD_Version catalogVersion,TransactionController tc){\n+\n+    List<VersionAndUpgrade> scripts;\n+\n+    public static class VersionAndUpgrade {\n+        public Splice_DD_Version version;\n+        public UpgradeScript script;\n+\n+        public VersionAndUpgrade(Splice_DD_Version version,UpgradeScript script) {\n+            this.version = version;\n+            this.script = script;\n+        }\n+    }\n+\n+    public void addUpgradeScript(int major, int minor, int patch, int sprint, UpgradeScript script)\n+    {\n+        scripts.add(new VersionAndUpgrade(new Splice_DD_Version(sdd, major, minor, patch, sprint), script));\n+    }\n+\n+    public SpliceCatalogUpgradeScripts(SpliceDataDictionary sdd, TransactionController tc){\n         this.sdd=sdd;\n-        this.catalogVersion=catalogVersion;\n         this.tc=tc;\n \n-        ddComparator=new Comparator<Splice_DD_Version>(){\n-            @Override\n-            public int compare(Splice_DD_Version version1,Splice_DD_Version version2){\n-                long v1=version1.toLong();\n-                long v2=version2.toLong();\n-\n-                if(v1<v2)\n-                    return -1;\n-                else if(v1==v2)\n-                    return 0;\n-                else\n-                    return 1;\n+        scripts = new ArrayList<>();\n+        addUpgradeScript(2,8,0, 1901, new UpgradeScriptToRemoveUnusedBackupTables(sdd,tc));\n+        addUpgradeScript(2,8,0, 1909, new UpgradeScriptForReplication(sdd, tc));\n+        addUpgradeScript(2,8,0, 1917, new UpgradeScriptForMultiTenancy(sdd,tc));\n+        addUpgradeScript(2,8,0, 1924, new UpgradeScriptToAddPermissionViewsForMultiTenancy(sdd,tc));\n+\n+        addUpgradeScript(3,1,0, 1933, new UpgradeScriptToUpdateViewForSYSCONGLOMERATEINSCHEMAS(sdd,tc));\n+        addUpgradeScript(3,1,0, 1938, new UpgradeScriptForTriggerWhenClause(sdd,tc));\n+        addUpgradeScript(3,1,0, 1940, new UpgradeScriptForReplicationSystemTables(sdd,tc));\n+        addUpgradeScript(3,1,0, 1941, new UpgradeScriptForTableColumnViewInSYSIBM(sdd,tc));\n+        addUpgradeScript(3,1,0, 1948, new UpgradeScriptForAddDefaultToColumnViewInSYSIBM(sdd,tc));\n+        addUpgradeScript(3,1,0, 1953, new UpgradeScriptForRemoveUnusedIndexInSYSFILESTable(sdd,tc));\n+        addUpgradeScript(3,1,0, 1959, new UpgradeScriptForTriggerMultipleStatements(sdd,tc));\n+        addUpgradeScript(3,1,0, 1962, new UpgradeScriptForAddDefaultToColumnViewInSYSVW(sdd,tc));\n+        addUpgradeScript(3,1,0, 1964, new UpgradeScriptForAliasToTableView(sdd,tc));\n+        addUpgradeScript(3,1,0, 1970, new UpgradeScriptForAddTablesAndViewsInSYSIBMADM(sdd,tc));\n+        addUpgradeScript(3,1,0, 1971, new UpgradeScriptToAddCatalogVersion(sdd,tc));\n+        addUpgradeScript(3,1,0, 1974, new UpgradeScriptToAddMinRetentionPeriodColumnToSYSTABLES(sdd, tc));\n+        addUpgradeScript(3,1,0, 1977, new UpgradeScriptToAddSysKeyColUseViewInSYSIBM(sdd, tc));\n+        addUpgradeScript(3,1,0, 1979, new UpgradeScriptToSetJavaClassNameColumnInSYSALIASES(sdd, tc));\n+        addUpgradeScript(3,2,0, 1983, new UpgradeScriptToAddBaseTableSchemaColumnsToSysTablesInSYSIBM(sdd,tc));\n+        addUpgradeScript(3,2,0, 1985, new UpgradeScriptToAddSysNaturalNumbersTable(sdd, tc));\n+        addUpgradeScript(3,2,0, 1989, new UpgradeScriptToAddIndexColUseViewInSYSCAT(sdd, tc));\n+        addUpgradeScript(3,2,0, 1990, new UpgradeScriptForTablePriorities(sdd, tc));\n+    }\n+\n+    public static List<VersionAndUpgrade> GetScriptsToUpgrade(List<VersionAndUpgrade> scripts,", "originalCommit": "d80de21e0d5fc1f9d3ed5e119f2565e9b3436b7a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjIzNTUxNg==", "url": "https://github.com/splicemachine/spliceengine/pull/4896#discussion_r552235516", "bodyText": "done", "author": "martinrupp", "createdAt": "2021-01-05T22:24:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE4NjMyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "6a028375093b261c33da358050b85371d032b50e", "chunk": "diff --git a/splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/upgrade/SpliceCatalogUpgradeScripts.java b/splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/upgrade/SpliceCatalogUpgradeScripts.java\nindex f185117dfb..7ce002dc2e 100644\n--- a/splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/upgrade/SpliceCatalogUpgradeScripts.java\n+++ b/splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/upgrade/SpliceCatalogUpgradeScripts.java\n\n@@ -76,10 +76,10 @@ public class SpliceCatalogUpgradeScripts{\n         addUpgradeScript(3,2,0, 1983, new UpgradeScriptToAddBaseTableSchemaColumnsToSysTablesInSYSIBM(sdd,tc));\n         addUpgradeScript(3,2,0, 1985, new UpgradeScriptToAddSysNaturalNumbersTable(sdd, tc));\n         addUpgradeScript(3,2,0, 1989, new UpgradeScriptToAddIndexColUseViewInSYSCAT(sdd, tc));\n-        addUpgradeScript(3,2,0, 1990, new UpgradeScriptForTablePriorities(sdd, tc));\n+        addUpgradeScript(3,2,0, 1992, new UpgradeScriptForTablePriorities(sdd, tc));\n     }\n \n-    public static List<VersionAndUpgrade> GetScriptsToUpgrade(List<VersionAndUpgrade> scripts,\n+    public static List<VersionAndUpgrade> getScriptsToUpgrade(List<VersionAndUpgrade> scripts,\n                                                               Splice_DD_Version currentVersion)\n     {\n         List<VersionAndUpgrade> upgradeNeeded = new ArrayList<>();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE4ODIyNw==", "url": "https://github.com/splicemachine/spliceengine/pull/4896#discussion_r547188227", "bodyText": "It'd be great to have more descriptive test names", "author": "dgomezferro", "createdAt": "2020-12-22T10:12:14Z", "path": "splice_machine/src/test/java/com/splicemachine/derby/utils/SpliceCatalogUpgradeScriptsTest.java", "diffHunk": "@@ -0,0 +1,110 @@\n+package com.splicemachine.derby.utils;\n+\n+import com.splicemachine.db.iapi.error.StandardException;\n+import com.splicemachine.derby.impl.sql.catalog.Splice_DD_Version;\n+import com.splicemachine.derby.impl.sql.catalog.upgrade.SpliceCatalogUpgradeScripts;\n+import com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScript;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+public class SpliceCatalogUpgradeScriptsTest {\n+    String s1 = \"3.1.0.1938: com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScriptForTriggerWhenClause\\n\" +\n+            \"3.1.0.1940: com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScriptForReplicationSystemTables\\n\" +\n+            \"3.1.0.1941: com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScriptForTableColumnViewInSYSIBM\\n\" +\n+            \"3.1.0.1948: com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScriptForAddDefaultToColumnViewInSYSIBM\\n\" +\n+            \"3.1.0.1953: com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScriptForRemoveUnusedIndexInSYSFILESTable\\n\" +\n+            \"3.1.0.1959: com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScriptForTriggerMultipleStatements\\n\" +\n+            \"3.1.0.1962: com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScriptForAddDefaultToColumnViewInSYSVW\\n\" +\n+            \"3.1.0.1964: com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScriptForAliasToTableView\\n\" +\n+            \"3.1.0.1970: com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScriptForAddTablesAndViewsInSYSIBMADM\\n\" +\n+            \"3.1.0.1971: com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScriptToAddCatalogVersion\\n\" +\n+            \"3.1.0.1974: com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScriptToAddMinRetentionPeriodColumnToSYSTABLES\\n\" +\n+            \"3.1.0.1977: com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScriptToAddSysKeyColUseViewInSYSIBM\\n\" +\n+            \"3.1.0.1979: com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScriptToSetJavaClassNameColumnInSYSALIASES\\n\" +\n+            \"3.2.0.1983: com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScriptToAddBaseTableSchemaColumnsToSysTablesInSYSIBM\\n\" +\n+            \"3.2.0.1985: com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScriptToAddSysNaturalNumbersTable\\n\";\n+\n+    String s2 = \"3.2.0.1989: com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScriptToAddIndexColUseViewInSYSCAT\\n\" +\n+            \"3.2.0.1990: com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScriptForTablePriorities\\n\";\n+    // add more scripts here\n+\n+    @Test\n+    public void t1()", "originalCommit": "d80de21e0d5fc1f9d3ed5e119f2565e9b3436b7a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjIzNTU1Mw==", "url": "https://github.com/splicemachine/spliceengine/pull/4896#discussion_r552235553", "bodyText": "done", "author": "martinrupp", "createdAt": "2021-01-05T22:25:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE4ODIyNw=="}], "type": "inlineReview", "revised_code": {"commit": "6a028375093b261c33da358050b85371d032b50e", "chunk": "diff --git a/splice_machine/src/test/java/com/splicemachine/derby/utils/SpliceCatalogUpgradeScriptsTest.java b/splice_machine/src/test/java/com/splicemachine/derby/utils/SpliceCatalogUpgradeScriptsTest.java\nindex ec76a03a03..5af65c9076 100644\n--- a/splice_machine/src/test/java/com/splicemachine/derby/utils/SpliceCatalogUpgradeScriptsTest.java\n+++ b/splice_machine/src/test/java/com/splicemachine/derby/utils/SpliceCatalogUpgradeScriptsTest.java\n\n@@ -28,41 +28,41 @@ public class SpliceCatalogUpgradeScriptsTest {\n             \"3.2.0.1985: com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScriptToAddSysNaturalNumbersTable\\n\";\n \n     String s2 = \"3.2.0.1989: com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScriptToAddIndexColUseViewInSYSCAT\\n\" +\n-            \"3.2.0.1990: com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScriptForTablePriorities\\n\";\n+            \"3.2.0.1992: com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScriptForTablePriorities\\n\";\n     // add more scripts here\n \n     @Test\n-    public void t1()\n+    public void test_since_1933()\n     {\n         SpliceCatalogUpgradeScripts s = new SpliceCatalogUpgradeScripts(null, null);\n         Splice_DD_Version version = new Splice_DD_Version(null, 3,1,0, 1933);\n         List<SpliceCatalogUpgradeScripts.VersionAndUpgrade> list =\n-                SpliceCatalogUpgradeScripts.GetScriptsToUpgrade(s.GetScripts(), version);\n-        Assert.assertEquals(s1 + s2, GetUpgradeScriptsToStr(list));\n+                SpliceCatalogUpgradeScripts.getScriptsToUpgrade(s.getScripts(), version);\n+        Assert.assertEquals(s1 + s2, getUpgradeScriptsToStr(list));\n     }\n \n     @Test\n-    public void t2()\n+    public void test_since_1987()\n     {\n         SpliceCatalogUpgradeScripts s = new SpliceCatalogUpgradeScripts(null, null);\n         Splice_DD_Version version = new Splice_DD_Version(null, 3,2,0, 1987);\n         List<SpliceCatalogUpgradeScripts.VersionAndUpgrade> list =\n-                SpliceCatalogUpgradeScripts.GetScriptsToUpgrade(s.GetScripts(), version);\n-        Assert.assertEquals(s2, GetUpgradeScriptsToStr(list));\n+                SpliceCatalogUpgradeScripts.getScriptsToUpgrade(s.getScripts(), version);\n+        Assert.assertEquals(s2, getUpgradeScriptsToStr(list));\n     }\n \n     @Test\n-    public void t3()\n+    public void test_since_2000_upgrade_empty()\n     {\n         SpliceCatalogUpgradeScripts s = new SpliceCatalogUpgradeScripts(null, null);\n         Splice_DD_Version version = new Splice_DD_Version(null, 4,0,0, 2000);\n         List<SpliceCatalogUpgradeScripts.VersionAndUpgrade> list =\n-                SpliceCatalogUpgradeScripts.GetScriptsToUpgrade(s.GetScripts(), version);\n-        Assert.assertEquals(\"\", GetUpgradeScriptsToStr(list));\n+                SpliceCatalogUpgradeScripts.getScriptsToUpgrade(s.getScripts(), version);\n+        Assert.assertEquals(\"\", getUpgradeScriptsToStr(list));\n     }\n \n     @Test\n-    public void t4() throws StandardException {\n+    public void test_upgrade_run() throws StandardException {\n         List<SpliceCatalogUpgradeScripts.VersionAndUpgrade> list = new ArrayList<>();\n         final int[] counter = {0};\n         UpgradeScript s = new UpgradeScript() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE5MDkyNQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4896#discussion_r547190925", "bodyText": "Instead of using a List and perform a linear search each time we want to perform an upgrade, I would keep the tree structure used before and replace it with something like Guava's MultiMap instead. To start iterating from version X you can lookup the key in log(N) : N #versions by doing multimap.keySet().ceiling(X)", "author": "hatyo", "createdAt": "2020-12-22T10:17:14Z", "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/upgrade/SpliceCatalogUpgradeScripts.java", "diffHunk": "@@ -33,56 +30,81 @@\n     protected static final Logger LOG=Logger.getLogger(SpliceCatalogUpgradeScripts.class);\n \n     SpliceDataDictionary sdd;\n-    Splice_DD_Version catalogVersion;\n     TransactionController tc;\n-    TreeMap<Splice_DD_Version, UpgradeScript> scripts;\n-    Comparator<Splice_DD_Version> ddComparator;\n-    \n-    public SpliceCatalogUpgradeScripts(SpliceDataDictionary sdd,Splice_DD_Version catalogVersion,TransactionController tc){\n+\n+    List<VersionAndUpgrade> scripts;", "originalCommit": "d80de21e0d5fc1f9d3ed5e119f2565e9b3436b7a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ5MTQzOQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4896#discussion_r547491439", "bodyText": "i made this especially easy since the whole upgrade path is really hard to test, people modify it, and if it's broken it's a high cost, while optimal performance is lower priority here. last version was using a sophisticated map, then someone changed it to still iterate over all elements.\nthis upgrade is called ONCE when database is started, the number of items in the list is currently 22. Even for 100 items i would doubt that creating a multimap + searching is faster than just looping over a list. even if - I would really like to keep this rock-solid-bullet-proof code, and not trying to squeeze out a second or two.", "author": "martinrupp", "createdAt": "2020-12-22T20:25:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE5MDkyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODA0OTU2OA==", "url": "https://github.com/splicemachine/spliceengine/pull/4896#discussion_r548049568", "bodyText": "I agree with @martinrupp , I think it's ok to have a list here since this code is not performance sensitive (at least for now)", "author": "dgomezferro", "createdAt": "2020-12-23T16:48:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE5MDkyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODA3MDA1Mw==", "url": "https://github.com/splicemachine/spliceengine/pull/4896#discussion_r548070053", "bodyText": "I would really like to keep this rock-solid-bullet-proof code, and not trying to squeeze out a second or two.\n\nI think these are not mutually exclusive.\nAnyway, it is a fair point that the number of items is too small that the overhead is negligible.", "author": "hatyo", "createdAt": "2020-12-23T17:27:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE5MDkyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTE4MTUwMw==", "url": "https://github.com/splicemachine/spliceengine/pull/4896#discussion_r551181503", "bodyText": "I would really like to keep this rock-solid-bullet-proof code, and not trying to squeeze out a second or two.\n\n\n\nI think these are not mutually exclusive\n\nyes, i agree.", "author": "martinrupp", "createdAt": "2021-01-04T08:47:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE5MDkyNQ=="}], "type": "inlineReview", "revised_code": {"commit": "6a028375093b261c33da358050b85371d032b50e", "chunk": "diff --git a/splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/upgrade/SpliceCatalogUpgradeScripts.java b/splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/upgrade/SpliceCatalogUpgradeScripts.java\nindex f185117dfb..7ce002dc2e 100644\n--- a/splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/upgrade/SpliceCatalogUpgradeScripts.java\n+++ b/splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/upgrade/SpliceCatalogUpgradeScripts.java\n\n@@ -76,10 +76,10 @@ public class SpliceCatalogUpgradeScripts{\n         addUpgradeScript(3,2,0, 1983, new UpgradeScriptToAddBaseTableSchemaColumnsToSysTablesInSYSIBM(sdd,tc));\n         addUpgradeScript(3,2,0, 1985, new UpgradeScriptToAddSysNaturalNumbersTable(sdd, tc));\n         addUpgradeScript(3,2,0, 1989, new UpgradeScriptToAddIndexColUseViewInSYSCAT(sdd, tc));\n-        addUpgradeScript(3,2,0, 1990, new UpgradeScriptForTablePriorities(sdd, tc));\n+        addUpgradeScript(3,2,0, 1992, new UpgradeScriptForTablePriorities(sdd, tc));\n     }\n \n-    public static List<VersionAndUpgrade> GetScriptsToUpgrade(List<VersionAndUpgrade> scripts,\n+    public static List<VersionAndUpgrade> getScriptsToUpgrade(List<VersionAndUpgrade> scripts,\n                                                               Splice_DD_Version currentVersion)\n     {\n         List<VersionAndUpgrade> upgradeNeeded = new ArrayList<>();\n"}}, {"oid": "6a028375093b261c33da358050b85371d032b50e", "url": "https://github.com/splicemachine/spliceengine/commit/6a028375093b261c33da358050b85371d032b50e", "message": "DB-11067 address reviews", "committedDate": "2021-01-05T22:25:34Z", "type": "forcePushed"}, {"oid": "62d9168bd9b85c2f2621a45dd40953d2adcf73d7", "url": "https://github.com/splicemachine/spliceengine/commit/62d9168bd9b85c2f2621a45dd40953d2adcf73d7", "message": "DB-11067 SpliceCatalogUpgradeScripts can run multiple scripts for one version", "committedDate": "2021-01-06T09:38:03Z", "type": "forcePushed"}, {"oid": "62e7e1a0b0e4a24e22ce3587a7732a6591c26a1d", "url": "https://github.com/splicemachine/spliceengine/commit/62e7e1a0b0e4a24e22ce3587a7732a6591c26a1d", "message": "DB-11067 SpliceCatalogUpgradeScripts can run multiple scripts for one version", "committedDate": "2021-01-07T10:17:47Z", "type": "commit"}, {"oid": "62e7e1a0b0e4a24e22ce3587a7732a6591c26a1d", "url": "https://github.com/splicemachine/spliceengine/commit/62e7e1a0b0e4a24e22ce3587a7732a6591c26a1d", "message": "DB-11067 SpliceCatalogUpgradeScripts can run multiple scripts for one version", "committedDate": "2021-01-07T10:17:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzI0OTExMg==", "url": "https://github.com/splicemachine/spliceengine/pull/4896#discussion_r553249112", "bodyText": "Can you add two lines here explaining what the table means? It took me a while to understand", "author": "dgomezferro", "createdAt": "2021-01-07T10:43:11Z", "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/upgrade/SpliceCatalogUpgradeScripts.java", "diffHunk": "@@ -33,79 +30,121 @@\n     protected static final Logger LOG=Logger.getLogger(SpliceCatalogUpgradeScripts.class);\n \n     SpliceDataDictionary sdd;\n-    Splice_DD_Version catalogVersion;\n     TransactionController tc;\n-    TreeMap<Splice_DD_Version, UpgradeScript> scripts;\n-    Comparator<Splice_DD_Version> ddComparator;\n-    \n-    public SpliceCatalogUpgradeScripts(SpliceDataDictionary sdd,Splice_DD_Version catalogVersion,TransactionController tc){\n+\n+    List<VersionAndUpgrade> scripts;\n+\n+    public static class VersionAndUpgrade {\n+        public Splice_DD_Version version;\n+        public UpgradeScript script;\n+\n+        public VersionAndUpgrade(Splice_DD_Version version,UpgradeScript script) {\n+            this.version = version;\n+            this.script = script;\n+        }\n+    }\n+\n+    public void addUpgradeScript(Splice_DD_Version version, int sprint, UpgradeScript script)\n+    {\n+        scripts.add(new VersionAndUpgrade(new Splice_DD_Version(sdd, version.getMajorVersionNumber(),\n+                version.getMinorVersionNumber(), version.getPatchVersionNumber(), sprint), script));\n+    }\n+\n+    // master / branch-3.0 / branch-3.1\n+    // baseVersion1 = 2.8.0 / 2.8.0 / 2.8.0\n+    // baseVersion2 = 3.1.0 / 3.1.0 / 3.0.0 // 3. fork\n+    // baseVersion3 = 3.1.0 / 3.1.0 / 3.0.1 // hickup on branch 3.0\n+    // baseVersion4 = 3.2.0 / 3.1.0 / 3.0.1 // 3.2 fork", "originalCommit": "62e7e1a0b0e4a24e22ce3587a7732a6591c26a1d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzI4NjI4OQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4896#discussion_r553286289", "bodyText": "yes, good point", "author": "martinrupp", "createdAt": "2021-01-07T12:02:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzI0OTExMg=="}], "type": "inlineReview", "revised_code": {"commit": "8f96a670d00f341500633f866e8c311c61bedb61", "chunk": "diff --git a/splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/upgrade/SpliceCatalogUpgradeScripts.java b/splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/upgrade/SpliceCatalogUpgradeScripts.java\nindex a47e9b1574..00c460edeb 100644\n--- a/splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/upgrade/SpliceCatalogUpgradeScripts.java\n+++ b/splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/upgrade/SpliceCatalogUpgradeScripts.java\n\n@@ -50,11 +50,21 @@ public class SpliceCatalogUpgradeScripts{\n                 version.getMinorVersionNumber(), version.getPatchVersionNumber(), sprint), script));\n     }\n \n-    // master / branch-3.0 / branch-3.1\n-    // baseVersion1 = 2.8.0 / 2.8.0 / 2.8.0\n-    // baseVersion2 = 3.1.0 / 3.1.0 / 3.0.0 // 3. fork\n-    // baseVersion3 = 3.1.0 / 3.1.0 / 3.0.1 // hickup on branch 3.0\n-    // baseVersion4 = 3.2.0 / 3.1.0 / 3.0.1 // 3.2 fork\n+    // Upgrade scripts should be mostly the same on master/3.0/3.1.\n+    // However the base versions (i.e. major.minor.patch without sprint) are different.\n+    // e.g. UpgradeScriptToAddSysNaturalNumbersTable is for sprint 1985, which is [baseVersion4, 1985].\n+    // that means on master = 3.2.0.1985, branch-3.0 = 3.1.0.1985, branch-3.0 = 3.0.1.1985.\n+\n+    // following table gives an overview over different base versions in the branches\n+    //                 master | branch-3.0 | branch-3.1 | remarks\n+    // baseVersion1 =  2.8.0  |   2.8.0    |   2.8.0    |\n+    // baseVersion2 =  3.1.0  |   3.1.0    |   3.0.0    | 2.8 -> 3.x fork\n+    // baseVersion3 =  3.1.0  |   3.1.0    |   3.0.1    | hickup on branch 3.0\n+    // baseVersion4 =  3.2.0  |   3.1.0    |   3.0.1    | 3.2 fork\n+    // ...\n+    // baseVersionX = ...                               | add here new versions\n+    //\n+    // also check SpliceCatalogUpgradeScriptsTest for some unit tests for this.\n \n     static final public Splice_DD_Version baseVersion1 = new Splice_DD_Version(null, 2, 8, 0);\n     static final public Splice_DD_Version baseVersion2 = new Splice_DD_Version(null, 3, 1, 0);\n"}}, {"oid": "8f96a670d00f341500633f866e8c311c61bedb61", "url": "https://github.com/splicemachine/spliceengine/commit/8f96a670d00f341500633f866e8c311c61bedb61", "message": "DB-11067 address review comment (better comment about baseVersionX)", "committedDate": "2021-01-07T12:13:57Z", "type": "commit"}]}