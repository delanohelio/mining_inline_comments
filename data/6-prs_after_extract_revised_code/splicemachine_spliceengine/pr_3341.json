{"pr_number": 3341, "pr_title": "DB-9309 Reduce memory pressure on RegionServers", "pr_createdAt": "2020-03-25T12:12:39Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/3341", "timeline": [{"oid": "f5eb1668c3a3e53bfb06547f9dfdd3615f9111b8", "url": "https://github.com/splicemachine/spliceengine/commit/f5eb1668c3a3e53bfb06547f9dfdd3615f9111b8", "message": "DB-9309 Reduce buffering when streaming BLOBs from Spark", "committedDate": "2020-03-25T12:04:27Z", "type": "commit"}, {"oid": "b238a2631286dc0295cf9299a58d9d4af4c19c4c", "url": "https://github.com/splicemachine/spliceengine/commit/b238a2631286dc0295cf9299a58d9d4af4c19c4c", "message": "DB-9309 Reduce memory pressure when compacting on RSs", "committedDate": "2020-03-25T12:04:27Z", "type": "commit"}, {"oid": "412f837ece0d9b77ba6fdda84c5b34757d11c52b", "url": "https://github.com/splicemachine/spliceengine/commit/412f837ece0d9b77ba6fdda84c5b34757d11c52b", "message": "DB-9309 Improve error reporting", "committedDate": "2020-03-25T12:04:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkyMDUxMw==", "url": "https://github.com/splicemachine/spliceengine/pull/3341#discussion_r397920513", "bodyText": "Shouldn't the permit be release if an exception was thrown and we are in the catch block?", "author": "arnaud-splice", "createdAt": "2020-03-25T14:56:40Z", "path": "hbase_storage/src/main/java/com/splicemachine/si/impl/server/AbstractSICompactionScanner.java", "diffHunk": "@@ -75,13 +78,15 @@ public boolean next(List<Cell> list) throws IOException{\n         Entry entry;\n         try {\n             entry = queue.take();\n+            int toRelease = entry.cells.size();\n             final boolean more = entry.more;\n             List<TxnView> txns = waitFor(entry.txns);\n             compactionState.mutate(entry.cells, txns, list, purgeConfig);\n             if (!more) {\n                 timer.cancel();\n-                    context.close();\n+                context.close();\n             }\n+            permits.release(toRelease);\n             return more;\n         } catch (Exception e) {", "originalCommit": "412f837ece0d9b77ba6fdda84c5b34757d11c52b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY2NzczMA==", "url": "https://github.com/splicemachine/spliceengine/pull/3341#discussion_r401667730", "bodyText": "That's a good point, I added some code to explicitly stop the Reading thread and unblock it if there's any exception here.", "author": "dgomezferro", "createdAt": "2020-04-01T14:39:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkyMDUxMw=="}], "type": "inlineReview", "revised_code": {"commit": "34f76f824c95e33ef7686c5da50a710afa715b30", "chunk": "diff --git a/hbase_storage/src/main/java/com/splicemachine/si/impl/server/AbstractSICompactionScanner.java b/hbase_storage/src/main/java/com/splicemachine/si/impl/server/AbstractSICompactionScanner.java\nindex a199030382..5eb82b063b 100644\n--- a/hbase_storage/src/main/java/com/splicemachine/si/impl/server/AbstractSICompactionScanner.java\n+++ b/hbase_storage/src/main/java/com/splicemachine/si/impl/server/AbstractSICompactionScanner.java\n\n@@ -88,9 +89,15 @@ public abstract class AbstractSICompactionScanner implements InternalScanner {\n             }\n             permits.release(toRelease);\n             return more;\n-        } catch (Exception e) {\n+        } catch (Throwable t) {\n             timer.cancel();\n-            throw new IOException(e);\n+            stop = true;\n+\n+            // unblock reading thread\n+            permits.release(queue.size());\n+            queue.clear();\n+\n+            throw new IOException(t);\n         }\n     }\n \n"}}, {"oid": "34f76f824c95e33ef7686c5da50a710afa715b30", "url": "https://github.com/splicemachine/spliceengine/commit/34f76f824c95e33ef7686c5da50a710afa715b30", "message": "DB-9309 Handle failure cases more gracefully on compactions", "committedDate": "2020-03-25T15:59:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjY4NjgwOQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3341#discussion_r416686809", "bodyText": "Why the buffer size is set to LocalCompactionResolutionBufferSize for precompact()? Should it be used for preFlush() instead?", "author": "jyuanca", "createdAt": "2020-04-28T15:02:04Z", "path": "hbase_storage/src/main/java/com/splicemachine/si/data/hbase/coprocessor/SIObserver.java", "diffHunk": "@@ -230,7 +229,7 @@ public InternalScanner preCompact(ObserverContext<RegionCoprocessorEnvironment>\n                 }\n                 SICompactionScanner siScanner = new SICompactionScanner(\n                         state, scanner, purgeConfig,\n-                        conf.getOlapCompactionResolutionShare(), conf.getOlapCompactionResolutionBufferSize(), context);\n+                        conf.getOlapCompactionResolutionShare(), conf.getLocalCompactionResolutionBufferSize(), context);\n                 siScanner.start();", "originalCommit": "34f76f824c95e33ef7686c5da50a710afa715b30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTMwOTQ2OQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3341#discussion_r421309469", "bodyText": "This affects compactions that couldn't be run in Spark and fallback to run in HBase. I think flushes are fine because we are dealing with less data and the data itself is already in the MemStore, we are not bringing new data from a file into memory, so having a larger buffer shouldn't be a problem.", "author": "dgomezferro", "createdAt": "2020-05-07T07:54:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjY4NjgwOQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "f9dc8c350b8b2ee57ee37877eb4fc7b36ddb9fc6", "url": "https://github.com/splicemachine/spliceengine/commit/f9dc8c350b8b2ee57ee37877eb4fc7b36ddb9fc6", "message": "DB-9309 Add clarifying comment", "committedDate": "2020-05-07T07:55:43Z", "type": "commit"}, {"oid": "3cac28985510a02edcad0f5bc3fce9f21b39d783", "url": "https://github.com/splicemachine/spliceengine/commit/3cac28985510a02edcad0f5bc3fce9f21b39d783", "message": "Merge remote-tracking branch 'origin/master' into DB-9309", "committedDate": "2020-05-07T07:59:21Z", "type": "commit"}, {"oid": "afcb5996e211fcb00eea735b98f9b141c0e8cca6", "url": "https://github.com/splicemachine/spliceengine/commit/afcb5996e211fcb00eea735b98f9b141c0e8cca6", "message": "Merge remote-tracking branch 'origin/master' into DB-9309", "committedDate": "2020-05-07T08:12:28Z", "type": "commit"}]}