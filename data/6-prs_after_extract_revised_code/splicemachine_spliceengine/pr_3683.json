{"pr_number": 3683, "pr_title": "DB-9665 Clear ZNode for OlapServer app watcher", "pr_createdAt": "2020-06-15T17:10:30Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/3683", "timeline": [{"oid": "80edd6ee0f01907ddae32e081bebde1ba96751d3", "url": "https://github.com/splicemachine/spliceengine/commit/80edd6ee0f01907ddae32e081bebde1ba96751d3", "message": "DB-9665 Clear ZNode for OlapServer app watcher\n\nRestart OlapServer if software version changed", "committedDate": "2020-06-15T15:04:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQyMDgxMw==", "url": "https://github.com/splicemachine/spliceengine/pull/3683#discussion_r440420813", "bodyText": "Is it needed to wrap the exception in a RuntimeException, can we just remove the catch?", "author": "hatyo", "createdAt": "2020-06-15T20:14:08Z", "path": "hbase_sql/src/main/java/com/splicemachine/olap/OlapServerSubmitter.java", "diffHunk": "@@ -244,6 +244,24 @@ public void run() {\n \n     }\n \n+    private byte[] getKeepAlivePayload() {\n+        DatabaseVersion version;\n+        try {\n+            version = JMXUtils.getLocalMBeanProxy(JMXUtils.SPLICEMACHINE_VERSION, DatabaseVersion.class);\n+        } catch (Exception e) {\n+            throw new RuntimeException(e);\n+        }", "originalCommit": "80edd6ee0f01907ddae32e081bebde1ba96751d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY4MTk1MQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3683#discussion_r440681951", "bodyText": "I removed that as part of the refactoring to address other comments", "author": "dgomezferro", "createdAt": "2020-06-16T08:36:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQyMDgxMw=="}], "type": "inlineReview", "revised_code": {"commit": "ac3313fa3715aec4e56282b6fd498d92cd80fe91", "chunk": "diff --git a/hbase_sql/src/main/java/com/splicemachine/olap/OlapServerSubmitter.java b/hbase_sql/src/main/java/com/splicemachine/olap/OlapServerSubmitter.java\nindex f9f5d3e770..96e2551387 100644\n--- a/hbase_sql/src/main/java/com/splicemachine/olap/OlapServerSubmitter.java\n+++ b/hbase_sql/src/main/java/com/splicemachine/olap/OlapServerSubmitter.java\n\n@@ -244,21 +240,20 @@ public class OlapServerSubmitter implements Runnable {\n \n     }\n \n-    private byte[] getKeepAlivePayload() {\n-        DatabaseVersion version;\n-        try {\n-            version = JMXUtils.getLocalMBeanProxy(JMXUtils.SPLICEMACHINE_VERSION, DatabaseVersion.class);\n-        } catch (Exception e) {\n-            throw new RuntimeException(e);\n-        }\n-\n-        OlapMessage.KeepAlive message = OlapMessage.KeepAlive.newBuilder().setTime(System.currentTimeMillis())\n+    private void initKeepAlivePrototype() throws Exception {\n+        DatabaseVersion version = JMXUtils.getLocalMBeanProxy(JMXUtils.SPLICEMACHINE_VERSION, DatabaseVersion.class);\n+        keepAlivePrototype = OlapMessage.KeepAlive.newBuilder()\n                 .setMajor(version.getMajorVersionNumber())\n                 .setMinor(version.getMinorVersionNumber())\n                 .setPatch(version.getPatchVersionNumber())\n                 .setSprint(version.getSprintVersionNumber())\n-                .setImplementation(version.getImplementationVersion()).build();\n+                .setImplementation(version.getImplementationVersion()).buildPartial();\n+    }\n \n+    private byte[] getKeepAlivePayload() {\n+        OlapMessage.KeepAlive message = OlapMessage.KeepAlive.newBuilder(keepAlivePrototype)\n+                .setTime(System.currentTimeMillis())\n+                .build();\n         return message.toByteArray();\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQyNDg1MA==", "url": "https://github.com/splicemachine/spliceengine/pull/3683#discussion_r440424850", "bodyText": "Does version need to be re-read on every call? Can it be an instance, or even static, variable similar to OlapServerMaster?", "author": "OlegMazurov", "createdAt": "2020-06-15T20:22:19Z", "path": "hbase_sql/src/main/java/com/splicemachine/olap/OlapServerSubmitter.java", "diffHunk": "@@ -244,6 +244,24 @@ public void run() {\n \n     }\n \n+    private byte[] getKeepAlivePayload() {\n+        DatabaseVersion version;", "originalCommit": "80edd6ee0f01907ddae32e081bebde1ba96751d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY4Mjc2Mw==", "url": "https://github.com/splicemachine/spliceengine/pull/3683#discussion_r440682763", "bodyText": "I initialize a keepAlive message prototype once in the beginning with the version information and then use that to generate the payload with the time, so we only access the version once per OlapServer lifetime.", "author": "dgomezferro", "createdAt": "2020-06-16T08:37:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQyNDg1MA=="}], "type": "inlineReview", "revised_code": {"commit": "ac3313fa3715aec4e56282b6fd498d92cd80fe91", "chunk": "diff --git a/hbase_sql/src/main/java/com/splicemachine/olap/OlapServerSubmitter.java b/hbase_sql/src/main/java/com/splicemachine/olap/OlapServerSubmitter.java\nindex f9f5d3e770..96e2551387 100644\n--- a/hbase_sql/src/main/java/com/splicemachine/olap/OlapServerSubmitter.java\n+++ b/hbase_sql/src/main/java/com/splicemachine/olap/OlapServerSubmitter.java\n\n@@ -244,21 +240,20 @@ public class OlapServerSubmitter implements Runnable {\n \n     }\n \n-    private byte[] getKeepAlivePayload() {\n-        DatabaseVersion version;\n-        try {\n-            version = JMXUtils.getLocalMBeanProxy(JMXUtils.SPLICEMACHINE_VERSION, DatabaseVersion.class);\n-        } catch (Exception e) {\n-            throw new RuntimeException(e);\n-        }\n-\n-        OlapMessage.KeepAlive message = OlapMessage.KeepAlive.newBuilder().setTime(System.currentTimeMillis())\n+    private void initKeepAlivePrototype() throws Exception {\n+        DatabaseVersion version = JMXUtils.getLocalMBeanProxy(JMXUtils.SPLICEMACHINE_VERSION, DatabaseVersion.class);\n+        keepAlivePrototype = OlapMessage.KeepAlive.newBuilder()\n                 .setMajor(version.getMajorVersionNumber())\n                 .setMinor(version.getMinorVersionNumber())\n                 .setPatch(version.getPatchVersionNumber())\n                 .setSprint(version.getSprintVersionNumber())\n-                .setImplementation(version.getImplementationVersion()).build();\n+                .setImplementation(version.getImplementationVersion()).buildPartial();\n+    }\n \n+    private byte[] getKeepAlivePayload() {\n+        OlapMessage.KeepAlive message = OlapMessage.KeepAlive.newBuilder(keepAlivePrototype)\n+                .setTime(System.currentTimeMillis())\n+                .build();\n         return message.toByteArray();\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU0NzQ4MQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3683#discussion_r440547481", "bodyText": "Is this code possible after the change? Should we still ignore it?", "author": "OlegMazurov", "createdAt": "2020-06-16T02:17:37Z", "path": "hbase_sql/src/main/java/com/splicemachine/olap/OlapServerSubmitter.java", "diffHunk": "@@ -166,10 +163,13 @@ public void run() {\n                         public void run() {\n                             RecoverableZooKeeper zk = ZkUtils.getRecoverableZooKeeper();\n                             String root = HConfiguration.getConfiguration().getSpliceRootPath();\n-                            String path = root + HBaseConfiguration.OLAP_SERVER_PATH + HBaseConfiguration.OLAP_SERVER_KEEP_ALIVE_PATH + \"/\" + appName;\n-                            byte[] payload = Bytes.toBytes(System.currentTimeMillis());\n+                            String keepAlivePath = root + HBaseConfiguration.OLAP_SERVER_PATH + HBaseConfiguration.OLAP_SERVER_KEEP_ALIVE_PATH + \"/\" + appName;\n+\n+                            byte[] payload = getKeepAlivePayload();\n                             try {\n-                                zk.create(path, payload, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);\n+                                // clean up node if it exists\n+                                ZkUtils.safeDelete(keepAlivePath, -1);\n+                                zk.create(keepAlivePath, payload, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);\n                             } catch (KeeperException ke) {\n                                 if (ke.code().equals(NODEEXISTS)) {", "originalCommit": "80edd6ee0f01907ddae32e081bebde1ba96751d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY4MjkxNw==", "url": "https://github.com/splicemachine/spliceengine/pull/3683#discussion_r440682917", "bodyText": "I removed it, good point", "author": "dgomezferro", "createdAt": "2020-06-16T08:38:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU0NzQ4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "ac3313fa3715aec4e56282b6fd498d92cd80fe91", "chunk": "diff --git a/hbase_sql/src/main/java/com/splicemachine/olap/OlapServerSubmitter.java b/hbase_sql/src/main/java/com/splicemachine/olap/OlapServerSubmitter.java\nindex f9f5d3e770..96e2551387 100644\n--- a/hbase_sql/src/main/java/com/splicemachine/olap/OlapServerSubmitter.java\n+++ b/hbase_sql/src/main/java/com/splicemachine/olap/OlapServerSubmitter.java\n\n@@ -170,13 +173,6 @@ public class OlapServerSubmitter implements Runnable {\n                                 // clean up node if it exists\n                                 ZkUtils.safeDelete(keepAlivePath, -1);\n                                 zk.create(keepAlivePath, payload, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);\n-                            } catch (KeeperException ke) {\n-                                if (ke.code().equals(NODEEXISTS)) {\n-                                    // ignore\n-                                } else {\n-                                    LOG.error(\"Couldn't create keepAlive for OlapServer-\"+queueName, ke);\n-                                    return;\n-                                }\n                             } catch (Exception e) {\n                                 LOG.error(\"Couldn't create keepAlive for OlapServer-\"+queueName, e);\n                                 return;\n"}}, {"oid": "ac3313fa3715aec4e56282b6fd498d92cd80fe91", "url": "https://github.com/splicemachine/spliceengine/commit/ac3313fa3715aec4e56282b6fd498d92cd80fe91", "message": "DB-9665 Address reviews\n\nInitialize partial keepAlive message with version data once and update time when\ngenerating the payload", "committedDate": "2020-06-16T08:33:52Z", "type": "commit"}]}