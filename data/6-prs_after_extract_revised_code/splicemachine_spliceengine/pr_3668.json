{"pr_number": 3668, "pr_title": "DB-8190 DB-9604 Make Spark fetch and shuffle partitions configurable", "pr_createdAt": "2020-06-10T10:10:25Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/3668", "timeline": [{"oid": "99637dc49929197679b043afbc3ba058e11ab30b", "url": "https://github.com/splicemachine/spliceengine/commit/99637dc49929197679b043afbc3ba058e11ab30b", "message": "DB-8190 Make ParallelPartitions configurable", "committedDate": "2020-06-09T14:40:18Z", "type": "commit"}, {"oid": "c5d6ed1fce94ada9cae0a6bed81c0d594c550397", "url": "https://github.com/splicemachine/spliceengine/commit/c5d6ed1fce94ada9cae0a6bed81c0d594c550397", "message": "DB-9604 Make spark shuffle partitions configurable", "committedDate": "2020-06-09T14:40:49Z", "type": "commit"}, {"oid": "319406a823cbc845302de4aa4609007a97f32e7f", "url": "https://github.com/splicemachine/spliceengine/commit/319406a823cbc845302de4aa4609007a97f32e7f", "message": "DB-8190 DB-9604 Fix connection string properties", "committedDate": "2020-06-10T10:07:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk4MDY3NA==", "url": "https://github.com/splicemachine/spliceengine/pull/3668#discussion_r438980674", "bodyText": "Is it possible session is not initialized and null when getSession s called first time?", "author": "jyuanca", "createdAt": "2020-06-11T18:13:28Z", "path": "hbase_sql/src/main/java/com/splicemachine/derby/impl/SpliceSpark.java", "diffHunk": "@@ -70,14 +71,23 @@ private SpliceSpark() {} // private constructor forbids creating instances\n     private static final String OLD_SCOPE_KEY = \"spark.rdd.scope.old\";\n     private static final String OLD_SCOPE_OVERRIDE = \"spark.rdd.scope.noOverride.old\";\n \n+    public static void resetSession() {\n+        sessions.remove();\n+    }\n+\n     // Sets both ctx and session\n     public static synchronized SparkSession getSession() {\n         String threadName = Thread.currentThread().getName();\n         if (!SpliceClient.isClient() && !threadName.startsWith(\"olap-worker-\")) {\n              // Not running on the Olap Server... raise exception. Use getSessionUnsafe() if you know what you are doing.\n             throw new RuntimeException(\"Trying to get a SparkSession from outside the OlapServer\");\n         }\n-        return getSessionUnsafe();\n+        SparkSession result = sessions.get();\n+        if (result == null) {\n+            result = session.newSession();", "originalCommit": "319406a823cbc845302de4aa4609007a97f32e7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY4NDAyMA==", "url": "https://github.com/splicemachine/spliceengine/pull/3668#discussion_r440684020", "bodyText": "Nice catch, I'm calling getSessionUnsafe() now to guarantee it's properly initialized", "author": "dgomezferro", "createdAt": "2020-06-16T08:39:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk4MDY3NA=="}], "type": "inlineReview", "revised_code": {"commit": "6f1684c81f814292d59265cdfadfd3e56f9b4739", "chunk": "diff --git a/hbase_sql/src/main/java/com/splicemachine/derby/impl/SpliceSpark.java b/hbase_sql/src/main/java/com/splicemachine/derby/impl/SpliceSpark.java\nindex 5cfb9c880c..651818c3c6 100644\n--- a/hbase_sql/src/main/java/com/splicemachine/derby/impl/SpliceSpark.java\n+++ b/hbase_sql/src/main/java/com/splicemachine/derby/impl/SpliceSpark.java\n\n@@ -84,7 +84,7 @@ public class SpliceSpark {\n         }\n         SparkSession result = sessions.get();\n         if (result == null) {\n-            result = session.newSession();\n+            result = getSessionUnsafe().newSession();\n             sessions.set(result);\n         }\n         return result;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTAwNzg5OA==", "url": "https://github.com/splicemachine/spliceengine/pull/3668#discussion_r439007898", "bodyText": "Why do we need to set shuffle partition property both here and in QueryJob?", "author": "yxia92", "createdAt": "2020-06-11T19:05:30Z", "path": "hbase_sql/src/main/java/com/splicemachine/stream/StreamableRDD.java", "diffHunk": "@@ -153,6 +156,8 @@ private void submitBatch(int batch, int batchSize, int numPartitions, final Java\n             public Object call() throws Exception {\n                 SparkContext sc = SpliceSpark.getContextUnsafe().sc();\n                 sc.setLocalProperties(properties);\n+                if (shufflePartitions != null)\n+                    sc.setLocalProperty(SQLConf.SHUFFLE_PARTITIONS().key(), shufflePartitions.toString());", "originalCommit": "c5d6ed1fce94ada9cae0a6bed81c0d594c550397", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY3Mzc3Nw==", "url": "https://github.com/splicemachine/spliceengine/pull/3668#discussion_r440673777", "bodyText": "This wasn't needed, it was an initial attempt at fixing the problem that didn't work out, nice catch!", "author": "dgomezferro", "createdAt": "2020-06-16T08:23:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTAwNzg5OA=="}], "type": "inlineReview", "revised_code": {"commit": "cf20af02b3bf7ee7a11de04c35b2d60d621c344c", "chunk": "diff --git a/hbase_sql/src/main/java/com/splicemachine/stream/StreamableRDD.java b/hbase_sql/src/main/java/com/splicemachine/stream/StreamableRDD.java\nindex 61a1443493..cfc4d534d7 100644\n--- a/hbase_sql/src/main/java/com/splicemachine/stream/StreamableRDD.java\n+++ b/hbase_sql/src/main/java/com/splicemachine/stream/StreamableRDD.java\n\n@@ -156,8 +154,6 @@ public class StreamableRDD<T> {\n             public Object call() throws Exception {\n                 SparkContext sc = SpliceSpark.getContextUnsafe().sc();\n                 sc.setLocalProperties(properties);\n-                if (shufflePartitions != null)\n-                    sc.setLocalProperty(SQLConf.SHUFFLE_PARTITIONS().key(), shufflePartitions.toString());\n                 AtomicBoolean cont = new AtomicBoolean(true);\n                 SimpleFutureAction<Boolean> job = sc.submitJob(streamed.rdd(), new FunctionAdapter(), objects, new AbstractFunction2<Object, String, BoxedUnit>() {\n                     @Override\n"}}, {"oid": "cf20af02b3bf7ee7a11de04c35b2d60d621c344c", "url": "https://github.com/splicemachine/spliceengine/commit/cf20af02b3bf7ee7a11de04c35b2d60d621c344c", "message": "DB-9604 Remove shufflePartitions from StreamableRDD\n\nThat was dead code", "committedDate": "2020-06-12T10:47:13Z", "type": "commit"}, {"oid": "3760e9c2370913b5bc16826243941b062587e4b0", "url": "https://github.com/splicemachine/spliceengine/commit/3760e9c2370913b5bc16826243941b062587e4b0", "message": "Merge remote-tracking branch 'origin/master' into DB-8190-DB-9604", "committedDate": "2020-06-12T14:58:28Z", "type": "commit"}, {"oid": "6f1684c81f814292d59265cdfadfd3e56f9b4739", "url": "https://github.com/splicemachine/spliceengine/commit/6f1684c81f814292d59265cdfadfd3e56f9b4739", "message": "DB-9604 Make sure session is always initialized", "committedDate": "2020-06-16T08:39:03Z", "type": "commit"}]}