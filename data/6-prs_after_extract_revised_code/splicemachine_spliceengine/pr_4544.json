{"pr_number": 4544, "pr_title": "DB-10483 Support DEC and DECIMAL functions", "pr_createdAt": "2020-11-11T11:58:19Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/4544", "timeline": [{"oid": "e075f66e2f14413e3e9651bc83a0c35be79f4651", "url": "https://github.com/splicemachine/spliceengine/commit/e075f66e2f14413e3e9651bc83a0c35be79f4651", "message": "DB-10483 ascii art, make multiary function node table human-readable.", "committedDate": "2020-11-09T11:40:10Z", "type": "commit"}, {"oid": "fcf552c68bb7d837d9874c9a025a9c7469396744", "url": "https://github.com/splicemachine/spliceengine/commit/fcf552c68bb7d837d9874c9a025a9c7469396744", "message": "DB-10483 support DB2 DEC[IMAL] function.", "committedDate": "2020-11-11T11:23:07Z", "type": "commit"}, {"oid": "a06b1240d8bdb862de23292fc65bbe95d490408c", "url": "https://github.com/splicemachine/spliceengine/commit/a06b1240d8bdb862de23292fc65bbe95d490408c", "message": "DB-10483 add more tests.", "committedDate": "2020-11-11T11:53:20Z", "type": "commit"}, {"oid": "4471c8a70535963339aa217255fdb94d29687bfe", "url": "https://github.com/splicemachine/spliceengine/commit/4471c8a70535963339aa217255fdb94d29687bfe", "message": "DB-10483 address SpotBugs issues.", "committedDate": "2020-11-11T12:07:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM0MzcyMA==", "url": "https://github.com/splicemachine/spliceengine/pull/4544#discussion_r521343720", "bodyText": "I think you can remove that reference. We will have our own documentation.", "author": "arnaud-splice", "createdAt": "2020-11-11T13:04:23Z", "path": "db-engine/src/main/java/com/splicemachine/db/iapi/util/DecimalUtil.java", "diffHunk": "@@ -0,0 +1,130 @@\n+/*\n+ * Copyright (c) 2012 - 2020 Splice Machine, Inc.\n+ * This file is part of Splice Machine.\n+ * Splice Machine is free software: you can redistribute it and/or modify it under the terms of the\n+ * GNU Affero General Public License as published by the Free Software Foundation, either\n+ * version 3, or (at your option) any later version.\n+ * Splice Machine is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;\n+ * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n+ * See the GNU Affero General Public License for more details.\n+ * You should have received a copy of the GNU Affero General Public License along with Splice Machine.\n+ * If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package com.splicemachine.db.iapi.util;\n+\n+import com.splicemachine.db.iapi.error.StandardException;\n+import com.splicemachine.db.iapi.reference.SQLState;\n+import com.splicemachine.db.iapi.types.DataValueDescriptor;\n+import com.splicemachine.db.iapi.types.DataValueFactoryImpl;\n+import com.splicemachine.db.iapi.types.SQLDecfloat;\n+import com.splicemachine.db.iapi.types.SQLDecimal;\n+import com.splicemachine.primitives.Bytes;\n+\n+import java.math.BigDecimal;\n+import java.math.BigInteger;\n+import java.sql.Timestamp;\n+import java.util.Calendar;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+\n+public interface DecimalUtil {\n+\n+    /**", "originalCommit": "4471c8a70535963339aa217255fdb94d29687bfe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTUwNDU2Nw==", "url": "https://github.com/splicemachine/spliceengine/pull/4544#discussion_r521504567", "bodyText": "I would rather keep it for reference (even our documentation will be mirroring that some way of the other I think).", "author": "hatyo", "createdAt": "2020-11-11T17:03:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM0MzcyMA=="}], "type": "inlineReview", "revised_code": {"commit": "4fc182eacab9bf8fa9f73c16907e042a07547b8f", "chunk": "diff --git a/db-engine/src/main/java/com/splicemachine/db/iapi/util/DecimalUtil.java b/db-engine/src/main/java/com/splicemachine/db/iapi/util/DecimalUtil.java\nindex d838572380..722d846d4b 100644\n--- a/db-engine/src/main/java/com/splicemachine/db/iapi/util/DecimalUtil.java\n+++ b/db-engine/src/main/java/com/splicemachine/db/iapi/util/DecimalUtil.java\n\n@@ -24,7 +24,9 @@ import com.splicemachine.primitives.Bytes;\n import java.math.BigDecimal;\n import java.math.BigInteger;\n import java.sql.Timestamp;\n+import java.text.DecimalFormatSymbols;\n import java.util.Calendar;\n+import java.util.Locale;\n import java.util.regex.Matcher;\n import java.util.regex.Pattern;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM0NTY1Mw==", "url": "https://github.com/splicemachine/spliceengine/pull/4544#discussion_r521345653", "bodyText": "Why not construct a SQLDecimal directly from the string?", "author": "arnaud-splice", "createdAt": "2020-11-11T13:07:54Z", "path": "db-engine/src/main/java/com/splicemachine/db/iapi/util/DecimalUtil.java", "diffHunk": "@@ -0,0 +1,130 @@\n+/*\n+ * Copyright (c) 2012 - 2020 Splice Machine, Inc.\n+ * This file is part of Splice Machine.\n+ * Splice Machine is free software: you can redistribute it and/or modify it under the terms of the\n+ * GNU Affero General Public License as published by the Free Software Foundation, either\n+ * version 3, or (at your option) any later version.\n+ * Splice Machine is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;\n+ * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n+ * See the GNU Affero General Public License for more details.\n+ * You should have received a copy of the GNU Affero General Public License along with Splice Machine.\n+ * If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package com.splicemachine.db.iapi.util;\n+\n+import com.splicemachine.db.iapi.error.StandardException;\n+import com.splicemachine.db.iapi.reference.SQLState;\n+import com.splicemachine.db.iapi.types.DataValueDescriptor;\n+import com.splicemachine.db.iapi.types.DataValueFactoryImpl;\n+import com.splicemachine.db.iapi.types.SQLDecfloat;\n+import com.splicemachine.db.iapi.types.SQLDecimal;\n+import com.splicemachine.primitives.Bytes;\n+\n+import java.math.BigDecimal;\n+import java.math.BigInteger;\n+import java.sql.Timestamp;\n+import java.util.Calendar;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+\n+public interface DecimalUtil {\n+\n+    /**\n+     * Implements DB2 decimal function, for more information go to:\n+     * https://www.ibm.com/support/producthub/db2/docs/content/SSEPGG_11.5.0/com.ibm.db2.luw.sql.ref.doc/doc/r0000791.html\n+     */\n+    static DataValueDescriptor getDecimalDb2(DataValueDescriptor dvd,\n+                                             int precision,\n+                                             int scale,\n+                                             String decimalCharacter) throws StandardException {\n+        if (dvd == null || dvd.isNull()) {\n+            return null;\n+        }\n+        BigDecimal bigDecimal = null;\n+        Calendar cal = null;\n+        switch (DataValueFactoryImpl.Format.formatFor(dvd)) {\n+            case TINYINT: // fallthrough\n+            case SMALLINT: // fallthrough\n+            case INTEGER: // fallthrough\n+            case LONGINT: {\n+                if (String.valueOf(Math.abs(dvd.getLong())).length() > (precision - scale)) {\n+                    throw StandardException.newException(SQLState.LANG_INVALID_DECIMAL_CONVERSION, dvd.toString(), precision, scale); // DB2 SQLSTATE 22003\n+                }\n+                bigDecimal = new BigDecimal(new BigInteger(Bytes.toBytes(dvd.getLong())), 0);\n+            }\n+            break;\n+            case DECIMAL: {\n+                bigDecimal = SQLDecimal.getBigDecimal(dvd);\n+                if (bigDecimal == null) return null;\n+            }\n+            break;\n+            case DECFLOAT: {\n+                bigDecimal = SQLDecfloat.getBigDecimal(dvd);\n+                if (bigDecimal == null) return null;\n+            }\n+            break;\n+            case CHAR: // fallthrough", "originalCommit": "4471c8a70535963339aa217255fdb94d29687bfe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTUwNTMxNw==", "url": "https://github.com/splicemachine/spliceengine/pull/4544#discussion_r521505317", "bodyText": "The string could contain invalid characters, it could also contain a comma for example and decimal separator(s), I want to catch as many of these errors as possible giving corresponding error messages before actually parsing it into decimal.", "author": "hatyo", "createdAt": "2020-11-11T17:04:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM0NTY1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "4fc182eacab9bf8fa9f73c16907e042a07547b8f", "chunk": "diff --git a/db-engine/src/main/java/com/splicemachine/db/iapi/util/DecimalUtil.java b/db-engine/src/main/java/com/splicemachine/db/iapi/util/DecimalUtil.java\nindex d838572380..722d846d4b 100644\n--- a/db-engine/src/main/java/com/splicemachine/db/iapi/util/DecimalUtil.java\n+++ b/db-engine/src/main/java/com/splicemachine/db/iapi/util/DecimalUtil.java\n\n@@ -24,7 +24,9 @@ import com.splicemachine.primitives.Bytes;\n import java.math.BigDecimal;\n import java.math.BigInteger;\n import java.sql.Timestamp;\n+import java.text.DecimalFormatSymbols;\n import java.util.Calendar;\n+import java.util.Locale;\n import java.util.regex.Matcher;\n import java.util.regex.Pattern;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM4NDExNQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4544#discussion_r521384115", "bodyText": "Use BigInteger.valueOf(long val) instead", "author": "dgomezferro", "createdAt": "2020-11-11T14:11:22Z", "path": "db-engine/src/main/java/com/splicemachine/db/iapi/util/DecimalUtil.java", "diffHunk": "@@ -0,0 +1,130 @@\n+/*\n+ * Copyright (c) 2012 - 2020 Splice Machine, Inc.\n+ * This file is part of Splice Machine.\n+ * Splice Machine is free software: you can redistribute it and/or modify it under the terms of the\n+ * GNU Affero General Public License as published by the Free Software Foundation, either\n+ * version 3, or (at your option) any later version.\n+ * Splice Machine is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;\n+ * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n+ * See the GNU Affero General Public License for more details.\n+ * You should have received a copy of the GNU Affero General Public License along with Splice Machine.\n+ * If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package com.splicemachine.db.iapi.util;\n+\n+import com.splicemachine.db.iapi.error.StandardException;\n+import com.splicemachine.db.iapi.reference.SQLState;\n+import com.splicemachine.db.iapi.types.DataValueDescriptor;\n+import com.splicemachine.db.iapi.types.DataValueFactoryImpl;\n+import com.splicemachine.db.iapi.types.SQLDecfloat;\n+import com.splicemachine.db.iapi.types.SQLDecimal;\n+import com.splicemachine.primitives.Bytes;\n+\n+import java.math.BigDecimal;\n+import java.math.BigInteger;\n+import java.sql.Timestamp;\n+import java.util.Calendar;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+\n+public interface DecimalUtil {\n+\n+    /**\n+     * Implements DB2 decimal function, for more information go to:\n+     * https://www.ibm.com/support/producthub/db2/docs/content/SSEPGG_11.5.0/com.ibm.db2.luw.sql.ref.doc/doc/r0000791.html\n+     */\n+    static DataValueDescriptor getDecimalDb2(DataValueDescriptor dvd,\n+                                             int precision,\n+                                             int scale,\n+                                             String decimalCharacter) throws StandardException {\n+        if (dvd == null || dvd.isNull()) {\n+            return null;\n+        }\n+        BigDecimal bigDecimal = null;\n+        Calendar cal = null;\n+        switch (DataValueFactoryImpl.Format.formatFor(dvd)) {\n+            case TINYINT: // fallthrough\n+            case SMALLINT: // fallthrough\n+            case INTEGER: // fallthrough\n+            case LONGINT: {\n+                if (String.valueOf(Math.abs(dvd.getLong())).length() > (precision - scale)) {\n+                    throw StandardException.newException(SQLState.LANG_INVALID_DECIMAL_CONVERSION, dvd.toString(), precision, scale); // DB2 SQLSTATE 22003\n+                }\n+                bigDecimal = new BigDecimal(new BigInteger(Bytes.toBytes(dvd.getLong())), 0);", "originalCommit": "4471c8a70535963339aa217255fdb94d29687bfe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTUwNjAxMg==", "url": "https://github.com/splicemachine/spliceengine/pull/4544#discussion_r521506012", "bodyText": "done.", "author": "hatyo", "createdAt": "2020-11-11T17:05:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM4NDExNQ=="}], "type": "inlineReview", "revised_code": {"commit": "4fc182eacab9bf8fa9f73c16907e042a07547b8f", "chunk": "diff --git a/db-engine/src/main/java/com/splicemachine/db/iapi/util/DecimalUtil.java b/db-engine/src/main/java/com/splicemachine/db/iapi/util/DecimalUtil.java\nindex d838572380..722d846d4b 100644\n--- a/db-engine/src/main/java/com/splicemachine/db/iapi/util/DecimalUtil.java\n+++ b/db-engine/src/main/java/com/splicemachine/db/iapi/util/DecimalUtil.java\n\n@@ -24,7 +24,9 @@ import com.splicemachine.primitives.Bytes;\n import java.math.BigDecimal;\n import java.math.BigInteger;\n import java.sql.Timestamp;\n+import java.text.DecimalFormatSymbols;\n import java.util.Calendar;\n+import java.util.Locale;\n import java.util.regex.Matcher;\n import java.util.regex.Pattern;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM4ODU4OQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4544#discussion_r521388589", "bodyText": "Isn't this removing the decimalCharacter? How do we use it later?", "author": "dgomezferro", "createdAt": "2020-11-11T14:18:14Z", "path": "db-engine/src/main/java/com/splicemachine/db/iapi/util/DecimalUtil.java", "diffHunk": "@@ -0,0 +1,130 @@\n+/*\n+ * Copyright (c) 2012 - 2020 Splice Machine, Inc.\n+ * This file is part of Splice Machine.\n+ * Splice Machine is free software: you can redistribute it and/or modify it under the terms of the\n+ * GNU Affero General Public License as published by the Free Software Foundation, either\n+ * version 3, or (at your option) any later version.\n+ * Splice Machine is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;\n+ * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n+ * See the GNU Affero General Public License for more details.\n+ * You should have received a copy of the GNU Affero General Public License along with Splice Machine.\n+ * If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package com.splicemachine.db.iapi.util;\n+\n+import com.splicemachine.db.iapi.error.StandardException;\n+import com.splicemachine.db.iapi.reference.SQLState;\n+import com.splicemachine.db.iapi.types.DataValueDescriptor;\n+import com.splicemachine.db.iapi.types.DataValueFactoryImpl;\n+import com.splicemachine.db.iapi.types.SQLDecfloat;\n+import com.splicemachine.db.iapi.types.SQLDecimal;\n+import com.splicemachine.primitives.Bytes;\n+\n+import java.math.BigDecimal;\n+import java.math.BigInteger;\n+import java.sql.Timestamp;\n+import java.util.Calendar;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+\n+public interface DecimalUtil {\n+\n+    /**\n+     * Implements DB2 decimal function, for more information go to:\n+     * https://www.ibm.com/support/producthub/db2/docs/content/SSEPGG_11.5.0/com.ibm.db2.luw.sql.ref.doc/doc/r0000791.html\n+     */\n+    static DataValueDescriptor getDecimalDb2(DataValueDescriptor dvd,\n+                                             int precision,\n+                                             int scale,\n+                                             String decimalCharacter) throws StandardException {\n+        if (dvd == null || dvd.isNull()) {\n+            return null;\n+        }\n+        BigDecimal bigDecimal = null;\n+        Calendar cal = null;\n+        switch (DataValueFactoryImpl.Format.formatFor(dvd)) {\n+            case TINYINT: // fallthrough\n+            case SMALLINT: // fallthrough\n+            case INTEGER: // fallthrough\n+            case LONGINT: {\n+                if (String.valueOf(Math.abs(dvd.getLong())).length() > (precision - scale)) {\n+                    throw StandardException.newException(SQLState.LANG_INVALID_DECIMAL_CONVERSION, dvd.toString(), precision, scale); // DB2 SQLSTATE 22003\n+                }\n+                bigDecimal = new BigDecimal(new BigInteger(Bytes.toBytes(dvd.getLong())), 0);\n+            }\n+            break;\n+            case DECIMAL: {\n+                bigDecimal = SQLDecimal.getBigDecimal(dvd);\n+                if (bigDecimal == null) return null;\n+            }\n+            break;\n+            case DECFLOAT: {\n+                bigDecimal = SQLDecfloat.getBigDecimal(dvd);\n+                if (bigDecimal == null) return null;\n+            }\n+            break;\n+            case CHAR: // fallthrough\n+            case VARCHAR: {\n+                String input = dvd.getString();\n+                if (input == null) return null;\n+                input = input.trim().replace(decimalCharacter, \"\");", "originalCommit": "4471c8a70535963339aa217255fdb94d29687bfe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM5Njg1Mw==", "url": "https://github.com/splicemachine/spliceengine/pull/4544#discussion_r521396853", "bodyText": "After seeing the ITs I think you are using as \"digit group separator\" but I'm pretty sure it's supposed to be the \"fractional separator\". From the docs:\n\nit can appear at most once in string-expression\n\nand\n\nDigits are truncated from the end of the decimal number if the number of digits to the right of the decimal separator character is greater than the scale scale. An error is returned if the number of significant digits to the left of the decimal character (the whole part of the number) in string-expression is greater than precision - scale", "author": "dgomezferro", "createdAt": "2020-11-11T14:30:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM4ODU4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTUwODY3Ng==", "url": "https://github.com/splicemachine/spliceengine/pull/4544#discussion_r521508676", "bodyText": "You're right, I glimpsed over that, thanks for pointing it out.", "author": "hatyo", "createdAt": "2020-11-11T17:09:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM4ODU4OQ=="}], "type": "inlineReview", "revised_code": {"commit": "4fc182eacab9bf8fa9f73c16907e042a07547b8f", "chunk": "diff --git a/db-engine/src/main/java/com/splicemachine/db/iapi/util/DecimalUtil.java b/db-engine/src/main/java/com/splicemachine/db/iapi/util/DecimalUtil.java\nindex d838572380..722d846d4b 100644\n--- a/db-engine/src/main/java/com/splicemachine/db/iapi/util/DecimalUtil.java\n+++ b/db-engine/src/main/java/com/splicemachine/db/iapi/util/DecimalUtil.java\n\n@@ -24,7 +24,9 @@ import com.splicemachine.primitives.Bytes;\n import java.math.BigDecimal;\n import java.math.BigInteger;\n import java.sql.Timestamp;\n+import java.text.DecimalFormatSymbols;\n import java.util.Calendar;\n+import java.util.Locale;\n import java.util.regex.Matcher;\n import java.util.regex.Pattern;\n \n"}}, {"oid": "4fc182eacab9bf8fa9f73c16907e042a07547b8f", "url": "https://github.com/splicemachine/spliceengine/commit/4fc182eacab9bf8fa9f73c16907e042a07547b8f", "message": "DB-10483 address comments.", "committedDate": "2020-11-11T22:51:02Z", "type": "commit"}, {"oid": "9e083b7d698f78312f259fc1b62316611262ca51", "url": "https://github.com/splicemachine/spliceengine/commit/9e083b7d698f78312f259fc1b62316611262ca51", "message": "Merge remote-tracking branch 'origin/master' into DB-10483", "committedDate": "2020-11-12T08:05:39Z", "type": "commit"}, {"oid": "68ec7b376ed2385f2175525680c59a9277c27c33", "url": "https://github.com/splicemachine/spliceengine/commit/68ec7b376ed2385f2175525680c59a9277c27c33", "message": "Merge branch 'master' into DB-10483", "committedDate": "2020-11-13T00:50:19Z", "type": "commit"}]}