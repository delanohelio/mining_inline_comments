{"pr_number": 4689, "pr_title": "DB-10774 Wrap SetOp subquery in a derived table so it can be flattened.", "pr_createdAt": "2020-11-24T19:01:17Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/4689", "timeline": [{"oid": "e520ff3c090a859c1f40c952c634f4b6476681d9", "url": "https://github.com/splicemachine/spliceengine/commit/e520ff3c090a859c1f40c952c634f4b6476681d9", "message": "DB-10774 Wrap SetOp subquery in a derived table so it can be flattened.", "committedDate": "2020-11-24T19:24:47Z", "type": "commit"}, {"oid": "e520ff3c090a859c1f40c952c634f4b6476681d9", "url": "https://github.com/splicemachine/spliceengine/commit/e520ff3c090a859c1f40c952c634f4b6476681d9", "message": "DB-10774 Wrap SetOp subquery in a derived table so it can be flattened.", "committedDate": "2020-11-24T19:24:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTkzMTcwMQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4689#discussion_r529931701", "bodyText": "Not used", "author": "dgomezferro", "createdAt": "2020-11-24T22:18:44Z", "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/SubqueryNode.java", "diffHunk": "@@ -403,6 +406,107 @@ public ValueNode remapColumnReferencesToExpressions() throws StandardException{\n         return this;\n     }\n \n+    private void updateColumnNamesInSetQuery(SetOperatorNode setOperatorNode,\n+                                             String columnName,\n+                                             int columnPosition)   throws StandardException {\n+        ResultColumn rc;\n+        boolean replacementDone = false;", "originalCommit": "e520ff3c090a859c1f40c952c634f4b6476681d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDAxNjY2Ng==", "url": "https://github.com/splicemachine/spliceengine/pull/4689#discussion_r530016666", "bodyText": "Removed it.", "author": "msirek", "createdAt": "2020-11-24T23:45:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTkzMTcwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "726120377daba8cdc910ea6c81351af68cb7fc8f", "chunk": "diff --git a/db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/SubqueryNode.java b/db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/SubqueryNode.java\nindex 24161421ea..28e4beb9ae 100644\n--- a/db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/SubqueryNode.java\n+++ b/db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/SubqueryNode.java\n\n@@ -410,7 +410,6 @@ public class SubqueryNode extends ValueNode{\n                                              String columnName,\n                                              int columnPosition)   throws StandardException {\n         ResultColumn rc;\n-        boolean replacementDone = false;\n         if (setOperatorNode.getLeftResultSet() instanceof SetOperatorNode) {\n             updateColumnNamesInSetQuery((SetOperatorNode)setOperatorNode.getLeftResultSet(), columnName, columnPosition);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTkyNTM3Nw==", "url": "https://github.com/splicemachine/spliceengine/pull/4689#discussion_r529925377", "bodyText": "subqueryType cannot be NOT_EXISTS_SUBQUERY at this point, so we can safely remove this condition. subqueryType is modified later when eliminateNots is called in preprocssing the predicate containing this subquery.", "author": "ascend1", "createdAt": "2020-11-24T22:12:35Z", "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/SubqueryNode.java", "diffHunk": "@@ -425,6 +529,16 @@ public ValueNode bindExpression(FromList fromList,\n         //check if subquery is allowed in expression tree\n         checkReliability(CompilerContext.SUBQUERY_ILLEGAL,SQLState.LANG_SUBQUERY);\n \n+        // Rewrite a set operator tree so it's wrapped in a derived table.\n+        // This allows it to be flattenable, allowing for more efficient joins.\n+        // Disallow multicolumn IN/NOT IN for now to be safe.\n+        if (resultSet instanceof SetOperatorNode &&\n+            this.subqueryType != SubqueryNode.FROM_SUBQUERY &&\n+            (resultSet.getResultColumns().size() == 1 ||\n+             this.subqueryType == EXISTS_SUBQUERY     ||\n+             this.subqueryType == NOT_EXISTS_SUBQUERY ))", "originalCommit": "e520ff3c090a859c1f40c952c634f4b6476681d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDAxNjU1NQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4689#discussion_r530016555", "bodyText": "OK, removed it.", "author": "msirek", "createdAt": "2020-11-24T23:45:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTkyNTM3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "726120377daba8cdc910ea6c81351af68cb7fc8f", "chunk": "diff --git a/db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/SubqueryNode.java b/db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/SubqueryNode.java\nindex 24161421ea..28e4beb9ae 100644\n--- a/db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/SubqueryNode.java\n+++ b/db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/SubqueryNode.java\n\n@@ -535,8 +534,7 @@ public class SubqueryNode extends ValueNode{\n         if (resultSet instanceof SetOperatorNode &&\n             this.subqueryType != SubqueryNode.FROM_SUBQUERY &&\n             (resultSet.getResultColumns().size() == 1 ||\n-             this.subqueryType == EXISTS_SUBQUERY     ||\n-             this.subqueryType == NOT_EXISTS_SUBQUERY ))\n+             this.subqueryType == EXISTS_SUBQUERY))\n             wrapSetQueryInDerivedTable();\n \n         resultColumns=resultSet.getResultColumns();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTk1OTA2OQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4689#discussion_r529959069", "bodyText": "These two seem to be always nulls. Should we just pass in null, null or I missed something here?", "author": "ascend1", "createdAt": "2020-11-24T22:44:18Z", "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/SubqueryNode.java", "diffHunk": "@@ -403,6 +406,107 @@ public ValueNode remapColumnReferencesToExpressions() throws StandardException{\n         return this;\n     }\n \n+    private void updateColumnNamesInSetQuery(SetOperatorNode setOperatorNode,\n+                                             String columnName,\n+                                             int columnPosition)   throws StandardException {\n+        ResultColumn rc;\n+        boolean replacementDone = false;\n+        if (setOperatorNode.getLeftResultSet() instanceof SetOperatorNode) {\n+            updateColumnNamesInSetQuery((SetOperatorNode)setOperatorNode.getLeftResultSet(), columnName, columnPosition);\n+\n+        }\n+        else {\n+            rc = setOperatorNode.getLeftResultSet().getResultColumns().elementAt(columnPosition);\n+            rc.setName(columnName);\n+        }\n+        if (setOperatorNode.getRightResultSet() instanceof SetOperatorNode)\n+            updateColumnNamesInSetQuery((SetOperatorNode)setOperatorNode.getRightResultSet(), columnName, columnPosition);\n+        else {\n+            rc = setOperatorNode.getRightResultSet().getResultColumns().elementAt(columnPosition);\n+            rc.setName(columnName);\n+        }\n+        rc = setOperatorNode.getResultColumns().elementAt(columnPosition);;\n+        rc.setName(columnName);\n+        ColumnReference columnReference = (ColumnReference) getNodeFactory().getNode(\n+            C_NodeTypes.COLUMN_REFERENCE,\n+            columnName,\n+            null,\n+            getContextManager());\n+        rc.setExpression(columnReference);\n+    }\n+\n+    // Subquery flattening logic only knows how to flatten a SelectNode\n+    // in a subquery.  Everything else must be evaluated one row-at-a-time.\n+    // Let's get around the restriction by wrapping SetOp queries\n+    // (UNION, EXCEPT, INTERSECT) in a derived table, which itself\n+    // is represented as a SelectNode.\n+    // TODO:  Enhance subquery flattening logic to not require the\n+    //        the subquery expression to be a SelectNode.\n+    private void wrapSetQueryInDerivedTable() throws StandardException {\n+        if (!(resultSet instanceof SetOperatorNode))\n+            return;\n+        SetOperatorNode setOperatorNode = (SetOperatorNode)resultSet;\n+        ValueNode[] offsetClauses = new ValueNode[ OFFSET_CLAUSE_COUNT ];\n+        SubqueryNode derivedTable = (SubqueryNode) getNodeFactory().getNode(\n+                                        C_NodeTypes.SUBQUERY_NODE,\n+                                        resultSet,  // SetOperatorNode\n+                                        ReuseFactory.getInteger(SubqueryNode.FROM_SUBQUERY),\n+                                        null, // leftOperand,\n+                                        null, // orderCols,\n+                                        offsetClauses[ OFFSET_CLAUSE ],\n+                                        offsetClauses[ FETCH_FIRST_CLAUSE ],", "originalCommit": "e520ff3c090a859c1f40c952c634f4b6476681d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDAxNDc3Ng==", "url": "https://github.com/splicemachine/spliceengine/pull/4689#discussion_r530014776", "bodyText": "Yes, always nulls.  That means these options are not used.  This is code copied from sqlgrammar.  I tried to keep it the same instead of passing a null for the whole parameter in case that would cause NullPointerException.  I was comparing what happens when I create a derived table manually, and it created the array with nulls as well.", "author": "msirek", "createdAt": "2020-11-24T23:41:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTk1OTA2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "726120377daba8cdc910ea6c81351af68cb7fc8f", "chunk": "diff --git a/db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/SubqueryNode.java b/db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/SubqueryNode.java\nindex 24161421ea..28e4beb9ae 100644\n--- a/db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/SubqueryNode.java\n+++ b/db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/SubqueryNode.java\n\n@@ -410,7 +410,6 @@ public class SubqueryNode extends ValueNode{\n                                              String columnName,\n                                              int columnPosition)   throws StandardException {\n         ResultColumn rc;\n-        boolean replacementDone = false;\n         if (setOperatorNode.getLeftResultSet() instanceof SetOperatorNode) {\n             updateColumnNamesInSetQuery((SetOperatorNode)setOperatorNode.getLeftResultSet(), columnName, columnPosition);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTk2MTgzNg==", "url": "https://github.com/splicemachine/spliceengine/pull/4689#discussion_r529961836", "bodyText": "This flag is not used anywhere. Remove?", "author": "ascend1", "createdAt": "2020-11-24T22:46:59Z", "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/SubqueryNode.java", "diffHunk": "@@ -403,6 +406,107 @@ public ValueNode remapColumnReferencesToExpressions() throws StandardException{\n         return this;\n     }\n \n+    private void updateColumnNamesInSetQuery(SetOperatorNode setOperatorNode,\n+                                             String columnName,\n+                                             int columnPosition)   throws StandardException {\n+        ResultColumn rc;\n+        boolean replacementDone = false;", "originalCommit": "e520ff3c090a859c1f40c952c634f4b6476681d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDAxNTcyMg==", "url": "https://github.com/splicemachine/spliceengine/pull/4689#discussion_r530015722", "bodyText": "OK, removed it.", "author": "msirek", "createdAt": "2020-11-24T23:43:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTk2MTgzNg=="}], "type": "inlineReview", "revised_code": {"commit": "726120377daba8cdc910ea6c81351af68cb7fc8f", "chunk": "diff --git a/db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/SubqueryNode.java b/db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/SubqueryNode.java\nindex 24161421ea..28e4beb9ae 100644\n--- a/db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/SubqueryNode.java\n+++ b/db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/SubqueryNode.java\n\n@@ -410,7 +410,6 @@ public class SubqueryNode extends ValueNode{\n                                              String columnName,\n                                              int columnPosition)   throws StandardException {\n         ResultColumn rc;\n-        boolean replacementDone = false;\n         if (setOperatorNode.getLeftResultSet() instanceof SetOperatorNode) {\n             updateColumnNamesInSetQuery((SetOperatorNode)setOperatorNode.getLeftResultSet(), columnName, columnPosition);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTk2Mzk3MA==", "url": "https://github.com/splicemachine/spliceengine/pull/4689#discussion_r529963970", "bodyText": "dummy semicolon at the end of line", "author": "ascend1", "createdAt": "2020-11-24T22:49:07Z", "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/SubqueryNode.java", "diffHunk": "@@ -403,6 +406,107 @@ public ValueNode remapColumnReferencesToExpressions() throws StandardException{\n         return this;\n     }\n \n+    private void updateColumnNamesInSetQuery(SetOperatorNode setOperatorNode,\n+                                             String columnName,\n+                                             int columnPosition)   throws StandardException {\n+        ResultColumn rc;\n+        boolean replacementDone = false;\n+        if (setOperatorNode.getLeftResultSet() instanceof SetOperatorNode) {\n+            updateColumnNamesInSetQuery((SetOperatorNode)setOperatorNode.getLeftResultSet(), columnName, columnPosition);\n+\n+        }\n+        else {\n+            rc = setOperatorNode.getLeftResultSet().getResultColumns().elementAt(columnPosition);\n+            rc.setName(columnName);\n+        }\n+        if (setOperatorNode.getRightResultSet() instanceof SetOperatorNode)\n+            updateColumnNamesInSetQuery((SetOperatorNode)setOperatorNode.getRightResultSet(), columnName, columnPosition);\n+        else {\n+            rc = setOperatorNode.getRightResultSet().getResultColumns().elementAt(columnPosition);\n+            rc.setName(columnName);\n+        }\n+        rc = setOperatorNode.getResultColumns().elementAt(columnPosition);;", "originalCommit": "e520ff3c090a859c1f40c952c634f4b6476681d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDAxNTgzMg==", "url": "https://github.com/splicemachine/spliceengine/pull/4689#discussion_r530015832", "bodyText": "removed", "author": "msirek", "createdAt": "2020-11-24T23:43:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTk2Mzk3MA=="}], "type": "inlineReview", "revised_code": {"commit": "726120377daba8cdc910ea6c81351af68cb7fc8f", "chunk": "diff --git a/db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/SubqueryNode.java b/db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/SubqueryNode.java\nindex 24161421ea..28e4beb9ae 100644\n--- a/db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/SubqueryNode.java\n+++ b/db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/SubqueryNode.java\n\n@@ -410,7 +410,6 @@ public class SubqueryNode extends ValueNode{\n                                              String columnName,\n                                              int columnPosition)   throws StandardException {\n         ResultColumn rc;\n-        boolean replacementDone = false;\n         if (setOperatorNode.getLeftResultSet() instanceof SetOperatorNode) {\n             updateColumnNamesInSetQuery((SetOperatorNode)setOperatorNode.getLeftResultSet(), columnName, columnPosition);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDAwNjM5MA==", "url": "https://github.com/splicemachine/spliceengine/pull/4689#discussion_r530006390", "bodyText": "We have an IT called Subquery_Flattening_Exists_Union_IT, probably a better match for this case. But it's your decision whether to move it or not.", "author": "ascend1", "createdAt": "2020-11-24T23:32:07Z", "path": "splice_machine/src/test/java/com/splicemachine/subquery/Subquery_Flattening_InList_IT.java", "diffHunk": "@@ -360,4 +360,100 @@ public void numberOfColumnsMismatch() throws Exception {\n             Assert.assertEquals(\"42X58\", e.getSQLState());\n         }\n     }\n+\n+    @Test\n+    public void testSetOpInSubQFlatten() throws Exception {\n+\n+        String expected =\n+            \"A1 |A2 |\\n\" +\n+            \"--------\\n\" +\n+            \" 0 | 0 |\\n\" +\n+            \" 1 |10 |\\n\" +\n+            \" 2 |20 |\\n\" +\n+            \" 3 |30 |\\n\" +\n+            \" 4 |40 |\\n\" +\n+            \" 5 |50 |\";\n+        String sql = \"select a1,a2 from A\\n\" +\n+                \"WHERE a1 in (select a1 from A\" +\n+                \"            WHERE a1 in (\\n\" +\n+                \"            SELECT b1 FROM B \" +\n+                \"            UNION \" +\n+                \"            SELECT b1 FROM B ))\";\n+        assertUnorderedResult(methodWatcher.getOrCreateConnection(),\n+                              sql , ZERO_SUBQUERY_NODES, expected );\n+        sql = \"select a1,a2 from A\\n\" +\n+                \"WHERE a1 in (select a1 from A\" +\n+                \"            WHERE a1+a1 in (\\n\" +\n+                \"            SELECT b1+b1 FROM B \" +\n+                \"            UNION \" +\n+                \"            SELECT b1 FROM B ))\";\n+        assertUnorderedResult(methodWatcher.getOrCreateConnection(),\n+                              sql , ZERO_SUBQUERY_NODES, expected );\n+        sql = \"select a1,a2 from A\\n\" +\n+                \"WHERE a1 in (select a1 from A\" +\n+                \"            WHERE a1+a1 in (\\n\" +\n+                \"            SELECT b1 FROM B \" +\n+                \"            UNION \" +\n+                \"            SELECT b1+b1 FROM B ))\";\n+        assertUnorderedResult(methodWatcher.getOrCreateConnection(),\n+                              sql , ZERO_SUBQUERY_NODES, expected );\n+\n+        sql = \"select a1,a2 from A\\n\" +\n+                \"WHERE exists (select a1 from A\" +\n+                \"            WHERE a1+a1 in (\\n\" +\n+                \"            SELECT b1 FROM B \" +\n+                \"            UNION \" +\n+                \"            SELECT b1+b1 FROM B ))\";\n+        assertUnorderedResult(methodWatcher.getOrCreateConnection(),\n+                              sql , ONE_SUBQUERY_NODE, expected );", "originalCommit": "e520ff3c090a859c1f40c952c634f4b6476681d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDAxNjI1Nw==", "url": "https://github.com/splicemachine/spliceengine/pull/4689#discussion_r530016257", "bodyText": "OK, well I was mainly fixing this for IN list, so I put it there.  Also, this isn't specific to UNION, it's for all 3 set operation kinds.", "author": "msirek", "createdAt": "2020-11-24T23:44:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDAwNjM5MA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "726120377daba8cdc910ea6c81351af68cb7fc8f", "url": "https://github.com/splicemachine/spliceengine/commit/726120377daba8cdc910ea6c81351af68cb7fc8f", "message": "DB-10774 Address review comments.", "committedDate": "2020-11-24T23:46:31Z", "type": "commit"}]}