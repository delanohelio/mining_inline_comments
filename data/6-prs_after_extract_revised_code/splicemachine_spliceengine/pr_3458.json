{"pr_number": 3458, "pr_title": "DB-9423: fix foreign key constraint uniqueness", "pr_createdAt": "2020-04-21T14:21:19Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/3458", "timeline": [{"oid": "7b0f32b303efaaf0791e18c78e4314849575b055", "url": "https://github.com/splicemachine/spliceengine/commit/7b0f32b303efaaf0791e18c78e4314849575b055", "message": "DB-9423: fix foreign key constraint uniqueness", "committedDate": "2020-04-25T00:41:16Z", "type": "forcePushed"}, {"oid": "28928badb575891ff2754fa0e5eb3f558cf0b9f0", "url": "https://github.com/splicemachine/spliceengine/commit/28928badb575891ff2754fa0e5eb3f558cf0b9f0", "message": "address review comments", "committedDate": "2020-06-11T16:13:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY1ODczOA==", "url": "https://github.com/splicemachine/spliceengine/pull/3458#discussion_r448658738", "bodyText": "Could you also add check so that if  excludeNulls or excludeDefaults do not match, the index cannot be shared either?\nHere is a test case:\ncreate table b(i int, j int, primary key (i));\ncreate table a (i int, j int);\ninsert into b values (1,1);\ninsert into a values (1,1);\ncreate index aj on a(j) exclude null keys;\nalter table a add CONSTRAINT fc FOREIGN KEY(j) REFERENCES b(i) ON UPDATE NO ACTION ON DELETE restrict;\nsplice> show indexes from a;\nTABLE_NAME                                        |INDEX_NAME                                        |COLUMN_NAME         |ORDINAL&|NON_UNIQUE|TYPE |ASC&|CONGLOM_NO\n--------------------------------------------------------------------------------------------------------------------------------------------------------------------\nA                                                 |AJ                                                |J                   |1       |true      |BTREE|A   |1665      \nA                                                 |SQL200701155616910                                |J                   |1       |true      |BTREE|A   |1665      \n\n2 rows selected\nELAPSED TIME = 1531 milliseconds", "author": "yxia92", "createdAt": "2020-07-01T23:00:25Z", "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/execute/actions/CreateIndexConstantOperation.java", "diffHunk": "@@ -452,6 +452,9 @@ public void executeConstantAction( Activation activation ) throws StandardExcept\n                 }\n \n                 IndexRowGenerator irg = cd.getIndexDescriptor();\n+                if (irg.isUnique() != unique) {", "originalCommit": "28928badb575891ff2754fa0e5eb3f558cf0b9f0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "26d5a3494447575f9221abdb727bf1ac40ba8052", "chunk": "diff --git a/splice_machine/src/main/java/com/splicemachine/derby/impl/sql/execute/actions/CreateIndexConstantOperation.java b/splice_machine/src/main/java/com/splicemachine/derby/impl/sql/execute/actions/CreateIndexConstantOperation.java\nindex c8f28321eb..533896dd31 100644\n--- a/splice_machine/src/main/java/com/splicemachine/derby/impl/sql/execute/actions/CreateIndexConstantOperation.java\n+++ b/splice_machine/src/main/java/com/splicemachine/derby/impl/sql/execute/actions/CreateIndexConstantOperation.java\n\n@@ -452,7 +452,9 @@ public class CreateIndexConstantOperation extends IndexConstantOperation impleme\n                 }\n \n                 IndexRowGenerator irg = cd.getIndexDescriptor();\n-                if (irg.isUnique() != unique) {\n+                if (irg.isUnique() != unique ||\n+                        irg.excludeNulls() != excludeNulls ||\n+                        irg.excludeDefaults() != excludeDefaults) {\n                     continue;\n                 }\n                 int[] bcps = irg.baseColumnPositions();\n"}}, {"oid": "26d5a3494447575f9221abdb727bf1ac40ba8052", "url": "https://github.com/splicemachine/spliceengine/commit/26d5a3494447575f9221abdb727bf1ac40ba8052", "message": "DB-9423: fix foreign key constraint uniqueness", "committedDate": "2020-07-02T04:29:52Z", "type": "forcePushed"}, {"oid": "f2f92aebe2c891d16c61a67077d1dbe1c28712ef", "url": "https://github.com/splicemachine/spliceengine/commit/f2f92aebe2c891d16c61a67077d1dbe1c28712ef", "message": "DB-9423: fix foreign key constraint uniqueness", "committedDate": "2020-07-08T05:11:43Z", "type": "commit"}, {"oid": "f2f92aebe2c891d16c61a67077d1dbe1c28712ef", "url": "https://github.com/splicemachine/spliceengine/commit/f2f92aebe2c891d16c61a67077d1dbe1c28712ef", "message": "DB-9423: fix foreign key constraint uniqueness", "committedDate": "2020-07-08T05:11:43Z", "type": "forcePushed"}]}