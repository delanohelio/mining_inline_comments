{"pr_number": 4234, "pr_title": "DB-10383 Dropping an expression-based index also drops its statistics", "pr_createdAt": "2020-10-06T15:17:20Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/4234", "timeline": [{"oid": "04fbeefff2e07aca882cd18498a80a3ad324a542", "url": "https://github.com/splicemachine/spliceengine/commit/04fbeefff2e07aca882cd18498a80a3ad324a542", "message": "DB-10383 Dropping an expression-based index also drops its statistics", "committedDate": "2020-10-06T15:15:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc1NjUzNQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4234#discussion_r500756535", "bodyText": "We may need to broadcast the ALTER_STATS messages to invalidate the plans based on that stats too and remove the entry from the dictionary cache. See StatisticsAdmin.ddlNotification().", "author": "yxia92", "createdAt": "2020-10-07T06:02:54Z", "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/execute/AbstractDropIndexConstantOperation.java", "diffHunk": "@@ -126,6 +123,7 @@ private void drop(ConglomerateDescriptor cd,\n         SpliceTransactionManager userTxnManager = (SpliceTransactionManager)lcc.getTransactionExecute();\n         dd.dropConglomerateDescriptor(cd,userTxnManager);\n         td.removeConglomerateDescriptor(cd);\n+        dd.deletePartitionStatistics(cd.getConglomerateNumber(), userTxnManager);", "originalCommit": "04fbeefff2e07aca882cd18498a80a3ad324a542", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUyMzgwOA==", "url": "https://github.com/splicemachine/spliceengine/pull/4234#discussion_r501523808", "bodyText": "Good to know! Added in the next commit.", "author": "ascend1", "createdAt": "2020-10-08T08:03:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc1NjUzNQ=="}], "type": "inlineReview", "revised_code": {"commit": "e88d87fc983373eb731250a44d1927ad5befe47b", "chunk": "diff --git a/splice_machine/src/main/java/com/splicemachine/derby/impl/sql/execute/AbstractDropIndexConstantOperation.java b/splice_machine/src/main/java/com/splicemachine/derby/impl/sql/execute/AbstractDropIndexConstantOperation.java\nindex ec81837245..3f5d3ee645 100644\n--- a/splice_machine/src/main/java/com/splicemachine/derby/impl/sql/execute/AbstractDropIndexConstantOperation.java\n+++ b/splice_machine/src/main/java/com/splicemachine/derby/impl/sql/execute/AbstractDropIndexConstantOperation.java\n\n@@ -115,15 +121,22 @@ public abstract class AbstractDropIndexConstantOperation extends IndexConstantOp\n                       DataDictionary dd,\n                       LanguageConnectionContext lcc) throws StandardException {\n         /*\n-         * Manage the metadata changes necessary to drop a table. Will execute\n+         * Manage the metadata changes necessary to drop an index. Will execute\n          * within a child transaction, and will commit that child transaction when completed.\n          * If a failure for any reason occurs, this will rollback the child transaction,\n-         * then throw an exception\n+         * then throw an exception.\n          */\n         SpliceTransactionManager userTxnManager = (SpliceTransactionManager)lcc.getTransactionExecute();\n         dd.dropConglomerateDescriptor(cd,userTxnManager);\n         td.removeConglomerateDescriptor(cd);\n         dd.deletePartitionStatistics(cd.getConglomerateNumber(), userTxnManager);\n+\n+        /* Dropping index statistics affects the choice of best plan for queries on this table.\n+         * Broadcast a message to invalidate the related plans.\n+         */\n+        List<TableDescriptor> tds = Collections.singletonList(td);\n+        DDLMessage.DDLChange ddlChange = ProtoUtil.alterStats(userTxnManager.getActiveStateTxn().getTxnId(), tds);\n+        userTxnManager.prepareDataDictionaryChange(DDLUtils.notifyMetadataChange(ddlChange));\n     }\n \n     public String getScopeName() {\n"}}, {"oid": "e88d87fc983373eb731250a44d1927ad5befe47b", "url": "https://github.com/splicemachine/spliceengine/commit/e88d87fc983373eb731250a44d1927ad5befe47b", "message": "DB-10383 Address comment: invalidate related plans after dropping stats", "committedDate": "2020-10-08T07:56:03Z", "type": "commit"}]}