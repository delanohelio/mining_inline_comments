{"pr_number": 4043, "pr_title": "DB-10059 Implement SQL procedure that allow setting retention period", "pr_createdAt": "2020-08-24T16:41:28Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/4043", "timeline": [{"oid": "abe3e3f47f7fd60496b400308f9a2bcb44c21056", "url": "https://github.com/splicemachine/spliceengine/commit/abe3e3f47f7fd60496b400308f9a2bcb44c21056", "message": "DB-10045 refactor system tables row factory.", "committedDate": "2020-08-18T18:27:48Z", "type": "commit"}, {"oid": "08373b8a6984d961ee93889ecd94c8680fa5871b", "url": "https://github.com/splicemachine/spliceengine/commit/08373b8a6984d961ee93889ecd94c8680fa5871b", "message": "DB-10045 add MIN_RETAINED_VERSIONS column to SYSTABLES", "committedDate": "2020-08-18T18:28:01Z", "type": "commit"}, {"oid": "01a18f0a84f880b82e5cfcfdcb96e847291935b2", "url": "https://github.com/splicemachine/spliceengine/commit/01a18f0a84f880b82e5cfcfdcb96e847291935b2", "message": "DB-10045 fix spotbugs issue.", "committedDate": "2020-08-19T08:31:47Z", "type": "commit"}, {"oid": "e7cd2390342268607142d296e1c9bd95e26bd25d", "url": "https://github.com/splicemachine/spliceengine/commit/e7cd2390342268607142d296e1c9bd95e26bd25d", "message": "DB-10045 renamed field to minRetentionPeriod", "committedDate": "2020-08-21T15:52:13Z", "type": "commit"}, {"oid": "31f0415c89417a3fb8d1aebc534afcd4a2c7dfe0", "url": "https://github.com/splicemachine/spliceengine/commit/31f0415c89417a3fb8d1aebc534afcd4a2c7dfe0", "message": "Merge remote-tracking branch 'origin/master' into DB-10045", "committedDate": "2020-08-21T16:03:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzYxMjgwNw==", "url": "https://github.com/splicemachine/spliceengine/pull/4043#discussion_r477612807", "bodyText": "We need to use SYSVW.SYSTABLESVIEW instead of SYS.SYSTABLES as with schema restriction feature, regular user cannot acces the SYS schema.", "author": "yxia92", "createdAt": "2020-08-26T21:57:59Z", "path": "splice_machine/src/main/java/com/splicemachine/derby/utils/SpliceAdmin.java", "diffHunk": "@@ -1090,6 +1090,21 @@ public static String getSqlConglomsInSchema(){\n         return sqlConglomsInSchema;\n     }\n \n+    private static final String sqlGetTablesInSchema= \"SELECT TABLEID FROM SYS.SYSTABLES WHERE SCHEMAID = ?\";", "originalCommit": "bbc3987debfa0938adcda9018584e9a9c4b2e8c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU2MzA1MQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4043#discussion_r478563051", "bodyText": "done.", "author": "hatyo", "createdAt": "2020-08-27T16:56:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzYxMjgwNw=="}], "type": "inlineReview", "revised_code": {"commit": "90d68339c7383fb3bf57cbcf3857043bc8e0e28d", "chunk": "diff --git a/splice_machine/src/main/java/com/splicemachine/derby/utils/SpliceAdmin.java b/splice_machine/src/main/java/com/splicemachine/derby/utils/SpliceAdmin.java\nindex fcf2bfbd15..1ea3522d00 100644\n--- a/splice_machine/src/main/java/com/splicemachine/derby/utils/SpliceAdmin.java\n+++ b/splice_machine/src/main/java/com/splicemachine/derby/utils/SpliceAdmin.java\n\n@@ -1090,21 +1090,6 @@ public class SpliceAdmin extends BaseAdminProcedures{\n         return sqlConglomsInSchema;\n     }\n \n-    private static final String sqlGetTablesInSchema= \"SELECT TABLEID FROM SYS.SYSTABLES WHERE SCHEMAID = ?\";\n-\n-    private static List<TableDescriptor> getTablesInSchema(DataDictionary dataDictionary,\n-                                                           Connection connection,\n-                                                           String schemaId) throws SQLException, StandardException {\n-        PreparedStatement statement = connection.prepareStatement(sqlGetTablesInSchema);\n-        statement.setString(1, schemaId);\n-        ResultSet resultSet = statement.executeQuery();\n-        List<TableDescriptor> tableDescriptors = new ArrayList<>();\n-        while(resultSet.next()) {\n-            tableDescriptors.add(dataDictionary.getTableDescriptor(new BasicUUID(resultSet.getString(1))));\n-        }\n-        return tableDescriptors;\n-    }\n-\n     public static String getSqlConglomsInTable(){\n         return sqlConglomsInTable;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzYxMjk0MA==", "url": "https://github.com/splicemachine/spliceengine/pull/4043#discussion_r477612940", "bodyText": "Could you close the resultSet at the end?", "author": "yxia92", "createdAt": "2020-08-26T21:58:19Z", "path": "splice_machine/src/main/java/com/splicemachine/derby/utils/SpliceAdmin.java", "diffHunk": "@@ -1090,6 +1090,21 @@ public static String getSqlConglomsInSchema(){\n         return sqlConglomsInSchema;\n     }\n \n+    private static final String sqlGetTablesInSchema= \"SELECT TABLEID FROM SYS.SYSTABLES WHERE SCHEMAID = ?\";\n+\n+    private static List<TableDescriptor> getTablesInSchema(DataDictionary dataDictionary,\n+                                                           Connection connection,\n+                                                           String schemaId) throws SQLException, StandardException {\n+        PreparedStatement statement = connection.prepareStatement(sqlGetTablesInSchema);\n+        statement.setString(1, schemaId);\n+        ResultSet resultSet = statement.executeQuery();\n+        List<TableDescriptor> tableDescriptors = new ArrayList<>();\n+        while(resultSet.next()) {\n+            tableDescriptors.add(dataDictionary.getTableDescriptor(new BasicUUID(resultSet.getString(1))));\n+        }", "originalCommit": "bbc3987debfa0938adcda9018584e9a9c4b2e8c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU2MzA5MQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4043#discussion_r478563091", "bodyText": "done.", "author": "hatyo", "createdAt": "2020-08-27T16:57:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzYxMjk0MA=="}], "type": "inlineReview", "revised_code": {"commit": "90d68339c7383fb3bf57cbcf3857043bc8e0e28d", "chunk": "diff --git a/splice_machine/src/main/java/com/splicemachine/derby/utils/SpliceAdmin.java b/splice_machine/src/main/java/com/splicemachine/derby/utils/SpliceAdmin.java\nindex fcf2bfbd15..1ea3522d00 100644\n--- a/splice_machine/src/main/java/com/splicemachine/derby/utils/SpliceAdmin.java\n+++ b/splice_machine/src/main/java/com/splicemachine/derby/utils/SpliceAdmin.java\n\n@@ -1090,21 +1090,6 @@ public class SpliceAdmin extends BaseAdminProcedures{\n         return sqlConglomsInSchema;\n     }\n \n-    private static final String sqlGetTablesInSchema= \"SELECT TABLEID FROM SYS.SYSTABLES WHERE SCHEMAID = ?\";\n-\n-    private static List<TableDescriptor> getTablesInSchema(DataDictionary dataDictionary,\n-                                                           Connection connection,\n-                                                           String schemaId) throws SQLException, StandardException {\n-        PreparedStatement statement = connection.prepareStatement(sqlGetTablesInSchema);\n-        statement.setString(1, schemaId);\n-        ResultSet resultSet = statement.executeQuery();\n-        List<TableDescriptor> tableDescriptors = new ArrayList<>();\n-        while(resultSet.next()) {\n-            tableDescriptors.add(dataDictionary.getTableDescriptor(new BasicUUID(resultSet.getString(1))));\n-        }\n-        return tableDescriptors;\n-    }\n-\n     public static String getSqlConglomsInTable(){\n         return sqlConglomsInTable;\n     }\n"}}, {"oid": "90d68339c7383fb3bf57cbcf3857043bc8e0e28d", "url": "https://github.com/splicemachine/spliceengine/commit/90d68339c7383fb3bf57cbcf3857043bc8e0e28d", "message": "Merge remote-tracking branch 'origin/master' into DB-10045", "committedDate": "2020-08-27T08:30:20Z", "type": "commit"}, {"oid": "a20c124c194b24035c61fdc6b3a6a06f5c6ea830", "url": "https://github.com/splicemachine/spliceengine/commit/a20c124c194b24035c61fdc6b3a6a06f5c6ea830", "message": "DB-10045 Add upgrade script for minRetentionPeriod column.", "committedDate": "2020-08-27T14:12:51Z", "type": "commit"}, {"oid": "1717d44ab20c5fa558c89fff2d338dc410acd379", "url": "https://github.com/splicemachine/spliceengine/commit/1717d44ab20c5fa558c89fff2d338dc410acd379", "message": "DB-10059 Add tests for SET_MIN_RETENTION_PERIOD.", "committedDate": "2020-08-27T16:53:59Z", "type": "forcePushed"}, {"oid": "3eed0230ad08bd8bebbb66ca900e95d97466a69e", "url": "https://github.com/splicemachine/spliceengine/commit/3eed0230ad08bd8bebbb66ca900e95d97466a69e", "message": "DB-10045 address comments.", "committedDate": "2020-08-28T17:17:08Z", "type": "commit"}, {"oid": "32a2ea5217632dfcba385a7a4ade6bc9312cb0df", "url": "https://github.com/splicemachine/spliceengine/commit/32a2ea5217632dfcba385a7a4ade6bc9312cb0df", "message": "DB-10059 address comments.", "committedDate": "2020-08-28T17:34:08Z", "type": "forcePushed"}, {"oid": "f42033bc14ffcec5900110b4eb293302435cab37", "url": "https://github.com/splicemachine/spliceengine/commit/f42033bc14ffcec5900110b4eb293302435cab37", "message": "DB-10045 Set upgrade version to 1974.", "committedDate": "2020-08-31T07:50:18Z", "type": "commit"}, {"oid": "15d8765e24bb16b43afb270d35c35108fc5bb9b0", "url": "https://github.com/splicemachine/spliceengine/commit/15d8765e24bb16b43afb270d35c35108fc5bb9b0", "message": "Merge remote-tracking branch 'origin/master' into DB-10045", "committedDate": "2020-08-31T08:37:41Z", "type": "commit"}, {"oid": "86e01d36dcf57284a1b5e0a75fbd6eaea768e3d4", "url": "https://github.com/splicemachine/spliceengine/commit/86e01d36dcf57284a1b5e0a75fbd6eaea768e3d4", "message": "DB-10059 address comments.", "committedDate": "2020-08-31T08:39:25Z", "type": "forcePushed"}, {"oid": "c2d34652296eff2a5fb37e2f24800bc2d308ca9f", "url": "https://github.com/splicemachine/spliceengine/commit/c2d34652296eff2a5fb37e2f24800bc2d308ca9f", "message": "DB-10045 fix test.", "committedDate": "2020-09-01T14:57:23Z", "type": "commit"}, {"oid": "4cbd2a3d53fa0fe4cf33d90d6893b19f1dfe2124", "url": "https://github.com/splicemachine/spliceengine/commit/4cbd2a3d53fa0fe4cf33d90d6893b19f1dfe2124", "message": "DB-10059 address comments.", "committedDate": "2020-09-01T15:00:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY4NjIwNg==", "url": "https://github.com/splicemachine/spliceengine/pull/4043#discussion_r482686206", "bodyText": "you may use .catalog(\"tableName\") and .catalog(\"schemaName\")", "author": "jyuanca", "createdAt": "2020-09-03T03:48:19Z", "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/SpliceSystemProcedures.java", "diffHunk": "@@ -1186,6 +1186,16 @@ public SpliceSystemProcedures(DataDictionary dictionary) {\n                             .build();\n                     procedures.add(purgeDeletedRows);\n \n+                    Procedure minRetentionPeriod = Procedure.newBuilder().name(\"SET_MIN_RETENTION_PERIOD\")\n+                            .varchar(\"schemaName\", 128)\n+                            .varchar(\"tableName\", 128)", "originalCommit": "4cbd2a3d53fa0fe4cf33d90d6893b19f1dfe2124", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQ2MjcwNg==", "url": "https://github.com/splicemachine/spliceengine/pull/4043#discussion_r485462706", "bodyText": "done.", "author": "hatyo", "createdAt": "2020-09-09T09:13:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY4NjIwNg=="}], "type": "inlineReview", "revised_code": {"commit": "a8e5e980b27fb03dfcec599c9a736f8c45a96a09", "chunk": "diff --git a/splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/SpliceSystemProcedures.java b/splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/SpliceSystemProcedures.java\nindex ac81ab3efb..f571197c05 100644\n--- a/splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/SpliceSystemProcedures.java\n+++ b/splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/SpliceSystemProcedures.java\n\n@@ -1186,16 +1186,6 @@ public class SpliceSystemProcedures extends DefaultSystemProcedureGenerator {\n                             .build();\n                     procedures.add(purgeDeletedRows);\n \n-                    Procedure minRetentionPeriod = Procedure.newBuilder().name(\"SET_MIN_RETENTION_PERIOD\")\n-                            .varchar(\"schemaName\", 128)\n-                            .varchar(\"tableName\", 128)\n-                            .bigint(\"minRetentionPeriod\")\n-                            .numOutputParams(0)\n-                            .numResultSets(0)\n-                            .ownerClass(SpliceAdmin.class.getCanonicalName())\n-                            .build();\n-                    procedures.add(minRetentionPeriod);\n-\n                     Procedure snapshotSchema = Procedure.newBuilder().name(\"SNAPSHOT_SCHEMA\")\n                             .varchar(\"schemaName\", 128)\n                             .varchar(\"snapshotName\", 128)\n"}}, {"oid": "a8e5e980b27fb03dfcec599c9a736f8c45a96a09", "url": "https://github.com/splicemachine/spliceengine/commit/a8e5e980b27fb03dfcec599c9a736f8c45a96a09", "message": "Merge remote-tracking branch 'origin/master' into DB-10045", "committedDate": "2020-09-09T08:57:40Z", "type": "commit"}, {"oid": "1c8ebebc8035b26eb485d20471b38e3a3f25b05c", "url": "https://github.com/splicemachine/spliceengine/commit/1c8ebebc8035b26eb485d20471b38e3a3f25b05c", "message": "DB-10059 Add system procedure to set retention period.\n\n- Add new system procedure SET_MIN_RETENTION_PERIOD which\n  allows setting the mininmum retention period for a table\n  or all tables in a schema.", "committedDate": "2020-09-09T09:04:06Z", "type": "commit"}, {"oid": "bea34ad6e16c497d0d3482f51042882357851c79", "url": "https://github.com/splicemachine/spliceengine/commit/bea34ad6e16c497d0d3482f51042882357851c79", "message": "DB-10059 Add tests for SET_MIN_RETENTION_PERIOD.", "committedDate": "2020-09-09T09:04:06Z", "type": "commit"}, {"oid": "ac8a7900bb0a82a1532b31e0569aa949d2d97735", "url": "https://github.com/splicemachine/spliceengine/commit/ac8a7900bb0a82a1532b31e0569aa949d2d97735", "message": "DB-10059 address comments.", "committedDate": "2020-09-09T09:04:06Z", "type": "commit"}, {"oid": "c28aaf8440617f9be04e02f48757dab6eda9b0d1", "url": "https://github.com/splicemachine/spliceengine/commit/c28aaf8440617f9be04e02f48757dab6eda9b0d1", "message": "DB-10059 address comment.", "committedDate": "2020-09-09T09:13:07Z", "type": "commit"}, {"oid": "c28aaf8440617f9be04e02f48757dab6eda9b0d1", "url": "https://github.com/splicemachine/spliceengine/commit/c28aaf8440617f9be04e02f48757dab6eda9b0d1", "message": "DB-10059 address comment.", "committedDate": "2020-09-09T09:13:07Z", "type": "forcePushed"}]}