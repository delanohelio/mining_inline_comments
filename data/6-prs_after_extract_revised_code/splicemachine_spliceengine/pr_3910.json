{"pr_number": 3910, "pr_title": "DB-9890 Skip column if column statistics object is too big", "pr_createdAt": "2020-07-31T16:39:43Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/3910", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg2OTQ4OQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3910#discussion_r463869489", "bodyText": "Is it possible to return this warning as part of the analyze output in addition to the warning in the log? so that user is aware that some column stats are skipped.", "author": "yxia92", "createdAt": "2020-07-31T22:17:10Z", "path": "splice_machine/src/main/java/com/splicemachine/derby/utils/StatisticsAdmin.java", "diffHunk": "@@ -1045,8 +1045,19 @@ public boolean hasNext() {\n                                                 ObjectInputStream ois = new ObjectInputStream(bais);\n                                                 // compose the entry for a given column\n                                                 ExecRow statsRow = StatisticsAdmin.generateRowFromStats(conglomId, \"-All-\", columnId, (ColumnStatisticsImpl) ois.readObject());\n-                                                dataDictionary.addColumnStatistics(statsRow, tc);\n-                                                bais.close();\n+                                                try {\n+                                                    dataDictionary.addColumnStatistics(statsRow, tc);\n+                                                } catch (StandardException e) {\n+                                                    // DB-9890 Skip a column if its statistics object doesn't fit into HBase cell.\n+                                                    if (e.getCause().getMessage().contains(\"KeyValue size too large\")) {\n+                                                        SpliceLogUtils.warn(LOG, \"Statistics object of [ConglomID=%d, ColumnID=%d] exceeds max KeyValue size. Try increase hbase.client.keyvalue.maxsize.\",\n+                                                                conglomId, columnId);", "originalCommit": "95d8ff4177b4f233e2def6e5ac530d51f34ac1a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI5ODM4NA==", "url": "https://github.com/splicemachine/spliceengine/pull/3910#discussion_r464298384", "bodyText": "I was thinking of something similar but not sure what's the correct way of doing it. It seems the standard way is to throw an exception and set the severity to warning. But we cannot throw here since we want to continue. Building the warning message into the result table would misuse the a char column, unless we add an extra column to the result table schema and set the message there. Not sure we should do that, either.\nDo you have any suggestions?", "author": "ascend1", "createdAt": "2020-08-03T09:27:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg2OTQ4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTgxMTQzNA==", "url": "https://github.com/splicemachine/spliceengine/pull/3910#discussion_r465811434", "bodyText": "I'm thinking of adding an extra column in the analyze output to indicate whether some column stats were not saved due to space limitation. Thanks!", "author": "yxia92", "createdAt": "2020-08-05T15:27:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg2OTQ4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTgyNzkwNg==", "url": "https://github.com/splicemachine/spliceengine/pull/3910#discussion_r465827906", "bodyText": "Got it, will add another commit.", "author": "ascend1", "createdAt": "2020-08-05T15:51:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg2OTQ4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTkzMTczMw==", "url": "https://github.com/splicemachine/spliceengine/pull/3910#discussion_r465931733", "bodyText": "Done.", "author": "ascend1", "createdAt": "2020-08-05T18:47:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg2OTQ4OQ=="}], "type": "inlineReview", "revised_code": {"commit": "dc78c9b88a5517c53d096585a7aa75e4c0c78267", "chunk": "diff --git a/splice_machine/src/main/java/com/splicemachine/derby/utils/StatisticsAdmin.java b/splice_machine/src/main/java/com/splicemachine/derby/utils/StatisticsAdmin.java\nindex 4e8bc3d31b..f8ce61caaf 100644\n--- a/splice_machine/src/main/java/com/splicemachine/derby/utils/StatisticsAdmin.java\n+++ b/splice_machine/src/main/java/com/splicemachine/derby/utils/StatisticsAdmin.java\n\n@@ -1052,6 +1061,7 @@ public class StatisticsAdmin extends BaseAdminProcedures {\n                                                     if (e.getCause().getMessage().contains(\"KeyValue size too large\")) {\n                                                         SpliceLogUtils.warn(LOG, \"Statistics object of [ConglomID=%d, ColumnID=%d] exceeds max KeyValue size. Try increase hbase.client.keyvalue.maxsize.\",\n                                                                 conglomId, columnId);\n+                                                        skippedColIds.add(columnId);\n                                                     } else {\n                                                         throw e;\n                                                     }\n"}}, {"oid": "dd0c1032e01de6b81c8f385a1c0f50db34a5ae5d", "url": "https://github.com/splicemachine/spliceengine/commit/dd0c1032e01de6b81c8f385a1c0f50db34a5ae5d", "message": "DB-9890 Skip column if column statistics object is too big", "committedDate": "2020-08-05T18:44:59Z", "type": "commit"}, {"oid": "dc78c9b88a5517c53d096585a7aa75e4c0c78267", "url": "https://github.com/splicemachine/spliceengine/commit/dc78c9b88a5517c53d096585a7aa75e4c0c78267", "message": "DB-9890 Show skipped column IDs in the result of ANALYZE command", "committedDate": "2020-08-05T18:44:59Z", "type": "commit"}, {"oid": "dc78c9b88a5517c53d096585a7aa75e4c0c78267", "url": "https://github.com/splicemachine/spliceengine/commit/dc78c9b88a5517c53d096585a7aa75e4c0c78267", "message": "DB-9890 Show skipped column IDs in the result of ANALYZE command", "committedDate": "2020-08-05T18:44:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk1NjAxOQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3910#discussion_r465956019", "bodyText": "For non-merged stats (that is, we output one row in the table stats table for each partition, so are the column stats), that means, we may add the same columnId multiple times to the skippedColIds list. Non-merged stats is a mode that we are not using currently, still I prefer to maintain it (in consideration in the future to support incremental stats) and add duplicate checks for this path. You may collect non-merged stats by calling the system procedure COLLECT_NONMERGED_TABLE_STATISTICS.", "author": "yxia92", "createdAt": "2020-08-05T19:33:33Z", "path": "splice_machine/src/main/java/com/splicemachine/derby/utils/StatisticsAdmin.java", "diffHunk": "@@ -1135,9 +1146,11 @@ public boolean hasNext() {\n                                             } catch (StandardException e) {\n                                                 // DB-9890 Skip a column if its statistics object doesn't fit into HBase cell.\n                                                 if (e.getCause().getMessage().contains(\"KeyValue size too large\")) {\n+                                                    int columnId = nextRow.getColumn(SYSCOLUMNSTATISTICSRowFactory.COLUMNID).getInt();\n                                                     SpliceLogUtils.warn(LOG, \"Statistics object of [ConglomID=%d, ColumnID=%d] exceeds max KeyValue size. Try increase hbase.client.keyvalue.maxsize.\",\n                                                             nextRow.getColumn(SYSCOLUMNSTATISTICSRowFactory.CONGLOMID).getInt(),\n-                                                            nextRow.getColumn(SYSCOLUMNSTATISTICSRowFactory.COLUMNID).getInt());\n+                                                            columnId);\n+                                                    skippedColIds.add(columnId);", "originalCommit": "dc78c9b88a5517c53d096585a7aa75e4c0c78267", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk2NDE1OA==", "url": "https://github.com/splicemachine/spliceengine/pull/3910#discussion_r465964158", "bodyText": "I see. I pushed a new commit and use HashSet instead of ArrayList.", "author": "ascend1", "createdAt": "2020-08-05T19:49:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk1NjAxOQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "984922b507811ebf949d40693c796dfe9d1ec308", "url": "https://github.com/splicemachine/spliceengine/commit/984922b507811ebf949d40693c796dfe9d1ec308", "message": "DB-9890 Fix duplicates in skipped column IDs", "committedDate": "2020-08-05T19:43:33Z", "type": "commit"}]}