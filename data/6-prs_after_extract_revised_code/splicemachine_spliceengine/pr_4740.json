{"pr_number": 4740, "pr_title": "DB-10898 DB-10897 configurable timestamp precision.", "pr_createdAt": "2020-11-30T17:38:13Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/4740", "timeline": [{"oid": "bfdd5759d74ac284395575eca1977dda7ecd84e5", "url": "https://github.com/splicemachine/spliceengine/commit/bfdd5759d74ac284395575eca1977dda7ecd84e5", "message": "DB-10898 DB-10897 configurable timestamp precision.", "committedDate": "2020-11-30T17:30:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg1MDQ1MA==", "url": "https://github.com/splicemachine/spliceengine/pull/4740#discussion_r532850450", "bodyText": "I guess we can't quite deprecate that one until we support an alternative that can be used for a transition though, but I agree we need to deprecate this in favour of a single parameter for timestamp precision, and a new way to specify the precision at function level: e.g. CURRENT TIMESTAMP(9)", "author": "arnaud-splice", "createdAt": "2020-11-30T19:37:35Z", "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/GenericStatement.java", "diffHunk": "@@ -603,6 +604,10 @@ else if (newMergeJoinString.equals(\"forced\"))\n                 }\n                 cc.setDisablePerParallelTaskJoinCosting(disablePerParallelTaskJoinCosting);\n \n+                /**", "originalCommit": "bfdd5759d74ac284395575eca1977dda7ecd84e5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQ0MDQ5NQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4740#discussion_r533440495", "bodyText": "Yes, maybe I shouldn't write that until we have an alternative. will remove it.", "author": "hatyo", "createdAt": "2020-12-01T14:18:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg1MDQ1MA=="}], "type": "inlineReview", "revised_code": {"commit": "3d77b16d33bd09912bd4165c72897aa6c4a904a7", "chunk": "diff --git a/db-engine/src/main/java/com/splicemachine/db/impl/sql/GenericStatement.java b/db-engine/src/main/java/com/splicemachine/db/impl/sql/GenericStatement.java\nindex ddca46b830..12637673b9 100644\n--- a/db-engine/src/main/java/com/splicemachine/db/impl/sql/GenericStatement.java\n+++ b/db-engine/src/main/java/com/splicemachine/db/impl/sql/GenericStatement.java\n\n@@ -604,10 +604,6 @@ public class GenericStatement implements Statement{\n                 }\n                 cc.setDisablePerParallelTaskJoinCosting(disablePerParallelTaskJoinCosting);\n \n-                /**\n-                 * Deprecated, we should remove this configuration parameter and only use SPLICE_TIMESTAMP_PRECISION\n-                 * instead.\n-                 */\n                 String currentTimestampPrecisionString =\n                 PropertyUtil.getCachedDatabaseProperty(lcc, Property.SPLICE_CURRENT_TIMESTAMP_PRECISION);\n                 int currentTimestampPrecision = CompilerContext.DEFAULT_SPLICE_CURRENT_TIMESTAMP_PRECISION;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg1Mzg2OA==", "url": "https://github.com/splicemachine/spliceengine/pull/4740#discussion_r532853868", "bodyText": "@martinrupp are you familiar with that? I seem to remember that you worked with precisions before.", "author": "arnaud-splice", "createdAt": "2020-11-30T19:43:22Z", "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/CastNode.java", "diffHunk": "@@ -1101,6 +1123,7 @@ private void genDataValueConversion(ExpressionClassBuilder acb,\n              * of VSDV.\n              */\n \n+            // not sure if this is important", "originalCommit": "bfdd5759d74ac284395575eca1977dda7ecd84e5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "400bba52bdac6135ea288688efd5b96eb7032ea8", "chunk": "diff --git a/db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/CastNode.java b/db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/CastNode.java\nindex 294ccf7cb1..f7e492d35f 100644\n--- a/db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/CastNode.java\n+++ b/db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/CastNode.java\n\n@@ -1123,7 +1131,6 @@ public class CastNode extends ValueNode\n              * of VSDV.\n              */\n \n-            // not sure if this is important\n             mb.push(isNumber ? getTypeServices().getPrecision() : getTypeServices().getMaximumWidth());\n             mb.push(getTypeServices().getScale());\n             mb.push(!sourceCTI.variableLength() ||\n"}}, {"oid": "3d77b16d33bd09912bd4165c72897aa6c4a904a7", "url": "https://github.com/splicemachine/spliceengine/commit/3d77b16d33bd09912bd4165c72897aa6c4a904a7", "message": "DB-10898 fix issues and add tests.", "committedDate": "2020-12-01T14:19:49Z", "type": "commit"}, {"oid": "400bba52bdac6135ea288688efd5b96eb7032ea8", "url": "https://github.com/splicemachine/spliceengine/commit/400bba52bdac6135ea288688efd5b96eb7032ea8", "message": "Merge remote-tracking branch 'origin/master' into DB-10898", "committedDate": "2020-12-01T14:35:11Z", "type": "commit"}, {"oid": "400bba52bdac6135ea288688efd5b96eb7032ea8", "url": "https://github.com/splicemachine/spliceengine/commit/400bba52bdac6135ea288688efd5b96eb7032ea8", "message": "Merge remote-tracking branch 'origin/master' into DB-10898", "committedDate": "2020-12-01T14:35:11Z", "type": "forcePushed"}, {"oid": "12fa21bc19a7fe4d1f288f241a000ac5c97c6d39", "url": "https://github.com/splicemachine/spliceengine/commit/12fa21bc19a7fe4d1f288f241a000ac5c97c6d39", "message": "Merge remote-tracking branch 'origin/master' into DB-10898", "committedDate": "2020-12-02T16:00:26Z", "type": "commit"}, {"oid": "a04d9071a02ba10c7d9b62afea244e1c935729ed", "url": "https://github.com/splicemachine/spliceengine/commit/a04d9071a02ba10c7d9b62afea244e1c935729ed", "message": "DB-10898 address spotbugs issues.", "committedDate": "2020-12-02T16:49:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ2OTY4NA==", "url": "https://github.com/splicemachine/spliceengine/pull/4740#discussion_r534469684", "bodyText": "I like the idea of automatically forcing recompile for convenience, but are you sure we want to do this?  It may have a performance impact.  Every time a flag is changed we have to recompile all SQLs and triggers.  There is no option for the user to set a database property without calling these cache-clearing functions if they wish to avoid it.  Something we should think about, perhaps, before making this change.", "author": "msirek", "createdAt": "2020-12-02T20:45:33Z", "path": "splice_machine/src/main/java/com/splicemachine/derby/utils/SpliceAdmin.java", "diffHunk": "@@ -1283,6 +1283,9 @@ public static void SYSCS_SET_GLOBAL_DATABASE_PROPERTY(final String key,final Str\n             PropertyInfo.setDatabaseProperty(key, value);\n             DDLMessage.DDLChange ddlChange = ProtoUtil.createSetDatabaseProperty(tc.getActiveStateTxn().getTxnId(), key);\n             tc.prepareDataDictionaryChange(DDLUtils.notifyMetadataChange(ddlChange));\n+            // we need to invalidate the statement caches since we could set parameters that affect query plans.\n+            SYSCS_INVALIDATE_STORED_STATEMENTS();\n+            SYSCS_EMPTY_GLOBAL_STATEMENT_CACHE();", "originalCommit": "a04d9071a02ba10c7d9b62afea244e1c935729ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDYxNDY5MA==", "url": "https://github.com/splicemachine/spliceengine/pull/4740#discussion_r534614690", "bodyText": "We can decide this point later, so the build can proceed.  Opened the following Jira:  https://splicemachine.atlassian.net/browse/DB-10948", "author": "msirek", "createdAt": "2020-12-03T02:13:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ2OTY4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTAxMjY4Nw==", "url": "https://github.com/splicemachine/spliceengine/pull/4740#discussion_r535012687", "bodyText": "Thanks @msirek for your observation, maybe it is OK to keep this implementation as setting a global database property doesn't happen very often but let's follow up in the JIRA you opened to discuss improvements (one improvement that @dgomezferro mentioned was e.g. to only invalidated affected statements using the dependency manager).", "author": "hatyo", "createdAt": "2020-12-03T09:37:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ2OTY4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM2MzUxNA==", "url": "https://github.com/splicemachine/spliceengine/pull/4740#discussion_r535363514", "bodyText": "This is not needed for all database properties. You can do this if the property is timestamp precision", "author": "jyuanca", "createdAt": "2020-12-03T16:00:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ2OTY4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM2ODc2OQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4740#discussion_r535368769", "bodyText": "Thanks @jyuanca! I will address it in DB-10948 then.", "author": "hatyo", "createdAt": "2020-12-03T16:07:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ2OTY4NA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "58e674947b07ff0d456be8080f7de64bd33fca3a", "url": "https://github.com/splicemachine/spliceengine/commit/58e674947b07ff0d456be8080f7de64bd33fca3a", "message": "DB-10898 fix tests.", "committedDate": "2020-12-02T20:51:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU5MDg0Nw==", "url": "https://github.com/splicemachine/spliceengine/pull/4740#discussion_r534590847", "bodyText": "Better to throw the error so that the user can correct the property values", "author": "jyuanca", "createdAt": "2020-12-03T01:09:58Z", "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/GenericStatement.java", "diffHunk": "@@ -619,6 +620,22 @@ else if (newMergeJoinString.equals(\"forced\"))\n                 }\n                 cc.setCurrentTimestampPrecision(currentTimestampPrecision);\n \n+                String timestampPrecisionString =\n+                        PropertyUtil.getCachedDatabaseProperty(lcc, Property.SPLICE_TIMESTAMP_PRECISION);\n+                int timestampPrecision = CompilerContext.DEFAULT_TIMESTAMP_PRECISION;\n+                try {\n+                    if (timestampPrecisionString != null)\n+                        timestampPrecision = Integer.parseInt(timestampPrecisionString);\n+                    if (timestampPrecision < Limits.MIN_TIMESTAMP_PRECISION)\n+                        timestampPrecision = Limits.MIN_TIMESTAMP_PRECISION;\n+                    if (timestampPrecision > Limits.MAX_TIMESTAMP_PRECISION)\n+                        timestampPrecision = Limits.MAX_TIMESTAMP_PRECISION;\n+                } catch (Exception e) {\n+                    // If the property value failed to convert to a boolean, don't throw an error,", "originalCommit": "58e674947b07ff0d456be8080f7de64bd33fca3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU5NjE4OQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4740#discussion_r534596189", "bodyText": "@jyuanca I believe this is not the code to handle the statement itself, but to parse the value once it's already been set.  So, if we throw the Exception here, that would cause all SQL requests to fail after a user has set an out-of-range value for this property.  So, the current code may be OK.", "author": "msirek", "createdAt": "2020-12-03T01:23:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU5MDg0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTAxNDU1OA==", "url": "https://github.com/splicemachine/spliceengine/pull/4740#discussion_r535014558", "bodyText": "@jyuanca does @msirek's address your comment?", "author": "hatyo", "createdAt": "2020-12-03T09:39:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU5MDg0Nw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "197fc0143cc74829c199e04208ae1f8bd33f0e04", "url": "https://github.com/splicemachine/spliceengine/commit/197fc0143cc74829c199e04208ae1f8bd33f0e04", "message": "Merge remote-tracking branch 'origin/master' into DB-10898", "committedDate": "2020-12-03T08:58:41Z", "type": "commit"}, {"oid": "85f405295da3be1ac8cd1a0fbc7cea4659ae06ba", "url": "https://github.com/splicemachine/spliceengine/commit/85f405295da3be1ac8cd1a0fbc7cea4659ae06ba", "message": "DB-10898 adapt failing test.", "committedDate": "2020-12-03T16:05:32Z", "type": "commit"}]}