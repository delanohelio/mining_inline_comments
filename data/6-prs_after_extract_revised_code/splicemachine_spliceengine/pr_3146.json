{"pr_number": 3146, "pr_title": "DB-9068 Use Java serialization for user defined aggregates", "pr_createdAt": "2020-01-17T12:30:57Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/3146", "timeline": [{"oid": "5dc17a709e4ccf35911e0ceabc078696b78ef82f", "url": "https://github.com/splicemachine/spliceengine/commit/5dc17a709e4ccf35911e0ceabc078696b78ef82f", "message": "DB-9068 Use Java serialization for user defined aggregates\n\nKryo won't have the classes registered and would fail", "committedDate": "2020-01-17T12:18:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODcxNTg5MA==", "url": "https://github.com/splicemachine/spliceengine/pull/3146#discussion_r368715890", "bodyText": "Minor issue - license header is missing", "author": "jyuanca", "createdAt": "2020-01-20T20:29:45Z", "path": "splice_machine/src/main/java/com/splicemachine/tools/StringConcat.java", "diffHunk": "@@ -0,0 +1,31 @@\n+package com.splicemachine.tools;\n+\n+import com.splicemachine.db.agg.Aggregator;\n+import com.splicemachine.db.iapi.error.StandardException;\n+\n+public class StringConcat implements Aggregator<String, String, StringConcat> {\n+    private StringBuilder agg;\n+\n+    public StringConcat() {\n+    }\n+\n+    @Override\n+    public void init() {\n+        agg = new StringBuilder();\n+    }\n+\n+    @Override\n+    public void accumulate(String value) throws StandardException {\n+        agg.append(value);\n+    }\n+\n+    @Override\n+    public void merge(StringConcat otherAggregator) {\n+        agg.append(otherAggregator.agg);\n+    }\n+\n+    @Override\n+    public String terminate() {\n+        return agg.toString();\n+    }\n+}", "originalCommit": "5dc17a709e4ccf35911e0ceabc078696b78ef82f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0e1b9b554ce3e0a4c0071120bceb9d6c6ad3117f", "chunk": "diff --git a/splice_machine/src/main/java/com/splicemachine/tools/StringConcat.java b/splice_machine/src/main/java/com/splicemachine/tools/StringConcat.java\nindex 7821bab2aa..1e8e97ccab 100644\n--- a/splice_machine/src/main/java/com/splicemachine/tools/StringConcat.java\n+++ b/splice_machine/src/main/java/com/splicemachine/tools/StringConcat.java\n\n@@ -1,3 +1,17 @@\n+/*\n+ * Copyright (c) 2012 - 2020 Splice Machine, Inc.\n+ *\n+ * This file is part of Splice Machine.\n+ * Splice Machine is free software: you can redistribute it and/or modify it under the terms of the\n+ * GNU Affero General Public License as published by the Free Software Foundation, either\n+ * version 3, or (at your option) any later version.\n+ * Splice Machine is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;\n+ * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n+ * See the GNU Affero General Public License for more details.\n+ * You should have received a copy of the GNU Affero General Public License along with Splice Machine.\n+ * If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n package com.splicemachine.tools;\n \n import com.splicemachine.db.agg.Aggregator;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NjQxNg==", "url": "https://github.com/splicemachine/spliceengine/pull/3146#discussion_r368766416", "bodyText": "[minor] replace tabs with spaces", "author": "arnaud-splice", "createdAt": "2020-01-21T00:28:12Z", "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/execute/UserDefinedAggregator.java", "diffHunk": "@@ -180,9 +185,15 @@ public ExecAggregator newAggregator()\n \t */\n \tpublic void writeExternal(ObjectOutput out) throws IOException\n \t{\n-\t\tout.writeInt( FIRST_VERSION );\n-        \n-        out.writeObject( _aggregator );\n+\t\tout.writeInt( SECOND_VERSION );", "originalCommit": "5dc17a709e4ccf35911e0ceabc078696b78ef82f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NjQzMQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3146#discussion_r368766431", "bodyText": "[minor] replace tabs with spaces", "author": "arnaud-splice", "createdAt": "2020-01-21T00:28:19Z", "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/execute/UserDefinedAggregator.java", "diffHunk": "@@ -63,6 +67,7 @@\n     ///////////////////////////////////////////////////////////////////////////////////\n \n     private static final int FIRST_VERSION = 0;\n+\tprivate static final int SECOND_VERSION = 1; // use java serialization for _aggregator since it will not be registered in our Kryo registry", "originalCommit": "5dc17a709e4ccf35911e0ceabc078696b78ef82f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0e1b9b554ce3e0a4c0071120bceb9d6c6ad3117f", "chunk": "diff --git a/db-engine/src/main/java/com/splicemachine/db/impl/sql/execute/UserDefinedAggregator.java b/db-engine/src/main/java/com/splicemachine/db/impl/sql/execute/UserDefinedAggregator.java\nindex 97f024c8bf..de2454c468 100644\n--- a/db-engine/src/main/java/com/splicemachine/db/impl/sql/execute/UserDefinedAggregator.java\n+++ b/db-engine/src/main/java/com/splicemachine/db/impl/sql/execute/UserDefinedAggregator.java\n\n@@ -67,7 +67,7 @@ public final class UserDefinedAggregator  extends UDTBase implements ExecAggrega\n     ///////////////////////////////////////////////////////////////////////////////////\n \n     private static final int FIRST_VERSION = 0;\n-\tprivate static final int SECOND_VERSION = 1; // use java serialization for _aggregator since it will not be registered in our Kryo registry\n+    private static final int SECOND_VERSION = 1; // use java serialization for _aggregator since it will not be registered in our Kryo registry\n \n     ///////////////////////////////////////////////////////////////////////////////////\n     //\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2Njc0Nw==", "url": "https://github.com/splicemachine/spliceengine/pull/3146#discussion_r368766747", "bodyText": "[minor] replace tabs with spaces", "author": "arnaud-splice", "createdAt": "2020-01-21T00:30:36Z", "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/execute/UserDefinedAggregator.java", "diffHunk": "@@ -195,9 +206,18 @@ public void writeExternal(ObjectOutput out) throws IOException\n \tpublic void readExternal(ObjectInput in) \n \t\tthrows IOException, ClassNotFoundException\n \t{\n-\t\tin.readInt();   // unused until we have a second rev of this class\n-\n-        _aggregator = (Aggregator) in.readObject();\n+\t\tint v = in.readInt();", "originalCommit": "5dc17a709e4ccf35911e0ceabc078696b78ef82f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk1MDA5Mg==", "url": "https://github.com/splicemachine/spliceengine/pull/3146#discussion_r368950092", "bodyText": "This file has mixed indenting, both options would look bad. I'd rather fix this with a repository wide reformatting effort.", "author": "dgomezferro", "createdAt": "2020-01-21T11:33:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2Njc0Nw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2OTEyMw==", "url": "https://github.com/splicemachine/spliceengine/pull/3146#discussion_r368769123", "bodyText": "assertThat(res, allOf(containsString(\"a\"), containsString(\"b\"), containsString(\"c\"), containsString(\"d\")))\nwould bring a better error message.", "author": "arnaud-splice", "createdAt": "2020-01-21T00:45:56Z", "path": "splice_machine/src/test/java/com/splicemachine/derby/impl/sql/execute/operations/SpliceUDTIT.java", "diffHunk": "@@ -202,4 +205,23 @@ public void testConnection() throws Exception {\n         Assert.assertNotNull(result);\n         Assert.assertTrue(result, result.compareTo(\"Got an internal connection\")==0);\n     }\n+\n+\n+    @Test\n+    public void testSparkUDA() throws Exception {\n+        methodWatcher.execute(\"create derby aggregate string_concat for varchar(2000) external name 'com.splicemachine.tools.StringConcat'\");\n+\n+        methodWatcher.execute(\"create table strings (v varchar(20))\");\n+        methodWatcher.execute(\"insert into strings values 'a','b','c','d'\");\n+\n+        for (boolean useSpark : Arrays.asList(true, false)) {\n+            ResultSet rs = methodWatcher.executeQuery(\"select string_concat(v) from strings --splice-properties useSpark=\"+useSpark);\n+            Assert.assertTrue(rs.next());\n+            String res = rs.getString(1);\n+            Assert.assertTrue(res.contains(\"a\"));", "originalCommit": "5dc17a709e4ccf35911e0ceabc078696b78ef82f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0e1b9b554ce3e0a4c0071120bceb9d6c6ad3117f", "chunk": "diff --git a/splice_machine/src/test/java/com/splicemachine/derby/impl/sql/execute/operations/SpliceUDTIT.java b/splice_machine/src/test/java/com/splicemachine/derby/impl/sql/execute/operations/SpliceUDTIT.java\nindex ff9ff09fba..e010b4f63b 100644\n--- a/splice_machine/src/test/java/com/splicemachine/derby/impl/sql/execute/operations/SpliceUDTIT.java\n+++ b/splice_machine/src/test/java/com/splicemachine/derby/impl/sql/execute/operations/SpliceUDTIT.java\n\n@@ -218,10 +221,7 @@ public class SpliceUDTIT extends SpliceUnitTest {\n             ResultSet rs = methodWatcher.executeQuery(\"select string_concat(v) from strings --splice-properties useSpark=\"+useSpark);\n             Assert.assertTrue(rs.next());\n             String res = rs.getString(1);\n-            Assert.assertTrue(res.contains(\"a\"));\n-            Assert.assertTrue(res.contains(\"b\"));\n-            Assert.assertTrue(res.contains(\"c\"));\n-            Assert.assertTrue(res.contains(\"d\"));\n+            assertThat(res, allOf(containsString(\"a\"), containsString(\"b\"), containsString(\"c\"), containsString(\"d\")));\n         }\n     }\n }\n"}}, {"oid": "0e1b9b554ce3e0a4c0071120bceb9d6c6ad3117f", "url": "https://github.com/splicemachine/spliceengine/commit/0e1b9b554ce3e0a4c0071120bceb9d6c6ad3117f", "message": "DB-9068 Address reviews", "committedDate": "2020-01-21T11:32:43Z", "type": "commit"}]}