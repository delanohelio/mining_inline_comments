{"pr_number": 4900, "pr_title": "DB-10759 Tell Spark where to find jars for user VTIs", "pr_createdAt": "2020-12-19T01:42:39Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/4900", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTg0MjQ2Mw==", "url": "https://github.com/splicemachine/spliceengine/pull/4900#discussion_r551842463", "bodyText": "We should try to reduce direct dependencies on Spark in \"core\" modules such as db-engine.", "author": "dgomezferro", "createdAt": "2021-01-05T10:24:15Z", "path": "db-engine/src/main/java/com/splicemachine/db/iapi/sql/conn/LanguageConnectionContext.java", "diffHunk": "@@ -1491,4 +1492,16 @@ void setDB2VarcharCompatibilityModeNeedsReset(boolean newValue,\n \n     boolean isCompilingFromTableTempTrigger();\n \n+    void addUserJarsToSparkContext();\n+\n+    boolean isSparkJob();\n+\n+    void setSparkContext(SparkContext sparkContext);\n+\n+    SparkContext getSparkContext();", "originalCommit": "4bffdb0e68fa1a5487799e838539002734f792eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjMzODA0OA==", "url": "https://github.com/splicemachine/spliceengine/pull/4900#discussion_r552338048", "bodyText": "@dgomezferro OK, I converted this to class Object and moved Spark class and API references to the spark_sql module.", "author": "msirek", "createdAt": "2021-01-06T03:01:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTg0MjQ2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "932e8dcfb67567148b25f74fafcff4cd09b5f48d", "chunk": "diff --git a/db-engine/src/main/java/com/splicemachine/db/iapi/sql/conn/LanguageConnectionContext.java b/db-engine/src/main/java/com/splicemachine/db/iapi/sql/conn/LanguageConnectionContext.java\nindex 20de06cf59..fdafb393ce 100644\n--- a/db-engine/src/main/java/com/splicemachine/db/iapi/sql/conn/LanguageConnectionContext.java\n+++ b/db-engine/src/main/java/com/splicemachine/db/iapi/sql/conn/LanguageConnectionContext.java\n\n@@ -1496,12 +1496,13 @@ public interface LanguageConnectionContext extends Context {\n \n     boolean isSparkJob();\n \n-    void setSparkContext(SparkContext sparkContext);\n+    void setSparkContext(Object sparkContext);\n \n-    SparkContext getSparkContext();\n+    Object getSparkContext();\n \n     void setApplicationJarsHashCode(int applicationJarsHashCode);\n \n     int getApplicationJarsHashCode();\n \n+    void setupSparkSQLUtils(SparkSQLUtils sparkSQLUtils);\n }\n"}}, {"oid": "fde6193fa176ac9f4046a321a35a06c883d352a8", "url": "https://github.com/splicemachine/spliceengine/commit/fde6193fa176ac9f4046a321a35a06c883d352a8", "message": "DB-10759 Tell Spark where to find jars for user VTIs", "committedDate": "2021-01-05T18:35:29Z", "type": "commit"}, {"oid": "039d594a771949c0ab573d702cb495a8c4358677", "url": "https://github.com/splicemachine/spliceengine/commit/039d594a771949c0ab573d702cb495a8c4358677", "message": "DB-10759 Fix Spotbugs", "committedDate": "2021-01-05T18:35:29Z", "type": "commit"}, {"oid": "a74d601557c231a0368c92222272600b88c23101", "url": "https://github.com/splicemachine/spliceengine/commit/a74d601557c231a0368c92222272600b88c23101", "message": "DB-10759 Fix Spotbugs, part 2.", "committedDate": "2021-01-05T18:35:29Z", "type": "commit"}, {"oid": "a74d601557c231a0368c92222272600b88c23101", "url": "https://github.com/splicemachine/spliceengine/commit/a74d601557c231a0368c92222272600b88c23101", "message": "DB-10759 Fix Spotbugs, part 2.", "committedDate": "2021-01-05T18:35:29Z", "type": "forcePushed"}, {"oid": "932e8dcfb67567148b25f74fafcff4cd09b5f48d", "url": "https://github.com/splicemachine/spliceengine/commit/932e8dcfb67567148b25f74fafcff4cd09b5f48d", "message": "DB-10759 Address review comments", "committedDate": "2021-01-06T02:57:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzI0NDkzNw==", "url": "https://github.com/splicemachine/spliceengine/pull/4900#discussion_r553244937", "bodyText": "The implementation for all platforms is the same, it should be in spark_sql/src/main/java only once instead of copied in multiple platforms.", "author": "dgomezferro", "createdAt": "2021-01-07T10:35:29Z", "path": "spark_sql/src/main/spark2.1/src/main/java/com/splicemachine/sparksql/SparkSQLUtilsImpl.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright (c) 2012 - 2021 Splice Machine, Inc.\n+ *\n+ * This file is part of Splice Machine.\n+ * Splice Machine is free software: you can redistribute it and/or modify it under the terms of the\n+ * GNU Affero General Public License as published by the Free Software Foundation, either\n+ * version 3, or (at your option) any later version.\n+ * Splice Machine is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;\n+ * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n+ * See the GNU Affero General Public License for more details.\n+ * You should have received a copy of the GNU Affero General Public License along with Splice Machine.\n+ * If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package com.splicemachine.sparksql;\n+\n+\n+import com.splicemachine.utils.SparkSQLUtils;\n+import org.apache.spark.SparkContext;\n+\n+/* Purpose:  Provide interfaces to access Spark objects or APIs\n+ *           which may differ depending on the Spark version.\n+ */\n+public class SparkSQLUtilsImpl implements SparkSQLUtils {", "originalCommit": "932e8dcfb67567148b25f74fafcff4cd09b5f48d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzU3MjM2Mw==", "url": "https://github.com/splicemachine/spliceengine/pull/4900#discussion_r553572363", "bodyText": "Good point.  I've made the change.  If we need to have different method implementations in the future based on spark version, we could create separate source files for it at that time.", "author": "msirek", "createdAt": "2021-01-07T20:32:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzI0NDkzNw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "3582515837b2943cbb3942f143d166d3f0ba813a", "url": "https://github.com/splicemachine/spliceengine/commit/3582515837b2943cbb3942f143d166d3f0ba813a", "message": "DB-10759 Address review comments, part 2", "committedDate": "2021-01-07T20:27:36Z", "type": "commit"}]}