{"pr_number": 3243, "pr_title": "DB-9124 Large concat expression cause long time hanging", "pr_createdAt": "2020-02-21T09:21:41Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/3243", "timeline": [{"oid": "72a940a7364ed8febc268f32e122959e71e77fab", "url": "https://github.com/splicemachine/spliceengine/commit/72a940a7364ed8febc268f32e122959e71e77fab", "message": "DB-9124 Large concat expression cause long time hanging", "committedDate": "2020-02-21T08:32:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQ3OTcwOQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3243#discussion_r382479709", "bodyText": "It seems this query used to work (slowly) before the fix, right? In that case we'd need to add a timeout for instance, to make sure the test fails if there's a regression. Or make the query bigger so that it crashes without the fix.", "author": "dgomezferro", "createdAt": "2020-02-21T09:31:19Z", "path": "splice_machine/src/test/java/com/splicemachine/derby/utils/SpliceStringFunctionsIT.java", "diffHunk": "@@ -713,6 +713,27 @@ public void testHEX() throws Exception {\n         rs.close();\n     }\n \n+    @Test\n+    public void testLongConcatenateString() throws Exception {\n+        String sqlText = \"SELECT COUNT(*) FROM (\" + \"SELECT CAST(CAST(c AS DECIMAL(9,4)) AS CHAR(50))||','\"", "originalCommit": "72a940a7364ed8febc268f32e122959e71e77fab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjUzODIwMg==", "url": "https://github.com/splicemachine/spliceengine/pull/3243#discussion_r382538202", "bodyText": "Agreed. I set the test case failed after 1 second. Without the fix, it took more than 10 seconds.", "author": "changli6", "createdAt": "2020-02-21T11:43:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQ3OTcwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "7656fa4a3b286e6db3c47cb05a7ec1449c3eeef8", "chunk": "diff --git a/splice_machine/src/test/java/com/splicemachine/derby/utils/SpliceStringFunctionsIT.java b/splice_machine/src/test/java/com/splicemachine/derby/utils/SpliceStringFunctionsIT.java\nindex fbfbe9b4c7..141e7fafcf 100644\n--- a/splice_machine/src/test/java/com/splicemachine/derby/utils/SpliceStringFunctionsIT.java\n+++ b/splice_machine/src/test/java/com/splicemachine/derby/utils/SpliceStringFunctionsIT.java\n\n@@ -713,23 +722,23 @@ public class SpliceStringFunctionsIT {\n         rs.close();\n     }\n \n-    @Test\n+    @Test(timeout=1000) //Time out after 1 second\n     public void testLongConcatenateString() throws Exception {\n-        String sqlText = \"SELECT COUNT(*) FROM (\" + \"SELECT CAST(CAST(c AS DECIMAL(9,4)) AS CHAR(50))||','\"\n-                + \"||CAST(CAST(c AS DECIMAL(9,4)) AS CHAR(50))||','\"\n-                + \"||CAST(CAST(c AS DECIMAL(9,4)) AS CHAR(50))||','\"\n-                + \"||CAST(CAST(c AS DECIMAL(9,4)) AS CHAR(50))||','\"\n-                + \"||CAST(CAST(c AS DECIMAL(9,4)) AS CHAR(50))||','\"\n-                + \"||CAST(CAST(c AS DECIMAL(9,4)) AS CHAR(50))||','\"\n-                + \"||CAST(CAST(c AS DECIMAL(9,4)) AS CHAR(50))||','\"\n-                + \"||CAST(CAST(c AS DECIMAL(9,4)) AS CHAR(50))||','\"\n-                + \"||CAST(CAST(c AS DECIMAL(9,4)) AS CHAR(50))||','\"\n-                + \"||CAST(CAST(c AS DECIMAL(9,4)) AS CHAR(50)) FROM \"\n-                + tableWatcherH + \") AS T\";\n+        String sqlText = \"SELECT CAST(CAST(a AS DECIMAL(3,1)) AS CHAR(4))||','\"\n+                + \"||CAST(CAST(a AS DECIMAL(3,1)) AS CHAR(4))||','\"\n+                + \"||CAST(CAST(a AS DECIMAL(3,1)) AS CHAR(4))||','\"\n+                + \"||CAST(CAST(a AS DECIMAL(3,1)) AS CHAR(4))||','\"\n+                + \"||CAST(CAST(a AS DECIMAL(3,1)) AS CHAR(4))||','\"\n+                + \"||CAST(CAST(a AS DECIMAL(3,1)) AS CHAR(4))||','\"\n+                + \"||CAST(CAST(a AS DECIMAL(3,1)) AS CHAR(4))||','\"\n+                + \"||CAST(CAST(a AS DECIMAL(3,1)) AS CHAR(4))||','\"\n+                + \"||CAST(CAST(a AS DECIMAL(3,1)) AS CHAR(4))||','\"\n+                + \"||CAST(CAST(a AS DECIMAL(3,1)) AS CHAR(4))||','\"\n+                + \"||CAST(CAST(a AS DECIMAL(3,1)) AS CHAR(4)) FROM \" + tableWatcherJ ;\n         ResultSet rs = methodWatcher.executeQuery(sqlText);\n         rs.next();\n \n-        assertEquals(1 , rs.getInt(1));\n+        assertEquals(\"Wrong result\",\"12.3,12.3,12.3,12.3,12.3,12.3,12.3,12.3,12.3,12.3,12.3\", rs.getString(1));\n         rs.close();\n     }\n \n"}}, {"oid": "7656fa4a3b286e6db3c47cb05a7ec1449c3eeef8", "url": "https://github.com/splicemachine/spliceengine/commit/7656fa4a3b286e6db3c47cb05a7ec1449c3eeef8", "message": "Set testLongConcatenateString timeout after 1 sec", "committedDate": "2020-02-21T11:32:30Z", "type": "commit"}]}