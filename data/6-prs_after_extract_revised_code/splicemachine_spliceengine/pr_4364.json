{"pr_number": 4364, "pr_title": "DB-10558 Improve getTxnAt performance", "pr_createdAt": "2020-10-23T12:53:01Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/4364", "timeline": [{"oid": "f2b2e5ef388f96a942042e524835114feafda1d2", "url": "https://github.com/splicemachine/spliceengine/commit/f2b2e5ef388f96a942042e524835114feafda1d2", "message": "DB-10558 More efficient HBase scans in time travel.", "committedDate": "2020-10-23T11:14:33Z", "type": "commit"}, {"oid": "270ff9bda427f8729fb83714d5079c0ee176643e", "url": "https://github.com/splicemachine/spliceengine/commit/270ff9bda427f8729fb83714d5079c0ee176643e", "message": "DB-10558 Add getTxnAt to high-priority queue.", "committedDate": "2020-10-23T12:34:34Z", "type": "commit"}, {"oid": "2c4343a6e4191901fb4f7e5a54c0f8e57db9ebf2", "url": "https://github.com/splicemachine/spliceengine/commit/2c4343a6e4191901fb4f7e5a54c0f8e57db9ebf2", "message": "Merge remote-tracking branch 'origin/master' into DB-10558", "committedDate": "2020-10-23T12:58:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDg3NjU4MA==", "url": "https://github.com/splicemachine/spliceengine/pull/4364#discussion_r510876580", "bodyText": "filterRowKey should only filter based on the rowkey, here you are looking at specific values. This is most likely called only once per row.\nI'm guessing the current implementation wouldn't work on SPLICE_TXN, since we'd inspect the latest written cell (COMMITTED or ROLLEDBACK), see that it's not the ACTIVE state and filter it out, which would filter out the whole row.", "author": "dgomezferro", "createdAt": "2020-10-23T13:17:26Z", "path": "hbase_storage/src/main/java/com/splicemachine/si/impl/region/HBaseTxnFinder.java", "diffHunk": "@@ -89,15 +92,81 @@ public void close() throws IOException {\n         }\n     }\n \n+    private static class TxWithTimestampFilter extends FilterBase {\n+\n+        @Override\n+        public boolean filterRowKey(Cell cell) {", "originalCommit": "270ff9bda427f8729fb83714d5079c0ee176643e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAyOTg0NA==", "url": "https://github.com/splicemachine/spliceengine/pull/4364#discussion_r511029844", "bodyText": "Thanks Daniel, I fixed it, now we simply return false in filterRowKey() method and I provided an implementation for filterCell instead, which returns INCLUDE for ACTIVE state.", "author": "hatyo", "createdAt": "2020-10-23T17:22:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDg3NjU4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU0NTk5MA==", "url": "https://github.com/splicemachine/spliceengine/pull/4364#discussion_r512545990", "bodyText": "Looks good, I think you don't need to implement it at all, the implementation on the super class should be good too, but it's OK with me.", "author": "dgomezferro", "createdAt": "2020-10-27T09:46:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDg3NjU4MA=="}], "type": "inlineReview", "revised_code": {"commit": "a41c523928311bf0714444f8ca4fee67ae89f838", "chunk": "diff --git a/hbase_storage/src/main/java/com/splicemachine/si/impl/region/HBaseTxnFinder.java b/hbase_storage/src/main/java/com/splicemachine/si/impl/region/HBaseTxnFinder.java\nindex 12d976c84a..02d2393c67 100644\n--- a/hbase_storage/src/main/java/com/splicemachine/si/impl/region/HBaseTxnFinder.java\n+++ b/hbase_storage/src/main/java/com/splicemachine/si/impl/region/HBaseTxnFinder.java\n\n@@ -94,13 +95,22 @@ public class HBaseTxnFinder implements TxnFinder {\n \n     private static class TxWithTimestampFilter extends FilterBase {\n \n+        /**\n+         * always return false so we make sure that {@link #filterCell(Cell)} method is called.\n+         */\n         @Override\n         public boolean filterRowKey(Cell cell) {\n-            if(cell == null) {\n-                return true;\n-            }\n+            return false;\n+        }\n+\n+        @Override\n+        public ReturnCode filterCell(final Cell cell) throws IOException {\n             Txn.State state = Txn.State.decode(cell.getValueArray(), cell.getValueOffset(), cell.getValueLength());\n-            return state != Txn.State.ACTIVE;\n+            if(state == Txn.State.ACTIVE) {\n+                return ReturnCode.INCLUDE;\n+            } else {\n+                return ReturnCode.SKIP;\n+            }\n         }\n     }\n \n"}}, {"oid": "a41c523928311bf0714444f8ca4fee67ae89f838", "url": "https://github.com/splicemachine/spliceengine/commit/a41c523928311bf0714444f8ca4fee67ae89f838", "message": "DB-10558 address comments.", "committedDate": "2020-10-23T17:29:25Z", "type": "commit"}, {"oid": "fbbdd2ee3cd8ffc8f204df39ea108ff2c2f02ce5", "url": "https://github.com/splicemachine/spliceengine/commit/fbbdd2ee3cd8ffc8f204df39ea108ff2c2f02ce5", "message": "Revert \"DB-10558 Add getTxnAt to high-priority queue.\"\n\nThis reverts commit 270ff9bda427f8729fb83714d5079c0ee176643e.", "committedDate": "2020-10-23T17:29:52Z", "type": "commit"}, {"oid": "eb215160d298174daec0079a3d9ff456927e96d1", "url": "https://github.com/splicemachine/spliceengine/commit/eb215160d298174daec0079a3d9ff456927e96d1", "message": "Merge remote-tracking branch 'origin/master' into DB-10558", "committedDate": "2020-10-26T08:24:33Z", "type": "commit"}]}