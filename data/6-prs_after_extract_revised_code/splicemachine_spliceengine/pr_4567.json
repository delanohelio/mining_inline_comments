{"pr_number": 4567, "pr_title": "DB-10718 fix HEX function for non-ASCII Strings", "pr_createdAt": "2020-11-12T09:42:54Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/4567", "timeline": [{"oid": "ebfb1ebd7d7c2fad7e6117142e0f89a50d4086b6", "url": "https://github.com/splicemachine/spliceengine/commit/ebfb1ebd7d7c2fad7e6117142e0f89a50d4086b6", "message": "DB-10718 fix HEX function", "committedDate": "2020-11-12T09:40:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk3NzI1MA==", "url": "https://github.com/splicemachine/spliceengine/pull/4567#discussion_r521977250", "bodyText": "please make this null friendly:\nString result = rs.getString(index);\nrs.wasNull() ? null : result;", "author": "hatyo", "createdAt": "2020-11-12T09:54:15Z", "path": "splice_machine/src/test/java/com/splicemachine/derby/test/framework/SpliceWatcher.java", "diffHunk": "@@ -377,4 +378,13 @@ public long getConglomId(String tableName, String schemaName) throws Exception {\n         }\n         return -1l;\n     }\n+\n+    public String executeGetString(String sql, int index) throws SQLException {\n+        try( Statement s = getOrCreateConnection().createStatement();\n+             ResultSet rs = s.executeQuery(sql))\n+        {\n+            Assert.assertTrue(rs.next());\n+            return rs.getString(index);", "originalCommit": "ebfb1ebd7d7c2fad7e6117142e0f89a50d4086b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk5NDc5OQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4567#discussion_r521994799", "bodyText": "this is already covered by getString, see docu https://docs.oracle.com/javase/7/docs/api/java/sql/ResultSet.html#getString(int)\nhowever you're right if we would add sth like Integer executeGetInteger we would need to check wasNull since getInt only returns the primitive type int.", "author": "martinrupp", "createdAt": "2020-11-12T10:20:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk3NzI1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk5NzM5MQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4567#discussion_r521997391", "bodyText": "Thanks! I didn't know that it is specified in JDBC interface that reference types must return null if they are null.", "author": "hatyo", "createdAt": "2020-11-12T10:24:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk3NzI1MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk3NzUwMg==", "url": "https://github.com/splicemachine/spliceengine/pull/4567#discussion_r521977502", "bodyText": "see above, in order to test null properly.", "author": "hatyo", "createdAt": "2020-11-12T09:54:35Z", "path": "splice_machine/src/test/java/com/splicemachine/derby/utils/SpliceStringFunctionsIT.java", "diffHunk": "@@ -702,40 +702,37 @@ public void testCastToFixedLengthCharType() throws Exception {\n \n     @Test\n     public void testHEX() throws Exception {\n-        String sqlText = \"values hex('B')\";\n-        ResultSet rs = methodWatcher.executeQuery(sqlText);\n-        rs.next();\n-        Assert.assertEquals(\"Wrong result value\", \"42\", rs.getString(1) );\n-\n-        sqlText = \"values hex('000020')\";\n-        rs = methodWatcher.executeQuery(sqlText);\n-        rs.next();\n-        Assert.assertEquals(\"Wrong result value\", \"303030303230\", rs.getString(1) );\n-\n-        sqlText = \"values hex(concat('a','b'))\";\n-        rs = methodWatcher.executeQuery(sqlText);\n-        rs.next();\n-        Assert.assertEquals(\"Wrong result value\", \"6162\", rs.getString(1) );\n \n-        sqlText = \"values hex(null)\";\n-        rs = methodWatcher.executeQuery(sqlText);\n-        rs.next();\n-        Assert.assertEquals(\"Wrong result value\", null, rs.getString(1) );\n-\n-        sqlText = \"values hex('')\";\n-        rs = methodWatcher.executeQuery(sqlText);\n-        rs.next();\n-        Assert.assertEquals(\"Wrong result value\",\"\", rs.getString(1) );\n+        // note that HEX is using getBytes(\"UTF-8\") to get a fixed representation\n+\n+        String tests[] = {\n+                \"'B'\",              \"42\",\n+                \"'000020'\",         \"303030303230\",\n+                \"'000020'\" ,        \"303030303230\",\n+                \"'\u00df'\",              \"C39F\",\n+                \"'\\u00E4'\",         \"C3A4\",     // \u00e4  https://www.compart.com/de/unicode/U+00E4\n+                \"'\\uD83D\\uDE02'\",   \"F09F9882\", // \ud83d\ude02 https://www.compart.com/de/unicode/U+1F602\n+                \"'Hello, World!'\",    \"48656C6C6F2C20576F726C6421\",\n+\n+                \"''\",               \"\",\n+                \"null\",             null,", "originalCommit": "ebfb1ebd7d7c2fad7e6117142e0f89a50d4086b6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk3OTg2NQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4567#discussion_r521979865", "bodyText": "I would rather use a constant such as com.splicemachine.primitives.Bytes.UTF8_CHARSET", "author": "hatyo", "createdAt": "2020-11-12T09:57:56Z", "path": "splice_machine/src/main/java/com/splicemachine/derby/utils/SpliceStringFunctions.java", "diffHunk": "@@ -134,17 +135,15 @@ else if (i >= 256)\n      * @param s An expression that returns a value with a maximum length of 16 336 bytes.\n      * @return Returns a hexadecimal representation of a value as a character string\n      */\n-    @SuppressFBWarnings(value = \"DM_DEFAULT_ENCODING\", justification = \"DB-9844\")\n-    public static String HEX(String s)\n-    {\n+    public static String HEX(String s) throws UnsupportedEncodingException {\n         if (s == null)\n             return null;\n-        else\n-            return StringUtil.toHexString(s.getBytes(),0,s.length()).toUpperCase();\n-\n+        else {\n+            byte[] b = s.getBytes(\"UTF-8\");", "originalCommit": "ebfb1ebd7d7c2fad7e6117142e0f89a50d4086b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk5NTQwMQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4567#discussion_r521995401", "bodyText": "thanks, good suggestion!", "author": "martinrupp", "createdAt": "2020-11-12T10:21:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk3OTg2NQ=="}], "type": "inlineReview", "revised_code": {"commit": "0c2050dcb33d96ce48f8e1af5b3b4bab5404d759", "chunk": "diff --git a/splice_machine/src/main/java/com/splicemachine/derby/utils/SpliceStringFunctions.java b/splice_machine/src/main/java/com/splicemachine/derby/utils/SpliceStringFunctions.java\nindex 881d080c3c..4d33b05419 100644\n--- a/splice_machine/src/main/java/com/splicemachine/derby/utils/SpliceStringFunctions.java\n+++ b/splice_machine/src/main/java/com/splicemachine/derby/utils/SpliceStringFunctions.java\n\n@@ -139,7 +140,7 @@ public class SpliceStringFunctions {\n         if (s == null)\n             return null;\n         else {\n-            byte[] b = s.getBytes(\"UTF-8\");\n+            byte[] b = s.getBytes(Bytes.UTF8_CHARSET);\n             return StringUtil.toHexString(b, 0, b.length).toUpperCase();\n         }\n     }\n"}}, {"oid": "0c2050dcb33d96ce48f8e1af5b3b4bab5404d759", "url": "https://github.com/splicemachine/spliceengine/commit/0c2050dcb33d96ce48f8e1af5b3b4bab5404d759", "message": "DB-10718 address comments", "committedDate": "2020-11-12T10:21:25Z", "type": "commit"}]}