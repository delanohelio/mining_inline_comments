{"pr_number": 4646, "pr_title": "DB-10720 single quote escaping improved", "pr_createdAt": "2020-11-18T09:40:19Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/4646", "timeline": [{"oid": "9e124c3e202d10e6c8d3c900f08c137a7cf5cd40", "url": "https://github.com/splicemachine/spliceengine/commit/9e124c3e202d10e6c8d3c900f08c137a7cf5cd40", "message": "DB-10720 single quote escaping improved", "committedDate": "2020-11-18T09:38:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQyOTY4Nw==", "url": "https://github.com/splicemachine/spliceengine/pull/4646#discussion_r529429687", "bodyText": "i guess we can remove this comment, since SELECT * FROM VALUES also has other problems (like fails for long results, see DB-10542)", "author": "martinrupp", "createdAt": "2020-11-24T10:37:14Z", "path": "splice_machine/src/main/java/com/splicemachine/derby/utils/SpliceAdmin.java", "diffHunk": "@@ -2273,16 +2273,22 @@ public static void INVALIDATE_GLOBAL_DICTIONARY_CACHE() throws Exception {\n     }\n \n     @SuppressFBWarnings(value=\"SQL_NONCONSTANT_STRING_PASSED_TO_EXECUTE\", justification=\"Intentional\")\n-    public static void SHOW_CREATE_TABLE(String schemaName, String tableName, ResultSet[] resultSet) throws SQLException\n+    public static void SHOW_CREATE_TABLE(String schemaName, String tableName, ResultSet[] resultSet) throws SQLException, StandardException\n     {\n-        List<String> ddls = SHOW_CREATE_TABLE_CORE(schemaName, tableName, false, true);\n-        StringBuilder sb = new StringBuilder(\"SELECT * FROM (VALUES '\");\n-        sb.append(ddls.get(0));\n-        sb.append(\";') FOO (DDL)\");\n-        resultSet[0] = executeStatement(sb);\n+        List<String> ddls = SHOW_CREATE_TABLE_CORE(schemaName, tableName, false);\n+\n+//        There are two solutions to have one place to escape single quotes. During the PR can chosen be the best one:\n+//        1) just to replace single quote by double quotes before wrapping to sql\n+//        StringBuilder sb = new StringBuilder(\"SELECT * FROM (VALUES '\");\n+//        sb.append(ddls.get(0).replace(\"'\", \"''\"));\n+//        sb.append(\";') FOO (DDL)\");\n+//        resultSet[0] = executeStatement(sb);\n+\n+//        2) to use ProcedureUtils.generateResult", "originalCommit": "9e124c3e202d10e6c8d3c900f08c137a7cf5cd40", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTU3Nzk5MA==", "url": "https://github.com/splicemachine/spliceengine/pull/4646#discussion_r529577990", "bodyText": "done", "author": "ipraznik-splice", "createdAt": "2020-11-24T14:17:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQyOTY4Nw=="}], "type": "inlineReview", "revised_code": {"commit": "b8a5d51e3385275d4e288291da655b4361195521", "chunk": "diff --git a/splice_machine/src/main/java/com/splicemachine/derby/utils/SpliceAdmin.java b/splice_machine/src/main/java/com/splicemachine/derby/utils/SpliceAdmin.java\nindex 720652145c..6767025393 100644\n--- a/splice_machine/src/main/java/com/splicemachine/derby/utils/SpliceAdmin.java\n+++ b/splice_machine/src/main/java/com/splicemachine/derby/utils/SpliceAdmin.java\n\n@@ -2276,15 +2276,6 @@ public class SpliceAdmin extends BaseAdminProcedures{\n     public static void SHOW_CREATE_TABLE(String schemaName, String tableName, ResultSet[] resultSet) throws SQLException, StandardException\n     {\n         List<String> ddls = SHOW_CREATE_TABLE_CORE(schemaName, tableName, false);\n-\n-//        There are two solutions to have one place to escape single quotes. During the PR can chosen be the best one:\n-//        1) just to replace single quote by double quotes before wrapping to sql\n-//        StringBuilder sb = new StringBuilder(\"SELECT * FROM (VALUES '\");\n-//        sb.append(ddls.get(0).replace(\"'\", \"''\"));\n-//        sb.append(\";') FOO (DDL)\");\n-//        resultSet[0] = executeStatement(sb);\n-\n-//        2) to use ProcedureUtils.generateResult\n         resultSet[0] = ProcedureUtils.generateResult(\"DDL\", ddls.get(0) + \";\");\n     }\n \n"}}, {"oid": "b8a5d51e3385275d4e288291da655b4361195521", "url": "https://github.com/splicemachine/spliceengine/commit/b8a5d51e3385275d4e288291da655b4361195521", "message": "DB-10720 unittest for a lot of columns as in DB-10542", "committedDate": "2020-11-24T14:15:10Z", "type": "commit"}, {"oid": "405661c3076f028741331061fa2fd89dd0044b03", "url": "https://github.com/splicemachine/spliceengine/commit/405661c3076f028741331061fa2fd89dd0044b03", "message": "DB-10720 unittest for a lot of columns renamed", "committedDate": "2020-11-24T14:29:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTYyODI1Mg==", "url": "https://github.com/splicemachine/spliceengine/pull/4646#discussion_r529628252", "bodyText": "awesome", "author": "martinrupp", "createdAt": "2020-11-24T15:21:59Z", "path": "splice_machine/src/test/java/com/splicemachine/derby/utils/ShowCreateTableIT.java", "diffHunk": "@@ -618,4 +619,29 @@ private static void  checkEqualIgnoreConstraintOrder(String expected, String act\n         String expectedResult = Stream.of(expected.split(\"CONSTRAINT \")).map(str -> str.substring(0, str.length() - 2)).sorted().collect(Collectors.joining(\", \"));\n         Assert.assertEquals(expectedResult, result);\n     }\n+\n+    @Test\n+    public void testTableDDLLonger32672() throws Exception {\n+        StringBuilder columnsDdlBuilder = new StringBuilder();\n+        final String columnTypes[] = {\"VARCHAR(30)\", \"CHAR(10)\", \"BIGINT\", \"DATE\", \"INTEGER\", \"DECIMAL(4,2)\"};\n+        Random rand = new Random();\n+\n+        int columnCounter = 0;\n+        while (columnsDdlBuilder.length() < 43100) {\n+            if (columnCounter > 0) {\n+                columnsDdlBuilder.append(\",\");\n+            }\n+            columnsDdlBuilder.append(String.format(\"\\\"COL_%d\\\" %s\\n\", columnCounter++, columnTypes[rand.nextInt(columnTypes.length)]));", "originalCommit": "405661c3076f028741331061fa2fd89dd0044b03", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}