{"pr_number": 4058, "pr_title": "DB-10101: avoid read/write contention on SYSBACKUPS file", "pr_createdAt": "2020-08-27T04:52:38Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/4058", "timeline": [{"oid": "d4821411ad30fb8e17e353f16f7248ca750c41e6", "url": "https://github.com/splicemachine/spliceengine/commit/d4821411ad30fb8e17e353f16f7248ca750c41e6", "message": "DB-10101: avoid read/write contention on SYSBACKUPS file", "committedDate": "2020-08-27T04:43:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU1MTg1Mw==", "url": "https://github.com/splicemachine/spliceengine/pull/4058#discussion_r478551853", "bodyText": "What happens if there's a table/schema backup going on but there was a previous full backup ? Without this change we would register the HFile and with it we wouldn't. Should we change the check to if (!shouldRegister && BackupUtils.existsDatabaseBackup(fs, rootDir) ? Would that create a race condition in the SYSBACKUPS file too?", "author": "dgomezferro", "createdAt": "2020-08-27T16:38:02Z", "path": "hbase_sql/src/main/java/com/splicemachine/hbase/BackupUtils.java", "diffHunk": "@@ -234,6 +231,12 @@ public static boolean shouldCaptureIncrementalChanges(FileSystem fs,Path rootDir\n                             }\n                         }\n                     }\n+                    else if (BackupUtils.existsDatabaseBackup(fs, rootDir)) {", "originalCommit": "d4821411ad30fb8e17e353f16f7248ca750c41e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQ0OTUzOQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4058#discussion_r479449539", "bodyText": "Good point!. Table/schema backup should not write to SYSBACKUPS file. I made changes to ee branch.", "author": "jyuanca", "createdAt": "2020-08-28T17:45:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU1MTg1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "f6b977482a1f2cc6a826352a391a5794e5520009", "chunk": "diff --git a/hbase_sql/src/main/java/com/splicemachine/hbase/BackupUtils.java b/hbase_sql/src/main/java/com/splicemachine/hbase/BackupUtils.java\nindex 720e6c9894..6a0d37ae2e 100644\n--- a/hbase_sql/src/main/java/com/splicemachine/hbase/BackupUtils.java\n+++ b/hbase_sql/src/main/java/com/splicemachine/hbase/BackupUtils.java\n\n@@ -231,7 +231,7 @@ public class BackupUtils {\n                             }\n                         }\n                     }\n-                    else if (BackupUtils.existsDatabaseBackup(fs, rootDir)) {\n+                    if (!shouldRegister && BackupUtils.existsDatabaseBackup(fs, rootDir)) {\n                         if (LOG.isDebugEnabled()) {\n                             SpliceLogUtils.debug(LOG, \"There exists a successful full or incremental backup in the system\");\n                         }\n"}}, {"oid": "f6b977482a1f2cc6a826352a391a5794e5520009", "url": "https://github.com/splicemachine/spliceengine/commit/f6b977482a1f2cc6a826352a391a5794e5520009", "message": "address review comments", "committedDate": "2020-08-28T17:30:05Z", "type": "commit"}]}