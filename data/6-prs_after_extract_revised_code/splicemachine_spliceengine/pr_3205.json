{"pr_number": 3205, "pr_title": "DB-9054: retrieve replication latency", "pr_createdAt": "2020-02-05T22:49:17Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/3205", "timeline": [{"oid": "b875c587e9226695263764da33998d61c1a05eda", "url": "https://github.com/splicemachine/spliceengine/commit/b875c587e9226695263764da33998d61c1a05eda", "message": "DB-9054: retrieve replication latency", "committedDate": "2020-02-05T17:46:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM1NDYwMw==", "url": "https://github.com/splicemachine/spliceengine/pull/3205#discussion_r382354603", "bodyText": "typo in the result string, I guess it should be \"Information not available\".", "author": "yxia92", "createdAt": "2020-02-21T01:38:40Z", "path": "splice_machine/src/main/java/com/splicemachine/replication/ReplicationSystemProcedure.java", "diffHunk": "@@ -61,6 +62,19 @@\n \n     private static Logger LOG = Logger.getLogger(ReplicationSystemProcedure.class);\n \n+    public static void GET_REPLICATION_PROGRESS(ResultSet[] resultSets) throws StandardException, SQLException {\n+        ReplicationManager replicationManager = EngineDriver.driver().manager().getReplicationManager();\n+        long ts = replicationManager.getReplicationProgress();\n+        if (ts > 0) {\n+            DateTime dateTime = new DateTime(ts);\n+            resultSets[0] = ProcedureUtils.generateResult(\n+                    \"Replication progress\", dateTime.toString());\n+        }\n+        else {\n+            resultSets[0] = ProcedureUtils.generateResult(\"Error\", \"Information for available\");", "originalCommit": "b875c587e9226695263764da33998d61c1a05eda", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0ee40083254205c30678165acdff3ac02d878d6c", "chunk": "diff --git a/splice_machine/src/main/java/com/splicemachine/replication/ReplicationSystemProcedure.java b/splice_machine/src/main/java/com/splicemachine/replication/ReplicationSystemProcedure.java\nindex 97066b64fa..27a6776c1e 100644\n--- a/splice_machine/src/main/java/com/splicemachine/replication/ReplicationSystemProcedure.java\n+++ b/splice_machine/src/main/java/com/splicemachine/replication/ReplicationSystemProcedure.java\n\n@@ -71,7 +71,7 @@ public class ReplicationSystemProcedure {\n                     \"Replication progress\", dateTime.toString());\n         }\n         else {\n-            resultSets[0] = ProcedureUtils.generateResult(\"Error\", \"Information for available\");\n+            resultSets[0] = ProcedureUtils.generateResult(\"Error\", \"Information not available\");\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM1NDk0MQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3205#discussion_r382354941", "bodyText": "It seems that we assume only one replication slave cluster for this system procedure. Can this logic be extended in the future if we have  multiple slave clusters?", "author": "yxia92", "createdAt": "2020-02-21T01:40:05Z", "path": "splice_machine/src/main/java/com/splicemachine/replication/ReplicationSystemProcedure.java", "diffHunk": "@@ -61,6 +62,19 @@\n \n     private static Logger LOG = Logger.getLogger(ReplicationSystemProcedure.class);\n \n+    public static void GET_REPLICATION_PROGRESS(ResultSet[] resultSets) throws StandardException, SQLException {\n+        ReplicationManager replicationManager = EngineDriver.driver().manager().getReplicationManager();\n+        long ts = replicationManager.getReplicationProgress();", "originalCommit": "b875c587e9226695263764da33998d61c1a05eda", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM5ODQyMA==", "url": "https://github.com/splicemachine/spliceengine/pull/3205#discussion_r382398420", "bodyText": "This system procedure is run on a slave cluster", "author": "jyuanca", "createdAt": "2020-02-21T05:01:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM1NDk0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM5OTY3Nw==", "url": "https://github.com/splicemachine/spliceengine/pull/3205#discussion_r382399677", "bodyText": "I see. Thanks!", "author": "yxia92", "createdAt": "2020-02-21T05:07:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM1NDk0MQ=="}], "type": "inlineReview", "revised_code": {"commit": "0ee40083254205c30678165acdff3ac02d878d6c", "chunk": "diff --git a/splice_machine/src/main/java/com/splicemachine/replication/ReplicationSystemProcedure.java b/splice_machine/src/main/java/com/splicemachine/replication/ReplicationSystemProcedure.java\nindex 97066b64fa..27a6776c1e 100644\n--- a/splice_machine/src/main/java/com/splicemachine/replication/ReplicationSystemProcedure.java\n+++ b/splice_machine/src/main/java/com/splicemachine/replication/ReplicationSystemProcedure.java\n\n@@ -71,7 +71,7 @@ public class ReplicationSystemProcedure {\n                     \"Replication progress\", dateTime.toString());\n         }\n         else {\n-            resultSets[0] = ProcedureUtils.generateResult(\"Error\", \"Information for available\");\n+            resultSets[0] = ProcedureUtils.generateResult(\"Error\", \"Information not available\");\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM1OTA5OQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3205#discussion_r382359099", "bodyText": "The call to CellUtil.cloneQualifier(cell) here seems redundant, should we just use colName?", "author": "yxia92", "createdAt": "2020-02-21T01:56:23Z", "path": "hbase_sql/src/main/java/com/splicemachine/hbase/SpliceReplicationSinkChore.java", "diffHunk": "@@ -260,19 +264,29 @@ private void updateProgress() throws IOException, KeeperException, InterruptedEx\n                     SpliceLogUtils.info(LOG, \"Checking snapshot taken at %d\", timestamp);\n                 //}\n                 CellScanner s = r.cellScanner();\n+                long ts = -1;\n                 while (s.advance()) {\n                     Cell cell = s.current();\n-                    String walName = Bytes.toString(CellUtil.cloneQualifier(cell));\n-                    Long position = Bytes.toLong(CellUtil.cloneValue(cell));\n-                    if (replicationProgress.containsKey(walName)) {\n-                        long appliedPosition = replicationProgress.get(walName);\n+                    byte[] colName = CellUtil.cloneQualifier(cell);\n+                    if(Arrays.equals(colName, HBaseConfiguration.REPLICATION_SNAPSHOT_TSCOL_BYTES)){\n+                        ts = Bytes.toLong(CellUtil.cloneValue(cell));\n                         //if (LOG.isDebugEnabled()) {\n+                        SpliceLogUtils.info(LOG, \"Process snapshot take at %s\", new DateTime(ts).toString());\n+                        //}\n+                    }\n+                    else {\n+                        String walName = Bytes.toString(CellUtil.cloneQualifier(cell));", "originalCommit": "b875c587e9226695263764da33998d61c1a05eda", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0ee40083254205c30678165acdff3ac02d878d6c", "chunk": "diff --git a/hbase_sql/src/main/java/com/splicemachine/hbase/SpliceReplicationSinkChore.java b/hbase_sql/src/main/java/com/splicemachine/hbase/SpliceReplicationSinkChore.java\nindex 1400ec7ccf..28be7d1497 100644\n--- a/hbase_sql/src/main/java/com/splicemachine/hbase/SpliceReplicationSinkChore.java\n+++ b/hbase_sql/src/main/java/com/splicemachine/hbase/SpliceReplicationSinkChore.java\n\n@@ -275,7 +275,7 @@ public class SpliceReplicationSinkChore extends ScheduledChore {\n                         //}\n                     }\n                     else {\n-                        String walName = Bytes.toString(CellUtil.cloneQualifier(cell));\n+                        String walName = Bytes.toString(colName);\n                         Long position = Bytes.toLong(CellUtil.cloneValue(cell));\n                         if (replicationProgress.containsKey(walName)) {\n                             long appliedPosition = replicationProgress.get(walName);\n"}}, {"oid": "0ee40083254205c30678165acdff3ac02d878d6c", "url": "https://github.com/splicemachine/spliceengine/commit/0ee40083254205c30678165acdff3ac02d878d6c", "message": "address review comments", "committedDate": "2020-02-21T05:14:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQwMjc2NA==", "url": "https://github.com/splicemachine/spliceengine/pull/3205#discussion_r386402764", "bodyText": "Why is that necessary?", "author": "arnaud-splice", "createdAt": "2020-03-02T13:50:40Z", "path": "platform_it/src/test/java/com/splicemachine/test/SpliceTestPlatformConfig.java", "diffHunk": "@@ -321,8 +321,8 @@ public static Configuration create(String hbaseRootDirUri,\n         // Replication\n         //\n         config.setBoolean(\"replication.source.eof.autorecovery\", true);\n-        config.set(\"hbase.replication.source.service\", \"com.splicemachine.replication.SpliceReplication\");\n-        config.set(\"hbase.replication.sink.service\", \"com.splicemachine.replication.SpliceReplication\");\n+        //config.set(\"hbase.replication.source.service\", \"com.splicemachine.replication.SpliceReplication\");\n+        //config.set(\"hbase.replication.sink.service\", \"com.splicemachine.replication.SpliceReplication\");", "originalCommit": "0ee40083254205c30678165acdff3ac02d878d6c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM2MDcwOQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3205#discussion_r387360709", "bodyText": "Comment them out so that splice can be started w/o building ee branch, because SpliceReplication is only available on ee branch. Without commenting them out, the following command will fail\n./start-splice-cluster -pcdh6.3.0\nYou have to always build with ee branch\nstart-splice-cluster -pcdh6.3.0,ee", "author": "jyuanca", "createdAt": "2020-03-03T23:40:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQwMjc2NA=="}], "type": "inlineReview", "revised_code": null}]}