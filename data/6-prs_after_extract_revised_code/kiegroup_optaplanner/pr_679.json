{"pr_number": 679, "pr_title": "PLANNER-1829: Add a ConstraintProvider for Scrabble", "pr_createdAt": "2020-02-10T19:34:25Z", "pr_url": "https://github.com/kiegroup/optaplanner/pull/679", "timeline": [{"oid": "a415badc5a20f0bb9b1f1f091cb80a615ea4a4eb", "url": "https://github.com/kiegroup/optaplanner/commit/a415badc5a20f0bb9b1f1f091cb80a615ea4a4eb", "message": "PLANNER-1829: Add a ConstraintProvider for Scrabble\n\nNote: FAST_ASSERT passes, but FULL_ASSERT fails", "committedDate": "2020-02-10T19:31:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI3NTMyNw==", "url": "https://github.com/kiegroup/optaplanner/pull/679#discussion_r377275327", "bodyText": "Some suggestions, for reasons of performance:\n\nThe first getX()/getY() comparisons should be done using Joiners.equal(...).\nI would consider first filtering out all the cells where c1.hasWordSet(...) and only then joining with c2.", "author": "triceo", "createdAt": "2020-02-10T19:40:50Z", "path": "optaplanner-examples/src/main/java/org/optaplanner/examples/scrabble/optional/score/ScrabbleConstraintProvider.java", "diffHunk": "@@ -0,0 +1,69 @@\n+package org.optaplanner.examples.scrabble.optional.score;\n+\n+import org.optaplanner.core.api.score.buildin.hardmediumsoft.HardMediumSoftScore;\n+import org.optaplanner.core.api.score.stream.Constraint;\n+import org.optaplanner.core.api.score.stream.ConstraintCollectors;\n+import org.optaplanner.core.api.score.stream.ConstraintFactory;\n+import org.optaplanner.core.api.score.stream.ConstraintProvider;\n+import org.optaplanner.core.impl.score.stream.bi.FilteringBiJoiner;\n+import org.optaplanner.examples.scrabble.domain.ScrabbleWordDirection;\n+import org.optaplanner.examples.scrabble.domain.ScrabbleCell;\n+import org.optaplanner.examples.scrabble.domain.ScrabbleWordAssignment;\n+\n+public class ScrabbleConstraintProvider implements ConstraintProvider {\n+\n+    @Override\n+    public Constraint[] defineConstraints(ConstraintFactory constraintFactory) {\n+        return new Constraint[]{\n+                                characterConflict(constraintFactory),\n+                                noParallelHorizontalNeighbours(constraintFactory),\n+                                noParallelVerticalNeighbours(constraintFactory),\n+                                outOfGrid(constraintFactory),\n+                                maximizeMergesPerWord(constraintFactory),\n+                                pullToCenter(constraintFactory)\n+        };\n+    }\n+\n+    private Constraint characterConflict(ConstraintFactory cf) {\n+        return cf.from(ScrabbleCell.class)\n+                 .filter(sc -> sc.getCharacterSet().size() >= 2)\n+                 .penalize(\"Character confict\", HardMediumSoftScore.ONE_HARD, sc -> 1 - sc.getCharacterSet().size());\n+    }\n+\n+    private Constraint noParallelHorizontalNeighbours(ConstraintFactory cf) {\n+        return cf.fromUniquePair(ScrabbleCell.class)\n+                 .filter((c1, c2) -> c1.getX() == c2.getX() &&\n+                                     Math.abs(c1.getY() - c2.getY()) == 1 &&\n+                                     c1.hasWordSet(ScrabbleWordDirection.HORIZONTAL) &&\n+                                     c2.hasWordSet(ScrabbleWordDirection.HORIZONTAL))\n+                 .penalize(\"No parallel horizontal neighbours\", HardMediumSoftScore.ONE_HARD);\n+    }\n+\n+    private Constraint noParallelVerticalNeighbours(ConstraintFactory cf) {\n+        return cf.fromUniquePair(ScrabbleCell.class)\n+                 .filter((c1, c2) -> c1.getY() == c2.getY() &&\n+                                     Math.abs(c1.getX() - c2.getX()) == 1 &&\n+                                     c1.hasWordSet(ScrabbleWordDirection.VERTICAL) &&\n+                                     c2.hasWordSet(ScrabbleWordDirection.VERTICAL))\n+                 .penalize(\"No parallel vertical neighbours\", HardMediumSoftScore.ONE_HARD);\n+    }", "originalCommit": "a415badc5a20f0bb9b1f1f091cb80a615ea4a4eb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f41070583c35bac44a83f6640697cb999814c8f1", "chunk": "diff --git a/optaplanner-examples/src/main/java/org/optaplanner/examples/scrabble/optional/score/ScrabbleConstraintProvider.java b/optaplanner-examples/src/main/java/org/optaplanner/examples/scrabble/optional/score/ScrabbleConstraintProvider.java\nindex 3c73b1d25..e6a9fc409 100644\n--- a/optaplanner-examples/src/main/java/org/optaplanner/examples/scrabble/optional/score/ScrabbleConstraintProvider.java\n+++ b/optaplanner-examples/src/main/java/org/optaplanner/examples/scrabble/optional/score/ScrabbleConstraintProvider.java\n\n@@ -5,7 +5,7 @@ import org.optaplanner.core.api.score.stream.Constraint;\n import org.optaplanner.core.api.score.stream.ConstraintCollectors;\n import org.optaplanner.core.api.score.stream.ConstraintFactory;\n import org.optaplanner.core.api.score.stream.ConstraintProvider;\n-import org.optaplanner.core.impl.score.stream.bi.FilteringBiJoiner;\n+import org.optaplanner.core.api.score.stream.Joiners;\n import org.optaplanner.examples.scrabble.domain.ScrabbleWordDirection;\n import org.optaplanner.examples.scrabble.domain.ScrabbleCell;\n import org.optaplanner.examples.scrabble.domain.ScrabbleWordAssignment;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI3NTg4MA==", "url": "https://github.com/kiegroup/optaplanner/pull/679#discussion_r377275880", "bodyText": "Please replace FilteringBiJoiner with Joiners.filtering(...).", "author": "triceo", "createdAt": "2020-02-10T19:41:52Z", "path": "optaplanner-examples/src/main/java/org/optaplanner/examples/scrabble/optional/score/ScrabbleConstraintProvider.java", "diffHunk": "@@ -0,0 +1,69 @@\n+package org.optaplanner.examples.scrabble.optional.score;\n+\n+import org.optaplanner.core.api.score.buildin.hardmediumsoft.HardMediumSoftScore;\n+import org.optaplanner.core.api.score.stream.Constraint;\n+import org.optaplanner.core.api.score.stream.ConstraintCollectors;\n+import org.optaplanner.core.api.score.stream.ConstraintFactory;\n+import org.optaplanner.core.api.score.stream.ConstraintProvider;\n+import org.optaplanner.core.impl.score.stream.bi.FilteringBiJoiner;\n+import org.optaplanner.examples.scrabble.domain.ScrabbleWordDirection;\n+import org.optaplanner.examples.scrabble.domain.ScrabbleCell;\n+import org.optaplanner.examples.scrabble.domain.ScrabbleWordAssignment;\n+\n+public class ScrabbleConstraintProvider implements ConstraintProvider {\n+\n+    @Override\n+    public Constraint[] defineConstraints(ConstraintFactory constraintFactory) {\n+        return new Constraint[]{\n+                                characterConflict(constraintFactory),\n+                                noParallelHorizontalNeighbours(constraintFactory),\n+                                noParallelVerticalNeighbours(constraintFactory),\n+                                outOfGrid(constraintFactory),\n+                                maximizeMergesPerWord(constraintFactory),\n+                                pullToCenter(constraintFactory)\n+        };\n+    }\n+\n+    private Constraint characterConflict(ConstraintFactory cf) {\n+        return cf.from(ScrabbleCell.class)\n+                 .filter(sc -> sc.getCharacterSet().size() >= 2)\n+                 .penalize(\"Character confict\", HardMediumSoftScore.ONE_HARD, sc -> 1 - sc.getCharacterSet().size());\n+    }\n+\n+    private Constraint noParallelHorizontalNeighbours(ConstraintFactory cf) {\n+        return cf.fromUniquePair(ScrabbleCell.class)\n+                 .filter((c1, c2) -> c1.getX() == c2.getX() &&\n+                                     Math.abs(c1.getY() - c2.getY()) == 1 &&\n+                                     c1.hasWordSet(ScrabbleWordDirection.HORIZONTAL) &&\n+                                     c2.hasWordSet(ScrabbleWordDirection.HORIZONTAL))\n+                 .penalize(\"No parallel horizontal neighbours\", HardMediumSoftScore.ONE_HARD);\n+    }\n+\n+    private Constraint noParallelVerticalNeighbours(ConstraintFactory cf) {\n+        return cf.fromUniquePair(ScrabbleCell.class)\n+                 .filter((c1, c2) -> c1.getY() == c2.getY() &&\n+                                     Math.abs(c1.getX() - c2.getX()) == 1 &&\n+                                     c1.hasWordSet(ScrabbleWordDirection.VERTICAL) &&\n+                                     c2.hasWordSet(ScrabbleWordDirection.VERTICAL))\n+                 .penalize(\"No parallel vertical neighbours\", HardMediumSoftScore.ONE_HARD);\n+    }\n+\n+    private Constraint outOfGrid(ConstraintFactory cf) {\n+        return cf.from(ScrabbleWordAssignment.class)\n+                 .filter(ScrabbleWordAssignment::isOutOfGrid)\n+                 .penalize(\"Out of grid\", HardMediumSoftScore.ONE_HARD, swa -> swa.getWord().length());\n+    }\n+\n+    private Constraint maximizeMergesPerWord(ConstraintFactory cf) {\n+        return cf.from(ScrabbleWordAssignment.class)\n+                 .join(ScrabbleCell.class, new FilteringBiJoiner<>((swa, sc) -> sc.getWordSet().contains(swa) && sc.hasMerge()))", "originalCommit": "a415badc5a20f0bb9b1f1f091cb80a615ea4a4eb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f41070583c35bac44a83f6640697cb999814c8f1", "chunk": "diff --git a/optaplanner-examples/src/main/java/org/optaplanner/examples/scrabble/optional/score/ScrabbleConstraintProvider.java b/optaplanner-examples/src/main/java/org/optaplanner/examples/scrabble/optional/score/ScrabbleConstraintProvider.java\nindex 3c73b1d25..e6a9fc409 100644\n--- a/optaplanner-examples/src/main/java/org/optaplanner/examples/scrabble/optional/score/ScrabbleConstraintProvider.java\n+++ b/optaplanner-examples/src/main/java/org/optaplanner/examples/scrabble/optional/score/ScrabbleConstraintProvider.java\n\n@@ -5,7 +5,7 @@ import org.optaplanner.core.api.score.stream.Constraint;\n import org.optaplanner.core.api.score.stream.ConstraintCollectors;\n import org.optaplanner.core.api.score.stream.ConstraintFactory;\n import org.optaplanner.core.api.score.stream.ConstraintProvider;\n-import org.optaplanner.core.impl.score.stream.bi.FilteringBiJoiner;\n+import org.optaplanner.core.api.score.stream.Joiners;\n import org.optaplanner.examples.scrabble.domain.ScrabbleWordDirection;\n import org.optaplanner.examples.scrabble.domain.ScrabbleCell;\n import org.optaplanner.examples.scrabble.domain.ScrabbleWordAssignment;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI4MTM3NQ==", "url": "https://github.com/kiegroup/optaplanner/pull/679#discussion_r377281375", "bodyText": "@Christopher-Chianelli  This is where the score corruption is going to be. DRL does this:\nscoreHolder.addHardConstraintMatch(kcontext, 1 - $size);\n\nSo the number will be 0 or less. But that is because in DRL, you need to input a negative number to penalize.\nIn CS, you have the penalize() call, and that expects a positive number.\nTherefore I think that if you invert the logic of the match weigher here, this score corruption will go away.", "author": "triceo", "createdAt": "2020-02-10T19:52:52Z", "path": "optaplanner-examples/src/main/java/org/optaplanner/examples/scrabble/optional/score/ScrabbleConstraintProvider.java", "diffHunk": "@@ -0,0 +1,69 @@\n+package org.optaplanner.examples.scrabble.optional.score;\n+\n+import org.optaplanner.core.api.score.buildin.hardmediumsoft.HardMediumSoftScore;\n+import org.optaplanner.core.api.score.stream.Constraint;\n+import org.optaplanner.core.api.score.stream.ConstraintCollectors;\n+import org.optaplanner.core.api.score.stream.ConstraintFactory;\n+import org.optaplanner.core.api.score.stream.ConstraintProvider;\n+import org.optaplanner.core.impl.score.stream.bi.FilteringBiJoiner;\n+import org.optaplanner.examples.scrabble.domain.ScrabbleWordDirection;\n+import org.optaplanner.examples.scrabble.domain.ScrabbleCell;\n+import org.optaplanner.examples.scrabble.domain.ScrabbleWordAssignment;\n+\n+public class ScrabbleConstraintProvider implements ConstraintProvider {\n+\n+    @Override\n+    public Constraint[] defineConstraints(ConstraintFactory constraintFactory) {\n+        return new Constraint[]{\n+                                characterConflict(constraintFactory),\n+                                noParallelHorizontalNeighbours(constraintFactory),\n+                                noParallelVerticalNeighbours(constraintFactory),\n+                                outOfGrid(constraintFactory),\n+                                maximizeMergesPerWord(constraintFactory),\n+                                pullToCenter(constraintFactory)\n+        };\n+    }\n+\n+    private Constraint characterConflict(ConstraintFactory cf) {\n+        return cf.from(ScrabbleCell.class)\n+                 .filter(sc -> sc.getCharacterSet().size() >= 2)\n+                 .penalize(\"Character confict\", HardMediumSoftScore.ONE_HARD, sc -> 1 - sc.getCharacterSet().size());", "originalCommit": "a415badc5a20f0bb9b1f1f091cb80a615ea4a4eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI5MzUwMA==", "url": "https://github.com/kiegroup/optaplanner/pull/679#discussion_r377293500", "bodyText": "Thanks for that; (although I still find it odd FAST_ASSERT didn't catch this) Suggestion for Constrant Stream: output a warning to the console whenever it see a penalize/reward with a negative number (if possible)", "author": "Christopher-Chianelli", "createdAt": "2020-02-10T20:18:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI4MTM3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzMwMjIxNg==", "url": "https://github.com/kiegroup/optaplanner/pull/679#discussion_r377302216", "bodyText": "There was another one: maximizeMergesPerWord was suppose to be a reward, not a penalty. But I got it working in FULL_ASSERT mode now.", "author": "Christopher-Chianelli", "createdAt": "2020-02-10T20:37:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI4MTM3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzMwMzUwNg==", "url": "https://github.com/kiegroup/optaplanner/pull/679#discussion_r377303506", "bodyText": "Please make it run like that for a couple minutes, sometimes the corruptions are hiding in less likely corners of the state space.\nWrt. the warning - I'll think about it. We generally don't do warnings in Optaplanner, but I'll consider if fail-fast would be a good idea here.", "author": "triceo", "createdAt": "2020-02-10T20:40:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI4MTM3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzMxNDUyMA==", "url": "https://github.com/kiegroup/optaplanner/pull/679#discussion_r377314520", "bodyText": "Error is probably better than a warning so users will immediately know something wrong instead of having to look at the logs to see why it not working correctly. Although that raises the question if someone has a constraint that can be positive or negative (Drools can do that since its reward function is also its penalize function).", "author": "Christopher-Chianelli", "createdAt": "2020-02-10T21:02:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI4MTM3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzMyODA3Nw==", "url": "https://github.com/kiegroup/optaplanner/pull/679#discussion_r377328077", "bodyText": "I ran it for 30 minutes; no Score Corruption was detected on FULL_ASSERT (manually terminated on Local Search step 1677)", "author": "Christopher-Chianelli", "createdAt": "2020-02-10T21:31:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI4MTM3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "f41070583c35bac44a83f6640697cb999814c8f1", "chunk": "diff --git a/optaplanner-examples/src/main/java/org/optaplanner/examples/scrabble/optional/score/ScrabbleConstraintProvider.java b/optaplanner-examples/src/main/java/org/optaplanner/examples/scrabble/optional/score/ScrabbleConstraintProvider.java\nindex 3c73b1d25..e6a9fc409 100644\n--- a/optaplanner-examples/src/main/java/org/optaplanner/examples/scrabble/optional/score/ScrabbleConstraintProvider.java\n+++ b/optaplanner-examples/src/main/java/org/optaplanner/examples/scrabble/optional/score/ScrabbleConstraintProvider.java\n\n@@ -5,7 +5,7 @@ import org.optaplanner.core.api.score.stream.Constraint;\n import org.optaplanner.core.api.score.stream.ConstraintCollectors;\n import org.optaplanner.core.api.score.stream.ConstraintFactory;\n import org.optaplanner.core.api.score.stream.ConstraintProvider;\n-import org.optaplanner.core.impl.score.stream.bi.FilteringBiJoiner;\n+import org.optaplanner.core.api.score.stream.Joiners;\n import org.optaplanner.examples.scrabble.domain.ScrabbleWordDirection;\n import org.optaplanner.examples.scrabble.domain.ScrabbleCell;\n import org.optaplanner.examples.scrabble.domain.ScrabbleWordAssignment;\n"}}, {"oid": "f41070583c35bac44a83f6640697cb999814c8f1", "url": "https://github.com/kiegroup/optaplanner/commit/f41070583c35bac44a83f6640697cb999814c8f1", "message": "Fix penalty for \"Character Conflict\" and reward for \"Maximize merges per word\"; optimize parallel constraints.", "committedDate": "2020-02-10T20:54:52Z", "type": "commit"}, {"oid": "8313e66887e52cc13e3e7cc461cb54e7cae6eb0d", "url": "https://github.com/kiegroup/optaplanner/commit/8313e66887e52cc13e3e7cc461cb54e7cae6eb0d", "message": "Use method reference instead of lambda in pullToCenter", "committedDate": "2020-02-10T21:39:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ4MDE2Mg==", "url": "https://github.com/kiegroup/optaplanner/pull/679#discussion_r377480162", "bodyText": "Looking at the code now, the join().filter() could be replaced by ifExists(...) with the appropriate joiners. The performance of that would likely be the best - only not sure if it would match 1:1 with what the DRL does. If FULL_ASSERT passes, I say let's do it.", "author": "triceo", "createdAt": "2020-02-11T07:47:37Z", "path": "optaplanner-examples/src/main/java/org/optaplanner/examples/scrabble/optional/score/ScrabbleConstraintProvider.java", "diffHunk": "@@ -0,0 +1,69 @@\n+package org.optaplanner.examples.scrabble.optional.score;\n+\n+import org.optaplanner.core.api.score.buildin.hardmediumsoft.HardMediumSoftScore;\n+import org.optaplanner.core.api.score.stream.Constraint;\n+import org.optaplanner.core.api.score.stream.ConstraintCollectors;\n+import org.optaplanner.core.api.score.stream.ConstraintFactory;\n+import org.optaplanner.core.api.score.stream.ConstraintProvider;\n+import org.optaplanner.core.api.score.stream.Joiners;\n+import org.optaplanner.examples.scrabble.domain.ScrabbleWordDirection;\n+import org.optaplanner.examples.scrabble.domain.ScrabbleCell;\n+import org.optaplanner.examples.scrabble.domain.ScrabbleWordAssignment;\n+\n+public class ScrabbleConstraintProvider implements ConstraintProvider {\n+\n+    @Override\n+    public Constraint[] defineConstraints(ConstraintFactory constraintFactory) {\n+        return new Constraint[]{\n+                                characterConflict(constraintFactory),\n+                                noParallelHorizontalNeighbours(constraintFactory),\n+                                noParallelVerticalNeighbours(constraintFactory),\n+                                outOfGrid(constraintFactory),\n+                                maximizeMergesPerWord(constraintFactory),\n+                                pullToCenter(constraintFactory)\n+        };\n+    }\n+\n+    private Constraint characterConflict(ConstraintFactory cf) {\n+        return cf.from(ScrabbleCell.class)\n+                 .filter(sc -> sc.getCharacterSet().size() >= 2)\n+                 .penalize(\"Character confict\", HardMediumSoftScore.ONE_HARD, sc -> sc.getCharacterSet().size() - 1);\n+    }\n+\n+    private Constraint noParallelHorizontalNeighbours(ConstraintFactory cf) {\n+        return cf.from(ScrabbleCell.class).filter(sc -> sc.hasWordSet(ScrabbleWordDirection.HORIZONTAL))\n+                 .join(ScrabbleCell.class,\n+                       Joiners.equal(ScrabbleCell::getX), Joiners.lessThan(ScrabbleCell::getId),\n+                       Joiners.filtering((first, other) -> other.hasWordSet(ScrabbleWordDirection.HORIZONTAL)))\n+                 .filter((c1, c2) -> Math.abs(c1.getY() - c2.getY()) == 1)\n+                 .penalize(\"No parallel horizontal neighbours\", HardMediumSoftScore.ONE_HARD);\n+    }\n+\n+    private Constraint noParallelVerticalNeighbours(ConstraintFactory cf) {\n+        return cf.from(ScrabbleCell.class).filter(sc -> sc.hasWordSet(ScrabbleWordDirection.VERTICAL))\n+                 .join(ScrabbleCell.class,\n+                       Joiners.equal(ScrabbleCell::getY), Joiners.lessThan(ScrabbleCell::getId),\n+                       Joiners.filtering((first, other) -> other.hasWordSet(ScrabbleWordDirection.VERTICAL)))\n+                 .filter((c1, c2) -> Math.abs(c1.getX() - c2.getX()) == 1)\n+                 .penalize(\"No parallel vertical neighbours\", HardMediumSoftScore.ONE_HARD);\n+    }", "originalCommit": "8313e66887e52cc13e3e7cc461cb54e7cae6eb0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM2Mjc4OA==", "url": "https://github.com/kiegroup/optaplanner/pull/679#discussion_r378362788", "bodyText": "I don't think they are the same. Consider this scenario:\nWO[R]D1\nWO[R]D2\nWO[R]D3\n\nWhere id([R] in WORD2) < id([R] in WORD1) < id([R] in WORD3).\nUsing the current method, the constraint matches are [([R] in WORD2, [R] in WORD1),([R] in WORD2, [R] in WORD3)].\nUsing the ifExists method, the constraint matches are [([R] in WORD2,[R] in WORD1|WORD2)] (there is only one constraint match, with the second element being in either WORD1 or WORD2). This situation is extremely rare, and probably take a long time to be explored. I ran 20 minutes on FULL_ASSERT using ifExists and got no errors so far, but I still think it not one-to-one.", "author": "Christopher-Chianelli", "createdAt": "2020-02-12T16:25:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ4MDE2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM2ODI5Ng==", "url": "https://github.com/kiegroup/optaplanner/pull/679#discussion_r378368296", "bodyText": "If (cell1.x < cell2.x -> cell1.id < cell2.id and cell1.y < cell2.y -> cell1.id < cell2.id) or (cell1.x > cell2.x -> cell1.id > cell2.id and cell1.y > cell2.y -> cell1.id > cell2.id), this could never happen (it requires an id discontinuity)", "author": "Christopher-Chianelli", "createdAt": "2020-02-12T16:33:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ4MDE2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM3ODExNw==", "url": "https://github.com/kiegroup/optaplanner/pull/679#discussion_r378378117", "bodyText": "From the importer:\n        private void readCellList() throws IOException {\n            int gridWidth = readIntegerValue(\"gridWidth:\");\n            solution.setGridWidth(gridWidth);\n            int gridHeight = readIntegerValue(\"gridHeight:\");\n            solution.setGridHeight(gridHeight);\n            List<ScrabbleCell> cellList = new ArrayList<>(gridWidth * gridHeight);\n            for (int x = 0; x < gridWidth; x++) {\n                for (int y = 0; y < gridHeight; y++) {\n                    ScrabbleCell cell = new ScrabbleCell();\n                    cell.setId((long) (y * gridWidth + x));\n                    cell.setX(x);\n                    cell.setY(y);\n                    cell.setWordSet(new LinkedHashSet<>());\n                    cell.setCharacterCountMap(new LinkedHashMap<>());\n                    cellList.add(cell);\n                }\n            }\n            solution.setCellList(cellList);\n        }\n\nIn particular: cell.setId((long) (y * gridWidth + x))\nDue to this, the corner case will never be hit, and the constraints are \"equivalent\".\n\"Proof\":\nAssume, for contradiction, there exists cells c1, c2, c3 such that c1.x = c2.x = c3.x and c1.hasWordSet(HORIZONTAL) and c2.hasWordSet(HORIZONTAL) and c3.hasWordSet(HORIZONTAL), with c1.y < c2.y < c3.y. From the id formula we can derive:\nc1.id \n= c1.y * W + x\n< c2.y * W + x\n= c2.id\n\nThus c1.id < c2.id. Similarly we have:\nc2.id\n= c2.y * W + x\n< c3.y * W + x\n= c3.id\n\nThus c2.id < c3.id and we have c1.id < c2.id < c3.id. This make \"double\" matches impossible, as they can only occur if a cell is between two cells with an id less than both of them, which we proved is not possible. QED.", "author": "Christopher-Chianelli", "createdAt": "2020-02-12T16:48:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ4MDE2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM4MTE4OQ==", "url": "https://github.com/kiegroup/optaplanner/pull/679#discussion_r378381189", "bodyText": "Side note: This proof also proves the filter can be simplified to c1.y == c2.y - 1.", "author": "Christopher-Chianelli", "createdAt": "2020-02-12T16:53:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ4MDE2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM4NDE5MQ==", "url": "https://github.com/kiegroup/optaplanner/pull/679#discussion_r378384191", "bodyText": "@triceo if Id generating code won't change and no one using Scrabble in production (with their own id generating code that might not have this property that cause the constraints to be equivalent), then I am okay changing it to ifExists.", "author": "Christopher-Chianelli", "createdAt": "2020-02-12T16:58:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ4MDE2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM5MjI3OQ==", "url": "https://github.com/kiegroup/optaplanner/pull/679#discussion_r378392279", "bodyText": "Looking at the Drools, they indeed use c1.x = c2.x and c2.y = c1.y + 1, meaning we can safety change this to an ifExists and remove the id joiner (which turn out was only changing Math.abs(c1.y - c2.y) = 1 to c2.y = c1.y + 1).", "author": "Christopher-Chianelli", "createdAt": "2020-02-12T17:12:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ4MDE2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM5NTk1MQ==", "url": "https://github.com/kiegroup/optaplanner/pull/679#discussion_r378395951", "bodyText": "(To bad there isn't a Joiners.fixed((first,second) -> boolean), since the cells x and y don't ever change, meaning we already know what cell we need to check for a particular cell and don't need to check all the cells in the same column)", "author": "Christopher-Chianelli", "createdAt": "2020-02-12T17:18:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ4MDE2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM5NjI0Mg==", "url": "https://github.com/kiegroup/optaplanner/pull/679#discussion_r378396242", "bodyText": "(fixed is basically a filtering that is only run once)", "author": "Christopher-Chianelli", "createdAt": "2020-02-12T17:18:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ4MDE2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM5ODQ4Mg==", "url": "https://github.com/kiegroup/optaplanner/pull/679#discussion_r378398482", "bodyText": "(wait, equals have an override that use two different functions; I can use that)", "author": "Christopher-Chianelli", "createdAt": "2020-02-12T17:22:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ4MDE2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQyMDQzOA==", "url": "https://github.com/kiegroup/optaplanner/pull/679#discussion_r378420438", "bodyText": "Well proven!", "author": "triceo", "createdAt": "2020-02-12T18:03:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ4MDE2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "3ff94274b96677ecf90f0a408c759b36e40475f0", "chunk": "diff --git a/optaplanner-examples/src/main/java/org/optaplanner/examples/scrabble/optional/score/ScrabbleConstraintProvider.java b/optaplanner-examples/src/main/java/org/optaplanner/examples/scrabble/optional/score/ScrabbleConstraintProvider.java\nindex a1058b6c7..f990ecc9d 100644\n--- a/optaplanner-examples/src/main/java/org/optaplanner/examples/scrabble/optional/score/ScrabbleConstraintProvider.java\n+++ b/optaplanner-examples/src/main/java/org/optaplanner/examples/scrabble/optional/score/ScrabbleConstraintProvider.java\n\n@@ -32,19 +32,17 @@ public class ScrabbleConstraintProvider implements ConstraintProvider {\n \n     private Constraint noParallelHorizontalNeighbours(ConstraintFactory cf) {\n         return cf.from(ScrabbleCell.class).filter(sc -> sc.hasWordSet(ScrabbleWordDirection.HORIZONTAL))\n-                 .join(ScrabbleCell.class,\n-                       Joiners.equal(ScrabbleCell::getX), Joiners.lessThan(ScrabbleCell::getId),\n-                       Joiners.filtering((first, other) -> other.hasWordSet(ScrabbleWordDirection.HORIZONTAL)))\n-                 .filter((c1, c2) -> Math.abs(c1.getY() - c2.getY()) == 1)\n+                 .ifExists(ScrabbleCell.class,\n+                           Joiners.equal(ScrabbleCell::getX), Joiners.equal(ScrabbleCell::getY, c -> c.getY() + 1),\n+                           Joiners.filtering((first, second) -> second.hasWordSet(ScrabbleWordDirection.HORIZONTAL)))\n                  .penalize(\"No parallel horizontal neighbours\", HardMediumSoftScore.ONE_HARD);\n     }\n \n     private Constraint noParallelVerticalNeighbours(ConstraintFactory cf) {\n         return cf.from(ScrabbleCell.class).filter(sc -> sc.hasWordSet(ScrabbleWordDirection.VERTICAL))\n-                 .join(ScrabbleCell.class,\n-                       Joiners.equal(ScrabbleCell::getY), Joiners.lessThan(ScrabbleCell::getId),\n-                       Joiners.filtering((first, other) -> other.hasWordSet(ScrabbleWordDirection.VERTICAL)))\n-                 .filter((c1, c2) -> Math.abs(c1.getX() - c2.getX()) == 1)\n+                 .ifExists(ScrabbleCell.class,\n+                           Joiners.equal(ScrabbleCell::getY), Joiners.equal(ScrabbleCell::getX, c -> c.getX() + 1),\n+                           Joiners.filtering((first, second) -> second.hasWordSet(ScrabbleWordDirection.VERTICAL)))\n                  .penalize(\"No parallel vertical neighbours\", HardMediumSoftScore.ONE_HARD);\n     }\n \n"}}, {"oid": "3ff94274b96677ecf90f0a408c759b36e40475f0", "url": "https://github.com/kiegroup/optaplanner/commit/3ff94274b96677ecf90f0a408c759b36e40475f0", "message": "Use ifExists for parallel constraints in Scrabble, use Drools in Solver config.", "committedDate": "2020-02-12T18:14:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ0NTA4OQ==", "url": "https://github.com/kiegroup/optaplanner/pull/679#discussion_r378445089", "bodyText": "One last thing, @Christopher-Chianelli, and then I'll merge: this isn't the proper code style, we don't do alignment on brackets. Please check the rest of the file as well, it's not the only place I see it.", "author": "triceo", "createdAt": "2020-02-12T18:51:15Z", "path": "optaplanner-examples/src/main/java/org/optaplanner/examples/scrabble/optional/score/ScrabbleConstraintProvider.java", "diffHunk": "@@ -0,0 +1,67 @@\n+package org.optaplanner.examples.scrabble.optional.score;\n+\n+import org.optaplanner.core.api.score.buildin.hardmediumsoft.HardMediumSoftScore;\n+import org.optaplanner.core.api.score.stream.Constraint;\n+import org.optaplanner.core.api.score.stream.ConstraintCollectors;\n+import org.optaplanner.core.api.score.stream.ConstraintFactory;\n+import org.optaplanner.core.api.score.stream.ConstraintProvider;\n+import org.optaplanner.core.api.score.stream.Joiners;\n+import org.optaplanner.examples.scrabble.domain.ScrabbleWordDirection;\n+import org.optaplanner.examples.scrabble.domain.ScrabbleCell;\n+import org.optaplanner.examples.scrabble.domain.ScrabbleWordAssignment;\n+\n+public class ScrabbleConstraintProvider implements ConstraintProvider {\n+\n+    @Override\n+    public Constraint[] defineConstraints(ConstraintFactory constraintFactory) {\n+        return new Constraint[]{\n+                                characterConflict(constraintFactory),\n+                                noParallelHorizontalNeighbours(constraintFactory),\n+                                noParallelVerticalNeighbours(constraintFactory),\n+                                outOfGrid(constraintFactory),\n+                                maximizeMergesPerWord(constraintFactory),\n+                                pullToCenter(constraintFactory)\n+        };", "originalCommit": "3ff94274b96677ecf90f0a408c759b36e40475f0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ4ODE4NQ==", "url": "https://github.com/kiegroup/optaplanner/pull/679#discussion_r378488185", "bodyText": "I use KIE Java Conventions in Eclipse. Fun fact: the IDEA KIE Java Formatter and Eclipse KIE Java Formatter disagrees in some places, and this is one of them. I remember I created a script once that ran Idea formatter for me from command line. Might be harder to do that now that I have IDEA in a flatpak....", "author": "Christopher-Chianelli", "createdAt": "2020-02-12T20:14:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ0NTA4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ5MDA0MQ==", "url": "https://github.com/kiegroup/optaplanner/pull/679#discussion_r378490041", "bodyText": "Dammit. :-( We should somehow get them in sync. I'll bring it up.\nIn the meantime - any chance you could configure yours to be the same as in IDEA? As far as I know, most of the team uses IntelliJ.", "author": "triceo", "createdAt": "2020-02-12T20:18:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ0NTA4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ5NTM1NA==", "url": "https://github.com/kiegroup/optaplanner/pull/679#discussion_r378495354", "bodyText": "They are fundamentally incompatible (IDEA's have more features than Eclipse). I will try running the IDEA's formatter in a container and package it as a program.", "author": "Christopher-Chianelli", "createdAt": "2020-02-12T20:29:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ0NTA4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU3NjM4NA==", "url": "https://github.com/kiegroup/optaplanner/pull/679#discussion_r379576384", "bodyText": "Done; managed to find out where format.sh is in the flatpak.", "author": "Christopher-Chianelli", "createdAt": "2020-02-14T18:20:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ0NTA4OQ=="}], "type": "inlineReview", "revised_code": {"commit": "db9f0c0043e59285030a2c7443fdff9eb94bf57f", "chunk": "diff --git a/optaplanner-examples/src/main/java/org/optaplanner/examples/scrabble/optional/score/ScrabbleConstraintProvider.java b/optaplanner-examples/src/main/java/org/optaplanner/examples/scrabble/optional/score/ScrabbleConstraintProvider.java\nindex f990ecc9d..ee5d89c65 100644\n--- a/optaplanner-examples/src/main/java/org/optaplanner/examples/scrabble/optional/score/ScrabbleConstraintProvider.java\n+++ b/optaplanner-examples/src/main/java/org/optaplanner/examples/scrabble/optional/score/ScrabbleConstraintProvider.java\n\n@@ -15,53 +15,52 @@ public class ScrabbleConstraintProvider implements ConstraintProvider {\n     @Override\n     public Constraint[] defineConstraints(ConstraintFactory constraintFactory) {\n         return new Constraint[]{\n-                                characterConflict(constraintFactory),\n-                                noParallelHorizontalNeighbours(constraintFactory),\n-                                noParallelVerticalNeighbours(constraintFactory),\n-                                outOfGrid(constraintFactory),\n-                                maximizeMergesPerWord(constraintFactory),\n-                                pullToCenter(constraintFactory)\n+                characterConflict(constraintFactory),\n+                noParallelHorizontalNeighbours(constraintFactory),\n+                noParallelVerticalNeighbours(constraintFactory),\n+                outOfGrid(constraintFactory),\n+                maximizeMergesPerWord(constraintFactory),\n+                pullToCenter(constraintFactory)\n         };\n     }\n \n     private Constraint characterConflict(ConstraintFactory cf) {\n         return cf.from(ScrabbleCell.class)\n-                 .filter(sc -> sc.getCharacterSet().size() >= 2)\n-                 .penalize(\"Character confict\", HardMediumSoftScore.ONE_HARD, sc -> sc.getCharacterSet().size() - 1);\n+                .filter(sc -> sc.getCharacterSet().size() >= 2)\n+                .penalize(\"Character confict\", HardMediumSoftScore.ONE_HARD, sc -> sc.getCharacterSet().size() - 1);\n     }\n \n     private Constraint noParallelHorizontalNeighbours(ConstraintFactory cf) {\n         return cf.from(ScrabbleCell.class).filter(sc -> sc.hasWordSet(ScrabbleWordDirection.HORIZONTAL))\n-                 .ifExists(ScrabbleCell.class,\n-                           Joiners.equal(ScrabbleCell::getX), Joiners.equal(ScrabbleCell::getY, c -> c.getY() + 1),\n-                           Joiners.filtering((first, second) -> second.hasWordSet(ScrabbleWordDirection.HORIZONTAL)))\n-                 .penalize(\"No parallel horizontal neighbours\", HardMediumSoftScore.ONE_HARD);\n+                .ifExists(ScrabbleCell.class,\n+                          Joiners.equal(ScrabbleCell::getX), Joiners.equal(ScrabbleCell::getY, c -> c.getY() + 1),\n+                          Joiners.filtering((first, second) -> second.hasWordSet(ScrabbleWordDirection.HORIZONTAL)))\n+                .penalize(\"No parallel horizontal neighbours\", HardMediumSoftScore.ONE_HARD);\n     }\n \n     private Constraint noParallelVerticalNeighbours(ConstraintFactory cf) {\n         return cf.from(ScrabbleCell.class).filter(sc -> sc.hasWordSet(ScrabbleWordDirection.VERTICAL))\n-                 .ifExists(ScrabbleCell.class,\n-                           Joiners.equal(ScrabbleCell::getY), Joiners.equal(ScrabbleCell::getX, c -> c.getX() + 1),\n-                           Joiners.filtering((first, second) -> second.hasWordSet(ScrabbleWordDirection.VERTICAL)))\n-                 .penalize(\"No parallel vertical neighbours\", HardMediumSoftScore.ONE_HARD);\n+                .ifExists(ScrabbleCell.class,\n+                          Joiners.equal(ScrabbleCell::getY), Joiners.equal(ScrabbleCell::getX, c -> c.getX() + 1),\n+                          Joiners.filtering((first, second) -> second.hasWordSet(ScrabbleWordDirection.VERTICAL)))\n+                .penalize(\"No parallel vertical neighbours\", HardMediumSoftScore.ONE_HARD);\n     }\n \n     private Constraint outOfGrid(ConstraintFactory cf) {\n         return cf.from(ScrabbleWordAssignment.class)\n-                 .filter(ScrabbleWordAssignment::isOutOfGrid)\n-                 .penalize(\"Out of grid\", HardMediumSoftScore.ONE_HARD, swa -> swa.getWord().length());\n+                .filter(ScrabbleWordAssignment::isOutOfGrid)\n+                .penalize(\"Out of grid\", HardMediumSoftScore.ONE_HARD, swa -> swa.getWord().length());\n     }\n \n     private Constraint maximizeMergesPerWord(ConstraintFactory cf) {\n         return cf.from(ScrabbleWordAssignment.class)\n-                 .join(ScrabbleCell.class, Joiners.filtering((swa, sc) -> sc.getWordSet().contains(swa) && sc.hasMerge()))\n-                 .groupBy((swa, sc) -> swa.getId(), ConstraintCollectors.countBi())\n-                 .reward(\"Maximize merges per word\", HardMediumSoftScore.ONE_MEDIUM, (id, count) -> count * count);\n+                .join(ScrabbleCell.class, Joiners.filtering((swa, sc) -> sc.getWordSet().contains(swa) && sc.hasMerge()))\n+                .groupBy((swa, sc) -> swa.getId(), ConstraintCollectors.countBi())\n+                .reward(\"Maximize merges per word\", HardMediumSoftScore.ONE_MEDIUM, (id, count) -> count * count);\n     }\n \n     private Constraint pullToCenter(ConstraintFactory cf) {\n         return cf.from(ScrabbleWordAssignment.class)\n-                 .penalize(\"Pull to the center\", HardMediumSoftScore.ONE_SOFT, ScrabbleWordAssignment::getDistanceToCenter);\n+                .penalize(\"Pull to the center\", HardMediumSoftScore.ONE_SOFT, ScrabbleWordAssignment::getDistanceToCenter);\n     }\n-\n }\n"}}, {"oid": "f2ffa9376f3e5eab49e8b1795e2bfce9eb37d290", "url": "https://github.com/kiegroup/optaplanner/commit/f2ffa9376f3e5eab49e8b1795e2bfce9eb37d290", "message": "Remove duplicate FULL_ASSERT line in Scrabble.", "committedDate": "2020-02-12T20:38:51Z", "type": "commit"}, {"oid": "db9f0c0043e59285030a2c7443fdff9eb94bf57f", "url": "https://github.com/kiegroup/optaplanner/commit/db9f0c0043e59285030a2c7443fdff9eb94bf57f", "message": "Make the Scrabble Constraint Provider code match the IDEA Formatter.", "committedDate": "2020-02-14T18:17:41Z", "type": "commit"}]}