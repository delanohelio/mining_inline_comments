{"pr_number": 718, "pr_title": "Make JaxbAdapter tests compatible on Windows machines", "pr_createdAt": "2020-03-12T16:36:53Z", "pr_url": "https://github.com/kiegroup/optaplanner/pull/718", "timeline": [{"oid": "406c22ea03fcca7dc20b479525614e9341e57fe7", "url": "https://github.com/kiegroup/optaplanner/commit/406c22ea03fcca7dc20b479525614e9341e57fe7", "message": "Make JaxbAdapter tests compatible on Windows machines", "committedDate": "2020-03-12T20:31:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc5MzA0MA==", "url": "https://github.com/kiegroup/optaplanner/pull/718#discussion_r393793040", "bodyText": "Proposal B)\nHow about we use \"\\r?\\n\" instead of \"\\n\"?\nProposal C) Why do we assert the formatting of the text? Is that needed?\nNormally \"\\s*\" includes all whitespace, including \\r and \\n.\nDoes this regex work for those 2 lines?\nregex = \"\\\\{\\\\s*\\\"([\\\\w]+)\\\"\\\\s:\\\\s\\\\{\"\n + ...", "author": "ge0ffrey", "createdAt": "2020-03-17T16:06:10Z", "path": "optaplanner-persistence/optaplanner-persistence-jaxb/src/test/java/org/optaplanner/persistence/jaxb/api/score/AbstractScoreJaxbXmlAdapterTest.java", "diffHunk": "@@ -103,22 +106,25 @@\n             throw new IllegalStateException(\"Marshalling or unmarshalling for input (\" + input + \") failed.\", e);\n         }\n         assertEquals(expectedScore, output.getScore());\n+\n+        String newLine = System.lineSeparator();\n         String regex;\n         if (expectedScore != null) {\n-            regex = \"\\\\{\\n\" // Opening bracket", "originalCommit": "406c22ea03fcca7dc20b479525614e9341e57fe7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc5NDkwNA==", "url": "https://github.com/kiegroup/optaplanner/pull/718#discussion_r393794904", "bodyText": "If C) works, can we go with that? I don't think we need to test for formatting.\n\"\\s*\" (which is escaped written as \"\\s*\"), means 0 or more whitespace characters.", "author": "ge0ffrey", "createdAt": "2020-03-17T16:08:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc5MzA0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc5NTU1Ng==", "url": "https://github.com/kiegroup/optaplanner/pull/718#discussion_r393795556", "bodyText": "Or Proposal D): The official Java regex for newline since Java 8: \"\\R\" (https://docs.oracle.com/javase/8/docs/api/java/util/regex/Pattern.html#lineending)", "author": "Christopher-Chianelli", "createdAt": "2020-03-17T16:09:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc5MzA0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgwMzAzNA==", "url": "https://github.com/kiegroup/optaplanner/pull/718#discussion_r393803034", "bodyText": "Wouldn't using jackson ObjectMapper (or similar) make sense here? We don't really care about how the JSON looks like, just that the JSON has certain fields/properties (which we can check via ObjectMapper:\nJsonNode parent= new ObjectMapper().readTree(json);\nString score = parent.get(\"score\").asText();", "author": "Christopher-Chianelli", "createdAt": "2020-03-17T16:20:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc5MzA0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkwMjM3OQ==", "url": "https://github.com/kiegroup/optaplanner/pull/718#discussion_r393902379", "bodyText": "+1 to using \\R for Java regex. What would we use for new line characters in the error messages?\n-1 to using ObjectMapper, I don't think we should introduce Jackson dependencies since this code deals with the JAXB JSON standard. We do use ObjectMapper in the optaplanner-persistence-jackson module. If we do decide to use it, it's outside the scope of this PR.", "author": "cuijulian", "createdAt": "2020-03-17T18:56:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc5MzA0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkwNTU1Nw==", "url": "https://github.com/kiegroup/optaplanner/pull/718#discussion_r393905557", "bodyText": "String.format(...) is a thing, and use \"%n\" (https://dzone.com/articles/java-string-format-examples) (note it varargs are not type safe, it basically sprintf).\nHow about using JAXBContext to create a new unmarshaller to read the json?", "author": "Christopher-Chianelli", "createdAt": "2020-03-17T19:02:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc5MzA0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk4MTUwOA==", "url": "https://github.com/kiegroup/optaplanner/pull/718#discussion_r393981508", "bodyText": "%n looks reasonable. Let's see if we can get consensus on which newline char to use. As for the rest, a bit of scope creep here, the purpose of this PR was to fix the broken Windows tests. We can address how we assert the Json output in a separate PR.", "author": "cuijulian", "createdAt": "2020-03-17T21:28:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc5MzA0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDczMDI4OQ==", "url": "https://github.com/kiegroup/optaplanner/pull/718#discussion_r400730289", "bodyText": "The JSON format is whitespace (and therefore newline) agnostic. Whether one puts newlines and 4 space indents into a JSON file is a matter of taste (= code style).\nWe need to test if it's formatted as JSON.\nDo we need to test if the JSON \"code style\" is adhered too? I am not sure. If we don't, then we can just put \\\\s*, this will match all and any whitespacing (including linefeed and newline characters). If we do want to test it, then this is fine.\nEither way, +1 to merge.", "author": "ge0ffrey", "createdAt": "2020-03-31T08:25:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc5MzA0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDkxMTk3Nw==", "url": "https://github.com/kiegroup/optaplanner/pull/718#discussion_r400911977", "bodyText": "Hmm, good points. I don't see why we shouldn't test for JSON code style. If anything it's a more strict test, so I am in favour of keeping it. Are there any examples where testing for \"style\" rather than just \"format\" is not a good choice?", "author": "cuijulian", "createdAt": "2020-03-31T13:27:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc5MzA0MA=="}], "type": "inlineReview", "revised_code": {"commit": "56c9783768642e55bb2caff51137c55770674f7d", "chunk": "diff --git a/optaplanner-persistence/optaplanner-persistence-jaxb/src/test/java/org/optaplanner/persistence/jaxb/api/score/AbstractScoreJaxbXmlAdapterTest.java b/optaplanner-persistence/optaplanner-persistence-jaxb/src/test/java/org/optaplanner/persistence/jaxb/api/score/AbstractScoreJaxbXmlAdapterTest.java\nindex e95c4ffe0..3da2482b5 100644\n--- a/optaplanner-persistence/optaplanner-persistence-jaxb/src/test/java/org/optaplanner/persistence/jaxb/api/score/AbstractScoreJaxbXmlAdapterTest.java\n+++ b/optaplanner-persistence/optaplanner-persistence-jaxb/src/test/java/org/optaplanner/persistence/jaxb/api/score/AbstractScoreJaxbXmlAdapterTest.java\n\n@@ -106,25 +104,23 @@ public abstract class AbstractScoreJaxbXmlAdapterTest {\n             throw new IllegalStateException(\"Marshalling or unmarshalling for input (\" + input + \") failed.\", e);\n         }\n         assertEquals(expectedScore, output.getScore());\n-\n-        String newLine = System.lineSeparator();\n         String regex;\n         if (expectedScore != null) {\n-            regex = \"\\\\{\" + newLine // Opening bracket\n-                    + \"\\\\s*\\\"([\\\\w]+)\\\"\\\\s:\\\\s\\\\{\" + newLine // Start of element\n+            regex = \"\\\\{\\\\R\" // Opening bracket\n+                    + \"\\\\s*\\\"([\\\\w]+)\\\"\\\\s:\\\\s\\\\{\\\\R\" // Start of element\n                     + \"\\\\s*\\\"score\\\"\\\\s:\\\\s\\\"\" // Start of element\n                     + expectedScore.toString().replaceAll(\"\\\\[\", \"\\\\\\\\[\").replaceAll(\"\\\\]\", \"\\\\\\\\]\") // Score\n-                    + \"\\\"\\\\s*\\\\}\" + newLine // End of element\n+                    + \"\\\"\\\\s*\\\\}\\\\R\" // End of element\n                     + \"\\\\}\"; // Closing bracket\n         } else {\n-            regex = \"\\\\{\" + newLine // Opening bracket\n-                    + \"\\\\s*\\\"([\\\\w]+)\\\"\\\\s:\\\\s\\\\{\" + newLine // Start of element\n-                    + \"\\\\s*\\\\}\" + newLine // End of element\n+            regex = \"\\\\{\\\\R\" // Opening bracket\n+                    + \"\\\\s*\\\"([\\\\w]+)\\\"\\\\s:\\\\s\\\\{\\\\R\" // Start of element\n+                    + \"\\\\s*\\\\}\\\\R\" // End of element\n                     + \"\\\\}\"; // Closing bracket\n         }\n         if (!jsonString.matches(regex)) {\n-            fail(\"Regular expression match failed.\" + newLine + \"Expected regular expression: \" + regex + newLine +\n-                 \"Actual string: \" + jsonString);\n+            fail(String.format(\"Regular expression match failed.%nExpected regular expression: \" + regex +\n+                                       \"%nActual string: \" + jsonString));\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc5Mzg1NQ==", "url": "https://github.com/kiegroup/optaplanner/pull/718#discussion_r393793855", "bodyText": "Using System.lineSeperator() makes me cringe. Can't remember/motivate why though... For some reason, it's taboo.", "author": "ge0ffrey", "createdAt": "2020-03-17T16:07:11Z", "path": "optaplanner-persistence/optaplanner-persistence-jaxb/src/test/java/org/optaplanner/persistence/jaxb/api/score/AbstractScoreJaxbXmlAdapterTest.java", "diffHunk": "@@ -103,22 +106,25 @@\n             throw new IllegalStateException(\"Marshalling or unmarshalling for input (\" + input + \") failed.\", e);\n         }\n         assertEquals(expectedScore, output.getScore());\n+\n+        String newLine = System.lineSeparator();", "originalCommit": "406c22ea03fcca7dc20b479525614e9341e57fe7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg0NzE1MQ==", "url": "https://github.com/kiegroup/optaplanner/pull/718#discussion_r393847151", "bodyText": "I haven't found anything wrong about it. Even OpenJDK seems to be switching to it:\nhttps://bugs.openjdk.java.net/browse/JDK-8198645", "author": "rsynek", "createdAt": "2020-03-17T17:25:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc5Mzg1NQ=="}], "type": "inlineReview", "revised_code": {"commit": "56c9783768642e55bb2caff51137c55770674f7d", "chunk": "diff --git a/optaplanner-persistence/optaplanner-persistence-jaxb/src/test/java/org/optaplanner/persistence/jaxb/api/score/AbstractScoreJaxbXmlAdapterTest.java b/optaplanner-persistence/optaplanner-persistence-jaxb/src/test/java/org/optaplanner/persistence/jaxb/api/score/AbstractScoreJaxbXmlAdapterTest.java\nindex e95c4ffe0..3da2482b5 100644\n--- a/optaplanner-persistence/optaplanner-persistence-jaxb/src/test/java/org/optaplanner/persistence/jaxb/api/score/AbstractScoreJaxbXmlAdapterTest.java\n+++ b/optaplanner-persistence/optaplanner-persistence-jaxb/src/test/java/org/optaplanner/persistence/jaxb/api/score/AbstractScoreJaxbXmlAdapterTest.java\n\n@@ -106,25 +104,23 @@ public abstract class AbstractScoreJaxbXmlAdapterTest {\n             throw new IllegalStateException(\"Marshalling or unmarshalling for input (\" + input + \") failed.\", e);\n         }\n         assertEquals(expectedScore, output.getScore());\n-\n-        String newLine = System.lineSeparator();\n         String regex;\n         if (expectedScore != null) {\n-            regex = \"\\\\{\" + newLine // Opening bracket\n-                    + \"\\\\s*\\\"([\\\\w]+)\\\"\\\\s:\\\\s\\\\{\" + newLine // Start of element\n+            regex = \"\\\\{\\\\R\" // Opening bracket\n+                    + \"\\\\s*\\\"([\\\\w]+)\\\"\\\\s:\\\\s\\\\{\\\\R\" // Start of element\n                     + \"\\\\s*\\\"score\\\"\\\\s:\\\\s\\\"\" // Start of element\n                     + expectedScore.toString().replaceAll(\"\\\\[\", \"\\\\\\\\[\").replaceAll(\"\\\\]\", \"\\\\\\\\]\") // Score\n-                    + \"\\\"\\\\s*\\\\}\" + newLine // End of element\n+                    + \"\\\"\\\\s*\\\\}\\\\R\" // End of element\n                     + \"\\\\}\"; // Closing bracket\n         } else {\n-            regex = \"\\\\{\" + newLine // Opening bracket\n-                    + \"\\\\s*\\\"([\\\\w]+)\\\"\\\\s:\\\\s\\\\{\" + newLine // Start of element\n-                    + \"\\\\s*\\\\}\" + newLine // End of element\n+            regex = \"\\\\{\\\\R\" // Opening bracket\n+                    + \"\\\\s*\\\"([\\\\w]+)\\\"\\\\s:\\\\s\\\\{\\\\R\" // Start of element\n+                    + \"\\\\s*\\\\}\\\\R\" // End of element\n                     + \"\\\\}\"; // Closing bracket\n         }\n         if (!jsonString.matches(regex)) {\n-            fail(\"Regular expression match failed.\" + newLine + \"Expected regular expression: \" + regex + newLine +\n-                 \"Actual string: \" + jsonString);\n+            fail(String.format(\"Regular expression match failed.%nExpected regular expression: \" + regex +\n+                                       \"%nActual string: \" + jsonString));\n         }\n     }\n \n"}}, {"oid": "56c9783768642e55bb2caff51137c55770674f7d", "url": "https://github.com/kiegroup/optaplanner/commit/56c9783768642e55bb2caff51137c55770674f7d", "message": "Make JaxbAdapter tests compatible on Windows machines", "committedDate": "2020-03-30T13:45:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDcyMzQzNw==", "url": "https://github.com/kiegroup/optaplanner/pull/718#discussion_r400723437", "bodyText": "If you use format, don't use concatenate +: format(\"... Expected regular expression (%s) ...\", regex)", "author": "ge0ffrey", "createdAt": "2020-03-31T08:14:22Z", "path": "optaplanner-persistence/optaplanner-persistence-jaxb/src/test/java/org/optaplanner/persistence/jaxb/api/score/AbstractScoreJaxbXmlAdapterTest.java", "diffHunk": "@@ -71,7 +71,8 @@\n                     + \"<([\\\\w\\\\-\\\\.]+)/>\"; // Start and end of element\n         }\n         if (!xmlString.matches(regex)) {\n-            fail(\"Regular expression match failed.\\nExpected regular expression: \" + regex + \"\\nActual string: \" + xmlString);\n+            fail(String.format(\"Regular expression match failed.%nExpected regular expression: \" + regex +\n+                                       \"%nActual string: \" + xmlString));", "originalCommit": "56c9783768642e55bb2caff51137c55770674f7d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "dfb93ba35d8a46182f34b2fab40df41adfcbb4e9", "chunk": "diff --git a/optaplanner-persistence/optaplanner-persistence-jaxb/src/test/java/org/optaplanner/persistence/jaxb/api/score/AbstractScoreJaxbXmlAdapterTest.java b/optaplanner-persistence/optaplanner-persistence-jaxb/src/test/java/org/optaplanner/persistence/jaxb/api/score/AbstractScoreJaxbXmlAdapterTest.java\nindex 3da2482b5..5be622dfe 100644\n--- a/optaplanner-persistence/optaplanner-persistence-jaxb/src/test/java/org/optaplanner/persistence/jaxb/api/score/AbstractScoreJaxbXmlAdapterTest.java\n+++ b/optaplanner-persistence/optaplanner-persistence-jaxb/src/test/java/org/optaplanner/persistence/jaxb/api/score/AbstractScoreJaxbXmlAdapterTest.java\n\n@@ -71,8 +71,8 @@ public abstract class AbstractScoreJaxbXmlAdapterTest {\n                     + \"<([\\\\w\\\\-\\\\.]+)/>\"; // Start and end of element\n         }\n         if (!xmlString.matches(regex)) {\n-            fail(String.format(\"Regular expression match failed.%nExpected regular expression: \" + regex +\n-                                       \"%nActual string: \" + xmlString));\n+            fail(String.format(\"Regular expression match failed.%nExpected regular expression: %s%n\" +\n+                                       \"Actual string: %s\", regex, xmlString));\n         }\n     }\n \n"}}, {"oid": "dfb93ba35d8a46182f34b2fab40df41adfcbb4e9", "url": "https://github.com/kiegroup/optaplanner/commit/dfb93ba35d8a46182f34b2fab40df41adfcbb4e9", "message": "Make JaxbAdapter tests compatible on Windows machines", "committedDate": "2020-03-31T13:29:59Z", "type": "commit"}, {"oid": "dfb93ba35d8a46182f34b2fab40df41adfcbb4e9", "url": "https://github.com/kiegroup/optaplanner/commit/dfb93ba35d8a46182f34b2fab40df41adfcbb4e9", "message": "Make JaxbAdapter tests compatible on Windows machines", "committedDate": "2020-03-31T13:29:59Z", "type": "forcePushed"}]}