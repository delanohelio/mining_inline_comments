{"pr_number": 1804, "pr_title": "IBM FHIR Server audit does not log bundles correctly. #1803", "pr_createdAt": "2020-12-07T15:38:15Z", "pr_url": "https://github.com/IBM/FHIR/pull/1804", "timeline": [{"oid": "6d00e2c8ec412072a34b0ff59a9370992593832f", "url": "https://github.com/IBM/FHIR/commit/6d00e2c8ec412072a34b0ff59a9370992593832f", "message": "IBM FHIR Server audit does not log bundles correctly. #1803\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-12-07T15:36:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYyMTUzNA==", "url": "https://github.com/IBM/FHIR/pull/1804#discussion_r537621534", "bodyText": "I know it's not part of the change, but is this the best way to get the name of the host? Do we ensure that HOSTNAME is part of the environment?  On Windows, COMPUTERNAME might be more appropriate. Let me know if you think we need a ticket for this.", "author": "punktilious", "createdAt": "2020-12-07T15:59:57Z", "path": "fhir-audit/src/main/java/com/ibm/fhir/audit/logging/impl/WhcAuditCadfLogService.java", "diffHunk": "@@ -82,7 +82,7 @@\n     private static CadfResource observerRsrc =\n             new CadfResource.Builder(\"fhir-server\", ResourceType.compute_node)\n                             .geolocation(new CadfGeolocation.Builder(geoCity, geoState, geoCountry, null).build())\n-                            .name(\"Fhir Audit\")\n+                            .name(\"IBM FHIR Server - Audit\")\n                             .host(System.getenv(\"HOSTNAME\"))", "originalCommit": "6d00e2c8ec412072a34b0ff59a9370992593832f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYyODk4NA==", "url": "https://github.com/IBM/FHIR/pull/1804#discussion_r537628984", "bodyText": "Good point, I don't think it's super reliable. I think a ticket isn't bad, probably lower priority.", "author": "prb112", "createdAt": "2020-12-07T16:09:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYyMTUzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY1MjkwOQ==", "url": "https://github.com/IBM/FHIR/pull/1804#discussion_r537652909", "bodyText": "Thanks", "author": "prb112", "createdAt": "2020-12-07T16:40:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYyMTUzNA=="}], "type": "inlineReview", "revised_code": {"commit": "f2814bf66b821939d42e92031358cc0f5ffbb413", "chunk": "diff --git a/fhir-audit/src/main/java/com/ibm/fhir/audit/logging/impl/WhcAuditCadfLogService.java b/fhir-audit/src/main/java/com/ibm/fhir/audit/logging/impl/WhcAuditCadfLogService.java\nindex 154c6b9582..95b09b5b83 100644\n--- a/fhir-audit/src/main/java/com/ibm/fhir/audit/logging/impl/WhcAuditCadfLogService.java\n+++ b/fhir-audit/src/main/java/com/ibm/fhir/audit/logging/impl/WhcAuditCadfLogService.java\n\n@@ -78,6 +82,16 @@ public class WhcAuditCadfLogService implements AuditLogService {\n         }\n     };\n \n+    /*\n+     * creates an internal map of ignored Event Types.\n+     */\n+    private static Set<String> createIgnoredLogEventType() {\n+        Set<String> set = new HashSet<>();\n+        set.add(AuditLogEventType.FHIR_CONFIGDATA.value());\n+        set.add(AuditLogEventType.FHIR_METADATA.value());\n+        return set;\n+    }\n+\n     // Initialize CADF OBSERVER resource object once\n     private static CadfResource observerRsrc =\n             new CadfResource.Builder(\"fhir-server\", ResourceType.compute_node)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYyMzM0Mg==", "url": "https://github.com/IBM/FHIR/pull/1804#discussion_r537623342", "bodyText": "String != String. Shouldn't this use !equals(...)?", "author": "punktilious", "createdAt": "2020-12-07T16:02:13Z", "path": "fhir-audit/src/main/java/com/ibm/fhir/audit/logging/impl/WhcAuditCadfLogService.java", "diffHunk": "@@ -197,8 +196,10 @@ public static CadfEvent createCadfEvent(AuditLogEntry logEntry)\n         Outcome cadfEventOutCome;\n \n         // Cadf does't log config, so skip\n-        if ((logEntry.getEventType() != AuditLogEventType.FHIR_CONFIGDATA.value()) && logEntry.getContext() != null\n-                && logEntry.getContext().getAction() != null && logEntry.getContext().getApiParameters() != null) {\n+        if ((logEntry.getEventType() != AuditLogEventType.FHIR_CONFIGDATA.value())", "originalCommit": "6d00e2c8ec412072a34b0ff59a9370992593832f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY0NjE2MQ==", "url": "https://github.com/IBM/FHIR/pull/1804#discussion_r537646161", "bodyText": "Cleaned this up by addressing Lee's well-known request", "author": "prb112", "createdAt": "2020-12-07T16:31:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYyMzM0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "f2814bf66b821939d42e92031358cc0f5ffbb413", "chunk": "diff --git a/fhir-audit/src/main/java/com/ibm/fhir/audit/logging/impl/WhcAuditCadfLogService.java b/fhir-audit/src/main/java/com/ibm/fhir/audit/logging/impl/WhcAuditCadfLogService.java\nindex 154c6b9582..95b09b5b83 100644\n--- a/fhir-audit/src/main/java/com/ibm/fhir/audit/logging/impl/WhcAuditCadfLogService.java\n+++ b/fhir-audit/src/main/java/com/ibm/fhir/audit/logging/impl/WhcAuditCadfLogService.java\n\n@@ -195,8 +209,8 @@ public class WhcAuditCadfLogService implements AuditLogService {\n         CadfEvent event = null;\n         Outcome cadfEventOutCome;\n \n-        // Cadf does't log config, so skip\n-        if ((logEntry.getEventType() != AuditLogEventType.FHIR_CONFIGDATA.value())\n+        // For CADF we don't log specific event types.\n+        if ( !IGNORED_AUDIT_EVENT_TYPE.contains(logEntry.getEventType())\n                 && logEntry.getContext() != null\n                 && logEntry.getContext().getAction() != null\n                 && logEntry.getContext().getApiParameters() != null) {\n"}}, {"oid": "f2814bf66b821939d42e92031358cc0f5ffbb413", "url": "https://github.com/IBM/FHIR/commit/f2814bf66b821939d42e92031358cc0f5ffbb413", "message": "fix: per code review changed the compare, and added an additional ignore\nfor the metadata endpoints\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-12-07T16:30:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY0ODQ1Mg==", "url": "https://github.com/IBM/FHIR/pull/1804#discussion_r537648452", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // Skip over the actual logging, int his case, we're deciding by default\n          \n          \n            \n                    // Skip over the actual logging, in this case, we're deciding by default", "author": "lmsurpre", "createdAt": "2020-12-07T16:34:09Z", "path": "fhir-server/src/main/java/com/ibm/fhir/server/util/RestAuditLogger.java", "diffHunk": "@@ -311,6 +313,21 @@ public static void logBundle(HttpServletRequest request, Bundle bundle, Date sta\n                 .resourcesUpdated(updateCount).build());\n         entry.setDescription(\"FHIR Bundle request\");\n \n+        // Previously we didn't set the Action which caused the logEntry to\n+        // Skip over the actual logging, int his case, we're deciding by default", "originalCommit": "f2814bf66b821939d42e92031358cc0f5ffbb413", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "05602f9306bf2979527649719b02de25e1b2ba4f", "chunk": "diff --git a/fhir-server/src/main/java/com/ibm/fhir/server/util/RestAuditLogger.java b/fhir-server/src/main/java/com/ibm/fhir/server/util/RestAuditLogger.java\nindex 35d08535c8..e64d3d2e41 100644\n--- a/fhir-server/src/main/java/com/ibm/fhir/server/util/RestAuditLogger.java\n+++ b/fhir-server/src/main/java/com/ibm/fhir/server/util/RestAuditLogger.java\n\n@@ -314,7 +314,7 @@ public class RestAuditLogger {\n         entry.setDescription(\"FHIR Bundle request\");\n \n         // Previously we didn't set the Action which caused the logEntry to\n-        // Skip over the actual logging, int his case, we're deciding by default\n+        // Skip over the actual logging, in this case, we're deciding by default\n         // Read, if Create, it'll dominate, Update if no create and more than one\n         // Update action.\n         String action = \"R\";\n"}}, {"oid": "05602f9306bf2979527649719b02de25e1b2ba4f", "url": "https://github.com/IBM/FHIR/commit/05602f9306bf2979527649719b02de25e1b2ba4f", "message": "Update fhir-server/src/main/java/com/ibm/fhir/server/util/RestAuditLogger.java\r\n\r\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>\n\nCo-authored-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-12-07T16:39:54Z", "type": "commit"}]}