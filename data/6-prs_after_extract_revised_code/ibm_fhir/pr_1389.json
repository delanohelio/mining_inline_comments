{"pr_number": 1389, "pr_title": "Resolves Search Issues #1383 #1384 #1388", "pr_createdAt": "2020-07-30T16:35:38Z", "pr_url": "https://github.com/IBM/FHIR/pull/1389", "timeline": [{"oid": "06fb2d5af63ad790146bf69ef3ff91281f8ed9e3", "url": "https://github.com/IBM/FHIR/commit/06fb2d5af63ad790146bf69ef3ff91281f8ed9e3", "message": "refactor: Values Table have duplicate data for _id and _lastUpdated\n#1388\n\n- FHIRPersistenceJDBCImpl filters the codes in the\nextractParameterValues step and keeps the parameter values from hitting\nthe corresponding tables\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-07-30T16:33:25Z", "type": "commit"}, {"oid": "08ae7e050842506214d1a175ad16e79d47d584e1", "url": "https://github.com/IBM/FHIR/commit/08ae7e050842506214d1a175ad16e79d47d584e1", "message": "fix: Chained Search with _id result in Http Status 500 #1384\n\n- Add a branch for _id to be called/used off of the chained reference\ntable\n- Clean up QuerySegment Aggregator for _id\n- Removed unused imports from persistence-jdbc\n- Take out the deprecated API call in AbstractSearchIdAndLastUpdatedTest\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-07-30T23:37:22Z", "type": "commit"}, {"oid": "1c874c306cef3fac95029075f86fc3dd44d9b9c0", "url": "https://github.com/IBM/FHIR/commit/1c874c306cef3fac95029075f86fc3dd44d9b9c0", "message": "fix: Whole system search with multiple _lastUpdated results in incorrect\nqueries #1383\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-07-31T00:28:53Z", "type": "commit"}, {"oid": "0d2ec598d930039484b17f77bed126c7c17508c5", "url": "https://github.com/IBM/FHIR/commit/0d2ec598d930039484b17f77bed126c7c17508c5", "message": "fix: Whole system search with multiple _lastUpdated results in incorrect\nqueries #1383\n\n- Tone down logging in SearchChainTest\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-07-31T13:32:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzgxODM1MQ==", "url": "https://github.com/IBM/FHIR/pull/1389#discussion_r463818351", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // An important step here is to add _id, values table bind variables, and then and _lastUpdated\n          \n          \n            \n                        // An important step here is to add _id, values table bind variables, and then _lastUpdated", "author": "lmsurpre", "createdAt": "2020-07-31T20:24:03Z", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/QuerySegmentAggregator.java", "diffHunk": "@@ -196,15 +196,16 @@ protected SqlQueryData buildQuery() throws Exception {\n             queryString.append(\"     R.LOGICAL_RESOURCE_ID = LR.LOGICAL_RESOURCE_ID \");\n             queryString.append(\" AND R.RESOURCE_ID = LR.CURRENT_RESOURCE_ID \");\n             queryString.append(\" AND R.IS_DELETED <> 'Y'\");\n-            \n \n-            // Bind Variables\n+\n+            // An important step here is to add _id, values table bind variables, and then and _lastUpdated", "originalCommit": "0d2ec598d930039484b17f77bed126c7c17508c5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "46036803588c76b306700cff91b1ba82777d6a9d", "chunk": "diff --git a/fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/QuerySegmentAggregator.java b/fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/QuerySegmentAggregator.java\nindex 0a714c6d3f..52615618a7 100644\n--- a/fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/QuerySegmentAggregator.java\n+++ b/fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/QuerySegmentAggregator.java\n\n@@ -198,14 +198,13 @@ public class QuerySegmentAggregator {\n             queryString.append(\" AND R.IS_DELETED <> 'Y'\");\n \n \n-            // An important step here is to add _id, values table bind variables, and then and _lastUpdated\n+            // An important step here is to add _id, _lastUpdated, and then values table bind variables\n             List<Object> allBindVariables = new ArrayList<>();\n             allBindVariables.addAll(idsObjects);\n-\n+            allBindVariables.addAll(lastUpdatedObjects);\n             for (SqlQueryData querySegment : this.querySegments) {\n                 allBindVariables.addAll(querySegment.getBindVariables());\n             }\n-            allBindVariables.addAll(lastUpdatedObjects);\n \n             // Add default ordering\n             queryString.append(DEFAULT_ORDERING);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzgxODUwMw==", "url": "https://github.com/IBM/FHIR/pull/1389#discussion_r463818503", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // An important step here is to add _id, values table bind variables, and then and _lastUpdated\n          \n          \n            \n                        // An important step here is to add _id, values table bind variables, and then _lastUpdated", "author": "lmsurpre", "createdAt": "2020-07-31T20:24:27Z", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/QuerySegmentAggregator.java", "diffHunk": "@@ -267,13 +268,14 @@ protected SqlQueryData buildCountQuery() throws Exception {\n             buildFromClause(queryString, simpleName);\n             buildWhereClause(queryString, null);\n \n-            // An important step here is to add _id then all other values. \n+            // An important step here is to add _id, values table bind variables, and then and _lastUpdated", "originalCommit": "0d2ec598d930039484b17f77bed126c7c17508c5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "46036803588c76b306700cff91b1ba82777d6a9d", "chunk": "diff --git a/fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/QuerySegmentAggregator.java b/fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/QuerySegmentAggregator.java\nindex 0a714c6d3f..52615618a7 100644\n--- a/fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/QuerySegmentAggregator.java\n+++ b/fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/QuerySegmentAggregator.java\n\n@@ -268,14 +267,13 @@ public class QuerySegmentAggregator {\n             buildFromClause(queryString, simpleName);\n             buildWhereClause(queryString, null);\n \n-            // An important step here is to add _id, values table bind variables, and then and _lastUpdated\n+            // An important step here is to add _id, _lastUpdated, and then values table bind variables\n             List<Object> allBindVariables = new ArrayList<>();\n             allBindVariables.addAll(idsObjects);\n-\n+            allBindVariables.addAll(lastUpdatedObjects);\n             for (SqlQueryData querySegment : this.querySegments) {\n                 allBindVariables.addAll(querySegment.getBindVariables());\n             }\n-            allBindVariables.addAll(lastUpdatedObjects);\n \n             addOptimizerHint(queryString);\n             queryData = new SqlQueryData(queryString.toString(), allBindVariables);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzgxODkzMA==", "url": "https://github.com/IBM/FHIR/pull/1389#discussion_r463818930", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            // An important step here is to add _id, values table bind variables, and then and _lastUpdated\n          \n          \n            \n                            // An important step here is to add _id, values table bind variables, and then _lastUpdated", "author": "lmsurpre", "createdAt": "2020-07-31T20:25:23Z", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/QuerySegmentAggregator.java", "diffHunk": "@@ -358,20 +359,19 @@ protected SqlQueryData buildSystemLevelQuery(String selectRoot, String subSelect\n                 queryString.append(JOIN);\n                 processFromClauseForLastUpdated(queryString, resourceTypeName);\n                 queryString.append(\" AS R \");\n-                                \n-                // An important step here is to add _id and _lastUpdated\n-                allBindVariables.addAll(idsObjects);\n-                allBindVariables.addAll(lastUpdatedObjects);\n \n                 queryString.append(ON);\n                 queryString.append(\"     R.LOGICAL_RESOURCE_ID = LR.LOGICAL_RESOURCE_ID \");\n                 queryString.append(\" AND R.RESOURCE_ID = LR.CURRENT_RESOURCE_ID \");\n                 queryString.append(\" AND R.IS_DELETED <> 'Y'\");\n-                \n+\n+                // An important step here is to add _id, values table bind variables, and then and _lastUpdated", "originalCommit": "0d2ec598d930039484b17f77bed126c7c17508c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg5MjU3OA==", "url": "https://github.com/IBM/FHIR/pull/1389#discussion_r463892578", "bodyText": "Fixed", "author": "prb112", "createdAt": "2020-08-01T00:06:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzgxODkzMA=="}], "type": "inlineReview", "revised_code": {"commit": "3af13ed7dca44d032580715507a19866bda213e1", "chunk": "diff --git a/fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/QuerySegmentAggregator.java b/fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/QuerySegmentAggregator.java\nindex 0a714c6d3f..8401bb0e01 100644\n--- a/fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/QuerySegmentAggregator.java\n+++ b/fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/QuerySegmentAggregator.java\n\n@@ -365,7 +363,7 @@ public class QuerySegmentAggregator {\n                 queryString.append(\" AND R.RESOURCE_ID = LR.CURRENT_RESOURCE_ID \");\n                 queryString.append(\" AND R.IS_DELETED <> 'Y'\");\n \n-                // An important step here is to add _id, values table bind variables, and then and _lastUpdated\n+                // An important step here is to add _id, values table bind variables, and then _lastUpdated\n                 allBindVariables.addAll(idsObjects);\n                 //Adding all other values to the bind variable list for this resource type.\n                 for (SqlQueryData querySegment : this.querySegments) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzgxOTIxNw==", "url": "https://github.com/IBM/FHIR/pull/1389#discussion_r463819217", "bodyText": "did you mean to take this back out?  if not, it should be a log statement, not sysout", "author": "lmsurpre", "createdAt": "2020-07-31T20:26:03Z", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/QuerySegmentAggregator.java", "diffHunk": "@@ -604,7 +606,10 @@ protected void buildWhereClause(StringBuilder whereClause, String overrideType)\n                         .append(\".LOGICAL_RESOURCE_ID = R.LOGICAL_RESOURCE_ID\");\n                     }\n                 }\n-            } // end if SKIP_WHERE\n+            } else {\n+                // end if SKIP_WHERE\n+                System.out.println(whereClause);", "originalCommit": "0d2ec598d930039484b17f77bed126c7c17508c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzgyNDI5MA==", "url": "https://github.com/IBM/FHIR/pull/1389#discussion_r463824290", "bodyText": "Yes, I meant to remove.  Fixed in next commit.", "author": "prb112", "createdAt": "2020-07-31T20:38:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzgxOTIxNw=="}], "type": "inlineReview", "revised_code": {"commit": "46036803588c76b306700cff91b1ba82777d6a9d", "chunk": "diff --git a/fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/QuerySegmentAggregator.java b/fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/QuerySegmentAggregator.java\nindex 0a714c6d3f..52615618a7 100644\n--- a/fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/QuerySegmentAggregator.java\n+++ b/fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/QuerySegmentAggregator.java\n\n@@ -606,10 +604,7 @@ public class QuerySegmentAggregator {\n                         .append(\".LOGICAL_RESOURCE_ID = R.LOGICAL_RESOURCE_ID\");\n                     }\n                 }\n-            } else {\n-                // end if SKIP_WHERE\n-                System.out.println(whereClause);\n-            }\n+            } // end if SKIP_WHERE\n         } // end for\n \n         log.exiting(CLASSNAME, METHODNAME);\n"}}, {"oid": "46036803588c76b306700cff91b1ba82777d6a9d", "url": "https://github.com/IBM/FHIR/commit/46036803588c76b306700cff91b1ba82777d6a9d", "message": "fix: Add Tests for _id and _lastUpdated #1383\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-07-31T20:51:01Z", "type": "commit"}, {"oid": "3af13ed7dca44d032580715507a19866bda213e1", "url": "https://github.com/IBM/FHIR/commit/3af13ed7dca44d032580715507a19866bda213e1", "message": "fix: per code review updating the comments\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-08-01T00:07:41Z", "type": "commit"}, {"oid": "84a1bdab0e56ededd80025bb27b58af0252050ce", "url": "https://github.com/IBM/FHIR/commit/84a1bdab0e56ededd80025bb27b58af0252050ce", "message": "fix: per code review updating the comments\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-08-01T00:37:51Z", "type": "commit"}]}