{"pr_number": 1607, "pr_title": "DropSchema related changes for issue #1595", "pr_createdAt": "2020-10-20T15:16:08Z", "pr_url": "https://github.com/IBM/FHIR/pull/1607", "timeline": [{"oid": "218e1cc932001ba7fbf5a20f4b574d80e5022d18", "url": "https://github.com/IBM/FHIR/commit/218e1cc932001ba7fbf5a20f4b574d80e5022d18", "message": "DropSchema related changes for issue #1595\n\nThis is only a partial fix. More work needs to happen for drop-schema to\nwork on PostgreSQL.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-10-20T15:18:22Z", "type": "forcePushed"}, {"oid": "45a551818479fa7af37225e9259be2669cc98c60", "url": "https://github.com/IBM/FHIR/commit/45a551818479fa7af37225e9259be2669cc98c60", "message": "DropSchema related changes for issue #1595\n\nThis is only a partial fix. More work needs to happen for drop-schema to\nwork on PostgreSQL.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-10-20T15:24:43Z", "type": "forcePushed"}, {"oid": "fd7807268a93ffdf832811c69799e49b7d566dc5", "url": "https://github.com/IBM/FHIR/commit/fd7807268a93ffdf832811c69799e49b7d566dc5", "message": "DropSchema related changes for issue #1595\n\nThis is only a partial fix. More work needs to happen for drop-schema to\nwork on PostgreSQL.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-10-21T12:05:13Z", "type": "commit"}, {"oid": "fd7807268a93ffdf832811c69799e49b7d566dc5", "url": "https://github.com/IBM/FHIR/commit/fd7807268a93ffdf832811c69799e49b7d566dc5", "message": "DropSchema related changes for issue #1595\n\nThis is only a partial fix. More work needs to happen for drop-schema to\nwork on PostgreSQL.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-10-21T12:05:13Z", "type": "forcePushed"}, {"oid": "2ca04e41a866de3c261888d55a9c7f08f0f9bb99", "url": "https://github.com/IBM/FHIR/commit/2ca04e41a866de3c261888d55a9c7f08f0f9bb99", "message": "Fix the SQLState for an undefined object name for postgresql\n\nAlso added try/catch for dropping undefined indexes\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-10-21T13:17:09Z", "type": "commit"}, {"oid": "2ca04e41a866de3c261888d55a9c7f08f0f9bb99", "url": "https://github.com/IBM/FHIR/commit/2ca04e41a866de3c261888d55a9c7f08f0f9bb99", "message": "Fix the SQLState for an undefined object name for postgresql\n\nAlso added try/catch for dropping undefined indexes\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-10-21T13:17:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI3OTg2MQ==", "url": "https://github.com/IBM/FHIR/pull/1607#discussion_r509279861", "bodyText": "Maybe this should be an OR with\n42883 | undefined_function\n42P01 | undefined_table\n42P02 | undefined_parameter\n42704 | undefined_object", "author": "prb112", "createdAt": "2020-10-21T13:27:39Z", "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/postgresql/PostgreSqlTranslator.java", "diffHunk": "@@ -113,7 +113,7 @@ public boolean isDuplicateSchema(SQLException x) {\n \n     @Override\n     public boolean isUndefinedName(SQLException x) {\n-        return \"42X05\".equals(x.getSQLState());", "originalCommit": "2ca04e41a866de3c261888d55a9c7f08f0f9bb99", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI5MTg5NQ==", "url": "https://github.com/IBM/FHIR/pull/1607#discussion_r509291895", "bodyText": "empirically I found the 42704 is what we got back for undefined functions, tables, and indexes.  not sure how to reconcile that with the provided list, but its easy-enough for me to or them", "author": "lmsurpre", "createdAt": "2020-10-21T13:40:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI3OTg2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI5NjkwNg==", "url": "https://github.com/IBM/FHIR/pull/1607#discussion_r509296906", "bodyText": "I wasn't sure if we should or not, it was more of a check-in, not necessarily that we had to or-then", "author": "prb112", "createdAt": "2020-10-21T13:45:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI3OTg2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTMxOTAzNw==", "url": "https://github.com/IBM/FHIR/pull/1607#discussion_r509319037", "bodyText": "ok, i went ahead and added them", "author": "lmsurpre", "createdAt": "2020-10-21T14:08:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI3OTg2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "0e66d528debb23b5f5220d6db3599e8f930b5608", "chunk": "diff --git a/fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/postgresql/PostgreSqlTranslator.java b/fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/postgresql/PostgreSqlTranslator.java\nindex 10a533c1bf..526c8df167 100644\n--- a/fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/postgresql/PostgreSqlTranslator.java\n+++ b/fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/postgresql/PostgreSqlTranslator.java\n\n@@ -113,7 +113,11 @@ public class PostgreSqlTranslator implements IDatabaseTranslator {\n \n     @Override\n     public boolean isUndefinedName(SQLException x) {\n-        return \"42704\".equals(x.getSQLState());\n+        String sqlState = x.getSQLState();\n+        return \"42704\".equals(sqlState) ||\n+               \"42883\".equals(sqlState) ||\n+               \"42P01\".equals(sqlState) ||\n+               \"42P02\".equals(sqlState);\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI4MzI2OA==", "url": "https://github.com/IBM/FHIR/pull/1607#discussion_r509283268", "bodyText": "is the adminDrop implicit here? what if we just call dropAdmin", "author": "prb112", "createdAt": "2020-10-21T13:30:19Z", "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/app/Main.java", "diffHunk": "@@ -424,7 +423,7 @@ protected void dropSchema() {\n                     JdbcTarget target = new JdbcTarget(c);\n                     IDatabaseAdapter adapter = getDbAdapter(dbType, target);\n \n-                    if (this.dropSchema) {\n+                    if (dropFhirSchema || dropOauthSchema || dropJavaBatchSchema) {", "originalCommit": "2ca04e41a866de3c261888d55a9c7f08f0f9bb99", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI4OTgyOQ==", "url": "https://github.com/IBM/FHIR/pull/1607#discussion_r509289829", "bodyText": "dropAdmin is covered separately in the if case just below this", "author": "lmsurpre", "createdAt": "2020-10-21T13:37:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI4MzI2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI5NDE2MQ==", "url": "https://github.com/IBM/FHIR/pull/1607#discussion_r509294161", "bodyText": "I think we should (later) revisit the whole option control logic in this Main...too much entropy.", "author": "punktilious", "createdAt": "2020-10-21T13:42:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI4MzI2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI5NTk0OA==", "url": "https://github.com/IBM/FHIR/pull/1607#discussion_r509295948", "bodyText": "+1 on Robin's comment.  it's definitely growing", "author": "prb112", "createdAt": "2020-10-21T13:44:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI4MzI2OA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI4NDgzOQ==", "url": "https://github.com/IBM/FHIR/pull/1607#discussion_r509284839", "bodyText": "See 426", "author": "prb112", "createdAt": "2020-10-21T13:31:32Z", "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/app/Main.java", "diffHunk": "@@ -1387,20 +1385,13 @@ protected void process() {\n \n         if (addKeyForTenant != null) {\n             addTenantKey();\n-        } else if (this.dropSchema) {\n+        } else if (this.dropAdmin || this.dropFhirSchema || this.dropJavaBatchSchema || this.dropOauthSchema) {", "originalCommit": "2ca04e41a866de3c261888d55a9c7f08f0f9bb99", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "b87388e431c73a3d522aa30a34a42ff83d54358b", "url": "https://github.com/IBM/FHIR/commit/b87388e431c73a3d522aa30a34a42ff83d54358b", "message": "Warn and skip drop permission statements for postgresql\n\nPermission objects are not used in our use of PostgreSQL\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-10-21T14:04:18Z", "type": "commit"}, {"oid": "0e66d528debb23b5f5220d6db3599e8f930b5608", "url": "https://github.com/IBM/FHIR/commit/0e66d528debb23b5f5220d6db3599e8f930b5608", "message": "Added additional codes for isUndefined\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-10-21T14:07:20Z", "type": "commit"}]}