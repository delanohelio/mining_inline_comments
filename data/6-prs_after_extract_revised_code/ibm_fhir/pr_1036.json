{"pr_number": 1036, "pr_title": "Set Context Invalid in Multi-tenant Db2 #1032", "pr_createdAt": "2020-05-06T17:50:10Z", "pr_url": "https://github.com/IBM/FHIR/pull/1036", "timeline": [{"oid": "6fece5b82ae7f814b60ab62ec64059a9eccc3bd7", "url": "https://github.com/IBM/FHIR/commit/6fece5b82ae7f814b60ab62ec64059a9eccc3bd7", "message": "Set Context Invalid in Multi-tenant Db2 #1032\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-05-06T17:49:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk4MjgyNw==", "url": "https://github.com/IBM/FHIR/pull/1036#discussion_r420982827", "bodyText": "should we handle dsPG == null situation?", "author": "albertwang-ibm", "createdAt": "2020-05-06T17:55:28Z", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/FHIRDbDAOImpl.java", "diffHunk": "@@ -247,6 +222,67 @@ public Connection getConnection() throws FHIRPersistenceDBConnectException {\n         }\n     }\n \n+    /**\n+     * this feature is executes row access control\n+     * \n+     * @param connection\n+     * @throws Exception\n+     */\n+    public void executeRowAccessFeature(Connection connection) throws Exception {\n+        // For the multi-tenant feature, configure the connection for the tenant by setting the sv_tenant_id.\n+        String tenantName = FHIRRequestContext.get().getTenantId();\n+        String tenantKey = null;\n+        String dsId = FHIRRequestContext.get().getDataStoreId();\n+        boolean multiTenantFeature = false;\n+\n+        // Retrieve the property group pertaining to the specified datastore.\n+        // Find and set the tenantKey for the request, otherwise subsequent pulls from the pool\n+        // miss the tenantKey.\n+        String dsPropertyName = FHIRConfiguration.PROPERTY_DATASOURCES + \"/\" + dsId;\n+        PropertyGroup dsPG = FHIRConfigHelper.getPropertyGroup(dsPropertyName);\n+        if (dsPG != null) {", "originalCommit": "6fece5b82ae7f814b60ab62ec64059a9eccc3bd7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk4NTY4OA==", "url": "https://github.com/IBM/FHIR/pull/1036#discussion_r420985688", "bodyText": "let me add a log", "author": "prb112", "createdAt": "2020-05-06T17:59:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk4MjgyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk4NjQ1MQ==", "url": "https://github.com/IBM/FHIR/pull/1036#discussion_r420986451", "bodyText": "and maybe a exception?", "author": "albertwang-ibm", "createdAt": "2020-05-06T18:01:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk4MjgyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk4NjUxNg==", "url": "https://github.com/IBM/FHIR/pull/1036#discussion_r420986516", "bodyText": "fixed, it's a good idea", "author": "prb112", "createdAt": "2020-05-06T18:01:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk4MjgyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk4Njc2Mw==", "url": "https://github.com/IBM/FHIR/pull/1036#discussion_r420986763", "bodyText": "cool, thanks!", "author": "albertwang-ibm", "createdAt": "2020-05-06T18:01:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk4MjgyNw=="}], "type": "inlineReview", "revised_code": {"commit": "71faf63879bdbf1dd4564f3d062ece29556f13a7", "chunk": "diff --git a/fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/FHIRDbDAOImpl.java b/fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/FHIRDbDAOImpl.java\nindex d236fb7714..4761b4f20d 100644\n--- a/fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/FHIRDbDAOImpl.java\n+++ b/fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/FHIRDbDAOImpl.java\n\n@@ -253,6 +253,8 @@ public class FHIRDbDAOImpl implements FHIRDbDAO {\n                 multiTenantFeature =\n                         dsPG.getBooleanProperty(\"multitenant\", DATASTORE_REQUIRES_ROW_PERMISSIONS.contains(type));\n             }\n+        } else {\n+            log.warning(\"there are no datasource properties found for : [\" + dsPropertyName + \"]\");\n         }\n \n         if (multiTenantFeature) {\n"}}, {"oid": "71faf63879bdbf1dd4564f3d062ece29556f13a7", "url": "https://github.com/IBM/FHIR/commit/71faf63879bdbf1dd4564f3d062ece29556f13a7", "message": "Set Context Invalid in Multi-tenant Db2 #1032\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-05-06T18:01:47Z", "type": "commit"}]}