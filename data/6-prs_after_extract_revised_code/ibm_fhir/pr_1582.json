{"pr_number": 1582, "pr_title": "Issue #1504 - add back in sort for PUT/DELETE requests", "pr_createdAt": "2020-10-14T21:31:00Z", "pr_url": "https://github.com/IBM/FHIR/pull/1582", "timeline": [{"oid": "3bad7cf02f13766c9175e1c69e6bbee66815959b", "url": "https://github.com/IBM/FHIR/commit/3bad7cf02f13766c9175e1c69e6bbee66815959b", "message": "Issue #1504 - add back in sort for PUT/DELETE requests\n\nSigned-off-by: Mike Schroeder <mschroed@us.ibm.com>", "committedDate": "2020-10-14T21:28:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA1NTM5OQ==", "url": "https://github.com/IBM/FHIR/pull/1582#discussion_r505055399", "bodyText": "Need if isLoggable barrier here", "author": "punktilious", "createdAt": "2020-10-14T23:13:55Z", "path": "fhir-server/src/main/java/com/ibm/fhir/server/util/FHIRRestHelper.java", "diffHunk": "@@ -2023,6 +2044,98 @@ private Bundle reconstructResponseBundle(Bundle responseBundle,\n         return responseBundle;\n     }\n \n+    /**\n+     * Returns a list of Integers that provide the indices of the bundle entries associated with the specified http\n+     * method.\n+     *\n+     * @param requestBundle\n+     *            the request bundle\n+     * @param httpMethod\n+     *            the http method to look for\n+     * @return\n+     */\n+    private List<Integer> getBundleRequestIndicesForMethod(Bundle requestBundle,\n+        Bundle responseBundle, HTTPVerb httpMethod) {\n+        List<Integer> indices = new ArrayList<>();\n+        for (int i = 0; i < requestBundle.getEntry().size(); i++) {\n+            Bundle.Entry requestEntry = requestBundle.getEntry().get(i);\n+            Bundle.Entry.Request request = requestEntry.getRequest();\n+\n+            Bundle.Entry responseEntry = responseBundle.getEntry().get(i);\n+            Bundle.Entry.Response response = responseEntry.getResponse();\n+\n+            // If the response status is SC_OK which means the request passed the validation,\n+            // and this request entry's http method is the one we're looking for,\n+            // then record the index in our list.\n+            // (please notice that status can not be null since R4, So we set the response status as SC_OK\n+            // after the resource validation. )\n+            if (response.getStatus().equals(SC_OK_STRING)\n+                    && request.getMethod().equals(httpMethod)) {\n+                indices.add(Integer.valueOf(i));\n+            }\n+        }\n+        return indices;\n+    }\n+\n+    /**\n+     * This function sorts the request entries in the specified bundle, based on the path part of the entry's 'url'\n+     * field.\n+     *\n+     * @param bundle\n+     *            the bundle containing the request entries to be sorted.\n+     * @return an array of Integer which provides the \"sorted\" ordering of request entry index values.\n+     */\n+    private void sortBundleRequestEntries(Bundle bundle, List<Integer> indices) {\n+        // Sort the list of indices based on the contents of their entries in the bundle.\n+        Collections.sort(indices, new BundleEntryComparator(bundle.getEntry()));\n+    }\n+\n+    private static class BundleEntryComparator implements Comparator<Integer> {\n+        private List<Bundle.Entry> entries;\n+\n+        public BundleEntryComparator(List<Bundle.Entry> entries) {\n+            this.entries = entries;\n+        }\n+\n+        @Override\n+        public int compare(Integer indexA, Integer indexB) {\n+            Bundle.Entry a = entries.get(indexA);\n+            Bundle.Entry b = entries.get(indexB);\n+            String pathA = getUrlPath(a);\n+            String pathB = getUrlPath(b);\n+\n+            log.fine(\"Comparing request entry URL paths: \" + pathA + \", \" + pathB);", "originalCommit": "3bad7cf02f13766c9175e1c69e6bbee66815959b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ2MjYxNA==", "url": "https://github.com/IBM/FHIR/pull/1582#discussion_r505462614", "bodyText": "like this:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        log.fine(\"Comparing request entry URL paths: \" + pathA + \", \" + pathB);\n          \n          \n            \n                        if (log.isLoggable(Level.FINE)) {\n          \n          \n            \n                            log.fine(\"Comparing request entry URL paths: \" + pathA + \", \" + pathB);\n          \n          \n            \n                        }", "author": "lmsurpre", "createdAt": "2020-10-15T11:20:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA1NTM5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ5MjM5OQ==", "url": "https://github.com/IBM/FHIR/pull/1582#discussion_r505492399", "bodyText": "Added check around all log.fine() statements that did not have check.", "author": "michaelwschroeder", "createdAt": "2020-10-15T12:15:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA1NTM5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTUwNDcxOQ==", "url": "https://github.com/IBM/FHIR/pull/1582#discussion_r505504719", "bodyText": "FWIW, I don't think its always needed.  Its mostly just to avoid paying the cost of string building, especially when the logs contain Object.toString() calls (or similar), and especially when in a loop.\nBut it never hurts to have it, so I'm OK with adding it everywhere.", "author": "lmsurpre", "createdAt": "2020-10-15T12:35:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA1NTM5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "920ca45a2a1f6ec05adca2773ebb6a2223ea146a", "chunk": "diff --git a/fhir-server/src/main/java/com/ibm/fhir/server/util/FHIRRestHelper.java b/fhir-server/src/main/java/com/ibm/fhir/server/util/FHIRRestHelper.java\nindex f08e72af97..61ed3d2d86 100644\n--- a/fhir-server/src/main/java/com/ibm/fhir/server/util/FHIRRestHelper.java\n+++ b/fhir-server/src/main/java/com/ibm/fhir/server/util/FHIRRestHelper.java\n\n@@ -2104,7 +2122,9 @@ public class FHIRRestHelper implements FHIRResourceHelpers {\n             String pathA = getUrlPath(a);\n             String pathB = getUrlPath(b);\n \n-            log.fine(\"Comparing request entry URL paths: \" + pathA + \", \" + pathB);\n+            if (log.isLoggable(Level.FINE)) {\n+                log.fine(\"Comparing request entry URL paths: \" + pathA + \", \" + pathB);\n+            }\n             if (pathA != null && pathB != null) {\n                 return pathA.compareTo(pathB);\n             } else if (pathA != null) {\n"}}, {"oid": "920ca45a2a1f6ec05adca2773ebb6a2223ea146a", "url": "https://github.com/IBM/FHIR/commit/920ca45a2a1f6ec05adca2773ebb6a2223ea146a", "message": "Issue #1504 - add isLoggable checks around log.fine() statements\n\nSigned-off-by: Mike Schroeder <mschroed@us.ibm.com>", "committedDate": "2020-10-15T12:14:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTUwNjk2Ng==", "url": "https://github.com/IBM/FHIR/pull/1582#discussion_r505506966", "bodyText": "I think @punktilious requested to add this one back in \"to avoid deadlock issues in case the same id appears in another bundle\", but I'm hoping someone can explain it to me because I'm not sure I get it.", "author": "lmsurpre", "createdAt": "2020-10-15T12:39:04Z", "path": "fhir-server/src/main/java/com/ibm/fhir/server/util/FHIRRestHelper.java", "diffHunk": "@@ -1549,10 +1571,27 @@ private Bundle processEntriesForMethod(Bundle requestBundle, Bundle responseBund\n         log.entering(this.getClass().getName(), \"processEntriesForMethod\", new Object[] {\"httpMethod\", httpMethod });\n         \n         try {\n-            // Visit each of the request entries, processing those with the specified request method.\n+            // First, obtain a list of request entry indices for the entries that we'll process.\n+            // This list will contain the indices associated with only the entries for the specified http method.\n+            List<Integer> entryIndices =\n+                    getBundleRequestIndicesForMethod(requestBundle, responseBundle, httpMethod);\n+            if (log.isLoggable(Level.FINER)) {\n+                log.finer(\"Bundle request indices to be processed: \" + entryIndices.toString());\n+            }\n+\n+            // Next, for PUT and DELETE requests, we need to sort the indices by the request url path value.\n+            if (httpMethod.equals(HTTPVerb.PUT) || httpMethod.equals(HTTPVerb.DELETE)) {\n+                sortBundleRequestEntries(requestBundle, entryIndices);", "originalCommit": "920ca45a2a1f6ec05adca2773ebb6a2223ea146a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTU5Mzk1NQ==", "url": "https://github.com/IBM/FHIR/pull/1582#discussion_r505593955", "bodyText": "here is the problematic scenario:\nwithin single transaction bundle:\nbundle 1:\nPUT A\nPUT B\n\nwithin a separate transaction bundle:\nbundle 2:\nPUT B\nPUT A\n\nthe timing problem would be:\n\nbundle 1 arrives first, it goes through entries and when it hits PUT A it locks A\nbundle 2 arrives very soon afterward, and it starts processing the PUT B before bundle 1's PUT B (locking B)\ndeadlock", "author": "lmsurpre", "createdAt": "2020-10-15T14:34:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTUwNjk2Ng=="}], "type": "inlineReview", "revised_code": null}]}