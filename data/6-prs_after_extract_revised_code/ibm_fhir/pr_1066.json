{"pr_number": 1066, "pr_title": "Upon Second Schema deployment, VersionHistoryService reports error", "pr_createdAt": "2020-05-11T16:59:29Z", "pr_url": "https://github.com/IBM/FHIR/pull/1066", "timeline": [{"oid": "7088f5e7ab9a9d531af3fa819ac67bda6d7b2a3b", "url": "https://github.com/IBM/FHIR/commit/7088f5e7ab9a9d531af3fa819ac67bda6d7b2a3b", "message": "Upon Second Schema deployment, VersionHistoryService reports error and\nthe update-schema is stopped. #1065\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-05-11T16:58:50Z", "type": "commit"}, {"oid": "4ab183454b1158267934b144b57278b610f27d45", "url": "https://github.com/IBM/FHIR/commit/4ab183454b1158267934b144b57278b610f27d45", "message": "Cleanup needless semicolon\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-05-11T17:16:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE5Njk1Mw==", "url": "https://github.com/IBM/FHIR/pull/1066#discussion_r423196953", "bodyText": "DB2 SQL Error: SQLCODE=-104, SQLSTATE=42601, SQLERRMC=;;enant_salt || ?, 2));END-OF-STATEMENT\nPossibly double end of statement problem? maybe only occurs on Windows versus Mac?", "author": "prb112", "createdAt": "2020-05-11T17:20:54Z", "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/app/Main.java", "diffHunk": "@@ -893,7 +893,7 @@ protected void checkIfTenantNameAndTenantKeyExists(Db2Adapter adapter, String te\n                 final String sql =\n                         \"SELECT t.tenant_status FROM fhir_admin.tenants t WHERE t.tenant_name = ? \"\n                                 + \"AND EXISTS (SELECT 1 FROM fhir_admin.tenant_keys tk WHERE tk.mt_id = t.mt_id \"\n-                                + \"AND tk.tenant_hash = sysibm.hash(tk.tenant_salt || ?, 2));\";\n+                                + \"AND tk.tenant_hash = sysibm.hash(tk.tenant_salt || ?, 2))\";", "originalCommit": "4ab183454b1158267934b144b57278b610f27d45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzIzMDEzOQ==", "url": "https://github.com/IBM/FHIR/pull/1066#discussion_r423230139", "bodyText": "wouldn't our windows e2e test have caught this?  if not, why not?", "author": "lmsurpre", "createdAt": "2020-05-11T18:18:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE5Njk1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzIzNTIwNQ==", "url": "https://github.com/IBM/FHIR/pull/1066#discussion_r423235205", "bodyText": "I thought so too.\nI did send a new cli jar to Frances and it worked.", "author": "prb112", "createdAt": "2020-05-11T18:28:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE5Njk1Mw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "cbf63b0cea6ec3f28ce2345f17db7c4486160f2c", "url": "https://github.com/IBM/FHIR/commit/cbf63b0cea6ec3f28ce2345f17db7c4486160f2c", "message": "Fix for newDb logic\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-05-11T18:15:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzIzMDgxOQ==", "url": "https://github.com/IBM/FHIR/pull/1066#discussion_r423230819", "bodyText": "should it be newDb = (x == null || x == 0)?", "author": "lmsurpre", "createdAt": "2020-05-11T18:20:20Z", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/DerbyBootstrapper.java", "diffHunk": "@@ -111,12 +111,12 @@ public static void bootstrap(Connection connection, String adminSchemaName, Stri\n         // Current version history for the database. This is used by applyWithHistory\n         // to determine which updates to apply and to record the new changes as they\n         // are applied\n-        VersionHistoryService vhs = new VersionHistoryService(adminSchemaName, dataSchemaName);\n+        VersionHistoryService vhs = new VersionHistoryService(adminSchemaName, dataSchemaName, OAUTH_SCHEMANAME);\n         vhs.setTarget(adapter);\n         vhs.init();\n \n         // Use the version history service to determine if this table existed before we run `applyWithHistory`\n-        boolean newDb = vhs.getVersion(dataSchemaName, DatabaseObjectType.TABLE.name(), \"PARAMETER_NAMES\") == null;\n+        boolean newDb = vhs.getVersion(dataSchemaName, DatabaseObjectType.TABLE.name(), \"PARAMETER_NAMES\") == 0;", "originalCommit": "cbf63b0cea6ec3f28ce2345f17db7c4486160f2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzIzNTI4Nw==", "url": "https://github.com/IBM/FHIR/pull/1066#discussion_r423235287", "bodyText": "fixed", "author": "prb112", "createdAt": "2020-05-11T18:28:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzIzMDgxOQ=="}], "type": "inlineReview", "revised_code": {"commit": "04b0d57a52fb2b9f83c9ebee09b645e17fb5912d", "chunk": "diff --git a/fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/DerbyBootstrapper.java b/fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/DerbyBootstrapper.java\nindex d7bdc4203a..d46b4d1246 100644\n--- a/fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/DerbyBootstrapper.java\n+++ b/fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/DerbyBootstrapper.java\n\n@@ -116,7 +116,9 @@ public class DerbyBootstrapper {\n         vhs.init();\n \n         // Use the version history service to determine if this table existed before we run `applyWithHistory`\n-        boolean newDb = vhs.getVersion(dataSchemaName, DatabaseObjectType.TABLE.name(), \"PARAMETER_NAMES\") == 0;\n+        boolean newDb =\n+                vhs.getVersion(dataSchemaName, DatabaseObjectType.TABLE.name(), \"PARAMETER_NAMES\") == null\n+                        || vhs.getVersion(dataSchemaName, DatabaseObjectType.TABLE.name(), \"PARAMETER_NAMES\") == 0;\n \n         // Define the schema and apply it (or required updates)\n         FhirSchemaGenerator gen = new FhirSchemaGenerator(adminSchemaName, dataSchemaName);\n"}}, {"oid": "04b0d57a52fb2b9f83c9ebee09b645e17fb5912d", "url": "https://github.com/IBM/FHIR/commit/04b0d57a52fb2b9f83c9ebee09b645e17fb5912d", "message": "Fix for newDb logic\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-05-11T18:25:16Z", "type": "commit"}]}