{"pr_number": 862, "pr_title": "issue #853 use system properties instead of derby.properties", "pr_createdAt": "2020-03-27T20:13:17Z", "pr_url": "https://github.com/IBM/FHIR/pull/862", "timeline": [{"oid": "bc2824999e5be15164a716946b8ed7ac7f15adef", "url": "https://github.com/IBM/FHIR/commit/bc2824999e5be15164a716946b8ed7ac7f15adef", "message": "issue #853 use system properties instead of derby.properties\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-03-27T20:12:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUyMDg2OA==", "url": "https://github.com/IBM/FHIR/pull/862#discussion_r399520868", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static void setServerProperties (boolean isDebug) {\n          \n          \n            \n                public static void setServerProperties(boolean isDebug) {", "author": "prb112", "createdAt": "2020-03-27T20:27:29Z", "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/derby/DerbyServerPropertiesMgr.java", "diffHunk": "@@ -0,0 +1,29 @@\n+/*\n+ * (C) Copyright IBM Corp. 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.database.utils.derby;\n+\n+import java.util.Properties;\n+\n+\n+/**\n+ * Server properties for embedded derby which is used in unit tests and server integration tests,\n+ * equal to setting in derby.properties.\n+ */\n+public class DerbyServerPropertiesMgr {\n+    public static void setServerProperties (boolean isDebug) {", "originalCommit": "bc2824999e5be15164a716946b8ed7ac7f15adef", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6a4d3e8d180dbcbe4085b27762ac91bd500f3514", "chunk": "diff --git a/fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/derby/DerbyServerPropertiesMgr.java b/fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/derby/DerbyServerPropertiesMgr.java\nindex a27c413c2d..9010a08421 100644\n--- a/fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/derby/DerbyServerPropertiesMgr.java\n+++ b/fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/derby/DerbyServerPropertiesMgr.java\n\n@@ -14,7 +14,7 @@ import java.util.Properties;\n  * equal to setting in derby.properties.\n  */\n public class DerbyServerPropertiesMgr {\n-    public static void setServerProperties (boolean isDebug) {\n+    public static void setServerProperties(boolean isDebug) {\n         Properties sysProperties = System.getProperties();\n         // This speeds up sequence fetching by pre-creating 1000 instead of the default 100.\n         sysProperties.put(\"derby.language.sequence.preallocator\", 1000);\n"}}, {"oid": "6a4d3e8d180dbcbe4085b27762ac91bd500f3514", "url": "https://github.com/IBM/FHIR/commit/6a4d3e8d180dbcbe4085b27762ac91bd500f3514", "message": "Update fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/derby/DerbyServerPropertiesMgr.java\r\n\r\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>\n\nCo-Authored-By: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-03-27T20:29:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUyMjEzNQ==", "url": "https://github.com/IBM/FHIR/pull/862#discussion_r399522135", "bodyText": "it's not really a constant at this point. let's just pass in the boolean value and a comment on line 149....", "author": "prb112", "createdAt": "2020-03-27T20:30:13Z", "path": "fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java", "diffHunk": "@@ -140,8 +141,13 @@ public void contextInitialized(ServletContextEvent event) {\n      */\n     private void bootstrapDerbyDatabases(PropertyGroup fhirConfig) throws Exception {\n         Boolean performDbBootstrap = fhirConfig.getBooleanProperty(PROPERTY_JDBC_BOOTSTRAP_DB, Boolean.FALSE);\n+        // Controls if we run derby in debugging mode which enables more logs.\n+        boolean DEBUG = false;", "originalCommit": "bc2824999e5be15164a716946b8ed7ac7f15adef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU4ODgyNA==", "url": "https://github.com/IBM/FHIR/pull/862#discussion_r399588824", "bodyText": "agreed, thanks!", "author": "albertwang-ibm", "createdAt": "2020-03-28T00:03:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUyMjEzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTYwMDE0OA==", "url": "https://github.com/IBM/FHIR/pull/862#discussion_r399600148", "bodyText": "done", "author": "albertwang-ibm", "createdAt": "2020-03-28T01:14:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUyMjEzNQ=="}], "type": "inlineReview", "revised_code": {"commit": "c7029290e67114a233485fb3c24f04872acd7679", "chunk": "diff --git a/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java b/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\nindex 3a00afe93b..b46e8393da 100644\n--- a/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\n+++ b/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\n\n@@ -141,12 +141,11 @@ public class FHIRServletContextListener implements ServletContextListener {\n      */\n     private void bootstrapDerbyDatabases(PropertyGroup fhirConfig) throws Exception {\n         Boolean performDbBootstrap = fhirConfig.getBooleanProperty(PROPERTY_JDBC_BOOTSTRAP_DB, Boolean.FALSE);\n-        // Controls if we run derby in debugging mode which enables more logs.\n-        boolean DEBUG = false;\n         if (performDbBootstrap) {\n             log.info(\"Performing Derby database bootstrapping...\");\n \n-            DerbyServerPropertiesMgr.setServerProperties(DEBUG);\n+            // Start derby with debug off by default.\n+            DerbyServerPropertiesMgr.setServerProperties(false);\n \n             String datasourceJndiName = fhirConfig.getStringProperty(FHIRConfiguration.PROPERTY_JDBC_DATASOURCE_JNDINAME, \"jdbc/fhirDB\");\n             InitialContext ctxt = new InitialContext();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUyMjY5NA==", "url": "https://github.com/IBM/FHIR/pull/862#discussion_r399522694", "bodyText": "does Derby automatically write this out when it's set on System.getProperties?", "author": "prb112", "createdAt": "2020-03-27T20:31:29Z", "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/derby/DerbyServerPropertiesMgr.java", "diffHunk": "@@ -0,0 +1,29 @@\n+/*\n+ * (C) Copyright IBM Corp. 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.database.utils.derby;\n+\n+import java.util.Properties;\n+\n+\n+/**\n+ * Server properties for embedded derby which is used in unit tests and server integration tests,\n+ * equal to setting in derby.properties.\n+ */\n+public class DerbyServerPropertiesMgr {\n+    public static void setServerProperties (boolean isDebug) {\n+        Properties sysProperties = System.getProperties();", "originalCommit": "bc2824999e5be15164a716946b8ed7ac7f15adef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU4ODk1Ng==", "url": "https://github.com/IBM/FHIR/pull/862#discussion_r399588956", "bodyText": "no, it doesn't.", "author": "albertwang-ibm", "createdAt": "2020-03-28T00:03:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUyMjY5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA5Nzg2MQ==", "url": "https://github.com/IBM/FHIR/pull/862#discussion_r400097861", "bodyText": "How does this write out? ...\nThe prior code uses a PrintWriter, and now it uses System.getProperties.\ntry (PrintWriter out = new PrintWriter(DERBY_PROPERTIES)){ \nIs very different from System.getProperties", "author": "prb112", "createdAt": "2020-03-30T10:49:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUyMjY5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDE0NTkwOQ==", "url": "https://github.com/IBM/FHIR/pull/862#discussion_r400145909", "bodyText": "yes, you are correct. I had used the perperties file because I did find this way at that time, now I found this way is much easier and don't have to associate with any directory.", "author": "albertwang-ibm", "createdAt": "2020-03-30T12:19:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUyMjY5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDE1MjAxOA==", "url": "https://github.com/IBM/FHIR/pull/862#discussion_r400152018", "bodyText": "Excellent.  thanks", "author": "prb112", "createdAt": "2020-03-30T12:29:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUyMjY5NA=="}], "type": "inlineReview", "revised_code": {"commit": "22d2a92fd8c413d12357b300b9a58325d3aa1d7f", "chunk": "diff --git a/fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/derby/DerbyServerPropertiesMgr.java b/fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/derby/DerbyServerPropertiesMgr.java\nindex a27c413c2d..9010a08421 100644\n--- a/fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/derby/DerbyServerPropertiesMgr.java\n+++ b/fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/derby/DerbyServerPropertiesMgr.java\n\n@@ -14,7 +14,7 @@ import java.util.Properties;\n  * equal to setting in derby.properties.\n  */\n public class DerbyServerPropertiesMgr {\n-    public static void setServerProperties (boolean isDebug) {\n+    public static void setServerProperties(boolean isDebug) {\n         Properties sysProperties = System.getProperties();\n         // This speeds up sequence fetching by pre-creating 1000 instead of the default 100.\n         sysProperties.put(\"derby.language.sequence.preallocator\", 1000);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUyMzE5OA==", "url": "https://github.com/IBM/FHIR/pull/862#discussion_r399523198", "bodyText": "I take it the translator already does the class name lookup?  otherwise if it doesn't I think this should be done on line 53. it's the general jdbc driver class loading pattern", "author": "prb112", "createdAt": "2020-03-27T20:32:35Z", "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/derby/DerbyMaster.java", "diffHunk": "@@ -56,22 +51,7 @@\n     public DerbyMaster(String database) {\n         this.database = database;\n \n-        try (PrintWriter out = new PrintWriter(DERBY_PROPERTIES)){\n-            Class.forName(DERBY_TRANSLATOR.getDriverClassName());", "originalCommit": "6a4d3e8d180dbcbe4085b27762ac91bd500f3514", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU5NzkwMA==", "url": "https://github.com/IBM/FHIR/pull/862#discussion_r399597900", "bodyText": "yeah, it's interesting that removing this has been working well. checking if this is really needed here ....", "author": "albertwang-ibm", "createdAt": "2020-03-28T00:57:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUyMzE5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU5OTAyOQ==", "url": "https://github.com/IBM/FHIR/pull/862#discussion_r399599029", "bodyText": "did some search, JDBC 4.0 (and after) drivers that are found in your class path are automatically loaded, only JDBC drivers older than 4.0 have to be loaded by Class.forName.\nI will keep it just in case JDBC older drivers are/(will be) still used...", "author": "albertwang-ibm", "createdAt": "2020-03-28T01:06:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUyMzE5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTYwMDIzMg==", "url": "https://github.com/IBM/FHIR/pull/862#discussion_r399600232", "bodyText": "added it back with comment even thought I believe it's not really needed now", "author": "albertwang-ibm", "createdAt": "2020-03-28T01:15:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUyMzE5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDEwMTUyMw==", "url": "https://github.com/IBM/FHIR/pull/862#discussion_r400101523", "bodyText": "it's best to maintain a consistent pattern - it's in FhirDbDaoImpl too", "author": "prb112", "createdAt": "2020-03-30T10:56:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUyMzE5OA=="}], "type": "inlineReview", "revised_code": {"commit": "c7029290e67114a233485fb3c24f04872acd7679", "chunk": "diff --git a/fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/derby/DerbyMaster.java b/fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/derby/DerbyMaster.java\nindex d39d5ae84c..680717b900 100644\n--- a/fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/derby/DerbyMaster.java\n+++ b/fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/derby/DerbyMaster.java\n\n@@ -51,8 +51,16 @@ public class DerbyMaster implements AutoCloseable {\n     public DerbyMaster(String database) {\n         this.database = database;\n \n-        DerbyServerPropertiesMgr.setServerProperties(DEBUG);\n+        // Any JDBC 4.0 drivers that are found in your class path are automatically loaded,\n+        // However, any driver prior to JDBC 4.0 has to be loaded with the method Class.forName.\n+        try {\n+            Class.forName(DERBY_TRANSLATOR.getDriverClassName());\n+        }\n+        catch (ClassNotFoundException e) {\n+            throw new IllegalStateException(e);\n+        }\n \n+        DerbyServerPropertiesMgr.setServerProperties(DEBUG);\n         dropDatabase(database);\n \n     }\n"}}, {"oid": "c7029290e67114a233485fb3c24f04872acd7679", "url": "https://github.com/IBM/FHIR/commit/c7029290e67114a233485fb3c24f04872acd7679", "message": "issue #853 minor changes per review comments\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-03-28T01:12:52Z", "type": "commit"}, {"oid": "22d2a92fd8c413d12357b300b9a58325d3aa1d7f", "url": "https://github.com/IBM/FHIR/commit/22d2a92fd8c413d12357b300b9a58325d3aa1d7f", "message": "Merge branch 'Albert-Master-New' of git@github.com:IBM/FHIR.git into Albert-Master-New", "committedDate": "2020-03-28T01:13:25Z", "type": "commit"}, {"oid": "0fe9d184319abd93deb53a118c8db3aa738c165f", "url": "https://github.com/IBM/FHIR/commit/0fe9d184319abd93deb53a118c8db3aa738c165f", "message": "Merge branch 'master' into Albert-Master-New", "committedDate": "2020-03-28T01:18:12Z", "type": "commit"}, {"oid": "22349ca73430795bf0e2bf105bc4f490448dafd4", "url": "https://github.com/IBM/FHIR/commit/22349ca73430795bf0e2bf105bc4f490448dafd4", "message": "issue #853 change derby directory\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-03-28T01:38:33Z", "type": "commit"}, {"oid": "0a9d5c89869e281bfc99f2a7a0ea27231f0dda31", "url": "https://github.com/IBM/FHIR/commit/0a9d5c89869e281bfc99f2a7a0ea27231f0dda31", "message": "issue #853 minor update of comment\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-03-28T01:44:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTg5MDM4NA==", "url": "https://github.com/IBM/FHIR/pull/862#discussion_r399890384", "bodyText": "Is this actually needed?  Isn't \"false\" the default?\nOr I guess you add this here just to make it easy to turn on should we want to turn it on?", "author": "lmsurpre", "createdAt": "2020-03-30T01:51:46Z", "path": "fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java", "diffHunk": "@@ -142,6 +143,10 @@ private void bootstrapDerbyDatabases(PropertyGroup fhirConfig) throws Exception\n         Boolean performDbBootstrap = fhirConfig.getBooleanProperty(PROPERTY_JDBC_BOOTSTRAP_DB, Boolean.FALSE);\n         if (performDbBootstrap) {\n             log.info(\"Performing Derby database bootstrapping...\");\n+\n+            // Start derby with debug off by default.\n+            DerbyServerPropertiesMgr.setServerProperties(false);", "originalCommit": "0a9d5c89869e281bfc99f2a7a0ea27231f0dda31", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}