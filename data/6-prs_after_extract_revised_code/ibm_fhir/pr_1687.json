{"pr_number": 1687, "pr_title": "fix: allocate-tenant fails when run twice", "pr_createdAt": "2020-11-10T14:32:20Z", "pr_url": "https://github.com/IBM/FHIR/pull/1687", "timeline": [{"oid": "32387a03fd17259da346bf0f1fa6b4efa8686e81", "url": "https://github.com/IBM/FHIR/commit/32387a03fd17259da346bf0f1fa6b4efa8686e81", "message": "fix: allocate-tenant fails when run twice\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-11-10T14:29:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYxODE3MA==", "url": "https://github.com/IBM/FHIR/pull/1687#discussion_r520618170", "bodyText": "As this is being run as maintenance task I supposed we're not going to be too worried about concurrency. Selecting first then inserting what's missing isn't thread-safe but it's probably not a big deal here.", "author": "punktilious", "createdAt": "2020-11-10T14:46:43Z", "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/PopulateParameterNames.java", "diffHunk": "@@ -52,15 +54,27 @@ public PopulateParameterNames(String adminSchemaName, String schemaName, Integer\n     public void run(IDatabaseTranslator translator, Connection c) {\n         final String stmtVariable = String.format(\"SET %s.SV_TENANT_ID = %d\", adminSchemaName, tenantId);\n         final String stmtResourceTypeInsert;\n+        final String PARAMETER_NAMES = String.format(\"SELECT PARAMETER_NAME_ID, PARAMETER_NAME FROM %s.parameter_names\", schemaName);\n         if (tenantId != null) {\n             stmtResourceTypeInsert =\n                     String.format(\"INSERT INTO %s.parameter_names (MT_ID, PARAMETER_NAME_ID, PARAMETER_NAME) \"\n                             + \"VALUES (%s.sv_tenant_id, ?, ?)\", schemaName, adminSchemaName);\n         } else {\n             stmtResourceTypeInsert =\n-                    String.format(\n-                            \"INSERT INTO %s.parameter_names (PARAMETER_NAME_ID, PARAMETER_NAME) \" + \"VALUES (?, ?)\",\n-                            schemaName);\n+                    String.format(\"INSERT INTO %s.parameter_names (PARAMETER_NAME_ID, PARAMETER_NAME) \" + \"VALUES (?, ?)\", schemaName);\n+        }\n+\n+        Map<String, Integer> values = new HashMap<>();", "originalCommit": "32387a03fd17259da346bf0f1fa6b4efa8686e81", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYzODIxNg==", "url": "https://github.com/IBM/FHIR/pull/1687#discussion_r520638216", "bodyText": "Good point, I'll have to defer this part... if customers hit we can add USING RS", "author": "prb112", "createdAt": "2020-11-10T15:12:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYxODE3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY1MDIwOA==", "url": "https://github.com/IBM/FHIR/pull/1687#discussion_r520650208", "bodyText": "Yeah, I'm not too worried about this in this context.", "author": "punktilious", "createdAt": "2020-11-10T15:27:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYxODE3MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYyNDI5OA==", "url": "https://github.com/IBM/FHIR/pull/1687#discussion_r520624298", "bodyText": "Parameter", "author": "punktilious", "createdAt": "2020-11-10T14:54:20Z", "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/PopulateParameterNames.java", "diffHunk": "@@ -76,26 +90,34 @@ public void run(IDatabaseTranslator translator, Connection c) {\n                 Properties props = new Properties();\n                 props.load(fis);\n \n+                int numToProcess = 0;\n                 for (Entry<Object, Object> valueEntry : props.entrySet()) {\n                     Integer curVal = Integer.parseInt((String) valueEntry.getValue());\n                     String code = (String) valueEntry.getKey();\n-                    batch.setLong(1, curVal);\n-                    batch.setString(2, code);\n-                    batch.addBatch();\n-                }\n \n-                // Check Error Codes.\n-                int[] codes = batch.executeBatch();\n-                int errorCodes = 0;\n-                for (int code : codes) {\n-                    if (code < 0) {\n-                        errorCodes++;\n+                    if (values.containsKey(code)) {\n+                        batch.setLong(1, curVal);\n+                        batch.setString(2, code);\n+                        batch.addBatch();\n+                        numToProcess++;\n                     }\n                 }\n-                if (errorCodes > 0) {\n-                    String msg = \"at least one of the Paramater Name/Codes are not populated [\" + errorCodes + \"]\";\n-                    LOGGER.severe(msg);\n-                    throw new IllegalArgumentException(msg);\n+\n+                // Only execute with num to process\n+                if (numToProcess > 0) {\n+                    // Check Error Codes.\n+                    int[] codes = batch.executeBatch();\n+                    int errorCodes = 0;\n+                    for (int code : codes) {\n+                        if (code < 0) {\n+                            errorCodes++;\n+                        }\n+                    }\n+                    if (errorCodes > 0) {\n+                        String msg = \"at least one of the Paramater Name/Codes are not populated [\" + errorCodes + \"]\";", "originalCommit": "32387a03fd17259da346bf0f1fa6b4efa8686e81", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fd6ee0573822ed84ae875143e04f783c12854f49", "chunk": "diff --git a/fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/PopulateParameterNames.java b/fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/PopulateParameterNames.java\nindex 85331e748a..22c1a663ea 100644\n--- a/fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/PopulateParameterNames.java\n+++ b/fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/PopulateParameterNames.java\n\n@@ -95,7 +95,7 @@ public class PopulateParameterNames implements IDatabaseStatement {\n                     Integer curVal = Integer.parseInt((String) valueEntry.getValue());\n                     String code = (String) valueEntry.getKey();\n \n-                    if (values.containsKey(code)) {\n+                    if (!values.containsKey(code)) {\n                         batch.setLong(1, curVal);\n                         batch.setString(2, code);\n                         batch.addBatch();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYyNzY2MQ==", "url": "https://github.com/IBM/FHIR/pull/1687#discussion_r520627661", "bodyText": "Shouldn't this be\n   if (!values.containsKey(code))", "author": "punktilious", "createdAt": "2020-11-10T14:58:30Z", "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/PopulateParameterNames.java", "diffHunk": "@@ -76,26 +90,34 @@ public void run(IDatabaseTranslator translator, Connection c) {\n                 Properties props = new Properties();\n                 props.load(fis);\n \n+                int numToProcess = 0;\n                 for (Entry<Object, Object> valueEntry : props.entrySet()) {\n                     Integer curVal = Integer.parseInt((String) valueEntry.getValue());\n                     String code = (String) valueEntry.getKey();\n-                    batch.setLong(1, curVal);\n-                    batch.setString(2, code);\n-                    batch.addBatch();\n-                }\n \n-                // Check Error Codes.\n-                int[] codes = batch.executeBatch();\n-                int errorCodes = 0;\n-                for (int code : codes) {\n-                    if (code < 0) {\n-                        errorCodes++;\n+                    if (values.containsKey(code)) {", "originalCommit": "32387a03fd17259da346bf0f1fa6b4efa8686e81", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYzNzQ2OQ==", "url": "https://github.com/IBM/FHIR/pull/1687#discussion_r520637469", "bodyText": "Yes! eagle eyes", "author": "prb112", "createdAt": "2020-11-10T15:11:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYyNzY2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "fd6ee0573822ed84ae875143e04f783c12854f49", "chunk": "diff --git a/fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/PopulateParameterNames.java b/fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/PopulateParameterNames.java\nindex 85331e748a..22c1a663ea 100644\n--- a/fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/PopulateParameterNames.java\n+++ b/fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/PopulateParameterNames.java\n\n@@ -95,7 +95,7 @@ public class PopulateParameterNames implements IDatabaseStatement {\n                     Integer curVal = Integer.parseInt((String) valueEntry.getValue());\n                     String code = (String) valueEntry.getKey();\n \n-                    if (values.containsKey(code)) {\n+                    if (!values.containsKey(code)) {\n                         batch.setLong(1, curVal);\n                         batch.setString(2, code);\n                         batch.addBatch();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYyODEyNg==", "url": "https://github.com/IBM/FHIR/pull/1687#discussion_r520628126", "bodyText": "Shouldn't this be\n   if (!values.containsKey(code))", "author": "punktilious", "createdAt": "2020-11-10T14:59:03Z", "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/PopulateResourceTypes.java", "diffHunk": "@@ -66,26 +82,34 @@ public void run(IDatabaseTranslator translator, Connection c) {\n                 Properties props = new Properties();\n                 props.load(fis);\n \n+                int numToProcess = 0;\n                 for (Entry<Object, Object> valueEntry : props.entrySet()) {\n                     Integer curVal = Integer.parseInt((String) valueEntry.getValue());\n                     String resource = (String) valueEntry.getKey();\n-                    batch.setInt(1, curVal);\n-                    batch.setString(2, resource);\n-                    batch.addBatch();\n-                }\n \n-                // Check Error Codes.\n-                int[] codes = batch.executeBatch();\n-                int errorCodes = 0;\n-                for (int code : codes) {\n-                    if (code < 0) {\n-                        errorCodes++;\n+                    if (values.containsKey(resource)) {", "originalCommit": "32387a03fd17259da346bf0f1fa6b4efa8686e81", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYzMTgxMA==", "url": "https://github.com/IBM/FHIR/pull/1687#discussion_r520631810", "bodyText": "ack... how did this work locally... I'll fix this up", "author": "prb112", "createdAt": "2020-11-10T15:03:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYyODEyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYzNzY0Nw==", "url": "https://github.com/IBM/FHIR/pull/1687#discussion_r520637647", "bodyText": "Eagle Eyes again! thank you", "author": "prb112", "createdAt": "2020-11-10T15:11:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYyODEyNg=="}], "type": "inlineReview", "revised_code": {"commit": "fd6ee0573822ed84ae875143e04f783c12854f49", "chunk": "diff --git a/fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/PopulateResourceTypes.java b/fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/PopulateResourceTypes.java\nindex dd32d81ae2..759882690e 100644\n--- a/fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/PopulateResourceTypes.java\n+++ b/fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/PopulateResourceTypes.java\n\n@@ -87,7 +87,7 @@ public class PopulateResourceTypes implements IDatabaseStatement {\n                     Integer curVal = Integer.parseInt((String) valueEntry.getValue());\n                     String resource = (String) valueEntry.getKey();\n \n-                    if (values.containsKey(resource)) {\n+                    if (!values.containsKey(resource)) {\n                         batch.setInt(1, curVal);\n                         batch.setString(2, resource);\n                         batch.addBatch();\n"}}, {"oid": "fd6ee0573822ed84ae875143e04f783c12854f49", "url": "https://github.com/IBM/FHIR/commit/fd6ee0573822ed84ae875143e04f783c12854f49", "message": "fix: bad logic found in code review\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-11-10T15:12:17Z", "type": "commit"}]}