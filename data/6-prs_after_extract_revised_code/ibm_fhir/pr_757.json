{"pr_number": 757, "pr_title": "REST layer refactoring/cleanup", "pr_createdAt": "2020-03-04T19:59:57Z", "pr_url": "https://github.com/IBM/FHIR/pull/757", "timeline": [{"oid": "c874a52af917549e1cafa62cd15c4c004051473b", "url": "https://github.com/IBM/FHIR/commit/c874a52af917549e1cafa62cd15c4c004051473b", "message": "REST layer refactoring/cleanup\n\n1. added originalRequestUri to FHIRRequestContext\n2. set it from FHIRRestServletFilter\n3. use it from FHIRResource\n4. remove unused `queryString` parm from SearchUtil.parseQueryParameters\n\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-03-04T20:21:04Z", "type": "forcePushed"}, {"oid": "84f8a1daed1df1ce035f77dc0854ab213daf1d17", "url": "https://github.com/IBM/FHIR/commit/84f8a1daed1df1ce035f77dc0854ab213daf1d17", "message": "REST layer refactoring/cleanup\n\n1. added originalRequestUri to FHIRRequestContext\n2. set it from FHIRRestServletFilter\n3. use it from FHIRResource\n4. remove unused `queryString` parm from SearchUtil.parseQueryParameters\n\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-03-04T20:40:25Z", "type": "commit"}, {"oid": "84f8a1daed1df1ce035f77dc0854ab213daf1d17", "url": "https://github.com/IBM/FHIR/commit/84f8a1daed1df1ce035f77dc0854ab213daf1d17", "message": "REST layer refactoring/cleanup\n\n1. added originalRequestUri to FHIRRequestContext\n2. set it from FHIRRestServletFilter\n3. use it from FHIRResource\n4. remove unused `queryString` parm from SearchUtil.parseQueryParameters\n\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-03-04T20:40:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk0MjM3OQ==", "url": "https://github.com/IBM/FHIR/pull/757#discussion_r387942379", "bodyText": "After our earlier discussion, this is only called once? or does it synchronize across multiple requests, I could see this being slow unintentionally.", "author": "prb112", "createdAt": "2020-03-04T21:23:16Z", "path": "fhir-server/src/main/java/com/ibm/fhir/server/resources/FHIRResource.java", "diffHunk": "@@ -3560,10 +3561,9 @@ private String serializeOperationOutcome(OperationOutcome oo) {\n         }\n     }\n \n-    private synchronized CapabilityStatement getCapabilityStatement() throws Exception {\n+    private synchronized CapabilityStatement getCapabilityStatement() throws FHIROperationException {", "originalCommit": "84f8a1daed1df1ce035f77dc0854ab213daf1d17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk1MDUxMw==", "url": "https://github.com/IBM/FHIR/pull/757#discussion_r387950513", "bodyText": "I don't think this comment is really related to this change.  getCapabilityStatement was (and still is) called on each metadata request and thats what we have #734 for", "author": "lmsurpre", "createdAt": "2020-03-04T21:40:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk0MjM3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk1MTM3Mg==", "url": "https://github.com/IBM/FHIR/pull/757#discussion_r387951372", "bodyText": "yeah ... I'm just wondering if we're injecting a pause with the synchronized when two threads are trying to generate it", "author": "prb112", "createdAt": "2020-03-04T21:42:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk0MjM3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk1MTQzOQ==", "url": "https://github.com/IBM/FHIR/pull/757#discussion_r387951439", "bodyText": "No need to resolve here", "author": "prb112", "createdAt": "2020-03-04T21:42:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk0MjM3OQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk0Mjc2MQ==", "url": "https://github.com/IBM/FHIR/pull/757#discussion_r387942761", "bodyText": "are you actually serializing this class?  best to generate it not use 1l.", "author": "prb112", "createdAt": "2020-03-04T21:23:59Z", "path": "fhir-server/src/main/java/com/ibm/fhir/server/filter/rest/FHIRRestServletFilter.java", "diffHunk": "@@ -39,54 +41,54 @@\n /**\n  * This class is a servlet filter which is registered with the REST API's servlet. The main purpose of the class is to\n  * log entry/exit information and elapsed time for each REST API request processed by the server.\n- * \n- * @author padams\n  */\n-public class FHIRRestServletFilter implements Filter {\n+public class FHIRRestServletFilter extends HttpFilter {\n+    private static final long serialVersionUID = 1L;", "originalCommit": "84f8a1daed1df1ce035f77dc0854ab213daf1d17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk1MDkyNg==", "url": "https://github.com/IBM/FHIR/pull/757#discussion_r387950926", "bodyText": "I am not, it was just to make eclipse not complain about missing it (apparently HttpFilter is serializable whereas Filter was not)", "author": "lmsurpre", "createdAt": "2020-03-04T21:41:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk0Mjc2MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk0MzM4MA==", "url": "https://github.com/IBM/FHIR/pull/757#discussion_r387943380", "bodyText": "Totally agree with this change!", "author": "prb112", "createdAt": "2020-03-04T21:25:21Z", "path": "fhir-server/src/main/java/com/ibm/fhir/server/filter/rest/FHIRRestServletFilter.java", "diffHunk": "@@ -100,56 +102,33 @@ public void doFilter(ServletRequest request, ServletResponse response, FilterCha\n         requestDescription.append(\"] method:[\");\n         requestDescription.append(getRequestMethod(request));\n         requestDescription.append(\"] uri:[\");\n-        requestDescription.append(getRequestURL(request));\n-        final String encodedRequestDescription = Encode.forHtml(requestDescription.toString());\n-\n+        requestDescription.append(requestUrl);\n+        if (!requestUrl.equals(originalRequestUri)) {\n+            requestDescription.append(\"] originalUri:[\");\n+            requestDescription.append(originalRequestUri);\n+        }\n+        requestDescription.append(\"]\");\n+        String encodedRequestDescription = Encode.forHtml(requestDescription.toString());\n         log.info(\"Received request: \" + encodedRequestDescription);\n-        \n+\n         try {\n             // Create a new FHIRRequestContext and set it on the current thread.\n             FHIRRequestContext context = new FHIRRequestContext(tenantId, dsId);\n             FHIRRequestContext.set(context);\n-            \n+\n+            context.setOriginalRequestUri(originalRequestUri);\n+\n             // Set the handling preference.\n-            HTTPHandlingPreference handlingPref = HTTPHandlingPreference.from(FHIRConfigHelper.getStringProperty(FHIRConfiguration.PROPERTY_DEFAULT_HANDLING, \"strict\"));\n-            boolean allowClientHandlingPref = FHIRConfigHelper.getBooleanProperty(FHIRConfiguration.PROPERTY_ALLOW_CLIENT_HANDLING_PREF, true);\n-            if (allowClientHandlingPref) {\n-                String handlingPrefString = ((HttpServletRequest) request).getHeader(preferHeaderName + \":\" + preferHandlingHeaderSectionName);\n-                if (handlingPrefString != null && !handlingPrefString.isEmpty()) {\n-                    try {\n-                        handlingPref = HTTPHandlingPreference.from(handlingPrefString);\n-                    } catch (IllegalArgumentException e) {\n-                        String message = \"Invalid HTTP handling preference passed in header 'Prefer': '\" + handlingPrefString + \"'\";\n-                        if (handlingPref == HTTPHandlingPreference.STRICT) {\n-                            throw new FHIRException(message + \"; use 'strict' or 'lenient'.\");\n-                        } else {\n-                            log.fine(message + \"; using \" + handlingPref.value() + \".\");\n-                        }\n-                    }\n-                }\n-            }\n-            FHIRRequestContext.get().setHandlingPreference(handlingPref);\n+            HTTPHandlingPreference handlingPref = computeHandlingPref(request);\n+            context.setHandlingPreference(handlingPref);\n \n             // Set the return preference.\n-            HTTPReturnPreference returnPref = defaultHttpReturnPref;\n-            String returnPrefString = ((HttpServletRequest) request).getHeader(preferHeaderName + \":\" + preferReturnHeaderSectionName);\n-            if (returnPrefString != null && !returnPrefString.isEmpty()) {\n-                try {\n-                    returnPref = HTTPReturnPreference.from(returnPrefString);\n-                } catch (IllegalArgumentException e) {\n-                    String message = \"Invalid HTTP return preference passed in header 'Prefer': '\" + returnPrefString + \"'\";\n-                    if (handlingPref == HTTPHandlingPreference.STRICT) {\n-                        throw new FHIRException(message + \"; use 'minimal', 'representation' or 'OperationOutcome'.\");\n-                    } else {\n-                        log.fine(message + \"; using \" + returnPref.value() + \".\");\n-                    }\n-                }\n-            }\n-            FHIRRequestContext.get().setReturnPreference(returnPref);\n+            HTTPReturnPreference returnPref = computeReturnPref(request, handlingPref);\n+            context.setReturnPreference(returnPref);\n \n             // Pass the request through to the next filter in the chain.\n             chain.doFilter(request, response);\n-        } catch (FHIRException e) {\n+        } catch (Exception e) {", "originalCommit": "84f8a1daed1df1ce035f77dc0854ab213daf1d17", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk0NDcxMg==", "url": "https://github.com/IBM/FHIR/pull/757#discussion_r387944712", "bodyText": "I thought Filters were stateless? ... so the reason I mention this...\nif the configuration changes, a server restart needs to be called to re-activate the init filter", "author": "prb112", "createdAt": "2020-03-04T21:28:10Z", "path": "fhir-server/src/main/java/com/ibm/fhir/server/filter/rest/FHIRRestServletFilter.java", "diffHunk": "@@ -39,54 +41,54 @@\n /**\n  * This class is a servlet filter which is registered with the REST API's servlet. The main purpose of the class is to\n  * log entry/exit information and elapsed time for each REST API request processed by the server.\n- * \n- * @author padams\n  */\n-public class FHIRRestServletFilter implements Filter {\n+public class FHIRRestServletFilter extends HttpFilter {\n+    private static final long serialVersionUID = 1L;\n+\n     private static final Logger log = Logger.getLogger(FHIRRestServletFilter.class.getName());\n \n     private static String tenantIdHeaderName = null;\n     private static String datastoreIdHeaderName = null;\n+    private static String originalRequestUriHeaderName = null;", "originalCommit": "84f8a1daed1df1ce035f77dc0854ab213daf1d17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk0NDgzMQ==", "url": "https://github.com/IBM/FHIR/pull/757#discussion_r387944831", "bodyText": "maybe document that behavior?", "author": "prb112", "createdAt": "2020-03-04T21:28:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk0NDcxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk1MTU0NQ==", "url": "https://github.com/IBM/FHIR/pull/757#discussion_r387951545", "bodyText": "added to section 5.1.3 of the userguide", "author": "lmsurpre", "createdAt": "2020-03-04T21:42:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk0NDcxMg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "b3d64beb4b27d64800d4c6278cbc432ab0190d5b", "url": "https://github.com/IBM/FHIR/commit/b3d64beb4b27d64800d4c6278cbc432ab0190d5b", "message": "update userguide to show originalRequestUriHeaderName is not dynamic\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-03-04T21:38:32Z", "type": "commit"}, {"oid": "2d79ae5a6c18c5a80cc5b39287e42078ce343cea", "url": "https://github.com/IBM/FHIR/commit/2d79ae5a6c18c5a80cc5b39287e42078ce343cea", "message": "Actually use FHIRRequestContext.getOriginalRequestUri\n\nIn the previous commits, I added `originalRequestUri` to the FHIRRequestContext so that we don't need to keep recomputing it.\r\nI meant to also start using that from FHIRResource, but I must have missed that change.\r\n\r\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-03-04T21:57:51Z", "type": "commit"}]}