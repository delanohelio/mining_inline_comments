{"pr_number": 1610, "pr_title": "issue #1272 - use new config approach while applying search param filter", "pr_createdAt": "2020-10-20T19:09:25Z", "pr_url": "https://github.com/IBM/FHIR/pull/1610", "timeline": [{"oid": "48191e5a36501cc9f93569a2d89fbeaf65b891fc", "url": "https://github.com/IBM/FHIR/commit/48191e5a36501cc9f93569a2d89fbeaf65b891fc", "message": "issue #1272 - use new config approach while applying search param filter\n\nalso added security to the db2 and postgres sample configs\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-10-20T19:12:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc3NzE0OQ==", "url": "https://github.com/IBM/FHIR/pull/1610#discussion_r508777149", "bodyText": "had a hard time deciding whether this should be info-level or fine-level. opted for info-level since this behavior is new.\nthe issue with this is that we'll see these messages on each and every request that involves search parameters like this.", "author": "lmsurpre", "createdAt": "2020-10-20T19:15:04Z", "path": "fhir-search/src/main/java/com/ibm/fhir/search/util/SearchUtil.java", "diffHunk": "@@ -270,19 +270,25 @@ public static void init() {\n         // If we found a non-empty list of search parameter names to filter on,\n         // then do the filtering. Otherwise, we're just going to return an empty list.\n         if (includedSPs != null && !includedSPs.isEmpty()) {\n-            // If \"*\" is contained in the included SP urls, then we can just return the unfiltered list\n-            // now, since everything in the list will be included anyway.\n-            if (includedSPs.contains(SearchConstants.WILDCARD_FILTER)) {\n-                return unfilteredSearchParameters;\n-            }\n+            boolean includeAll = includedSPs.containsKey(SearchConstants.WILDCARD_FILTER);\n \n-            // Otherwise, we'll walk through the unfiltered list and select the ones to be\n-            // included in our result.\n-            else {\n-                for (SearchParameter sp : unfilteredSearchParameters) {\n+            // Walk through the unfiltered list and select the ones to be included in our result.\n+            for (SearchParameter sp : unfilteredSearchParameters) {\n+                String code = sp.getCode().getValue();\n+                String url = sp.getUrl().getValue();\n \n-                    String url = sp.getUrl().getValue();\n-                    if (includedSPs.contains(url)) {\n+                if (includedSPs.containsKey(code)) {\n+                    if (includedSPs.get(code).equals(url)) {\n+                        results.add(sp);\n+                    } else {\n+                        log.info(\"Skipping search parameter with id='\" + sp.getId() + \"'. \"", "originalCommit": "48191e5a36501cc9f93569a2d89fbeaf65b891fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI3NDg5Mw==", "url": "https://github.com/IBM/FHIR/pull/1610#discussion_r509274893", "bodyText": "Question:\nExecuted on every search? if so, I'd say isLogLevel(fine)\nIf it's not, I'd say it's fine.", "author": "prb112", "createdAt": "2020-10-21T13:22:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc3NzE0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTMzNDc1OQ==", "url": "https://github.com/IBM/FHIR/pull/1610#discussion_r509334759", "bodyText": "I think it is executed for each search that targets a resource type with filtered parameters which match one of multiple possible target ids.  With our default config, we should never hit this.  The main motivator for keeping it info-level is that I think this will be the only log message you will get if you make an error while specifying the search parameter url in the config (so I don't want to hide that).\nIn the future, I think there is room for improving how we handle these search parameter filters.  For example, if we don't care about allowing dynamic updates to the config, we could check for all tenant configs during startup and validate the urls while we build a tenant-specific ParametersMap.", "author": "lmsurpre", "createdAt": "2020-10-21T14:26:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc3NzE0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTMzNTI1Nw==", "url": "https://github.com/IBM/FHIR/pull/1610#discussion_r509335257", "bodyText": "Discussed with Paul and we think info level is ok for now given the above.", "author": "lmsurpre", "createdAt": "2020-10-21T14:27:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc3NzE0OQ=="}], "type": "inlineReview", "revised_code": {"commit": "b1a569c5cf45dfe8265117a0cf167b155f5675db", "chunk": "diff --git a/fhir-search/src/main/java/com/ibm/fhir/search/util/SearchUtil.java b/fhir-search/src/main/java/com/ibm/fhir/search/util/SearchUtil.java\nindex f72d75f8bc..ef1d76724d 100644\n--- a/fhir-search/src/main/java/com/ibm/fhir/search/util/SearchUtil.java\n+++ b/fhir-search/src/main/java/com/ibm/fhir/search/util/SearchUtil.java\n\n@@ -278,7 +278,8 @@ public class SearchUtil {\n                 String url = sp.getUrl().getValue();\n \n                 if (includedSPs.containsKey(code)) {\n-                    if (includedSPs.get(code).equals(url)) {\n+                    String configuredUrl = includedSPs.get(code);\n+                    if (configuredUrl != null && configuredUrl.equals(url)) {\n                         results.add(sp);\n                     } else {\n                         log.info(\"Skipping search parameter with id='\" + sp.getId() + \"'. \"\n"}}, {"oid": "b1a569c5cf45dfe8265117a0cf167b155f5675db", "url": "https://github.com/IBM/FHIR/commit/b1a569c5cf45dfe8265117a0cf167b155f5675db", "message": "issue #1272 - use new config approach while applying search param filter\n\nalso added security to the db2 and postgres sample configs\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-10-20T19:22:10Z", "type": "commit"}, {"oid": "b1a569c5cf45dfe8265117a0cf167b155f5675db", "url": "https://github.com/IBM/FHIR/commit/b1a569c5cf45dfe8265117a0cf167b155f5675db", "message": "issue #1272 - use new config approach while applying search param filter\n\nalso added security to the db2 and postgres sample configs\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-10-20T19:22:10Z", "type": "forcePushed"}]}