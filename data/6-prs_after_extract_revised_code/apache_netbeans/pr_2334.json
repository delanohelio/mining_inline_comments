{"pr_number": 2334, "pr_title": "[NETBEANS-3986] Create new Class/Interface/Enum when copy-paste raw text", "pr_createdAt": "2020-08-28T07:57:34Z", "pr_url": "https://github.com/apache/netbeans/pull/2334", "timeline": [{"oid": "13d34cb114e41043c061f06ac9b834d540af2397", "url": "https://github.com/apache/netbeans/commit/13d34cb114e41043c061f06ac9b834d540af2397", "message": "[NETBEANS-3986] Create new Class/Interface/Enum on copy-paste raw text\nfrom clipboard", "committedDate": "2020-09-16T12:38:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc4MTE5MQ==", "url": "https://github.com/apache/netbeans/pull/2334#discussion_r491781191", "bodyText": "plz avoid hardcoded path", "author": "arusinha", "createdAt": "2020-09-21T03:41:33Z", "path": "java/java.project.ui/test/unit/src/org/netbeans/spi/java/project/support/ui/PackageViewTest.java", "diffHunk": "@@ -721,6 +724,121 @@ public void testCopyPaste () throws Exception {\n         }\n     }\n \n+    @RandomlyFails\n+    public void testCopyPasteJavaFileFromClipboard() throws Exception {\n+\n+        //Setup sourcegroups\n+        FileObject root1 = root.createFolder(\"paste-src\");\n+        SourceGroup group = new SimpleSourceGroup(root1);\n+        Node rn = PackageView.createPackageView(group);\n+        Node[] nodes = rn.getChildren().getNodes(true);\n+\n+        Clipboard clipboard = Toolkit.getDefaultToolkit().getSystemClipboard();\n+        StringSelection selection = new StringSelection(\"import java.util.*;\"\n+                + \"class C{}\"\n+                + \"public class PC{}\"\n+                + \"interface I{}\"\n+                + \"enum En{}\"\n+        );\n+        clipboard.setContents(selection, selection);\n+\n+        Transferable transferable = clipboard.getContents(selection);\n+        if (nodes.length > 0) {\n+            PasteType[] pts = nodes[0].getPasteTypes(transferable);\n+            pts[0].paste();\n+            FileObject[] files = nodes[0].getLookup().lookup(DataObject.class).getPrimaryFile().getChildren();\n+            assertEquals(\"File count\", 1, files.length);\n+            assertEquals(\"File name\", \"PC.java\", files[0].getName() + \".\" + files[0].getExt());\n+            assertEquals(\"File contents\",\"import java.util.*;\"\n+                    + \"class C{}\"\n+                    + \"public class PC{}\"\n+                    + \"interface I{}\"\n+                    + \"enum En{}\",\n+                     files[0].asText());\n+        }\n+\n+         for (Node n : nodes[0].getChildren().getNodes(true)) {\n+            DataObject dobj = n.getLookup().lookup(DataObject.class);\n+            if (dobj != null) {\n+                dobj.delete();\n+            }\n+        }\n+\n+    }\n+\n+    @RandomlyFails\n+    public void testCopyPasteJavaFileFromClipboard_removeExistingPackageName() throws Exception {\n+\n+        //Setup sourcegroups\n+        FileObject root1 = root.createFolder(\"paste-src-rm-package\");\n+        SourceGroup group = new SimpleSourceGroup(root1);\n+        Node rn = PackageView.createPackageView(group);\n+        Node[] nodes = rn.getChildren().getNodes(true);\n+\n+        Clipboard clipboard = Toolkit.getDefaultToolkit().getSystemClipboard();\n+        StringSelection selection = new StringSelection(\"package copy.paste     .\"\n+                + \"java\"\n+                + \";\"\n+                + \"import java.util.*;\"\n+                + \"public class PC{}\"\n+        );\n+        clipboard.setContents(selection, selection);\n+\n+        Transferable transferable = clipboard.getContents(selection);\n+        if (nodes.length > 0) {\n+            PasteType[] pts = nodes[0].getPasteTypes(transferable);\n+            pts[0].paste();\n+            FileObject[] files = nodes[0].getLookup().lookup(DataObject.class).getPrimaryFile().getChildren();\n+            assertEquals(\"File count\", 1, files.length);\n+            assertEquals(\"File name\", \"PC.java\", files[0].getName() + \".\" + files[0].getExt());\n+            assertEquals(\"File contents\",\"import java.util.*;\"\n+                    + \"public class PC{}\",\n+                     files[0].asText());\n+        }\n+\n+         for (Node n : nodes[0].getChildren().getNodes(true)) {\n+            DataObject dobj = n.getLookup().lookup(DataObject.class);\n+            if (dobj != null) {\n+                dobj.delete();\n+            }\n+        }\n+\n+    }\n+\n+    @RandomlyFails\n+    public void testCopyPasteJavaFileFromClipboard_CompilationErrorInCode() throws Exception {\n+\n+        //Setup sourcegroups\n+        FileObject root1 = root.createFolder(\"paste-src-error\");\n+        SourceGroup group = new SimpleSourceGroup(root1);\n+        Node rn = PackageView.createPackageView(group);\n+        Node[] nodes = rn.getChildren().getNodes(true);\n+\n+        Clipboard clipboard = Toolkit.getDefaultToolkit().getSystemClipboard();\n+        StringSelection selection = new StringSelection(\"C:\\\\Program Files\\\\Java\\\\jdk-9.0.4\\\\bin\\\\ class Hello java.exe  \\\\\\\"-javaagent:\\\" +\\n\" +", "originalCommit": "13d34cb114e41043c061f06ac9b834d540af2397", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTgzOTE4MA==", "url": "https://github.com/apache/netbeans/pull/2334#discussion_r491839180", "bodyText": "addressed code review comments", "author": "singh-akhilesh", "createdAt": "2020-09-21T07:30:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc4MTE5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "8e482b9048ded66821f6518b53765898321e4565", "chunk": "diff --git a/java/java.project.ui/test/unit/src/org/netbeans/spi/java/project/support/ui/PackageViewTest.java b/java/java.project.ui/test/unit/src/org/netbeans/spi/java/project/support/ui/PackageViewTest.java\nindex bad1cf11cc..9dbdf75ed9 100644\n--- a/java/java.project.ui/test/unit/src/org/netbeans/spi/java/project/support/ui/PackageViewTest.java\n+++ b/java/java.project.ui/test/unit/src/org/netbeans/spi/java/project/support/ui/PackageViewTest.java\n\n@@ -764,6 +764,90 @@ public class PackageViewTest extends NbTestCase {\n             }\n         }\n \n+    }\n+    \n+     @RandomlyFails\n+    public void testCopyPasteJavaFileFromClipboard_createJavaFileForEnum() throws Exception {\n+\n+        //Setup sourcegroups\n+        FileObject root1 = root.createFolder(\"paste-src\");\n+        SourceGroup group = new SimpleSourceGroup(root1);\n+        Node rn = PackageView.createPackageView(group);\n+        Node[] nodes = rn.getChildren().getNodes(true);\n+\n+        Clipboard clipboard = Toolkit.getDefaultToolkit().getSystemClipboard();\n+        StringSelection selection = new StringSelection(\"import java.util.*;\"\n+                + \"class C{}\"\n+                + \"class PC{}\"\n+                + \"interface I{}\"\n+                + \"public enum En{}\"\n+        );\n+        clipboard.setContents(selection, selection);\n+\n+        Transferable transferable = clipboard.getContents(selection);\n+        if (nodes.length > 0) {\n+            PasteType[] pts = nodes[0].getPasteTypes(transferable);\n+            pts[0].paste();\n+            FileObject[] files = nodes[0].getLookup().lookup(DataObject.class).getPrimaryFile().getChildren();\n+            assertEquals(\"File count\", 1, files.length);\n+            assertEquals(\"File name\", \"En.java\", files[0].getName() + \".\" + files[0].getExt());\n+            assertEquals(\"File contents\",\"import java.util.*;\"\n+                    + \"class C{}\"\n+                    + \"class PC{}\"\n+                    + \"interface I{}\"\n+                    + \"public enum En{}\",\n+                     files[0].asText());\n+        }\n+\n+         for (Node n : nodes[0].getChildren().getNodes(true)) {\n+            DataObject dobj = n.getLookup().lookup(DataObject.class);\n+            if (dobj != null) {\n+                dobj.delete();\n+            }\n+        }\n+\n+    }\n+    \n+     @RandomlyFails\n+    public void testCopyPasteJavaFileFromClipboard_createJavaFileForInterface() throws Exception {\n+\n+        //Setup sourcegroups\n+        FileObject root1 = root.createFolder(\"paste-src\");\n+        SourceGroup group = new SimpleSourceGroup(root1);\n+        Node rn = PackageView.createPackageView(group);\n+        Node[] nodes = rn.getChildren().getNodes(true);\n+\n+        Clipboard clipboard = Toolkit.getDefaultToolkit().getSystemClipboard();\n+        StringSelection selection = new StringSelection(\"import java.util.*;\"\n+                + \"class C{}\"\n+                + \"class PC{}\"\n+                + \"public interface I{}\"\n+                + \"enum En{}\"\n+        );\n+        clipboard.setContents(selection, selection);\n+\n+        Transferable transferable = clipboard.getContents(selection);\n+        if (nodes.length > 0) {\n+            PasteType[] pts = nodes[0].getPasteTypes(transferable);\n+            pts[0].paste();\n+            FileObject[] files = nodes[0].getLookup().lookup(DataObject.class).getPrimaryFile().getChildren();\n+            assertEquals(\"File count\", 1, files.length);\n+            assertEquals(\"File name\", \"I.java\", files[0].getName() + \".\" + files[0].getExt());\n+            assertEquals(\"File contents\",\"import java.util.*;\"\n+                    + \"class C{}\"\n+                    + \"class PC{}\"\n+                    + \"public interface I{}\"\n+                    + \"enum En{}\",\n+                     files[0].asText());\n+        }\n+\n+         for (Node n : nodes[0].getChildren().getNodes(true)) {\n+            DataObject dobj = n.getLookup().lookup(DataObject.class);\n+            if (dobj != null) {\n+                dobj.delete();\n+            }\n+        }\n+\n     }\n \n     @RandomlyFails\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc4MTI5NA==", "url": "https://github.com/apache/netbeans/pull/2334#discussion_r491781294", "bodyText": "plz avoid hardcoded path", "author": "arusinha", "createdAt": "2020-09-21T03:42:06Z", "path": "java/java.project.ui/test/unit/src/org/netbeans/spi/java/project/support/ui/PackageViewTest.java", "diffHunk": "@@ -721,6 +724,121 @@ public void testCopyPaste () throws Exception {\n         }\n     }\n \n+    @RandomlyFails\n+    public void testCopyPasteJavaFileFromClipboard() throws Exception {\n+\n+        //Setup sourcegroups\n+        FileObject root1 = root.createFolder(\"paste-src\");\n+        SourceGroup group = new SimpleSourceGroup(root1);\n+        Node rn = PackageView.createPackageView(group);\n+        Node[] nodes = rn.getChildren().getNodes(true);\n+\n+        Clipboard clipboard = Toolkit.getDefaultToolkit().getSystemClipboard();\n+        StringSelection selection = new StringSelection(\"import java.util.*;\"\n+                + \"class C{}\"\n+                + \"public class PC{}\"\n+                + \"interface I{}\"\n+                + \"enum En{}\"\n+        );\n+        clipboard.setContents(selection, selection);\n+\n+        Transferable transferable = clipboard.getContents(selection);\n+        if (nodes.length > 0) {\n+            PasteType[] pts = nodes[0].getPasteTypes(transferable);\n+            pts[0].paste();\n+            FileObject[] files = nodes[0].getLookup().lookup(DataObject.class).getPrimaryFile().getChildren();\n+            assertEquals(\"File count\", 1, files.length);\n+            assertEquals(\"File name\", \"PC.java\", files[0].getName() + \".\" + files[0].getExt());\n+            assertEquals(\"File contents\",\"import java.util.*;\"\n+                    + \"class C{}\"\n+                    + \"public class PC{}\"\n+                    + \"interface I{}\"\n+                    + \"enum En{}\",\n+                     files[0].asText());\n+        }\n+\n+         for (Node n : nodes[0].getChildren().getNodes(true)) {\n+            DataObject dobj = n.getLookup().lookup(DataObject.class);\n+            if (dobj != null) {\n+                dobj.delete();\n+            }\n+        }\n+\n+    }\n+\n+    @RandomlyFails\n+    public void testCopyPasteJavaFileFromClipboard_removeExistingPackageName() throws Exception {\n+\n+        //Setup sourcegroups\n+        FileObject root1 = root.createFolder(\"paste-src-rm-package\");\n+        SourceGroup group = new SimpleSourceGroup(root1);\n+        Node rn = PackageView.createPackageView(group);\n+        Node[] nodes = rn.getChildren().getNodes(true);\n+\n+        Clipboard clipboard = Toolkit.getDefaultToolkit().getSystemClipboard();\n+        StringSelection selection = new StringSelection(\"package copy.paste     .\"\n+                + \"java\"\n+                + \";\"\n+                + \"import java.util.*;\"\n+                + \"public class PC{}\"\n+        );\n+        clipboard.setContents(selection, selection);\n+\n+        Transferable transferable = clipboard.getContents(selection);\n+        if (nodes.length > 0) {\n+            PasteType[] pts = nodes[0].getPasteTypes(transferable);\n+            pts[0].paste();\n+            FileObject[] files = nodes[0].getLookup().lookup(DataObject.class).getPrimaryFile().getChildren();\n+            assertEquals(\"File count\", 1, files.length);\n+            assertEquals(\"File name\", \"PC.java\", files[0].getName() + \".\" + files[0].getExt());\n+            assertEquals(\"File contents\",\"import java.util.*;\"\n+                    + \"public class PC{}\",\n+                     files[0].asText());\n+        }\n+\n+         for (Node n : nodes[0].getChildren().getNodes(true)) {\n+            DataObject dobj = n.getLookup().lookup(DataObject.class);\n+            if (dobj != null) {\n+                dobj.delete();\n+            }\n+        }\n+\n+    }\n+\n+    @RandomlyFails\n+    public void testCopyPasteJavaFileFromClipboard_CompilationErrorInCode() throws Exception {\n+\n+        //Setup sourcegroups\n+        FileObject root1 = root.createFolder(\"paste-src-error\");\n+        SourceGroup group = new SimpleSourceGroup(root1);\n+        Node rn = PackageView.createPackageView(group);\n+        Node[] nodes = rn.getChildren().getNodes(true);\n+\n+        Clipboard clipboard = Toolkit.getDefaultToolkit().getSystemClipboard();\n+        StringSelection selection = new StringSelection(\"C:\\\\Program Files\\\\Java\\\\jdk-9.0.4\\\\bin\\\\ class Hello java.exe  \\\\\\\"-javaagent:\\\" +\\n\" +\n+                \"\\\"C:\\\\Program Files\\\\NB\\\\Community Edition 201.3803.71\\\\lib\\\\\");\n+        clipboard.setContents(selection, selection);\n+\n+        Transferable transferable = clipboard.getContents(selection);\n+        if (nodes.length > 0) {\n+            PasteType[] pts = nodes[0].getPasteTypes(transferable);\n+            pts[0].paste();\n+            FileObject[] files = nodes[0].getLookup().lookup(DataObject.class).getPrimaryFile().getChildren();\n+            assertEquals(\"File count\", 1, files.length);\n+            assertEquals(\"File name\", \"Hello.java\", files[0].getName() + \".\" + files[0].getExt());\n+            assertEquals(\"C:\\\\Program Files\\\\Java\\\\jdk-9.0.4\\\\bin\\\\ class Hello java.exe  \\\\\\\"-javaagent:\\\" +\\n\" +", "originalCommit": "13d34cb114e41043c061f06ac9b834d540af2397", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTgzOTI1MA==", "url": "https://github.com/apache/netbeans/pull/2334#discussion_r491839250", "bodyText": "addressed code review comments", "author": "singh-akhilesh", "createdAt": "2020-09-21T07:30:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc4MTI5NA=="}], "type": "inlineReview", "revised_code": {"commit": "8e482b9048ded66821f6518b53765898321e4565", "chunk": "diff --git a/java/java.project.ui/test/unit/src/org/netbeans/spi/java/project/support/ui/PackageViewTest.java b/java/java.project.ui/test/unit/src/org/netbeans/spi/java/project/support/ui/PackageViewTest.java\nindex bad1cf11cc..9dbdf75ed9 100644\n--- a/java/java.project.ui/test/unit/src/org/netbeans/spi/java/project/support/ui/PackageViewTest.java\n+++ b/java/java.project.ui/test/unit/src/org/netbeans/spi/java/project/support/ui/PackageViewTest.java\n\n@@ -764,6 +764,90 @@ public class PackageViewTest extends NbTestCase {\n             }\n         }\n \n+    }\n+    \n+     @RandomlyFails\n+    public void testCopyPasteJavaFileFromClipboard_createJavaFileForEnum() throws Exception {\n+\n+        //Setup sourcegroups\n+        FileObject root1 = root.createFolder(\"paste-src\");\n+        SourceGroup group = new SimpleSourceGroup(root1);\n+        Node rn = PackageView.createPackageView(group);\n+        Node[] nodes = rn.getChildren().getNodes(true);\n+\n+        Clipboard clipboard = Toolkit.getDefaultToolkit().getSystemClipboard();\n+        StringSelection selection = new StringSelection(\"import java.util.*;\"\n+                + \"class C{}\"\n+                + \"class PC{}\"\n+                + \"interface I{}\"\n+                + \"public enum En{}\"\n+        );\n+        clipboard.setContents(selection, selection);\n+\n+        Transferable transferable = clipboard.getContents(selection);\n+        if (nodes.length > 0) {\n+            PasteType[] pts = nodes[0].getPasteTypes(transferable);\n+            pts[0].paste();\n+            FileObject[] files = nodes[0].getLookup().lookup(DataObject.class).getPrimaryFile().getChildren();\n+            assertEquals(\"File count\", 1, files.length);\n+            assertEquals(\"File name\", \"En.java\", files[0].getName() + \".\" + files[0].getExt());\n+            assertEquals(\"File contents\",\"import java.util.*;\"\n+                    + \"class C{}\"\n+                    + \"class PC{}\"\n+                    + \"interface I{}\"\n+                    + \"public enum En{}\",\n+                     files[0].asText());\n+        }\n+\n+         for (Node n : nodes[0].getChildren().getNodes(true)) {\n+            DataObject dobj = n.getLookup().lookup(DataObject.class);\n+            if (dobj != null) {\n+                dobj.delete();\n+            }\n+        }\n+\n+    }\n+    \n+     @RandomlyFails\n+    public void testCopyPasteJavaFileFromClipboard_createJavaFileForInterface() throws Exception {\n+\n+        //Setup sourcegroups\n+        FileObject root1 = root.createFolder(\"paste-src\");\n+        SourceGroup group = new SimpleSourceGroup(root1);\n+        Node rn = PackageView.createPackageView(group);\n+        Node[] nodes = rn.getChildren().getNodes(true);\n+\n+        Clipboard clipboard = Toolkit.getDefaultToolkit().getSystemClipboard();\n+        StringSelection selection = new StringSelection(\"import java.util.*;\"\n+                + \"class C{}\"\n+                + \"class PC{}\"\n+                + \"public interface I{}\"\n+                + \"enum En{}\"\n+        );\n+        clipboard.setContents(selection, selection);\n+\n+        Transferable transferable = clipboard.getContents(selection);\n+        if (nodes.length > 0) {\n+            PasteType[] pts = nodes[0].getPasteTypes(transferable);\n+            pts[0].paste();\n+            FileObject[] files = nodes[0].getLookup().lookup(DataObject.class).getPrimaryFile().getChildren();\n+            assertEquals(\"File count\", 1, files.length);\n+            assertEquals(\"File name\", \"I.java\", files[0].getName() + \".\" + files[0].getExt());\n+            assertEquals(\"File contents\",\"import java.util.*;\"\n+                    + \"class C{}\"\n+                    + \"class PC{}\"\n+                    + \"public interface I{}\"\n+                    + \"enum En{}\",\n+                     files[0].asText());\n+        }\n+\n+         for (Node n : nodes[0].getChildren().getNodes(true)) {\n+            DataObject dobj = n.getLookup().lookup(DataObject.class);\n+            if (dobj != null) {\n+                dobj.delete();\n+            }\n+        }\n+\n     }\n \n     @RandomlyFails\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc4MTY2OA==", "url": "https://github.com/apache/netbeans/pull/2334#discussion_r491781668", "bodyText": "plz use //NOI18N for string literal. need to correct wherever used string literal", "author": "arusinha", "createdAt": "2020-09-21T03:44:45Z", "path": "java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java", "diffHunk": "@@ -0,0 +1,258 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.netbeans.spi.java.project.support.ui;\n+\n+import com.sun.source.tree.ClassTree;\n+import com.sun.source.tree.CompilationUnitTree;\n+import com.sun.source.tree.Tree;\n+import com.sun.source.util.JavacTask;\n+import java.awt.Toolkit;\n+import java.awt.datatransfer.Clipboard;\n+import java.awt.datatransfer.DataFlavor;\n+import java.awt.datatransfer.Transferable;\n+import java.awt.datatransfer.UnsupportedFlavorException;\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.util.Arrays;\n+import java.util.Set;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import javax.swing.JOptionPane;\n+import javax.tools.JavaCompiler;\n+import javax.tools.JavaFileObject;\n+import javax.tools.SimpleJavaFileObject;\n+import javax.tools.StandardJavaFileManager;\n+import javax.tools.ToolProvider;\n+import org.netbeans.api.java.classpath.ClassPath;\n+import org.netbeans.api.java.source.ClasspathInfo;\n+import org.netbeans.api.java.source.CompilationController;\n+import org.netbeans.api.java.source.CompilationInfo;\n+import org.netbeans.api.java.source.JavaSource;\n+import org.netbeans.api.java.source.Task;\n+import org.openide.filesystems.FileObject;\n+import org.openide.filesystems.FileUtil;\n+import org.openide.loaders.DataFolder;\n+import org.openide.util.Exceptions;\n+import org.openide.util.datatransfer.PasteType;\n+\n+/**\n+ *\n+ * @author aksinsin\n+ */\n+public class CreateJavaClassFileFromClipboard extends PasteType {\n+    \n+    private static final String PUBLIC_MODIFIER = \"public\";\n+\n+    private final DataFolder context;\n+    private final Transferable t;\n+\n+    public CreateJavaClassFileFromClipboard(DataFolder context, Transferable t) {\n+        this.context = context;\n+        this.t = t;\n+    }\n+\n+    @Override\n+    public Transferable paste() throws IOException {\n+        try {\n+            Clipboard c = Toolkit.getDefaultToolkit().getSystemClipboard();\n+            if (!c.isDataFlavorAvailable(DataFlavor.stringFlavor)) {\n+                return t;\n+            }\n+            String copiedData = (String) c.getData(DataFlavor.stringFlavor);\n+            CreateJavaClassFileFromClipboard.ClassContent classContent = extractPackageAndClassName(copiedData);\n+            if (classContent == null) {\n+                JOptionPane.showMessageDialog(null, \"Code not valid to create class\");\n+                return t;\n+            }\n+            Set<FileObject> files = this.context.files();\n+            if (files.size() != 1) {\n+                return t;\n+            }\n+            String path = files.iterator().next().getPath();\n+            File fileName = new File(path + File.separator + classContent.getClassName() + \".java\");\n+            if (fileName.exists()) {\n+                JOptionPane.showMessageDialog(null, \"Cannot create class already present\");\n+                return t;\n+            }\n+            if (!fileName.createNewFile()) {\n+                JOptionPane.showMessageDialog(null, \"Cannot create file\");\n+                return t;\n+            }\n+\n+            if (classContent.getPackageName() != null) {\n+                copiedData = removePackage(copiedData, classContent.getPackageName());\n+            }\n+            try (BufferedWriter bw = new BufferedWriter(new FileWriter(fileName))) {\n+                String packageLocation = getPackageNameFromFile(fileName);\n+                if (packageLocation != null && !packageLocation.isEmpty()) {\n+                    copiedData = \"package \" + packageLocation + \";\\n\" + copiedData;// NOI18N\n+                }\n+                bw.write(copiedData);\n+            }\n+\n+        } catch (UnsupportedFlavorException ex) {\n+            Exceptions.printStackTrace(ex);\n+        } catch (IOException ex) {\n+            Exceptions.printStackTrace(ex);\n+        }\n+        return t;\n+    }\n+    \n+    \n+     private static class DeadlockTask implements Task<CompilationController> {\n+\n+        JavaSource.Phase phase;\n+        CompilationInfo info;\n+\n+        public DeadlockTask(JavaSource.Phase phase) {\n+            assert phase != null;\n+            this.phase = phase;\n+        }\n+\n+        public void run(CompilationController info) {\n+            try {\n+                info.toPhase(this.phase);\n+                this.info = info;\n+            } catch (IOException ioe) {\n+            }\n+        }\n+\n+    }\n+\n+    private ClassContent extractPackageAndClassName(String copiedData) {\n+        JavaCompiler compiler = ToolProvider.getSystemJavaCompiler();\n+        StandardJavaFileManager fileManager = compiler.getStandardFileManager(null, null, null);\n+\n+        String publicFirstClassName = null;\n+        String nonPublicFirstClassName = null;\n+        String packageName = null;\n+        int counter = 0;\n+        JavaCompiler.CompilationTask task = compiler.getTask(null, fileManager, null, null, null, Arrays.asList(new MyFileObject(copiedData)));\n+        parse:\n+        try {\n+            for (CompilationUnitTree compilationUnitTree : ((JavacTask) task).parse()) {\n+                packageName = compilationUnitTree.getPackageName() != null\n+                        ? compilationUnitTree.getPackageName().toString() : null;\n+                for (Tree tree : compilationUnitTree.getTypeDecls()) {\n+                    if (tree instanceof ClassTree) {\n+                        final ClassTree classTree = (ClassTree) tree;\n+                        if (classTree.toString().trim().startsWith(PUBLIC_MODIFIER)) {\n+                            publicFirstClassName = classTree.getSimpleName().toString();\n+                            break parse;\n+                        }\n+                        if (counter == 0) {\n+                            nonPublicFirstClassName = classTree.getSimpleName().toString();\n+                            counter++;\n+                        }\n+                    }\n+                }\n+            }\n+        } catch (Exception ex) {\n+            Exceptions.printStackTrace(ex);\n+        } finally {\n+            try {\n+                fileManager.close();\n+            } catch (IOException ex) {\n+                Exceptions.printStackTrace(ex);\n+            }\n+        }\n+\n+        if (publicFirstClassName != null && !publicFirstClassName.equals(\"<error>\")) {\n+            return new ClassContent(publicFirstClassName, packageName);\n+        } else if (nonPublicFirstClassName != null && !nonPublicFirstClassName.equals(\"<error>\")) {\n+            return new ClassContent(nonPublicFirstClassName, packageName);\n+        } else {\n+            return null;\n+        }\n+\n+    }\n+\n+    private String removePackage(String copiedCode, String oldPacageName) {\n+        String packageRegex = oldPacageName.replace(\".\", \"\\\\s*.\\\\s*\");", "originalCommit": "13d34cb114e41043c061f06ac9b834d540af2397", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTgzOTI5Mg==", "url": "https://github.com/apache/netbeans/pull/2334#discussion_r491839292", "bodyText": "addressed code review comments", "author": "singh-akhilesh", "createdAt": "2020-09-21T07:30:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc4MTY2OA=="}], "type": "inlineReview", "revised_code": {"commit": "8e482b9048ded66821f6518b53765898321e4565", "chunk": "diff --git a/java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java b/java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java\nindex b9d8870419..566ab6e906 100644\n--- a/java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java\n+++ b/java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java\n\n@@ -60,7 +60,7 @@ import org.openide.util.datatransfer.PasteType;\n  */\n public class CreateJavaClassFileFromClipboard extends PasteType {\n     \n-    private static final String PUBLIC_MODIFIER = \"public\";\n+    private static final String PUBLIC_MODIFIER = \"public\"; //NOI18N\n \n     private final DataFolder context;\n     private final Transferable t;\n"}}, {"oid": "8e482b9048ded66821f6518b53765898321e4565", "url": "https://github.com/apache/netbeans/commit/8e482b9048ded66821f6518b53765898321e4565", "message": "[NETBEANS-3986] Create new Class/Interface/Enum on copy-paste raw text\nfrom clipboard", "committedDate": "2020-09-21T07:28:47Z", "type": "forcePushed"}, {"oid": "962aca488a3965d2b1ad1e0b475be1033d28489e", "url": "https://github.com/apache/netbeans/commit/962aca488a3965d2b1ad1e0b475be1033d28489e", "message": "[NETBEANS-3986] Create new Class/Interface/Enum on copy-paste raw text\nfrom clipboard", "committedDate": "2020-09-21T11:46:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA0ODc5MA==", "url": "https://github.com/apache/netbeans/pull/2334#discussion_r500048790", "bodyText": "It would be better to use DialogDisplayer.notify(Later) instead of JOptionPane (on all places):\nhttps://bits.netbeans.org/dev/javadoc/org-openide-dialogs/org/openide/DialogDisplayer.html#notifyLater-org.openide.NotifyDescriptor-\n(+something like @NbBundle.Messages(\"ERR_NotValidClass=Code is not a valid class\") and Bundle.ERR_NotValidClass().", "author": "lahodaj", "createdAt": "2020-10-06T07:04:20Z", "path": "java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java", "diffHunk": "@@ -0,0 +1,258 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.netbeans.spi.java.project.support.ui;\n+\n+import com.sun.source.tree.ClassTree;\n+import com.sun.source.tree.CompilationUnitTree;\n+import com.sun.source.tree.Tree;\n+import com.sun.source.util.JavacTask;\n+import java.awt.Toolkit;\n+import java.awt.datatransfer.Clipboard;\n+import java.awt.datatransfer.DataFlavor;\n+import java.awt.datatransfer.Transferable;\n+import java.awt.datatransfer.UnsupportedFlavorException;\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.util.Arrays;\n+import java.util.Set;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import javax.swing.JOptionPane;\n+import javax.tools.JavaCompiler;\n+import javax.tools.JavaFileObject;\n+import javax.tools.SimpleJavaFileObject;\n+import javax.tools.StandardJavaFileManager;\n+import javax.tools.ToolProvider;\n+import org.netbeans.api.java.classpath.ClassPath;\n+import org.netbeans.api.java.source.ClasspathInfo;\n+import org.netbeans.api.java.source.CompilationController;\n+import org.netbeans.api.java.source.CompilationInfo;\n+import org.netbeans.api.java.source.JavaSource;\n+import org.netbeans.api.java.source.Task;\n+import org.openide.filesystems.FileObject;\n+import org.openide.filesystems.FileUtil;\n+import org.openide.loaders.DataFolder;\n+import org.openide.util.Exceptions;\n+import org.openide.util.datatransfer.PasteType;\n+\n+/**\n+ *\n+ * @author aksinsin\n+ */\n+public class CreateJavaClassFileFromClipboard extends PasteType {\n+    \n+    private static final String PUBLIC_MODIFIER = \"public\"; //NOI18N\n+\n+    private final DataFolder context;\n+    private final Transferable t;\n+\n+    public CreateJavaClassFileFromClipboard(DataFolder context, Transferable t) {\n+        this.context = context;\n+        this.t = t;\n+    }\n+\n+    @Override\n+    public Transferable paste() throws IOException {\n+        try {\n+            Clipboard c = Toolkit.getDefaultToolkit().getSystemClipboard();\n+            if (!c.isDataFlavorAvailable(DataFlavor.stringFlavor)) {\n+                return t;\n+            }\n+            String copiedData = (String) c.getData(DataFlavor.stringFlavor);\n+            CreateJavaClassFileFromClipboard.ClassContent classContent = extractPackageAndClassName(copiedData);\n+            if (classContent == null) {\n+                JOptionPane.showMessageDialog(null, \"Code not valid to create class\"); //NOI18N", "originalCommit": "962aca488a3965d2b1ad1e0b475be1033d28489e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA4MzQ5NA==", "url": "https://github.com/apache/netbeans/pull/2334#discussion_r501083494", "bodyText": "Addressed code comment.\nUsed  @NbBundle.Messages({\n\"ERR_NotValidClass=Code is not a valid class\",\n\"ERR_ClassAlreadyPresent=Class {0} already present\",\n\"ERR_UnableToCreateFile=Unable to create file {0}\",}) for message bundling.\nand  DialogDisplayer.getDefault().notifyLater(notifyMsg); for displaying error dialog.", "author": "singh-akhilesh", "createdAt": "2020-10-07T14:59:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA0ODc5MA=="}], "type": "inlineReview", "revised_code": {"commit": "56f16fb193c9bb64aae4ece87b8269483936e0a4", "chunk": "diff --git a/java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java b/java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java\nindex 566ab6e906..d7e8ab8b90 100644\n--- a/java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java\n+++ b/java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java\n\n@@ -22,6 +22,8 @@ import com.sun.source.tree.ClassTree;\n import com.sun.source.tree.CompilationUnitTree;\n import com.sun.source.tree.Tree;\n import com.sun.source.util.JavacTask;\n+import com.sun.source.util.SourcePositions;\n+import com.sun.source.util.Trees;\n import java.awt.Toolkit;\n import java.awt.datatransfer.Clipboard;\n import java.awt.datatransfer.DataFlavor;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA0OTgyMg==", "url": "https://github.com/apache/netbeans/pull/2334#discussion_r500049822", "bodyText": "I think this class can be removed, see below. Please note that CompilationInfo is only valid while the task is running, and \"exporting\" it outside of the task is likely to lead to bad effects.", "author": "lahodaj", "createdAt": "2020-10-06T07:06:32Z", "path": "java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java", "diffHunk": "@@ -0,0 +1,258 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.netbeans.spi.java.project.support.ui;\n+\n+import com.sun.source.tree.ClassTree;\n+import com.sun.source.tree.CompilationUnitTree;\n+import com.sun.source.tree.Tree;\n+import com.sun.source.util.JavacTask;\n+import java.awt.Toolkit;\n+import java.awt.datatransfer.Clipboard;\n+import java.awt.datatransfer.DataFlavor;\n+import java.awt.datatransfer.Transferable;\n+import java.awt.datatransfer.UnsupportedFlavorException;\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.util.Arrays;\n+import java.util.Set;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import javax.swing.JOptionPane;\n+import javax.tools.JavaCompiler;\n+import javax.tools.JavaFileObject;\n+import javax.tools.SimpleJavaFileObject;\n+import javax.tools.StandardJavaFileManager;\n+import javax.tools.ToolProvider;\n+import org.netbeans.api.java.classpath.ClassPath;\n+import org.netbeans.api.java.source.ClasspathInfo;\n+import org.netbeans.api.java.source.CompilationController;\n+import org.netbeans.api.java.source.CompilationInfo;\n+import org.netbeans.api.java.source.JavaSource;\n+import org.netbeans.api.java.source.Task;\n+import org.openide.filesystems.FileObject;\n+import org.openide.filesystems.FileUtil;\n+import org.openide.loaders.DataFolder;\n+import org.openide.util.Exceptions;\n+import org.openide.util.datatransfer.PasteType;\n+\n+/**\n+ *\n+ * @author aksinsin\n+ */\n+public class CreateJavaClassFileFromClipboard extends PasteType {\n+    \n+    private static final String PUBLIC_MODIFIER = \"public\"; //NOI18N\n+\n+    private final DataFolder context;\n+    private final Transferable t;\n+\n+    public CreateJavaClassFileFromClipboard(DataFolder context, Transferable t) {\n+        this.context = context;\n+        this.t = t;\n+    }\n+\n+    @Override\n+    public Transferable paste() throws IOException {\n+        try {\n+            Clipboard c = Toolkit.getDefaultToolkit().getSystemClipboard();\n+            if (!c.isDataFlavorAvailable(DataFlavor.stringFlavor)) {\n+                return t;\n+            }\n+            String copiedData = (String) c.getData(DataFlavor.stringFlavor);\n+            CreateJavaClassFileFromClipboard.ClassContent classContent = extractPackageAndClassName(copiedData);\n+            if (classContent == null) {\n+                JOptionPane.showMessageDialog(null, \"Code not valid to create class\"); //NOI18N\n+                return t;\n+            }\n+            Set<FileObject> files = this.context.files();\n+            if (files.size() != 1) {\n+                return t;\n+            }\n+            String path = files.iterator().next().getPath();\n+            File fileName = new File(path + File.separator + classContent.getClassName() + \".java\"); //NOI18N\n+            if (fileName.exists()) {\n+                JOptionPane.showMessageDialog(null, \"Cannot create class already present\"); //NOI18N\n+                return t;\n+            }\n+            if (!fileName.createNewFile()) {\n+                JOptionPane.showMessageDialog(null, \"Cannot create file\"); //NOI18N\n+                return t;\n+            }\n+\n+            if (classContent.getPackageName() != null) {\n+                copiedData = removePackage(copiedData, classContent.getPackageName());\n+            }\n+            try (BufferedWriter bw = new BufferedWriter(new FileWriter(fileName))) {\n+                String packageLocation = getPackageNameFromFile(fileName);\n+                if (packageLocation != null && !packageLocation.isEmpty()) {\n+                    copiedData = \"package \" + packageLocation + \";\\n\" + copiedData;// NOI18N\n+                }\n+                bw.write(copiedData);\n+            }\n+\n+        } catch (UnsupportedFlavorException ex) {\n+            Exceptions.printStackTrace(ex);\n+        } catch (IOException ex) {\n+            Exceptions.printStackTrace(ex);\n+        }\n+        return t;\n+    }\n+    \n+    \n+     private static class DeadlockTask implements Task<CompilationController> {", "originalCommit": "962aca488a3965d2b1ad1e0b475be1033d28489e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA4NDg0MQ==", "url": "https://github.com/apache/netbeans/pull/2334#discussion_r501084841", "bodyText": "Addressed.\nRemoved this class DeadlockTask .", "author": "singh-akhilesh", "createdAt": "2020-10-07T15:01:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA0OTgyMg=="}], "type": "inlineReview", "revised_code": {"commit": "56f16fb193c9bb64aae4ece87b8269483936e0a4", "chunk": "diff --git a/java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java b/java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java\nindex 566ab6e906..d7e8ab8b90 100644\n--- a/java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java\n+++ b/java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java\n\n@@ -22,6 +22,8 @@ import com.sun.source.tree.ClassTree;\n import com.sun.source.tree.CompilationUnitTree;\n import com.sun.source.tree.Tree;\n import com.sun.source.util.JavacTask;\n+import com.sun.source.util.SourcePositions;\n+import com.sun.source.util.Trees;\n import java.awt.Toolkit;\n import java.awt.datatransfer.Clipboard;\n import java.awt.datatransfer.DataFlavor;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA1MDM3Nw==", "url": "https://github.com/apache/netbeans/pull/2334#discussion_r500050377", "bodyText": "Not sure if the file manager is needed here (passing null to getTask instead of a file manager should be fine). But if yes, please wrap it with try-with-resources, so that it is guaranteed to be closed.", "author": "lahodaj", "createdAt": "2020-10-06T07:07:48Z", "path": "java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java", "diffHunk": "@@ -0,0 +1,258 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.netbeans.spi.java.project.support.ui;\n+\n+import com.sun.source.tree.ClassTree;\n+import com.sun.source.tree.CompilationUnitTree;\n+import com.sun.source.tree.Tree;\n+import com.sun.source.util.JavacTask;\n+import java.awt.Toolkit;\n+import java.awt.datatransfer.Clipboard;\n+import java.awt.datatransfer.DataFlavor;\n+import java.awt.datatransfer.Transferable;\n+import java.awt.datatransfer.UnsupportedFlavorException;\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.util.Arrays;\n+import java.util.Set;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import javax.swing.JOptionPane;\n+import javax.tools.JavaCompiler;\n+import javax.tools.JavaFileObject;\n+import javax.tools.SimpleJavaFileObject;\n+import javax.tools.StandardJavaFileManager;\n+import javax.tools.ToolProvider;\n+import org.netbeans.api.java.classpath.ClassPath;\n+import org.netbeans.api.java.source.ClasspathInfo;\n+import org.netbeans.api.java.source.CompilationController;\n+import org.netbeans.api.java.source.CompilationInfo;\n+import org.netbeans.api.java.source.JavaSource;\n+import org.netbeans.api.java.source.Task;\n+import org.openide.filesystems.FileObject;\n+import org.openide.filesystems.FileUtil;\n+import org.openide.loaders.DataFolder;\n+import org.openide.util.Exceptions;\n+import org.openide.util.datatransfer.PasteType;\n+\n+/**\n+ *\n+ * @author aksinsin\n+ */\n+public class CreateJavaClassFileFromClipboard extends PasteType {\n+    \n+    private static final String PUBLIC_MODIFIER = \"public\"; //NOI18N\n+\n+    private final DataFolder context;\n+    private final Transferable t;\n+\n+    public CreateJavaClassFileFromClipboard(DataFolder context, Transferable t) {\n+        this.context = context;\n+        this.t = t;\n+    }\n+\n+    @Override\n+    public Transferable paste() throws IOException {\n+        try {\n+            Clipboard c = Toolkit.getDefaultToolkit().getSystemClipboard();\n+            if (!c.isDataFlavorAvailable(DataFlavor.stringFlavor)) {\n+                return t;\n+            }\n+            String copiedData = (String) c.getData(DataFlavor.stringFlavor);\n+            CreateJavaClassFileFromClipboard.ClassContent classContent = extractPackageAndClassName(copiedData);\n+            if (classContent == null) {\n+                JOptionPane.showMessageDialog(null, \"Code not valid to create class\"); //NOI18N\n+                return t;\n+            }\n+            Set<FileObject> files = this.context.files();\n+            if (files.size() != 1) {\n+                return t;\n+            }\n+            String path = files.iterator().next().getPath();\n+            File fileName = new File(path + File.separator + classContent.getClassName() + \".java\"); //NOI18N\n+            if (fileName.exists()) {\n+                JOptionPane.showMessageDialog(null, \"Cannot create class already present\"); //NOI18N\n+                return t;\n+            }\n+            if (!fileName.createNewFile()) {\n+                JOptionPane.showMessageDialog(null, \"Cannot create file\"); //NOI18N\n+                return t;\n+            }\n+\n+            if (classContent.getPackageName() != null) {\n+                copiedData = removePackage(copiedData, classContent.getPackageName());\n+            }\n+            try (BufferedWriter bw = new BufferedWriter(new FileWriter(fileName))) {\n+                String packageLocation = getPackageNameFromFile(fileName);\n+                if (packageLocation != null && !packageLocation.isEmpty()) {\n+                    copiedData = \"package \" + packageLocation + \";\\n\" + copiedData;// NOI18N\n+                }\n+                bw.write(copiedData);\n+            }\n+\n+        } catch (UnsupportedFlavorException ex) {\n+            Exceptions.printStackTrace(ex);\n+        } catch (IOException ex) {\n+            Exceptions.printStackTrace(ex);\n+        }\n+        return t;\n+    }\n+    \n+    \n+     private static class DeadlockTask implements Task<CompilationController> {\n+\n+        JavaSource.Phase phase;\n+        CompilationInfo info;\n+\n+        public DeadlockTask(JavaSource.Phase phase) {\n+            assert phase != null;\n+            this.phase = phase;\n+        }\n+\n+        public void run(CompilationController info) {\n+            try {\n+                info.toPhase(this.phase);\n+                this.info = info;\n+            } catch (IOException ioe) {\n+            }\n+        }\n+\n+    }\n+\n+    private ClassContent extractPackageAndClassName(String copiedData) {\n+        JavaCompiler compiler = ToolProvider.getSystemJavaCompiler();\n+        StandardJavaFileManager fileManager = compiler.getStandardFileManager(null, null, null);", "originalCommit": "962aca488a3965d2b1ad1e0b475be1033d28489e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA4NjM4MA==", "url": "https://github.com/apache/netbeans/pull/2334#discussion_r501086380", "bodyText": "Addressed.\nYou are correct file manager is not needed in this case. So removed file manager passed null in compiler.getTask.", "author": "singh-akhilesh", "createdAt": "2020-10-07T15:03:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA1MDM3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "56f16fb193c9bb64aae4ece87b8269483936e0a4", "chunk": "diff --git a/java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java b/java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java\nindex 566ab6e906..d7e8ab8b90 100644\n--- a/java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java\n+++ b/java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java\n\n@@ -22,6 +22,8 @@ import com.sun.source.tree.ClassTree;\n import com.sun.source.tree.CompilationUnitTree;\n import com.sun.source.tree.Tree;\n import com.sun.source.util.JavacTask;\n+import com.sun.source.util.SourcePositions;\n+import com.sun.source.util.Trees;\n import java.awt.Toolkit;\n import java.awt.datatransfer.Clipboard;\n import java.awt.datatransfer.DataFlavor;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA1MTQxMA==", "url": "https://github.com/apache/netbeans/pull/2334#discussion_r500051410", "bodyText": "Please check this work both with and without nb-javac (there are some special cases for nb-javac, so to be sure).", "author": "lahodaj", "createdAt": "2020-10-06T07:10:03Z", "path": "java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java", "diffHunk": "@@ -0,0 +1,258 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.netbeans.spi.java.project.support.ui;\n+\n+import com.sun.source.tree.ClassTree;\n+import com.sun.source.tree.CompilationUnitTree;\n+import com.sun.source.tree.Tree;\n+import com.sun.source.util.JavacTask;\n+import java.awt.Toolkit;\n+import java.awt.datatransfer.Clipboard;\n+import java.awt.datatransfer.DataFlavor;\n+import java.awt.datatransfer.Transferable;\n+import java.awt.datatransfer.UnsupportedFlavorException;\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.util.Arrays;\n+import java.util.Set;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import javax.swing.JOptionPane;\n+import javax.tools.JavaCompiler;\n+import javax.tools.JavaFileObject;\n+import javax.tools.SimpleJavaFileObject;\n+import javax.tools.StandardJavaFileManager;\n+import javax.tools.ToolProvider;\n+import org.netbeans.api.java.classpath.ClassPath;\n+import org.netbeans.api.java.source.ClasspathInfo;\n+import org.netbeans.api.java.source.CompilationController;\n+import org.netbeans.api.java.source.CompilationInfo;\n+import org.netbeans.api.java.source.JavaSource;\n+import org.netbeans.api.java.source.Task;\n+import org.openide.filesystems.FileObject;\n+import org.openide.filesystems.FileUtil;\n+import org.openide.loaders.DataFolder;\n+import org.openide.util.Exceptions;\n+import org.openide.util.datatransfer.PasteType;\n+\n+/**\n+ *\n+ * @author aksinsin\n+ */\n+public class CreateJavaClassFileFromClipboard extends PasteType {\n+    \n+    private static final String PUBLIC_MODIFIER = \"public\"; //NOI18N\n+\n+    private final DataFolder context;\n+    private final Transferable t;\n+\n+    public CreateJavaClassFileFromClipboard(DataFolder context, Transferable t) {\n+        this.context = context;\n+        this.t = t;\n+    }\n+\n+    @Override\n+    public Transferable paste() throws IOException {\n+        try {\n+            Clipboard c = Toolkit.getDefaultToolkit().getSystemClipboard();\n+            if (!c.isDataFlavorAvailable(DataFlavor.stringFlavor)) {\n+                return t;\n+            }\n+            String copiedData = (String) c.getData(DataFlavor.stringFlavor);\n+            CreateJavaClassFileFromClipboard.ClassContent classContent = extractPackageAndClassName(copiedData);\n+            if (classContent == null) {\n+                JOptionPane.showMessageDialog(null, \"Code not valid to create class\"); //NOI18N\n+                return t;\n+            }\n+            Set<FileObject> files = this.context.files();\n+            if (files.size() != 1) {\n+                return t;\n+            }\n+            String path = files.iterator().next().getPath();\n+            File fileName = new File(path + File.separator + classContent.getClassName() + \".java\"); //NOI18N\n+            if (fileName.exists()) {\n+                JOptionPane.showMessageDialog(null, \"Cannot create class already present\"); //NOI18N\n+                return t;\n+            }\n+            if (!fileName.createNewFile()) {\n+                JOptionPane.showMessageDialog(null, \"Cannot create file\"); //NOI18N\n+                return t;\n+            }\n+\n+            if (classContent.getPackageName() != null) {\n+                copiedData = removePackage(copiedData, classContent.getPackageName());\n+            }\n+            try (BufferedWriter bw = new BufferedWriter(new FileWriter(fileName))) {\n+                String packageLocation = getPackageNameFromFile(fileName);\n+                if (packageLocation != null && !packageLocation.isEmpty()) {\n+                    copiedData = \"package \" + packageLocation + \";\\n\" + copiedData;// NOI18N\n+                }\n+                bw.write(copiedData);\n+            }\n+\n+        } catch (UnsupportedFlavorException ex) {\n+            Exceptions.printStackTrace(ex);\n+        } catch (IOException ex) {\n+            Exceptions.printStackTrace(ex);\n+        }\n+        return t;\n+    }\n+    \n+    \n+     private static class DeadlockTask implements Task<CompilationController> {\n+\n+        JavaSource.Phase phase;\n+        CompilationInfo info;\n+\n+        public DeadlockTask(JavaSource.Phase phase) {\n+            assert phase != null;\n+            this.phase = phase;\n+        }\n+\n+        public void run(CompilationController info) {\n+            try {\n+                info.toPhase(this.phase);\n+                this.info = info;\n+            } catch (IOException ioe) {\n+            }\n+        }\n+\n+    }\n+\n+    private ClassContent extractPackageAndClassName(String copiedData) {\n+        JavaCompiler compiler = ToolProvider.getSystemJavaCompiler();\n+        StandardJavaFileManager fileManager = compiler.getStandardFileManager(null, null, null);\n+\n+        String publicFirstClassName = null;\n+        String nonPublicFirstClassName = null;\n+        String packageName = null;\n+        int counter = 0;\n+        JavaCompiler.CompilationTask task = compiler.getTask(null, fileManager, null, null, null, Arrays.asList(new MyFileObject(copiedData)));", "originalCommit": "962aca488a3965d2b1ad1e0b475be1033d28489e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA4Njg3NQ==", "url": "https://github.com/apache/netbeans/pull/2334#discussion_r501086875", "bodyText": "Addressed.\nVerified with and without nb-javac, working as expected.", "author": "singh-akhilesh", "createdAt": "2020-10-07T15:03:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA1MTQxMA=="}], "type": "inlineReview", "revised_code": {"commit": "56f16fb193c9bb64aae4ece87b8269483936e0a4", "chunk": "diff --git a/java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java b/java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java\nindex 566ab6e906..d7e8ab8b90 100644\n--- a/java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java\n+++ b/java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java\n\n@@ -22,6 +22,8 @@ import com.sun.source.tree.ClassTree;\n import com.sun.source.tree.CompilationUnitTree;\n import com.sun.source.tree.Tree;\n import com.sun.source.util.JavacTask;\n+import com.sun.source.util.SourcePositions;\n+import com.sun.source.util.Trees;\n import java.awt.Toolkit;\n import java.awt.datatransfer.Clipboard;\n import java.awt.datatransfer.DataFlavor;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA1MTUzOA==", "url": "https://github.com/apache/netbeans/pull/2334#discussion_r500051538", "bodyText": "What exceptions are expected here?", "author": "lahodaj", "createdAt": "2020-10-06T07:10:22Z", "path": "java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java", "diffHunk": "@@ -0,0 +1,258 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.netbeans.spi.java.project.support.ui;\n+\n+import com.sun.source.tree.ClassTree;\n+import com.sun.source.tree.CompilationUnitTree;\n+import com.sun.source.tree.Tree;\n+import com.sun.source.util.JavacTask;\n+import java.awt.Toolkit;\n+import java.awt.datatransfer.Clipboard;\n+import java.awt.datatransfer.DataFlavor;\n+import java.awt.datatransfer.Transferable;\n+import java.awt.datatransfer.UnsupportedFlavorException;\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.util.Arrays;\n+import java.util.Set;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import javax.swing.JOptionPane;\n+import javax.tools.JavaCompiler;\n+import javax.tools.JavaFileObject;\n+import javax.tools.SimpleJavaFileObject;\n+import javax.tools.StandardJavaFileManager;\n+import javax.tools.ToolProvider;\n+import org.netbeans.api.java.classpath.ClassPath;\n+import org.netbeans.api.java.source.ClasspathInfo;\n+import org.netbeans.api.java.source.CompilationController;\n+import org.netbeans.api.java.source.CompilationInfo;\n+import org.netbeans.api.java.source.JavaSource;\n+import org.netbeans.api.java.source.Task;\n+import org.openide.filesystems.FileObject;\n+import org.openide.filesystems.FileUtil;\n+import org.openide.loaders.DataFolder;\n+import org.openide.util.Exceptions;\n+import org.openide.util.datatransfer.PasteType;\n+\n+/**\n+ *\n+ * @author aksinsin\n+ */\n+public class CreateJavaClassFileFromClipboard extends PasteType {\n+    \n+    private static final String PUBLIC_MODIFIER = \"public\"; //NOI18N\n+\n+    private final DataFolder context;\n+    private final Transferable t;\n+\n+    public CreateJavaClassFileFromClipboard(DataFolder context, Transferable t) {\n+        this.context = context;\n+        this.t = t;\n+    }\n+\n+    @Override\n+    public Transferable paste() throws IOException {\n+        try {\n+            Clipboard c = Toolkit.getDefaultToolkit().getSystemClipboard();\n+            if (!c.isDataFlavorAvailable(DataFlavor.stringFlavor)) {\n+                return t;\n+            }\n+            String copiedData = (String) c.getData(DataFlavor.stringFlavor);\n+            CreateJavaClassFileFromClipboard.ClassContent classContent = extractPackageAndClassName(copiedData);\n+            if (classContent == null) {\n+                JOptionPane.showMessageDialog(null, \"Code not valid to create class\"); //NOI18N\n+                return t;\n+            }\n+            Set<FileObject> files = this.context.files();\n+            if (files.size() != 1) {\n+                return t;\n+            }\n+            String path = files.iterator().next().getPath();\n+            File fileName = new File(path + File.separator + classContent.getClassName() + \".java\"); //NOI18N\n+            if (fileName.exists()) {\n+                JOptionPane.showMessageDialog(null, \"Cannot create class already present\"); //NOI18N\n+                return t;\n+            }\n+            if (!fileName.createNewFile()) {\n+                JOptionPane.showMessageDialog(null, \"Cannot create file\"); //NOI18N\n+                return t;\n+            }\n+\n+            if (classContent.getPackageName() != null) {\n+                copiedData = removePackage(copiedData, classContent.getPackageName());\n+            }\n+            try (BufferedWriter bw = new BufferedWriter(new FileWriter(fileName))) {\n+                String packageLocation = getPackageNameFromFile(fileName);\n+                if (packageLocation != null && !packageLocation.isEmpty()) {\n+                    copiedData = \"package \" + packageLocation + \";\\n\" + copiedData;// NOI18N\n+                }\n+                bw.write(copiedData);\n+            }\n+\n+        } catch (UnsupportedFlavorException ex) {\n+            Exceptions.printStackTrace(ex);\n+        } catch (IOException ex) {\n+            Exceptions.printStackTrace(ex);\n+        }\n+        return t;\n+    }\n+    \n+    \n+     private static class DeadlockTask implements Task<CompilationController> {\n+\n+        JavaSource.Phase phase;\n+        CompilationInfo info;\n+\n+        public DeadlockTask(JavaSource.Phase phase) {\n+            assert phase != null;\n+            this.phase = phase;\n+        }\n+\n+        public void run(CompilationController info) {\n+            try {\n+                info.toPhase(this.phase);\n+                this.info = info;\n+            } catch (IOException ioe) {\n+            }\n+        }\n+\n+    }\n+\n+    private ClassContent extractPackageAndClassName(String copiedData) {\n+        JavaCompiler compiler = ToolProvider.getSystemJavaCompiler();\n+        StandardJavaFileManager fileManager = compiler.getStandardFileManager(null, null, null);\n+\n+        String publicFirstClassName = null;\n+        String nonPublicFirstClassName = null;\n+        String packageName = null;\n+        int counter = 0;\n+        JavaCompiler.CompilationTask task = compiler.getTask(null, fileManager, null, null, null, Arrays.asList(new MyFileObject(copiedData)));\n+        parse:\n+        try {\n+            for (CompilationUnitTree compilationUnitTree : ((JavacTask) task).parse()) {\n+                packageName = compilationUnitTree.getPackageName() != null\n+                        ? compilationUnitTree.getPackageName().toString() : null;\n+                for (Tree tree : compilationUnitTree.getTypeDecls()) {\n+                    if (tree instanceof ClassTree) {\n+                        final ClassTree classTree = (ClassTree) tree;\n+                        if (classTree.toString().trim().startsWith(PUBLIC_MODIFIER)) {\n+                            publicFirstClassName = classTree.getSimpleName().toString();\n+                            break parse;\n+                        }\n+                        if (counter == 0) {\n+                            nonPublicFirstClassName = classTree.getSimpleName().toString();\n+                            counter++;\n+                        }\n+                    }\n+                }\n+            }\n+        } catch (Exception ex) {", "originalCommit": "962aca488a3965d2b1ad1e0b475be1033d28489e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA4NzY4Ng==", "url": "https://github.com/apache/netbeans/pull/2334#discussion_r501087686", "bodyText": "Expecting IOExection here, changed this to IOException.", "author": "singh-akhilesh", "createdAt": "2020-10-07T15:04:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA1MTUzOA=="}], "type": "inlineReview", "revised_code": {"commit": "56f16fb193c9bb64aae4ece87b8269483936e0a4", "chunk": "diff --git a/java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java b/java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java\nindex 566ab6e906..d7e8ab8b90 100644\n--- a/java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java\n+++ b/java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java\n\n@@ -22,6 +22,8 @@ import com.sun.source.tree.ClassTree;\n import com.sun.source.tree.CompilationUnitTree;\n import com.sun.source.tree.Tree;\n import com.sun.source.util.JavacTask;\n+import com.sun.source.util.SourcePositions;\n+import com.sun.source.util.Trees;\n import java.awt.Toolkit;\n import java.awt.datatransfer.Clipboard;\n import java.awt.datatransfer.DataFlavor;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA1MjQzMg==", "url": "https://github.com/apache/netbeans/pull/2334#discussion_r500052432", "bodyText": "I think I would rather record the start and end offset of the package clause in ClassContent, and removed it based on the offsets. Especially given we have access to the AST above, should be easier than trying to setup a regexp.", "author": "lahodaj", "createdAt": "2020-10-06T07:12:12Z", "path": "java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java", "diffHunk": "@@ -0,0 +1,258 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.netbeans.spi.java.project.support.ui;\n+\n+import com.sun.source.tree.ClassTree;\n+import com.sun.source.tree.CompilationUnitTree;\n+import com.sun.source.tree.Tree;\n+import com.sun.source.util.JavacTask;\n+import java.awt.Toolkit;\n+import java.awt.datatransfer.Clipboard;\n+import java.awt.datatransfer.DataFlavor;\n+import java.awt.datatransfer.Transferable;\n+import java.awt.datatransfer.UnsupportedFlavorException;\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.util.Arrays;\n+import java.util.Set;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import javax.swing.JOptionPane;\n+import javax.tools.JavaCompiler;\n+import javax.tools.JavaFileObject;\n+import javax.tools.SimpleJavaFileObject;\n+import javax.tools.StandardJavaFileManager;\n+import javax.tools.ToolProvider;\n+import org.netbeans.api.java.classpath.ClassPath;\n+import org.netbeans.api.java.source.ClasspathInfo;\n+import org.netbeans.api.java.source.CompilationController;\n+import org.netbeans.api.java.source.CompilationInfo;\n+import org.netbeans.api.java.source.JavaSource;\n+import org.netbeans.api.java.source.Task;\n+import org.openide.filesystems.FileObject;\n+import org.openide.filesystems.FileUtil;\n+import org.openide.loaders.DataFolder;\n+import org.openide.util.Exceptions;\n+import org.openide.util.datatransfer.PasteType;\n+\n+/**\n+ *\n+ * @author aksinsin\n+ */\n+public class CreateJavaClassFileFromClipboard extends PasteType {\n+    \n+    private static final String PUBLIC_MODIFIER = \"public\"; //NOI18N\n+\n+    private final DataFolder context;\n+    private final Transferable t;\n+\n+    public CreateJavaClassFileFromClipboard(DataFolder context, Transferable t) {\n+        this.context = context;\n+        this.t = t;\n+    }\n+\n+    @Override\n+    public Transferable paste() throws IOException {\n+        try {\n+            Clipboard c = Toolkit.getDefaultToolkit().getSystemClipboard();\n+            if (!c.isDataFlavorAvailable(DataFlavor.stringFlavor)) {\n+                return t;\n+            }\n+            String copiedData = (String) c.getData(DataFlavor.stringFlavor);\n+            CreateJavaClassFileFromClipboard.ClassContent classContent = extractPackageAndClassName(copiedData);\n+            if (classContent == null) {\n+                JOptionPane.showMessageDialog(null, \"Code not valid to create class\"); //NOI18N\n+                return t;\n+            }\n+            Set<FileObject> files = this.context.files();\n+            if (files.size() != 1) {\n+                return t;\n+            }\n+            String path = files.iterator().next().getPath();\n+            File fileName = new File(path + File.separator + classContent.getClassName() + \".java\"); //NOI18N\n+            if (fileName.exists()) {\n+                JOptionPane.showMessageDialog(null, \"Cannot create class already present\"); //NOI18N\n+                return t;\n+            }\n+            if (!fileName.createNewFile()) {\n+                JOptionPane.showMessageDialog(null, \"Cannot create file\"); //NOI18N\n+                return t;\n+            }\n+\n+            if (classContent.getPackageName() != null) {\n+                copiedData = removePackage(copiedData, classContent.getPackageName());\n+            }\n+            try (BufferedWriter bw = new BufferedWriter(new FileWriter(fileName))) {\n+                String packageLocation = getPackageNameFromFile(fileName);\n+                if (packageLocation != null && !packageLocation.isEmpty()) {\n+                    copiedData = \"package \" + packageLocation + \";\\n\" + copiedData;// NOI18N\n+                }\n+                bw.write(copiedData);\n+            }\n+\n+        } catch (UnsupportedFlavorException ex) {\n+            Exceptions.printStackTrace(ex);\n+        } catch (IOException ex) {\n+            Exceptions.printStackTrace(ex);\n+        }\n+        return t;\n+    }\n+    \n+    \n+     private static class DeadlockTask implements Task<CompilationController> {\n+\n+        JavaSource.Phase phase;\n+        CompilationInfo info;\n+\n+        public DeadlockTask(JavaSource.Phase phase) {\n+            assert phase != null;\n+            this.phase = phase;\n+        }\n+\n+        public void run(CompilationController info) {\n+            try {\n+                info.toPhase(this.phase);\n+                this.info = info;\n+            } catch (IOException ioe) {\n+            }\n+        }\n+\n+    }\n+\n+    private ClassContent extractPackageAndClassName(String copiedData) {\n+        JavaCompiler compiler = ToolProvider.getSystemJavaCompiler();\n+        StandardJavaFileManager fileManager = compiler.getStandardFileManager(null, null, null);\n+\n+        String publicFirstClassName = null;\n+        String nonPublicFirstClassName = null;\n+        String packageName = null;\n+        int counter = 0;\n+        JavaCompiler.CompilationTask task = compiler.getTask(null, fileManager, null, null, null, Arrays.asList(new MyFileObject(copiedData)));\n+        parse:\n+        try {\n+            for (CompilationUnitTree compilationUnitTree : ((JavacTask) task).parse()) {\n+                packageName = compilationUnitTree.getPackageName() != null\n+                        ? compilationUnitTree.getPackageName().toString() : null;\n+                for (Tree tree : compilationUnitTree.getTypeDecls()) {\n+                    if (tree instanceof ClassTree) {\n+                        final ClassTree classTree = (ClassTree) tree;\n+                        if (classTree.toString().trim().startsWith(PUBLIC_MODIFIER)) {\n+                            publicFirstClassName = classTree.getSimpleName().toString();\n+                            break parse;\n+                        }\n+                        if (counter == 0) {\n+                            nonPublicFirstClassName = classTree.getSimpleName().toString();\n+                            counter++;\n+                        }\n+                    }\n+                }\n+            }\n+        } catch (Exception ex) {\n+            Exceptions.printStackTrace(ex);\n+        } finally {\n+            try {\n+                fileManager.close();\n+            } catch (IOException ex) {\n+                Exceptions.printStackTrace(ex);\n+            }\n+        }\n+\n+        if (publicFirstClassName != null && !publicFirstClassName.equals(\"<error>\")) { //NOI18N\n+            return new ClassContent(publicFirstClassName, packageName);\n+        } else if (nonPublicFirstClassName != null && !nonPublicFirstClassName.equals(\"<error>\")) { //NOI18N\n+            return new ClassContent(nonPublicFirstClassName, packageName);\n+        } else {\n+            return null;\n+        }\n+\n+    }\n+\n+    private String removePackage(String copiedCode, String oldPacageName) {", "originalCommit": "962aca488a3965d2b1ad1e0b475be1033d28489e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA4OTUzMA==", "url": "https://github.com/apache/netbeans/pull/2334#discussion_r501089530", "bodyText": "Comment Addressed.\nGetting start and end offset of package using below:\nJavaCompiler.CompilationTask task = compiler.getTask(null, null, null, null, null, Arrays.asList(new MyFileObject(copiedData)));\nSourcePositions sourcePositions = Trees.instance(task).getSourcePositions();\nfor (CompilationUnitTree compilationUnitTree : ((JavacTask) task).parse()) {\npackageStartOffset = sourcePositions.getStartPosition(compilationUnitTree, compilationUnitTree.getPackage());\npackageEndOffset = sourcePositions.getEndPosition(compilationUnitTree, compilationUnitTree.getPackage());", "author": "singh-akhilesh", "createdAt": "2020-10-07T15:07:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA1MjQzMg=="}], "type": "inlineReview", "revised_code": {"commit": "56f16fb193c9bb64aae4ece87b8269483936e0a4", "chunk": "diff --git a/java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java b/java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java\nindex 566ab6e906..d7e8ab8b90 100644\n--- a/java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java\n+++ b/java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java\n\n@@ -22,6 +22,8 @@ import com.sun.source.tree.ClassTree;\n import com.sun.source.tree.CompilationUnitTree;\n import com.sun.source.tree.Tree;\n import com.sun.source.util.JavacTask;\n+import com.sun.source.util.SourcePositions;\n+import com.sun.source.util.Trees;\n import java.awt.Toolkit;\n import java.awt.datatransfer.Clipboard;\n import java.awt.datatransfer.DataFlavor;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA1NDcwOA==", "url": "https://github.com/apache/netbeans/pull/2334#discussion_r500054708", "bodyText": "Running a task seems unnecessarily complex and slow. If I read this correctly, the goal is to get the source ClassPath. There are multiple ways to achieve that:\n-ClassPath.getClassPath(ClassPath.SOURCE, data) //watch for null as a result, treat as ClassPath.EMPTY.\n-ClasspathInfo.create(data).getClassPath(...SOURCE)\n-js.getClasspathInfo()\nThe first is likely to be the fastest in this context.", "author": "lahodaj", "createdAt": "2020-10-06T07:16:40Z", "path": "java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java", "diffHunk": "@@ -0,0 +1,258 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.netbeans.spi.java.project.support.ui;\n+\n+import com.sun.source.tree.ClassTree;\n+import com.sun.source.tree.CompilationUnitTree;\n+import com.sun.source.tree.Tree;\n+import com.sun.source.util.JavacTask;\n+import java.awt.Toolkit;\n+import java.awt.datatransfer.Clipboard;\n+import java.awt.datatransfer.DataFlavor;\n+import java.awt.datatransfer.Transferable;\n+import java.awt.datatransfer.UnsupportedFlavorException;\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.util.Arrays;\n+import java.util.Set;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import javax.swing.JOptionPane;\n+import javax.tools.JavaCompiler;\n+import javax.tools.JavaFileObject;\n+import javax.tools.SimpleJavaFileObject;\n+import javax.tools.StandardJavaFileManager;\n+import javax.tools.ToolProvider;\n+import org.netbeans.api.java.classpath.ClassPath;\n+import org.netbeans.api.java.source.ClasspathInfo;\n+import org.netbeans.api.java.source.CompilationController;\n+import org.netbeans.api.java.source.CompilationInfo;\n+import org.netbeans.api.java.source.JavaSource;\n+import org.netbeans.api.java.source.Task;\n+import org.openide.filesystems.FileObject;\n+import org.openide.filesystems.FileUtil;\n+import org.openide.loaders.DataFolder;\n+import org.openide.util.Exceptions;\n+import org.openide.util.datatransfer.PasteType;\n+\n+/**\n+ *\n+ * @author aksinsin\n+ */\n+public class CreateJavaClassFileFromClipboard extends PasteType {\n+    \n+    private static final String PUBLIC_MODIFIER = \"public\"; //NOI18N\n+\n+    private final DataFolder context;\n+    private final Transferable t;\n+\n+    public CreateJavaClassFileFromClipboard(DataFolder context, Transferable t) {\n+        this.context = context;\n+        this.t = t;\n+    }\n+\n+    @Override\n+    public Transferable paste() throws IOException {\n+        try {\n+            Clipboard c = Toolkit.getDefaultToolkit().getSystemClipboard();\n+            if (!c.isDataFlavorAvailable(DataFlavor.stringFlavor)) {\n+                return t;\n+            }\n+            String copiedData = (String) c.getData(DataFlavor.stringFlavor);\n+            CreateJavaClassFileFromClipboard.ClassContent classContent = extractPackageAndClassName(copiedData);\n+            if (classContent == null) {\n+                JOptionPane.showMessageDialog(null, \"Code not valid to create class\"); //NOI18N\n+                return t;\n+            }\n+            Set<FileObject> files = this.context.files();\n+            if (files.size() != 1) {\n+                return t;\n+            }\n+            String path = files.iterator().next().getPath();\n+            File fileName = new File(path + File.separator + classContent.getClassName() + \".java\"); //NOI18N\n+            if (fileName.exists()) {\n+                JOptionPane.showMessageDialog(null, \"Cannot create class already present\"); //NOI18N\n+                return t;\n+            }\n+            if (!fileName.createNewFile()) {\n+                JOptionPane.showMessageDialog(null, \"Cannot create file\"); //NOI18N\n+                return t;\n+            }\n+\n+            if (classContent.getPackageName() != null) {\n+                copiedData = removePackage(copiedData, classContent.getPackageName());\n+            }\n+            try (BufferedWriter bw = new BufferedWriter(new FileWriter(fileName))) {\n+                String packageLocation = getPackageNameFromFile(fileName);\n+                if (packageLocation != null && !packageLocation.isEmpty()) {\n+                    copiedData = \"package \" + packageLocation + \";\\n\" + copiedData;// NOI18N\n+                }\n+                bw.write(copiedData);\n+            }\n+\n+        } catch (UnsupportedFlavorException ex) {\n+            Exceptions.printStackTrace(ex);\n+        } catch (IOException ex) {\n+            Exceptions.printStackTrace(ex);\n+        }\n+        return t;\n+    }\n+    \n+    \n+     private static class DeadlockTask implements Task<CompilationController> {\n+\n+        JavaSource.Phase phase;\n+        CompilationInfo info;\n+\n+        public DeadlockTask(JavaSource.Phase phase) {\n+            assert phase != null;\n+            this.phase = phase;\n+        }\n+\n+        public void run(CompilationController info) {\n+            try {\n+                info.toPhase(this.phase);\n+                this.info = info;\n+            } catch (IOException ioe) {\n+            }\n+        }\n+\n+    }\n+\n+    private ClassContent extractPackageAndClassName(String copiedData) {\n+        JavaCompiler compiler = ToolProvider.getSystemJavaCompiler();\n+        StandardJavaFileManager fileManager = compiler.getStandardFileManager(null, null, null);\n+\n+        String publicFirstClassName = null;\n+        String nonPublicFirstClassName = null;\n+        String packageName = null;\n+        int counter = 0;\n+        JavaCompiler.CompilationTask task = compiler.getTask(null, fileManager, null, null, null, Arrays.asList(new MyFileObject(copiedData)));\n+        parse:\n+        try {\n+            for (CompilationUnitTree compilationUnitTree : ((JavacTask) task).parse()) {\n+                packageName = compilationUnitTree.getPackageName() != null\n+                        ? compilationUnitTree.getPackageName().toString() : null;\n+                for (Tree tree : compilationUnitTree.getTypeDecls()) {\n+                    if (tree instanceof ClassTree) {\n+                        final ClassTree classTree = (ClassTree) tree;\n+                        if (classTree.toString().trim().startsWith(PUBLIC_MODIFIER)) {\n+                            publicFirstClassName = classTree.getSimpleName().toString();\n+                            break parse;\n+                        }\n+                        if (counter == 0) {\n+                            nonPublicFirstClassName = classTree.getSimpleName().toString();\n+                            counter++;\n+                        }\n+                    }\n+                }\n+            }\n+        } catch (Exception ex) {\n+            Exceptions.printStackTrace(ex);\n+        } finally {\n+            try {\n+                fileManager.close();\n+            } catch (IOException ex) {\n+                Exceptions.printStackTrace(ex);\n+            }\n+        }\n+\n+        if (publicFirstClassName != null && !publicFirstClassName.equals(\"<error>\")) { //NOI18N\n+            return new ClassContent(publicFirstClassName, packageName);\n+        } else if (nonPublicFirstClassName != null && !nonPublicFirstClassName.equals(\"<error>\")) { //NOI18N\n+            return new ClassContent(nonPublicFirstClassName, packageName);\n+        } else {\n+            return null;\n+        }\n+\n+    }\n+\n+    private String removePackage(String copiedCode, String oldPacageName) {\n+        String packageRegex = oldPacageName.replace(\".\", \"\\\\s*.\\\\s*\"); //NOI18N\n+        packageRegex = \"package\\\\s+\" + packageRegex + \"\\\\s*;\"; //NOI18N\n+        Pattern p = Pattern.compile(packageRegex);\n+\n+        Matcher m = p.matcher(copiedCode);\n+        StringBuffer sb = new StringBuffer();\n+        if (m.find()) {\n+            m.appendReplacement(sb, \"\"); //NOI18N\n+        }\n+\n+        m.appendTail(sb);\n+        return sb.toString();\n+    }\n+\n+    private String getPackageNameFromFile(File fileName) {\n+        String packageLocation = null;\n+        try {\n+            FileObject data = FileUtil.createData(fileName);\n+            JavaSource js = JavaSource.forFileObject(data);\n+\n+            final DeadlockTask bt = new DeadlockTask(JavaSource.Phase.RESOLVED);\n+            js.runUserActionTask(bt, true);", "originalCommit": "962aca488a3965d2b1ad1e0b475be1033d28489e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA5MjkwNA==", "url": "https://github.com/apache/netbeans/pull/2334#discussion_r501092904", "bodyText": "Comment addressed!\nRemoved the previously written code for getting class path and use the suggested one : ** ClassPath.getClassPath(data, ClassPath.SOURCE);**", "author": "singh-akhilesh", "createdAt": "2020-10-07T15:11:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA1NDcwOA=="}], "type": "inlineReview", "revised_code": {"commit": "56f16fb193c9bb64aae4ece87b8269483936e0a4", "chunk": "diff --git a/java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java b/java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java\nindex 566ab6e906..d7e8ab8b90 100644\n--- a/java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java\n+++ b/java/java.project.ui/src/org/netbeans/spi/java/project/support/ui/CreateJavaClassFileFromClipboard.java\n\n@@ -22,6 +22,8 @@ import com.sun.source.tree.ClassTree;\n import com.sun.source.tree.CompilationUnitTree;\n import com.sun.source.tree.Tree;\n import com.sun.source.util.JavacTask;\n+import com.sun.source.util.SourcePositions;\n+import com.sun.source.util.Trees;\n import java.awt.Toolkit;\n import java.awt.datatransfer.Clipboard;\n import java.awt.datatransfer.DataFlavor;\n"}}, {"oid": "56f16fb193c9bb64aae4ece87b8269483936e0a4", "url": "https://github.com/apache/netbeans/commit/56f16fb193c9bb64aae4ece87b8269483936e0a4", "message": "[NETBEANS-3986] Create new Class/Interface/Enum on copy-paste raw text\nfrom clipboard", "committedDate": "2020-10-07T14:53:39Z", "type": "commit"}, {"oid": "56f16fb193c9bb64aae4ece87b8269483936e0a4", "url": "https://github.com/apache/netbeans/commit/56f16fb193c9bb64aae4ece87b8269483936e0a4", "message": "[NETBEANS-3986] Create new Class/Interface/Enum on copy-paste raw text\nfrom clipboard", "committedDate": "2020-10-07T14:53:39Z", "type": "forcePushed"}]}