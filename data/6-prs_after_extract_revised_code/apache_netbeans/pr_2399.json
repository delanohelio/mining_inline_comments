{"pr_number": 2399, "pr_title": "[NETBEANS-4832] Avoid assertion & NPE in fxml code completion", "pr_createdAt": "2020-09-25T01:48:09Z", "pr_url": "https://github.com/apache/netbeans/pull/2399", "timeline": [{"oid": "66d9f1cf83eba16edb68e0a8bb832e49200fd126", "url": "https://github.com/apache/netbeans/commit/66d9f1cf83eba16edb68e0a8bb832e49200fd126", "message": "[NETBEANS-4832] Avoid assertion & NPE in fxml code completion", "committedDate": "2020-09-25T01:23:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU2NTI4MA==", "url": "https://github.com/apache/netbeans/pull/2399#discussion_r495565280", "bodyText": "Not related to this bug, but a few lines below: (elem.getKind() == ElementKind.CLASS || elem.getKind() == ElementKind.INTERFACE) IMHO does not work for ANNOTATION_TYPE and ENUM. Could be worth to fix as\nelem.getKind().isClass() || elem.getKind().isInterface ?", "author": "sdedic", "createdAt": "2020-09-27T11:56:12Z", "path": "java/java.source.base/src/org/netbeans/modules/java/source/ElementUtils.java", "diffHunk": "@@ -60,6 +60,11 @@ public static TypeElement getTypeElementByBinaryName(JavacTask task, String name\n         for (ModuleElement me : allModules) {\n             TypeElement found = getTypeElementByBinaryName(task, me, name);\n \n+            if (result == found) {\n+                // avoid returning null, partial fix for [NETBEANS-4832]\n+                continue;\n+            }\n+", "originalCommit": "8cd0308d63c79157c92b6b738f4e3ee5c311363b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjM0MzE5Mw==", "url": "https://github.com/apache/netbeans/pull/2399#discussion_r496343193", "bodyText": "So you're saying that the if(result==found)continue seems OK.\nAnd that there's an additional issue that could arise in some cases; and you've proposed a fix which can be incorporated with this change.", "author": "errael", "createdAt": "2020-09-29T02:34:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU2NTI4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU1ODcwNg==", "url": "https://github.com/apache/netbeans/pull/2399#discussion_r497558706", "bodyText": "Added separate commit for ANNOTATION_TYPE, ENUM, still in this PR.", "author": "errael", "createdAt": "2020-09-30T14:32:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU2NTI4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU2MDM1MQ==", "url": "https://github.com/apache/netbeans/pull/2399#discussion_r497560351", "bodyText": "@sdedic Known issues handled, please review.", "author": "errael", "createdAt": "2020-09-30T14:34:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU2NTI4MA=="}], "type": "inlineReview", "revised_code": {"commit": "1d1875b837c34275230b244b28c5ce075ff1b9a6", "chunk": "diff --git a/java/java.source.base/src/org/netbeans/modules/java/source/ElementUtils.java b/java/java.source.base/src/org/netbeans/modules/java/source/ElementUtils.java\nindex b6db375bf9..d411877004 100644\n--- a/java/java.source.base/src/org/netbeans/modules/java/source/ElementUtils.java\n+++ b/java/java.source.base/src/org/netbeans/modules/java/source/ElementUtils.java\n\n@@ -72,7 +72,7 @@ public class ElementUtils {\n                 if (result != null) {\n                     if (foundInUnamedModule == true) {\n                         for (TypeElement elem : new TypeElement[]{result, found}) {\n-                            if ((elem.getKind() == ElementKind.CLASS || elem.getKind() == ElementKind.INTERFACE)\n+                            if ((elem.getKind().isClass() || elem.getKind().isInterface())\n                                     && (((ClassSymbol) elem).packge().modle != syms.unnamedModule)) {\n                                 return elem;\n                             }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU2NTQ1OQ==", "url": "https://github.com/apache/netbeans/pull/2399#discussion_r495565459", "bodyText": "I understand the trigger, but couldn't it be fixed right in the getPackagElement(), @jlahoda ?", "author": "sdedic", "createdAt": "2020-09-27T11:58:41Z", "path": "javafx/javafx2.editor/src/org/netbeans/modules/javafx2/editor/FXMLCompletion2.java", "diffHunk": "@@ -161,6 +161,8 @@ public void run(ResultIterator resultIterator) throws Exception {\n                 }\n                 Parser.Result result = resultIterator.getParserResult();\n                 ci = CompilationInfo.get(result);\n+                // following populates module info, partial fix for [NETBEANS-4832]\n+                ci.getElements().getPackageElement(\"java.lang\");", "originalCommit": "8cd0308d63c79157c92b6b738f4e3ee5c311363b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjM0MzM2MA==", "url": "https://github.com/apache/netbeans/pull/2399#discussion_r496343360", "bodyText": "Did you mean getElements() rather than getPackageElement()?", "author": "errael", "createdAt": "2020-09-29T02:34:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU2NTQ1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjM4OTQxMg==", "url": "https://github.com/apache/netbeans/pull/2399#discussion_r496389412", "bodyText": "I think the expected way would be to get a CompilationController (instead of just CompilationInfo) and call toPhase(ELEMENTS_RESOLVED), or alike, on it.", "author": "jlahoda", "createdAt": "2020-09-29T04:41:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU2NTQ1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU1OTcyOA==", "url": "https://github.com/apache/netbeans/pull/2399#discussion_r497559728", "bodyText": "@jlahoda Use CompilationController as suggested. Works, thanks. Please review.", "author": "errael", "createdAt": "2020-09-30T14:33:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU2NTQ1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "1d1875b837c34275230b244b28c5ce075ff1b9a6", "chunk": "diff --git a/javafx/javafx2.editor/src/org/netbeans/modules/javafx2/editor/FXMLCompletion2.java b/javafx/javafx2.editor/src/org/netbeans/modules/javafx2/editor/FXMLCompletion2.java\nindex 82c27dbe0f..2e2c5c057a 100644\n--- a/javafx/javafx2.editor/src/org/netbeans/modules/javafx2/editor/FXMLCompletion2.java\n+++ b/javafx/javafx2.editor/src/org/netbeans/modules/javafx2/editor/FXMLCompletion2.java\n\n@@ -160,9 +161,9 @@ public class FXMLCompletion2 implements CompletionProvider {\n                     return;\n                 }\n                 Parser.Result result = resultIterator.getParserResult();\n-                ci = CompilationInfo.get(result);\n-                // following populates module info, partial fix for [NETBEANS-4832]\n-                ci.getElements().getPackageElement(\"java.lang\");\n+                // [NETBEANS-4832] CompController (not CompInfo) for module info (partial fix)\n+                cc = CompilationController.get(result);\n+                cc.toPhase(Phase.ELEMENTS_RESOLVED);\n \n                 ctx = new CompletionContext(doc, caretOffset, queryType);\n \n"}}, {"oid": "1d1875b837c34275230b244b28c5ce075ff1b9a6", "url": "https://github.com/apache/netbeans/commit/1d1875b837c34275230b244b28c5ce075ff1b9a6", "message": "Handle ANNOTATION_TYPE and ENUM in getTypeElementByBinaryName().", "committedDate": "2020-09-30T14:17:35Z", "type": "commit"}, {"oid": "1d1875b837c34275230b244b28c5ce075ff1b9a6", "url": "https://github.com/apache/netbeans/commit/1d1875b837c34275230b244b28c5ce075ff1b9a6", "message": "Handle ANNOTATION_TYPE and ENUM in getTypeElementByBinaryName().", "committedDate": "2020-09-30T14:17:35Z", "type": "forcePushed"}]}