{"pr_number": 2305, "pr_title": "[NETBEANS-3693] Create only one instance of javac", "pr_createdAt": "2020-08-09T13:38:05Z", "pr_url": "https://github.com/apache/netbeans/pull/2305", "timeline": [{"oid": "8c73e078e43cbcea4c36dfe72b2ea5e25b9e2f66", "url": "https://github.com/apache/netbeans/commit/8c73e078e43cbcea4c36dfe72b2ea5e25b9e2f66", "message": "[NETBEANS-3693] Create only one instance of javac", "committedDate": "2020-08-12T14:34:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjYzOTc3Ng==", "url": "https://github.com/apache/netbeans/pull/2305#discussion_r492639776", "bodyText": "I suspect this will disable \"sequential\" processing when nb-javac is installed, right? Or do I miss something here?", "author": "lahodaj", "createdAt": "2020-09-22T10:48:40Z", "path": "java/java.source.base/src/org/netbeans/modules/java/source/parsing/JavacParser.java", "diffHunk": "@@ -424,9 +434,28 @@ private void parseImpl(\n                     break;\n                 default:\n                     init (snapshot, task, false);\n+                    DiagnosticListener<JavaFileObject> diagnosticListener;\n+                    JavacTaskImpl javacTask;\n+                    boolean oneInstanceJava=Boolean.getBoolean(\"java.enable.single.javac\") && this.snapshotSize <= this.MAX_FILE_SIZE;\n+                    if (sequentialParsing == null && ciImpl == null && oneInstanceJava) {\n+                        List<JavaFileObject> jfos = new ArrayList<>();\n+                        for (Snapshot s : snapshots) {\n+                            jfos.add(FileObjects.sourceFileObject(s.getSource().getFileObject(), root, JavaFileFilterQuery.getFilter(s.getSource().getFileObject()), s.getText()));\n+                        }\n+                        diagnosticListener = new CompilationInfoImpl.DiagnosticListenerImpl(this.root, jfos.get(0), this.cpInfo);\n+                        javacTask = JavacParser.createJavacTask(this.file, jfos, this.root, this.cpInfo,\n+                                this, diagnosticListener, false);\n+                    } else if (ciImpl != null &&  oneInstanceJava) {\n+                        diagnosticListener = ciImpl.getDiagnosticListener();\n+                        javacTask = ciImpl.getJavacTask();\n+                        oldParsedTrees=ciImpl.getParsedTrees();\n+                    } else {\n+                        diagnosticListener = null;\n+                        javacTask = null;\n+                    }\n                     ciImpl = createCurrentInfo(this, file, root, snapshot,\n-                        sequentialParsing == null || ciImpl == null ? null : ciImpl.getJavacTask(),\n-                        sequentialParsing == null || ciImpl == null ? null : ciImpl.getDiagnosticListener());\n+                        javacTask,", "originalCommit": "8c73e078e43cbcea4c36dfe72b2ea5e25b9e2f66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjg0MjI4MQ==", "url": "https://github.com/apache/netbeans/pull/2305#discussion_r492842281", "bodyText": "This is handled above on the if-else conditions starting at line 440. If nb-javac is installed then sequential parsing will not be null and remaining code will be same as of before this PR.", "author": "Akshay-Gupta-Oracle", "createdAt": "2020-09-22T15:43:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjYzOTc3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTcyMTIxMA==", "url": "https://github.com/apache/netbeans/pull/2305#discussion_r495721210", "bodyText": "Is this OK @jlahoda, can this PR be merged now??", "author": "Akshay-Gupta-Oracle", "createdAt": "2020-09-28T06:47:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjYzOTc3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjU4NTEwMA==", "url": "https://github.com/apache/netbeans/pull/2305#discussion_r496585100", "bodyText": "I note that the if on line 448 is also checking oneInstanceJava. So it seems to me that is sequentialParsing != null and oneInstanceJava == false, the it will always fall to the else section and go file-by-file. Or what do I miss?", "author": "lahodaj", "createdAt": "2020-09-29T09:46:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjYzOTc3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk2MTM0OQ==", "url": "https://github.com/apache/netbeans/pull/2305#discussion_r502961349", "bodyText": "You're correct @jlahoda I've removed the oninstance variable form second if. and added (sequentialParsing != null || oneInstanceJava) instead.\nNow this PR is final", "author": "Akshay-Gupta-Oracle", "createdAt": "2020-10-11T20:20:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjYzOTc3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "ebf439b61c7ceac5c88de3598e73efb85311de94", "chunk": "diff --git a/java/java.source.base/src/org/netbeans/modules/java/source/parsing/JavacParser.java b/java/java.source.base/src/org/netbeans/modules/java/source/parsing/JavacParser.java\nindex 87ccaf35f9..9d1d6d5330 100644\n--- a/java/java.source.base/src/org/netbeans/modules/java/source/parsing/JavacParser.java\n+++ b/java/java.source.base/src/org/netbeans/modules/java/source/parsing/JavacParser.java\n\n@@ -433,7 +433,7 @@ public class JavacParser extends Parser {\n                     }\n                     break;\n                 default:\n-                    init (snapshot, task, false);\n+                    init(snapshot, task, false);\n                     DiagnosticListener<JavaFileObject> diagnosticListener;\n                     JavacTaskImpl javacTask;\n                     boolean oneInstanceJava=Boolean.getBoolean(\"java.enable.single.javac\") && this.snapshotSize <= this.MAX_FILE_SIZE;\n"}}, {"oid": "ebf439b61c7ceac5c88de3598e73efb85311de94", "url": "https://github.com/apache/netbeans/commit/ebf439b61c7ceac5c88de3598e73efb85311de94", "message": "[NETBEANS-3693] Create only one instance of javac", "committedDate": "2020-10-11T04:18:21Z", "type": "forcePushed"}, {"oid": "28e08ca23a1a1b01c3f1dc92334881e63b41ddfd", "url": "https://github.com/apache/netbeans/commit/28e08ca23a1a1b01c3f1dc92334881e63b41ddfd", "message": "[NETBEANS-3693] Create only one instance of javac", "committedDate": "2020-10-11T20:31:46Z", "type": "commit"}, {"oid": "28e08ca23a1a1b01c3f1dc92334881e63b41ddfd", "url": "https://github.com/apache/netbeans/commit/28e08ca23a1a1b01c3f1dc92334881e63b41ddfd", "message": "[NETBEANS-3693] Create only one instance of javac", "committedDate": "2020-10-11T20:31:46Z", "type": "forcePushed"}]}