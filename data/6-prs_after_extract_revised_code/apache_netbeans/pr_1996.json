{"pr_number": 1996, "pr_title": "Only register LSP based formatting if MimePath has language server", "pr_createdAt": "2020-03-01T20:24:37Z", "pr_url": "https://github.com/apache/netbeans/pull/1996", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk5MTQ0Ng==", "url": "https://github.com/apache/netbeans/pull/1996#discussion_r387991446", "bodyText": "Nitpick: missing whitespace after if", "author": "junichi11", "createdAt": "2020-03-04T23:15:52Z", "path": "ide/lsp.client/src/org/netbeans/modules/lsp/client/bindings/Formatter.java", "diffHunk": "@@ -47,12 +45,18 @@\n \n     private static final Logger LOG = Logger.getLogger(Formatter.class.getName());\n \n-    @MimeRegistration(mimeType = \"\", service = ReformatTask.Factory.class)\n     public static class Factory implements ReformatTask.Factory {\n \n         @Override\n         public ReformatTask createTask(Context context) {\n-            return new Formatter(context);\n+            FileObject file = NbEditorUtilities.getFileObject(context.document());\n+            if (file != null) {\n+                LSPBindings bindings = LSPBindings.getBindings(file);\n+                if(bindings != null) {", "originalCommit": "e522ec0ae444cb61e30a4b674c19086df058bb13", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "952f6a909b77ab5a7dfd253b988b81c912e2869a", "chunk": "diff --git a/ide/lsp.client/src/org/netbeans/modules/lsp/client/bindings/Formatter.java b/ide/lsp.client/src/org/netbeans/modules/lsp/client/bindings/Formatter.java\nindex 6fce04ecbb..045e490050 100644\n--- a/ide/lsp.client/src/org/netbeans/modules/lsp/client/bindings/Formatter.java\n+++ b/ide/lsp.client/src/org/netbeans/modules/lsp/client/bindings/Formatter.java\n\n@@ -52,7 +52,7 @@ public class Formatter implements ReformatTask {\n             FileObject file = NbEditorUtilities.getFileObject(context.document());\n             if (file != null) {\n                 LSPBindings bindings = LSPBindings.getBindings(file);\n-                if(bindings != null) {\n+                if (bindings != null) {\n                     return new Formatter(context);\n                 }\n             }\n"}}, {"oid": "952f6a909b77ab5a7dfd253b988b81c912e2869a", "url": "https://github.com/apache/netbeans/commit/952f6a909b77ab5a7dfd253b988b81c912e2869a", "message": "Only register LSP based formatting if MimePath has language server\n\nIt was observed that XML formatting did not work after enabling LSP\nformatting. The problem was caused by the MimeLookup for application/xml\nthat returned two ReformatTask.Factory implementations. One was the\nright factory, the other the Formatter provided by the LSP Client\nmodule.\n\nInstead of registering the ReformatTask.Factory of the LSP client module\non the empty mime path, it is now dynamically registered by a\nMimeDataProvider (LspMimeDataProvider). That MimeDataProvider ensures\nthat the lsp based formatter is only registered if a\nLanguageServerProvider is present on the targetted mime path.\n\nAs an implementation note the LspMimeDataProvider is registered with a\nposition, which ensures, that it is registered with higher priority than\nLegacyFormattersProvider which unconditionally registers a formatter.\nHaving a higher priority (any position has higher priority than no\nposition) ensures LspMimeDataProvider is queried first.", "committedDate": "2020-03-05T18:21:51Z", "type": "commit"}, {"oid": "952f6a909b77ab5a7dfd253b988b81c912e2869a", "url": "https://github.com/apache/netbeans/commit/952f6a909b77ab5a7dfd253b988b81c912e2869a", "message": "Only register LSP based formatting if MimePath has language server\n\nIt was observed that XML formatting did not work after enabling LSP\nformatting. The problem was caused by the MimeLookup for application/xml\nthat returned two ReformatTask.Factory implementations. One was the\nright factory, the other the Formatter provided by the LSP Client\nmodule.\n\nInstead of registering the ReformatTask.Factory of the LSP client module\non the empty mime path, it is now dynamically registered by a\nMimeDataProvider (LspMimeDataProvider). That MimeDataProvider ensures\nthat the lsp based formatter is only registered if a\nLanguageServerProvider is present on the targetted mime path.\n\nAs an implementation note the LspMimeDataProvider is registered with a\nposition, which ensures, that it is registered with higher priority than\nLegacyFormattersProvider which unconditionally registers a formatter.\nHaving a higher priority (any position has higher priority than no\nposition) ensures LspMimeDataProvider is queried first.", "committedDate": "2020-03-05T18:21:51Z", "type": "forcePushed"}]}