{"pr_number": 2478, "pr_title": "StatusDisplayer messages remoted to LSP client.", "pr_createdAt": "2020-10-21T05:27:52Z", "pr_url": "https://github.com/apache/netbeans/pull/2478", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTAwMzk1Nw==", "url": "https://github.com/apache/netbeans/pull/2478#discussion_r509003957", "bodyText": "Not urgent, but shouldn't there be some client/server capabilities handshake to find out if this message is supported on both sides? If this message isn't supported, then send some standard message like logMessage or showMessage? @jlahoda tends to repeat that VSCode isn't the only client for this server.", "author": "JaroslavTulach", "createdAt": "2020-10-21T05:46:00Z", "path": "java/java.lsp.server/src/org/netbeans/modules/java/lsp/server/protocol/NbCodeLanguageClient.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.netbeans.modules.java.lsp.server.protocol;\n+\n+import org.eclipse.lsp4j.MessageParams;\n+import org.eclipse.lsp4j.jsonrpc.services.JsonNotification;\n+import org.eclipse.lsp4j.jsonrpc.validation.NonNull;\n+import org.eclipse.lsp4j.services.LanguageClient;\n+\n+/**\n+ * An extension to the standard LanguageClient that adds several messages missing\n+ * from the official LSP protocol.s\n+ * @author sdedic\n+ */\n+public interface NbCodeLanguageClient extends LanguageClient {\n+    \n+    /**\n+     * Shows a message in the status bar. Log- and Info-type messages are shown \"as is\".\n+     * The other message types can be decorated by an icon according to {@link MessageParams#getType}.\n+     * The message will be hidden after specified number of milliseconds; 0 means the client\n+     * controls when the message is hidden.\n+     * \n+     * @param params message type and text.\n+     */\n+    @JsonNotification(\"window/showStatusBarMessage\")\n+    public void showStatusBarMessage(@NonNull ShowStatusMessageParams params);", "originalCommit": "4eb04ff2082067d261b907f169884d23f4a36c3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM1OTAxMQ==", "url": "https://github.com/apache/netbeans/pull/2478#discussion_r509359011", "bodyText": "Need still to learn :)", "author": "sdedic", "createdAt": "2020-10-21T14:54:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTAwMzk1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "a8630409c18288fe07b9edefbb3f53bb941bb7b9", "chunk": "diff --git a/java/java.lsp.server/src/org/netbeans/modules/java/lsp/server/protocol/NbCodeLanguageClient.java b/java/java.lsp.server/src/org/netbeans/modules/java/lsp/server/protocol/NbCodeLanguageClient.java\nindex 1b56105ad0..10ad5a64f8 100644\n--- a/java/java.lsp.server/src/org/netbeans/modules/java/lsp/server/protocol/NbCodeLanguageClient.java\n+++ b/java/java.lsp.server/src/org/netbeans/modules/java/lsp/server/protocol/NbCodeLanguageClient.java\n\n@@ -40,4 +40,10 @@ public interface NbCodeLanguageClient extends LanguageClient {\n      */\n     @JsonNotification(\"window/showStatusBarMessage\")\n     public void showStatusBarMessage(@NonNull ShowStatusMessageParams params);\n+    \n+    /**\n+     * Returns extended code capabilities.\n+     * @return code capabilities.\n+     */\n+    public NbCodeClientCapabilities getNbCodeCapabilities();\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTAwNTM2Mw==", "url": "https://github.com/apache/netbeans/pull/2478#discussion_r509005363", "bodyText": "wrapMessages! That's the trick. Cute.", "author": "JaroslavTulach", "createdAt": "2020-10-21T05:50:27Z", "path": "java/java.lsp.server/src/org/netbeans/modules/java/lsp/server/protocol/Server.java", "diffHunk": "@@ -77,14 +85,56 @@ public static void launchServer(InputStream in, OutputStream out) {\n             Exceptions.printStackTrace(ex);\n         }\n     }\n+    \n+    private static Launcher<NbCodeLanguageClient> createLauncher(LanguageServerImpl server, InputStream in, OutputStream out) {\n+        return new LSPLauncher.Builder<NbCodeLanguageClient>()\n+            .setLocalService(server)\n+            .setRemoteInterface(NbCodeLanguageClient.class)\n+            .setInput(in)\n+            .setOutput(out)\n+            .wrapMessages(new ConsumeWithLookup(server.getSessionLookup())::attachLookup)", "originalCommit": "4eb04ff2082067d261b907f169884d23f4a36c3f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a8630409c18288fe07b9edefbb3f53bb941bb7b9", "chunk": "diff --git a/java/java.lsp.server/src/org/netbeans/modules/java/lsp/server/protocol/Server.java b/java/java.lsp.server/src/org/netbeans/modules/java/lsp/server/protocol/Server.java\nindex c59ee5fad1..91bf54135c 100644\n--- a/java/java.lsp.server/src/org/netbeans/modules/java/lsp/server/protocol/Server.java\n+++ b/java/java.lsp.server/src/org/netbeans/modules/java/lsp/server/protocol/Server.java\n\n@@ -122,7 +122,7 @@ public final class Server {\n     private static class LanguageServerImpl implements LanguageServer, LanguageClientAware {\n \n         private static final Logger LOG = Logger.getLogger(LanguageServerImpl.class.getName());\n-        private LanguageClient client;\n+        private NbCodeClientWrapper client;\n         private final TextDocumentService textDocumentService = new TextDocumentServiceImpl();\n         private final WorkspaceService workspaceService = new WorkspaceServiceImpl();\n         private final InstanceContent   sessionServices = new InstanceContent();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTAwNTkwNA==", "url": "https://github.com/apache/netbeans/pull/2478#discussion_r509005904", "bodyText": "Wouldn't it be simpler if the type of client field was changed to NbCodeLanguageClient?", "author": "JaroslavTulach", "createdAt": "2020-10-21T05:52:09Z", "path": "java/java.lsp.server/src/org/netbeans/modules/java/lsp/server/protocol/Server.java", "diffHunk": "@@ -185,6 +236,15 @@ public WorkspaceService getWorkspaceService() {\n         @Override\n         public void connect(LanguageClient client) {\n             this.client = client;", "originalCommit": "4eb04ff2082067d261b907f169884d23f4a36c3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM1OTk1Mw==", "url": "https://github.com/apache/netbeans/pull/2478#discussion_r509359953", "bodyText": "If the capabilities are negotiated ?", "author": "sdedic", "createdAt": "2020-10-21T14:56:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTAwNTkwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM2NTM2OQ==", "url": "https://github.com/apache/netbeans/pull/2478#discussion_r509365369", "bodyText": "All the time. We can have the rich interface NbCodeLanguageClient, but only send messages that are allowed according to the capabilities.", "author": "JaroslavTulach", "createdAt": "2020-10-21T15:02:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTAwNTkwNA=="}], "type": "inlineReview", "revised_code": {"commit": "a8630409c18288fe07b9edefbb3f53bb941bb7b9", "chunk": "diff --git a/java/java.lsp.server/src/org/netbeans/modules/java/lsp/server/protocol/Server.java b/java/java.lsp.server/src/org/netbeans/modules/java/lsp/server/protocol/Server.java\nindex c59ee5fad1..91bf54135c 100644\n--- a/java/java.lsp.server/src/org/netbeans/modules/java/lsp/server/protocol/Server.java\n+++ b/java/java.lsp.server/src/org/netbeans/modules/java/lsp/server/protocol/Server.java\n\n@@ -234,8 +239,8 @@ public final class Server {\n         }\n \n         @Override\n-        public void connect(LanguageClient client) {\n-            this.client = client;\n+        public void connect(LanguageClient aClient) {\n+            this.client = new NbCodeClientWrapper((NbCodeLanguageClient)aClient);\n             \n             sessionServices.add(new WorkspaceIOContext() {\n                 @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTAwNjQ3NQ==", "url": "https://github.com/apache/netbeans/pull/2478#discussion_r509006475", "bodyText": "The TypeScript definition says timeout is optional. Shouldn't this method return Integer and null if the timeout isn't set?", "author": "JaroslavTulach", "createdAt": "2020-10-21T05:53:52Z", "path": "java/java.lsp.server/src/org/netbeans/modules/java/lsp/server/protocol/ShowStatusMessageParams.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.netbeans.modules.java.lsp.server.protocol;\n+\n+import org.eclipse.lsp4j.MessageParams;\n+import org.eclipse.lsp4j.MessageType;\n+import org.eclipse.xtext.xbase.lib.Pure;\n+\n+/**\n+ *\n+ * @author sdedic\n+ */\n+public class ShowStatusMessageParams extends MessageParams {\n+    private int timeout = 0;\n+\n+    public ShowStatusMessageParams(MessageType type, String message) {\n+        super(type, message);\n+    }\n+\n+    public ShowStatusMessageParams(MessageType type, String message, int timeout) {\n+        super(type, message);\n+        this.timeout = timeout;\n+    }\n+\n+    @Pure\n+    public int getTimeout() {", "originalCommit": "4eb04ff2082067d261b907f169884d23f4a36c3f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9439b695b22dabde9a32b6285f9353dd3cc6a593", "chunk": "diff --git a/java/java.lsp.server/src/org/netbeans/modules/java/lsp/server/protocol/ShowStatusMessageParams.java b/java/java.lsp.server/src/org/netbeans/modules/java/lsp/server/protocol/ShowStatusMessageParams.java\nindex 7f03122f8f..43af7366db 100644\n--- a/java/java.lsp.server/src/org/netbeans/modules/java/lsp/server/protocol/ShowStatusMessageParams.java\n+++ b/java/java.lsp.server/src/org/netbeans/modules/java/lsp/server/protocol/ShowStatusMessageParams.java\n\n@@ -18,6 +18,7 @@\n  */\n package org.netbeans.modules.java.lsp.server.protocol;\n \n+import java.util.Objects;\n import org.eclipse.lsp4j.MessageParams;\n import org.eclipse.lsp4j.MessageType;\n import org.eclipse.xtext.xbase.lib.Pure;\n"}}, {"oid": "9439b695b22dabde9a32b6285f9353dd3cc6a593", "url": "https://github.com/apache/netbeans/commit/9439b695b22dabde9a32b6285f9353dd3cc6a593", "message": "StatusDisplayer messages remoted to vscode.", "committedDate": "2020-10-22T09:59:07Z", "type": "commit"}, {"oid": "a8630409c18288fe07b9edefbb3f53bb941bb7b9", "url": "https://github.com/apache/netbeans/commit/a8630409c18288fe07b9edefbb3f53bb941bb7b9", "message": "Extended capabilities negotiated with the client.", "committedDate": "2020-10-22T09:59:07Z", "type": "commit"}, {"oid": "a8630409c18288fe07b9edefbb3f53bb941bb7b9", "url": "https://github.com/apache/netbeans/commit/a8630409c18288fe07b9edefbb3f53bb941bb7b9", "message": "Extended capabilities negotiated with the client.", "committedDate": "2020-10-22T09:59:07Z", "type": "forcePushed"}]}