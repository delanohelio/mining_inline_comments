{"pr_number": 2600, "pr_title": "First attempt add LSP-based rename refactoring to the Java LSP Server and the LSP Client.", "pr_createdAt": "2020-12-16T08:42:11Z", "pr_url": "https://github.com/apache/netbeans/pull/2600", "timeline": [{"oid": "47e84044c18576363cae1365fe1217e7c8a84f49", "url": "https://github.com/apache/netbeans/commit/47e84044c18576363cae1365fe1217e7c8a84f49", "message": "First attempt add LSP-based rename refactoring to the Java LSP Server and the LSP Client.", "committedDate": "2020-12-06T12:51:15Z", "type": "commit"}, {"oid": "597cb031cda6a2cf6a1c7edfa0c5fcd8570b7cfe", "url": "https://github.com/apache/netbeans/commit/597cb031cda6a2cf6a1c7edfa0c5fcd8570b7cfe", "message": "Fixing import order.", "committedDate": "2020-12-06T15:58:01Z", "type": "commit"}, {"oid": "dfec095ac978aab8162b7b2c46614cadf3b33b15", "url": "https://github.com/apache/netbeans/commit/dfec095ac978aab8162b7b2c46614cadf3b33b15", "message": "Merging master into the lsp-rename-refactoring branch.", "committedDate": "2020-12-06T19:03:13Z", "type": "commit"}, {"oid": "7250544ceea9da133a1e6be4ca890c7a6780e838", "url": "https://github.com/apache/netbeans/commit/7250544ceea9da133a1e6be4ca890c7a6780e838", "message": "Fixing import.", "committedDate": "2020-12-06T20:30:22Z", "type": "commit"}, {"oid": "70d2d3dafa787f35998e24e0a5ddbfed82a2ec10", "url": "https://github.com/apache/netbeans/commit/70d2d3dafa787f35998e24e0a5ddbfed82a2ec10", "message": "Resolving RAT problems.", "committedDate": "2020-12-08T06:30:10Z", "type": "commit"}, {"oid": "fe8132f7844b2c042165fb55837268b7df1141e4", "url": "https://github.com/apache/netbeans/commit/fe8132f7844b2c042165fb55837268b7df1141e4", "message": "Merging master into lsp-rename-refactoring", "committedDate": "2020-12-16T07:16:09Z", "type": "commit"}, {"oid": "4c865767568f091041c03d511757a533099d4427", "url": "https://github.com/apache/netbeans/commit/4c865767568f091041c03d511757a533099d4427", "message": "Merge branch 'master' into pr-2600", "committedDate": "2020-12-26T16:30:07Z", "type": "commit"}, {"oid": "52feaf755c926ee8af6a56993580c15b85df5397", "url": "https://github.com/apache/netbeans/commit/52feaf755c926ee8af6a56993580c15b85df5397", "message": "Implement cancelability for refactorings\n\nPrimary aim of this change is to be able to cancel dialog from\nrefactoring, without raising UnsupportedOperationException.", "committedDate": "2020-12-27T17:15:12Z", "type": "commit"}, {"oid": "26487ddd3a7285fbbcd25eb8c624536af016870b", "url": "https://github.com/apache/netbeans/commit/26487ddd3a7285fbbcd25eb8c624536af016870b", "message": "Register rename action into the popup menu", "committedDate": "2020-12-27T17:15:12Z", "type": "commit"}, {"oid": "1618fb4bfd9c5c8060b5ea4d2b6e065e5824671f", "url": "https://github.com/apache/netbeans/commit/1618fb4bfd9c5c8060b5ea4d2b6e065e5824671f", "message": "Ensure TokenSequence is accessed under document lock", "committedDate": "2020-12-27T17:15:13Z", "type": "commit"}, {"oid": "1449154d58d33f0a9023f8f819ee7b5c2c672118", "url": "https://github.com/apache/netbeans/commit/1449154d58d33f0a9023f8f819ee7b5c2c672118", "message": "Merge changes done by matthiasblaesing.", "committedDate": "2020-12-29T19:58:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA5MDcxNQ==", "url": "https://github.com/apache/netbeans/pull/2600#discussion_r552090715", "bodyText": "What is Set<TextDocumentServiceImpl> ALL_INSTANCES good for? It is only used from static void refreshAllEditors() that seems to be unused.", "author": "dbalek", "createdAt": "2021-01-05T17:45:38Z", "path": "java/java.lsp.server/src/org/netbeans/modules/java/lsp/server/protocol/TextDocumentServiceImpl.java", "diffHunk": "@@ -192,12 +205,14 @@\n \n     private static final RequestProcessor BACKGROUND_TASKS = new RequestProcessor(TextDocumentServiceImpl.class.getName(), 1, false, false);\n     private static final RequestProcessor WORKER = new RequestProcessor(TextDocumentServiceImpl.class.getName(), 1, false, false);\n+    private static final Set<TextDocumentServiceImpl> ALL_INSTANCES = Collections.newSetFromMap(new WeakHashMap<>());", "originalCommit": "1449154d58d33f0a9023f8f819ee7b5c2c672118", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjE5ODU5Ng==", "url": "https://github.com/apache/netbeans/pull/2600#discussion_r552198596", "bodyText": "Sorry, this was part of a (failed) attempt to fix an unrelated problem and should not be here. Removed in 5987977.", "author": "jlahoda", "createdAt": "2021-01-05T21:14:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA5MDcxNQ=="}], "type": "inlineReview", "revised_code": {"commit": "59879772afcd7c58b978bd0a17abe6472c71be5c", "chunk": "diff --git a/java/java.lsp.server/src/org/netbeans/modules/java/lsp/server/protocol/TextDocumentServiceImpl.java b/java/java.lsp.server/src/org/netbeans/modules/java/lsp/server/protocol/TextDocumentServiceImpl.java\nindex 675cee0441..0ee626e125 100644\n--- a/java/java.lsp.server/src/org/netbeans/modules/java/lsp/server/protocol/TextDocumentServiceImpl.java\n+++ b/java/java.lsp.server/src/org/netbeans/modules/java/lsp/server/protocol/TextDocumentServiceImpl.java\n\n@@ -205,14 +204,12 @@ public class TextDocumentServiceImpl implements TextDocumentService, LanguageCli\n \n     private static final RequestProcessor BACKGROUND_TASKS = new RequestProcessor(TextDocumentServiceImpl.class.getName(), 1, false, false);\n     private static final RequestProcessor WORKER = new RequestProcessor(TextDocumentServiceImpl.class.getName(), 1, false, false);\n-    private static final Set<TextDocumentServiceImpl> ALL_INSTANCES = Collections.newSetFromMap(new WeakHashMap<>());\n \n     private final Map<String, Document> openedDocuments = new HashMap<>();\n     private final Map<String, RequestProcessor.Task> diagnosticTasks = new HashMap<>();\n     private NbCodeLanguageClient client;\n \n     public TextDocumentServiceImpl() {\n-        ALL_INSTANCES.add(this);\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA5MTA1NA==", "url": "https://github.com/apache/netbeans/pull/2600#discussion_r552091054", "bodyText": "Seems to be unused.", "author": "dbalek", "createdAt": "2021-01-05T17:46:13Z", "path": "java/java.lsp.server/src/org/netbeans/modules/java/lsp/server/protocol/TextDocumentServiceImpl.java", "diffHunk": "@@ -1410,20 +1556,37 @@ public static int getOffset(Document doc, Position pos) {\n             file[0] = wc.getFileObject();\n             lm[0] = wc.getCompilationUnit().getLineMap();\n         });\n+        return fileModifications(changes, file[0], lm[0]);\n+    }\n+    \n+    private static List<TextEdit> fileModifications(ModificationResult changes, FileObject file, LineMap lm) {\n         //TODO: full, correct and safe edit production:\n-        List<? extends ModificationResult.Difference> diffs = changes.getDifferences(file[0]);\n+        List<? extends ModificationResult.Difference> diffs = changes.getDifferences(file);\n         if (diffs == null) {\n             return Collections.emptyList();\n         }\n         List<TextEdit> edits = new ArrayList<>();\n+        IntFunction<Position> offset2Position = lm != null ? pos -> Utils.createPosition(lm, pos)\n+                                                           : pos -> Utils.createPosition(file, pos);\n+                                            \n         for (ModificationResult.Difference diff : diffs) {\n             String newText = diff.getNewText();\n-            edits.add(new TextEdit(new Range(Utils.createPosition(lm[0], diff.getStartPosition().getOffset()),\n-                                             Utils.createPosition(lm[0], diff.getEndPosition().getOffset())),\n+            edits.add(new TextEdit(new Range(offset2Position.apply(diff.getStartPosition().getOffset()),\n+                                             offset2Position.apply(diff.getEndPosition().getOffset())),\n                                    newText != null ? newText : \"\"));\n         }\n         return edits;\n     }\n+    \n+    static void refreshAllEditors() {", "originalCommit": "1449154d58d33f0a9023f8f819ee7b5c2c672118", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "59879772afcd7c58b978bd0a17abe6472c71be5c", "chunk": "diff --git a/java/java.lsp.server/src/org/netbeans/modules/java/lsp/server/protocol/TextDocumentServiceImpl.java b/java/java.lsp.server/src/org/netbeans/modules/java/lsp/server/protocol/TextDocumentServiceImpl.java\nindex 675cee0441..0ee626e125 100644\n--- a/java/java.lsp.server/src/org/netbeans/modules/java/lsp/server/protocol/TextDocumentServiceImpl.java\n+++ b/java/java.lsp.server/src/org/netbeans/modules/java/lsp/server/protocol/TextDocumentServiceImpl.java\n\n@@ -1577,16 +1574,6 @@ public class TextDocumentServiceImpl implements TextDocumentService, LanguageCli\n         }\n         return edits;\n     }\n-    \n-    static void refreshAllEditors() {\n-        for (TextDocumentServiceImpl impl : ALL_INSTANCES) {\n-            System.err.println(\"impl: \" + impl);\n-            for (String uri : impl.openedDocuments.keySet()) {\n-                System.err.println(\"uri=\" + uri);\n-                impl.runDiagnoticTasks(uri);\n-            }\n-        }\n-    }\n \n     private static void reportNotificationDone(String s, Object parameter) {\n         if (HOOK_NOTIFICATION != null) {\n"}}, {"oid": "59879772afcd7c58b978bd0a17abe6472c71be5c", "url": "https://github.com/apache/netbeans/commit/59879772afcd7c58b978bd0a17abe6472c71be5c", "message": "Removing unnecessary code.", "committedDate": "2021-01-05T21:13:40Z", "type": "commit"}]}