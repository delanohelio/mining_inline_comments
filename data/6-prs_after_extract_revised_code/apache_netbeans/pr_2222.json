{"pr_number": 2222, "pr_title": "[NETBEANS-4311]: Added support for auto-completion of Java Record", "pr_createdAt": "2020-06-29T14:33:41Z", "pr_url": "https://github.com/apache/netbeans/pull/2222", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODYzODYwNg==", "url": "https://github.com/apache/netbeans/pull/2222#discussion_r458638606", "bodyText": "Sorry, but I am not sure we should filter out j.l.Record here. We are not filtering any other element AFAIK, so why Record?", "author": "lahodaj", "createdAt": "2020-07-22T08:51:37Z", "path": "java/java.completion/src/org/netbeans/modules/java/completion/JavaCompletionTask.java", "diffHunk": "@@ -3930,6 +4136,8 @@ public boolean accept(Element e, TypeMirror t) {\n             }\n         };\n         for (TypeElement e : controller.getElementUtilities().getGlobalTypes(acceptor)) {\n+            if (e.getQualifiedName().toString().equals(JAVA_LANG_RECORD) && env.getController().getSourceVersion().compareTo(SOURCE_VERSION_RELEASE_14) < 0) ", "originalCommit": "95b95096c1c3bc4f7b2d0d6e887498c661f4a266", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODcxMjk0NQ==", "url": "https://github.com/apache/netbeans/pull/2222#discussion_r458712945", "bodyText": "If I don't add the check , 'Record' entry need to be added in old golden files (roughly 65 files) otherwise existing test-cases will fail with nb-javac for 14", "author": "arusinha", "createdAt": "2020-07-22T11:06:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODYzODYwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI0NTcwMQ==", "url": "https://github.com/apache/netbeans/pull/2222#discussion_r459245701", "bodyText": "Sorry, I am unclear which files - the code completion tests run and pass on JDK 14 without nb-javac, the golden files have been updated some time ago. I believe files like \".../JavaCompletionTaskTest/14/initBlockTypesAndLocalMembers.pass\" have been specifically added so that the tests would pass on JDK 14. Not sure if nb-javac should change anything here?", "author": "lahodaj", "createdAt": "2020-07-23T06:49:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODYzODYwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY2Nzc4NQ==", "url": "https://github.com/apache/netbeans/pull/2222#discussion_r460667785", "bodyText": "java.lang.Record check is now removed. The problem was the in the proposed nb-javac-14 where it was added by mistake,corrected now", "author": "arusinha", "createdAt": "2020-07-27T06:15:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODYzODYwNg=="}], "type": "inlineReview", "revised_code": {"commit": "84ed378465d5ece29d5ff47b6f716a1209cedb5f", "chunk": "diff --git a/java/java.completion/src/org/netbeans/modules/java/completion/JavaCompletionTask.java b/java/java.completion/src/org/netbeans/modules/java/completion/JavaCompletionTask.java\nindex 8365f50f97..ef40212b71 100644\n--- a/java/java.completion/src/org/netbeans/modules/java/completion/JavaCompletionTask.java\n+++ b/java/java.completion/src/org/netbeans/modules/java/completion/JavaCompletionTask.java\n\n@@ -4136,8 +4134,6 @@ public final class JavaCompletionTask<T> extends BaseTask {\n             }\n         };\n         for (TypeElement e : controller.getElementUtilities().getGlobalTypes(acceptor)) {\n-            if (e.getQualifiedName().toString().equals(JAVA_LANG_RECORD) && env.getController().getSourceVersion().compareTo(SOURCE_VERSION_RELEASE_14) < 0) \n-                continue;\n             results.add(itemFactory.createTypeItem(env.getController(), e, (DeclaredType) e.asType(), anchorOffset, null, elements.isDeprecated(e), env.isInsideNew(), env.isInsideNew() || env.isInsideClass(), false, false, false));\n         }\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODY0NjMzNQ==", "url": "https://github.com/apache/netbeans/pull/2222#discussion_r458646335", "bodyText": "I think this method's name and content do not really match - it is not only \"isRecordSupported\", but also \"and is the prefix a prefix of 'record''. I would suggest to drop the second concern from this method. Many callers don't need the prefix check. I counted just two callers that really need to check the prefix (for many, the prefix check happens automatically later), and I think it would be cleaner for them to call the prefix check explicitly.\nAlso, for discussion - should there be a preview enablement test here as well?", "author": "lahodaj", "createdAt": "2020-07-22T09:04:26Z", "path": "java/java.completion/src/org/netbeans/modules/java/completion/JavaCompletionTask.java", "diffHunk": "@@ -3008,10 +3027,194 @@ private void insideBreakOrContinue(Env env) throws IOException {\n             }\n         }\n     }\n+    \n+    private void addClassTypes(final Env env, DeclaredType baseType) throws IOException{\n+        EnumSet<ElementKind> classKinds = EnumSet.of(CLASS, INTERFACE, ENUM, ANNOTATION_TYPE, TYPE_PARAMETER);\n+        if (isRecordSupported(env, null)) {\n+            classKinds.add(TreeShims.getRecordKind());\n+        }\n+        addTypes(env, classKinds, null);\n+    }\n+\n+    private boolean isRecordSupported(final Env env, String prefix) {", "originalCommit": "95b95096c1c3bc4f7b2d0d6e887498c661f4a266", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY2Nzk4NA==", "url": "https://github.com/apache/netbeans/pull/2222#discussion_r460667984", "bodyText": "Corrected the method signature now.\nWe are not using enable-preview flag to enable/disable text-block auto-completion. Propose to retain the same behavior. If someone types \"rec\" it will be auto completed to \"record\" . He/She can then use the enable-preview hint to add the required parameter", "author": "arusinha", "createdAt": "2020-07-27T06:16:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODY0NjMzNQ=="}], "type": "inlineReview", "revised_code": {"commit": "84ed378465d5ece29d5ff47b6f716a1209cedb5f", "chunk": "diff --git a/java/java.completion/src/org/netbeans/modules/java/completion/JavaCompletionTask.java b/java/java.completion/src/org/netbeans/modules/java/completion/JavaCompletionTask.java\nindex 8365f50f97..ef40212b71 100644\n--- a/java/java.completion/src/org/netbeans/modules/java/completion/JavaCompletionTask.java\n+++ b/java/java.completion/src/org/netbeans/modules/java/completion/JavaCompletionTask.java\n\n@@ -3030,15 +3029,14 @@ public final class JavaCompletionTask<T> extends BaseTask {\n     \n     private void addClassTypes(final Env env, DeclaredType baseType) throws IOException{\n         EnumSet<ElementKind> classKinds = EnumSet.of(CLASS, INTERFACE, ENUM, ANNOTATION_TYPE, TYPE_PARAMETER);\n-        if (isRecordSupported(env, null)) {\n+        if (isRecordSupported(env)) {\n             classKinds.add(TreeShims.getRecordKind());\n         }\n-        addTypes(env, classKinds, null);\n+        addTypes(env, classKinds, baseType);\n     }\n \n-    private boolean isRecordSupported(final Env env, String prefix) {\n-        return (SOURCE_VERSION_RELEASE_14 != null && env.getController().getSourceVersion().compareTo(SOURCE_VERSION_RELEASE_14) >= 0\n-                && Utilities.startsWith(RECORD_KEYWORD, prefix));\n+    private boolean isRecordSupported(final Env env) {\n+        return (SOURCE_VERSION_RELEASE_14 != null && env.getController().getSourceVersion().compareTo(SOURCE_VERSION_RELEASE_14) >= 0);\n     }\n \n     private void insideRecord(Env env) throws IOException {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODY0Njg1NQ==", "url": "https://github.com/apache/netbeans/pull/2222#discussion_r458646855", "bodyText": "The baseType parameter is unused. Suggest to either pass it to addTypes, or drop it.", "author": "lahodaj", "createdAt": "2020-07-22T09:05:13Z", "path": "java/java.completion/src/org/netbeans/modules/java/completion/JavaCompletionTask.java", "diffHunk": "@@ -3008,10 +3027,194 @@ private void insideBreakOrContinue(Env env) throws IOException {\n             }\n         }\n     }\n+    \n+    private void addClassTypes(final Env env, DeclaredType baseType) throws IOException{", "originalCommit": "95b95096c1c3bc4f7b2d0d6e887498c661f4a266", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTIwNjcwMQ==", "url": "https://github.com/apache/netbeans/pull/2222#discussion_r459206701", "bodyText": "thanks for correcting me, I will pass the parameter to to addTypes call", "author": "arusinha", "createdAt": "2020-07-23T04:19:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODY0Njg1NQ=="}], "type": "inlineReview", "revised_code": {"commit": "84ed378465d5ece29d5ff47b6f716a1209cedb5f", "chunk": "diff --git a/java/java.completion/src/org/netbeans/modules/java/completion/JavaCompletionTask.java b/java/java.completion/src/org/netbeans/modules/java/completion/JavaCompletionTask.java\nindex 8365f50f97..ef40212b71 100644\n--- a/java/java.completion/src/org/netbeans/modules/java/completion/JavaCompletionTask.java\n+++ b/java/java.completion/src/org/netbeans/modules/java/completion/JavaCompletionTask.java\n\n@@ -3030,15 +3029,14 @@ public final class JavaCompletionTask<T> extends BaseTask {\n     \n     private void addClassTypes(final Env env, DeclaredType baseType) throws IOException{\n         EnumSet<ElementKind> classKinds = EnumSet.of(CLASS, INTERFACE, ENUM, ANNOTATION_TYPE, TYPE_PARAMETER);\n-        if (isRecordSupported(env, null)) {\n+        if (isRecordSupported(env)) {\n             classKinds.add(TreeShims.getRecordKind());\n         }\n-        addTypes(env, classKinds, null);\n+        addTypes(env, classKinds, baseType);\n     }\n \n-    private boolean isRecordSupported(final Env env, String prefix) {\n-        return (SOURCE_VERSION_RELEASE_14 != null && env.getController().getSourceVersion().compareTo(SOURCE_VERSION_RELEASE_14) >= 0\n-                && Utilities.startsWith(RECORD_KEYWORD, prefix));\n+    private boolean isRecordSupported(final Env env) {\n+        return (SOURCE_VERSION_RELEASE_14 != null && env.getController().getSourceVersion().compareTo(SOURCE_VERSION_RELEASE_14) >= 0);\n     }\n \n     private void insideRecord(Env env) throws IOException {\n"}}, {"oid": "84ed378465d5ece29d5ff47b6f716a1209cedb5f", "url": "https://github.com/apache/netbeans/commit/84ed378465d5ece29d5ff47b6f716a1209cedb5f", "message": "[NETBEANS-4311]: Added support for auto-completion of Java Record", "committedDate": "2020-07-30T02:12:51Z", "type": "commit"}, {"oid": "84ed378465d5ece29d5ff47b6f716a1209cedb5f", "url": "https://github.com/apache/netbeans/commit/84ed378465d5ece29d5ff47b6f716a1209cedb5f", "message": "[NETBEANS-4311]: Added support for auto-completion of Java Record", "committedDate": "2020-07-30T02:12:51Z", "type": "forcePushed"}]}