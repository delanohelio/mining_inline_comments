{"pr_number": 2139, "pr_title": "NETBEANS-2082: do not scroll to caret after fold collapse, if caret is s off-screen.", "pr_createdAt": "2020-05-15T14:34:29Z", "pr_url": "https://github.com/apache/netbeans/pull/2139", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA2Mjc1Mg==", "url": "https://github.com/apache/netbeans/pull/2139#discussion_r426062752", "bodyText": "Should this variable perhaps be called \"changeToCollapsed\" rather than \"changedToCollapsed\"?\nAlso, why keep this variable at all--why not just do \"collapsedFoldEncountered = true\" instead?", "author": "eirikbakke", "createdAt": "2020-05-15T21:51:14Z", "path": "ide/editor.fold.nbui/src/org/netbeans/modules/editor/fold/ui/FoldViewFactory.java", "diffHunk": "@@ -260,24 +260,25 @@ public void finishCreation() {\n \n     @Override\n     public void foldHierarchyChanged(FoldHierarchyEvent evt) {\n-        if (!collapsedFoldEncountered) {\n-            // Check if any collapsed fold was added or a collapsed/expanded state changed\n-            for (int i = evt.getAddedFoldCount() - 1; i >= 0; i--) {\n-                if (evt.getAddedFold(i).isCollapsed()) {\n-                    collapsedFoldEncountered = true;\n-                    break;\n-                }\n+        boolean collapsedAdded = false;\n+        boolean changedToCollapsed = false;\n+        // Check if any collapsed fold was added or a collapsed/expanded state changed\n+        for (int i = evt.getAddedFoldCount() - 1; i >= 0; i--) {\n+            if (evt.getAddedFold(i).isCollapsed()) {\n+                collapsedAdded = true;\n+                break;\n             }\n-            if (!collapsedFoldEncountered) {\n-                for (int i = evt.getFoldStateChangeCount() - 1; i >= 0; i--) {\n-                    FoldStateChange foldStateChange = evt.getFoldStateChange(i);\n-                    if (foldStateChange.isCollapsedChanged() && foldStateChange.getFold().isCollapsed()) {\n-                        collapsedFoldEncountered = true;\n-                        break;\n-                    }\n+        }\n+        if (!collapsedAdded) {\n+            for (int i = evt.getFoldStateChangeCount() - 1; i >= 0; i--) {\n+                FoldStateChange foldStateChange = evt.getFoldStateChange(i);\n+                if (foldStateChange.isCollapsedChanged() && foldStateChange.getFold().isCollapsed()) {\n+                    changedToCollapsed = true;", "originalCommit": "39f56ef4b49b26bb77d3c0b7ab3a025aa4f6df04", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjEyMDQzNw==", "url": "https://github.com/apache/netbeans/pull/2139#discussion_r426120437", "bodyText": "strictly speaking, the folds have been already changed when this event is inspected :) Or is the extra 'd' some typo/grammar-like error ?\nI like more to update the shared variable from a single assignment; does the suggestion bring some objective improvement, or is it rather a personal taste ?", "author": "sdedic", "createdAt": "2020-05-16T05:25:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA2Mjc1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjEyMTM3Ng==", "url": "https://github.com/apache/netbeans/pull/2139#discussion_r426121376", "bodyText": "Oh, I see, it's not just that there has been a change to a collapsed fold, but that it has been changed from not collapsed to collapsed. Your name makes sense now.\nIt's fine as it stands.", "author": "eirikbakke", "createdAt": "2020-05-16T05:40:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA2Mjc1Mg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA2MzE0Ng==", "url": "https://github.com/apache/netbeans/pull/2139#discussion_r426063146", "bodyText": "Would be good to add a comment here referencing the bug that is fixed by doing updateRetainsVisibleOnce only in the collapsedAdded case, and why this fixes the bug.", "author": "eirikbakke", "createdAt": "2020-05-15T21:52:34Z", "path": "ide/editor.fold.nbui/src/org/netbeans/modules/editor/fold/ui/FoldViewFactory.java", "diffHunk": "@@ -289,7 +290,9 @@ public void foldHierarchyChanged(FoldHierarchyEvent evt) {\n                 ViewUtils.log(CHANGE_LOG, \"CHANGE in FoldViewFactory: <\" + // NOI18N\n                         startOffset + \",\" + endOffset + \">\\n\"); // NOI18N\n             }\n-            comp.putClientProperty(\"editorcaret.updateRetainsVisibleOnce\", Boolean.TRUE);\n+            if (collapsedAdded) {", "originalCommit": "39f56ef4b49b26bb77d3c0b7ab3a025aa4f6df04", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjEyMDIzNg==", "url": "https://github.com/apache/netbeans/pull/2139#discussion_r426120236", "bodyText": "Usually that's why the commit message references a JIRA issue; for more context. But will leave a short comment here.", "author": "sdedic", "createdAt": "2020-05-16T05:21:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA2MzE0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjEyMTUyMQ==", "url": "https://github.com/apache/netbeans/pull/2139#discussion_r426121521", "bodyText": "The principle I like to follow is that the the code should be readable without doing a \"git blame\" on it, and ideally without reading the JIRA description either (though the comment can certainly be short).", "author": "eirikbakke", "createdAt": "2020-05-16T05:43:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA2MzE0Ng=="}], "type": "inlineReview", "revised_code": {"commit": "150a06b191e5f84666080b0168517c30c6b85a61", "chunk": "diff --git a/ide/editor.fold.nbui/src/org/netbeans/modules/editor/fold/ui/FoldViewFactory.java b/ide/editor.fold.nbui/src/org/netbeans/modules/editor/fold/ui/FoldViewFactory.java\nindex 979ba8b5af..c729e3e874 100644\n--- a/ide/editor.fold.nbui/src/org/netbeans/modules/editor/fold/ui/FoldViewFactory.java\n+++ b/ide/editor.fold.nbui/src/org/netbeans/modules/editor/fold/ui/FoldViewFactory.java\n\n@@ -291,6 +291,8 @@ public final class FoldViewFactory extends EditorViewFactory implements FoldHier\n                         startOffset + \",\" + endOffset + \">\\n\"); // NOI18N\n             }\n             if (collapsedAdded) {\n+                // this hint covers a specific case when a fold is created as *initially* collapsed\n+                // to maintain caret position on screen, if the caret was visible. \n                 comp.putClientProperty(\"editorcaret.updateRetainsVisibleOnce\", Boolean.TRUE);\n             }\n             fireEvent(EditorViewFactoryChange.createList(startOffset, endOffset,\n"}}, {"oid": "150a06b191e5f84666080b0168517c30c6b85a61", "url": "https://github.com/apache/netbeans/commit/150a06b191e5f84666080b0168517c30c6b85a61", "message": "NETBEANS-2082: do not scroll to caret after fold collapse, if caret is off-screen.", "committedDate": "2020-05-17T07:05:32Z", "type": "commit"}, {"oid": "150a06b191e5f84666080b0168517c30c6b85a61", "url": "https://github.com/apache/netbeans/commit/150a06b191e5f84666080b0168517c30c6b85a61", "message": "NETBEANS-2082: do not scroll to caret after fold collapse, if caret is off-screen.", "committedDate": "2020-05-17T07:05:32Z", "type": "forcePushed"}]}