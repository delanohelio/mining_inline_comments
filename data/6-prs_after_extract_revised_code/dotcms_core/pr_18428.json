{"pr_number": 18428, "pr_title": "Issue 17806 ppfilters", "pr_createdAt": "2020-05-02T01:23:00Z", "pr_url": "https://github.com/dotCMS/core/pull/18428", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwODkxMA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424608910", "bodyText": "rename to\nfinal Structure contentType or final Structure structure", "author": "jdotcms", "createdAt": "2020-05-13T17:27:41Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -621,119 +688,155 @@ private void setHTMLPagesDependencies(Set<String> idsToWork) {\n \t\t\t\tIdentifier iden = idenAPI.find(pageId);\n \n \t\t\t\t// Host dependency\n-\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n-\t\t\t\thosts.addOrClean( iden.getHostId(), h.getModDate());\n-\t\t\t\thostsSet.add(iden.getHostId());\n-\t\t\t\tFolder folder = folderAPI.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n-\t\t\t\tfolders.addOrClean( folder.getInode(), folder.getModDate());\n-\t\t\t\tfoldersSet.add(folder.getInode());\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n+\t\t\t\t\thosts.addOrClean(iden.getHostId(), h.getModDate());\n+\t\t\t\t\thostsSet.add(iden.getHostId());\n+\t\t\t\t}\n \n+\t\t\t\t// Folder dependencies\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n+\t\t\t\t\tFolder folder = folderAPI\n+\t\t\t\t\t\t\t.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n+\t\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n+\t\t\t\t\tfoldersSet.add(folder.getInode());\n+\t\t\t\t}\n \n \t\t\t\t// looking for working version (must exists)\n \t\t\t\tIHTMLPage workingPage = null;\n \n \t\t\t\tContentlet contentlet = null;\n-\t\t\t\ttry{\n-\t\t\t\t\tcontentlet = APILocator.getContentletAPI().search(\"+identifier:\"+pageId+\" +working:true\", 0, 0, \"moddate\", user, false).get(0);\n+\t\t\t\ttry {\n+\t\t\t\t\tcontentlet = APILocator.getContentletAPI()\n+\t\t\t\t\t\t\t.search(\"+identifier:\" + pageId + \" +working:true\", 0, 0, \"moddate\",\n+\t\t\t\t\t\t\t\t\tuser, false).get(0);\n \t\t\t\t} catch (DotContentletStateException e) {\n \t\t\t\t\t// content not found message is already displayed on console\n-\t\t\t\t\tLogger.debug(this, e.getMessage(),e);\n+\t\t\t\t\tLogger.debug(this, e.getMessage(), e);\n \t\t\t\t}\n-\t\t\t\tif(contentlet != null)\n+\t\t\t\tif (contentlet != null)\n \t\t\t\t\tworkingPage = APILocator.getHTMLPageAssetAPI().fromContentlet(contentlet);\n \n-\n \t\t\t\t// looking for live version (might not exists)\n \t\t\t\tIHTMLPage livePage = null;\n \n \t\t\t\tcontentlet = null;\n-\t\t\t\ttry{\n-\t\t\t\t\tList<Contentlet> result = APILocator.getContentletAPI().search(\"+identifier:\"+pageId+\" +live:true\", 0, 0, \"moddate\", user, false);\n-\t\t\t\t\tif(!result.isEmpty()) {\n+\t\t\t\ttry {\n+\t\t\t\t\tList<Contentlet> result = APILocator.getContentletAPI()\n+\t\t\t\t\t\t\t.search(\"+identifier:\" + pageId + \" +live:true\", 0, 0, \"moddate\", user,\n+\t\t\t\t\t\t\t\t\tfalse);\n+\t\t\t\t\tif (!result.isEmpty()) {\n \t\t\t\t\t\tcontentlet = result.get(0);\n \t\t\t\t\t}\n \n \t\t\t\t} catch (DotContentletStateException e) {\n \t\t\t\t\t// content not found message is already displayed on console\n-\t\t\t\t\tLogger.debug(this, e.getMessage(),e);\n+\t\t\t\t\tLogger.debug(this, e.getMessage(), e);\n \t\t\t\t}\n-\t\t\t\tif(contentlet != null)\n-\t\t\t\t\tlivePage = APILocator.getHTMLPageAssetAPI().fromContentlet(contentlet); \n-\n+\t\t\t\tif (contentlet != null)\n+\t\t\t\t\tlivePage = APILocator.getHTMLPageAssetAPI().fromContentlet(contentlet);\n \n \t\t\t\t// working template working page\n \t\t\t\tTemplate workingTemplateWP = null;\n \t\t\t\t// live template working page\n \t\t\t\tTemplate liveTemplateWP = null;\n \n-\t\t\t\tif(workingPage!=null) {\n-\t\t\t\t\tworkingTemplateWP = APILocator.getTemplateAPI().findWorkingTemplate(workingPage.getTemplateId(), user, false);\n-\t\t\t\t\tliveTemplateWP = APILocator.getTemplateAPI().findLiveTemplate(workingPage.getTemplateId(), user, false);\n+\t\t\t\tif (workingPage != null) {\n+\t\t\t\t\tworkingTemplateWP = APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.findWorkingTemplate(workingPage.getTemplateId(), user, false);\n+\t\t\t\t\tliveTemplateWP = APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.findLiveTemplate(workingPage.getTemplateId(), user, false);\n \t\t\t\t\t// Templates dependencies\n-\t\t\t\t\ttemplates.addOrClean( workingPage.getTemplateId(), workingTemplateWP.getModDate());\n-\t\t\t\t\ttemplatesSet.add(workingPage.getTemplateId());\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.TEMPLATE.getType())) {\n+\t\t\t\t\t\ttemplates.addOrClean(workingPage.getTemplateId(),\n+\t\t\t\t\t\t\t\tworkingTemplateWP.getModDate());\n+\t\t\t\t\t\ttemplatesSet.add(workingPage.getTemplateId());\n+\t\t\t\t\t}\n \t\t\t\t}\n \n \t\t\t\tTemplate liveTemplateLP = null;\n \n \t\t\t\t// live template live page\n-\t\t\t\tif(livePage!=null) {\n-\t\t\t\t\tliveTemplateLP = APILocator.getTemplateAPI().findLiveTemplate(livePage.getTemplateId(), user, false);\n+\t\t\t\tif (livePage != null) {\n+\t\t\t\t\tliveTemplateLP = APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.findLiveTemplate(livePage.getTemplateId(), user, false);\n \t\t\t\t\t// Templates dependencies\n-\t\t\t\t\ttemplates.addOrClean( livePage.getTemplateId(), livePage.getModDate());\n-\t\t\t\t\ttemplatesSet.add(livePage.getTemplateId());\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.TEMPLATE.getType())) {\n+\t\t\t\t\t\ttemplates.addOrClean(livePage.getTemplateId(), livePage.getModDate());\n+\t\t\t\t\t\ttemplatesSet.add(livePage.getTemplateId());\n+\t\t\t\t\t}\n \t\t\t\t}\n \n-\t\t\t\t// Containers dependencies\n \t\t\t\tcontainerList.clear();\n \n-\t\t\t\tif(workingTemplateWP!=null && InodeUtils.isSet(workingTemplateWP.getInode())){\n-\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI().getContainersInTemplate(workingTemplateWP, user, false));\n+\t\t\t\tif (workingTemplateWP != null && InodeUtils.isSet(workingTemplateWP.getInode())) {\n+\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.getContainersInTemplate(workingTemplateWP, user, false));\n \t\t\t\t}\n-\t\t\t\tif(liveTemplateWP!=null && InodeUtils.isSet(liveTemplateWP.getInode())){\n-\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI().getContainersInTemplate(liveTemplateWP, user, false));\n+\t\t\t\tif (liveTemplateWP != null && InodeUtils.isSet(liveTemplateWP.getInode())) {\n+\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.getContainersInTemplate(liveTemplateWP, user, false));\n \t\t\t\t}\n-\t\t\t\tif(liveTemplateLP!=null && InodeUtils.isSet(liveTemplateLP.getInode())){\n-\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI().getContainersInTemplate(liveTemplateLP, user, false));\n+\t\t\t\tif (liveTemplateLP != null && InodeUtils.isSet(liveTemplateLP.getInode())) {\n+\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.getContainersInTemplate(liveTemplateLP, user, false));\n \t\t\t\t}\n \n \t\t\t\tfor (Container container : containerList) {\n-\n-\t\t\t\t\tif (container instanceof FileAssetContainer) {\n-\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\tcontainers.addOrClean(container.getIdentifier(), container.getModDate());\n-\t\t\t\t\t\tcontainersSet.add(container.getIdentifier());\n+\t\t\t\t\t// Containers dependencies\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTAINER.getType())) {\n+\t\t\t\t\t\tif (container instanceof FileAssetContainer) {\n+\t\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n+\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\tcontainers\n+\t\t\t\t\t\t\t\t\t.addOrClean(container.getIdentifier(), container.getModDate());\n+\t\t\t\t\t\t\tcontainersSet.add(container.getIdentifier());\n+\t\t\t\t\t\t}\n \t\t\t\t\t}\n \n \t\t\t\t\t// Structure dependencies\n-\t\t\t\t\tList<ContainerStructure> csList = APILocator.getContainerAPI().getContainerStructures(container);\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENT_TYPE.getType())) {\n+\t\t\t\t\t\tList<ContainerStructure> csList = APILocator.getContainerAPI()\n+\t\t\t\t\t\t\t\t.getContainerStructures(container);\n \n-\t\t\t\t\tfor (ContainerStructure containerStructure : csList) {\n-\t\t\t\t\t\tStructure st = CacheLocator.getContentTypeCache().getStructureByInode(containerStructure.getStructureId());\n-\t\t\t\t\t\tstructures.addOrClean(containerStructure.getStructureId(), st.getModDate());\n-\t\t\t\t\t\tstructuresSet.add(containerStructure.getStructureId());\n+\t\t\t\t\t\tfor (ContainerStructure containerStructure : csList) {\n+\t\t\t\t\t\t\tStructure st = CacheLocator.getContentTypeCache()", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -680,24 +680,24 @@ public class DependencyManager {\n \n \t\ttry {\n \n-\t\t\tIdentifierAPI idenAPI = APILocator.getIdentifierAPI();\n-\t\t\tFolderAPI folderAPI = APILocator.getFolderAPI();\n-\t\t\tSet<Container> containerList = new HashSet<>();\n+\t\t\tfinal IdentifierAPI idenAPI = APILocator.getIdentifierAPI();\n+\t\t\tfinal FolderAPI folderAPI = APILocator.getFolderAPI();\n+\t\t\tfinal Set<Container> containerList = new HashSet<>();\n \n-\t\t\tfor (String pageId : idsToWork) {\n-\t\t\t\tIdentifier iden = idenAPI.find(pageId);\n+\t\t\tfor (final String pageId : idsToWork) {\n+\t\t\t\tfinal Identifier identifier = idenAPI.find(pageId);\n \n \t\t\t\t// Host dependency\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n-\t\t\t\t\thosts.addOrClean(iden.getHostId(), h.getModDate());\n-\t\t\t\t\thostsSet.add(iden.getHostId());\n+\t\t\t\t\tfinal Host host = APILocator.getHostAPI().find(identifier.getHostId(), user, false);\n+\t\t\t\t\thosts.addOrClean(identifier.getHostId(), host.getModDate());\n+\t\t\t\t\thostsSet.add(identifier.getHostId());\n \t\t\t\t}\n \n \t\t\t\t// Folder dependencies\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n-\t\t\t\t\tFolder folder = folderAPI\n-\t\t\t\t\t\t\t.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n+\t\t\t\t\tfinal Folder folder = folderAPI\n+\t\t\t\t\t\t\t.findFolderByPath(identifier.getParentPath(), identifier.getHostId(), user, false);\n \t\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n \t\t\t\t\tfoldersSet.add(folder.getInode());\n \t\t\t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwOTA1OA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424609058", "bodyText": "set to final", "author": "jdotcms", "createdAt": "2020-05-13T17:27:54Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -621,119 +688,155 @@ private void setHTMLPagesDependencies(Set<String> idsToWork) {\n \t\t\t\tIdentifier iden = idenAPI.find(pageId);\n \n \t\t\t\t// Host dependency\n-\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n-\t\t\t\thosts.addOrClean( iden.getHostId(), h.getModDate());\n-\t\t\t\thostsSet.add(iden.getHostId());\n-\t\t\t\tFolder folder = folderAPI.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n-\t\t\t\tfolders.addOrClean( folder.getInode(), folder.getModDate());\n-\t\t\t\tfoldersSet.add(folder.getInode());\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n+\t\t\t\t\thosts.addOrClean(iden.getHostId(), h.getModDate());\n+\t\t\t\t\thostsSet.add(iden.getHostId());\n+\t\t\t\t}\n \n+\t\t\t\t// Folder dependencies\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n+\t\t\t\t\tFolder folder = folderAPI\n+\t\t\t\t\t\t\t.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n+\t\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n+\t\t\t\t\tfoldersSet.add(folder.getInode());\n+\t\t\t\t}\n \n \t\t\t\t// looking for working version (must exists)\n \t\t\t\tIHTMLPage workingPage = null;\n \n \t\t\t\tContentlet contentlet = null;\n-\t\t\t\ttry{\n-\t\t\t\t\tcontentlet = APILocator.getContentletAPI().search(\"+identifier:\"+pageId+\" +working:true\", 0, 0, \"moddate\", user, false).get(0);\n+\t\t\t\ttry {\n+\t\t\t\t\tcontentlet = APILocator.getContentletAPI()\n+\t\t\t\t\t\t\t.search(\"+identifier:\" + pageId + \" +working:true\", 0, 0, \"moddate\",\n+\t\t\t\t\t\t\t\t\tuser, false).get(0);\n \t\t\t\t} catch (DotContentletStateException e) {\n \t\t\t\t\t// content not found message is already displayed on console\n-\t\t\t\t\tLogger.debug(this, e.getMessage(),e);\n+\t\t\t\t\tLogger.debug(this, e.getMessage(), e);\n \t\t\t\t}\n-\t\t\t\tif(contentlet != null)\n+\t\t\t\tif (contentlet != null)\n \t\t\t\t\tworkingPage = APILocator.getHTMLPageAssetAPI().fromContentlet(contentlet);\n \n-\n \t\t\t\t// looking for live version (might not exists)\n \t\t\t\tIHTMLPage livePage = null;\n \n \t\t\t\tcontentlet = null;\n-\t\t\t\ttry{\n-\t\t\t\t\tList<Contentlet> result = APILocator.getContentletAPI().search(\"+identifier:\"+pageId+\" +live:true\", 0, 0, \"moddate\", user, false);\n-\t\t\t\t\tif(!result.isEmpty()) {\n+\t\t\t\ttry {\n+\t\t\t\t\tList<Contentlet> result = APILocator.getContentletAPI()\n+\t\t\t\t\t\t\t.search(\"+identifier:\" + pageId + \" +live:true\", 0, 0, \"moddate\", user,\n+\t\t\t\t\t\t\t\t\tfalse);\n+\t\t\t\t\tif (!result.isEmpty()) {\n \t\t\t\t\t\tcontentlet = result.get(0);\n \t\t\t\t\t}\n \n \t\t\t\t} catch (DotContentletStateException e) {\n \t\t\t\t\t// content not found message is already displayed on console\n-\t\t\t\t\tLogger.debug(this, e.getMessage(),e);\n+\t\t\t\t\tLogger.debug(this, e.getMessage(), e);\n \t\t\t\t}\n-\t\t\t\tif(contentlet != null)\n-\t\t\t\t\tlivePage = APILocator.getHTMLPageAssetAPI().fromContentlet(contentlet); \n-\n+\t\t\t\tif (contentlet != null)\n+\t\t\t\t\tlivePage = APILocator.getHTMLPageAssetAPI().fromContentlet(contentlet);\n \n \t\t\t\t// working template working page\n \t\t\t\tTemplate workingTemplateWP = null;\n \t\t\t\t// live template working page\n \t\t\t\tTemplate liveTemplateWP = null;\n \n-\t\t\t\tif(workingPage!=null) {\n-\t\t\t\t\tworkingTemplateWP = APILocator.getTemplateAPI().findWorkingTemplate(workingPage.getTemplateId(), user, false);\n-\t\t\t\t\tliveTemplateWP = APILocator.getTemplateAPI().findLiveTemplate(workingPage.getTemplateId(), user, false);\n+\t\t\t\tif (workingPage != null) {\n+\t\t\t\t\tworkingTemplateWP = APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.findWorkingTemplate(workingPage.getTemplateId(), user, false);\n+\t\t\t\t\tliveTemplateWP = APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.findLiveTemplate(workingPage.getTemplateId(), user, false);\n \t\t\t\t\t// Templates dependencies\n-\t\t\t\t\ttemplates.addOrClean( workingPage.getTemplateId(), workingTemplateWP.getModDate());\n-\t\t\t\t\ttemplatesSet.add(workingPage.getTemplateId());\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.TEMPLATE.getType())) {\n+\t\t\t\t\t\ttemplates.addOrClean(workingPage.getTemplateId(),\n+\t\t\t\t\t\t\t\tworkingTemplateWP.getModDate());\n+\t\t\t\t\t\ttemplatesSet.add(workingPage.getTemplateId());\n+\t\t\t\t\t}\n \t\t\t\t}\n \n \t\t\t\tTemplate liveTemplateLP = null;\n \n \t\t\t\t// live template live page\n-\t\t\t\tif(livePage!=null) {\n-\t\t\t\t\tliveTemplateLP = APILocator.getTemplateAPI().findLiveTemplate(livePage.getTemplateId(), user, false);\n+\t\t\t\tif (livePage != null) {\n+\t\t\t\t\tliveTemplateLP = APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.findLiveTemplate(livePage.getTemplateId(), user, false);\n \t\t\t\t\t// Templates dependencies\n-\t\t\t\t\ttemplates.addOrClean( livePage.getTemplateId(), livePage.getModDate());\n-\t\t\t\t\ttemplatesSet.add(livePage.getTemplateId());\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.TEMPLATE.getType())) {\n+\t\t\t\t\t\ttemplates.addOrClean(livePage.getTemplateId(), livePage.getModDate());\n+\t\t\t\t\t\ttemplatesSet.add(livePage.getTemplateId());\n+\t\t\t\t\t}\n \t\t\t\t}\n \n-\t\t\t\t// Containers dependencies\n \t\t\t\tcontainerList.clear();\n \n-\t\t\t\tif(workingTemplateWP!=null && InodeUtils.isSet(workingTemplateWP.getInode())){\n-\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI().getContainersInTemplate(workingTemplateWP, user, false));\n+\t\t\t\tif (workingTemplateWP != null && InodeUtils.isSet(workingTemplateWP.getInode())) {\n+\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.getContainersInTemplate(workingTemplateWP, user, false));\n \t\t\t\t}\n-\t\t\t\tif(liveTemplateWP!=null && InodeUtils.isSet(liveTemplateWP.getInode())){\n-\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI().getContainersInTemplate(liveTemplateWP, user, false));\n+\t\t\t\tif (liveTemplateWP != null && InodeUtils.isSet(liveTemplateWP.getInode())) {\n+\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.getContainersInTemplate(liveTemplateWP, user, false));\n \t\t\t\t}\n-\t\t\t\tif(liveTemplateLP!=null && InodeUtils.isSet(liveTemplateLP.getInode())){\n-\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI().getContainersInTemplate(liveTemplateLP, user, false));\n+\t\t\t\tif (liveTemplateLP != null && InodeUtils.isSet(liveTemplateLP.getInode())) {\n+\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.getContainersInTemplate(liveTemplateLP, user, false));\n \t\t\t\t}\n \n \t\t\t\tfor (Container container : containerList) {\n-\n-\t\t\t\t\tif (container instanceof FileAssetContainer) {\n-\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\tcontainers.addOrClean(container.getIdentifier(), container.getModDate());\n-\t\t\t\t\t\tcontainersSet.add(container.getIdentifier());\n+\t\t\t\t\t// Containers dependencies\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTAINER.getType())) {\n+\t\t\t\t\t\tif (container instanceof FileAssetContainer) {\n+\t\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n+\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\tcontainers\n+\t\t\t\t\t\t\t\t\t.addOrClean(container.getIdentifier(), container.getModDate());\n+\t\t\t\t\t\t\tcontainersSet.add(container.getIdentifier());\n+\t\t\t\t\t\t}\n \t\t\t\t\t}\n \n \t\t\t\t\t// Structure dependencies\n-\t\t\t\t\tList<ContainerStructure> csList = APILocator.getContainerAPI().getContainerStructures(container);\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENT_TYPE.getType())) {\n+\t\t\t\t\t\tList<ContainerStructure> csList = APILocator.getContainerAPI()\n+\t\t\t\t\t\t\t\t.getContainerStructures(container);\n \n-\t\t\t\t\tfor (ContainerStructure containerStructure : csList) {\n-\t\t\t\t\t\tStructure st = CacheLocator.getContentTypeCache().getStructureByInode(containerStructure.getStructureId());\n-\t\t\t\t\t\tstructures.addOrClean(containerStructure.getStructureId(), st.getModDate());\n-\t\t\t\t\t\tstructuresSet.add(containerStructure.getStructureId());\n+\t\t\t\t\t\tfor (ContainerStructure containerStructure : csList) {\n+\t\t\t\t\t\t\tStructure st = CacheLocator.getContentTypeCache()\n+\t\t\t\t\t\t\t\t\t.getStructureByInode(containerStructure.getStructureId());\n+\t\t\t\t\t\t\tcontentTypes.addOrClean(containerStructure.getStructureId(),\n+\t\t\t\t\t\t\t\t\tst.getModDate());\n+\t\t\t\t\t\t\tcontentTypesSet.add(containerStructure.getStructureId());\n+\t\t\t\t\t\t}\n \t\t\t\t\t}\n \n-\t\t\t\t\tList<MultiTree> treeList = APILocator.getMultiTreeAPI().getMultiTrees(workingPage,container);\n-\n-\t\t\t\t\tfor (MultiTree mt : treeList) {\n-\t\t\t\t\t\tString contentIdentifier = mt.getChild();\n-\t\t\t\t\t\t// Contents dependencies\n-\n-\t\t\t\t\t\tList<Contentlet> contentList = APILocator.getContentletAPI().search( \"+identifier:\" + contentIdentifier, 0, 0, \"moddate\", user, false );\n-\t\t\t\t\t\tfor ( Contentlet contentletI : contentList ) {\n-\t\t\t\t\t\t\tcontents.addOrClean( contentletI.getIdentifier(), contentletI.getModDate() );\n-\t\t\t\t\t\t\tcontentsSet.add( contentletI.getIdentifier() );\n+\t\t\t\t\t// Contents dependencies\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType())) {\n+\t\t\t\t\t\tList<MultiTree> treeList = APILocator.getMultiTreeAPI()", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -680,24 +680,24 @@ public class DependencyManager {\n \n \t\ttry {\n \n-\t\t\tIdentifierAPI idenAPI = APILocator.getIdentifierAPI();\n-\t\t\tFolderAPI folderAPI = APILocator.getFolderAPI();\n-\t\t\tSet<Container> containerList = new HashSet<>();\n+\t\t\tfinal IdentifierAPI idenAPI = APILocator.getIdentifierAPI();\n+\t\t\tfinal FolderAPI folderAPI = APILocator.getFolderAPI();\n+\t\t\tfinal Set<Container> containerList = new HashSet<>();\n \n-\t\t\tfor (String pageId : idsToWork) {\n-\t\t\t\tIdentifier iden = idenAPI.find(pageId);\n+\t\t\tfor (final String pageId : idsToWork) {\n+\t\t\t\tfinal Identifier identifier = idenAPI.find(pageId);\n \n \t\t\t\t// Host dependency\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n-\t\t\t\t\thosts.addOrClean(iden.getHostId(), h.getModDate());\n-\t\t\t\t\thostsSet.add(iden.getHostId());\n+\t\t\t\t\tfinal Host host = APILocator.getHostAPI().find(identifier.getHostId(), user, false);\n+\t\t\t\t\thosts.addOrClean(identifier.getHostId(), host.getModDate());\n+\t\t\t\t\thostsSet.add(identifier.getHostId());\n \t\t\t\t}\n \n \t\t\t\t// Folder dependencies\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n-\t\t\t\t\tFolder folder = folderAPI\n-\t\t\t\t\t\t\t.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n+\t\t\t\t\tfinal Folder folder = folderAPI\n+\t\t\t\t\t\t\t.findFolderByPath(identifier.getParentPath(), identifier.getHostId(), user, false);\n \t\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n \t\t\t\t\tfoldersSet.add(folder.getInode());\n \t\t\t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwOTE5OA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424609198", "bodyText": "set to final and rename to multitree", "author": "jdotcms", "createdAt": "2020-05-13T17:28:07Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -621,119 +688,155 @@ private void setHTMLPagesDependencies(Set<String> idsToWork) {\n \t\t\t\tIdentifier iden = idenAPI.find(pageId);\n \n \t\t\t\t// Host dependency\n-\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n-\t\t\t\thosts.addOrClean( iden.getHostId(), h.getModDate());\n-\t\t\t\thostsSet.add(iden.getHostId());\n-\t\t\t\tFolder folder = folderAPI.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n-\t\t\t\tfolders.addOrClean( folder.getInode(), folder.getModDate());\n-\t\t\t\tfoldersSet.add(folder.getInode());\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n+\t\t\t\t\thosts.addOrClean(iden.getHostId(), h.getModDate());\n+\t\t\t\t\thostsSet.add(iden.getHostId());\n+\t\t\t\t}\n \n+\t\t\t\t// Folder dependencies\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n+\t\t\t\t\tFolder folder = folderAPI\n+\t\t\t\t\t\t\t.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n+\t\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n+\t\t\t\t\tfoldersSet.add(folder.getInode());\n+\t\t\t\t}\n \n \t\t\t\t// looking for working version (must exists)\n \t\t\t\tIHTMLPage workingPage = null;\n \n \t\t\t\tContentlet contentlet = null;\n-\t\t\t\ttry{\n-\t\t\t\t\tcontentlet = APILocator.getContentletAPI().search(\"+identifier:\"+pageId+\" +working:true\", 0, 0, \"moddate\", user, false).get(0);\n+\t\t\t\ttry {\n+\t\t\t\t\tcontentlet = APILocator.getContentletAPI()\n+\t\t\t\t\t\t\t.search(\"+identifier:\" + pageId + \" +working:true\", 0, 0, \"moddate\",\n+\t\t\t\t\t\t\t\t\tuser, false).get(0);\n \t\t\t\t} catch (DotContentletStateException e) {\n \t\t\t\t\t// content not found message is already displayed on console\n-\t\t\t\t\tLogger.debug(this, e.getMessage(),e);\n+\t\t\t\t\tLogger.debug(this, e.getMessage(), e);\n \t\t\t\t}\n-\t\t\t\tif(contentlet != null)\n+\t\t\t\tif (contentlet != null)\n \t\t\t\t\tworkingPage = APILocator.getHTMLPageAssetAPI().fromContentlet(contentlet);\n \n-\n \t\t\t\t// looking for live version (might not exists)\n \t\t\t\tIHTMLPage livePage = null;\n \n \t\t\t\tcontentlet = null;\n-\t\t\t\ttry{\n-\t\t\t\t\tList<Contentlet> result = APILocator.getContentletAPI().search(\"+identifier:\"+pageId+\" +live:true\", 0, 0, \"moddate\", user, false);\n-\t\t\t\t\tif(!result.isEmpty()) {\n+\t\t\t\ttry {\n+\t\t\t\t\tList<Contentlet> result = APILocator.getContentletAPI()\n+\t\t\t\t\t\t\t.search(\"+identifier:\" + pageId + \" +live:true\", 0, 0, \"moddate\", user,\n+\t\t\t\t\t\t\t\t\tfalse);\n+\t\t\t\t\tif (!result.isEmpty()) {\n \t\t\t\t\t\tcontentlet = result.get(0);\n \t\t\t\t\t}\n \n \t\t\t\t} catch (DotContentletStateException e) {\n \t\t\t\t\t// content not found message is already displayed on console\n-\t\t\t\t\tLogger.debug(this, e.getMessage(),e);\n+\t\t\t\t\tLogger.debug(this, e.getMessage(), e);\n \t\t\t\t}\n-\t\t\t\tif(contentlet != null)\n-\t\t\t\t\tlivePage = APILocator.getHTMLPageAssetAPI().fromContentlet(contentlet); \n-\n+\t\t\t\tif (contentlet != null)\n+\t\t\t\t\tlivePage = APILocator.getHTMLPageAssetAPI().fromContentlet(contentlet);\n \n \t\t\t\t// working template working page\n \t\t\t\tTemplate workingTemplateWP = null;\n \t\t\t\t// live template working page\n \t\t\t\tTemplate liveTemplateWP = null;\n \n-\t\t\t\tif(workingPage!=null) {\n-\t\t\t\t\tworkingTemplateWP = APILocator.getTemplateAPI().findWorkingTemplate(workingPage.getTemplateId(), user, false);\n-\t\t\t\t\tliveTemplateWP = APILocator.getTemplateAPI().findLiveTemplate(workingPage.getTemplateId(), user, false);\n+\t\t\t\tif (workingPage != null) {\n+\t\t\t\t\tworkingTemplateWP = APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.findWorkingTemplate(workingPage.getTemplateId(), user, false);\n+\t\t\t\t\tliveTemplateWP = APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.findLiveTemplate(workingPage.getTemplateId(), user, false);\n \t\t\t\t\t// Templates dependencies\n-\t\t\t\t\ttemplates.addOrClean( workingPage.getTemplateId(), workingTemplateWP.getModDate());\n-\t\t\t\t\ttemplatesSet.add(workingPage.getTemplateId());\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.TEMPLATE.getType())) {\n+\t\t\t\t\t\ttemplates.addOrClean(workingPage.getTemplateId(),\n+\t\t\t\t\t\t\t\tworkingTemplateWP.getModDate());\n+\t\t\t\t\t\ttemplatesSet.add(workingPage.getTemplateId());\n+\t\t\t\t\t}\n \t\t\t\t}\n \n \t\t\t\tTemplate liveTemplateLP = null;\n \n \t\t\t\t// live template live page\n-\t\t\t\tif(livePage!=null) {\n-\t\t\t\t\tliveTemplateLP = APILocator.getTemplateAPI().findLiveTemplate(livePage.getTemplateId(), user, false);\n+\t\t\t\tif (livePage != null) {\n+\t\t\t\t\tliveTemplateLP = APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.findLiveTemplate(livePage.getTemplateId(), user, false);\n \t\t\t\t\t// Templates dependencies\n-\t\t\t\t\ttemplates.addOrClean( livePage.getTemplateId(), livePage.getModDate());\n-\t\t\t\t\ttemplatesSet.add(livePage.getTemplateId());\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.TEMPLATE.getType())) {\n+\t\t\t\t\t\ttemplates.addOrClean(livePage.getTemplateId(), livePage.getModDate());\n+\t\t\t\t\t\ttemplatesSet.add(livePage.getTemplateId());\n+\t\t\t\t\t}\n \t\t\t\t}\n \n-\t\t\t\t// Containers dependencies\n \t\t\t\tcontainerList.clear();\n \n-\t\t\t\tif(workingTemplateWP!=null && InodeUtils.isSet(workingTemplateWP.getInode())){\n-\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI().getContainersInTemplate(workingTemplateWP, user, false));\n+\t\t\t\tif (workingTemplateWP != null && InodeUtils.isSet(workingTemplateWP.getInode())) {\n+\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.getContainersInTemplate(workingTemplateWP, user, false));\n \t\t\t\t}\n-\t\t\t\tif(liveTemplateWP!=null && InodeUtils.isSet(liveTemplateWP.getInode())){\n-\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI().getContainersInTemplate(liveTemplateWP, user, false));\n+\t\t\t\tif (liveTemplateWP != null && InodeUtils.isSet(liveTemplateWP.getInode())) {\n+\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.getContainersInTemplate(liveTemplateWP, user, false));\n \t\t\t\t}\n-\t\t\t\tif(liveTemplateLP!=null && InodeUtils.isSet(liveTemplateLP.getInode())){\n-\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI().getContainersInTemplate(liveTemplateLP, user, false));\n+\t\t\t\tif (liveTemplateLP != null && InodeUtils.isSet(liveTemplateLP.getInode())) {\n+\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.getContainersInTemplate(liveTemplateLP, user, false));\n \t\t\t\t}\n \n \t\t\t\tfor (Container container : containerList) {\n-\n-\t\t\t\t\tif (container instanceof FileAssetContainer) {\n-\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\tcontainers.addOrClean(container.getIdentifier(), container.getModDate());\n-\t\t\t\t\t\tcontainersSet.add(container.getIdentifier());\n+\t\t\t\t\t// Containers dependencies\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTAINER.getType())) {\n+\t\t\t\t\t\tif (container instanceof FileAssetContainer) {\n+\t\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n+\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\tcontainers\n+\t\t\t\t\t\t\t\t\t.addOrClean(container.getIdentifier(), container.getModDate());\n+\t\t\t\t\t\t\tcontainersSet.add(container.getIdentifier());\n+\t\t\t\t\t\t}\n \t\t\t\t\t}\n \n \t\t\t\t\t// Structure dependencies\n-\t\t\t\t\tList<ContainerStructure> csList = APILocator.getContainerAPI().getContainerStructures(container);\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENT_TYPE.getType())) {\n+\t\t\t\t\t\tList<ContainerStructure> csList = APILocator.getContainerAPI()\n+\t\t\t\t\t\t\t\t.getContainerStructures(container);\n \n-\t\t\t\t\tfor (ContainerStructure containerStructure : csList) {\n-\t\t\t\t\t\tStructure st = CacheLocator.getContentTypeCache().getStructureByInode(containerStructure.getStructureId());\n-\t\t\t\t\t\tstructures.addOrClean(containerStructure.getStructureId(), st.getModDate());\n-\t\t\t\t\t\tstructuresSet.add(containerStructure.getStructureId());\n+\t\t\t\t\t\tfor (ContainerStructure containerStructure : csList) {\n+\t\t\t\t\t\t\tStructure st = CacheLocator.getContentTypeCache()\n+\t\t\t\t\t\t\t\t\t.getStructureByInode(containerStructure.getStructureId());\n+\t\t\t\t\t\t\tcontentTypes.addOrClean(containerStructure.getStructureId(),\n+\t\t\t\t\t\t\t\t\tst.getModDate());\n+\t\t\t\t\t\t\tcontentTypesSet.add(containerStructure.getStructureId());\n+\t\t\t\t\t\t}\n \t\t\t\t\t}\n \n-\t\t\t\t\tList<MultiTree> treeList = APILocator.getMultiTreeAPI().getMultiTrees(workingPage,container);\n-\n-\t\t\t\t\tfor (MultiTree mt : treeList) {\n-\t\t\t\t\t\tString contentIdentifier = mt.getChild();\n-\t\t\t\t\t\t// Contents dependencies\n-\n-\t\t\t\t\t\tList<Contentlet> contentList = APILocator.getContentletAPI().search( \"+identifier:\" + contentIdentifier, 0, 0, \"moddate\", user, false );\n-\t\t\t\t\t\tfor ( Contentlet contentletI : contentList ) {\n-\t\t\t\t\t\t\tcontents.addOrClean( contentletI.getIdentifier(), contentletI.getModDate() );\n-\t\t\t\t\t\t\tcontentsSet.add( contentletI.getIdentifier() );\n+\t\t\t\t\t// Contents dependencies\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType())) {\n+\t\t\t\t\t\tList<MultiTree> treeList = APILocator.getMultiTreeAPI()\n+\t\t\t\t\t\t\t\t.getMultiTrees(workingPage, container);\n+\n+\t\t\t\t\t\tfor (MultiTree mt : treeList) {", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -680,24 +680,24 @@ public class DependencyManager {\n \n \t\ttry {\n \n-\t\t\tIdentifierAPI idenAPI = APILocator.getIdentifierAPI();\n-\t\t\tFolderAPI folderAPI = APILocator.getFolderAPI();\n-\t\t\tSet<Container> containerList = new HashSet<>();\n+\t\t\tfinal IdentifierAPI idenAPI = APILocator.getIdentifierAPI();\n+\t\t\tfinal FolderAPI folderAPI = APILocator.getFolderAPI();\n+\t\t\tfinal Set<Container> containerList = new HashSet<>();\n \n-\t\t\tfor (String pageId : idsToWork) {\n-\t\t\t\tIdentifier iden = idenAPI.find(pageId);\n+\t\t\tfor (final String pageId : idsToWork) {\n+\t\t\t\tfinal Identifier identifier = idenAPI.find(pageId);\n \n \t\t\t\t// Host dependency\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n-\t\t\t\t\thosts.addOrClean(iden.getHostId(), h.getModDate());\n-\t\t\t\t\thostsSet.add(iden.getHostId());\n+\t\t\t\t\tfinal Host host = APILocator.getHostAPI().find(identifier.getHostId(), user, false);\n+\t\t\t\t\thosts.addOrClean(identifier.getHostId(), host.getModDate());\n+\t\t\t\t\thostsSet.add(identifier.getHostId());\n \t\t\t\t}\n \n \t\t\t\t// Folder dependencies\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n-\t\t\t\t\tFolder folder = folderAPI\n-\t\t\t\t\t\t\t.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n+\t\t\t\t\tfinal Folder folder = folderAPI\n+\t\t\t\t\t\t\t.findFolderByPath(identifier.getParentPath(), identifier.getHostId(), user, false);\n \t\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n \t\t\t\t\tfoldersSet.add(folder.getInode());\n \t\t\t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwOTMxNQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424609315", "bodyText": "set to final", "author": "jdotcms", "createdAt": "2020-05-13T17:28:18Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -621,119 +688,155 @@ private void setHTMLPagesDependencies(Set<String> idsToWork) {\n \t\t\t\tIdentifier iden = idenAPI.find(pageId);\n \n \t\t\t\t// Host dependency\n-\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n-\t\t\t\thosts.addOrClean( iden.getHostId(), h.getModDate());\n-\t\t\t\thostsSet.add(iden.getHostId());\n-\t\t\t\tFolder folder = folderAPI.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n-\t\t\t\tfolders.addOrClean( folder.getInode(), folder.getModDate());\n-\t\t\t\tfoldersSet.add(folder.getInode());\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n+\t\t\t\t\thosts.addOrClean(iden.getHostId(), h.getModDate());\n+\t\t\t\t\thostsSet.add(iden.getHostId());\n+\t\t\t\t}\n \n+\t\t\t\t// Folder dependencies\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n+\t\t\t\t\tFolder folder = folderAPI\n+\t\t\t\t\t\t\t.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n+\t\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n+\t\t\t\t\tfoldersSet.add(folder.getInode());\n+\t\t\t\t}\n \n \t\t\t\t// looking for working version (must exists)\n \t\t\t\tIHTMLPage workingPage = null;\n \n \t\t\t\tContentlet contentlet = null;\n-\t\t\t\ttry{\n-\t\t\t\t\tcontentlet = APILocator.getContentletAPI().search(\"+identifier:\"+pageId+\" +working:true\", 0, 0, \"moddate\", user, false).get(0);\n+\t\t\t\ttry {\n+\t\t\t\t\tcontentlet = APILocator.getContentletAPI()\n+\t\t\t\t\t\t\t.search(\"+identifier:\" + pageId + \" +working:true\", 0, 0, \"moddate\",\n+\t\t\t\t\t\t\t\t\tuser, false).get(0);\n \t\t\t\t} catch (DotContentletStateException e) {\n \t\t\t\t\t// content not found message is already displayed on console\n-\t\t\t\t\tLogger.debug(this, e.getMessage(),e);\n+\t\t\t\t\tLogger.debug(this, e.getMessage(), e);\n \t\t\t\t}\n-\t\t\t\tif(contentlet != null)\n+\t\t\t\tif (contentlet != null)\n \t\t\t\t\tworkingPage = APILocator.getHTMLPageAssetAPI().fromContentlet(contentlet);\n \n-\n \t\t\t\t// looking for live version (might not exists)\n \t\t\t\tIHTMLPage livePage = null;\n \n \t\t\t\tcontentlet = null;\n-\t\t\t\ttry{\n-\t\t\t\t\tList<Contentlet> result = APILocator.getContentletAPI().search(\"+identifier:\"+pageId+\" +live:true\", 0, 0, \"moddate\", user, false);\n-\t\t\t\t\tif(!result.isEmpty()) {\n+\t\t\t\ttry {\n+\t\t\t\t\tList<Contentlet> result = APILocator.getContentletAPI()\n+\t\t\t\t\t\t\t.search(\"+identifier:\" + pageId + \" +live:true\", 0, 0, \"moddate\", user,\n+\t\t\t\t\t\t\t\t\tfalse);\n+\t\t\t\t\tif (!result.isEmpty()) {\n \t\t\t\t\t\tcontentlet = result.get(0);\n \t\t\t\t\t}\n \n \t\t\t\t} catch (DotContentletStateException e) {\n \t\t\t\t\t// content not found message is already displayed on console\n-\t\t\t\t\tLogger.debug(this, e.getMessage(),e);\n+\t\t\t\t\tLogger.debug(this, e.getMessage(), e);\n \t\t\t\t}\n-\t\t\t\tif(contentlet != null)\n-\t\t\t\t\tlivePage = APILocator.getHTMLPageAssetAPI().fromContentlet(contentlet); \n-\n+\t\t\t\tif (contentlet != null)\n+\t\t\t\t\tlivePage = APILocator.getHTMLPageAssetAPI().fromContentlet(contentlet);\n \n \t\t\t\t// working template working page\n \t\t\t\tTemplate workingTemplateWP = null;\n \t\t\t\t// live template working page\n \t\t\t\tTemplate liveTemplateWP = null;\n \n-\t\t\t\tif(workingPage!=null) {\n-\t\t\t\t\tworkingTemplateWP = APILocator.getTemplateAPI().findWorkingTemplate(workingPage.getTemplateId(), user, false);\n-\t\t\t\t\tliveTemplateWP = APILocator.getTemplateAPI().findLiveTemplate(workingPage.getTemplateId(), user, false);\n+\t\t\t\tif (workingPage != null) {\n+\t\t\t\t\tworkingTemplateWP = APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.findWorkingTemplate(workingPage.getTemplateId(), user, false);\n+\t\t\t\t\tliveTemplateWP = APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.findLiveTemplate(workingPage.getTemplateId(), user, false);\n \t\t\t\t\t// Templates dependencies\n-\t\t\t\t\ttemplates.addOrClean( workingPage.getTemplateId(), workingTemplateWP.getModDate());\n-\t\t\t\t\ttemplatesSet.add(workingPage.getTemplateId());\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.TEMPLATE.getType())) {\n+\t\t\t\t\t\ttemplates.addOrClean(workingPage.getTemplateId(),\n+\t\t\t\t\t\t\t\tworkingTemplateWP.getModDate());\n+\t\t\t\t\t\ttemplatesSet.add(workingPage.getTemplateId());\n+\t\t\t\t\t}\n \t\t\t\t}\n \n \t\t\t\tTemplate liveTemplateLP = null;\n \n \t\t\t\t// live template live page\n-\t\t\t\tif(livePage!=null) {\n-\t\t\t\t\tliveTemplateLP = APILocator.getTemplateAPI().findLiveTemplate(livePage.getTemplateId(), user, false);\n+\t\t\t\tif (livePage != null) {\n+\t\t\t\t\tliveTemplateLP = APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.findLiveTemplate(livePage.getTemplateId(), user, false);\n \t\t\t\t\t// Templates dependencies\n-\t\t\t\t\ttemplates.addOrClean( livePage.getTemplateId(), livePage.getModDate());\n-\t\t\t\t\ttemplatesSet.add(livePage.getTemplateId());\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.TEMPLATE.getType())) {\n+\t\t\t\t\t\ttemplates.addOrClean(livePage.getTemplateId(), livePage.getModDate());\n+\t\t\t\t\t\ttemplatesSet.add(livePage.getTemplateId());\n+\t\t\t\t\t}\n \t\t\t\t}\n \n-\t\t\t\t// Containers dependencies\n \t\t\t\tcontainerList.clear();\n \n-\t\t\t\tif(workingTemplateWP!=null && InodeUtils.isSet(workingTemplateWP.getInode())){\n-\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI().getContainersInTemplate(workingTemplateWP, user, false));\n+\t\t\t\tif (workingTemplateWP != null && InodeUtils.isSet(workingTemplateWP.getInode())) {\n+\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.getContainersInTemplate(workingTemplateWP, user, false));\n \t\t\t\t}\n-\t\t\t\tif(liveTemplateWP!=null && InodeUtils.isSet(liveTemplateWP.getInode())){\n-\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI().getContainersInTemplate(liveTemplateWP, user, false));\n+\t\t\t\tif (liveTemplateWP != null && InodeUtils.isSet(liveTemplateWP.getInode())) {\n+\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.getContainersInTemplate(liveTemplateWP, user, false));\n \t\t\t\t}\n-\t\t\t\tif(liveTemplateLP!=null && InodeUtils.isSet(liveTemplateLP.getInode())){\n-\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI().getContainersInTemplate(liveTemplateLP, user, false));\n+\t\t\t\tif (liveTemplateLP != null && InodeUtils.isSet(liveTemplateLP.getInode())) {\n+\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.getContainersInTemplate(liveTemplateLP, user, false));\n \t\t\t\t}\n \n \t\t\t\tfor (Container container : containerList) {\n-\n-\t\t\t\t\tif (container instanceof FileAssetContainer) {\n-\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\tcontainers.addOrClean(container.getIdentifier(), container.getModDate());\n-\t\t\t\t\t\tcontainersSet.add(container.getIdentifier());\n+\t\t\t\t\t// Containers dependencies\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTAINER.getType())) {\n+\t\t\t\t\t\tif (container instanceof FileAssetContainer) {\n+\t\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n+\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\tcontainers\n+\t\t\t\t\t\t\t\t\t.addOrClean(container.getIdentifier(), container.getModDate());\n+\t\t\t\t\t\t\tcontainersSet.add(container.getIdentifier());\n+\t\t\t\t\t\t}\n \t\t\t\t\t}\n \n \t\t\t\t\t// Structure dependencies\n-\t\t\t\t\tList<ContainerStructure> csList = APILocator.getContainerAPI().getContainerStructures(container);\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENT_TYPE.getType())) {\n+\t\t\t\t\t\tList<ContainerStructure> csList = APILocator.getContainerAPI()\n+\t\t\t\t\t\t\t\t.getContainerStructures(container);\n \n-\t\t\t\t\tfor (ContainerStructure containerStructure : csList) {\n-\t\t\t\t\t\tStructure st = CacheLocator.getContentTypeCache().getStructureByInode(containerStructure.getStructureId());\n-\t\t\t\t\t\tstructures.addOrClean(containerStructure.getStructureId(), st.getModDate());\n-\t\t\t\t\t\tstructuresSet.add(containerStructure.getStructureId());\n+\t\t\t\t\t\tfor (ContainerStructure containerStructure : csList) {\n+\t\t\t\t\t\t\tStructure st = CacheLocator.getContentTypeCache()\n+\t\t\t\t\t\t\t\t\t.getStructureByInode(containerStructure.getStructureId());\n+\t\t\t\t\t\t\tcontentTypes.addOrClean(containerStructure.getStructureId(),\n+\t\t\t\t\t\t\t\t\tst.getModDate());\n+\t\t\t\t\t\t\tcontentTypesSet.add(containerStructure.getStructureId());\n+\t\t\t\t\t\t}\n \t\t\t\t\t}\n \n-\t\t\t\t\tList<MultiTree> treeList = APILocator.getMultiTreeAPI().getMultiTrees(workingPage,container);\n-\n-\t\t\t\t\tfor (MultiTree mt : treeList) {\n-\t\t\t\t\t\tString contentIdentifier = mt.getChild();\n-\t\t\t\t\t\t// Contents dependencies\n-\n-\t\t\t\t\t\tList<Contentlet> contentList = APILocator.getContentletAPI().search( \"+identifier:\" + contentIdentifier, 0, 0, \"moddate\", user, false );\n-\t\t\t\t\t\tfor ( Contentlet contentletI : contentList ) {\n-\t\t\t\t\t\t\tcontents.addOrClean( contentletI.getIdentifier(), contentletI.getModDate() );\n-\t\t\t\t\t\t\tcontentsSet.add( contentletI.getIdentifier() );\n+\t\t\t\t\t// Contents dependencies\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType())) {\n+\t\t\t\t\t\tList<MultiTree> treeList = APILocator.getMultiTreeAPI()\n+\t\t\t\t\t\t\t\t.getMultiTrees(workingPage, container);\n+\n+\t\t\t\t\t\tfor (MultiTree mt : treeList) {\n+\t\t\t\t\t\t\tString contentIdentifier = mt.getChild();", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -680,24 +680,24 @@ public class DependencyManager {\n \n \t\ttry {\n \n-\t\t\tIdentifierAPI idenAPI = APILocator.getIdentifierAPI();\n-\t\t\tFolderAPI folderAPI = APILocator.getFolderAPI();\n-\t\t\tSet<Container> containerList = new HashSet<>();\n+\t\t\tfinal IdentifierAPI idenAPI = APILocator.getIdentifierAPI();\n+\t\t\tfinal FolderAPI folderAPI = APILocator.getFolderAPI();\n+\t\t\tfinal Set<Container> containerList = new HashSet<>();\n \n-\t\t\tfor (String pageId : idsToWork) {\n-\t\t\t\tIdentifier iden = idenAPI.find(pageId);\n+\t\t\tfor (final String pageId : idsToWork) {\n+\t\t\t\tfinal Identifier identifier = idenAPI.find(pageId);\n \n \t\t\t\t// Host dependency\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n-\t\t\t\t\thosts.addOrClean(iden.getHostId(), h.getModDate());\n-\t\t\t\t\thostsSet.add(iden.getHostId());\n+\t\t\t\t\tfinal Host host = APILocator.getHostAPI().find(identifier.getHostId(), user, false);\n+\t\t\t\t\thosts.addOrClean(identifier.getHostId(), host.getModDate());\n+\t\t\t\t\thostsSet.add(identifier.getHostId());\n \t\t\t\t}\n \n \t\t\t\t// Folder dependencies\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n-\t\t\t\t\tFolder folder = folderAPI\n-\t\t\t\t\t\t\t.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n+\t\t\t\t\tfinal Folder folder = folderAPI\n+\t\t\t\t\t\t\t.findFolderByPath(identifier.getParentPath(), identifier.getHostId(), user, false);\n \t\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n \t\t\t\t\tfoldersSet.add(folder.getInode());\n \t\t\t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwOTM4OQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424609389", "bodyText": "set to final", "author": "jdotcms", "createdAt": "2020-05-13T17:28:26Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -621,119 +688,155 @@ private void setHTMLPagesDependencies(Set<String> idsToWork) {\n \t\t\t\tIdentifier iden = idenAPI.find(pageId);\n \n \t\t\t\t// Host dependency\n-\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n-\t\t\t\thosts.addOrClean( iden.getHostId(), h.getModDate());\n-\t\t\t\thostsSet.add(iden.getHostId());\n-\t\t\t\tFolder folder = folderAPI.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n-\t\t\t\tfolders.addOrClean( folder.getInode(), folder.getModDate());\n-\t\t\t\tfoldersSet.add(folder.getInode());\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n+\t\t\t\t\thosts.addOrClean(iden.getHostId(), h.getModDate());\n+\t\t\t\t\thostsSet.add(iden.getHostId());\n+\t\t\t\t}\n \n+\t\t\t\t// Folder dependencies\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n+\t\t\t\t\tFolder folder = folderAPI\n+\t\t\t\t\t\t\t.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n+\t\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n+\t\t\t\t\tfoldersSet.add(folder.getInode());\n+\t\t\t\t}\n \n \t\t\t\t// looking for working version (must exists)\n \t\t\t\tIHTMLPage workingPage = null;\n \n \t\t\t\tContentlet contentlet = null;\n-\t\t\t\ttry{\n-\t\t\t\t\tcontentlet = APILocator.getContentletAPI().search(\"+identifier:\"+pageId+\" +working:true\", 0, 0, \"moddate\", user, false).get(0);\n+\t\t\t\ttry {\n+\t\t\t\t\tcontentlet = APILocator.getContentletAPI()\n+\t\t\t\t\t\t\t.search(\"+identifier:\" + pageId + \" +working:true\", 0, 0, \"moddate\",\n+\t\t\t\t\t\t\t\t\tuser, false).get(0);\n \t\t\t\t} catch (DotContentletStateException e) {\n \t\t\t\t\t// content not found message is already displayed on console\n-\t\t\t\t\tLogger.debug(this, e.getMessage(),e);\n+\t\t\t\t\tLogger.debug(this, e.getMessage(), e);\n \t\t\t\t}\n-\t\t\t\tif(contentlet != null)\n+\t\t\t\tif (contentlet != null)\n \t\t\t\t\tworkingPage = APILocator.getHTMLPageAssetAPI().fromContentlet(contentlet);\n \n-\n \t\t\t\t// looking for live version (might not exists)\n \t\t\t\tIHTMLPage livePage = null;\n \n \t\t\t\tcontentlet = null;\n-\t\t\t\ttry{\n-\t\t\t\t\tList<Contentlet> result = APILocator.getContentletAPI().search(\"+identifier:\"+pageId+\" +live:true\", 0, 0, \"moddate\", user, false);\n-\t\t\t\t\tif(!result.isEmpty()) {\n+\t\t\t\ttry {\n+\t\t\t\t\tList<Contentlet> result = APILocator.getContentletAPI()\n+\t\t\t\t\t\t\t.search(\"+identifier:\" + pageId + \" +live:true\", 0, 0, \"moddate\", user,\n+\t\t\t\t\t\t\t\t\tfalse);\n+\t\t\t\t\tif (!result.isEmpty()) {\n \t\t\t\t\t\tcontentlet = result.get(0);\n \t\t\t\t\t}\n \n \t\t\t\t} catch (DotContentletStateException e) {\n \t\t\t\t\t// content not found message is already displayed on console\n-\t\t\t\t\tLogger.debug(this, e.getMessage(),e);\n+\t\t\t\t\tLogger.debug(this, e.getMessage(), e);\n \t\t\t\t}\n-\t\t\t\tif(contentlet != null)\n-\t\t\t\t\tlivePage = APILocator.getHTMLPageAssetAPI().fromContentlet(contentlet); \n-\n+\t\t\t\tif (contentlet != null)\n+\t\t\t\t\tlivePage = APILocator.getHTMLPageAssetAPI().fromContentlet(contentlet);\n \n \t\t\t\t// working template working page\n \t\t\t\tTemplate workingTemplateWP = null;\n \t\t\t\t// live template working page\n \t\t\t\tTemplate liveTemplateWP = null;\n \n-\t\t\t\tif(workingPage!=null) {\n-\t\t\t\t\tworkingTemplateWP = APILocator.getTemplateAPI().findWorkingTemplate(workingPage.getTemplateId(), user, false);\n-\t\t\t\t\tliveTemplateWP = APILocator.getTemplateAPI().findLiveTemplate(workingPage.getTemplateId(), user, false);\n+\t\t\t\tif (workingPage != null) {\n+\t\t\t\t\tworkingTemplateWP = APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.findWorkingTemplate(workingPage.getTemplateId(), user, false);\n+\t\t\t\t\tliveTemplateWP = APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.findLiveTemplate(workingPage.getTemplateId(), user, false);\n \t\t\t\t\t// Templates dependencies\n-\t\t\t\t\ttemplates.addOrClean( workingPage.getTemplateId(), workingTemplateWP.getModDate());\n-\t\t\t\t\ttemplatesSet.add(workingPage.getTemplateId());\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.TEMPLATE.getType())) {\n+\t\t\t\t\t\ttemplates.addOrClean(workingPage.getTemplateId(),\n+\t\t\t\t\t\t\t\tworkingTemplateWP.getModDate());\n+\t\t\t\t\t\ttemplatesSet.add(workingPage.getTemplateId());\n+\t\t\t\t\t}\n \t\t\t\t}\n \n \t\t\t\tTemplate liveTemplateLP = null;\n \n \t\t\t\t// live template live page\n-\t\t\t\tif(livePage!=null) {\n-\t\t\t\t\tliveTemplateLP = APILocator.getTemplateAPI().findLiveTemplate(livePage.getTemplateId(), user, false);\n+\t\t\t\tif (livePage != null) {\n+\t\t\t\t\tliveTemplateLP = APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.findLiveTemplate(livePage.getTemplateId(), user, false);\n \t\t\t\t\t// Templates dependencies\n-\t\t\t\t\ttemplates.addOrClean( livePage.getTemplateId(), livePage.getModDate());\n-\t\t\t\t\ttemplatesSet.add(livePage.getTemplateId());\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.TEMPLATE.getType())) {\n+\t\t\t\t\t\ttemplates.addOrClean(livePage.getTemplateId(), livePage.getModDate());\n+\t\t\t\t\t\ttemplatesSet.add(livePage.getTemplateId());\n+\t\t\t\t\t}\n \t\t\t\t}\n \n-\t\t\t\t// Containers dependencies\n \t\t\t\tcontainerList.clear();\n \n-\t\t\t\tif(workingTemplateWP!=null && InodeUtils.isSet(workingTemplateWP.getInode())){\n-\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI().getContainersInTemplate(workingTemplateWP, user, false));\n+\t\t\t\tif (workingTemplateWP != null && InodeUtils.isSet(workingTemplateWP.getInode())) {\n+\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.getContainersInTemplate(workingTemplateWP, user, false));\n \t\t\t\t}\n-\t\t\t\tif(liveTemplateWP!=null && InodeUtils.isSet(liveTemplateWP.getInode())){\n-\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI().getContainersInTemplate(liveTemplateWP, user, false));\n+\t\t\t\tif (liveTemplateWP != null && InodeUtils.isSet(liveTemplateWP.getInode())) {\n+\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.getContainersInTemplate(liveTemplateWP, user, false));\n \t\t\t\t}\n-\t\t\t\tif(liveTemplateLP!=null && InodeUtils.isSet(liveTemplateLP.getInode())){\n-\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI().getContainersInTemplate(liveTemplateLP, user, false));\n+\t\t\t\tif (liveTemplateLP != null && InodeUtils.isSet(liveTemplateLP.getInode())) {\n+\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.getContainersInTemplate(liveTemplateLP, user, false));\n \t\t\t\t}\n \n \t\t\t\tfor (Container container : containerList) {\n-\n-\t\t\t\t\tif (container instanceof FileAssetContainer) {\n-\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\tcontainers.addOrClean(container.getIdentifier(), container.getModDate());\n-\t\t\t\t\t\tcontainersSet.add(container.getIdentifier());\n+\t\t\t\t\t// Containers dependencies\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTAINER.getType())) {\n+\t\t\t\t\t\tif (container instanceof FileAssetContainer) {\n+\t\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n+\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\tcontainers\n+\t\t\t\t\t\t\t\t\t.addOrClean(container.getIdentifier(), container.getModDate());\n+\t\t\t\t\t\t\tcontainersSet.add(container.getIdentifier());\n+\t\t\t\t\t\t}\n \t\t\t\t\t}\n \n \t\t\t\t\t// Structure dependencies\n-\t\t\t\t\tList<ContainerStructure> csList = APILocator.getContainerAPI().getContainerStructures(container);\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENT_TYPE.getType())) {\n+\t\t\t\t\t\tList<ContainerStructure> csList = APILocator.getContainerAPI()\n+\t\t\t\t\t\t\t\t.getContainerStructures(container);\n \n-\t\t\t\t\tfor (ContainerStructure containerStructure : csList) {\n-\t\t\t\t\t\tStructure st = CacheLocator.getContentTypeCache().getStructureByInode(containerStructure.getStructureId());\n-\t\t\t\t\t\tstructures.addOrClean(containerStructure.getStructureId(), st.getModDate());\n-\t\t\t\t\t\tstructuresSet.add(containerStructure.getStructureId());\n+\t\t\t\t\t\tfor (ContainerStructure containerStructure : csList) {\n+\t\t\t\t\t\t\tStructure st = CacheLocator.getContentTypeCache()\n+\t\t\t\t\t\t\t\t\t.getStructureByInode(containerStructure.getStructureId());\n+\t\t\t\t\t\t\tcontentTypes.addOrClean(containerStructure.getStructureId(),\n+\t\t\t\t\t\t\t\t\tst.getModDate());\n+\t\t\t\t\t\t\tcontentTypesSet.add(containerStructure.getStructureId());\n+\t\t\t\t\t\t}\n \t\t\t\t\t}\n \n-\t\t\t\t\tList<MultiTree> treeList = APILocator.getMultiTreeAPI().getMultiTrees(workingPage,container);\n-\n-\t\t\t\t\tfor (MultiTree mt : treeList) {\n-\t\t\t\t\t\tString contentIdentifier = mt.getChild();\n-\t\t\t\t\t\t// Contents dependencies\n-\n-\t\t\t\t\t\tList<Contentlet> contentList = APILocator.getContentletAPI().search( \"+identifier:\" + contentIdentifier, 0, 0, \"moddate\", user, false );\n-\t\t\t\t\t\tfor ( Contentlet contentletI : contentList ) {\n-\t\t\t\t\t\t\tcontents.addOrClean( contentletI.getIdentifier(), contentletI.getModDate() );\n-\t\t\t\t\t\t\tcontentsSet.add( contentletI.getIdentifier() );\n+\t\t\t\t\t// Contents dependencies\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType())) {\n+\t\t\t\t\t\tList<MultiTree> treeList = APILocator.getMultiTreeAPI()\n+\t\t\t\t\t\t\t\t.getMultiTrees(workingPage, container);\n+\n+\t\t\t\t\t\tfor (MultiTree mt : treeList) {\n+\t\t\t\t\t\t\tString contentIdentifier = mt.getChild();\n+\t\t\t\t\t\t\tList<Contentlet> contentList = APILocator.getContentletAPI()", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -680,24 +680,24 @@ public class DependencyManager {\n \n \t\ttry {\n \n-\t\t\tIdentifierAPI idenAPI = APILocator.getIdentifierAPI();\n-\t\t\tFolderAPI folderAPI = APILocator.getFolderAPI();\n-\t\t\tSet<Container> containerList = new HashSet<>();\n+\t\t\tfinal IdentifierAPI idenAPI = APILocator.getIdentifierAPI();\n+\t\t\tfinal FolderAPI folderAPI = APILocator.getFolderAPI();\n+\t\t\tfinal Set<Container> containerList = new HashSet<>();\n \n-\t\t\tfor (String pageId : idsToWork) {\n-\t\t\t\tIdentifier iden = idenAPI.find(pageId);\n+\t\t\tfor (final String pageId : idsToWork) {\n+\t\t\t\tfinal Identifier identifier = idenAPI.find(pageId);\n \n \t\t\t\t// Host dependency\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n-\t\t\t\t\thosts.addOrClean(iden.getHostId(), h.getModDate());\n-\t\t\t\t\thostsSet.add(iden.getHostId());\n+\t\t\t\t\tfinal Host host = APILocator.getHostAPI().find(identifier.getHostId(), user, false);\n+\t\t\t\t\thosts.addOrClean(identifier.getHostId(), host.getModDate());\n+\t\t\t\t\thostsSet.add(identifier.getHostId());\n \t\t\t\t}\n \n \t\t\t\t// Folder dependencies\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n-\t\t\t\t\tFolder folder = folderAPI\n-\t\t\t\t\t\t\t.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n+\t\t\t\t\tfinal Folder folder = folderAPI\n+\t\t\t\t\t\t\t.findFolderByPath(identifier.getParentPath(), identifier.getHostId(), user, false);\n \t\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n \t\t\t\t\tfoldersSet.add(folder.getInode());\n \t\t\t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwOTUwMQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424609501", "bodyText": "set to final", "author": "jdotcms", "createdAt": "2020-05-13T17:28:37Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -621,119 +688,155 @@ private void setHTMLPagesDependencies(Set<String> idsToWork) {\n \t\t\t\tIdentifier iden = idenAPI.find(pageId);\n \n \t\t\t\t// Host dependency\n-\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n-\t\t\t\thosts.addOrClean( iden.getHostId(), h.getModDate());\n-\t\t\t\thostsSet.add(iden.getHostId());\n-\t\t\t\tFolder folder = folderAPI.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n-\t\t\t\tfolders.addOrClean( folder.getInode(), folder.getModDate());\n-\t\t\t\tfoldersSet.add(folder.getInode());\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n+\t\t\t\t\thosts.addOrClean(iden.getHostId(), h.getModDate());\n+\t\t\t\t\thostsSet.add(iden.getHostId());\n+\t\t\t\t}\n \n+\t\t\t\t// Folder dependencies\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n+\t\t\t\t\tFolder folder = folderAPI\n+\t\t\t\t\t\t\t.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n+\t\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n+\t\t\t\t\tfoldersSet.add(folder.getInode());\n+\t\t\t\t}\n \n \t\t\t\t// looking for working version (must exists)\n \t\t\t\tIHTMLPage workingPage = null;\n \n \t\t\t\tContentlet contentlet = null;\n-\t\t\t\ttry{\n-\t\t\t\t\tcontentlet = APILocator.getContentletAPI().search(\"+identifier:\"+pageId+\" +working:true\", 0, 0, \"moddate\", user, false).get(0);\n+\t\t\t\ttry {\n+\t\t\t\t\tcontentlet = APILocator.getContentletAPI()\n+\t\t\t\t\t\t\t.search(\"+identifier:\" + pageId + \" +working:true\", 0, 0, \"moddate\",\n+\t\t\t\t\t\t\t\t\tuser, false).get(0);\n \t\t\t\t} catch (DotContentletStateException e) {\n \t\t\t\t\t// content not found message is already displayed on console\n-\t\t\t\t\tLogger.debug(this, e.getMessage(),e);\n+\t\t\t\t\tLogger.debug(this, e.getMessage(), e);\n \t\t\t\t}\n-\t\t\t\tif(contentlet != null)\n+\t\t\t\tif (contentlet != null)\n \t\t\t\t\tworkingPage = APILocator.getHTMLPageAssetAPI().fromContentlet(contentlet);\n \n-\n \t\t\t\t// looking for live version (might not exists)\n \t\t\t\tIHTMLPage livePage = null;\n \n \t\t\t\tcontentlet = null;\n-\t\t\t\ttry{\n-\t\t\t\t\tList<Contentlet> result = APILocator.getContentletAPI().search(\"+identifier:\"+pageId+\" +live:true\", 0, 0, \"moddate\", user, false);\n-\t\t\t\t\tif(!result.isEmpty()) {\n+\t\t\t\ttry {\n+\t\t\t\t\tList<Contentlet> result = APILocator.getContentletAPI()\n+\t\t\t\t\t\t\t.search(\"+identifier:\" + pageId + \" +live:true\", 0, 0, \"moddate\", user,\n+\t\t\t\t\t\t\t\t\tfalse);\n+\t\t\t\t\tif (!result.isEmpty()) {\n \t\t\t\t\t\tcontentlet = result.get(0);\n \t\t\t\t\t}\n \n \t\t\t\t} catch (DotContentletStateException e) {\n \t\t\t\t\t// content not found message is already displayed on console\n-\t\t\t\t\tLogger.debug(this, e.getMessage(),e);\n+\t\t\t\t\tLogger.debug(this, e.getMessage(), e);\n \t\t\t\t}\n-\t\t\t\tif(contentlet != null)\n-\t\t\t\t\tlivePage = APILocator.getHTMLPageAssetAPI().fromContentlet(contentlet); \n-\n+\t\t\t\tif (contentlet != null)\n+\t\t\t\t\tlivePage = APILocator.getHTMLPageAssetAPI().fromContentlet(contentlet);\n \n \t\t\t\t// working template working page\n \t\t\t\tTemplate workingTemplateWP = null;\n \t\t\t\t// live template working page\n \t\t\t\tTemplate liveTemplateWP = null;\n \n-\t\t\t\tif(workingPage!=null) {\n-\t\t\t\t\tworkingTemplateWP = APILocator.getTemplateAPI().findWorkingTemplate(workingPage.getTemplateId(), user, false);\n-\t\t\t\t\tliveTemplateWP = APILocator.getTemplateAPI().findLiveTemplate(workingPage.getTemplateId(), user, false);\n+\t\t\t\tif (workingPage != null) {\n+\t\t\t\t\tworkingTemplateWP = APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.findWorkingTemplate(workingPage.getTemplateId(), user, false);\n+\t\t\t\t\tliveTemplateWP = APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.findLiveTemplate(workingPage.getTemplateId(), user, false);\n \t\t\t\t\t// Templates dependencies\n-\t\t\t\t\ttemplates.addOrClean( workingPage.getTemplateId(), workingTemplateWP.getModDate());\n-\t\t\t\t\ttemplatesSet.add(workingPage.getTemplateId());\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.TEMPLATE.getType())) {\n+\t\t\t\t\t\ttemplates.addOrClean(workingPage.getTemplateId(),\n+\t\t\t\t\t\t\t\tworkingTemplateWP.getModDate());\n+\t\t\t\t\t\ttemplatesSet.add(workingPage.getTemplateId());\n+\t\t\t\t\t}\n \t\t\t\t}\n \n \t\t\t\tTemplate liveTemplateLP = null;\n \n \t\t\t\t// live template live page\n-\t\t\t\tif(livePage!=null) {\n-\t\t\t\t\tliveTemplateLP = APILocator.getTemplateAPI().findLiveTemplate(livePage.getTemplateId(), user, false);\n+\t\t\t\tif (livePage != null) {\n+\t\t\t\t\tliveTemplateLP = APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.findLiveTemplate(livePage.getTemplateId(), user, false);\n \t\t\t\t\t// Templates dependencies\n-\t\t\t\t\ttemplates.addOrClean( livePage.getTemplateId(), livePage.getModDate());\n-\t\t\t\t\ttemplatesSet.add(livePage.getTemplateId());\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.TEMPLATE.getType())) {\n+\t\t\t\t\t\ttemplates.addOrClean(livePage.getTemplateId(), livePage.getModDate());\n+\t\t\t\t\t\ttemplatesSet.add(livePage.getTemplateId());\n+\t\t\t\t\t}\n \t\t\t\t}\n \n-\t\t\t\t// Containers dependencies\n \t\t\t\tcontainerList.clear();\n \n-\t\t\t\tif(workingTemplateWP!=null && InodeUtils.isSet(workingTemplateWP.getInode())){\n-\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI().getContainersInTemplate(workingTemplateWP, user, false));\n+\t\t\t\tif (workingTemplateWP != null && InodeUtils.isSet(workingTemplateWP.getInode())) {\n+\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.getContainersInTemplate(workingTemplateWP, user, false));\n \t\t\t\t}\n-\t\t\t\tif(liveTemplateWP!=null && InodeUtils.isSet(liveTemplateWP.getInode())){\n-\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI().getContainersInTemplate(liveTemplateWP, user, false));\n+\t\t\t\tif (liveTemplateWP != null && InodeUtils.isSet(liveTemplateWP.getInode())) {\n+\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.getContainersInTemplate(liveTemplateWP, user, false));\n \t\t\t\t}\n-\t\t\t\tif(liveTemplateLP!=null && InodeUtils.isSet(liveTemplateLP.getInode())){\n-\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI().getContainersInTemplate(liveTemplateLP, user, false));\n+\t\t\t\tif (liveTemplateLP != null && InodeUtils.isSet(liveTemplateLP.getInode())) {\n+\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.getContainersInTemplate(liveTemplateLP, user, false));\n \t\t\t\t}\n \n \t\t\t\tfor (Container container : containerList) {\n-\n-\t\t\t\t\tif (container instanceof FileAssetContainer) {\n-\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\tcontainers.addOrClean(container.getIdentifier(), container.getModDate());\n-\t\t\t\t\t\tcontainersSet.add(container.getIdentifier());\n+\t\t\t\t\t// Containers dependencies\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTAINER.getType())) {\n+\t\t\t\t\t\tif (container instanceof FileAssetContainer) {\n+\t\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n+\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\tcontainers\n+\t\t\t\t\t\t\t\t\t.addOrClean(container.getIdentifier(), container.getModDate());\n+\t\t\t\t\t\t\tcontainersSet.add(container.getIdentifier());\n+\t\t\t\t\t\t}\n \t\t\t\t\t}\n \n \t\t\t\t\t// Structure dependencies\n-\t\t\t\t\tList<ContainerStructure> csList = APILocator.getContainerAPI().getContainerStructures(container);\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENT_TYPE.getType())) {\n+\t\t\t\t\t\tList<ContainerStructure> csList = APILocator.getContainerAPI()\n+\t\t\t\t\t\t\t\t.getContainerStructures(container);\n \n-\t\t\t\t\tfor (ContainerStructure containerStructure : csList) {\n-\t\t\t\t\t\tStructure st = CacheLocator.getContentTypeCache().getStructureByInode(containerStructure.getStructureId());\n-\t\t\t\t\t\tstructures.addOrClean(containerStructure.getStructureId(), st.getModDate());\n-\t\t\t\t\t\tstructuresSet.add(containerStructure.getStructureId());\n+\t\t\t\t\t\tfor (ContainerStructure containerStructure : csList) {\n+\t\t\t\t\t\t\tStructure st = CacheLocator.getContentTypeCache()\n+\t\t\t\t\t\t\t\t\t.getStructureByInode(containerStructure.getStructureId());\n+\t\t\t\t\t\t\tcontentTypes.addOrClean(containerStructure.getStructureId(),\n+\t\t\t\t\t\t\t\t\tst.getModDate());\n+\t\t\t\t\t\t\tcontentTypesSet.add(containerStructure.getStructureId());\n+\t\t\t\t\t\t}\n \t\t\t\t\t}\n \n-\t\t\t\t\tList<MultiTree> treeList = APILocator.getMultiTreeAPI().getMultiTrees(workingPage,container);\n-\n-\t\t\t\t\tfor (MultiTree mt : treeList) {\n-\t\t\t\t\t\tString contentIdentifier = mt.getChild();\n-\t\t\t\t\t\t// Contents dependencies\n-\n-\t\t\t\t\t\tList<Contentlet> contentList = APILocator.getContentletAPI().search( \"+identifier:\" + contentIdentifier, 0, 0, \"moddate\", user, false );\n-\t\t\t\t\t\tfor ( Contentlet contentletI : contentList ) {\n-\t\t\t\t\t\t\tcontents.addOrClean( contentletI.getIdentifier(), contentletI.getModDate() );\n-\t\t\t\t\t\t\tcontentsSet.add( contentletI.getIdentifier() );\n+\t\t\t\t\t// Contents dependencies\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType())) {\n+\t\t\t\t\t\tList<MultiTree> treeList = APILocator.getMultiTreeAPI()\n+\t\t\t\t\t\t\t\t.getMultiTrees(workingPage, container);\n+\n+\t\t\t\t\t\tfor (MultiTree mt : treeList) {\n+\t\t\t\t\t\t\tString contentIdentifier = mt.getChild();\n+\t\t\t\t\t\t\tList<Contentlet> contentList = APILocator.getContentletAPI()\n+\t\t\t\t\t\t\t\t\t.search(\"+identifier:\" + contentIdentifier, 0, 0, \"moddate\",\n+\t\t\t\t\t\t\t\t\t\t\tuser, false);\n+\t\t\t\t\t\t\tfor (Contentlet contentletI : contentList) {", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -680,24 +680,24 @@ public class DependencyManager {\n \n \t\ttry {\n \n-\t\t\tIdentifierAPI idenAPI = APILocator.getIdentifierAPI();\n-\t\t\tFolderAPI folderAPI = APILocator.getFolderAPI();\n-\t\t\tSet<Container> containerList = new HashSet<>();\n+\t\t\tfinal IdentifierAPI idenAPI = APILocator.getIdentifierAPI();\n+\t\t\tfinal FolderAPI folderAPI = APILocator.getFolderAPI();\n+\t\t\tfinal Set<Container> containerList = new HashSet<>();\n \n-\t\t\tfor (String pageId : idsToWork) {\n-\t\t\t\tIdentifier iden = idenAPI.find(pageId);\n+\t\t\tfor (final String pageId : idsToWork) {\n+\t\t\t\tfinal Identifier identifier = idenAPI.find(pageId);\n \n \t\t\t\t// Host dependency\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n-\t\t\t\t\thosts.addOrClean(iden.getHostId(), h.getModDate());\n-\t\t\t\t\thostsSet.add(iden.getHostId());\n+\t\t\t\t\tfinal Host host = APILocator.getHostAPI().find(identifier.getHostId(), user, false);\n+\t\t\t\t\thosts.addOrClean(identifier.getHostId(), host.getModDate());\n+\t\t\t\t\thostsSet.add(identifier.getHostId());\n \t\t\t\t}\n \n \t\t\t\t// Folder dependencies\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n-\t\t\t\t\tFolder folder = folderAPI\n-\t\t\t\t\t\t\t.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n+\t\t\t\t\tfinal Folder folder = folderAPI\n+\t\t\t\t\t\t\t.findFolderByPath(identifier.getParentPath(), identifier.getHostId(), user, false);\n \t\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n \t\t\t\t\tfoldersSet.add(folder.getInode());\n \t\t\t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwOTcxOQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424609719", "bodyText": "rename to\nfinal Host host", "author": "jdotcms", "createdAt": "2020-05-13T17:29:00Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -760,46 +863,62 @@ private void setTemplateDependencies() {\n \t\t\t\tTemplate lvT = APILocator.getTemplateAPI().findLiveTemplate(id, user, false);\n \n \t\t\t\t// Host dependency\n-\t\t\t\tHost h = APILocator.getHostAPI().find(APILocator.getTemplateAPI().getTemplateHost(wkT).getIdentifier(), user, false);\n-\t\t\t\thosts.addOrClean( APILocator.getTemplateAPI().getTemplateHost( wkT ).getIdentifier(), h.getModDate());\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\t\tHost h = APILocator.getHostAPI()", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -855,35 +856,35 @@ public class DependencyManager {\n \t */\n \tprivate void setTemplateDependencies(final PublisherFilter publisherFilter)  {\n \t\ttry {\n-\t\t\tList<Container> containerList = new ArrayList<>();\n-\t\t\tFolderAPI folderAPI = APILocator.getFolderAPI();\n+\t\t\tfinal List<Container> containerList = new ArrayList<>();\n+\t\t\tfinal FolderAPI folderAPI = APILocator.getFolderAPI();\n \n-\t\t\tfor (String id : templatesSet) {\n-\t\t\t\tTemplate wkT = APILocator.getTemplateAPI().findWorkingTemplate(id, user, false);\n-\t\t\t\tTemplate lvT = APILocator.getTemplateAPI().findLiveTemplate(id, user, false);\n+\t\t\tfor (final String id : templatesSet) {\n+\t\t\t\tfinal Template workingTemplate = APILocator.getTemplateAPI().findWorkingTemplate(id, user, false);\n+\t\t\t\tfinal Template liveTemplate = APILocator.getTemplateAPI().findLiveTemplate(id, user, false);\n \n \t\t\t\t// Host dependency\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\t\tHost h = APILocator.getHostAPI()\n-\t\t\t\t\t\t\t.find(APILocator.getTemplateAPI().getTemplateHost(wkT).getIdentifier(),\n+\t\t\t\t\tfinal Host host = APILocator.getHostAPI()\n+\t\t\t\t\t\t\t.find(APILocator.getTemplateAPI().getTemplateHost(workingTemplate).getIdentifier(),\n \t\t\t\t\t\t\t\t\tuser, false);\n \t\t\t\t\thosts.addOrClean(\n-\t\t\t\t\t\t\tAPILocator.getTemplateAPI().getTemplateHost(wkT).getIdentifier(),\n-\t\t\t\t\t\t\th.getModDate());\n+\t\t\t\t\t\t\tAPILocator.getTemplateAPI().getTemplateHost(workingTemplate).getIdentifier(),\n+\t\t\t\t\t\t\thost.getModDate());\n \t\t\t\t}\n \n \t\t\t\tcontainerList.clear();\n \t\t\t\t// Container dependencies\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTAINER.getType())) {\n \t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n-\t\t\t\t\t\t\t.getContainersInTemplate(wkT, user, false));\n+\t\t\t\t\t\t\t.getContainersInTemplate(workingTemplate, user, false));\n \n-\t\t\t\t\tif (lvT != null && InodeUtils.isSet(lvT.getInode())) {\n+\t\t\t\t\tif (liveTemplate != null && InodeUtils.isSet(liveTemplate.getInode())) {\n \t\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n-\t\t\t\t\t\t\t\t.getContainersInTemplate(lvT, user, false));\n+\t\t\t\t\t\t\t\t.getContainersInTemplate(liveTemplate, user, false));\n \t\t\t\t\t}\n \n-\t\t\t\t\tfor (Container container : containerList) {\n+\t\t\t\t\tfor (final Container container : containerList) {\n \n \t\t\t\t\t\tif (container instanceof FileAssetContainer) {\n \t\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYxMDA3Mw==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424610073", "bodyText": "rename to template", "author": "jdotcms", "createdAt": "2020-05-13T17:29:36Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -760,46 +863,62 @@ private void setTemplateDependencies() {\n \t\t\t\tTemplate lvT = APILocator.getTemplateAPI().findLiveTemplate(id, user, false);", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -855,35 +856,35 @@ public class DependencyManager {\n \t */\n \tprivate void setTemplateDependencies(final PublisherFilter publisherFilter)  {\n \t\ttry {\n-\t\t\tList<Container> containerList = new ArrayList<>();\n-\t\t\tFolderAPI folderAPI = APILocator.getFolderAPI();\n+\t\t\tfinal List<Container> containerList = new ArrayList<>();\n+\t\t\tfinal FolderAPI folderAPI = APILocator.getFolderAPI();\n \n-\t\t\tfor (String id : templatesSet) {\n-\t\t\t\tTemplate wkT = APILocator.getTemplateAPI().findWorkingTemplate(id, user, false);\n-\t\t\t\tTemplate lvT = APILocator.getTemplateAPI().findLiveTemplate(id, user, false);\n+\t\t\tfor (final String id : templatesSet) {\n+\t\t\t\tfinal Template workingTemplate = APILocator.getTemplateAPI().findWorkingTemplate(id, user, false);\n+\t\t\t\tfinal Template liveTemplate = APILocator.getTemplateAPI().findLiveTemplate(id, user, false);\n \n \t\t\t\t// Host dependency\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\t\tHost h = APILocator.getHostAPI()\n-\t\t\t\t\t\t\t.find(APILocator.getTemplateAPI().getTemplateHost(wkT).getIdentifier(),\n+\t\t\t\t\tfinal Host host = APILocator.getHostAPI()\n+\t\t\t\t\t\t\t.find(APILocator.getTemplateAPI().getTemplateHost(workingTemplate).getIdentifier(),\n \t\t\t\t\t\t\t\t\tuser, false);\n \t\t\t\t\thosts.addOrClean(\n-\t\t\t\t\t\t\tAPILocator.getTemplateAPI().getTemplateHost(wkT).getIdentifier(),\n-\t\t\t\t\t\t\th.getModDate());\n+\t\t\t\t\t\t\tAPILocator.getTemplateAPI().getTemplateHost(workingTemplate).getIdentifier(),\n+\t\t\t\t\t\t\thost.getModDate());\n \t\t\t\t}\n \n \t\t\t\tcontainerList.clear();\n \t\t\t\t// Container dependencies\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTAINER.getType())) {\n \t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n-\t\t\t\t\t\t\t.getContainersInTemplate(wkT, user, false));\n+\t\t\t\t\t\t\t.getContainersInTemplate(workingTemplate, user, false));\n \n-\t\t\t\t\tif (lvT != null && InodeUtils.isSet(lvT.getInode())) {\n+\t\t\t\t\tif (liveTemplate != null && InodeUtils.isSet(liveTemplate.getInode())) {\n \t\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n-\t\t\t\t\t\t\t\t.getContainersInTemplate(lvT, user, false));\n+\t\t\t\t\t\t\t\t.getContainersInTemplate(liveTemplate, user, false));\n \t\t\t\t\t}\n \n-\t\t\t\t\tfor (Container container : containerList) {\n+\t\t\t\t\tfor (final Container container : containerList) {\n \n \t\t\t\t\t\tif (container instanceof FileAssetContainer) {\n \t\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYxMDI0NA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424610244", "bodyText": "set to final", "author": "jdotcms", "createdAt": "2020-05-13T17:29:54Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -760,46 +863,62 @@ private void setTemplateDependencies() {\n \t\t\t\tTemplate lvT = APILocator.getTemplateAPI().findLiveTemplate(id, user, false);\n \n \t\t\t\t// Host dependency\n-\t\t\t\tHost h = APILocator.getHostAPI().find(APILocator.getTemplateAPI().getTemplateHost(wkT).getIdentifier(), user, false);\n-\t\t\t\thosts.addOrClean( APILocator.getTemplateAPI().getTemplateHost( wkT ).getIdentifier(), h.getModDate());\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\t\tHost h = APILocator.getHostAPI()\n+\t\t\t\t\t\t\t.find(APILocator.getTemplateAPI().getTemplateHost(wkT).getIdentifier(),\n+\t\t\t\t\t\t\t\t\tuser, false);\n+\t\t\t\t\thosts.addOrClean(\n+\t\t\t\t\t\t\tAPILocator.getTemplateAPI().getTemplateHost(wkT).getIdentifier(),\n+\t\t\t\t\t\t\th.getModDate());\n+\t\t\t\t}\n \n \t\t\t\tcontainerList.clear();\n-\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI().getContainersInTemplate(wkT, user, false));\n+\t\t\t\t// Container dependencies\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTAINER.getType())) {\n+\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.getContainersInTemplate(wkT, user, false));\n \n-\t\t\t\tif(lvT!=null && InodeUtils.isSet(lvT.getInode())) {\n-\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI().getContainersInTemplate(lvT, user, false));\n-\t\t\t\t}\n+\t\t\t\t\tif (lvT != null && InodeUtils.isSet(lvT.getInode())) {\n+\t\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t\t.getContainersInTemplate(lvT, user, false));\n+\t\t\t\t\t}\n \n-\t\t\t\tfor (Container container : containerList) {\n+\t\t\t\t\tfor (Container container : containerList) {", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -855,35 +856,35 @@ public class DependencyManager {\n \t */\n \tprivate void setTemplateDependencies(final PublisherFilter publisherFilter)  {\n \t\ttry {\n-\t\t\tList<Container> containerList = new ArrayList<>();\n-\t\t\tFolderAPI folderAPI = APILocator.getFolderAPI();\n+\t\t\tfinal List<Container> containerList = new ArrayList<>();\n+\t\t\tfinal FolderAPI folderAPI = APILocator.getFolderAPI();\n \n-\t\t\tfor (String id : templatesSet) {\n-\t\t\t\tTemplate wkT = APILocator.getTemplateAPI().findWorkingTemplate(id, user, false);\n-\t\t\t\tTemplate lvT = APILocator.getTemplateAPI().findLiveTemplate(id, user, false);\n+\t\t\tfor (final String id : templatesSet) {\n+\t\t\t\tfinal Template workingTemplate = APILocator.getTemplateAPI().findWorkingTemplate(id, user, false);\n+\t\t\t\tfinal Template liveTemplate = APILocator.getTemplateAPI().findLiveTemplate(id, user, false);\n \n \t\t\t\t// Host dependency\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\t\tHost h = APILocator.getHostAPI()\n-\t\t\t\t\t\t\t.find(APILocator.getTemplateAPI().getTemplateHost(wkT).getIdentifier(),\n+\t\t\t\t\tfinal Host host = APILocator.getHostAPI()\n+\t\t\t\t\t\t\t.find(APILocator.getTemplateAPI().getTemplateHost(workingTemplate).getIdentifier(),\n \t\t\t\t\t\t\t\t\tuser, false);\n \t\t\t\t\thosts.addOrClean(\n-\t\t\t\t\t\t\tAPILocator.getTemplateAPI().getTemplateHost(wkT).getIdentifier(),\n-\t\t\t\t\t\t\th.getModDate());\n+\t\t\t\t\t\t\tAPILocator.getTemplateAPI().getTemplateHost(workingTemplate).getIdentifier(),\n+\t\t\t\t\t\t\thost.getModDate());\n \t\t\t\t}\n \n \t\t\t\tcontainerList.clear();\n \t\t\t\t// Container dependencies\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTAINER.getType())) {\n \t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n-\t\t\t\t\t\t\t.getContainersInTemplate(wkT, user, false));\n+\t\t\t\t\t\t\t.getContainersInTemplate(workingTemplate, user, false));\n \n-\t\t\t\t\tif (lvT != null && InodeUtils.isSet(lvT.getInode())) {\n+\t\t\t\t\tif (liveTemplate != null && InodeUtils.isSet(liveTemplate.getInode())) {\n \t\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n-\t\t\t\t\t\t\t\t.getContainersInTemplate(lvT, user, false));\n+\t\t\t\t\t\t\t\t.getContainersInTemplate(liveTemplate, user, false));\n \t\t\t\t\t}\n \n-\t\t\t\t\tfor (Container container : containerList) {\n+\t\t\t\t\tfor (final Container container : containerList) {\n \n \t\t\t\t\t\tif (container instanceof FileAssetContainer) {\n \t\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYxMDU1Ng==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424610556", "bodyText": "set to final", "author": "jdotcms", "createdAt": "2020-05-13T17:30:24Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -760,46 +863,62 @@ private void setTemplateDependencies() {\n \t\t\t\tTemplate lvT = APILocator.getTemplateAPI().findLiveTemplate(id, user, false);\n \n \t\t\t\t// Host dependency\n-\t\t\t\tHost h = APILocator.getHostAPI().find(APILocator.getTemplateAPI().getTemplateHost(wkT).getIdentifier(), user, false);\n-\t\t\t\thosts.addOrClean( APILocator.getTemplateAPI().getTemplateHost( wkT ).getIdentifier(), h.getModDate());\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\t\tHost h = APILocator.getHostAPI()\n+\t\t\t\t\t\t\t.find(APILocator.getTemplateAPI().getTemplateHost(wkT).getIdentifier(),\n+\t\t\t\t\t\t\t\t\tuser, false);\n+\t\t\t\t\thosts.addOrClean(\n+\t\t\t\t\t\t\tAPILocator.getTemplateAPI().getTemplateHost(wkT).getIdentifier(),\n+\t\t\t\t\t\t\th.getModDate());\n+\t\t\t\t}\n \n \t\t\t\tcontainerList.clear();\n-\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI().getContainersInTemplate(wkT, user, false));\n+\t\t\t\t// Container dependencies\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTAINER.getType())) {\n+\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.getContainersInTemplate(wkT, user, false));\n \n-\t\t\t\tif(lvT!=null && InodeUtils.isSet(lvT.getInode())) {\n-\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI().getContainersInTemplate(lvT, user, false));\n-\t\t\t\t}\n+\t\t\t\t\tif (lvT != null && InodeUtils.isSet(lvT.getInode())) {\n+\t\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t\t.getContainersInTemplate(lvT, user, false));\n+\t\t\t\t\t}\n \n-\t\t\t\tfor (Container container : containerList) {\n+\t\t\t\t\tfor (Container container : containerList) {\n \n-\t\t\t\t\tif(container instanceof FileAssetContainer){\n-\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n-\t\t\t\t\t\tcontinue;\n-\t\t\t\t\t}\n+\t\t\t\t\t\tif (container instanceof FileAssetContainer) {\n+\t\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n+\t\t\t\t\t\t\tcontinue;\n+\t\t\t\t\t\t}\n \n-\t\t\t\t\t// Container dependencies\n-\t\t\t\t\tcontainers.addOrClean( container.getIdentifier(), container.getModDate());\n-\t\t\t\t\tcontainersSet.add(container.getIdentifier());\n+\t\t\t\t\t\tcontainers.addOrClean(container.getIdentifier(), container.getModDate());\n+\t\t\t\t\t\tcontainersSet.add(container.getIdentifier());\n+\t\t\t\t\t}\n \t\t\t\t}\n \n \t\t\t\t//Adding theme\n-\t\t\t\tif(UtilMethods.isSet(wkT.getTheme())){\n-\t\t\t\t\ttry{\n-\t\t\t\t\t\tFolder themeFolder = folderAPI.find(wkT.getTheme(), user, false);\n-\t\t\t\t\t\tif(themeFolder != null &&  InodeUtils.isSet(themeFolder.getInode())){\n-\t\t\t\t\t\t\tFolder parent = APILocator.getFolderAPI().findParentFolder(themeFolder, user, false);\n-\t\t\t\t\t\t\tif(UtilMethods.isSet(parent)) {\n-\t\t\t\t\t\t\t\tfolders.addOrClean( parent.getInode(), parent.getModDate());\n-\t\t\t\t\t\t\t\tfoldersSet.add(parent.getInode());\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n+\t\t\t\t\tif (UtilMethods.isSet(wkT.getTheme())) {\n+\t\t\t\t\t\ttry {\n+\t\t\t\t\t\t\tFolder themeFolder = folderAPI.find(wkT.getTheme(), user, false);", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -855,35 +856,35 @@ public class DependencyManager {\n \t */\n \tprivate void setTemplateDependencies(final PublisherFilter publisherFilter)  {\n \t\ttry {\n-\t\t\tList<Container> containerList = new ArrayList<>();\n-\t\t\tFolderAPI folderAPI = APILocator.getFolderAPI();\n+\t\t\tfinal List<Container> containerList = new ArrayList<>();\n+\t\t\tfinal FolderAPI folderAPI = APILocator.getFolderAPI();\n \n-\t\t\tfor (String id : templatesSet) {\n-\t\t\t\tTemplate wkT = APILocator.getTemplateAPI().findWorkingTemplate(id, user, false);\n-\t\t\t\tTemplate lvT = APILocator.getTemplateAPI().findLiveTemplate(id, user, false);\n+\t\t\tfor (final String id : templatesSet) {\n+\t\t\t\tfinal Template workingTemplate = APILocator.getTemplateAPI().findWorkingTemplate(id, user, false);\n+\t\t\t\tfinal Template liveTemplate = APILocator.getTemplateAPI().findLiveTemplate(id, user, false);\n \n \t\t\t\t// Host dependency\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\t\tHost h = APILocator.getHostAPI()\n-\t\t\t\t\t\t\t.find(APILocator.getTemplateAPI().getTemplateHost(wkT).getIdentifier(),\n+\t\t\t\t\tfinal Host host = APILocator.getHostAPI()\n+\t\t\t\t\t\t\t.find(APILocator.getTemplateAPI().getTemplateHost(workingTemplate).getIdentifier(),\n \t\t\t\t\t\t\t\t\tuser, false);\n \t\t\t\t\thosts.addOrClean(\n-\t\t\t\t\t\t\tAPILocator.getTemplateAPI().getTemplateHost(wkT).getIdentifier(),\n-\t\t\t\t\t\t\th.getModDate());\n+\t\t\t\t\t\t\tAPILocator.getTemplateAPI().getTemplateHost(workingTemplate).getIdentifier(),\n+\t\t\t\t\t\t\thost.getModDate());\n \t\t\t\t}\n \n \t\t\t\tcontainerList.clear();\n \t\t\t\t// Container dependencies\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTAINER.getType())) {\n \t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n-\t\t\t\t\t\t\t.getContainersInTemplate(wkT, user, false));\n+\t\t\t\t\t\t\t.getContainersInTemplate(workingTemplate, user, false));\n \n-\t\t\t\t\tif (lvT != null && InodeUtils.isSet(lvT.getInode())) {\n+\t\t\t\t\tif (liveTemplate != null && InodeUtils.isSet(liveTemplate.getInode())) {\n \t\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n-\t\t\t\t\t\t\t\t.getContainersInTemplate(lvT, user, false));\n+\t\t\t\t\t\t\t\t.getContainersInTemplate(liveTemplate, user, false));\n \t\t\t\t\t}\n \n-\t\t\t\t\tfor (Container container : containerList) {\n+\t\t\t\t\tfor (final Container container : containerList) {\n \n \t\t\t\t\t\tif (container instanceof FileAssetContainer) {\n \t\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYxMDY3MQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424610671", "bodyText": "set to final", "author": "jdotcms", "createdAt": "2020-05-13T17:30:33Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -760,46 +863,62 @@ private void setTemplateDependencies() {\n \t\t\t\tTemplate lvT = APILocator.getTemplateAPI().findLiveTemplate(id, user, false);\n \n \t\t\t\t// Host dependency\n-\t\t\t\tHost h = APILocator.getHostAPI().find(APILocator.getTemplateAPI().getTemplateHost(wkT).getIdentifier(), user, false);\n-\t\t\t\thosts.addOrClean( APILocator.getTemplateAPI().getTemplateHost( wkT ).getIdentifier(), h.getModDate());\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\t\tHost h = APILocator.getHostAPI()\n+\t\t\t\t\t\t\t.find(APILocator.getTemplateAPI().getTemplateHost(wkT).getIdentifier(),\n+\t\t\t\t\t\t\t\t\tuser, false);\n+\t\t\t\t\thosts.addOrClean(\n+\t\t\t\t\t\t\tAPILocator.getTemplateAPI().getTemplateHost(wkT).getIdentifier(),\n+\t\t\t\t\t\t\th.getModDate());\n+\t\t\t\t}\n \n \t\t\t\tcontainerList.clear();\n-\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI().getContainersInTemplate(wkT, user, false));\n+\t\t\t\t// Container dependencies\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTAINER.getType())) {\n+\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.getContainersInTemplate(wkT, user, false));\n \n-\t\t\t\tif(lvT!=null && InodeUtils.isSet(lvT.getInode())) {\n-\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI().getContainersInTemplate(lvT, user, false));\n-\t\t\t\t}\n+\t\t\t\t\tif (lvT != null && InodeUtils.isSet(lvT.getInode())) {\n+\t\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t\t.getContainersInTemplate(lvT, user, false));\n+\t\t\t\t\t}\n \n-\t\t\t\tfor (Container container : containerList) {\n+\t\t\t\t\tfor (Container container : containerList) {\n \n-\t\t\t\t\tif(container instanceof FileAssetContainer){\n-\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n-\t\t\t\t\t\tcontinue;\n-\t\t\t\t\t}\n+\t\t\t\t\t\tif (container instanceof FileAssetContainer) {\n+\t\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n+\t\t\t\t\t\t\tcontinue;\n+\t\t\t\t\t\t}\n \n-\t\t\t\t\t// Container dependencies\n-\t\t\t\t\tcontainers.addOrClean( container.getIdentifier(), container.getModDate());\n-\t\t\t\t\tcontainersSet.add(container.getIdentifier());\n+\t\t\t\t\t\tcontainers.addOrClean(container.getIdentifier(), container.getModDate());\n+\t\t\t\t\t\tcontainersSet.add(container.getIdentifier());\n+\t\t\t\t\t}\n \t\t\t\t}\n \n \t\t\t\t//Adding theme\n-\t\t\t\tif(UtilMethods.isSet(wkT.getTheme())){\n-\t\t\t\t\ttry{\n-\t\t\t\t\t\tFolder themeFolder = folderAPI.find(wkT.getTheme(), user, false);\n-\t\t\t\t\t\tif(themeFolder != null &&  InodeUtils.isSet(themeFolder.getInode())){\n-\t\t\t\t\t\t\tFolder parent = APILocator.getFolderAPI().findParentFolder(themeFolder, user, false);\n-\t\t\t\t\t\t\tif(UtilMethods.isSet(parent)) {\n-\t\t\t\t\t\t\t\tfolders.addOrClean( parent.getInode(), parent.getModDate());\n-\t\t\t\t\t\t\t\tfoldersSet.add(parent.getInode());\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n+\t\t\t\t\tif (UtilMethods.isSet(wkT.getTheme())) {\n+\t\t\t\t\t\ttry {\n+\t\t\t\t\t\t\tFolder themeFolder = folderAPI.find(wkT.getTheme(), user, false);\n+\t\t\t\t\t\t\tif (themeFolder != null && InodeUtils.isSet(themeFolder.getInode())) {\n+\t\t\t\t\t\t\t\tFolder parent = APILocator.getFolderAPI()", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -855,35 +856,35 @@ public class DependencyManager {\n \t */\n \tprivate void setTemplateDependencies(final PublisherFilter publisherFilter)  {\n \t\ttry {\n-\t\t\tList<Container> containerList = new ArrayList<>();\n-\t\t\tFolderAPI folderAPI = APILocator.getFolderAPI();\n+\t\t\tfinal List<Container> containerList = new ArrayList<>();\n+\t\t\tfinal FolderAPI folderAPI = APILocator.getFolderAPI();\n \n-\t\t\tfor (String id : templatesSet) {\n-\t\t\t\tTemplate wkT = APILocator.getTemplateAPI().findWorkingTemplate(id, user, false);\n-\t\t\t\tTemplate lvT = APILocator.getTemplateAPI().findLiveTemplate(id, user, false);\n+\t\t\tfor (final String id : templatesSet) {\n+\t\t\t\tfinal Template workingTemplate = APILocator.getTemplateAPI().findWorkingTemplate(id, user, false);\n+\t\t\t\tfinal Template liveTemplate = APILocator.getTemplateAPI().findLiveTemplate(id, user, false);\n \n \t\t\t\t// Host dependency\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\t\tHost h = APILocator.getHostAPI()\n-\t\t\t\t\t\t\t.find(APILocator.getTemplateAPI().getTemplateHost(wkT).getIdentifier(),\n+\t\t\t\t\tfinal Host host = APILocator.getHostAPI()\n+\t\t\t\t\t\t\t.find(APILocator.getTemplateAPI().getTemplateHost(workingTemplate).getIdentifier(),\n \t\t\t\t\t\t\t\t\tuser, false);\n \t\t\t\t\thosts.addOrClean(\n-\t\t\t\t\t\t\tAPILocator.getTemplateAPI().getTemplateHost(wkT).getIdentifier(),\n-\t\t\t\t\t\t\th.getModDate());\n+\t\t\t\t\t\t\tAPILocator.getTemplateAPI().getTemplateHost(workingTemplate).getIdentifier(),\n+\t\t\t\t\t\t\thost.getModDate());\n \t\t\t\t}\n \n \t\t\t\tcontainerList.clear();\n \t\t\t\t// Container dependencies\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTAINER.getType())) {\n \t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n-\t\t\t\t\t\t\t.getContainersInTemplate(wkT, user, false));\n+\t\t\t\t\t\t\t.getContainersInTemplate(workingTemplate, user, false));\n \n-\t\t\t\t\tif (lvT != null && InodeUtils.isSet(lvT.getInode())) {\n+\t\t\t\t\tif (liveTemplate != null && InodeUtils.isSet(liveTemplate.getInode())) {\n \t\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n-\t\t\t\t\t\t\t\t.getContainersInTemplate(lvT, user, false));\n+\t\t\t\t\t\t\t\t.getContainersInTemplate(liveTemplate, user, false));\n \t\t\t\t\t}\n \n-\t\t\t\t\tfor (Container container : containerList) {\n+\t\t\t\t\tfor (final Container container : containerList) {\n \n \t\t\t\t\t\tif (container instanceof FileAssetContainer) {\n \t\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYxMDgzMQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424610831", "bodyText": "set to final", "author": "jdotcms", "createdAt": "2020-05-13T17:30:49Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -760,46 +863,62 @@ private void setTemplateDependencies() {\n \t\t\t\tTemplate lvT = APILocator.getTemplateAPI().findLiveTemplate(id, user, false);\n \n \t\t\t\t// Host dependency\n-\t\t\t\tHost h = APILocator.getHostAPI().find(APILocator.getTemplateAPI().getTemplateHost(wkT).getIdentifier(), user, false);\n-\t\t\t\thosts.addOrClean( APILocator.getTemplateAPI().getTemplateHost( wkT ).getIdentifier(), h.getModDate());\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\t\tHost h = APILocator.getHostAPI()\n+\t\t\t\t\t\t\t.find(APILocator.getTemplateAPI().getTemplateHost(wkT).getIdentifier(),\n+\t\t\t\t\t\t\t\t\tuser, false);\n+\t\t\t\t\thosts.addOrClean(\n+\t\t\t\t\t\t\tAPILocator.getTemplateAPI().getTemplateHost(wkT).getIdentifier(),\n+\t\t\t\t\t\t\th.getModDate());\n+\t\t\t\t}\n \n \t\t\t\tcontainerList.clear();\n-\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI().getContainersInTemplate(wkT, user, false));\n+\t\t\t\t// Container dependencies\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTAINER.getType())) {\n+\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.getContainersInTemplate(wkT, user, false));\n \n-\t\t\t\tif(lvT!=null && InodeUtils.isSet(lvT.getInode())) {\n-\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI().getContainersInTemplate(lvT, user, false));\n-\t\t\t\t}\n+\t\t\t\t\tif (lvT != null && InodeUtils.isSet(lvT.getInode())) {\n+\t\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t\t.getContainersInTemplate(lvT, user, false));\n+\t\t\t\t\t}\n \n-\t\t\t\tfor (Container container : containerList) {\n+\t\t\t\t\tfor (Container container : containerList) {\n \n-\t\t\t\t\tif(container instanceof FileAssetContainer){\n-\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n-\t\t\t\t\t\tcontinue;\n-\t\t\t\t\t}\n+\t\t\t\t\t\tif (container instanceof FileAssetContainer) {\n+\t\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n+\t\t\t\t\t\t\tcontinue;\n+\t\t\t\t\t\t}\n \n-\t\t\t\t\t// Container dependencies\n-\t\t\t\t\tcontainers.addOrClean( container.getIdentifier(), container.getModDate());\n-\t\t\t\t\tcontainersSet.add(container.getIdentifier());\n+\t\t\t\t\t\tcontainers.addOrClean(container.getIdentifier(), container.getModDate());\n+\t\t\t\t\t\tcontainersSet.add(container.getIdentifier());\n+\t\t\t\t\t}\n \t\t\t\t}\n \n \t\t\t\t//Adding theme\n-\t\t\t\tif(UtilMethods.isSet(wkT.getTheme())){\n-\t\t\t\t\ttry{\n-\t\t\t\t\t\tFolder themeFolder = folderAPI.find(wkT.getTheme(), user, false);\n-\t\t\t\t\t\tif(themeFolder != null &&  InodeUtils.isSet(themeFolder.getInode())){\n-\t\t\t\t\t\t\tFolder parent = APILocator.getFolderAPI().findParentFolder(themeFolder, user, false);\n-\t\t\t\t\t\t\tif(UtilMethods.isSet(parent)) {\n-\t\t\t\t\t\t\t\tfolders.addOrClean( parent.getInode(), parent.getModDate());\n-\t\t\t\t\t\t\t\tfoldersSet.add(parent.getInode());\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n+\t\t\t\t\tif (UtilMethods.isSet(wkT.getTheme())) {\n+\t\t\t\t\t\ttry {\n+\t\t\t\t\t\t\tFolder themeFolder = folderAPI.find(wkT.getTheme(), user, false);\n+\t\t\t\t\t\t\tif (themeFolder != null && InodeUtils.isSet(themeFolder.getInode())) {\n+\t\t\t\t\t\t\t\tFolder parent = APILocator.getFolderAPI()\n+\t\t\t\t\t\t\t\t\t\t.findParentFolder(themeFolder, user, false);\n+\t\t\t\t\t\t\t\tif (UtilMethods.isSet(parent)) {\n+\t\t\t\t\t\t\t\t\tfolders.addOrClean(parent.getInode(), parent.getModDate());\n+\t\t\t\t\t\t\t\t\tfoldersSet.add(parent.getInode());\n+\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\tList<Folder> folderList = new ArrayList<Folder>();", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -855,35 +856,35 @@ public class DependencyManager {\n \t */\n \tprivate void setTemplateDependencies(final PublisherFilter publisherFilter)  {\n \t\ttry {\n-\t\t\tList<Container> containerList = new ArrayList<>();\n-\t\t\tFolderAPI folderAPI = APILocator.getFolderAPI();\n+\t\t\tfinal List<Container> containerList = new ArrayList<>();\n+\t\t\tfinal FolderAPI folderAPI = APILocator.getFolderAPI();\n \n-\t\t\tfor (String id : templatesSet) {\n-\t\t\t\tTemplate wkT = APILocator.getTemplateAPI().findWorkingTemplate(id, user, false);\n-\t\t\t\tTemplate lvT = APILocator.getTemplateAPI().findLiveTemplate(id, user, false);\n+\t\t\tfor (final String id : templatesSet) {\n+\t\t\t\tfinal Template workingTemplate = APILocator.getTemplateAPI().findWorkingTemplate(id, user, false);\n+\t\t\t\tfinal Template liveTemplate = APILocator.getTemplateAPI().findLiveTemplate(id, user, false);\n \n \t\t\t\t// Host dependency\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\t\tHost h = APILocator.getHostAPI()\n-\t\t\t\t\t\t\t.find(APILocator.getTemplateAPI().getTemplateHost(wkT).getIdentifier(),\n+\t\t\t\t\tfinal Host host = APILocator.getHostAPI()\n+\t\t\t\t\t\t\t.find(APILocator.getTemplateAPI().getTemplateHost(workingTemplate).getIdentifier(),\n \t\t\t\t\t\t\t\t\tuser, false);\n \t\t\t\t\thosts.addOrClean(\n-\t\t\t\t\t\t\tAPILocator.getTemplateAPI().getTemplateHost(wkT).getIdentifier(),\n-\t\t\t\t\t\t\th.getModDate());\n+\t\t\t\t\t\t\tAPILocator.getTemplateAPI().getTemplateHost(workingTemplate).getIdentifier(),\n+\t\t\t\t\t\t\thost.getModDate());\n \t\t\t\t}\n \n \t\t\t\tcontainerList.clear();\n \t\t\t\t// Container dependencies\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTAINER.getType())) {\n \t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n-\t\t\t\t\t\t\t.getContainersInTemplate(wkT, user, false));\n+\t\t\t\t\t\t\t.getContainersInTemplate(workingTemplate, user, false));\n \n-\t\t\t\t\tif (lvT != null && InodeUtils.isSet(lvT.getInode())) {\n+\t\t\t\t\tif (liveTemplate != null && InodeUtils.isSet(liveTemplate.getInode())) {\n \t\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n-\t\t\t\t\t\t\t\t.getContainersInTemplate(lvT, user, false));\n+\t\t\t\t\t\t\t\t.getContainersInTemplate(liveTemplate, user, false));\n \t\t\t\t\t}\n \n-\t\t\t\t\tfor (Container container : containerList) {\n+\t\t\t\t\tfor (final Container container : containerList) {\n \n \t\t\t\t\t\tif (container instanceof FileAssetContainer) {\n \t\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYxMTIzNA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424611234", "bodyText": "rename to\nfinal Container container", "author": "jdotcms", "createdAt": "2020-05-13T17:31:25Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -829,43 +948,51 @@ private void setContainerDependencies() {\n \t\t\t\tContainer c = APILocator.getContainerAPI().getWorkingContainerById(id, user, false);", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -942,44 +943,44 @@ public class DependencyManager {\n \n \t\ttry {\n \n-\t\t\tList<Container> containerList = new ArrayList<>();\n+\t\t\tfinal List<Container> containerList = new ArrayList<>();\n \n-\t\t\tfor (String id : containersSet) {\n-\t\t\t\tContainer c = APILocator.getContainerAPI().getWorkingContainerById(id, user, false);\n+\t\t\tfor (final String id : containersSet) {\n+\t\t\t\tfinal Container containerById = APILocator.getContainerAPI().getWorkingContainerById(id, user, false);\n \n \t\t\t\t// Host Dependency\n \t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\t\tHost h = APILocator.getContainerAPI().getParentHost(c, user, false);\n-\t\t\t\t\thosts.addOrClean(APILocator.getContainerAPI().getParentHost(c, user, false)\n-\t\t\t\t\t\t\t.getIdentifier(), h.getModDate());\n+\t\t\t\t\tfinal Host host = APILocator.getContainerAPI().getParentHost(containerById, user, false);\n+\t\t\t\t\thosts.addOrClean(APILocator.getContainerAPI().getParentHost(containerById, user, false)\n+\t\t\t\t\t\t\t.getIdentifier(), host.getModDate());\n \t\t\t\t}\n \n \t\t\t\tcontainerList.clear();\n \n \t\t\t\t// Content Type Dependencies\n \t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENT_TYPE.getType())) {\n-\t\t\t\t\tContainer workingContainer = APILocator.getContainerAPI()\n+\t\t\t\t\tfinal Container workingContainer = APILocator.getContainerAPI()\n \t\t\t\t\t\t\t.getWorkingContainerById(id, user, false);\n \t\t\t\t\tif (workingContainer != null) {\n \t\t\t\t\t\tcontainerList.add(workingContainer);\n \t\t\t\t\t}\n \n-\t\t\t\t\tContainer liveContainer = APILocator.getContainerAPI()\n+\t\t\t\t\tfinal Container liveContainer = APILocator.getContainerAPI()\n \t\t\t\t\t\t\t.getLiveContainerById(id, user, false);\n \t\t\t\t\tif (liveContainer != null) {\n \t\t\t\t\t\tcontainerList.add(liveContainer);\n \t\t\t\t\t}\n \n-\t\t\t\t\tfor (Container container : containerList) {\n+\t\t\t\t\tfor (final Container container : containerList) {\n \t\t\t\t\t\t// Structure dependencies\n-\t\t\t\t\t\tList<ContainerStructure> csList = APILocator.getContainerAPI()\n+\t\t\t\t\t\tfinal List<ContainerStructure> csList = APILocator.getContainerAPI()\n \t\t\t\t\t\t\t\t.getContainerStructures(container);\n \n-\t\t\t\t\t\tfor (ContainerStructure containerStructure : csList) {\n-\t\t\t\t\t\t\tStructure st = CacheLocator.getContentTypeCache()\n+\t\t\t\t\t\tfor (final ContainerStructure containerStructure : csList) {\n+\t\t\t\t\t\t\tfinal Structure structure = CacheLocator.getContentTypeCache()\n \t\t\t\t\t\t\t\t\t.getStructureByInode(containerStructure.getStructureId());\n \t\t\t\t\t\t\tcontentTypes.addOrClean(containerStructure.getStructureId(),\n-\t\t\t\t\t\t\t\t\tst.getModDate());\n+\t\t\t\t\t\t\t\t\tstructure.getModDate());\n \t\t\t\t\t\t\tcontentTypesSet.add(containerStructure.getStructureId());\n \t\t\t\t\t\t}\n \t\t\t\t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYxMTM5NA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424611394", "bodyText": "rename to\nfinal Host host", "author": "jdotcms", "createdAt": "2020-05-13T17:31:42Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -829,43 +948,51 @@ private void setContainerDependencies() {\n \t\t\t\tContainer c = APILocator.getContainerAPI().getWorkingContainerById(id, user, false);\n \n \t\t\t\t// Host Dependency\n-\t\t\t\tHost h = APILocator.getContainerAPI().getParentHost(c, user, false);\n-\t\t\t\thosts.addOrClean( APILocator.getContainerAPI().getParentHost( c, user, false ).getIdentifier(), h.getModDate());\n+\t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\t\tHost h = APILocator.getContainerAPI().getParentHost(c, user, false);", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -942,44 +943,44 @@ public class DependencyManager {\n \n \t\ttry {\n \n-\t\t\tList<Container> containerList = new ArrayList<>();\n+\t\t\tfinal List<Container> containerList = new ArrayList<>();\n \n-\t\t\tfor (String id : containersSet) {\n-\t\t\t\tContainer c = APILocator.getContainerAPI().getWorkingContainerById(id, user, false);\n+\t\t\tfor (final String id : containersSet) {\n+\t\t\t\tfinal Container containerById = APILocator.getContainerAPI().getWorkingContainerById(id, user, false);\n \n \t\t\t\t// Host Dependency\n \t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\t\tHost h = APILocator.getContainerAPI().getParentHost(c, user, false);\n-\t\t\t\t\thosts.addOrClean(APILocator.getContainerAPI().getParentHost(c, user, false)\n-\t\t\t\t\t\t\t.getIdentifier(), h.getModDate());\n+\t\t\t\t\tfinal Host host = APILocator.getContainerAPI().getParentHost(containerById, user, false);\n+\t\t\t\t\thosts.addOrClean(APILocator.getContainerAPI().getParentHost(containerById, user, false)\n+\t\t\t\t\t\t\t.getIdentifier(), host.getModDate());\n \t\t\t\t}\n \n \t\t\t\tcontainerList.clear();\n \n \t\t\t\t// Content Type Dependencies\n \t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENT_TYPE.getType())) {\n-\t\t\t\t\tContainer workingContainer = APILocator.getContainerAPI()\n+\t\t\t\t\tfinal Container workingContainer = APILocator.getContainerAPI()\n \t\t\t\t\t\t\t.getWorkingContainerById(id, user, false);\n \t\t\t\t\tif (workingContainer != null) {\n \t\t\t\t\t\tcontainerList.add(workingContainer);\n \t\t\t\t\t}\n \n-\t\t\t\t\tContainer liveContainer = APILocator.getContainerAPI()\n+\t\t\t\t\tfinal Container liveContainer = APILocator.getContainerAPI()\n \t\t\t\t\t\t\t.getLiveContainerById(id, user, false);\n \t\t\t\t\tif (liveContainer != null) {\n \t\t\t\t\t\tcontainerList.add(liveContainer);\n \t\t\t\t\t}\n \n-\t\t\t\t\tfor (Container container : containerList) {\n+\t\t\t\t\tfor (final Container container : containerList) {\n \t\t\t\t\t\t// Structure dependencies\n-\t\t\t\t\t\tList<ContainerStructure> csList = APILocator.getContainerAPI()\n+\t\t\t\t\t\tfinal List<ContainerStructure> csList = APILocator.getContainerAPI()\n \t\t\t\t\t\t\t\t.getContainerStructures(container);\n \n-\t\t\t\t\t\tfor (ContainerStructure containerStructure : csList) {\n-\t\t\t\t\t\t\tStructure st = CacheLocator.getContentTypeCache()\n+\t\t\t\t\t\tfor (final ContainerStructure containerStructure : csList) {\n+\t\t\t\t\t\t\tfinal Structure structure = CacheLocator.getContentTypeCache()\n \t\t\t\t\t\t\t\t\t.getStructureByInode(containerStructure.getStructureId());\n \t\t\t\t\t\t\tcontentTypes.addOrClean(containerStructure.getStructureId(),\n-\t\t\t\t\t\t\t\t\tst.getModDate());\n+\t\t\t\t\t\t\t\t\tstructure.getModDate());\n \t\t\t\t\t\t\tcontentTypesSet.add(containerStructure.getStructureId());\n \t\t\t\t\t\t}\n \t\t\t\t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYxMTU0Ng==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424611546", "bodyText": "set to final", "author": "jdotcms", "createdAt": "2020-05-13T17:31:57Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -829,43 +948,51 @@ private void setContainerDependencies() {\n \t\t\t\tContainer c = APILocator.getContainerAPI().getWorkingContainerById(id, user, false);\n \n \t\t\t\t// Host Dependency\n-\t\t\t\tHost h = APILocator.getContainerAPI().getParentHost(c, user, false);\n-\t\t\t\thosts.addOrClean( APILocator.getContainerAPI().getParentHost( c, user, false ).getIdentifier(), h.getModDate());\n+\t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\t\tHost h = APILocator.getContainerAPI().getParentHost(c, user, false);\n+\t\t\t\t\thosts.addOrClean(APILocator.getContainerAPI().getParentHost(c, user, false)\n+\t\t\t\t\t\t\t.getIdentifier(), h.getModDate());\n+\t\t\t\t}\n \n \t\t\t\tcontainerList.clear();\n \n-\t\t\t\tContainer workingContainer = APILocator.getContainerAPI().getWorkingContainerById(id, user, false);\n-\t\t\t\tif ( workingContainer != null ) {\n-\t\t\t\t\tcontainerList.add( workingContainer );\n-\t\t\t\t}\n+\t\t\t\t// Content Type Dependencies\n+\t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENT_TYPE.getType())) {\n+\t\t\t\t\tContainer workingContainer = APILocator.getContainerAPI()", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -942,44 +943,44 @@ public class DependencyManager {\n \n \t\ttry {\n \n-\t\t\tList<Container> containerList = new ArrayList<>();\n+\t\t\tfinal List<Container> containerList = new ArrayList<>();\n \n-\t\t\tfor (String id : containersSet) {\n-\t\t\t\tContainer c = APILocator.getContainerAPI().getWorkingContainerById(id, user, false);\n+\t\t\tfor (final String id : containersSet) {\n+\t\t\t\tfinal Container containerById = APILocator.getContainerAPI().getWorkingContainerById(id, user, false);\n \n \t\t\t\t// Host Dependency\n \t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\t\tHost h = APILocator.getContainerAPI().getParentHost(c, user, false);\n-\t\t\t\t\thosts.addOrClean(APILocator.getContainerAPI().getParentHost(c, user, false)\n-\t\t\t\t\t\t\t.getIdentifier(), h.getModDate());\n+\t\t\t\t\tfinal Host host = APILocator.getContainerAPI().getParentHost(containerById, user, false);\n+\t\t\t\t\thosts.addOrClean(APILocator.getContainerAPI().getParentHost(containerById, user, false)\n+\t\t\t\t\t\t\t.getIdentifier(), host.getModDate());\n \t\t\t\t}\n \n \t\t\t\tcontainerList.clear();\n \n \t\t\t\t// Content Type Dependencies\n \t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENT_TYPE.getType())) {\n-\t\t\t\t\tContainer workingContainer = APILocator.getContainerAPI()\n+\t\t\t\t\tfinal Container workingContainer = APILocator.getContainerAPI()\n \t\t\t\t\t\t\t.getWorkingContainerById(id, user, false);\n \t\t\t\t\tif (workingContainer != null) {\n \t\t\t\t\t\tcontainerList.add(workingContainer);\n \t\t\t\t\t}\n \n-\t\t\t\t\tContainer liveContainer = APILocator.getContainerAPI()\n+\t\t\t\t\tfinal Container liveContainer = APILocator.getContainerAPI()\n \t\t\t\t\t\t\t.getLiveContainerById(id, user, false);\n \t\t\t\t\tif (liveContainer != null) {\n \t\t\t\t\t\tcontainerList.add(liveContainer);\n \t\t\t\t\t}\n \n-\t\t\t\t\tfor (Container container : containerList) {\n+\t\t\t\t\tfor (final Container container : containerList) {\n \t\t\t\t\t\t// Structure dependencies\n-\t\t\t\t\t\tList<ContainerStructure> csList = APILocator.getContainerAPI()\n+\t\t\t\t\t\tfinal List<ContainerStructure> csList = APILocator.getContainerAPI()\n \t\t\t\t\t\t\t\t.getContainerStructures(container);\n \n-\t\t\t\t\t\tfor (ContainerStructure containerStructure : csList) {\n-\t\t\t\t\t\t\tStructure st = CacheLocator.getContentTypeCache()\n+\t\t\t\t\t\tfor (final ContainerStructure containerStructure : csList) {\n+\t\t\t\t\t\t\tfinal Structure structure = CacheLocator.getContentTypeCache()\n \t\t\t\t\t\t\t\t\t.getStructureByInode(containerStructure.getStructureId());\n \t\t\t\t\t\t\tcontentTypes.addOrClean(containerStructure.getStructureId(),\n-\t\t\t\t\t\t\t\t\tst.getModDate());\n+\t\t\t\t\t\t\t\t\tstructure.getModDate());\n \t\t\t\t\t\t\tcontentTypesSet.add(containerStructure.getStructureId());\n \t\t\t\t\t\t}\n \t\t\t\t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYxMTY4NA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424611684", "bodyText": "set to final", "author": "jdotcms", "createdAt": "2020-05-13T17:32:12Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -829,43 +948,51 @@ private void setContainerDependencies() {\n \t\t\t\tContainer c = APILocator.getContainerAPI().getWorkingContainerById(id, user, false);\n \n \t\t\t\t// Host Dependency\n-\t\t\t\tHost h = APILocator.getContainerAPI().getParentHost(c, user, false);\n-\t\t\t\thosts.addOrClean( APILocator.getContainerAPI().getParentHost( c, user, false ).getIdentifier(), h.getModDate());\n+\t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\t\tHost h = APILocator.getContainerAPI().getParentHost(c, user, false);\n+\t\t\t\t\thosts.addOrClean(APILocator.getContainerAPI().getParentHost(c, user, false)\n+\t\t\t\t\t\t\t.getIdentifier(), h.getModDate());\n+\t\t\t\t}\n \n \t\t\t\tcontainerList.clear();\n \n-\t\t\t\tContainer workingContainer = APILocator.getContainerAPI().getWorkingContainerById(id, user, false);\n-\t\t\t\tif ( workingContainer != null ) {\n-\t\t\t\t\tcontainerList.add( workingContainer );\n-\t\t\t\t}\n+\t\t\t\t// Content Type Dependencies\n+\t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENT_TYPE.getType())) {\n+\t\t\t\t\tContainer workingContainer = APILocator.getContainerAPI()\n+\t\t\t\t\t\t\t.getWorkingContainerById(id, user, false);\n+\t\t\t\t\tif (workingContainer != null) {\n+\t\t\t\t\t\tcontainerList.add(workingContainer);\n+\t\t\t\t\t}\n \n-\t\t\t\tContainer liveContainer = APILocator.getContainerAPI().getLiveContainerById(id, user, false);\n-\t\t\t\tif ( liveContainer != null ) {\n-\t\t\t\t\tcontainerList.add( liveContainer );\n-\t\t\t\t}\n+\t\t\t\t\tContainer liveContainer = APILocator.getContainerAPI()", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -942,44 +943,44 @@ public class DependencyManager {\n \n \t\ttry {\n \n-\t\t\tList<Container> containerList = new ArrayList<>();\n+\t\t\tfinal List<Container> containerList = new ArrayList<>();\n \n-\t\t\tfor (String id : containersSet) {\n-\t\t\t\tContainer c = APILocator.getContainerAPI().getWorkingContainerById(id, user, false);\n+\t\t\tfor (final String id : containersSet) {\n+\t\t\t\tfinal Container containerById = APILocator.getContainerAPI().getWorkingContainerById(id, user, false);\n \n \t\t\t\t// Host Dependency\n \t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\t\tHost h = APILocator.getContainerAPI().getParentHost(c, user, false);\n-\t\t\t\t\thosts.addOrClean(APILocator.getContainerAPI().getParentHost(c, user, false)\n-\t\t\t\t\t\t\t.getIdentifier(), h.getModDate());\n+\t\t\t\t\tfinal Host host = APILocator.getContainerAPI().getParentHost(containerById, user, false);\n+\t\t\t\t\thosts.addOrClean(APILocator.getContainerAPI().getParentHost(containerById, user, false)\n+\t\t\t\t\t\t\t.getIdentifier(), host.getModDate());\n \t\t\t\t}\n \n \t\t\t\tcontainerList.clear();\n \n \t\t\t\t// Content Type Dependencies\n \t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENT_TYPE.getType())) {\n-\t\t\t\t\tContainer workingContainer = APILocator.getContainerAPI()\n+\t\t\t\t\tfinal Container workingContainer = APILocator.getContainerAPI()\n \t\t\t\t\t\t\t.getWorkingContainerById(id, user, false);\n \t\t\t\t\tif (workingContainer != null) {\n \t\t\t\t\t\tcontainerList.add(workingContainer);\n \t\t\t\t\t}\n \n-\t\t\t\t\tContainer liveContainer = APILocator.getContainerAPI()\n+\t\t\t\t\tfinal Container liveContainer = APILocator.getContainerAPI()\n \t\t\t\t\t\t\t.getLiveContainerById(id, user, false);\n \t\t\t\t\tif (liveContainer != null) {\n \t\t\t\t\t\tcontainerList.add(liveContainer);\n \t\t\t\t\t}\n \n-\t\t\t\t\tfor (Container container : containerList) {\n+\t\t\t\t\tfor (final Container container : containerList) {\n \t\t\t\t\t\t// Structure dependencies\n-\t\t\t\t\t\tList<ContainerStructure> csList = APILocator.getContainerAPI()\n+\t\t\t\t\t\tfinal List<ContainerStructure> csList = APILocator.getContainerAPI()\n \t\t\t\t\t\t\t\t.getContainerStructures(container);\n \n-\t\t\t\t\t\tfor (ContainerStructure containerStructure : csList) {\n-\t\t\t\t\t\t\tStructure st = CacheLocator.getContentTypeCache()\n+\t\t\t\t\t\tfor (final ContainerStructure containerStructure : csList) {\n+\t\t\t\t\t\t\tfinal Structure structure = CacheLocator.getContentTypeCache()\n \t\t\t\t\t\t\t\t\t.getStructureByInode(containerStructure.getStructureId());\n \t\t\t\t\t\t\tcontentTypes.addOrClean(containerStructure.getStructureId(),\n-\t\t\t\t\t\t\t\t\tst.getModDate());\n+\t\t\t\t\t\t\t\t\tstructure.getModDate());\n \t\t\t\t\t\t\tcontentTypesSet.add(containerStructure.getStructureId());\n \t\t\t\t\t\t}\n \t\t\t\t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYxMTgzMw==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424611833", "bodyText": "set to final", "author": "jdotcms", "createdAt": "2020-05-13T17:32:25Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -829,43 +948,51 @@ private void setContainerDependencies() {\n \t\t\t\tContainer c = APILocator.getContainerAPI().getWorkingContainerById(id, user, false);\n \n \t\t\t\t// Host Dependency\n-\t\t\t\tHost h = APILocator.getContainerAPI().getParentHost(c, user, false);\n-\t\t\t\thosts.addOrClean( APILocator.getContainerAPI().getParentHost( c, user, false ).getIdentifier(), h.getModDate());\n+\t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\t\tHost h = APILocator.getContainerAPI().getParentHost(c, user, false);\n+\t\t\t\t\thosts.addOrClean(APILocator.getContainerAPI().getParentHost(c, user, false)\n+\t\t\t\t\t\t\t.getIdentifier(), h.getModDate());\n+\t\t\t\t}\n \n \t\t\t\tcontainerList.clear();\n \n-\t\t\t\tContainer workingContainer = APILocator.getContainerAPI().getWorkingContainerById(id, user, false);\n-\t\t\t\tif ( workingContainer != null ) {\n-\t\t\t\t\tcontainerList.add( workingContainer );\n-\t\t\t\t}\n+\t\t\t\t// Content Type Dependencies\n+\t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENT_TYPE.getType())) {\n+\t\t\t\t\tContainer workingContainer = APILocator.getContainerAPI()\n+\t\t\t\t\t\t\t.getWorkingContainerById(id, user, false);\n+\t\t\t\t\tif (workingContainer != null) {\n+\t\t\t\t\t\tcontainerList.add(workingContainer);\n+\t\t\t\t\t}\n \n-\t\t\t\tContainer liveContainer = APILocator.getContainerAPI().getLiveContainerById(id, user, false);\n-\t\t\t\tif ( liveContainer != null ) {\n-\t\t\t\t\tcontainerList.add( liveContainer );\n-\t\t\t\t}\n+\t\t\t\t\tContainer liveContainer = APILocator.getContainerAPI()\n+\t\t\t\t\t\t\t.getLiveContainerById(id, user, false);\n+\t\t\t\t\tif (liveContainer != null) {\n+\t\t\t\t\t\tcontainerList.add(liveContainer);\n+\t\t\t\t\t}\n \n-\t\t\t\tfor (Container container : containerList) {\n+\t\t\t\t\tfor (Container container : containerList) {", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -942,44 +943,44 @@ public class DependencyManager {\n \n \t\ttry {\n \n-\t\t\tList<Container> containerList = new ArrayList<>();\n+\t\t\tfinal List<Container> containerList = new ArrayList<>();\n \n-\t\t\tfor (String id : containersSet) {\n-\t\t\t\tContainer c = APILocator.getContainerAPI().getWorkingContainerById(id, user, false);\n+\t\t\tfor (final String id : containersSet) {\n+\t\t\t\tfinal Container containerById = APILocator.getContainerAPI().getWorkingContainerById(id, user, false);\n \n \t\t\t\t// Host Dependency\n \t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\t\tHost h = APILocator.getContainerAPI().getParentHost(c, user, false);\n-\t\t\t\t\thosts.addOrClean(APILocator.getContainerAPI().getParentHost(c, user, false)\n-\t\t\t\t\t\t\t.getIdentifier(), h.getModDate());\n+\t\t\t\t\tfinal Host host = APILocator.getContainerAPI().getParentHost(containerById, user, false);\n+\t\t\t\t\thosts.addOrClean(APILocator.getContainerAPI().getParentHost(containerById, user, false)\n+\t\t\t\t\t\t\t.getIdentifier(), host.getModDate());\n \t\t\t\t}\n \n \t\t\t\tcontainerList.clear();\n \n \t\t\t\t// Content Type Dependencies\n \t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENT_TYPE.getType())) {\n-\t\t\t\t\tContainer workingContainer = APILocator.getContainerAPI()\n+\t\t\t\t\tfinal Container workingContainer = APILocator.getContainerAPI()\n \t\t\t\t\t\t\t.getWorkingContainerById(id, user, false);\n \t\t\t\t\tif (workingContainer != null) {\n \t\t\t\t\t\tcontainerList.add(workingContainer);\n \t\t\t\t\t}\n \n-\t\t\t\t\tContainer liveContainer = APILocator.getContainerAPI()\n+\t\t\t\t\tfinal Container liveContainer = APILocator.getContainerAPI()\n \t\t\t\t\t\t\t.getLiveContainerById(id, user, false);\n \t\t\t\t\tif (liveContainer != null) {\n \t\t\t\t\t\tcontainerList.add(liveContainer);\n \t\t\t\t\t}\n \n-\t\t\t\t\tfor (Container container : containerList) {\n+\t\t\t\t\tfor (final Container container : containerList) {\n \t\t\t\t\t\t// Structure dependencies\n-\t\t\t\t\t\tList<ContainerStructure> csList = APILocator.getContainerAPI()\n+\t\t\t\t\t\tfinal List<ContainerStructure> csList = APILocator.getContainerAPI()\n \t\t\t\t\t\t\t\t.getContainerStructures(container);\n \n-\t\t\t\t\t\tfor (ContainerStructure containerStructure : csList) {\n-\t\t\t\t\t\t\tStructure st = CacheLocator.getContentTypeCache()\n+\t\t\t\t\t\tfor (final ContainerStructure containerStructure : csList) {\n+\t\t\t\t\t\t\tfinal Structure structure = CacheLocator.getContentTypeCache()\n \t\t\t\t\t\t\t\t\t.getStructureByInode(containerStructure.getStructureId());\n \t\t\t\t\t\t\tcontentTypes.addOrClean(containerStructure.getStructureId(),\n-\t\t\t\t\t\t\t\t\tst.getModDate());\n+\t\t\t\t\t\t\t\t\tstructure.getModDate());\n \t\t\t\t\t\t\tcontentTypesSet.add(containerStructure.getStructureId());\n \t\t\t\t\t\t}\n \t\t\t\t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYxMjA0NA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424612044", "bodyText": "set to final", "author": "jdotcms", "createdAt": "2020-05-13T17:32:46Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -932,13 +1059,11 @@ private void setContainerDependencies() {\n \t * <li>Relationships</li>\n \t * </ul>\n \t */\n-\tprivate void setStructureDependencies() throws DotDataException, DotSecurityException {\n+\tprivate void setStructureDependencies(final PublisherFilter publisherFilter)  throws DotDataException, DotSecurityException {\n \t\ttry {\n \n-\t\t\tSet<String> s = new HashSet<String>();\n-\t\t\ts.addAll(structuresSet);\n-\t\t\tfor (String inode : s) {\n-\t\t\t\tstructureDependencyHelper(inode);\n+\t\t\tfor (String inode : contentTypesSet) {", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -1062,7 +1063,7 @@ public class DependencyManager {\n \tprivate void setStructureDependencies(final PublisherFilter publisherFilter)  throws DotDataException, DotSecurityException {\n \t\ttry {\n \n-\t\t\tfor (String inode : contentTypesSet) {\n+\t\t\tfor (final String inode : contentTypesSet) {\n \t\t\t\tstructureDependencyHelper(inode,publisherFilter);\n \t\t\t}\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYzMzc1Mg==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424633752", "bodyText": "rename to structure and set to final", "author": "jdotcms", "createdAt": "2020-05-13T18:09:08Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -952,48 +1077,79 @@ private void setStructureDependencies() throws DotDataException, DotSecurityExce\n \t * @throws DotDataException\n \t * @throws DotSecurityException\n \t */\n-\tprivate void structureDependencyHelper(String stInode) throws DotDataException, DotSecurityException{\n+\tprivate void structureDependencyHelper(final String stInode, final PublisherFilter publisherFilter) throws DotDataException, DotSecurityException{\n \t\tfinal Structure structure = CacheLocator.getContentTypeCache().getStructureByInode(stInode);\n-\t\tfinal Host host = APILocator.getHostAPI().find(structure.getHost(), user, false);\n-\t\thosts.addOrClean(structure.getHost(), host.getModDate()); // add the host dependency\n \n-\t\tfinal Folder folder = APILocator.getFolderAPI().find(structure.getFolder(), user, false);\n-\t\tfolders.addOrClean(structure.getFolder(), folder.getModDate()); // add the folder dependency\n+\t\t// Host Dependency\n+\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\tfinal Host host = APILocator.getHostAPI().find(structure.getHost(), user, false);\n+\t\t\thosts.addOrClean(structure.getHost(), host.getModDate()); // add the host dependency\n+\t\t}\n \n-\t\ttry {\n-\t\t\tfinal List<WorkflowScheme> schemes = APILocator.getWorkflowAPI().findSchemesForStruct(structure);\n-\t\t\tfor (final WorkflowScheme scheme : schemes) {\n-\t\t\t\tworkflows.addOrClean(scheme.getId(), scheme.getModDate());\n+\t\t// Folder Dependencies\n+\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n+\t\t\tfinal Folder folder = APILocator.getFolderAPI()\n+\t\t\t\t\t.find(structure.getFolder(), user, false);\n+\t\t\tfolders.addOrClean(structure.getFolder(),\n+\t\t\t\t\tfolder.getModDate()); // add the folder dependency\n+\t\t}\n+\n+\t\t// Workflows Dependencies\n+\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.WORKFLOW.getType())) {\n+\t\t\ttry {\n+\t\t\t\tfinal List<WorkflowScheme> schemes = APILocator.getWorkflowAPI()\n+\t\t\t\t\t\t.findSchemesForStruct(structure);\n+\t\t\t\tfor (final WorkflowScheme scheme : schemes) {\n+\t\t\t\t\tworkflows.addOrClean(scheme.getId(), scheme.getModDate());\n+\t\t\t\t}\n+\t\t\t} catch (DotDataException e) {\n+\t\t\t\tLogger.debug(getClass(),\n+\t\t\t\t\t\t() -> \"Could not get the Workflow Scheme Dependency for Structure ID: \"\n+\t\t\t\t\t\t\t\t+ structure.getInode());\n \t\t\t}\n-\t\t} catch (DotDataException e) {\n-\t\t\tLogger.debug(getClass(), ()->\"Could not get the Workflow Scheme Dependency for Structure ID: \" + structure.getInode());\n \t\t}\n \n-        APILocator.getCategoryAPI().findCategories(new StructureTransformer(structure).from(), user).forEach(category -> {\n-            this.categories.addOrClean(category.getCategoryId(), category.getModDate());\n-        });\n+\t\t// Categories Dependencies\n+\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CATEGORY.getType())) {\n+\t\t\tAPILocator.getCategoryAPI()\n+\t\t\t\t\t.findCategories(new StructureTransformer(structure).from(), user)\n+\t\t\t\t\t.forEach(category -> {\n+\t\t\t\t\t\tthis.categories.addOrClean(category.getCategoryId(), category.getModDate());\n+\t\t\t\t\t});\n+\t\t}\n \n \t\t// Related structures\n-\t\tfinal List<Relationship> relations = FactoryLocator.getRelationshipFactory().byContentType(structure);\n-\n-\t\tfor (final Relationship relationship : relations) {\n-\t\t\trelationships.addOrClean( relationship.getInode(), relationship.getModDate());\n-\n-\t\t\tif(!structures.contains(relationship.getChildStructureInode()) && config.getOperation().equals( Operation.PUBLISH) ){\n-\t\t\t\tStructure struct = CacheLocator.getContentTypeCache().getStructureByInode(relationship.getChildStructureInode());\n-\t\t\t\tsolvedStructures.add(stInode);\n-\t\t\t\tstructures.addOrClean( relationship.getChildStructureInode(), struct.getModDate());\n-\n-\t\t\t\tif(!solvedStructures.contains(relationship.getChildStructureInode()))\n-\t\t\t\t\tstructureDependencyHelper( relationship.getChildStructureInode() );\n-\t\t\t}\n-\t\t\tif(!structures.contains(relationship.getParentStructureInode()) && config.getOperation().equals( Operation.PUBLISH) ){\n-\t\t\t\tStructure struct = CacheLocator.getContentTypeCache().getStructureByInode(relationship.getParentStructureInode());\n-\t\t\t\tsolvedStructures.add(stInode);\n-\t\t\t\tstructures.addOrClean( relationship.getParentStructureInode(), struct.getModDate());\n-\n-\t\t\t\tif(!solvedStructures.contains(relationship.getParentStructureInode()))\n-\t\t\t\t\tstructureDependencyHelper( relationship.getParentStructureInode() );\n+\t\tif(publisherFilter.isRelationships()) {\n+\t\t\tfinal List<Relationship> relations = FactoryLocator.getRelationshipFactory()\n+\t\t\t\t\t.byContentType(structure);\n+\n+\t\t\tfor (final Relationship relationship : relations) {\n+\t\t\t\trelationships.addOrClean(relationship.getInode(), relationship.getModDate());\n+\n+\t\t\t\tif (!contentTypes.contains(relationship.getChildStructureInode()) && config\n+\t\t\t\t\t\t.getOperation().equals(Operation.PUBLISH)) {\n+\t\t\t\t\tStructure struct = CacheLocator.getContentTypeCache()", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -1128,15 +1129,16 @@ public class DependencyManager {\n \n \t\t\t\tif (!contentTypes.contains(relationship.getChildStructureInode()) && config\n \t\t\t\t\t\t.getOperation().equals(Operation.PUBLISH)) {\n-\t\t\t\t\tStructure struct = CacheLocator.getContentTypeCache()\n+\t\t\t\t\tfinal Structure childStructure = CacheLocator.getContentTypeCache()\n \t\t\t\t\t\t\t.getStructureByInode(relationship.getChildStructureInode());\n \t\t\t\t\tsolvedContentTypes.add(stInode);\n \t\t\t\t\tcontentTypes\n-\t\t\t\t\t\t\t.addOrClean(relationship.getChildStructureInode(), struct.getModDate());\n+\t\t\t\t\t\t\t.addOrClean(relationship.getChildStructureInode(), childStructure.getModDate());\n \n-\t\t\t\t\tif (!solvedContentTypes.contains(relationship.getChildStructureInode()))\n+\t\t\t\t\tif (!solvedContentTypes.contains(relationship.getChildStructureInode())) {\n \t\t\t\t\t\tstructureDependencyHelper(relationship.getChildStructureInode(),\n \t\t\t\t\t\t\t\tpublisherFilter);\n+\t\t\t\t\t}\n \t\t\t\t}\n \t\t\t\tif (!contentTypes.contains(relationship.getParentStructureInode()) && config\n \t\t\t\t\t\t.getOperation().equals(Operation.PUBLISH)) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYzMzk0Nw==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424633947", "bodyText": "use curly brackets", "author": "jdotcms", "createdAt": "2020-05-13T18:09:30Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -952,48 +1077,79 @@ private void setStructureDependencies() throws DotDataException, DotSecurityExce\n \t * @throws DotDataException\n \t * @throws DotSecurityException\n \t */\n-\tprivate void structureDependencyHelper(String stInode) throws DotDataException, DotSecurityException{\n+\tprivate void structureDependencyHelper(final String stInode, final PublisherFilter publisherFilter) throws DotDataException, DotSecurityException{\n \t\tfinal Structure structure = CacheLocator.getContentTypeCache().getStructureByInode(stInode);\n-\t\tfinal Host host = APILocator.getHostAPI().find(structure.getHost(), user, false);\n-\t\thosts.addOrClean(structure.getHost(), host.getModDate()); // add the host dependency\n \n-\t\tfinal Folder folder = APILocator.getFolderAPI().find(structure.getFolder(), user, false);\n-\t\tfolders.addOrClean(structure.getFolder(), folder.getModDate()); // add the folder dependency\n+\t\t// Host Dependency\n+\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\tfinal Host host = APILocator.getHostAPI().find(structure.getHost(), user, false);\n+\t\t\thosts.addOrClean(structure.getHost(), host.getModDate()); // add the host dependency\n+\t\t}\n \n-\t\ttry {\n-\t\t\tfinal List<WorkflowScheme> schemes = APILocator.getWorkflowAPI().findSchemesForStruct(structure);\n-\t\t\tfor (final WorkflowScheme scheme : schemes) {\n-\t\t\t\tworkflows.addOrClean(scheme.getId(), scheme.getModDate());\n+\t\t// Folder Dependencies\n+\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n+\t\t\tfinal Folder folder = APILocator.getFolderAPI()\n+\t\t\t\t\t.find(structure.getFolder(), user, false);\n+\t\t\tfolders.addOrClean(structure.getFolder(),\n+\t\t\t\t\tfolder.getModDate()); // add the folder dependency\n+\t\t}\n+\n+\t\t// Workflows Dependencies\n+\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.WORKFLOW.getType())) {\n+\t\t\ttry {\n+\t\t\t\tfinal List<WorkflowScheme> schemes = APILocator.getWorkflowAPI()\n+\t\t\t\t\t\t.findSchemesForStruct(structure);\n+\t\t\t\tfor (final WorkflowScheme scheme : schemes) {\n+\t\t\t\t\tworkflows.addOrClean(scheme.getId(), scheme.getModDate());\n+\t\t\t\t}\n+\t\t\t} catch (DotDataException e) {\n+\t\t\t\tLogger.debug(getClass(),\n+\t\t\t\t\t\t() -> \"Could not get the Workflow Scheme Dependency for Structure ID: \"\n+\t\t\t\t\t\t\t\t+ structure.getInode());\n \t\t\t}\n-\t\t} catch (DotDataException e) {\n-\t\t\tLogger.debug(getClass(), ()->\"Could not get the Workflow Scheme Dependency for Structure ID: \" + structure.getInode());\n \t\t}\n \n-        APILocator.getCategoryAPI().findCategories(new StructureTransformer(structure).from(), user).forEach(category -> {\n-            this.categories.addOrClean(category.getCategoryId(), category.getModDate());\n-        });\n+\t\t// Categories Dependencies\n+\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CATEGORY.getType())) {\n+\t\t\tAPILocator.getCategoryAPI()\n+\t\t\t\t\t.findCategories(new StructureTransformer(structure).from(), user)\n+\t\t\t\t\t.forEach(category -> {\n+\t\t\t\t\t\tthis.categories.addOrClean(category.getCategoryId(), category.getModDate());\n+\t\t\t\t\t});\n+\t\t}\n \n \t\t// Related structures\n-\t\tfinal List<Relationship> relations = FactoryLocator.getRelationshipFactory().byContentType(structure);\n-\n-\t\tfor (final Relationship relationship : relations) {\n-\t\t\trelationships.addOrClean( relationship.getInode(), relationship.getModDate());\n-\n-\t\t\tif(!structures.contains(relationship.getChildStructureInode()) && config.getOperation().equals( Operation.PUBLISH) ){\n-\t\t\t\tStructure struct = CacheLocator.getContentTypeCache().getStructureByInode(relationship.getChildStructureInode());\n-\t\t\t\tsolvedStructures.add(stInode);\n-\t\t\t\tstructures.addOrClean( relationship.getChildStructureInode(), struct.getModDate());\n-\n-\t\t\t\tif(!solvedStructures.contains(relationship.getChildStructureInode()))\n-\t\t\t\t\tstructureDependencyHelper( relationship.getChildStructureInode() );\n-\t\t\t}\n-\t\t\tif(!structures.contains(relationship.getParentStructureInode()) && config.getOperation().equals( Operation.PUBLISH) ){\n-\t\t\t\tStructure struct = CacheLocator.getContentTypeCache().getStructureByInode(relationship.getParentStructureInode());\n-\t\t\t\tsolvedStructures.add(stInode);\n-\t\t\t\tstructures.addOrClean( relationship.getParentStructureInode(), struct.getModDate());\n-\n-\t\t\t\tif(!solvedStructures.contains(relationship.getParentStructureInode()))\n-\t\t\t\t\tstructureDependencyHelper( relationship.getParentStructureInode() );\n+\t\tif(publisherFilter.isRelationships()) {\n+\t\t\tfinal List<Relationship> relations = FactoryLocator.getRelationshipFactory()\n+\t\t\t\t\t.byContentType(structure);\n+\n+\t\t\tfor (final Relationship relationship : relations) {\n+\t\t\t\trelationships.addOrClean(relationship.getInode(), relationship.getModDate());\n+\n+\t\t\t\tif (!contentTypes.contains(relationship.getChildStructureInode()) && config\n+\t\t\t\t\t\t.getOperation().equals(Operation.PUBLISH)) {\n+\t\t\t\t\tStructure struct = CacheLocator.getContentTypeCache()\n+\t\t\t\t\t\t\t.getStructureByInode(relationship.getChildStructureInode());\n+\t\t\t\t\tsolvedContentTypes.add(stInode);\n+\t\t\t\t\tcontentTypes\n+\t\t\t\t\t\t\t.addOrClean(relationship.getChildStructureInode(), struct.getModDate());\n+\n+\t\t\t\t\tif (!solvedContentTypes.contains(relationship.getChildStructureInode()))", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -1128,15 +1129,16 @@ public class DependencyManager {\n \n \t\t\t\tif (!contentTypes.contains(relationship.getChildStructureInode()) && config\n \t\t\t\t\t\t.getOperation().equals(Operation.PUBLISH)) {\n-\t\t\t\t\tStructure struct = CacheLocator.getContentTypeCache()\n+\t\t\t\t\tfinal Structure childStructure = CacheLocator.getContentTypeCache()\n \t\t\t\t\t\t\t.getStructureByInode(relationship.getChildStructureInode());\n \t\t\t\t\tsolvedContentTypes.add(stInode);\n \t\t\t\t\tcontentTypes\n-\t\t\t\t\t\t\t.addOrClean(relationship.getChildStructureInode(), struct.getModDate());\n+\t\t\t\t\t\t\t.addOrClean(relationship.getChildStructureInode(), childStructure.getModDate());\n \n-\t\t\t\t\tif (!solvedContentTypes.contains(relationship.getChildStructureInode()))\n+\t\t\t\t\tif (!solvedContentTypes.contains(relationship.getChildStructureInode())) {\n \t\t\t\t\t\tstructureDependencyHelper(relationship.getChildStructureInode(),\n \t\t\t\t\t\t\t\tpublisherFilter);\n+\t\t\t\t\t}\n \t\t\t\t}\n \t\t\t\tif (!contentTypes.contains(relationship.getParentStructureInode()) && config\n \t\t\t\t\t\t.getOperation().equals(Operation.PUBLISH)) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYzNDIwNQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424634205", "bodyText": "set to final", "author": "jdotcms", "createdAt": "2020-05-13T18:09:54Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -1004,36 +1160,45 @@ private void structureDependencyHelper(String stInode) throws DotDataException,\n \t * @throws DotDataException\n \t * @throws DotSecurityException\n \t */\n-\tprivate void processList(Set<Contentlet> cons) throws DotDataException, DotSecurityException {\n+\tprivate void processList(final Set<Contentlet> cons, final PublisherFilter publisherFilter) throws DotDataException, DotSecurityException {\n \t\tSet<Contentlet> contentsToProcess = new HashSet<Contentlet>();", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -1156,63 +1158,63 @@ public class DependencyManager {\n \n \t/**\n \t * \n-\t * @param cons\n+\t * @param contentletSet\n \t * @throws DotDataException\n \t * @throws DotSecurityException\n \t */\n-\tprivate void processList(final Set<Contentlet> cons, final PublisherFilter publisherFilter) throws DotDataException, DotSecurityException {\n-\t\tSet<Contentlet> contentsToProcess = new HashSet<Contentlet>();\n-\t\tSet<Contentlet> contentsWithDependenciesToProcess = new HashSet<Contentlet>();\n+\tprivate void processList(final Set<Contentlet> contentletSet, final PublisherFilter publisherFilter) throws DotDataException, DotSecurityException {\n+\t\tfinal Set<Contentlet> contentsToProcess = new HashSet<Contentlet>();\n+\t\tfinal Set<Contentlet> contentsWithDependenciesToProcess = new HashSet<Contentlet>();\n \n-\t\tfor (Contentlet con : cons) {\n+\t\tfor (final Contentlet contentlet : contentletSet) {\n \t\t\t// Host Dependency\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\tHost h = APILocator.getHostAPI().find(con.getHost(), user, false);\n-\t\t\t\thosts.addOrClean(con.getHost(), h.getModDate());\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(contentlet.getHost(), user, false);\n+\t\t\t\thosts.addOrClean(contentlet.getHost(), host.getModDate());\n \t\t\t}\n \n-\t\t\tcontentsToProcess.add(con);\n+\t\t\tcontentsToProcess.add(contentlet);\n \n \t\t\t// Relationships Dependencies\n \t\t\tif(publisherFilter.isRelationships()) {\n-\t\t\t\tMap<Relationship, List<Contentlet>> contentRel =\n-\t\t\t\t\t\tAPILocator.getContentletAPI().findContentRelationships(con, user);\n+\t\t\t\tfinal Map<Relationship, List<Contentlet>> contentRelationshipsMap =\n+\t\t\t\t\t\tAPILocator.getContentletAPI().findContentRelationships(contentlet, user);\n \n-\t\t\t\tfor (Relationship rel : contentRel.keySet()) {\n-\t\t\t\t\tcontentsToProcess.addAll(contentRel.get(rel));\n+\t\t\t\tfor (final Relationship relationship : contentRelationshipsMap.keySet()) {\n+\t\t\t\t\tcontentsToProcess.addAll(contentRelationshipsMap.get(relationship));\n \t\t\t\t\t/**\n \t\t\t\t\t * ISSUE #2222: https://github.com/dotCMS/dotCMS/issues/2222\n \t\t\t\t\t *\n \t\t\t\t\t * We need the relationships in which the single related content is involved.\n \t\t\t\t\t *\n \t\t\t\t\t */\n-\t\t\t\t\tif (contentRel.get(rel).size() > 0)\n-\t\t\t\t\t\trelationships.addOrClean(rel.getInode(), rel.getModDate());\n+\t\t\t\t\tif (contentRelationshipsMap.get(relationship).size() > 0)\n+\t\t\t\t\t\trelationships.addOrClean(relationship.getInode(), relationship.getModDate());\n \t\t\t\t}\n \t\t\t}\n \t\t}\n \t\t// end relationships false\n \n-\t\tfor (Contentlet con : contentsToProcess) {\n+\t\tfor (final Contentlet contentletToProcess : contentsToProcess) {\n \t\t\t// Host Dependency\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\tHost h = APILocator.getHostAPI().find(con.getHost(), user, false);\n-\t\t\t\thosts.addOrClean(con.getHost(), h.getModDate());\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(contentletToProcess.getHost(), user, false);\n+\t\t\t\thosts.addOrClean(contentletToProcess.getHost(), host.getModDate());\n \t\t\t}\n-\t\t\tcontentsWithDependenciesToProcess.add(con);\n+\t\t\tcontentsWithDependenciesToProcess.add(contentletToProcess);\n \t\t\t//Copy asset files to bundle folder keeping original folders structure\n-\t\t\tList<Field> fields=FieldsCache.getFieldsByStructureInode(con.getStructureInode());\n+\t\t\tfinal List<Field> fields=FieldsCache.getFieldsByStructureInode(contentletToProcess.getStructureInode());\n \n-\t\t\tfor(Field ff : fields) {\n-\t\t\t\tif (ff.getFieldType().equals(Field.FieldType.IMAGE.toString())\n-\t\t\t\t\t\t|| ff.getFieldType().equals(Field.FieldType.FILE.toString())) {\n+\t\t\tfor(final Field field : fields) {\n+\t\t\t\tif (field.getFieldType().equals(Field.FieldType.IMAGE.toString())\n+\t\t\t\t\t\t|| field.getFieldType().equals(Field.FieldType.FILE.toString())) {\n \n \t\t\t\t\ttry {\n \t\t\t\t\t\tString value = \"\";\n-\t\t\t\t\t\tif(UtilMethods.isSet(APILocator.getContentletAPI().getFieldValue(con, ff))){\n-\t\t\t\t\t\t\tvalue = APILocator.getContentletAPI().getFieldValue(con, ff).toString();\n+\t\t\t\t\t\tif(UtilMethods.isSet(APILocator.getContentletAPI().getFieldValue(contentletToProcess, field))){\n+\t\t\t\t\t\t\tvalue = APILocator.getContentletAPI().getFieldValue(contentletToProcess, field).toString();\n \t\t\t\t\t\t}\n-\t\t\t\t\t\tIdentifier id = APILocator.getIdentifierAPI().find(value);\n+\t\t\t\t\t\tfinal Identifier id = APILocator.getIdentifierAPI().find(value);\n \t\t\t\t\t\tif (InodeUtils.isSet(id.getInode()) && id.getAssetType().equals(\"contentlet\")) {\n \t\t\t\t\t\t\tcontentsWithDependenciesToProcess.addAll(\n \t\t\t\t\t\t\t\t\tAPILocator.getContentletAPI()\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYzNDQwMA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424634400", "bodyText": "rename to contentlet and set to final", "author": "jdotcms", "createdAt": "2020-05-13T18:10:12Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -1004,36 +1160,45 @@ private void structureDependencyHelper(String stInode) throws DotDataException,\n \t * @throws DotDataException\n \t * @throws DotSecurityException\n \t */\n-\tprivate void processList(Set<Contentlet> cons) throws DotDataException, DotSecurityException {\n+\tprivate void processList(final Set<Contentlet> cons, final PublisherFilter publisherFilter) throws DotDataException, DotSecurityException {\n \t\tSet<Contentlet> contentsToProcess = new HashSet<Contentlet>();\n \t\tSet<Contentlet> contentsWithDependenciesToProcess = new HashSet<Contentlet>();\n \n-\t\t//Getting all related content\n-\n \t\tfor (Contentlet con : cons) {", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -1156,63 +1158,63 @@ public class DependencyManager {\n \n \t/**\n \t * \n-\t * @param cons\n+\t * @param contentletSet\n \t * @throws DotDataException\n \t * @throws DotSecurityException\n \t */\n-\tprivate void processList(final Set<Contentlet> cons, final PublisherFilter publisherFilter) throws DotDataException, DotSecurityException {\n-\t\tSet<Contentlet> contentsToProcess = new HashSet<Contentlet>();\n-\t\tSet<Contentlet> contentsWithDependenciesToProcess = new HashSet<Contentlet>();\n+\tprivate void processList(final Set<Contentlet> contentletSet, final PublisherFilter publisherFilter) throws DotDataException, DotSecurityException {\n+\t\tfinal Set<Contentlet> contentsToProcess = new HashSet<Contentlet>();\n+\t\tfinal Set<Contentlet> contentsWithDependenciesToProcess = new HashSet<Contentlet>();\n \n-\t\tfor (Contentlet con : cons) {\n+\t\tfor (final Contentlet contentlet : contentletSet) {\n \t\t\t// Host Dependency\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\tHost h = APILocator.getHostAPI().find(con.getHost(), user, false);\n-\t\t\t\thosts.addOrClean(con.getHost(), h.getModDate());\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(contentlet.getHost(), user, false);\n+\t\t\t\thosts.addOrClean(contentlet.getHost(), host.getModDate());\n \t\t\t}\n \n-\t\t\tcontentsToProcess.add(con);\n+\t\t\tcontentsToProcess.add(contentlet);\n \n \t\t\t// Relationships Dependencies\n \t\t\tif(publisherFilter.isRelationships()) {\n-\t\t\t\tMap<Relationship, List<Contentlet>> contentRel =\n-\t\t\t\t\t\tAPILocator.getContentletAPI().findContentRelationships(con, user);\n+\t\t\t\tfinal Map<Relationship, List<Contentlet>> contentRelationshipsMap =\n+\t\t\t\t\t\tAPILocator.getContentletAPI().findContentRelationships(contentlet, user);\n \n-\t\t\t\tfor (Relationship rel : contentRel.keySet()) {\n-\t\t\t\t\tcontentsToProcess.addAll(contentRel.get(rel));\n+\t\t\t\tfor (final Relationship relationship : contentRelationshipsMap.keySet()) {\n+\t\t\t\t\tcontentsToProcess.addAll(contentRelationshipsMap.get(relationship));\n \t\t\t\t\t/**\n \t\t\t\t\t * ISSUE #2222: https://github.com/dotCMS/dotCMS/issues/2222\n \t\t\t\t\t *\n \t\t\t\t\t * We need the relationships in which the single related content is involved.\n \t\t\t\t\t *\n \t\t\t\t\t */\n-\t\t\t\t\tif (contentRel.get(rel).size() > 0)\n-\t\t\t\t\t\trelationships.addOrClean(rel.getInode(), rel.getModDate());\n+\t\t\t\t\tif (contentRelationshipsMap.get(relationship).size() > 0)\n+\t\t\t\t\t\trelationships.addOrClean(relationship.getInode(), relationship.getModDate());\n \t\t\t\t}\n \t\t\t}\n \t\t}\n \t\t// end relationships false\n \n-\t\tfor (Contentlet con : contentsToProcess) {\n+\t\tfor (final Contentlet contentletToProcess : contentsToProcess) {\n \t\t\t// Host Dependency\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\tHost h = APILocator.getHostAPI().find(con.getHost(), user, false);\n-\t\t\t\thosts.addOrClean(con.getHost(), h.getModDate());\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(contentletToProcess.getHost(), user, false);\n+\t\t\t\thosts.addOrClean(contentletToProcess.getHost(), host.getModDate());\n \t\t\t}\n-\t\t\tcontentsWithDependenciesToProcess.add(con);\n+\t\t\tcontentsWithDependenciesToProcess.add(contentletToProcess);\n \t\t\t//Copy asset files to bundle folder keeping original folders structure\n-\t\t\tList<Field> fields=FieldsCache.getFieldsByStructureInode(con.getStructureInode());\n+\t\t\tfinal List<Field> fields=FieldsCache.getFieldsByStructureInode(contentletToProcess.getStructureInode());\n \n-\t\t\tfor(Field ff : fields) {\n-\t\t\t\tif (ff.getFieldType().equals(Field.FieldType.IMAGE.toString())\n-\t\t\t\t\t\t|| ff.getFieldType().equals(Field.FieldType.FILE.toString())) {\n+\t\t\tfor(final Field field : fields) {\n+\t\t\t\tif (field.getFieldType().equals(Field.FieldType.IMAGE.toString())\n+\t\t\t\t\t\t|| field.getFieldType().equals(Field.FieldType.FILE.toString())) {\n \n \t\t\t\t\ttry {\n \t\t\t\t\t\tString value = \"\";\n-\t\t\t\t\t\tif(UtilMethods.isSet(APILocator.getContentletAPI().getFieldValue(con, ff))){\n-\t\t\t\t\t\t\tvalue = APILocator.getContentletAPI().getFieldValue(con, ff).toString();\n+\t\t\t\t\t\tif(UtilMethods.isSet(APILocator.getContentletAPI().getFieldValue(contentletToProcess, field))){\n+\t\t\t\t\t\t\tvalue = APILocator.getContentletAPI().getFieldValue(contentletToProcess, field).toString();\n \t\t\t\t\t\t}\n-\t\t\t\t\t\tIdentifier id = APILocator.getIdentifierAPI().find(value);\n+\t\t\t\t\t\tfinal Identifier id = APILocator.getIdentifierAPI().find(value);\n \t\t\t\t\t\tif (InodeUtils.isSet(id.getInode()) && id.getAssetType().equals(\"contentlet\")) {\n \t\t\t\t\t\t\tcontentsWithDependenciesToProcess.addAll(\n \t\t\t\t\t\t\t\t\tAPILocator.getContentletAPI()\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYzNDUxOQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424634519", "bodyText": "rename to contentletSet", "author": "jdotcms", "createdAt": "2020-05-13T18:10:24Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -1004,36 +1160,45 @@ private void structureDependencyHelper(String stInode) throws DotDataException,\n \t * @throws DotDataException\n \t * @throws DotSecurityException\n \t */\n-\tprivate void processList(Set<Contentlet> cons) throws DotDataException, DotSecurityException {\n+\tprivate void processList(final Set<Contentlet> cons, final PublisherFilter publisherFilter) throws DotDataException, DotSecurityException {", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -1156,63 +1158,63 @@ public class DependencyManager {\n \n \t/**\n \t * \n-\t * @param cons\n+\t * @param contentletSet\n \t * @throws DotDataException\n \t * @throws DotSecurityException\n \t */\n-\tprivate void processList(final Set<Contentlet> cons, final PublisherFilter publisherFilter) throws DotDataException, DotSecurityException {\n-\t\tSet<Contentlet> contentsToProcess = new HashSet<Contentlet>();\n-\t\tSet<Contentlet> contentsWithDependenciesToProcess = new HashSet<Contentlet>();\n+\tprivate void processList(final Set<Contentlet> contentletSet, final PublisherFilter publisherFilter) throws DotDataException, DotSecurityException {\n+\t\tfinal Set<Contentlet> contentsToProcess = new HashSet<Contentlet>();\n+\t\tfinal Set<Contentlet> contentsWithDependenciesToProcess = new HashSet<Contentlet>();\n \n-\t\tfor (Contentlet con : cons) {\n+\t\tfor (final Contentlet contentlet : contentletSet) {\n \t\t\t// Host Dependency\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\tHost h = APILocator.getHostAPI().find(con.getHost(), user, false);\n-\t\t\t\thosts.addOrClean(con.getHost(), h.getModDate());\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(contentlet.getHost(), user, false);\n+\t\t\t\thosts.addOrClean(contentlet.getHost(), host.getModDate());\n \t\t\t}\n \n-\t\t\tcontentsToProcess.add(con);\n+\t\t\tcontentsToProcess.add(contentlet);\n \n \t\t\t// Relationships Dependencies\n \t\t\tif(publisherFilter.isRelationships()) {\n-\t\t\t\tMap<Relationship, List<Contentlet>> contentRel =\n-\t\t\t\t\t\tAPILocator.getContentletAPI().findContentRelationships(con, user);\n+\t\t\t\tfinal Map<Relationship, List<Contentlet>> contentRelationshipsMap =\n+\t\t\t\t\t\tAPILocator.getContentletAPI().findContentRelationships(contentlet, user);\n \n-\t\t\t\tfor (Relationship rel : contentRel.keySet()) {\n-\t\t\t\t\tcontentsToProcess.addAll(contentRel.get(rel));\n+\t\t\t\tfor (final Relationship relationship : contentRelationshipsMap.keySet()) {\n+\t\t\t\t\tcontentsToProcess.addAll(contentRelationshipsMap.get(relationship));\n \t\t\t\t\t/**\n \t\t\t\t\t * ISSUE #2222: https://github.com/dotCMS/dotCMS/issues/2222\n \t\t\t\t\t *\n \t\t\t\t\t * We need the relationships in which the single related content is involved.\n \t\t\t\t\t *\n \t\t\t\t\t */\n-\t\t\t\t\tif (contentRel.get(rel).size() > 0)\n-\t\t\t\t\t\trelationships.addOrClean(rel.getInode(), rel.getModDate());\n+\t\t\t\t\tif (contentRelationshipsMap.get(relationship).size() > 0)\n+\t\t\t\t\t\trelationships.addOrClean(relationship.getInode(), relationship.getModDate());\n \t\t\t\t}\n \t\t\t}\n \t\t}\n \t\t// end relationships false\n \n-\t\tfor (Contentlet con : contentsToProcess) {\n+\t\tfor (final Contentlet contentletToProcess : contentsToProcess) {\n \t\t\t// Host Dependency\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\tHost h = APILocator.getHostAPI().find(con.getHost(), user, false);\n-\t\t\t\thosts.addOrClean(con.getHost(), h.getModDate());\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(contentletToProcess.getHost(), user, false);\n+\t\t\t\thosts.addOrClean(contentletToProcess.getHost(), host.getModDate());\n \t\t\t}\n-\t\t\tcontentsWithDependenciesToProcess.add(con);\n+\t\t\tcontentsWithDependenciesToProcess.add(contentletToProcess);\n \t\t\t//Copy asset files to bundle folder keeping original folders structure\n-\t\t\tList<Field> fields=FieldsCache.getFieldsByStructureInode(con.getStructureInode());\n+\t\t\tfinal List<Field> fields=FieldsCache.getFieldsByStructureInode(contentletToProcess.getStructureInode());\n \n-\t\t\tfor(Field ff : fields) {\n-\t\t\t\tif (ff.getFieldType().equals(Field.FieldType.IMAGE.toString())\n-\t\t\t\t\t\t|| ff.getFieldType().equals(Field.FieldType.FILE.toString())) {\n+\t\t\tfor(final Field field : fields) {\n+\t\t\t\tif (field.getFieldType().equals(Field.FieldType.IMAGE.toString())\n+\t\t\t\t\t\t|| field.getFieldType().equals(Field.FieldType.FILE.toString())) {\n \n \t\t\t\t\ttry {\n \t\t\t\t\t\tString value = \"\";\n-\t\t\t\t\t\tif(UtilMethods.isSet(APILocator.getContentletAPI().getFieldValue(con, ff))){\n-\t\t\t\t\t\t\tvalue = APILocator.getContentletAPI().getFieldValue(con, ff).toString();\n+\t\t\t\t\t\tif(UtilMethods.isSet(APILocator.getContentletAPI().getFieldValue(contentletToProcess, field))){\n+\t\t\t\t\t\t\tvalue = APILocator.getContentletAPI().getFieldValue(contentletToProcess, field).toString();\n \t\t\t\t\t\t}\n-\t\t\t\t\t\tIdentifier id = APILocator.getIdentifierAPI().find(value);\n+\t\t\t\t\t\tfinal Identifier id = APILocator.getIdentifierAPI().find(value);\n \t\t\t\t\t\tif (InodeUtils.isSet(id.getInode()) && id.getAssetType().equals(\"contentlet\")) {\n \t\t\t\t\t\t\tcontentsWithDependenciesToProcess.addAll(\n \t\t\t\t\t\t\t\t\tAPILocator.getContentletAPI()\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYzNDY4NA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424634684", "bodyText": "rename to host and set to final", "author": "jdotcms", "createdAt": "2020-05-13T18:10:39Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -1004,36 +1160,45 @@ private void structureDependencyHelper(String stInode) throws DotDataException,\n \t * @throws DotDataException\n \t * @throws DotSecurityException\n \t */\n-\tprivate void processList(Set<Contentlet> cons) throws DotDataException, DotSecurityException {\n+\tprivate void processList(final Set<Contentlet> cons, final PublisherFilter publisherFilter) throws DotDataException, DotSecurityException {\n \t\tSet<Contentlet> contentsToProcess = new HashSet<Contentlet>();\n \t\tSet<Contentlet> contentsWithDependenciesToProcess = new HashSet<Contentlet>();\n \n-\t\t//Getting all related content\n-\n \t\tfor (Contentlet con : cons) {\n-\t\t\tHost h = APILocator.getHostAPI().find(con.getHost(), user, false);\n-\t\t\thosts.addOrClean( con.getHost(), h.getModDate()); // add the host dependency\n+\t\t\t// Host Dependency\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\tHost h = APILocator.getHostAPI().find(con.getHost(), user, false);", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -1156,63 +1158,63 @@ public class DependencyManager {\n \n \t/**\n \t * \n-\t * @param cons\n+\t * @param contentletSet\n \t * @throws DotDataException\n \t * @throws DotSecurityException\n \t */\n-\tprivate void processList(final Set<Contentlet> cons, final PublisherFilter publisherFilter) throws DotDataException, DotSecurityException {\n-\t\tSet<Contentlet> contentsToProcess = new HashSet<Contentlet>();\n-\t\tSet<Contentlet> contentsWithDependenciesToProcess = new HashSet<Contentlet>();\n+\tprivate void processList(final Set<Contentlet> contentletSet, final PublisherFilter publisherFilter) throws DotDataException, DotSecurityException {\n+\t\tfinal Set<Contentlet> contentsToProcess = new HashSet<Contentlet>();\n+\t\tfinal Set<Contentlet> contentsWithDependenciesToProcess = new HashSet<Contentlet>();\n \n-\t\tfor (Contentlet con : cons) {\n+\t\tfor (final Contentlet contentlet : contentletSet) {\n \t\t\t// Host Dependency\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\tHost h = APILocator.getHostAPI().find(con.getHost(), user, false);\n-\t\t\t\thosts.addOrClean(con.getHost(), h.getModDate());\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(contentlet.getHost(), user, false);\n+\t\t\t\thosts.addOrClean(contentlet.getHost(), host.getModDate());\n \t\t\t}\n \n-\t\t\tcontentsToProcess.add(con);\n+\t\t\tcontentsToProcess.add(contentlet);\n \n \t\t\t// Relationships Dependencies\n \t\t\tif(publisherFilter.isRelationships()) {\n-\t\t\t\tMap<Relationship, List<Contentlet>> contentRel =\n-\t\t\t\t\t\tAPILocator.getContentletAPI().findContentRelationships(con, user);\n+\t\t\t\tfinal Map<Relationship, List<Contentlet>> contentRelationshipsMap =\n+\t\t\t\t\t\tAPILocator.getContentletAPI().findContentRelationships(contentlet, user);\n \n-\t\t\t\tfor (Relationship rel : contentRel.keySet()) {\n-\t\t\t\t\tcontentsToProcess.addAll(contentRel.get(rel));\n+\t\t\t\tfor (final Relationship relationship : contentRelationshipsMap.keySet()) {\n+\t\t\t\t\tcontentsToProcess.addAll(contentRelationshipsMap.get(relationship));\n \t\t\t\t\t/**\n \t\t\t\t\t * ISSUE #2222: https://github.com/dotCMS/dotCMS/issues/2222\n \t\t\t\t\t *\n \t\t\t\t\t * We need the relationships in which the single related content is involved.\n \t\t\t\t\t *\n \t\t\t\t\t */\n-\t\t\t\t\tif (contentRel.get(rel).size() > 0)\n-\t\t\t\t\t\trelationships.addOrClean(rel.getInode(), rel.getModDate());\n+\t\t\t\t\tif (contentRelationshipsMap.get(relationship).size() > 0)\n+\t\t\t\t\t\trelationships.addOrClean(relationship.getInode(), relationship.getModDate());\n \t\t\t\t}\n \t\t\t}\n \t\t}\n \t\t// end relationships false\n \n-\t\tfor (Contentlet con : contentsToProcess) {\n+\t\tfor (final Contentlet contentletToProcess : contentsToProcess) {\n \t\t\t// Host Dependency\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\tHost h = APILocator.getHostAPI().find(con.getHost(), user, false);\n-\t\t\t\thosts.addOrClean(con.getHost(), h.getModDate());\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(contentletToProcess.getHost(), user, false);\n+\t\t\t\thosts.addOrClean(contentletToProcess.getHost(), host.getModDate());\n \t\t\t}\n-\t\t\tcontentsWithDependenciesToProcess.add(con);\n+\t\t\tcontentsWithDependenciesToProcess.add(contentletToProcess);\n \t\t\t//Copy asset files to bundle folder keeping original folders structure\n-\t\t\tList<Field> fields=FieldsCache.getFieldsByStructureInode(con.getStructureInode());\n+\t\t\tfinal List<Field> fields=FieldsCache.getFieldsByStructureInode(contentletToProcess.getStructureInode());\n \n-\t\t\tfor(Field ff : fields) {\n-\t\t\t\tif (ff.getFieldType().equals(Field.FieldType.IMAGE.toString())\n-\t\t\t\t\t\t|| ff.getFieldType().equals(Field.FieldType.FILE.toString())) {\n+\t\t\tfor(final Field field : fields) {\n+\t\t\t\tif (field.getFieldType().equals(Field.FieldType.IMAGE.toString())\n+\t\t\t\t\t\t|| field.getFieldType().equals(Field.FieldType.FILE.toString())) {\n \n \t\t\t\t\ttry {\n \t\t\t\t\t\tString value = \"\";\n-\t\t\t\t\t\tif(UtilMethods.isSet(APILocator.getContentletAPI().getFieldValue(con, ff))){\n-\t\t\t\t\t\t\tvalue = APILocator.getContentletAPI().getFieldValue(con, ff).toString();\n+\t\t\t\t\t\tif(UtilMethods.isSet(APILocator.getContentletAPI().getFieldValue(contentletToProcess, field))){\n+\t\t\t\t\t\t\tvalue = APILocator.getContentletAPI().getFieldValue(contentletToProcess, field).toString();\n \t\t\t\t\t\t}\n-\t\t\t\t\t\tIdentifier id = APILocator.getIdentifierAPI().find(value);\n+\t\t\t\t\t\tfinal Identifier id = APILocator.getIdentifierAPI().find(value);\n \t\t\t\t\t\tif (InodeUtils.isSet(id.getInode()) && id.getAssetType().equals(\"contentlet\")) {\n \t\t\t\t\t\t\tcontentsWithDependenciesToProcess.addAll(\n \t\t\t\t\t\t\t\t\tAPILocator.getContentletAPI()\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYzNDg5MQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424634891", "bodyText": "rename to contentRelatedMap", "author": "jdotcms", "createdAt": "2020-05-13T18:10:56Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -1004,36 +1160,45 @@ private void structureDependencyHelper(String stInode) throws DotDataException,\n \t * @throws DotDataException\n \t * @throws DotSecurityException\n \t */\n-\tprivate void processList(Set<Contentlet> cons) throws DotDataException, DotSecurityException {\n+\tprivate void processList(final Set<Contentlet> cons, final PublisherFilter publisherFilter) throws DotDataException, DotSecurityException {\n \t\tSet<Contentlet> contentsToProcess = new HashSet<Contentlet>();\n \t\tSet<Contentlet> contentsWithDependenciesToProcess = new HashSet<Contentlet>();\n \n-\t\t//Getting all related content\n-\n \t\tfor (Contentlet con : cons) {\n-\t\t\tHost h = APILocator.getHostAPI().find(con.getHost(), user, false);\n-\t\t\thosts.addOrClean( con.getHost(), h.getModDate()); // add the host dependency\n+\t\t\t// Host Dependency\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\tHost h = APILocator.getHostAPI().find(con.getHost(), user, false);\n+\t\t\t\thosts.addOrClean(con.getHost(), h.getModDate());\n+\t\t\t}\n+\n \t\t\tcontentsToProcess.add(con);\n \n-\t\t\tMap<Relationship, List<Contentlet>> contentRel =\n-\t\t\t\t\tAPILocator.getContentletAPI().findContentRelationships(con, user);\n-\n-\t\t\tfor (Relationship rel : contentRel.keySet()) {\n-\t\t\t\tcontentsToProcess.addAll(contentRel.get(rel));\n-\t\t\t\t/**\n-\t\t\t\t * ISSUE #2222: https://github.com/dotCMS/dotCMS/issues/2222\n-\t\t\t\t *\n-\t\t\t\t * We need the relationships in which the single related content is involved.\n-\t\t\t\t *\n-\t\t\t\t */\n-\t\t\t\tif(contentRel.get(rel).size()>0)\n-\t\t\t\t\trelationships.addOrClean( rel.getInode(), rel.getModDate());\n+\t\t\t// Relationships Dependencies\n+\t\t\tif(publisherFilter.isRelationships()) {\n+\t\t\t\tMap<Relationship, List<Contentlet>> contentRel =", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -1156,63 +1158,63 @@ public class DependencyManager {\n \n \t/**\n \t * \n-\t * @param cons\n+\t * @param contentletSet\n \t * @throws DotDataException\n \t * @throws DotSecurityException\n \t */\n-\tprivate void processList(final Set<Contentlet> cons, final PublisherFilter publisherFilter) throws DotDataException, DotSecurityException {\n-\t\tSet<Contentlet> contentsToProcess = new HashSet<Contentlet>();\n-\t\tSet<Contentlet> contentsWithDependenciesToProcess = new HashSet<Contentlet>();\n+\tprivate void processList(final Set<Contentlet> contentletSet, final PublisherFilter publisherFilter) throws DotDataException, DotSecurityException {\n+\t\tfinal Set<Contentlet> contentsToProcess = new HashSet<Contentlet>();\n+\t\tfinal Set<Contentlet> contentsWithDependenciesToProcess = new HashSet<Contentlet>();\n \n-\t\tfor (Contentlet con : cons) {\n+\t\tfor (final Contentlet contentlet : contentletSet) {\n \t\t\t// Host Dependency\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\tHost h = APILocator.getHostAPI().find(con.getHost(), user, false);\n-\t\t\t\thosts.addOrClean(con.getHost(), h.getModDate());\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(contentlet.getHost(), user, false);\n+\t\t\t\thosts.addOrClean(contentlet.getHost(), host.getModDate());\n \t\t\t}\n \n-\t\t\tcontentsToProcess.add(con);\n+\t\t\tcontentsToProcess.add(contentlet);\n \n \t\t\t// Relationships Dependencies\n \t\t\tif(publisherFilter.isRelationships()) {\n-\t\t\t\tMap<Relationship, List<Contentlet>> contentRel =\n-\t\t\t\t\t\tAPILocator.getContentletAPI().findContentRelationships(con, user);\n+\t\t\t\tfinal Map<Relationship, List<Contentlet>> contentRelationshipsMap =\n+\t\t\t\t\t\tAPILocator.getContentletAPI().findContentRelationships(contentlet, user);\n \n-\t\t\t\tfor (Relationship rel : contentRel.keySet()) {\n-\t\t\t\t\tcontentsToProcess.addAll(contentRel.get(rel));\n+\t\t\t\tfor (final Relationship relationship : contentRelationshipsMap.keySet()) {\n+\t\t\t\t\tcontentsToProcess.addAll(contentRelationshipsMap.get(relationship));\n \t\t\t\t\t/**\n \t\t\t\t\t * ISSUE #2222: https://github.com/dotCMS/dotCMS/issues/2222\n \t\t\t\t\t *\n \t\t\t\t\t * We need the relationships in which the single related content is involved.\n \t\t\t\t\t *\n \t\t\t\t\t */\n-\t\t\t\t\tif (contentRel.get(rel).size() > 0)\n-\t\t\t\t\t\trelationships.addOrClean(rel.getInode(), rel.getModDate());\n+\t\t\t\t\tif (contentRelationshipsMap.get(relationship).size() > 0)\n+\t\t\t\t\t\trelationships.addOrClean(relationship.getInode(), relationship.getModDate());\n \t\t\t\t}\n \t\t\t}\n \t\t}\n \t\t// end relationships false\n \n-\t\tfor (Contentlet con : contentsToProcess) {\n+\t\tfor (final Contentlet contentletToProcess : contentsToProcess) {\n \t\t\t// Host Dependency\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\tHost h = APILocator.getHostAPI().find(con.getHost(), user, false);\n-\t\t\t\thosts.addOrClean(con.getHost(), h.getModDate());\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(contentletToProcess.getHost(), user, false);\n+\t\t\t\thosts.addOrClean(contentletToProcess.getHost(), host.getModDate());\n \t\t\t}\n-\t\t\tcontentsWithDependenciesToProcess.add(con);\n+\t\t\tcontentsWithDependenciesToProcess.add(contentletToProcess);\n \t\t\t//Copy asset files to bundle folder keeping original folders structure\n-\t\t\tList<Field> fields=FieldsCache.getFieldsByStructureInode(con.getStructureInode());\n+\t\t\tfinal List<Field> fields=FieldsCache.getFieldsByStructureInode(contentletToProcess.getStructureInode());\n \n-\t\t\tfor(Field ff : fields) {\n-\t\t\t\tif (ff.getFieldType().equals(Field.FieldType.IMAGE.toString())\n-\t\t\t\t\t\t|| ff.getFieldType().equals(Field.FieldType.FILE.toString())) {\n+\t\t\tfor(final Field field : fields) {\n+\t\t\t\tif (field.getFieldType().equals(Field.FieldType.IMAGE.toString())\n+\t\t\t\t\t\t|| field.getFieldType().equals(Field.FieldType.FILE.toString())) {\n \n \t\t\t\t\ttry {\n \t\t\t\t\t\tString value = \"\";\n-\t\t\t\t\t\tif(UtilMethods.isSet(APILocator.getContentletAPI().getFieldValue(con, ff))){\n-\t\t\t\t\t\t\tvalue = APILocator.getContentletAPI().getFieldValue(con, ff).toString();\n+\t\t\t\t\t\tif(UtilMethods.isSet(APILocator.getContentletAPI().getFieldValue(contentletToProcess, field))){\n+\t\t\t\t\t\t\tvalue = APILocator.getContentletAPI().getFieldValue(contentletToProcess, field).toString();\n \t\t\t\t\t\t}\n-\t\t\t\t\t\tIdentifier id = APILocator.getIdentifierAPI().find(value);\n+\t\t\t\t\t\tfinal Identifier id = APILocator.getIdentifierAPI().find(value);\n \t\t\t\t\t\tif (InodeUtils.isSet(id.getInode()) && id.getAssetType().equals(\"contentlet\")) {\n \t\t\t\t\t\t\tcontentsWithDependenciesToProcess.addAll(\n \t\t\t\t\t\t\t\t\tAPILocator.getContentletAPI()\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYzNTA0OQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424635049", "bodyText": "rename to relationship and set to final", "author": "jdotcms", "createdAt": "2020-05-13T18:11:10Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -1004,36 +1160,45 @@ private void structureDependencyHelper(String stInode) throws DotDataException,\n \t * @throws DotDataException\n \t * @throws DotSecurityException\n \t */\n-\tprivate void processList(Set<Contentlet> cons) throws DotDataException, DotSecurityException {\n+\tprivate void processList(final Set<Contentlet> cons, final PublisherFilter publisherFilter) throws DotDataException, DotSecurityException {\n \t\tSet<Contentlet> contentsToProcess = new HashSet<Contentlet>();\n \t\tSet<Contentlet> contentsWithDependenciesToProcess = new HashSet<Contentlet>();\n \n-\t\t//Getting all related content\n-\n \t\tfor (Contentlet con : cons) {\n-\t\t\tHost h = APILocator.getHostAPI().find(con.getHost(), user, false);\n-\t\t\thosts.addOrClean( con.getHost(), h.getModDate()); // add the host dependency\n+\t\t\t// Host Dependency\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\tHost h = APILocator.getHostAPI().find(con.getHost(), user, false);\n+\t\t\t\thosts.addOrClean(con.getHost(), h.getModDate());\n+\t\t\t}\n+\n \t\t\tcontentsToProcess.add(con);\n \n-\t\t\tMap<Relationship, List<Contentlet>> contentRel =\n-\t\t\t\t\tAPILocator.getContentletAPI().findContentRelationships(con, user);\n-\n-\t\t\tfor (Relationship rel : contentRel.keySet()) {\n-\t\t\t\tcontentsToProcess.addAll(contentRel.get(rel));\n-\t\t\t\t/**\n-\t\t\t\t * ISSUE #2222: https://github.com/dotCMS/dotCMS/issues/2222\n-\t\t\t\t *\n-\t\t\t\t * We need the relationships in which the single related content is involved.\n-\t\t\t\t *\n-\t\t\t\t */\n-\t\t\t\tif(contentRel.get(rel).size()>0)\n-\t\t\t\t\trelationships.addOrClean( rel.getInode(), rel.getModDate());\n+\t\t\t// Relationships Dependencies\n+\t\t\tif(publisherFilter.isRelationships()) {\n+\t\t\t\tMap<Relationship, List<Contentlet>> contentRel =\n+\t\t\t\t\t\tAPILocator.getContentletAPI().findContentRelationships(con, user);\n+\n+\t\t\t\tfor (Relationship rel : contentRel.keySet()) {", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -1156,63 +1158,63 @@ public class DependencyManager {\n \n \t/**\n \t * \n-\t * @param cons\n+\t * @param contentletSet\n \t * @throws DotDataException\n \t * @throws DotSecurityException\n \t */\n-\tprivate void processList(final Set<Contentlet> cons, final PublisherFilter publisherFilter) throws DotDataException, DotSecurityException {\n-\t\tSet<Contentlet> contentsToProcess = new HashSet<Contentlet>();\n-\t\tSet<Contentlet> contentsWithDependenciesToProcess = new HashSet<Contentlet>();\n+\tprivate void processList(final Set<Contentlet> contentletSet, final PublisherFilter publisherFilter) throws DotDataException, DotSecurityException {\n+\t\tfinal Set<Contentlet> contentsToProcess = new HashSet<Contentlet>();\n+\t\tfinal Set<Contentlet> contentsWithDependenciesToProcess = new HashSet<Contentlet>();\n \n-\t\tfor (Contentlet con : cons) {\n+\t\tfor (final Contentlet contentlet : contentletSet) {\n \t\t\t// Host Dependency\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\tHost h = APILocator.getHostAPI().find(con.getHost(), user, false);\n-\t\t\t\thosts.addOrClean(con.getHost(), h.getModDate());\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(contentlet.getHost(), user, false);\n+\t\t\t\thosts.addOrClean(contentlet.getHost(), host.getModDate());\n \t\t\t}\n \n-\t\t\tcontentsToProcess.add(con);\n+\t\t\tcontentsToProcess.add(contentlet);\n \n \t\t\t// Relationships Dependencies\n \t\t\tif(publisherFilter.isRelationships()) {\n-\t\t\t\tMap<Relationship, List<Contentlet>> contentRel =\n-\t\t\t\t\t\tAPILocator.getContentletAPI().findContentRelationships(con, user);\n+\t\t\t\tfinal Map<Relationship, List<Contentlet>> contentRelationshipsMap =\n+\t\t\t\t\t\tAPILocator.getContentletAPI().findContentRelationships(contentlet, user);\n \n-\t\t\t\tfor (Relationship rel : contentRel.keySet()) {\n-\t\t\t\t\tcontentsToProcess.addAll(contentRel.get(rel));\n+\t\t\t\tfor (final Relationship relationship : contentRelationshipsMap.keySet()) {\n+\t\t\t\t\tcontentsToProcess.addAll(contentRelationshipsMap.get(relationship));\n \t\t\t\t\t/**\n \t\t\t\t\t * ISSUE #2222: https://github.com/dotCMS/dotCMS/issues/2222\n \t\t\t\t\t *\n \t\t\t\t\t * We need the relationships in which the single related content is involved.\n \t\t\t\t\t *\n \t\t\t\t\t */\n-\t\t\t\t\tif (contentRel.get(rel).size() > 0)\n-\t\t\t\t\t\trelationships.addOrClean(rel.getInode(), rel.getModDate());\n+\t\t\t\t\tif (contentRelationshipsMap.get(relationship).size() > 0)\n+\t\t\t\t\t\trelationships.addOrClean(relationship.getInode(), relationship.getModDate());\n \t\t\t\t}\n \t\t\t}\n \t\t}\n \t\t// end relationships false\n \n-\t\tfor (Contentlet con : contentsToProcess) {\n+\t\tfor (final Contentlet contentletToProcess : contentsToProcess) {\n \t\t\t// Host Dependency\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\tHost h = APILocator.getHostAPI().find(con.getHost(), user, false);\n-\t\t\t\thosts.addOrClean(con.getHost(), h.getModDate());\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(contentletToProcess.getHost(), user, false);\n+\t\t\t\thosts.addOrClean(contentletToProcess.getHost(), host.getModDate());\n \t\t\t}\n-\t\t\tcontentsWithDependenciesToProcess.add(con);\n+\t\t\tcontentsWithDependenciesToProcess.add(contentletToProcess);\n \t\t\t//Copy asset files to bundle folder keeping original folders structure\n-\t\t\tList<Field> fields=FieldsCache.getFieldsByStructureInode(con.getStructureInode());\n+\t\t\tfinal List<Field> fields=FieldsCache.getFieldsByStructureInode(contentletToProcess.getStructureInode());\n \n-\t\t\tfor(Field ff : fields) {\n-\t\t\t\tif (ff.getFieldType().equals(Field.FieldType.IMAGE.toString())\n-\t\t\t\t\t\t|| ff.getFieldType().equals(Field.FieldType.FILE.toString())) {\n+\t\t\tfor(final Field field : fields) {\n+\t\t\t\tif (field.getFieldType().equals(Field.FieldType.IMAGE.toString())\n+\t\t\t\t\t\t|| field.getFieldType().equals(Field.FieldType.FILE.toString())) {\n \n \t\t\t\t\ttry {\n \t\t\t\t\t\tString value = \"\";\n-\t\t\t\t\t\tif(UtilMethods.isSet(APILocator.getContentletAPI().getFieldValue(con, ff))){\n-\t\t\t\t\t\t\tvalue = APILocator.getContentletAPI().getFieldValue(con, ff).toString();\n+\t\t\t\t\t\tif(UtilMethods.isSet(APILocator.getContentletAPI().getFieldValue(contentletToProcess, field))){\n+\t\t\t\t\t\t\tvalue = APILocator.getContentletAPI().getFieldValue(contentletToProcess, field).toString();\n \t\t\t\t\t\t}\n-\t\t\t\t\t\tIdentifier id = APILocator.getIdentifierAPI().find(value);\n+\t\t\t\t\t\tfinal Identifier id = APILocator.getIdentifierAPI().find(value);\n \t\t\t\t\t\tif (InodeUtils.isSet(id.getInode()) && id.getAssetType().equals(\"contentlet\")) {\n \t\t\t\t\t\t\tcontentsWithDependenciesToProcess.addAll(\n \t\t\t\t\t\t\t\t\tAPILocator.getContentletAPI()\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYzNTI3OA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424635278", "bodyText": "rename to contenletToProcess and set to final", "author": "jdotcms", "createdAt": "2020-05-13T18:11:34Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -1004,36 +1160,45 @@ private void structureDependencyHelper(String stInode) throws DotDataException,\n \t * @throws DotDataException\n \t * @throws DotSecurityException\n \t */\n-\tprivate void processList(Set<Contentlet> cons) throws DotDataException, DotSecurityException {\n+\tprivate void processList(final Set<Contentlet> cons, final PublisherFilter publisherFilter) throws DotDataException, DotSecurityException {\n \t\tSet<Contentlet> contentsToProcess = new HashSet<Contentlet>();\n \t\tSet<Contentlet> contentsWithDependenciesToProcess = new HashSet<Contentlet>();\n \n-\t\t//Getting all related content\n-\n \t\tfor (Contentlet con : cons) {\n-\t\t\tHost h = APILocator.getHostAPI().find(con.getHost(), user, false);\n-\t\t\thosts.addOrClean( con.getHost(), h.getModDate()); // add the host dependency\n+\t\t\t// Host Dependency\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\tHost h = APILocator.getHostAPI().find(con.getHost(), user, false);\n+\t\t\t\thosts.addOrClean(con.getHost(), h.getModDate());\n+\t\t\t}\n+\n \t\t\tcontentsToProcess.add(con);\n \n-\t\t\tMap<Relationship, List<Contentlet>> contentRel =\n-\t\t\t\t\tAPILocator.getContentletAPI().findContentRelationships(con, user);\n-\n-\t\t\tfor (Relationship rel : contentRel.keySet()) {\n-\t\t\t\tcontentsToProcess.addAll(contentRel.get(rel));\n-\t\t\t\t/**\n-\t\t\t\t * ISSUE #2222: https://github.com/dotCMS/dotCMS/issues/2222\n-\t\t\t\t *\n-\t\t\t\t * We need the relationships in which the single related content is involved.\n-\t\t\t\t *\n-\t\t\t\t */\n-\t\t\t\tif(contentRel.get(rel).size()>0)\n-\t\t\t\t\trelationships.addOrClean( rel.getInode(), rel.getModDate());\n+\t\t\t// Relationships Dependencies\n+\t\t\tif(publisherFilter.isRelationships()) {\n+\t\t\t\tMap<Relationship, List<Contentlet>> contentRel =\n+\t\t\t\t\t\tAPILocator.getContentletAPI().findContentRelationships(con, user);\n+\n+\t\t\t\tfor (Relationship rel : contentRel.keySet()) {\n+\t\t\t\t\tcontentsToProcess.addAll(contentRel.get(rel));\n+\t\t\t\t\t/**\n+\t\t\t\t\t * ISSUE #2222: https://github.com/dotCMS/dotCMS/issues/2222\n+\t\t\t\t\t *\n+\t\t\t\t\t * We need the relationships in which the single related content is involved.\n+\t\t\t\t\t *\n+\t\t\t\t\t */\n+\t\t\t\t\tif (contentRel.get(rel).size() > 0)\n+\t\t\t\t\t\trelationships.addOrClean(rel.getInode(), rel.getModDate());\n+\t\t\t\t}\n \t\t\t}\n \t\t}\n+\t\t// end relationships false\n \n \t\tfor (Contentlet con : contentsToProcess) {", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -1156,63 +1158,63 @@ public class DependencyManager {\n \n \t/**\n \t * \n-\t * @param cons\n+\t * @param contentletSet\n \t * @throws DotDataException\n \t * @throws DotSecurityException\n \t */\n-\tprivate void processList(final Set<Contentlet> cons, final PublisherFilter publisherFilter) throws DotDataException, DotSecurityException {\n-\t\tSet<Contentlet> contentsToProcess = new HashSet<Contentlet>();\n-\t\tSet<Contentlet> contentsWithDependenciesToProcess = new HashSet<Contentlet>();\n+\tprivate void processList(final Set<Contentlet> contentletSet, final PublisherFilter publisherFilter) throws DotDataException, DotSecurityException {\n+\t\tfinal Set<Contentlet> contentsToProcess = new HashSet<Contentlet>();\n+\t\tfinal Set<Contentlet> contentsWithDependenciesToProcess = new HashSet<Contentlet>();\n \n-\t\tfor (Contentlet con : cons) {\n+\t\tfor (final Contentlet contentlet : contentletSet) {\n \t\t\t// Host Dependency\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\tHost h = APILocator.getHostAPI().find(con.getHost(), user, false);\n-\t\t\t\thosts.addOrClean(con.getHost(), h.getModDate());\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(contentlet.getHost(), user, false);\n+\t\t\t\thosts.addOrClean(contentlet.getHost(), host.getModDate());\n \t\t\t}\n \n-\t\t\tcontentsToProcess.add(con);\n+\t\t\tcontentsToProcess.add(contentlet);\n \n \t\t\t// Relationships Dependencies\n \t\t\tif(publisherFilter.isRelationships()) {\n-\t\t\t\tMap<Relationship, List<Contentlet>> contentRel =\n-\t\t\t\t\t\tAPILocator.getContentletAPI().findContentRelationships(con, user);\n+\t\t\t\tfinal Map<Relationship, List<Contentlet>> contentRelationshipsMap =\n+\t\t\t\t\t\tAPILocator.getContentletAPI().findContentRelationships(contentlet, user);\n \n-\t\t\t\tfor (Relationship rel : contentRel.keySet()) {\n-\t\t\t\t\tcontentsToProcess.addAll(contentRel.get(rel));\n+\t\t\t\tfor (final Relationship relationship : contentRelationshipsMap.keySet()) {\n+\t\t\t\t\tcontentsToProcess.addAll(contentRelationshipsMap.get(relationship));\n \t\t\t\t\t/**\n \t\t\t\t\t * ISSUE #2222: https://github.com/dotCMS/dotCMS/issues/2222\n \t\t\t\t\t *\n \t\t\t\t\t * We need the relationships in which the single related content is involved.\n \t\t\t\t\t *\n \t\t\t\t\t */\n-\t\t\t\t\tif (contentRel.get(rel).size() > 0)\n-\t\t\t\t\t\trelationships.addOrClean(rel.getInode(), rel.getModDate());\n+\t\t\t\t\tif (contentRelationshipsMap.get(relationship).size() > 0)\n+\t\t\t\t\t\trelationships.addOrClean(relationship.getInode(), relationship.getModDate());\n \t\t\t\t}\n \t\t\t}\n \t\t}\n \t\t// end relationships false\n \n-\t\tfor (Contentlet con : contentsToProcess) {\n+\t\tfor (final Contentlet contentletToProcess : contentsToProcess) {\n \t\t\t// Host Dependency\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\tHost h = APILocator.getHostAPI().find(con.getHost(), user, false);\n-\t\t\t\thosts.addOrClean(con.getHost(), h.getModDate());\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(contentletToProcess.getHost(), user, false);\n+\t\t\t\thosts.addOrClean(contentletToProcess.getHost(), host.getModDate());\n \t\t\t}\n-\t\t\tcontentsWithDependenciesToProcess.add(con);\n+\t\t\tcontentsWithDependenciesToProcess.add(contentletToProcess);\n \t\t\t//Copy asset files to bundle folder keeping original folders structure\n-\t\t\tList<Field> fields=FieldsCache.getFieldsByStructureInode(con.getStructureInode());\n+\t\t\tfinal List<Field> fields=FieldsCache.getFieldsByStructureInode(contentletToProcess.getStructureInode());\n \n-\t\t\tfor(Field ff : fields) {\n-\t\t\t\tif (ff.getFieldType().equals(Field.FieldType.IMAGE.toString())\n-\t\t\t\t\t\t|| ff.getFieldType().equals(Field.FieldType.FILE.toString())) {\n+\t\t\tfor(final Field field : fields) {\n+\t\t\t\tif (field.getFieldType().equals(Field.FieldType.IMAGE.toString())\n+\t\t\t\t\t\t|| field.getFieldType().equals(Field.FieldType.FILE.toString())) {\n \n \t\t\t\t\ttry {\n \t\t\t\t\t\tString value = \"\";\n-\t\t\t\t\t\tif(UtilMethods.isSet(APILocator.getContentletAPI().getFieldValue(con, ff))){\n-\t\t\t\t\t\t\tvalue = APILocator.getContentletAPI().getFieldValue(con, ff).toString();\n+\t\t\t\t\t\tif(UtilMethods.isSet(APILocator.getContentletAPI().getFieldValue(contentletToProcess, field))){\n+\t\t\t\t\t\t\tvalue = APILocator.getContentletAPI().getFieldValue(contentletToProcess, field).toString();\n \t\t\t\t\t\t}\n-\t\t\t\t\t\tIdentifier id = APILocator.getIdentifierAPI().find(value);\n+\t\t\t\t\t\tfinal Identifier id = APILocator.getIdentifierAPI().find(value);\n \t\t\t\t\t\tif (InodeUtils.isSet(id.getInode()) && id.getAssetType().equals(\"contentlet\")) {\n \t\t\t\t\t\t\tcontentsWithDependenciesToProcess.addAll(\n \t\t\t\t\t\t\t\t\tAPILocator.getContentletAPI()\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYzNTQ0Ng==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424635446", "bodyText": "rename to host and set to final", "author": "jdotcms", "createdAt": "2020-05-13T18:11:52Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -1004,36 +1160,45 @@ private void structureDependencyHelper(String stInode) throws DotDataException,\n \t * @throws DotDataException\n \t * @throws DotSecurityException\n \t */\n-\tprivate void processList(Set<Contentlet> cons) throws DotDataException, DotSecurityException {\n+\tprivate void processList(final Set<Contentlet> cons, final PublisherFilter publisherFilter) throws DotDataException, DotSecurityException {\n \t\tSet<Contentlet> contentsToProcess = new HashSet<Contentlet>();\n \t\tSet<Contentlet> contentsWithDependenciesToProcess = new HashSet<Contentlet>();\n \n-\t\t//Getting all related content\n-\n \t\tfor (Contentlet con : cons) {\n-\t\t\tHost h = APILocator.getHostAPI().find(con.getHost(), user, false);\n-\t\t\thosts.addOrClean( con.getHost(), h.getModDate()); // add the host dependency\n+\t\t\t// Host Dependency\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\tHost h = APILocator.getHostAPI().find(con.getHost(), user, false);\n+\t\t\t\thosts.addOrClean(con.getHost(), h.getModDate());\n+\t\t\t}\n+\n \t\t\tcontentsToProcess.add(con);\n \n-\t\t\tMap<Relationship, List<Contentlet>> contentRel =\n-\t\t\t\t\tAPILocator.getContentletAPI().findContentRelationships(con, user);\n-\n-\t\t\tfor (Relationship rel : contentRel.keySet()) {\n-\t\t\t\tcontentsToProcess.addAll(contentRel.get(rel));\n-\t\t\t\t/**\n-\t\t\t\t * ISSUE #2222: https://github.com/dotCMS/dotCMS/issues/2222\n-\t\t\t\t *\n-\t\t\t\t * We need the relationships in which the single related content is involved.\n-\t\t\t\t *\n-\t\t\t\t */\n-\t\t\t\tif(contentRel.get(rel).size()>0)\n-\t\t\t\t\trelationships.addOrClean( rel.getInode(), rel.getModDate());\n+\t\t\t// Relationships Dependencies\n+\t\t\tif(publisherFilter.isRelationships()) {\n+\t\t\t\tMap<Relationship, List<Contentlet>> contentRel =\n+\t\t\t\t\t\tAPILocator.getContentletAPI().findContentRelationships(con, user);\n+\n+\t\t\t\tfor (Relationship rel : contentRel.keySet()) {\n+\t\t\t\t\tcontentsToProcess.addAll(contentRel.get(rel));\n+\t\t\t\t\t/**\n+\t\t\t\t\t * ISSUE #2222: https://github.com/dotCMS/dotCMS/issues/2222\n+\t\t\t\t\t *\n+\t\t\t\t\t * We need the relationships in which the single related content is involved.\n+\t\t\t\t\t *\n+\t\t\t\t\t */\n+\t\t\t\t\tif (contentRel.get(rel).size() > 0)\n+\t\t\t\t\t\trelationships.addOrClean(rel.getInode(), rel.getModDate());\n+\t\t\t\t}\n \t\t\t}\n \t\t}\n+\t\t// end relationships false\n \n \t\tfor (Contentlet con : contentsToProcess) {\n-\t\t\tHost h = APILocator.getHostAPI().find(con.getHost(), user, false);\n-\t\t\thosts.addOrClean( con.getHost(), h.getModDate()); // add the host dependency\n+\t\t\t// Host Dependency\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\tHost h = APILocator.getHostAPI().find(con.getHost(), user, false);", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -1156,63 +1158,63 @@ public class DependencyManager {\n \n \t/**\n \t * \n-\t * @param cons\n+\t * @param contentletSet\n \t * @throws DotDataException\n \t * @throws DotSecurityException\n \t */\n-\tprivate void processList(final Set<Contentlet> cons, final PublisherFilter publisherFilter) throws DotDataException, DotSecurityException {\n-\t\tSet<Contentlet> contentsToProcess = new HashSet<Contentlet>();\n-\t\tSet<Contentlet> contentsWithDependenciesToProcess = new HashSet<Contentlet>();\n+\tprivate void processList(final Set<Contentlet> contentletSet, final PublisherFilter publisherFilter) throws DotDataException, DotSecurityException {\n+\t\tfinal Set<Contentlet> contentsToProcess = new HashSet<Contentlet>();\n+\t\tfinal Set<Contentlet> contentsWithDependenciesToProcess = new HashSet<Contentlet>();\n \n-\t\tfor (Contentlet con : cons) {\n+\t\tfor (final Contentlet contentlet : contentletSet) {\n \t\t\t// Host Dependency\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\tHost h = APILocator.getHostAPI().find(con.getHost(), user, false);\n-\t\t\t\thosts.addOrClean(con.getHost(), h.getModDate());\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(contentlet.getHost(), user, false);\n+\t\t\t\thosts.addOrClean(contentlet.getHost(), host.getModDate());\n \t\t\t}\n \n-\t\t\tcontentsToProcess.add(con);\n+\t\t\tcontentsToProcess.add(contentlet);\n \n \t\t\t// Relationships Dependencies\n \t\t\tif(publisherFilter.isRelationships()) {\n-\t\t\t\tMap<Relationship, List<Contentlet>> contentRel =\n-\t\t\t\t\t\tAPILocator.getContentletAPI().findContentRelationships(con, user);\n+\t\t\t\tfinal Map<Relationship, List<Contentlet>> contentRelationshipsMap =\n+\t\t\t\t\t\tAPILocator.getContentletAPI().findContentRelationships(contentlet, user);\n \n-\t\t\t\tfor (Relationship rel : contentRel.keySet()) {\n-\t\t\t\t\tcontentsToProcess.addAll(contentRel.get(rel));\n+\t\t\t\tfor (final Relationship relationship : contentRelationshipsMap.keySet()) {\n+\t\t\t\t\tcontentsToProcess.addAll(contentRelationshipsMap.get(relationship));\n \t\t\t\t\t/**\n \t\t\t\t\t * ISSUE #2222: https://github.com/dotCMS/dotCMS/issues/2222\n \t\t\t\t\t *\n \t\t\t\t\t * We need the relationships in which the single related content is involved.\n \t\t\t\t\t *\n \t\t\t\t\t */\n-\t\t\t\t\tif (contentRel.get(rel).size() > 0)\n-\t\t\t\t\t\trelationships.addOrClean(rel.getInode(), rel.getModDate());\n+\t\t\t\t\tif (contentRelationshipsMap.get(relationship).size() > 0)\n+\t\t\t\t\t\trelationships.addOrClean(relationship.getInode(), relationship.getModDate());\n \t\t\t\t}\n \t\t\t}\n \t\t}\n \t\t// end relationships false\n \n-\t\tfor (Contentlet con : contentsToProcess) {\n+\t\tfor (final Contentlet contentletToProcess : contentsToProcess) {\n \t\t\t// Host Dependency\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\tHost h = APILocator.getHostAPI().find(con.getHost(), user, false);\n-\t\t\t\thosts.addOrClean(con.getHost(), h.getModDate());\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(contentletToProcess.getHost(), user, false);\n+\t\t\t\thosts.addOrClean(contentletToProcess.getHost(), host.getModDate());\n \t\t\t}\n-\t\t\tcontentsWithDependenciesToProcess.add(con);\n+\t\t\tcontentsWithDependenciesToProcess.add(contentletToProcess);\n \t\t\t//Copy asset files to bundle folder keeping original folders structure\n-\t\t\tList<Field> fields=FieldsCache.getFieldsByStructureInode(con.getStructureInode());\n+\t\t\tfinal List<Field> fields=FieldsCache.getFieldsByStructureInode(contentletToProcess.getStructureInode());\n \n-\t\t\tfor(Field ff : fields) {\n-\t\t\t\tif (ff.getFieldType().equals(Field.FieldType.IMAGE.toString())\n-\t\t\t\t\t\t|| ff.getFieldType().equals(Field.FieldType.FILE.toString())) {\n+\t\t\tfor(final Field field : fields) {\n+\t\t\t\tif (field.getFieldType().equals(Field.FieldType.IMAGE.toString())\n+\t\t\t\t\t\t|| field.getFieldType().equals(Field.FieldType.FILE.toString())) {\n \n \t\t\t\t\ttry {\n \t\t\t\t\t\tString value = \"\";\n-\t\t\t\t\t\tif(UtilMethods.isSet(APILocator.getContentletAPI().getFieldValue(con, ff))){\n-\t\t\t\t\t\t\tvalue = APILocator.getContentletAPI().getFieldValue(con, ff).toString();\n+\t\t\t\t\t\tif(UtilMethods.isSet(APILocator.getContentletAPI().getFieldValue(contentletToProcess, field))){\n+\t\t\t\t\t\t\tvalue = APILocator.getContentletAPI().getFieldValue(contentletToProcess, field).toString();\n \t\t\t\t\t\t}\n-\t\t\t\t\t\tIdentifier id = APILocator.getIdentifierAPI().find(value);\n+\t\t\t\t\t\tfinal Identifier id = APILocator.getIdentifierAPI().find(value);\n \t\t\t\t\t\tif (InodeUtils.isSet(id.getInode()) && id.getAssetType().equals(\"contentlet\")) {\n \t\t\t\t\t\t\tcontentsWithDependenciesToProcess.addAll(\n \t\t\t\t\t\t\t\t\tAPILocator.getContentletAPI()\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYzNTY0OQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424635649", "bodyText": "rename to host and set to final", "author": "jdotcms", "createdAt": "2020-05-13T18:12:13Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -1064,13 +1229,26 @@ private void processList(Set<Contentlet> cons) throws DotDataException, DotSecur\n \n \t\t// Adding the Contents (including related) and adding filesAsContent\n \t\tfor (Contentlet con : contentsWithDependenciesToProcess) {\n-\t\t\tHost h = APILocator.getHostAPI().find(con.getHost(), user, false);\n-\t\t\thosts.addOrClean( con.getHost(), h.getModDate()); // add the host dependency\n-\t\t\tcontents.addOrClean( con.getIdentifier(), con.getModDate()); // adding the content (including related)\n-\t\t\tFolder f = APILocator.getFolderAPI().find(con.getFolder(), user, false);\n-\t\t\tfolders.addOrClean( con.getFolder(), f.getModDate()); // adding content folder\n-\n-\t\t\tlanguages.addOrClean(Long.toString(con.getLanguageId()), new Date()); // will be included only when hasn't been sent ever\n+\t\t\t// Host Dependency\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\tHost h = APILocator.getHostAPI().find(con.getHost(), user, false);", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -1228,39 +1230,39 @@ public class DependencyManager {\n \t\t}\n \n \t\t// Adding the Contents (including related) and adding filesAsContent\n-\t\tfor (Contentlet con : contentsWithDependenciesToProcess) {\n+\t\tfor (final Contentlet contentletWithDependenciesToProcess : contentsWithDependenciesToProcess) {\n \t\t\t// Host Dependency\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\tHost h = APILocator.getHostAPI().find(con.getHost(), user, false);\n-\t\t\t\thosts.addOrClean(con.getHost(), h.getModDate());\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(contentletWithDependenciesToProcess.getHost(), user, false);\n+\t\t\t\thosts.addOrClean(contentletWithDependenciesToProcess.getHost(), host.getModDate());\n \t\t\t}\n \t\t\t// Content Dependency\n-\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType()) && publisherFilter.acceptExcludeDependencyQuery(con.getIdentifier())) {\n-\t\t\t\tcontents.addOrClean(con.getIdentifier(),\n-\t\t\t\t\t\tcon.getModDate());\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType()) && publisherFilter.acceptExcludeDependencyQuery(contentletWithDependenciesToProcess.getIdentifier())) {\n+\t\t\t\tcontents.addOrClean(contentletWithDependenciesToProcess.getIdentifier(),\n+\t\t\t\t\t\tcontentletWithDependenciesToProcess.getModDate());\n \t\t\t}\n \t\t\t// Folder Dependency\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n-\t\t\t\tFolder f = APILocator.getFolderAPI().find(con.getFolder(), user, false);\n-\t\t\t\tfolders.addOrClean(con.getFolder(), f.getModDate()); // adding content folder\n+\t\t\t\tfinal Folder folder = APILocator.getFolderAPI().find(contentletWithDependenciesToProcess.getFolder(), user, false);\n+\t\t\t\tfolders.addOrClean(contentletWithDependenciesToProcess.getFolder(), folder.getModDate()); // adding content folder\n \t\t\t}\n \t\t\t// Language Dependency\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.LANGUAGE.getType())) {\n-\t\t\t\tlanguages.addOrClean(Long.toString(con.getLanguageId()),\n+\t\t\t\tlanguages.addOrClean(Long.toString(contentletWithDependenciesToProcess.getLanguageId()),\n \t\t\t\t\t\tnew Date()); // will be included only when hasn't been sent ever\n \t\t\t}\n \n \t\t\ttry {\n \t\t\t\tif (Config.getBooleanProperty(\"PUSH_PUBLISHING_PUSH_ALL_FOLDER_PAGES\", false)\n-\t\t\t\t\t\t&& con.getStructure().getStructureType() == Structure.STRUCTURE_TYPE_HTMLPAGE) {\n+\t\t\t\t\t\t&& contentletWithDependenciesToProcess.getStructure().getStructureType() == Structure.STRUCTURE_TYPE_HTMLPAGE) {\n \n-\t\t\t\t\tFolder contFolder=APILocator.getFolderAPI().find(con.getFolder(), user, false);\n-\t\t\t\t\tList<IHTMLPage> folderHtmlPages = new ArrayList<IHTMLPage>(); \n+\t\t\t\t\tfinal Folder contFolder=APILocator.getFolderAPI().find(contentletWithDependenciesToProcess.getFolder(), user, false);\n+\t\t\t\t\tfinal List<IHTMLPage> folderHtmlPages = new ArrayList<IHTMLPage>();\n \t\t\t\t\tfolderHtmlPages.addAll(APILocator.getHTMLPageAssetAPI().getHTMLPages(contFolder, false, false, user, false));\n \t\t\t\t\tfolderHtmlPages.addAll(APILocator.getHTMLPageAssetAPI().getHTMLPages(contFolder, true, false, user, false));\n \n-\t\t\t\t\tSet<String> pagesToProcess = new HashSet<>();\n-\t\t\t\t\tfor (IHTMLPage htmlPage : folderHtmlPages) {\n+\t\t\t\t\tfinal Set<String> pagesToProcess = new HashSet<>();\n+\t\t\t\t\tfor (final IHTMLPage htmlPage : folderHtmlPages) {\n \n \t\t\t\t\t\tBoolean mustBeIncluded;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYzNTg4NQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424635885", "bodyText": "rename to folder and set to final", "author": "jdotcms", "createdAt": "2020-05-13T18:12:36Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -1064,13 +1229,26 @@ private void processList(Set<Contentlet> cons) throws DotDataException, DotSecur\n \n \t\t// Adding the Contents (including related) and adding filesAsContent\n \t\tfor (Contentlet con : contentsWithDependenciesToProcess) {\n-\t\t\tHost h = APILocator.getHostAPI().find(con.getHost(), user, false);\n-\t\t\thosts.addOrClean( con.getHost(), h.getModDate()); // add the host dependency\n-\t\t\tcontents.addOrClean( con.getIdentifier(), con.getModDate()); // adding the content (including related)\n-\t\t\tFolder f = APILocator.getFolderAPI().find(con.getFolder(), user, false);\n-\t\t\tfolders.addOrClean( con.getFolder(), f.getModDate()); // adding content folder\n-\n-\t\t\tlanguages.addOrClean(Long.toString(con.getLanguageId()), new Date()); // will be included only when hasn't been sent ever\n+\t\t\t// Host Dependency\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\tHost h = APILocator.getHostAPI().find(con.getHost(), user, false);\n+\t\t\t\thosts.addOrClean(con.getHost(), h.getModDate());\n+\t\t\t}\n+\t\t\t// Content Dependency\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType()) && publisherFilter.acceptExcludeDependencyQuery(con.getIdentifier())) {\n+\t\t\t\tcontents.addOrClean(con.getIdentifier(),\n+\t\t\t\t\t\tcon.getModDate());\n+\t\t\t}\n+\t\t\t// Folder Dependency\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n+\t\t\t\tFolder f = APILocator.getFolderAPI().find(con.getFolder(), user, false);", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -1228,39 +1230,39 @@ public class DependencyManager {\n \t\t}\n \n \t\t// Adding the Contents (including related) and adding filesAsContent\n-\t\tfor (Contentlet con : contentsWithDependenciesToProcess) {\n+\t\tfor (final Contentlet contentletWithDependenciesToProcess : contentsWithDependenciesToProcess) {\n \t\t\t// Host Dependency\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\tHost h = APILocator.getHostAPI().find(con.getHost(), user, false);\n-\t\t\t\thosts.addOrClean(con.getHost(), h.getModDate());\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(contentletWithDependenciesToProcess.getHost(), user, false);\n+\t\t\t\thosts.addOrClean(contentletWithDependenciesToProcess.getHost(), host.getModDate());\n \t\t\t}\n \t\t\t// Content Dependency\n-\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType()) && publisherFilter.acceptExcludeDependencyQuery(con.getIdentifier())) {\n-\t\t\t\tcontents.addOrClean(con.getIdentifier(),\n-\t\t\t\t\t\tcon.getModDate());\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType()) && publisherFilter.acceptExcludeDependencyQuery(contentletWithDependenciesToProcess.getIdentifier())) {\n+\t\t\t\tcontents.addOrClean(contentletWithDependenciesToProcess.getIdentifier(),\n+\t\t\t\t\t\tcontentletWithDependenciesToProcess.getModDate());\n \t\t\t}\n \t\t\t// Folder Dependency\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n-\t\t\t\tFolder f = APILocator.getFolderAPI().find(con.getFolder(), user, false);\n-\t\t\t\tfolders.addOrClean(con.getFolder(), f.getModDate()); // adding content folder\n+\t\t\t\tfinal Folder folder = APILocator.getFolderAPI().find(contentletWithDependenciesToProcess.getFolder(), user, false);\n+\t\t\t\tfolders.addOrClean(contentletWithDependenciesToProcess.getFolder(), folder.getModDate()); // adding content folder\n \t\t\t}\n \t\t\t// Language Dependency\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.LANGUAGE.getType())) {\n-\t\t\t\tlanguages.addOrClean(Long.toString(con.getLanguageId()),\n+\t\t\t\tlanguages.addOrClean(Long.toString(contentletWithDependenciesToProcess.getLanguageId()),\n \t\t\t\t\t\tnew Date()); // will be included only when hasn't been sent ever\n \t\t\t}\n \n \t\t\ttry {\n \t\t\t\tif (Config.getBooleanProperty(\"PUSH_PUBLISHING_PUSH_ALL_FOLDER_PAGES\", false)\n-\t\t\t\t\t\t&& con.getStructure().getStructureType() == Structure.STRUCTURE_TYPE_HTMLPAGE) {\n+\t\t\t\t\t\t&& contentletWithDependenciesToProcess.getStructure().getStructureType() == Structure.STRUCTURE_TYPE_HTMLPAGE) {\n \n-\t\t\t\t\tFolder contFolder=APILocator.getFolderAPI().find(con.getFolder(), user, false);\n-\t\t\t\t\tList<IHTMLPage> folderHtmlPages = new ArrayList<IHTMLPage>(); \n+\t\t\t\t\tfinal Folder contFolder=APILocator.getFolderAPI().find(contentletWithDependenciesToProcess.getFolder(), user, false);\n+\t\t\t\t\tfinal List<IHTMLPage> folderHtmlPages = new ArrayList<IHTMLPage>();\n \t\t\t\t\tfolderHtmlPages.addAll(APILocator.getHTMLPageAssetAPI().getHTMLPages(contFolder, false, false, user, false));\n \t\t\t\t\tfolderHtmlPages.addAll(APILocator.getHTMLPageAssetAPI().getHTMLPages(contFolder, true, false, user, false));\n \n-\t\t\t\t\tSet<String> pagesToProcess = new HashSet<>();\n-\t\t\t\t\tfor (IHTMLPage htmlPage : folderHtmlPages) {\n+\t\t\t\t\tfinal Set<String> pagesToProcess = new HashSet<>();\n+\t\t\t\t\tfor (final IHTMLPage htmlPage : folderHtmlPages) {\n \n \t\t\t\t\t\tBoolean mustBeIncluded;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYzNjE5Ng==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424636196", "bodyText": "set to final", "author": "jdotcms", "createdAt": "2020-05-13T18:13:05Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -1095,40 +1273,47 @@ private void processList(Set<Contentlet> cons) throws DotDataException, DotSecur\n \n \t\t\t\t\t}\n \t\t\t\t\t//Process the pages we found\n-\t\t\t\t\tsetHTMLPagesDependencies(pagesToProcess);\n+\t\t\t\t\tsetHTMLPagesDependencies(pagesToProcess,publisherFilter);\n \t\t\t\t}\n \t\t\t} catch (Exception e) {\n \t\t\t\tLogger.debug(this, e.toString());\n \t\t\t}\n \n-\t\t\tif(Config.getBooleanProperty(\"PUSH_PUBLISHING_PUSH_STRUCTURES\", true)) {\n+\t\t\tif(Config.getBooleanProperty(\"PUSH_PUBLISHING_PUSH_STRUCTURES\", true) && publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENT_TYPE.getType())) {\n \t\t\t\tStructure struct = CacheLocator.getContentTypeCache().getStructureByInode(con.getStructureInode());\n-\t\t\t\tstructures.addOrClean( con.getStructureInode(), struct.getModDate());\n-\t\t\t\tstructureDependencyHelper(con.getStructureInode());\n+\t\t\t\tcontentTypes.addOrClean( con.getStructureInode(), struct.getModDate());\n+\t\t\t\tstructureDependencyHelper(con.getStructureInode(),publisherFilter);\n \t\t\t}\n \n \t\t\t// Evaluate all the categories from this contentlet to include as dependency.\n-            final List<Category> categoriesFromContentlet = APILocator.getCategoryAPI()\n-                    .getParents(con, APILocator.systemUser(), false);\n-            for (Category category : categoriesFromContentlet) {\n-                categories.addOrClean(category.getCategoryId(), category.getModDate());\n-            }\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CATEGORY.getType())) {\n+\t\t\t\tfinal List<Category> categoriesFromContentlet = APILocator.getCategoryAPI()\n+\t\t\t\t\t\t.getParents(con, APILocator.systemUser(), false);\n+\t\t\t\tfor (Category category : categoriesFromContentlet) {", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -1280,35 +1282,35 @@ public class DependencyManager {\n \t\t\t}\n \n \t\t\tif(Config.getBooleanProperty(\"PUSH_PUBLISHING_PUSH_STRUCTURES\", true) && publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENT_TYPE.getType())) {\n-\t\t\t\tStructure struct = CacheLocator.getContentTypeCache().getStructureByInode(con.getStructureInode());\n-\t\t\t\tcontentTypes.addOrClean( con.getStructureInode(), struct.getModDate());\n-\t\t\t\tstructureDependencyHelper(con.getStructureInode(),publisherFilter);\n+\t\t\t\tfinal Structure structure = CacheLocator.getContentTypeCache().getStructureByInode(contentletWithDependenciesToProcess.getStructureInode());\n+\t\t\t\tcontentTypes.addOrClean( contentletWithDependenciesToProcess.getStructureInode(), structure.getModDate());\n+\t\t\t\tstructureDependencyHelper(contentletWithDependenciesToProcess.getStructureInode(),publisherFilter);\n \t\t\t}\n \n \t\t\t// Evaluate all the categories from this contentlet to include as dependency.\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CATEGORY.getType())) {\n \t\t\t\tfinal List<Category> categoriesFromContentlet = APILocator.getCategoryAPI()\n-\t\t\t\t\t\t.getParents(con, APILocator.systemUser(), false);\n-\t\t\t\tfor (Category category : categoriesFromContentlet) {\n+\t\t\t\t\t\t.getParents(contentletWithDependenciesToProcess, APILocator.systemUser(), false);\n+\t\t\t\tfor (final Category category : categoriesFromContentlet) {\n \t\t\t\t\tcategories.addOrClean(category.getCategoryId(), category.getModDate());\n \t\t\t\t}\n \t\t\t}\n         }\n \t\t\n \t\t//This is for adding the new language variables (as content)\n-        for (String lang : languages) {\n-            String keyValueQuery = \"+contentType:\" + LanguageVariableAPI.LANGUAGEVARIABLE + \" +languageId:\" + lang;\n-            List<Contentlet> listKeyValueLang = APILocator.getContentletAPI()\n+        for (final String lang : languages) {\n+            final String keyValueQuery = \"+contentType:\" + LanguageVariableAPI.LANGUAGEVARIABLE + \" +languageId:\" + lang;\n+            final List<Contentlet> listKeyValueLang = APILocator.getContentletAPI()\n                             .search(keyValueQuery,0, -1, StringPool.BLANK, user, false);// search for language variables\n \t\t\t// if there is any language variable and we accept to push content type, add the content type\n             if (!listKeyValueLang.isEmpty() && publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENT_TYPE.getType())) {\n-                Structure struct = CacheLocator.getContentTypeCache()\n+                final Structure structure = CacheLocator.getContentTypeCache()\n                                 .getStructureByInode(listKeyValueLang.get(0).getContentTypeId());\n-                contentTypes.addOrClean(struct.getIdentifier(), struct.getModDate());\n-                structureDependencyHelper(struct.getIdentifier(),publisherFilter);\n+                contentTypes.addOrClean(structure.getIdentifier(), structure.getModDate());\n+                structureDependencyHelper(structure.getIdentifier(),publisherFilter);\n             }\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType())) {\n-\t\t\t\tfor (Contentlet keyValue : listKeyValueLang) {// add the language variable\n+\t\t\t\tfor (final Contentlet keyValue : listKeyValueLang) {// add the language variable\n \t\t\t\t\tif(publisherFilter.acceptExcludeDependencyQuery(keyValue.getIdentifier())) {\n \t\t\t\t\t\tcontents.addOrClean(keyValue.getIdentifier(), keyValue.getModDate());\n \t\t\t\t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYzNjM0Nw==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424636347", "bodyText": "set to final and rename to language", "author": "jdotcms", "createdAt": "2020-05-13T18:13:20Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -1095,40 +1273,47 @@ private void processList(Set<Contentlet> cons) throws DotDataException, DotSecur\n \n \t\t\t\t\t}\n \t\t\t\t\t//Process the pages we found\n-\t\t\t\t\tsetHTMLPagesDependencies(pagesToProcess);\n+\t\t\t\t\tsetHTMLPagesDependencies(pagesToProcess,publisherFilter);\n \t\t\t\t}\n \t\t\t} catch (Exception e) {\n \t\t\t\tLogger.debug(this, e.toString());\n \t\t\t}\n \n-\t\t\tif(Config.getBooleanProperty(\"PUSH_PUBLISHING_PUSH_STRUCTURES\", true)) {\n+\t\t\tif(Config.getBooleanProperty(\"PUSH_PUBLISHING_PUSH_STRUCTURES\", true) && publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENT_TYPE.getType())) {\n \t\t\t\tStructure struct = CacheLocator.getContentTypeCache().getStructureByInode(con.getStructureInode());\n-\t\t\t\tstructures.addOrClean( con.getStructureInode(), struct.getModDate());\n-\t\t\t\tstructureDependencyHelper(con.getStructureInode());\n+\t\t\t\tcontentTypes.addOrClean( con.getStructureInode(), struct.getModDate());\n+\t\t\t\tstructureDependencyHelper(con.getStructureInode(),publisherFilter);\n \t\t\t}\n \n \t\t\t// Evaluate all the categories from this contentlet to include as dependency.\n-            final List<Category> categoriesFromContentlet = APILocator.getCategoryAPI()\n-                    .getParents(con, APILocator.systemUser(), false);\n-            for (Category category : categoriesFromContentlet) {\n-                categories.addOrClean(category.getCategoryId(), category.getModDate());\n-            }\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CATEGORY.getType())) {\n+\t\t\t\tfinal List<Category> categoriesFromContentlet = APILocator.getCategoryAPI()\n+\t\t\t\t\t\t.getParents(con, APILocator.systemUser(), false);\n+\t\t\t\tfor (Category category : categoriesFromContentlet) {\n+\t\t\t\t\tcategories.addOrClean(category.getCategoryId(), category.getModDate());\n+\t\t\t\t}\n+\t\t\t}\n         }\n \t\t\n \t\t//This is for adding the new language variables (as content)\n         for (String lang : languages) {", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -1280,35 +1282,35 @@ public class DependencyManager {\n \t\t\t}\n \n \t\t\tif(Config.getBooleanProperty(\"PUSH_PUBLISHING_PUSH_STRUCTURES\", true) && publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENT_TYPE.getType())) {\n-\t\t\t\tStructure struct = CacheLocator.getContentTypeCache().getStructureByInode(con.getStructureInode());\n-\t\t\t\tcontentTypes.addOrClean( con.getStructureInode(), struct.getModDate());\n-\t\t\t\tstructureDependencyHelper(con.getStructureInode(),publisherFilter);\n+\t\t\t\tfinal Structure structure = CacheLocator.getContentTypeCache().getStructureByInode(contentletWithDependenciesToProcess.getStructureInode());\n+\t\t\t\tcontentTypes.addOrClean( contentletWithDependenciesToProcess.getStructureInode(), structure.getModDate());\n+\t\t\t\tstructureDependencyHelper(contentletWithDependenciesToProcess.getStructureInode(),publisherFilter);\n \t\t\t}\n \n \t\t\t// Evaluate all the categories from this contentlet to include as dependency.\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CATEGORY.getType())) {\n \t\t\t\tfinal List<Category> categoriesFromContentlet = APILocator.getCategoryAPI()\n-\t\t\t\t\t\t.getParents(con, APILocator.systemUser(), false);\n-\t\t\t\tfor (Category category : categoriesFromContentlet) {\n+\t\t\t\t\t\t.getParents(contentletWithDependenciesToProcess, APILocator.systemUser(), false);\n+\t\t\t\tfor (final Category category : categoriesFromContentlet) {\n \t\t\t\t\tcategories.addOrClean(category.getCategoryId(), category.getModDate());\n \t\t\t\t}\n \t\t\t}\n         }\n \t\t\n \t\t//This is for adding the new language variables (as content)\n-        for (String lang : languages) {\n-            String keyValueQuery = \"+contentType:\" + LanguageVariableAPI.LANGUAGEVARIABLE + \" +languageId:\" + lang;\n-            List<Contentlet> listKeyValueLang = APILocator.getContentletAPI()\n+        for (final String lang : languages) {\n+            final String keyValueQuery = \"+contentType:\" + LanguageVariableAPI.LANGUAGEVARIABLE + \" +languageId:\" + lang;\n+            final List<Contentlet> listKeyValueLang = APILocator.getContentletAPI()\n                             .search(keyValueQuery,0, -1, StringPool.BLANK, user, false);// search for language variables\n \t\t\t// if there is any language variable and we accept to push content type, add the content type\n             if (!listKeyValueLang.isEmpty() && publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENT_TYPE.getType())) {\n-                Structure struct = CacheLocator.getContentTypeCache()\n+                final Structure structure = CacheLocator.getContentTypeCache()\n                                 .getStructureByInode(listKeyValueLang.get(0).getContentTypeId());\n-                contentTypes.addOrClean(struct.getIdentifier(), struct.getModDate());\n-                structureDependencyHelper(struct.getIdentifier(),publisherFilter);\n+                contentTypes.addOrClean(structure.getIdentifier(), structure.getModDate());\n+                structureDependencyHelper(structure.getIdentifier(),publisherFilter);\n             }\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType())) {\n-\t\t\t\tfor (Contentlet keyValue : listKeyValueLang) {// add the language variable\n+\t\t\t\tfor (final Contentlet keyValue : listKeyValueLang) {// add the language variable\n \t\t\t\t\tif(publisherFilter.acceptExcludeDependencyQuery(keyValue.getIdentifier())) {\n \t\t\t\t\t\tcontents.addOrClean(keyValue.getIdentifier(), keyValue.getModDate());\n \t\t\t\t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYzNjQwNw==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424636407", "bodyText": "set to final", "author": "jdotcms", "createdAt": "2020-05-13T18:13:28Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -1095,40 +1273,47 @@ private void processList(Set<Contentlet> cons) throws DotDataException, DotSecur\n \n \t\t\t\t\t}\n \t\t\t\t\t//Process the pages we found\n-\t\t\t\t\tsetHTMLPagesDependencies(pagesToProcess);\n+\t\t\t\t\tsetHTMLPagesDependencies(pagesToProcess,publisherFilter);\n \t\t\t\t}\n \t\t\t} catch (Exception e) {\n \t\t\t\tLogger.debug(this, e.toString());\n \t\t\t}\n \n-\t\t\tif(Config.getBooleanProperty(\"PUSH_PUBLISHING_PUSH_STRUCTURES\", true)) {\n+\t\t\tif(Config.getBooleanProperty(\"PUSH_PUBLISHING_PUSH_STRUCTURES\", true) && publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENT_TYPE.getType())) {\n \t\t\t\tStructure struct = CacheLocator.getContentTypeCache().getStructureByInode(con.getStructureInode());\n-\t\t\t\tstructures.addOrClean( con.getStructureInode(), struct.getModDate());\n-\t\t\t\tstructureDependencyHelper(con.getStructureInode());\n+\t\t\t\tcontentTypes.addOrClean( con.getStructureInode(), struct.getModDate());\n+\t\t\t\tstructureDependencyHelper(con.getStructureInode(),publisherFilter);\n \t\t\t}\n \n \t\t\t// Evaluate all the categories from this contentlet to include as dependency.\n-            final List<Category> categoriesFromContentlet = APILocator.getCategoryAPI()\n-                    .getParents(con, APILocator.systemUser(), false);\n-            for (Category category : categoriesFromContentlet) {\n-                categories.addOrClean(category.getCategoryId(), category.getModDate());\n-            }\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CATEGORY.getType())) {\n+\t\t\t\tfinal List<Category> categoriesFromContentlet = APILocator.getCategoryAPI()\n+\t\t\t\t\t\t.getParents(con, APILocator.systemUser(), false);\n+\t\t\t\tfor (Category category : categoriesFromContentlet) {\n+\t\t\t\t\tcategories.addOrClean(category.getCategoryId(), category.getModDate());\n+\t\t\t\t}\n+\t\t\t}\n         }\n \t\t\n \t\t//This is for adding the new language variables (as content)\n         for (String lang : languages) {\n             String keyValueQuery = \"+contentType:\" + LanguageVariableAPI.LANGUAGEVARIABLE + \" +languageId:\" + lang;", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -1280,35 +1282,35 @@ public class DependencyManager {\n \t\t\t}\n \n \t\t\tif(Config.getBooleanProperty(\"PUSH_PUBLISHING_PUSH_STRUCTURES\", true) && publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENT_TYPE.getType())) {\n-\t\t\t\tStructure struct = CacheLocator.getContentTypeCache().getStructureByInode(con.getStructureInode());\n-\t\t\t\tcontentTypes.addOrClean( con.getStructureInode(), struct.getModDate());\n-\t\t\t\tstructureDependencyHelper(con.getStructureInode(),publisherFilter);\n+\t\t\t\tfinal Structure structure = CacheLocator.getContentTypeCache().getStructureByInode(contentletWithDependenciesToProcess.getStructureInode());\n+\t\t\t\tcontentTypes.addOrClean( contentletWithDependenciesToProcess.getStructureInode(), structure.getModDate());\n+\t\t\t\tstructureDependencyHelper(contentletWithDependenciesToProcess.getStructureInode(),publisherFilter);\n \t\t\t}\n \n \t\t\t// Evaluate all the categories from this contentlet to include as dependency.\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CATEGORY.getType())) {\n \t\t\t\tfinal List<Category> categoriesFromContentlet = APILocator.getCategoryAPI()\n-\t\t\t\t\t\t.getParents(con, APILocator.systemUser(), false);\n-\t\t\t\tfor (Category category : categoriesFromContentlet) {\n+\t\t\t\t\t\t.getParents(contentletWithDependenciesToProcess, APILocator.systemUser(), false);\n+\t\t\t\tfor (final Category category : categoriesFromContentlet) {\n \t\t\t\t\tcategories.addOrClean(category.getCategoryId(), category.getModDate());\n \t\t\t\t}\n \t\t\t}\n         }\n \t\t\n \t\t//This is for adding the new language variables (as content)\n-        for (String lang : languages) {\n-            String keyValueQuery = \"+contentType:\" + LanguageVariableAPI.LANGUAGEVARIABLE + \" +languageId:\" + lang;\n-            List<Contentlet> listKeyValueLang = APILocator.getContentletAPI()\n+        for (final String lang : languages) {\n+            final String keyValueQuery = \"+contentType:\" + LanguageVariableAPI.LANGUAGEVARIABLE + \" +languageId:\" + lang;\n+            final List<Contentlet> listKeyValueLang = APILocator.getContentletAPI()\n                             .search(keyValueQuery,0, -1, StringPool.BLANK, user, false);// search for language variables\n \t\t\t// if there is any language variable and we accept to push content type, add the content type\n             if (!listKeyValueLang.isEmpty() && publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENT_TYPE.getType())) {\n-                Structure struct = CacheLocator.getContentTypeCache()\n+                final Structure structure = CacheLocator.getContentTypeCache()\n                                 .getStructureByInode(listKeyValueLang.get(0).getContentTypeId());\n-                contentTypes.addOrClean(struct.getIdentifier(), struct.getModDate());\n-                structureDependencyHelper(struct.getIdentifier(),publisherFilter);\n+                contentTypes.addOrClean(structure.getIdentifier(), structure.getModDate());\n+                structureDependencyHelper(structure.getIdentifier(),publisherFilter);\n             }\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType())) {\n-\t\t\t\tfor (Contentlet keyValue : listKeyValueLang) {// add the language variable\n+\t\t\t\tfor (final Contentlet keyValue : listKeyValueLang) {// add the language variable\n \t\t\t\t\tif(publisherFilter.acceptExcludeDependencyQuery(keyValue.getIdentifier())) {\n \t\t\t\t\t\tcontents.addOrClean(keyValue.getIdentifier(), keyValue.getModDate());\n \t\t\t\t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYzNjY1NA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424636654", "bodyText": "set to final", "author": "jdotcms", "createdAt": "2020-05-13T18:13:56Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -1095,40 +1273,47 @@ private void processList(Set<Contentlet> cons) throws DotDataException, DotSecur\n \n \t\t\t\t\t}\n \t\t\t\t\t//Process the pages we found\n-\t\t\t\t\tsetHTMLPagesDependencies(pagesToProcess);\n+\t\t\t\t\tsetHTMLPagesDependencies(pagesToProcess,publisherFilter);\n \t\t\t\t}\n \t\t\t} catch (Exception e) {\n \t\t\t\tLogger.debug(this, e.toString());\n \t\t\t}\n \n-\t\t\tif(Config.getBooleanProperty(\"PUSH_PUBLISHING_PUSH_STRUCTURES\", true)) {\n+\t\t\tif(Config.getBooleanProperty(\"PUSH_PUBLISHING_PUSH_STRUCTURES\", true) && publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENT_TYPE.getType())) {\n \t\t\t\tStructure struct = CacheLocator.getContentTypeCache().getStructureByInode(con.getStructureInode());\n-\t\t\t\tstructures.addOrClean( con.getStructureInode(), struct.getModDate());\n-\t\t\t\tstructureDependencyHelper(con.getStructureInode());\n+\t\t\t\tcontentTypes.addOrClean( con.getStructureInode(), struct.getModDate());\n+\t\t\t\tstructureDependencyHelper(con.getStructureInode(),publisherFilter);\n \t\t\t}\n \n \t\t\t// Evaluate all the categories from this contentlet to include as dependency.\n-            final List<Category> categoriesFromContentlet = APILocator.getCategoryAPI()\n-                    .getParents(con, APILocator.systemUser(), false);\n-            for (Category category : categoriesFromContentlet) {\n-                categories.addOrClean(category.getCategoryId(), category.getModDate());\n-            }\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CATEGORY.getType())) {\n+\t\t\t\tfinal List<Category> categoriesFromContentlet = APILocator.getCategoryAPI()\n+\t\t\t\t\t\t.getParents(con, APILocator.systemUser(), false);\n+\t\t\t\tfor (Category category : categoriesFromContentlet) {\n+\t\t\t\t\tcategories.addOrClean(category.getCategoryId(), category.getModDate());\n+\t\t\t\t}\n+\t\t\t}\n         }\n \t\t\n \t\t//This is for adding the new language variables (as content)\n         for (String lang : languages) {\n             String keyValueQuery = \"+contentType:\" + LanguageVariableAPI.LANGUAGEVARIABLE + \" +languageId:\" + lang;\n             List<Contentlet> listKeyValueLang = APILocator.getContentletAPI()\n                             .search(keyValueQuery,0, -1, StringPool.BLANK, user, false);// search for language variables\n-            if (!listKeyValueLang.isEmpty()) {// if there is any language variable add the content type\n+\t\t\t// if there is any language variable and we accept to push content type, add the content type\n+            if (!listKeyValueLang.isEmpty() && publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENT_TYPE.getType())) {\n                 Structure struct = CacheLocator.getContentTypeCache()\n                                 .getStructureByInode(listKeyValueLang.get(0).getContentTypeId());\n-                structures.addOrClean(struct.getIdentifier(), struct.getModDate());\n-                structureDependencyHelper(struct.getIdentifier());\n-            }\n-            for (Contentlet keyValue : listKeyValueLang) {// add the language variable\n-                contents.addOrClean(keyValue.getIdentifier(), keyValue.getModDate());\n+                contentTypes.addOrClean(struct.getIdentifier(), struct.getModDate());\n+                structureDependencyHelper(struct.getIdentifier(),publisherFilter);\n             }\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType())) {\n+\t\t\t\tfor (Contentlet keyValue : listKeyValueLang) {// add the language variable", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -1280,35 +1282,35 @@ public class DependencyManager {\n \t\t\t}\n \n \t\t\tif(Config.getBooleanProperty(\"PUSH_PUBLISHING_PUSH_STRUCTURES\", true) && publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENT_TYPE.getType())) {\n-\t\t\t\tStructure struct = CacheLocator.getContentTypeCache().getStructureByInode(con.getStructureInode());\n-\t\t\t\tcontentTypes.addOrClean( con.getStructureInode(), struct.getModDate());\n-\t\t\t\tstructureDependencyHelper(con.getStructureInode(),publisherFilter);\n+\t\t\t\tfinal Structure structure = CacheLocator.getContentTypeCache().getStructureByInode(contentletWithDependenciesToProcess.getStructureInode());\n+\t\t\t\tcontentTypes.addOrClean( contentletWithDependenciesToProcess.getStructureInode(), structure.getModDate());\n+\t\t\t\tstructureDependencyHelper(contentletWithDependenciesToProcess.getStructureInode(),publisherFilter);\n \t\t\t}\n \n \t\t\t// Evaluate all the categories from this contentlet to include as dependency.\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CATEGORY.getType())) {\n \t\t\t\tfinal List<Category> categoriesFromContentlet = APILocator.getCategoryAPI()\n-\t\t\t\t\t\t.getParents(con, APILocator.systemUser(), false);\n-\t\t\t\tfor (Category category : categoriesFromContentlet) {\n+\t\t\t\t\t\t.getParents(contentletWithDependenciesToProcess, APILocator.systemUser(), false);\n+\t\t\t\tfor (final Category category : categoriesFromContentlet) {\n \t\t\t\t\tcategories.addOrClean(category.getCategoryId(), category.getModDate());\n \t\t\t\t}\n \t\t\t}\n         }\n \t\t\n \t\t//This is for adding the new language variables (as content)\n-        for (String lang : languages) {\n-            String keyValueQuery = \"+contentType:\" + LanguageVariableAPI.LANGUAGEVARIABLE + \" +languageId:\" + lang;\n-            List<Contentlet> listKeyValueLang = APILocator.getContentletAPI()\n+        for (final String lang : languages) {\n+            final String keyValueQuery = \"+contentType:\" + LanguageVariableAPI.LANGUAGEVARIABLE + \" +languageId:\" + lang;\n+            final List<Contentlet> listKeyValueLang = APILocator.getContentletAPI()\n                             .search(keyValueQuery,0, -1, StringPool.BLANK, user, false);// search for language variables\n \t\t\t// if there is any language variable and we accept to push content type, add the content type\n             if (!listKeyValueLang.isEmpty() && publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENT_TYPE.getType())) {\n-                Structure struct = CacheLocator.getContentTypeCache()\n+                final Structure structure = CacheLocator.getContentTypeCache()\n                                 .getStructureByInode(listKeyValueLang.get(0).getContentTypeId());\n-                contentTypes.addOrClean(struct.getIdentifier(), struct.getModDate());\n-                structureDependencyHelper(struct.getIdentifier(),publisherFilter);\n+                contentTypes.addOrClean(structure.getIdentifier(), structure.getModDate());\n+                structureDependencyHelper(structure.getIdentifier(),publisherFilter);\n             }\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType())) {\n-\t\t\t\tfor (Contentlet keyValue : listKeyValueLang) {// add the language variable\n+\t\t\t\tfor (final Contentlet keyValue : listKeyValueLang) {// add the language variable\n \t\t\t\t\tif(publisherFilter.acceptExcludeDependencyQuery(keyValue.getIdentifier())) {\n \t\t\t\t\t\tcontents.addOrClean(keyValue.getIdentifier(), keyValue.getModDate());\n \t\t\t\t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYzNzIzNA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424637234", "bodyText": "rename to bundle", "author": "jdotcms", "createdAt": "2020-05-13T18:14:58Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/PublisherUtil.java", "diffHunk": "@@ -101,6 +101,7 @@ public static Bundle getBundleByMap(Map<String, Object> row){\n \t\tb.setOwner(UtilMethods.isSet(row.get(\"owner\"))?row.get(\"owner\").toString():\"\");\n \t\tb.setForcePush(UtilMethods.isSet(row.get(\"force_push\")) && DbConnectionFactory\n \t\t\t\t.isDBTrue(row.get(\"force_push\").toString()));\n+\t\tb.setFilterKey(UtilMethods.isSet(row.get(\"filter_key\")) ? row.get(\"filter_key\").toString() : \"\");", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/PublisherUtil.java b/dotCMS/src/main/java/com/dotcms/publisher/util/PublisherUtil.java\nindex 0e0f20a43c..85cf73c357 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/PublisherUtil.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/PublisherUtil.java\n\n@@ -93,16 +93,16 @@ public class PublisherUtil {\n \t}\n \n \tpublic static Bundle getBundleByMap(Map<String, Object> row){\n-\t\tBundle b = new Bundle();\n-\t\tb.setId(row.get(\"id\").toString());\n-\t\tb.setName(row.get(\"name\").toString());\n-\t\tb.setPublishDate((Date)row.get(\"publish_date\"));\n-\t\tb.setExpireDate((Date)row.get(\"expire_date\"));\n-\t\tb.setOwner(UtilMethods.isSet(row.get(\"owner\"))?row.get(\"owner\").toString():\"\");\n-\t\tb.setForcePush(UtilMethods.isSet(row.get(\"force_push\")) && DbConnectionFactory\n+\t\tfinal Bundle bundle = new Bundle();\n+\t\tbundle.setId(row.get(\"id\").toString());\n+\t\tbundle.setName(row.get(\"name\").toString());\n+\t\tbundle.setPublishDate((Date)row.get(\"publish_date\"));\n+\t\tbundle.setExpireDate((Date)row.get(\"expire_date\"));\n+\t\tbundle.setOwner(UtilMethods.isSet(row.get(\"owner\"))?row.get(\"owner\").toString():\"\");\n+\t\tbundle.setForcePush(UtilMethods.isSet(row.get(\"force_push\")) && DbConnectionFactory\n \t\t\t\t.isDBTrue(row.get(\"force_push\").toString()));\n-\t\tb.setFilterKey(UtilMethods.isSet(row.get(\"filter_key\")) ? row.get(\"filter_key\").toString() : \"\");\n-\t\treturn b;\n+\t\tbundle.setFilterKey(UtilMethods.isSet(row.get(\"filter_key\")) ? row.get(\"filter_key\").toString() : \"\");\n+\t\treturn bundle;\n \t}\n \n \tpublic static PushedAsset getPushedAssetByMap(Map<String, Object> row){\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY0MjMxOQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424642319", "bodyText": "you might replace this for user.isAdmin", "author": "jdotcms", "createdAt": "2020-05-13T18:23:19Z", "path": "dotCMS/src/main/java/com/dotcms/publishing/PublisherAPIImpl.java", "diffHunk": "@@ -142,4 +152,76 @@ public PublishStatus publish ( PublisherConfig config, PublishStatus status ) th\n         return status;\n     }\n \n+    @Override\n+    public void addFilterDescriptor(final FilterDescriptor filterDescriptor) {\n+        this.loadedFilters.put(filterDescriptor.getKey(),filterDescriptor);\n+    }\n+\n+    @Override\n+    public List<FilterDescriptor> getFiltersDescriptorsByRole(final User user) throws DotDataException {\n+        if(APILocator.getUserAPI().isCMSAdmin(user)){", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publishing/PublisherAPIImpl.java b/dotCMS/src/main/java/com/dotcms/publishing/PublisherAPIImpl.java\nindex 59a8b14271..c91e32cd7f 100644\n--- a/dotCMS/src/main/java/com/dotcms/publishing/PublisherAPIImpl.java\n+++ b/dotCMS/src/main/java/com/dotcms/publishing/PublisherAPIImpl.java\n\n@@ -159,7 +159,7 @@ public class PublisherAPIImpl implements PublisherAPI {\n \n     @Override\n     public List<FilterDescriptor> getFiltersDescriptorsByRole(final User user) throws DotDataException {\n-        if(APILocator.getUserAPI().isCMSAdmin(user)){\n+        if(user.isAdmin()){\n             return new ArrayList<>(this.loadedFilters.values());\n         }\n         final List<Role> roles = APILocator.getRoleAPI().loadRolesForUser(user.getUserId(), true);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY1MDUxMg==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424650512", "bodyText": "This could be refactored by\nreturn !UtilMethods.isSet(filterKey)?\n     this.loadedFilters.values().stream().filter(FilterDescriptor::isDefaultFilter()).findFirst().get():\n    this.loadedFilters.containsKey(filterKey)? this.loadedFilters.get(filterKey) :  this.loadedFilters.values().stream().filter(FilterDescriptor::isDefaultFilter()).findFirst().get();\n        \n\nIn addition you can create a method called getDefaultFilter, that basically returns this\n this.loadedFilters.values().stream().filter(FilterDescriptor::isDefaultFilter()).findFirst().get()\n\nAnd call such as this:\nreturn !UtilMethods.isSet(filterKey)?\n     this.getDefaultFilter():\n     this.loadedFilters.containsKey(filterKey)?\n         this.loadedFilters.get(filterKey) :  this.getDefaultFilter();", "author": "jdotcms", "createdAt": "2020-05-13T18:37:01Z", "path": "dotCMS/src/main/java/com/dotcms/publishing/PublisherAPIImpl.java", "diffHunk": "@@ -142,4 +152,76 @@ public PublishStatus publish ( PublisherConfig config, PublishStatus status ) th\n         return status;\n     }\n \n+    @Override\n+    public void addFilterDescriptor(final FilterDescriptor filterDescriptor) {\n+        this.loadedFilters.put(filterDescriptor.getKey(),filterDescriptor);\n+    }\n+\n+    @Override\n+    public List<FilterDescriptor> getFiltersDescriptorsByRole(final User user) throws DotDataException {\n+        if(APILocator.getUserAPI().isCMSAdmin(user)){\n+            return new ArrayList<>(this.loadedFilters.values());\n+        }\n+        final List<Role> roles = APILocator.getRoleAPI().loadRolesForUser(user.getUserId(), true);\n+        Logger.info(this,\"User Roles: \" + roles.toString());\n+        final List<FilterDescriptor> filters = new ArrayList<>();\n+        for(final Map.Entry<String,FilterDescriptor> filterDescriptorMap : this.loadedFilters.entrySet()){\n+            final String filterRoles = filterDescriptorMap.getValue().getRoles();\n+            Logger.info(PublisherAPI.class,\"File: \" +filterDescriptorMap.getKey() + \" Roles: \" + filterRoles );\n+            for(final Role role : roles){\n+                if(UtilMethods.isSet(role.getRoleKey()) && filterRoles.contains(role.getRoleKey())){\n+                    filters.add(filterDescriptorMap.getValue());\n+                }\n+            }\n+        }\n+\n+        return filters;\n+    }\n+\n+    @Override\n+    public Map<String, FilterDescriptor> getFilterDescriptorMap() {\n+        return this.loadedFilters;\n+    }\n+\n+    @Override\n+    public FilterDescriptor getFilterDescriptorByKey(final String filterKey) {\n+        final FilterDescriptor defaultFilter = this.loadedFilters.values().stream().filter(filterDescriptor -> filterDescriptor.isDefaultFilter()).findAny().get();\n+        if(!UtilMethods.isSet(filterKey)){\n+            return defaultFilter;\n+        }\n+        return this.loadedFilters.getOrDefault(filterKey,defaultFilter);\n+    }", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publishing/PublisherAPIImpl.java b/dotCMS/src/main/java/com/dotcms/publishing/PublisherAPIImpl.java\nindex 59a8b14271..c91e32cd7f 100644\n--- a/dotCMS/src/main/java/com/dotcms/publishing/PublisherAPIImpl.java\n+++ b/dotCMS/src/main/java/com/dotcms/publishing/PublisherAPIImpl.java\n\n@@ -159,7 +159,7 @@ public class PublisherAPIImpl implements PublisherAPI {\n \n     @Override\n     public List<FilterDescriptor> getFiltersDescriptorsByRole(final User user) throws DotDataException {\n-        if(APILocator.getUserAPI().isCMSAdmin(user)){\n+        if(user.isAdmin()){\n             return new ArrayList<>(this.loadedFilters.values());\n         }\n         final List<Role> roles = APILocator.getRoleAPI().loadRolesForUser(user.getUserId(), true);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY1MzQzNA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424653434", "bodyText": "I prefer to do this such as\nList.class.cast(filterDescriptor.getFilters().get(\"excludeClasses\")).stream().forEach(type -> publisherFilter.addTypeToExcludeClassesSet(type.toString()));", "author": "jdotcms", "createdAt": "2020-05-13T18:41:54Z", "path": "dotCMS/src/main/java/com/dotcms/publishing/PublisherAPIImpl.java", "diffHunk": "@@ -142,4 +152,76 @@ public PublishStatus publish ( PublisherConfig config, PublishStatus status ) th\n         return status;\n     }\n \n+    @Override\n+    public void addFilterDescriptor(final FilterDescriptor filterDescriptor) {\n+        this.loadedFilters.put(filterDescriptor.getKey(),filterDescriptor);\n+    }\n+\n+    @Override\n+    public List<FilterDescriptor> getFiltersDescriptorsByRole(final User user) throws DotDataException {\n+        if(APILocator.getUserAPI().isCMSAdmin(user)){\n+            return new ArrayList<>(this.loadedFilters.values());\n+        }\n+        final List<Role> roles = APILocator.getRoleAPI().loadRolesForUser(user.getUserId(), true);\n+        Logger.info(this,\"User Roles: \" + roles.toString());\n+        final List<FilterDescriptor> filters = new ArrayList<>();\n+        for(final Map.Entry<String,FilterDescriptor> filterDescriptorMap : this.loadedFilters.entrySet()){\n+            final String filterRoles = filterDescriptorMap.getValue().getRoles();\n+            Logger.info(PublisherAPI.class,\"File: \" +filterDescriptorMap.getKey() + \" Roles: \" + filterRoles );\n+            for(final Role role : roles){\n+                if(UtilMethods.isSet(role.getRoleKey()) && filterRoles.contains(role.getRoleKey())){\n+                    filters.add(filterDescriptorMap.getValue());\n+                }\n+            }\n+        }\n+\n+        return filters;\n+    }\n+\n+    @Override\n+    public Map<String, FilterDescriptor> getFilterDescriptorMap() {\n+        return this.loadedFilters;\n+    }\n+\n+    @Override\n+    public FilterDescriptor getFilterDescriptorByKey(final String filterKey) {\n+        final FilterDescriptor defaultFilter = this.loadedFilters.values().stream().filter(filterDescriptor -> filterDescriptor.isDefaultFilter()).findAny().get();\n+        if(!UtilMethods.isSet(filterKey)){\n+            return defaultFilter;\n+        }\n+        return this.loadedFilters.getOrDefault(filterKey,defaultFilter);\n+    }\n+\n+    @Override\n+    public PublisherFilter createPublisherFilter(final String bundleId)\n+            throws DotDataException, DotSecurityException {\n+\n+        final String filterKey = APILocator.getBundleAPI().getBundleById(bundleId).getFilterKey();\n+        final FilterDescriptor filterDescriptor = this.getFilterDescriptorByKey(filterKey);\n+\n+        final PublisherFilterImpl publisherFilter = new PublisherFilterImpl((Boolean)filterDescriptor.getFilters().getOrDefault(\"dependencies\",true),\n+                (Boolean)filterDescriptor.getFilters().getOrDefault(\"relationships\",true));\n+\n+        if(filterDescriptor.getFilters().containsKey(\"excludeClasses\")){\n+            ((ArrayList)filterDescriptor.getFilters().get(\"excludeClasses\")).stream().forEach(type -> publisherFilter.addTypeToExcludeClassesSet(type.toString()));", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publishing/PublisherAPIImpl.java b/dotCMS/src/main/java/com/dotcms/publishing/PublisherAPIImpl.java\nindex 59a8b14271..c91e32cd7f 100644\n--- a/dotCMS/src/main/java/com/dotcms/publishing/PublisherAPIImpl.java\n+++ b/dotCMS/src/main/java/com/dotcms/publishing/PublisherAPIImpl.java\n\n@@ -159,7 +159,7 @@ public class PublisherAPIImpl implements PublisherAPI {\n \n     @Override\n     public List<FilterDescriptor> getFiltersDescriptorsByRole(final User user) throws DotDataException {\n-        if(APILocator.getUserAPI().isCMSAdmin(user)){\n+        if(user.isAdmin()){\n             return new ArrayList<>(this.loadedFilters.values());\n         }\n         final List<Role> roles = APILocator.getRoleAPI().loadRolesForUser(user.getUserId(), true);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY1MzU2OA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424653568", "bodyText": "same thing here", "author": "jdotcms", "createdAt": "2020-05-13T18:42:07Z", "path": "dotCMS/src/main/java/com/dotcms/publishing/PublisherAPIImpl.java", "diffHunk": "@@ -142,4 +152,76 @@ public PublishStatus publish ( PublisherConfig config, PublishStatus status ) th\n         return status;\n     }\n \n+    @Override\n+    public void addFilterDescriptor(final FilterDescriptor filterDescriptor) {\n+        this.loadedFilters.put(filterDescriptor.getKey(),filterDescriptor);\n+    }\n+\n+    @Override\n+    public List<FilterDescriptor> getFiltersDescriptorsByRole(final User user) throws DotDataException {\n+        if(APILocator.getUserAPI().isCMSAdmin(user)){\n+            return new ArrayList<>(this.loadedFilters.values());\n+        }\n+        final List<Role> roles = APILocator.getRoleAPI().loadRolesForUser(user.getUserId(), true);\n+        Logger.info(this,\"User Roles: \" + roles.toString());\n+        final List<FilterDescriptor> filters = new ArrayList<>();\n+        for(final Map.Entry<String,FilterDescriptor> filterDescriptorMap : this.loadedFilters.entrySet()){\n+            final String filterRoles = filterDescriptorMap.getValue().getRoles();\n+            Logger.info(PublisherAPI.class,\"File: \" +filterDescriptorMap.getKey() + \" Roles: \" + filterRoles );\n+            for(final Role role : roles){\n+                if(UtilMethods.isSet(role.getRoleKey()) && filterRoles.contains(role.getRoleKey())){\n+                    filters.add(filterDescriptorMap.getValue());\n+                }\n+            }\n+        }\n+\n+        return filters;\n+    }\n+\n+    @Override\n+    public Map<String, FilterDescriptor> getFilterDescriptorMap() {\n+        return this.loadedFilters;\n+    }\n+\n+    @Override\n+    public FilterDescriptor getFilterDescriptorByKey(final String filterKey) {\n+        final FilterDescriptor defaultFilter = this.loadedFilters.values().stream().filter(filterDescriptor -> filterDescriptor.isDefaultFilter()).findAny().get();\n+        if(!UtilMethods.isSet(filterKey)){\n+            return defaultFilter;\n+        }\n+        return this.loadedFilters.getOrDefault(filterKey,defaultFilter);\n+    }\n+\n+    @Override\n+    public PublisherFilter createPublisherFilter(final String bundleId)\n+            throws DotDataException, DotSecurityException {\n+\n+        final String filterKey = APILocator.getBundleAPI().getBundleById(bundleId).getFilterKey();\n+        final FilterDescriptor filterDescriptor = this.getFilterDescriptorByKey(filterKey);\n+\n+        final PublisherFilterImpl publisherFilter = new PublisherFilterImpl((Boolean)filterDescriptor.getFilters().getOrDefault(\"dependencies\",true),\n+                (Boolean)filterDescriptor.getFilters().getOrDefault(\"relationships\",true));\n+\n+        if(filterDescriptor.getFilters().containsKey(\"excludeClasses\")){\n+            ((ArrayList)filterDescriptor.getFilters().get(\"excludeClasses\")).stream().forEach(type -> publisherFilter.addTypeToExcludeClassesSet(type.toString()));\n+        }\n+\n+        if(filterDescriptor.getFilters().containsKey(\"excludeDependencyClasses\")){\n+            ((ArrayList)filterDescriptor.getFilters().get(\"excludeDependencyClasses\")).stream().forEach(type -> publisherFilter.addTypeToExcludeDependencyClassesSet(type.toString()));", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publishing/PublisherAPIImpl.java b/dotCMS/src/main/java/com/dotcms/publishing/PublisherAPIImpl.java\nindex 59a8b14271..c91e32cd7f 100644\n--- a/dotCMS/src/main/java/com/dotcms/publishing/PublisherAPIImpl.java\n+++ b/dotCMS/src/main/java/com/dotcms/publishing/PublisherAPIImpl.java\n\n@@ -159,7 +159,7 @@ public class PublisherAPIImpl implements PublisherAPI {\n \n     @Override\n     public List<FilterDescriptor> getFiltersDescriptorsByRole(final User user) throws DotDataException {\n-        if(APILocator.getUserAPI().isCMSAdmin(user)){\n+        if(user.isAdmin()){\n             return new ArrayList<>(this.loadedFilters.values());\n         }\n         final List<Role> roles = APILocator.getRoleAPI().loadRolesForUser(user.getUserId(), true);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY1NTYzMQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424655631", "bodyText": "use the supplier version\nLogger.debug(PushPublishFiltersInitializer.class, ()-> \" dotcms filters files copied\");", "author": "jdotcms", "createdAt": "2020-05-13T18:45:32Z", "path": "dotCMS/src/main/java/com/dotcms/publishing/PushPublishFiltersInitializer.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package com.dotcms.publishing;\n+\n+import com.dotcms.config.DotInitializer;\n+import com.dotcms.util.YamlUtil;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.util.Logger;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+\n+/**\n+ * Path of the yaml files: /assets/server/publishing-filters/\n+ */\n+public class PushPublishFiltersInitializer implements DotInitializer {\n+\n+    @Override\n+    public void init() {\n+\n+        try {\n+            //Path where the YAML files are stored\n+            final String filtersDirectoryString =\n+                    APILocator.getFileAssetAPI().getRealAssetsRootPath() + File.separator + \"server\"\n+                            + File.separator + \"publishing-filters\" + File.separator;\n+            final File basePath = new File(filtersDirectoryString);\n+            if (!basePath.exists()) {\n+                basePath.mkdir();\n+                //If the directory does not exists, copy the YAML files that are ship with\n+                //dotcms to the created directory\n+                final String systemFiltersDirectory = \"com\" + File.separator + \"dotcms\" +\n+                        File.separator + \"publishing-filters\" + File.separator;\n+                final String systemFiltersPathString = Thread.currentThread()\n+                        .getContextClassLoader().getResource(systemFiltersDirectory).getPath();\n+                final File systemFilters = new File(systemFiltersPathString);\n+                Files.list(systemFilters.toPath()).forEach(filter -> {\n+                    try {\n+                        Files.copy(filter,\n+                                Paths.get(filtersDirectoryString + filter.getFileName()));\n+                    } catch (IOException e) {\n+                        Logger.error(this, e.getMessage(), e);\n+                    }\n+                });\n+                Logger.debug(PushPublishFiltersInitializer.class, \" dotcms filters files copied\");", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publishing/PushPublishFiltersInitializer.java b/dotCMS/src/main/java/com/dotcms/publishing/PushPublishFiltersInitializer.java\nindex 58dd5e14f8..f43c7c7d16 100644\n--- a/dotCMS/src/main/java/com/dotcms/publishing/PushPublishFiltersInitializer.java\n+++ b/dotCMS/src/main/java/com/dotcms/publishing/PushPublishFiltersInitializer.java\n\n@@ -41,7 +41,7 @@ public class PushPublishFiltersInitializer implements DotInitializer {\n                         Logger.error(this, e.getMessage(), e);\n                     }\n                 });\n-                Logger.debug(PushPublishFiltersInitializer.class, \" dotcms filters files copied\");\n+                Logger.debug(PushPublishFiltersInitializer.class, ()->\" dotcms filters files copied\");\n             }\n             Logger.info(PushPublishFiltersInitializer.class, \" ymlFiles are set under:  \" + filtersDirectoryString);\n             //For each YAML file under the directory,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY1NjM4OQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424656389", "bodyText": "Add doc", "author": "jdotcms", "createdAt": "2020-05-13T18:46:52Z", "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/pushpublish/PushPublishFilterResource.java", "diffHunk": "@@ -0,0 +1,61 @@\n+package com.dotcms.rest.api.v1.pushpublish;\n+\n+import com.dotcms.publishing.FilterDescriptor;\n+import com.dotcms.rest.InitDataObject;\n+import com.dotcms.rest.ResponseEntityView;\n+import com.dotcms.rest.WebResource;\n+import com.dotcms.rest.annotation.NoCache;\n+import com.dotcms.util.CollectionsUtils;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotDataException;\n+import com.google.common.annotations.VisibleForTesting;\n+import com.liferay.portal.model.User;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.core.Context;\n+import javax.ws.rs.core.MediaType;\n+import javax.ws.rs.core.Response;\n+import org.glassfish.jersey.server.JSONP;\n+\n+@Path(\"/v1/pushpublish/filter\")\n+public class PushPublishFilterResource {", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/rest/api/v1/pushpublish/PushPublishFilterResource.java b/dotCMS/src/main/java/com/dotcms/rest/api/v1/pushpublish/PushPublishFilterResource.java\nindex 3e78179616..aac62efe1c 100644\n--- a/dotCMS/src/main/java/com/dotcms/rest/api/v1/pushpublish/PushPublishFilterResource.java\n+++ b/dotCMS/src/main/java/com/dotcms/rest/api/v1/pushpublish/PushPublishFilterResource.java\n\n@@ -22,6 +22,9 @@ import javax.ws.rs.core.MediaType;\n import javax.ws.rs.core.Response;\n import org.glassfish.jersey.server.JSONP;\n \n+/**\n+ * This Resource is for the push publishing filters\n+ */\n @Path(\"/v1/pushpublish/filter\")\n public class PushPublishFilterResource {\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY1NzY2OA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424657668", "bodyText": "Log here", "author": "jdotcms", "createdAt": "2020-05-13T18:49:04Z", "path": "dotCMS/src/main/java/com/dotcms/util/YamlUtil.java", "diffHunk": "@@ -0,0 +1,86 @@\n+package com.dotcms.util;\n+\n+import com.dotmarketing.exception.DotRuntimeException;\n+import com.fasterxml.jackson.annotation.JsonAutoDetect;\n+import com.fasterxml.jackson.annotation.PropertyAccessor;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.dataformat.yaml.YAMLFactory;\n+\n+import java.io.File;\n+import java.io.InputStream;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+\n+/**\n+ * Yaml Utils to parse and save yaml files\n+ * @author jsanca\n+ */\n+public class YamlUtil {\n+\n+    private final static ObjectMapper ymlMapper = new ObjectMapper(new YAMLFactory())\n+            .setVisibility(PropertyAccessor.FIELD, JsonAutoDetect.Visibility.ANY)\n+            .findAndRegisterModules();\n+\n+    /**\n+     * Parse the file in order to convert to T object\n+     * @param file {@link File}\n+     * @param tClass T class to convert\n+     * @param <T>\n+     * @return Object Yaml converted\n+     */\n+    public static <T> T parse(final File file, final Class<T> tClass) {\n+\n+        return parse(Paths.get(file.getPath()), tClass);\n+    }\n+\n+    /**\n+     * Parse the path in order to convert to T object\n+     * @param path {@link Path}\n+     * @param tClass T class to convert\n+     * @param <T>\n+     * @return Object Yaml converted\n+     */\n+    public static <T> T parse(final Path path, final Class<T> tClass) {\n+\n+        try(final InputStream inputStream = Files.newInputStream(path)) {\n+\n+            return parse(inputStream, tClass);\n+        }catch (Exception e){\n+            throw new DotRuntimeException(e);", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/util/YamlUtil.java b/dotCMS/src/main/java/com/dotcms/util/YamlUtil.java\nindex d8ef45753b..5d958aaa77 100644\n--- a/dotCMS/src/main/java/com/dotcms/util/YamlUtil.java\n+++ b/dotCMS/src/main/java/com/dotcms/util/YamlUtil.java\n\n@@ -1,6 +1,7 @@\n package com.dotcms.util;\n \n import com.dotmarketing.exception.DotRuntimeException;\n+import com.dotmarketing.util.Logger;\n import com.fasterxml.jackson.annotation.JsonAutoDetect;\n import com.fasterxml.jackson.annotation.PropertyAccessor;\n import com.fasterxml.jackson.databind.ObjectMapper;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY1Nzc2NQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424657765", "bodyText": "Buffered it", "author": "jdotcms", "createdAt": "2020-05-13T18:49:15Z", "path": "dotCMS/src/main/java/com/dotcms/util/YamlUtil.java", "diffHunk": "@@ -0,0 +1,86 @@\n+package com.dotcms.util;\n+\n+import com.dotmarketing.exception.DotRuntimeException;\n+import com.fasterxml.jackson.annotation.JsonAutoDetect;\n+import com.fasterxml.jackson.annotation.PropertyAccessor;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.dataformat.yaml.YAMLFactory;\n+\n+import java.io.File;\n+import java.io.InputStream;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+\n+/**\n+ * Yaml Utils to parse and save yaml files\n+ * @author jsanca\n+ */\n+public class YamlUtil {\n+\n+    private final static ObjectMapper ymlMapper = new ObjectMapper(new YAMLFactory())\n+            .setVisibility(PropertyAccessor.FIELD, JsonAutoDetect.Visibility.ANY)\n+            .findAndRegisterModules();\n+\n+    /**\n+     * Parse the file in order to convert to T object\n+     * @param file {@link File}\n+     * @param tClass T class to convert\n+     * @param <T>\n+     * @return Object Yaml converted\n+     */\n+    public static <T> T parse(final File file, final Class<T> tClass) {\n+\n+        return parse(Paths.get(file.getPath()), tClass);\n+    }\n+\n+    /**\n+     * Parse the path in order to convert to T object\n+     * @param path {@link Path}\n+     * @param tClass T class to convert\n+     * @param <T>\n+     * @return Object Yaml converted\n+     */\n+    public static <T> T parse(final Path path, final Class<T> tClass) {\n+\n+        try(final InputStream inputStream = Files.newInputStream(path)) {", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/util/YamlUtil.java b/dotCMS/src/main/java/com/dotcms/util/YamlUtil.java\nindex d8ef45753b..5d958aaa77 100644\n--- a/dotCMS/src/main/java/com/dotcms/util/YamlUtil.java\n+++ b/dotCMS/src/main/java/com/dotcms/util/YamlUtil.java\n\n@@ -1,6 +1,7 @@\n package com.dotcms.util;\n \n import com.dotmarketing.exception.DotRuntimeException;\n+import com.dotmarketing.util.Logger;\n import com.fasterxml.jackson.annotation.JsonAutoDetect;\n import com.fasterxml.jackson.annotation.PropertyAccessor;\n import com.fasterxml.jackson.databind.ObjectMapper;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY1ODE4Ng==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424658186", "bodyText": "Log here", "author": "jdotcms", "createdAt": "2020-05-13T18:49:55Z", "path": "dotCMS/src/main/java/com/dotcms/util/YamlUtil.java", "diffHunk": "@@ -0,0 +1,86 @@\n+package com.dotcms.util;\n+\n+import com.dotmarketing.exception.DotRuntimeException;\n+import com.fasterxml.jackson.annotation.JsonAutoDetect;\n+import com.fasterxml.jackson.annotation.PropertyAccessor;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.dataformat.yaml.YAMLFactory;\n+\n+import java.io.File;\n+import java.io.InputStream;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+\n+/**\n+ * Yaml Utils to parse and save yaml files\n+ * @author jsanca\n+ */\n+public class YamlUtil {\n+\n+    private final static ObjectMapper ymlMapper = new ObjectMapper(new YAMLFactory())\n+            .setVisibility(PropertyAccessor.FIELD, JsonAutoDetect.Visibility.ANY)\n+            .findAndRegisterModules();\n+\n+    /**\n+     * Parse the file in order to convert to T object\n+     * @param file {@link File}\n+     * @param tClass T class to convert\n+     * @param <T>\n+     * @return Object Yaml converted\n+     */\n+    public static <T> T parse(final File file, final Class<T> tClass) {\n+\n+        return parse(Paths.get(file.getPath()), tClass);\n+    }\n+\n+    /**\n+     * Parse the path in order to convert to T object\n+     * @param path {@link Path}\n+     * @param tClass T class to convert\n+     * @param <T>\n+     * @return Object Yaml converted\n+     */\n+    public static <T> T parse(final Path path, final Class<T> tClass) {\n+\n+        try(final InputStream inputStream = Files.newInputStream(path)) {\n+\n+            return parse(inputStream, tClass);\n+        }catch (Exception e){\n+            throw new DotRuntimeException(e);\n+        }\n+    }\n+\n+    /**\n+     * Parse the input stream in order to convert to T object\n+     * @param inputStream {@link InputStream}\n+     * @param tClass T class to convert\n+     * @param <T>\n+     * @return Object Yaml converted\n+     */\n+    public static <T> T parse(final InputStream inputStream, final Class<T> tClass) {\n+\n+        try {\n+            return ymlMapper\n+                    .readValue(inputStream, tClass);\n+        } catch (Exception e) {\n+            throw new DotRuntimeException(e);", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/util/YamlUtil.java b/dotCMS/src/main/java/com/dotcms/util/YamlUtil.java\nindex d8ef45753b..5d958aaa77 100644\n--- a/dotCMS/src/main/java/com/dotcms/util/YamlUtil.java\n+++ b/dotCMS/src/main/java/com/dotcms/util/YamlUtil.java\n\n@@ -1,6 +1,7 @@\n package com.dotcms.util;\n \n import com.dotmarketing.exception.DotRuntimeException;\n+import com.dotmarketing.util.Logger;\n import com.fasterxml.jackson.annotation.JsonAutoDetect;\n import com.fasterxml.jackson.annotation.PropertyAccessor;\n import com.fasterxml.jackson.databind.ObjectMapper;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY1ODI3MQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424658271", "bodyText": "Log here", "author": "jdotcms", "createdAt": "2020-05-13T18:50:01Z", "path": "dotCMS/src/main/java/com/dotcms/util/YamlUtil.java", "diffHunk": "@@ -0,0 +1,86 @@\n+package com.dotcms.util;\n+\n+import com.dotmarketing.exception.DotRuntimeException;\n+import com.fasterxml.jackson.annotation.JsonAutoDetect;\n+import com.fasterxml.jackson.annotation.PropertyAccessor;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.dataformat.yaml.YAMLFactory;\n+\n+import java.io.File;\n+import java.io.InputStream;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+\n+/**\n+ * Yaml Utils to parse and save yaml files\n+ * @author jsanca\n+ */\n+public class YamlUtil {\n+\n+    private final static ObjectMapper ymlMapper = new ObjectMapper(new YAMLFactory())\n+            .setVisibility(PropertyAccessor.FIELD, JsonAutoDetect.Visibility.ANY)\n+            .findAndRegisterModules();\n+\n+    /**\n+     * Parse the file in order to convert to T object\n+     * @param file {@link File}\n+     * @param tClass T class to convert\n+     * @param <T>\n+     * @return Object Yaml converted\n+     */\n+    public static <T> T parse(final File file, final Class<T> tClass) {\n+\n+        return parse(Paths.get(file.getPath()), tClass);\n+    }\n+\n+    /**\n+     * Parse the path in order to convert to T object\n+     * @param path {@link Path}\n+     * @param tClass T class to convert\n+     * @param <T>\n+     * @return Object Yaml converted\n+     */\n+    public static <T> T parse(final Path path, final Class<T> tClass) {\n+\n+        try(final InputStream inputStream = Files.newInputStream(path)) {\n+\n+            return parse(inputStream, tClass);\n+        }catch (Exception e){\n+            throw new DotRuntimeException(e);\n+        }\n+    }\n+\n+    /**\n+     * Parse the input stream in order to convert to T object\n+     * @param inputStream {@link InputStream}\n+     * @param tClass T class to convert\n+     * @param <T>\n+     * @return Object Yaml converted\n+     */\n+    public static <T> T parse(final InputStream inputStream, final Class<T> tClass) {\n+\n+        try {\n+            return ymlMapper\n+                    .readValue(inputStream, tClass);\n+        } catch (Exception e) {\n+            throw new DotRuntimeException(e);\n+        }\n+    }\n+\n+    /**\n+     * Write into a file a Yaml\n+     * @param file {@link File} destiny file to save the yaml\n+     * @param yaml T yaml file\n+     * @param <T>\n+     */\n+    public static <T> void write (final File file, final T yaml) {\n+\n+        try {\n+            ymlMapper.writeValue(file, yaml);\n+        } catch (Exception e) {\n+            throw new DotRuntimeException(e);", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/util/YamlUtil.java b/dotCMS/src/main/java/com/dotcms/util/YamlUtil.java\nindex d8ef45753b..5d958aaa77 100644\n--- a/dotCMS/src/main/java/com/dotcms/util/YamlUtil.java\n+++ b/dotCMS/src/main/java/com/dotcms/util/YamlUtil.java\n\n@@ -1,6 +1,7 @@\n package com.dotcms.util;\n \n import com.dotmarketing.exception.DotRuntimeException;\n+import com.dotmarketing.util.Logger;\n import com.fasterxml.jackson.annotation.JsonAutoDetect;\n import com.fasterxml.jackson.annotation.PropertyAccessor;\n import com.fasterxml.jackson.databind.ObjectMapper;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY1ODgxNA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424658814", "bodyText": "use StringPool.BLANK and i18n \"Filter\"", "author": "jdotcms", "createdAt": "2020-05-13T18:50:52Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/workflows/actionlet/PushNowActionlet.java", "diffHunk": "@@ -63,6 +64,7 @@\n         final List<WorkflowActionletParameter> params = new ArrayList<>();\n         params.add(new WorkflowActionletParameter(PARAM_ENVIRONMENT, \"Name of the Environment\", \"\", true));\n         params.add(new WorkflowActionletParameter(PARAM_FORCE_PUSH, \"Force the Push? true or false\", \"false\", true));\n+        params.add(new WorkflowActionletParameter(PARAM_FILTER_KEY, \"Filter\", \"\", true));", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a84206cac21f76993b27f794da8e08b4398c7652", "chunk": "diff --git a/dotCMS/src/main/java/com/dotmarketing/portlets/workflows/actionlet/PushNowActionlet.java b/dotCMS/src/main/java/com/dotmarketing/portlets/workflows/actionlet/PushNowActionlet.java\nindex 24a4f0296b..346f800e35 100644\n--- a/dotCMS/src/main/java/com/dotmarketing/portlets/workflows/actionlet/PushNowActionlet.java\n+++ b/dotCMS/src/main/java/com/dotmarketing/portlets/workflows/actionlet/PushNowActionlet.java\n\n@@ -62,9 +66,14 @@ public class PushNowActionlet extends WorkFlowActionlet {\n     @Override\n     public List<WorkflowActionletParameter> getParameters() {\n         final List<WorkflowActionletParameter> params = new ArrayList<>();\n-        params.add(new WorkflowActionletParameter(PARAM_ENVIRONMENT, \"Name of the Environment\", \"\", true));\n-        params.add(new WorkflowActionletParameter(PARAM_FORCE_PUSH, \"Force the Push? true or false\", \"false\", true));\n-        params.add(new WorkflowActionletParameter(PARAM_FILTER_KEY, \"Filter\", \"\", true));\n+        //Environment Param\n+        params.add(new WorkflowActionletParameter(PARAM_ENVIRONMENT, Try.of(()->LanguageUtil.get(\"pushNowActionlet.environments.name\")).getOrElse(\"Name of the Environments\"), \"\", true));\n+        //Filter Param\n+        final Collection<FilterDescriptor> filterDescriptorMap = APILocator.getPublisherAPI().getFilterDescriptorMap().values();\n+        final FilterDescriptor defaultFilter = filterDescriptorMap.stream().filter(filterDescriptor -> filterDescriptor.isDefaultFilter()).findFirst().get();\n+        final List<MultiKeyValue> multiKeyValueFilterList = new ArrayList<>();\n+        filterDescriptorMap.stream().forEach(filterDescriptor -> multiKeyValueFilterList.add(new MultiKeyValue(filterDescriptor.getKey(),filterDescriptor.getTitle())));\n+        params.add(new MultiSelectionWorkflowActionletParameter(PARAM_FILTER_KEY, Try.of(()->LanguageUtil.get(\"pushNowActionlet.filter\")).getOrElse(\"Name of the Environments\"), defaultFilter.getKey(), true,()->multiKeyValueFilterList));\n         return params;\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY1OTMyMQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424659321", "bodyText": "I would ask to the catalog if the filter_key does not exists on publishing_bundle to proceed", "author": "jdotcms", "createdAt": "2020-05-13T18:51:47Z", "path": "dotCMS/src/main/java/com/dotmarketing/startup/runonce/Task05305AddPushPublishFilterColumn.java", "diffHunk": "@@ -0,0 +1,42 @@\n+package com.dotmarketing.startup.runonce;\n+\n+import com.dotmarketing.startup.AbstractJDBCStartupTask;\n+import java.util.List;\n+\n+public class Task05305AddPushPublishFilterColumn extends AbstractJDBCStartupTask {\n+\n+    @Override\n+    public String getPostgresScript() {\n+        return \"ALTER TABLE publishing_bundle ADD filter_key VARCHAR(100)\";\n+    }\n+\n+    @Override\n+    public String getMySQLScript() {\n+        return \"ALTER TABLE publishing_bundle ADD filter_key VARCHAR(100)\";\n+    }\n+\n+    @Override\n+    public String getOracleScript() {\n+        return \"ALTER TABLE publishing_bundle ADD filter_key VARCHAR2(100)\";\n+    }\n+\n+    @Override\n+    public String getMSSQLScript() {\n+        return \"ALTER TABLE publishing_bundle ADD filter_key NVARCHAR(100)\";\n+    }\n+\n+    @Override\n+    public String getH2Script() {\n+        return null;\n+    }\n+\n+    @Override\n+    protected List<String> getTablesToDropConstraints() {\n+        return null;\n+    }\n+\n+    @Override\n+    public boolean forceRun() {\n+        return true;", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cdf576a198511562cb24aa36e0f151f02153c900", "chunk": "diff --git a/dotCMS/src/main/java/com/dotmarketing/startup/runonce/Task05305AddPushPublishFilterColumn.java b/dotCMS/src/main/java/com/dotmarketing/startup/runonce/Task05305AddPushPublishFilterColumn.java\nindex 50beaee7cd..90ee18f5b9 100644\n--- a/dotCMS/src/main/java/com/dotmarketing/startup/runonce/Task05305AddPushPublishFilterColumn.java\n+++ b/dotCMS/src/main/java/com/dotmarketing/startup/runonce/Task05305AddPushPublishFilterColumn.java\n\n@@ -1,6 +1,10 @@\n package com.dotmarketing.startup.runonce;\n \n+import com.dotmarketing.common.db.DotDatabaseMetaData;\n+import com.dotmarketing.db.DbConnectionFactory;\n import com.dotmarketing.startup.AbstractJDBCStartupTask;\n+import com.dotmarketing.util.Logger;\n+import java.sql.SQLException;\n import java.util.List;\n \n public class Task05305AddPushPublishFilterColumn extends AbstractJDBCStartupTask {\n"}}, {"oid": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "url": "https://github.com/dotCMS/core/commit/e0568a65affc3aa93fde2d9692d52d4ae1944d28", "message": "#17806 #17985 feedback", "committedDate": "2020-05-13T22:57:50Z", "type": "commit"}, {"oid": "a84206cac21f76993b27f794da8e08b4398c7652", "url": "https://github.com/dotCMS/core/commit/a84206cac21f76993b27f794da8e08b4398c7652", "message": "Issue 17987 (#18487)\n\n* #17806 adding the ability to render a select box instead of a single text area for the actionlets on wf\r\n\r\n* #17806 adding the ability to render a select box instead of a single text area for the actionlets on wf 2\r\n\r\n* #17987 add filter key param and remove force push\r\n\r\n* #17987 fix java doc\r\n\r\n* #17987 dropdown for filter\r\n\r\n* #17987 dojoType and style to select\r\n\r\n* #17987 tests\r\n\r\n* #17987 test for getParameters\r\n\r\n* #17987 dropdown env and test\r\n\r\n* fix test\r\n\r\n* #17987 rollback to env selector, since it should allow multiple env\r\n\r\n* #17987 feedback changes\r\n\r\nCo-authored-by: jdotcms <jonathan.sanchez@dotcms.com>", "committedDate": "2020-05-14T15:38:52Z", "type": "commit"}, {"oid": "a2e2a96762647ff6927fe66d0848ce0b8ee7a93c", "url": "https://github.com/dotCMS/core/commit/a2e2a96762647ff6927fe66d0848ce0b8ee7a93c", "message": "merge master", "committedDate": "2020-05-14T18:00:39Z", "type": "commit"}, {"oid": "cdf576a198511562cb24aa36e0f151f02153c900", "url": "https://github.com/dotCMS/core/commit/cdf576a198511562cb24aa36e0f151f02153c900", "message": "feedback", "committedDate": "2020-05-14T18:06:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTI1NDgwNA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r431254804", "bodyText": "is there a way to fix this test without using a sleep?", "author": "nollymar", "createdAt": "2020-05-27T15:57:59Z", "path": "dotCMS/src/integration-test/java/com/dotcms/content/elasticsearch/business/ContentletIndexAPIImplTest.java", "diffHunk": "@@ -557,7 +557,7 @@ public void removeContentFromIndexByStructureInode () throws Exception {\n \n             int x=0;\n             do {\n-                Thread.sleep(200);\n+                Thread.sleep(5000);", "originalCommit": "cdf576a198511562cb24aa36e0f151f02153c900", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM3Mzc5Mg==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r431373792", "bodyText": "This test was not related to the PP filters, but it fails sporadically in master. When I tried to debug it, it succeeded. So I increase the sleep as a temporary fix (did not want to spend a lot of time here since it's not related to the task), this test is in the doc of tests that fail sporadically so when all those tests are attacked we can take another look to search another approach.", "author": "erickgonzalez", "createdAt": "2020-05-27T19:01:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTI1NDgwNA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "f5f5f5d1d5629f7c1b8c19b50e3941cd2181adf8", "url": "https://github.com/dotCMS/core/commit/f5f5f5d1d5629f7c1b8c19b50e3941cd2181adf8", "message": "merge master", "committedDate": "2020-05-27T16:11:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM0ODMwNQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r431348305", "bodyText": "Avoid methods with more than 4/5 parameters. It gets too confusing. Create an object instead, probably using the Builder pattern to build it, which give you named methods) and then pass it to this method.", "author": "dsilvam", "createdAt": "2020-05-27T18:15:36Z", "path": "dotCMS/src/integration-test/java/com/dotcms/enterprise/publishing/remote/DependencyBundlerTest.java", "diffHunk": "@@ -0,0 +1,572 @@\n+package com.dotcms.enterprise.publishing.remote;\n+\n+import static com.dotcms.rendering.velocity.directive.ParseContainer.getDotParserContainerUUID;\n+\n+import com.dotcms.IntegrationTestBase;\n+import com.dotcms.LicenseTestUtil;\n+import com.dotcms.contenttype.model.field.Field;\n+import com.dotcms.contenttype.model.field.FieldBuilder;\n+import com.dotcms.contenttype.model.field.RelationshipField;\n+import com.dotcms.contenttype.model.type.BaseContentType;\n+import com.dotcms.contenttype.model.type.ContentType;\n+import com.dotcms.datagen.ContainerDataGen;\n+import com.dotcms.datagen.FolderDataGen;\n+import com.dotcms.datagen.HTMLPageDataGen;\n+import com.dotcms.datagen.TemplateDataGen;\n+import com.dotcms.datagen.TestDataUtils;\n+import com.dotcms.publisher.bundle.bean.Bundle;\n+import com.dotcms.publisher.bundle.business.BundleAPI;\n+import com.dotcms.publisher.business.DotPublisherException;\n+import com.dotcms.publisher.business.PublishQueueElement;\n+import com.dotcms.publisher.business.PublisherAPI;\n+import com.dotcms.publisher.pusher.PushPublisher;\n+import com.dotcms.publisher.pusher.PushPublisherConfig;\n+import com.dotcms.publisher.util.PublisherUtil;\n+import com.dotcms.publishing.BundlerStatus;\n+import com.dotcms.publishing.BundlerUtil;\n+import com.dotcms.publishing.DotBundleException;\n+import com.dotcms.publishing.DotPublishingException;\n+import com.dotcms.publishing.FilterDescriptor;\n+import com.dotcms.publishing.IBundler;\n+import com.dotcms.publishing.Publisher;\n+import com.dotcms.publishing.PublisherConfig.Operation;\n+import com.dotcms.util.CollectionsUtils;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.MultiTree;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.containers.model.Container;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.dotmarketing.portlets.folders.model.Folder;\n+import com.dotmarketing.portlets.htmlpageasset.model.HTMLPageAsset;\n+import com.dotmarketing.portlets.structure.model.Relationship;\n+import com.dotmarketing.portlets.templates.model.Template;\n+import com.dotmarketing.util.Logger;\n+import com.dotmarketing.util.UUIDGenerator;\n+import com.dotmarketing.util.UtilMethods;\n+import com.dotmarketing.util.WebKeys.Relationship.RELATIONSHIP_CARDINALITY;\n+import com.liferay.portal.model.User;\n+import io.vavr.API;\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.junit.Assert;\n+\n+public class DependencyBundlerTest extends IntegrationTestBase {\n+\n+    private static User systemUser;\n+    private static String defaultFilterKey = \"Intelligent.yml\";\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {\n+\n+        //Setting web app environment\n+        IntegrationTestInitService.getInstance().init();\n+        LicenseTestUtil.getLicense();\n+\n+        systemUser = APILocator.getUserAPI().getSystemUser();\n+        createFilterDescriptor(defaultFilterKey,true,true,false,null,null,null,null,true);\n+    }\n+\n+    /**\n+     * Creates and saves bundle\n+     * @param bundleName\n+     * @return a bundle\n+     * @throws DotDataException\n+     */\n+    private static Bundle createBundle (final String bundleName, final boolean forcePush,final String filterKey)\n+            throws DotDataException {\n+\n+        final BundleAPI bundleAPI         = APILocator.getBundleAPI();\n+        final Bundle     bundle1           = new Bundle(bundleName, null, null, systemUser.getUserId(),forcePush,filterKey);\n+\n+        bundleAPI.saveBundle(bundle1);\n+        return bundle1;\n+    }\n+\n+    /**\n+     * Creates a Filter and adds it to map of filters\n+     *\n+     * @param key\n+     * @param dependencies\n+     * @param relationships\n+     * @param forcePush\n+     * @param excludeClasses\n+     * @param excludeDependencyClasses\n+     * @param excludeQuery\n+     * @param excludeDependencyQuery\n+     * @param defaultFilter\n+     */\n+    private static void createFilterDescriptor(final String key, final boolean dependencies,\n+            final boolean relationships, final boolean forcePush,\n+            final List<Object> excludeClasses, final List<Object> excludeDependencyClasses,\n+            final String excludeQuery, final String excludeDependencyQuery, final boolean defaultFilter){", "originalCommit": "f5f5f5d1d5629f7c1b8c19b50e3941cd2181adf8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6487fe139932b9740065dd125e56be3a12c6905b", "chunk": "diff --git a/dotCMS/src/integration-test/java/com/dotcms/enterprise/publishing/remote/DependencyBundlerTest.java b/dotCMS/src/integration-test/java/com/dotcms/enterprise/publishing/remote/DependencyBundlerTest.java\nindex 3e126d1665..a38640a706 100644\n--- a/dotCMS/src/integration-test/java/com/dotcms/enterprise/publishing/remote/DependencyBundlerTest.java\n+++ b/dotCMS/src/integration-test/java/com/dotcms/enterprise/publishing/remote/DependencyBundlerTest.java\n\n@@ -104,7 +104,7 @@ public class DependencyBundlerTest extends IntegrationTestBase {\n      * @param excludeDependencyQuery\n      * @param defaultFilter\n      */\n-    private static void createFilterDescriptor(final String key, final boolean dependencies,\n+    private static void createFilterDescriptor(final String key, final boolean dependencies,//CREATE BUILDER PARA EVITAR METODO CON TANTOS PARAMS\n             final boolean relationships, final boolean forcePush,\n             final List<Object> excludeClasses, final List<Object> excludeDependencyClasses,\n             final String excludeQuery, final String excludeDependencyQuery, final boolean defaultFilter){\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ2MDE4Ng==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r431460186", "bodyText": "the excludeClassesList seems unnecessary here", "author": "dsilvam", "createdAt": "2020-05-27T21:44:26Z", "path": "dotCMS/src/integration-test/java/com/dotcms/enterprise/publishing/remote/DependencyBundlerTest.java", "diffHunk": "@@ -0,0 +1,572 @@\n+package com.dotcms.enterprise.publishing.remote;\n+\n+import static com.dotcms.rendering.velocity.directive.ParseContainer.getDotParserContainerUUID;\n+\n+import com.dotcms.IntegrationTestBase;\n+import com.dotcms.LicenseTestUtil;\n+import com.dotcms.contenttype.model.field.Field;\n+import com.dotcms.contenttype.model.field.FieldBuilder;\n+import com.dotcms.contenttype.model.field.RelationshipField;\n+import com.dotcms.contenttype.model.type.BaseContentType;\n+import com.dotcms.contenttype.model.type.ContentType;\n+import com.dotcms.datagen.ContainerDataGen;\n+import com.dotcms.datagen.FolderDataGen;\n+import com.dotcms.datagen.HTMLPageDataGen;\n+import com.dotcms.datagen.TemplateDataGen;\n+import com.dotcms.datagen.TestDataUtils;\n+import com.dotcms.publisher.bundle.bean.Bundle;\n+import com.dotcms.publisher.bundle.business.BundleAPI;\n+import com.dotcms.publisher.business.DotPublisherException;\n+import com.dotcms.publisher.business.PublishQueueElement;\n+import com.dotcms.publisher.business.PublisherAPI;\n+import com.dotcms.publisher.pusher.PushPublisher;\n+import com.dotcms.publisher.pusher.PushPublisherConfig;\n+import com.dotcms.publisher.util.PublisherUtil;\n+import com.dotcms.publishing.BundlerStatus;\n+import com.dotcms.publishing.BundlerUtil;\n+import com.dotcms.publishing.DotBundleException;\n+import com.dotcms.publishing.DotPublishingException;\n+import com.dotcms.publishing.FilterDescriptor;\n+import com.dotcms.publishing.IBundler;\n+import com.dotcms.publishing.Publisher;\n+import com.dotcms.publishing.PublisherConfig.Operation;\n+import com.dotcms.util.CollectionsUtils;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.MultiTree;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.containers.model.Container;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.dotmarketing.portlets.folders.model.Folder;\n+import com.dotmarketing.portlets.htmlpageasset.model.HTMLPageAsset;\n+import com.dotmarketing.portlets.structure.model.Relationship;\n+import com.dotmarketing.portlets.templates.model.Template;\n+import com.dotmarketing.util.Logger;\n+import com.dotmarketing.util.UUIDGenerator;\n+import com.dotmarketing.util.UtilMethods;\n+import com.dotmarketing.util.WebKeys.Relationship.RELATIONSHIP_CARDINALITY;\n+import com.liferay.portal.model.User;\n+import io.vavr.API;\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.junit.Assert;\n+\n+public class DependencyBundlerTest extends IntegrationTestBase {\n+\n+    private static User systemUser;\n+    private static String defaultFilterKey = \"Intelligent.yml\";\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {\n+\n+        //Setting web app environment\n+        IntegrationTestInitService.getInstance().init();\n+        LicenseTestUtil.getLicense();\n+\n+        systemUser = APILocator.getUserAPI().getSystemUser();\n+        createFilterDescriptor(defaultFilterKey,true,true,false,null,null,null,null,true);\n+    }\n+\n+    /**\n+     * Creates and saves bundle\n+     * @param bundleName\n+     * @return a bundle\n+     * @throws DotDataException\n+     */\n+    private static Bundle createBundle (final String bundleName, final boolean forcePush,final String filterKey)\n+            throws DotDataException {\n+\n+        final BundleAPI bundleAPI         = APILocator.getBundleAPI();\n+        final Bundle     bundle1           = new Bundle(bundleName, null, null, systemUser.getUserId(),forcePush,filterKey);\n+\n+        bundleAPI.saveBundle(bundle1);\n+        return bundle1;\n+    }\n+\n+    /**\n+     * Creates a Filter and adds it to map of filters\n+     *\n+     * @param key\n+     * @param dependencies\n+     * @param relationships\n+     * @param forcePush\n+     * @param excludeClasses\n+     * @param excludeDependencyClasses\n+     * @param excludeQuery\n+     * @param excludeDependencyQuery\n+     * @param defaultFilter\n+     */\n+    private static void createFilterDescriptor(final String key, final boolean dependencies,\n+            final boolean relationships, final boolean forcePush,\n+            final List<Object> excludeClasses, final List<Object> excludeDependencyClasses,\n+            final String excludeQuery, final String excludeDependencyQuery, final boolean defaultFilter){\n+        final Map<String,Object> filtersMap = new HashMap<>();\n+        if(UtilMethods.isSet(dependencies)) {\n+            filtersMap.put(\"dependencies\", dependencies);\n+        }\n+        if(UtilMethods.isSet(relationships)) {\n+            filtersMap.put(\"relationships\", relationships);\n+        }\n+        if(UtilMethods.isSet(forcePush)) {\n+            filtersMap.put(\"forcePush\", forcePush);\n+        }\n+        if(UtilMethods.isSet(excludeClasses)) {\n+            filtersMap.put(\"excludeClasses\", excludeClasses);\n+        }\n+        if(UtilMethods.isSet(excludeDependencyClasses)) {\n+            filtersMap.put(\"excludeDependencyClasses\", excludeDependencyClasses);\n+        }\n+        if(UtilMethods.isSet(excludeQuery)) {\n+            filtersMap.put(\"excludeQuery\", excludeQuery);\n+        }\n+        if(UtilMethods.isSet(excludeDependencyQuery)) {\n+            filtersMap.put(\"excludeDependencyQuery\", excludeDependencyQuery);\n+        }\n+        APILocator.getPublisherAPI().addFilterDescriptor(new FilterDescriptor(key,key,filtersMap,defaultFilter,\"DOTCMS_BACK_END_USER\"));\n+    }\n+\n+    /**\n+     * Generate a bundle and returns a PushPublisherConfig to retrieve the list of objects that make up\n+     * the bundle, organized by their types.\n+     */\n+    private static PushPublisherConfig generateBundle ( final String bundleId, final PushPublisherConfig.Operation operation )\n+            throws DotPublisherException, DotDataException, DotPublishingException, IllegalAccessException, InstantiationException, DotBundleException, IOException {\n+\n+        final PushPublisherConfig pconf = new PushPublisherConfig();\n+        final PublisherAPI pubAPI = PublisherAPI.getInstance();\n+\n+        final List<PublishQueueElement> tempBundleContents = pubAPI\n+                .getQueueElementsByBundleId(bundleId);\n+        final List<PublishQueueElement> assetsToPublish = new ArrayList<PublishQueueElement>();\n+\n+        for (final PublishQueueElement queueElement : tempBundleContents) {\n+            assetsToPublish.add(queueElement);\n+        }\n+\n+        pconf.setDownloading(true);\n+        pconf.setOperation(operation);\n+\n+        pconf.setAssets(assetsToPublish);\n+        //Queries creation\n+        pconf.setLuceneQueries(PublisherUtil.prepareQueries(tempBundleContents));\n+        pconf.setId(bundleId);\n+        pconf.setUser(APILocator.getUserAPI().getSystemUser());\n+\n+        //BUNDLERS\n+\n+        final List<Class<IBundler>> bundlers = new ArrayList<>();\n+        final List<IBundler> confBundlers = new ArrayList<IBundler>();\n+\n+        final Publisher publisher = new PushPublisher();\n+        publisher.init(pconf);\n+        //Add the bundles for this publisher\n+        for (final Class<IBundler> clazz : publisher.getBundlers()) {\n+            if (!bundlers.contains(clazz)) {\n+                bundlers.add(clazz);\n+            }\n+        }\n+\n+        final File bundleRoot = BundlerUtil.getBundleRoot(pconf);\n+\n+        // Run bundlers\n+        BundlerUtil.writeBundleXML(pconf);\n+        for (final Class<IBundler> aClass : bundlers) {\n+\n+            final IBundler bundler = aClass.newInstance();\n+            confBundlers.add(bundler);\n+            bundler.setConfig(pconf);\n+            bundler.setPublisher(publisher);\n+            final BundlerStatus bundlerStatus = new BundlerStatus(bundler.getClass().getName());\n+            //Generate the bundler\n+            Logger.info(DependencyBundlerTest.class, \"Start of Bundler: \" + aClass.getSimpleName());\n+            bundler.generate(bundleRoot, bundlerStatus);\n+            Logger.info(DependencyBundlerTest.class, \"End of Bundler: \" + aClass.getSimpleName());\n+        }\n+\n+        pconf.setBundlers(confBundlers);\n+\n+        return pconf;\n+    }\n+\n+    /**\n+     * This test is for the filter excludeDependencyClasses.\n+     *\n+     * This test creates a Content Type and a content, and generates the bundle using the default Filter (this one does not have any exclude filter set),\n+     * so the content and the content type (as a dependency) will be added.\n+     * After this using the same Content Type and content generates another bundle but using a new created filter that exclude ContentTypes to be pushed\n+     * as a dependency, so in the bundle the content will be added but the content type will not.\n+     */\n+    @Test\n+    public void testGenerateBundleWithFilter_ExcludeDependencyClasses_ContentTypeWorkflow_NotAdded()\n+            throws DotDataException, IllegalAccessException, DotBundleException, DotPublishingException, InstantiationException, DotPublisherException, IOException {\n+        //Create ContentType\n+        final ContentType contentType = TestDataUtils.getWikiLikeContentType();\n+        //Create Content\n+        final Contentlet content = TestDataUtils.getWikiContent(true,APILocator.getLanguageAPI().getDefaultLanguage().getId(),contentType.id());\n+\n+        //Create bundle with DefaultFilter\n+        final Bundle bundleWithDefaultFilter = createBundle(\"TestBundle\"+System.currentTimeMillis(),false,defaultFilterKey);\n+        //Add assets to the bundle\n+        PublisherAPI.getInstance().saveBundleAssets(Arrays.asList(content.getIdentifier()),bundleWithDefaultFilter.getId(),\n+                systemUser);\n+        //Generate Bundle, will return several dependencySet with the assets that will be added to the bundle\n+        final PushPublisherConfig listOfAssetsWithDefaultFilter = generateBundle(bundleWithDefaultFilter.getId(), Operation.PUBLISH);\n+        Assert.assertNotNull(listOfAssetsWithDefaultFilter);\n+        Assert.assertFalse(listOfAssetsWithDefaultFilter.getStructures().isEmpty());\n+        Assert.assertTrue(listOfAssetsWithDefaultFilter.getStructures().contains(contentType.id()));\n+        Assert.assertTrue(listOfAssetsWithDefaultFilter.getContentlets().contains(content.getIdentifier()));\n+\n+        //Create filter\n+        final String filterKey = \"TestFilterWithExcludeDependencyClasses.yml\";\n+        final List<Object> excludeDependencyClassesList = new ArrayList<>();\n+        excludeDependencyClassesList.add(\"ContentType\");\n+        excludeDependencyClassesList.add(\"Workflow\");\n+        createFilterDescriptor(filterKey,true,true,false,\n+                null,excludeDependencyClassesList,null,null,false);\n+        //Create bundle with New filter\n+        final Bundle bundleWithNewFilter = createBundle(\"TestBundle\"+System.currentTimeMillis(),false,filterKey);\n+        //Add assets to the bundle\n+        PublisherAPI.getInstance().saveBundleAssets(Arrays.asList(content.getIdentifier()),bundleWithNewFilter.getId(),\n+                systemUser);\n+        //Generate Bundle, will return several dependencySet with the assets that will be added to the bundle\n+        final PushPublisherConfig listOfAssetsWithNewFilter = generateBundle(bundleWithNewFilter.getId(), Operation.PUBLISH);\n+        Assert.assertNotNull(listOfAssetsWithNewFilter);\n+        Assert.assertTrue(listOfAssetsWithNewFilter.getStructures().isEmpty());\n+        Assert.assertTrue(listOfAssetsWithNewFilter.getContentlets().contains(content.getIdentifier()));\n+    }\n+\n+    /**\n+     * This test is for the filter excludeClasses.\n+     *\n+     * This test creates a Template and a Container, and generates the bundle using the default Filter (this one does not have any exclude filter set),\n+     * so the Template and the Container will be added (both assets added manually).\n+     * After this using the same Template and Container generates another bundle but using a new created filter that exclude Template and Container to be pushed,\n+     * so in the bundle neither the Template nor the Container will be added.\n+     */\n+    @Test\n+    public void testGenerateBundleWithFilter_ExcludeClasses_TemplateContainer_NotAdded()\n+            throws DotDataException, IllegalAccessException, DotBundleException, DotPublishingException, InstantiationException, DotPublisherException, IOException {\n+        //Create Container\n+        final Container container = new ContainerDataGen().nextPersisted();\n+        //Create Template\n+        final Template template = new TemplateDataGen().nextPersisted();\n+\n+        //Create bundle with DefaultFilter\n+        final Bundle bundleWithDefaultFilter = createBundle(\"TestBundle\"+System.currentTimeMillis(),false,defaultFilterKey);\n+        //Add assets to the bundle\n+        PublisherAPI.getInstance().saveBundleAssets(Arrays.asList(template.getIdentifier(),container.getIdentifier()),bundleWithDefaultFilter.getId(),\n+                systemUser);\n+        //Generate Bundle, will return several dependencySet with the assets that will be added to the bundle\n+        final PushPublisherConfig listOfAssetsWithDefaultFilter = generateBundle(bundleWithDefaultFilter.getId(), Operation.PUBLISH);\n+        Assert.assertNotNull(listOfAssetsWithDefaultFilter);\n+        Assert.assertFalse(listOfAssetsWithDefaultFilter.getTemplates().isEmpty());\n+        Assert.assertFalse(listOfAssetsWithDefaultFilter.getContainers().isEmpty());\n+        Assert.assertTrue(listOfAssetsWithDefaultFilter.getTemplates().contains(template.getIdentifier()));\n+        Assert.assertTrue(listOfAssetsWithDefaultFilter.getContainers().contains(container.getIdentifier()));\n+\n+        //Create filter\n+        final String filterKey = \"TestFilterWithExcludeClasses.yml\";\n+        final List<Object> excludeClassesList = new ArrayList<>();\n+        excludeClassesList.add(\"Template\");\n+        excludeClassesList.add(\"Containers\");\n+        createFilterDescriptor(filterKey,true,true,false,\n+                excludeClassesList,null,null,null,false);\n+        //Create bundle with New filter\n+        final Bundle bundleWithNewFilter = createBundle(\"TestBundle\"+System.currentTimeMillis(),false,filterKey);\n+        //Add assets to the bundle\n+        PublisherAPI.getInstance().saveBundleAssets(Arrays.asList(template.getIdentifier(),container.getIdentifier()),bundleWithNewFilter.getId(),\n+                systemUser);\n+        //Generate Bundle, will return several dependencySet with the assets that will be added to the bundle\n+        final PushPublisherConfig listOfAssetsWithNewFilter = generateBundle(bundleWithNewFilter.getId(), Operation.PUBLISH);\n+        Assert.assertNotNull(listOfAssetsWithNewFilter);\n+        Assert.assertTrue(listOfAssetsWithNewFilter.getTemplates().isEmpty());\n+        Assert.assertTrue(listOfAssetsWithNewFilter.getContainers().isEmpty());\n+    }\n+\n+    /**\n+     * This test is for the filter excludeDependencyQuery\n+     *\n+     * This test creates 2 Content Types with a Relationship field, creates 2 content one of each Content Type and Relates them,\n+     * generates the bundle using the default Filter (this one does not have any exclude filter set),\n+     * so the both ContentTypes and content will be added (Content Types and child content as a dependency since only pushing the parent content).\n+     * After this using the same assets generates another bundle but using a new created filter that exclude content from the child Content Type to be pushed,\n+     * so in the bundle will be the parent and child Content Type and the parent content.\n+     */\n+    @Test\n+    public void testGenerateBundleWithFilter_ExcludeDependencyQuery_ContentFromChildContentType_NotAdded()\n+            throws DotDataException, IllegalAccessException, DotBundleException, DotPublishingException, InstantiationException, DotPublisherException, IOException, DotSecurityException {\n+        //Create child Content Type\n+        final ContentType childContentType = TestDataUtils.getNewsLikeContentType();\n+        //Create parent Content Type\n+        final ContentType parentContentType = TestDataUtils.getWikiLikeContentType();\n+        //Relate Content Types\n+        Field newField = FieldBuilder.builder(RelationshipField.class).name(\"chilCT_parentCT\" + System.currentTimeMillis())\n+                .contentTypeId(parentContentType.id()).values(String.valueOf(\n+                        RELATIONSHIP_CARDINALITY.MANY_TO_MANY.ordinal()))\n+                .relationType(childContentType.variable()).build();\n+        newField = APILocator.getContentTypeFieldAPI().save(newField, systemUser);\n+        //Create child content\n+        final Contentlet childContentlet = TestDataUtils.getNewsContent(true,APILocator.getLanguageAPI().getDefaultLanguage().getId(),childContentType.id());\n+        //Create parent content\n+        Contentlet parentContentlet = TestDataUtils.getWikiContent(false,APILocator.getLanguageAPI().getDefaultLanguage().getId(),parentContentType.id());\n+        //Relate contents\n+        final Relationship relationship = APILocator.getRelationshipAPI().getRelationshipFromField(newField,systemUser);\n+        parentContentlet = APILocator.getContentletAPI().checkin(parentContentlet,\n+                CollectionsUtils.map(relationship, CollectionsUtils.list(childContentlet)), systemUser,\n+                false);\n+\n+        //Create bundle with DefaultFilter\n+        final Bundle bundleWithDefaultFilter = createBundle(\"TestBundle\"+System.currentTimeMillis(),false,defaultFilterKey);\n+        //Add assets to the bundle\n+        PublisherAPI.getInstance().saveBundleAssets(Arrays.asList(parentContentlet.getIdentifier()),bundleWithDefaultFilter.getId(),\n+                systemUser);\n+        //Generate Bundle, will return several dependencySet with the assets that will be added to the bundle\n+        final PushPublisherConfig listOfAssetsWithDefaultFilter = generateBundle(bundleWithDefaultFilter.getId(), Operation.PUBLISH);\n+        Assert.assertNotNull(listOfAssetsWithDefaultFilter);\n+        Assert.assertFalse(listOfAssetsWithDefaultFilter.getStructures().isEmpty());\n+        Assert.assertTrue(listOfAssetsWithDefaultFilter.getStructures().contains(parentContentType.id()));\n+        Assert.assertTrue(listOfAssetsWithDefaultFilter.getStructures().contains(childContentType.id()));\n+        Assert.assertFalse(listOfAssetsWithDefaultFilter.getContentlets().isEmpty());\n+        Assert.assertTrue(listOfAssetsWithDefaultFilter.getContentlets().contains(parentContentlet.getIdentifier()));\n+        Assert.assertTrue(listOfAssetsWithDefaultFilter.getContentlets().contains(childContentlet.getIdentifier()));\n+        Assert.assertFalse(listOfAssetsWithDefaultFilter.getRelationships().isEmpty());\n+        Assert.assertTrue(listOfAssetsWithDefaultFilter.getRelationships().contains(relationship.getInode()));\n+\n+        //Create filter\n+        final String filterKey = \"TestFilterWithExcludeDependencyQuery.yml\";\n+        final String excludeDependencyQuery = \"+contentType:\"+childContentType.variable();\n+        createFilterDescriptor(filterKey,true,true,false,\n+                null,null,null,excludeDependencyQuery,false);\n+        //Create bundle with New filter\n+        final Bundle bundleWithNewFilter = createBundle(\"TestBundle\"+System.currentTimeMillis(),false,filterKey);\n+        //Add assets to the bundle\n+        PublisherAPI.getInstance().saveBundleAssets(Arrays.asList(parentContentlet.getIdentifier()),bundleWithNewFilter.getId(),\n+                systemUser);\n+        //Generate Bundle, will return several dependencySet with the assets that will be added to the bundle\n+        final PushPublisherConfig listOfAssetsWithNewFilter = generateBundle(bundleWithNewFilter.getId(), Operation.PUBLISH);\n+        Assert.assertNotNull(listOfAssetsWithNewFilter);\n+        Assert.assertFalse(listOfAssetsWithNewFilter.getStructures().isEmpty());\n+        Assert.assertTrue(listOfAssetsWithNewFilter.getStructures().contains(parentContentType.id()));\n+        Assert.assertTrue(listOfAssetsWithNewFilter.getStructures().contains(childContentType.id()));\n+        Assert.assertFalse(listOfAssetsWithNewFilter.getContentlets().isEmpty());\n+        Assert.assertTrue(listOfAssetsWithNewFilter.getContentlets().contains(parentContentlet.getIdentifier()));\n+        Assert.assertFalse(listOfAssetsWithNewFilter.getContentlets().contains(childContentlet.getIdentifier()));\n+        Assert.assertFalse(listOfAssetsWithNewFilter.getRelationships().isEmpty());\n+        Assert.assertTrue(listOfAssetsWithNewFilter.getRelationships().contains(relationship.getInode()));\n+    }\n+\n+    /**\n+     * This test is for the filter excludeQuery\n+     *\n+     * This test creates 2 Content Types (one Widget and one Content), creates one content of each one,\n+     * generates the bundle using the default Filter (this one does not have any exclude filter set),\n+     * and tries to push each content, so the both ContentTypes and content will be added.\n+     * After this using the same assets generates another bundle but using a new created filter that exclude content from the baseType Widget to be pushed,\n+     * so in the bundle will be only the content and the ContentType of the baseType Content.\n+     */\n+    @Test\n+    public void testGenerateBundleWithFilter_ExcludeQuery_BaseTypeWidget_NotAdded()\n+            throws DotDataException, IllegalAccessException, DotBundleException, DotPublishingException, InstantiationException, DotPublisherException, IOException, DotSecurityException {\n+        //Create Widget ContentType\n+        final ContentType widgetContentType = TestDataUtils.getWidgetLikeContentType();\n+        //Create Content ContentType\n+        final ContentType contentContentType = TestDataUtils.getWikiLikeContentType();\n+        //Create Widget contentlet\n+        final Contentlet widgetContentlet = TestDataUtils.getWidgetContent(true,APILocator.getLanguageAPI().getDefaultLanguage().getId(),widgetContentType.id());\n+        //Create Content contentlet\n+        final Contentlet contentContentlet = TestDataUtils.getWikiContent(true, APILocator.getLanguageAPI().getDefaultLanguage().getId(),contentContentType.id());\n+\n+        //Create bundle with DefaultFilter\n+        final Bundle bundleWithDefaultFilter = createBundle(\"TestBundle\"+System.currentTimeMillis(),false,defaultFilterKey);\n+        //Add assets to the bundle\n+        PublisherAPI.getInstance().saveBundleAssets(Arrays.asList(contentContentlet.getIdentifier(),widgetContentlet.getIdentifier()),bundleWithDefaultFilter.getId(),\n+                systemUser);\n+        //Generate Bundle, will return several dependencySet with the assets that will be added to the bundle\n+        final PushPublisherConfig listOfAssetsWithDefaultFilter = generateBundle(bundleWithDefaultFilter.getId(), Operation.PUBLISH);\n+        Assert.assertNotNull(listOfAssetsWithDefaultFilter);\n+        Assert.assertFalse(listOfAssetsWithDefaultFilter.getStructures().isEmpty());\n+        Assert.assertTrue(listOfAssetsWithDefaultFilter.getStructures().contains(contentContentType.id()));\n+        Assert.assertTrue(listOfAssetsWithDefaultFilter.getStructures().contains(widgetContentType.id()));\n+        Assert.assertFalse(listOfAssetsWithDefaultFilter.getContentlets().isEmpty());\n+        Assert.assertTrue(listOfAssetsWithDefaultFilter.getContentlets().contains(contentContentlet.getIdentifier()));\n+        Assert.assertTrue(listOfAssetsWithDefaultFilter.getContentlets().contains(widgetContentlet.getIdentifier()));\n+\n+        //Create filter\n+        final String filterKey = \"TestFilterWithExcludeQuery.yml\";\n+        final String excludeQuery = \"+baseType:\"+ BaseContentType.WIDGET.getType();\n+        createFilterDescriptor(filterKey,true,true,false,\n+                null,null,excludeQuery,null,false);\n+        //Create bundle with New filter\n+        final Bundle bundleWithNewFilter = createBundle(\"TestBundle\"+System.currentTimeMillis(),false,filterKey);\n+        //Add assets to the bundle\n+        PublisherAPI.getInstance().saveBundleAssets(Arrays.asList(contentContentlet.getIdentifier(),widgetContentlet.getIdentifier()),bundleWithNewFilter.getId(),\n+                systemUser);\n+        //Generate Bundle, will return several dependencySet with the assets that will be added to the bundle\n+        final PushPublisherConfig listOfAssetsWithNewFilter = generateBundle(bundleWithNewFilter.getId(), Operation.PUBLISH);\n+        Assert.assertNotNull(listOfAssetsWithNewFilter);\n+        Assert.assertFalse(listOfAssetsWithNewFilter.getStructures().isEmpty());\n+        Assert.assertTrue(listOfAssetsWithNewFilter.getStructures().contains(contentContentType.id()));\n+        Assert.assertFalse(listOfAssetsWithNewFilter.getStructures().contains(widgetContentType.id()));\n+        Assert.assertFalse(listOfAssetsWithNewFilter.getContentlets().isEmpty());\n+        Assert.assertTrue(listOfAssetsWithNewFilter.getContentlets().contains(contentContentlet.getIdentifier()));\n+        Assert.assertFalse(listOfAssetsWithNewFilter.getContentlets().contains(widgetContentlet.getIdentifier()));\n+    }\n+\n+    /**\n+     * This test is for the filter dependencies.\n+     *\n+     * This test creates a Template, a Container, a Folder, a Page, a ContentType and a contentlet\n+     * and generates the bundle using the default Filter (this one does not have any exclude filter set),\n+     * by pushing the Page (by dependency it will pull everything else Contentlet, ContentType, Container, Template, Folder).\n+     * After this using the same assets generates another bundle but using a new created filter that exclude any dependency to be pushed,\n+     * so in the bundle there is nothing else but the Page.\n+     */\n+    @Test\n+    public void testGenerateBundleWithFilter_DependenciesFalse_TemplateContainerFolderContenttypeContentlet_NotAdded()\n+            throws DotDataException, IllegalAccessException, DotBundleException, DotPublishingException, InstantiationException, DotPublisherException, IOException {\n+        //Create Content Type\n+        final ContentType contentType = TestDataUtils.getWikiLikeContentType();\n+        //Create Container\n+        final Container container = new ContainerDataGen().withContentType(contentType,\"!{title}\").nextPersisted();\n+        //Create Template\n+        final String uuid = UUIDGenerator.generateUuid();\n+        final Template template = new TemplateDataGen().withContainer(container.getIdentifier(),uuid).nextPersisted();\n+        //Create contentlet\n+        final Contentlet contentlet = TestDataUtils.getWikiContent(true,APILocator.getLanguageAPI().getDefaultLanguage().getId(),contentType.id());\n+        //Create Folder\n+        final Folder folder = new FolderDataGen().nextPersisted();\n+        //Create Page\n+        final HTMLPageAsset page = new HTMLPageDataGen(folder,template).languageId(APILocator.getLanguageAPI().getDefaultLanguage().getId())\n+                .nextPersisted();\n+        HTMLPageDataGen.publish(page);\n+        //Add Contentlet to Page\n+        final MultiTree multiTree = new MultiTree(page.getIdentifier(),\n+                container.getIdentifier(),\n+                contentlet.getIdentifier(), getDotParserContainerUUID(uuid), 0);\n+        APILocator.getMultiTreeAPI().saveMultiTree(multiTree);\n+\n+        //Create bundle with DefaultFilter\n+        final Bundle bundleWithDefaultFilter = createBundle(\"TestBundle\"+System.currentTimeMillis(),false,defaultFilterKey);\n+        //Add assets to the bundle\n+        PublisherAPI.getInstance().saveBundleAssets(Arrays.asList(page.getIdentifier()),bundleWithDefaultFilter.getId(),\n+                systemUser);\n+        //Generate Bundle, will return several dependencySet with the assets that will be added to the bundle\n+        final PushPublisherConfig listOfAssetsWithDefaultFilter = generateBundle(bundleWithDefaultFilter.getId(), Operation.PUBLISH);\n+        Assert.assertNotNull(listOfAssetsWithDefaultFilter);\n+        Assert.assertFalse(listOfAssetsWithDefaultFilter.getStructures().isEmpty());\n+        Assert.assertTrue(listOfAssetsWithDefaultFilter.getStructures().contains(contentType.id()));\n+        Assert.assertTrue(listOfAssetsWithDefaultFilter.getStructures().contains(page.getContentType().id()));\n+        Assert.assertFalse(listOfAssetsWithDefaultFilter.getTemplates().isEmpty());\n+        Assert.assertTrue(listOfAssetsWithDefaultFilter.getTemplates().contains(template.getIdentifier()));\n+        Assert.assertFalse(listOfAssetsWithDefaultFilter.getContainers().isEmpty());\n+        Assert.assertTrue(listOfAssetsWithDefaultFilter.getContainers().contains(container.getIdentifier()));\n+        Assert.assertFalse(listOfAssetsWithDefaultFilter.getContentlets().isEmpty());\n+        Assert.assertTrue(listOfAssetsWithDefaultFilter.getContentlets().contains(contentlet.getIdentifier()));\n+        Assert.assertTrue(listOfAssetsWithDefaultFilter.getContentlets().contains(page.getIdentifier()));\n+        Assert.assertFalse(listOfAssetsWithDefaultFilter.getFolders().isEmpty());\n+        Assert.assertTrue(listOfAssetsWithDefaultFilter.getFolders().contains(folder.getInode()));\n+\n+\n+        //Create filter\n+        final String filterKey = \"TestFilterWithDependenciesFalse.yml\";\n+        final List<Object> excludeClassesList = new ArrayList<>();\n+        excludeClassesList.add(\"Template\");\n+        excludeClassesList.add(\"Containers\");\n+        createFilterDescriptor(filterKey,false,true,false,", "originalCommit": "f5f5f5d1d5629f7c1b8c19b50e3941cd2181adf8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM0MjMxMQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433342311", "bodyText": "done", "author": "erickgonzalez", "createdAt": "2020-06-01T16:18:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ2MDE4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "6487fe139932b9740065dd125e56be3a12c6905b", "chunk": "diff --git a/dotCMS/src/integration-test/java/com/dotcms/enterprise/publishing/remote/DependencyBundlerTest.java b/dotCMS/src/integration-test/java/com/dotcms/enterprise/publishing/remote/DependencyBundlerTest.java\nindex 3e126d1665..a38640a706 100644\n--- a/dotCMS/src/integration-test/java/com/dotcms/enterprise/publishing/remote/DependencyBundlerTest.java\n+++ b/dotCMS/src/integration-test/java/com/dotcms/enterprise/publishing/remote/DependencyBundlerTest.java\n\n@@ -104,7 +104,7 @@ public class DependencyBundlerTest extends IntegrationTestBase {\n      * @param excludeDependencyQuery\n      * @param defaultFilter\n      */\n-    private static void createFilterDescriptor(final String key, final boolean dependencies,\n+    private static void createFilterDescriptor(final String key, final boolean dependencies,//CREATE BUILDER PARA EVITAR METODO CON TANTOS PARAMS\n             final boolean relationships, final boolean forcePush,\n             final List<Object> excludeClasses, final List<Object> excludeDependencyClasses,\n             final String excludeQuery, final String excludeDependencyQuery, final boolean defaultFilter){\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ2MTQwNg==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r431461406", "bodyText": "expected result?", "author": "dsilvam", "createdAt": "2020-05-27T21:46:48Z", "path": "dotCMS/src/integration-test/java/com/dotcms/publisher/bundle/business/BundleFactoryTest.java", "diffHunk": "@@ -212,4 +214,36 @@ public void test_deleteAllAssetsFromBundle() throws DotDataException, DotPublish\n \n         bundleFactory.deleteBundle(bundleid);\n     }\n+\n+    @Test\n+    public void test_insertBundleWithFilterKey() throws DotDataException {", "originalCommit": "f5f5f5d1d5629f7c1b8c19b50e3941cd2181adf8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM0NDg5MQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433344891", "bodyText": "done", "author": "erickgonzalez", "createdAt": "2020-06-01T16:23:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ2MTQwNg=="}], "type": "inlineReview", "revised_code": {"commit": "6487fe139932b9740065dd125e56be3a12c6905b", "chunk": "diff --git a/dotCMS/src/integration-test/java/com/dotcms/publisher/bundle/business/BundleFactoryTest.java b/dotCMS/src/integration-test/java/com/dotcms/publisher/bundle/business/BundleFactoryTest.java\nindex cc94ca7603..deced7473c 100644\n--- a/dotCMS/src/integration-test/java/com/dotcms/publisher/bundle/business/BundleFactoryTest.java\n+++ b/dotCMS/src/integration-test/java/com/dotcms/publisher/bundle/business/BundleFactoryTest.java\n\n@@ -215,8 +215,14 @@ public class BundleFactoryTest {\n         bundleFactory.deleteBundle(bundleid);\n     }\n \n+    /**\n+     * Method to test: {@link BundleAPI#saveBundle(Bundle)}\n+     * Given Scenario: Create a new bundle with a filter key\n+     * ExpectedResult: the bundle should create without issues\n+     *\n+     */\n     @Test\n-    public void test_insertBundleWithFilterKey() throws DotDataException {\n+    public void test_insertBundleWithFilterKey_success() throws DotDataException {\n         final String uuid = UUIDGenerator.generateUuid();\n         Bundle bundle = new Bundle();\n         bundle.setId(uuid);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ2MTkyMA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r431461920", "bodyText": "expected result missing in name", "author": "dsilvam", "createdAt": "2020-05-27T21:47:52Z", "path": "dotCMS/src/integration-test/java/com/dotcms/publisher/bundle/business/BundleFactoryTest.java", "diffHunk": "@@ -212,4 +214,36 @@ public void test_deleteAllAssetsFromBundle() throws DotDataException, DotPublish\n \n         bundleFactory.deleteBundle(bundleid);\n     }\n+\n+    @Test\n+    public void test_insertBundleWithFilterKey() throws DotDataException {\n+        final String uuid = UUIDGenerator.generateUuid();\n+        Bundle bundle = new Bundle();\n+        bundle.setId(uuid);\n+        bundle.setName(\"testBundle\"+System.currentTimeMillis());\n+        bundle.setForcePush(false);\n+        bundle.setOwner(adminUser.getUserId());\n+        bundle.setPublishDate(new Date());\n+        bundle.setFilterKey(\"testFilter\");\n+        APILocator.getBundleAPI().saveBundle(bundle);\n+\n+        bundle = APILocator.getBundleAPI().getBundleById(uuid);\n+        assertEquals(\"testFilter\",bundle.getFilterKey());\n+    }\n+\n+    @Test\n+    public void test_insertBundleWithoutFilterKey() throws DotDataException {", "originalCommit": "f5f5f5d1d5629f7c1b8c19b50e3941cd2181adf8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM0NDk5Mw==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433344993", "bodyText": "done", "author": "erickgonzalez", "createdAt": "2020-06-01T16:24:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ2MTkyMA=="}], "type": "inlineReview", "revised_code": {"commit": "6487fe139932b9740065dd125e56be3a12c6905b", "chunk": "diff --git a/dotCMS/src/integration-test/java/com/dotcms/publisher/bundle/business/BundleFactoryTest.java b/dotCMS/src/integration-test/java/com/dotcms/publisher/bundle/business/BundleFactoryTest.java\nindex cc94ca7603..deced7473c 100644\n--- a/dotCMS/src/integration-test/java/com/dotcms/publisher/bundle/business/BundleFactoryTest.java\n+++ b/dotCMS/src/integration-test/java/com/dotcms/publisher/bundle/business/BundleFactoryTest.java\n\n@@ -215,8 +215,14 @@ public class BundleFactoryTest {\n         bundleFactory.deleteBundle(bundleid);\n     }\n \n+    /**\n+     * Method to test: {@link BundleAPI#saveBundle(Bundle)}\n+     * Given Scenario: Create a new bundle with a filter key\n+     * ExpectedResult: the bundle should create without issues\n+     *\n+     */\n     @Test\n-    public void test_insertBundleWithFilterKey() throws DotDataException {\n+    public void test_insertBundleWithFilterKey_success() throws DotDataException {\n         final String uuid = UUIDGenerator.generateUuid();\n         Bundle bundle = new Bundle();\n         bundle.setId(uuid);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ2Mjg3OQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r431462879", "bodyText": "expected result missing in test method name", "author": "dsilvam", "createdAt": "2020-05-27T21:49:53Z", "path": "dotCMS/src/integration-test/java/com/dotcms/publishing/PublisherAPITest.java", "diffHunk": "@@ -319,4 +326,293 @@ private FileFilter getNoBundleXMLFileFilter() {\n         return file -> !file.getAbsolutePath().endsWith(\"bundle.xml\");\n     }\n \n+    @Test\n+    public void test_addFilter(){", "originalCommit": "f5f5f5d1d5629f7c1b8c19b50e3941cd2181adf8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM0NzY4OA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433347688", "bodyText": "done", "author": "erickgonzalez", "createdAt": "2020-06-01T16:28:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ2Mjg3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "6487fe139932b9740065dd125e56be3a12c6905b", "chunk": "diff --git a/dotCMS/src/integration-test/java/com/dotcms/publishing/PublisherAPITest.java b/dotCMS/src/integration-test/java/com/dotcms/publishing/PublisherAPITest.java\nindex 2bc1f26be3..b03cc12d49 100644\n--- a/dotCMS/src/integration-test/java/com/dotcms/publishing/PublisherAPITest.java\n+++ b/dotCMS/src/integration-test/java/com/dotcms/publishing/PublisherAPITest.java\n\n@@ -326,8 +326,14 @@ public class PublisherAPITest extends IntegrationTestBase {\n         return file -> !file.getAbsolutePath().endsWith(\"bundle.xml\");\n     }\n \n+    /**\n+     * Method to test: {@link PublisherAPI#addFilterDescriptor(FilterDescriptor)}\n+     * Given Scenario: Create a new FilterDescriptor and add it to the FilterDescriptorMap\n+     * ExpectedResult: the filterDescriptor is added successfully to the map\n+     *\n+     */\n     @Test\n-    public void test_addFilter(){\n+    public void test_addFilter_success(){\n         publisherAPI.getFilterDescriptorMap().clear();\n \n         final Map<String,Object> filtersMap =\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ3OTk2Mw==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r431479963", "bodyText": "not needed?", "author": "dsilvam", "createdAt": "2020-05-27T22:32:02Z", "path": "dotCMS/src/integration-test/java/com/dotcms/publishing/PublisherAPITest.java", "diffHunk": "@@ -319,4 +326,293 @@ private FileFilter getNoBundleXMLFileFilter() {\n         return file -> !file.getAbsolutePath().endsWith(\"bundle.xml\");\n     }\n \n+    @Test\n+    public void test_addFilter(){\n+        publisherAPI.getFilterDescriptorMap().clear();\n+\n+        final Map<String,Object> filtersMap =\n+                ImmutableMap.of(\"dependencies\",true,\"relationships\",true,\"excludeClasses\",\"Host,Workflow\");\n+        final FilterDescriptor filterDescriptor =\n+                new FilterDescriptor(\"filterTestAPI.yml\",\"Filter Test Title\",filtersMap,false,\"Reviewer,dotcms.org.2789\");\n+\n+        publisherAPI.addFilterDescriptor(filterDescriptor);\n+\n+        final Map<String,FilterDescriptor> filterDescriptorMap = APILocator.getPublisherAPI().getFilterDescriptorMap();\n+        Logger.info(this,filterDescriptorMap.toString());", "originalCommit": "f5f5f5d1d5629f7c1b8c19b50e3941cd2181adf8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM0NzkyOQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433347929", "bodyText": "done", "author": "erickgonzalez", "createdAt": "2020-06-01T16:28:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ3OTk2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "6487fe139932b9740065dd125e56be3a12c6905b", "chunk": "diff --git a/dotCMS/src/integration-test/java/com/dotcms/publishing/PublisherAPITest.java b/dotCMS/src/integration-test/java/com/dotcms/publishing/PublisherAPITest.java\nindex 2bc1f26be3..b03cc12d49 100644\n--- a/dotCMS/src/integration-test/java/com/dotcms/publishing/PublisherAPITest.java\n+++ b/dotCMS/src/integration-test/java/com/dotcms/publishing/PublisherAPITest.java\n\n@@ -326,8 +326,14 @@ public class PublisherAPITest extends IntegrationTestBase {\n         return file -> !file.getAbsolutePath().endsWith(\"bundle.xml\");\n     }\n \n+    /**\n+     * Method to test: {@link PublisherAPI#addFilterDescriptor(FilterDescriptor)}\n+     * Given Scenario: Create a new FilterDescriptor and add it to the FilterDescriptorMap\n+     * ExpectedResult: the filterDescriptor is added successfully to the map\n+     *\n+     */\n     @Test\n-    public void test_addFilter(){\n+    public void test_addFilter_success(){\n         publisherAPI.getFilterDescriptorMap().clear();\n \n         final Map<String,Object> filtersMap =\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ4MTgzNg==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r431481836", "bodyText": "expected result or javadoc", "author": "dsilvam", "createdAt": "2020-05-27T22:37:21Z", "path": "dotCMS/src/integration-test/java/com/dotcms/publishing/PublisherAPITest.java", "diffHunk": "@@ -319,4 +326,293 @@ private FileFilter getNoBundleXMLFileFilter() {\n         return file -> !file.getAbsolutePath().endsWith(\"bundle.xml\");\n     }\n \n+    @Test\n+    public void test_addFilter(){\n+        publisherAPI.getFilterDescriptorMap().clear();\n+\n+        final Map<String,Object> filtersMap =\n+                ImmutableMap.of(\"dependencies\",true,\"relationships\",true,\"excludeClasses\",\"Host,Workflow\");\n+        final FilterDescriptor filterDescriptor =\n+                new FilterDescriptor(\"filterTestAPI.yml\",\"Filter Test Title\",filtersMap,false,\"Reviewer,dotcms.org.2789\");\n+\n+        publisherAPI.addFilterDescriptor(filterDescriptor);\n+\n+        final Map<String,FilterDescriptor> filterDescriptorMap = APILocator.getPublisherAPI().getFilterDescriptorMap();\n+        Logger.info(this,filterDescriptorMap.toString());\n+        Assert.assertFalse(filterDescriptorMap.isEmpty());\n+        Assert.assertTrue(filterDescriptorMap.containsKey(filterDescriptor.getKey()));\n+    }\n+\n+    @Test\n+    public void test_getFiltersByRole_CMSAdmin() throws DotDataException {", "originalCommit": "f5f5f5d1d5629f7c1b8c19b50e3941cd2181adf8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM0OTMzNA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433349334", "bodyText": "done", "author": "erickgonzalez", "createdAt": "2020-06-01T16:30:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ4MTgzNg=="}], "type": "inlineReview", "revised_code": {"commit": "6487fe139932b9740065dd125e56be3a12c6905b", "chunk": "diff --git a/dotCMS/src/integration-test/java/com/dotcms/publishing/PublisherAPITest.java b/dotCMS/src/integration-test/java/com/dotcms/publishing/PublisherAPITest.java\nindex 2bc1f26be3..b03cc12d49 100644\n--- a/dotCMS/src/integration-test/java/com/dotcms/publishing/PublisherAPITest.java\n+++ b/dotCMS/src/integration-test/java/com/dotcms/publishing/PublisherAPITest.java\n\n@@ -326,8 +326,14 @@ public class PublisherAPITest extends IntegrationTestBase {\n         return file -> !file.getAbsolutePath().endsWith(\"bundle.xml\");\n     }\n \n+    /**\n+     * Method to test: {@link PublisherAPI#addFilterDescriptor(FilterDescriptor)}\n+     * Given Scenario: Create a new FilterDescriptor and add it to the FilterDescriptorMap\n+     * ExpectedResult: the filterDescriptor is added successfully to the map\n+     *\n+     */\n     @Test\n-    public void test_addFilter(){\n+    public void test_addFilter_success(){\n         publisherAPI.getFilterDescriptorMap().clear();\n \n         final Map<String,Object> filtersMap =\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ5ODcxMg==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r431498712", "bodyText": "This test is identical to the previous one. Turn on code-duplication detection on your IDE to spot this. Either fix or remove the duplicate", "author": "dsilvam", "createdAt": "2020-05-27T23:27:06Z", "path": "dotCMS/src/integration-test/java/com/dotcms/publishing/PublisherFilterImplTest.java", "diffHunk": "@@ -0,0 +1,122 @@\n+package com.dotcms.publishing;\n+\n+import com.dotcms.publisher.util.PusheableAsset;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.util.UUIDGenerator;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+public class PublisherFilterImplTest {\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {\n+        //Setting web app environment\n+        IntegrationTestInitService.getInstance().init();\n+    }\n+\n+    @Test\n+    public void Test_acceptExcludeDependencyClasses(){\n+        // Using diff case because user can use diff case\n+        final ArrayList<String> listOfTypes = new ArrayList<String>(Arrays.asList(\"Containers\", \"TEMPLATE\",\"host\",\"ContentType\"));\n+\n+        final PublisherFilterImpl publisherFilter = new PublisherFilterImpl(true,true);\n+\n+        // Should return true since the types have not been add to the Set, using the PusheableAsset since this is the value passed in core\n+        Assert.assertTrue(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTAINER.getType()));\n+        Assert.assertTrue(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.TEMPLATE.getType()));\n+        Assert.assertTrue(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType()));\n+        Assert.assertTrue(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType()));\n+        Assert.assertTrue(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENT_TYPE.getType()));\n+        // Adding the types to the Set\n+        listOfTypes.stream().forEach(type -> publisherFilter.addTypeToExcludeDependencyClassesSet(type));\n+        // Should return false since types are in the Set\n+        Assert.assertFalse(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTAINER.getType()));\n+        Assert.assertFalse(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.TEMPLATE.getType()));\n+        Assert.assertFalse(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType()));\n+        Assert.assertFalse(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENT_TYPE.getType()));\n+        // Should return true since the type is not in the Set\n+        Assert.assertTrue(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType()));\n+\n+    }\n+\n+    @Test\n+    public void Test_acceptExcludeClasses(){\n+        // Using diff case because user can use diff case\n+        final ArrayList<String> listOfTypes = new ArrayList<String>(Arrays.asList(\"Containers\", \"TEMPLATE\",\"host\"));\n+\n+        final PublisherFilterImpl publisherFilter = new PublisherFilterImpl(true,true);\n+\n+        // Should return true since the types have not been add to the Set, using the PusheableAsset since this is the value passed in core\n+        Assert.assertTrue(publisherFilter.acceptExcludeClasses(PusheableAsset.CONTAINER.getType()));\n+        Assert.assertTrue(publisherFilter.acceptExcludeClasses(PusheableAsset.TEMPLATE.getType()));\n+        Assert.assertTrue(publisherFilter.acceptExcludeClasses(PusheableAsset.SITE.getType()));\n+        Assert.assertTrue(publisherFilter.acceptExcludeClasses(PusheableAsset.CONTENTLET.getType()));\n+        // Adding the types to the Set\n+        listOfTypes.stream().forEach(type -> publisherFilter.addTypeToExcludeClassesSet(type));\n+        // Should return false since types are in the Set\n+        Assert.assertFalse(publisherFilter.acceptExcludeClasses(PusheableAsset.CONTAINER.getType()));\n+        Assert.assertFalse(publisherFilter.acceptExcludeClasses(PusheableAsset.TEMPLATE.getType()));\n+        Assert.assertFalse(publisherFilter.acceptExcludeClasses(PusheableAsset.SITE.getType()));\n+        // Should return true since the type is not in the Set\n+        Assert.assertTrue(publisherFilter.acceptExcludeClasses(PusheableAsset.CONTENTLET.getType()));\n+\n+    }\n+\n+    @Test\n+    public void Test_acceptExcludeQuery(){\n+        // Generate a couple of uuid\n+        final String id1 = UUIDGenerator.generateUuid();\n+        final String id2 = UUIDGenerator.generateUuid();\n+        final String id3 = UUIDGenerator.generateUuid();\n+        final ArrayList<String> listOfIds = new ArrayList<String>(Arrays.asList(id1,id2,id3));\n+\n+        final PublisherFilterImpl publisherFilter = new PublisherFilterImpl(true,true);\n+\n+        // Should return true since the ids have not been add to the Set\n+        Assert.assertTrue(publisherFilter.acceptExcludeQuery(id1));\n+        Assert.assertTrue(publisherFilter.acceptExcludeQuery(id2));\n+        Assert.assertTrue(publisherFilter.acceptExcludeQuery(id3));\n+        Assert.assertTrue(publisherFilter.acceptExcludeQuery(UUIDGenerator.generateUuid()));\n+        // Adding the types to the Set\n+        listOfIds.stream().forEach(id -> publisherFilter.addContentletIdToExcludeQueryAssetIdSet(id));\n+        // Should return false since ids are in the Set\n+        Assert.assertFalse(publisherFilter.acceptExcludeQuery(id1));\n+        Assert.assertFalse(publisherFilter.acceptExcludeQuery(id2));\n+        Assert.assertFalse(publisherFilter.acceptExcludeQuery(id3));\n+        // Should return true since the id is not in the Set\n+        Assert.assertTrue(publisherFilter.acceptExcludeQuery(UUIDGenerator.generateUuid()));\n+\n+    }\n+\n+    @Test\n+    public void Test_acceptExcludeDependencyQuery(){", "originalCommit": "f5f5f5d1d5629f7c1b8c19b50e3941cd2181adf8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM1MTkwMw==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433351903", "bodyText": "done", "author": "erickgonzalez", "createdAt": "2020-06-01T16:35:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ5ODcxMg=="}], "type": "inlineReview", "revised_code": {"commit": "6487fe139932b9740065dd125e56be3a12c6905b", "chunk": "diff --git a/dotCMS/src/integration-test/java/com/dotcms/publishing/PublisherFilterImplTest.java b/dotCMS/src/integration-test/java/com/dotcms/publishing/PublisherFilterImplTest.java\nindex e29658d5a4..c1fc30e815 100644\n--- a/dotCMS/src/integration-test/java/com/dotcms/publishing/PublisherFilterImplTest.java\n+++ b/dotCMS/src/integration-test/java/com/dotcms/publishing/PublisherFilterImplTest.java\n\n@@ -17,6 +17,12 @@ public class PublisherFilterImplTest {\n         IntegrationTestInitService.getInstance().init();\n     }\n \n+    /**\n+     * Method to test: {@link PublisherFilter#acceptExcludeDependencyClasses(String)}\n+     * Given Scenario: Given a list of types that are gonna be excluded to PP as a Dependency\n+     * ExpectedResult: Types in the list are excluded and types not in the list are accepted\n+     *\n+     */\n     @Test\n     public void Test_acceptExcludeDependencyClasses(){\n         // Using diff case because user can use diff case\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwMjM4Ng==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r431502386", "bodyText": "this needs to be in plural /v1/pushpublish/filters as dictated by the convention.\nE.g. GET /employees, gets all employees, GET /employees/1 gets a particular employee out of all of them", "author": "dsilvam", "createdAt": "2020-05-27T23:38:32Z", "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/pushpublish/PushPublishFilterResource.java", "diffHunk": "@@ -0,0 +1,67 @@\n+package com.dotcms.rest.api.v1.pushpublish;\n+\n+import com.dotcms.publishing.FilterDescriptor;\n+import com.dotcms.rest.InitDataObject;\n+import com.dotcms.rest.ResponseEntityView;\n+import com.dotcms.rest.WebResource;\n+import com.dotcms.rest.annotation.NoCache;\n+import com.dotcms.util.CollectionsUtils;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotDataException;\n+import com.google.common.annotations.VisibleForTesting;\n+import com.liferay.portal.model.User;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.core.Context;\n+import javax.ws.rs.core.MediaType;\n+import javax.ws.rs.core.Response;\n+import org.glassfish.jersey.server.JSONP;\n+\n+/**\n+ * This Resource is for the push publishing filters\n+ */\n+@Path(\"/v1/pushpublish/filter\")", "originalCommit": "f5f5f5d1d5629f7c1b8c19b50e3941cd2181adf8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM4Nzg3OA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433387878", "bodyText": "done", "author": "erickgonzalez", "createdAt": "2020-06-01T17:43:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwMjM4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "caca0f3c155c27d2407bfa8640fe05c1e3bff5e0", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/rest/api/v1/pushpublish/PushPublishFilterResource.java b/dotCMS/src/main/java/com/dotcms/rest/api/v1/pushpublish/PushPublishFilterResource.java\nindex aac62efe1c..89e214f9a3 100644\n--- a/dotCMS/src/main/java/com/dotcms/rest/api/v1/pushpublish/PushPublishFilterResource.java\n+++ b/dotCMS/src/main/java/com/dotcms/rest/api/v1/pushpublish/PushPublishFilterResource.java\n\n@@ -25,7 +25,7 @@ import org.glassfish.jersey.server.JSONP;\n /**\n  * This Resource is for the push publishing filters\n  */\n-@Path(\"/v1/pushpublish/filter\")\n+@Path(\"/v1/pushpublish/filters\")\n public class PushPublishFilterResource {\n \n     private final WebResource webResource;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwNDY5MA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r431504690", "bodyText": "I think the name of this method is not clear. It should be doesExcludeClassesContaintType", "author": "dsilvam", "createdAt": "2020-05-27T23:45:44Z", "path": "dotCMS/src/main/java/com/dotcms/publishing/PublisherFilterImpl.java", "diffHunk": "@@ -0,0 +1,85 @@\n+package com.dotcms.publishing;\n+\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+/**\n+ * This class is use to load the values of the filters of a FilterDescriptor that is going to be use\n+ * to create a bundle.\n+ * Each method check for each filter and check that the asset that is going to be added to the bundle\n+ * is accepted.\n+ */\n+public class PublisherFilterImpl implements PublisherFilter{\n+\n+    private final Set<String> excludeClassesSet = new HashSet<>();\n+    private final Set<String>excludeDependencyClassesSet = new HashSet<>();\n+    private final Set<String>excludeQueryAssetIdSet = new HashSet<>();\n+    private final Set<String>excludeDependencyQueryAssetIdSet = new HashSet<>();\n+    private final boolean dependencies;\n+    private final boolean relationships;\n+\n+    public PublisherFilterImpl(final boolean dependencies, final boolean relationships) {\n+        this.dependencies = dependencies;\n+        this.relationships = relationships;\n+    }\n+\n+    @Override\n+    public boolean isDependencies() {\n+        return dependencies;\n+    }\n+\n+    @Override\n+    public boolean isRelationships() {\n+        return relationships;\n+    }\n+\n+    public void addTypeToExcludeDependencyClassesSet(final String type) {\n+        this.excludeDependencyClassesSet.add(type.toLowerCase());\n+    }\n+\n+    public void addTypeToExcludeClassesSet(final String type) {\n+        this.excludeClassesSet.add(type.toLowerCase());\n+    }\n+\n+    public void addContentletIdToExcludeQueryAssetIdSet(final String contentletId) {\n+        this.excludeQueryAssetIdSet.add(contentletId);\n+    }\n+\n+    public void addContentletIdToExcludeDependencyQueryAssetIdSet(final String contentletId) {\n+        this.excludeDependencyQueryAssetIdSet.add(contentletId);\n+    }\n+\n+    @Override\n+    public boolean acceptExcludeClasses(final String assetType) {\n+        return !this.excludeClassesSet.contains(assetType.toLowerCase());", "originalCommit": "f5f5f5d1d5629f7c1b8c19b50e3941cd2181adf8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg3NjE5Mw==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r431876193", "bodyText": "isExcludeClasses?", "author": "freddyucv", "createdAt": "2020-05-28T14:26:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwNDY5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg5MTQ5OQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r431891499", "bodyText": "nope, doesExcludeClassesContaintType", "author": "dsilvam", "createdAt": "2020-05-28T14:42:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwNDY5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkwMDk0Mw==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r431900943", "bodyText": "but the negation inside the method would need to be removed", "author": "dsilvam", "createdAt": "2020-05-28T14:53:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwNDY5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkwNTA4Mg==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r431905082", "bodyText": "Actually the name should be doesExcludeClass or isClassExcluded, in singular not in plural. We don't care about the underlying implementation, we should care if the class is excluded or not.\nThe caller would be:\nif(publisherFilter.doesExcludeClass(asset.getType())){ continue; }\n(without negation)", "author": "dsilvam", "createdAt": "2020-05-28T14:59:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwNDY5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQyNTIzMA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433425230", "bodyText": "done", "author": "erickgonzalez", "createdAt": "2020-06-01T18:54:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwNDY5MA=="}], "type": "inlineReview", "revised_code": {"commit": "b6a062025f2e8da405f1effe33a37cf7086b672a", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publishing/PublisherFilterImpl.java b/dotCMS/src/main/java/com/dotcms/publishing/PublisherFilterImpl.java\nindex b7901f6886..f41208ee07 100644\n--- a/dotCMS/src/main/java/com/dotcms/publishing/PublisherFilterImpl.java\n+++ b/dotCMS/src/main/java/com/dotcms/publishing/PublisherFilterImpl.java\n\n@@ -51,23 +51,23 @@ public class PublisherFilterImpl implements PublisherFilter{\n     }\n \n     @Override\n-    public boolean acceptExcludeClasses(final String assetType) {\n-        return !this.excludeClassesSet.contains(assetType.toLowerCase());\n+    public boolean doesExcludeClassesContainsType(final String assetType) {\n+        return this.excludeClassesSet.contains(assetType.toLowerCase());\n     }\n \n     @Override\n-    public boolean acceptExcludeQuery(final String contentletId) {\n-        return !this.excludeQueryAssetIdSet.contains(contentletId);\n+    public boolean doesExcludeQueryContainsContentletId(final String contentletId) {\n+        return this.excludeQueryAssetIdSet.contains(contentletId);\n     }\n \n     @Override\n-    public boolean acceptExcludeDependencyQuery(final String contentletId) {\n-        return !this.excludeDependencyQueryAssetIdSet.contains(contentletId);\n+    public boolean doesExcludeDependencyQueryContainsContentletId(final String contentletId) {\n+        return this.excludeDependencyQueryAssetIdSet.contains(contentletId);\n     }\n \n     @Override\n-    public boolean acceptExcludeDependencyClasses(final String pusheableAssetType) {\n-        return !this.excludeDependencyClassesSet.contains(pusheableAssetType.toLowerCase());\n+    public boolean doesExcludeDependencyClassesContainsType(final String pusheableAssetType) {\n+        return this.excludeDependencyClassesSet.contains(pusheableAssetType.toLowerCase());\n     }\n \n     public String toString(){\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwNDg2MQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r431504861", "bodyText": "I think the name of this method is not clear. It should be doesExcludeQueryContaintContentlet", "author": "dsilvam", "createdAt": "2020-05-27T23:46:20Z", "path": "dotCMS/src/main/java/com/dotcms/publishing/PublisherFilterImpl.java", "diffHunk": "@@ -0,0 +1,85 @@\n+package com.dotcms.publishing;\n+\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+/**\n+ * This class is use to load the values of the filters of a FilterDescriptor that is going to be use\n+ * to create a bundle.\n+ * Each method check for each filter and check that the asset that is going to be added to the bundle\n+ * is accepted.\n+ */\n+public class PublisherFilterImpl implements PublisherFilter{\n+\n+    private final Set<String> excludeClassesSet = new HashSet<>();\n+    private final Set<String>excludeDependencyClassesSet = new HashSet<>();\n+    private final Set<String>excludeQueryAssetIdSet = new HashSet<>();\n+    private final Set<String>excludeDependencyQueryAssetIdSet = new HashSet<>();\n+    private final boolean dependencies;\n+    private final boolean relationships;\n+\n+    public PublisherFilterImpl(final boolean dependencies, final boolean relationships) {\n+        this.dependencies = dependencies;\n+        this.relationships = relationships;\n+    }\n+\n+    @Override\n+    public boolean isDependencies() {\n+        return dependencies;\n+    }\n+\n+    @Override\n+    public boolean isRelationships() {\n+        return relationships;\n+    }\n+\n+    public void addTypeToExcludeDependencyClassesSet(final String type) {\n+        this.excludeDependencyClassesSet.add(type.toLowerCase());\n+    }\n+\n+    public void addTypeToExcludeClassesSet(final String type) {\n+        this.excludeClassesSet.add(type.toLowerCase());\n+    }\n+\n+    public void addContentletIdToExcludeQueryAssetIdSet(final String contentletId) {\n+        this.excludeQueryAssetIdSet.add(contentletId);\n+    }\n+\n+    public void addContentletIdToExcludeDependencyQueryAssetIdSet(final String contentletId) {\n+        this.excludeDependencyQueryAssetIdSet.add(contentletId);\n+    }\n+\n+    @Override\n+    public boolean acceptExcludeClasses(final String assetType) {\n+        return !this.excludeClassesSet.contains(assetType.toLowerCase());\n+    }\n+\n+    @Override\n+    public boolean acceptExcludeQuery(final String contentletId) {\n+        return !this.excludeQueryAssetIdSet.contains(contentletId);\n+    }", "originalCommit": "f5f5f5d1d5629f7c1b8c19b50e3941cd2181adf8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg3NzEzMA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r431877130", "bodyText": "isExcludeQueryContaintContentlet?", "author": "freddyucv", "createdAt": "2020-05-28T14:27:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwNDg2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQyNTUxOQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433425519", "bodyText": "done", "author": "erickgonzalez", "createdAt": "2020-06-01T18:54:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwNDg2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "b6a062025f2e8da405f1effe33a37cf7086b672a", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publishing/PublisherFilterImpl.java b/dotCMS/src/main/java/com/dotcms/publishing/PublisherFilterImpl.java\nindex b7901f6886..f41208ee07 100644\n--- a/dotCMS/src/main/java/com/dotcms/publishing/PublisherFilterImpl.java\n+++ b/dotCMS/src/main/java/com/dotcms/publishing/PublisherFilterImpl.java\n\n@@ -51,23 +51,23 @@ public class PublisherFilterImpl implements PublisherFilter{\n     }\n \n     @Override\n-    public boolean acceptExcludeClasses(final String assetType) {\n-        return !this.excludeClassesSet.contains(assetType.toLowerCase());\n+    public boolean doesExcludeClassesContainsType(final String assetType) {\n+        return this.excludeClassesSet.contains(assetType.toLowerCase());\n     }\n \n     @Override\n-    public boolean acceptExcludeQuery(final String contentletId) {\n-        return !this.excludeQueryAssetIdSet.contains(contentletId);\n+    public boolean doesExcludeQueryContainsContentletId(final String contentletId) {\n+        return this.excludeQueryAssetIdSet.contains(contentletId);\n     }\n \n     @Override\n-    public boolean acceptExcludeDependencyQuery(final String contentletId) {\n-        return !this.excludeDependencyQueryAssetIdSet.contains(contentletId);\n+    public boolean doesExcludeDependencyQueryContainsContentletId(final String contentletId) {\n+        return this.excludeDependencyQueryAssetIdSet.contains(contentletId);\n     }\n \n     @Override\n-    public boolean acceptExcludeDependencyClasses(final String pusheableAssetType) {\n-        return !this.excludeDependencyClassesSet.contains(pusheableAssetType.toLowerCase());\n+    public boolean doesExcludeDependencyClassesContainsType(final String pusheableAssetType) {\n+        return this.excludeDependencyClassesSet.contains(pusheableAssetType.toLowerCase());\n     }\n \n     public String toString(){\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwNDk0Mw==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r431504943", "bodyText": "I think the name of this method is not clear. It should be doesExcludeDependencyQueryContaintContentlet", "author": "dsilvam", "createdAt": "2020-05-27T23:46:40Z", "path": "dotCMS/src/main/java/com/dotcms/publishing/PublisherFilterImpl.java", "diffHunk": "@@ -0,0 +1,85 @@\n+package com.dotcms.publishing;\n+\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+/**\n+ * This class is use to load the values of the filters of a FilterDescriptor that is going to be use\n+ * to create a bundle.\n+ * Each method check for each filter and check that the asset that is going to be added to the bundle\n+ * is accepted.\n+ */\n+public class PublisherFilterImpl implements PublisherFilter{\n+\n+    private final Set<String> excludeClassesSet = new HashSet<>();\n+    private final Set<String>excludeDependencyClassesSet = new HashSet<>();\n+    private final Set<String>excludeQueryAssetIdSet = new HashSet<>();\n+    private final Set<String>excludeDependencyQueryAssetIdSet = new HashSet<>();\n+    private final boolean dependencies;\n+    private final boolean relationships;\n+\n+    public PublisherFilterImpl(final boolean dependencies, final boolean relationships) {\n+        this.dependencies = dependencies;\n+        this.relationships = relationships;\n+    }\n+\n+    @Override\n+    public boolean isDependencies() {\n+        return dependencies;\n+    }\n+\n+    @Override\n+    public boolean isRelationships() {\n+        return relationships;\n+    }\n+\n+    public void addTypeToExcludeDependencyClassesSet(final String type) {\n+        this.excludeDependencyClassesSet.add(type.toLowerCase());\n+    }\n+\n+    public void addTypeToExcludeClassesSet(final String type) {\n+        this.excludeClassesSet.add(type.toLowerCase());\n+    }\n+\n+    public void addContentletIdToExcludeQueryAssetIdSet(final String contentletId) {\n+        this.excludeQueryAssetIdSet.add(contentletId);\n+    }\n+\n+    public void addContentletIdToExcludeDependencyQueryAssetIdSet(final String contentletId) {\n+        this.excludeDependencyQueryAssetIdSet.add(contentletId);\n+    }\n+\n+    @Override\n+    public boolean acceptExcludeClasses(final String assetType) {\n+        return !this.excludeClassesSet.contains(assetType.toLowerCase());\n+    }\n+\n+    @Override\n+    public boolean acceptExcludeQuery(final String contentletId) {\n+        return !this.excludeQueryAssetIdSet.contains(contentletId);\n+    }\n+\n+    @Override\n+    public boolean acceptExcludeDependencyQuery(final String contentletId) {", "originalCommit": "f5f5f5d1d5629f7c1b8c19b50e3941cd2181adf8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQyNTMxMA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433425310", "bodyText": "done", "author": "erickgonzalez", "createdAt": "2020-06-01T18:54:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwNDk0Mw=="}], "type": "inlineReview", "revised_code": {"commit": "b6a062025f2e8da405f1effe33a37cf7086b672a", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publishing/PublisherFilterImpl.java b/dotCMS/src/main/java/com/dotcms/publishing/PublisherFilterImpl.java\nindex b7901f6886..f41208ee07 100644\n--- a/dotCMS/src/main/java/com/dotcms/publishing/PublisherFilterImpl.java\n+++ b/dotCMS/src/main/java/com/dotcms/publishing/PublisherFilterImpl.java\n\n@@ -51,23 +51,23 @@ public class PublisherFilterImpl implements PublisherFilter{\n     }\n \n     @Override\n-    public boolean acceptExcludeClasses(final String assetType) {\n-        return !this.excludeClassesSet.contains(assetType.toLowerCase());\n+    public boolean doesExcludeClassesContainsType(final String assetType) {\n+        return this.excludeClassesSet.contains(assetType.toLowerCase());\n     }\n \n     @Override\n-    public boolean acceptExcludeQuery(final String contentletId) {\n-        return !this.excludeQueryAssetIdSet.contains(contentletId);\n+    public boolean doesExcludeQueryContainsContentletId(final String contentletId) {\n+        return this.excludeQueryAssetIdSet.contains(contentletId);\n     }\n \n     @Override\n-    public boolean acceptExcludeDependencyQuery(final String contentletId) {\n-        return !this.excludeDependencyQueryAssetIdSet.contains(contentletId);\n+    public boolean doesExcludeDependencyQueryContainsContentletId(final String contentletId) {\n+        return this.excludeDependencyQueryAssetIdSet.contains(contentletId);\n     }\n \n     @Override\n-    public boolean acceptExcludeDependencyClasses(final String pusheableAssetType) {\n-        return !this.excludeDependencyClassesSet.contains(pusheableAssetType.toLowerCase());\n+    public boolean doesExcludeDependencyClassesContainsType(final String pusheableAssetType) {\n+        return this.excludeDependencyClassesSet.contains(pusheableAssetType.toLowerCase());\n     }\n \n     public String toString(){\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwNTE0Ng==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r431505146", "bodyText": "I think the name of this method is not clear. It should be doesExcludeDependencyClassesContaintType", "author": "dsilvam", "createdAt": "2020-05-27T23:47:22Z", "path": "dotCMS/src/main/java/com/dotcms/publishing/PublisherFilterImpl.java", "diffHunk": "@@ -0,0 +1,85 @@\n+package com.dotcms.publishing;\n+\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+/**\n+ * This class is use to load the values of the filters of a FilterDescriptor that is going to be use\n+ * to create a bundle.\n+ * Each method check for each filter and check that the asset that is going to be added to the bundle\n+ * is accepted.\n+ */\n+public class PublisherFilterImpl implements PublisherFilter{\n+\n+    private final Set<String> excludeClassesSet = new HashSet<>();\n+    private final Set<String>excludeDependencyClassesSet = new HashSet<>();\n+    private final Set<String>excludeQueryAssetIdSet = new HashSet<>();\n+    private final Set<String>excludeDependencyQueryAssetIdSet = new HashSet<>();\n+    private final boolean dependencies;\n+    private final boolean relationships;\n+\n+    public PublisherFilterImpl(final boolean dependencies, final boolean relationships) {\n+        this.dependencies = dependencies;\n+        this.relationships = relationships;\n+    }\n+\n+    @Override\n+    public boolean isDependencies() {\n+        return dependencies;\n+    }\n+\n+    @Override\n+    public boolean isRelationships() {\n+        return relationships;\n+    }\n+\n+    public void addTypeToExcludeDependencyClassesSet(final String type) {\n+        this.excludeDependencyClassesSet.add(type.toLowerCase());\n+    }\n+\n+    public void addTypeToExcludeClassesSet(final String type) {\n+        this.excludeClassesSet.add(type.toLowerCase());\n+    }\n+\n+    public void addContentletIdToExcludeQueryAssetIdSet(final String contentletId) {\n+        this.excludeQueryAssetIdSet.add(contentletId);\n+    }\n+\n+    public void addContentletIdToExcludeDependencyQueryAssetIdSet(final String contentletId) {\n+        this.excludeDependencyQueryAssetIdSet.add(contentletId);\n+    }\n+\n+    @Override\n+    public boolean acceptExcludeClasses(final String assetType) {\n+        return !this.excludeClassesSet.contains(assetType.toLowerCase());\n+    }\n+\n+    @Override\n+    public boolean acceptExcludeQuery(final String contentletId) {\n+        return !this.excludeQueryAssetIdSet.contains(contentletId);\n+    }\n+\n+    @Override\n+    public boolean acceptExcludeDependencyQuery(final String contentletId) {\n+        return !this.excludeDependencyQueryAssetIdSet.contains(contentletId);\n+    }\n+\n+    @Override\n+    public boolean acceptExcludeDependencyClasses(final String pusheableAssetType) {", "originalCommit": "f5f5f5d1d5629f7c1b8c19b50e3941cd2181adf8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg3NzM1Mw==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r431877353", "bodyText": "isExcludeDependencyClassesContaintType", "author": "freddyucv", "createdAt": "2020-05-28T14:27:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwNTE0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQyNTQyNg==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433425426", "bodyText": "done", "author": "erickgonzalez", "createdAt": "2020-06-01T18:54:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwNTE0Ng=="}], "type": "inlineReview", "revised_code": {"commit": "b6a062025f2e8da405f1effe33a37cf7086b672a", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publishing/PublisherFilterImpl.java b/dotCMS/src/main/java/com/dotcms/publishing/PublisherFilterImpl.java\nindex b7901f6886..f41208ee07 100644\n--- a/dotCMS/src/main/java/com/dotcms/publishing/PublisherFilterImpl.java\n+++ b/dotCMS/src/main/java/com/dotcms/publishing/PublisherFilterImpl.java\n\n@@ -51,23 +51,23 @@ public class PublisherFilterImpl implements PublisherFilter{\n     }\n \n     @Override\n-    public boolean acceptExcludeClasses(final String assetType) {\n-        return !this.excludeClassesSet.contains(assetType.toLowerCase());\n+    public boolean doesExcludeClassesContainsType(final String assetType) {\n+        return this.excludeClassesSet.contains(assetType.toLowerCase());\n     }\n \n     @Override\n-    public boolean acceptExcludeQuery(final String contentletId) {\n-        return !this.excludeQueryAssetIdSet.contains(contentletId);\n+    public boolean doesExcludeQueryContainsContentletId(final String contentletId) {\n+        return this.excludeQueryAssetIdSet.contains(contentletId);\n     }\n \n     @Override\n-    public boolean acceptExcludeDependencyQuery(final String contentletId) {\n-        return !this.excludeDependencyQueryAssetIdSet.contains(contentletId);\n+    public boolean doesExcludeDependencyQueryContainsContentletId(final String contentletId) {\n+        return this.excludeDependencyQueryAssetIdSet.contains(contentletId);\n     }\n \n     @Override\n-    public boolean acceptExcludeDependencyClasses(final String pusheableAssetType) {\n-        return !this.excludeDependencyClassesSet.contains(pusheableAssetType.toLowerCase());\n+    public boolean doesExcludeDependencyClassesContainsType(final String pusheableAssetType) {\n+        return this.excludeDependencyClassesSet.contains(pusheableAssetType.toLowerCase());\n     }\n \n     public String toString(){\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwODQ1Nw==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r431508457", "bodyText": "I think here an alternative could be:\n\nMap the List<Contentlet> contentlets to a List<String> contentletsIdentifiers using stream().map\nAdd a method to the publisherFilter to addAll that takes a list of strings and pass list in 1.\n@freddyucv @jdotcms thoughts about this?\nIf the guys thinks this can be better, please apply in the if above also", "author": "dsilvam", "createdAt": "2020-05-27T23:58:23Z", "path": "dotCMS/src/main/java/com/dotcms/publishing/PublisherAPIImpl.java", "diffHunk": "@@ -142,4 +152,78 @@ public PublishStatus publish ( PublisherConfig config, PublishStatus status ) th\n         return status;\n     }\n \n+    @Override\n+    public void addFilterDescriptor(final FilterDescriptor filterDescriptor) {\n+        this.loadedFilters.put(filterDescriptor.getKey(),filterDescriptor);\n+    }\n+\n+    @Override\n+    public List<FilterDescriptor> getFiltersDescriptorsByRole(final User user) throws DotDataException {\n+        if(user.isAdmin()){\n+            return new ArrayList<>(this.loadedFilters.values());\n+        }\n+        final List<Role> roles = APILocator.getRoleAPI().loadRolesForUser(user.getUserId(), true);\n+        Logger.info(this,\"User Roles: \" + roles.toString());\n+        final List<FilterDescriptor> filters = new ArrayList<>();\n+        for(final Map.Entry<String,FilterDescriptor> filterDescriptorMap : this.loadedFilters.entrySet()){\n+            final String filterRoles = filterDescriptorMap.getValue().getRoles();\n+            Logger.info(PublisherAPI.class,\"File: \" +filterDescriptorMap.getKey() + \" Roles: \" + filterRoles );\n+            for(final Role role : roles){\n+                if(UtilMethods.isSet(role.getRoleKey()) && filterRoles.contains(role.getRoleKey())){\n+                    filters.add(filterDescriptorMap.getValue());\n+                }\n+            }\n+        }\n+\n+        return filters;\n+    }\n+\n+    @Override\n+    public Map<String, FilterDescriptor> getFilterDescriptorMap() {\n+        return this.loadedFilters;\n+    }\n+\n+    @Override\n+    public FilterDescriptor getFilterDescriptorByKey(final String filterKey) {\n+        final FilterDescriptor defaultFilter = getDefaultFilter();\n+        return !UtilMethods.isSet(filterKey) ? defaultFilter : this.loadedFilters.getOrDefault(filterKey,defaultFilter);\n+    }\n+\n+    @Override\n+    public PublisherFilter createPublisherFilter(final String bundleId)\n+            throws DotDataException, DotSecurityException {\n+\n+        final String filterKey = APILocator.getBundleAPI().getBundleById(bundleId).getFilterKey();\n+        final FilterDescriptor filterDescriptor = this.getFilterDescriptorByKey(filterKey);\n+\n+        final PublisherFilterImpl publisherFilter = new PublisherFilterImpl((Boolean)filterDescriptor.getFilters().getOrDefault(\"dependencies\",true),\n+                (Boolean)filterDescriptor.getFilters().getOrDefault(\"relationships\",true));\n+\n+        if(filterDescriptor.getFilters().containsKey(\"excludeClasses\")){\n+            List.class.cast(filterDescriptor.getFilters().get(\"excludeClasses\")).stream().forEach(type -> publisherFilter.addTypeToExcludeClassesSet(type.toString()));\n+\n+        }\n+\n+        if(filterDescriptor.getFilters().containsKey(\"excludeDependencyClasses\")){\n+            List.class.cast(filterDescriptor.getFilters().get(\"excludeDependencyClasses\")).stream().forEach(type -> publisherFilter.addTypeToExcludeDependencyClassesSet(type.toString()));\n+        }\n+\n+        if(filterDescriptor.getFilters().containsKey(\"excludeQuery\")){\n+            final String query = filterDescriptor.getFilters().get(\"excludeQuery\").toString();\n+            final List<Contentlet> contentlets = APILocator.getContentletAPI().search(query, 0, 0, \"moddate\", APILocator.systemUser(), false);\n+            contentlets.stream().forEach(contentlet -> publisherFilter.addContentletIdToExcludeQueryAssetIdSet(contentlet.getIdentifier()));\n+        }\n+\n+        if(filterDescriptor.getFilters().containsKey(\"excludeDependencyQuery\")){\n+            final String query = filterDescriptor.getFilters().get(\"excludeDependencyQuery\").toString();\n+            final List<Contentlet> contentlets = APILocator.getContentletAPI().search(query, 0, 0, \"moddate\", APILocator.systemUser(), false);\n+            contentlets.stream().forEach(contentlet -> publisherFilter.addContentletIdToExcludeDependencyQueryAssetIdSet(contentlet.getIdentifier()));", "originalCommit": "f5f5f5d1d5629f7c1b8c19b50e3941cd2181adf8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg4ODY3MA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r431888670", "bodyText": "Why do not add all the contentlet to publisherFilter and then it take what it need from the contentlet later?", "author": "freddyucv", "createdAt": "2020-05-28T14:38:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwODQ1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ5NTM1Nw==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433495357", "bodyText": "done", "author": "erickgonzalez", "createdAt": "2020-06-01T21:17:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwODQ1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "3bb6f01e43fd12a32798c2d74fdcdb1851d9fae9", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publishing/PublisherAPIImpl.java b/dotCMS/src/main/java/com/dotcms/publishing/PublisherAPIImpl.java\nindex c91e32cd7f..4241dcdb91 100644\n--- a/dotCMS/src/main/java/com/dotcms/publishing/PublisherAPIImpl.java\n+++ b/dotCMS/src/main/java/com/dotcms/publishing/PublisherAPIImpl.java\n\n@@ -178,7 +179,7 @@ public class PublisherAPIImpl implements PublisherAPI {\n         return filters;\n     }\n \n-    @Override\n+    @VisibleForTesting\n     public Map<String, FilterDescriptor> getFilterDescriptorMap() {\n         return this.loadedFilters;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg4NTUxNg==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r431885516", "bodyText": "maybe here we can use some of Polymorphism to get this code better, something like:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if(filterDescriptor.getFilters().containsKey(\"excludeDependencyClasses\")){\n          \n          \n            \n                    public interface PPFilter {\n          \n          \n            \n                        public boolean shouldApply( final FilterDescriptor filterDescriptor);\n          \n          \n            \n                        public void. apply(final FilterDescriptor filterDescriptor, PublisherFilterImpl publisherFilter))\n          \n          \n            \n                    }\n          \n      \n    \n    \n  \n\nEach ifs could be a implementation of the before interface, something like:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if(filterDescriptor.getFilters().containsKey(\"excludeDependencyClasses\")){\n          \n          \n            \n                    public ExcludeClassPPFilter implements PPFilter {\n          \n          \n            \n                                public boolean shouldApply( final FilterDescriptor filterDescriptor) {\n          \n          \n            \n                                    return filterDescriptor.getFilters().containsKey(\"excludeClasses\");\n          \n          \n            \n                                }\n          \n          \n            \n                                \n          \n          \n            \n                               public void. apply(final FilterDescriptor filterDescriptor, PublisherFilterImpl publisherFilter)){\n          \n          \n            \n                                   List.class.cast(filterDescriptor.getFilters().get(\"excludeClasses\")).stream().forEach(type -> publisherFilter.addTypeToExcludeClassesSet(type.toString()));\n          \n          \n            \n                               }\n          \n          \n            \n                    }", "author": "freddyucv", "createdAt": "2020-05-28T14:35:44Z", "path": "dotCMS/src/main/java/com/dotcms/publishing/PublisherAPIImpl.java", "diffHunk": "@@ -142,4 +152,78 @@ public PublishStatus publish ( PublisherConfig config, PublishStatus status ) th\n         return status;\n     }\n \n+    @Override\n+    public void addFilterDescriptor(final FilterDescriptor filterDescriptor) {\n+        this.loadedFilters.put(filterDescriptor.getKey(),filterDescriptor);\n+    }\n+\n+    @Override\n+    public List<FilterDescriptor> getFiltersDescriptorsByRole(final User user) throws DotDataException {\n+        if(user.isAdmin()){\n+            return new ArrayList<>(this.loadedFilters.values());\n+        }\n+        final List<Role> roles = APILocator.getRoleAPI().loadRolesForUser(user.getUserId(), true);\n+        Logger.info(this,\"User Roles: \" + roles.toString());\n+        final List<FilterDescriptor> filters = new ArrayList<>();\n+        for(final Map.Entry<String,FilterDescriptor> filterDescriptorMap : this.loadedFilters.entrySet()){\n+            final String filterRoles = filterDescriptorMap.getValue().getRoles();\n+            Logger.info(PublisherAPI.class,\"File: \" +filterDescriptorMap.getKey() + \" Roles: \" + filterRoles );\n+            for(final Role role : roles){\n+                if(UtilMethods.isSet(role.getRoleKey()) && filterRoles.contains(role.getRoleKey())){\n+                    filters.add(filterDescriptorMap.getValue());\n+                }\n+            }\n+        }\n+\n+        return filters;\n+    }\n+\n+    @Override\n+    public Map<String, FilterDescriptor> getFilterDescriptorMap() {\n+        return this.loadedFilters;\n+    }\n+\n+    @Override\n+    public FilterDescriptor getFilterDescriptorByKey(final String filterKey) {\n+        final FilterDescriptor defaultFilter = getDefaultFilter();\n+        return !UtilMethods.isSet(filterKey) ? defaultFilter : this.loadedFilters.getOrDefault(filterKey,defaultFilter);\n+    }\n+\n+    @Override\n+    public PublisherFilter createPublisherFilter(final String bundleId)\n+            throws DotDataException, DotSecurityException {\n+\n+        final String filterKey = APILocator.getBundleAPI().getBundleById(bundleId).getFilterKey();\n+        final FilterDescriptor filterDescriptor = this.getFilterDescriptorByKey(filterKey);\n+\n+        final PublisherFilterImpl publisherFilter = new PublisherFilterImpl((Boolean)filterDescriptor.getFilters().getOrDefault(\"dependencies\",true),\n+                (Boolean)filterDescriptor.getFilters().getOrDefault(\"relationships\",true));\n+\n+        if(filterDescriptor.getFilters().containsKey(\"excludeClasses\")){\n+            List.class.cast(filterDescriptor.getFilters().get(\"excludeClasses\")).stream().forEach(type -> publisherFilter.addTypeToExcludeClassesSet(type.toString()));\n+\n+        }\n+\n+        if(filterDescriptor.getFilters().containsKey(\"excludeDependencyClasses\")){", "originalCommit": "f5f5f5d1d5629f7c1b8c19b50e3941cd2181adf8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3bb6f01e43fd12a32798c2d74fdcdb1851d9fae9", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publishing/PublisherAPIImpl.java b/dotCMS/src/main/java/com/dotcms/publishing/PublisherAPIImpl.java\nindex c91e32cd7f..4241dcdb91 100644\n--- a/dotCMS/src/main/java/com/dotcms/publishing/PublisherAPIImpl.java\n+++ b/dotCMS/src/main/java/com/dotcms/publishing/PublisherAPIImpl.java\n\n@@ -178,7 +179,7 @@ public class PublisherAPIImpl implements PublisherAPI {\n         return filters;\n     }\n \n-    @Override\n+    @VisibleForTesting\n     public Map<String, FilterDescriptor> getFilterDescriptorMap() {\n         return this.loadedFilters;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE3MjAzNw==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r432172037", "bodyText": "expected result missing in name or javadoc", "author": "dsilvam", "createdAt": "2020-05-28T23:07:53Z", "path": "dotCMS/src/integration-test/java/com/dotcms/publishing/PushPublishFiltersInitializerTest.java", "diffHunk": "@@ -0,0 +1,58 @@\n+package com.dotcms.publishing;\n+\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotcms.util.YamlUtil;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.util.Logger;\n+import com.google.common.collect.ImmutableMap;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Map;\n+import java.util.stream.Stream;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+public class PushPublishFiltersInitializerTest {\n+\n+    private static PushPublishFiltersInitializer pushPublishFiltersInitializer;\n+    private static File path;\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {\n+        //Setting web app environment\n+        IntegrationTestInitService.getInstance().init();\n+        final String tmpdirPath = System.getProperty(\"java.io.tmpdir\");\n+        path = new File(tmpdirPath + File.separator + \"filters\");\n+        if (!path.exists()) {\n+            path.mkdir();\n+        }\n+        pushPublishFiltersInitializer = new PushPublishFiltersInitializer();\n+    }\n+\n+    private void createFilterFile(final FilterDescriptor filterDescriptor){\n+        Logger.info(this,\"PATH\" + path.toString());\n+        final File file = new File(path.toString(),filterDescriptor.getKey());\n+        YamlUtil.write(file,filterDescriptor);\n+    }\n+\n+    @Test\n+    public void test_loadFilter() throws IOException {", "originalCommit": "f5f5f5d1d5629f7c1b8c19b50e3941cd2181adf8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM2NTU1NQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433365555", "bodyText": "done", "author": "erickgonzalez", "createdAt": "2020-06-01T17:01:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE3MjAzNw=="}], "type": "inlineReview", "revised_code": {"commit": "6487fe139932b9740065dd125e56be3a12c6905b", "chunk": "diff --git a/dotCMS/src/integration-test/java/com/dotcms/publishing/PushPublishFiltersInitializerTest.java b/dotCMS/src/integration-test/java/com/dotcms/publishing/PushPublishFiltersInitializerTest.java\nindex 3190ab4aa0..56a6a5440c 100644\n--- a/dotCMS/src/integration-test/java/com/dotcms/publishing/PushPublishFiltersInitializerTest.java\n+++ b/dotCMS/src/integration-test/java/com/dotcms/publishing/PushPublishFiltersInitializerTest.java\n\n@@ -38,8 +38,14 @@ public class PushPublishFiltersInitializerTest {\n         YamlUtil.write(file,filterDescriptor);\n     }\n \n+    /**\n+     * Method to test: {@link PushPublishFiltersInitializer#loadFilter(Path)}\n+     * Given Scenario: Given a yaml file that contains a FilterDescriptor, the initializer reads the file and loads the filter\n+     * ExpectedResult: filter is successfully added to the filterDescriptorMap\n+     *\n+     */\n     @Test\n-    public void test_loadFilter() throws IOException {\n+    public void test_loadFilter_success() throws IOException {\n         final Map<String,Object> filtersMap =\n                 ImmutableMap.of(\"dependencies\",true,\"relationships\",true,\"excludeClasses\",\"Host,Workflow\");\n         final FilterDescriptor filterDescriptor =\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE3MjM5Nw==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r432172397", "bodyText": "expected result in name or javadoc", "author": "dsilvam", "createdAt": "2020-05-28T23:09:04Z", "path": "dotCMS/src/integration-test/java/com/dotcms/rest/api/v1/pushpublish/PushPublishFilterResourceTest.java", "diffHunk": "@@ -0,0 +1,81 @@\n+package com.dotcms.rest.api.v1.pushpublish;\n+\n+import com.dotcms.mock.request.MockAttributeRequest;\n+import com.dotcms.mock.request.MockHeaderRequest;\n+import com.dotcms.mock.request.MockHttpRequest;\n+import com.dotcms.mock.request.MockSessionRequest;\n+import com.dotcms.mock.response.MockHttpResponse;\n+import com.dotcms.publishing.FilterDescriptor;\n+import com.dotcms.rest.ResponseEntityView;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotDataException;\n+import com.google.common.collect.ImmutableMap;\n+import java.util.Map;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import javax.ws.rs.core.Response;\n+import javax.ws.rs.core.Response.Status;\n+import org.glassfish.jersey.internal.util.Base64;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import com.dotcms.rest.exception.SecurityException;\n+\n+public class PushPublishFilterResourceTest {\n+\n+    static HttpServletResponse response;\n+    static PushPublishFilterResource resource;\n+    static String filterKey;\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {\n+        // Setting web app environment\n+        IntegrationTestInitService.getInstance().init();\n+        resource = new PushPublishFilterResource();\n+        response = new MockHttpResponse();\n+\n+        APILocator.getPublisherAPI().getFilterDescriptorMap().clear();\n+        filterKey = \"filterTestAPI.yml\";\n+\n+        createFilter();\n+    }\n+\n+    private static void createFilter(){\n+        final Map<String,Object> filtersMap =\n+                ImmutableMap.of(\"dependencies\",true,\"relationships\",true,\"excludeClasses\",\"Host,Workflow\");\n+        final FilterDescriptor filterDescriptor =\n+                new FilterDescriptor(filterKey,\"Filter Test Title\",filtersMap,true,\"Reviewer,dotcms.org.2789\");\n+\n+        APILocator.getPublisherAPI().addFilterDescriptor(filterDescriptor);\n+    }\n+\n+    private HttpServletRequest getHttpRequest(final boolean authorization) {\n+        final MockHeaderRequest request = new MockHeaderRequest(\n+                new MockSessionRequest(\n+                        new MockAttributeRequest(new MockHttpRequest(\"localhost\", \"/\").request())\n+                                .request())\n+                        .request());\n+\n+        if(authorization) {\n+            request.setHeader(\"Authorization\",\n+                    \"Basic \" + new String(Base64.encode(\"admin@dotcms.com:admin\".getBytes())));\n+\n+        }\n+\n+        return request;\n+    }\n+\n+    @Test\n+    public void test_getFilter_withUser() throws DotDataException {", "originalCommit": "f5f5f5d1d5629f7c1b8c19b50e3941cd2181adf8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM2ODU3OA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433368578", "bodyText": "done", "author": "erickgonzalez", "createdAt": "2020-06-01T17:07:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE3MjM5Nw=="}], "type": "inlineReview", "revised_code": {"commit": "6487fe139932b9740065dd125e56be3a12c6905b", "chunk": "diff --git a/dotCMS/src/integration-test/java/com/dotcms/rest/api/v1/pushpublish/PushPublishFilterResourceTest.java b/dotCMS/src/integration-test/java/com/dotcms/rest/api/v1/pushpublish/PushPublishFilterResourceTest.java\nindex 0ec6b85224..e996f22486 100644\n--- a/dotCMS/src/integration-test/java/com/dotcms/rest/api/v1/pushpublish/PushPublishFilterResourceTest.java\n+++ b/dotCMS/src/integration-test/java/com/dotcms/rest/api/v1/pushpublish/PushPublishFilterResourceTest.java\n\n@@ -35,7 +35,7 @@ public class PushPublishFilterResourceTest {\n         resource = new PushPublishFilterResource();\n         response = new MockHttpResponse();\n \n-        APILocator.getPublisherAPI().getFilterDescriptorMap().clear();\n+        APILocator.getPublisherAPI().getFilterDescriptorMap().clear();//I suggest that the internal map is not exposed but offer the methods you need via API (e.g. clearFileDescriptors())\n         filterKey = \"filterTestAPI.yml\";\n \n         createFilter();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjU1NzExOQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r432557119", "bodyText": "I suggest that the internal map is not exposed but offer the methods you need via API (e.g. clearFileDescriptors())", "author": "dsilvam", "createdAt": "2020-05-29T15:18:33Z", "path": "dotCMS/src/integration-test/java/com/dotcms/rest/api/v1/pushpublish/PushPublishFilterResourceTest.java", "diffHunk": "@@ -0,0 +1,81 @@\n+package com.dotcms.rest.api.v1.pushpublish;\n+\n+import com.dotcms.mock.request.MockAttributeRequest;\n+import com.dotcms.mock.request.MockHeaderRequest;\n+import com.dotcms.mock.request.MockHttpRequest;\n+import com.dotcms.mock.request.MockSessionRequest;\n+import com.dotcms.mock.response.MockHttpResponse;\n+import com.dotcms.publishing.FilterDescriptor;\n+import com.dotcms.rest.ResponseEntityView;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotDataException;\n+import com.google.common.collect.ImmutableMap;\n+import java.util.Map;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import javax.ws.rs.core.Response;\n+import javax.ws.rs.core.Response.Status;\n+import org.glassfish.jersey.internal.util.Base64;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import com.dotcms.rest.exception.SecurityException;\n+\n+public class PushPublishFilterResourceTest {\n+\n+    static HttpServletResponse response;\n+    static PushPublishFilterResource resource;\n+    static String filterKey;\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {\n+        // Setting web app environment\n+        IntegrationTestInitService.getInstance().init();\n+        resource = new PushPublishFilterResource();\n+        response = new MockHttpResponse();\n+\n+        APILocator.getPublisherAPI().getFilterDescriptorMap().clear();", "originalCommit": "f5f5f5d1d5629f7c1b8c19b50e3941cd2181adf8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUwMDA2OA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433500068", "bodyText": "done", "author": "erickgonzalez", "createdAt": "2020-06-01T21:27:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjU1NzExOQ=="}], "type": "inlineReview", "revised_code": {"commit": "6487fe139932b9740065dd125e56be3a12c6905b", "chunk": "diff --git a/dotCMS/src/integration-test/java/com/dotcms/rest/api/v1/pushpublish/PushPublishFilterResourceTest.java b/dotCMS/src/integration-test/java/com/dotcms/rest/api/v1/pushpublish/PushPublishFilterResourceTest.java\nindex 0ec6b85224..e996f22486 100644\n--- a/dotCMS/src/integration-test/java/com/dotcms/rest/api/v1/pushpublish/PushPublishFilterResourceTest.java\n+++ b/dotCMS/src/integration-test/java/com/dotcms/rest/api/v1/pushpublish/PushPublishFilterResourceTest.java\n\n@@ -35,7 +35,7 @@ public class PushPublishFilterResourceTest {\n         resource = new PushPublishFilterResource();\n         response = new MockHttpResponse();\n \n-        APILocator.getPublisherAPI().getFilterDescriptorMap().clear();\n+        APILocator.getPublisherAPI().getFilterDescriptorMap().clear();//I suggest that the internal map is not exposed but offer the methods you need via API (e.g. clearFileDescriptors())\n         filterKey = \"filterTestAPI.yml\";\n \n         createFilter();\n"}}, {"oid": "9e8593d93789282fcc82356e8540e7e86c447b6f", "url": "https://github.com/dotCMS/core/commit/9e8593d93789282fcc82356e8540e7e86c447b6f", "message": "merge master", "committedDate": "2020-06-01T16:12:06Z", "type": "commit"}, {"oid": "e1dc6fd2913086a5131bbd8c0f0c7712863f3f97", "url": "https://github.com/dotCMS/core/commit/e1dc6fd2913086a5131bbd8c0f0c7712863f3f97", "message": "fix conflicts", "committedDate": "2020-06-01T16:12:57Z", "type": "commit"}, {"oid": "6487fe139932b9740065dd125e56be3a12c6905b", "url": "https://github.com/dotCMS/core/commit/6487fe139932b9740065dd125e56be3a12c6905b", "message": "#17806 feedback over tests files", "committedDate": "2020-06-01T17:47:08Z", "type": "commit"}, {"oid": "caca0f3c155c27d2407bfa8640fe05c1e3bff5e0", "url": "https://github.com/dotCMS/core/commit/caca0f3c155c27d2407bfa8640fe05c1e3bff5e0", "message": "#17806 change endpoint name", "committedDate": "2020-06-01T17:54:38Z", "type": "commit"}, {"oid": "b6a062025f2e8da405f1effe33a37cf7086b672a", "url": "https://github.com/dotCMS/core/commit/b6a062025f2e8da405f1effe33a37cf7086b672a", "message": "#17806 rename PublisherFilter methods", "committedDate": "2020-06-01T18:53:14Z", "type": "commit"}, {"oid": "eb94d44ae34c86d2a6932ee27a6252a83b55018a", "url": "https://github.com/dotCMS/core/commit/eb94d44ae34c86d2a6932ee27a6252a83b55018a", "message": "merge master", "committedDate": "2020-06-01T20:30:29Z", "type": "commit"}, {"oid": "3bb6f01e43fd12a32798c2d74fdcdb1851d9fae9", "url": "https://github.com/dotCMS/core/commit/3bb6f01e43fd12a32798c2d74fdcdb1851d9fae9", "message": "#17806 feedback remove visibility filterMap", "committedDate": "2020-06-01T21:40:28Z", "type": "commit"}, {"oid": "d303d8ce23e694dae36c96f07e87151f2bef3f36", "url": "https://github.com/dotCMS/core/commit/d303d8ce23e694dae36c96f07e87151f2bef3f36", "message": "remove util test class", "committedDate": "2020-06-01T21:57:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxNTIyMw==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433515223", "bodyText": "Issue found: Local variable 'contentlet1' could be declared final", "author": "dev-dotcms", "createdAt": "2020-06-01T22:05:15Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/workflows/actionlet/PushNowActionletTest.java", "diffHunk": "@@ -0,0 +1,216 @@\n+package com.dotmarketing.portlets.workflows.actionlet;\n+\n+import com.dotcms.contenttype.business.ContentTypeAPI;\n+import com.dotcms.contenttype.model.field.DataTypes;\n+import com.dotcms.contenttype.model.field.Field;\n+import com.dotcms.contenttype.model.field.FieldBuilder;\n+import com.dotcms.contenttype.model.field.TextField;\n+import com.dotcms.contenttype.model.type.BaseContentType;\n+import com.dotcms.contenttype.model.type.ContentType;\n+import com.dotcms.contenttype.model.type.ContentTypeBuilder;\n+import com.dotcms.contenttype.transform.contenttype.StructureTransformer;\n+import com.dotcms.datagen.TestUserUtils;\n+import com.dotcms.publisher.bundle.bean.Bundle;\n+import com.dotcms.publisher.environment.bean.Environment;\n+import com.dotcms.publisher.environment.business.EnvironmentAPI;\n+import com.dotcms.publishing.FilterDescriptor;\n+import com.dotcms.publishing.PublisherAPIImpl;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.beans.Permission;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.business.FactoryLocator;\n+import com.dotmarketing.business.PermissionAPI;\n+import com.dotmarketing.business.Role;\n+import com.dotmarketing.exception.AlreadyExistException;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.contentlet.business.ContentletAPI;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.dotmarketing.portlets.contentlet.model.IndexPolicy;\n+import com.dotmarketing.portlets.folders.business.FolderAPI;\n+import com.dotmarketing.portlets.workflows.business.BaseWorkflowIntegrationTest;\n+import com.dotmarketing.portlets.workflows.business.WorkflowAPI;\n+import com.dotmarketing.portlets.workflows.model.MultiKeyValue;\n+import com.dotmarketing.portlets.workflows.model.MultiSelectionWorkflowActionletParameter;\n+import com.dotmarketing.portlets.workflows.model.WorkflowActionClass;\n+import com.dotmarketing.portlets.workflows.model.WorkflowActionletParameter;\n+import com.dotmarketing.portlets.workflows.model.WorkflowProcessor;\n+import com.liferay.portal.model.User;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import javax.validation.constraints.AssertTrue;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+public class PushNowActionletTest extends BaseWorkflowIntegrationTest {\n+\n+    private static CreateSchemeStepActionResult schemeStepActionResult = null;\n+    private static WorkflowAPI workflowAPI = null;\n+    private static ContentletAPI contentletAPI = null;\n+    private static ContentTypeAPI contentTypeAPI = null;\n+    private static ContentType type = null;\n+    private static User adminUser;\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {\n+        //Setting web app environment\n+\n+        IntegrationTestInitService.getInstance().init();\n+        workflowAPI = APILocator.getWorkflowAPI();\n+        contentTypeAPI = APILocator.getContentTypeAPI(APILocator.systemUser());\n+        contentletAPI = APILocator.getContentletAPI();\n+        final long currentTime = System.currentTimeMillis();\n+        adminUser = TestUserUtils.getUser(TestUserUtils.getOrCreateAdminRole(),\"testPushNow@test.com\"+currentTime,\"testPushNowActionlet\"+currentTime,\"testPushNowActionlet\"+currentTime,\"testPushNowActionlet\"+currentTime);\n+\n+    }\n+\n+    private void createWorkflowWithPushNowActionlet(final String environmentNameParam, final String filterKeyParam)\n+            throws DotSecurityException, AlreadyExistException, DotDataException, InstantiationException, IllegalAccessException {\n+        // Create the scheme and actions. This method allows you to add just one sub-action\n+        final long sysTime = System.currentTimeMillis();\n+        schemeStepActionResult = createSchemeStepActionActionlet\n+                (\"itPushNowScheme_\" + sysTime, \"step1\", \"action1\",\n+                        CheckinContentActionlet.class);\n+        // Add the Push Now sub-action for this test\n+        addActionletToAction(schemeStepActionResult.getAction().getId(),\n+                PushNowActionlet.class, 1);\n+        // Add the required parameters of the sub-action\n+        final List<WorkflowActionClass> actionletClasses = getActionletsFromAction(\n+                schemeStepActionResult.getAction());\n+        WorkflowActionClass workflowActionClass = actionletClasses.get(1);\n+        addParameterValuesToActionlet(workflowActionClass,\n+                Arrays.asList(environmentNameParam,filterKeyParam));\n+        // Set the role ID of the people who can use the action\n+        addWhoCanUseToAction(schemeStepActionResult.getAction(),\n+                Collections.singletonList(TestUserUtils.getOrCreateAdminRole().getId()));\n+        // Associate the scheme to the content type\n+        workflowAPI.saveSchemesForStruct(new StructureTransformer(type).asStructure(),\n+                Collections.singletonList(schemeStepActionResult.getScheme()));\n+    }\n+\n+    private static void createTestContentType()\n+            throws DotDataException, DotSecurityException {\n+        type = contentTypeAPI.save(\n+                ContentTypeBuilder.builder(BaseContentType.CONTENT.immutableClass())\n+                        .folder(FolderAPI.SYSTEM_FOLDER).host(Host.SYSTEM_HOST)\n+                        .description(\"Content Type for testing the Push Now actionlet.\")\n+                        .name(\"PushNowActionletTest\"+System.currentTimeMillis())\n+                        .variable(\"PushNowActionletTest\"+System.currentTimeMillis()).build());\n+        final List<Field> fields = new ArrayList<>(type.fields());\n+        fields.add(FieldBuilder.builder(TextField.class).name(\"title\").variable(\"title\")\n+                .contentTypeId(type.id()).dataType(DataTypes.TEXT).indexed(true).build());\n+        fields.add(FieldBuilder.builder(TextField.class).name(\"txt\").variable(\"txt\")\n+                .contentTypeId(type.id()).dataType(DataTypes.TEXT).indexed(true).build());\n+        type = contentTypeAPI.save(type, fields);\n+\n+        //Give Permissions to the Content Type\n+        final Permission permission = new Permission(type.id(),TestUserUtils.getOrCreateAdminRole().getId(),PermissionAPI.PERMISSION_WRITE);\n+        APILocator.getPermissionAPI().save(permission,type,APILocator.systemUser(),false);\n+    }\n+\n+    private static void createFilterDescriptor(final String key, final boolean defaultFilter){\n+        final Map<String,Object> filtersMap = new HashMap<>();\n+        APILocator.getPublisherAPI().addFilterDescriptor(new FilterDescriptor(key,key,filtersMap,defaultFilter,\"DOTCMS_BACK_END_USER\"));\n+    }\n+\n+    private static Environment createEnvironment (final String name) throws DotDataException, DotSecurityException {\n+\n+        final EnvironmentAPI environmentAPI = APILocator.getEnvironmentAPI();\n+        final Environment environment = new Environment();\n+        final List<Permission> permissions = new ArrayList<>();\n+        permissions.add(new Permission(environment.getId(),\n+                APILocator.getRoleAPI().loadRoleByKey(adminUser.getUserId()).getId(),\n+                PermissionAPI.PERMISSION_USE));\n+\n+        environment.setName(name);\n+        environment.setPushToAll(false);\n+        environmentAPI.saveEnvironment(environment, permissions);\n+\n+        return environment;\n+    }\n+\n+    /**\n+     * This test is for checking if the Push Now Actionlet creates the Bundle with the filter selected.\n+     * When the Workflow with the sub-action is invoked it creates a Bundle to PP the contentlet,\n+     * that Bundle that is created must have the selected filter as filter Key.\n+     */\n+    @Test\n+    public void test_PushNowActionlet_BundleUsesFilterKeySet()\n+            throws DotSecurityException, DotDataException, IllegalAccessException, AlreadyExistException, InstantiationException {\n+        //Create Content Type\n+        createTestContentType();\n+        //Create Filter\n+        final String defaultFilterKey = \"testDefaultFilterKey.yml\"+System.currentTimeMillis();\n+        createFilterDescriptor(defaultFilterKey,true);\n+        final String filterKey = \"testFilterKey.yml\"+System.currentTimeMillis();\n+        createFilterDescriptor(filterKey,false);\n+        //Create Environment\n+        final Environment environment = createEnvironment(\"TestEnvironment_\" + System.currentTimeMillis());\n+        //Create Workflow and pass the env and the filterKey\n+        createWorkflowWithPushNowActionlet(environment.getName(),filterKey);\n+        //Create Contentlet\n+        final Contentlet cont = new Contentlet();\n+        cont.setContentTypeId(type.id());\n+        cont.setOwner(APILocator.systemUser().toString());\n+        cont.setModDate(new Date());\n+        cont.setLanguageId(1);\n+        cont.setStringProperty(\"title\", \"Test Save\");\n+        cont.setStringProperty(\"txt\", \"Test Save Text\");\n+        cont.setIndexPolicy(IndexPolicy.WAIT_FOR);\n+        cont.setBoolProperty(Contentlet.IS_TEST_MODE, true);\n+        Contentlet contentlet1 = contentletAPI.checkin(cont, adminUser, false);", "originalCommit": "d303d8ce23e694dae36c96f07e87151f2bef3f36", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxNTIzNA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433515234", "bodyText": "Issue found: Unnecessary use of fully qualified name 'Assert.assertEquals' due to existing static import 'org.junit.Assert.assertEquals'", "author": "dev-dotcms", "createdAt": "2020-06-01T22:05:16Z", "path": "dotCMS/src/integration-test/java/com/dotcms/publishing/PublisherAPITest.java", "diffHunk": "@@ -319,4 +327,304 @@ private FileFilter getNoBundleXMLFileFilter() {\n         return file -> !file.getAbsolutePath().endsWith(\"bundle.xml\");\n     }\n \n+    /**\n+     * Method to test: {@link PublisherAPI#addFilterDescriptor(FilterDescriptor)}\n+     * Given Scenario: Create a new FilterDescriptor and add it to the FilterDescriptorMap\n+     * ExpectedResult: the filterDescriptor is added successfully to the map\n+     *\n+     */\n+    @Test\n+    public void test_addFilter_success() throws DotDataException {\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final Map<String,Object> filtersMap =\n+                ImmutableMap.of(\"dependencies\",true,\"relationships\",true,\"excludeClasses\",\"Host,Workflow\");\n+        final FilterDescriptor filterDescriptor =\n+                new FilterDescriptor(\"filterTestAPI.yml\",\"Filter Test Title\",filtersMap,false,\"Reviewer,dotcms.org.2789\");\n+\n+        publisherAPI.addFilterDescriptor(filterDescriptor);\n+\n+        final List<FilterDescriptor> filterDescriptorList = APILocator.getPublisherAPI().getFiltersDescriptorsByRole(\n+                TestUserUtils.getAdminUser());\n+        Assert.assertFalse(filterDescriptorList.isEmpty());\n+        Assert.assertTrue(filterDescriptorList.stream().anyMatch(filter -> filter.getKey().equalsIgnoreCase(filterDescriptor.getKey())));\n+    }\n+\n+    /**\n+     * Method to test: {@link PublisherAPI#getFiltersDescriptorsByRole(User)}\n+     * Given Scenario: Get the filters that the CMSAdmin has access to\n+     * ExpectedResult: CMSAdmin has access to all the filters\n+     *\n+     */\n+    @Test\n+    public void test_getFiltersByRole_CMSAdmin_returnAllFilters() throws DotDataException {\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final Map<String,Object> filtersMap =\n+                ImmutableMap.of(\"dependencies\",true,\"relationships\",true,\"excludeClasses\",\"Host,Workflow\");\n+\n+        final FilterDescriptor filterDescriptor1 =\n+                new FilterDescriptor(\"filterTest1.yml\",\"Filter Test Title 1\",filtersMap,false,\"Reviewer,dotcms.org.2789\");\n+\n+        final FilterDescriptor filterDescriptor2 =\n+                new FilterDescriptor(\"filterTest2.yml\",\"Filter Test Title 2\",filtersMap,false,\"Reviewer\");\n+\n+        publisherAPI.addFilterDescriptor(filterDescriptor1);\n+        publisherAPI.addFilterDescriptor(filterDescriptor2);\n+\n+        final User newUser = new UserDataGen().nextPersisted();\n+        APILocator.getRoleAPI().addRoleToUser(APILocator.getRoleAPI().loadCMSAdminRole(), newUser);\n+\n+        final List<FilterDescriptor> filterDescriptors = publisherAPI.getFiltersDescriptorsByRole(newUser);\n+        Assert.assertFalse(filterDescriptors.isEmpty());\n+        Assert.assertTrue(filterDescriptors.contains(filterDescriptor1));\n+        Assert.assertTrue(filterDescriptors.contains(filterDescriptor2));\n+    }\n+\n+    /***\n+     * This test gets the filters that the user has access.\n+     * This test the userId of the new User is set into possible roles in the Filter\n+     *\n+     * @throws DotDataException\n+     */\n+    @Test\n+    public void test_getFiltersByRole_nonCMSAdmin_userId() throws DotDataException {\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final User newUser = new UserDataGen().nextPersisted();\n+\n+        final Map<String,Object> filtersMap =\n+                ImmutableMap.of(\"dependencies\",true,\"relationships\",true,\"excludeClasses\",\"Host,Workflow\");\n+        final FilterDescriptor filterDescriptor1 =\n+                new FilterDescriptor(\"filterTest1.yml\",\"Filter Test Title 1\",filtersMap,false,\"Reviewer,\" + newUser.getUserId());\n+\n+        final FilterDescriptor filterDescriptor2 =\n+                new FilterDescriptor(\"filterTest2.yml\",\"Filter Test Title 2\",filtersMap,false,\"Reviewer\");\n+\n+        publisherAPI.addFilterDescriptor(filterDescriptor1);\n+        publisherAPI.addFilterDescriptor(filterDescriptor2);\n+\n+        final List<FilterDescriptor> filterDescriptors = publisherAPI.getFiltersDescriptorsByRole(newUser);\n+        Logger.info(this,filterDescriptors.toString());\n+        Assert.assertFalse(filterDescriptors.isEmpty());\n+        Assert.assertTrue(filterDescriptors.contains(filterDescriptor1));\n+        Assert.assertFalse(filterDescriptors.contains(filterDescriptor2));\n+    }\n+\n+    /***\n+     * This test gets the filters that the user has access.\n+     * This test creates 3 Roles and 5 users with the following Hierarchy:\n+     * Role A (user A)\n+     *  |_____ Role B (user B)\n+     *           |_____ Role C (user C and user D)\n+     *\n+     * On the roles field is set the Role B and the userId of user C.\n+     *\n+     * Since Role Hierarchy is respected this is the expected result:\n+     * User A - Have Access to the Filter\n+     * User B - Have Access to the Filter\n+     * User C - Have Access to the Filter\n+     * User D - Do not have access to the Filter\n+     *\n+     * @throws DotDataException\n+     */\n+    @Test\n+    public void test_getFiltersByRole_nonCMSAdmin_RoleHierarchy() throws DotDataException {\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final User userA = new UserDataGen().nextPersisted();\n+        final User userB = new UserDataGen().nextPersisted();\n+        final User userC = new UserDataGen().nextPersisted();\n+        final User userD = new UserDataGen().nextPersisted();\n+\n+        final Role roleA = new RoleDataGen().nextPersisted();\n+        final Role roleB = new RoleDataGen().parent(roleA.getId()).nextPersisted();\n+        final Role roleC = new RoleDataGen().parent(roleB.getId()).nextPersisted();\n+\n+        APILocator.getRoleAPI().addRoleToUser(roleA,userA);\n+        APILocator.getRoleAPI().addRoleToUser(roleB,userB);\n+        APILocator.getRoleAPI().addRoleToUser(roleC,userC);\n+        APILocator.getRoleAPI().addRoleToUser(roleC,userD);\n+\n+        final Map<String,Object> filtersMap1 =\n+                ImmutableMap.of(\"dependencies\",true,\"relationships\",true,\"excludeClasses\",\"Host,Workflow\");\n+        final FilterDescriptor filterDescriptor1 =\n+                new FilterDescriptor(\"filterTest1.yml\",\"Filter Test Title 1\",filtersMap1,false,roleB.getRoleKey()+','+userC.getUserId());\n+\n+        publisherAPI.addFilterDescriptor(filterDescriptor1);\n+\n+        //User A\n+        List<FilterDescriptor> filterDescriptors = publisherAPI.getFiltersDescriptorsByRole(userA);\n+        Logger.info(this,filterDescriptors.toString());\n+        Assert.assertFalse(filterDescriptors.isEmpty());\n+        Assert.assertTrue(filterDescriptors.contains(filterDescriptor1));\n+\n+        //User B\n+        filterDescriptors = publisherAPI.getFiltersDescriptorsByRole(userB);\n+        Logger.info(this,filterDescriptors.toString());\n+        Assert.assertFalse(filterDescriptors.isEmpty());\n+        Assert.assertTrue(filterDescriptors.contains(filterDescriptor1));\n+\n+        //User C\n+        filterDescriptors = publisherAPI.getFiltersDescriptorsByRole(userC);\n+        Logger.info(this,filterDescriptors.toString());\n+        Assert.assertFalse(filterDescriptors.isEmpty());\n+        Assert.assertTrue(filterDescriptors.contains(filterDescriptor1));\n+\n+        //User D\n+        filterDescriptors = publisherAPI.getFiltersDescriptorsByRole(userD);\n+        Logger.info(this,filterDescriptors.toString());\n+        Assert.assertTrue(filterDescriptors.isEmpty());\n+    }\n+\n+    private void createFilterDescriptor(final String key,final String title,final boolean defaultFilter,Map<String,Object> filtersMap){\n+        if(!UtilMethods.isSet(filtersMap)){\n+            final List<Object> listExcludeClasses = new ArrayList();\n+            listExcludeClasses.add(\"User\");\n+            listExcludeClasses.add(\"OSGI\");\n+            filtersMap =\n+                    ImmutableMap.of(\"dependencies\",true,\"relationships\",true,\"excludeClasses\",\n+                            listExcludeClasses);\n+        }\n+        publisherAPI.addFilterDescriptor(new FilterDescriptor(key,title,filtersMap,defaultFilter,\"DOTCMS_BACK_END_USER\"));\n+    }\n+\n+    /**\n+     * This test creates and gets a FilterDescriptor using the key as reference.\n+     */\n+    @Test\n+    public void test_getFilterDescriptorByKey_success(){\n+        final String key = \"TestByKeySuccess.yml\";\n+        createFilterDescriptor(key,\"TestByKeySuccess\",true,null);\n+        final FilterDescriptor filterDescriptor = publisherAPI.getFilterDescriptorByKey(key);\n+        Assert.assertNotNull(filterDescriptor);\n+        Assert.assertEquals(key,filterDescriptor.getKey());\n+    }\n+\n+    /**\n+     * This test creates 2 FilterDescriptors (one set as default) tries to get a FilterDescriptor, but since key is not passed,\n+     * it returns the FilterDescriptor set as default.\n+     */\n+    @Test\n+    public void test_getFilterDescriptorByKey_emptyKey_returnDefaultFilter(){\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final String keyDefault = \"TestByKeyEmptyKeyDefault.yml\";\n+        createFilterDescriptor(keyDefault,\"TestByKeyEmptyKeyDefault\",true,null);\n+\n+        final String keyNonDefault = \"TestByKeyEmptyKeyNonDefault.yml\";\n+        createFilterDescriptor(keyNonDefault,\"TestByKeyEmptyKeyDefault\",false,null);\n+\n+        final FilterDescriptor filterDescriptor = publisherAPI.getFilterDescriptorByKey(\"\");\n+        Assert.assertNotNull(filterDescriptor);\n+        Assert.assertEquals(keyDefault,filterDescriptor.getKey());\n+    }\n+\n+    /**\n+     * This test creates 2 FilterDescriptors (one set as default) tries to get a FilterDescriptor, but since key passed does not belong to any FilterDescriptor,\n+     * it returns the FilterDescriptor set as default.\n+     */\n+    @Test\n+    public void test_getFilterDescriptorByKey_filterKeyDoesNotExist_returnDefaultFilter(){\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final String keyDefault = \"TestByKeyDoesNotExistDefault.yml\";\n+        createFilterDescriptor(keyDefault,\"TestByKeyDoesNotExistDefault\",true,null);\n+\n+        final String keyNonDefault = \"TestByKeyDoesNotExistNonDefault.yml\";\n+        createFilterDescriptor(keyNonDefault,\"TestByKeyDoesNotExistNonDefault\",false,null);\n+\n+        final FilterDescriptor filterDescriptor = publisherAPI.getFilterDescriptorByKey(\"thisKeyNotExists\");\n+        Assert.assertNotNull(filterDescriptor);\n+        Assert.assertEquals(keyDefault,filterDescriptor.getKey());\n+    }\n+\n+    /**\n+     * This test creates a FilterDescriptor and a Bundle (with the created FilterDescriptor) and\n+     * returns a PublisherFilter with the filters of the FilterDescriptor.\n+     *\n+     * In this case the FilterDescriptor has all the possible filters.\n+     */\n+    @Test\n+    public void test_createPublisherFilter_withAllFilters()\n+            throws DotDataException, DotSecurityException {\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final String filterKey = \"TestCreatePublisherFilterAllFilters.yml\";\n+        final Map<String,Object> filtersMap = new HashMap<>();\n+        filtersMap.put(\"excludeQuery\",\"+baseType:5\");\n+        final List<Object> listExcludeClasses = new ArrayList();\n+        listExcludeClasses.add(\"User\");\n+        listExcludeClasses.add(\"Host\");\n+        listExcludeClasses.add(\"ContentType\");\n+        filtersMap.put(\"excludeClasses\", listExcludeClasses);\n+        filtersMap.put(\"dependencies\",true);\n+        filtersMap.put(\"excludeDependencyQuery\",\"+baseType:7\");\n+        filtersMap.put(\"excludeDependencyClasses\", listExcludeClasses);\n+        filtersMap.put(\"forcePush\",false);\n+        filtersMap.put(\"relationships\",true);\n+        createFilterDescriptor(filterKey,\"TestCreatePublisherFilter\",true,filtersMap);\n+\n+        final String bundleName = \"testCreatePublisherFilterAllFilters\";\n+        Bundle bundle = new Bundle(bundleName, new Date(), null, adminUser.getUserId(),\n+                (Boolean) filtersMap.get(\"forcePush\"),filterKey);\n+        APILocator.getBundleAPI().saveBundle(bundle);\n+        bundle = APILocator.getBundleAPI().getBundleByName(bundleName);\n+        Assert.assertNotNull(bundle);\n+        Assert.assertEquals(filterKey,bundle.getFilterKey());\n+\n+        final PublisherFilter publisherFilter = publisherAPI.createPublisherFilter(bundle.getId());\n+        Assert.assertNotNull(publisherFilter);\n+        Assert.assertEquals(filtersMap.get(\"dependencies\"),publisherFilter.isDependencies());", "originalCommit": "d303d8ce23e694dae36c96f07e87151f2bef3f36", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxNTI0Mw==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433515243", "bodyText": "Issue found: Unnecessary use of fully qualified name 'Assert.assertEquals' due to existing static import 'org.junit.Assert.assertEquals'", "author": "dev-dotcms", "createdAt": "2020-06-01T22:05:17Z", "path": "dotCMS/src/integration-test/java/com/dotcms/publishing/PublisherAPITest.java", "diffHunk": "@@ -319,4 +327,304 @@ private FileFilter getNoBundleXMLFileFilter() {\n         return file -> !file.getAbsolutePath().endsWith(\"bundle.xml\");\n     }\n \n+    /**\n+     * Method to test: {@link PublisherAPI#addFilterDescriptor(FilterDescriptor)}\n+     * Given Scenario: Create a new FilterDescriptor and add it to the FilterDescriptorMap\n+     * ExpectedResult: the filterDescriptor is added successfully to the map\n+     *\n+     */\n+    @Test\n+    public void test_addFilter_success() throws DotDataException {\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final Map<String,Object> filtersMap =\n+                ImmutableMap.of(\"dependencies\",true,\"relationships\",true,\"excludeClasses\",\"Host,Workflow\");\n+        final FilterDescriptor filterDescriptor =\n+                new FilterDescriptor(\"filterTestAPI.yml\",\"Filter Test Title\",filtersMap,false,\"Reviewer,dotcms.org.2789\");\n+\n+        publisherAPI.addFilterDescriptor(filterDescriptor);\n+\n+        final List<FilterDescriptor> filterDescriptorList = APILocator.getPublisherAPI().getFiltersDescriptorsByRole(\n+                TestUserUtils.getAdminUser());\n+        Assert.assertFalse(filterDescriptorList.isEmpty());\n+        Assert.assertTrue(filterDescriptorList.stream().anyMatch(filter -> filter.getKey().equalsIgnoreCase(filterDescriptor.getKey())));\n+    }\n+\n+    /**\n+     * Method to test: {@link PublisherAPI#getFiltersDescriptorsByRole(User)}\n+     * Given Scenario: Get the filters that the CMSAdmin has access to\n+     * ExpectedResult: CMSAdmin has access to all the filters\n+     *\n+     */\n+    @Test\n+    public void test_getFiltersByRole_CMSAdmin_returnAllFilters() throws DotDataException {\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final Map<String,Object> filtersMap =\n+                ImmutableMap.of(\"dependencies\",true,\"relationships\",true,\"excludeClasses\",\"Host,Workflow\");\n+\n+        final FilterDescriptor filterDescriptor1 =\n+                new FilterDescriptor(\"filterTest1.yml\",\"Filter Test Title 1\",filtersMap,false,\"Reviewer,dotcms.org.2789\");\n+\n+        final FilterDescriptor filterDescriptor2 =\n+                new FilterDescriptor(\"filterTest2.yml\",\"Filter Test Title 2\",filtersMap,false,\"Reviewer\");\n+\n+        publisherAPI.addFilterDescriptor(filterDescriptor1);\n+        publisherAPI.addFilterDescriptor(filterDescriptor2);\n+\n+        final User newUser = new UserDataGen().nextPersisted();\n+        APILocator.getRoleAPI().addRoleToUser(APILocator.getRoleAPI().loadCMSAdminRole(), newUser);\n+\n+        final List<FilterDescriptor> filterDescriptors = publisherAPI.getFiltersDescriptorsByRole(newUser);\n+        Assert.assertFalse(filterDescriptors.isEmpty());\n+        Assert.assertTrue(filterDescriptors.contains(filterDescriptor1));\n+        Assert.assertTrue(filterDescriptors.contains(filterDescriptor2));\n+    }\n+\n+    /***\n+     * This test gets the filters that the user has access.\n+     * This test the userId of the new User is set into possible roles in the Filter\n+     *\n+     * @throws DotDataException\n+     */\n+    @Test\n+    public void test_getFiltersByRole_nonCMSAdmin_userId() throws DotDataException {\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final User newUser = new UserDataGen().nextPersisted();\n+\n+        final Map<String,Object> filtersMap =\n+                ImmutableMap.of(\"dependencies\",true,\"relationships\",true,\"excludeClasses\",\"Host,Workflow\");\n+        final FilterDescriptor filterDescriptor1 =\n+                new FilterDescriptor(\"filterTest1.yml\",\"Filter Test Title 1\",filtersMap,false,\"Reviewer,\" + newUser.getUserId());\n+\n+        final FilterDescriptor filterDescriptor2 =\n+                new FilterDescriptor(\"filterTest2.yml\",\"Filter Test Title 2\",filtersMap,false,\"Reviewer\");\n+\n+        publisherAPI.addFilterDescriptor(filterDescriptor1);\n+        publisherAPI.addFilterDescriptor(filterDescriptor2);\n+\n+        final List<FilterDescriptor> filterDescriptors = publisherAPI.getFiltersDescriptorsByRole(newUser);\n+        Logger.info(this,filterDescriptors.toString());\n+        Assert.assertFalse(filterDescriptors.isEmpty());\n+        Assert.assertTrue(filterDescriptors.contains(filterDescriptor1));\n+        Assert.assertFalse(filterDescriptors.contains(filterDescriptor2));\n+    }\n+\n+    /***\n+     * This test gets the filters that the user has access.\n+     * This test creates 3 Roles and 5 users with the following Hierarchy:\n+     * Role A (user A)\n+     *  |_____ Role B (user B)\n+     *           |_____ Role C (user C and user D)\n+     *\n+     * On the roles field is set the Role B and the userId of user C.\n+     *\n+     * Since Role Hierarchy is respected this is the expected result:\n+     * User A - Have Access to the Filter\n+     * User B - Have Access to the Filter\n+     * User C - Have Access to the Filter\n+     * User D - Do not have access to the Filter\n+     *\n+     * @throws DotDataException\n+     */\n+    @Test\n+    public void test_getFiltersByRole_nonCMSAdmin_RoleHierarchy() throws DotDataException {\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final User userA = new UserDataGen().nextPersisted();\n+        final User userB = new UserDataGen().nextPersisted();\n+        final User userC = new UserDataGen().nextPersisted();\n+        final User userD = new UserDataGen().nextPersisted();\n+\n+        final Role roleA = new RoleDataGen().nextPersisted();\n+        final Role roleB = new RoleDataGen().parent(roleA.getId()).nextPersisted();\n+        final Role roleC = new RoleDataGen().parent(roleB.getId()).nextPersisted();\n+\n+        APILocator.getRoleAPI().addRoleToUser(roleA,userA);\n+        APILocator.getRoleAPI().addRoleToUser(roleB,userB);\n+        APILocator.getRoleAPI().addRoleToUser(roleC,userC);\n+        APILocator.getRoleAPI().addRoleToUser(roleC,userD);\n+\n+        final Map<String,Object> filtersMap1 =\n+                ImmutableMap.of(\"dependencies\",true,\"relationships\",true,\"excludeClasses\",\"Host,Workflow\");\n+        final FilterDescriptor filterDescriptor1 =\n+                new FilterDescriptor(\"filterTest1.yml\",\"Filter Test Title 1\",filtersMap1,false,roleB.getRoleKey()+','+userC.getUserId());\n+\n+        publisherAPI.addFilterDescriptor(filterDescriptor1);\n+\n+        //User A\n+        List<FilterDescriptor> filterDescriptors = publisherAPI.getFiltersDescriptorsByRole(userA);\n+        Logger.info(this,filterDescriptors.toString());\n+        Assert.assertFalse(filterDescriptors.isEmpty());\n+        Assert.assertTrue(filterDescriptors.contains(filterDescriptor1));\n+\n+        //User B\n+        filterDescriptors = publisherAPI.getFiltersDescriptorsByRole(userB);\n+        Logger.info(this,filterDescriptors.toString());\n+        Assert.assertFalse(filterDescriptors.isEmpty());\n+        Assert.assertTrue(filterDescriptors.contains(filterDescriptor1));\n+\n+        //User C\n+        filterDescriptors = publisherAPI.getFiltersDescriptorsByRole(userC);\n+        Logger.info(this,filterDescriptors.toString());\n+        Assert.assertFalse(filterDescriptors.isEmpty());\n+        Assert.assertTrue(filterDescriptors.contains(filterDescriptor1));\n+\n+        //User D\n+        filterDescriptors = publisherAPI.getFiltersDescriptorsByRole(userD);\n+        Logger.info(this,filterDescriptors.toString());\n+        Assert.assertTrue(filterDescriptors.isEmpty());\n+    }\n+\n+    private void createFilterDescriptor(final String key,final String title,final boolean defaultFilter,Map<String,Object> filtersMap){\n+        if(!UtilMethods.isSet(filtersMap)){\n+            final List<Object> listExcludeClasses = new ArrayList();\n+            listExcludeClasses.add(\"User\");\n+            listExcludeClasses.add(\"OSGI\");\n+            filtersMap =\n+                    ImmutableMap.of(\"dependencies\",true,\"relationships\",true,\"excludeClasses\",\n+                            listExcludeClasses);\n+        }\n+        publisherAPI.addFilterDescriptor(new FilterDescriptor(key,title,filtersMap,defaultFilter,\"DOTCMS_BACK_END_USER\"));\n+    }\n+\n+    /**\n+     * This test creates and gets a FilterDescriptor using the key as reference.\n+     */\n+    @Test\n+    public void test_getFilterDescriptorByKey_success(){\n+        final String key = \"TestByKeySuccess.yml\";\n+        createFilterDescriptor(key,\"TestByKeySuccess\",true,null);\n+        final FilterDescriptor filterDescriptor = publisherAPI.getFilterDescriptorByKey(key);\n+        Assert.assertNotNull(filterDescriptor);\n+        Assert.assertEquals(key,filterDescriptor.getKey());\n+    }\n+\n+    /**\n+     * This test creates 2 FilterDescriptors (one set as default) tries to get a FilterDescriptor, but since key is not passed,\n+     * it returns the FilterDescriptor set as default.\n+     */\n+    @Test\n+    public void test_getFilterDescriptorByKey_emptyKey_returnDefaultFilter(){\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final String keyDefault = \"TestByKeyEmptyKeyDefault.yml\";\n+        createFilterDescriptor(keyDefault,\"TestByKeyEmptyKeyDefault\",true,null);\n+\n+        final String keyNonDefault = \"TestByKeyEmptyKeyNonDefault.yml\";\n+        createFilterDescriptor(keyNonDefault,\"TestByKeyEmptyKeyDefault\",false,null);\n+\n+        final FilterDescriptor filterDescriptor = publisherAPI.getFilterDescriptorByKey(\"\");\n+        Assert.assertNotNull(filterDescriptor);\n+        Assert.assertEquals(keyDefault,filterDescriptor.getKey());", "originalCommit": "d303d8ce23e694dae36c96f07e87151f2bef3f36", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxNTI0Ng==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433515246", "bodyText": "Issue found: Avoid using redundant field initializer for 'schemeStepActionResult'", "author": "dev-dotcms", "createdAt": "2020-06-01T22:05:18Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/workflows/actionlet/PushNowActionletTest.java", "diffHunk": "@@ -0,0 +1,216 @@\n+package com.dotmarketing.portlets.workflows.actionlet;\n+\n+import com.dotcms.contenttype.business.ContentTypeAPI;\n+import com.dotcms.contenttype.model.field.DataTypes;\n+import com.dotcms.contenttype.model.field.Field;\n+import com.dotcms.contenttype.model.field.FieldBuilder;\n+import com.dotcms.contenttype.model.field.TextField;\n+import com.dotcms.contenttype.model.type.BaseContentType;\n+import com.dotcms.contenttype.model.type.ContentType;\n+import com.dotcms.contenttype.model.type.ContentTypeBuilder;\n+import com.dotcms.contenttype.transform.contenttype.StructureTransformer;\n+import com.dotcms.datagen.TestUserUtils;\n+import com.dotcms.publisher.bundle.bean.Bundle;\n+import com.dotcms.publisher.environment.bean.Environment;\n+import com.dotcms.publisher.environment.business.EnvironmentAPI;\n+import com.dotcms.publishing.FilterDescriptor;\n+import com.dotcms.publishing.PublisherAPIImpl;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.beans.Permission;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.business.FactoryLocator;\n+import com.dotmarketing.business.PermissionAPI;\n+import com.dotmarketing.business.Role;\n+import com.dotmarketing.exception.AlreadyExistException;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.contentlet.business.ContentletAPI;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.dotmarketing.portlets.contentlet.model.IndexPolicy;\n+import com.dotmarketing.portlets.folders.business.FolderAPI;\n+import com.dotmarketing.portlets.workflows.business.BaseWorkflowIntegrationTest;\n+import com.dotmarketing.portlets.workflows.business.WorkflowAPI;\n+import com.dotmarketing.portlets.workflows.model.MultiKeyValue;\n+import com.dotmarketing.portlets.workflows.model.MultiSelectionWorkflowActionletParameter;\n+import com.dotmarketing.portlets.workflows.model.WorkflowActionClass;\n+import com.dotmarketing.portlets.workflows.model.WorkflowActionletParameter;\n+import com.dotmarketing.portlets.workflows.model.WorkflowProcessor;\n+import com.liferay.portal.model.User;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import javax.validation.constraints.AssertTrue;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+public class PushNowActionletTest extends BaseWorkflowIntegrationTest {\n+\n+    private static CreateSchemeStepActionResult schemeStepActionResult = null;", "originalCommit": "d303d8ce23e694dae36c96f07e87151f2bef3f36", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxNTI1Mg==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433515252", "bodyText": "Issue found: These nested if statements could be combined", "author": "dev-dotcms", "createdAt": "2020-06-01T22:05:19Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -357,35 +370,55 @@ public void setDependencies() throws DotSecurityException, DotDataException, Dot\n \t * <li>Folders</li>\n \t * </ul>\n \t */\n-\tprivate void setLinkDependencies() {\n+\tprivate void setLinkDependencies(final PublisherFilter publisherFilter)  {\n \t\tfor(String linkId : linksSet) {\n \t\t\ttry {\n \t\t\t\tIdentifier ident=APILocator.getIdentifierAPI().find(linkId);\n-\t\t\t\tFolder ff = APILocator.getFolderAPI().findFolderByPath(ident.getParentPath(), ident.getHostId(), user, false);\n-\t\t\t\tfolders.addOrClean( ff.getInode(), ff.getModDate());\n-\t\t\t\tfoldersSet.add(ff.getInode());\n \n-\t\t\t\tHost hh=APILocator.getHostAPI().find(ident.getHostId(), user, false);\n-\t\t\t\thosts.addOrClean( hh.getIdentifier(), hh.getModDate());\n-\t\t\t\thostsSet.add(hh.getIdentifier());\n+\t\t\t\t// Folder Dependencies\n+\t\t\t\tif(!publisherFilter.doesExcludeDependencyClassesContainsType(PusheableAsset.FOLDER.getType())) {\n+\t\t\t\t\tfinal Folder folder = APILocator.getFolderAPI()\n+\t\t\t\t\t\t\t.findFolderByPath(ident.getParentPath(), ident.getHostId(), user,\n+\t\t\t\t\t\t\t\t\tfalse);\n+\t\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n+\t\t\t\t\tfoldersSet.add(folder.getInode());\n+\t\t\t\t}\n \n-\t\t\t\tLink link = APILocator.getMenuLinkAPI().findWorkingLinkById(linkId, user, false);\n+\t\t\t\t// Host Dependencies\n+\t\t\t\tif(!publisherFilter.doesExcludeDependencyClassesContainsType(PusheableAsset.SITE.getType())) {\n+\t\t\t\t\tfinal Host host = APILocator.getHostAPI().find(ident.getHostId(), user, false);\n+\t\t\t\t\thosts.addOrClean(host.getIdentifier(), host.getModDate());\n+\t\t\t\t\thostsSet.add(host.getIdentifier());\n+\t\t\t\t}\n \n-\t\t\t\tif(link!=null) {\n+\t\t\t\t// Content Dependencies\n+\t\t\t\tif(!publisherFilter.doesExcludeDependencyClassesContainsType(PusheableAsset.CONTENTLET.getType())) {\n+\t\t\t\t\tfinal Link link = APILocator.getMenuLinkAPI()\n+\t\t\t\t\t\t\t.findWorkingLinkById(linkId, user, false);\n \n-\t\t\t\t\tif(link.getLinkType().equals(Link.LinkType.INTERNAL.toString())) {\n-\t\t\t\t\t\tIdentifier id = APILocator.getIdentifierAPI().find(link.getInternalLinkIdentifier());\n+\t\t\t\t\tif (link != null) {\n \n-\t\t\t\t\t\t// add file/content dependencies. will also work with htmlpages as content\n-\t\t\t\t\t\tif (InodeUtils.isSet(id.getInode()) && id.getAssetType().equals(\"contentlet\")) {\n-\t\t\t\t\t\t\tList<Contentlet> contentList = APILocator.getContentletAPI().search(\"+identifier:\"+id.getId(), 0, 0, \"moddate\", user, false);\n+\t\t\t\t\t\tif (link.getLinkType().equals(Link.LinkType.INTERNAL.toString())) {", "originalCommit": "d303d8ce23e694dae36c96f07e87151f2bef3f36", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxNTI1OQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433515259", "bodyText": "Issue found: Local variable 'struct' could be declared final", "author": "dev-dotcms", "createdAt": "2020-06-01T22:05:20Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -952,102 +1078,143 @@ private void setStructureDependencies() throws DotDataException, DotSecurityExce\n \t * @throws DotDataException\n \t * @throws DotSecurityException\n \t */\n-\tprivate void structureDependencyHelper(String stInode) throws DotDataException, DotSecurityException{\n+\tprivate void structureDependencyHelper(final String stInode, final PublisherFilter publisherFilter) throws DotDataException, DotSecurityException{\n \t\tfinal Structure structure = CacheLocator.getContentTypeCache().getStructureByInode(stInode);\n-\t\tfinal Host host = APILocator.getHostAPI().find(structure.getHost(), user, false);\n-\t\thosts.addOrClean(structure.getHost(), host.getModDate()); // add the host dependency\n \n-\t\tfinal Folder folder = APILocator.getFolderAPI().find(structure.getFolder(), user, false);\n-\t\tfolders.addOrClean(structure.getFolder(), folder.getModDate()); // add the folder dependency\n+\t\t// Host Dependency\n+\t\tif(!publisherFilter.doesExcludeDependencyClassesContainsType(PusheableAsset.SITE.getType())) {\n+\t\t\tfinal Host host = APILocator.getHostAPI().find(structure.getHost(), user, false);\n+\t\t\thosts.addOrClean(structure.getHost(), host.getModDate()); // add the host dependency\n+\t\t}\n \n-\t\ttry {\n-\t\t\tfinal List<WorkflowScheme> schemes = APILocator.getWorkflowAPI().findSchemesForStruct(structure);\n-\t\t\tfor (final WorkflowScheme scheme : schemes) {\n-\t\t\t\tworkflows.addOrClean(scheme.getId(), scheme.getModDate());\n+\t\t// Folder Dependencies\n+\t\tif(!publisherFilter.doesExcludeDependencyClassesContainsType(PusheableAsset.FOLDER.getType())) {\n+\t\t\tfinal Folder folder = APILocator.getFolderAPI()\n+\t\t\t\t\t.find(structure.getFolder(), user, false);\n+\t\t\tfolders.addOrClean(structure.getFolder(),\n+\t\t\t\t\tfolder.getModDate()); // add the folder dependency\n+\t\t}\n+\n+\t\t// Workflows Dependencies\n+\t\tif(!publisherFilter.doesExcludeDependencyClassesContainsType(PusheableAsset.WORKFLOW.getType())) {\n+\t\t\ttry {\n+\t\t\t\tfinal List<WorkflowScheme> schemes = APILocator.getWorkflowAPI()\n+\t\t\t\t\t\t.findSchemesForStruct(structure);\n+\t\t\t\tfor (final WorkflowScheme scheme : schemes) {\n+\t\t\t\t\tworkflows.addOrClean(scheme.getId(), scheme.getModDate());\n+\t\t\t\t}\n+\t\t\t} catch (DotDataException e) {\n+\t\t\t\tLogger.debug(getClass(),\n+\t\t\t\t\t\t() -> \"Could not get the Workflow Scheme Dependency for Structure ID: \"\n+\t\t\t\t\t\t\t\t+ structure.getInode());\n \t\t\t}\n-\t\t} catch (DotDataException e) {\n-\t\t\tLogger.debug(getClass(), ()->\"Could not get the Workflow Scheme Dependency for Structure ID: \" + structure.getInode());\n \t\t}\n \n-        APILocator.getCategoryAPI().findCategories(new StructureTransformer(structure).from(), user).forEach(category -> {\n-            this.categories.addOrClean(category.getCategoryId(), category.getModDate());\n-        });\n+\t\t// Categories Dependencies\n+\t\tif(!publisherFilter.doesExcludeDependencyClassesContainsType(PusheableAsset.CATEGORY.getType())) {\n+\t\t\tAPILocator.getCategoryAPI()\n+\t\t\t\t\t.findCategories(new StructureTransformer(structure).from(), user)\n+\t\t\t\t\t.forEach(category -> {\n+\t\t\t\t\t\tthis.categories.addOrClean(category.getCategoryId(), category.getModDate());\n+\t\t\t\t\t});\n+\t\t}\n \n \t\t// Related structures\n-\t\tfinal List<Relationship> relations = FactoryLocator.getRelationshipFactory().byContentType(structure);\n-\n-\t\tfor (final Relationship relationship : relations) {\n-\t\t\trelationships.addOrClean( relationship.getInode(), relationship.getModDate());\n-\n-\t\t\tif(!structures.contains(relationship.getChildStructureInode()) && config.getOperation().equals( Operation.PUBLISH) ){\n-\t\t\t\tStructure struct = CacheLocator.getContentTypeCache().getStructureByInode(relationship.getChildStructureInode());\n-\t\t\t\tsolvedStructures.add(stInode);\n-\t\t\t\tstructures.addOrClean( relationship.getChildStructureInode(), struct.getModDate());\n-\n-\t\t\t\tif(!solvedStructures.contains(relationship.getChildStructureInode()))\n-\t\t\t\t\tstructureDependencyHelper( relationship.getChildStructureInode() );\n-\t\t\t}\n-\t\t\tif(!structures.contains(relationship.getParentStructureInode()) && config.getOperation().equals( Operation.PUBLISH) ){\n-\t\t\t\tStructure struct = CacheLocator.getContentTypeCache().getStructureByInode(relationship.getParentStructureInode());\n-\t\t\t\tsolvedStructures.add(stInode);\n-\t\t\t\tstructures.addOrClean( relationship.getParentStructureInode(), struct.getModDate());\n-\n-\t\t\t\tif(!solvedStructures.contains(relationship.getParentStructureInode()))\n-\t\t\t\t\tstructureDependencyHelper( relationship.getParentStructureInode() );\n+\t\tif(publisherFilter.isRelationships()) {\n+\t\t\tfinal List<Relationship> relations = FactoryLocator.getRelationshipFactory()\n+\t\t\t\t\t.byContentType(structure);\n+\n+\t\t\tfor (final Relationship relationship : relations) {\n+\t\t\t\trelationships.addOrClean(relationship.getInode(), relationship.getModDate());\n+\n+\t\t\t\tif (!contentTypes.contains(relationship.getChildStructureInode()) && config\n+\t\t\t\t\t\t.getOperation().equals(Operation.PUBLISH)) {\n+\t\t\t\t\tfinal Structure childStructure = CacheLocator.getContentTypeCache()\n+\t\t\t\t\t\t\t.getStructureByInode(relationship.getChildStructureInode());\n+\t\t\t\t\tsolvedContentTypes.add(stInode);\n+\t\t\t\t\tcontentTypes\n+\t\t\t\t\t\t\t.addOrClean(relationship.getChildStructureInode(), childStructure.getModDate());\n+\n+\t\t\t\t\tif (!solvedContentTypes.contains(relationship.getChildStructureInode())) {\n+\t\t\t\t\t\tstructureDependencyHelper(relationship.getChildStructureInode(),\n+\t\t\t\t\t\t\t\tpublisherFilter);\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t\tif (!contentTypes.contains(relationship.getParentStructureInode()) && config\n+\t\t\t\t\t\t.getOperation().equals(Operation.PUBLISH)) {\n+\t\t\t\t\tStructure struct = CacheLocator.getContentTypeCache()", "originalCommit": "d303d8ce23e694dae36c96f07e87151f2bef3f36", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxNTI2Nw==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433515267", "bodyText": "Issue found: Unnecessary use of fully qualified name 'Assert.assertTrue' due to existing static import 'org.junit.Assert.assertTrue'", "author": "dev-dotcms", "createdAt": "2020-06-01T22:05:21Z", "path": "dotCMS/src/integration-test/java/com/dotcms/publishing/PublisherAPITest.java", "diffHunk": "@@ -319,4 +327,304 @@ private FileFilter getNoBundleXMLFileFilter() {\n         return file -> !file.getAbsolutePath().endsWith(\"bundle.xml\");\n     }\n \n+    /**\n+     * Method to test: {@link PublisherAPI#addFilterDescriptor(FilterDescriptor)}\n+     * Given Scenario: Create a new FilterDescriptor and add it to the FilterDescriptorMap\n+     * ExpectedResult: the filterDescriptor is added successfully to the map\n+     *\n+     */\n+    @Test\n+    public void test_addFilter_success() throws DotDataException {\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final Map<String,Object> filtersMap =\n+                ImmutableMap.of(\"dependencies\",true,\"relationships\",true,\"excludeClasses\",\"Host,Workflow\");\n+        final FilterDescriptor filterDescriptor =\n+                new FilterDescriptor(\"filterTestAPI.yml\",\"Filter Test Title\",filtersMap,false,\"Reviewer,dotcms.org.2789\");\n+\n+        publisherAPI.addFilterDescriptor(filterDescriptor);\n+\n+        final List<FilterDescriptor> filterDescriptorList = APILocator.getPublisherAPI().getFiltersDescriptorsByRole(\n+                TestUserUtils.getAdminUser());\n+        Assert.assertFalse(filterDescriptorList.isEmpty());\n+        Assert.assertTrue(filterDescriptorList.stream().anyMatch(filter -> filter.getKey().equalsIgnoreCase(filterDescriptor.getKey())));\n+    }\n+\n+    /**\n+     * Method to test: {@link PublisherAPI#getFiltersDescriptorsByRole(User)}\n+     * Given Scenario: Get the filters that the CMSAdmin has access to\n+     * ExpectedResult: CMSAdmin has access to all the filters\n+     *\n+     */\n+    @Test\n+    public void test_getFiltersByRole_CMSAdmin_returnAllFilters() throws DotDataException {\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final Map<String,Object> filtersMap =\n+                ImmutableMap.of(\"dependencies\",true,\"relationships\",true,\"excludeClasses\",\"Host,Workflow\");\n+\n+        final FilterDescriptor filterDescriptor1 =\n+                new FilterDescriptor(\"filterTest1.yml\",\"Filter Test Title 1\",filtersMap,false,\"Reviewer,dotcms.org.2789\");\n+\n+        final FilterDescriptor filterDescriptor2 =\n+                new FilterDescriptor(\"filterTest2.yml\",\"Filter Test Title 2\",filtersMap,false,\"Reviewer\");\n+\n+        publisherAPI.addFilterDescriptor(filterDescriptor1);\n+        publisherAPI.addFilterDescriptor(filterDescriptor2);\n+\n+        final User newUser = new UserDataGen().nextPersisted();\n+        APILocator.getRoleAPI().addRoleToUser(APILocator.getRoleAPI().loadCMSAdminRole(), newUser);\n+\n+        final List<FilterDescriptor> filterDescriptors = publisherAPI.getFiltersDescriptorsByRole(newUser);\n+        Assert.assertFalse(filterDescriptors.isEmpty());\n+        Assert.assertTrue(filterDescriptors.contains(filterDescriptor1));", "originalCommit": "d303d8ce23e694dae36c96f07e87151f2bef3f36", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxNTI3MA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433515270", "bodyText": "Issue found: Avoid variables with short names like id", "author": "dev-dotcms", "createdAt": "2020-06-01T22:05:21Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -952,102 +1078,143 @@ private void setStructureDependencies() throws DotDataException, DotSecurityExce\n \t * @throws DotDataException\n \t * @throws DotSecurityException\n \t */\n-\tprivate void structureDependencyHelper(String stInode) throws DotDataException, DotSecurityException{\n+\tprivate void structureDependencyHelper(final String stInode, final PublisherFilter publisherFilter) throws DotDataException, DotSecurityException{\n \t\tfinal Structure structure = CacheLocator.getContentTypeCache().getStructureByInode(stInode);\n-\t\tfinal Host host = APILocator.getHostAPI().find(structure.getHost(), user, false);\n-\t\thosts.addOrClean(structure.getHost(), host.getModDate()); // add the host dependency\n \n-\t\tfinal Folder folder = APILocator.getFolderAPI().find(structure.getFolder(), user, false);\n-\t\tfolders.addOrClean(structure.getFolder(), folder.getModDate()); // add the folder dependency\n+\t\t// Host Dependency\n+\t\tif(!publisherFilter.doesExcludeDependencyClassesContainsType(PusheableAsset.SITE.getType())) {\n+\t\t\tfinal Host host = APILocator.getHostAPI().find(structure.getHost(), user, false);\n+\t\t\thosts.addOrClean(structure.getHost(), host.getModDate()); // add the host dependency\n+\t\t}\n \n-\t\ttry {\n-\t\t\tfinal List<WorkflowScheme> schemes = APILocator.getWorkflowAPI().findSchemesForStruct(structure);\n-\t\t\tfor (final WorkflowScheme scheme : schemes) {\n-\t\t\t\tworkflows.addOrClean(scheme.getId(), scheme.getModDate());\n+\t\t// Folder Dependencies\n+\t\tif(!publisherFilter.doesExcludeDependencyClassesContainsType(PusheableAsset.FOLDER.getType())) {\n+\t\t\tfinal Folder folder = APILocator.getFolderAPI()\n+\t\t\t\t\t.find(structure.getFolder(), user, false);\n+\t\t\tfolders.addOrClean(structure.getFolder(),\n+\t\t\t\t\tfolder.getModDate()); // add the folder dependency\n+\t\t}\n+\n+\t\t// Workflows Dependencies\n+\t\tif(!publisherFilter.doesExcludeDependencyClassesContainsType(PusheableAsset.WORKFLOW.getType())) {\n+\t\t\ttry {\n+\t\t\t\tfinal List<WorkflowScheme> schemes = APILocator.getWorkflowAPI()\n+\t\t\t\t\t\t.findSchemesForStruct(structure);\n+\t\t\t\tfor (final WorkflowScheme scheme : schemes) {\n+\t\t\t\t\tworkflows.addOrClean(scheme.getId(), scheme.getModDate());\n+\t\t\t\t}\n+\t\t\t} catch (DotDataException e) {\n+\t\t\t\tLogger.debug(getClass(),\n+\t\t\t\t\t\t() -> \"Could not get the Workflow Scheme Dependency for Structure ID: \"\n+\t\t\t\t\t\t\t\t+ structure.getInode());\n \t\t\t}\n-\t\t} catch (DotDataException e) {\n-\t\t\tLogger.debug(getClass(), ()->\"Could not get the Workflow Scheme Dependency for Structure ID: \" + structure.getInode());\n \t\t}\n \n-        APILocator.getCategoryAPI().findCategories(new StructureTransformer(structure).from(), user).forEach(category -> {\n-            this.categories.addOrClean(category.getCategoryId(), category.getModDate());\n-        });\n+\t\t// Categories Dependencies\n+\t\tif(!publisherFilter.doesExcludeDependencyClassesContainsType(PusheableAsset.CATEGORY.getType())) {\n+\t\t\tAPILocator.getCategoryAPI()\n+\t\t\t\t\t.findCategories(new StructureTransformer(structure).from(), user)\n+\t\t\t\t\t.forEach(category -> {\n+\t\t\t\t\t\tthis.categories.addOrClean(category.getCategoryId(), category.getModDate());\n+\t\t\t\t\t});\n+\t\t}\n \n \t\t// Related structures\n-\t\tfinal List<Relationship> relations = FactoryLocator.getRelationshipFactory().byContentType(structure);\n-\n-\t\tfor (final Relationship relationship : relations) {\n-\t\t\trelationships.addOrClean( relationship.getInode(), relationship.getModDate());\n-\n-\t\t\tif(!structures.contains(relationship.getChildStructureInode()) && config.getOperation().equals( Operation.PUBLISH) ){\n-\t\t\t\tStructure struct = CacheLocator.getContentTypeCache().getStructureByInode(relationship.getChildStructureInode());\n-\t\t\t\tsolvedStructures.add(stInode);\n-\t\t\t\tstructures.addOrClean( relationship.getChildStructureInode(), struct.getModDate());\n-\n-\t\t\t\tif(!solvedStructures.contains(relationship.getChildStructureInode()))\n-\t\t\t\t\tstructureDependencyHelper( relationship.getChildStructureInode() );\n-\t\t\t}\n-\t\t\tif(!structures.contains(relationship.getParentStructureInode()) && config.getOperation().equals( Operation.PUBLISH) ){\n-\t\t\t\tStructure struct = CacheLocator.getContentTypeCache().getStructureByInode(relationship.getParentStructureInode());\n-\t\t\t\tsolvedStructures.add(stInode);\n-\t\t\t\tstructures.addOrClean( relationship.getParentStructureInode(), struct.getModDate());\n-\n-\t\t\t\tif(!solvedStructures.contains(relationship.getParentStructureInode()))\n-\t\t\t\t\tstructureDependencyHelper( relationship.getParentStructureInode() );\n+\t\tif(publisherFilter.isRelationships()) {\n+\t\t\tfinal List<Relationship> relations = FactoryLocator.getRelationshipFactory()\n+\t\t\t\t\t.byContentType(structure);\n+\n+\t\t\tfor (final Relationship relationship : relations) {\n+\t\t\t\trelationships.addOrClean(relationship.getInode(), relationship.getModDate());\n+\n+\t\t\t\tif (!contentTypes.contains(relationship.getChildStructureInode()) && config\n+\t\t\t\t\t\t.getOperation().equals(Operation.PUBLISH)) {\n+\t\t\t\t\tfinal Structure childStructure = CacheLocator.getContentTypeCache()\n+\t\t\t\t\t\t\t.getStructureByInode(relationship.getChildStructureInode());\n+\t\t\t\t\tsolvedContentTypes.add(stInode);\n+\t\t\t\t\tcontentTypes\n+\t\t\t\t\t\t\t.addOrClean(relationship.getChildStructureInode(), childStructure.getModDate());\n+\n+\t\t\t\t\tif (!solvedContentTypes.contains(relationship.getChildStructureInode())) {\n+\t\t\t\t\t\tstructureDependencyHelper(relationship.getChildStructureInode(),\n+\t\t\t\t\t\t\t\tpublisherFilter);\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t\tif (!contentTypes.contains(relationship.getParentStructureInode()) && config\n+\t\t\t\t\t\t.getOperation().equals(Operation.PUBLISH)) {\n+\t\t\t\t\tStructure struct = CacheLocator.getContentTypeCache()\n+\t\t\t\t\t\t\t.getStructureByInode(relationship.getParentStructureInode());\n+\t\t\t\t\tsolvedContentTypes.add(stInode);\n+\t\t\t\t\tcontentTypes.addOrClean(relationship.getParentStructureInode(),\n+\t\t\t\t\t\t\tstruct.getModDate());\n+\n+\t\t\t\t\tif (!solvedContentTypes.contains(relationship.getParentStructureInode()))\n+\t\t\t\t\t\tstructureDependencyHelper(relationship.getParentStructureInode(),\n+\t\t\t\t\t\t\t\tpublisherFilter);\n+\t\t\t\t}\n \t\t\t}\n \t\t}\n \t}\n \n \t/**\n \t * \n-\t * @param cons\n+\t * @param contentletSet\n \t * @throws DotDataException\n \t * @throws DotSecurityException\n \t */\n-\tprivate void processList(Set<Contentlet> cons) throws DotDataException, DotSecurityException {\n-\t\tSet<Contentlet> contentsToProcess = new HashSet<Contentlet>();\n-\t\tSet<Contentlet> contentsWithDependenciesToProcess = new HashSet<Contentlet>();\n-\n-\t\t//Getting all related content\n-\n-\t\tfor (Contentlet con : cons) {\n-\t\t\tHost h = APILocator.getHostAPI().find(con.getHost(), user, false);\n-\t\t\thosts.addOrClean( con.getHost(), h.getModDate()); // add the host dependency\n-\t\t\tcontentsToProcess.add(con);\n-\n-\t\t\tMap<Relationship, List<Contentlet>> contentRel =\n-\t\t\t\t\tAPILocator.getContentletAPI().findContentRelationships(con, user);\n-\n-\t\t\tfor (Relationship rel : contentRel.keySet()) {\n-\t\t\t\tcontentsToProcess.addAll(contentRel.get(rel));\n-\t\t\t\t/**\n-\t\t\t\t * ISSUE #2222: https://github.com/dotCMS/dotCMS/issues/2222\n-\t\t\t\t *\n-\t\t\t\t * We need the relationships in which the single related content is involved.\n-\t\t\t\t *\n-\t\t\t\t */\n-\t\t\t\tif(contentRel.get(rel).size()>0)\n-\t\t\t\t\trelationships.addOrClean( rel.getInode(), rel.getModDate());\n+\tprivate void processList(final Set<Contentlet> contentletSet, final PublisherFilter publisherFilter) throws DotDataException, DotSecurityException {\n+\t\tfinal Set<Contentlet> contentsToProcess = new HashSet<Contentlet>();\n+\t\tfinal Set<Contentlet> contentsWithDependenciesToProcess = new HashSet<Contentlet>();\n+\n+\t\tfor (final Contentlet contentlet : contentletSet) {\n+\t\t\t// Host Dependency\n+\t\t\tif(!publisherFilter.doesExcludeDependencyClassesContainsType(PusheableAsset.SITE.getType())) {\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(contentlet.getHost(), user, false);\n+\t\t\t\thosts.addOrClean(contentlet.getHost(), host.getModDate());\n+\t\t\t}\n+\n+\t\t\tcontentsToProcess.add(contentlet);\n+\n+\t\t\t// Relationships Dependencies\n+\t\t\tif(publisherFilter.isRelationships()) {\n+\t\t\t\tfinal Map<Relationship, List<Contentlet>> contentRelationshipsMap =\n+\t\t\t\t\t\tAPILocator.getContentletAPI().findContentRelationships(contentlet, user);\n+\n+\t\t\t\tfor (final Relationship relationship : contentRelationshipsMap.keySet()) {\n+\t\t\t\t\tcontentsToProcess.addAll(contentRelationshipsMap.get(relationship));\n+\t\t\t\t\t/**\n+\t\t\t\t\t * ISSUE #2222: https://github.com/dotCMS/dotCMS/issues/2222\n+\t\t\t\t\t *\n+\t\t\t\t\t * We need the relationships in which the single related content is involved.\n+\t\t\t\t\t *\n+\t\t\t\t\t */\n+\t\t\t\t\tif (contentRelationshipsMap.get(relationship).size() > 0)\n+\t\t\t\t\t\trelationships.addOrClean(relationship.getInode(), relationship.getModDate());\n+\t\t\t\t}\n \t\t\t}\n \t\t}\n+\t\t// end relationships false\n \n-\t\tfor (Contentlet con : contentsToProcess) {\n-\t\t\tHost h = APILocator.getHostAPI().find(con.getHost(), user, false);\n-\t\t\thosts.addOrClean( con.getHost(), h.getModDate()); // add the host dependency\n-\t\t\tcontentsWithDependenciesToProcess.add(con);\n+\t\tfor (final Contentlet contentletToProcess : contentsToProcess) {\n+\t\t\t// Host Dependency\n+\t\t\tif(!publisherFilter.doesExcludeDependencyClassesContainsType(PusheableAsset.SITE.getType())) {\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(contentletToProcess.getHost(), user, false);\n+\t\t\t\thosts.addOrClean(contentletToProcess.getHost(), host.getModDate());\n+\t\t\t}\n+\t\t\tcontentsWithDependenciesToProcess.add(contentletToProcess);\n \t\t\t//Copy asset files to bundle folder keeping original folders structure\n-\t\t\tList<Field> fields=FieldsCache.getFieldsByStructureInode(con.getStructureInode());\n+\t\t\tfinal List<Field> fields=FieldsCache.getFieldsByStructureInode(contentletToProcess.getStructureInode());\n \n-\t\t\tfor(Field ff : fields) {\n-\t\t\t\tif (ff.getFieldType().equals(Field.FieldType.IMAGE.toString())\n-\t\t\t\t\t\t|| ff.getFieldType().equals(Field.FieldType.FILE.toString())) {\n+\t\t\tfor(final Field field : fields) {\n+\t\t\t\tif (field.getFieldType().equals(Field.FieldType.IMAGE.toString())\n+\t\t\t\t\t\t|| field.getFieldType().equals(Field.FieldType.FILE.toString())) {\n \n \t\t\t\t\ttry {\n \t\t\t\t\t\tString value = \"\";\n-\t\t\t\t\t\tif(UtilMethods.isSet(APILocator.getContentletAPI().getFieldValue(con, ff))){\n-\t\t\t\t\t\t\tvalue = APILocator.getContentletAPI().getFieldValue(con, ff).toString();\n+\t\t\t\t\t\tif(UtilMethods.isSet(APILocator.getContentletAPI().getFieldValue(contentletToProcess, field))){\n+\t\t\t\t\t\t\tvalue = APILocator.getContentletAPI().getFieldValue(contentletToProcess, field).toString();\n \t\t\t\t\t\t}\n-\t\t\t\t\t\tIdentifier id = APILocator.getIdentifierAPI().find(value);\n+\t\t\t\t\t\tfinal Identifier id = APILocator.getIdentifierAPI().find(value);", "originalCommit": "d303d8ce23e694dae36c96f07e87151f2bef3f36", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxNTI3OA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433515278", "bodyText": "Issue found: Unnecessary use of fully qualified name 'Assert.assertTrue' due to existing static import 'org.junit.Assert.assertTrue'", "author": "dev-dotcms", "createdAt": "2020-06-01T22:05:23Z", "path": "dotCMS/src/integration-test/java/com/dotcms/publishing/PublisherAPITest.java", "diffHunk": "@@ -319,4 +327,304 @@ private FileFilter getNoBundleXMLFileFilter() {\n         return file -> !file.getAbsolutePath().endsWith(\"bundle.xml\");\n     }\n \n+    /**\n+     * Method to test: {@link PublisherAPI#addFilterDescriptor(FilterDescriptor)}\n+     * Given Scenario: Create a new FilterDescriptor and add it to the FilterDescriptorMap\n+     * ExpectedResult: the filterDescriptor is added successfully to the map\n+     *\n+     */\n+    @Test\n+    public void test_addFilter_success() throws DotDataException {\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final Map<String,Object> filtersMap =\n+                ImmutableMap.of(\"dependencies\",true,\"relationships\",true,\"excludeClasses\",\"Host,Workflow\");\n+        final FilterDescriptor filterDescriptor =\n+                new FilterDescriptor(\"filterTestAPI.yml\",\"Filter Test Title\",filtersMap,false,\"Reviewer,dotcms.org.2789\");\n+\n+        publisherAPI.addFilterDescriptor(filterDescriptor);\n+\n+        final List<FilterDescriptor> filterDescriptorList = APILocator.getPublisherAPI().getFiltersDescriptorsByRole(\n+                TestUserUtils.getAdminUser());\n+        Assert.assertFalse(filterDescriptorList.isEmpty());\n+        Assert.assertTrue(filterDescriptorList.stream().anyMatch(filter -> filter.getKey().equalsIgnoreCase(filterDescriptor.getKey())));\n+    }\n+\n+    /**\n+     * Method to test: {@link PublisherAPI#getFiltersDescriptorsByRole(User)}\n+     * Given Scenario: Get the filters that the CMSAdmin has access to\n+     * ExpectedResult: CMSAdmin has access to all the filters\n+     *\n+     */\n+    @Test\n+    public void test_getFiltersByRole_CMSAdmin_returnAllFilters() throws DotDataException {\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final Map<String,Object> filtersMap =\n+                ImmutableMap.of(\"dependencies\",true,\"relationships\",true,\"excludeClasses\",\"Host,Workflow\");\n+\n+        final FilterDescriptor filterDescriptor1 =\n+                new FilterDescriptor(\"filterTest1.yml\",\"Filter Test Title 1\",filtersMap,false,\"Reviewer,dotcms.org.2789\");\n+\n+        final FilterDescriptor filterDescriptor2 =\n+                new FilterDescriptor(\"filterTest2.yml\",\"Filter Test Title 2\",filtersMap,false,\"Reviewer\");\n+\n+        publisherAPI.addFilterDescriptor(filterDescriptor1);\n+        publisherAPI.addFilterDescriptor(filterDescriptor2);\n+\n+        final User newUser = new UserDataGen().nextPersisted();\n+        APILocator.getRoleAPI().addRoleToUser(APILocator.getRoleAPI().loadCMSAdminRole(), newUser);\n+\n+        final List<FilterDescriptor> filterDescriptors = publisherAPI.getFiltersDescriptorsByRole(newUser);\n+        Assert.assertFalse(filterDescriptors.isEmpty());\n+        Assert.assertTrue(filterDescriptors.contains(filterDescriptor1));\n+        Assert.assertTrue(filterDescriptors.contains(filterDescriptor2));\n+    }\n+\n+    /***\n+     * This test gets the filters that the user has access.\n+     * This test the userId of the new User is set into possible roles in the Filter\n+     *\n+     * @throws DotDataException\n+     */\n+    @Test\n+    public void test_getFiltersByRole_nonCMSAdmin_userId() throws DotDataException {\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final User newUser = new UserDataGen().nextPersisted();\n+\n+        final Map<String,Object> filtersMap =\n+                ImmutableMap.of(\"dependencies\",true,\"relationships\",true,\"excludeClasses\",\"Host,Workflow\");\n+        final FilterDescriptor filterDescriptor1 =\n+                new FilterDescriptor(\"filterTest1.yml\",\"Filter Test Title 1\",filtersMap,false,\"Reviewer,\" + newUser.getUserId());\n+\n+        final FilterDescriptor filterDescriptor2 =\n+                new FilterDescriptor(\"filterTest2.yml\",\"Filter Test Title 2\",filtersMap,false,\"Reviewer\");\n+\n+        publisherAPI.addFilterDescriptor(filterDescriptor1);\n+        publisherAPI.addFilterDescriptor(filterDescriptor2);\n+\n+        final List<FilterDescriptor> filterDescriptors = publisherAPI.getFiltersDescriptorsByRole(newUser);\n+        Logger.info(this,filterDescriptors.toString());\n+        Assert.assertFalse(filterDescriptors.isEmpty());\n+        Assert.assertTrue(filterDescriptors.contains(filterDescriptor1));\n+        Assert.assertFalse(filterDescriptors.contains(filterDescriptor2));\n+    }\n+\n+    /***\n+     * This test gets the filters that the user has access.\n+     * This test creates 3 Roles and 5 users with the following Hierarchy:\n+     * Role A (user A)\n+     *  |_____ Role B (user B)\n+     *           |_____ Role C (user C and user D)\n+     *\n+     * On the roles field is set the Role B and the userId of user C.\n+     *\n+     * Since Role Hierarchy is respected this is the expected result:\n+     * User A - Have Access to the Filter\n+     * User B - Have Access to the Filter\n+     * User C - Have Access to the Filter\n+     * User D - Do not have access to the Filter\n+     *\n+     * @throws DotDataException\n+     */\n+    @Test\n+    public void test_getFiltersByRole_nonCMSAdmin_RoleHierarchy() throws DotDataException {\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final User userA = new UserDataGen().nextPersisted();\n+        final User userB = new UserDataGen().nextPersisted();\n+        final User userC = new UserDataGen().nextPersisted();\n+        final User userD = new UserDataGen().nextPersisted();\n+\n+        final Role roleA = new RoleDataGen().nextPersisted();\n+        final Role roleB = new RoleDataGen().parent(roleA.getId()).nextPersisted();\n+        final Role roleC = new RoleDataGen().parent(roleB.getId()).nextPersisted();\n+\n+        APILocator.getRoleAPI().addRoleToUser(roleA,userA);\n+        APILocator.getRoleAPI().addRoleToUser(roleB,userB);\n+        APILocator.getRoleAPI().addRoleToUser(roleC,userC);\n+        APILocator.getRoleAPI().addRoleToUser(roleC,userD);\n+\n+        final Map<String,Object> filtersMap1 =\n+                ImmutableMap.of(\"dependencies\",true,\"relationships\",true,\"excludeClasses\",\"Host,Workflow\");\n+        final FilterDescriptor filterDescriptor1 =\n+                new FilterDescriptor(\"filterTest1.yml\",\"Filter Test Title 1\",filtersMap1,false,roleB.getRoleKey()+','+userC.getUserId());\n+\n+        publisherAPI.addFilterDescriptor(filterDescriptor1);\n+\n+        //User A\n+        List<FilterDescriptor> filterDescriptors = publisherAPI.getFiltersDescriptorsByRole(userA);\n+        Logger.info(this,filterDescriptors.toString());\n+        Assert.assertFalse(filterDescriptors.isEmpty());\n+        Assert.assertTrue(filterDescriptors.contains(filterDescriptor1));\n+\n+        //User B\n+        filterDescriptors = publisherAPI.getFiltersDescriptorsByRole(userB);\n+        Logger.info(this,filterDescriptors.toString());\n+        Assert.assertFalse(filterDescriptors.isEmpty());\n+        Assert.assertTrue(filterDescriptors.contains(filterDescriptor1));\n+\n+        //User C\n+        filterDescriptors = publisherAPI.getFiltersDescriptorsByRole(userC);\n+        Logger.info(this,filterDescriptors.toString());\n+        Assert.assertFalse(filterDescriptors.isEmpty());\n+        Assert.assertTrue(filterDescriptors.contains(filterDescriptor1));\n+\n+        //User D\n+        filterDescriptors = publisherAPI.getFiltersDescriptorsByRole(userD);\n+        Logger.info(this,filterDescriptors.toString());\n+        Assert.assertTrue(filterDescriptors.isEmpty());\n+    }\n+\n+    private void createFilterDescriptor(final String key,final String title,final boolean defaultFilter,Map<String,Object> filtersMap){\n+        if(!UtilMethods.isSet(filtersMap)){\n+            final List<Object> listExcludeClasses = new ArrayList();\n+            listExcludeClasses.add(\"User\");\n+            listExcludeClasses.add(\"OSGI\");\n+            filtersMap =\n+                    ImmutableMap.of(\"dependencies\",true,\"relationships\",true,\"excludeClasses\",\n+                            listExcludeClasses);\n+        }\n+        publisherAPI.addFilterDescriptor(new FilterDescriptor(key,title,filtersMap,defaultFilter,\"DOTCMS_BACK_END_USER\"));\n+    }\n+\n+    /**\n+     * This test creates and gets a FilterDescriptor using the key as reference.\n+     */\n+    @Test\n+    public void test_getFilterDescriptorByKey_success(){\n+        final String key = \"TestByKeySuccess.yml\";\n+        createFilterDescriptor(key,\"TestByKeySuccess\",true,null);\n+        final FilterDescriptor filterDescriptor = publisherAPI.getFilterDescriptorByKey(key);\n+        Assert.assertNotNull(filterDescriptor);\n+        Assert.assertEquals(key,filterDescriptor.getKey());\n+    }\n+\n+    /**\n+     * This test creates 2 FilterDescriptors (one set as default) tries to get a FilterDescriptor, but since key is not passed,\n+     * it returns the FilterDescriptor set as default.\n+     */\n+    @Test\n+    public void test_getFilterDescriptorByKey_emptyKey_returnDefaultFilter(){\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final String keyDefault = \"TestByKeyEmptyKeyDefault.yml\";\n+        createFilterDescriptor(keyDefault,\"TestByKeyEmptyKeyDefault\",true,null);\n+\n+        final String keyNonDefault = \"TestByKeyEmptyKeyNonDefault.yml\";\n+        createFilterDescriptor(keyNonDefault,\"TestByKeyEmptyKeyDefault\",false,null);\n+\n+        final FilterDescriptor filterDescriptor = publisherAPI.getFilterDescriptorByKey(\"\");\n+        Assert.assertNotNull(filterDescriptor);\n+        Assert.assertEquals(keyDefault,filterDescriptor.getKey());\n+    }\n+\n+    /**\n+     * This test creates 2 FilterDescriptors (one set as default) tries to get a FilterDescriptor, but since key passed does not belong to any FilterDescriptor,\n+     * it returns the FilterDescriptor set as default.\n+     */\n+    @Test\n+    public void test_getFilterDescriptorByKey_filterKeyDoesNotExist_returnDefaultFilter(){\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final String keyDefault = \"TestByKeyDoesNotExistDefault.yml\";\n+        createFilterDescriptor(keyDefault,\"TestByKeyDoesNotExistDefault\",true,null);\n+\n+        final String keyNonDefault = \"TestByKeyDoesNotExistNonDefault.yml\";\n+        createFilterDescriptor(keyNonDefault,\"TestByKeyDoesNotExistNonDefault\",false,null);\n+\n+        final FilterDescriptor filterDescriptor = publisherAPI.getFilterDescriptorByKey(\"thisKeyNotExists\");\n+        Assert.assertNotNull(filterDescriptor);\n+        Assert.assertEquals(keyDefault,filterDescriptor.getKey());\n+    }\n+\n+    /**\n+     * This test creates a FilterDescriptor and a Bundle (with the created FilterDescriptor) and\n+     * returns a PublisherFilter with the filters of the FilterDescriptor.\n+     *\n+     * In this case the FilterDescriptor has all the possible filters.\n+     */\n+    @Test\n+    public void test_createPublisherFilter_withAllFilters()\n+            throws DotDataException, DotSecurityException {\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final String filterKey = \"TestCreatePublisherFilterAllFilters.yml\";\n+        final Map<String,Object> filtersMap = new HashMap<>();\n+        filtersMap.put(\"excludeQuery\",\"+baseType:5\");\n+        final List<Object> listExcludeClasses = new ArrayList();\n+        listExcludeClasses.add(\"User\");\n+        listExcludeClasses.add(\"Host\");\n+        listExcludeClasses.add(\"ContentType\");\n+        filtersMap.put(\"excludeClasses\", listExcludeClasses);\n+        filtersMap.put(\"dependencies\",true);\n+        filtersMap.put(\"excludeDependencyQuery\",\"+baseType:7\");\n+        filtersMap.put(\"excludeDependencyClasses\", listExcludeClasses);\n+        filtersMap.put(\"forcePush\",false);\n+        filtersMap.put(\"relationships\",true);\n+        createFilterDescriptor(filterKey,\"TestCreatePublisherFilter\",true,filtersMap);\n+\n+        final String bundleName = \"testCreatePublisherFilterAllFilters\";\n+        Bundle bundle = new Bundle(bundleName, new Date(), null, adminUser.getUserId(),\n+                (Boolean) filtersMap.get(\"forcePush\"),filterKey);\n+        APILocator.getBundleAPI().saveBundle(bundle);\n+        bundle = APILocator.getBundleAPI().getBundleByName(bundleName);\n+        Assert.assertNotNull(bundle);\n+        Assert.assertEquals(filterKey,bundle.getFilterKey());\n+\n+        final PublisherFilter publisherFilter = publisherAPI.createPublisherFilter(bundle.getId());\n+        Assert.assertNotNull(publisherFilter);\n+        Assert.assertEquals(filtersMap.get(\"dependencies\"),publisherFilter.isDependencies());\n+        Assert.assertEquals(filtersMap.get(\"relationships\"),publisherFilter.isRelationships());\n+        Assert.assertEquals(filtersMap.get(\"forcePush\"),bundle.isForcePush());\n+        Assert.assertTrue(publisherFilter.doesExcludeClassesContainsType(\"User\"));\n+        Assert.assertFalse(publisherFilter.doesExcludeClassesContainsType(\"Template\"));\n+        Assert.assertTrue(publisherFilter.doesExcludeDependencyClassesContainsType(\"Host\"));\n+        Assert.assertTrue(publisherFilter.doesExcludeDependencyClassesContainsType(\"ContentType\"));", "originalCommit": "d303d8ce23e694dae36c96f07e87151f2bef3f36", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxNTI4Nw==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433515287", "bodyText": "Issue found: Avoid unused imports such as 'java.util.Map'", "author": "dev-dotcms", "createdAt": "2020-06-01T22:05:24Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/servlets/ajax/AjaxDirectorServletIntegrationTest.java", "diffHunk": "@@ -35,6 +37,7 @@\n import java.util.Collections;\n import java.util.Date;\n import java.util.List;\n+import java.util.Map;", "originalCommit": "d303d8ce23e694dae36c96f07e87151f2bef3f36", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxNTI5Ng==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433515296", "bodyText": "Issue found: The String literal \"TestBundle\" appears 12 times in this file; the first occurrence is on line 216", "author": "dev-dotcms", "createdAt": "2020-06-01T22:05:25Z", "path": "dotCMS/src/integration-test/java/com/dotcms/enterprise/publishing/remote/DependencyBundlerTest.java", "diffHunk": "@@ -0,0 +1,569 @@\n+package com.dotcms.enterprise.publishing.remote;\n+\n+import static com.dotcms.rendering.velocity.directive.ParseContainer.getDotParserContainerUUID;\n+\n+import com.dotcms.IntegrationTestBase;\n+import com.dotcms.LicenseTestUtil;\n+import com.dotcms.contenttype.model.field.Field;\n+import com.dotcms.contenttype.model.field.FieldBuilder;\n+import com.dotcms.contenttype.model.field.RelationshipField;\n+import com.dotcms.contenttype.model.type.BaseContentType;\n+import com.dotcms.contenttype.model.type.ContentType;\n+import com.dotcms.datagen.ContainerDataGen;\n+import com.dotcms.datagen.FolderDataGen;\n+import com.dotcms.datagen.HTMLPageDataGen;\n+import com.dotcms.datagen.TemplateDataGen;\n+import com.dotcms.datagen.TestDataUtils;\n+import com.dotcms.publisher.bundle.bean.Bundle;\n+import com.dotcms.publisher.bundle.business.BundleAPI;\n+import com.dotcms.publisher.business.DotPublisherException;\n+import com.dotcms.publisher.business.PublishQueueElement;\n+import com.dotcms.publisher.business.PublisherAPI;\n+import com.dotcms.publisher.pusher.PushPublisher;\n+import com.dotcms.publisher.pusher.PushPublisherConfig;\n+import com.dotcms.publisher.util.PublisherUtil;\n+import com.dotcms.publishing.BundlerStatus;\n+import com.dotcms.publishing.BundlerUtil;\n+import com.dotcms.publishing.DotBundleException;\n+import com.dotcms.publishing.DotPublishingException;\n+import com.dotcms.publishing.FilterDescriptor;\n+import com.dotcms.publishing.IBundler;\n+import com.dotcms.publishing.Publisher;\n+import com.dotcms.publishing.PublisherConfig.Operation;\n+import com.dotcms.util.CollectionsUtils;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.MultiTree;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.containers.model.Container;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.dotmarketing.portlets.folders.model.Folder;\n+import com.dotmarketing.portlets.htmlpageasset.model.HTMLPageAsset;\n+import com.dotmarketing.portlets.structure.model.Relationship;\n+import com.dotmarketing.portlets.templates.model.Template;\n+import com.dotmarketing.util.Logger;\n+import com.dotmarketing.util.UUIDGenerator;\n+import com.dotmarketing.util.UtilMethods;\n+import com.dotmarketing.util.WebKeys.Relationship.RELATIONSHIP_CARDINALITY;\n+import com.liferay.portal.model.User;\n+import io.vavr.API;\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.junit.Assert;\n+\n+public class DependencyBundlerTest extends IntegrationTestBase {\n+\n+    private static User systemUser;\n+    private static String defaultFilterKey = \"Intelligent.yml\";\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {\n+\n+        //Setting web app environment\n+        IntegrationTestInitService.getInstance().init();\n+        LicenseTestUtil.getLicense();\n+\n+        systemUser = APILocator.getUserAPI().getSystemUser();\n+        createFilterDescriptor(defaultFilterKey,true,true,false,null,null,null,null,true);\n+    }\n+\n+    /**\n+     * Creates and saves bundle\n+     * @param bundleName\n+     * @return a bundle\n+     * @throws DotDataException\n+     */\n+    private static Bundle createBundle (final String bundleName, final boolean forcePush,final String filterKey)\n+            throws DotDataException {\n+\n+        final BundleAPI bundleAPI         = APILocator.getBundleAPI();\n+        final Bundle     bundle1           = new Bundle(bundleName, null, null, systemUser.getUserId(),forcePush,filterKey);\n+\n+        bundleAPI.saveBundle(bundle1);\n+        return bundle1;\n+    }\n+\n+    /**\n+     * Creates a Filter and adds it to map of filters\n+     *\n+     * @param key\n+     * @param dependencies\n+     * @param relationships\n+     * @param forcePush\n+     * @param excludeClasses\n+     * @param excludeDependencyClasses\n+     * @param excludeQuery\n+     * @param excludeDependencyQuery\n+     * @param defaultFilter\n+     */\n+    private static void createFilterDescriptor(final String key, final boolean dependencies,//CREATE BUILDER PARA EVITAR METODO CON TANTOS PARAMS\n+            final boolean relationships, final boolean forcePush,\n+            final List<Object> excludeClasses, final List<Object> excludeDependencyClasses,\n+            final String excludeQuery, final String excludeDependencyQuery, final boolean defaultFilter){\n+        final Map<String,Object> filtersMap = new HashMap<>();\n+        if(UtilMethods.isSet(dependencies)) {\n+            filtersMap.put(\"dependencies\", dependencies);\n+        }\n+        if(UtilMethods.isSet(relationships)) {\n+            filtersMap.put(\"relationships\", relationships);\n+        }\n+        if(UtilMethods.isSet(forcePush)) {\n+            filtersMap.put(\"forcePush\", forcePush);\n+        }\n+        if(UtilMethods.isSet(excludeClasses)) {\n+            filtersMap.put(\"excludeClasses\", excludeClasses);\n+        }\n+        if(UtilMethods.isSet(excludeDependencyClasses)) {\n+            filtersMap.put(\"excludeDependencyClasses\", excludeDependencyClasses);\n+        }\n+        if(UtilMethods.isSet(excludeQuery)) {\n+            filtersMap.put(\"excludeQuery\", excludeQuery);\n+        }\n+        if(UtilMethods.isSet(excludeDependencyQuery)) {\n+            filtersMap.put(\"excludeDependencyQuery\", excludeDependencyQuery);\n+        }\n+        APILocator.getPublisherAPI().addFilterDescriptor(new FilterDescriptor(key,key,filtersMap,defaultFilter,\"DOTCMS_BACK_END_USER\"));\n+    }\n+\n+    /**\n+     * Generate a bundle and returns a PushPublisherConfig to retrieve the list of objects that make up\n+     * the bundle, organized by their types.\n+     */\n+    private static PushPublisherConfig generateBundle ( final String bundleId, final PushPublisherConfig.Operation operation )\n+            throws DotPublisherException, DotDataException, DotPublishingException, IllegalAccessException, InstantiationException, DotBundleException, IOException {\n+\n+        final PushPublisherConfig pconf = new PushPublisherConfig();\n+        final PublisherAPI pubAPI = PublisherAPI.getInstance();\n+\n+        final List<PublishQueueElement> tempBundleContents = pubAPI\n+                .getQueueElementsByBundleId(bundleId);\n+        final List<PublishQueueElement> assetsToPublish = new ArrayList<PublishQueueElement>();\n+\n+        for (final PublishQueueElement queueElement : tempBundleContents) {\n+            assetsToPublish.add(queueElement);\n+        }\n+\n+        pconf.setDownloading(true);\n+        pconf.setOperation(operation);\n+\n+        pconf.setAssets(assetsToPublish);\n+        //Queries creation\n+        pconf.setLuceneQueries(PublisherUtil.prepareQueries(tempBundleContents));\n+        pconf.setId(bundleId);\n+        pconf.setUser(APILocator.getUserAPI().getSystemUser());\n+\n+        //BUNDLERS\n+\n+        final List<Class<IBundler>> bundlers = new ArrayList<>();\n+        final List<IBundler> confBundlers = new ArrayList<IBundler>();\n+\n+        final Publisher publisher = new PushPublisher();\n+        publisher.init(pconf);\n+        //Add the bundles for this publisher\n+        for (final Class<IBundler> clazz : publisher.getBundlers()) {\n+            if (!bundlers.contains(clazz)) {\n+                bundlers.add(clazz);\n+            }\n+        }\n+\n+        final File bundleRoot = BundlerUtil.getBundleRoot(pconf);\n+\n+        // Run bundlers\n+        BundlerUtil.writeBundleXML(pconf);\n+        for (final Class<IBundler> aClass : bundlers) {\n+\n+            final IBundler bundler = aClass.newInstance();\n+            confBundlers.add(bundler);\n+            bundler.setConfig(pconf);\n+            bundler.setPublisher(publisher);\n+            final BundlerStatus bundlerStatus = new BundlerStatus(bundler.getClass().getName());\n+            //Generate the bundler\n+            Logger.info(DependencyBundlerTest.class, \"Start of Bundler: \" + aClass.getSimpleName());\n+            bundler.generate(bundleRoot, bundlerStatus);\n+            Logger.info(DependencyBundlerTest.class, \"End of Bundler: \" + aClass.getSimpleName());\n+        }\n+\n+        pconf.setBundlers(confBundlers);\n+\n+        return pconf;\n+    }\n+\n+    /**\n+     * This test is for the filter excludeDependencyClasses.\n+     *\n+     * This test creates a Content Type and a content, and generates the bundle using the default Filter (this one does not have any exclude filter set),\n+     * so the content and the content type (as a dependency) will be added.\n+     * After this using the same Content Type and content generates another bundle but using a new created filter that exclude ContentTypes to be pushed\n+     * as a dependency, so in the bundle the content will be added but the content type will not.\n+     */\n+    @Test\n+    public void testGenerateBundleWithFilter_ExcludeDependencyClasses_ContentTypeWorkflow_NotAdded()\n+            throws DotDataException, IllegalAccessException, DotBundleException, DotPublishingException, InstantiationException, DotPublisherException, IOException {\n+        //Create ContentType\n+        final ContentType contentType = TestDataUtils.getWikiLikeContentType();\n+        //Create Content\n+        final Contentlet content = TestDataUtils.getWikiContent(true,APILocator.getLanguageAPI().getDefaultLanguage().getId(),contentType.id());\n+\n+        //Create bundle with DefaultFilter\n+        final Bundle bundleWithDefaultFilter = createBundle(\"TestBundle\"+System.currentTimeMillis(),false,defaultFilterKey);", "originalCommit": "d303d8ce23e694dae36c96f07e87151f2bef3f36", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxNTMwMw==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433515303", "bodyText": "Issue found: A method/constructor should not explicitly throw java.lang.Exception", "author": "dev-dotcms", "createdAt": "2020-06-01T22:05:26Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/workflows/actionlet/PushNowActionletTest.java", "diffHunk": "@@ -0,0 +1,216 @@\n+package com.dotmarketing.portlets.workflows.actionlet;\n+\n+import com.dotcms.contenttype.business.ContentTypeAPI;\n+import com.dotcms.contenttype.model.field.DataTypes;\n+import com.dotcms.contenttype.model.field.Field;\n+import com.dotcms.contenttype.model.field.FieldBuilder;\n+import com.dotcms.contenttype.model.field.TextField;\n+import com.dotcms.contenttype.model.type.BaseContentType;\n+import com.dotcms.contenttype.model.type.ContentType;\n+import com.dotcms.contenttype.model.type.ContentTypeBuilder;\n+import com.dotcms.contenttype.transform.contenttype.StructureTransformer;\n+import com.dotcms.datagen.TestUserUtils;\n+import com.dotcms.publisher.bundle.bean.Bundle;\n+import com.dotcms.publisher.environment.bean.Environment;\n+import com.dotcms.publisher.environment.business.EnvironmentAPI;\n+import com.dotcms.publishing.FilterDescriptor;\n+import com.dotcms.publishing.PublisherAPIImpl;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.beans.Permission;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.business.FactoryLocator;\n+import com.dotmarketing.business.PermissionAPI;\n+import com.dotmarketing.business.Role;\n+import com.dotmarketing.exception.AlreadyExistException;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.contentlet.business.ContentletAPI;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.dotmarketing.portlets.contentlet.model.IndexPolicy;\n+import com.dotmarketing.portlets.folders.business.FolderAPI;\n+import com.dotmarketing.portlets.workflows.business.BaseWorkflowIntegrationTest;\n+import com.dotmarketing.portlets.workflows.business.WorkflowAPI;\n+import com.dotmarketing.portlets.workflows.model.MultiKeyValue;\n+import com.dotmarketing.portlets.workflows.model.MultiSelectionWorkflowActionletParameter;\n+import com.dotmarketing.portlets.workflows.model.WorkflowActionClass;\n+import com.dotmarketing.portlets.workflows.model.WorkflowActionletParameter;\n+import com.dotmarketing.portlets.workflows.model.WorkflowProcessor;\n+import com.liferay.portal.model.User;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import javax.validation.constraints.AssertTrue;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+public class PushNowActionletTest extends BaseWorkflowIntegrationTest {\n+\n+    private static CreateSchemeStepActionResult schemeStepActionResult = null;\n+    private static WorkflowAPI workflowAPI = null;\n+    private static ContentletAPI contentletAPI = null;\n+    private static ContentTypeAPI contentTypeAPI = null;\n+    private static ContentType type = null;\n+    private static User adminUser;\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {", "originalCommit": "d303d8ce23e694dae36c96f07e87151f2bef3f36", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxNTMwNg==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433515306", "bodyText": "Issue found: Avoid unused imports such as 'io.vavr.API'", "author": "dev-dotcms", "createdAt": "2020-06-01T22:05:27Z", "path": "dotCMS/src/integration-test/java/com/dotcms/enterprise/publishing/remote/DependencyBundlerTest.java", "diffHunk": "@@ -0,0 +1,569 @@\n+package com.dotcms.enterprise.publishing.remote;\n+\n+import static com.dotcms.rendering.velocity.directive.ParseContainer.getDotParserContainerUUID;\n+\n+import com.dotcms.IntegrationTestBase;\n+import com.dotcms.LicenseTestUtil;\n+import com.dotcms.contenttype.model.field.Field;\n+import com.dotcms.contenttype.model.field.FieldBuilder;\n+import com.dotcms.contenttype.model.field.RelationshipField;\n+import com.dotcms.contenttype.model.type.BaseContentType;\n+import com.dotcms.contenttype.model.type.ContentType;\n+import com.dotcms.datagen.ContainerDataGen;\n+import com.dotcms.datagen.FolderDataGen;\n+import com.dotcms.datagen.HTMLPageDataGen;\n+import com.dotcms.datagen.TemplateDataGen;\n+import com.dotcms.datagen.TestDataUtils;\n+import com.dotcms.publisher.bundle.bean.Bundle;\n+import com.dotcms.publisher.bundle.business.BundleAPI;\n+import com.dotcms.publisher.business.DotPublisherException;\n+import com.dotcms.publisher.business.PublishQueueElement;\n+import com.dotcms.publisher.business.PublisherAPI;\n+import com.dotcms.publisher.pusher.PushPublisher;\n+import com.dotcms.publisher.pusher.PushPublisherConfig;\n+import com.dotcms.publisher.util.PublisherUtil;\n+import com.dotcms.publishing.BundlerStatus;\n+import com.dotcms.publishing.BundlerUtil;\n+import com.dotcms.publishing.DotBundleException;\n+import com.dotcms.publishing.DotPublishingException;\n+import com.dotcms.publishing.FilterDescriptor;\n+import com.dotcms.publishing.IBundler;\n+import com.dotcms.publishing.Publisher;\n+import com.dotcms.publishing.PublisherConfig.Operation;\n+import com.dotcms.util.CollectionsUtils;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.MultiTree;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.containers.model.Container;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.dotmarketing.portlets.folders.model.Folder;\n+import com.dotmarketing.portlets.htmlpageasset.model.HTMLPageAsset;\n+import com.dotmarketing.portlets.structure.model.Relationship;\n+import com.dotmarketing.portlets.templates.model.Template;\n+import com.dotmarketing.util.Logger;\n+import com.dotmarketing.util.UUIDGenerator;\n+import com.dotmarketing.util.UtilMethods;\n+import com.dotmarketing.util.WebKeys.Relationship.RELATIONSHIP_CARDINALITY;\n+import com.liferay.portal.model.User;\n+import io.vavr.API;", "originalCommit": "d303d8ce23e694dae36c96f07e87151f2bef3f36", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxNTMxMw==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433515313", "bodyText": "Issue found: This statement should have braces", "author": "dev-dotcms", "createdAt": "2020-06-01T22:05:28Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -952,102 +1078,143 @@ private void setStructureDependencies() throws DotDataException, DotSecurityExce\n \t * @throws DotDataException\n \t * @throws DotSecurityException\n \t */\n-\tprivate void structureDependencyHelper(String stInode) throws DotDataException, DotSecurityException{\n+\tprivate void structureDependencyHelper(final String stInode, final PublisherFilter publisherFilter) throws DotDataException, DotSecurityException{\n \t\tfinal Structure structure = CacheLocator.getContentTypeCache().getStructureByInode(stInode);\n-\t\tfinal Host host = APILocator.getHostAPI().find(structure.getHost(), user, false);\n-\t\thosts.addOrClean(structure.getHost(), host.getModDate()); // add the host dependency\n \n-\t\tfinal Folder folder = APILocator.getFolderAPI().find(structure.getFolder(), user, false);\n-\t\tfolders.addOrClean(structure.getFolder(), folder.getModDate()); // add the folder dependency\n+\t\t// Host Dependency\n+\t\tif(!publisherFilter.doesExcludeDependencyClassesContainsType(PusheableAsset.SITE.getType())) {\n+\t\t\tfinal Host host = APILocator.getHostAPI().find(structure.getHost(), user, false);\n+\t\t\thosts.addOrClean(structure.getHost(), host.getModDate()); // add the host dependency\n+\t\t}\n \n-\t\ttry {\n-\t\t\tfinal List<WorkflowScheme> schemes = APILocator.getWorkflowAPI().findSchemesForStruct(structure);\n-\t\t\tfor (final WorkflowScheme scheme : schemes) {\n-\t\t\t\tworkflows.addOrClean(scheme.getId(), scheme.getModDate());\n+\t\t// Folder Dependencies\n+\t\tif(!publisherFilter.doesExcludeDependencyClassesContainsType(PusheableAsset.FOLDER.getType())) {\n+\t\t\tfinal Folder folder = APILocator.getFolderAPI()\n+\t\t\t\t\t.find(structure.getFolder(), user, false);\n+\t\t\tfolders.addOrClean(structure.getFolder(),\n+\t\t\t\t\tfolder.getModDate()); // add the folder dependency\n+\t\t}\n+\n+\t\t// Workflows Dependencies\n+\t\tif(!publisherFilter.doesExcludeDependencyClassesContainsType(PusheableAsset.WORKFLOW.getType())) {\n+\t\t\ttry {\n+\t\t\t\tfinal List<WorkflowScheme> schemes = APILocator.getWorkflowAPI()\n+\t\t\t\t\t\t.findSchemesForStruct(structure);\n+\t\t\t\tfor (final WorkflowScheme scheme : schemes) {\n+\t\t\t\t\tworkflows.addOrClean(scheme.getId(), scheme.getModDate());\n+\t\t\t\t}\n+\t\t\t} catch (DotDataException e) {\n+\t\t\t\tLogger.debug(getClass(),\n+\t\t\t\t\t\t() -> \"Could not get the Workflow Scheme Dependency for Structure ID: \"\n+\t\t\t\t\t\t\t\t+ structure.getInode());\n \t\t\t}\n-\t\t} catch (DotDataException e) {\n-\t\t\tLogger.debug(getClass(), ()->\"Could not get the Workflow Scheme Dependency for Structure ID: \" + structure.getInode());\n \t\t}\n \n-        APILocator.getCategoryAPI().findCategories(new StructureTransformer(structure).from(), user).forEach(category -> {\n-            this.categories.addOrClean(category.getCategoryId(), category.getModDate());\n-        });\n+\t\t// Categories Dependencies\n+\t\tif(!publisherFilter.doesExcludeDependencyClassesContainsType(PusheableAsset.CATEGORY.getType())) {\n+\t\t\tAPILocator.getCategoryAPI()\n+\t\t\t\t\t.findCategories(new StructureTransformer(structure).from(), user)\n+\t\t\t\t\t.forEach(category -> {\n+\t\t\t\t\t\tthis.categories.addOrClean(category.getCategoryId(), category.getModDate());\n+\t\t\t\t\t});\n+\t\t}\n \n \t\t// Related structures\n-\t\tfinal List<Relationship> relations = FactoryLocator.getRelationshipFactory().byContentType(structure);\n-\n-\t\tfor (final Relationship relationship : relations) {\n-\t\t\trelationships.addOrClean( relationship.getInode(), relationship.getModDate());\n-\n-\t\t\tif(!structures.contains(relationship.getChildStructureInode()) && config.getOperation().equals( Operation.PUBLISH) ){\n-\t\t\t\tStructure struct = CacheLocator.getContentTypeCache().getStructureByInode(relationship.getChildStructureInode());\n-\t\t\t\tsolvedStructures.add(stInode);\n-\t\t\t\tstructures.addOrClean( relationship.getChildStructureInode(), struct.getModDate());\n-\n-\t\t\t\tif(!solvedStructures.contains(relationship.getChildStructureInode()))\n-\t\t\t\t\tstructureDependencyHelper( relationship.getChildStructureInode() );\n-\t\t\t}\n-\t\t\tif(!structures.contains(relationship.getParentStructureInode()) && config.getOperation().equals( Operation.PUBLISH) ){\n-\t\t\t\tStructure struct = CacheLocator.getContentTypeCache().getStructureByInode(relationship.getParentStructureInode());\n-\t\t\t\tsolvedStructures.add(stInode);\n-\t\t\t\tstructures.addOrClean( relationship.getParentStructureInode(), struct.getModDate());\n-\n-\t\t\t\tif(!solvedStructures.contains(relationship.getParentStructureInode()))\n-\t\t\t\t\tstructureDependencyHelper( relationship.getParentStructureInode() );\n+\t\tif(publisherFilter.isRelationships()) {\n+\t\t\tfinal List<Relationship> relations = FactoryLocator.getRelationshipFactory()\n+\t\t\t\t\t.byContentType(structure);\n+\n+\t\t\tfor (final Relationship relationship : relations) {\n+\t\t\t\trelationships.addOrClean(relationship.getInode(), relationship.getModDate());\n+\n+\t\t\t\tif (!contentTypes.contains(relationship.getChildStructureInode()) && config\n+\t\t\t\t\t\t.getOperation().equals(Operation.PUBLISH)) {\n+\t\t\t\t\tfinal Structure childStructure = CacheLocator.getContentTypeCache()\n+\t\t\t\t\t\t\t.getStructureByInode(relationship.getChildStructureInode());\n+\t\t\t\t\tsolvedContentTypes.add(stInode);\n+\t\t\t\t\tcontentTypes\n+\t\t\t\t\t\t\t.addOrClean(relationship.getChildStructureInode(), childStructure.getModDate());\n+\n+\t\t\t\t\tif (!solvedContentTypes.contains(relationship.getChildStructureInode())) {\n+\t\t\t\t\t\tstructureDependencyHelper(relationship.getChildStructureInode(),\n+\t\t\t\t\t\t\t\tpublisherFilter);\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t\tif (!contentTypes.contains(relationship.getParentStructureInode()) && config\n+\t\t\t\t\t\t.getOperation().equals(Operation.PUBLISH)) {\n+\t\t\t\t\tStructure struct = CacheLocator.getContentTypeCache()\n+\t\t\t\t\t\t\t.getStructureByInode(relationship.getParentStructureInode());\n+\t\t\t\t\tsolvedContentTypes.add(stInode);\n+\t\t\t\t\tcontentTypes.addOrClean(relationship.getParentStructureInode(),\n+\t\t\t\t\t\t\tstruct.getModDate());\n+\n+\t\t\t\t\tif (!solvedContentTypes.contains(relationship.getParentStructureInode()))\n+\t\t\t\t\t\tstructureDependencyHelper(relationship.getParentStructureInode(),\n+\t\t\t\t\t\t\t\tpublisherFilter);\n+\t\t\t\t}\n \t\t\t}\n \t\t}\n \t}\n \n \t/**\n \t * \n-\t * @param cons\n+\t * @param contentletSet\n \t * @throws DotDataException\n \t * @throws DotSecurityException\n \t */\n-\tprivate void processList(Set<Contentlet> cons) throws DotDataException, DotSecurityException {\n-\t\tSet<Contentlet> contentsToProcess = new HashSet<Contentlet>();\n-\t\tSet<Contentlet> contentsWithDependenciesToProcess = new HashSet<Contentlet>();\n-\n-\t\t//Getting all related content\n-\n-\t\tfor (Contentlet con : cons) {\n-\t\t\tHost h = APILocator.getHostAPI().find(con.getHost(), user, false);\n-\t\t\thosts.addOrClean( con.getHost(), h.getModDate()); // add the host dependency\n-\t\t\tcontentsToProcess.add(con);\n-\n-\t\t\tMap<Relationship, List<Contentlet>> contentRel =\n-\t\t\t\t\tAPILocator.getContentletAPI().findContentRelationships(con, user);\n-\n-\t\t\tfor (Relationship rel : contentRel.keySet()) {\n-\t\t\t\tcontentsToProcess.addAll(contentRel.get(rel));\n-\t\t\t\t/**\n-\t\t\t\t * ISSUE #2222: https://github.com/dotCMS/dotCMS/issues/2222\n-\t\t\t\t *\n-\t\t\t\t * We need the relationships in which the single related content is involved.\n-\t\t\t\t *\n-\t\t\t\t */\n-\t\t\t\tif(contentRel.get(rel).size()>0)\n-\t\t\t\t\trelationships.addOrClean( rel.getInode(), rel.getModDate());\n+\tprivate void processList(final Set<Contentlet> contentletSet, final PublisherFilter publisherFilter) throws DotDataException, DotSecurityException {\n+\t\tfinal Set<Contentlet> contentsToProcess = new HashSet<Contentlet>();\n+\t\tfinal Set<Contentlet> contentsWithDependenciesToProcess = new HashSet<Contentlet>();\n+\n+\t\tfor (final Contentlet contentlet : contentletSet) {\n+\t\t\t// Host Dependency\n+\t\t\tif(!publisherFilter.doesExcludeDependencyClassesContainsType(PusheableAsset.SITE.getType())) {\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(contentlet.getHost(), user, false);\n+\t\t\t\thosts.addOrClean(contentlet.getHost(), host.getModDate());\n+\t\t\t}\n+\n+\t\t\tcontentsToProcess.add(contentlet);\n+\n+\t\t\t// Relationships Dependencies\n+\t\t\tif(publisherFilter.isRelationships()) {\n+\t\t\t\tfinal Map<Relationship, List<Contentlet>> contentRelationshipsMap =\n+\t\t\t\t\t\tAPILocator.getContentletAPI().findContentRelationships(contentlet, user);\n+\n+\t\t\t\tfor (final Relationship relationship : contentRelationshipsMap.keySet()) {\n+\t\t\t\t\tcontentsToProcess.addAll(contentRelationshipsMap.get(relationship));\n+\t\t\t\t\t/**\n+\t\t\t\t\t * ISSUE #2222: https://github.com/dotCMS/dotCMS/issues/2222\n+\t\t\t\t\t *\n+\t\t\t\t\t * We need the relationships in which the single related content is involved.\n+\t\t\t\t\t *\n+\t\t\t\t\t */\n+\t\t\t\t\tif (contentRelationshipsMap.get(relationship).size() > 0)\n+\t\t\t\t\t\trelationships.addOrClean(relationship.getInode(), relationship.getModDate());", "originalCommit": "d303d8ce23e694dae36c96f07e87151f2bef3f36", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxNTMxNg==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433515316", "bodyText": "Issue found: Avoid unused imports such as 'com.dotmarketing.business.Role'", "author": "dev-dotcms", "createdAt": "2020-06-01T22:05:29Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/workflows/actionlet/PushNowActionletTest.java", "diffHunk": "@@ -0,0 +1,216 @@\n+package com.dotmarketing.portlets.workflows.actionlet;\n+\n+import com.dotcms.contenttype.business.ContentTypeAPI;\n+import com.dotcms.contenttype.model.field.DataTypes;\n+import com.dotcms.contenttype.model.field.Field;\n+import com.dotcms.contenttype.model.field.FieldBuilder;\n+import com.dotcms.contenttype.model.field.TextField;\n+import com.dotcms.contenttype.model.type.BaseContentType;\n+import com.dotcms.contenttype.model.type.ContentType;\n+import com.dotcms.contenttype.model.type.ContentTypeBuilder;\n+import com.dotcms.contenttype.transform.contenttype.StructureTransformer;\n+import com.dotcms.datagen.TestUserUtils;\n+import com.dotcms.publisher.bundle.bean.Bundle;\n+import com.dotcms.publisher.environment.bean.Environment;\n+import com.dotcms.publisher.environment.business.EnvironmentAPI;\n+import com.dotcms.publishing.FilterDescriptor;\n+import com.dotcms.publishing.PublisherAPIImpl;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.beans.Permission;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.business.FactoryLocator;\n+import com.dotmarketing.business.PermissionAPI;\n+import com.dotmarketing.business.Role;", "originalCommit": "d303d8ce23e694dae36c96f07e87151f2bef3f36", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxNTMxOQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433515319", "bodyText": "Issue found: A method/constructor should not explicitly throw java.lang.Exception", "author": "dev-dotcms", "createdAt": "2020-06-01T22:05:29Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/startup/runonce/Task05305AddPushPublishFilterColumnTest.java", "diffHunk": "@@ -0,0 +1,35 @@\n+package com.dotmarketing.startup.runonce;\n+\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.common.db.DotConnect;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+import com.dotmarketing.exception.DotDataException;\n+import java.sql.SQLException;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+public class Task05305AddPushPublishFilterColumnTest {\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {", "originalCommit": "d303d8ce23e694dae36c96f07e87151f2bef3f36", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxNTMyNA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433515324", "bodyText": "Issue found: Unnecessary use of fully qualified name 'Assert.assertEquals' due to existing static import 'org.junit.Assert.assertEquals'", "author": "dev-dotcms", "createdAt": "2020-06-01T22:05:30Z", "path": "dotCMS/src/integration-test/java/com/dotcms/publishing/PublisherAPITest.java", "diffHunk": "@@ -319,4 +327,304 @@ private FileFilter getNoBundleXMLFileFilter() {\n         return file -> !file.getAbsolutePath().endsWith(\"bundle.xml\");\n     }\n \n+    /**\n+     * Method to test: {@link PublisherAPI#addFilterDescriptor(FilterDescriptor)}\n+     * Given Scenario: Create a new FilterDescriptor and add it to the FilterDescriptorMap\n+     * ExpectedResult: the filterDescriptor is added successfully to the map\n+     *\n+     */\n+    @Test\n+    public void test_addFilter_success() throws DotDataException {\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final Map<String,Object> filtersMap =\n+                ImmutableMap.of(\"dependencies\",true,\"relationships\",true,\"excludeClasses\",\"Host,Workflow\");\n+        final FilterDescriptor filterDescriptor =\n+                new FilterDescriptor(\"filterTestAPI.yml\",\"Filter Test Title\",filtersMap,false,\"Reviewer,dotcms.org.2789\");\n+\n+        publisherAPI.addFilterDescriptor(filterDescriptor);\n+\n+        final List<FilterDescriptor> filterDescriptorList = APILocator.getPublisherAPI().getFiltersDescriptorsByRole(\n+                TestUserUtils.getAdminUser());\n+        Assert.assertFalse(filterDescriptorList.isEmpty());\n+        Assert.assertTrue(filterDescriptorList.stream().anyMatch(filter -> filter.getKey().equalsIgnoreCase(filterDescriptor.getKey())));\n+    }\n+\n+    /**\n+     * Method to test: {@link PublisherAPI#getFiltersDescriptorsByRole(User)}\n+     * Given Scenario: Get the filters that the CMSAdmin has access to\n+     * ExpectedResult: CMSAdmin has access to all the filters\n+     *\n+     */\n+    @Test\n+    public void test_getFiltersByRole_CMSAdmin_returnAllFilters() throws DotDataException {\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final Map<String,Object> filtersMap =\n+                ImmutableMap.of(\"dependencies\",true,\"relationships\",true,\"excludeClasses\",\"Host,Workflow\");\n+\n+        final FilterDescriptor filterDescriptor1 =\n+                new FilterDescriptor(\"filterTest1.yml\",\"Filter Test Title 1\",filtersMap,false,\"Reviewer,dotcms.org.2789\");\n+\n+        final FilterDescriptor filterDescriptor2 =\n+                new FilterDescriptor(\"filterTest2.yml\",\"Filter Test Title 2\",filtersMap,false,\"Reviewer\");\n+\n+        publisherAPI.addFilterDescriptor(filterDescriptor1);\n+        publisherAPI.addFilterDescriptor(filterDescriptor2);\n+\n+        final User newUser = new UserDataGen().nextPersisted();\n+        APILocator.getRoleAPI().addRoleToUser(APILocator.getRoleAPI().loadCMSAdminRole(), newUser);\n+\n+        final List<FilterDescriptor> filterDescriptors = publisherAPI.getFiltersDescriptorsByRole(newUser);\n+        Assert.assertFalse(filterDescriptors.isEmpty());\n+        Assert.assertTrue(filterDescriptors.contains(filterDescriptor1));\n+        Assert.assertTrue(filterDescriptors.contains(filterDescriptor2));\n+    }\n+\n+    /***\n+     * This test gets the filters that the user has access.\n+     * This test the userId of the new User is set into possible roles in the Filter\n+     *\n+     * @throws DotDataException\n+     */\n+    @Test\n+    public void test_getFiltersByRole_nonCMSAdmin_userId() throws DotDataException {\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final User newUser = new UserDataGen().nextPersisted();\n+\n+        final Map<String,Object> filtersMap =\n+                ImmutableMap.of(\"dependencies\",true,\"relationships\",true,\"excludeClasses\",\"Host,Workflow\");\n+        final FilterDescriptor filterDescriptor1 =\n+                new FilterDescriptor(\"filterTest1.yml\",\"Filter Test Title 1\",filtersMap,false,\"Reviewer,\" + newUser.getUserId());\n+\n+        final FilterDescriptor filterDescriptor2 =\n+                new FilterDescriptor(\"filterTest2.yml\",\"Filter Test Title 2\",filtersMap,false,\"Reviewer\");\n+\n+        publisherAPI.addFilterDescriptor(filterDescriptor1);\n+        publisherAPI.addFilterDescriptor(filterDescriptor2);\n+\n+        final List<FilterDescriptor> filterDescriptors = publisherAPI.getFiltersDescriptorsByRole(newUser);\n+        Logger.info(this,filterDescriptors.toString());\n+        Assert.assertFalse(filterDescriptors.isEmpty());\n+        Assert.assertTrue(filterDescriptors.contains(filterDescriptor1));\n+        Assert.assertFalse(filterDescriptors.contains(filterDescriptor2));\n+    }\n+\n+    /***\n+     * This test gets the filters that the user has access.\n+     * This test creates 3 Roles and 5 users with the following Hierarchy:\n+     * Role A (user A)\n+     *  |_____ Role B (user B)\n+     *           |_____ Role C (user C and user D)\n+     *\n+     * On the roles field is set the Role B and the userId of user C.\n+     *\n+     * Since Role Hierarchy is respected this is the expected result:\n+     * User A - Have Access to the Filter\n+     * User B - Have Access to the Filter\n+     * User C - Have Access to the Filter\n+     * User D - Do not have access to the Filter\n+     *\n+     * @throws DotDataException\n+     */\n+    @Test\n+    public void test_getFiltersByRole_nonCMSAdmin_RoleHierarchy() throws DotDataException {\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final User userA = new UserDataGen().nextPersisted();\n+        final User userB = new UserDataGen().nextPersisted();\n+        final User userC = new UserDataGen().nextPersisted();\n+        final User userD = new UserDataGen().nextPersisted();\n+\n+        final Role roleA = new RoleDataGen().nextPersisted();\n+        final Role roleB = new RoleDataGen().parent(roleA.getId()).nextPersisted();\n+        final Role roleC = new RoleDataGen().parent(roleB.getId()).nextPersisted();\n+\n+        APILocator.getRoleAPI().addRoleToUser(roleA,userA);\n+        APILocator.getRoleAPI().addRoleToUser(roleB,userB);\n+        APILocator.getRoleAPI().addRoleToUser(roleC,userC);\n+        APILocator.getRoleAPI().addRoleToUser(roleC,userD);\n+\n+        final Map<String,Object> filtersMap1 =\n+                ImmutableMap.of(\"dependencies\",true,\"relationships\",true,\"excludeClasses\",\"Host,Workflow\");\n+        final FilterDescriptor filterDescriptor1 =\n+                new FilterDescriptor(\"filterTest1.yml\",\"Filter Test Title 1\",filtersMap1,false,roleB.getRoleKey()+','+userC.getUserId());\n+\n+        publisherAPI.addFilterDescriptor(filterDescriptor1);\n+\n+        //User A\n+        List<FilterDescriptor> filterDescriptors = publisherAPI.getFiltersDescriptorsByRole(userA);\n+        Logger.info(this,filterDescriptors.toString());\n+        Assert.assertFalse(filterDescriptors.isEmpty());\n+        Assert.assertTrue(filterDescriptors.contains(filterDescriptor1));\n+\n+        //User B\n+        filterDescriptors = publisherAPI.getFiltersDescriptorsByRole(userB);\n+        Logger.info(this,filterDescriptors.toString());\n+        Assert.assertFalse(filterDescriptors.isEmpty());\n+        Assert.assertTrue(filterDescriptors.contains(filterDescriptor1));\n+\n+        //User C\n+        filterDescriptors = publisherAPI.getFiltersDescriptorsByRole(userC);\n+        Logger.info(this,filterDescriptors.toString());\n+        Assert.assertFalse(filterDescriptors.isEmpty());\n+        Assert.assertTrue(filterDescriptors.contains(filterDescriptor1));\n+\n+        //User D\n+        filterDescriptors = publisherAPI.getFiltersDescriptorsByRole(userD);\n+        Logger.info(this,filterDescriptors.toString());\n+        Assert.assertTrue(filterDescriptors.isEmpty());\n+    }\n+\n+    private void createFilterDescriptor(final String key,final String title,final boolean defaultFilter,Map<String,Object> filtersMap){\n+        if(!UtilMethods.isSet(filtersMap)){\n+            final List<Object> listExcludeClasses = new ArrayList();\n+            listExcludeClasses.add(\"User\");\n+            listExcludeClasses.add(\"OSGI\");\n+            filtersMap =\n+                    ImmutableMap.of(\"dependencies\",true,\"relationships\",true,\"excludeClasses\",\n+                            listExcludeClasses);\n+        }\n+        publisherAPI.addFilterDescriptor(new FilterDescriptor(key,title,filtersMap,defaultFilter,\"DOTCMS_BACK_END_USER\"));\n+    }\n+\n+    /**\n+     * This test creates and gets a FilterDescriptor using the key as reference.\n+     */\n+    @Test\n+    public void test_getFilterDescriptorByKey_success(){\n+        final String key = \"TestByKeySuccess.yml\";\n+        createFilterDescriptor(key,\"TestByKeySuccess\",true,null);\n+        final FilterDescriptor filterDescriptor = publisherAPI.getFilterDescriptorByKey(key);\n+        Assert.assertNotNull(filterDescriptor);\n+        Assert.assertEquals(key,filterDescriptor.getKey());\n+    }\n+\n+    /**\n+     * This test creates 2 FilterDescriptors (one set as default) tries to get a FilterDescriptor, but since key is not passed,\n+     * it returns the FilterDescriptor set as default.\n+     */\n+    @Test\n+    public void test_getFilterDescriptorByKey_emptyKey_returnDefaultFilter(){\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final String keyDefault = \"TestByKeyEmptyKeyDefault.yml\";\n+        createFilterDescriptor(keyDefault,\"TestByKeyEmptyKeyDefault\",true,null);\n+\n+        final String keyNonDefault = \"TestByKeyEmptyKeyNonDefault.yml\";\n+        createFilterDescriptor(keyNonDefault,\"TestByKeyEmptyKeyDefault\",false,null);\n+\n+        final FilterDescriptor filterDescriptor = publisherAPI.getFilterDescriptorByKey(\"\");\n+        Assert.assertNotNull(filterDescriptor);\n+        Assert.assertEquals(keyDefault,filterDescriptor.getKey());\n+    }\n+\n+    /**\n+     * This test creates 2 FilterDescriptors (one set as default) tries to get a FilterDescriptor, but since key passed does not belong to any FilterDescriptor,\n+     * it returns the FilterDescriptor set as default.\n+     */\n+    @Test\n+    public void test_getFilterDescriptorByKey_filterKeyDoesNotExist_returnDefaultFilter(){\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final String keyDefault = \"TestByKeyDoesNotExistDefault.yml\";\n+        createFilterDescriptor(keyDefault,\"TestByKeyDoesNotExistDefault\",true,null);\n+\n+        final String keyNonDefault = \"TestByKeyDoesNotExistNonDefault.yml\";\n+        createFilterDescriptor(keyNonDefault,\"TestByKeyDoesNotExistNonDefault\",false,null);\n+\n+        final FilterDescriptor filterDescriptor = publisherAPI.getFilterDescriptorByKey(\"thisKeyNotExists\");\n+        Assert.assertNotNull(filterDescriptor);\n+        Assert.assertEquals(keyDefault,filterDescriptor.getKey());\n+    }\n+\n+    /**\n+     * This test creates a FilterDescriptor and a Bundle (with the created FilterDescriptor) and\n+     * returns a PublisherFilter with the filters of the FilterDescriptor.\n+     *\n+     * In this case the FilterDescriptor has all the possible filters.\n+     */\n+    @Test\n+    public void test_createPublisherFilter_withAllFilters()\n+            throws DotDataException, DotSecurityException {\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final String filterKey = \"TestCreatePublisherFilterAllFilters.yml\";\n+        final Map<String,Object> filtersMap = new HashMap<>();\n+        filtersMap.put(\"excludeQuery\",\"+baseType:5\");\n+        final List<Object> listExcludeClasses = new ArrayList();\n+        listExcludeClasses.add(\"User\");\n+        listExcludeClasses.add(\"Host\");\n+        listExcludeClasses.add(\"ContentType\");\n+        filtersMap.put(\"excludeClasses\", listExcludeClasses);\n+        filtersMap.put(\"dependencies\",true);\n+        filtersMap.put(\"excludeDependencyQuery\",\"+baseType:7\");\n+        filtersMap.put(\"excludeDependencyClasses\", listExcludeClasses);\n+        filtersMap.put(\"forcePush\",false);\n+        filtersMap.put(\"relationships\",true);\n+        createFilterDescriptor(filterKey,\"TestCreatePublisherFilter\",true,filtersMap);\n+\n+        final String bundleName = \"testCreatePublisherFilterAllFilters\";\n+        Bundle bundle = new Bundle(bundleName, new Date(), null, adminUser.getUserId(),\n+                (Boolean) filtersMap.get(\"forcePush\"),filterKey);\n+        APILocator.getBundleAPI().saveBundle(bundle);\n+        bundle = APILocator.getBundleAPI().getBundleByName(bundleName);\n+        Assert.assertNotNull(bundle);\n+        Assert.assertEquals(filterKey,bundle.getFilterKey());\n+\n+        final PublisherFilter publisherFilter = publisherAPI.createPublisherFilter(bundle.getId());\n+        Assert.assertNotNull(publisherFilter);\n+        Assert.assertEquals(filtersMap.get(\"dependencies\"),publisherFilter.isDependencies());\n+        Assert.assertEquals(filtersMap.get(\"relationships\"),publisherFilter.isRelationships());\n+        Assert.assertEquals(filtersMap.get(\"forcePush\"),bundle.isForcePush());", "originalCommit": "d303d8ce23e694dae36c96f07e87151f2bef3f36", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxNTMyOA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433515328", "bodyText": "Issue found: Avoid variables with short names like c", "author": "dev-dotcms", "createdAt": "2020-06-01T22:05:31Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -571,22 +638,22 @@ private void setFolderListDependencies(List<Folder> folderList) throws DotIdenti\n \t * determines which of them are actually {@link IHTMLPage} objects. After\n \t * that, the respective dependencies will be retrieved and added acordingly.\n \t */\n-\tprivate void setHTMLPagesDependencies() {\n+\tprivate void setHTMLPagesDependencies(final PublisherFilter publisherFilter)  {\n \t\ttry {\n \n-\t\t\tSet<String> idsToWork = new HashSet<>();\n+\t\t\tfinal Set<String> idsToWork = new HashSet<>();\n \t\t\tidsToWork.addAll(htmlPagesSet);\n-\t\t\tfor (String contId : contentsSet) {\n+\t\t\tfor (final String contId : contentsSet) {\n \n-\t\t\t\tList<Contentlet> c = APILocator.getContentletAPI().search(\"+identifier:\" + contId, 0, 0, \"moddate\", user, false);\n+\t\t\t\tfinal List<Contentlet> c = APILocator.getContentletAPI().search(\"+identifier:\" + contId, 0, 0, \"moddate\", user, false);", "originalCommit": "d303d8ce23e694dae36c96f07e87151f2bef3f36", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxNTMzNA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433515334", "bodyText": "Issue found: All methods are static.  Consider using a utility class instead. Alternatively, you could add a private constructor or make the class abstract to silence this warning.", "author": "dev-dotcms", "createdAt": "2020-06-01T22:05:32Z", "path": "dotCMS/src/main/java/com/dotcms/util/YamlUtil.java", "diffHunk": "@@ -0,0 +1,90 @@\n+package com.dotcms.util;\n+\n+import com.dotmarketing.exception.DotRuntimeException;\n+import com.dotmarketing.util.Logger;\n+import com.fasterxml.jackson.annotation.JsonAutoDetect;\n+import com.fasterxml.jackson.annotation.PropertyAccessor;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.dataformat.yaml.YAMLFactory;\n+\n+import java.io.File;\n+import java.io.InputStream;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+\n+/**\n+ * Yaml Utils to parse and save yaml files\n+ * @author jsanca\n+ */\n+public class YamlUtil {", "originalCommit": "d303d8ce23e694dae36c96f07e87151f2bef3f36", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxNTMzOQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433515339", "bodyText": "Issue found: Avoid variables with short names like id", "author": "dev-dotcms", "createdAt": "2020-06-01T22:05:33Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/bundle/bean/Bundle.java", "diffHunk": "@@ -10,69 +10,78 @@\n \tprivate String owner;\n \tprivate Integer operation;\n \tprivate boolean forcePush;\n+\tprivate String filterKey;\n \n \tpublic Bundle() {}\n \n-\tpublic Bundle(String name, Date publishDate, Date expireDate, String owner) {\n+\tpublic Bundle(final String name,final Date publishDate,final Date expireDate,final String owner) {\n \t\tthis.name = name;\n \t\tthis.publishDate = publishDate;\n \t\tthis.expireDate = expireDate;\n \t\tthis.owner = owner;\n \t}\n \n-\tpublic Bundle(String name, Date publishDate, Date expireDate, String owner, boolean forcePush) {\n+\tpublic Bundle(final String name,final Date publishDate,final Date expireDate,final String owner,final boolean forcePush,final String filterKey) {\n \t\tthis.name = name;\n \t\tthis.publishDate = publishDate;\n \t\tthis.expireDate = expireDate;\n \t\tthis.owner = owner;\n \t\tthis.forcePush = forcePush;\n+\t\tthis.filterKey = filterKey;\n \t}\n \n \tpublic String getId() {\n \t\treturn id;\n \t}\n-\tpublic void setId(String id) {\n+\tpublic void setId(final String id) {", "originalCommit": "d303d8ce23e694dae36c96f07e87151f2bef3f36", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxNTM0OA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433515348", "bodyText": "Issue found: Local variable 'pathStream' could be declared final", "author": "dev-dotcms", "createdAt": "2020-06-01T22:05:35Z", "path": "dotCMS/src/integration-test/java/com/dotcms/publishing/PushPublishFiltersInitializerTest.java", "diffHunk": "@@ -0,0 +1,68 @@\n+package com.dotcms.publishing;\n+\n+import com.dotcms.datagen.TestUserUtils;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotcms.util.YamlUtil;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.util.Logger;\n+import com.google.common.collect.ImmutableMap;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Stream;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+public class PushPublishFiltersInitializerTest {\n+\n+    private static PushPublishFiltersInitializer pushPublishFiltersInitializer;\n+    private static File path;\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {\n+        //Setting web app environment\n+        IntegrationTestInitService.getInstance().init();\n+        final String tmpdirPath = System.getProperty(\"java.io.tmpdir\");\n+        path = new File(tmpdirPath + File.separator + \"filters\");\n+        if (!path.exists()) {\n+            path.mkdir();\n+        }\n+        pushPublishFiltersInitializer = new PushPublishFiltersInitializer();\n+    }\n+\n+    private void createFilterFile(final FilterDescriptor filterDescriptor){\n+        Logger.info(this,\"PATH\" + path.toString());\n+        final File file = new File(path.toString(),filterDescriptor.getKey());\n+        YamlUtil.write(file,filterDescriptor);\n+    }\n+\n+    /**\n+     * Method to test: {@link PushPublishFiltersInitializer#loadFilter(Path)}\n+     * Given Scenario: Given a yaml file that contains a FilterDescriptor, the initializer reads the file and loads the filter\n+     * ExpectedResult: filter is successfully added to the filterDescriptorMap\n+     *\n+     */\n+    @Test\n+    public void test_loadFilter_success() throws IOException, DotDataException {\n+        final Map<String,Object> filtersMap =\n+                ImmutableMap.of(\"dependencies\",true,\"relationships\",true,\"excludeClasses\",\"Host,Workflow\");\n+        final FilterDescriptor filterDescriptor =\n+                new FilterDescriptor(\"filterTest.yml\",\"Filter Test Title\",filtersMap,true,\"Reviewer,dotcms.org.2789\");\n+        createFilterFile(filterDescriptor);\n+\n+        Stream<Path> pathStream = Files.list(path.toPath());", "originalCommit": "d303d8ce23e694dae36c96f07e87151f2bef3f36", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxNTM1Nw==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433515357", "bodyText": "Issue found: Unnecessary use of fully qualified name 'Assert.assertEquals' due to existing static import 'org.junit.Assert.assertEquals'", "author": "dev-dotcms", "createdAt": "2020-06-01T22:05:36Z", "path": "dotCMS/src/integration-test/java/com/dotcms/publishing/PublisherAPITest.java", "diffHunk": "@@ -319,4 +327,304 @@ private FileFilter getNoBundleXMLFileFilter() {\n         return file -> !file.getAbsolutePath().endsWith(\"bundle.xml\");\n     }\n \n+    /**\n+     * Method to test: {@link PublisherAPI#addFilterDescriptor(FilterDescriptor)}\n+     * Given Scenario: Create a new FilterDescriptor and add it to the FilterDescriptorMap\n+     * ExpectedResult: the filterDescriptor is added successfully to the map\n+     *\n+     */\n+    @Test\n+    public void test_addFilter_success() throws DotDataException {\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final Map<String,Object> filtersMap =\n+                ImmutableMap.of(\"dependencies\",true,\"relationships\",true,\"excludeClasses\",\"Host,Workflow\");\n+        final FilterDescriptor filterDescriptor =\n+                new FilterDescriptor(\"filterTestAPI.yml\",\"Filter Test Title\",filtersMap,false,\"Reviewer,dotcms.org.2789\");\n+\n+        publisherAPI.addFilterDescriptor(filterDescriptor);\n+\n+        final List<FilterDescriptor> filterDescriptorList = APILocator.getPublisherAPI().getFiltersDescriptorsByRole(\n+                TestUserUtils.getAdminUser());\n+        Assert.assertFalse(filterDescriptorList.isEmpty());\n+        Assert.assertTrue(filterDescriptorList.stream().anyMatch(filter -> filter.getKey().equalsIgnoreCase(filterDescriptor.getKey())));\n+    }\n+\n+    /**\n+     * Method to test: {@link PublisherAPI#getFiltersDescriptorsByRole(User)}\n+     * Given Scenario: Get the filters that the CMSAdmin has access to\n+     * ExpectedResult: CMSAdmin has access to all the filters\n+     *\n+     */\n+    @Test\n+    public void test_getFiltersByRole_CMSAdmin_returnAllFilters() throws DotDataException {\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final Map<String,Object> filtersMap =\n+                ImmutableMap.of(\"dependencies\",true,\"relationships\",true,\"excludeClasses\",\"Host,Workflow\");\n+\n+        final FilterDescriptor filterDescriptor1 =\n+                new FilterDescriptor(\"filterTest1.yml\",\"Filter Test Title 1\",filtersMap,false,\"Reviewer,dotcms.org.2789\");\n+\n+        final FilterDescriptor filterDescriptor2 =\n+                new FilterDescriptor(\"filterTest2.yml\",\"Filter Test Title 2\",filtersMap,false,\"Reviewer\");\n+\n+        publisherAPI.addFilterDescriptor(filterDescriptor1);\n+        publisherAPI.addFilterDescriptor(filterDescriptor2);\n+\n+        final User newUser = new UserDataGen().nextPersisted();\n+        APILocator.getRoleAPI().addRoleToUser(APILocator.getRoleAPI().loadCMSAdminRole(), newUser);\n+\n+        final List<FilterDescriptor> filterDescriptors = publisherAPI.getFiltersDescriptorsByRole(newUser);\n+        Assert.assertFalse(filterDescriptors.isEmpty());\n+        Assert.assertTrue(filterDescriptors.contains(filterDescriptor1));\n+        Assert.assertTrue(filterDescriptors.contains(filterDescriptor2));\n+    }\n+\n+    /***\n+     * This test gets the filters that the user has access.\n+     * This test the userId of the new User is set into possible roles in the Filter\n+     *\n+     * @throws DotDataException\n+     */\n+    @Test\n+    public void test_getFiltersByRole_nonCMSAdmin_userId() throws DotDataException {\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final User newUser = new UserDataGen().nextPersisted();\n+\n+        final Map<String,Object> filtersMap =\n+                ImmutableMap.of(\"dependencies\",true,\"relationships\",true,\"excludeClasses\",\"Host,Workflow\");\n+        final FilterDescriptor filterDescriptor1 =\n+                new FilterDescriptor(\"filterTest1.yml\",\"Filter Test Title 1\",filtersMap,false,\"Reviewer,\" + newUser.getUserId());\n+\n+        final FilterDescriptor filterDescriptor2 =\n+                new FilterDescriptor(\"filterTest2.yml\",\"Filter Test Title 2\",filtersMap,false,\"Reviewer\");\n+\n+        publisherAPI.addFilterDescriptor(filterDescriptor1);\n+        publisherAPI.addFilterDescriptor(filterDescriptor2);\n+\n+        final List<FilterDescriptor> filterDescriptors = publisherAPI.getFiltersDescriptorsByRole(newUser);\n+        Logger.info(this,filterDescriptors.toString());\n+        Assert.assertFalse(filterDescriptors.isEmpty());\n+        Assert.assertTrue(filterDescriptors.contains(filterDescriptor1));\n+        Assert.assertFalse(filterDescriptors.contains(filterDescriptor2));\n+    }\n+\n+    /***\n+     * This test gets the filters that the user has access.\n+     * This test creates 3 Roles and 5 users with the following Hierarchy:\n+     * Role A (user A)\n+     *  |_____ Role B (user B)\n+     *           |_____ Role C (user C and user D)\n+     *\n+     * On the roles field is set the Role B and the userId of user C.\n+     *\n+     * Since Role Hierarchy is respected this is the expected result:\n+     * User A - Have Access to the Filter\n+     * User B - Have Access to the Filter\n+     * User C - Have Access to the Filter\n+     * User D - Do not have access to the Filter\n+     *\n+     * @throws DotDataException\n+     */\n+    @Test\n+    public void test_getFiltersByRole_nonCMSAdmin_RoleHierarchy() throws DotDataException {\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final User userA = new UserDataGen().nextPersisted();\n+        final User userB = new UserDataGen().nextPersisted();\n+        final User userC = new UserDataGen().nextPersisted();\n+        final User userD = new UserDataGen().nextPersisted();\n+\n+        final Role roleA = new RoleDataGen().nextPersisted();\n+        final Role roleB = new RoleDataGen().parent(roleA.getId()).nextPersisted();\n+        final Role roleC = new RoleDataGen().parent(roleB.getId()).nextPersisted();\n+\n+        APILocator.getRoleAPI().addRoleToUser(roleA,userA);\n+        APILocator.getRoleAPI().addRoleToUser(roleB,userB);\n+        APILocator.getRoleAPI().addRoleToUser(roleC,userC);\n+        APILocator.getRoleAPI().addRoleToUser(roleC,userD);\n+\n+        final Map<String,Object> filtersMap1 =\n+                ImmutableMap.of(\"dependencies\",true,\"relationships\",true,\"excludeClasses\",\"Host,Workflow\");\n+        final FilterDescriptor filterDescriptor1 =\n+                new FilterDescriptor(\"filterTest1.yml\",\"Filter Test Title 1\",filtersMap1,false,roleB.getRoleKey()+','+userC.getUserId());\n+\n+        publisherAPI.addFilterDescriptor(filterDescriptor1);\n+\n+        //User A\n+        List<FilterDescriptor> filterDescriptors = publisherAPI.getFiltersDescriptorsByRole(userA);\n+        Logger.info(this,filterDescriptors.toString());\n+        Assert.assertFalse(filterDescriptors.isEmpty());\n+        Assert.assertTrue(filterDescriptors.contains(filterDescriptor1));\n+\n+        //User B\n+        filterDescriptors = publisherAPI.getFiltersDescriptorsByRole(userB);\n+        Logger.info(this,filterDescriptors.toString());\n+        Assert.assertFalse(filterDescriptors.isEmpty());\n+        Assert.assertTrue(filterDescriptors.contains(filterDescriptor1));\n+\n+        //User C\n+        filterDescriptors = publisherAPI.getFiltersDescriptorsByRole(userC);\n+        Logger.info(this,filterDescriptors.toString());\n+        Assert.assertFalse(filterDescriptors.isEmpty());\n+        Assert.assertTrue(filterDescriptors.contains(filterDescriptor1));\n+\n+        //User D\n+        filterDescriptors = publisherAPI.getFiltersDescriptorsByRole(userD);\n+        Logger.info(this,filterDescriptors.toString());\n+        Assert.assertTrue(filterDescriptors.isEmpty());\n+    }\n+\n+    private void createFilterDescriptor(final String key,final String title,final boolean defaultFilter,Map<String,Object> filtersMap){\n+        if(!UtilMethods.isSet(filtersMap)){\n+            final List<Object> listExcludeClasses = new ArrayList();\n+            listExcludeClasses.add(\"User\");\n+            listExcludeClasses.add(\"OSGI\");\n+            filtersMap =\n+                    ImmutableMap.of(\"dependencies\",true,\"relationships\",true,\"excludeClasses\",\n+                            listExcludeClasses);\n+        }\n+        publisherAPI.addFilterDescriptor(new FilterDescriptor(key,title,filtersMap,defaultFilter,\"DOTCMS_BACK_END_USER\"));\n+    }\n+\n+    /**\n+     * This test creates and gets a FilterDescriptor using the key as reference.\n+     */\n+    @Test\n+    public void test_getFilterDescriptorByKey_success(){\n+        final String key = \"TestByKeySuccess.yml\";\n+        createFilterDescriptor(key,\"TestByKeySuccess\",true,null);\n+        final FilterDescriptor filterDescriptor = publisherAPI.getFilterDescriptorByKey(key);\n+        Assert.assertNotNull(filterDescriptor);\n+        Assert.assertEquals(key,filterDescriptor.getKey());", "originalCommit": "d303d8ce23e694dae36c96f07e87151f2bef3f36", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxNTM2Mg==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433515362", "bodyText": "Issue found: The String literal \"forcePush\" appears 6 times in this file; the first occurrence is on line 551", "author": "dev-dotcms", "createdAt": "2020-06-01T22:05:36Z", "path": "dotCMS/src/integration-test/java/com/dotcms/publishing/PublisherAPITest.java", "diffHunk": "@@ -319,4 +327,304 @@ private FileFilter getNoBundleXMLFileFilter() {\n         return file -> !file.getAbsolutePath().endsWith(\"bundle.xml\");\n     }\n \n+    /**\n+     * Method to test: {@link PublisherAPI#addFilterDescriptor(FilterDescriptor)}\n+     * Given Scenario: Create a new FilterDescriptor and add it to the FilterDescriptorMap\n+     * ExpectedResult: the filterDescriptor is added successfully to the map\n+     *\n+     */\n+    @Test\n+    public void test_addFilter_success() throws DotDataException {\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final Map<String,Object> filtersMap =\n+                ImmutableMap.of(\"dependencies\",true,\"relationships\",true,\"excludeClasses\",\"Host,Workflow\");\n+        final FilterDescriptor filterDescriptor =\n+                new FilterDescriptor(\"filterTestAPI.yml\",\"Filter Test Title\",filtersMap,false,\"Reviewer,dotcms.org.2789\");\n+\n+        publisherAPI.addFilterDescriptor(filterDescriptor);\n+\n+        final List<FilterDescriptor> filterDescriptorList = APILocator.getPublisherAPI().getFiltersDescriptorsByRole(\n+                TestUserUtils.getAdminUser());\n+        Assert.assertFalse(filterDescriptorList.isEmpty());\n+        Assert.assertTrue(filterDescriptorList.stream().anyMatch(filter -> filter.getKey().equalsIgnoreCase(filterDescriptor.getKey())));\n+    }\n+\n+    /**\n+     * Method to test: {@link PublisherAPI#getFiltersDescriptorsByRole(User)}\n+     * Given Scenario: Get the filters that the CMSAdmin has access to\n+     * ExpectedResult: CMSAdmin has access to all the filters\n+     *\n+     */\n+    @Test\n+    public void test_getFiltersByRole_CMSAdmin_returnAllFilters() throws DotDataException {\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final Map<String,Object> filtersMap =\n+                ImmutableMap.of(\"dependencies\",true,\"relationships\",true,\"excludeClasses\",\"Host,Workflow\");\n+\n+        final FilterDescriptor filterDescriptor1 =\n+                new FilterDescriptor(\"filterTest1.yml\",\"Filter Test Title 1\",filtersMap,false,\"Reviewer,dotcms.org.2789\");\n+\n+        final FilterDescriptor filterDescriptor2 =\n+                new FilterDescriptor(\"filterTest2.yml\",\"Filter Test Title 2\",filtersMap,false,\"Reviewer\");\n+\n+        publisherAPI.addFilterDescriptor(filterDescriptor1);\n+        publisherAPI.addFilterDescriptor(filterDescriptor2);\n+\n+        final User newUser = new UserDataGen().nextPersisted();\n+        APILocator.getRoleAPI().addRoleToUser(APILocator.getRoleAPI().loadCMSAdminRole(), newUser);\n+\n+        final List<FilterDescriptor> filterDescriptors = publisherAPI.getFiltersDescriptorsByRole(newUser);\n+        Assert.assertFalse(filterDescriptors.isEmpty());\n+        Assert.assertTrue(filterDescriptors.contains(filterDescriptor1));\n+        Assert.assertTrue(filterDescriptors.contains(filterDescriptor2));\n+    }\n+\n+    /***\n+     * This test gets the filters that the user has access.\n+     * This test the userId of the new User is set into possible roles in the Filter\n+     *\n+     * @throws DotDataException\n+     */\n+    @Test\n+    public void test_getFiltersByRole_nonCMSAdmin_userId() throws DotDataException {\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final User newUser = new UserDataGen().nextPersisted();\n+\n+        final Map<String,Object> filtersMap =\n+                ImmutableMap.of(\"dependencies\",true,\"relationships\",true,\"excludeClasses\",\"Host,Workflow\");\n+        final FilterDescriptor filterDescriptor1 =\n+                new FilterDescriptor(\"filterTest1.yml\",\"Filter Test Title 1\",filtersMap,false,\"Reviewer,\" + newUser.getUserId());\n+\n+        final FilterDescriptor filterDescriptor2 =\n+                new FilterDescriptor(\"filterTest2.yml\",\"Filter Test Title 2\",filtersMap,false,\"Reviewer\");\n+\n+        publisherAPI.addFilterDescriptor(filterDescriptor1);\n+        publisherAPI.addFilterDescriptor(filterDescriptor2);\n+\n+        final List<FilterDescriptor> filterDescriptors = publisherAPI.getFiltersDescriptorsByRole(newUser);\n+        Logger.info(this,filterDescriptors.toString());\n+        Assert.assertFalse(filterDescriptors.isEmpty());\n+        Assert.assertTrue(filterDescriptors.contains(filterDescriptor1));\n+        Assert.assertFalse(filterDescriptors.contains(filterDescriptor2));\n+    }\n+\n+    /***\n+     * This test gets the filters that the user has access.\n+     * This test creates 3 Roles and 5 users with the following Hierarchy:\n+     * Role A (user A)\n+     *  |_____ Role B (user B)\n+     *           |_____ Role C (user C and user D)\n+     *\n+     * On the roles field is set the Role B and the userId of user C.\n+     *\n+     * Since Role Hierarchy is respected this is the expected result:\n+     * User A - Have Access to the Filter\n+     * User B - Have Access to the Filter\n+     * User C - Have Access to the Filter\n+     * User D - Do not have access to the Filter\n+     *\n+     * @throws DotDataException\n+     */\n+    @Test\n+    public void test_getFiltersByRole_nonCMSAdmin_RoleHierarchy() throws DotDataException {\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final User userA = new UserDataGen().nextPersisted();\n+        final User userB = new UserDataGen().nextPersisted();\n+        final User userC = new UserDataGen().nextPersisted();\n+        final User userD = new UserDataGen().nextPersisted();\n+\n+        final Role roleA = new RoleDataGen().nextPersisted();\n+        final Role roleB = new RoleDataGen().parent(roleA.getId()).nextPersisted();\n+        final Role roleC = new RoleDataGen().parent(roleB.getId()).nextPersisted();\n+\n+        APILocator.getRoleAPI().addRoleToUser(roleA,userA);\n+        APILocator.getRoleAPI().addRoleToUser(roleB,userB);\n+        APILocator.getRoleAPI().addRoleToUser(roleC,userC);\n+        APILocator.getRoleAPI().addRoleToUser(roleC,userD);\n+\n+        final Map<String,Object> filtersMap1 =\n+                ImmutableMap.of(\"dependencies\",true,\"relationships\",true,\"excludeClasses\",\"Host,Workflow\");\n+        final FilterDescriptor filterDescriptor1 =\n+                new FilterDescriptor(\"filterTest1.yml\",\"Filter Test Title 1\",filtersMap1,false,roleB.getRoleKey()+','+userC.getUserId());\n+\n+        publisherAPI.addFilterDescriptor(filterDescriptor1);\n+\n+        //User A\n+        List<FilterDescriptor> filterDescriptors = publisherAPI.getFiltersDescriptorsByRole(userA);\n+        Logger.info(this,filterDescriptors.toString());\n+        Assert.assertFalse(filterDescriptors.isEmpty());\n+        Assert.assertTrue(filterDescriptors.contains(filterDescriptor1));\n+\n+        //User B\n+        filterDescriptors = publisherAPI.getFiltersDescriptorsByRole(userB);\n+        Logger.info(this,filterDescriptors.toString());\n+        Assert.assertFalse(filterDescriptors.isEmpty());\n+        Assert.assertTrue(filterDescriptors.contains(filterDescriptor1));\n+\n+        //User C\n+        filterDescriptors = publisherAPI.getFiltersDescriptorsByRole(userC);\n+        Logger.info(this,filterDescriptors.toString());\n+        Assert.assertFalse(filterDescriptors.isEmpty());\n+        Assert.assertTrue(filterDescriptors.contains(filterDescriptor1));\n+\n+        //User D\n+        filterDescriptors = publisherAPI.getFiltersDescriptorsByRole(userD);\n+        Logger.info(this,filterDescriptors.toString());\n+        Assert.assertTrue(filterDescriptors.isEmpty());\n+    }\n+\n+    private void createFilterDescriptor(final String key,final String title,final boolean defaultFilter,Map<String,Object> filtersMap){\n+        if(!UtilMethods.isSet(filtersMap)){\n+            final List<Object> listExcludeClasses = new ArrayList();\n+            listExcludeClasses.add(\"User\");\n+            listExcludeClasses.add(\"OSGI\");\n+            filtersMap =\n+                    ImmutableMap.of(\"dependencies\",true,\"relationships\",true,\"excludeClasses\",\n+                            listExcludeClasses);\n+        }\n+        publisherAPI.addFilterDescriptor(new FilterDescriptor(key,title,filtersMap,defaultFilter,\"DOTCMS_BACK_END_USER\"));\n+    }\n+\n+    /**\n+     * This test creates and gets a FilterDescriptor using the key as reference.\n+     */\n+    @Test\n+    public void test_getFilterDescriptorByKey_success(){\n+        final String key = \"TestByKeySuccess.yml\";\n+        createFilterDescriptor(key,\"TestByKeySuccess\",true,null);\n+        final FilterDescriptor filterDescriptor = publisherAPI.getFilterDescriptorByKey(key);\n+        Assert.assertNotNull(filterDescriptor);\n+        Assert.assertEquals(key,filterDescriptor.getKey());\n+    }\n+\n+    /**\n+     * This test creates 2 FilterDescriptors (one set as default) tries to get a FilterDescriptor, but since key is not passed,\n+     * it returns the FilterDescriptor set as default.\n+     */\n+    @Test\n+    public void test_getFilterDescriptorByKey_emptyKey_returnDefaultFilter(){\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final String keyDefault = \"TestByKeyEmptyKeyDefault.yml\";\n+        createFilterDescriptor(keyDefault,\"TestByKeyEmptyKeyDefault\",true,null);\n+\n+        final String keyNonDefault = \"TestByKeyEmptyKeyNonDefault.yml\";\n+        createFilterDescriptor(keyNonDefault,\"TestByKeyEmptyKeyDefault\",false,null);\n+\n+        final FilterDescriptor filterDescriptor = publisherAPI.getFilterDescriptorByKey(\"\");\n+        Assert.assertNotNull(filterDescriptor);\n+        Assert.assertEquals(keyDefault,filterDescriptor.getKey());\n+    }\n+\n+    /**\n+     * This test creates 2 FilterDescriptors (one set as default) tries to get a FilterDescriptor, but since key passed does not belong to any FilterDescriptor,\n+     * it returns the FilterDescriptor set as default.\n+     */\n+    @Test\n+    public void test_getFilterDescriptorByKey_filterKeyDoesNotExist_returnDefaultFilter(){\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final String keyDefault = \"TestByKeyDoesNotExistDefault.yml\";\n+        createFilterDescriptor(keyDefault,\"TestByKeyDoesNotExistDefault\",true,null);\n+\n+        final String keyNonDefault = \"TestByKeyDoesNotExistNonDefault.yml\";\n+        createFilterDescriptor(keyNonDefault,\"TestByKeyDoesNotExistNonDefault\",false,null);\n+\n+        final FilterDescriptor filterDescriptor = publisherAPI.getFilterDescriptorByKey(\"thisKeyNotExists\");\n+        Assert.assertNotNull(filterDescriptor);\n+        Assert.assertEquals(keyDefault,filterDescriptor.getKey());\n+    }\n+\n+    /**\n+     * This test creates a FilterDescriptor and a Bundle (with the created FilterDescriptor) and\n+     * returns a PublisherFilter with the filters of the FilterDescriptor.\n+     *\n+     * In this case the FilterDescriptor has all the possible filters.\n+     */\n+    @Test\n+    public void test_createPublisherFilter_withAllFilters()\n+            throws DotDataException, DotSecurityException {\n+        PublisherAPIImpl.class.cast(publisherAPI).getFilterDescriptorMap().clear();\n+\n+        final String filterKey = \"TestCreatePublisherFilterAllFilters.yml\";\n+        final Map<String,Object> filtersMap = new HashMap<>();\n+        filtersMap.put(\"excludeQuery\",\"+baseType:5\");\n+        final List<Object> listExcludeClasses = new ArrayList();\n+        listExcludeClasses.add(\"User\");\n+        listExcludeClasses.add(\"Host\");\n+        listExcludeClasses.add(\"ContentType\");\n+        filtersMap.put(\"excludeClasses\", listExcludeClasses);\n+        filtersMap.put(\"dependencies\",true);\n+        filtersMap.put(\"excludeDependencyQuery\",\"+baseType:7\");\n+        filtersMap.put(\"excludeDependencyClasses\", listExcludeClasses);\n+        filtersMap.put(\"forcePush\",false);", "originalCommit": "d303d8ce23e694dae36c96f07e87151f2bef3f36", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxNTM2OQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433515369", "bodyText": "Issue found: Avoid unused imports such as 'javax.validation.constraints.AssertTrue'", "author": "dev-dotcms", "createdAt": "2020-06-01T22:05:37Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/workflows/actionlet/PushNowActionletTest.java", "diffHunk": "@@ -0,0 +1,216 @@\n+package com.dotmarketing.portlets.workflows.actionlet;\n+\n+import com.dotcms.contenttype.business.ContentTypeAPI;\n+import com.dotcms.contenttype.model.field.DataTypes;\n+import com.dotcms.contenttype.model.field.Field;\n+import com.dotcms.contenttype.model.field.FieldBuilder;\n+import com.dotcms.contenttype.model.field.TextField;\n+import com.dotcms.contenttype.model.type.BaseContentType;\n+import com.dotcms.contenttype.model.type.ContentType;\n+import com.dotcms.contenttype.model.type.ContentTypeBuilder;\n+import com.dotcms.contenttype.transform.contenttype.StructureTransformer;\n+import com.dotcms.datagen.TestUserUtils;\n+import com.dotcms.publisher.bundle.bean.Bundle;\n+import com.dotcms.publisher.environment.bean.Environment;\n+import com.dotcms.publisher.environment.business.EnvironmentAPI;\n+import com.dotcms.publishing.FilterDescriptor;\n+import com.dotcms.publishing.PublisherAPIImpl;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.beans.Permission;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.business.FactoryLocator;\n+import com.dotmarketing.business.PermissionAPI;\n+import com.dotmarketing.business.Role;\n+import com.dotmarketing.exception.AlreadyExistException;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.contentlet.business.ContentletAPI;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.dotmarketing.portlets.contentlet.model.IndexPolicy;\n+import com.dotmarketing.portlets.folders.business.FolderAPI;\n+import com.dotmarketing.portlets.workflows.business.BaseWorkflowIntegrationTest;\n+import com.dotmarketing.portlets.workflows.business.WorkflowAPI;\n+import com.dotmarketing.portlets.workflows.model.MultiKeyValue;\n+import com.dotmarketing.portlets.workflows.model.MultiSelectionWorkflowActionletParameter;\n+import com.dotmarketing.portlets.workflows.model.WorkflowActionClass;\n+import com.dotmarketing.portlets.workflows.model.WorkflowActionletParameter;\n+import com.dotmarketing.portlets.workflows.model.WorkflowProcessor;\n+import com.liferay.portal.model.User;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import javax.validation.constraints.AssertTrue;", "originalCommit": "d303d8ce23e694dae36c96f07e87151f2bef3f36", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxNTM3OQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r433515379", "bodyText": "Issue found: This statement should have braces", "author": "dev-dotcms", "createdAt": "2020-06-01T22:05:38Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -952,102 +1078,143 @@ private void setStructureDependencies() throws DotDataException, DotSecurityExce\n \t * @throws DotDataException\n \t * @throws DotSecurityException\n \t */\n-\tprivate void structureDependencyHelper(String stInode) throws DotDataException, DotSecurityException{\n+\tprivate void structureDependencyHelper(final String stInode, final PublisherFilter publisherFilter) throws DotDataException, DotSecurityException{\n \t\tfinal Structure structure = CacheLocator.getContentTypeCache().getStructureByInode(stInode);\n-\t\tfinal Host host = APILocator.getHostAPI().find(structure.getHost(), user, false);\n-\t\thosts.addOrClean(structure.getHost(), host.getModDate()); // add the host dependency\n \n-\t\tfinal Folder folder = APILocator.getFolderAPI().find(structure.getFolder(), user, false);\n-\t\tfolders.addOrClean(structure.getFolder(), folder.getModDate()); // add the folder dependency\n+\t\t// Host Dependency\n+\t\tif(!publisherFilter.doesExcludeDependencyClassesContainsType(PusheableAsset.SITE.getType())) {\n+\t\t\tfinal Host host = APILocator.getHostAPI().find(structure.getHost(), user, false);\n+\t\t\thosts.addOrClean(structure.getHost(), host.getModDate()); // add the host dependency\n+\t\t}\n \n-\t\ttry {\n-\t\t\tfinal List<WorkflowScheme> schemes = APILocator.getWorkflowAPI().findSchemesForStruct(structure);\n-\t\t\tfor (final WorkflowScheme scheme : schemes) {\n-\t\t\t\tworkflows.addOrClean(scheme.getId(), scheme.getModDate());\n+\t\t// Folder Dependencies\n+\t\tif(!publisherFilter.doesExcludeDependencyClassesContainsType(PusheableAsset.FOLDER.getType())) {\n+\t\t\tfinal Folder folder = APILocator.getFolderAPI()\n+\t\t\t\t\t.find(structure.getFolder(), user, false);\n+\t\t\tfolders.addOrClean(structure.getFolder(),\n+\t\t\t\t\tfolder.getModDate()); // add the folder dependency\n+\t\t}\n+\n+\t\t// Workflows Dependencies\n+\t\tif(!publisherFilter.doesExcludeDependencyClassesContainsType(PusheableAsset.WORKFLOW.getType())) {\n+\t\t\ttry {\n+\t\t\t\tfinal List<WorkflowScheme> schemes = APILocator.getWorkflowAPI()\n+\t\t\t\t\t\t.findSchemesForStruct(structure);\n+\t\t\t\tfor (final WorkflowScheme scheme : schemes) {\n+\t\t\t\t\tworkflows.addOrClean(scheme.getId(), scheme.getModDate());\n+\t\t\t\t}\n+\t\t\t} catch (DotDataException e) {\n+\t\t\t\tLogger.debug(getClass(),\n+\t\t\t\t\t\t() -> \"Could not get the Workflow Scheme Dependency for Structure ID: \"\n+\t\t\t\t\t\t\t\t+ structure.getInode());\n \t\t\t}\n-\t\t} catch (DotDataException e) {\n-\t\t\tLogger.debug(getClass(), ()->\"Could not get the Workflow Scheme Dependency for Structure ID: \" + structure.getInode());\n \t\t}\n \n-        APILocator.getCategoryAPI().findCategories(new StructureTransformer(structure).from(), user).forEach(category -> {\n-            this.categories.addOrClean(category.getCategoryId(), category.getModDate());\n-        });\n+\t\t// Categories Dependencies\n+\t\tif(!publisherFilter.doesExcludeDependencyClassesContainsType(PusheableAsset.CATEGORY.getType())) {\n+\t\t\tAPILocator.getCategoryAPI()\n+\t\t\t\t\t.findCategories(new StructureTransformer(structure).from(), user)\n+\t\t\t\t\t.forEach(category -> {\n+\t\t\t\t\t\tthis.categories.addOrClean(category.getCategoryId(), category.getModDate());\n+\t\t\t\t\t});\n+\t\t}\n \n \t\t// Related structures\n-\t\tfinal List<Relationship> relations = FactoryLocator.getRelationshipFactory().byContentType(structure);\n-\n-\t\tfor (final Relationship relationship : relations) {\n-\t\t\trelationships.addOrClean( relationship.getInode(), relationship.getModDate());\n-\n-\t\t\tif(!structures.contains(relationship.getChildStructureInode()) && config.getOperation().equals( Operation.PUBLISH) ){\n-\t\t\t\tStructure struct = CacheLocator.getContentTypeCache().getStructureByInode(relationship.getChildStructureInode());\n-\t\t\t\tsolvedStructures.add(stInode);\n-\t\t\t\tstructures.addOrClean( relationship.getChildStructureInode(), struct.getModDate());\n-\n-\t\t\t\tif(!solvedStructures.contains(relationship.getChildStructureInode()))\n-\t\t\t\t\tstructureDependencyHelper( relationship.getChildStructureInode() );\n-\t\t\t}\n-\t\t\tif(!structures.contains(relationship.getParentStructureInode()) && config.getOperation().equals( Operation.PUBLISH) ){\n-\t\t\t\tStructure struct = CacheLocator.getContentTypeCache().getStructureByInode(relationship.getParentStructureInode());\n-\t\t\t\tsolvedStructures.add(stInode);\n-\t\t\t\tstructures.addOrClean( relationship.getParentStructureInode(), struct.getModDate());\n-\n-\t\t\t\tif(!solvedStructures.contains(relationship.getParentStructureInode()))\n-\t\t\t\t\tstructureDependencyHelper( relationship.getParentStructureInode() );\n+\t\tif(publisherFilter.isRelationships()) {\n+\t\t\tfinal List<Relationship> relations = FactoryLocator.getRelationshipFactory()\n+\t\t\t\t\t.byContentType(structure);\n+\n+\t\t\tfor (final Relationship relationship : relations) {\n+\t\t\t\trelationships.addOrClean(relationship.getInode(), relationship.getModDate());\n+\n+\t\t\t\tif (!contentTypes.contains(relationship.getChildStructureInode()) && config\n+\t\t\t\t\t\t.getOperation().equals(Operation.PUBLISH)) {\n+\t\t\t\t\tfinal Structure childStructure = CacheLocator.getContentTypeCache()\n+\t\t\t\t\t\t\t.getStructureByInode(relationship.getChildStructureInode());\n+\t\t\t\t\tsolvedContentTypes.add(stInode);\n+\t\t\t\t\tcontentTypes\n+\t\t\t\t\t\t\t.addOrClean(relationship.getChildStructureInode(), childStructure.getModDate());\n+\n+\t\t\t\t\tif (!solvedContentTypes.contains(relationship.getChildStructureInode())) {\n+\t\t\t\t\t\tstructureDependencyHelper(relationship.getChildStructureInode(),\n+\t\t\t\t\t\t\t\tpublisherFilter);\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t\tif (!contentTypes.contains(relationship.getParentStructureInode()) && config\n+\t\t\t\t\t\t.getOperation().equals(Operation.PUBLISH)) {\n+\t\t\t\t\tStructure struct = CacheLocator.getContentTypeCache()\n+\t\t\t\t\t\t\t.getStructureByInode(relationship.getParentStructureInode());\n+\t\t\t\t\tsolvedContentTypes.add(stInode);\n+\t\t\t\t\tcontentTypes.addOrClean(relationship.getParentStructureInode(),\n+\t\t\t\t\t\t\tstruct.getModDate());\n+\n+\t\t\t\t\tif (!solvedContentTypes.contains(relationship.getParentStructureInode()))\n+\t\t\t\t\t\tstructureDependencyHelper(relationship.getParentStructureInode(),", "originalCommit": "d303d8ce23e694dae36c96f07e87151f2bef3f36", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "3c83a3d8320a957796e1969bd84d42698336f601", "url": "https://github.com/dotCMS/core/commit/3c83a3d8320a957796e1969bd84d42698336f601", "message": "#17986 read and load yml files when init", "committedDate": "2020-02-13T14:52:22Z", "type": "commit"}, {"oid": "a740ba85c2887c0d7909973aa3b6c3001362049e", "url": "https://github.com/dotCMS/core/commit/a740ba85c2887c0d7909973aa3b6c3001362049e", "message": "#17984 create Resource to getFilters by Role", "committedDate": "2020-02-13T22:00:23Z", "type": "commit"}, {"oid": "ffa2c8344aa90988f20c77839cdc7f888c51b6e8", "url": "https://github.com/dotCMS/core/commit/ffa2c8344aa90988f20c77839cdc7f888c51b6e8", "message": "#17986 #17984 IT", "committedDate": "2020-02-18T18:58:14Z", "type": "commit"}, {"oid": "3a1bc461bb659ad67234b1cc76e20e43d2a268f3", "url": "https://github.com/dotCMS/core/commit/3a1bc461bb659ad67234b1cc76e20e43d2a268f3", "message": "#17998 ship dotcms filters", "committedDate": "2020-02-20T20:51:46Z", "type": "commit"}, {"oid": "e31cab36755d3cfbb94d1af27b16411ab6bee227", "url": "https://github.com/dotCMS/core/commit/e31cab36755d3cfbb94d1af27b16411ab6bee227", "message": "Merge branch 'master' of github.com:dotCMS/core into issue-17806-ppfilters", "committedDate": "2020-02-21T14:46:22Z", "type": "commit"}, {"oid": "5ee92a35499107d901e320e5f3fb995d69fd48fc", "url": "https://github.com/dotCMS/core/commit/5ee92a35499107d901e320e5f3fb995d69fd48fc", "message": "#17985 remove force_push param, add filterKey param, update bundle bean and references", "committedDate": "2020-02-24T17:03:29Z", "type": "commit"}, {"oid": "f21f0642348af4831c43ccc4310321dca5526526", "url": "https://github.com/dotCMS/core/commit/f21f0642348af4831c43ccc4310321dca5526526", "message": "#17806 merge master", "committedDate": "2020-02-25T14:36:42Z", "type": "commit"}, {"oid": "583617b0b1adc9dd1a449dd767df602b28797b65", "url": "https://github.com/dotCMS/core/commit/583617b0b1adc9dd1a449dd767df602b28797b65", "message": "#17985 add column to DB", "committedDate": "2020-02-25T20:49:43Z", "type": "commit"}, {"oid": "00abc5e8cfa54ce7c9e9b11bc20821312cf4863f", "url": "https://github.com/dotCMS/core/commit/00abc5e8cfa54ce7c9e9b11bc20821312cf4863f", "message": "#17985 add new column to queries", "committedDate": "2020-02-25T20:52:15Z", "type": "commit"}, {"oid": "8745734b5b7445f6c5ca3f1c4ccda0eaa854cf84", "url": "https://github.com/dotCMS/core/commit/8745734b5b7445f6c5ca3f1c4ccda0eaa854cf84", "message": "logs", "committedDate": "2020-02-25T21:12:33Z", "type": "commit"}, {"oid": "e8f073e0be7e0227f4f768d0a7088a1faf01b6dd", "url": "https://github.com/dotCMS/core/commit/e8f073e0be7e0227f4f768d0a7088a1faf01b6dd", "message": "logs", "committedDate": "2020-02-25T21:49:00Z", "type": "commit"}, {"oid": "ac7d74e20177cdae50c060f9514c24e7239de3b0", "url": "https://github.com/dotCMS/core/commit/ac7d74e20177cdae50c060f9514c24e7239de3b0", "message": "logs", "committedDate": "2020-02-25T22:14:08Z", "type": "commit"}, {"oid": "187ef45cf8d7503a3ddb1c3c7822c3539f67737e", "url": "https://github.com/dotCMS/core/commit/187ef45cf8d7503a3ddb1c3c7822c3539f67737e", "message": "logs", "committedDate": "2020-02-26T14:16:49Z", "type": "commit"}, {"oid": "caf2c488df3b4b0c1e94309e7e76f84e0363b152", "url": "https://github.com/dotCMS/core/commit/caf2c488df3b4b0c1e94309e7e76f84e0363b152", "message": "#17985 fix tests and revert logs", "committedDate": "2020-02-26T22:38:28Z", "type": "commit"}, {"oid": "1fa43eb3a3438d18c77981a678a004b2415d2d6b", "url": "https://github.com/dotCMS/core/commit/1fa43eb3a3438d18c77981a678a004b2415d2d6b", "message": "#17985 add new column to h2", "committedDate": "2020-02-27T14:28:49Z", "type": "commit"}, {"oid": "9c0fa018de0f60e87bde512132d9b164970ad74d", "url": "https://github.com/dotCMS/core/commit/9c0fa018de0f60e87bde512132d9b164970ad74d", "message": "Merge branch 'master' of github.com:dotCMS/core into issue-17806-ppfilters", "committedDate": "2020-02-27T14:30:04Z", "type": "commit"}, {"oid": "d8aa5d736780ea888f2678421b815fc25c1be5b1", "url": "https://github.com/dotCMS/core/commit/d8aa5d736780ea888f2678421b815fc25c1be5b1", "message": "Merge branch 'master' of github.com:dotCMS/core into issue-17806-ppfilters", "committedDate": "2020-02-27T15:33:47Z", "type": "commit"}, {"oid": "e0127b2ae5075e91965f2c13563c9507fba342cc", "url": "https://github.com/dotCMS/core/commit/e0127b2ae5075e91965f2c13563c9507fba342cc", "message": "#17985 force push comes in the yaml", "committedDate": "2020-02-28T17:07:58Z", "type": "commit"}, {"oid": "cd31653e43527c64812ac4fc57d0bc4772771dbd", "url": "https://github.com/dotCMS/core/commit/cd31653e43527c64812ac4fc57d0bc4772771dbd", "message": "#17985 forcePush yamls, and getFilterbykey", "committedDate": "2020-02-28T17:10:53Z", "type": "commit"}, {"oid": "ce6b868fb39466d18f4a63165be792307e5f9f36", "url": "https://github.com/dotCMS/core/commit/ce6b868fb39466d18f4a63165be792307e5f9f36", "message": "#17985 change title yml", "committedDate": "2020-02-28T20:22:54Z", "type": "commit"}, {"oid": "2e8ffc2eeda8f1d8718d4f656f2d0496fa83a42a", "url": "https://github.com/dotCMS/core/commit/2e8ffc2eeda8f1d8718d4f656f2d0496fa83a42a", "message": "#17985 change path of resource", "committedDate": "2020-03-02T14:09:30Z", "type": "commit"}, {"oid": "c993b41bbd858016d4b3b94cd52b938dc2616a93", "url": "https://github.com/dotCMS/core/commit/c993b41bbd858016d4b3b94cd52b938dc2616a93", "message": "#17985 merge master", "committedDate": "2020-03-04T17:28:21Z", "type": "commit"}, {"oid": "8ca2efb50fdff315e2be15b075359e4a1f71dc77", "url": "https://github.com/dotCMS/core/commit/8ca2efb50fdff315e2be15b075359e4a1f71dc77", "message": "Merge branch 'master' of github.com:dotCMS/core into issue-17806-ppfilters", "committedDate": "2020-03-04T18:07:21Z", "type": "commit"}, {"oid": "981ae4f703f48a001020fb80381bbc93600414c8", "url": "https://github.com/dotCMS/core/commit/981ae4f703f48a001020fb80381bbc93600414c8", "message": "#17985 update info to yaml files", "committedDate": "2020-03-09T16:56:43Z", "type": "commit"}, {"oid": "401cda5b2a80e777ec58db5cb0050769e3cbad77", "url": "https://github.com/dotCMS/core/commit/401cda5b2a80e777ec58db5cb0050769e3cbad77", "message": "#17985 publisherFilter manages filters values, IT", "committedDate": "2020-03-09T21:01:32Z", "type": "commit"}, {"oid": "470536e37414f2b239b113dc051e22791eeca707", "url": "https://github.com/dotCMS/core/commit/470536e37414f2b239b113dc051e22791eeca707", "message": "#17985 getFilterByKey and createPublisherFilter methods", "committedDate": "2020-03-09T23:02:28Z", "type": "commit"}, {"oid": "8c143fbd004c7526c3d02264ce2807710f2cc3a6", "url": "https://github.com/dotCMS/core/commit/8c143fbd004c7526c3d02264ce2807710f2cc3a6", "message": "#17985 apply accept to the dependencyManager to check if the asset is added to the bundle and which dependencies", "committedDate": "2020-03-09T23:04:10Z", "type": "commit"}, {"oid": "d15a8f48ea5cee798d5cf2c1218040bf1de4ac14", "url": "https://github.com/dotCMS/core/commit/d15a8f48ea5cee798d5cf2c1218040bf1de4ac14", "message": "merge master April 7th", "committedDate": "2020-04-07T17:53:52Z", "type": "commit"}, {"oid": "91ab7f00e2e1fad659a74090a28ef2ee5cae9290", "url": "https://github.com/dotCMS/core/commit/91ab7f00e2e1fad659a74090a28ef2ee5cae9290", "message": "#17985 #17806 modify yml files", "committedDate": "2020-04-08T21:38:35Z", "type": "commit"}, {"oid": "522868ce6c870005f525711c5139eaad09d5871d", "url": "https://github.com/dotCMS/core/commit/522868ce6c870005f525711c5139eaad09d5871d", "message": "#17985 fix structure excludeDependency", "committedDate": "2020-04-08T21:40:02Z", "type": "commit"}, {"oid": "7440314f0aac9785d81ab75a22b10e04431b6179", "url": "https://github.com/dotCMS/core/commit/7440314f0aac9785d81ab75a22b10e04431b6179", "message": "#17985 #17806 remove key from yml file, get from fileName", "committedDate": "2020-04-08T21:41:25Z", "type": "commit"}, {"oid": "1209a3cc1c6bc0068d66ec5a3c949b5dfc3339f8", "url": "https://github.com/dotCMS/core/commit/1209a3cc1c6bc0068d66ec5a3c949b5dfc3339f8", "message": "#17985 fix download bundle, use BundleId", "committedDate": "2020-04-08T21:43:02Z", "type": "commit"}, {"oid": "22a43c9e66afe2e15773107570cea1e270600e3d", "url": "https://github.com/dotCMS/core/commit/22a43c9e66afe2e15773107570cea1e270600e3d", "message": "#17806 #17985 order filters", "committedDate": "2020-04-09T15:27:09Z", "type": "commit"}, {"oid": "43601eb8c62e7e67b00c4e566b6fccaa5b7377ea", "url": "https://github.com/dotCMS/core/commit/43601eb8c62e7e67b00c4e566b6fccaa5b7377ea", "message": "#17985 show Filter applied in the bundle detail", "committedDate": "2020-04-09T19:48:41Z", "type": "commit"}, {"oid": "36dff915bf582a90094f2f3e57d6ec702a591dec", "url": "https://github.com/dotCMS/core/commit/36dff915bf582a90094f2f3e57d6ec702a591dec", "message": "#17985 fix oracle column datatype", "committedDate": "2020-04-09T21:03:27Z", "type": "commit"}, {"oid": "b1ed441f86356c16069ac5702dd3db9bd5f53135", "url": "https://github.com/dotCMS/core/commit/b1ed441f86356c16069ac5702dd3db9bd5f53135", "message": "#17985 upgradeTask and Test", "committedDate": "2020-04-09T22:12:54Z", "type": "commit"}, {"oid": "7acf88f3d9211f6e1569fdf4b852757b8788867e", "url": "https://github.com/dotCMS/core/commit/7acf88f3d9211f6e1569fdf4b852757b8788867e", "message": "#17985 add upgradeTask to TaskLocator", "committedDate": "2020-04-13T19:33:21Z", "type": "commit"}, {"oid": "13187fc67fcd9fe8774e527f2edfb8f7adff68bd", "url": "https://github.com/dotCMS/core/commit/13187fc67fcd9fe8774e527f2edfb8f7adff68bd", "message": "merge master", "committedDate": "2020-04-20T17:31:08Z", "type": "commit"}, {"oid": "4b9d8e7bca09e34e3a7c84d347fc8b186b9219eb", "url": "https://github.com/dotCMS/core/commit/4b9d8e7bca09e34e3a7c84d347fc8b186b9219eb", "message": "#17806 new tests and refactor other ones", "committedDate": "2020-04-21T16:58:24Z", "type": "commit"}, {"oid": "d4c4078d746fe72714773439c05f0d1b2d08f512", "url": "https://github.com/dotCMS/core/commit/d4c4078d746fe72714773439c05f0d1b2d08f512", "message": "#17806 rename methods", "committedDate": "2020-04-21T16:59:44Z", "type": "commit"}, {"oid": "6965a08afabb751a10bdcd4bddc5360f334335dd", "url": "https://github.com/dotCMS/core/commit/6965a08afabb751a10bdcd4bddc5360f334335dd", "message": "#17806 fix tests", "committedDate": "2020-04-21T17:40:43Z", "type": "commit"}, {"oid": "d0a820b51d6fa417678bce28d7b3f2e16ff07d2a", "url": "https://github.com/dotCMS/core/commit/d0a820b51d6fa417678bce28d7b3f2e16ff07d2a", "message": "Merge branch 'master' of github.com:dotCMS/core into issue-17806-ppfilters", "committedDate": "2020-04-22T15:59:57Z", "type": "commit"}, {"oid": "6852c3a43ce24e374e5e3f106d19f797adff7f86", "url": "https://github.com/dotCMS/core/commit/6852c3a43ce24e374e5e3f106d19f797adff7f86", "message": "Merge branch 'master' of github.com:dotCMS/core into issue-17806-ppfilters", "committedDate": "2020-04-24T16:26:25Z", "type": "commit"}, {"oid": "da07b60e77143ac297df3a6823f3aab858df5768", "url": "https://github.com/dotCMS/core/commit/da07b60e77143ac297df3a6823f3aab858df5768", "message": "#17806 change structure for contenttype", "committedDate": "2020-04-24T18:13:10Z", "type": "commit"}, {"oid": "a778b93954912a0b0ebebfee6b9cb4e5d9d5b8a7", "url": "https://github.com/dotCMS/core/commit/a778b93954912a0b0ebebfee6b9cb4e5d9d5b8a7", "message": "#17806 tests", "committedDate": "2020-04-28T00:11:12Z", "type": "commit"}, {"oid": "133ac7126a55aba1e2d1407d701c4e9bb5d6eb7a", "url": "https://github.com/dotCMS/core/commit/133ac7126a55aba1e2d1407d701c4e9bb5d6eb7a", "message": "#17806 #17985 better definition of relationship filter", "committedDate": "2020-04-28T18:46:45Z", "type": "commit"}, {"oid": "4fb67a317560c9889966f77ce35b2b0c45898051", "url": "https://github.com/dotCMS/core/commit/4fb67a317560c9889966f77ce35b2b0c45898051", "message": "#17806 tests", "committedDate": "2020-04-28T18:48:06Z", "type": "commit"}, {"oid": "a0e6f85d575f288592d2c018c886556b5cd699f5", "url": "https://github.com/dotCMS/core/commit/a0e6f85d575f288592d2c018c886556b5cd699f5", "message": "#17806 #17985 tests", "committedDate": "2020-05-01T21:46:26Z", "type": "commit"}, {"oid": "6869538b2a86df10c68b49810c1e0fc52feb600f", "url": "https://github.com/dotCMS/core/commit/6869538b2a86df10c68b49810c1e0fc52feb600f", "message": "#17985 merge master", "committedDate": "2020-05-01T21:52:52Z", "type": "commit"}, {"oid": "38a805f564931586628e409141e62f791190bfd6", "url": "https://github.com/dotCMS/core/commit/38a805f564931586628e409141e62f791190bfd6", "message": "#17985 add tests to mainsuite", "committedDate": "2020-05-02T01:22:12Z", "type": "commit"}, {"oid": "21a7b1eb1b80d45b013bf82cb21b81e233ad04ac", "url": "https://github.com/dotCMS/core/commit/21a7b1eb1b80d45b013bf82cb21b81e233ad04ac", "message": "Merge branch 'master' of github.com:dotCMS/core into issue-17806-ppfilters", "committedDate": "2020-05-04T14:30:11Z", "type": "commit"}, {"oid": "6284a4bdf499874fe638ccf0f04018e52239777a", "url": "https://github.com/dotCMS/core/commit/6284a4bdf499874fe638ccf0f04018e52239777a", "message": "#17806 fix failing tests", "committedDate": "2020-05-04T17:48:41Z", "type": "commit"}, {"oid": "74d8492e2dadcc9901bf430c7deedeb7da725b7f", "url": "https://github.com/dotCMS/core/commit/74d8492e2dadcc9901bf430c7deedeb7da725b7f", "message": "#17806 toString publisherFilter", "committedDate": "2020-05-04T20:07:59Z", "type": "commit"}, {"oid": "6cf5dc5bf0c33e77862e6d14f7c64edeca79b0c7", "url": "https://github.com/dotCMS/core/commit/6cf5dc5bf0c33e77862e6d14f7c64edeca79b0c7", "message": "#17806 error message assert", "committedDate": "2020-05-04T20:09:09Z", "type": "commit"}, {"oid": "488cd98c1f44831ae8587788d3c9d1818997dfae", "url": "https://github.com/dotCMS/core/commit/488cd98c1f44831ae8587788d3c9d1818997dfae", "message": "fix test", "committedDate": "2020-05-04T21:14:23Z", "type": "commit"}, {"oid": "294472d26f4e044cade157ed39534b31f531fc81", "url": "https://github.com/dotCMS/core/commit/294472d26f4e044cade157ed39534b31f531fc81", "message": "logs for failing test, delete later", "committedDate": "2020-05-04T21:59:08Z", "type": "commit"}, {"oid": "f262b5e4eab8987e08033397dcd33c594db6ee24", "url": "https://github.com/dotCMS/core/commit/f262b5e4eab8987e08033397dcd33c594db6ee24", "message": "logs for failing test, delete later", "committedDate": "2020-05-05T00:58:50Z", "type": "commit"}, {"oid": "f8103f0fb2e6d439cd8335dde26a8096ea972dce", "url": "https://github.com/dotCMS/core/commit/f8103f0fb2e6d439cd8335dde26a8096ea972dce", "message": "logs for failing test, delete later", "committedDate": "2020-05-05T02:38:26Z", "type": "commit"}, {"oid": "86bb128e7bd5cfc88d3449c149c4fe006ea6824c", "url": "https://github.com/dotCMS/core/commit/86bb128e7bd5cfc88d3449c149c4fe006ea6824c", "message": "#17806 #17985 missing apply filters to lang var", "committedDate": "2020-05-05T14:56:07Z", "type": "commit"}, {"oid": "7e9325f54ca814dbbbdaed6e0f82b23b2a10b6bd", "url": "https://github.com/dotCMS/core/commit/7e9325f54ca814dbbbdaed6e0f82b23b2a10b6bd", "message": "remove logs for testing", "committedDate": "2020-05-05T17:33:49Z", "type": "commit"}, {"oid": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "url": "https://github.com/dotCMS/core/commit/adfebf4e3a948581410f416bb5f6127fde9b1a7e", "message": "Merge branch 'master' of github.com:dotCMS/core into issue-17806-ppfilters", "committedDate": "2020-05-11T20:08:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU2NjQ4Mg==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424566482", "bodyText": "use this doc guide\n\n/**\n* Method to test: include this in case the method to test does not belong to the class this test-class is testing \n* Given Scenario: Scenario under test\n* ExpectedResult: Expected result that the assertion is checking against\n*\n*/", "author": "jdotcms", "createdAt": "2020-05-13T16:20:10Z", "path": "dotCMS/src/integration-test/java/com/dotcms/publishing/PublisherFilterImplTest.java", "diffHunk": "@@ -0,0 +1,122 @@\n+package com.dotcms.publishing;\n+\n+import com.dotcms.publisher.util.PusheableAsset;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.util.UUIDGenerator;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+public class PublisherFilterImplTest {\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {\n+        //Setting web app environment\n+        IntegrationTestInitService.getInstance().init();\n+    }\n+\n+    @Test", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6487fe139932b9740065dd125e56be3a12c6905b", "chunk": "diff --git a/dotCMS/src/integration-test/java/com/dotcms/publishing/PublisherFilterImplTest.java b/dotCMS/src/integration-test/java/com/dotcms/publishing/PublisherFilterImplTest.java\nindex e29658d5a4..c1fc30e815 100644\n--- a/dotCMS/src/integration-test/java/com/dotcms/publishing/PublisherFilterImplTest.java\n+++ b/dotCMS/src/integration-test/java/com/dotcms/publishing/PublisherFilterImplTest.java\n\n@@ -17,6 +17,12 @@ public class PublisherFilterImplTest {\n         IntegrationTestInitService.getInstance().init();\n     }\n \n+    /**\n+     * Method to test: {@link PublisherFilter#acceptExcludeDependencyClasses(String)}\n+     * Given Scenario: Given a list of types that are gonna be excluded to PP as a Dependency\n+     * ExpectedResult: Types in the list are excluded and types not in the list are accepted\n+     *\n+     */\n     @Test\n     public void Test_acceptExcludeDependencyClasses(){\n         // Using diff case because user can use diff case\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU2ODA4Nw==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424568087", "bodyText": "I think on some db these strategies may break the connection, I think we can query the catalog to check metainfo to see if the filter_key exists", "author": "jdotcms", "createdAt": "2020-05-13T16:22:34Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/startup/runonce/Task05305AddPushPublishFilterColumnTest.java", "diffHunk": "@@ -0,0 +1,46 @@\n+package com.dotmarketing.startup.runonce;\n+\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.common.db.DotConnect;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+import com.dotmarketing.exception.DotDataException;\n+import java.sql.SQLException;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+public class Task05305AddPushPublishFilterColumnTest {\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {\n+        // Setting web app environment\n+        IntegrationTestInitService.getInstance().init();\n+    }\n+\n+    private void dropColumn() throws SQLException {\n+        final String dropColumnSQL = \"ALTER TABLE publishing_bundle DROP COLUMN filter_key\";\n+        final DotConnect dotConnect = new DotConnect();\n+        dotConnect.executeStatement(dropColumnSQL);\n+    }\n+\n+    private boolean checkColumnExists(){\n+        final String dropColumnSQL = \"select id from publishing_bundle where filter_key = ''\";", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cdf576a198511562cb24aa36e0f151f02153c900", "chunk": "diff --git a/dotCMS/src/integration-test/java/com/dotmarketing/startup/runonce/Task05305AddPushPublishFilterColumnTest.java b/dotCMS/src/integration-test/java/com/dotmarketing/startup/runonce/Task05305AddPushPublishFilterColumnTest.java\nindex 448f6338c6..04cbb7f377 100644\n--- a/dotCMS/src/integration-test/java/com/dotmarketing/startup/runonce/Task05305AddPushPublishFilterColumnTest.java\n+++ b/dotCMS/src/integration-test/java/com/dotmarketing/startup/runonce/Task05305AddPushPublishFilterColumnTest.java\n\n@@ -23,24 +23,13 @@ public class Task05305AddPushPublishFilterColumnTest {\n         dotConnect.executeStatement(dropColumnSQL);\n     }\n \n-    private boolean checkColumnExists(){\n-        final String dropColumnSQL = \"select id from publishing_bundle where filter_key = ''\";\n-        final DotConnect dotConnect = new DotConnect();\n-        try {\n-            dotConnect.executeStatement(dropColumnSQL);\n-            return true;\n-        } catch (SQLException e) {\n-            return false;\n-        }\n-    }\n-\n     @Test\n     public void test_upgradeTask_success() throws SQLException, DotDataException {\n         dropColumn();\n-        assertFalse(checkColumnExists());\n         final Task05305AddPushPublishFilterColumn task = new Task05305AddPushPublishFilterColumn();\n+        assertTrue(task.forceRun());//True because the column does not exists\n         task.executeUpgrade();\n-        assertTrue(checkColumnExists());\n+        assertFalse(task.forceRun());//False because the column exists\n     }\n \n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU3MDA5Mg==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424570092", "bodyText": "rename to publisherAPI", "author": "jdotcms", "createdAt": "2020-05-13T16:25:31Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/ajax/RemotePublishAjaxAction.java", "diffHunk": "@@ -633,13 +633,13 @@ public void downloadUnpushedBundle ( HttpServletRequest request, HttpServletResp\n     @SuppressWarnings (\"unchecked\")\n     private Map<String, Object> generateBundle ( String bundleId, PushPublisherConfig.Operation operation ) throws DotPublisherException, DotDataException, DotPublishingException, IllegalAccessException, InstantiationException, DotBundleException, IOException {\n \n-        PushPublisherConfig pconf = new PushPublisherConfig();\n-        PublisherAPI pubAPI = PublisherAPI.getInstance();\n+        final PushPublisherConfig pconf = new PushPublisherConfig();\n+        final PublisherAPI pubAPI = PublisherAPI.getInstance();", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/ajax/RemotePublishAjaxAction.java b/dotCMS/src/main/java/com/dotcms/publisher/ajax/RemotePublishAjaxAction.java\nindex 42870e7e73..82b0d6154a 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/ajax/RemotePublishAjaxAction.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/ajax/RemotePublishAjaxAction.java\n\n@@ -633,24 +633,24 @@ public class RemotePublishAjaxAction extends AjaxAction {\n     @SuppressWarnings (\"unchecked\")\n     private Map<String, Object> generateBundle ( String bundleId, PushPublisherConfig.Operation operation ) throws DotPublisherException, DotDataException, DotPublishingException, IllegalAccessException, InstantiationException, DotBundleException, IOException {\n \n-        final PushPublisherConfig pconf = new PushPublisherConfig();\n-        final PublisherAPI pubAPI = PublisherAPI.getInstance();\n+        final PushPublisherConfig pushPublisherConfig = new PushPublisherConfig();\n+        final PublisherAPI publisherAPI = PublisherAPI.getInstance();\n \n-        final List<PublishQueueElement> tempBundleContents = pubAPI.getQueueElementsByBundleId( bundleId );\n+        final List<PublishQueueElement> tempBundleContents = publisherAPI.getQueueElementsByBundleId( bundleId );\n         final List<PublishQueueElement> assetsToPublish = new ArrayList<PublishQueueElement>();\n \n-        for ( final PublishQueueElement c : tempBundleContents ) {\n-                assetsToPublish.add( c );\n+        for ( final PublishQueueElement publishQueueElement : tempBundleContents ) {\n+                assetsToPublish.add( publishQueueElement );\n         }\n \n-        pconf.setDownloading( true );\n-        pconf.setOperation(operation);\n+        pushPublisherConfig.setDownloading( true );\n+        pushPublisherConfig.setOperation(operation);\n \n-        pconf.setAssets( assetsToPublish );\n+        pushPublisherConfig.setAssets( assetsToPublish );\n         //Queries creation\n-        pconf.setLuceneQueries( PublisherUtil.prepareQueries( tempBundleContents ) );\n-        pconf.setId( bundleId );\n-        pconf.setUser( APILocator.getUserAPI().getSystemUser() );\n+        pushPublisherConfig.setLuceneQueries( PublisherUtil.prepareQueries( tempBundleContents ) );\n+        pushPublisherConfig.setId( bundleId );\n+        pushPublisherConfig.setUser( APILocator.getUserAPI().getSystemUser() );\n \n         //BUNDLERS\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU3MDI1MQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424570251", "bodyText": "rename to pushPublisherConfig", "author": "jdotcms", "createdAt": "2020-05-13T16:25:45Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/ajax/RemotePublishAjaxAction.java", "diffHunk": "@@ -633,13 +633,13 @@ public void downloadUnpushedBundle ( HttpServletRequest request, HttpServletResp\n     @SuppressWarnings (\"unchecked\")\n     private Map<String, Object> generateBundle ( String bundleId, PushPublisherConfig.Operation operation ) throws DotPublisherException, DotDataException, DotPublishingException, IllegalAccessException, InstantiationException, DotBundleException, IOException {\n \n-        PushPublisherConfig pconf = new PushPublisherConfig();\n-        PublisherAPI pubAPI = PublisherAPI.getInstance();\n+        final PushPublisherConfig pconf = new PushPublisherConfig();", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/ajax/RemotePublishAjaxAction.java b/dotCMS/src/main/java/com/dotcms/publisher/ajax/RemotePublishAjaxAction.java\nindex 42870e7e73..82b0d6154a 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/ajax/RemotePublishAjaxAction.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/ajax/RemotePublishAjaxAction.java\n\n@@ -633,24 +633,24 @@ public class RemotePublishAjaxAction extends AjaxAction {\n     @SuppressWarnings (\"unchecked\")\n     private Map<String, Object> generateBundle ( String bundleId, PushPublisherConfig.Operation operation ) throws DotPublisherException, DotDataException, DotPublishingException, IllegalAccessException, InstantiationException, DotBundleException, IOException {\n \n-        final PushPublisherConfig pconf = new PushPublisherConfig();\n-        final PublisherAPI pubAPI = PublisherAPI.getInstance();\n+        final PushPublisherConfig pushPublisherConfig = new PushPublisherConfig();\n+        final PublisherAPI publisherAPI = PublisherAPI.getInstance();\n \n-        final List<PublishQueueElement> tempBundleContents = pubAPI.getQueueElementsByBundleId( bundleId );\n+        final List<PublishQueueElement> tempBundleContents = publisherAPI.getQueueElementsByBundleId( bundleId );\n         final List<PublishQueueElement> assetsToPublish = new ArrayList<PublishQueueElement>();\n \n-        for ( final PublishQueueElement c : tempBundleContents ) {\n-                assetsToPublish.add( c );\n+        for ( final PublishQueueElement publishQueueElement : tempBundleContents ) {\n+                assetsToPublish.add( publishQueueElement );\n         }\n \n-        pconf.setDownloading( true );\n-        pconf.setOperation(operation);\n+        pushPublisherConfig.setDownloading( true );\n+        pushPublisherConfig.setOperation(operation);\n \n-        pconf.setAssets( assetsToPublish );\n+        pushPublisherConfig.setAssets( assetsToPublish );\n         //Queries creation\n-        pconf.setLuceneQueries( PublisherUtil.prepareQueries( tempBundleContents ) );\n-        pconf.setId( bundleId );\n-        pconf.setUser( APILocator.getUserAPI().getSystemUser() );\n+        pushPublisherConfig.setLuceneQueries( PublisherUtil.prepareQueries( tempBundleContents ) );\n+        pushPublisherConfig.setId( bundleId );\n+        pushPublisherConfig.setUser( APILocator.getUserAPI().getSystemUser() );\n \n         //BUNDLERS\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU3MDYyOA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424570628", "bodyText": "rename to publishQueueElement", "author": "jdotcms", "createdAt": "2020-05-13T16:26:15Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/ajax/RemotePublishAjaxAction.java", "diffHunk": "@@ -633,13 +633,13 @@ public void downloadUnpushedBundle ( HttpServletRequest request, HttpServletResp\n     @SuppressWarnings (\"unchecked\")\n     private Map<String, Object> generateBundle ( String bundleId, PushPublisherConfig.Operation operation ) throws DotPublisherException, DotDataException, DotPublishingException, IllegalAccessException, InstantiationException, DotBundleException, IOException {\n \n-        PushPublisherConfig pconf = new PushPublisherConfig();\n-        PublisherAPI pubAPI = PublisherAPI.getInstance();\n+        final PushPublisherConfig pconf = new PushPublisherConfig();\n+        final PublisherAPI pubAPI = PublisherAPI.getInstance();\n \n-        List<PublishQueueElement> tempBundleContents = pubAPI.getQueueElementsByBundleId( bundleId );\n-        List<PublishQueueElement> assetsToPublish = new ArrayList<PublishQueueElement>(); \n+        final List<PublishQueueElement> tempBundleContents = pubAPI.getQueueElementsByBundleId( bundleId );\n+        final List<PublishQueueElement> assetsToPublish = new ArrayList<PublishQueueElement>();\n \n-        for ( PublishQueueElement c : tempBundleContents ) {\n+        for ( final PublishQueueElement c : tempBundleContents ) {", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/ajax/RemotePublishAjaxAction.java b/dotCMS/src/main/java/com/dotcms/publisher/ajax/RemotePublishAjaxAction.java\nindex 42870e7e73..82b0d6154a 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/ajax/RemotePublishAjaxAction.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/ajax/RemotePublishAjaxAction.java\n\n@@ -633,24 +633,24 @@ public class RemotePublishAjaxAction extends AjaxAction {\n     @SuppressWarnings (\"unchecked\")\n     private Map<String, Object> generateBundle ( String bundleId, PushPublisherConfig.Operation operation ) throws DotPublisherException, DotDataException, DotPublishingException, IllegalAccessException, InstantiationException, DotBundleException, IOException {\n \n-        final PushPublisherConfig pconf = new PushPublisherConfig();\n-        final PublisherAPI pubAPI = PublisherAPI.getInstance();\n+        final PushPublisherConfig pushPublisherConfig = new PushPublisherConfig();\n+        final PublisherAPI publisherAPI = PublisherAPI.getInstance();\n \n-        final List<PublishQueueElement> tempBundleContents = pubAPI.getQueueElementsByBundleId( bundleId );\n+        final List<PublishQueueElement> tempBundleContents = publisherAPI.getQueueElementsByBundleId( bundleId );\n         final List<PublishQueueElement> assetsToPublish = new ArrayList<PublishQueueElement>();\n \n-        for ( final PublishQueueElement c : tempBundleContents ) {\n-                assetsToPublish.add( c );\n+        for ( final PublishQueueElement publishQueueElement : tempBundleContents ) {\n+                assetsToPublish.add( publishQueueElement );\n         }\n \n-        pconf.setDownloading( true );\n-        pconf.setOperation(operation);\n+        pushPublisherConfig.setDownloading( true );\n+        pushPublisherConfig.setOperation(operation);\n \n-        pconf.setAssets( assetsToPublish );\n+        pushPublisherConfig.setAssets( assetsToPublish );\n         //Queries creation\n-        pconf.setLuceneQueries( PublisherUtil.prepareQueries( tempBundleContents ) );\n-        pconf.setId( bundleId );\n-        pconf.setUser( APILocator.getUserAPI().getSystemUser() );\n+        pushPublisherConfig.setLuceneQueries( PublisherUtil.prepareQueries( tempBundleContents ) );\n+        pushPublisherConfig.setId( bundleId );\n+        pushPublisherConfig.setUser( APILocator.getUserAPI().getSystemUser() );\n \n         //BUNDLERS\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU4ODUwMQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424588501", "bodyText": "rename to clazzBundler", "author": "jdotcms", "createdAt": "2020-05-13T16:54:19Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/ajax/RemotePublishAjaxAction.java", "diffHunk": "@@ -654,32 +654,28 @@ public void downloadUnpushedBundle ( HttpServletRequest request, HttpServletResp\n \n         //BUNDLERS\n \n-        List<Class<IBundler>> bundlers = new ArrayList<Class<IBundler>>();\n-        List<IBundler> confBundlers = new ArrayList<IBundler>();\n+        final List<Class<IBundler>> bundlers = new ArrayList<Class<IBundler>>();\n+        final List<IBundler> confBundlers = new ArrayList<IBundler>();\n \n-        Publisher publisher = new PushPublisher();\n+        final Publisher publisher = new PushPublisher();\n         publisher.init( pconf );\n         //Add the bundles for this publisher\n-        for ( Class clazz : publisher.getBundlers() ) {\n+        for ( final Class clazz : publisher.getBundlers() ) {\n             if ( !bundlers.contains( clazz ) ) {\n                 bundlers.add( clazz );\n             }\n         }\n-\n-        //Create a new bundle id for this generated bundle\n-        String newBundleId = UUID.randomUUID().toString();\n-        pconf.setId( newBundleId );\n-        File bundleRoot = BundlerUtil.getBundleRoot( pconf );\n+        final File bundleRoot = BundlerUtil.getBundleRoot( pconf );\n \n         // Run bundlers\n         BundlerUtil.writeBundleXML( pconf );\n-        for ( Class<IBundler> c : bundlers ) {\n+        for ( final Class<IBundler> c : bundlers ) {", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/ajax/RemotePublishAjaxAction.java b/dotCMS/src/main/java/com/dotcms/publisher/ajax/RemotePublishAjaxAction.java\nindex 42870e7e73..82b0d6154a 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/ajax/RemotePublishAjaxAction.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/ajax/RemotePublishAjaxAction.java\n\n@@ -633,24 +633,24 @@ public class RemotePublishAjaxAction extends AjaxAction {\n     @SuppressWarnings (\"unchecked\")\n     private Map<String, Object> generateBundle ( String bundleId, PushPublisherConfig.Operation operation ) throws DotPublisherException, DotDataException, DotPublishingException, IllegalAccessException, InstantiationException, DotBundleException, IOException {\n \n-        final PushPublisherConfig pconf = new PushPublisherConfig();\n-        final PublisherAPI pubAPI = PublisherAPI.getInstance();\n+        final PushPublisherConfig pushPublisherConfig = new PushPublisherConfig();\n+        final PublisherAPI publisherAPI = PublisherAPI.getInstance();\n \n-        final List<PublishQueueElement> tempBundleContents = pubAPI.getQueueElementsByBundleId( bundleId );\n+        final List<PublishQueueElement> tempBundleContents = publisherAPI.getQueueElementsByBundleId( bundleId );\n         final List<PublishQueueElement> assetsToPublish = new ArrayList<PublishQueueElement>();\n \n-        for ( final PublishQueueElement c : tempBundleContents ) {\n-                assetsToPublish.add( c );\n+        for ( final PublishQueueElement publishQueueElement : tempBundleContents ) {\n+                assetsToPublish.add( publishQueueElement );\n         }\n \n-        pconf.setDownloading( true );\n-        pconf.setOperation(operation);\n+        pushPublisherConfig.setDownloading( true );\n+        pushPublisherConfig.setOperation(operation);\n \n-        pconf.setAssets( assetsToPublish );\n+        pushPublisherConfig.setAssets( assetsToPublish );\n         //Queries creation\n-        pconf.setLuceneQueries( PublisherUtil.prepareQueries( tempBundleContents ) );\n-        pconf.setId( bundleId );\n-        pconf.setUser( APILocator.getUserAPI().getSystemUser() );\n+        pushPublisherConfig.setLuceneQueries( PublisherUtil.prepareQueries( tempBundleContents ) );\n+        pushPublisherConfig.setId( bundleId );\n+        pushPublisherConfig.setUser( APILocator.getUserAPI().getSystemUser() );\n \n         //BUNDLERS\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU4ODgzMQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424588831", "bodyText": "rename to fileList", "author": "jdotcms", "createdAt": "2020-05-13T16:54:52Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/ajax/RemotePublishAjaxAction.java", "diffHunk": "@@ -689,12 +685,11 @@ public void downloadUnpushedBundle ( HttpServletRequest request, HttpServletResp\n         pconf.setBundlers( confBundlers );\n \n         //Compressing bundle\n-        ArrayList<File> list = new ArrayList<File>();\n+        final ArrayList<File> list = new ArrayList<File>();", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/ajax/RemotePublishAjaxAction.java b/dotCMS/src/main/java/com/dotcms/publisher/ajax/RemotePublishAjaxAction.java\nindex 42870e7e73..82b0d6154a 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/ajax/RemotePublishAjaxAction.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/ajax/RemotePublishAjaxAction.java\n\n@@ -658,39 +658,39 @@ public class RemotePublishAjaxAction extends AjaxAction {\n         final List<IBundler> confBundlers = new ArrayList<IBundler>();\n \n         final Publisher publisher = new PushPublisher();\n-        publisher.init( pconf );\n+        publisher.init( pushPublisherConfig );\n         //Add the bundles for this publisher\n         for ( final Class clazz : publisher.getBundlers() ) {\n             if ( !bundlers.contains( clazz ) ) {\n                 bundlers.add( clazz );\n             }\n         }\n-        final File bundleRoot = BundlerUtil.getBundleRoot( pconf );\n+        final File bundleRoot = BundlerUtil.getBundleRoot( pushPublisherConfig );\n \n         // Run bundlers\n-        BundlerUtil.writeBundleXML( pconf );\n-        for ( final Class<IBundler> c : bundlers ) {\n+        BundlerUtil.writeBundleXML( pushPublisherConfig );\n+        for ( final Class<IBundler> clazzBundler : bundlers ) {\n \n-            final IBundler bundler = c.newInstance();\n+            final IBundler bundler = clazzBundler.newInstance();\n             confBundlers.add( bundler );\n-            bundler.setConfig( pconf );\n+            bundler.setConfig( pushPublisherConfig );\n             bundler.setPublisher(publisher);\n             final BundlerStatus bundlerStatus = new BundlerStatus( bundler.getClass().getName() );\n             //Generate the bundler\n-            Logger.info(this, \"Start of Bundler: \" + c.getSimpleName());\n+            Logger.info(this, \"Start of Bundler: \" + clazzBundler.getSimpleName());\n             bundler.generate( bundleRoot, bundlerStatus );\n-            Logger.info(this, \"End of Bundler: \" + c.getSimpleName());\n+            Logger.info(this, \"End of Bundler: \" + clazzBundler.getSimpleName());\n         }\n \n-        pconf.setBundlers( confBundlers );\n+        pushPublisherConfig.setBundlers( confBundlers );\n \n         //Compressing bundle\n-        final ArrayList<File> list = new ArrayList<File>();\n-        list.add( bundleRoot );\n-        final File bundle = new File( bundleRoot + File.separator + \"..\" + File.separator + pconf.getId() + \".tar.gz\" );\n+        final ArrayList<File> fileList = new ArrayList<File>();\n+        fileList.add( bundleRoot );\n+        final File bundle = new File( bundleRoot + File.separator + \"..\" + File.separator + pushPublisherConfig.getId() + \".tar.gz\" );\n \n         final Map<String, Object> bundleData = new HashMap<String, Object>();\n-        bundleData.put( \"file\", PushUtils.compressFiles( list, bundle, bundleRoot.getAbsolutePath() ) );\n+        bundleData.put( \"file\", PushUtils.compressFiles( fileList, bundle, bundleRoot.getAbsolutePath() ) );\n         return bundleData;\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU5MjQwMA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424592400", "bodyText": "remove the _ from the variables", "author": "jdotcms", "createdAt": "2020-05-13T17:00:20Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/ajax/RemotePublishAjaxAction.java", "diffHunk": "@@ -937,19 +932,15 @@ public void pushBundle ( HttpServletRequest request, HttpServletResponse respons\n             PublisherAPI publisherAPI = PublisherAPI.getInstance();\n \n             //Read the form values\n-            String bundleId = request.getParameter( \"assetIdentifier\" );\n-            String _contentPushPublishDate = request.getParameter( \"remotePublishDate\" );\n-            String _contentPushPublishTime = request.getParameter( \"remotePublishTime\" );\n-            String _contentPushExpireDate = request.getParameter( \"remotePublishExpireDate\" );\n-            String _contentPushExpireTime = request.getParameter( \"remotePublishExpireTime\" );\n-            String _iWantTo = request.getParameter( \"iWantTo\" );\n-            String whoToSendTmp = request.getParameter( \"whoToSend\" );\n-            String forcePushTmp = request.getParameter( \"forcePush\" );\n-            \n-            Boolean forcePush = false;\n-            if(UtilMethods.isSet(forcePushTmp)){\n-                forcePush = Boolean.valueOf(forcePushTmp);\n-            }\n+            final String bundleId = request.getParameter( \"assetIdentifier\" );\n+            final String _contentPushPublishDate = request.getParameter( \"remotePublishDate\" );", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/ajax/RemotePublishAjaxAction.java b/dotCMS/src/main/java/com/dotcms/publisher/ajax/RemotePublishAjaxAction.java\nindex 42870e7e73..82b0d6154a 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/ajax/RemotePublishAjaxAction.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/ajax/RemotePublishAjaxAction.java\n\n@@ -933,11 +933,11 @@ public class RemotePublishAjaxAction extends AjaxAction {\n \n             //Read the form values\n             final String bundleId = request.getParameter( \"assetIdentifier\" );\n-            final String _contentPushPublishDate = request.getParameter( \"remotePublishDate\" );\n-            final String _contentPushPublishTime = request.getParameter( \"remotePublishTime\" );\n-            final String _contentPushExpireDate = request.getParameter( \"remotePublishExpireDate\" );\n-            final String _contentPushExpireTime = request.getParameter( \"remotePublishExpireTime\" );\n-            final String _iWantTo = request.getParameter( \"iWantTo\" );\n+            final String contentPushPublishDate = request.getParameter( \"remotePublishDate\" );\n+            final String contentPushPublishTime = request.getParameter( \"remotePublishTime\" );\n+            final String contentPushExpireDate = request.getParameter( \"remotePublishExpireDate\" );\n+            final String contentPushExpireTime = request.getParameter( \"remotePublishExpireTime\" );\n+            final String iWantTo = request.getParameter( \"iWantTo\" );\n             final String whoToSendTmp = request.getParameter( \"whoToSend\" );\n             final String filterKey = request.getParameter(\"filterKey\");\n             final boolean forcePush = (boolean) APILocator.getPublisherAPI().getFilterDescriptorByKey(filterKey).getFilters().getOrDefault(\"forcePush\",false);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU5NzA5Nw==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424597097", "bodyText": "rename to\nfinal Folder folder =", "author": "jdotcms", "createdAt": "2020-05-13T17:08:09Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -357,35 +370,55 @@ public void setDependencies() throws DotSecurityException, DotDataException, Dot\n \t * <li>Folders</li>\n \t * </ul>\n \t */\n-\tprivate void setLinkDependencies() {\n+\tprivate void setLinkDependencies(final PublisherFilter publisherFilter)  {\n \t\tfor(String linkId : linksSet) {\n \t\t\ttry {\n \t\t\t\tIdentifier ident=APILocator.getIdentifierAPI().find(linkId);\n-\t\t\t\tFolder ff = APILocator.getFolderAPI().findFolderByPath(ident.getParentPath(), ident.getHostId(), user, false);\n-\t\t\t\tfolders.addOrClean( ff.getInode(), ff.getModDate());\n-\t\t\t\tfoldersSet.add(ff.getInode());\n \n-\t\t\t\tHost hh=APILocator.getHostAPI().find(ident.getHostId(), user, false);\n-\t\t\t\thosts.addOrClean( hh.getIdentifier(), hh.getModDate());\n-\t\t\t\thostsSet.add(hh.getIdentifier());\n+\t\t\t\t// Folder Dependencies\n+\t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n+\t\t\t\t\tFolder ff = APILocator.getFolderAPI()", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -377,39 +377,39 @@ public class DependencyManager {\n \n \t\t\t\t// Folder Dependencies\n \t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n-\t\t\t\t\tFolder ff = APILocator.getFolderAPI()\n+\t\t\t\t\tfinal Folder folder = APILocator.getFolderAPI()\n \t\t\t\t\t\t\t.findFolderByPath(ident.getParentPath(), ident.getHostId(), user,\n \t\t\t\t\t\t\t\t\tfalse);\n-\t\t\t\t\tfolders.addOrClean(ff.getInode(), ff.getModDate());\n-\t\t\t\t\tfoldersSet.add(ff.getInode());\n+\t\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n+\t\t\t\t\tfoldersSet.add(folder.getInode());\n \t\t\t\t}\n \n \t\t\t\t// Host Dependencies\n \t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\t\tHost hh = APILocator.getHostAPI().find(ident.getHostId(), user, false);\n-\t\t\t\t\thosts.addOrClean(hh.getIdentifier(), hh.getModDate());\n-\t\t\t\t\thostsSet.add(hh.getIdentifier());\n+\t\t\t\t\tfinal Host host = APILocator.getHostAPI().find(ident.getHostId(), user, false);\n+\t\t\t\t\thosts.addOrClean(host.getIdentifier(), host.getModDate());\n+\t\t\t\t\thostsSet.add(host.getIdentifier());\n \t\t\t\t}\n \n \t\t\t\t// Content Dependencies\n \t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType())) {\n-\t\t\t\t\tLink link = APILocator.getMenuLinkAPI()\n+\t\t\t\t\tfinal Link link = APILocator.getMenuLinkAPI()\n \t\t\t\t\t\t\t.findWorkingLinkById(linkId, user, false);\n \n \t\t\t\t\tif (link != null) {\n \n \t\t\t\t\t\tif (link.getLinkType().equals(Link.LinkType.INTERNAL.toString())) {\n-\t\t\t\t\t\t\tIdentifier id = APILocator.getIdentifierAPI()\n+\t\t\t\t\t\t\tfinal Identifier id = APILocator.getIdentifierAPI()\n \t\t\t\t\t\t\t\t\t.find(link.getInternalLinkIdentifier());\n \n \t\t\t\t\t\t\t// add file/content dependencies. will also work with htmlpages as content\n \t\t\t\t\t\t\tif (InodeUtils.isSet(id.getInode()) && id.getAssetType()\n \t\t\t\t\t\t\t\t\t.equals(\"contentlet\")) {\n-\t\t\t\t\t\t\t\tList<Contentlet> contentList = APILocator.getContentletAPI()\n+\t\t\t\t\t\t\t\tfinal List<Contentlet> contentList = APILocator.getContentletAPI()\n \t\t\t\t\t\t\t\t\t\t.search(\"+identifier:\" + id.getId(), 0, 0, \"moddate\", user,\n \t\t\t\t\t\t\t\t\t\t\t\tfalse);\n \n-\t\t\t\t\t\t\t\tfor (Contentlet contentlet : contentList) {\n+\t\t\t\t\t\t\t\tfor (final Contentlet contentlet : contentList) {\n \t\t\t\t\t\t\t\t\tif(publisherFilter.acceptExcludeDependencyQuery(contentlet.getIdentifier())) {\n \t\t\t\t\t\t\t\t\t\tcontents.addOrClean(contentlet.getIdentifier(),\n \t\t\t\t\t\t\t\t\t\t\t\tcontentlet.getModDate());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU5NzMzOQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424597339", "bodyText": "rename to\nfinal Host host", "author": "jdotcms", "createdAt": "2020-05-13T17:08:37Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -357,35 +370,55 @@ public void setDependencies() throws DotSecurityException, DotDataException, Dot\n \t * <li>Folders</li>\n \t * </ul>\n \t */\n-\tprivate void setLinkDependencies() {\n+\tprivate void setLinkDependencies(final PublisherFilter publisherFilter)  {\n \t\tfor(String linkId : linksSet) {\n \t\t\ttry {\n \t\t\t\tIdentifier ident=APILocator.getIdentifierAPI().find(linkId);\n-\t\t\t\tFolder ff = APILocator.getFolderAPI().findFolderByPath(ident.getParentPath(), ident.getHostId(), user, false);\n-\t\t\t\tfolders.addOrClean( ff.getInode(), ff.getModDate());\n-\t\t\t\tfoldersSet.add(ff.getInode());\n \n-\t\t\t\tHost hh=APILocator.getHostAPI().find(ident.getHostId(), user, false);\n-\t\t\t\thosts.addOrClean( hh.getIdentifier(), hh.getModDate());\n-\t\t\t\thostsSet.add(hh.getIdentifier());\n+\t\t\t\t// Folder Dependencies\n+\t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n+\t\t\t\t\tFolder ff = APILocator.getFolderAPI()\n+\t\t\t\t\t\t\t.findFolderByPath(ident.getParentPath(), ident.getHostId(), user,\n+\t\t\t\t\t\t\t\t\tfalse);\n+\t\t\t\t\tfolders.addOrClean(ff.getInode(), ff.getModDate());\n+\t\t\t\t\tfoldersSet.add(ff.getInode());\n+\t\t\t\t}\n \n-\t\t\t\tLink link = APILocator.getMenuLinkAPI().findWorkingLinkById(linkId, user, false);\n+\t\t\t\t// Host Dependencies\n+\t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\t\tHost hh = APILocator.getHostAPI().find(ident.getHostId(), user, false);", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -377,39 +377,39 @@ public class DependencyManager {\n \n \t\t\t\t// Folder Dependencies\n \t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n-\t\t\t\t\tFolder ff = APILocator.getFolderAPI()\n+\t\t\t\t\tfinal Folder folder = APILocator.getFolderAPI()\n \t\t\t\t\t\t\t.findFolderByPath(ident.getParentPath(), ident.getHostId(), user,\n \t\t\t\t\t\t\t\t\tfalse);\n-\t\t\t\t\tfolders.addOrClean(ff.getInode(), ff.getModDate());\n-\t\t\t\t\tfoldersSet.add(ff.getInode());\n+\t\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n+\t\t\t\t\tfoldersSet.add(folder.getInode());\n \t\t\t\t}\n \n \t\t\t\t// Host Dependencies\n \t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\t\tHost hh = APILocator.getHostAPI().find(ident.getHostId(), user, false);\n-\t\t\t\t\thosts.addOrClean(hh.getIdentifier(), hh.getModDate());\n-\t\t\t\t\thostsSet.add(hh.getIdentifier());\n+\t\t\t\t\tfinal Host host = APILocator.getHostAPI().find(ident.getHostId(), user, false);\n+\t\t\t\t\thosts.addOrClean(host.getIdentifier(), host.getModDate());\n+\t\t\t\t\thostsSet.add(host.getIdentifier());\n \t\t\t\t}\n \n \t\t\t\t// Content Dependencies\n \t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType())) {\n-\t\t\t\t\tLink link = APILocator.getMenuLinkAPI()\n+\t\t\t\t\tfinal Link link = APILocator.getMenuLinkAPI()\n \t\t\t\t\t\t\t.findWorkingLinkById(linkId, user, false);\n \n \t\t\t\t\tif (link != null) {\n \n \t\t\t\t\t\tif (link.getLinkType().equals(Link.LinkType.INTERNAL.toString())) {\n-\t\t\t\t\t\t\tIdentifier id = APILocator.getIdentifierAPI()\n+\t\t\t\t\t\t\tfinal Identifier id = APILocator.getIdentifierAPI()\n \t\t\t\t\t\t\t\t\t.find(link.getInternalLinkIdentifier());\n \n \t\t\t\t\t\t\t// add file/content dependencies. will also work with htmlpages as content\n \t\t\t\t\t\t\tif (InodeUtils.isSet(id.getInode()) && id.getAssetType()\n \t\t\t\t\t\t\t\t\t.equals(\"contentlet\")) {\n-\t\t\t\t\t\t\t\tList<Contentlet> contentList = APILocator.getContentletAPI()\n+\t\t\t\t\t\t\t\tfinal List<Contentlet> contentList = APILocator.getContentletAPI()\n \t\t\t\t\t\t\t\t\t\t.search(\"+identifier:\" + id.getId(), 0, 0, \"moddate\", user,\n \t\t\t\t\t\t\t\t\t\t\t\tfalse);\n \n-\t\t\t\t\t\t\t\tfor (Contentlet contentlet : contentList) {\n+\t\t\t\t\t\t\t\tfor (final Contentlet contentlet : contentList) {\n \t\t\t\t\t\t\t\t\tif(publisherFilter.acceptExcludeDependencyQuery(contentlet.getIdentifier())) {\n \t\t\t\t\t\t\t\t\t\tcontents.addOrClean(contentlet.getIdentifier(),\n \t\t\t\t\t\t\t\t\t\t\t\tcontentlet.getModDate());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU5ODA4Mw==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424598083", "bodyText": "set to final", "author": "jdotcms", "createdAt": "2020-05-13T17:09:55Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -357,35 +370,55 @@ public void setDependencies() throws DotSecurityException, DotDataException, Dot\n \t * <li>Folders</li>\n \t * </ul>\n \t */\n-\tprivate void setLinkDependencies() {\n+\tprivate void setLinkDependencies(final PublisherFilter publisherFilter)  {\n \t\tfor(String linkId : linksSet) {\n \t\t\ttry {\n \t\t\t\tIdentifier ident=APILocator.getIdentifierAPI().find(linkId);\n-\t\t\t\tFolder ff = APILocator.getFolderAPI().findFolderByPath(ident.getParentPath(), ident.getHostId(), user, false);\n-\t\t\t\tfolders.addOrClean( ff.getInode(), ff.getModDate());\n-\t\t\t\tfoldersSet.add(ff.getInode());\n \n-\t\t\t\tHost hh=APILocator.getHostAPI().find(ident.getHostId(), user, false);\n-\t\t\t\thosts.addOrClean( hh.getIdentifier(), hh.getModDate());\n-\t\t\t\thostsSet.add(hh.getIdentifier());\n+\t\t\t\t// Folder Dependencies\n+\t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n+\t\t\t\t\tFolder ff = APILocator.getFolderAPI()\n+\t\t\t\t\t\t\t.findFolderByPath(ident.getParentPath(), ident.getHostId(), user,\n+\t\t\t\t\t\t\t\t\tfalse);\n+\t\t\t\t\tfolders.addOrClean(ff.getInode(), ff.getModDate());\n+\t\t\t\t\tfoldersSet.add(ff.getInode());\n+\t\t\t\t}\n \n-\t\t\t\tLink link = APILocator.getMenuLinkAPI().findWorkingLinkById(linkId, user, false);\n+\t\t\t\t// Host Dependencies\n+\t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\t\tHost hh = APILocator.getHostAPI().find(ident.getHostId(), user, false);\n+\t\t\t\t\thosts.addOrClean(hh.getIdentifier(), hh.getModDate());\n+\t\t\t\t\thostsSet.add(hh.getIdentifier());\n+\t\t\t\t}\n \n-\t\t\t\tif(link!=null) {\n+\t\t\t\t// Content Dependencies\n+\t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType())) {\n+\t\t\t\t\tLink link = APILocator.getMenuLinkAPI()\n+\t\t\t\t\t\t\t.findWorkingLinkById(linkId, user, false);\n \n-\t\t\t\t\tif(link.getLinkType().equals(Link.LinkType.INTERNAL.toString())) {\n-\t\t\t\t\t\tIdentifier id = APILocator.getIdentifierAPI().find(link.getInternalLinkIdentifier());\n+\t\t\t\t\tif (link != null) {\n \n-\t\t\t\t\t\t// add file/content dependencies. will also work with htmlpages as content\n-\t\t\t\t\t\tif (InodeUtils.isSet(id.getInode()) && id.getAssetType().equals(\"contentlet\")) {\n-\t\t\t\t\t\t\tList<Contentlet> contentList = APILocator.getContentletAPI().search(\"+identifier:\"+id.getId(), 0, 0, \"moddate\", user, false);\n+\t\t\t\t\t\tif (link.getLinkType().equals(Link.LinkType.INTERNAL.toString())) {\n+\t\t\t\t\t\t\tIdentifier id = APILocator.getIdentifierAPI()\n+\t\t\t\t\t\t\t\t\t.find(link.getInternalLinkIdentifier());\n \n-\t\t\t\t\t\t\tfor (Contentlet contentlet : contentList) {\n-\t\t\t\t\t\t\t\tcontents.addOrClean(contentlet.getIdentifier(), contentlet.getModDate());\n-\t\t\t\t\t\t\t\tcontentsSet.add(contentlet.getIdentifier());\n-\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t// add file/content dependencies. will also work with htmlpages as content\n+\t\t\t\t\t\t\tif (InodeUtils.isSet(id.getInode()) && id.getAssetType()\n+\t\t\t\t\t\t\t\t\t.equals(\"contentlet\")) {\n+\t\t\t\t\t\t\t\tList<Contentlet> contentList = APILocator.getContentletAPI()\n+\t\t\t\t\t\t\t\t\t\t.search(\"+identifier:\" + id.getId(), 0, 0, \"moddate\", user,\n+\t\t\t\t\t\t\t\t\t\t\t\tfalse);\n+\n+\t\t\t\t\t\t\t\tfor (Contentlet contentlet : contentList) {", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -377,39 +377,39 @@ public class DependencyManager {\n \n \t\t\t\t// Folder Dependencies\n \t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n-\t\t\t\t\tFolder ff = APILocator.getFolderAPI()\n+\t\t\t\t\tfinal Folder folder = APILocator.getFolderAPI()\n \t\t\t\t\t\t\t.findFolderByPath(ident.getParentPath(), ident.getHostId(), user,\n \t\t\t\t\t\t\t\t\tfalse);\n-\t\t\t\t\tfolders.addOrClean(ff.getInode(), ff.getModDate());\n-\t\t\t\t\tfoldersSet.add(ff.getInode());\n+\t\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n+\t\t\t\t\tfoldersSet.add(folder.getInode());\n \t\t\t\t}\n \n \t\t\t\t// Host Dependencies\n \t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\t\tHost hh = APILocator.getHostAPI().find(ident.getHostId(), user, false);\n-\t\t\t\t\thosts.addOrClean(hh.getIdentifier(), hh.getModDate());\n-\t\t\t\t\thostsSet.add(hh.getIdentifier());\n+\t\t\t\t\tfinal Host host = APILocator.getHostAPI().find(ident.getHostId(), user, false);\n+\t\t\t\t\thosts.addOrClean(host.getIdentifier(), host.getModDate());\n+\t\t\t\t\thostsSet.add(host.getIdentifier());\n \t\t\t\t}\n \n \t\t\t\t// Content Dependencies\n \t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType())) {\n-\t\t\t\t\tLink link = APILocator.getMenuLinkAPI()\n+\t\t\t\t\tfinal Link link = APILocator.getMenuLinkAPI()\n \t\t\t\t\t\t\t.findWorkingLinkById(linkId, user, false);\n \n \t\t\t\t\tif (link != null) {\n \n \t\t\t\t\t\tif (link.getLinkType().equals(Link.LinkType.INTERNAL.toString())) {\n-\t\t\t\t\t\t\tIdentifier id = APILocator.getIdentifierAPI()\n+\t\t\t\t\t\t\tfinal Identifier id = APILocator.getIdentifierAPI()\n \t\t\t\t\t\t\t\t\t.find(link.getInternalLinkIdentifier());\n \n \t\t\t\t\t\t\t// add file/content dependencies. will also work with htmlpages as content\n \t\t\t\t\t\t\tif (InodeUtils.isSet(id.getInode()) && id.getAssetType()\n \t\t\t\t\t\t\t\t\t.equals(\"contentlet\")) {\n-\t\t\t\t\t\t\t\tList<Contentlet> contentList = APILocator.getContentletAPI()\n+\t\t\t\t\t\t\t\tfinal List<Contentlet> contentList = APILocator.getContentletAPI()\n \t\t\t\t\t\t\t\t\t\t.search(\"+identifier:\" + id.getId(), 0, 0, \"moddate\", user,\n \t\t\t\t\t\t\t\t\t\t\t\tfalse);\n \n-\t\t\t\t\t\t\t\tfor (Contentlet contentlet : contentList) {\n+\t\t\t\t\t\t\t\tfor (final Contentlet contentlet : contentList) {\n \t\t\t\t\t\t\t\t\tif(publisherFilter.acceptExcludeDependencyQuery(contentlet.getIdentifier())) {\n \t\t\t\t\t\t\t\t\t\tcontents.addOrClean(contentlet.getIdentifier(),\n \t\t\t\t\t\t\t\t\t\t\t\tcontentlet.getModDate());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU5ODMwNw==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424598307", "bodyText": "set to final", "author": "jdotcms", "createdAt": "2020-05-13T17:10:14Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -408,58 +441,79 @@ private void setLinkDependencies() {\n \t * <li>Rules.</li>\n \t * </ul>\n \t */\n-\tprivate void setHostDependencies () {\n+\tprivate void setHostDependencies (final PublisherFilter publisherFilter) {\n \t\ttry {\n \t\t\tfor (String id : hostsSet) {\n \t\t\t\tfinal Host h = APILocator.getHostAPI().find(id, user, false);\n \n \t\t\t\t// Template dependencies\n-\t\t\t\tfinal List<Template> templateList = APILocator.getTemplateAPI().findTemplatesAssignedTo(h);\n-\t\t\t\tfor (Template template : templateList) {\n-\t\t\t\t\ttemplates.addOrClean( template.getIdentifier(), template.getModDate());\n-\t\t\t\t\ttemplatesSet.add(template.getIdentifier());\n+\t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.TEMPLATE.getType())) {\n+\t\t\t\t\tfinal List<Template> templateList = APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.findTemplatesAssignedTo(h);\n+\t\t\t\t\tfor (Template template : templateList) {", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -443,14 +443,14 @@ public class DependencyManager {\n \t */\n \tprivate void setHostDependencies (final PublisherFilter publisherFilter) {\n \t\ttry {\n-\t\t\tfor (String id : hostsSet) {\n-\t\t\t\tfinal Host h = APILocator.getHostAPI().find(id, user, false);\n+\t\t\tfor (final String hostId : hostsSet) {\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(hostId, user, false);\n \n \t\t\t\t// Template dependencies\n \t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.TEMPLATE.getType())) {\n \t\t\t\t\tfinal List<Template> templateList = APILocator.getTemplateAPI()\n-\t\t\t\t\t\t\t.findTemplatesAssignedTo(h);\n-\t\t\t\t\tfor (Template template : templateList) {\n+\t\t\t\t\t\t\t.findTemplatesAssignedTo(host);\n+\t\t\t\t\tfor (final Template template : templateList) {\n \t\t\t\t\t\ttemplates.addOrClean(template.getIdentifier(), template.getModDate());\n \t\t\t\t\t\ttemplatesSet.add(template.getIdentifier());\n \t\t\t\t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU5ODQ3MQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424598471", "bodyText": "rename to host", "author": "jdotcms", "createdAt": "2020-05-13T17:10:31Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -408,58 +441,79 @@ private void setLinkDependencies() {\n \t * <li>Rules.</li>\n \t * </ul>\n \t */\n-\tprivate void setHostDependencies () {\n+\tprivate void setHostDependencies (final PublisherFilter publisherFilter) {\n \t\ttry {\n \t\t\tfor (String id : hostsSet) {\n \t\t\t\tfinal Host h = APILocator.getHostAPI().find(id, user, false);", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -443,14 +443,14 @@ public class DependencyManager {\n \t */\n \tprivate void setHostDependencies (final PublisherFilter publisherFilter) {\n \t\ttry {\n-\t\t\tfor (String id : hostsSet) {\n-\t\t\t\tfinal Host h = APILocator.getHostAPI().find(id, user, false);\n+\t\t\tfor (final String hostId : hostsSet) {\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(hostId, user, false);\n \n \t\t\t\t// Template dependencies\n \t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.TEMPLATE.getType())) {\n \t\t\t\t\tfinal List<Template> templateList = APILocator.getTemplateAPI()\n-\t\t\t\t\t\t\t.findTemplatesAssignedTo(h);\n-\t\t\t\t\tfor (Template template : templateList) {\n+\t\t\t\t\t\t\t.findTemplatesAssignedTo(host);\n+\t\t\t\t\tfor (final Template template : templateList) {\n \t\t\t\t\t\ttemplates.addOrClean(template.getIdentifier(), template.getModDate());\n \t\t\t\t\t\ttemplatesSet.add(template.getIdentifier());\n \t\t\t\t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwMzAwNQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424603005", "bodyText": "set to final", "author": "jdotcms", "createdAt": "2020-05-13T17:18:10Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -408,58 +441,79 @@ private void setLinkDependencies() {\n \t * <li>Rules.</li>\n \t * </ul>\n \t */\n-\tprivate void setHostDependencies () {\n+\tprivate void setHostDependencies (final PublisherFilter publisherFilter) {\n \t\ttry {\n \t\t\tfor (String id : hostsSet) {\n \t\t\t\tfinal Host h = APILocator.getHostAPI().find(id, user, false);\n \n \t\t\t\t// Template dependencies\n-\t\t\t\tfinal List<Template> templateList = APILocator.getTemplateAPI().findTemplatesAssignedTo(h);\n-\t\t\t\tfor (Template template : templateList) {\n-\t\t\t\t\ttemplates.addOrClean( template.getIdentifier(), template.getModDate());\n-\t\t\t\t\ttemplatesSet.add(template.getIdentifier());\n+\t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.TEMPLATE.getType())) {\n+\t\t\t\t\tfinal List<Template> templateList = APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.findTemplatesAssignedTo(h);\n+\t\t\t\t\tfor (Template template : templateList) {\n+\t\t\t\t\t\ttemplates.addOrClean(template.getIdentifier(), template.getModDate());\n+\t\t\t\t\t\ttemplatesSet.add(template.getIdentifier());\n+\t\t\t\t\t}\n \t\t\t\t}\n \n \t\t\t\t// Container dependencies\n-\t\t\t\tfinal List<Container> containerList = APILocator.getContainerAPI().findContainersUnder(h);\n-\t\t\t\tfor (Container container : containerList) {\n-\n-\t\t\t\t\tif (container instanceof FileAssetContainer) {\n-\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\tcontainers.addOrClean(container.getIdentifier(), container.getModDate());\n-\t\t\t\t\t\tcontainersSet.add(container.getIdentifier());\n+\t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTAINER.getType())) {\n+\t\t\t\t\tfinal List<Container> containerList = APILocator.getContainerAPI()\n+\t\t\t\t\t\t\t.findContainersUnder(h);\n+\t\t\t\t\tfor (Container container : containerList) {", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -443,14 +443,14 @@ public class DependencyManager {\n \t */\n \tprivate void setHostDependencies (final PublisherFilter publisherFilter) {\n \t\ttry {\n-\t\t\tfor (String id : hostsSet) {\n-\t\t\t\tfinal Host h = APILocator.getHostAPI().find(id, user, false);\n+\t\t\tfor (final String hostId : hostsSet) {\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(hostId, user, false);\n \n \t\t\t\t// Template dependencies\n \t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.TEMPLATE.getType())) {\n \t\t\t\t\tfinal List<Template> templateList = APILocator.getTemplateAPI()\n-\t\t\t\t\t\t\t.findTemplatesAssignedTo(h);\n-\t\t\t\t\tfor (Template template : templateList) {\n+\t\t\t\t\t\t\t.findTemplatesAssignedTo(host);\n+\t\t\t\t\tfor (final Template template : templateList) {\n \t\t\t\t\t\ttemplates.addOrClean(template.getIdentifier(), template.getModDate());\n \t\t\t\t\t\ttemplatesSet.add(template.getIdentifier());\n \t\t\t\t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwMzIzMQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424603231", "bodyText": "set to final", "author": "jdotcms", "createdAt": "2020-05-13T17:18:30Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -408,58 +441,79 @@ private void setLinkDependencies() {\n \t * <li>Rules.</li>\n \t * </ul>\n \t */\n-\tprivate void setHostDependencies () {\n+\tprivate void setHostDependencies (final PublisherFilter publisherFilter) {\n \t\ttry {\n \t\t\tfor (String id : hostsSet) {\n \t\t\t\tfinal Host h = APILocator.getHostAPI().find(id, user, false);\n \n \t\t\t\t// Template dependencies\n-\t\t\t\tfinal List<Template> templateList = APILocator.getTemplateAPI().findTemplatesAssignedTo(h);\n-\t\t\t\tfor (Template template : templateList) {\n-\t\t\t\t\ttemplates.addOrClean( template.getIdentifier(), template.getModDate());\n-\t\t\t\t\ttemplatesSet.add(template.getIdentifier());\n+\t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.TEMPLATE.getType())) {\n+\t\t\t\t\tfinal List<Template> templateList = APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.findTemplatesAssignedTo(h);\n+\t\t\t\t\tfor (Template template : templateList) {\n+\t\t\t\t\t\ttemplates.addOrClean(template.getIdentifier(), template.getModDate());\n+\t\t\t\t\t\ttemplatesSet.add(template.getIdentifier());\n+\t\t\t\t\t}\n \t\t\t\t}\n \n \t\t\t\t// Container dependencies\n-\t\t\t\tfinal List<Container> containerList = APILocator.getContainerAPI().findContainersUnder(h);\n-\t\t\t\tfor (Container container : containerList) {\n-\n-\t\t\t\t\tif (container instanceof FileAssetContainer) {\n-\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\tcontainers.addOrClean(container.getIdentifier(), container.getModDate());\n-\t\t\t\t\t\tcontainersSet.add(container.getIdentifier());\n+\t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTAINER.getType())) {\n+\t\t\t\t\tfinal List<Container> containerList = APILocator.getContainerAPI()\n+\t\t\t\t\t\t\t.findContainersUnder(h);\n+\t\t\t\t\tfor (Container container : containerList) {\n+\n+\t\t\t\t\t\tif (container instanceof FileAssetContainer) {\n+\t\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n+\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\tcontainers\n+\t\t\t\t\t\t\t\t\t.addOrClean(container.getIdentifier(), container.getModDate());\n+\t\t\t\t\t\t\tcontainersSet.add(container.getIdentifier());\n+\t\t\t\t\t\t}\n \t\t\t\t\t}\n \t\t\t\t}\n \n \t\t\t\t// Content dependencies\n-\t\t\t\tString luceneQuery = \"+conHost:\" + h.getIdentifier();\n-\n-\t\t\t\tfinal List<Contentlet> contentList = APILocator.getContentletAPI().search(luceneQuery, 0, 0, null, user, false);\n-\t\t\t\tfor (Contentlet contentlet : contentList) {\n-\t\t\t\t\tcontents.addOrClean( contentlet.getIdentifier(), contentlet.getModDate());\n-\t\t\t\t\tcontentsSet.add(contentlet.getIdentifier());\n+\t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType())) {\n+\t\t\t\t\tString luceneQuery = \"+conHost:\" + h.getIdentifier();", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -443,14 +443,14 @@ public class DependencyManager {\n \t */\n \tprivate void setHostDependencies (final PublisherFilter publisherFilter) {\n \t\ttry {\n-\t\t\tfor (String id : hostsSet) {\n-\t\t\t\tfinal Host h = APILocator.getHostAPI().find(id, user, false);\n+\t\t\tfor (final String hostId : hostsSet) {\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(hostId, user, false);\n \n \t\t\t\t// Template dependencies\n \t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.TEMPLATE.getType())) {\n \t\t\t\t\tfinal List<Template> templateList = APILocator.getTemplateAPI()\n-\t\t\t\t\t\t\t.findTemplatesAssignedTo(h);\n-\t\t\t\t\tfor (Template template : templateList) {\n+\t\t\t\t\t\t\t.findTemplatesAssignedTo(host);\n+\t\t\t\t\tfor (final Template template : templateList) {\n \t\t\t\t\t\ttemplates.addOrClean(template.getIdentifier(), template.getModDate());\n \t\t\t\t\t\ttemplatesSet.add(template.getIdentifier());\n \t\t\t\t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwMzM2MA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424603360", "bodyText": "set to final", "author": "jdotcms", "createdAt": "2020-05-13T17:18:41Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -408,58 +441,79 @@ private void setLinkDependencies() {\n \t * <li>Rules.</li>\n \t * </ul>\n \t */\n-\tprivate void setHostDependencies () {\n+\tprivate void setHostDependencies (final PublisherFilter publisherFilter) {\n \t\ttry {\n \t\t\tfor (String id : hostsSet) {\n \t\t\t\tfinal Host h = APILocator.getHostAPI().find(id, user, false);\n \n \t\t\t\t// Template dependencies\n-\t\t\t\tfinal List<Template> templateList = APILocator.getTemplateAPI().findTemplatesAssignedTo(h);\n-\t\t\t\tfor (Template template : templateList) {\n-\t\t\t\t\ttemplates.addOrClean( template.getIdentifier(), template.getModDate());\n-\t\t\t\t\ttemplatesSet.add(template.getIdentifier());\n+\t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.TEMPLATE.getType())) {\n+\t\t\t\t\tfinal List<Template> templateList = APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.findTemplatesAssignedTo(h);\n+\t\t\t\t\tfor (Template template : templateList) {\n+\t\t\t\t\t\ttemplates.addOrClean(template.getIdentifier(), template.getModDate());\n+\t\t\t\t\t\ttemplatesSet.add(template.getIdentifier());\n+\t\t\t\t\t}\n \t\t\t\t}\n \n \t\t\t\t// Container dependencies\n-\t\t\t\tfinal List<Container> containerList = APILocator.getContainerAPI().findContainersUnder(h);\n-\t\t\t\tfor (Container container : containerList) {\n-\n-\t\t\t\t\tif (container instanceof FileAssetContainer) {\n-\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\tcontainers.addOrClean(container.getIdentifier(), container.getModDate());\n-\t\t\t\t\t\tcontainersSet.add(container.getIdentifier());\n+\t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTAINER.getType())) {\n+\t\t\t\t\tfinal List<Container> containerList = APILocator.getContainerAPI()\n+\t\t\t\t\t\t\t.findContainersUnder(h);\n+\t\t\t\t\tfor (Container container : containerList) {\n+\n+\t\t\t\t\t\tif (container instanceof FileAssetContainer) {\n+\t\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n+\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\tcontainers\n+\t\t\t\t\t\t\t\t\t.addOrClean(container.getIdentifier(), container.getModDate());\n+\t\t\t\t\t\t\tcontainersSet.add(container.getIdentifier());\n+\t\t\t\t\t\t}\n \t\t\t\t\t}\n \t\t\t\t}\n \n \t\t\t\t// Content dependencies\n-\t\t\t\tString luceneQuery = \"+conHost:\" + h.getIdentifier();\n-\n-\t\t\t\tfinal List<Contentlet> contentList = APILocator.getContentletAPI().search(luceneQuery, 0, 0, null, user, false);\n-\t\t\t\tfor (Contentlet contentlet : contentList) {\n-\t\t\t\t\tcontents.addOrClean( contentlet.getIdentifier(), contentlet.getModDate());\n-\t\t\t\t\tcontentsSet.add(contentlet.getIdentifier());\n+\t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType())) {\n+\t\t\t\t\tString luceneQuery = \"+conHost:\" + h.getIdentifier();\n+\t\t\t\t\tfinal List<Contentlet> contentList = APILocator.getContentletAPI()\n+\t\t\t\t\t\t\t.search(luceneQuery, 0, 0, null, user, false);\n+\t\t\t\t\tfor (Contentlet contentlet : contentList) {", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -443,14 +443,14 @@ public class DependencyManager {\n \t */\n \tprivate void setHostDependencies (final PublisherFilter publisherFilter) {\n \t\ttry {\n-\t\t\tfor (String id : hostsSet) {\n-\t\t\t\tfinal Host h = APILocator.getHostAPI().find(id, user, false);\n+\t\t\tfor (final String hostId : hostsSet) {\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(hostId, user, false);\n \n \t\t\t\t// Template dependencies\n \t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.TEMPLATE.getType())) {\n \t\t\t\t\tfinal List<Template> templateList = APILocator.getTemplateAPI()\n-\t\t\t\t\t\t\t.findTemplatesAssignedTo(h);\n-\t\t\t\t\tfor (Template template : templateList) {\n+\t\t\t\t\t\t\t.findTemplatesAssignedTo(host);\n+\t\t\t\t\tfor (final Template template : templateList) {\n \t\t\t\t\t\ttemplates.addOrClean(template.getIdentifier(), template.getModDate());\n \t\t\t\t\t\ttemplatesSet.add(template.getIdentifier());\n \t\t\t\t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwMzUxNA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424603514", "bodyText": "set to final", "author": "jdotcms", "createdAt": "2020-05-13T17:18:58Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -408,58 +441,79 @@ private void setLinkDependencies() {\n \t * <li>Rules.</li>\n \t * </ul>\n \t */\n-\tprivate void setHostDependencies () {\n+\tprivate void setHostDependencies (final PublisherFilter publisherFilter) {\n \t\ttry {\n \t\t\tfor (String id : hostsSet) {\n \t\t\t\tfinal Host h = APILocator.getHostAPI().find(id, user, false);\n \n \t\t\t\t// Template dependencies\n-\t\t\t\tfinal List<Template> templateList = APILocator.getTemplateAPI().findTemplatesAssignedTo(h);\n-\t\t\t\tfor (Template template : templateList) {\n-\t\t\t\t\ttemplates.addOrClean( template.getIdentifier(), template.getModDate());\n-\t\t\t\t\ttemplatesSet.add(template.getIdentifier());\n+\t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.TEMPLATE.getType())) {\n+\t\t\t\t\tfinal List<Template> templateList = APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.findTemplatesAssignedTo(h);\n+\t\t\t\t\tfor (Template template : templateList) {\n+\t\t\t\t\t\ttemplates.addOrClean(template.getIdentifier(), template.getModDate());\n+\t\t\t\t\t\ttemplatesSet.add(template.getIdentifier());\n+\t\t\t\t\t}\n \t\t\t\t}\n \n \t\t\t\t// Container dependencies\n-\t\t\t\tfinal List<Container> containerList = APILocator.getContainerAPI().findContainersUnder(h);\n-\t\t\t\tfor (Container container : containerList) {\n-\n-\t\t\t\t\tif (container instanceof FileAssetContainer) {\n-\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\tcontainers.addOrClean(container.getIdentifier(), container.getModDate());\n-\t\t\t\t\t\tcontainersSet.add(container.getIdentifier());\n+\t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTAINER.getType())) {\n+\t\t\t\t\tfinal List<Container> containerList = APILocator.getContainerAPI()\n+\t\t\t\t\t\t\t.findContainersUnder(h);\n+\t\t\t\t\tfor (Container container : containerList) {\n+\n+\t\t\t\t\t\tif (container instanceof FileAssetContainer) {\n+\t\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n+\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\tcontainers\n+\t\t\t\t\t\t\t\t\t.addOrClean(container.getIdentifier(), container.getModDate());\n+\t\t\t\t\t\t\tcontainersSet.add(container.getIdentifier());\n+\t\t\t\t\t\t}\n \t\t\t\t\t}\n \t\t\t\t}\n \n \t\t\t\t// Content dependencies\n-\t\t\t\tString luceneQuery = \"+conHost:\" + h.getIdentifier();\n-\n-\t\t\t\tfinal List<Contentlet> contentList = APILocator.getContentletAPI().search(luceneQuery, 0, 0, null, user, false);\n-\t\t\t\tfor (Contentlet contentlet : contentList) {\n-\t\t\t\t\tcontents.addOrClean( contentlet.getIdentifier(), contentlet.getModDate());\n-\t\t\t\t\tcontentsSet.add(contentlet.getIdentifier());\n+\t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType())) {\n+\t\t\t\t\tString luceneQuery = \"+conHost:\" + h.getIdentifier();\n+\t\t\t\t\tfinal List<Contentlet> contentList = APILocator.getContentletAPI()\n+\t\t\t\t\t\t\t.search(luceneQuery, 0, 0, null, user, false);\n+\t\t\t\t\tfor (Contentlet contentlet : contentList) {\n+\t\t\t\t\t\tif(publisherFilter.acceptExcludeDependencyQuery(contentlet.getIdentifier())) {\n+\t\t\t\t\t\t\tcontents.addOrClean(contentlet.getIdentifier(),\n+\t\t\t\t\t\t\t\t\tcontentlet.getModDate());\n+\t\t\t\t\t\t\tcontentsSet.add(contentlet.getIdentifier());\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n \t\t\t\t}\n \n \t\t\t\t// Structure dependencies\n-\t\t\t\tfinal List<Structure> structuresList = StructureFactory.getStructuresUnderHost(h, user, false);\n-\t\t\t\tfor (Structure structure : structuresList) {\n-\t\t\t\t\tstructures.addOrClean( structure.getInode(), structure.getModDate());\n-\t\t\t\t\tstructuresSet.add(structure.getInode());\n+\t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENT_TYPE.getType())) {\n+\t\t\t\t\tfinal List<Structure> structuresList = StructureFactory\n+\t\t\t\t\t\t\t.getStructuresUnderHost(h, user, false);\n+\t\t\t\t\tfor (Structure structure : structuresList) {", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -443,14 +443,14 @@ public class DependencyManager {\n \t */\n \tprivate void setHostDependencies (final PublisherFilter publisherFilter) {\n \t\ttry {\n-\t\t\tfor (String id : hostsSet) {\n-\t\t\t\tfinal Host h = APILocator.getHostAPI().find(id, user, false);\n+\t\t\tfor (final String hostId : hostsSet) {\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(hostId, user, false);\n \n \t\t\t\t// Template dependencies\n \t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.TEMPLATE.getType())) {\n \t\t\t\t\tfinal List<Template> templateList = APILocator.getTemplateAPI()\n-\t\t\t\t\t\t\t.findTemplatesAssignedTo(h);\n-\t\t\t\t\tfor (Template template : templateList) {\n+\t\t\t\t\t\t\t.findTemplatesAssignedTo(host);\n+\t\t\t\t\tfor (final Template template : templateList) {\n \t\t\t\t\t\ttemplates.addOrClean(template.getIdentifier(), template.getModDate());\n \t\t\t\t\t\ttemplatesSet.add(template.getIdentifier());\n \t\t\t\t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwMzY3Mw==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424603673", "bodyText": "set to final", "author": "jdotcms", "createdAt": "2020-05-13T17:19:15Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -408,58 +441,79 @@ private void setLinkDependencies() {\n \t * <li>Rules.</li>\n \t * </ul>\n \t */\n-\tprivate void setHostDependencies () {\n+\tprivate void setHostDependencies (final PublisherFilter publisherFilter) {\n \t\ttry {\n \t\t\tfor (String id : hostsSet) {\n \t\t\t\tfinal Host h = APILocator.getHostAPI().find(id, user, false);\n \n \t\t\t\t// Template dependencies\n-\t\t\t\tfinal List<Template> templateList = APILocator.getTemplateAPI().findTemplatesAssignedTo(h);\n-\t\t\t\tfor (Template template : templateList) {\n-\t\t\t\t\ttemplates.addOrClean( template.getIdentifier(), template.getModDate());\n-\t\t\t\t\ttemplatesSet.add(template.getIdentifier());\n+\t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.TEMPLATE.getType())) {\n+\t\t\t\t\tfinal List<Template> templateList = APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.findTemplatesAssignedTo(h);\n+\t\t\t\t\tfor (Template template : templateList) {\n+\t\t\t\t\t\ttemplates.addOrClean(template.getIdentifier(), template.getModDate());\n+\t\t\t\t\t\ttemplatesSet.add(template.getIdentifier());\n+\t\t\t\t\t}\n \t\t\t\t}\n \n \t\t\t\t// Container dependencies\n-\t\t\t\tfinal List<Container> containerList = APILocator.getContainerAPI().findContainersUnder(h);\n-\t\t\t\tfor (Container container : containerList) {\n-\n-\t\t\t\t\tif (container instanceof FileAssetContainer) {\n-\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\tcontainers.addOrClean(container.getIdentifier(), container.getModDate());\n-\t\t\t\t\t\tcontainersSet.add(container.getIdentifier());\n+\t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTAINER.getType())) {\n+\t\t\t\t\tfinal List<Container> containerList = APILocator.getContainerAPI()\n+\t\t\t\t\t\t\t.findContainersUnder(h);\n+\t\t\t\t\tfor (Container container : containerList) {\n+\n+\t\t\t\t\t\tif (container instanceof FileAssetContainer) {\n+\t\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n+\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\tcontainers\n+\t\t\t\t\t\t\t\t\t.addOrClean(container.getIdentifier(), container.getModDate());\n+\t\t\t\t\t\t\tcontainersSet.add(container.getIdentifier());\n+\t\t\t\t\t\t}\n \t\t\t\t\t}\n \t\t\t\t}\n \n \t\t\t\t// Content dependencies\n-\t\t\t\tString luceneQuery = \"+conHost:\" + h.getIdentifier();\n-\n-\t\t\t\tfinal List<Contentlet> contentList = APILocator.getContentletAPI().search(luceneQuery, 0, 0, null, user, false);\n-\t\t\t\tfor (Contentlet contentlet : contentList) {\n-\t\t\t\t\tcontents.addOrClean( contentlet.getIdentifier(), contentlet.getModDate());\n-\t\t\t\t\tcontentsSet.add(contentlet.getIdentifier());\n+\t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType())) {\n+\t\t\t\t\tString luceneQuery = \"+conHost:\" + h.getIdentifier();\n+\t\t\t\t\tfinal List<Contentlet> contentList = APILocator.getContentletAPI()\n+\t\t\t\t\t\t\t.search(luceneQuery, 0, 0, null, user, false);\n+\t\t\t\t\tfor (Contentlet contentlet : contentList) {\n+\t\t\t\t\t\tif(publisherFilter.acceptExcludeDependencyQuery(contentlet.getIdentifier())) {\n+\t\t\t\t\t\t\tcontents.addOrClean(contentlet.getIdentifier(),\n+\t\t\t\t\t\t\t\t\tcontentlet.getModDate());\n+\t\t\t\t\t\t\tcontentsSet.add(contentlet.getIdentifier());\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n \t\t\t\t}\n \n \t\t\t\t// Structure dependencies\n-\t\t\t\tfinal List<Structure> structuresList = StructureFactory.getStructuresUnderHost(h, user, false);\n-\t\t\t\tfor (Structure structure : structuresList) {\n-\t\t\t\t\tstructures.addOrClean( structure.getInode(), structure.getModDate());\n-\t\t\t\t\tstructuresSet.add(structure.getInode());\n+\t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENT_TYPE.getType())) {\n+\t\t\t\t\tfinal List<Structure> structuresList = StructureFactory\n+\t\t\t\t\t\t\t.getStructuresUnderHost(h, user, false);\n+\t\t\t\t\tfor (Structure structure : structuresList) {\n+\t\t\t\t\t\tcontentTypes.addOrClean(structure.getInode(), structure.getModDate());\n+\t\t\t\t\t\tcontentTypesSet.add(structure.getInode());\n+\t\t\t\t\t}\n \t\t\t\t}\n \n \t\t\t\t// Folder dependencies\n-\t\t\t\tfinal List<Folder> folderList = APILocator.getFolderAPI().findFoldersByHost(h, user, false);\n-\t\t\t\tfor (Folder folder : folderList) {\n-\t\t\t\t\tfolders.addOrClean( folder.getInode(), folder.getModDate());\n-\t\t\t\t\tfoldersSet.add(folder.getInode());\n+\t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n+\t\t\t\t\tfinal List<Folder> folderList = APILocator.getFolderAPI()\n+\t\t\t\t\t\t\t.findFoldersByHost(h, user, false);\n+\t\t\t\t\tfor (Folder folder : folderList) {", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -443,14 +443,14 @@ public class DependencyManager {\n \t */\n \tprivate void setHostDependencies (final PublisherFilter publisherFilter) {\n \t\ttry {\n-\t\t\tfor (String id : hostsSet) {\n-\t\t\t\tfinal Host h = APILocator.getHostAPI().find(id, user, false);\n+\t\t\tfor (final String hostId : hostsSet) {\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(hostId, user, false);\n \n \t\t\t\t// Template dependencies\n \t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.TEMPLATE.getType())) {\n \t\t\t\t\tfinal List<Template> templateList = APILocator.getTemplateAPI()\n-\t\t\t\t\t\t\t.findTemplatesAssignedTo(h);\n-\t\t\t\t\tfor (Template template : templateList) {\n+\t\t\t\t\t\t\t.findTemplatesAssignedTo(host);\n+\t\t\t\t\tfor (final Template template : templateList) {\n \t\t\t\t\t\ttemplates.addOrClean(template.getIdentifier(), template.getModDate());\n \t\t\t\t\t\ttemplatesSet.add(template.getIdentifier());\n \t\t\t\t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwMzc3Mw==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424603773", "bodyText": "rename h to host", "author": "jdotcms", "createdAt": "2020-05-13T17:19:24Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -408,58 +441,79 @@ private void setLinkDependencies() {\n \t * <li>Rules.</li>\n \t * </ul>\n \t */\n-\tprivate void setHostDependencies () {\n+\tprivate void setHostDependencies (final PublisherFilter publisherFilter) {\n \t\ttry {\n \t\t\tfor (String id : hostsSet) {\n \t\t\t\tfinal Host h = APILocator.getHostAPI().find(id, user, false);\n \n \t\t\t\t// Template dependencies\n-\t\t\t\tfinal List<Template> templateList = APILocator.getTemplateAPI().findTemplatesAssignedTo(h);\n-\t\t\t\tfor (Template template : templateList) {\n-\t\t\t\t\ttemplates.addOrClean( template.getIdentifier(), template.getModDate());\n-\t\t\t\t\ttemplatesSet.add(template.getIdentifier());\n+\t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.TEMPLATE.getType())) {\n+\t\t\t\t\tfinal List<Template> templateList = APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.findTemplatesAssignedTo(h);\n+\t\t\t\t\tfor (Template template : templateList) {\n+\t\t\t\t\t\ttemplates.addOrClean(template.getIdentifier(), template.getModDate());\n+\t\t\t\t\t\ttemplatesSet.add(template.getIdentifier());\n+\t\t\t\t\t}\n \t\t\t\t}\n \n \t\t\t\t// Container dependencies\n-\t\t\t\tfinal List<Container> containerList = APILocator.getContainerAPI().findContainersUnder(h);\n-\t\t\t\tfor (Container container : containerList) {\n-\n-\t\t\t\t\tif (container instanceof FileAssetContainer) {\n-\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\tcontainers.addOrClean(container.getIdentifier(), container.getModDate());\n-\t\t\t\t\t\tcontainersSet.add(container.getIdentifier());\n+\t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTAINER.getType())) {\n+\t\t\t\t\tfinal List<Container> containerList = APILocator.getContainerAPI()\n+\t\t\t\t\t\t\t.findContainersUnder(h);\n+\t\t\t\t\tfor (Container container : containerList) {\n+\n+\t\t\t\t\t\tif (container instanceof FileAssetContainer) {\n+\t\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n+\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\tcontainers\n+\t\t\t\t\t\t\t\t\t.addOrClean(container.getIdentifier(), container.getModDate());\n+\t\t\t\t\t\t\tcontainersSet.add(container.getIdentifier());\n+\t\t\t\t\t\t}\n \t\t\t\t\t}\n \t\t\t\t}\n \n \t\t\t\t// Content dependencies\n-\t\t\t\tString luceneQuery = \"+conHost:\" + h.getIdentifier();\n-\n-\t\t\t\tfinal List<Contentlet> contentList = APILocator.getContentletAPI().search(luceneQuery, 0, 0, null, user, false);\n-\t\t\t\tfor (Contentlet contentlet : contentList) {\n-\t\t\t\t\tcontents.addOrClean( contentlet.getIdentifier(), contentlet.getModDate());\n-\t\t\t\t\tcontentsSet.add(contentlet.getIdentifier());\n+\t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType())) {\n+\t\t\t\t\tString luceneQuery = \"+conHost:\" + h.getIdentifier();\n+\t\t\t\t\tfinal List<Contentlet> contentList = APILocator.getContentletAPI()\n+\t\t\t\t\t\t\t.search(luceneQuery, 0, 0, null, user, false);\n+\t\t\t\t\tfor (Contentlet contentlet : contentList) {\n+\t\t\t\t\t\tif(publisherFilter.acceptExcludeDependencyQuery(contentlet.getIdentifier())) {\n+\t\t\t\t\t\t\tcontents.addOrClean(contentlet.getIdentifier(),\n+\t\t\t\t\t\t\t\t\tcontentlet.getModDate());\n+\t\t\t\t\t\t\tcontentsSet.add(contentlet.getIdentifier());\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n \t\t\t\t}\n \n \t\t\t\t// Structure dependencies\n-\t\t\t\tfinal List<Structure> structuresList = StructureFactory.getStructuresUnderHost(h, user, false);\n-\t\t\t\tfor (Structure structure : structuresList) {\n-\t\t\t\t\tstructures.addOrClean( structure.getInode(), structure.getModDate());\n-\t\t\t\t\tstructuresSet.add(structure.getInode());\n+\t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENT_TYPE.getType())) {\n+\t\t\t\t\tfinal List<Structure> structuresList = StructureFactory\n+\t\t\t\t\t\t\t.getStructuresUnderHost(h, user, false);\n+\t\t\t\t\tfor (Structure structure : structuresList) {\n+\t\t\t\t\t\tcontentTypes.addOrClean(structure.getInode(), structure.getModDate());\n+\t\t\t\t\t\tcontentTypesSet.add(structure.getInode());\n+\t\t\t\t\t}\n \t\t\t\t}\n \n \t\t\t\t// Folder dependencies\n-\t\t\t\tfinal List<Folder> folderList = APILocator.getFolderAPI().findFoldersByHost(h, user, false);\n-\t\t\t\tfor (Folder folder : folderList) {\n-\t\t\t\t\tfolders.addOrClean( folder.getInode(), folder.getModDate());\n-\t\t\t\t\tfoldersSet.add(folder.getInode());\n+\t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n+\t\t\t\t\tfinal List<Folder> folderList = APILocator.getFolderAPI()\n+\t\t\t\t\t\t\t.findFoldersByHost(h, user, false);", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -443,14 +443,14 @@ public class DependencyManager {\n \t */\n \tprivate void setHostDependencies (final PublisherFilter publisherFilter) {\n \t\ttry {\n-\t\t\tfor (String id : hostsSet) {\n-\t\t\t\tfinal Host h = APILocator.getHostAPI().find(id, user, false);\n+\t\t\tfor (final String hostId : hostsSet) {\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(hostId, user, false);\n \n \t\t\t\t// Template dependencies\n \t\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.TEMPLATE.getType())) {\n \t\t\t\t\tfinal List<Template> templateList = APILocator.getTemplateAPI()\n-\t\t\t\t\t\t\t.findTemplatesAssignedTo(h);\n-\t\t\t\t\tfor (Template template : templateList) {\n+\t\t\t\t\t\t\t.findTemplatesAssignedTo(host);\n+\t\t\t\t\tfor (final Template template : templateList) {\n \t\t\t\t\t\ttemplates.addOrClean(template.getIdentifier(), template.getModDate());\n \t\t\t\t\t\ttemplatesSet.add(template.getIdentifier());\n \t\t\t\t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwNDE4NA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424604184", "bodyText": "rename to folder and set to final", "author": "jdotcms", "createdAt": "2020-05-13T17:20:02Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -514,54 +568,67 @@ private void setFolderDependencies() {\n \t * @throws DotDataException\n \t * @throws DotSecurityException\n \t */\n-\tprivate void setFolderListDependencies(List<Folder> folderList) throws DotIdentifierStateException, DotDataException, DotSecurityException {\n+\tprivate void setFolderListDependencies(final List<Folder> folderList, final PublisherFilter publisherFilter) throws DotIdentifierStateException, DotDataException, DotSecurityException {\n \t\tfor (Folder f : folderList) {", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -569,27 +569,27 @@ public class DependencyManager {\n \t * @throws DotSecurityException\n \t */\n \tprivate void setFolderListDependencies(final List<Folder> folderList, final PublisherFilter publisherFilter) throws DotIdentifierStateException, DotDataException, DotSecurityException {\n-\t\tfor (Folder f : folderList) {\n+\t\tfor (final Folder folder : folderList) {\n \n \t\t\t// Add folder even if empty\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n-\t\t\t\tfolders.addOrClean(f.getInode(), f.getModDate());\n-\t\t\t\tfoldersSet.add(f.getInode());\n+\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n+\t\t\t\tfoldersSet.add(folder.getInode());\n \t\t\t}\n \n \t\t\t// Host dependency\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\tHost h = APILocator.getHostAPI().find(f.getHostId(), user, false);\n-\t\t\t\thosts.addOrClean(f.getHostId(), h.getModDate());\n-\t\t\t\thostsSet.add(f.getHostId());\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(folder.getHostId(), user, false);\n+\t\t\t\thosts.addOrClean(folder.getHostId(), host.getModDate());\n+\t\t\t\thostsSet.add(folder.getHostId());\n \t\t\t}\n \n \t\t\t// Content dependencies\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType())) {\n-\t\t\t\tString luceneQuery = \"+conFolder:\" + f.getInode();\n-\t\t\t\tList<Contentlet> contentList = APILocator.getContentletAPI()\n+\t\t\t\tfinal String luceneQuery = \"+conFolder:\" + folder.getInode();\n+\t\t\t\tfinal List<Contentlet> contentList = APILocator.getContentletAPI()\n \t\t\t\t\t\t.search(luceneQuery, 0, 0, null, user, false);\n-\t\t\t\tfor (Contentlet contentlet : contentList) {\n+\t\t\t\tfor (final Contentlet contentlet : contentList) {\n \t\t\t\t\tif(publisherFilter.acceptExcludeDependencyQuery(contentlet.getIdentifier())) {\n \t\t\t\t\t\tcontents.addOrClean(contentlet.getIdentifier(), contentlet.getModDate());\n \t\t\t\t\t\tcontentsSet.add(contentlet.getIdentifier());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwNDYwNw==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424604607", "bodyText": "rename to\nfinal Host host", "author": "jdotcms", "createdAt": "2020-05-13T17:20:41Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -514,54 +568,67 @@ private void setFolderDependencies() {\n \t * @throws DotDataException\n \t * @throws DotSecurityException\n \t */\n-\tprivate void setFolderListDependencies(List<Folder> folderList) throws DotIdentifierStateException, DotDataException, DotSecurityException {\n+\tprivate void setFolderListDependencies(final List<Folder> folderList, final PublisherFilter publisherFilter) throws DotIdentifierStateException, DotDataException, DotSecurityException {\n \t\tfor (Folder f : folderList) {\n \n \t\t\t// Add folder even if empty\n-\t\t\tfolders.addOrClean( f.getInode(), f.getModDate());\n-\t\t\tfoldersSet.add(f.getInode());\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n+\t\t\t\tfolders.addOrClean(f.getInode(), f.getModDate());\n+\t\t\t\tfoldersSet.add(f.getInode());\n+\t\t\t}\n \n \t\t\t// Host dependency\n-\t\t\tHost h = APILocator.getHostAPI().find(f.getHostId(), user, false);\n-\t\t\thosts.addOrClean( f.getHostId(), h.getModDate());\n-\t\t\thostsSet.add(f.getHostId());\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\tHost h = APILocator.getHostAPI().find(f.getHostId(), user, false);", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -569,27 +569,27 @@ public class DependencyManager {\n \t * @throws DotSecurityException\n \t */\n \tprivate void setFolderListDependencies(final List<Folder> folderList, final PublisherFilter publisherFilter) throws DotIdentifierStateException, DotDataException, DotSecurityException {\n-\t\tfor (Folder f : folderList) {\n+\t\tfor (final Folder folder : folderList) {\n \n \t\t\t// Add folder even if empty\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n-\t\t\t\tfolders.addOrClean(f.getInode(), f.getModDate());\n-\t\t\t\tfoldersSet.add(f.getInode());\n+\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n+\t\t\t\tfoldersSet.add(folder.getInode());\n \t\t\t}\n \n \t\t\t// Host dependency\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\tHost h = APILocator.getHostAPI().find(f.getHostId(), user, false);\n-\t\t\t\thosts.addOrClean(f.getHostId(), h.getModDate());\n-\t\t\t\thostsSet.add(f.getHostId());\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(folder.getHostId(), user, false);\n+\t\t\t\thosts.addOrClean(folder.getHostId(), host.getModDate());\n+\t\t\t\thostsSet.add(folder.getHostId());\n \t\t\t}\n \n \t\t\t// Content dependencies\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType())) {\n-\t\t\t\tString luceneQuery = \"+conFolder:\" + f.getInode();\n-\t\t\t\tList<Contentlet> contentList = APILocator.getContentletAPI()\n+\t\t\t\tfinal String luceneQuery = \"+conFolder:\" + folder.getInode();\n+\t\t\t\tfinal List<Contentlet> contentList = APILocator.getContentletAPI()\n \t\t\t\t\t\t.search(luceneQuery, 0, 0, null, user, false);\n-\t\t\t\tfor (Contentlet contentlet : contentList) {\n+\t\t\t\tfor (final Contentlet contentlet : contentList) {\n \t\t\t\t\tif(publisherFilter.acceptExcludeDependencyQuery(contentlet.getIdentifier())) {\n \t\t\t\t\t\tcontents.addOrClean(contentlet.getIdentifier(), contentlet.getModDate());\n \t\t\t\t\t\tcontentsSet.add(contentlet.getIdentifier());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwNDc2Nw==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424604767", "bodyText": "Rename f to folder", "author": "jdotcms", "createdAt": "2020-05-13T17:20:55Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -514,54 +568,67 @@ private void setFolderDependencies() {\n \t * @throws DotDataException\n \t * @throws DotSecurityException\n \t */\n-\tprivate void setFolderListDependencies(List<Folder> folderList) throws DotIdentifierStateException, DotDataException, DotSecurityException {\n+\tprivate void setFolderListDependencies(final List<Folder> folderList, final PublisherFilter publisherFilter) throws DotIdentifierStateException, DotDataException, DotSecurityException {\n \t\tfor (Folder f : folderList) {\n \n \t\t\t// Add folder even if empty\n-\t\t\tfolders.addOrClean( f.getInode(), f.getModDate());\n-\t\t\tfoldersSet.add(f.getInode());\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n+\t\t\t\tfolders.addOrClean(f.getInode(), f.getModDate());\n+\t\t\t\tfoldersSet.add(f.getInode());\n+\t\t\t}\n \n \t\t\t// Host dependency\n-\t\t\tHost h = APILocator.getHostAPI().find(f.getHostId(), user, false);\n-\t\t\thosts.addOrClean( f.getHostId(), h.getModDate());\n-\t\t\thostsSet.add(f.getHostId());\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\tHost h = APILocator.getHostAPI().find(f.getHostId(), user, false);", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -569,27 +569,27 @@ public class DependencyManager {\n \t * @throws DotSecurityException\n \t */\n \tprivate void setFolderListDependencies(final List<Folder> folderList, final PublisherFilter publisherFilter) throws DotIdentifierStateException, DotDataException, DotSecurityException {\n-\t\tfor (Folder f : folderList) {\n+\t\tfor (final Folder folder : folderList) {\n \n \t\t\t// Add folder even if empty\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n-\t\t\t\tfolders.addOrClean(f.getInode(), f.getModDate());\n-\t\t\t\tfoldersSet.add(f.getInode());\n+\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n+\t\t\t\tfoldersSet.add(folder.getInode());\n \t\t\t}\n \n \t\t\t// Host dependency\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\tHost h = APILocator.getHostAPI().find(f.getHostId(), user, false);\n-\t\t\t\thosts.addOrClean(f.getHostId(), h.getModDate());\n-\t\t\t\thostsSet.add(f.getHostId());\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(folder.getHostId(), user, false);\n+\t\t\t\thosts.addOrClean(folder.getHostId(), host.getModDate());\n+\t\t\t\thostsSet.add(folder.getHostId());\n \t\t\t}\n \n \t\t\t// Content dependencies\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType())) {\n-\t\t\t\tString luceneQuery = \"+conFolder:\" + f.getInode();\n-\t\t\t\tList<Contentlet> contentList = APILocator.getContentletAPI()\n+\t\t\t\tfinal String luceneQuery = \"+conFolder:\" + folder.getInode();\n+\t\t\t\tfinal List<Contentlet> contentList = APILocator.getContentletAPI()\n \t\t\t\t\t\t.search(luceneQuery, 0, 0, null, user, false);\n-\t\t\t\tfor (Contentlet contentlet : contentList) {\n+\t\t\t\tfor (final Contentlet contentlet : contentList) {\n \t\t\t\t\tif(publisherFilter.acceptExcludeDependencyQuery(contentlet.getIdentifier())) {\n \t\t\t\t\t\tcontents.addOrClean(contentlet.getIdentifier(), contentlet.getModDate());\n \t\t\t\t\t\tcontentsSet.add(contentlet.getIdentifier());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwNDg4Mg==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424604882", "bodyText": "set to final", "author": "jdotcms", "createdAt": "2020-05-13T17:21:07Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -514,54 +568,67 @@ private void setFolderDependencies() {\n \t * @throws DotDataException\n \t * @throws DotSecurityException\n \t */\n-\tprivate void setFolderListDependencies(List<Folder> folderList) throws DotIdentifierStateException, DotDataException, DotSecurityException {\n+\tprivate void setFolderListDependencies(final List<Folder> folderList, final PublisherFilter publisherFilter) throws DotIdentifierStateException, DotDataException, DotSecurityException {\n \t\tfor (Folder f : folderList) {\n \n \t\t\t// Add folder even if empty\n-\t\t\tfolders.addOrClean( f.getInode(), f.getModDate());\n-\t\t\tfoldersSet.add(f.getInode());\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n+\t\t\t\tfolders.addOrClean(f.getInode(), f.getModDate());\n+\t\t\t\tfoldersSet.add(f.getInode());\n+\t\t\t}\n \n \t\t\t// Host dependency\n-\t\t\tHost h = APILocator.getHostAPI().find(f.getHostId(), user, false);\n-\t\t\thosts.addOrClean( f.getHostId(), h.getModDate());\n-\t\t\thostsSet.add(f.getHostId());\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\tHost h = APILocator.getHostAPI().find(f.getHostId(), user, false);\n+\t\t\t\thosts.addOrClean(f.getHostId(), h.getModDate());\n+\t\t\t\thostsSet.add(f.getHostId());\n+\t\t\t}\n \n \t\t\t// Content dependencies\n-\t\t\tString luceneQuery = \"+conFolder:\" + f.getInode();\n-\n-\t\t\tList<Contentlet> contentList = APILocator.getContentletAPI().search(luceneQuery, 0, 0, null, user, false);\n-\t\t\tfor (Contentlet contentlet : contentList) {\n-\t\t\t\tcontents.addOrClean( contentlet.getIdentifier(), contentlet.getModDate());\n-\t\t\t\tcontentsSet.add(contentlet.getIdentifier());\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType())) {\n+\t\t\t\tString luceneQuery = \"+conFolder:\" + f.getInode();", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -569,27 +569,27 @@ public class DependencyManager {\n \t * @throws DotSecurityException\n \t */\n \tprivate void setFolderListDependencies(final List<Folder> folderList, final PublisherFilter publisherFilter) throws DotIdentifierStateException, DotDataException, DotSecurityException {\n-\t\tfor (Folder f : folderList) {\n+\t\tfor (final Folder folder : folderList) {\n \n \t\t\t// Add folder even if empty\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n-\t\t\t\tfolders.addOrClean(f.getInode(), f.getModDate());\n-\t\t\t\tfoldersSet.add(f.getInode());\n+\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n+\t\t\t\tfoldersSet.add(folder.getInode());\n \t\t\t}\n \n \t\t\t// Host dependency\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\tHost h = APILocator.getHostAPI().find(f.getHostId(), user, false);\n-\t\t\t\thosts.addOrClean(f.getHostId(), h.getModDate());\n-\t\t\t\thostsSet.add(f.getHostId());\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(folder.getHostId(), user, false);\n+\t\t\t\thosts.addOrClean(folder.getHostId(), host.getModDate());\n+\t\t\t\thostsSet.add(folder.getHostId());\n \t\t\t}\n \n \t\t\t// Content dependencies\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType())) {\n-\t\t\t\tString luceneQuery = \"+conFolder:\" + f.getInode();\n-\t\t\t\tList<Contentlet> contentList = APILocator.getContentletAPI()\n+\t\t\t\tfinal String luceneQuery = \"+conFolder:\" + folder.getInode();\n+\t\t\t\tfinal List<Contentlet> contentList = APILocator.getContentletAPI()\n \t\t\t\t\t\t.search(luceneQuery, 0, 0, null, user, false);\n-\t\t\t\tfor (Contentlet contentlet : contentList) {\n+\t\t\t\tfor (final Contentlet contentlet : contentList) {\n \t\t\t\t\tif(publisherFilter.acceptExcludeDependencyQuery(contentlet.getIdentifier())) {\n \t\t\t\t\t\tcontents.addOrClean(contentlet.getIdentifier(), contentlet.getModDate());\n \t\t\t\t\t\tcontentsSet.add(contentlet.getIdentifier());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwNTAwOA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424605008", "bodyText": "set to final", "author": "jdotcms", "createdAt": "2020-05-13T17:21:18Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -514,54 +568,67 @@ private void setFolderDependencies() {\n \t * @throws DotDataException\n \t * @throws DotSecurityException\n \t */\n-\tprivate void setFolderListDependencies(List<Folder> folderList) throws DotIdentifierStateException, DotDataException, DotSecurityException {\n+\tprivate void setFolderListDependencies(final List<Folder> folderList, final PublisherFilter publisherFilter) throws DotIdentifierStateException, DotDataException, DotSecurityException {\n \t\tfor (Folder f : folderList) {\n \n \t\t\t// Add folder even if empty\n-\t\t\tfolders.addOrClean( f.getInode(), f.getModDate());\n-\t\t\tfoldersSet.add(f.getInode());\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n+\t\t\t\tfolders.addOrClean(f.getInode(), f.getModDate());\n+\t\t\t\tfoldersSet.add(f.getInode());\n+\t\t\t}\n \n \t\t\t// Host dependency\n-\t\t\tHost h = APILocator.getHostAPI().find(f.getHostId(), user, false);\n-\t\t\thosts.addOrClean( f.getHostId(), h.getModDate());\n-\t\t\thostsSet.add(f.getHostId());\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\tHost h = APILocator.getHostAPI().find(f.getHostId(), user, false);\n+\t\t\t\thosts.addOrClean(f.getHostId(), h.getModDate());\n+\t\t\t\thostsSet.add(f.getHostId());\n+\t\t\t}\n \n \t\t\t// Content dependencies\n-\t\t\tString luceneQuery = \"+conFolder:\" + f.getInode();\n-\n-\t\t\tList<Contentlet> contentList = APILocator.getContentletAPI().search(luceneQuery, 0, 0, null, user, false);\n-\t\t\tfor (Contentlet contentlet : contentList) {\n-\t\t\t\tcontents.addOrClean( contentlet.getIdentifier(), contentlet.getModDate());\n-\t\t\t\tcontentsSet.add(contentlet.getIdentifier());\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType())) {\n+\t\t\t\tString luceneQuery = \"+conFolder:\" + f.getInode();\n+\t\t\t\tList<Contentlet> contentList = APILocator.getContentletAPI()", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -569,27 +569,27 @@ public class DependencyManager {\n \t * @throws DotSecurityException\n \t */\n \tprivate void setFolderListDependencies(final List<Folder> folderList, final PublisherFilter publisherFilter) throws DotIdentifierStateException, DotDataException, DotSecurityException {\n-\t\tfor (Folder f : folderList) {\n+\t\tfor (final Folder folder : folderList) {\n \n \t\t\t// Add folder even if empty\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n-\t\t\t\tfolders.addOrClean(f.getInode(), f.getModDate());\n-\t\t\t\tfoldersSet.add(f.getInode());\n+\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n+\t\t\t\tfoldersSet.add(folder.getInode());\n \t\t\t}\n \n \t\t\t// Host dependency\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\tHost h = APILocator.getHostAPI().find(f.getHostId(), user, false);\n-\t\t\t\thosts.addOrClean(f.getHostId(), h.getModDate());\n-\t\t\t\thostsSet.add(f.getHostId());\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(folder.getHostId(), user, false);\n+\t\t\t\thosts.addOrClean(folder.getHostId(), host.getModDate());\n+\t\t\t\thostsSet.add(folder.getHostId());\n \t\t\t}\n \n \t\t\t// Content dependencies\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType())) {\n-\t\t\t\tString luceneQuery = \"+conFolder:\" + f.getInode();\n-\t\t\t\tList<Contentlet> contentList = APILocator.getContentletAPI()\n+\t\t\t\tfinal String luceneQuery = \"+conFolder:\" + folder.getInode();\n+\t\t\t\tfinal List<Contentlet> contentList = APILocator.getContentletAPI()\n \t\t\t\t\t\t.search(luceneQuery, 0, 0, null, user, false);\n-\t\t\t\tfor (Contentlet contentlet : contentList) {\n+\t\t\t\tfor (final Contentlet contentlet : contentList) {\n \t\t\t\t\tif(publisherFilter.acceptExcludeDependencyQuery(contentlet.getIdentifier())) {\n \t\t\t\t\t\tcontents.addOrClean(contentlet.getIdentifier(), contentlet.getModDate());\n \t\t\t\t\t\tcontentsSet.add(contentlet.getIdentifier());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwNTA3Mw==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424605073", "bodyText": "set to final", "author": "jdotcms", "createdAt": "2020-05-13T17:21:25Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -514,54 +568,67 @@ private void setFolderDependencies() {\n \t * @throws DotDataException\n \t * @throws DotSecurityException\n \t */\n-\tprivate void setFolderListDependencies(List<Folder> folderList) throws DotIdentifierStateException, DotDataException, DotSecurityException {\n+\tprivate void setFolderListDependencies(final List<Folder> folderList, final PublisherFilter publisherFilter) throws DotIdentifierStateException, DotDataException, DotSecurityException {\n \t\tfor (Folder f : folderList) {\n \n \t\t\t// Add folder even if empty\n-\t\t\tfolders.addOrClean( f.getInode(), f.getModDate());\n-\t\t\tfoldersSet.add(f.getInode());\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n+\t\t\t\tfolders.addOrClean(f.getInode(), f.getModDate());\n+\t\t\t\tfoldersSet.add(f.getInode());\n+\t\t\t}\n \n \t\t\t// Host dependency\n-\t\t\tHost h = APILocator.getHostAPI().find(f.getHostId(), user, false);\n-\t\t\thosts.addOrClean( f.getHostId(), h.getModDate());\n-\t\t\thostsSet.add(f.getHostId());\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\tHost h = APILocator.getHostAPI().find(f.getHostId(), user, false);\n+\t\t\t\thosts.addOrClean(f.getHostId(), h.getModDate());\n+\t\t\t\thostsSet.add(f.getHostId());\n+\t\t\t}\n \n \t\t\t// Content dependencies\n-\t\t\tString luceneQuery = \"+conFolder:\" + f.getInode();\n-\n-\t\t\tList<Contentlet> contentList = APILocator.getContentletAPI().search(luceneQuery, 0, 0, null, user, false);\n-\t\t\tfor (Contentlet contentlet : contentList) {\n-\t\t\t\tcontents.addOrClean( contentlet.getIdentifier(), contentlet.getModDate());\n-\t\t\t\tcontentsSet.add(contentlet.getIdentifier());\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType())) {\n+\t\t\t\tString luceneQuery = \"+conFolder:\" + f.getInode();\n+\t\t\t\tList<Contentlet> contentList = APILocator.getContentletAPI()\n+\t\t\t\t\t\t.search(luceneQuery, 0, 0, null, user, false);\n+\t\t\t\tfor (Contentlet contentlet : contentList) {", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -569,27 +569,27 @@ public class DependencyManager {\n \t * @throws DotSecurityException\n \t */\n \tprivate void setFolderListDependencies(final List<Folder> folderList, final PublisherFilter publisherFilter) throws DotIdentifierStateException, DotDataException, DotSecurityException {\n-\t\tfor (Folder f : folderList) {\n+\t\tfor (final Folder folder : folderList) {\n \n \t\t\t// Add folder even if empty\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n-\t\t\t\tfolders.addOrClean(f.getInode(), f.getModDate());\n-\t\t\t\tfoldersSet.add(f.getInode());\n+\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n+\t\t\t\tfoldersSet.add(folder.getInode());\n \t\t\t}\n \n \t\t\t// Host dependency\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\tHost h = APILocator.getHostAPI().find(f.getHostId(), user, false);\n-\t\t\t\thosts.addOrClean(f.getHostId(), h.getModDate());\n-\t\t\t\thostsSet.add(f.getHostId());\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(folder.getHostId(), user, false);\n+\t\t\t\thosts.addOrClean(folder.getHostId(), host.getModDate());\n+\t\t\t\thostsSet.add(folder.getHostId());\n \t\t\t}\n \n \t\t\t// Content dependencies\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType())) {\n-\t\t\t\tString luceneQuery = \"+conFolder:\" + f.getInode();\n-\t\t\t\tList<Contentlet> contentList = APILocator.getContentletAPI()\n+\t\t\t\tfinal String luceneQuery = \"+conFolder:\" + folder.getInode();\n+\t\t\t\tfinal List<Contentlet> contentList = APILocator.getContentletAPI()\n \t\t\t\t\t\t.search(luceneQuery, 0, 0, null, user, false);\n-\t\t\t\tfor (Contentlet contentlet : contentList) {\n+\t\t\t\tfor (final Contentlet contentlet : contentList) {\n \t\t\t\t\tif(publisherFilter.acceptExcludeDependencyQuery(contentlet.getIdentifier())) {\n \t\t\t\t\t\tcontents.addOrClean(contentlet.getIdentifier(), contentlet.getModDate());\n \t\t\t\t\t\tcontentsSet.add(contentlet.getIdentifier());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwNTE2OA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424605168", "bodyText": "set to final", "author": "jdotcms", "createdAt": "2020-05-13T17:21:36Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -514,54 +568,67 @@ private void setFolderDependencies() {\n \t * @throws DotDataException\n \t * @throws DotSecurityException\n \t */\n-\tprivate void setFolderListDependencies(List<Folder> folderList) throws DotIdentifierStateException, DotDataException, DotSecurityException {\n+\tprivate void setFolderListDependencies(final List<Folder> folderList, final PublisherFilter publisherFilter) throws DotIdentifierStateException, DotDataException, DotSecurityException {\n \t\tfor (Folder f : folderList) {\n \n \t\t\t// Add folder even if empty\n-\t\t\tfolders.addOrClean( f.getInode(), f.getModDate());\n-\t\t\tfoldersSet.add(f.getInode());\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n+\t\t\t\tfolders.addOrClean(f.getInode(), f.getModDate());\n+\t\t\t\tfoldersSet.add(f.getInode());\n+\t\t\t}\n \n \t\t\t// Host dependency\n-\t\t\tHost h = APILocator.getHostAPI().find(f.getHostId(), user, false);\n-\t\t\thosts.addOrClean( f.getHostId(), h.getModDate());\n-\t\t\thostsSet.add(f.getHostId());\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\tHost h = APILocator.getHostAPI().find(f.getHostId(), user, false);\n+\t\t\t\thosts.addOrClean(f.getHostId(), h.getModDate());\n+\t\t\t\thostsSet.add(f.getHostId());\n+\t\t\t}\n \n \t\t\t// Content dependencies\n-\t\t\tString luceneQuery = \"+conFolder:\" + f.getInode();\n-\n-\t\t\tList<Contentlet> contentList = APILocator.getContentletAPI().search(luceneQuery, 0, 0, null, user, false);\n-\t\t\tfor (Contentlet contentlet : contentList) {\n-\t\t\t\tcontents.addOrClean( contentlet.getIdentifier(), contentlet.getModDate());\n-\t\t\t\tcontentsSet.add(contentlet.getIdentifier());\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType())) {\n+\t\t\t\tString luceneQuery = \"+conFolder:\" + f.getInode();\n+\t\t\t\tList<Contentlet> contentList = APILocator.getContentletAPI()\n+\t\t\t\t\t\t.search(luceneQuery, 0, 0, null, user, false);\n+\t\t\t\tfor (Contentlet contentlet : contentList) {\n+\t\t\t\t\tif(publisherFilter.acceptExcludeDependencyQuery(contentlet.getIdentifier())) {\n+\t\t\t\t\t\tcontents.addOrClean(contentlet.getIdentifier(), contentlet.getModDate());\n+\t\t\t\t\t\tcontentsSet.add(contentlet.getIdentifier());\n+\t\t\t\t\t}\n+\t\t\t\t}\n \t\t\t}\n \n \t\t\t// Menu Link dependencies\n-\n-\t\t\tList<Link> linkList = APILocator.getMenuLinkAPI().findFolderMenuLinks(f);\n-\t\t\tfor (Link link : linkList) {\n-\t\t\t\tlinks.addOrClean( link.getIdentifier(), link.getModDate());\n-\t\t\t\tlinksSet.add(link.getIdentifier());\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.LINK.getType())) {\n+\t\t\t\tList<Link> linkList = APILocator.getMenuLinkAPI().findFolderMenuLinks(f);", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -569,27 +569,27 @@ public class DependencyManager {\n \t * @throws DotSecurityException\n \t */\n \tprivate void setFolderListDependencies(final List<Folder> folderList, final PublisherFilter publisherFilter) throws DotIdentifierStateException, DotDataException, DotSecurityException {\n-\t\tfor (Folder f : folderList) {\n+\t\tfor (final Folder folder : folderList) {\n \n \t\t\t// Add folder even if empty\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n-\t\t\t\tfolders.addOrClean(f.getInode(), f.getModDate());\n-\t\t\t\tfoldersSet.add(f.getInode());\n+\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n+\t\t\t\tfoldersSet.add(folder.getInode());\n \t\t\t}\n \n \t\t\t// Host dependency\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\tHost h = APILocator.getHostAPI().find(f.getHostId(), user, false);\n-\t\t\t\thosts.addOrClean(f.getHostId(), h.getModDate());\n-\t\t\t\thostsSet.add(f.getHostId());\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(folder.getHostId(), user, false);\n+\t\t\t\thosts.addOrClean(folder.getHostId(), host.getModDate());\n+\t\t\t\thostsSet.add(folder.getHostId());\n \t\t\t}\n \n \t\t\t// Content dependencies\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType())) {\n-\t\t\t\tString luceneQuery = \"+conFolder:\" + f.getInode();\n-\t\t\t\tList<Contentlet> contentList = APILocator.getContentletAPI()\n+\t\t\t\tfinal String luceneQuery = \"+conFolder:\" + folder.getInode();\n+\t\t\t\tfinal List<Contentlet> contentList = APILocator.getContentletAPI()\n \t\t\t\t\t\t.search(luceneQuery, 0, 0, null, user, false);\n-\t\t\t\tfor (Contentlet contentlet : contentList) {\n+\t\t\t\tfor (final Contentlet contentlet : contentList) {\n \t\t\t\t\tif(publisherFilter.acceptExcludeDependencyQuery(contentlet.getIdentifier())) {\n \t\t\t\t\t\tcontents.addOrClean(contentlet.getIdentifier(), contentlet.getModDate());\n \t\t\t\t\t\tcontentsSet.add(contentlet.getIdentifier());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwNTI0NQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424605245", "bodyText": "set to final", "author": "jdotcms", "createdAt": "2020-05-13T17:21:44Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -514,54 +568,67 @@ private void setFolderDependencies() {\n \t * @throws DotDataException\n \t * @throws DotSecurityException\n \t */\n-\tprivate void setFolderListDependencies(List<Folder> folderList) throws DotIdentifierStateException, DotDataException, DotSecurityException {\n+\tprivate void setFolderListDependencies(final List<Folder> folderList, final PublisherFilter publisherFilter) throws DotIdentifierStateException, DotDataException, DotSecurityException {\n \t\tfor (Folder f : folderList) {\n \n \t\t\t// Add folder even if empty\n-\t\t\tfolders.addOrClean( f.getInode(), f.getModDate());\n-\t\t\tfoldersSet.add(f.getInode());\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n+\t\t\t\tfolders.addOrClean(f.getInode(), f.getModDate());\n+\t\t\t\tfoldersSet.add(f.getInode());\n+\t\t\t}\n \n \t\t\t// Host dependency\n-\t\t\tHost h = APILocator.getHostAPI().find(f.getHostId(), user, false);\n-\t\t\thosts.addOrClean( f.getHostId(), h.getModDate());\n-\t\t\thostsSet.add(f.getHostId());\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\tHost h = APILocator.getHostAPI().find(f.getHostId(), user, false);\n+\t\t\t\thosts.addOrClean(f.getHostId(), h.getModDate());\n+\t\t\t\thostsSet.add(f.getHostId());\n+\t\t\t}\n \n \t\t\t// Content dependencies\n-\t\t\tString luceneQuery = \"+conFolder:\" + f.getInode();\n-\n-\t\t\tList<Contentlet> contentList = APILocator.getContentletAPI().search(luceneQuery, 0, 0, null, user, false);\n-\t\t\tfor (Contentlet contentlet : contentList) {\n-\t\t\t\tcontents.addOrClean( contentlet.getIdentifier(), contentlet.getModDate());\n-\t\t\t\tcontentsSet.add(contentlet.getIdentifier());\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType())) {\n+\t\t\t\tString luceneQuery = \"+conFolder:\" + f.getInode();\n+\t\t\t\tList<Contentlet> contentList = APILocator.getContentletAPI()\n+\t\t\t\t\t\t.search(luceneQuery, 0, 0, null, user, false);\n+\t\t\t\tfor (Contentlet contentlet : contentList) {\n+\t\t\t\t\tif(publisherFilter.acceptExcludeDependencyQuery(contentlet.getIdentifier())) {\n+\t\t\t\t\t\tcontents.addOrClean(contentlet.getIdentifier(), contentlet.getModDate());\n+\t\t\t\t\t\tcontentsSet.add(contentlet.getIdentifier());\n+\t\t\t\t\t}\n+\t\t\t\t}\n \t\t\t}\n \n \t\t\t// Menu Link dependencies\n-\n-\t\t\tList<Link> linkList = APILocator.getMenuLinkAPI().findFolderMenuLinks(f);\n-\t\t\tfor (Link link : linkList) {\n-\t\t\t\tlinks.addOrClean( link.getIdentifier(), link.getModDate());\n-\t\t\t\tlinksSet.add(link.getIdentifier());\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.LINK.getType())) {\n+\t\t\t\tList<Link> linkList = APILocator.getMenuLinkAPI().findFolderMenuLinks(f);\n+\t\t\t\tfor (Link link : linkList) {", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -569,27 +569,27 @@ public class DependencyManager {\n \t * @throws DotSecurityException\n \t */\n \tprivate void setFolderListDependencies(final List<Folder> folderList, final PublisherFilter publisherFilter) throws DotIdentifierStateException, DotDataException, DotSecurityException {\n-\t\tfor (Folder f : folderList) {\n+\t\tfor (final Folder folder : folderList) {\n \n \t\t\t// Add folder even if empty\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n-\t\t\t\tfolders.addOrClean(f.getInode(), f.getModDate());\n-\t\t\t\tfoldersSet.add(f.getInode());\n+\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n+\t\t\t\tfoldersSet.add(folder.getInode());\n \t\t\t}\n \n \t\t\t// Host dependency\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\tHost h = APILocator.getHostAPI().find(f.getHostId(), user, false);\n-\t\t\t\thosts.addOrClean(f.getHostId(), h.getModDate());\n-\t\t\t\thostsSet.add(f.getHostId());\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(folder.getHostId(), user, false);\n+\t\t\t\thosts.addOrClean(folder.getHostId(), host.getModDate());\n+\t\t\t\thostsSet.add(folder.getHostId());\n \t\t\t}\n \n \t\t\t// Content dependencies\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType())) {\n-\t\t\t\tString luceneQuery = \"+conFolder:\" + f.getInode();\n-\t\t\t\tList<Contentlet> contentList = APILocator.getContentletAPI()\n+\t\t\t\tfinal String luceneQuery = \"+conFolder:\" + folder.getInode();\n+\t\t\t\tfinal List<Contentlet> contentList = APILocator.getContentletAPI()\n \t\t\t\t\t\t.search(luceneQuery, 0, 0, null, user, false);\n-\t\t\t\tfor (Contentlet contentlet : contentList) {\n+\t\t\t\tfor (final Contentlet contentlet : contentList) {\n \t\t\t\t\tif(publisherFilter.acceptExcludeDependencyQuery(contentlet.getIdentifier())) {\n \t\t\t\t\t\tcontents.addOrClean(contentlet.getIdentifier(), contentlet.getModDate());\n \t\t\t\t\t\tcontentsSet.add(contentlet.getIdentifier());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwNTg2NQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424605865", "bodyText": "set to final", "author": "jdotcms", "createdAt": "2020-05-13T17:22:44Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -514,54 +568,67 @@ private void setFolderDependencies() {\n \t * @throws DotDataException\n \t * @throws DotSecurityException\n \t */\n-\tprivate void setFolderListDependencies(List<Folder> folderList) throws DotIdentifierStateException, DotDataException, DotSecurityException {\n+\tprivate void setFolderListDependencies(final List<Folder> folderList, final PublisherFilter publisherFilter) throws DotIdentifierStateException, DotDataException, DotSecurityException {\n \t\tfor (Folder f : folderList) {\n \n \t\t\t// Add folder even if empty\n-\t\t\tfolders.addOrClean( f.getInode(), f.getModDate());\n-\t\t\tfoldersSet.add(f.getInode());\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n+\t\t\t\tfolders.addOrClean(f.getInode(), f.getModDate());\n+\t\t\t\tfoldersSet.add(f.getInode());\n+\t\t\t}\n \n \t\t\t// Host dependency\n-\t\t\tHost h = APILocator.getHostAPI().find(f.getHostId(), user, false);\n-\t\t\thosts.addOrClean( f.getHostId(), h.getModDate());\n-\t\t\thostsSet.add(f.getHostId());\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\tHost h = APILocator.getHostAPI().find(f.getHostId(), user, false);\n+\t\t\t\thosts.addOrClean(f.getHostId(), h.getModDate());\n+\t\t\t\thostsSet.add(f.getHostId());\n+\t\t\t}\n \n \t\t\t// Content dependencies\n-\t\t\tString luceneQuery = \"+conFolder:\" + f.getInode();\n-\n-\t\t\tList<Contentlet> contentList = APILocator.getContentletAPI().search(luceneQuery, 0, 0, null, user, false);\n-\t\t\tfor (Contentlet contentlet : contentList) {\n-\t\t\t\tcontents.addOrClean( contentlet.getIdentifier(), contentlet.getModDate());\n-\t\t\t\tcontentsSet.add(contentlet.getIdentifier());\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType())) {\n+\t\t\t\tString luceneQuery = \"+conFolder:\" + f.getInode();\n+\t\t\t\tList<Contentlet> contentList = APILocator.getContentletAPI()\n+\t\t\t\t\t\t.search(luceneQuery, 0, 0, null, user, false);\n+\t\t\t\tfor (Contentlet contentlet : contentList) {\n+\t\t\t\t\tif(publisherFilter.acceptExcludeDependencyQuery(contentlet.getIdentifier())) {\n+\t\t\t\t\t\tcontents.addOrClean(contentlet.getIdentifier(), contentlet.getModDate());\n+\t\t\t\t\t\tcontentsSet.add(contentlet.getIdentifier());\n+\t\t\t\t\t}\n+\t\t\t\t}\n \t\t\t}\n \n \t\t\t// Menu Link dependencies\n-\n-\t\t\tList<Link> linkList = APILocator.getMenuLinkAPI().findFolderMenuLinks(f);\n-\t\t\tfor (Link link : linkList) {\n-\t\t\t\tlinks.addOrClean( link.getIdentifier(), link.getModDate());\n-\t\t\t\tlinksSet.add(link.getIdentifier());\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.LINK.getType())) {\n+\t\t\t\tList<Link> linkList = APILocator.getMenuLinkAPI().findFolderMenuLinks(f);\n+\t\t\t\tfor (Link link : linkList) {\n+\t\t\t\t\tlinks.addOrClean(link.getIdentifier(), link.getModDate());\n+\t\t\t\t\tlinksSet.add(link.getIdentifier());\n+\t\t\t\t}\n \t\t\t}\n \n \t\t\t// Structure dependencies\n-\t\t\tList<Structure> structureList = APILocator.getFolderAPI().getStructures(f, user, false);\n-\n-\t\t\tfor (Structure structure : structureList) {\n-\t\t\t\tstructures.addOrClean( structure.getInode(), structure.getModDate());\n-\t\t\t\tstructuresSet.add(structure.getInode());\n-\t\t\t}\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENT_TYPE.getType())) {\n+\t\t\t\tList<Structure> structureList = APILocator.getFolderAPI()\n+\t\t\t\t\t\t.getStructures(f, user, false);\n+\t\t\t\tfor (Structure structure : structureList) {", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -569,27 +569,27 @@ public class DependencyManager {\n \t * @throws DotSecurityException\n \t */\n \tprivate void setFolderListDependencies(final List<Folder> folderList, final PublisherFilter publisherFilter) throws DotIdentifierStateException, DotDataException, DotSecurityException {\n-\t\tfor (Folder f : folderList) {\n+\t\tfor (final Folder folder : folderList) {\n \n \t\t\t// Add folder even if empty\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n-\t\t\t\tfolders.addOrClean(f.getInode(), f.getModDate());\n-\t\t\t\tfoldersSet.add(f.getInode());\n+\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n+\t\t\t\tfoldersSet.add(folder.getInode());\n \t\t\t}\n \n \t\t\t// Host dependency\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\tHost h = APILocator.getHostAPI().find(f.getHostId(), user, false);\n-\t\t\t\thosts.addOrClean(f.getHostId(), h.getModDate());\n-\t\t\t\thostsSet.add(f.getHostId());\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(folder.getHostId(), user, false);\n+\t\t\t\thosts.addOrClean(folder.getHostId(), host.getModDate());\n+\t\t\t\thostsSet.add(folder.getHostId());\n \t\t\t}\n \n \t\t\t// Content dependencies\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType())) {\n-\t\t\t\tString luceneQuery = \"+conFolder:\" + f.getInode();\n-\t\t\t\tList<Contentlet> contentList = APILocator.getContentletAPI()\n+\t\t\t\tfinal String luceneQuery = \"+conFolder:\" + folder.getInode();\n+\t\t\t\tfinal List<Contentlet> contentList = APILocator.getContentletAPI()\n \t\t\t\t\t\t.search(luceneQuery, 0, 0, null, user, false);\n-\t\t\t\tfor (Contentlet contentlet : contentList) {\n+\t\t\t\tfor (final Contentlet contentlet : contentList) {\n \t\t\t\t\tif(publisherFilter.acceptExcludeDependencyQuery(contentlet.getIdentifier())) {\n \t\t\t\t\t\tcontents.addOrClean(contentlet.getIdentifier(), contentlet.getModDate());\n \t\t\t\t\t\tcontentsSet.add(contentlet.getIdentifier());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwNjAzNg==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424606036", "bodyText": "rename to folder", "author": "jdotcms", "createdAt": "2020-05-13T17:23:01Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -514,54 +568,67 @@ private void setFolderDependencies() {\n \t * @throws DotDataException\n \t * @throws DotSecurityException\n \t */\n-\tprivate void setFolderListDependencies(List<Folder> folderList) throws DotIdentifierStateException, DotDataException, DotSecurityException {\n+\tprivate void setFolderListDependencies(final List<Folder> folderList, final PublisherFilter publisherFilter) throws DotIdentifierStateException, DotDataException, DotSecurityException {\n \t\tfor (Folder f : folderList) {\n \n \t\t\t// Add folder even if empty\n-\t\t\tfolders.addOrClean( f.getInode(), f.getModDate());\n-\t\t\tfoldersSet.add(f.getInode());\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n+\t\t\t\tfolders.addOrClean(f.getInode(), f.getModDate());\n+\t\t\t\tfoldersSet.add(f.getInode());\n+\t\t\t}\n \n \t\t\t// Host dependency\n-\t\t\tHost h = APILocator.getHostAPI().find(f.getHostId(), user, false);\n-\t\t\thosts.addOrClean( f.getHostId(), h.getModDate());\n-\t\t\thostsSet.add(f.getHostId());\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\tHost h = APILocator.getHostAPI().find(f.getHostId(), user, false);\n+\t\t\t\thosts.addOrClean(f.getHostId(), h.getModDate());\n+\t\t\t\thostsSet.add(f.getHostId());\n+\t\t\t}\n \n \t\t\t// Content dependencies\n-\t\t\tString luceneQuery = \"+conFolder:\" + f.getInode();\n-\n-\t\t\tList<Contentlet> contentList = APILocator.getContentletAPI().search(luceneQuery, 0, 0, null, user, false);\n-\t\t\tfor (Contentlet contentlet : contentList) {\n-\t\t\t\tcontents.addOrClean( contentlet.getIdentifier(), contentlet.getModDate());\n-\t\t\t\tcontentsSet.add(contentlet.getIdentifier());\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType())) {\n+\t\t\t\tString luceneQuery = \"+conFolder:\" + f.getInode();\n+\t\t\t\tList<Contentlet> contentList = APILocator.getContentletAPI()\n+\t\t\t\t\t\t.search(luceneQuery, 0, 0, null, user, false);\n+\t\t\t\tfor (Contentlet contentlet : contentList) {\n+\t\t\t\t\tif(publisherFilter.acceptExcludeDependencyQuery(contentlet.getIdentifier())) {\n+\t\t\t\t\t\tcontents.addOrClean(contentlet.getIdentifier(), contentlet.getModDate());\n+\t\t\t\t\t\tcontentsSet.add(contentlet.getIdentifier());\n+\t\t\t\t\t}\n+\t\t\t\t}\n \t\t\t}\n \n \t\t\t// Menu Link dependencies\n-\n-\t\t\tList<Link> linkList = APILocator.getMenuLinkAPI().findFolderMenuLinks(f);\n-\t\t\tfor (Link link : linkList) {\n-\t\t\t\tlinks.addOrClean( link.getIdentifier(), link.getModDate());\n-\t\t\t\tlinksSet.add(link.getIdentifier());\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.LINK.getType())) {\n+\t\t\t\tList<Link> linkList = APILocator.getMenuLinkAPI().findFolderMenuLinks(f);\n+\t\t\t\tfor (Link link : linkList) {\n+\t\t\t\t\tlinks.addOrClean(link.getIdentifier(), link.getModDate());\n+\t\t\t\t\tlinksSet.add(link.getIdentifier());\n+\t\t\t\t}\n \t\t\t}\n \n \t\t\t// Structure dependencies\n-\t\t\tList<Structure> structureList = APILocator.getFolderAPI().getStructures(f, user, false);\n-\n-\t\t\tfor (Structure structure : structureList) {\n-\t\t\t\tstructures.addOrClean( structure.getInode(), structure.getModDate());\n-\t\t\t\tstructuresSet.add(structure.getInode());\n-\t\t\t}\n+\t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENT_TYPE.getType())) {\n+\t\t\t\tList<Structure> structureList = APILocator.getFolderAPI()\n+\t\t\t\t\t\t.getStructures(f, user, false);\n+\t\t\t\tfor (Structure structure : structureList) {\n+\t\t\t\t\tcontentTypes.addOrClean(structure.getInode(), structure.getModDate());\n+\t\t\t\t\tcontentTypesSet.add(structure.getInode());\n+\t\t\t\t}\n \n-\t\t\t//Add the default structure of this folder\n-\t\t\tif ( f.getDefaultFileType() != null ) {\n-\t\t\t\tStructure defaultStructure = CacheLocator.getContentTypeCache().getStructureByInode( f.getDefaultFileType() );\n-\t\t\t\tif ( (defaultStructure != null && InodeUtils.isSet( defaultStructure.getInode() ))\n-\t\t\t\t\t\t&& !structuresSet.contains( defaultStructure.getInode() ) ) {\n-\t\t\t\t\tstructures.addOrClean( defaultStructure.getInode(), defaultStructure.getModDate() );\n-\t\t\t\t\tstructuresSet.add( defaultStructure.getInode() );\n+\t\t\t\t//Add the default structure of this folder\n+\t\t\t\tif (f.getDefaultFileType() != null) {\n+\t\t\t\t\tStructure defaultStructure = CacheLocator.getContentTypeCache()", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -569,27 +569,27 @@ public class DependencyManager {\n \t * @throws DotSecurityException\n \t */\n \tprivate void setFolderListDependencies(final List<Folder> folderList, final PublisherFilter publisherFilter) throws DotIdentifierStateException, DotDataException, DotSecurityException {\n-\t\tfor (Folder f : folderList) {\n+\t\tfor (final Folder folder : folderList) {\n \n \t\t\t// Add folder even if empty\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n-\t\t\t\tfolders.addOrClean(f.getInode(), f.getModDate());\n-\t\t\t\tfoldersSet.add(f.getInode());\n+\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n+\t\t\t\tfoldersSet.add(folder.getInode());\n \t\t\t}\n \n \t\t\t// Host dependency\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\tHost h = APILocator.getHostAPI().find(f.getHostId(), user, false);\n-\t\t\t\thosts.addOrClean(f.getHostId(), h.getModDate());\n-\t\t\t\thostsSet.add(f.getHostId());\n+\t\t\t\tfinal Host host = APILocator.getHostAPI().find(folder.getHostId(), user, false);\n+\t\t\t\thosts.addOrClean(folder.getHostId(), host.getModDate());\n+\t\t\t\thostsSet.add(folder.getHostId());\n \t\t\t}\n \n \t\t\t// Content dependencies\n \t\t\tif(publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENTLET.getType())) {\n-\t\t\t\tString luceneQuery = \"+conFolder:\" + f.getInode();\n-\t\t\t\tList<Contentlet> contentList = APILocator.getContentletAPI()\n+\t\t\t\tfinal String luceneQuery = \"+conFolder:\" + folder.getInode();\n+\t\t\t\tfinal List<Contentlet> contentList = APILocator.getContentletAPI()\n \t\t\t\t\t\t.search(luceneQuery, 0, 0, null, user, false);\n-\t\t\t\tfor (Contentlet contentlet : contentList) {\n+\t\t\t\tfor (final Contentlet contentlet : contentList) {\n \t\t\t\t\tif(publisherFilter.acceptExcludeDependencyQuery(contentlet.getIdentifier())) {\n \t\t\t\t\t\tcontents.addOrClean(contentlet.getIdentifier(), contentlet.getModDate());\n \t\t\t\t\t\tcontentsSet.add(contentlet.getIdentifier());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwNjMwNw==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424606307", "bodyText": "rename to identifier", "author": "jdotcms", "createdAt": "2020-05-13T17:23:27Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -621,119 +688,155 @@ private void setHTMLPagesDependencies(Set<String> idsToWork) {\n \t\t\t\tIdentifier iden = idenAPI.find(pageId);", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -680,24 +680,24 @@ public class DependencyManager {\n \n \t\ttry {\n \n-\t\t\tIdentifierAPI idenAPI = APILocator.getIdentifierAPI();\n-\t\t\tFolderAPI folderAPI = APILocator.getFolderAPI();\n-\t\t\tSet<Container> containerList = new HashSet<>();\n+\t\t\tfinal IdentifierAPI idenAPI = APILocator.getIdentifierAPI();\n+\t\t\tfinal FolderAPI folderAPI = APILocator.getFolderAPI();\n+\t\t\tfinal Set<Container> containerList = new HashSet<>();\n \n-\t\t\tfor (String pageId : idsToWork) {\n-\t\t\t\tIdentifier iden = idenAPI.find(pageId);\n+\t\t\tfor (final String pageId : idsToWork) {\n+\t\t\t\tfinal Identifier identifier = idenAPI.find(pageId);\n \n \t\t\t\t// Host dependency\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n-\t\t\t\t\thosts.addOrClean(iden.getHostId(), h.getModDate());\n-\t\t\t\t\thostsSet.add(iden.getHostId());\n+\t\t\t\t\tfinal Host host = APILocator.getHostAPI().find(identifier.getHostId(), user, false);\n+\t\t\t\t\thosts.addOrClean(identifier.getHostId(), host.getModDate());\n+\t\t\t\t\thostsSet.add(identifier.getHostId());\n \t\t\t\t}\n \n \t\t\t\t// Folder dependencies\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n-\t\t\t\t\tFolder folder = folderAPI\n-\t\t\t\t\t\t\t.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n+\t\t\t\t\tfinal Folder folder = folderAPI\n+\t\t\t\t\t\t\t.findFolderByPath(identifier.getParentPath(), identifier.getHostId(), user, false);\n \t\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n \t\t\t\t\tfoldersSet.add(folder.getInode());\n \t\t\t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwNjU2MA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424606560", "bodyText": "rename to\nfinal Host host", "author": "jdotcms", "createdAt": "2020-05-13T17:23:51Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -621,119 +688,155 @@ private void setHTMLPagesDependencies(Set<String> idsToWork) {\n \t\t\t\tIdentifier iden = idenAPI.find(pageId);\n \n \t\t\t\t// Host dependency\n-\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n-\t\t\t\thosts.addOrClean( iden.getHostId(), h.getModDate());\n-\t\t\t\thostsSet.add(iden.getHostId());\n-\t\t\t\tFolder folder = folderAPI.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n-\t\t\t\tfolders.addOrClean( folder.getInode(), folder.getModDate());\n-\t\t\t\tfoldersSet.add(folder.getInode());\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -680,24 +680,24 @@ public class DependencyManager {\n \n \t\ttry {\n \n-\t\t\tIdentifierAPI idenAPI = APILocator.getIdentifierAPI();\n-\t\t\tFolderAPI folderAPI = APILocator.getFolderAPI();\n-\t\t\tSet<Container> containerList = new HashSet<>();\n+\t\t\tfinal IdentifierAPI idenAPI = APILocator.getIdentifierAPI();\n+\t\t\tfinal FolderAPI folderAPI = APILocator.getFolderAPI();\n+\t\t\tfinal Set<Container> containerList = new HashSet<>();\n \n-\t\t\tfor (String pageId : idsToWork) {\n-\t\t\t\tIdentifier iden = idenAPI.find(pageId);\n+\t\t\tfor (final String pageId : idsToWork) {\n+\t\t\t\tfinal Identifier identifier = idenAPI.find(pageId);\n \n \t\t\t\t// Host dependency\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n-\t\t\t\t\thosts.addOrClean(iden.getHostId(), h.getModDate());\n-\t\t\t\t\thostsSet.add(iden.getHostId());\n+\t\t\t\t\tfinal Host host = APILocator.getHostAPI().find(identifier.getHostId(), user, false);\n+\t\t\t\t\thosts.addOrClean(identifier.getHostId(), host.getModDate());\n+\t\t\t\t\thostsSet.add(identifier.getHostId());\n \t\t\t\t}\n \n \t\t\t\t// Folder dependencies\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n-\t\t\t\t\tFolder folder = folderAPI\n-\t\t\t\t\t\t\t.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n+\t\t\t\t\tfinal Folder folder = folderAPI\n+\t\t\t\t\t\t\t.findFolderByPath(identifier.getParentPath(), identifier.getHostId(), user, false);\n \t\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n \t\t\t\t\tfoldersSet.add(folder.getInode());\n \t\t\t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwNjY5MQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424606691", "bodyText": "set to final", "author": "jdotcms", "createdAt": "2020-05-13T17:24:05Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -621,119 +688,155 @@ private void setHTMLPagesDependencies(Set<String> idsToWork) {\n \t\t\t\tIdentifier iden = idenAPI.find(pageId);\n \n \t\t\t\t// Host dependency\n-\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n-\t\t\t\thosts.addOrClean( iden.getHostId(), h.getModDate());\n-\t\t\t\thostsSet.add(iden.getHostId());\n-\t\t\t\tFolder folder = folderAPI.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n-\t\t\t\tfolders.addOrClean( folder.getInode(), folder.getModDate());\n-\t\t\t\tfoldersSet.add(folder.getInode());\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n+\t\t\t\t\thosts.addOrClean(iden.getHostId(), h.getModDate());\n+\t\t\t\t\thostsSet.add(iden.getHostId());\n+\t\t\t\t}\n \n+\t\t\t\t// Folder dependencies\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n+\t\t\t\t\tFolder folder = folderAPI", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -680,24 +680,24 @@ public class DependencyManager {\n \n \t\ttry {\n \n-\t\t\tIdentifierAPI idenAPI = APILocator.getIdentifierAPI();\n-\t\t\tFolderAPI folderAPI = APILocator.getFolderAPI();\n-\t\t\tSet<Container> containerList = new HashSet<>();\n+\t\t\tfinal IdentifierAPI idenAPI = APILocator.getIdentifierAPI();\n+\t\t\tfinal FolderAPI folderAPI = APILocator.getFolderAPI();\n+\t\t\tfinal Set<Container> containerList = new HashSet<>();\n \n-\t\t\tfor (String pageId : idsToWork) {\n-\t\t\t\tIdentifier iden = idenAPI.find(pageId);\n+\t\t\tfor (final String pageId : idsToWork) {\n+\t\t\t\tfinal Identifier identifier = idenAPI.find(pageId);\n \n \t\t\t\t// Host dependency\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n-\t\t\t\t\thosts.addOrClean(iden.getHostId(), h.getModDate());\n-\t\t\t\t\thostsSet.add(iden.getHostId());\n+\t\t\t\t\tfinal Host host = APILocator.getHostAPI().find(identifier.getHostId(), user, false);\n+\t\t\t\t\thosts.addOrClean(identifier.getHostId(), host.getModDate());\n+\t\t\t\t\thostsSet.add(identifier.getHostId());\n \t\t\t\t}\n \n \t\t\t\t// Folder dependencies\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n-\t\t\t\t\tFolder folder = folderAPI\n-\t\t\t\t\t\t\t.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n+\t\t\t\t\tfinal Folder folder = folderAPI\n+\t\t\t\t\t\t\t.findFolderByPath(identifier.getParentPath(), identifier.getHostId(), user, false);\n \t\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n \t\t\t\t\tfoldersSet.add(folder.getInode());\n \t\t\t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwNzExOA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424607118", "bodyText": "Logger should use the supplier such as\nLogger.debug (this, ()->e.getMessage(), e)", "author": "jdotcms", "createdAt": "2020-05-13T17:24:48Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -621,119 +688,155 @@ private void setHTMLPagesDependencies(Set<String> idsToWork) {\n \t\t\t\tIdentifier iden = idenAPI.find(pageId);\n \n \t\t\t\t// Host dependency\n-\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n-\t\t\t\thosts.addOrClean( iden.getHostId(), h.getModDate());\n-\t\t\t\thostsSet.add(iden.getHostId());\n-\t\t\t\tFolder folder = folderAPI.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n-\t\t\t\tfolders.addOrClean( folder.getInode(), folder.getModDate());\n-\t\t\t\tfoldersSet.add(folder.getInode());\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n+\t\t\t\t\thosts.addOrClean(iden.getHostId(), h.getModDate());\n+\t\t\t\t\thostsSet.add(iden.getHostId());\n+\t\t\t\t}\n \n+\t\t\t\t// Folder dependencies\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n+\t\t\t\t\tFolder folder = folderAPI\n+\t\t\t\t\t\t\t.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n+\t\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n+\t\t\t\t\tfoldersSet.add(folder.getInode());\n+\t\t\t\t}\n \n \t\t\t\t// looking for working version (must exists)\n \t\t\t\tIHTMLPage workingPage = null;\n \n \t\t\t\tContentlet contentlet = null;\n-\t\t\t\ttry{\n-\t\t\t\t\tcontentlet = APILocator.getContentletAPI().search(\"+identifier:\"+pageId+\" +working:true\", 0, 0, \"moddate\", user, false).get(0);\n+\t\t\t\ttry {\n+\t\t\t\t\tcontentlet = APILocator.getContentletAPI()\n+\t\t\t\t\t\t\t.search(\"+identifier:\" + pageId + \" +working:true\", 0, 0, \"moddate\",\n+\t\t\t\t\t\t\t\t\tuser, false).get(0);\n \t\t\t\t} catch (DotContentletStateException e) {\n \t\t\t\t\t// content not found message is already displayed on console\n-\t\t\t\t\tLogger.debug(this, e.getMessage(),e);\n+\t\t\t\t\tLogger.debug(this, e.getMessage(), e);", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -680,24 +680,24 @@ public class DependencyManager {\n \n \t\ttry {\n \n-\t\t\tIdentifierAPI idenAPI = APILocator.getIdentifierAPI();\n-\t\t\tFolderAPI folderAPI = APILocator.getFolderAPI();\n-\t\t\tSet<Container> containerList = new HashSet<>();\n+\t\t\tfinal IdentifierAPI idenAPI = APILocator.getIdentifierAPI();\n+\t\t\tfinal FolderAPI folderAPI = APILocator.getFolderAPI();\n+\t\t\tfinal Set<Container> containerList = new HashSet<>();\n \n-\t\t\tfor (String pageId : idsToWork) {\n-\t\t\t\tIdentifier iden = idenAPI.find(pageId);\n+\t\t\tfor (final String pageId : idsToWork) {\n+\t\t\t\tfinal Identifier identifier = idenAPI.find(pageId);\n \n \t\t\t\t// Host dependency\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n-\t\t\t\t\thosts.addOrClean(iden.getHostId(), h.getModDate());\n-\t\t\t\t\thostsSet.add(iden.getHostId());\n+\t\t\t\t\tfinal Host host = APILocator.getHostAPI().find(identifier.getHostId(), user, false);\n+\t\t\t\t\thosts.addOrClean(identifier.getHostId(), host.getModDate());\n+\t\t\t\t\thostsSet.add(identifier.getHostId());\n \t\t\t\t}\n \n \t\t\t\t// Folder dependencies\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n-\t\t\t\t\tFolder folder = folderAPI\n-\t\t\t\t\t\t\t.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n+\t\t\t\t\tfinal Folder folder = folderAPI\n+\t\t\t\t\t\t\t.findFolderByPath(identifier.getParentPath(), identifier.getHostId(), user, false);\n \t\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n \t\t\t\t\tfoldersSet.add(folder.getInode());\n \t\t\t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwNzQwMA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424607400", "bodyText": "set to final", "author": "jdotcms", "createdAt": "2020-05-13T17:25:13Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -621,119 +688,155 @@ private void setHTMLPagesDependencies(Set<String> idsToWork) {\n \t\t\t\tIdentifier iden = idenAPI.find(pageId);\n \n \t\t\t\t// Host dependency\n-\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n-\t\t\t\thosts.addOrClean( iden.getHostId(), h.getModDate());\n-\t\t\t\thostsSet.add(iden.getHostId());\n-\t\t\t\tFolder folder = folderAPI.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n-\t\t\t\tfolders.addOrClean( folder.getInode(), folder.getModDate());\n-\t\t\t\tfoldersSet.add(folder.getInode());\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n+\t\t\t\t\thosts.addOrClean(iden.getHostId(), h.getModDate());\n+\t\t\t\t\thostsSet.add(iden.getHostId());\n+\t\t\t\t}\n \n+\t\t\t\t// Folder dependencies\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n+\t\t\t\t\tFolder folder = folderAPI\n+\t\t\t\t\t\t\t.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n+\t\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n+\t\t\t\t\tfoldersSet.add(folder.getInode());\n+\t\t\t\t}\n \n \t\t\t\t// looking for working version (must exists)\n \t\t\t\tIHTMLPage workingPage = null;\n \n \t\t\t\tContentlet contentlet = null;\n-\t\t\t\ttry{\n-\t\t\t\t\tcontentlet = APILocator.getContentletAPI().search(\"+identifier:\"+pageId+\" +working:true\", 0, 0, \"moddate\", user, false).get(0);\n+\t\t\t\ttry {\n+\t\t\t\t\tcontentlet = APILocator.getContentletAPI()\n+\t\t\t\t\t\t\t.search(\"+identifier:\" + pageId + \" +working:true\", 0, 0, \"moddate\",\n+\t\t\t\t\t\t\t\t\tuser, false).get(0);\n \t\t\t\t} catch (DotContentletStateException e) {\n \t\t\t\t\t// content not found message is already displayed on console\n-\t\t\t\t\tLogger.debug(this, e.getMessage(),e);\n+\t\t\t\t\tLogger.debug(this, e.getMessage(), e);\n \t\t\t\t}\n-\t\t\t\tif(contentlet != null)\n+\t\t\t\tif (contentlet != null)\n \t\t\t\t\tworkingPage = APILocator.getHTMLPageAssetAPI().fromContentlet(contentlet);\n \n-\n \t\t\t\t// looking for live version (might not exists)\n \t\t\t\tIHTMLPage livePage = null;\n \n \t\t\t\tcontentlet = null;\n-\t\t\t\ttry{\n-\t\t\t\t\tList<Contentlet> result = APILocator.getContentletAPI().search(\"+identifier:\"+pageId+\" +live:true\", 0, 0, \"moddate\", user, false);\n-\t\t\t\t\tif(!result.isEmpty()) {\n+\t\t\t\ttry {\n+\t\t\t\t\tList<Contentlet> result = APILocator.getContentletAPI()", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -680,24 +680,24 @@ public class DependencyManager {\n \n \t\ttry {\n \n-\t\t\tIdentifierAPI idenAPI = APILocator.getIdentifierAPI();\n-\t\t\tFolderAPI folderAPI = APILocator.getFolderAPI();\n-\t\t\tSet<Container> containerList = new HashSet<>();\n+\t\t\tfinal IdentifierAPI idenAPI = APILocator.getIdentifierAPI();\n+\t\t\tfinal FolderAPI folderAPI = APILocator.getFolderAPI();\n+\t\t\tfinal Set<Container> containerList = new HashSet<>();\n \n-\t\t\tfor (String pageId : idsToWork) {\n-\t\t\t\tIdentifier iden = idenAPI.find(pageId);\n+\t\t\tfor (final String pageId : idsToWork) {\n+\t\t\t\tfinal Identifier identifier = idenAPI.find(pageId);\n \n \t\t\t\t// Host dependency\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n-\t\t\t\t\thosts.addOrClean(iden.getHostId(), h.getModDate());\n-\t\t\t\t\thostsSet.add(iden.getHostId());\n+\t\t\t\t\tfinal Host host = APILocator.getHostAPI().find(identifier.getHostId(), user, false);\n+\t\t\t\t\thosts.addOrClean(identifier.getHostId(), host.getModDate());\n+\t\t\t\t\thostsSet.add(identifier.getHostId());\n \t\t\t\t}\n \n \t\t\t\t// Folder dependencies\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n-\t\t\t\t\tFolder folder = folderAPI\n-\t\t\t\t\t\t\t.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n+\t\t\t\t\tfinal Folder folder = folderAPI\n+\t\t\t\t\t\t\t.findFolderByPath(identifier.getParentPath(), identifier.getHostId(), user, false);\n \t\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n \t\t\t\t\tfoldersSet.add(folder.getInode());\n \t\t\t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwNzUzNw==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424607537", "bodyText": "same Logger comment", "author": "jdotcms", "createdAt": "2020-05-13T17:25:28Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -621,119 +688,155 @@ private void setHTMLPagesDependencies(Set<String> idsToWork) {\n \t\t\t\tIdentifier iden = idenAPI.find(pageId);\n \n \t\t\t\t// Host dependency\n-\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n-\t\t\t\thosts.addOrClean( iden.getHostId(), h.getModDate());\n-\t\t\t\thostsSet.add(iden.getHostId());\n-\t\t\t\tFolder folder = folderAPI.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n-\t\t\t\tfolders.addOrClean( folder.getInode(), folder.getModDate());\n-\t\t\t\tfoldersSet.add(folder.getInode());\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n+\t\t\t\t\thosts.addOrClean(iden.getHostId(), h.getModDate());\n+\t\t\t\t\thostsSet.add(iden.getHostId());\n+\t\t\t\t}\n \n+\t\t\t\t// Folder dependencies\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n+\t\t\t\t\tFolder folder = folderAPI\n+\t\t\t\t\t\t\t.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n+\t\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n+\t\t\t\t\tfoldersSet.add(folder.getInode());\n+\t\t\t\t}\n \n \t\t\t\t// looking for working version (must exists)\n \t\t\t\tIHTMLPage workingPage = null;\n \n \t\t\t\tContentlet contentlet = null;\n-\t\t\t\ttry{\n-\t\t\t\t\tcontentlet = APILocator.getContentletAPI().search(\"+identifier:\"+pageId+\" +working:true\", 0, 0, \"moddate\", user, false).get(0);\n+\t\t\t\ttry {\n+\t\t\t\t\tcontentlet = APILocator.getContentletAPI()\n+\t\t\t\t\t\t\t.search(\"+identifier:\" + pageId + \" +working:true\", 0, 0, \"moddate\",\n+\t\t\t\t\t\t\t\t\tuser, false).get(0);\n \t\t\t\t} catch (DotContentletStateException e) {\n \t\t\t\t\t// content not found message is already displayed on console\n-\t\t\t\t\tLogger.debug(this, e.getMessage(),e);\n+\t\t\t\t\tLogger.debug(this, e.getMessage(), e);\n \t\t\t\t}\n-\t\t\t\tif(contentlet != null)\n+\t\t\t\tif (contentlet != null)\n \t\t\t\t\tworkingPage = APILocator.getHTMLPageAssetAPI().fromContentlet(contentlet);\n \n-\n \t\t\t\t// looking for live version (might not exists)\n \t\t\t\tIHTMLPage livePage = null;\n \n \t\t\t\tcontentlet = null;\n-\t\t\t\ttry{\n-\t\t\t\t\tList<Contentlet> result = APILocator.getContentletAPI().search(\"+identifier:\"+pageId+\" +live:true\", 0, 0, \"moddate\", user, false);\n-\t\t\t\t\tif(!result.isEmpty()) {\n+\t\t\t\ttry {\n+\t\t\t\t\tList<Contentlet> result = APILocator.getContentletAPI()\n+\t\t\t\t\t\t\t.search(\"+identifier:\" + pageId + \" +live:true\", 0, 0, \"moddate\", user,\n+\t\t\t\t\t\t\t\t\tfalse);\n+\t\t\t\t\tif (!result.isEmpty()) {\n \t\t\t\t\t\tcontentlet = result.get(0);\n \t\t\t\t\t}\n \n \t\t\t\t} catch (DotContentletStateException e) {\n \t\t\t\t\t// content not found message is already displayed on console\n-\t\t\t\t\tLogger.debug(this, e.getMessage(),e);\n+\t\t\t\t\tLogger.debug(this, e.getMessage(), e);", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -680,24 +680,24 @@ public class DependencyManager {\n \n \t\ttry {\n \n-\t\t\tIdentifierAPI idenAPI = APILocator.getIdentifierAPI();\n-\t\t\tFolderAPI folderAPI = APILocator.getFolderAPI();\n-\t\t\tSet<Container> containerList = new HashSet<>();\n+\t\t\tfinal IdentifierAPI idenAPI = APILocator.getIdentifierAPI();\n+\t\t\tfinal FolderAPI folderAPI = APILocator.getFolderAPI();\n+\t\t\tfinal Set<Container> containerList = new HashSet<>();\n \n-\t\t\tfor (String pageId : idsToWork) {\n-\t\t\t\tIdentifier iden = idenAPI.find(pageId);\n+\t\t\tfor (final String pageId : idsToWork) {\n+\t\t\t\tfinal Identifier identifier = idenAPI.find(pageId);\n \n \t\t\t\t// Host dependency\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n-\t\t\t\t\thosts.addOrClean(iden.getHostId(), h.getModDate());\n-\t\t\t\t\thostsSet.add(iden.getHostId());\n+\t\t\t\t\tfinal Host host = APILocator.getHostAPI().find(identifier.getHostId(), user, false);\n+\t\t\t\t\thosts.addOrClean(identifier.getHostId(), host.getModDate());\n+\t\t\t\t\thostsSet.add(identifier.getHostId());\n \t\t\t\t}\n \n \t\t\t\t// Folder dependencies\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n-\t\t\t\t\tFolder folder = folderAPI\n-\t\t\t\t\t\t\t.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n+\t\t\t\t\tfinal Folder folder = folderAPI\n+\t\t\t\t\t\t\t.findFolderByPath(identifier.getParentPath(), identifier.getHostId(), user, false);\n \t\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n \t\t\t\t\tfoldersSet.add(folder.getInode());\n \t\t\t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwNzY3OA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424607678", "bodyText": "use curly brackets", "author": "jdotcms", "createdAt": "2020-05-13T17:25:43Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -621,119 +688,155 @@ private void setHTMLPagesDependencies(Set<String> idsToWork) {\n \t\t\t\tIdentifier iden = idenAPI.find(pageId);\n \n \t\t\t\t// Host dependency\n-\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n-\t\t\t\thosts.addOrClean( iden.getHostId(), h.getModDate());\n-\t\t\t\thostsSet.add(iden.getHostId());\n-\t\t\t\tFolder folder = folderAPI.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n-\t\t\t\tfolders.addOrClean( folder.getInode(), folder.getModDate());\n-\t\t\t\tfoldersSet.add(folder.getInode());\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n+\t\t\t\t\thosts.addOrClean(iden.getHostId(), h.getModDate());\n+\t\t\t\t\thostsSet.add(iden.getHostId());\n+\t\t\t\t}\n \n+\t\t\t\t// Folder dependencies\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n+\t\t\t\t\tFolder folder = folderAPI\n+\t\t\t\t\t\t\t.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n+\t\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n+\t\t\t\t\tfoldersSet.add(folder.getInode());\n+\t\t\t\t}\n \n \t\t\t\t// looking for working version (must exists)\n \t\t\t\tIHTMLPage workingPage = null;\n \n \t\t\t\tContentlet contentlet = null;\n-\t\t\t\ttry{\n-\t\t\t\t\tcontentlet = APILocator.getContentletAPI().search(\"+identifier:\"+pageId+\" +working:true\", 0, 0, \"moddate\", user, false).get(0);\n+\t\t\t\ttry {\n+\t\t\t\t\tcontentlet = APILocator.getContentletAPI()\n+\t\t\t\t\t\t\t.search(\"+identifier:\" + pageId + \" +working:true\", 0, 0, \"moddate\",\n+\t\t\t\t\t\t\t\t\tuser, false).get(0);\n \t\t\t\t} catch (DotContentletStateException e) {\n \t\t\t\t\t// content not found message is already displayed on console\n-\t\t\t\t\tLogger.debug(this, e.getMessage(),e);\n+\t\t\t\t\tLogger.debug(this, e.getMessage(), e);\n \t\t\t\t}\n-\t\t\t\tif(contentlet != null)\n+\t\t\t\tif (contentlet != null)\n \t\t\t\t\tworkingPage = APILocator.getHTMLPageAssetAPI().fromContentlet(contentlet);\n \n-\n \t\t\t\t// looking for live version (might not exists)\n \t\t\t\tIHTMLPage livePage = null;\n \n \t\t\t\tcontentlet = null;\n-\t\t\t\ttry{\n-\t\t\t\t\tList<Contentlet> result = APILocator.getContentletAPI().search(\"+identifier:\"+pageId+\" +live:true\", 0, 0, \"moddate\", user, false);\n-\t\t\t\t\tif(!result.isEmpty()) {\n+\t\t\t\ttry {\n+\t\t\t\t\tList<Contentlet> result = APILocator.getContentletAPI()\n+\t\t\t\t\t\t\t.search(\"+identifier:\" + pageId + \" +live:true\", 0, 0, \"moddate\", user,\n+\t\t\t\t\t\t\t\t\tfalse);\n+\t\t\t\t\tif (!result.isEmpty()) {\n \t\t\t\t\t\tcontentlet = result.get(0);\n \t\t\t\t\t}\n \n \t\t\t\t} catch (DotContentletStateException e) {\n \t\t\t\t\t// content not found message is already displayed on console\n-\t\t\t\t\tLogger.debug(this, e.getMessage(),e);\n+\t\t\t\t\tLogger.debug(this, e.getMessage(), e);\n \t\t\t\t}\n-\t\t\t\tif(contentlet != null)\n-\t\t\t\t\tlivePage = APILocator.getHTMLPageAssetAPI().fromContentlet(contentlet); \n-\n+\t\t\t\tif (contentlet != null)", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -680,24 +680,24 @@ public class DependencyManager {\n \n \t\ttry {\n \n-\t\t\tIdentifierAPI idenAPI = APILocator.getIdentifierAPI();\n-\t\t\tFolderAPI folderAPI = APILocator.getFolderAPI();\n-\t\t\tSet<Container> containerList = new HashSet<>();\n+\t\t\tfinal IdentifierAPI idenAPI = APILocator.getIdentifierAPI();\n+\t\t\tfinal FolderAPI folderAPI = APILocator.getFolderAPI();\n+\t\t\tfinal Set<Container> containerList = new HashSet<>();\n \n-\t\t\tfor (String pageId : idsToWork) {\n-\t\t\t\tIdentifier iden = idenAPI.find(pageId);\n+\t\t\tfor (final String pageId : idsToWork) {\n+\t\t\t\tfinal Identifier identifier = idenAPI.find(pageId);\n \n \t\t\t\t// Host dependency\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n-\t\t\t\t\thosts.addOrClean(iden.getHostId(), h.getModDate());\n-\t\t\t\t\thostsSet.add(iden.getHostId());\n+\t\t\t\t\tfinal Host host = APILocator.getHostAPI().find(identifier.getHostId(), user, false);\n+\t\t\t\t\thosts.addOrClean(identifier.getHostId(), host.getModDate());\n+\t\t\t\t\thostsSet.add(identifier.getHostId());\n \t\t\t\t}\n \n \t\t\t\t// Folder dependencies\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n-\t\t\t\t\tFolder folder = folderAPI\n-\t\t\t\t\t\t\t.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n+\t\t\t\t\tfinal Folder folder = folderAPI\n+\t\t\t\t\t\t\t.findFolderByPath(identifier.getParentPath(), identifier.getHostId(), user, false);\n \t\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n \t\t\t\t\tfoldersSet.add(folder.getInode());\n \t\t\t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwODExMA==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424608110", "bodyText": "set to final", "author": "jdotcms", "createdAt": "2020-05-13T17:26:25Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -621,119 +688,155 @@ private void setHTMLPagesDependencies(Set<String> idsToWork) {\n \t\t\t\tIdentifier iden = idenAPI.find(pageId);\n \n \t\t\t\t// Host dependency\n-\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n-\t\t\t\thosts.addOrClean( iden.getHostId(), h.getModDate());\n-\t\t\t\thostsSet.add(iden.getHostId());\n-\t\t\t\tFolder folder = folderAPI.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n-\t\t\t\tfolders.addOrClean( folder.getInode(), folder.getModDate());\n-\t\t\t\tfoldersSet.add(folder.getInode());\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n+\t\t\t\t\thosts.addOrClean(iden.getHostId(), h.getModDate());\n+\t\t\t\t\thostsSet.add(iden.getHostId());\n+\t\t\t\t}\n \n+\t\t\t\t// Folder dependencies\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n+\t\t\t\t\tFolder folder = folderAPI\n+\t\t\t\t\t\t\t.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n+\t\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n+\t\t\t\t\tfoldersSet.add(folder.getInode());\n+\t\t\t\t}\n \n \t\t\t\t// looking for working version (must exists)\n \t\t\t\tIHTMLPage workingPage = null;\n \n \t\t\t\tContentlet contentlet = null;\n-\t\t\t\ttry{\n-\t\t\t\t\tcontentlet = APILocator.getContentletAPI().search(\"+identifier:\"+pageId+\" +working:true\", 0, 0, \"moddate\", user, false).get(0);\n+\t\t\t\ttry {\n+\t\t\t\t\tcontentlet = APILocator.getContentletAPI()\n+\t\t\t\t\t\t\t.search(\"+identifier:\" + pageId + \" +working:true\", 0, 0, \"moddate\",\n+\t\t\t\t\t\t\t\t\tuser, false).get(0);\n \t\t\t\t} catch (DotContentletStateException e) {\n \t\t\t\t\t// content not found message is already displayed on console\n-\t\t\t\t\tLogger.debug(this, e.getMessage(),e);\n+\t\t\t\t\tLogger.debug(this, e.getMessage(), e);\n \t\t\t\t}\n-\t\t\t\tif(contentlet != null)\n+\t\t\t\tif (contentlet != null)\n \t\t\t\t\tworkingPage = APILocator.getHTMLPageAssetAPI().fromContentlet(contentlet);\n \n-\n \t\t\t\t// looking for live version (might not exists)\n \t\t\t\tIHTMLPage livePage = null;\n \n \t\t\t\tcontentlet = null;\n-\t\t\t\ttry{\n-\t\t\t\t\tList<Contentlet> result = APILocator.getContentletAPI().search(\"+identifier:\"+pageId+\" +live:true\", 0, 0, \"moddate\", user, false);\n-\t\t\t\t\tif(!result.isEmpty()) {\n+\t\t\t\ttry {\n+\t\t\t\t\tList<Contentlet> result = APILocator.getContentletAPI()\n+\t\t\t\t\t\t\t.search(\"+identifier:\" + pageId + \" +live:true\", 0, 0, \"moddate\", user,\n+\t\t\t\t\t\t\t\t\tfalse);\n+\t\t\t\t\tif (!result.isEmpty()) {\n \t\t\t\t\t\tcontentlet = result.get(0);\n \t\t\t\t\t}\n \n \t\t\t\t} catch (DotContentletStateException e) {\n \t\t\t\t\t// content not found message is already displayed on console\n-\t\t\t\t\tLogger.debug(this, e.getMessage(),e);\n+\t\t\t\t\tLogger.debug(this, e.getMessage(), e);\n \t\t\t\t}\n-\t\t\t\tif(contentlet != null)\n-\t\t\t\t\tlivePage = APILocator.getHTMLPageAssetAPI().fromContentlet(contentlet); \n-\n+\t\t\t\tif (contentlet != null)\n+\t\t\t\t\tlivePage = APILocator.getHTMLPageAssetAPI().fromContentlet(contentlet);\n \n \t\t\t\t// working template working page\n \t\t\t\tTemplate workingTemplateWP = null;\n \t\t\t\t// live template working page\n \t\t\t\tTemplate liveTemplateWP = null;\n \n-\t\t\t\tif(workingPage!=null) {\n-\t\t\t\t\tworkingTemplateWP = APILocator.getTemplateAPI().findWorkingTemplate(workingPage.getTemplateId(), user, false);\n-\t\t\t\t\tliveTemplateWP = APILocator.getTemplateAPI().findLiveTemplate(workingPage.getTemplateId(), user, false);\n+\t\t\t\tif (workingPage != null) {\n+\t\t\t\t\tworkingTemplateWP = APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.findWorkingTemplate(workingPage.getTemplateId(), user, false);\n+\t\t\t\t\tliveTemplateWP = APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.findLiveTemplate(workingPage.getTemplateId(), user, false);\n \t\t\t\t\t// Templates dependencies\n-\t\t\t\t\ttemplates.addOrClean( workingPage.getTemplateId(), workingTemplateWP.getModDate());\n-\t\t\t\t\ttemplatesSet.add(workingPage.getTemplateId());\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.TEMPLATE.getType())) {\n+\t\t\t\t\t\ttemplates.addOrClean(workingPage.getTemplateId(),\n+\t\t\t\t\t\t\t\tworkingTemplateWP.getModDate());\n+\t\t\t\t\t\ttemplatesSet.add(workingPage.getTemplateId());\n+\t\t\t\t\t}\n \t\t\t\t}\n \n \t\t\t\tTemplate liveTemplateLP = null;\n \n \t\t\t\t// live template live page\n-\t\t\t\tif(livePage!=null) {\n-\t\t\t\t\tliveTemplateLP = APILocator.getTemplateAPI().findLiveTemplate(livePage.getTemplateId(), user, false);\n+\t\t\t\tif (livePage != null) {\n+\t\t\t\t\tliveTemplateLP = APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.findLiveTemplate(livePage.getTemplateId(), user, false);\n \t\t\t\t\t// Templates dependencies\n-\t\t\t\t\ttemplates.addOrClean( livePage.getTemplateId(), livePage.getModDate());\n-\t\t\t\t\ttemplatesSet.add(livePage.getTemplateId());\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.TEMPLATE.getType())) {\n+\t\t\t\t\t\ttemplates.addOrClean(livePage.getTemplateId(), livePage.getModDate());\n+\t\t\t\t\t\ttemplatesSet.add(livePage.getTemplateId());\n+\t\t\t\t\t}\n \t\t\t\t}\n \n-\t\t\t\t// Containers dependencies\n \t\t\t\tcontainerList.clear();\n \n-\t\t\t\tif(workingTemplateWP!=null && InodeUtils.isSet(workingTemplateWP.getInode())){\n-\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI().getContainersInTemplate(workingTemplateWP, user, false));\n+\t\t\t\tif (workingTemplateWP != null && InodeUtils.isSet(workingTemplateWP.getInode())) {\n+\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.getContainersInTemplate(workingTemplateWP, user, false));\n \t\t\t\t}\n-\t\t\t\tif(liveTemplateWP!=null && InodeUtils.isSet(liveTemplateWP.getInode())){\n-\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI().getContainersInTemplate(liveTemplateWP, user, false));\n+\t\t\t\tif (liveTemplateWP != null && InodeUtils.isSet(liveTemplateWP.getInode())) {\n+\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.getContainersInTemplate(liveTemplateWP, user, false));\n \t\t\t\t}\n-\t\t\t\tif(liveTemplateLP!=null && InodeUtils.isSet(liveTemplateLP.getInode())){\n-\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI().getContainersInTemplate(liveTemplateLP, user, false));\n+\t\t\t\tif (liveTemplateLP != null && InodeUtils.isSet(liveTemplateLP.getInode())) {\n+\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.getContainersInTemplate(liveTemplateLP, user, false));\n \t\t\t\t}\n \n \t\t\t\tfor (Container container : containerList) {", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -680,24 +680,24 @@ public class DependencyManager {\n \n \t\ttry {\n \n-\t\t\tIdentifierAPI idenAPI = APILocator.getIdentifierAPI();\n-\t\t\tFolderAPI folderAPI = APILocator.getFolderAPI();\n-\t\t\tSet<Container> containerList = new HashSet<>();\n+\t\t\tfinal IdentifierAPI idenAPI = APILocator.getIdentifierAPI();\n+\t\t\tfinal FolderAPI folderAPI = APILocator.getFolderAPI();\n+\t\t\tfinal Set<Container> containerList = new HashSet<>();\n \n-\t\t\tfor (String pageId : idsToWork) {\n-\t\t\t\tIdentifier iden = idenAPI.find(pageId);\n+\t\t\tfor (final String pageId : idsToWork) {\n+\t\t\t\tfinal Identifier identifier = idenAPI.find(pageId);\n \n \t\t\t\t// Host dependency\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n-\t\t\t\t\thosts.addOrClean(iden.getHostId(), h.getModDate());\n-\t\t\t\t\thostsSet.add(iden.getHostId());\n+\t\t\t\t\tfinal Host host = APILocator.getHostAPI().find(identifier.getHostId(), user, false);\n+\t\t\t\t\thosts.addOrClean(identifier.getHostId(), host.getModDate());\n+\t\t\t\t\thostsSet.add(identifier.getHostId());\n \t\t\t\t}\n \n \t\t\t\t// Folder dependencies\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n-\t\t\t\t\tFolder folder = folderAPI\n-\t\t\t\t\t\t\t.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n+\t\t\t\t\tfinal Folder folder = folderAPI\n+\t\t\t\t\t\t\t.findFolderByPath(identifier.getParentPath(), identifier.getHostId(), user, false);\n \t\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n \t\t\t\t\tfoldersSet.add(folder.getInode());\n \t\t\t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwODQ5Ng==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424608496", "bodyText": "set to final\nrename to containerList", "author": "jdotcms", "createdAt": "2020-05-13T17:27:03Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -621,119 +688,155 @@ private void setHTMLPagesDependencies(Set<String> idsToWork) {\n \t\t\t\tIdentifier iden = idenAPI.find(pageId);\n \n \t\t\t\t// Host dependency\n-\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n-\t\t\t\thosts.addOrClean( iden.getHostId(), h.getModDate());\n-\t\t\t\thostsSet.add(iden.getHostId());\n-\t\t\t\tFolder folder = folderAPI.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n-\t\t\t\tfolders.addOrClean( folder.getInode(), folder.getModDate());\n-\t\t\t\tfoldersSet.add(folder.getInode());\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n+\t\t\t\t\thosts.addOrClean(iden.getHostId(), h.getModDate());\n+\t\t\t\t\thostsSet.add(iden.getHostId());\n+\t\t\t\t}\n \n+\t\t\t\t// Folder dependencies\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n+\t\t\t\t\tFolder folder = folderAPI\n+\t\t\t\t\t\t\t.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n+\t\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n+\t\t\t\t\tfoldersSet.add(folder.getInode());\n+\t\t\t\t}\n \n \t\t\t\t// looking for working version (must exists)\n \t\t\t\tIHTMLPage workingPage = null;\n \n \t\t\t\tContentlet contentlet = null;\n-\t\t\t\ttry{\n-\t\t\t\t\tcontentlet = APILocator.getContentletAPI().search(\"+identifier:\"+pageId+\" +working:true\", 0, 0, \"moddate\", user, false).get(0);\n+\t\t\t\ttry {\n+\t\t\t\t\tcontentlet = APILocator.getContentletAPI()\n+\t\t\t\t\t\t\t.search(\"+identifier:\" + pageId + \" +working:true\", 0, 0, \"moddate\",\n+\t\t\t\t\t\t\t\t\tuser, false).get(0);\n \t\t\t\t} catch (DotContentletStateException e) {\n \t\t\t\t\t// content not found message is already displayed on console\n-\t\t\t\t\tLogger.debug(this, e.getMessage(),e);\n+\t\t\t\t\tLogger.debug(this, e.getMessage(), e);\n \t\t\t\t}\n-\t\t\t\tif(contentlet != null)\n+\t\t\t\tif (contentlet != null)\n \t\t\t\t\tworkingPage = APILocator.getHTMLPageAssetAPI().fromContentlet(contentlet);\n \n-\n \t\t\t\t// looking for live version (might not exists)\n \t\t\t\tIHTMLPage livePage = null;\n \n \t\t\t\tcontentlet = null;\n-\t\t\t\ttry{\n-\t\t\t\t\tList<Contentlet> result = APILocator.getContentletAPI().search(\"+identifier:\"+pageId+\" +live:true\", 0, 0, \"moddate\", user, false);\n-\t\t\t\t\tif(!result.isEmpty()) {\n+\t\t\t\ttry {\n+\t\t\t\t\tList<Contentlet> result = APILocator.getContentletAPI()\n+\t\t\t\t\t\t\t.search(\"+identifier:\" + pageId + \" +live:true\", 0, 0, \"moddate\", user,\n+\t\t\t\t\t\t\t\t\tfalse);\n+\t\t\t\t\tif (!result.isEmpty()) {\n \t\t\t\t\t\tcontentlet = result.get(0);\n \t\t\t\t\t}\n \n \t\t\t\t} catch (DotContentletStateException e) {\n \t\t\t\t\t// content not found message is already displayed on console\n-\t\t\t\t\tLogger.debug(this, e.getMessage(),e);\n+\t\t\t\t\tLogger.debug(this, e.getMessage(), e);\n \t\t\t\t}\n-\t\t\t\tif(contentlet != null)\n-\t\t\t\t\tlivePage = APILocator.getHTMLPageAssetAPI().fromContentlet(contentlet); \n-\n+\t\t\t\tif (contentlet != null)\n+\t\t\t\t\tlivePage = APILocator.getHTMLPageAssetAPI().fromContentlet(contentlet);\n \n \t\t\t\t// working template working page\n \t\t\t\tTemplate workingTemplateWP = null;\n \t\t\t\t// live template working page\n \t\t\t\tTemplate liveTemplateWP = null;\n \n-\t\t\t\tif(workingPage!=null) {\n-\t\t\t\t\tworkingTemplateWP = APILocator.getTemplateAPI().findWorkingTemplate(workingPage.getTemplateId(), user, false);\n-\t\t\t\t\tliveTemplateWP = APILocator.getTemplateAPI().findLiveTemplate(workingPage.getTemplateId(), user, false);\n+\t\t\t\tif (workingPage != null) {\n+\t\t\t\t\tworkingTemplateWP = APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.findWorkingTemplate(workingPage.getTemplateId(), user, false);\n+\t\t\t\t\tliveTemplateWP = APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.findLiveTemplate(workingPage.getTemplateId(), user, false);\n \t\t\t\t\t// Templates dependencies\n-\t\t\t\t\ttemplates.addOrClean( workingPage.getTemplateId(), workingTemplateWP.getModDate());\n-\t\t\t\t\ttemplatesSet.add(workingPage.getTemplateId());\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.TEMPLATE.getType())) {\n+\t\t\t\t\t\ttemplates.addOrClean(workingPage.getTemplateId(),\n+\t\t\t\t\t\t\t\tworkingTemplateWP.getModDate());\n+\t\t\t\t\t\ttemplatesSet.add(workingPage.getTemplateId());\n+\t\t\t\t\t}\n \t\t\t\t}\n \n \t\t\t\tTemplate liveTemplateLP = null;\n \n \t\t\t\t// live template live page\n-\t\t\t\tif(livePage!=null) {\n-\t\t\t\t\tliveTemplateLP = APILocator.getTemplateAPI().findLiveTemplate(livePage.getTemplateId(), user, false);\n+\t\t\t\tif (livePage != null) {\n+\t\t\t\t\tliveTemplateLP = APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.findLiveTemplate(livePage.getTemplateId(), user, false);\n \t\t\t\t\t// Templates dependencies\n-\t\t\t\t\ttemplates.addOrClean( livePage.getTemplateId(), livePage.getModDate());\n-\t\t\t\t\ttemplatesSet.add(livePage.getTemplateId());\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.TEMPLATE.getType())) {\n+\t\t\t\t\t\ttemplates.addOrClean(livePage.getTemplateId(), livePage.getModDate());\n+\t\t\t\t\t\ttemplatesSet.add(livePage.getTemplateId());\n+\t\t\t\t\t}\n \t\t\t\t}\n \n-\t\t\t\t// Containers dependencies\n \t\t\t\tcontainerList.clear();\n \n-\t\t\t\tif(workingTemplateWP!=null && InodeUtils.isSet(workingTemplateWP.getInode())){\n-\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI().getContainersInTemplate(workingTemplateWP, user, false));\n+\t\t\t\tif (workingTemplateWP != null && InodeUtils.isSet(workingTemplateWP.getInode())) {\n+\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.getContainersInTemplate(workingTemplateWP, user, false));\n \t\t\t\t}\n-\t\t\t\tif(liveTemplateWP!=null && InodeUtils.isSet(liveTemplateWP.getInode())){\n-\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI().getContainersInTemplate(liveTemplateWP, user, false));\n+\t\t\t\tif (liveTemplateWP != null && InodeUtils.isSet(liveTemplateWP.getInode())) {\n+\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.getContainersInTemplate(liveTemplateWP, user, false));\n \t\t\t\t}\n-\t\t\t\tif(liveTemplateLP!=null && InodeUtils.isSet(liveTemplateLP.getInode())){\n-\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI().getContainersInTemplate(liveTemplateLP, user, false));\n+\t\t\t\tif (liveTemplateLP != null && InodeUtils.isSet(liveTemplateLP.getInode())) {\n+\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.getContainersInTemplate(liveTemplateLP, user, false));\n \t\t\t\t}\n \n \t\t\t\tfor (Container container : containerList) {\n-\n-\t\t\t\t\tif (container instanceof FileAssetContainer) {\n-\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\tcontainers.addOrClean(container.getIdentifier(), container.getModDate());\n-\t\t\t\t\t\tcontainersSet.add(container.getIdentifier());\n+\t\t\t\t\t// Containers dependencies\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTAINER.getType())) {\n+\t\t\t\t\t\tif (container instanceof FileAssetContainer) {\n+\t\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n+\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\tcontainers\n+\t\t\t\t\t\t\t\t\t.addOrClean(container.getIdentifier(), container.getModDate());\n+\t\t\t\t\t\t\tcontainersSet.add(container.getIdentifier());\n+\t\t\t\t\t\t}\n \t\t\t\t\t}\n \n \t\t\t\t\t// Structure dependencies\n-\t\t\t\t\tList<ContainerStructure> csList = APILocator.getContainerAPI().getContainerStructures(container);\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENT_TYPE.getType())) {\n+\t\t\t\t\t\tList<ContainerStructure> csList = APILocator.getContainerAPI()", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -680,24 +680,24 @@ public class DependencyManager {\n \n \t\ttry {\n \n-\t\t\tIdentifierAPI idenAPI = APILocator.getIdentifierAPI();\n-\t\t\tFolderAPI folderAPI = APILocator.getFolderAPI();\n-\t\t\tSet<Container> containerList = new HashSet<>();\n+\t\t\tfinal IdentifierAPI idenAPI = APILocator.getIdentifierAPI();\n+\t\t\tfinal FolderAPI folderAPI = APILocator.getFolderAPI();\n+\t\t\tfinal Set<Container> containerList = new HashSet<>();\n \n-\t\t\tfor (String pageId : idsToWork) {\n-\t\t\t\tIdentifier iden = idenAPI.find(pageId);\n+\t\t\tfor (final String pageId : idsToWork) {\n+\t\t\t\tfinal Identifier identifier = idenAPI.find(pageId);\n \n \t\t\t\t// Host dependency\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n-\t\t\t\t\thosts.addOrClean(iden.getHostId(), h.getModDate());\n-\t\t\t\t\thostsSet.add(iden.getHostId());\n+\t\t\t\t\tfinal Host host = APILocator.getHostAPI().find(identifier.getHostId(), user, false);\n+\t\t\t\t\thosts.addOrClean(identifier.getHostId(), host.getModDate());\n+\t\t\t\t\thostsSet.add(identifier.getHostId());\n \t\t\t\t}\n \n \t\t\t\t// Folder dependencies\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n-\t\t\t\t\tFolder folder = folderAPI\n-\t\t\t\t\t\t\t.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n+\t\t\t\t\tfinal Folder folder = folderAPI\n+\t\t\t\t\t\t\t.findFolderByPath(identifier.getParentPath(), identifier.getHostId(), user, false);\n \t\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n \t\t\t\t\tfoldersSet.add(folder.getInode());\n \t\t\t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwODYwOQ==", "url": "https://github.com/dotCMS/core/pull/18428#discussion_r424608609", "bodyText": "set to final", "author": "jdotcms", "createdAt": "2020-05-13T17:27:12Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -621,119 +688,155 @@ private void setHTMLPagesDependencies(Set<String> idsToWork) {\n \t\t\t\tIdentifier iden = idenAPI.find(pageId);\n \n \t\t\t\t// Host dependency\n-\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n-\t\t\t\thosts.addOrClean( iden.getHostId(), h.getModDate());\n-\t\t\t\thostsSet.add(iden.getHostId());\n-\t\t\t\tFolder folder = folderAPI.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n-\t\t\t\tfolders.addOrClean( folder.getInode(), folder.getModDate());\n-\t\t\t\tfoldersSet.add(folder.getInode());\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n+\t\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n+\t\t\t\t\thosts.addOrClean(iden.getHostId(), h.getModDate());\n+\t\t\t\t\thostsSet.add(iden.getHostId());\n+\t\t\t\t}\n \n+\t\t\t\t// Folder dependencies\n+\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n+\t\t\t\t\tFolder folder = folderAPI\n+\t\t\t\t\t\t\t.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n+\t\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n+\t\t\t\t\tfoldersSet.add(folder.getInode());\n+\t\t\t\t}\n \n \t\t\t\t// looking for working version (must exists)\n \t\t\t\tIHTMLPage workingPage = null;\n \n \t\t\t\tContentlet contentlet = null;\n-\t\t\t\ttry{\n-\t\t\t\t\tcontentlet = APILocator.getContentletAPI().search(\"+identifier:\"+pageId+\" +working:true\", 0, 0, \"moddate\", user, false).get(0);\n+\t\t\t\ttry {\n+\t\t\t\t\tcontentlet = APILocator.getContentletAPI()\n+\t\t\t\t\t\t\t.search(\"+identifier:\" + pageId + \" +working:true\", 0, 0, \"moddate\",\n+\t\t\t\t\t\t\t\t\tuser, false).get(0);\n \t\t\t\t} catch (DotContentletStateException e) {\n \t\t\t\t\t// content not found message is already displayed on console\n-\t\t\t\t\tLogger.debug(this, e.getMessage(),e);\n+\t\t\t\t\tLogger.debug(this, e.getMessage(), e);\n \t\t\t\t}\n-\t\t\t\tif(contentlet != null)\n+\t\t\t\tif (contentlet != null)\n \t\t\t\t\tworkingPage = APILocator.getHTMLPageAssetAPI().fromContentlet(contentlet);\n \n-\n \t\t\t\t// looking for live version (might not exists)\n \t\t\t\tIHTMLPage livePage = null;\n \n \t\t\t\tcontentlet = null;\n-\t\t\t\ttry{\n-\t\t\t\t\tList<Contentlet> result = APILocator.getContentletAPI().search(\"+identifier:\"+pageId+\" +live:true\", 0, 0, \"moddate\", user, false);\n-\t\t\t\t\tif(!result.isEmpty()) {\n+\t\t\t\ttry {\n+\t\t\t\t\tList<Contentlet> result = APILocator.getContentletAPI()\n+\t\t\t\t\t\t\t.search(\"+identifier:\" + pageId + \" +live:true\", 0, 0, \"moddate\", user,\n+\t\t\t\t\t\t\t\t\tfalse);\n+\t\t\t\t\tif (!result.isEmpty()) {\n \t\t\t\t\t\tcontentlet = result.get(0);\n \t\t\t\t\t}\n \n \t\t\t\t} catch (DotContentletStateException e) {\n \t\t\t\t\t// content not found message is already displayed on console\n-\t\t\t\t\tLogger.debug(this, e.getMessage(),e);\n+\t\t\t\t\tLogger.debug(this, e.getMessage(), e);\n \t\t\t\t}\n-\t\t\t\tif(contentlet != null)\n-\t\t\t\t\tlivePage = APILocator.getHTMLPageAssetAPI().fromContentlet(contentlet); \n-\n+\t\t\t\tif (contentlet != null)\n+\t\t\t\t\tlivePage = APILocator.getHTMLPageAssetAPI().fromContentlet(contentlet);\n \n \t\t\t\t// working template working page\n \t\t\t\tTemplate workingTemplateWP = null;\n \t\t\t\t// live template working page\n \t\t\t\tTemplate liveTemplateWP = null;\n \n-\t\t\t\tif(workingPage!=null) {\n-\t\t\t\t\tworkingTemplateWP = APILocator.getTemplateAPI().findWorkingTemplate(workingPage.getTemplateId(), user, false);\n-\t\t\t\t\tliveTemplateWP = APILocator.getTemplateAPI().findLiveTemplate(workingPage.getTemplateId(), user, false);\n+\t\t\t\tif (workingPage != null) {\n+\t\t\t\t\tworkingTemplateWP = APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.findWorkingTemplate(workingPage.getTemplateId(), user, false);\n+\t\t\t\t\tliveTemplateWP = APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.findLiveTemplate(workingPage.getTemplateId(), user, false);\n \t\t\t\t\t// Templates dependencies\n-\t\t\t\t\ttemplates.addOrClean( workingPage.getTemplateId(), workingTemplateWP.getModDate());\n-\t\t\t\t\ttemplatesSet.add(workingPage.getTemplateId());\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.TEMPLATE.getType())) {\n+\t\t\t\t\t\ttemplates.addOrClean(workingPage.getTemplateId(),\n+\t\t\t\t\t\t\t\tworkingTemplateWP.getModDate());\n+\t\t\t\t\t\ttemplatesSet.add(workingPage.getTemplateId());\n+\t\t\t\t\t}\n \t\t\t\t}\n \n \t\t\t\tTemplate liveTemplateLP = null;\n \n \t\t\t\t// live template live page\n-\t\t\t\tif(livePage!=null) {\n-\t\t\t\t\tliveTemplateLP = APILocator.getTemplateAPI().findLiveTemplate(livePage.getTemplateId(), user, false);\n+\t\t\t\tif (livePage != null) {\n+\t\t\t\t\tliveTemplateLP = APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.findLiveTemplate(livePage.getTemplateId(), user, false);\n \t\t\t\t\t// Templates dependencies\n-\t\t\t\t\ttemplates.addOrClean( livePage.getTemplateId(), livePage.getModDate());\n-\t\t\t\t\ttemplatesSet.add(livePage.getTemplateId());\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.TEMPLATE.getType())) {\n+\t\t\t\t\t\ttemplates.addOrClean(livePage.getTemplateId(), livePage.getModDate());\n+\t\t\t\t\t\ttemplatesSet.add(livePage.getTemplateId());\n+\t\t\t\t\t}\n \t\t\t\t}\n \n-\t\t\t\t// Containers dependencies\n \t\t\t\tcontainerList.clear();\n \n-\t\t\t\tif(workingTemplateWP!=null && InodeUtils.isSet(workingTemplateWP.getInode())){\n-\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI().getContainersInTemplate(workingTemplateWP, user, false));\n+\t\t\t\tif (workingTemplateWP != null && InodeUtils.isSet(workingTemplateWP.getInode())) {\n+\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.getContainersInTemplate(workingTemplateWP, user, false));\n \t\t\t\t}\n-\t\t\t\tif(liveTemplateWP!=null && InodeUtils.isSet(liveTemplateWP.getInode())){\n-\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI().getContainersInTemplate(liveTemplateWP, user, false));\n+\t\t\t\tif (liveTemplateWP != null && InodeUtils.isSet(liveTemplateWP.getInode())) {\n+\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.getContainersInTemplate(liveTemplateWP, user, false));\n \t\t\t\t}\n-\t\t\t\tif(liveTemplateLP!=null && InodeUtils.isSet(liveTemplateLP.getInode())){\n-\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI().getContainersInTemplate(liveTemplateLP, user, false));\n+\t\t\t\tif (liveTemplateLP != null && InodeUtils.isSet(liveTemplateLP.getInode())) {\n+\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n+\t\t\t\t\t\t\t.getContainersInTemplate(liveTemplateLP, user, false));\n \t\t\t\t}\n \n \t\t\t\tfor (Container container : containerList) {\n-\n-\t\t\t\t\tif (container instanceof FileAssetContainer) {\n-\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\tcontainers.addOrClean(container.getIdentifier(), container.getModDate());\n-\t\t\t\t\t\tcontainersSet.add(container.getIdentifier());\n+\t\t\t\t\t// Containers dependencies\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTAINER.getType())) {\n+\t\t\t\t\t\tif (container instanceof FileAssetContainer) {\n+\t\t\t\t\t\t\tfileAssetContainersSet.add(container.getIdentifier());\n+\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\tcontainers\n+\t\t\t\t\t\t\t\t\t.addOrClean(container.getIdentifier(), container.getModDate());\n+\t\t\t\t\t\t\tcontainersSet.add(container.getIdentifier());\n+\t\t\t\t\t\t}\n \t\t\t\t\t}\n \n \t\t\t\t\t// Structure dependencies\n-\t\t\t\t\tList<ContainerStructure> csList = APILocator.getContainerAPI().getContainerStructures(container);\n+\t\t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.CONTENT_TYPE.getType())) {\n+\t\t\t\t\t\tList<ContainerStructure> csList = APILocator.getContainerAPI()\n+\t\t\t\t\t\t\t\t.getContainerStructures(container);\n \n-\t\t\t\t\tfor (ContainerStructure containerStructure : csList) {\n-\t\t\t\t\t\tStructure st = CacheLocator.getContentTypeCache().getStructureByInode(containerStructure.getStructureId());\n-\t\t\t\t\t\tstructures.addOrClean(containerStructure.getStructureId(), st.getModDate());\n-\t\t\t\t\t\tstructuresSet.add(containerStructure.getStructureId());\n+\t\t\t\t\t\tfor (ContainerStructure containerStructure : csList) {", "originalCommit": "adfebf4e3a948581410f416bb5f6127fde9b1a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0568a65affc3aa93fde2d9692d52d4ae1944d28", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\nindex eee4ed764b..f5254b0747 100644\n--- a/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n+++ b/dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java\n\n@@ -680,24 +680,24 @@ public class DependencyManager {\n \n \t\ttry {\n \n-\t\t\tIdentifierAPI idenAPI = APILocator.getIdentifierAPI();\n-\t\t\tFolderAPI folderAPI = APILocator.getFolderAPI();\n-\t\t\tSet<Container> containerList = new HashSet<>();\n+\t\t\tfinal IdentifierAPI idenAPI = APILocator.getIdentifierAPI();\n+\t\t\tfinal FolderAPI folderAPI = APILocator.getFolderAPI();\n+\t\t\tfinal Set<Container> containerList = new HashSet<>();\n \n-\t\t\tfor (String pageId : idsToWork) {\n-\t\t\t\tIdentifier iden = idenAPI.find(pageId);\n+\t\t\tfor (final String pageId : idsToWork) {\n+\t\t\t\tfinal Identifier identifier = idenAPI.find(pageId);\n \n \t\t\t\t// Host dependency\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.SITE.getType())) {\n-\t\t\t\t\tHost h = APILocator.getHostAPI().find(iden.getHostId(), user, false);\n-\t\t\t\t\thosts.addOrClean(iden.getHostId(), h.getModDate());\n-\t\t\t\t\thostsSet.add(iden.getHostId());\n+\t\t\t\t\tfinal Host host = APILocator.getHostAPI().find(identifier.getHostId(), user, false);\n+\t\t\t\t\thosts.addOrClean(identifier.getHostId(), host.getModDate());\n+\t\t\t\t\thostsSet.add(identifier.getHostId());\n \t\t\t\t}\n \n \t\t\t\t// Folder dependencies\n \t\t\t\tif (publisherFilter.acceptExcludeDependencyClasses(PusheableAsset.FOLDER.getType())) {\n-\t\t\t\t\tFolder folder = folderAPI\n-\t\t\t\t\t\t\t.findFolderByPath(iden.getParentPath(), iden.getHostId(), user, false);\n+\t\t\t\t\tfinal Folder folder = folderAPI\n+\t\t\t\t\t\t\t.findFolderByPath(identifier.getParentPath(), identifier.getHostId(), user, false);\n \t\t\t\t\tfolders.addOrClean(folder.getInode(), folder.getModDate());\n \t\t\t\t\tfoldersSet.add(folder.getInode());\n \t\t\t\t}\n"}}]}