{"pr_number": 18322, "pr_title": "Issue 18210", "pr_createdAt": "2020-04-17T18:53:44Z", "pr_url": "https://github.com/dotCMS/core/pull/18322", "timeline": [{"oid": "ca623a3c4389905e03211b039af354851815f4e2", "url": "https://github.com/dotCMS/core/commit/ca623a3c4389905e03211b039af354851815f4e2", "message": "#18210 fix page path validation so it takes correct host", "committedDate": "2020-04-15T22:23:27Z", "type": "commit"}, {"oid": "9bed4a9722a707d34bf48dc0a8d1ab1c77c92f5b", "url": "https://github.com/dotCMS/core/commit/9bed4a9722a707d34bf48dc0a8d1ab1c77c92f5b", "message": "#18210 avoid mutating system_folder", "committedDate": "2020-04-16T23:54:51Z", "type": "commit"}, {"oid": "78f9e990c4eacdc0adb9799ec18defb1e6cfc347", "url": "https://github.com/dotCMS/core/commit/78f9e990c4eacdc0adb9799ec18defb1e6cfc347", "message": "#18210 integration test", "committedDate": "2020-04-17T18:45:07Z", "type": "commit"}, {"oid": "b3289a85844ebb849ebe40585ddf63605589bbad", "url": "https://github.com/dotCMS/core/commit/b3289a85844ebb849ebe40585ddf63605589bbad", "message": "Merge branch 'master' of github.com:dotCMS/core into issue-18210", "committedDate": "2020-04-17T18:45:22Z", "type": "commit"}, {"oid": "b1cf491a4dcbd8e7d7f7a8d9a7f72820e1de7d68", "url": "https://github.com/dotCMS/core/commit/b1cf491a4dcbd8e7d7f7a8d9a7f72820e1de7d68", "message": "#18210 fixing test", "committedDate": "2020-04-17T22:16:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQyMDI3OQ==", "url": "https://github.com/dotCMS/core/pull/18322#discussion_r411420279", "bodyText": "maybe it should go into a private method", "author": "freddyucv", "createdAt": "2020-04-20T14:23:36Z", "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/viewtools/navigation/NavTool.java", "diffHunk": "@@ -77,13 +79,24 @@ protected NavResultHydrated getNav(Host host, String path, long languageId, User\n             path = path.substring(0, path.lastIndexOf(\"/\"));\n         }\n \n-        Folder folder = !path.equals(\"/\") ? APILocator.getFolderAPI()\n+        final Folder originalFolder = !path.equals(\"/\") ? APILocator.getFolderAPI()\n             .findFolderByPath(path, host, systemUserParam, true)\n                 : APILocator.getFolderAPI()\n                     .findSystemFolder();\n-        if (folder == null || !UtilMethods.isSet(folder.getIdentifier())) {\n+\n+        if (originalFolder == null || !UtilMethods.isSet(originalFolder.getIdentifier())) {\n             return null;\n         }\n+\n+        // make a defensive copy to avoid mutating cached version\n+        Folder folder = new Folder();\n+        try {\n+            BeanUtils.copyProperties(folder, originalFolder);\n+        } catch (IllegalAccessException | InvocationTargetException e) {\n+            folder = originalFolder;\n+            Logger.warnAndDebug(NavTool.class,\"Defensive copy failed. Using original object\", e);\n+        }\n+", "originalCommit": "b1cf491a4dcbd8e7d7f7a8d9a7f72820e1de7d68", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "285fb52e74ed0855eb1b469a7ce8a4b0e2bd1313", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/rendering/velocity/viewtools/navigation/NavTool.java b/dotCMS/src/main/java/com/dotcms/rendering/velocity/viewtools/navigation/NavTool.java\nindex 93265d9568..d3f3fd54dd 100644\n--- a/dotCMS/src/main/java/com/dotcms/rendering/velocity/viewtools/navigation/NavTool.java\n+++ b/dotCMS/src/main/java/com/dotcms/rendering/velocity/viewtools/navigation/NavTool.java\n\n@@ -89,13 +89,7 @@ public class NavTool implements ViewTool {\n         }\n \n         // make a defensive copy to avoid mutating cached version\n-        Folder folder = new Folder();\n-        try {\n-            BeanUtils.copyProperties(folder, originalFolder);\n-        } catch (IllegalAccessException | InvocationTargetException e) {\n-            folder = originalFolder;\n-            Logger.warnAndDebug(NavTool.class,\"Defensive copy failed. Using original object\", e);\n-        }\n+        Folder folder = getDefensiveCopyOfFolder(originalFolder);\n \n         NavResult result = CacheLocator.getNavToolCache()\n             .getNav(host.getIdentifier(), folder.getInode(), languageId);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQyMTM0OA==", "url": "https://github.com/dotCMS/core/pull/18322#discussion_r411421348", "bodyText": "I think we should check also the return value of the getNav method", "author": "freddyucv", "createdAt": "2020-04-20T14:25:01Z", "path": "dotCMS/src/integration-test/java/com/dotcms/rendering/velocity/viewtools/navigation/NavToolTest.java", "diffHunk": "@@ -441,4 +449,36 @@ public void testNavTool_rootLevel_returnItemsOnlyForSite() throws Exception\n \n     }\n \n+    /**\n+     * Method to test: NavTool.getNav\n+     * Given scenario: get navigation for system folder (\"/\")\n+     * Expected result: getting the navigation should not change system folder's hostId\n+     * @throws Exception exception\n+     */\n+\n+    @Test\n+    public void testNavTool_getNav_SystemFolder_ShouldNotChangeSystemFolderHostId() throws Exception\n+    {\n+        //Get SystemFolder\n+        Folder systemFolder = APILocator.getFolderAPI().findSystemFolder();\n+\n+        //Create new Host\n+        final Host host = new SiteDataGen().nextPersisted();\n+\n+        //Create contentlets on one host\n+        final File file = File.createTempFile(\"fileTestEngTrue\", \".txt\");\n+        FileUtil.write(file, \"helloworld\");\n+        final Contentlet fileAssetOneHost = new FileAssetDataGen(systemFolder, file)\n+                .host(host).setProperty(FileAssetAPI.SHOW_ON_MENU, \"true\").nextPersisted();\n+        final Template template = new TemplateDataGen().nextPersisted();\n+        final Contentlet pageAssetOneHost = new HTMLPageDataGen(systemFolder, template)\n+                .showOnMenu(true).host(host).nextPersisted();\n+        ContentletDataGen.publish(pageAssetOneHost);\n+        ContentletDataGen.publish(fileAssetOneHost);\n+\n+        new NavTool().getNav(host, systemFolder.getPath());\n+        systemFolder = APILocator.getFolderAPI().findSystemFolder();\n+        assertEquals(Host.SYSTEM_HOST, systemFolder.getHostId());", "originalCommit": "b1cf491a4dcbd8e7d7f7a8d9a7f72820e1de7d68", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ5Mjc4OQ==", "url": "https://github.com/dotCMS/core/pull/18322#discussion_r411492789", "bodyText": "It's covered in a different test", "author": "dsilvam", "createdAt": "2020-04-20T15:54:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQyMTM0OA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "285fb52e74ed0855eb1b469a7ce8a4b0e2bd1313", "url": "https://github.com/dotCMS/core/commit/285fb52e74ed0855eb1b469a7ce8a4b0e2bd1313", "message": "#18210 extract to method - code review", "committedDate": "2020-04-20T15:55:05Z", "type": "commit"}, {"oid": "979cb4e304e0022f3bb301548303939c54257d5c", "url": "https://github.com/dotCMS/core/commit/979cb4e304e0022f3bb301548303939c54257d5c", "message": "#18210 extract to method - code review", "committedDate": "2020-04-20T15:58:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTUwMjQ2OQ==", "url": "https://github.com/dotCMS/core/pull/18322#discussion_r411502469", "bodyText": "Issue found: Local variable 'modifiedSystemFolder' could be declared final", "author": "dev-dotcms", "createdAt": "2020-04-20T16:06:27Z", "path": "dotCMS/src/integration-test/java/com/dotcms/rendering/velocity/viewtools/navigation/NavToolTest.java", "diffHunk": "@@ -204,8 +205,15 @@ public void testRootLevelNavigation_WhenOneFileAssetIsShownOnMenu() throws Excep\n                     .getNav(site, systemFolder.getPath(), 1, user);\n             assertNotNull(navResult);\n \n+            /* method below `findShowOnMenuUnderFolder` expects a mutated version of SYSTEM_FOLDER with the hostId altered.\n+               So let's create a defensive copy of the SYSTEM_FOLDER, modify it and pass it to the method.\n+            */\n+            Folder modifiedSystemFolder = new Folder();", "originalCommit": "979cb4e304e0022f3bb301548303939c54257d5c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTUwMjQ4Nw==", "url": "https://github.com/dotCMS/core/pull/18322#discussion_r411502487", "bodyText": "Issue found: Position literals first in String comparisons", "author": "dev-dotcms", "createdAt": "2020-04-20T16:06:28Z", "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/viewtools/navigation/NavTool.java", "diffHunk": "@@ -77,13 +79,17 @@ protected NavResultHydrated getNav(Host host, String path, long languageId, User\n             path = path.substring(0, path.lastIndexOf(\"/\"));\n         }\n \n-        Folder folder = !path.equals(\"/\") ? APILocator.getFolderAPI()\n+        final Folder originalFolder = !path.equals(\"/\") ? APILocator.getFolderAPI()", "originalCommit": "979cb4e304e0022f3bb301548303939c54257d5c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjY3NDM4MQ==", "url": "https://github.com/dotCMS/core/pull/18322#discussion_r412674381", "bodyText": "Very good", "author": "jdotcms", "createdAt": "2020-04-22T05:11:19Z", "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/viewtools/navigation/NavTool.java", "diffHunk": "@@ -215,6 +221,22 @@ protected NavResultHydrated getNav(Host host, String path, long languageId, User\n         }\n     }\n \n+    /**\n+     * Makes a defensive copy of the given folder to avoid mutating cached version\n+     * @param originalFolder folder to make the defensive copy from\n+     * @return defensive copy\n+     */\n+    private Folder getDefensiveCopyOfFolder(Folder originalFolder) {", "originalCommit": "979cb4e304e0022f3bb301548303939c54257d5c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}