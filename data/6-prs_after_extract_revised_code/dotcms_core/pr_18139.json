{"pr_number": 18139, "pr_title": "#18086 show pre-execute code regardless the mode", "pr_createdAt": "2020-03-13T23:20:27Z", "pr_url": "https://github.com/dotCMS/core/pull/18139", "timeline": [{"oid": "b0a48a101944cbb94bba2ebcfa8c70a719c8eb5c", "url": "https://github.com/dotCMS/core/commit/b0a48a101944cbb94bba2ebcfa8c70a719c8eb5c", "message": "#18086 show pre-execute code regardless the mode", "committedDate": "2020-03-13T23:19:12Z", "type": "commit"}, {"oid": "cb562bce96475ac90608d502880149995391672c", "url": "https://github.com/dotCMS/core/commit/cb562bce96475ac90608d502880149995391672c", "message": "#18086 add the page info and pre-execute code regardless the pagemode", "committedDate": "2020-03-16T21:56:18Z", "type": "commit"}, {"oid": "abccab01613ea4669e7646a7aa8d01cf6041ec8d", "url": "https://github.com/dotCMS/core/commit/abccab01613ea4669e7646a7aa8d01cf6041ec8d", "message": "#18086 IT for every pagemode: edit, preview, live", "committedDate": "2020-03-16T21:57:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM0NDExNQ==", "url": "https://github.com/dotCMS/core/pull/18139#discussion_r393344115", "bodyText": "Issue found: StringBuffer (or StringBuilder).append is called consecutively without reusing the target variable.", "author": "dev-dotcms", "createdAt": "2020-03-16T22:27:50Z", "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/services/PageLoader.java", "diffHunk": "@@ -197,6 +186,15 @@ public InputStream buildStream(IHTMLPage htmlPage, PageMode mode, final String f\n \n     }\n \n+    private void addWidgetPreExecuteCodeAndPageInfo(final HTMLPageAsset htmlPage, final PageMode mode,\n+            final StringBuilder stringBuilder, final User user) throws DotSecurityException, DotDataException {\n+        final PageRenderUtil pce = new PageRenderUtil(htmlPage, user, mode);\n+        // Add the pre-execute code of a widget to the page\n+        stringBuilder.append(pce.getWidgetPreExecute());", "originalCommit": "abccab01613ea4669e7646a7aa8d01cf6041ec8d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM0NDEyOQ==", "url": "https://github.com/dotCMS/core/pull/18139#discussion_r393344129", "bodyText": "Issue found: Local variable 'contentType' could be declared final", "author": "dev-dotcms", "createdAt": "2020-03-16T22:27:52Z", "path": "dotCMS/src/integration-test/java/com/dotcms/rendering/velocity/services/HTMLPageAssetRenderedTest.java", "diffHunk": "@@ -1298,6 +1300,72 @@ public void shouldRenderUsingOtherSiteContainerAndNotAdvanceTemplate() throws Ex\n         Assert.assertTrue(html.contains(\"content2content1\"));\n     }\n \n+    //Data Provider for the Widget Pre-execute code test\n+    @DataProvider\n+    public static Object[] dataProviderWidgetPreExecuteCode() {\n+        return new Object[] {\n+                new WidgetPreExecuteCodeTestCase(PageMode.EDIT_MODE),\n+                new WidgetPreExecuteCodeTestCase(PageMode.PREVIEW_MODE),\n+                new WidgetPreExecuteCodeTestCase(PageMode.LIVE),\n+        };\n+    }\n+\n+    private static class WidgetPreExecuteCodeTestCase {\n+        final PageMode pageMode;\n+\n+        public WidgetPreExecuteCodeTestCase(final PageMode pageMode) {\n+            this.pageMode = pageMode;\n+        }\n+    }\n+\n+    @Test\n+    @UseDataProvider(\"dataProviderWidgetPreExecuteCode\")\n+    public void test_WidgetPreExecuteCodeShowRegardlessPageMode(final WidgetPreExecuteCodeTestCase testCase) throws Exception {\n+\n+        //Update the Preexecute Field to have some code in it\n+        final String preExcuteCode = \"PreExecute Code Displayed\";\n+        ContentType contentType = TestDataUtils.getWidgetLikeContentType();", "originalCommit": "abccab01613ea4669e7646a7aa8d01cf6041ec8d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM0NDEzNw==", "url": "https://github.com/dotCMS/core/pull/18139#discussion_r393344137", "bodyText": "Issue found: Local variable 'multiTree' could be declared final", "author": "dev-dotcms", "createdAt": "2020-03-16T22:27:53Z", "path": "dotCMS/src/integration-test/java/com/dotcms/rendering/velocity/services/HTMLPageAssetRenderedTest.java", "diffHunk": "@@ -1298,6 +1300,72 @@ public void shouldRenderUsingOtherSiteContainerAndNotAdvanceTemplate() throws Ex\n         Assert.assertTrue(html.contains(\"content2content1\"));\n     }\n \n+    //Data Provider for the Widget Pre-execute code test\n+    @DataProvider\n+    public static Object[] dataProviderWidgetPreExecuteCode() {\n+        return new Object[] {\n+                new WidgetPreExecuteCodeTestCase(PageMode.EDIT_MODE),\n+                new WidgetPreExecuteCodeTestCase(PageMode.PREVIEW_MODE),\n+                new WidgetPreExecuteCodeTestCase(PageMode.LIVE),\n+        };\n+    }\n+\n+    private static class WidgetPreExecuteCodeTestCase {\n+        final PageMode pageMode;\n+\n+        public WidgetPreExecuteCodeTestCase(final PageMode pageMode) {\n+            this.pageMode = pageMode;\n+        }\n+    }\n+\n+    @Test\n+    @UseDataProvider(\"dataProviderWidgetPreExecuteCode\")\n+    public void test_WidgetPreExecuteCodeShowRegardlessPageMode(final WidgetPreExecuteCodeTestCase testCase) throws Exception {\n+\n+        //Update the Preexecute Field to have some code in it\n+        final String preExcuteCode = \"PreExecute Code Displayed\";\n+        ContentType contentType = TestDataUtils.getWidgetLikeContentType();\n+        final Field preExecuteField = APILocator.getContentTypeFieldAPI().byContentTypeIdAndVar(contentType.id(),WidgetContentType.WIDGET_PRE_EXECUTE_FIELD_VAR);\n+        APILocator.getContentTypeFieldAPI()\n+                .save(FieldBuilder.builder(preExecuteField).values(preExcuteCode).build(), systemUser);\n+        // Assert that the widget has set the pre-execute field\n+        Assert.assertTrue(APILocator.getContentTypeFieldAPI()\n+                .byContentTypeIdAndVar(contentType.id(),WidgetContentType.WIDGET_PRE_EXECUTE_FIELD_VAR)\n+                .values().equals(preExcuteCode));\n+\n+        //Create Contentlet\n+        final Contentlet widgetContentlet = TestDataUtils.getWidgetContent(true,1,contentType.id());\n+        addAnonymousPermissions(widgetContentlet);\n+\n+        //Create Container, Template and Page\n+        final Container container = createContainer();\n+        final Template template = createTemplate(container);\n+\n+        final String pageName = \"testPage-\"+System.currentTimeMillis();\n+        final HTMLPageAsset page = createHtmlPageAsset(template, pageName, 1);\n+\n+        //Add contentlet to the page\n+        MultiTree multiTree = new MultiTree(page.getIdentifier(), container.getIdentifier(),widgetContentlet.getIdentifier() ,UUID,0);", "originalCommit": "abccab01613ea4669e7646a7aa8d01cf6041ec8d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}