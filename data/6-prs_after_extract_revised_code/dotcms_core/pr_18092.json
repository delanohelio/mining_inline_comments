{"pr_number": 18092, "pr_title": "#18072 : Improving logging code in order to provide better error mess\u2026", "pr_createdAt": "2020-03-03T22:17:12Z", "pr_url": "https://github.com/dotCMS/core/pull/18092", "timeline": [{"oid": "392c07a75fa150e566ed98ba946e099d8a26077f", "url": "https://github.com/dotCMS/core/commit/392c07a75fa150e566ed98ba946e099d8a26077f", "message": "#18072 : Improving logging code in order to provide better error messages when a reindex fails. A more descriptive message has also been changed in the ESContentFactoryImpl class because of the upgrade in our ES library, which might involve updating configuration parameters and mappings for ES and existing contents in a customer environment.", "committedDate": "2020-03-03T22:16:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzcwNTQ4Mg==", "url": "https://github.com/dotCMS/core/pull/18092#discussion_r387705482", "bodyText": "better:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    } catch (final DotSecurityException e) {\n          \n          \n            \n                    } catch (final DotSecurityException | DotDataException e) {\n          \n          \n            \n                      ...", "author": "freddyucv", "createdAt": "2020-03-04T14:35:28Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/contentlet/business/Contentlet.java", "diffHunk": "@@ -277,20 +249,72 @@ public void setLanguageId(long languageId) {\n         this.languageId = languageId;\r\n     }\r\n \r\n+    /**\r\n+     * @deprecated Use the method {@link #getContentTypeId()}\r\n+     *\r\n+     * @return\r\n+     */\r\n     public String getStructureInode() {\r\n-        return structureInode;\r\n+        return contentTypeId;\r\n+    }\r\n+\r\n+    /**\r\n+     * Returns the ID of the Content Type that this Contentlet belongs to.\r\n+     *\r\n+     * @return The Content Type ID.\r\n+     */\r\n+    public String getContentTypeId() {\r\n+        return this.contentTypeId;\r\n     }\r\n \r\n+    /**\r\n+     * @deprecated Use the method {@link #setContentTypeId(String)}\r\n+     *\r\n+     * @param structureInode\r\n+     */\r\n     public void setStructureInode(String structureInode) {\r\n-        this.structureInode = structureInode;\r\n+        this.contentTypeId = structureInode;\r\n     }\r\n+\r\n+    /**\r\n+     * Sets the Content Type ID that this Contentlet belongs to.\r\n+     *\r\n+     * @param contentTypeId The Content Type ID.\r\n+     */\r\n+    public void setContentTypeId(final String contentTypeId) {\r\n+        this.contentTypeId = contentTypeId;\r\n+    }\r\n+\r\n     /**\r\n+     * @deprecated Use the method {@link #getContentType()}\r\n+     *\r\n+     * @return\r\n      */\r\n     public Structure getStructure() {\r\n-        Structure structure = CacheLocator.getContentTypeCache().getStructureByInode(structureInode);\r\n+        Structure structure = CacheLocator.getContentTypeCache().getStructureByInode(contentTypeId);\r\n         return structure;\r\n     }\r\n \r\n+    /**\r\n+     * Returns the Content Type that this Contentlet belongs to.\r\n+     *\r\n+     * @return The {@link ContentType} object.\r\n+     */\r\n+    public ContentType getContentType() {\r\n+        final ContentType contentType;\r\n+        try {\r\n+            contentType = APILocator.getContentTypeAPI(APILocator.systemUser()).find(contentTypeId);\r\n+            return contentType;\r\n+        } catch (final DotSecurityException e) {\r", "originalCommit": "392c07a75fa150e566ed98ba946e099d8a26077f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc2NzExMw==", "url": "https://github.com/dotCMS/core/pull/18092#discussion_r387767113", "bodyText": "Done", "author": "jcastro-dotcms", "createdAt": "2020-03-04T16:04:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzcwNTQ4Mg=="}], "type": "inlineReview", "revised_code": {"commit": "3fcbdf37cb32264283c2e780a22173dfd8ba679f", "chunk": "diff --git a/dotCMS/src/main/java/com/dotmarketing/portlets/contentlet/business/Contentlet.java b/dotCMS/src/main/java/com/dotmarketing/portlets/contentlet/business/Contentlet.java\nindex 71a28fd066..4b6a331726 100644\n--- a/dotCMS/src/main/java/com/dotmarketing/portlets/contentlet/business/Contentlet.java\n+++ b/dotCMS/src/main/java/com/dotmarketing/portlets/contentlet/business/Contentlet.java\n\n@@ -305,10 +305,7 @@ public class Contentlet extends WebAsset implements Serializable {\n         try {\n             contentType = APILocator.getContentTypeAPI(APILocator.systemUser()).find(contentTypeId);\n             return contentType;\n-        } catch (final DotSecurityException e) {\n-            Logger.error(this, String.format(\"An error occurred when returning the Content Type associated to \" +\n-                    \"Contentlet '%s'\", this.getIdentifier()));\n-        } catch (final DotDataException e) {\n+        } catch (final DotSecurityException | DotDataException e) {\n             Logger.error(this, String.format(\"An error occurred when returning the Content Type associated to \" +\n                     \"Contentlet '%s'\", this.getIdentifier()));\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzcwNzY2Mw==", "url": "https://github.com/dotCMS/core/pull/18092#discussion_r387707663", "bodyText": "better:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    } catch (final IllegalArgumentException iae) {\n          \n          \n            \n                    } catch (final DotRuntimeException | InvocationTargetException  | IllegalAccessException  e) {", "author": "freddyucv", "createdAt": "2020-03-04T14:38:49Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/contentlet/business/Contentlet.java", "diffHunk": "@@ -1599,159 +1619,109 @@ public void setDisabledWysiwyg(String disabledWysiwyg) {\n \t\tthis.disabledWysiwyg = disabledWysiwyg;\r\n \t}\r\n \r\n-\t/*public String getFolder() {\r\n-\t\treturn folder;\r\n-\t}\r\n-\r\n-\tpublic void setFolder(String folder) {\r\n-\t\tthis.folder = folder;\r\n-\t}*/\r\n-\r\n \t/**\r\n \t *\r\n-\t * @param f\r\n+\t * @param field\r\n \t * @param value\r\n \t */\r\n-\tpublic void setField(Field f, Object value) throws DotRuntimeException {\r\n+\tpublic void setField(Field field, Object value) throws DotRuntimeException {\r\n \t\ttry {\r\n \t\t\tif(value != null && value instanceof Timestamp){\r\n \t\t\t\tvalue = new Date(((Timestamp)value).getTime());\r\n \t\t\t}\r\n-\r\n-\t\t\t/* This code is not being used anymore - issue 10529\r\n-\t\t\tif(value!=null && value instanceof String && ((String)value).indexOf(\"\\\\u\")>-1) {\r\n-\t\t\t\tvalue = ((String)value).replace(\"\\\\u\", \"${esc.b}u\");\r\n-\t\t\t}\r\n-\t\t\t*/\r\n-\t\t\tBeanUtils.setProperty(this, f.getFieldContentlet(), value);\r\n-\t\t}catch(IllegalArgumentException iae){\r\n-\t\t\tLogger.error(this, \"Unable to set the contentlet field.\");\r\n-\t\t\tthrow new DotRuntimeException(\"Unable to set the contentlet field.\", iae);\r\n-\t\t} catch (IllegalAccessException e) {\r\n-\t\t\tLogger.error(this, \"Unable to set the contentlet field.\");\r\n-\t\t\tthrow new DotRuntimeException(\"Unable to set the contentlet field.\", e);\r\n-\t\t} catch (InvocationTargetException e) {\r\n-\t\t\tLogger.error(this, \"Unable to set the contentlet field.\");\r\n-\t\t\tthrow new DotRuntimeException(\"Unable to set the contentlet field.\", e);\r\n-\t\t}\r\n-\t}\r\n-\r\n-\r\n-\t/**\r\n-\t *\r\n-\t * @param fieldVarName velocityVarName\r\n-\t * @param value\r\n-\t * @throws DotRuntimeException if the field doesn't exist or it's not accesible\r\n-\t */\r\n-\tpublic void setField(String fieldVarName, Object value) throws DotRuntimeException {\r\n-\t\tStructure st = CacheLocator.getContentTypeCache().getStructureByInode(this.structureInode);\r\n-\t\tField f = st.getFieldVar(fieldVarName);\r\n-\t\tif(f == null)\r\n-\t\t\tthrow new DotRuntimeException(\"Field: \" + fieldVarName + \" doesn't exist.\");\r\n-\t\tsetField(f, value);\r\n-\t}\r\n+\t\t\tBeanUtils.setProperty(this, field.getFieldContentlet(), value);\r\n+        } catch (final IllegalArgumentException iae) {\r", "originalCommit": "392c07a75fa150e566ed98ba946e099d8a26077f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc2NzE2OA==", "url": "https://github.com/dotCMS/core/pull/18092#discussion_r387767168", "bodyText": "Done", "author": "jcastro-dotcms", "createdAt": "2020-03-04T16:04:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzcwNzY2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "3fcbdf37cb32264283c2e780a22173dfd8ba679f", "chunk": "diff --git a/dotCMS/src/main/java/com/dotmarketing/portlets/contentlet/business/Contentlet.java b/dotCMS/src/main/java/com/dotmarketing/portlets/contentlet/business/Contentlet.java\nindex 71a28fd066..4b6a331726 100644\n--- a/dotCMS/src/main/java/com/dotmarketing/portlets/contentlet/business/Contentlet.java\n+++ b/dotCMS/src/main/java/com/dotmarketing/portlets/contentlet/business/Contentlet.java\n\n@@ -1624,30 +1621,18 @@ public class Contentlet extends WebAsset implements Serializable {\n \t * @param field\n \t * @param value\n \t */\n-\tpublic void setField(Field field, Object value) throws DotRuntimeException {\n+\tpublic void setField(final Field field, Object value) throws DotRuntimeException {\n \t\ttry {\n \t\t\tif(value != null && value instanceof Timestamp){\n \t\t\t\tvalue = new Date(((Timestamp)value).getTime());\n \t\t\t}\n \t\t\tBeanUtils.setProperty(this, field.getFieldContentlet(), value);\n-        } catch (final IllegalArgumentException iae) {\n+        } catch (final IllegalArgumentException | IllegalAccessException | InvocationTargetException iae) {\n             final String errorMsg = String.format(\"Unable to set value [ %s ] contentlet field [ %s ]: %s\", (null !=\n                     value ? value.toString() : \"null\"), (null != field ? field.getFieldName() : \"null\"), iae\n                     .getMessage());\n             Logger.error(this, errorMsg);\n             throw new DotRuntimeException(errorMsg, iae);\n-        } catch (final IllegalAccessException e) {\n-            final String errorMsg = String.format(\"Unable to set value [ %s ] contentlet field [ %s ]: %s\", (null !=\n-                    value ? value.toString() : \"null\"), (null != field ? field.getFieldName() : \"null\"), e.getMessage\n-                    ());\n-            Logger.error(this, errorMsg);\n-            throw new DotRuntimeException(errorMsg, e);\n-        } catch (final InvocationTargetException e) {\n-            final String errorMsg = String.format(\"Unable to set value [ %s ] contentlet field [ %s ]: %s\", (null !=\n-                    value ? value.toString() : \"null\"), (null != field ? field.getFieldName() : \"null\"), e.getMessage\n-                    ());\n-            Logger.error(this, errorMsg);\n-            throw new DotRuntimeException(errorMsg, e);\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzcwODc0OA==", "url": "https://github.com/dotCMS/core/pull/18092#discussion_r387708748", "bodyText": "why all this are remove?", "author": "freddyucv", "createdAt": "2020-03-04T14:40:30Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/contentlet/business/Contentlet.java", "diffHunk": "@@ -219,36 +221,6 @@\n     private boolean bool24;\r\n     private boolean bool25;\r\n \r\n-    //private String folder;\r\n-\r\n-    private File binary1;\r\n-    private File binary2;\r\n-    private File binary3;\r\n-    private File binary4;\r\n-    private File binary5;\r\n-    private File binary6;\r\n-    private File binary7;\r\n-    private File binary8;\r\n-    private File binary9;\r\n-    private File binary10;\r\n-    private File binary11;\r\n-    private File binary12;\r\n-    private File binary13;\r\n-    private File binary14;\r\n-    private File binary15;\r\n-    private File binary16;\r\n-    private File binary17;\r\n-    private File binary18;\r\n-    private File binary19;\r\n-    private File binary20;\r\n-    private File binary21;\r\n-    private File binary22;\r\n-    private File binary23;\r\n-    private File binary24;\r\n-    private File binary25;\r", "originalCommit": "392c07a75fa150e566ed98ba946e099d8a26077f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc2NjU2Mg==", "url": "https://github.com/dotCMS/core/pull/18092#discussion_r387766562", "bodyText": "That code is marked by IntelliJ as not being used by any other class in the source code. It was probable caused by another refactoring not related to this issue.", "author": "jcastro-dotcms", "createdAt": "2020-03-04T16:04:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzcwODc0OA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzcxNTY5MA==", "url": "https://github.com/dotCMS/core/pull/18092#discussion_r387715690", "bodyText": "are you sure that you wanna show these exceptions as error? they might cause a lot of noise. I think Logger.warnAndDebug is better", "author": "nollymar", "createdAt": "2020-03-04T14:51:02Z", "path": "dotCMS/src/main/java/com/dotcms/content/elasticsearch/business/ESContentFactoryImpl.java", "diffHunk": "@@ -1584,20 +1585,18 @@ protected SearchHits indexSearch(String query, int limit, int offset, String sor\n \n             searchRequest.source(searchSourceBuilder);\n             response = RestHighLevelClientProvider.getInstance().getClient().search(searchRequest, RequestOptions.DEFAULT);\n-\n-\n-        } catch (ElasticsearchStatusException | IndexNotFoundException | SearchPhaseExecutionException infe ) {\n-            Logger.warn(this.getClass(), \"----------------------------------------------\");\n-            Logger.warn(this.getClass(), \"Elasticsearch Index Error : \" + indexToHit);\n-            Logger.warnAndDebug(this.getClass(), infe.getMessage(), infe);\n-            Logger.warn(this.getClass(), \"----------------------------------------------\");\n-\n+        } catch (final ElasticsearchStatusException | IndexNotFoundException | SearchPhaseExecutionException e) {\n+            Logger.error(this.getClass(), \"----------------------------------------------\");\n+            Logger.error(this.getClass(), String.format(\"Elasticsearch error in index '%s'\", indexToHit));", "originalCommit": "392c07a75fa150e566ed98ba946e099d8a26077f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc2NDY1Mw==", "url": "https://github.com/dotCMS/core/pull/18092#discussion_r387764653", "bodyText": "Fixed", "author": "jcastro-dotcms", "createdAt": "2020-03-04T16:01:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzcxNTY5MA=="}], "type": "inlineReview", "revised_code": {"commit": "c49a1ca9b32f574790b00d3b3428be6c2ac06a4c", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/content/elasticsearch/business/ESContentFactoryImpl.java b/dotCMS/src/main/java/com/dotcms/content/elasticsearch/business/ESContentFactoryImpl.java\nindex a2db627f6d..b15c4c5332 100644\n--- a/dotCMS/src/main/java/com/dotcms/content/elasticsearch/business/ESContentFactoryImpl.java\n+++ b/dotCMS/src/main/java/com/dotcms/content/elasticsearch/business/ESContentFactoryImpl.java\n\n@@ -1589,7 +1589,9 @@ public class ESContentFactoryImpl extends ContentletFactory {\n             Logger.error(this.getClass(), \"----------------------------------------------\");\n             Logger.error(this.getClass(), String.format(\"Elasticsearch error in index '%s'\", indexToHit));\n             Logger.error(this.getClass(), String.format(\"Lucene Query: [ %s ]\", formattedQuery));\n-            Logger.error(this.getClass(), String.format(\"ES Query: %s\", searchSourceBuilder), e);\n+            Logger.error(this.getClass(), String.format(\"ES Query: %s\", searchSourceBuilder));\n+            Logger.error(this.getClass(), String.format(\"Class %s: %s\", e.getClass().getName(), e.getCause()\n+                    .getMessage()));\n             Logger.error(this.getClass(), \"----------------------------------------------\");\n             return new SearchHits(new SearchHit[] {}, new TotalHits(0, Relation.EQUAL_TO), 0);\n         } catch (final Exception e) {\n"}}, {"oid": "c49a1ca9b32f574790b00d3b3428be6c2ac06a4c", "url": "https://github.com/dotCMS/core/commit/c49a1ca9b32f574790b00d3b3428be6c2ac06a4c", "message": "#18072 : Print only the error message in the Cause instead of the whole stack trace.", "committedDate": "2020-03-04T16:00:40Z", "type": "commit"}, {"oid": "3fcbdf37cb32264283c2e780a22173dfd8ba679f", "url": "https://github.com/dotCMS/core/commit/3fcbdf37cb32264283c2e780a22173dfd8ba679f", "message": "#18072 : Adding Code Review changes.", "committedDate": "2020-03-04T16:04:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc4NTk4NQ==", "url": "https://github.com/dotCMS/core/pull/18092#discussion_r387785985", "bodyText": "Issue found: Local variable 'structure' could be declared final", "author": "dev-dotcms", "createdAt": "2020-03-04T16:32:18Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/contentlet/business/Contentlet.java", "diffHunk": "@@ -277,20 +249,69 @@ public void setLanguageId(long languageId) {\n         this.languageId = languageId;\r\n     }\r\n \r\n+    /**\r\n+     * @deprecated Use the method {@link #getContentTypeId()}\r\n+     *\r\n+     * @return\r\n+     */\r\n     public String getStructureInode() {\r\n-        return structureInode;\r\n+        return contentTypeId;\r\n+    }\r\n+\r\n+    /**\r\n+     * Returns the ID of the Content Type that this Contentlet belongs to.\r\n+     *\r\n+     * @return The Content Type ID.\r\n+     */\r\n+    public String getContentTypeId() {\r\n+        return this.contentTypeId;\r\n     }\r\n \r\n+    /**\r\n+     * @deprecated Use the method {@link #setContentTypeId(String)}\r\n+     *\r\n+     * @param structureInode\r\n+     */\r\n     public void setStructureInode(String structureInode) {\r\n-        this.structureInode = structureInode;\r\n+        this.contentTypeId = structureInode;\r\n     }\r\n+\r\n+    /**\r\n+     * Sets the Content Type ID that this Contentlet belongs to.\r\n+     *\r\n+     * @param contentTypeId The Content Type ID.\r\n+     */\r\n+    public void setContentTypeId(final String contentTypeId) {\r\n+        this.contentTypeId = contentTypeId;\r\n+    }\r\n+\r\n     /**\r\n+     * @deprecated Use the method {@link #getContentType()}\r\n+     *\r\n+     * @return\r\n      */\r\n     public Structure getStructure() {\r\n-        Structure structure = CacheLocator.getContentTypeCache().getStructureByInode(structureInode);\r\n+        Structure structure = CacheLocator.getContentTypeCache().getStructureByInode(contentTypeId);\r", "originalCommit": "3fcbdf37cb32264283c2e780a22173dfd8ba679f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}