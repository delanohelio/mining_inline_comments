{"pr_number": 19447, "pr_title": "#19285 Using Max contentlet properties by Persona", "pr_createdAt": "2020-10-14T18:18:08Z", "pr_url": "https://github.com/dotCMS/core/pull/19447", "timeline": [{"oid": "4c9d9defcb469490f42cf5eadfac8dc78e286063", "url": "https://github.com/dotCMS/core/commit/4c9d9defcb469490f42cf5eadfac8dc78e286063", "message": "#19285 Using Max contentlet properties by Persona", "committedDate": "2020-10-14T18:16:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg5MDA1Ng==", "url": "https://github.com/dotCMS/core/pull/19447#discussion_r504890056", "bodyText": "should return a Set?", "author": "jdotcms", "createdAt": "2020-10-14T18:35:01Z", "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/services/PageRenderUtil.java", "diffHunk": "@@ -514,4 +510,40 @@ private String getPersonaTagToIncludeContent(final HttpServletRequest request, f\n \n         return hasPersonalizations ? currentPersonaTag : MultiTree.DOT_PERSONALIZATION_DEFAULT;\n     }\n+\n+    private static class ContainerUUIDPersona {\n+        Map<String, List<String>> containerUuidPersona     = Maps.newHashMap();\n+\n+        public void add(\n+                final Container container,\n+                final String uniqueUUIDForRender,\n+                final PersonalizedContentlet personalizedContentlet) {\n+\n+            get(container, uniqueUUIDForRender, personalizedContentlet)\n+                    .add(personalizedContentlet.getContentletId());\n+        }\n+\n+        private List<String> get(Container container, String uniqueUUIDForRender, PersonalizedContentlet personalizedContentlet) {\n+            return containerUuidPersona\n+                    .computeIfAbsent(\n+                            getKey(container, uniqueUUIDForRender, personalizedContentlet),\n+                            k -> Lists.newArrayList()\n+                    );\n+        }\n+\n+        private String getKey(Container container, String uniqueUUIDForRender, PersonalizedContentlet personalizedContentlet) {\n+            return container.getIdentifier() + uniqueUUIDForRender + personalizedContentlet.getPersonalization();\n+        }\n+\n+        public long getSize(\n+                final Container container,\n+                final String uniqueUUIDForRender,\n+                final PersonalizedContentlet personalizedContentlet) {\n+            return get(container, uniqueUUIDForRender, personalizedContentlet).size();\n+        }\n+\n+        public Iterable<? extends Map.Entry<String, List<String>>> entrySet() {", "originalCommit": "4c9d9defcb469490f42cf5eadfac8dc78e286063", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTYwMzM1Ng==", "url": "https://github.com/dotCMS/core/pull/19447#discussion_r505603356", "bodyText": "done bbd1763#diff-135d6f9eb01eb89ef742b83753636596a41a9e3ab757abd4347b57e80ae892e0R548", "author": "freddyucv", "createdAt": "2020-10-15T14:47:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg5MDA1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "bbd176303ed633ddea71b2af08cb868208201451", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/rendering/velocity/services/PageRenderUtil.java b/dotCMS/src/main/java/com/dotcms/rendering/velocity/services/PageRenderUtil.java\nindex ece011ae24..7fb3ec6769 100644\n--- a/dotCMS/src/main/java/com/dotcms/rendering/velocity/services/PageRenderUtil.java\n+++ b/dotCMS/src/main/java/com/dotcms/rendering/velocity/services/PageRenderUtil.java\n\n@@ -511,8 +511,11 @@ public class PageRenderUtil implements Serializable {\n         return hasPersonalizations ? currentPersonaTag : MultiTree.DOT_PERSONALIZATION_DEFAULT;\n     }\n \n+    /**\n+     * Util class to sort the {@link Contentlet} by {@link Persona} and {@link Container}\n+     */\n     private static class ContainerUUIDPersona {\n-        Map<String, List<String>> containerUuidPersona     = Maps.newHashMap();\n+        Map<String, List<String>> contents = Maps.newHashMap();\n \n         public void add(\n                 final Container container,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg5MDE1Nw==", "url": "https://github.com/dotCMS/core/pull/19447#discussion_r504890157", "bodyText": "Add some doc", "author": "jdotcms", "createdAt": "2020-10-14T18:35:14Z", "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/services/PageRenderUtil.java", "diffHunk": "@@ -514,4 +510,40 @@ private String getPersonaTagToIncludeContent(final HttpServletRequest request, f\n \n         return hasPersonalizations ? currentPersonaTag : MultiTree.DOT_PERSONALIZATION_DEFAULT;\n     }\n+\n+    private static class ContainerUUIDPersona {", "originalCommit": "4c9d9defcb469490f42cf5eadfac8dc78e286063", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTYwMzE1OA==", "url": "https://github.com/dotCMS/core/pull/19447#discussion_r505603158", "bodyText": "done bbd1763#diff-135d6f9eb01eb89ef742b83753636596a41a9e3ab757abd4347b57e80ae892e0R517", "author": "freddyucv", "createdAt": "2020-10-15T14:46:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg5MDE1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "bbd176303ed633ddea71b2af08cb868208201451", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/rendering/velocity/services/PageRenderUtil.java b/dotCMS/src/main/java/com/dotcms/rendering/velocity/services/PageRenderUtil.java\nindex ece011ae24..7fb3ec6769 100644\n--- a/dotCMS/src/main/java/com/dotcms/rendering/velocity/services/PageRenderUtil.java\n+++ b/dotCMS/src/main/java/com/dotcms/rendering/velocity/services/PageRenderUtil.java\n\n@@ -511,8 +511,11 @@ public class PageRenderUtil implements Serializable {\n         return hasPersonalizations ? currentPersonaTag : MultiTree.DOT_PERSONALIZATION_DEFAULT;\n     }\n \n+    /**\n+     * Util class to sort the {@link Contentlet} by {@link Persona} and {@link Container}\n+     */\n     private static class ContainerUUIDPersona {\n-        Map<String, List<String>> containerUuidPersona     = Maps.newHashMap();\n+        Map<String, List<String>> contents = Maps.newHashMap();\n \n         public void add(\n                 final Container container,\n"}}, {"oid": "bbd176303ed633ddea71b2af08cb868208201451", "url": "https://github.com/dotCMS/core/commit/bbd176303ed633ddea71b2af08cb868208201451", "message": "#19285 Doc and refactoring", "committedDate": "2020-10-15T14:46:01Z", "type": "commit"}, {"oid": "874cf5507ca3c965a400ea59ef55ad142d6dedb5", "url": "https://github.com/dotCMS/core/commit/874cf5507ca3c965a400ea59ef55ad142d6dedb5", "message": "Merge remote-tracking branch 'origin/master' into issue-19285-Legacy-containers-personalization-cache-issue", "committedDate": "2020-10-20T20:09:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgxMTEzOA==", "url": "https://github.com/dotCMS/core/pull/19447#discussion_r508811138", "bodyText": "Codacy found an issue: A method/constructor should not explicitly throw java.lang.Exception", "author": "dev-dotcms", "createdAt": "2020-10-20T20:16:54Z", "path": "dotCMS/src/integration-test/java/com/dotcms/rendering/velocity/services/HTMLPageAssetRenderedTest.java", "diffHunk": "@@ -1653,6 +1658,103 @@ public void pageWithSidebarShouldRender() throws Exception{\n         assertTrue(firstIndex != -1 && secondIndex != -1 && firstIndex != secondIndex && thirdIndex == -1);\n     }\n \n+    /**\n+     * Method to test: {@link HTMLPageAssetRenderedAPI#getPageHtml(PageContext, HttpServletRequest, HttpServletResponse)}\n+     * When: A page has multiple personas version, and the container has a MAx contentlet equals to 1\n+     * Should: render the page\n+     */\n+    @Test\n+    public void pageWithMultiplePersona() throws Exception{", "originalCommit": "874cf5507ca3c965a400ea59ef55ad142d6dedb5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}