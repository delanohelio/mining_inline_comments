{"pr_number": 18305, "pr_title": "#18229 Setting TrustSelfSignedStrategy to avoid validating ssl certificates by default", "pr_createdAt": "2020-04-13T18:01:48Z", "pr_url": "https://github.com/dotCMS/core/pull/18305", "timeline": [{"oid": "794acd9fbf2770cfd0363315ba61800e260cc41d", "url": "https://github.com/dotCMS/core/commit/794acd9fbf2770cfd0363315ba61800e260cc41d", "message": "#18229 Setting TrustSelfSignedStrategy to avoid validating ssl certificates by default", "committedDate": "2020-04-13T17:56:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIxNDM3OQ==", "url": "https://github.com/dotCMS/core/pull/18305#discussion_r408214379", "bodyText": "\"https\" should be a constant", "author": "freddyucv", "createdAt": "2020-04-14T15:09:59Z", "path": "dotCMS/src/main/java/com/dotcms/content/elasticsearch/util/DotRestHighLevelClientProvider.java", "diffHunk": "@@ -106,14 +110,24 @@ private BasicCredentialsProvider getCredentialsProvider() throws IOException, Ge\n \n     private RestClientBuilder getClientBuilder(final BasicCredentialsProvider credentialsProvider) {\n         final String esAuthType = getESAuthType();\n-\n+        final String esProtocol = Config.getStringProperty(\"ES_PROTOCOL\", \"https\");\n         final RestClientBuilder clientBuilder = RestClient\n                 .builder(new HttpHost(Config.getStringProperty(\"ES_HOSTNAME\", \"127.0.0.1\"),\n-                        Config.getIntProperty(\"ES_PORT\", 9200), sslContextFromPem != null ? \"https\" :\"http\"))\n+                        Config.getIntProperty(\"ES_PORT\", 9200), esProtocol))\n                 .setHttpClientConfigCallback((httpClientBuilder) -> {\n                     if (sslContextFromPem != null) {\n                         httpClientBuilder\n                                 .setSSLContext(sslContextFromPem);\n+                    } else if (\"https\".equals(esProtocol)){", "originalCommit": "794acd9fbf2770cfd0363315ba61800e260cc41d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODMxMTUxMQ==", "url": "https://github.com/dotCMS/core/pull/18305#discussion_r408311511", "bodyText": "Done", "author": "nollymar", "createdAt": "2020-04-14T17:29:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIxNDM3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "c6c856aa6fcb70afd8b76fce1348eb72d92fe327", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/content/elasticsearch/util/DotRestHighLevelClientProvider.java b/dotCMS/src/main/java/com/dotcms/content/elasticsearch/util/DotRestHighLevelClientProvider.java\nindex 206683c940..73b6f4be30 100644\n--- a/dotCMS/src/main/java/com/dotcms/content/elasticsearch/util/DotRestHighLevelClientProvider.java\n+++ b/dotCMS/src/main/java/com/dotcms/content/elasticsearch/util/DotRestHighLevelClientProvider.java\n\n@@ -110,7 +110,8 @@ public class DotRestHighLevelClientProvider extends RestHighLevelClientProvider\n \n     private RestClientBuilder getClientBuilder(final BasicCredentialsProvider credentialsProvider) {\n         final String esAuthType = getESAuthType();\n-        final String esProtocol = Config.getStringProperty(\"ES_PROTOCOL\", \"https\");\n+        final String httpsProtocol = \"https\";\n+        final String esProtocol = Config.getStringProperty(\"ES_PROTOCOL\", httpsProtocol);\n         final RestClientBuilder clientBuilder = RestClient\n                 .builder(new HttpHost(Config.getStringProperty(\"ES_HOSTNAME\", \"127.0.0.1\"),\n                         Config.getIntProperty(\"ES_PORT\", 9200), esProtocol))\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIxNTEzOQ==", "url": "https://github.com/dotCMS/core/pull/18305#discussion_r408215139", "bodyText": "is it possible do any test?", "author": "freddyucv", "createdAt": "2020-04-14T15:10:58Z", "path": "dotCMS/src/main/java/com/dotcms/content/elasticsearch/util/DotRestHighLevelClientProvider.java", "diffHunk": "@@ -106,14 +110,24 @@ private BasicCredentialsProvider getCredentialsProvider() throws IOException, Ge\n \n     private RestClientBuilder getClientBuilder(final BasicCredentialsProvider credentialsProvider) {\n         final String esAuthType = getESAuthType();\n-\n+        final String esProtocol = Config.getStringProperty(\"ES_PROTOCOL\", \"https\");\n         final RestClientBuilder clientBuilder = RestClient\n                 .builder(new HttpHost(Config.getStringProperty(\"ES_HOSTNAME\", \"127.0.0.1\"),\n-                        Config.getIntProperty(\"ES_PORT\", 9200), sslContextFromPem != null ? \"https\" :\"http\"))\n+                        Config.getIntProperty(\"ES_PORT\", 9200), esProtocol))\n                 .setHttpClientConfigCallback((httpClientBuilder) -> {\n                     if (sslContextFromPem != null) {\n                         httpClientBuilder\n                                 .setSSLContext(sslContextFromPem);\n+                    } else if (\"https\".equals(esProtocol)){\n+                        try {\n+                            httpClientBuilder.setSSLContext(SSLContexts\n+                                    .custom().loadTrustMaterial(new TrustSelfSignedStrategy()).build());\n+                        } catch (NoSuchAlgorithmException | KeyManagementException | KeyStoreException e) {\n+                            Logger.error(this.getClass(),\n+                                    \"Error setting TrustSelfSignedStrategy for Elastic RestHighLevelClient\",\n+                                    e);\n+                            throw new DotRuntimeException(e);\n+                        }", "originalCommit": "794acd9fbf2770cfd0363315ba61800e260cc41d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI4NzAzNw==", "url": "https://github.com/dotCMS/core/pull/18305#discussion_r408287037", "bodyText": "how do you suggest to test it? The logic avoid sending certificates for validation when the ES connection is established", "author": "nollymar", "createdAt": "2020-04-14T16:50:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIxNTEzOQ=="}], "type": "inlineReview", "revised_code": {"commit": "c6c856aa6fcb70afd8b76fce1348eb72d92fe327", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/content/elasticsearch/util/DotRestHighLevelClientProvider.java b/dotCMS/src/main/java/com/dotcms/content/elasticsearch/util/DotRestHighLevelClientProvider.java\nindex 206683c940..73b6f4be30 100644\n--- a/dotCMS/src/main/java/com/dotcms/content/elasticsearch/util/DotRestHighLevelClientProvider.java\n+++ b/dotCMS/src/main/java/com/dotcms/content/elasticsearch/util/DotRestHighLevelClientProvider.java\n\n@@ -110,7 +110,8 @@ public class DotRestHighLevelClientProvider extends RestHighLevelClientProvider\n \n     private RestClientBuilder getClientBuilder(final BasicCredentialsProvider credentialsProvider) {\n         final String esAuthType = getESAuthType();\n-        final String esProtocol = Config.getStringProperty(\"ES_PROTOCOL\", \"https\");\n+        final String httpsProtocol = \"https\";\n+        final String esProtocol = Config.getStringProperty(\"ES_PROTOCOL\", httpsProtocol);\n         final RestClientBuilder clientBuilder = RestClient\n                 .builder(new HttpHost(Config.getStringProperty(\"ES_HOSTNAME\", \"127.0.0.1\"),\n                         Config.getIntProperty(\"ES_PORT\", 9200), esProtocol))\n"}}, {"oid": "c6c856aa6fcb70afd8b76fce1348eb72d92fe327", "url": "https://github.com/dotCMS/core/commit/c6c856aa6fcb70afd8b76fce1348eb72d92fe327", "message": "#18229 Applying code review suggestions", "committedDate": "2020-04-14T17:28:52Z", "type": "commit"}, {"oid": "e0b2cc5a44a34919cb74e95f3dff4c6f464963a1", "url": "https://github.com/dotCMS/core/commit/e0b2cc5a44a34919cb74e95f3dff4c6f464963a1", "message": "#18229 Adding more logging", "committedDate": "2020-04-17T18:58:20Z", "type": "commit"}, {"oid": "bd74856e3703201711bb6b93b1679d4f679e946a", "url": "https://github.com/dotCMS/core/commit/bd74856e3703201711bb6b93b1679d4f679e946a", "message": "#18229 Adding more logging", "committedDate": "2020-04-17T19:04:19Z", "type": "commit"}, {"oid": "7622e4be4d62a0a1e8853d5d897ed839a998f658", "url": "https://github.com/dotCMS/core/commit/7622e4be4d62a0a1e8853d5d897ed839a998f658", "message": "#18229 Fixing typo and improving logs", "committedDate": "2020-04-17T19:12:57Z", "type": "commit"}]}