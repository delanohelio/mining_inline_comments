{"pr_number": 19482, "pr_title": "Issue 18730", "pr_createdAt": "2020-10-21T18:43:46Z", "pr_url": "https://github.com/dotCMS/core/pull/19482", "timeline": [{"oid": "db68bb11fb7323cca7a76ba768c44e0ff5e564c7", "url": "https://github.com/dotCMS/core/commit/db68bb11fb7323cca7a76ba768c44e0ff5e564c7", "message": "#18730 remove mapping", "committedDate": "2020-10-16T00:12:23Z", "type": "commit"}, {"oid": "43769b5f61c47b1b9e7fd65d51b15788a532fe6b", "url": "https://github.com/dotCMS/core/commit/43769b5f61c47b1b9e7fd65d51b15788a532fe6b", "message": "#18730 migrate API to use dotconnect", "committedDate": "2020-10-16T00:13:36Z", "type": "commit"}, {"oid": "c4ee0e0b000c49c7963c39e82bf5953d11094a0b", "url": "https://github.com/dotCMS/core/commit/c4ee0e0b000c49c7963c39e82bf5953d11094a0b", "message": "#18730 move classes where they belong", "committedDate": "2020-10-16T16:22:20Z", "type": "commit"}, {"oid": "fe7e610157683eecf5305daaf9e7659d661f9f28", "url": "https://github.com/dotCMS/core/commit/fe7e610157683eecf5305daaf9e7659d661f9f28", "message": "#18730 a bit of cleanup", "committedDate": "2020-10-16T17:40:51Z", "type": "commit"}, {"oid": "625af82e2d98770b94d372c39d6244bf038e0cd0", "url": "https://github.com/dotCMS/core/commit/625af82e2d98770b94d372c39d6244bf038e0cd0", "message": "#18730 call factory", "committedDate": "2020-10-16T21:14:28Z", "type": "commit"}, {"oid": "4726b2eea68619f9a9df179a32b66bbe1b6e515d", "url": "https://github.com/dotCMS/core/commit/4726b2eea68619f9a9df179a32b66bbe1b6e515d", "message": "Merge branch 'master' of github.com:dotCMS/core into issue-18730", "committedDate": "2020-10-20T20:58:05Z", "type": "commit"}, {"oid": "b7f7a01172aab5baab2a35bb943b079fdee91b8d", "url": "https://github.com/dotCMS/core/commit/b7f7a01172aab5baab2a35bb943b079fdee91b8d", "message": "#18730 fixes for history, delete version", "committedDate": "2020-10-21T18:35:17Z", "type": "commit"}, {"oid": "2c53c3f74deba61640b3261facc3984dfadd903f", "url": "https://github.com/dotCMS/core/commit/2c53c3f74deba61640b3261facc3984dfadd903f", "message": "#18730 fixes for publish, unpublish, archive", "committedDate": "2020-10-21T18:38:40Z", "type": "commit"}, {"oid": "6c593fed2e3cc1cf053ea7cb9ab399ae35e9cf88", "url": "https://github.com/dotCMS/core/commit/6c593fed2e3cc1cf053ea7cb9ab399ae35e9cf88", "message": "Merge branch 'master' of github.com:dotCMS/core into issue-18730", "committedDate": "2020-10-21T18:39:28Z", "type": "commit"}, {"oid": "fabdd2d51047f2ea94d08670fbf4bfc48a2219ad", "url": "https://github.com/dotCMS/core/commit/fabdd2d51047f2ea94d08670fbf4bfc48a2219ad", "message": "sql to recreate getChildrenClass", "committedDate": "2020-10-22T15:42:00Z", "type": "commit"}, {"oid": "e435b7327338572337f00ebee7382c0b37393a8b", "url": "https://github.com/dotCMS/core/commit/e435b7327338572337f00ebee7382c0b37393a8b", "message": "#18730 call findAllVersions from template", "committedDate": "2020-10-22T16:05:36Z", "type": "commit"}, {"oid": "324a0739e76468db94132ed8af1971ddc68a04a4", "url": "https://github.com/dotCMS/core/commit/324a0739e76468db94132ed8af1971ddc68a04a4", "message": "#18730 get idate and owner from inode", "committedDate": "2020-10-22T18:02:19Z", "type": "commit"}, {"oid": "103d1c9b15ec9650818005a6e12b9c8f68b6a155", "url": "https://github.com/dotCMS/core/commit/103d1c9b15ec9650818005a6e12b9c8f68b6a155", "message": "#18730 should update all versions of the template", "committedDate": "2020-10-22T20:17:40Z", "type": "commit"}, {"oid": "1de967e871c05a8b0c08b5900273f719c9d7b7eb", "url": "https://github.com/dotCMS/core/commit/1de967e871c05a8b0c08b5900273f719c9d7b7eb", "message": "Merge branch 'master' of github.com:dotCMS/core into issue-18730", "committedDate": "2020-10-22T21:45:01Z", "type": "commit"}, {"oid": "93bd51b9677b63142c8506765021448a1e937123", "url": "https://github.com/dotCMS/core/commit/93bd51b9677b63142c8506765021448a1e937123", "message": "#18730 export template", "committedDate": "2020-10-22T23:37:36Z", "type": "commit"}, {"oid": "0dd2edd3998742e42f494879709a3280f9e3f456", "url": "https://github.com/dotCMS/core/commit/0dd2edd3998742e42f494879709a3280f9e3f456", "message": "#18730 doc tests", "committedDate": "2020-10-23T00:22:23Z", "type": "commit"}, {"oid": "92b80c004067c116664128f11a2755eb0816aa95", "url": "https://github.com/dotCMS/core/commit/92b80c004067c116664128f11a2755eb0816aa95", "message": "#18730 tests", "committedDate": "2020-10-23T00:52:51Z", "type": "commit"}, {"oid": "bc72abff3e2f9a7262d8a202866fc8d97c798e57", "url": "https://github.com/dotCMS/core/commit/bc72abff3e2f9a7262d8a202866fc8d97c798e57", "message": "remove call InodeFactory.getInode", "committedDate": "2020-10-23T03:54:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDU4MDg5NQ==", "url": "https://github.com/dotCMS/core/pull/19482#discussion_r510580895", "bodyText": "Codacy found an issue: A method/constructor should not explicitly throw java.lang.Exception", "author": "dev-dotcms", "createdAt": "2020-10-23T04:01:49Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/templates/business/TemplateAPI.java", "diffHunk": "@@ -220,7 +219,7 @@ Template copy(Template sourceTemplate, Host destinationHost, boolean forceOverwr\n \t * @throws Exception\n \t */\n \t@Deprecated\n-\tpublic boolean delete(Template template, User user, boolean respectFrontendRoles) throws DotSecurityException, Exception;\n+\tboolean delete(Template template, User user, boolean respectFrontendRoles) throws DotSecurityException, Exception;", "originalCommit": "bc72abff3e2f9a7262d8a202866fc8d97c798e57", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDU4MDkwNA==", "url": "https://github.com/dotCMS/core/pull/19482#discussion_r510580904", "bodyText": "Codacy found an issue: Avoid variables with short names like id", "author": "dev-dotcms", "createdAt": "2020-10-23T04:01:50Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/templates/business/TemplateAPIImpl.java", "diffHunk": "@@ -482,17 +467,14 @@ public Template find(String inode, User user,  boolean respectFrontEndRoles) thr\n \n \t}\n \n-\n-\n-\n-\tpublic Template findLiveTemplate(String id, User user, boolean respectFrontendRoles) throws DotDataException, DotSecurityException {\n+\tpublic Template findLiveTemplate(final String id, final User user, final boolean respectFrontendRoles) throws DotDataException, DotSecurityException {", "originalCommit": "bc72abff3e2f9a7262d8a202866fc8d97c798e57", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDU4MDkwOA==", "url": "https://github.com/dotCMS/core/pull/19482#discussion_r510580908", "bodyText": "Codacy found an issue: Avoid unused imports such as 'com.dotcms.contenttype.model.type.BaseContentType'", "author": "dev-dotcms", "createdAt": "2020-10-23T04:01:51Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/templates/business/TemplateAPITest.java", "diffHunk": "@@ -1,10 +1,14 @@\n package com.dotmarketing.portlets.templates.business;\n \n import com.dotcms.IntegrationTestBase;\n+import com.dotcms.content.elasticsearch.business.ESContentFactoryImpl;\n+import com.dotcms.contenttype.model.type.BaseContentType;", "originalCommit": "bc72abff3e2f9a7262d8a202866fc8d97c798e57", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDU4MDkxMw==", "url": "https://github.com/dotCMS/core/pull/19482#discussion_r510580913", "bodyText": "Codacy found an issue: Avoid throwing raw exception types.", "author": "dev-dotcms", "createdAt": "2020-10-23T04:01:52Z", "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/viewtools/DotTemplateTool.java", "diffHunk": "@@ -132,15 +134,16 @@ public static void removeFromLayoutCache(final String templateInode){\n         layoutCache.invalidate(templateInode + true);\n     }\n \n-    private static DrawedBody getDrawedBody(String themeInode, User user) throws DotDataException, DotSecurityException {\n-        final Identifier ident = APILocator.getIdentifierAPI().findFromInode(themeInode);\n-        final Template template = APILocator.getTemplateAPI().findWorkingTemplate(ident.getId(), user, false);\n+    private static DrawedBody getDrawedBody(String themeInodeOrId, User user) throws DotDataException, DotSecurityException {\n+        final Template template = FactoryLocator.getTemplateFactory().find(themeInodeOrId);//If null themeInodeOrId is a Id\n+        final String identifier = template!=null ? template.getIdentifier() : themeInodeOrId;\n+        final Template workingTemplate = APILocator.getTemplateAPI().findWorkingTemplate(identifier, user, false);\n \n-        if (!template.isDrawed()){\n-            throw new RuntimeException(\"Template with inode: \" + themeInode + \" is not drawed\");\n+        if (!workingTemplate.isDrawed()){\n+            throw new RuntimeException(\"Template with inode: \" + themeInodeOrId + \" is not drawed\");", "originalCommit": "bc72abff3e2f9a7262d8a202866fc8d97c798e57", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDU4MDkyMA==", "url": "https://github.com/dotCMS/core/pull/19482#discussion_r510580920", "bodyText": "Codacy found an issue: Avoid unused imports such as 'com.dotcms.content.elasticsearch.business.ESContentFactoryImpl'", "author": "dev-dotcms", "createdAt": "2020-10-23T04:01:53Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/templates/business/TemplateAPITest.java", "diffHunk": "@@ -1,10 +1,14 @@\n package com.dotmarketing.portlets.templates.business;\n \n import com.dotcms.IntegrationTestBase;\n+import com.dotcms.content.elasticsearch.business.ESContentFactoryImpl;", "originalCommit": "bc72abff3e2f9a7262d8a202866fc8d97c798e57", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDU4MDkyMw==", "url": "https://github.com/dotCMS/core/pull/19482#discussion_r510580923", "bodyText": "Codacy found an issue: Avoid variables with short names like id", "author": "dev-dotcms", "createdAt": "2020-10-23T04:01:54Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/templates/business/TemplateAPIImpl.java", "diffHunk": "@@ -455,23 +440,23 @@ public boolean delete(Template template, User user, boolean respectFrontendRoles\n \t\t}\n \t}\n \n-\tpublic Template findWorkingTemplate(String id, User user, boolean respectFrontendRoles) throws DotDataException, DotSecurityException {\n-\t\tVersionInfo info = APILocator.getVersionableAPI().getVersionInfo(id);\n+\tpublic Template findWorkingTemplate(final String id, final User user, final boolean respectFrontendRoles) throws DotDataException, DotSecurityException {", "originalCommit": "bc72abff3e2f9a7262d8a202866fc8d97c798e57", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDU4MDkyNw==", "url": "https://github.com/dotCMS/core/pull/19482#discussion_r510580927", "bodyText": "Codacy found an issue: All methods are static.  Consider using a utility class instead. Alternatively, you could add a private constructor or make the class abstract to silence this warning.", "author": "dev-dotcms", "createdAt": "2020-10-23T04:01:55Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/templates/business/TemplateSQL.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package com.dotmarketing.portlets.templates.business;\n+\n+import com.dotmarketing.beans.Inode.Type;\n+\n+public class TemplateSQL {", "originalCommit": "bc72abff3e2f9a7262d8a202866fc8d97c798e57", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDU4MDkzMA==", "url": "https://github.com/dotCMS/core/pull/19482#discussion_r510580930", "bodyText": "Codacy found an issue: Avoid unused imports such as 'io.vavr.control.Try'", "author": "dev-dotcms", "createdAt": "2020-10-23T04:01:56Z", "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/viewtools/DotTemplateTool.java", "diffHunk": "@@ -21,6 +22,7 @@\n import com.dotmarketing.util.UtilMethods;\n import com.liferay.portal.model.User;\n \n+import io.vavr.control.Try;", "originalCommit": "bc72abff3e2f9a7262d8a202866fc8d97c798e57", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAwODkxOA==", "url": "https://github.com/dotCMS/core/pull/19482#discussion_r511008918", "bodyText": "remove this", "author": "nollymar", "createdAt": "2020-10-23T16:42:31Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/templates/business/TemplateSQL.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package com.dotmarketing.portlets.templates.business;\n+\n+import com.dotmarketing.beans.Inode.Type;\n+\n+public class TemplateSQL {\n+\n+    public static TemplateSQL getInstance(){ return new TemplateSQL(); }\n+\n+    public static final String FIND_TEMPLATES_BY_HOST_INODE =\n+            \"select template.*, template_1_.*  from \" + Type.TEMPLATE.getTableName() + \" template, inode template_1_, \" +\n+                    \"identifier template_identifier, \" + Type.TEMPLATE.getVersionTableName() + \" vi where \" +\n+                    \"template_identifier.host_inode = ? and template_identifier.id = template.identifier and \" +\n+                    \"template.inode = template_1_.inode and vi.identifier=template.identifier and \" +\n+                    \"template.inode=vi.working_inode \";\n+\n+    public static final String FIND_WORKING_TEMPLATE_BY_HOST_INODE_AND_TITLE =\n+            \"select template.*, template_1_.* from \" + Type.TEMPLATE.getTableName() + \" template, inode template_1_, \" +\n+                    \"identifier template_identifier, \" + Type.TEMPLATE.getVersionTableName() + \" vi where \" +\n+                    \"template_identifier.host_inode = ? and template_identifier.id = template.identifier and \" +\n+                    \"vi.identifier=template_identifier.id and template.title = ? and \" +\n+                    \"template.inode = template_1_.inode and \" +\n+                    \"template.inode=vi.working_inode \";\n+\n+//    public static final String SELECT_ALL_FIELDS = \"select inode, show_on_menu, title, mod_date, mod_user, \" +\n+//            \"sort_order, friendly_name, body, header, footer, image, identifier, drawed, drawed_body, \" +", "originalCommit": "bc72abff3e2f9a7262d8a202866fc8d97c798e57", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}