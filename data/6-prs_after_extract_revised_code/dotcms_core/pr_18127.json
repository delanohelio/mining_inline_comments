{"pr_number": 18127, "pr_title": "#17901 Fixing error in rules permission", "pr_createdAt": "2020-03-10T21:52:42Z", "pr_url": "https://github.com/dotCMS/core/pull/18127", "timeline": [{"oid": "8bfa60711ca8cf177c26b40b86326eb46ee7cc3d", "url": "https://github.com/dotCMS/core/commit/8bfa60711ca8cf177c26b40b86326eb46ee7cc3d", "message": "#17901 Fixing error in rules permission", "committedDate": "2020-03-10T21:44:43Z", "type": "commit"}, {"oid": "8aa161d79623af9f536a712a9bf41be4796db965", "url": "https://github.com/dotCMS/core/commit/8aa161d79623af9f536a712a9bf41be4796db965", "message": "#17901", "committedDate": "2020-03-10T22:19:53Z", "type": "commit"}, {"oid": "91d1acb6689278feea712e8d984d49a793b5c746", "url": "https://github.com/dotCMS/core/commit/91d1acb6689278feea712e8d984d49a793b5c746", "message": "#17882 testing", "committedDate": "2020-03-11T16:52:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTEzNTU1NA==", "url": "https://github.com/dotCMS/core/pull/18127#discussion_r391135554", "bodyText": "why are you comparing against 3 rules if the assert below verifies that there are just 2 rules in the collection?", "author": "nollymar", "createdAt": "2020-03-11T17:20:52Z", "path": "dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java", "diffHunk": "@@ -81,6 +253,95 @@ public void shouldGetRules() throws DotSecurityException, DotDataException {\n         assertFalse(rulesId.contains(rule3.getId()));\n     }\n \n+\n+    /**\n+     * Method to Test: {@link RulesAPIImpl#getAllRulesByParent(String, User)} )}\n+     * When: User with permission try to get all the rules from host\n+     * Should: Return all the rules from the host\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test\n+    public void shouldGetRulesFromHostId() throws DotSecurityException, DotDataException {\n+        final Role role = new RoleDataGen().nextPersisted();\n+        final User user = new UserDataGen().roles(role).nextPersisted();\n+        final Host host = new SiteDataGen().nextPersisted();\n+        final Rule rule1 = new RuleDataGen().host(host).nextPersisted();\n+        final Rule rule2 = new RuleDataGen().host(host).nextPersisted();\n+\n+        final Host anotherHost = new SiteDataGen().nextPersisted();\n+        final Rule rule3 = new RuleDataGen().host(anotherHost).nextPersisted();\n+\n+        this.addPermission(role, host, false);\n+        final List<Rule> rules = rulesAPI.getAllRulesByParent(host.getIdentifier(), user, false);\n+\n+        assertEquals(2, rules.size());\n+\n+        final List<String> rulesId = rules.stream().map(rule -> rule.getId()).collect(Collectors.toList());\n+        assertTrue(rulesId.contains(rule1.getId()));\n+        assertTrue(rulesId.contains(rule2.getId()));\n+        assertFalse(rulesId.contains(rule3.getId()));\n+    }\n+\n+\n+    /**\n+     * Method to Test: {@link RulesAPIImpl#getAllRulesByParent(String, User)} )}\n+     * When: User with permission try to get all the rules from host\n+     * Should: Return all the rules from the host\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test\n+    public void shouldGetRulesFromPageId() throws DotSecurityException, DotDataException {\n+        final Role role = new RoleDataGen().nextPersisted();\n+        final User user = new UserDataGen().roles(role).nextPersisted();\n+        final Host host = new SiteDataGen().nextPersisted();\n+        this.addPermission(role, host, false);\n+\n+        final Template template = new TemplateDataGen().nextPersisted();\n+        final Folder folder = new FolderDataGen().nextPersisted();\n+        final HTMLPageAsset htmlPageAsset = new HTMLPageDataGen(host, template)\n+                .folder(folder)\n+                .nextPersisted();\n+\n+        final Rule rule1 = new RuleDataGen().page(htmlPageAsset).nextPersisted();\n+        final Rule rule2 = new RuleDataGen().page(htmlPageAsset).nextPersisted();\n+        new RuleDataGen().host(host).nextPersisted();\n+\n+        final HTMLPageAsset anotherHtmlPageAsset = new HTMLPageDataGen(host, template).nextPersisted();\n+        final Rule rule3 = new RuleDataGen().page(anotherHtmlPageAsset).nextPersisted();\n+\n+        addPermissionToReadRulesFolder(role, folder);\n+\n+        final List<Rule> rules = rulesAPI.getAllRulesByParent(htmlPageAsset.getIdentifier(), user, false);\n+\n+        assertEquals(2, rules.size());\n+\n+        final List<String> rulesId = rules.stream().map(rule -> rule.getId()).collect(Collectors.toList());", "originalCommit": "91d1acb6689278feea712e8d984d49a793b5c746", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE0MTk2NQ==", "url": "https://github.com/dotCMS/core/pull/18127#discussion_r391141965", "bodyText": "because one of this rules is add in another page\nhttps://github.com/dotCMS/core/pull/18127/files/91d1acb6689278feea712e8d984d49a793b5c746#diff-9baded4fb0fb63e2648d9c9c4380ec1aR313", "author": "freddyucv", "createdAt": "2020-03-11T17:30:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTEzNTU1NA=="}], "type": "inlineReview", "revised_code": {"commit": "6ca6e589249aa68f1867d0712f6cd345a452ff93", "chunk": "diff --git a/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java b/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java\nindex 50ce78253c..0b4a4cd932 100644\n--- a/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java\n+++ b/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java\n\n@@ -254,6 +254,46 @@ public class RulesAPIImplIntegrationTest {\n     }\n \n \n+    /**\n+     * Method to Test: {@link RulesAPIImpl#getAllRulesByParent(Ruleable, User, boolean)}\n+     * When: The anonimous user have permission over the rules and try to get the rules with respectFrontendRoles set to true\n+     * Should: Return all the rules from the host\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test\n+    public void shouldGetRulesWithAnonymous() throws DotSecurityException, DotDataException {\n+        final Role role = new RoleDataGen().nextPersisted();\n+        final User user = new UserDataGen().roles(role).nextPersisted();\n+        final Host host = new SiteDataGen().nextPersisted();\n+        final Rule rule1 = new RuleDataGen().host(host).nextPersisted();\n+        final Rule rule2 = new RuleDataGen().host(host).nextPersisted();\n+\n+        final Host anotherHost = new SiteDataGen().nextPersisted();\n+        final Rule rule3 = new RuleDataGen().host(anotherHost).nextPersisted();\n+\n+        final Role anonymousRole = APILocator.getRoleAPI().loadCMSAnonymousRole();\n+\n+        final Permission hostReadPermission = new Permission();\n+        hostReadPermission.setInode(host.getPermissionId());\n+        hostReadPermission.setRoleId(role.getId());\n+        hostReadPermission.setPermission(PermissionAPI.PERMISSION_USE);\n+\n+        APILocator.getPermissionAPI().save(list(hostReadPermission), host, systemUser, false);\n+\n+        this.addPermission(anonymousRole, host, false);\n+\n+        final List<Rule> rules = rulesAPI.getAllRulesByParent(host, user, true);\n+\n+        assertEquals(2, rules.size());\n+\n+        /*final List<String> rulesId = rules.stream().map(rule -> rule.getId()).collect(Collectors.toList());\n+        assertTrue(rulesId.contains(rule1.getId()));\n+        assertTrue(rulesId.contains(rule2.getId()));\n+        assertFalse(rulesId.contains(rule3.getId()));*/\n+    }\n+\n     /**\n      * Method to Test: {@link RulesAPIImpl#getAllRulesByParent(String, User)} )}\n      * When: User with permission try to get all the rules from host\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTEzODY0OA==", "url": "https://github.com/dotCMS/core/pull/18127#discussion_r391138648", "bodyText": "I think you should also compare the parent, not just the size", "author": "nollymar", "createdAt": "2020-03-11T17:25:37Z", "path": "dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java", "diffHunk": "@@ -119,6 +418,30 @@ public void shouldReturnEmptyList() throws DotSecurityException, DotDataExceptio\n         assertTrue( rules.isEmpty());\n     }\n \n+    /**\n+     * Method to Test: {@link RulesAPIImpl#saveRule(Rule, User, boolean)}\n+     * When: A not admin user with right permission try to save a new rule in a Page\n+     * Should: Save the new rule\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test\n+    public void shouldSaveNewRuleInPage() throws DotSecurityException, DotDataException {\n+        final Role role = new RoleDataGen().nextPersisted();\n+        final User user = new UserDataGen().roles(role).nextPersisted();\n+        final Host host = new SiteDataGen().nextPersisted();\n+        final Template template = new TemplateDataGen().nextPersisted();\n+        final HTMLPageAsset htmlPageAsset = new HTMLPageDataGen(host, template).nextPersisted();\n+        final Rule rule = new RuleDataGen().page(htmlPageAsset).next();\n+\n+        this.addPermission(role, host, true);\n+        rulesAPI.saveRule(rule, user, false);\n+\n+        final List<Rule> rules = rulesAPI.getAllRulesByParent(htmlPageAsset, systemUser, true);\n+        assertEquals(1, rules.size());", "originalCommit": "91d1acb6689278feea712e8d984d49a793b5c746", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE4MDg5Nw==", "url": "https://github.com/dotCMS/core/pull/18127#discussion_r391180897", "bodyText": "done 6ca6e58#diff-9baded4fb0fb63e2648d9c9c4380ec1aR483", "author": "freddyucv", "createdAt": "2020-03-11T18:33:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTEzODY0OA=="}], "type": "inlineReview", "revised_code": {"commit": "6ca6e589249aa68f1867d0712f6cd345a452ff93", "chunk": "diff --git a/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java b/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java\nindex 50ce78253c..0b4a4cd932 100644\n--- a/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java\n+++ b/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java\n\n@@ -434,12 +474,14 @@ public class RulesAPIImplIntegrationTest {\n         final Template template = new TemplateDataGen().nextPersisted();\n         final HTMLPageAsset htmlPageAsset = new HTMLPageDataGen(host, template).nextPersisted();\n         final Rule rule = new RuleDataGen().page(htmlPageAsset).next();\n-\n         this.addPermission(role, host, true);\n         rulesAPI.saveRule(rule, user, false);\n \n         final List<Rule> rules = rulesAPI.getAllRulesByParent(htmlPageAsset, systemUser, true);\n         assertEquals(1, rules.size());\n+\n+        final List<String> rulesId = rules.stream().map(pageRule -> pageRule.getId()).collect(Collectors.toList());\n+        assertTrue(rulesId.contains(rule.getId()));\n     }\n \n     /**\n"}}, {"oid": "6ca6e589249aa68f1867d0712f6cd345a452ff93", "url": "https://github.com/dotCMS/core/commit/6ca6e589249aa68f1867d0712f6cd345a452ff93", "message": "#17901 testing", "committedDate": "2020-03-11T18:24:13Z", "type": "commit"}, {"oid": "a2480c1acb9ab72ce418b9f1a7b293d82b2f7f55", "url": "https://github.com/dotCMS/core/commit/a2480c1acb9ab72ce418b9f1a7b293d82b2f7f55", "message": "#17901 testing", "committedDate": "2020-03-11T18:31:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI4NTQzMg==", "url": "https://github.com/dotCMS/core/pull/18127#discussion_r391285432", "bodyText": "I think the expected value goes at first", "author": "dsilvam", "createdAt": "2020-03-11T21:43:32Z", "path": "dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java", "diffHunk": "@@ -51,6 +51,178 @@ public static void prepare() throws Exception {\n         rulesAPI   = APILocator.getRulesAPI();\n     }\n \n+\n+    /**\n+     * Method to Test: {@link RulesAPIImpl#saveConditionGroup(ConditionGroup, User, boolean)}\n+     *                  and {@link RulesAPIImpl#saveCondition(Condition, User, boolean)}\n+     * When: User with permission try to create a Group Condition and a Condition\n+     * Should: Delete it\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test\n+    public void shouldSaveCondition() throws DotSecurityException, DotDataException {\n+        final Role role = new RoleDataGen().nextPersisted();\n+        final User user = new UserDataGen().roles(role).nextPersisted();\n+        final Host host = new SiteDataGen().nextPersisted();\n+        final Rule rule = new RuleDataGen().host(host).nextPersisted();\n+\n+        final ConditionGroup conditionGroup = new ConditionGroupDataGen().rule(rule).next();\n+        this.addPermission(role, host, true);\n+\n+        //Saving and testing GroupCondition\n+        rulesAPI.saveConditionGroup(conditionGroup, user, false);\n+\n+        List<Rule> allRules = rulesAPI.getAllRules(user, false);\n+        assertEquals(1, allRules.size());\n+\n+        final Rule ruleFromDataBase = allRules.get(0);\n+\n+        final List<ConditionGroup> groups = ruleFromDataBase.getGroups();\n+        assertEquals(1, groups.size());\n+\n+        assertEquals(groups.get(0).getOperator(), conditionGroup.getOperator());", "originalCommit": "a2480c1acb9ab72ce418b9f1a7b293d82b2f7f55", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI4NjU3NA==", "url": "https://github.com/dotCMS/core/pull/18127#discussion_r391286574", "bodyText": "done d8a32ec#diff-9baded4fb0fb63e2648d9c9c4380ec1aR84", "author": "freddyucv", "createdAt": "2020-03-11T21:46:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI4NTQzMg=="}], "type": "inlineReview", "revised_code": {"commit": "d8a32ec5a775f434c7ee34caeaa3b0e19018ab5f", "chunk": "diff --git a/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java b/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java\nindex ec08ee3d9c..42b64ba4e3 100644\n--- a/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java\n+++ b/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java\n\n@@ -82,7 +81,7 @@ public class RulesAPIImplIntegrationTest {\n         final List<ConditionGroup> groups = ruleFromDataBase.getGroups();\n         assertEquals(1, groups.size());\n \n-        assertEquals(groups.get(0).getOperator(), conditionGroup.getOperator());\n+        assertEquals(conditionGroup.getOperator(), groups.get(0).getOperator());\n \n         //Saving and testing Condition\n         final Condition condition = new ConditionDataGen().group(groups.get(0)).next();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI4ODA3NQ==", "url": "https://github.com/dotCMS/core/pull/18127#discussion_r391288075", "bodyText": "this assert doesn't look like it's needed", "author": "dsilvam", "createdAt": "2020-03-11T21:49:38Z", "path": "dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java", "diffHunk": "@@ -51,6 +51,178 @@ public static void prepare() throws Exception {\n         rulesAPI   = APILocator.getRulesAPI();\n     }\n \n+\n+    /**\n+     * Method to Test: {@link RulesAPIImpl#saveConditionGroup(ConditionGroup, User, boolean)}\n+     *                  and {@link RulesAPIImpl#saveCondition(Condition, User, boolean)}\n+     * When: User with permission try to create a Group Condition and a Condition\n+     * Should: Delete it\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test\n+    public void shouldSaveCondition() throws DotSecurityException, DotDataException {\n+        final Role role = new RoleDataGen().nextPersisted();\n+        final User user = new UserDataGen().roles(role).nextPersisted();\n+        final Host host = new SiteDataGen().nextPersisted();\n+        final Rule rule = new RuleDataGen().host(host).nextPersisted();\n+\n+        final ConditionGroup conditionGroup = new ConditionGroupDataGen().rule(rule).next();\n+        this.addPermission(role, host, true);\n+\n+        //Saving and testing GroupCondition\n+        rulesAPI.saveConditionGroup(conditionGroup, user, false);\n+\n+        List<Rule> allRules = rulesAPI.getAllRules(user, false);\n+        assertEquals(1, allRules.size());\n+\n+        final Rule ruleFromDataBase = allRules.get(0);\n+\n+        final List<ConditionGroup> groups = ruleFromDataBase.getGroups();\n+        assertEquals(1, groups.size());\n+\n+        assertEquals(groups.get(0).getOperator(), conditionGroup.getOperator());\n+\n+        //Saving and testing Condition\n+        final Condition condition = new ConditionDataGen().group(groups.get(0)).next();\n+\n+        rulesAPI.saveCondition(condition, user, false);\n+\n+        allRules = rulesAPI.getAllRules(user, false);\n+        assertEquals(1, allRules.size());", "originalCommit": "a2480c1acb9ab72ce418b9f1a7b293d82b2f7f55", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY5ODIzNA==", "url": "https://github.com/dotCMS/core/pull/18127#discussion_r391698234", "bodyText": "done d8a32ec#diff-9baded4fb0fb63e2648d9c9c4380ec1aL93", "author": "freddyucv", "createdAt": "2020-03-12T15:24:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI4ODA3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "d8a32ec5a775f434c7ee34caeaa3b0e19018ab5f", "chunk": "diff --git a/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java b/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java\nindex ec08ee3d9c..42b64ba4e3 100644\n--- a/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java\n+++ b/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java\n\n@@ -82,7 +81,7 @@ public class RulesAPIImplIntegrationTest {\n         final List<ConditionGroup> groups = ruleFromDataBase.getGroups();\n         assertEquals(1, groups.size());\n \n-        assertEquals(groups.get(0).getOperator(), conditionGroup.getOperator());\n+        assertEquals(conditionGroup.getOperator(), groups.get(0).getOperator());\n \n         //Saving and testing Condition\n         final Condition condition = new ConditionDataGen().group(groups.get(0)).next();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI5MzUxOQ==", "url": "https://github.com/dotCMS/core/pull/18127#discussion_r391293519", "bodyText": "assert not needed", "author": "dsilvam", "createdAt": "2020-03-11T22:03:39Z", "path": "dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java", "diffHunk": "@@ -51,6 +51,178 @@ public static void prepare() throws Exception {\n         rulesAPI   = APILocator.getRulesAPI();\n     }\n \n+\n+    /**\n+     * Method to Test: {@link RulesAPIImpl#saveConditionGroup(ConditionGroup, User, boolean)}\n+     *                  and {@link RulesAPIImpl#saveCondition(Condition, User, boolean)}\n+     * When: User with permission try to create a Group Condition and a Condition\n+     * Should: Delete it\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test\n+    public void shouldSaveCondition() throws DotSecurityException, DotDataException {\n+        final Role role = new RoleDataGen().nextPersisted();\n+        final User user = new UserDataGen().roles(role).nextPersisted();\n+        final Host host = new SiteDataGen().nextPersisted();\n+        final Rule rule = new RuleDataGen().host(host).nextPersisted();\n+\n+        final ConditionGroup conditionGroup = new ConditionGroupDataGen().rule(rule).next();\n+        this.addPermission(role, host, true);\n+\n+        //Saving and testing GroupCondition\n+        rulesAPI.saveConditionGroup(conditionGroup, user, false);\n+\n+        List<Rule> allRules = rulesAPI.getAllRules(user, false);\n+        assertEquals(1, allRules.size());\n+\n+        final Rule ruleFromDataBase = allRules.get(0);\n+\n+        final List<ConditionGroup> groups = ruleFromDataBase.getGroups();\n+        assertEquals(1, groups.size());\n+\n+        assertEquals(groups.get(0).getOperator(), conditionGroup.getOperator());\n+\n+        //Saving and testing Condition\n+        final Condition condition = new ConditionDataGen().group(groups.get(0)).next();\n+\n+        rulesAPI.saveCondition(condition, user, false);\n+\n+        allRules = rulesAPI.getAllRules(user, false);\n+        assertEquals(1, allRules.size());\n+        final List<Condition> conditions = allRules.get(0).getGroups().get(0).getConditions();\n+\n+        assertEquals(1, conditions.size());\n+\n+        assertEquals(condition.getOperator(), conditions.get(0).getOperator());\n+    }\n+\n+    /**\n+     * Method to Test: {@link RulesAPIImpl#saveConditionGroup(ConditionGroup, User, boolean)}\n+     * When: User without permission try to create a Group Condition\n+     * Should: Throw a DotSecurityException\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test(expected = DotSecurityException.class)\n+    public void shouldNotSaveCondition() throws DotDataException, DotSecurityException {\n+        final Role role = new RoleDataGen().nextPersisted();\n+        final User user = new UserDataGen().roles(role).nextPersisted();\n+        final Host host = new SiteDataGen().nextPersisted();\n+        final Rule rule = new RuleDataGen().host(host).nextPersisted();\n+\n+        final ConditionGroup conditionGroup = new ConditionGroupDataGen().rule(rule).next();\n+        rulesAPI.saveConditionGroup(conditionGroup, user, false);\n+    }\n+\n+    /**\n+     * Method to Test: {@link RulesAPIImpl#saveRuleAction(RuleAction, User, boolean)}\n+     * When: User with permission try to create a Rule's Action\n+     * Should: Save it\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test\n+    public void shouldSaveRuleAction() throws DotSecurityException, DotDataException {\n+        final Role role = new RoleDataGen().nextPersisted();\n+        final User user = new UserDataGen().roles(role).nextPersisted();\n+        final Host host = new SiteDataGen().nextPersisted();\n+        final Rule rule = new RuleDataGen().host(host).nextPersisted();\n+\n+        this.addPermission(role, host, true);\n+\n+        final RuleAction ruleAction = new RuleActionDataGen().rule(rule).next();\n+\n+        rulesAPI.saveRuleAction(ruleAction, user, false);\n+\n+        final List<Rule> allRules = rulesAPI.getAllRules(user, false);\n+        assertEquals(1, allRules.size());", "originalCommit": "a2480c1acb9ab72ce418b9f1a7b293d82b2f7f55", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY5ODM4OA==", "url": "https://github.com/dotCMS/core/pull/18127#discussion_r391698388", "bodyText": "done d8a32ec#diff-9baded4fb0fb63e2648d9c9c4380ec1aL142", "author": "freddyucv", "createdAt": "2020-03-12T15:24:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI5MzUxOQ=="}], "type": "inlineReview", "revised_code": {"commit": "d8a32ec5a775f434c7ee34caeaa3b0e19018ab5f", "chunk": "diff --git a/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java b/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java\nindex ec08ee3d9c..42b64ba4e3 100644\n--- a/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java\n+++ b/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java\n\n@@ -82,7 +81,7 @@ public class RulesAPIImplIntegrationTest {\n         final List<ConditionGroup> groups = ruleFromDataBase.getGroups();\n         assertEquals(1, groups.size());\n \n-        assertEquals(groups.get(0).getOperator(), conditionGroup.getOperator());\n+        assertEquals(conditionGroup.getOperator(), groups.get(0).getOperator());\n \n         //Saving and testing Condition\n         final Condition condition = new ConditionDataGen().group(groups.get(0)).next();\n"}}, {"oid": "d8a32ec5a775f434c7ee34caeaa3b0e19018ab5f", "url": "https://github.com/dotCMS/core/commit/d8a32ec5a775f434c7ee34caeaa3b0e19018ab5f", "message": "#17901 refactoring", "committedDate": "2020-03-12T15:03:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc1OTM5Ng==", "url": "https://github.com/dotCMS/core/pull/18127#discussion_r391759396", "bodyText": "Issue found: The String literal \"siteId\" appears 5 times in this file; the first occurrence is on line 80", "author": "dev-dotcms", "createdAt": "2020-03-12T16:56:34Z", "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/sites/ruleengine/rules/RuleResource.java", "diffHunk": "@@ -82,12 +77,11 @@ protected RuleResource(ApiProvider apiProvider, WebResource webResource) {\n     public Map<String, RestRule> list(\n             @Context final HttpServletRequest request,\n             @Context final HttpServletResponse response,\n-            @PathParam(\"siteId\") String siteId) throws DotSecurityException, DotDataException {\n+            @PathParam(\"siteId\") String parentId) throws DotSecurityException, DotDataException {", "originalCommit": "d8a32ec5a775f434c7ee34caeaa3b0e19018ab5f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc1OTQwNA==", "url": "https://github.com/dotCMS/core/pull/18127#discussion_r391759404", "bodyText": "Issue found: Avoid reassigning parameters such as 'parentId'", "author": "dev-dotcms", "createdAt": "2020-03-12T16:56:36Z", "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/sites/ruleengine/rules/RuleResource.java", "diffHunk": "@@ -82,12 +77,11 @@ protected RuleResource(ApiProvider apiProvider, WebResource webResource) {\n     public Map<String, RestRule> list(\n             @Context final HttpServletRequest request,\n             @Context final HttpServletResponse response,\n-            @PathParam(\"siteId\") String siteId) throws DotSecurityException, DotDataException {\n+            @PathParam(\"siteId\") String parentId) throws DotSecurityException, DotDataException {", "originalCommit": "d8a32ec5a775f434c7ee34caeaa3b0e19018ab5f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc1OTQxNA==", "url": "https://github.com/dotCMS/core/pull/18127#discussion_r391759414", "bodyText": "Issue found: Avoid unused imports such as 'com.dotcms.datagen'", "author": "dev-dotcms", "createdAt": "2020-03-12T16:56:37Z", "path": "dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java", "diffHunk": "@@ -1,15 +1,14 @@\n package com.dotcms.enterprise.rules;\n \n-import com.dotcms.datagen.RoleDataGen;\n-import com.dotcms.datagen.SiteDataGen;\n-import com.dotcms.datagen.UserDataGen;\n-import com.dotcms.util.CollectionsUtils;\n+import com.dotcms.datagen.*;", "originalCommit": "d8a32ec5a775f434c7ee34caeaa3b0e19018ab5f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc1OTQyOA==", "url": "https://github.com/dotCMS/core/pull/18127#discussion_r391759428", "bodyText": "Issue found: Avoid unused imports such as 'org.junit.Assert'", "author": "dev-dotcms", "createdAt": "2020-03-12T16:56:38Z", "path": "dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java", "diffHunk": "@@ -27,10 +27,9 @@\n import java.util.List;\n import java.util.stream.Collectors;\n \n+import static com.dotcms.util.CollectionsUtils.list;\n import static org.jgroups.util.Util.assertFalse;\n-import static org.junit.Assert.assertEquals;\n-import static org.junit.Assert.assertNull;\n-import static org.junit.Assert.assertTrue;\n+import static org.junit.Assert.*;", "originalCommit": "d8a32ec5a775f434c7ee34caeaa3b0e19018ab5f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}