{"pr_number": 17922, "pr_title": "#17904 first draft for the reset approver actionlet", "pr_createdAt": "2020-01-28T22:32:47Z", "pr_url": "https://github.com/dotCMS/core/pull/17922", "timeline": [{"oid": "6497802cdc810f8fcc5e9f5f7c6e0573b0632850", "url": "https://github.com/dotCMS/core/commit/6497802cdc810f8fcc5e9f5f7c6e0573b0632850", "message": "#17904 first draft for the reset approver actionlet", "committedDate": "2020-01-28T22:32:27Z", "type": "commit"}, {"oid": "376046627ec1cd0faf36f456cab6b9c15bdef1be", "url": "https://github.com/dotCMS/core/commit/376046627ec1cd0faf36f456cab6b9c15bdef1be", "message": "#17904 adding new change to update instead of delete the approval messages, in addition an action name or id could be pass to associate the reset actionlet to another action", "committedDate": "2020-01-29T23:03:33Z", "type": "commit"}, {"oid": "aa34e8b702cc3592c8bc161c730fac88e0a5ba28", "url": "https://github.com/dotCMS/core/commit/aa34e8b702cc3592c8bc161c730fac88e0a5ba28", "message": "#17904 adding some fixes", "committedDate": "2020-01-30T22:11:36Z", "type": "commit"}, {"oid": "434050eb9e0b9606c2c86837821dcf8a8bd7b5ab", "url": "https://github.com/dotCMS/core/commit/434050eb9e0b9606c2c86837821dcf8a8bd7b5ab", "message": "#17904 codacy feedback done", "committedDate": "2020-01-30T22:26:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzUwMTM2OA==", "url": "https://github.com/dotCMS/core/pull/17922#discussion_r373501368", "bodyText": "While this method looks ok, as a general rule, I am not a fan of writing shallow custom wrappers on top of what apis provide.  It seems like code sprawl.  Do we need to maintain boilerplate code like this?  Why not just use a lamda filter ... and .findFirst() which is going to be better tested?", "author": "wezell", "createdAt": "2020-01-31T14:19:10Z", "path": "dotCMS/src/main/java/com/dotcms/util/CollectionsUtils.java", "diffHunk": "@@ -926,7 +925,27 @@\n \t    return new ImmutableListCollector<>();\n     }\n \n-\tprivate static class ImmutableListCollector<T> implements Collector<T, ImmutableList.Builder<T>, ImmutableList<T>> {\n+    /**", "originalCommit": "434050eb9e0b9606c2c86837821dcf8a8bd7b5ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU5ODQzNQ==", "url": "https://github.com/dotCMS/core/pull/17922#discussion_r373598435", "bodyText": "you right, removed", "author": "jdotcms", "createdAt": "2020-01-31T17:35:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzUwMTM2OA=="}], "type": "inlineReview", "revised_code": {"commit": "4d4e71cda9444f1c3efa7070be96f241ee69b4a8", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/util/CollectionsUtils.java b/dotCMS/src/main/java/com/dotcms/util/CollectionsUtils.java\nindex 614a170ce0..1c6a7dbf7a 100644\n--- a/dotCMS/src/main/java/com/dotcms/util/CollectionsUtils.java\n+++ b/dotCMS/src/main/java/com/dotcms/util/CollectionsUtils.java\n\n@@ -925,26 +925,6 @@ public class CollectionsUtils implements Serializable {\n \t    return new ImmutableListCollector<>();\n     }\n \n-    /**\n-     * Finds a element into the list base on the function comparator (receives the element and returns true if match is right)\n-     * @param items {@link List}\n-     * @param comparator {@link Function} to determine if it is the match or not\n-     * @param <T>\n-     * @return Optional, return empty if not match, otherwise the first match element\n-     */\n-    public static <T> Optional<T> find(final List<T> items, final Function<T, Boolean> comparator) {\n-\n-\t    for (final T item : items) {\n-\n-\t        if (comparator.apply(item)) {\n-\n-\t            return Optional.ofNullable(item);\n-            }\n-        }\n-\n-\t    return Optional.empty();\n-    }\n-\n     private static class ImmutableListCollector<T> implements Collector<T, ImmutableList.Builder<T>, ImmutableList<T>> {\n         @Override\n         public Supplier<ImmutableList.Builder<T>> supplier() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzUwMTk0Mg==", "url": "https://github.com/dotCMS/core/pull/17922#discussion_r373501942", "bodyText": "A unique name should happen automatically when you call new SiteDataGen().nextPersisted(); If it doesn't, this code should be moved there.", "author": "wezell", "createdAt": "2020-01-31T14:20:19Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/workflows/actionlet/FourEyeApproverActionletTest.java", "diffHunk": "@@ -83,7 +83,7 @@ public static void prepare() throws Exception {\n         contentletAPI = APILocator.getContentletAPI();\n         languageAPI = APILocator.getLanguageAPI();\n \n-        site = new SiteDataGen().nextPersisted();\n+        site = new SiteDataGen().name(\"site\"+System.currentTimeMillis()).nextPersisted();", "originalCommit": "434050eb9e0b9606c2c86837821dcf8a8bd7b5ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU5NjIwMw==", "url": "https://github.com/dotCMS/core/pull/17922#discussion_r373596203", "bodyText": "You right fixed", "author": "jdotcms", "createdAt": "2020-01-31T17:30:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzUwMTk0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "4d4e71cda9444f1c3efa7070be96f241ee69b4a8", "chunk": "diff --git a/dotCMS/src/integration-test/java/com/dotmarketing/portlets/workflows/actionlet/FourEyeApproverActionletTest.java b/dotCMS/src/integration-test/java/com/dotmarketing/portlets/workflows/actionlet/FourEyeApproverActionletTest.java\nindex 47f36af398..cfe22fda24 100644\n--- a/dotCMS/src/integration-test/java/com/dotmarketing/portlets/workflows/actionlet/FourEyeApproverActionletTest.java\n+++ b/dotCMS/src/integration-test/java/com/dotmarketing/portlets/workflows/actionlet/FourEyeApproverActionletTest.java\n\n@@ -83,7 +83,7 @@ public class FourEyeApproverActionletTest extends BaseWorkflowIntegrationTest {\n         contentletAPI = APILocator.getContentletAPI();\n         languageAPI = APILocator.getLanguageAPI();\n \n-        site = new SiteDataGen().name(\"site\"+System.currentTimeMillis()).nextPersisted();\n+        site = new SiteDataGen().nextPersisted();\n         // Get the test role and two users from such a role\n         final Role publisherRole = TestUserUtils.getOrCreatePublisherRole(site);\n         publisher1 = TestUserUtils.getChrisPublisherUser(site);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzUwODE5NQ==", "url": "https://github.com/dotCMS/core/pull/17922#discussion_r373508195", "bodyText": "Good tests!", "author": "wezell", "createdAt": "2020-01-31T14:32:28Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/workflows/model/WorkflowHistoryTest.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.dotmarketing.portlets.workflows.model;\n+\n+import com.liferay.util.StringPool;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.util.Map;\n+\n+public class WorkflowHistoryTest {\n+\n+    @Test\n+    public void test_getChangeMap_null_description ()  {\n+\n+        final WorkflowHistory workflowHistory = new WorkflowHistory();\n+        workflowHistory.setChangeDescription(null);\n+        final Map<String, Object> changeMap = workflowHistory.getChangeMap();\n+\n+        Assert.assertNotNull(\"GetChangeMap must not return a null map\",changeMap);\n+        Assert.assertEquals(\"Should return a blank description\", changeMap.get(\"description\"), StringPool.BLANK);\n+        Assert.assertEquals(\"Should return a comment type\", changeMap.get(\"type\"), WorkflowHistoryType.COMMENT.name());\n+        Assert.assertEquals(\"Should return a comment type\", changeMap.get(\"state\"), WorkflowHistoryState.NONE.name());\n+    }\n+\n+    @Test\n+    public void test_getChangeMap_with_description ()  {\n+\n+        final WorkflowHistory workflowHistory = new WorkflowHistory();\n+        workflowHistory.setChangeDescription(\"test\");\n+        final Map<String, Object> changeMap = workflowHistory.getChangeMap();\n+\n+        Assert.assertNotNull(\"GetChangeMap must not return a null map\",changeMap);\n+        Assert.assertEquals(\"Should return test description\", workflowHistory.getChangeDescription(), \"test\");\n+        Assert.assertEquals(\"Should return test description\", changeMap.get(\"description\"), \"test\");\n+        Assert.assertEquals(\"Should return a comment type\", changeMap.get(\"type\"), WorkflowHistoryType.COMMENT.name());\n+        Assert.assertEquals(\"Should return a comment type\", changeMap.get(\"state\"), WorkflowHistoryState.NONE.name());\n+    }\n+\n+    @Test\n+    public void test_getChangeMap_approval_type ()  {\n+\n+        final WorkflowHistory workflowHistory = new WorkflowHistory();\n+        workflowHistory.setChangeDescription(\"{'description':'test', 'type':'\" + WorkflowHistoryType.APPROVAL.name() + \"', 'state':'\"+  WorkflowHistoryState.NONE.name() +\"' }\");\n+        final Map<String, Object> changeMap = workflowHistory.getChangeMap();\n+\n+        Assert.assertNotNull(\"GetChangeMap must not return a null map\",changeMap);\n+        Assert.assertEquals(\"Should return test description\", workflowHistory.getChangeDescription(), \"test\");\n+        Assert.assertEquals(\"Should return test description\", changeMap.get(\"description\"), \"test\");\n+        Assert.assertEquals(\"Should return approval type\", changeMap.get(\"type\"), WorkflowHistoryType.APPROVAL.name());\n+        Assert.assertEquals(\"Should return a comment type\", changeMap.get(\"state\"), WorkflowHistoryState.NONE.name());\n+    }\n+}", "originalCommit": "434050eb9e0b9606c2c86837821dcf8a8bd7b5ab", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzUwOTUyMQ==", "url": "https://github.com/dotCMS/core/pull/17922#discussion_r373509521", "bodyText": "These should be a Logger.warn\nIf we are not going to log the stack, which is ok, we should at least include the e.getMessage() in our message.  Otherwise the root cause is totally obfuscated.  Logger.warnAndDebug() works as well.", "author": "wezell", "createdAt": "2020-01-31T14:35:10Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/workflows/actionlet/MultipleApproverActionlet.java", "diffHunk": "@@ -64,95 +54,93 @@ public void executeAction(WorkflowProcessor processor, Map<String, WorkflowActio\n \t\t\t}\n \t\t}\n \n-\t\tSet<User> requiredApprovers = new HashSet<User>();\n-\t\tSet<User> hasApproved = new HashSet<User>();\n-\t\tStringTokenizer st = new StringTokenizer(userIds, \", \");\n-\t\twhile (st.hasMoreTokens()) {\n-\t\t\tString x = st.nextToken();\n+\t\tfinal Set<User> requiredApprovers = new HashSet<>();\n+\t\tfinal Set<User> hasApproved       = new HashSet<>();\n+\t\tfinal StringTokenizer userIdTokenizer = new StringTokenizer(userIds, StringPool.COMMA);\n+\t\twhile (userIdTokenizer.hasMoreTokens()) {\n \n-\t\t\tif (Validator.isEmailAddress(x)) {\n+\t\t\tfinal String userIdToken = userIdTokenizer.nextToken();\n+\n+\t\t\tif (Validator.isEmailAddress(userIdToken)) {\n \t\t\t\ttry {\n-\t\t\t\t\tUser u = APILocator.getUserAPI().loadByUserByEmail(x, APILocator.getUserAPI().getSystemUser(), false);\n \n-\t\t\t\t\trequiredApprovers.add(u);\n+\t\t\t\t\tfinal User user = APILocator.getUserAPI().loadByUserByEmail(userIdToken,\n+\t\t\t\t\t\t\tAPILocator.getUserAPI().getSystemUser(), false);\n+\n+\t\t\t\t\trequiredApprovers.add(user);\n \t\t\t\t} catch (Exception e) {\n-\t\t\t\t\tLogger.error(this.getClass(), \"Unable to find user with email:\" + x);\n+\n+\t\t\t\t\tLogger.error(this.getClass(), \"Unable to find user with email:\" + userIdToken);\n \t\t\t\t}\n \t\t\t} else {\n \t\t\t\ttry {\n \n-\t\t\t\t\tUser u = APILocator.getUserAPI().loadUserById(x, APILocator.getUserAPI().getSystemUser(), false);\n-\t\t\t\t\trequiredApprovers.add(u);\n+\t\t\t\t\tfinal User user = APILocator.getUserAPI().loadUserById(userIdToken,\n+\t\t\t\t\t\t\tAPILocator.getUserAPI().getSystemUser(), false);\n+\t\t\t\t\trequiredApprovers.add(user);\n \t\t\t\t} catch (Exception e) {\n-\t\t\t\t\tLogger.error(this.getClass(), \"Unable to find user with userID:\" + x);\n+\t\t\t\t\tLogger.error(this.getClass(), \"Unable to find user with userID:\" + userIdToken);", "originalCommit": "434050eb9e0b9606c2c86837821dcf8a8bd7b5ab", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4d4e71cda9444f1c3efa7070be96f241ee69b4a8", "chunk": "diff --git a/dotCMS/src/main/java/com/dotmarketing/portlets/workflows/actionlet/MultipleApproverActionlet.java b/dotCMS/src/main/java/com/dotmarketing/portlets/workflows/actionlet/MultipleApproverActionlet.java\nindex 631f37ead5..4010762af1 100644\n--- a/dotCMS/src/main/java/com/dotmarketing/portlets/workflows/actionlet/MultipleApproverActionlet.java\n+++ b/dotCMS/src/main/java/com/dotmarketing/portlets/workflows/actionlet/MultipleApproverActionlet.java\n\n@@ -70,7 +82,8 @@ public class MultipleApproverActionlet extends WorkFlowActionlet {\n \t\t\t\t\trequiredApprovers.add(user);\n \t\t\t\t} catch (Exception e) {\n \n-\t\t\t\t\tLogger.error(this.getClass(), \"Unable to find user with email:\" + userIdToken);\n+\t\t\t\t\tLogger.warnAndDebug(this.getClass(), \"Unable to find user with email:\" + userIdToken\n+\t\t\t\t\t\t\t+ \", message: \" + e.getMessage(), e);\n \t\t\t\t}\n \t\t\t} else {\n \t\t\t\ttry {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzUxMTI5MA==", "url": "https://github.com/dotCMS/core/pull/17922#discussion_r373511290", "bodyText": "I think we have an StringUtils.isJson method.    Maybe it needs a null check and a trim() but those would be good to have.", "author": "wezell", "createdAt": "2020-01-31T14:38:38Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/workflows/model/WorkflowHistory.java", "diffHunk": "@@ -65,7 +69,30 @@ public void setCreationDate(Date creationDate) {\n     }\r\n \r\n     public String getChangeDescription() {\r\n-        return changeDescription;\r\n+\r\n+        if (UtilMethods.isSet(this.changeDescription) && this.changeDescription.trim().startsWith(\"{\")) {\r", "originalCommit": "434050eb9e0b9606c2c86837821dcf8a8bd7b5ab", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4d4e71cda9444f1c3efa7070be96f241ee69b4a8", "chunk": "diff --git a/dotCMS/src/main/java/com/dotmarketing/portlets/workflows/model/WorkflowHistory.java b/dotCMS/src/main/java/com/dotmarketing/portlets/workflows/model/WorkflowHistory.java\nindex a078b7e270..d5d0f0dc5a 100644\n--- a/dotCMS/src/main/java/com/dotmarketing/portlets/workflows/model/WorkflowHistory.java\n+++ b/dotCMS/src/main/java/com/dotmarketing/portlets/workflows/model/WorkflowHistory.java\n\n@@ -85,7 +86,7 @@ public class WorkflowHistory  implements Serializable, WorkflowTimelineItem\n \n     public Map<String, Object> getChangeMap () {\n \n-        if (UtilMethods.isSet(this.changeDescription) && this.changeDescription.trim().startsWith(\"{\")) {\n+        if (UtilMethods.isSet(this.changeDescription) && StringUtils.isJson(this.changeDescription.trim())) {\n             // if it is json\n             return MarshalFactory.getInstance().getMarshalUtils().unmarshal(this.changeDescription, Map.class);\n         }\n"}}, {"oid": "4d4e71cda9444f1c3efa7070be96f241ee69b4a8", "url": "https://github.com/dotCMS/core/commit/4d4e71cda9444f1c3efa7070be96f241ee69b4a8", "message": "#17984 Feedback done", "committedDate": "2020-01-31T17:55:32Z", "type": "commit"}, {"oid": "b16ef47b23bd7ad0c96985ed70eb2dadf3b407b4", "url": "https://github.com/dotCMS/core/commit/b16ef47b23bd7ad0c96985ed70eb2dadf3b407b4", "message": "#17984 Feedback done 2", "committedDate": "2020-01-31T18:02:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzYxMjk5MQ==", "url": "https://github.com/dotCMS/core/pull/17922#discussion_r373612991", "bodyText": "Issue found: The String literal \"Should return test description\" appears 4 times in this file; the first occurrence is on line 31", "author": "dev-dotcms", "createdAt": "2020-01-31T18:10:33Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/workflows/model/WorkflowHistoryTest.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.dotmarketing.portlets.workflows.model;\n+\n+import com.liferay.util.StringPool;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.util.Map;\n+\n+public class WorkflowHistoryTest {\n+\n+    @Test\n+    public void test_getChangeMap_null_description ()  {\n+\n+        final WorkflowHistory workflowHistory = new WorkflowHistory();\n+        workflowHistory.setChangeDescription(null);\n+        final Map<String, Object> changeMap = workflowHistory.getChangeMap();\n+\n+        Assert.assertNotNull(\"GetChangeMap must not return a null map\",changeMap);\n+        Assert.assertEquals(\"Should return a blank description\", changeMap.get(\"description\"), StringPool.BLANK);\n+        Assert.assertEquals(\"Should return a comment type\", changeMap.get(\"type\"), WorkflowHistoryType.COMMENT.name());\n+        Assert.assertEquals(\"Should return a comment type\", changeMap.get(\"state\"), WorkflowHistoryState.NONE.name());\n+    }\n+\n+    @Test\n+    public void test_getChangeMap_with_description ()  {\n+\n+        final WorkflowHistory workflowHistory = new WorkflowHistory();\n+        workflowHistory.setChangeDescription(\"test\");\n+        final Map<String, Object> changeMap = workflowHistory.getChangeMap();\n+\n+        Assert.assertNotNull(\"GetChangeMap must not return a null map\",changeMap);\n+        Assert.assertEquals(\"Should return test description\", workflowHistory.getChangeDescription(), \"test\");", "originalCommit": "b16ef47b23bd7ad0c96985ed70eb2dadf3b407b4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzYxMjk5OA==", "url": "https://github.com/dotCMS/core/pull/17922#discussion_r373612998", "bodyText": "Issue found: These nested if statements could be combined", "author": "dev-dotcms", "createdAt": "2020-01-31T18:10:34Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/workflows/actionlet/ResetApproversActionlet.java", "diffHunk": "@@ -0,0 +1,130 @@\n+\n+package com.dotmarketing.portlets.workflows.actionlet;\n+\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.workflows.model.WorkflowAction;\n+import com.dotmarketing.portlets.workflows.model.WorkflowActionClassParameter;\n+import com.dotmarketing.portlets.workflows.model.WorkflowActionFailureException;\n+import com.dotmarketing.portlets.workflows.model.WorkflowActionletParameter;\n+import com.dotmarketing.portlets.workflows.model.WorkflowHistory;\n+import com.dotmarketing.portlets.workflows.model.WorkflowHistoryState;\n+import com.dotmarketing.portlets.workflows.model.WorkflowHistoryType;\n+import com.dotmarketing.portlets.workflows.model.WorkflowProcessor;\n+import com.dotmarketing.util.Logger;\n+import com.dotmarketing.util.UUIDUtil;\n+import com.dotmarketing.util.UtilMethods;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+import static com.dotmarketing.portlets.workflows.util.WorkflowActionletUtil.getParameterValue;\n+\n+/**\n+ * Deletes the approvers of the workflow task\n+ * @author jsanca\n+ */\n+public class ResetApproversActionlet extends WorkFlowActionlet {\n+\n+\tprivate static final String ID_DELIMITER = \",\";\n+\tprivate static final String PARAM_CONTENT_ACTIONS = \"action\";\n+\n+\tprivate static ArrayList<WorkflowActionletParameter> ACTIONLET_PARAMETERS = null;\n+\n+\t@Override\n+\tpublic synchronized List<WorkflowActionletParameter> getParameters() {\n+\t\tif (null == ACTIONLET_PARAMETERS) {\n+\t\t\tACTIONLET_PARAMETERS = new ArrayList<>();\n+\t\t\tACTIONLET_PARAMETERS\n+\t\t\t\t\t.add(new WorkflowActionletParameter(PARAM_CONTENT_ACTIONS,\n+\t\t\t\t\t\t\t\"Optional Action ID, or Name\", null,\n+\t\t\t\t\t\t\tfalse));\n+\t\t}\n+\t\treturn ACTIONLET_PARAMETERS;\n+\t}\n+\n+\t@Override\n+\tpublic String getName() {\n+\t\treturn \"Reset Approvals\";\n+\t}\n+\n+\t@Override\n+\tpublic String getHowTo() {\n+\n+\t\treturn \"This actionlet will reset workflow history approvals\";\n+\t}\n+\n+\tprivate Optional<String> getWorkflowIdFromParameter (final WorkflowProcessor processor,\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t final WorkflowActionClassParameter parameter)  {\n+\n+\t\tfinal String value = getParameterValue(parameter);\n+\t\tif (null != value) {\n+\n+\t\t\tif (!UUIDUtil.isUUID(value)) {", "originalCommit": "b16ef47b23bd7ad0c96985ed70eb2dadf3b407b4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzYxMzAwNA==", "url": "https://github.com/dotCMS/core/pull/17922#discussion_r373613004", "bodyText": "Issue found: Avoid using redundant field initializer for 'ACTIONLET_PARAMETERS'", "author": "dev-dotcms", "createdAt": "2020-01-31T18:10:36Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/workflows/actionlet/ResetApproversActionlet.java", "diffHunk": "@@ -0,0 +1,130 @@\n+\n+package com.dotmarketing.portlets.workflows.actionlet;\n+\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.workflows.model.WorkflowAction;\n+import com.dotmarketing.portlets.workflows.model.WorkflowActionClassParameter;\n+import com.dotmarketing.portlets.workflows.model.WorkflowActionFailureException;\n+import com.dotmarketing.portlets.workflows.model.WorkflowActionletParameter;\n+import com.dotmarketing.portlets.workflows.model.WorkflowHistory;\n+import com.dotmarketing.portlets.workflows.model.WorkflowHistoryState;\n+import com.dotmarketing.portlets.workflows.model.WorkflowHistoryType;\n+import com.dotmarketing.portlets.workflows.model.WorkflowProcessor;\n+import com.dotmarketing.util.Logger;\n+import com.dotmarketing.util.UUIDUtil;\n+import com.dotmarketing.util.UtilMethods;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+import static com.dotmarketing.portlets.workflows.util.WorkflowActionletUtil.getParameterValue;\n+\n+/**\n+ * Deletes the approvers of the workflow task\n+ * @author jsanca\n+ */\n+public class ResetApproversActionlet extends WorkFlowActionlet {\n+\n+\tprivate static final String ID_DELIMITER = \",\";\n+\tprivate static final String PARAM_CONTENT_ACTIONS = \"action\";\n+\n+\tprivate static ArrayList<WorkflowActionletParameter> ACTIONLET_PARAMETERS = null;", "originalCommit": "b16ef47b23bd7ad0c96985ed70eb2dadf3b407b4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzYxMzAxOA==", "url": "https://github.com/dotCMS/core/pull/17922#discussion_r373613018", "bodyText": "Issue found: Avoid unused imports such as 'com.dotmarketing.portlets.workflows.model'", "author": "dev-dotcms", "createdAt": "2020-01-31T18:10:37Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/workflows/actionlet/FourEyeApproverActionlet.java", "diffHunk": "@@ -1,27 +1,22 @@\n package com.dotmarketing.portlets.workflows.actionlet;\n \n-import static com.dotmarketing.portlets.workflows.util.WorkflowActionletUtil.getApproversFromHistory;\n-import static com.dotmarketing.portlets.workflows.util.WorkflowActionletUtil.getParameterValue;\n-import static com.dotmarketing.portlets.workflows.util.WorkflowActionletUtil.getUsersFromIds;\n-\n import com.dotcms.util.ConversionUtils;\n import com.dotmarketing.business.APILocator;\n import com.dotmarketing.business.Role;\n import com.dotmarketing.exception.DotDataException;\n-import com.dotmarketing.portlets.workflows.model.MultiUserReferenceParameter;\n-import com.dotmarketing.portlets.workflows.model.WorkflowActionClassParameter;\n-import com.dotmarketing.portlets.workflows.model.WorkflowActionletParameter;\n-import com.dotmarketing.portlets.workflows.model.WorkflowHistory;\n-import com.dotmarketing.portlets.workflows.model.WorkflowProcessor;\n+import com.dotmarketing.portlets.workflows.model.*;", "originalCommit": "b16ef47b23bd7ad0c96985ed70eb2dadf3b407b4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzYxMzAzNQ==", "url": "https://github.com/dotCMS/core/pull/17922#discussion_r373613035", "bodyText": "Issue found: This call to Collection.toArray() may be optimizable", "author": "dev-dotcms", "createdAt": "2020-01-31T18:10:38Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/workflows/actionlet/MultipleApproverActionlet.java", "diffHunk": "@@ -64,95 +66,94 @@ public void executeAction(WorkflowProcessor processor, Map<String, WorkflowActio\n \t\t\t}\n \t\t}\n \n-\t\tSet<User> requiredApprovers = new HashSet<User>();\n-\t\tSet<User> hasApproved = new HashSet<User>();\n-\t\tStringTokenizer st = new StringTokenizer(userIds, \", \");\n-\t\twhile (st.hasMoreTokens()) {\n-\t\t\tString x = st.nextToken();\n+\t\tfinal Set<User> requiredApprovers = new HashSet<>();\n+\t\tfinal Set<User> hasApproved       = new HashSet<>();\n+\t\tfinal StringTokenizer userIdTokenizer = new StringTokenizer(userIds, StringPool.COMMA);\n+\t\twhile (userIdTokenizer.hasMoreTokens()) {\n \n-\t\t\tif (Validator.isEmailAddress(x)) {\n+\t\t\tfinal String userIdToken = userIdTokenizer.nextToken();\n+\n+\t\t\tif (Validator.isEmailAddress(userIdToken)) {\n \t\t\t\ttry {\n-\t\t\t\t\tUser u = APILocator.getUserAPI().loadByUserByEmail(x, APILocator.getUserAPI().getSystemUser(), false);\n \n-\t\t\t\t\trequiredApprovers.add(u);\n+\t\t\t\t\tfinal User user = APILocator.getUserAPI().loadByUserByEmail(userIdToken,\n+\t\t\t\t\t\t\tAPILocator.getUserAPI().getSystemUser(), false);\n+\n+\t\t\t\t\trequiredApprovers.add(user);\n \t\t\t\t} catch (Exception e) {\n-\t\t\t\t\tLogger.error(this.getClass(), \"Unable to find user with email:\" + x);\n+\n+\t\t\t\t\tLogger.warnAndDebug(this.getClass(), \"Unable to find user with email:\" + userIdToken\n+\t\t\t\t\t\t\t+ \", message: \" + e.getMessage(), e);\n \t\t\t\t}\n \t\t\t} else {\n \t\t\t\ttry {\n \n-\t\t\t\t\tUser u = APILocator.getUserAPI().loadUserById(x, APILocator.getUserAPI().getSystemUser(), false);\n-\t\t\t\t\trequiredApprovers.add(u);\n+\t\t\t\t\tfinal User user = APILocator.getUserAPI().loadUserById(userIdToken,\n+\t\t\t\t\t\t\tAPILocator.getUserAPI().getSystemUser(), false);\n+\t\t\t\t\trequiredApprovers.add(user);\n \t\t\t\t} catch (Exception e) {\n-\t\t\t\t\tLogger.error(this.getClass(), \"Unable to find user with userID:\" + x);\n+\t\t\t\t\tLogger.error(this.getClass(), \"Unable to find user with userID:\" + userIdToken);\n \t\t\t\t}\n \n \t\t\t}\n \t\t}\n+\n \t\tList<WorkflowHistory> histories = processor.getHistory();\n \t\t\n \t\t// add this approval to the history\n-\t\tWorkflowHistory h = new WorkflowHistory();\n-\t\th.setActionId(processor.getAction().getId());\n-\t\th.setMadeBy(processor.getUser().getUserId());\n-\t\tif(histories == null){\n-\t\t\thistories = new ArrayList<WorkflowHistory>();\n-\t\t\thistories.add(h);\n-\t\t}else histories.add(h);\n+\t\tfinal WorkflowHistory workflowHistory = new WorkflowHistory();\n+\t\tworkflowHistory.setActionId(processor.getAction().getId());\n+\t\tworkflowHistory.setMadeBy(processor.getUser().getUserId());\n+\t\thistories = histories == null?new ArrayList<>():histories;\n+\t\thistories.add(workflowHistory);\n \t\t\n-\t\tfor (User u : requiredApprovers) {\n+\t\tfor (final User requiredApprover : requiredApprovers) {\n+\t\t\tfor (final WorkflowHistory history : histories) {\n \n-\t\t\tfor (WorkflowHistory history : histories) {\n-\t\t\t\tif (history.getActionId().equals(processor.getAction().getId())) {\n-\t\t\t\t\tif (u.getUserId().equals(history.getMadeBy())) {\n-\t\t\t\t\t\thasApproved.add(u);\n-\t\t\t\t\t}\n+\t\t\t\tfinal Map<String, Object> changeMap = history.getChangeMap();\n+\t\t\t\tif (history.getActionId().equals(processor.getAction().getId()) && // if it is the action id and it is not reset.\n+\t\t\t\t\t\t!WorkflowHistoryState.RESET.name().equals(changeMap.get(\"state\"))) {\n \n-\t\t\t\t}\n+\t\t\t\t\tif (requiredApprover.getUserId().equals(history.getMadeBy())) {\n \n+\t\t\t\t\t\thasApproved.add(requiredApprover);\n+\t\t\t\t\t}\n+\t\t\t\t}\n \t\t\t}\n-\n \t\t}\n \t\t\n \t\tif (hasApproved.size() < requiredApprovers.size()) {\n \t\t\t\n \t\t\tshouldStop = true;\n \t\t\t// keep the workflow process on the same step\n \t\t\tprocessor.setNextStep( processor.getStep());\n-\t\t\t\n-\t\t\t\n+\n \t\t\t// only send emails to users who have not approved\n-\t\t\tList<String> emails = new ArrayList<String>();\n-\t\t\tfor (User u : requiredApprovers) {\n-\t\t\t\tif(!hasApproved.contains(u)){\n-\t\t\t\t\temails.add(u.getEmailAddress());\t\t\t\t\t\n+\t\t\tfinal List<String> emails = new ArrayList<>();\n+\t\t\tfor (final User user : requiredApprovers) {\n+\t\t\t\tif(!hasApproved.contains(user)){\n+\t\t\t\t\temails.add(user.getEmailAddress());\n \t\t\t\t}\n \t\t\t}\n \t\t\t\n \t\t\t// to assign it for next assignee\n-\t\t\tfor (User u : requiredApprovers) {\n-\t\t\t\tif(!hasApproved.contains(u)){\t\t\t\t\t\n+\t\t\tfor (final User requiredApprover : requiredApprovers) {\n+\t\t\t\tif(!hasApproved.contains(requiredApprover)){\n \t\t\t\t\ttry {\n-\t                   processor.setNextAssign(APILocator.getRoleAPI().getUserRole(u));\n+\t                   processor.setNextAssign(APILocator.getRoleAPI().getUserRole(requiredApprover));\n \t                   break;\n \t                } catch (DotDataException e) {\n \t                   Logger.error(MultipleApproverActionlet.class,e.getMessage(),e);\n \t                }\n \t\t\t\t}\n \t\t\t}\n-\t\t\t\n-\t\t\t\n-\t\t\t\n-\t\t\t\n-\t\t\tString[] emailsToSend = (String[]) emails.toArray(new String[emails.size()]);\n \n-\t\t\t\n+\t\t\tfinal String[] emailsToSend = emails.toArray(new String[emails.size()]);", "originalCommit": "b16ef47b23bd7ad0c96985ed70eb2dadf3b407b4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzYxMzA0NQ==", "url": "https://github.com/dotCMS/core/pull/17922#discussion_r373613045", "bodyText": "Issue found: Avoid unused private fields such as 'ID_DELIMITER'.", "author": "dev-dotcms", "createdAt": "2020-01-31T18:10:39Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/workflows/actionlet/ResetApproversActionlet.java", "diffHunk": "@@ -0,0 +1,130 @@\n+\n+package com.dotmarketing.portlets.workflows.actionlet;\n+\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.workflows.model.WorkflowAction;\n+import com.dotmarketing.portlets.workflows.model.WorkflowActionClassParameter;\n+import com.dotmarketing.portlets.workflows.model.WorkflowActionFailureException;\n+import com.dotmarketing.portlets.workflows.model.WorkflowActionletParameter;\n+import com.dotmarketing.portlets.workflows.model.WorkflowHistory;\n+import com.dotmarketing.portlets.workflows.model.WorkflowHistoryState;\n+import com.dotmarketing.portlets.workflows.model.WorkflowHistoryType;\n+import com.dotmarketing.portlets.workflows.model.WorkflowProcessor;\n+import com.dotmarketing.util.Logger;\n+import com.dotmarketing.util.UUIDUtil;\n+import com.dotmarketing.util.UtilMethods;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+import static com.dotmarketing.portlets.workflows.util.WorkflowActionletUtil.getParameterValue;\n+\n+/**\n+ * Deletes the approvers of the workflow task\n+ * @author jsanca\n+ */\n+public class ResetApproversActionlet extends WorkFlowActionlet {\n+\n+\tprivate static final String ID_DELIMITER = \",\";", "originalCommit": "b16ef47b23bd7ad0c96985ed70eb2dadf3b407b4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzYxMzA1MQ==", "url": "https://github.com/dotCMS/core/pull/17922#discussion_r373613051", "bodyText": "Issue found: The String literal \"test\" appears 5 times in this file; the first occurrence is on line 27", "author": "dev-dotcms", "createdAt": "2020-01-31T18:10:40Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/workflows/model/WorkflowHistoryTest.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.dotmarketing.portlets.workflows.model;\n+\n+import com.liferay.util.StringPool;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.util.Map;\n+\n+public class WorkflowHistoryTest {\n+\n+    @Test\n+    public void test_getChangeMap_null_description ()  {\n+\n+        final WorkflowHistory workflowHistory = new WorkflowHistory();\n+        workflowHistory.setChangeDescription(null);\n+        final Map<String, Object> changeMap = workflowHistory.getChangeMap();\n+\n+        Assert.assertNotNull(\"GetChangeMap must not return a null map\",changeMap);\n+        Assert.assertEquals(\"Should return a blank description\", changeMap.get(\"description\"), StringPool.BLANK);\n+        Assert.assertEquals(\"Should return a comment type\", changeMap.get(\"type\"), WorkflowHistoryType.COMMENT.name());\n+        Assert.assertEquals(\"Should return a comment type\", changeMap.get(\"state\"), WorkflowHistoryState.NONE.name());\n+    }\n+\n+    @Test\n+    public void test_getChangeMap_with_description ()  {\n+\n+        final WorkflowHistory workflowHistory = new WorkflowHistory();\n+        workflowHistory.setChangeDescription(\"test\");", "originalCommit": "b16ef47b23bd7ad0c96985ed70eb2dadf3b407b4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzYxMzA2OA==", "url": "https://github.com/dotCMS/core/pull/17922#discussion_r373613068", "bodyText": "Issue found: Use block level rather than method level synchronization", "author": "dev-dotcms", "createdAt": "2020-01-31T18:10:42Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/workflows/actionlet/ResetApproversActionlet.java", "diffHunk": "@@ -0,0 +1,130 @@\n+\n+package com.dotmarketing.portlets.workflows.actionlet;\n+\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.workflows.model.WorkflowAction;\n+import com.dotmarketing.portlets.workflows.model.WorkflowActionClassParameter;\n+import com.dotmarketing.portlets.workflows.model.WorkflowActionFailureException;\n+import com.dotmarketing.portlets.workflows.model.WorkflowActionletParameter;\n+import com.dotmarketing.portlets.workflows.model.WorkflowHistory;\n+import com.dotmarketing.portlets.workflows.model.WorkflowHistoryState;\n+import com.dotmarketing.portlets.workflows.model.WorkflowHistoryType;\n+import com.dotmarketing.portlets.workflows.model.WorkflowProcessor;\n+import com.dotmarketing.util.Logger;\n+import com.dotmarketing.util.UUIDUtil;\n+import com.dotmarketing.util.UtilMethods;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+import static com.dotmarketing.portlets.workflows.util.WorkflowActionletUtil.getParameterValue;\n+\n+/**\n+ * Deletes the approvers of the workflow task\n+ * @author jsanca\n+ */\n+public class ResetApproversActionlet extends WorkFlowActionlet {\n+\n+\tprivate static final String ID_DELIMITER = \",\";\n+\tprivate static final String PARAM_CONTENT_ACTIONS = \"action\";\n+\n+\tprivate static ArrayList<WorkflowActionletParameter> ACTIONLET_PARAMETERS = null;\n+\n+\t@Override\n+\tpublic synchronized List<WorkflowActionletParameter> getParameters() {", "originalCommit": "b16ef47b23bd7ad0c96985ed70eb2dadf3b407b4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzYxMzA3Mg==", "url": "https://github.com/dotCMS/core/pull/17922#discussion_r373613072", "bodyText": "Issue found: The String literal \"Should return a comment type\" appears 5 times in this file; the first occurrence is on line 20", "author": "dev-dotcms", "createdAt": "2020-01-31T18:10:43Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/workflows/model/WorkflowHistoryTest.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.dotmarketing.portlets.workflows.model;\n+\n+import com.liferay.util.StringPool;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.util.Map;\n+\n+public class WorkflowHistoryTest {\n+\n+    @Test\n+    public void test_getChangeMap_null_description ()  {\n+\n+        final WorkflowHistory workflowHistory = new WorkflowHistory();\n+        workflowHistory.setChangeDescription(null);\n+        final Map<String, Object> changeMap = workflowHistory.getChangeMap();\n+\n+        Assert.assertNotNull(\"GetChangeMap must not return a null map\",changeMap);\n+        Assert.assertEquals(\"Should return a blank description\", changeMap.get(\"description\"), StringPool.BLANK);\n+        Assert.assertEquals(\"Should return a comment type\", changeMap.get(\"type\"), WorkflowHistoryType.COMMENT.name());", "originalCommit": "b16ef47b23bd7ad0c96985ed70eb2dadf3b407b4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzYxMzA4MQ==", "url": "https://github.com/dotCMS/core/pull/17922#discussion_r373613081", "bodyText": "Issue found: Avoid using implementation types like 'ArrayList'; use the interface instead", "author": "dev-dotcms", "createdAt": "2020-01-31T18:10:44Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/workflows/actionlet/ResetApproversActionlet.java", "diffHunk": "@@ -0,0 +1,130 @@\n+\n+package com.dotmarketing.portlets.workflows.actionlet;\n+\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.workflows.model.WorkflowAction;\n+import com.dotmarketing.portlets.workflows.model.WorkflowActionClassParameter;\n+import com.dotmarketing.portlets.workflows.model.WorkflowActionFailureException;\n+import com.dotmarketing.portlets.workflows.model.WorkflowActionletParameter;\n+import com.dotmarketing.portlets.workflows.model.WorkflowHistory;\n+import com.dotmarketing.portlets.workflows.model.WorkflowHistoryState;\n+import com.dotmarketing.portlets.workflows.model.WorkflowHistoryType;\n+import com.dotmarketing.portlets.workflows.model.WorkflowProcessor;\n+import com.dotmarketing.util.Logger;\n+import com.dotmarketing.util.UUIDUtil;\n+import com.dotmarketing.util.UtilMethods;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+import static com.dotmarketing.portlets.workflows.util.WorkflowActionletUtil.getParameterValue;\n+\n+/**\n+ * Deletes the approvers of the workflow task\n+ * @author jsanca\n+ */\n+public class ResetApproversActionlet extends WorkFlowActionlet {\n+\n+\tprivate static final String ID_DELIMITER = \",\";\n+\tprivate static final String PARAM_CONTENT_ACTIONS = \"action\";\n+\n+\tprivate static ArrayList<WorkflowActionletParameter> ACTIONLET_PARAMETERS = null;", "originalCommit": "b16ef47b23bd7ad0c96985ed70eb2dadf3b407b4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzYxMzA4OQ==", "url": "https://github.com/dotCMS/core/pull/17922#discussion_r373613089", "bodyText": "Issue found: Avoid unused imports such as 'com.dotmarketing.portlets.workflows.util.WorkflowActionletUtil'", "author": "dev-dotcms", "createdAt": "2020-01-31T18:10:45Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/workflows/actionlet/FourEyeApproverActionlet.java", "diffHunk": "@@ -1,27 +1,22 @@\n package com.dotmarketing.portlets.workflows.actionlet;\n \n-import static com.dotmarketing.portlets.workflows.util.WorkflowActionletUtil.getApproversFromHistory;\n-import static com.dotmarketing.portlets.workflows.util.WorkflowActionletUtil.getParameterValue;\n-import static com.dotmarketing.portlets.workflows.util.WorkflowActionletUtil.getUsersFromIds;\n-\n import com.dotcms.util.ConversionUtils;\n import com.dotmarketing.business.APILocator;\n import com.dotmarketing.business.Role;\n import com.dotmarketing.exception.DotDataException;\n-import com.dotmarketing.portlets.workflows.model.MultiUserReferenceParameter;\n-import com.dotmarketing.portlets.workflows.model.WorkflowActionClassParameter;\n-import com.dotmarketing.portlets.workflows.model.WorkflowActionletParameter;\n-import com.dotmarketing.portlets.workflows.model.WorkflowHistory;\n-import com.dotmarketing.portlets.workflows.model.WorkflowProcessor;\n+import com.dotmarketing.portlets.workflows.model.*;\n import com.dotmarketing.portlets.workflows.util.WorkflowEmailUtil;\n import com.dotmarketing.util.Logger;\n import com.liferay.portal.model.User;\n import io.vavr.Tuple2;\n+\n import java.util.ArrayList;\n import java.util.List;\n import java.util.Map;\n import java.util.Set;\n \n+import static com.dotmarketing.portlets.workflows.util.WorkflowActionletUtil.*;", "originalCommit": "b16ef47b23bd7ad0c96985ed70eb2dadf3b407b4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzYxMzA5OQ==", "url": "https://github.com/dotCMS/core/pull/17922#discussion_r373613099", "bodyText": "Issue found: These nested if statements could be combined", "author": "dev-dotcms", "createdAt": "2020-01-31T18:10:47Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/workflows/actionlet/MultipleApproverActionlet.java", "diffHunk": "@@ -64,95 +66,94 @@ public void executeAction(WorkflowProcessor processor, Map<String, WorkflowActio\n \t\t\t}\n \t\t}\n \n-\t\tSet<User> requiredApprovers = new HashSet<User>();\n-\t\tSet<User> hasApproved = new HashSet<User>();\n-\t\tStringTokenizer st = new StringTokenizer(userIds, \", \");\n-\t\twhile (st.hasMoreTokens()) {\n-\t\t\tString x = st.nextToken();\n+\t\tfinal Set<User> requiredApprovers = new HashSet<>();\n+\t\tfinal Set<User> hasApproved       = new HashSet<>();\n+\t\tfinal StringTokenizer userIdTokenizer = new StringTokenizer(userIds, StringPool.COMMA);\n+\t\twhile (userIdTokenizer.hasMoreTokens()) {\n \n-\t\t\tif (Validator.isEmailAddress(x)) {\n+\t\t\tfinal String userIdToken = userIdTokenizer.nextToken();\n+\n+\t\t\tif (Validator.isEmailAddress(userIdToken)) {\n \t\t\t\ttry {\n-\t\t\t\t\tUser u = APILocator.getUserAPI().loadByUserByEmail(x, APILocator.getUserAPI().getSystemUser(), false);\n \n-\t\t\t\t\trequiredApprovers.add(u);\n+\t\t\t\t\tfinal User user = APILocator.getUserAPI().loadByUserByEmail(userIdToken,\n+\t\t\t\t\t\t\tAPILocator.getUserAPI().getSystemUser(), false);\n+\n+\t\t\t\t\trequiredApprovers.add(user);\n \t\t\t\t} catch (Exception e) {\n-\t\t\t\t\tLogger.error(this.getClass(), \"Unable to find user with email:\" + x);\n+\n+\t\t\t\t\tLogger.warnAndDebug(this.getClass(), \"Unable to find user with email:\" + userIdToken\n+\t\t\t\t\t\t\t+ \", message: \" + e.getMessage(), e);\n \t\t\t\t}\n \t\t\t} else {\n \t\t\t\ttry {\n \n-\t\t\t\t\tUser u = APILocator.getUserAPI().loadUserById(x, APILocator.getUserAPI().getSystemUser(), false);\n-\t\t\t\t\trequiredApprovers.add(u);\n+\t\t\t\t\tfinal User user = APILocator.getUserAPI().loadUserById(userIdToken,\n+\t\t\t\t\t\t\tAPILocator.getUserAPI().getSystemUser(), false);\n+\t\t\t\t\trequiredApprovers.add(user);\n \t\t\t\t} catch (Exception e) {\n-\t\t\t\t\tLogger.error(this.getClass(), \"Unable to find user with userID:\" + x);\n+\t\t\t\t\tLogger.error(this.getClass(), \"Unable to find user with userID:\" + userIdToken);\n \t\t\t\t}\n \n \t\t\t}\n \t\t}\n+\n \t\tList<WorkflowHistory> histories = processor.getHistory();\n \t\t\n \t\t// add this approval to the history\n-\t\tWorkflowHistory h = new WorkflowHistory();\n-\t\th.setActionId(processor.getAction().getId());\n-\t\th.setMadeBy(processor.getUser().getUserId());\n-\t\tif(histories == null){\n-\t\t\thistories = new ArrayList<WorkflowHistory>();\n-\t\t\thistories.add(h);\n-\t\t}else histories.add(h);\n+\t\tfinal WorkflowHistory workflowHistory = new WorkflowHistory();\n+\t\tworkflowHistory.setActionId(processor.getAction().getId());\n+\t\tworkflowHistory.setMadeBy(processor.getUser().getUserId());\n+\t\thistories = histories == null?new ArrayList<>():histories;\n+\t\thistories.add(workflowHistory);\n \t\t\n-\t\tfor (User u : requiredApprovers) {\n+\t\tfor (final User requiredApprover : requiredApprovers) {\n+\t\t\tfor (final WorkflowHistory history : histories) {\n \n-\t\t\tfor (WorkflowHistory history : histories) {\n-\t\t\t\tif (history.getActionId().equals(processor.getAction().getId())) {\n-\t\t\t\t\tif (u.getUserId().equals(history.getMadeBy())) {\n-\t\t\t\t\t\thasApproved.add(u);\n-\t\t\t\t\t}\n+\t\t\t\tfinal Map<String, Object> changeMap = history.getChangeMap();\n+\t\t\t\tif (history.getActionId().equals(processor.getAction().getId()) && // if it is the action id and it is not reset.\n+\t\t\t\t\t\t!WorkflowHistoryState.RESET.name().equals(changeMap.get(\"state\"))) {\n \n-\t\t\t\t}\n+\t\t\t\t\tif (requiredApprover.getUserId().equals(history.getMadeBy())) {", "originalCommit": "b16ef47b23bd7ad0c96985ed70eb2dadf3b407b4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}