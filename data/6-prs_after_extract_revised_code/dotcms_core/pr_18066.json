{"pr_number": 18066, "pr_title": "Fixing rule permission bug", "pr_createdAt": "2020-02-28T19:43:05Z", "pr_url": "https://github.com/dotCMS/core/pull/18066", "timeline": [{"oid": "4d5853ccccfea0f113dbbcc5c9f98579085c68dc", "url": "https://github.com/dotCMS/core/commit/4d5853ccccfea0f113dbbcc5c9f98579085c68dc", "message": "Fixing rule permission bug", "committedDate": "2020-02-28T19:06:05Z", "type": "commit"}, {"oid": "44413a3a9ead5814a6a5c5f384aafe58a99b5050", "url": "https://github.com/dotCMS/core/commit/44413a3a9ead5814a6a5c5f384aafe58a99b5050", "message": "#17901 testing", "committedDate": "2020-02-28T20:40:46Z", "type": "commit"}, {"oid": "0548ce1d1025ffc9fd82e5a2480544fbb14e1985", "url": "https://github.com/dotCMS/core/commit/0548ce1d1025ffc9fd82e5a2480544fbb14e1985", "message": "#17901 refactoring", "committedDate": "2020-02-28T20:52:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkyMDM2MQ==", "url": "https://github.com/dotCMS/core/pull/18066#discussion_r385920361", "bodyText": "Issue found: Avoid reassigning parameters such as 'siteId'", "author": "dev-dotcms", "createdAt": "2020-02-28T21:01:52Z", "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/sites/ruleengine/rules/RuleResource.java", "diffHunk": "@@ -77,11 +79,15 @@ protected RuleResource(ApiProvider apiProvider, WebResource webResource) {\n     @Path(\"/rules\")\n     @NoCache\n     @Produces({MediaType.APPLICATION_JSON, \"application/javascript\"})\n-    public Map<String, RestRule> list(@Context HttpServletRequest request, @Context final HttpServletResponse response, @PathParam(\"siteId\") String siteId) {\n+    public Map<String, RestRule> list(\n+            @Context final HttpServletRequest request,\n+            @Context final HttpServletResponse response,\n+            @PathParam(\"siteId\") String siteId) throws DotSecurityException, DotDataException {", "originalCommit": "0548ce1d1025ffc9fd82e5a2480544fbb14e1985", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkyMDM3Mw==", "url": "https://github.com/dotCMS/core/pull/18066#discussion_r385920373", "bodyText": "Issue found: The String literal \"siteId\" appears 5 times in this file; the first occurrence is on line 85", "author": "dev-dotcms", "createdAt": "2020-02-28T21:01:54Z", "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/sites/ruleengine/rules/RuleResource.java", "diffHunk": "@@ -77,11 +79,15 @@ protected RuleResource(ApiProvider apiProvider, WebResource webResource) {\n     @Path(\"/rules\")\n     @NoCache\n     @Produces({MediaType.APPLICATION_JSON, \"application/javascript\"})\n-    public Map<String, RestRule> list(@Context HttpServletRequest request, @Context final HttpServletResponse response, @PathParam(\"siteId\") String siteId) {\n+    public Map<String, RestRule> list(\n+            @Context final HttpServletRequest request,\n+            @Context final HttpServletResponse response,\n+            @PathParam(\"siteId\") String siteId) throws DotSecurityException, DotDataException {", "originalCommit": "0548ce1d1025ffc9fd82e5a2480544fbb14e1985", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkyMDM4OA==", "url": "https://github.com/dotCMS/core/pull/18066#discussion_r385920388", "bodyText": "Issue found: Avoid unused imports such as 'com.dotmarketing.business'", "author": "dev-dotcms", "createdAt": "2020-02-28T21:01:55Z", "path": "dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java", "diffHunk": "@@ -7,10 +7,7 @@\n import com.dotcms.util.IntegrationTestInitService;\n import com.dotmarketing.beans.Host;\n import com.dotmarketing.beans.Permission;\n-import com.dotmarketing.business.APILocator;\n-import com.dotmarketing.business.CacheLocator;\n-import com.dotmarketing.business.PermissionAPI;\n-import com.dotmarketing.business.Role;\n+import com.dotmarketing.business.*;", "originalCommit": "0548ce1d1025ffc9fd82e5a2480544fbb14e1985", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkyODE1OA==", "url": "https://github.com/dotCMS/core/pull/18066#discussion_r385928158", "bodyText": "let's add a finally to remove created stuff", "author": "dsilvam", "createdAt": "2020-02-28T21:22:09Z", "path": "dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java", "diffHunk": "@@ -52,6 +51,74 @@ public static void prepare() throws Exception {\n         rulesAPI   = APILocator.getRulesAPI();\n     }\n \n+    /**\n+     * Method to Test: {@link RulesAPIImpl#getAllRulesByParent(Ruleable, User, boolean)}\n+     * When: User with permission try to get all the rules from host\n+     * Should: Return all the rules from the host\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test\n+    public void shouldGetRules() throws DotSecurityException, DotDataException {\n+        final Role role = new RoleDataGen().nextPersisted();\n+        final User user = new UserDataGen().roles(role).nextPersisted();\n+        final Host host = new SiteDataGen().nextPersisted();\n+        final Rule rule1 = new RuleDataGen().host(host).nextPersisted();\n+        final Rule rule2 = new RuleDataGen().host(host).nextPersisted();\n+\n+        final Host anotherHost = new SiteDataGen().nextPersisted();\n+        final Rule rule3 = new RuleDataGen().host(anotherHost).nextPersisted();\n+\n+        this.addPermission(role, host, false);\n+        final List<Rule> rules = rulesAPI.getAllRulesByParent(host, user, false);\n+\n+        assertEquals(2, rules.size());\n+\n+        final List<String> rulesId = rules.stream().map(rule -> rule.getId()).collect(Collectors.toList());\n+        assertTrue(rulesId.contains(rule1.getId()));\n+        assertTrue(rulesId.contains(rule2.getId()));\n+        assertFalse(rulesId.contains(rule3.getId()));", "originalCommit": "0548ce1d1025ffc9fd82e5a2480544fbb14e1985", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}