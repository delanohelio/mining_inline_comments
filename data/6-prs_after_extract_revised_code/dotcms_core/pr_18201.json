{"pr_number": 18201, "pr_title": "#17901 testing", "pr_createdAt": "2020-03-27T15:18:16Z", "pr_url": "https://github.com/dotCMS/core/pull/18201", "timeline": [{"oid": "31d54b5500f06032c74edc68827d35bdfae0e3e7", "url": "https://github.com/dotCMS/core/commit/31d54b5500f06032c74edc68827d35bdfae0e3e7", "message": "#17901 testing", "committedDate": "2020-03-27T15:12:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM0ODAwMQ==", "url": "https://github.com/dotCMS/core/pull/18201#discussion_r399348001", "bodyText": "why is this done again? looks like it was done already in line 111", "author": "dsilvam", "createdAt": "2020-03-27T15:28:16Z", "path": "dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java", "diffHunk": "@@ -82,12 +79,80 @@ public void shouldSaveCondition() throws DotSecurityException, DotDataException\n         final Rule rule = new RuleDataGen().host(host).nextPersisted();\n \n         final ConditionGroup conditionGroup = new ConditionGroupDataGen().rule(rule).next();\n-        this.addPermission(role, host, true);\n+        this.addRulesPermission(role, host, true);\n \n         //Saving and testing GroupCondition\n         rulesAPI.saveConditionGroup(conditionGroup, user, false);\n \n         List<Rule> allRules = rulesAPI.getAllRules(user, false);\n+        checkCondition(user, conditionGroup, allRules);\n+    }\n+\n+    /**\n+     * Method to Test: {@link RulesAPIImpl#saveConditionGroup(ConditionGroup, User, boolean)}\n+     *                  and {@link RulesAPIImpl#saveCondition(Condition, User, boolean)}\n+     * When:Try to create a Group Condition and a Condition in a page's rule with PuBLISH permission over the page\n+     * Should: save the rule\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test\n+    public void shouldSaveConditionInRulesPage() throws DotSecurityException, DotDataException {\n+        final Role role = new RoleDataGen().nextPersisted();\n+        final User user = new UserDataGen().roles(role).nextPersisted();\n+        final Host host = new SiteDataGen().nextPersisted();\n+\n+        final Template template = new TemplateDataGen().nextPersisted();\n+        final HTMLPageAsset htmlPageAsset = new HTMLPageDataGen(host, template)\n+                .nextPersisted();\n+\n+        addPermission(role, htmlPageAsset, PermissionAPI.PERMISSION_PUBLISH);\n+        addRulesPermission(role, host, true);\n+        final Rule rule = new RuleDataGen().page(htmlPageAsset).nextPersisted();\n+\n+        final ConditionGroup conditionGroup = new ConditionGroupDataGen().rule(rule).next();\n+        this.addRulesPermission(role, host, true);", "originalCommit": "31d54b5500f06032c74edc68827d35bdfae0e3e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQxMDM4Nw==", "url": "https://github.com/dotCMS/core/pull/18201#discussion_r399410387", "bodyText": "done a3d5384#diff-9baded4fb0fb63e2648d9c9c4380ec1aL115", "author": "freddyucv", "createdAt": "2020-03-27T17:00:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM0ODAwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "a3d5384f514af695b89fdbc549338def9a8cce2c", "chunk": "diff --git a/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java b/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java\nindex 2ca0e208f8..a6eb79e37f 100644\n--- a/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java\n+++ b/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java\n\n@@ -79,13 +79,14 @@ public class RulesAPIImplIntegrationTest {\n         final Rule rule = new RuleDataGen().host(host).nextPersisted();\n \n         final ConditionGroup conditionGroup = new ConditionGroupDataGen().rule(rule).next();\n-        this.addRulesPermission(role, host, true);\n+        addRulesReadPermissions(role, host);\n+        addRulesPublishPermissions(role, host);\n \n         //Saving and testing GroupCondition\n         rulesAPI.saveConditionGroup(conditionGroup, user, false);\n \n         List<Rule> allRules = rulesAPI.getAllRules(user, false);\n-        checkCondition(user, conditionGroup, allRules);\n+        createConditionAndCheck(user, conditionGroup, allRules);\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM0ODg4OQ==", "url": "https://github.com/dotCMS/core/pull/18201#discussion_r399348889", "bodyText": "javadoc says Condition Group and Condition but code shows only Condition Group", "author": "dsilvam", "createdAt": "2020-03-27T15:29:32Z", "path": "dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java", "diffHunk": "@@ -82,12 +79,80 @@ public void shouldSaveCondition() throws DotSecurityException, DotDataException\n         final Rule rule = new RuleDataGen().host(host).nextPersisted();\n \n         final ConditionGroup conditionGroup = new ConditionGroupDataGen().rule(rule).next();\n-        this.addPermission(role, host, true);\n+        this.addRulesPermission(role, host, true);\n \n         //Saving and testing GroupCondition\n         rulesAPI.saveConditionGroup(conditionGroup, user, false);\n \n         List<Rule> allRules = rulesAPI.getAllRules(user, false);\n+        checkCondition(user, conditionGroup, allRules);\n+    }\n+\n+    /**\n+     * Method to Test: {@link RulesAPIImpl#saveConditionGroup(ConditionGroup, User, boolean)}\n+     *                  and {@link RulesAPIImpl#saveCondition(Condition, User, boolean)}\n+     * When:Try to create a Group Condition and a Condition in a page's rule with PuBLISH permission over the page", "originalCommit": "31d54b5500f06032c74edc68827d35bdfae0e3e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQxMDYyNw==", "url": "https://github.com/dotCMS/core/pull/18201#discussion_r399410627", "bodyText": "done a3d5384#diff-9baded4fb0fb63e2648d9c9c4380ec1aR157", "author": "freddyucv", "createdAt": "2020-03-27T17:00:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM0ODg4OQ=="}], "type": "inlineReview", "revised_code": {"commit": "a3d5384f514af695b89fdbc549338def9a8cce2c", "chunk": "diff --git a/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java b/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java\nindex 2ca0e208f8..a6eb79e37f 100644\n--- a/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java\n+++ b/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java\n\n@@ -79,13 +79,14 @@ public class RulesAPIImplIntegrationTest {\n         final Rule rule = new RuleDataGen().host(host).nextPersisted();\n \n         final ConditionGroup conditionGroup = new ConditionGroupDataGen().rule(rule).next();\n-        this.addRulesPermission(role, host, true);\n+        addRulesReadPermissions(role, host);\n+        addRulesPublishPermissions(role, host);\n \n         //Saving and testing GroupCondition\n         rulesAPI.saveConditionGroup(conditionGroup, user, false);\n \n         List<Rule> allRules = rulesAPI.getAllRules(user, false);\n-        checkCondition(user, conditionGroup, allRules);\n+        createConditionAndCheck(user, conditionGroup, allRules);\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM4MjY0MA==", "url": "https://github.com/dotCMS/core/pull/18201#discussion_r399382640", "bodyText": "Looks like this line shouldn't be there if you don't want publish perms on the page", "author": "dsilvam", "createdAt": "2020-03-27T16:18:36Z", "path": "dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java", "diffHunk": "@@ -82,12 +79,80 @@ public void shouldSaveCondition() throws DotSecurityException, DotDataException\n         final Rule rule = new RuleDataGen().host(host).nextPersisted();\n \n         final ConditionGroup conditionGroup = new ConditionGroupDataGen().rule(rule).next();\n-        this.addPermission(role, host, true);\n+        this.addRulesPermission(role, host, true);\n \n         //Saving and testing GroupCondition\n         rulesAPI.saveConditionGroup(conditionGroup, user, false);\n \n         List<Rule> allRules = rulesAPI.getAllRules(user, false);\n+        checkCondition(user, conditionGroup, allRules);\n+    }\n+\n+    /**\n+     * Method to Test: {@link RulesAPIImpl#saveConditionGroup(ConditionGroup, User, boolean)}\n+     *                  and {@link RulesAPIImpl#saveCondition(Condition, User, boolean)}\n+     * When:Try to create a Group Condition and a Condition in a page's rule with PuBLISH permission over the page\n+     * Should: save the rule\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test\n+    public void shouldSaveConditionInRulesPage() throws DotSecurityException, DotDataException {\n+        final Role role = new RoleDataGen().nextPersisted();\n+        final User user = new UserDataGen().roles(role).nextPersisted();\n+        final Host host = new SiteDataGen().nextPersisted();\n+\n+        final Template template = new TemplateDataGen().nextPersisted();\n+        final HTMLPageAsset htmlPageAsset = new HTMLPageDataGen(host, template)\n+                .nextPersisted();\n+\n+        addPermission(role, htmlPageAsset, PermissionAPI.PERMISSION_PUBLISH);\n+        addRulesPermission(role, host, true);\n+        final Rule rule = new RuleDataGen().page(htmlPageAsset).nextPersisted();\n+\n+        final ConditionGroup conditionGroup = new ConditionGroupDataGen().rule(rule).next();\n+        this.addRulesPermission(role, host, true);\n+\n+        //Saving and testing GroupCondition\n+        rulesAPI.saveConditionGroup(conditionGroup, user, false);\n+\n+        List<Rule> allRules = rulesAPI.getAllRules(user, false);\n+        checkCondition(user, conditionGroup, allRules);\n+    }\n+\n+    /**\n+     * Method to Test: {@link RulesAPIImpl#saveConditionGroup(ConditionGroup, User, boolean)}\n+     *                  and {@link RulesAPIImpl#saveCondition(Condition, User, boolean)}\n+     * When:Try to create a Group Condition and a Condition in a page's rule without PuBLISH permission over the page\n+     * Should: Throw a {@link DotSecurityException}\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test(expected = DotSecurityException.class)\n+    public void shouldSaveConditionInRulesPageShouldNotWork() throws DotSecurityException, DotDataException {\n+        final Role role = new RoleDataGen().nextPersisted();\n+        final User user = new UserDataGen().roles(role).nextPersisted();\n+        final Host host = new SiteDataGen().nextPersisted();\n+\n+        final Template template = new TemplateDataGen().nextPersisted();\n+        final Folder folder = new FolderDataGen().site(host).nextPersisted();\n+        final HTMLPageAsset htmlPageAsset = new HTMLPageDataGen(host, template)\n+                .folder(folder)\n+                .nextPersisted();\n+\n+        addPermission(role, htmlPageAsset, PermissionAPI.PERMISSION_PUBLISH);        addRulesPermission(role, host, true);", "originalCommit": "31d54b5500f06032c74edc68827d35bdfae0e3e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQxMDkxMg==", "url": "https://github.com/dotCMS/core/pull/18201#discussion_r399410912", "bodyText": "done a3d5384#diff-9baded4fb0fb63e2648d9c9c4380ec1aL145", "author": "freddyucv", "createdAt": "2020-03-27T17:01:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM4MjY0MA=="}], "type": "inlineReview", "revised_code": {"commit": "a3d5384f514af695b89fdbc549338def9a8cce2c", "chunk": "diff --git a/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java b/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java\nindex 2ca0e208f8..a6eb79e37f 100644\n--- a/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java\n+++ b/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java\n\n@@ -79,13 +79,14 @@ public class RulesAPIImplIntegrationTest {\n         final Rule rule = new RuleDataGen().host(host).nextPersisted();\n \n         final ConditionGroup conditionGroup = new ConditionGroupDataGen().rule(rule).next();\n-        this.addRulesPermission(role, host, true);\n+        addRulesReadPermissions(role, host);\n+        addRulesPublishPermissions(role, host);\n \n         //Saving and testing GroupCondition\n         rulesAPI.saveConditionGroup(conditionGroup, user, false);\n \n         List<Rule> allRules = rulesAPI.getAllRules(user, false);\n-        checkCondition(user, conditionGroup, allRules);\n+        createConditionAndCheck(user, conditionGroup, allRules);\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM4NzQ0Mg==", "url": "https://github.com/dotCMS/core/pull/18201#discussion_r399387442", "bodyText": "create a variable for the third parameter to understand what's going on\nboolean addPublishPermsForRules = true;", "author": "dsilvam", "createdAt": "2020-03-27T16:25:40Z", "path": "dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java", "diffHunk": "@@ -82,12 +79,80 @@ public void shouldSaveCondition() throws DotSecurityException, DotDataException\n         final Rule rule = new RuleDataGen().host(host).nextPersisted();\n \n         final ConditionGroup conditionGroup = new ConditionGroupDataGen().rule(rule).next();\n-        this.addPermission(role, host, true);\n+        this.addRulesPermission(role, host, true);", "originalCommit": "31d54b5500f06032c74edc68827d35bdfae0e3e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM5MDE2Ng==", "url": "https://github.com/dotCMS/core/pull/18201#discussion_r399390166", "bodyText": "Or just separate addRulesPermission into two methods with clearer responsibilities and get rid of the flag:\naddPermsToPublishRules\naddPermsToReadRules", "author": "dsilvam", "createdAt": "2020-03-27T16:29:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM4NzQ0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQxMTI3OQ==", "url": "https://github.com/dotCMS/core/pull/18201#discussion_r399411279", "bodyText": "done a3d5384#diff-9baded4fb0fb63e2648d9c9c4380ec1aR889-R910", "author": "freddyucv", "createdAt": "2020-03-27T17:01:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM4NzQ0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "a3d5384f514af695b89fdbc549338def9a8cce2c", "chunk": "diff --git a/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java b/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java\nindex 2ca0e208f8..a6eb79e37f 100644\n--- a/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java\n+++ b/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java\n\n@@ -79,13 +79,14 @@ public class RulesAPIImplIntegrationTest {\n         final Rule rule = new RuleDataGen().host(host).nextPersisted();\n \n         final ConditionGroup conditionGroup = new ConditionGroupDataGen().rule(rule).next();\n-        this.addRulesPermission(role, host, true);\n+        addRulesReadPermissions(role, host);\n+        addRulesPublishPermissions(role, host);\n \n         //Saving and testing GroupCondition\n         rulesAPI.saveConditionGroup(conditionGroup, user, false);\n \n         List<Rule> allRules = rulesAPI.getAllRules(user, false);\n-        checkCondition(user, conditionGroup, allRules);\n+        createConditionAndCheck(user, conditionGroup, allRules);\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM5MzMwMA==", "url": "https://github.com/dotCMS/core/pull/18201#discussion_r399393300", "bodyText": "rename method to shouldNotSaveConditionInRuleOnPage", "author": "dsilvam", "createdAt": "2020-03-27T16:34:47Z", "path": "dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java", "diffHunk": "@@ -82,12 +79,80 @@ public void shouldSaveCondition() throws DotSecurityException, DotDataException\n         final Rule rule = new RuleDataGen().host(host).nextPersisted();\n \n         final ConditionGroup conditionGroup = new ConditionGroupDataGen().rule(rule).next();\n-        this.addPermission(role, host, true);\n+        this.addRulesPermission(role, host, true);\n \n         //Saving and testing GroupCondition\n         rulesAPI.saveConditionGroup(conditionGroup, user, false);\n \n         List<Rule> allRules = rulesAPI.getAllRules(user, false);\n+        checkCondition(user, conditionGroup, allRules);\n+    }\n+\n+    /**\n+     * Method to Test: {@link RulesAPIImpl#saveConditionGroup(ConditionGroup, User, boolean)}\n+     *                  and {@link RulesAPIImpl#saveCondition(Condition, User, boolean)}\n+     * When:Try to create a Group Condition and a Condition in a page's rule with PuBLISH permission over the page\n+     * Should: save the rule\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test\n+    public void shouldSaveConditionInRulesPage() throws DotSecurityException, DotDataException {\n+        final Role role = new RoleDataGen().nextPersisted();\n+        final User user = new UserDataGen().roles(role).nextPersisted();\n+        final Host host = new SiteDataGen().nextPersisted();\n+\n+        final Template template = new TemplateDataGen().nextPersisted();\n+        final HTMLPageAsset htmlPageAsset = new HTMLPageDataGen(host, template)\n+                .nextPersisted();\n+\n+        addPermission(role, htmlPageAsset, PermissionAPI.PERMISSION_PUBLISH);\n+        addRulesPermission(role, host, true);\n+        final Rule rule = new RuleDataGen().page(htmlPageAsset).nextPersisted();\n+\n+        final ConditionGroup conditionGroup = new ConditionGroupDataGen().rule(rule).next();\n+        this.addRulesPermission(role, host, true);\n+\n+        //Saving and testing GroupCondition\n+        rulesAPI.saveConditionGroup(conditionGroup, user, false);\n+\n+        List<Rule> allRules = rulesAPI.getAllRules(user, false);\n+        checkCondition(user, conditionGroup, allRules);\n+    }\n+\n+    /**\n+     * Method to Test: {@link RulesAPIImpl#saveConditionGroup(ConditionGroup, User, boolean)}\n+     *                  and {@link RulesAPIImpl#saveCondition(Condition, User, boolean)}\n+     * When:Try to create a Group Condition and a Condition in a page's rule without PuBLISH permission over the page\n+     * Should: Throw a {@link DotSecurityException}\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test(expected = DotSecurityException.class)\n+    public void shouldSaveConditionInRulesPageShouldNotWork() throws DotSecurityException, DotDataException {", "originalCommit": "31d54b5500f06032c74edc68827d35bdfae0e3e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQxMTQyMg==", "url": "https://github.com/dotCMS/core/pull/18201#discussion_r399411422", "bodyText": "done a3d5384#diff-9baded4fb0fb63e2648d9c9c4380ec1aR136", "author": "freddyucv", "createdAt": "2020-03-27T17:02:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM5MzMwMA=="}], "type": "inlineReview", "revised_code": {"commit": "a3d5384f514af695b89fdbc549338def9a8cce2c", "chunk": "diff --git a/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java b/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java\nindex 2ca0e208f8..a6eb79e37f 100644\n--- a/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java\n+++ b/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java\n\n@@ -79,13 +79,14 @@ public class RulesAPIImplIntegrationTest {\n         final Rule rule = new RuleDataGen().host(host).nextPersisted();\n \n         final ConditionGroup conditionGroup = new ConditionGroupDataGen().rule(rule).next();\n-        this.addRulesPermission(role, host, true);\n+        addRulesReadPermissions(role, host);\n+        addRulesPublishPermissions(role, host);\n \n         //Saving and testing GroupCondition\n         rulesAPI.saveConditionGroup(conditionGroup, user, false);\n \n         List<Rule> allRules = rulesAPI.getAllRules(user, false);\n-        checkCondition(user, conditionGroup, allRules);\n+        createConditionAndCheck(user, conditionGroup, allRules);\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM5Mzg2OA==", "url": "https://github.com/dotCMS/core/pull/18201#discussion_r399393868", "bodyText": "rename method to: shouldNotSaveRuleActionInRuleOnPage", "author": "dsilvam", "createdAt": "2020-03-27T16:35:33Z", "path": "dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java", "diffHunk": "@@ -144,13 +209,75 @@ public void shouldSaveRuleAction() throws DotSecurityException, DotDataException\n         final Host host = new SiteDataGen().nextPersisted();\n         final Rule rule = new RuleDataGen().host(host).nextPersisted();\n \n-        this.addPermission(role, host, true);\n+        this.addRulesPermission(role, host, true);\n+\n+        final RuleAction ruleAction = new RuleActionDataGen().rule(rule).next();\n+\n+        rulesAPI.saveRuleAction(ruleAction, user, false);\n+\n+        final List<Rule> allRules = rulesAPI.getAllRules(user, false);\n+        checkActions(ruleAction, allRules);\n+    }\n+\n+    /**\n+     * Method to Test: {@link RulesAPIImpl#saveRuleAction(RuleAction, User, boolean)}\n+     * When: User with permission try to create a Rule's Action in a Rule's Page\n+     * Should: Save it\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test\n+    public void shouldSaveRuleActionInPage() throws DotSecurityException, DotDataException {\n+        final Role role = new RoleDataGen().nextPersisted();\n+        final User user = new UserDataGen().roles(role).nextPersisted();\n+        final Host host = new SiteDataGen().nextPersisted();\n+\n+         final Template template = new TemplateDataGen().nextPersisted();\n+         final HTMLPageAsset htmlPageAsset = new HTMLPageDataGen(host, template)\n+                .nextPersisted();\n+\n+        final Rule rule = new RuleDataGen().page(htmlPageAsset).nextPersisted();\n \n+        this.addRulesPermission(role, host, true);\n+        this.addPermission(role, htmlPageAsset, PermissionLevel.PUBLISH.getType());\n         final RuleAction ruleAction = new RuleActionDataGen().rule(rule).next();\n \n         rulesAPI.saveRuleAction(ruleAction, user, false);\n \n         final List<Rule> allRules = rulesAPI.getAllRules(user, false);\n+        checkActions(ruleAction, allRules);\n+    }\n+\n+    /**\n+     * Method to Test: {@link RulesAPIImpl#saveRuleAction(RuleAction, User, boolean)}\n+     * When: User with permission try to create a Rule's Action but without PUBLISH permission over the page\n+     * Should: throw a {@link DotSecurityException}\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test (expected = DotSecurityException.class)\n+    public void shouldSaveRuleActionInPageShouldNotWork() throws DotSecurityException, DotDataException {", "originalCommit": "31d54b5500f06032c74edc68827d35bdfae0e3e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQxMTU1MQ==", "url": "https://github.com/dotCMS/core/pull/18201#discussion_r399411551", "bodyText": "done a3d5384#diff-9baded4fb0fb63e2648d9c9c4380ec1aR271", "author": "freddyucv", "createdAt": "2020-03-27T17:02:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM5Mzg2OA=="}], "type": "inlineReview", "revised_code": {"commit": "a3d5384f514af695b89fdbc549338def9a8cce2c", "chunk": "diff --git a/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java b/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java\nindex 2ca0e208f8..a6eb79e37f 100644\n--- a/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java\n+++ b/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java\n\n@@ -209,7 +217,8 @@ public class RulesAPIImplIntegrationTest {\n         final Host host = new SiteDataGen().nextPersisted();\n         final Rule rule = new RuleDataGen().host(host).nextPersisted();\n \n-        this.addRulesPermission(role, host, true);\n+        addRulesReadPermissions(role, host);\n+        addRulesPublishPermissions(role, host);\n \n         final RuleAction ruleAction = new RuleActionDataGen().rule(rule).next();\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM5NDI5NA==", "url": "https://github.com/dotCMS/core/pull/18201#discussion_r399394294", "bodyText": "Rename method to: shouldNotDeleteRuleOnPage", "author": "dsilvam", "createdAt": "2020-03-27T16:36:11Z", "path": "dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java", "diffHunk": "@@ -193,13 +320,75 @@ public void shouldDeleteRules() throws DotSecurityException, DotDataException {\n         final Host host = new SiteDataGen().nextPersisted();\n         final Rule rule = new RuleDataGen().host(host).nextPersisted();\n \n-        this.addPermission(role, host, true);\n+        this.addRulesPermission(role, host, true);\n+\n+        assertTrue(existRule(rule));\n+\n+        rulesAPI.deleteRule(rule, user, false);\n+\n+        assertFalse(existRule(rule));\n+    }\n+\n+    /**\n+     * Method to Test: {@link RulesAPIImpl#deleteRule(Rule, User, boolean)}\n+     * When: User with permission try to delete a rule's page\n+     * Should: Delete it\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test\n+    public void shouldDeleteRulesInPage() throws DotSecurityException, DotDataException {\n+        final Role role = new RoleDataGen().nextPersisted();\n+        final User user = new UserDataGen().roles(role).nextPersisted();\n+        final Host host = new SiteDataGen().nextPersisted();\n+\n+        final Template template = new TemplateDataGen().nextPersisted();\n+        final HTMLPageAsset htmlPageAsset = new HTMLPageDataGen(host, template)\n+                .nextPersisted();\n+\n+        final Rule rule = new RuleDataGen().page(htmlPageAsset).nextPersisted();\n \n-        assertTrue(existRule(user, rule));\n+        this.addRulesPermission(role, host, true);\n+        this.addPermission(role, htmlPageAsset, PermissionAPI.PERMISSION_PUBLISH);\n+\n+        assertTrue(existRule(rule));\n+\n+        rulesAPI.deleteRule(rule, user, false);\n+\n+        assertFalse(existRule(rule));\n+\n+    }\n+\n+    /**\n+     * Method to Test: {@link RulesAPIImpl#deleteRule(Rule, User, boolean)}\n+     * When: User with permission try to delete a rule's page without PUBLISH permission over the page\n+     * Should:throw a {@link DotSecurityException}\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test(expected = DotSecurityException.class)\n+    public void shouldDeleteRulesInPageShouldNotWork() throws DotSecurityException, DotDataException {", "originalCommit": "31d54b5500f06032c74edc68827d35bdfae0e3e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQxMTcxOQ==", "url": "https://github.com/dotCMS/core/pull/18201#discussion_r399411719", "bodyText": "done a3d5384#diff-9baded4fb0fb63e2648d9c9c4380ec1aR385", "author": "freddyucv", "createdAt": "2020-03-27T17:02:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM5NDI5NA=="}], "type": "inlineReview", "revised_code": {"commit": "a3d5384f514af695b89fdbc549338def9a8cce2c", "chunk": "diff --git a/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java b/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java\nindex 2ca0e208f8..a6eb79e37f 100644\n--- a/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java\n+++ b/dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java\n\n@@ -320,7 +331,8 @@ public class RulesAPIImplIntegrationTest {\n         final Host host = new SiteDataGen().nextPersisted();\n         final Rule rule = new RuleDataGen().host(host).nextPersisted();\n \n-        this.addRulesPermission(role, host, true);\n+        addRulesReadPermissions(role, host);\n+        addRulesPublishPermissions(role, host);\n \n         assertTrue(existRule(rule));\n \n"}}, {"oid": "a3d5384f514af695b89fdbc549338def9a8cce2c", "url": "https://github.com/dotCMS/core/commit/a3d5384f514af695b89fdbc549338def9a8cce2c", "message": "#17901 refactoring", "committedDate": "2020-03-27T16:55:17Z", "type": "commit"}, {"oid": "5c57d7fe15875cec1b5a59c6dd7c675575f3bfb4", "url": "https://github.com/dotCMS/core/commit/5c57d7fe15875cec1b5a59c6dd7c675575f3bfb4", "message": "#17901 refactoring", "committedDate": "2020-03-27T17:58:16Z", "type": "commit"}, {"oid": "e30f796e80b76383c5d421a2a1f2cf15966746eb", "url": "https://github.com/dotCMS/core/commit/e30f796e80b76383c5d421a2a1f2cf15966746eb", "message": "Merge remote-tracking branch 'origin/master' into issue-17901-Unable-to-create-rules", "committedDate": "2020-03-27T19:11:00Z", "type": "commit"}, {"oid": "9dcc64bb04edfadcee9a6df0f9cb6ec383121f7e", "url": "https://github.com/dotCMS/core/commit/9dcc64bb04edfadcee9a6df0f9cb6ec383121f7e", "message": "Merge branch 'master' of https://github.com/dotCMS/core into issue-17901-Unable-to-create-rules", "committedDate": "2020-03-27T19:11:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ5MDU5NQ==", "url": "https://github.com/dotCMS/core/pull/18201#discussion_r399490595", "bodyText": "Issue found: Parameter 'role' is not assigned and could be declared final", "author": "dev-dotcms", "createdAt": "2020-03-27T19:22:41Z", "path": "dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java", "diffHunk": "@@ -527,6 +702,30 @@ public void shouldSaveNewRuleInPage() throws DotSecurityException, DotDataExcept\n         assertTrue(rulesId.contains(rule.getId()));\n     }\n \n+    @NotNull\n+    private void addPermission(\n+            final Role role,\n+            final Permissionable permissionable,\n+            final int permissionPublish) {\n+\n+        final Permission publishPermission = getPermission(role, permissionable, permissionPublish);\n+\n+        try {\n+            APILocator.getPermissionAPI().save(publishPermission, permissionable, systemUser, false);\n+        } catch (DotDataException | DotSecurityException e){\n+            throw new RuntimeException(e);\n+        }\n+    }\n+\n+    @NotNull\n+    private Permission getPermission(Role role, Permissionable permissionable, int permissionPublish) {", "originalCommit": "9dcc64bb04edfadcee9a6df0f9cb6ec383121f7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ5MDYwNQ==", "url": "https://github.com/dotCMS/core/pull/18201#discussion_r399490605", "bodyText": "Issue found: JUnit tests should include assert() or fail()", "author": "dev-dotcms", "createdAt": "2020-03-27T19:22:43Z", "path": "dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java", "diffHunk": "@@ -82,12 +79,85 @@ public void shouldSaveCondition() throws DotSecurityException, DotDataException\n         final Rule rule = new RuleDataGen().host(host).nextPersisted();\n \n         final ConditionGroup conditionGroup = new ConditionGroupDataGen().rule(rule).next();\n-        this.addPermission(role, host, true);\n+        addRulesPublishPermissions(role, host);\n \n         //Saving and testing GroupCondition\n         rulesAPI.saveConditionGroup(conditionGroup, user, false);\n \n         List<Rule> allRules = rulesAPI.getAllRules(user, false);\n+        createConditionAndCheck(user, conditionGroup, allRules);\n+    }\n+\n+    /**\n+     * Method to Test: {@link RulesAPIImpl#saveConditionGroup(ConditionGroup, User, boolean)}\n+     *                  and {@link RulesAPIImpl#saveCondition(Condition, User, boolean)}\n+     * When:Try to create a Group Condition and a Condition in a page's rule with PuBLISH permission over the page\n+     * Should: save the rule\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test\n+    public void shouldSaveConditionInRulesPage() throws DotSecurityException, DotDataException {", "originalCommit": "9dcc64bb04edfadcee9a6df0f9cb6ec383121f7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ5MDYxMw==", "url": "https://github.com/dotCMS/core/pull/18201#discussion_r399490613", "bodyText": "Issue found: Local variable 'allRules' could be declared final", "author": "dev-dotcms", "createdAt": "2020-03-27T19:22:44Z", "path": "dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java", "diffHunk": "@@ -82,12 +79,85 @@ public void shouldSaveCondition() throws DotSecurityException, DotDataException\n         final Rule rule = new RuleDataGen().host(host).nextPersisted();\n \n         final ConditionGroup conditionGroup = new ConditionGroupDataGen().rule(rule).next();\n-        this.addPermission(role, host, true);\n+        addRulesPublishPermissions(role, host);\n \n         //Saving and testing GroupCondition\n         rulesAPI.saveConditionGroup(conditionGroup, user, false);\n \n         List<Rule> allRules = rulesAPI.getAllRules(user, false);\n+        createConditionAndCheck(user, conditionGroup, allRules);\n+    }\n+\n+    /**\n+     * Method to Test: {@link RulesAPIImpl#saveConditionGroup(ConditionGroup, User, boolean)}\n+     *                  and {@link RulesAPIImpl#saveCondition(Condition, User, boolean)}\n+     * When:Try to create a Group Condition and a Condition in a page's rule with PuBLISH permission over the page\n+     * Should: save the rule\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test\n+    public void shouldSaveConditionInRulesPage() throws DotSecurityException, DotDataException {\n+        final Role role = new RoleDataGen().nextPersisted();\n+        final User user = new UserDataGen().roles(role).nextPersisted();\n+        final Host host = new SiteDataGen().nextPersisted();\n+\n+        final Template template = new TemplateDataGen().nextPersisted();\n+        final HTMLPageAsset htmlPageAsset = new HTMLPageDataGen(host, template)\n+                .nextPersisted();\n+\n+        addPermission(role, htmlPageAsset, PermissionAPI.PERMISSION_PUBLISH);\n+        addRulesPublishPermissions(role, host);\n+\n+        final Rule rule = new RuleDataGen().page(htmlPageAsset).nextPersisted();\n+\n+        final ConditionGroup conditionGroup = new ConditionGroupDataGen().rule(rule).next();\n+\n+        //Saving and testing GroupCondition\n+        rulesAPI.saveConditionGroup(conditionGroup, user, false);\n+\n+        List<Rule> allRules = rulesAPI.getAllRules(user, false);", "originalCommit": "9dcc64bb04edfadcee9a6df0f9cb6ec383121f7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ5MDYyNA==", "url": "https://github.com/dotCMS/core/pull/18201#discussion_r399490624", "bodyText": "Issue found: JUnit tests should include assert() or fail()", "author": "dev-dotcms", "createdAt": "2020-03-27T19:22:45Z", "path": "dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java", "diffHunk": "@@ -144,13 +214,75 @@ public void shouldSaveRuleAction() throws DotSecurityException, DotDataException\n         final Host host = new SiteDataGen().nextPersisted();\n         final Rule rule = new RuleDataGen().host(host).nextPersisted();\n \n-        this.addPermission(role, host, true);\n+        addRulesPublishPermissions(role, host);\n+\n+        final RuleAction ruleAction = new RuleActionDataGen().rule(rule).next();\n+\n+        rulesAPI.saveRuleAction(ruleAction, user, false);\n+\n+        final List<Rule> allRules = rulesAPI.getAllRules(user, false);\n+        checkActions(ruleAction, allRules);\n+    }\n+\n+    /**\n+     * Method to Test: {@link RulesAPIImpl#saveRuleAction(RuleAction, User, boolean)}\n+     * When: User with permission try to create a Rule's Action in a Rule's Page\n+     * Should: Save it\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test\n+    public void shouldSaveRuleActionInPage() throws DotSecurityException, DotDataException {", "originalCommit": "9dcc64bb04edfadcee9a6df0f9cb6ec383121f7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ5MDY0NA==", "url": "https://github.com/dotCMS/core/pull/18201#discussion_r399490644", "bodyText": "Issue found: Avoid unused imports such as 'com.dotmarketing.business'", "author": "dev-dotcms", "createdAt": "2020-03-27T19:22:46Z", "path": "dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java", "diffHunk": "@@ -16,11 +16,7 @@\n import com.dotcms.util.IntegrationTestInitService;\n import com.dotmarketing.beans.Host;\n import com.dotmarketing.beans.Permission;\n-import com.dotmarketing.business.APILocator;\n-import com.dotmarketing.business.CacheLocator;\n-import com.dotmarketing.business.PermissionAPI;\n-import com.dotmarketing.business.Role;\n-import com.dotmarketing.business.Ruleable;\n+import com.dotmarketing.business.*;", "originalCommit": "9dcc64bb04edfadcee9a6df0f9cb6ec383121f7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ5MDY2NA==", "url": "https://github.com/dotCMS/core/pull/18201#discussion_r399490664", "bodyText": "Issue found: Avoid throwing raw exception types.", "author": "dev-dotcms", "createdAt": "2020-03-27T19:22:48Z", "path": "dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java", "diffHunk": "@@ -527,6 +702,30 @@ public void shouldSaveNewRuleInPage() throws DotSecurityException, DotDataExcept\n         assertTrue(rulesId.contains(rule.getId()));\n     }\n \n+    @NotNull\n+    private void addPermission(\n+            final Role role,\n+            final Permissionable permissionable,\n+            final int permissionPublish) {\n+\n+        final Permission publishPermission = getPermission(role, permissionable, permissionPublish);\n+\n+        try {\n+            APILocator.getPermissionAPI().save(publishPermission, permissionable, systemUser, false);\n+        } catch (DotDataException | DotSecurityException e){\n+            throw new RuntimeException(e);", "originalCommit": "9dcc64bb04edfadcee9a6df0f9cb6ec383121f7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}