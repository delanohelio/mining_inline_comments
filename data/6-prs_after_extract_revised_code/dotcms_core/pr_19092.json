{"pr_number": 19092, "pr_title": "Improve reindex mapping process", "pr_createdAt": "2020-08-13T15:01:21Z", "pr_url": "https://github.com/dotCMS/core/pull/19092", "timeline": [{"oid": "0457b2ad5ddee91f480a047b3511c1d423d0c99e", "url": "https://github.com/dotCMS/core/commit/0457b2ad5ddee91f480a047b3511c1d423d0c99e", "message": "#19091 ESMappingUtilHelper.getInstance().addCustomMapping was moved out of the commit listener and the reindex switchover pause was increased", "committedDate": "2020-08-13T14:50:13Z", "type": "commit"}, {"oid": "04939462863df5477e83f1978c940bc696755fab", "url": "https://github.com/dotCMS/core/commit/04939462863df5477e83f1978c940bc696755fab", "message": "#19091 Field mapping is executed per content type", "committedDate": "2020-08-13T14:52:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA0MzEwOQ==", "url": "https://github.com/dotCMS/core/pull/19092#discussion_r470043109", "bodyText": "stream() method can be removed", "author": "victoralfaro-dotcms", "createdAt": "2020-08-13T15:36:32Z", "path": "dotCMS/src/main/java/com/dotcms/content/elasticsearch/util/ESMappingUtilHelper.java", "diffHunk": "@@ -294,23 +295,28 @@ private void addMappingForRemainingFields(final Set<String> mappedFields,\n     private void addMappingForContentTypeIfNeeded(final ContentType contentType,\n             final Set<String> mappedFields, final String... indexes) {\n         final Map<String, JSONObject> contentTypeMapping = new HashMap();\n-        contentType.fields().stream().forEach(field-> {\n-                try {\n-                    addMappingForFieldIfNeeded(contentType, field,\n-                            mappedFields, contentTypeMapping);\n-                    putContentTypeMapping(contentType, contentTypeMapping, indexes);\n-                } catch (Exception e) {\n-                    handleInvalidCustomMappingError(\n-                            \"notification.reindexing.content.type.mapping.error\",\n-                            contentType.name(), indexes);\n-                    final String message =\n-                            \"Error updating index mapping for content type \" + contentType.name()\n-                                    + \". This custom mapping will be ignored for index(es) \" +\n-                                    Arrays.stream(indexes).collect(Collectors.joining(\",\"));\n-                    Logger.warn(ESMappingUtilHelper.class, message, e);\n+        try {\n+            contentType.fields().stream().forEach(field-> {", "originalCommit": "04939462863df5477e83f1978c940bc696755fab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA1MDI4Ng==", "url": "https://github.com/dotCMS/core/pull/19092#discussion_r470050286", "bodyText": "Why having nested try-catches if you are throwing a DotRuntimeException to be caught outside the loop?", "author": "victoralfaro-dotcms", "createdAt": "2020-08-13T15:47:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA0MzEwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA1NjM4OQ==", "url": "https://github.com/dotCMS/core/pull/19092#discussion_r470056389", "bodyText": "Because these exceptions need to be logged but never interrupt the whole process. This logic is part of a full reindex, which can take a lot of time in large datasets. Here, it is important to give more priority to the full process itself, because otherwise the application is useless, even when just setting a field mapping fails.", "author": "nollymar", "createdAt": "2020-08-13T15:56:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA0MzEwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA1NjY2OA==", "url": "https://github.com/dotCMS/core/pull/19092#discussion_r470056668", "bodyText": "By the way, the stream() suggestion was applied", "author": "nollymar", "createdAt": "2020-08-13T15:56:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA0MzEwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA1ODI1Mg==", "url": "https://github.com/dotCMS/core/pull/19092#discussion_r470058252", "bodyText": "Fair enough! Thanks for clarifying.", "author": "victoralfaro-dotcms", "createdAt": "2020-08-13T15:59:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA0MzEwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "f59802ad3ca5ff400b233d0946be0773a8c4e0f3", "chunk": "diff --git a/dotCMS/src/main/java/com/dotcms/content/elasticsearch/util/ESMappingUtilHelper.java b/dotCMS/src/main/java/com/dotcms/content/elasticsearch/util/ESMappingUtilHelper.java\nindex 09ff59336c..f7ad419483 100644\n--- a/dotCMS/src/main/java/com/dotcms/content/elasticsearch/util/ESMappingUtilHelper.java\n+++ b/dotCMS/src/main/java/com/dotcms/content/elasticsearch/util/ESMappingUtilHelper.java\n\n@@ -296,7 +296,7 @@ public class ESMappingUtilHelper {\n             final Set<String> mappedFields, final String... indexes) {\n         final Map<String, JSONObject> contentTypeMapping = new HashMap();\n         try {\n-            contentType.fields().stream().forEach(field-> {\n+            contentType.fields().forEach(field-> {\n                     try {\n                         addMappingForFieldIfNeeded(contentType, field,\n                                 mappedFields, contentTypeMapping);\n"}}, {"oid": "f59802ad3ca5ff400b233d0946be0773a8c4e0f3", "url": "https://github.com/dotCMS/core/commit/f59802ad3ca5ff400b233d0946be0773a8c4e0f3", "message": "#19091 Applying code review suggestions", "committedDate": "2020-08-13T15:53:47Z", "type": "commit"}, {"oid": "fd53e2b51b31f512b73d04e5c630d555b26f49c2", "url": "https://github.com/dotCMS/core/commit/fd53e2b51b31f512b73d04e5c630d555b26f49c2", "message": "#19091 Show switchover notification when the switchover actually finishes", "committedDate": "2020-08-13T21:42:49Z", "type": "commit"}, {"oid": "407a3ab058ae8dd8ec8de05dfb75868a775ba37a", "url": "https://github.com/dotCMS/core/commit/407a3ab058ae8dd8ec8de05dfb75868a775ba37a", "message": "Updating release version number", "committedDate": "2020-08-13T21:43:19Z", "type": "commit"}, {"oid": "d01d706c388b14c962661dd9f032a4f11e41c55b", "url": "https://github.com/dotCMS/core/commit/d01d706c388b14c962661dd9f032a4f11e41c55b", "message": "#19091 Show switchover notification when the switchover actually finishes", "committedDate": "2020-08-13T21:43:34Z", "type": "commit"}, {"oid": "4cd6b5f487e00d9f154060cf174b7bcbb9dea1b6", "url": "https://github.com/dotCMS/core/commit/4cd6b5f487e00d9f154060cf174b7bcbb9dea1b6", "message": "Changing log level to debug", "committedDate": "2020-08-13T21:44:28Z", "type": "commit"}]}