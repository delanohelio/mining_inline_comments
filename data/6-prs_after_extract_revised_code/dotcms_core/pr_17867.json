{"pr_number": 17867, "pr_title": "#17864 fixed with test", "pr_createdAt": "2020-01-17T21:38:11Z", "pr_url": "https://github.com/dotCMS/core/pull/17867", "timeline": [{"oid": "2244ae0defc6e2e77a4db53e67a2e9922e3677a8", "url": "https://github.com/dotCMS/core/commit/2244ae0defc6e2e77a4db53e67a2e9922e3677a8", "message": "#17864 fixed with test", "committedDate": "2020-01-17T21:14:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE1MDExMA==", "url": "https://github.com/dotCMS/core/pull/17867#discussion_r368150110", "bodyText": "Issue found: Avoid unused imports such as 'java.util.Set'", "author": "dev-dotcms", "createdAt": "2020-01-17T21:47:56Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/contentlet/transform/ContentletTransformerTest.java", "diffHunk": "@@ -21,10 +24,14 @@\n import com.dotmarketing.portlets.contentlet.struts.ContentletForm;\n import com.dotmarketing.portlets.htmlpageasset.business.HTMLPageAssetAPI;\n import com.dotmarketing.portlets.workflows.business.BaseWorkflowIntegrationTest;\n+import com.dotmarketing.util.UUIDGenerator;\n+import com.twelvemonkeys.util.LinkedSet;\n+import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n import java.util.Map;\n import java.util.Objects;\n+import java.util.Set;", "originalCommit": "2244ae0defc6e2e77a4db53e67a2e9922e3677a8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE1MDExOQ==", "url": "https://github.com/dotCMS/core/pull/17867#discussion_r368150119", "bodyText": "Issue found: A method/constructor should not explicitly throw java.lang.Exception", "author": "dev-dotcms", "createdAt": "2020-01-17T21:47:57Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/contentlet/transform/ContentletTransformerTest.java", "diffHunk": "@@ -166,6 +175,68 @@ public String getUrl(Contentlet contentlet) {\n         assertEquals(urlExpected, newContentlet.getMap().get(HTMLPageAssetAPI.URL_FIELD));\n         assertFalse(newContentlet.getMap().containsKey(Contentlet.NULL_PROPERTIES));\n     }\n+    \n+    /**\n+     * this test creates a widget type that has constant fields and a content of this type.\n+     * It updates the constant field values and insures that the new constant field values are both\n+     * in the content object and the newly transformed map\n+     * @throws Exception\n+     */\n+    @Test\n+    public void Test_Constant_fields_are_in_map() throws Exception {", "originalCommit": "2244ae0defc6e2e77a4db53e67a2e9922e3677a8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE1MDEyNQ==", "url": "https://github.com/dotCMS/core/pull/17867#discussion_r368150125", "bodyText": "Issue found: Local variable 'newField' could be declared final", "author": "dev-dotcms", "createdAt": "2020-01-17T21:47:58Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/contentlet/transform/ContentletTransformerTest.java", "diffHunk": "@@ -166,6 +175,68 @@ public String getUrl(Contentlet contentlet) {\n         assertEquals(urlExpected, newContentlet.getMap().get(HTMLPageAssetAPI.URL_FIELD));\n         assertFalse(newContentlet.getMap().containsKey(Contentlet.NULL_PROPERTIES));\n     }\n+    \n+    /**\n+     * this test creates a widget type that has constant fields and a content of this type.\n+     * It updates the constant field values and insures that the new constant field values are both\n+     * in the content object and the newly transformed map\n+     * @throws Exception\n+     */\n+    @Test\n+    public void Test_Constant_fields_are_in_map() throws Exception {\n+        \n+        \n+        // create a widget and a content of that widget;\n+        final ContentType widgetLikeContenType = TestDataUtils.getWidgetLikeContentType();\n+        final Contentlet newContentlet = TestDataUtils.getWidgetContent(true, 1, widgetLikeContenType.id());\n+        assertNotNull(newContentlet);\n+\n+        final List<Field> constants = widgetLikeContenType.fields(ConstantField.class);\n+        \n+        final String constantVar1 = constants.get(0).variable();\n+        final String constantVar2 = constants.get(1).variable();\n+        \n+        // assert our content type has no constant values in it\n+        assertTrue(constants.size()>1);\n+        assertNull(constants.get(0).values());\n+        assertNull(constants.get(1).values());\n+        \n+        // assert our content Map has no constant values in it\n+        Map<String,Object> map = new ContentletToMapTransformer(newContentlet).toMaps().get(0);\n+        assertNull(map.get(constantVar1));\n+        assertNull(map.get(constantVar2));\n+        \n+        \n+        // update our Content Type constants to have values\n+        final List<Field> allFields = new ArrayList<>(widgetLikeContenType.fields());\n+        allFields.removeIf(f->constants.contains(f));\n+        for(final Field field : constants) {\n+            final String value = UUIDGenerator.generateUuid();\n+            Field newField = FieldBuilder.builder(field).values(value).build();", "originalCommit": "2244ae0defc6e2e77a4db53e67a2e9922e3677a8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE1MDEzMw==", "url": "https://github.com/dotCMS/core/pull/17867#discussion_r368150133", "bodyText": "Issue found: Avoid unused imports such as 'com.twelvemonkeys.util.LinkedSet'", "author": "dev-dotcms", "createdAt": "2020-01-17T21:47:59Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/contentlet/transform/ContentletTransformerTest.java", "diffHunk": "@@ -21,10 +24,14 @@\n import com.dotmarketing.portlets.contentlet.struts.ContentletForm;\n import com.dotmarketing.portlets.htmlpageasset.business.HTMLPageAssetAPI;\n import com.dotmarketing.portlets.workflows.business.BaseWorkflowIntegrationTest;\n+import com.dotmarketing.util.UUIDGenerator;\n+import com.twelvemonkeys.util.LinkedSet;", "originalCommit": "2244ae0defc6e2e77a4db53e67a2e9922e3677a8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE1MDEzOQ==", "url": "https://github.com/dotCMS/core/pull/17867#discussion_r368150139", "bodyText": "Issue found: Local variable 'updatedType' could be declared final", "author": "dev-dotcms", "createdAt": "2020-01-17T21:48:01Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/contentlet/transform/ContentletTransformerTest.java", "diffHunk": "@@ -166,6 +175,68 @@ public String getUrl(Contentlet contentlet) {\n         assertEquals(urlExpected, newContentlet.getMap().get(HTMLPageAssetAPI.URL_FIELD));\n         assertFalse(newContentlet.getMap().containsKey(Contentlet.NULL_PROPERTIES));\n     }\n+    \n+    /**\n+     * this test creates a widget type that has constant fields and a content of this type.\n+     * It updates the constant field values and insures that the new constant field values are both\n+     * in the content object and the newly transformed map\n+     * @throws Exception\n+     */\n+    @Test\n+    public void Test_Constant_fields_are_in_map() throws Exception {\n+        \n+        \n+        // create a widget and a content of that widget;\n+        final ContentType widgetLikeContenType = TestDataUtils.getWidgetLikeContentType();\n+        final Contentlet newContentlet = TestDataUtils.getWidgetContent(true, 1, widgetLikeContenType.id());\n+        assertNotNull(newContentlet);\n+\n+        final List<Field> constants = widgetLikeContenType.fields(ConstantField.class);\n+        \n+        final String constantVar1 = constants.get(0).variable();\n+        final String constantVar2 = constants.get(1).variable();\n+        \n+        // assert our content type has no constant values in it\n+        assertTrue(constants.size()>1);\n+        assertNull(constants.get(0).values());\n+        assertNull(constants.get(1).values());\n+        \n+        // assert our content Map has no constant values in it\n+        Map<String,Object> map = new ContentletToMapTransformer(newContentlet).toMaps().get(0);\n+        assertNull(map.get(constantVar1));\n+        assertNull(map.get(constantVar2));\n+        \n+        \n+        // update our Content Type constants to have values\n+        final List<Field> allFields = new ArrayList<>(widgetLikeContenType.fields());\n+        allFields.removeIf(f->constants.contains(f));\n+        for(final Field field : constants) {\n+            final String value = UUIDGenerator.generateUuid();\n+            Field newField = FieldBuilder.builder(field).values(value).build();\n+            allFields.add(newField);\n+        }\n+        ContentType updatedType =APILocator.getContentTypeAPI(APILocator.systemUser()).save(widgetLikeContenType, allFields);", "originalCommit": "2244ae0defc6e2e77a4db53e67a2e9922e3677a8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}