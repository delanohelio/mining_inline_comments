{"pr_number": 1844, "pr_title": "Towing improvements 1", "pr_createdAt": "2020-04-12T16:45:23Z", "pr_url": "https://github.com/MegaMek/megamek/pull/1844", "timeline": [{"oid": "bb64397f55d63a18565a83202eb94192ceae210a", "url": "https://github.com/MegaMek/megamek/commit/bb64397f55d63a18565a83202eb94192ceae210a", "message": "Update towing MP per TM errata", "committedDate": "2020-04-07T16:42:43Z", "type": "commit"}, {"oid": "a8582c413c6f431fda487d5e4d51689b99a65621", "url": "https://github.com/MegaMek/megamek/commit/a8582c413c6f431fda487d5e4d51689b99a65621", "message": "Test adjacent coords for whole land train when unloading", "committedDate": "2020-04-08T15:48:50Z", "type": "commit"}, {"oid": "e159757f5a44574a9f8e805fb4813c7d89db418e", "url": "https://github.com/MegaMek/megamek/commit/e159757f5a44574a9f8e805fb4813c7d89db418e", "message": "Allow towed trailers to unload to alternate positions", "committedDate": "2020-04-08T16:37:19Z", "type": "commit"}, {"oid": "e76f9a0fcc94afdbe2aba8890146c2367795ebf8", "url": "https://github.com/MegaMek/megamek/commit/e76f9a0fcc94afdbe2aba8890146c2367795ebf8", "message": "Fix stack violation check to use targetPos if available", "committedDate": "2020-04-08T16:37:41Z", "type": "commit"}, {"oid": "decd072989a494462dde3d77cf9e14796a5a6f34", "url": "https://github.com/MegaMek/megamek/commit/decd072989a494462dde3d77cf9e14796a5a6f34", "message": "Finish unload trains to adjacent hexes", "committedDate": "2020-04-09T15:34:31Z", "type": "commit"}, {"oid": "af988c840b5c2d32d347a13b06a54225b9f32044", "url": "https://github.com/MegaMek/megamek/commit/af988c840b5c2d32d347a13b06a54225b9f32044", "message": "Allow infantry adjacent to trains to Mount", "committedDate": "2020-04-09T15:56:26Z", "type": "commit"}, {"oid": "a5e7aeb29779ba789a4c17c0dcaafad0676455e7", "url": "https://github.com/MegaMek/megamek/commit/a5e7aeb29779ba789a4c17c0dcaafad0676455e7", "message": "Update system panel display for trailer ammo", "committedDate": "2020-04-10T16:53:38Z", "type": "commit"}, {"oid": "0572f3b8a8cb57c5da22712e79aa90d3a002cb95", "url": "https://github.com/MegaMek/megamek/commit/0572f3b8a8cb57c5da22712e79aa90d3a002cb95", "message": "WIP ammo sharing for trains", "committedDate": "2020-04-10T16:58:28Z", "type": "commit"}, {"oid": "b72a264612ec671ef1de22a741a36625541c9ef8", "url": "https://github.com/MegaMek/megamek/commit/b72a264612ec671ef1de22a741a36625541c9ef8", "message": "Allow loadWeaponWithSameAmmo to search trailers and tractor", "committedDate": "2020-04-11T16:41:59Z", "type": "commit"}, {"oid": "46a3df6ca12bfc870c5d886643a88241e9793975", "url": "https://github.com/MegaMek/megamek/commit/46a3df6ca12bfc870c5d886643a88241e9793975", "message": "Add ammo carrier tracking for weapon attack actions", "committedDate": "2020-04-11T17:21:38Z", "type": "commit"}, {"oid": "27c35b8c6a1e2046ac48ade3bde5c19ff3c3bb6f", "url": "https://github.com/MegaMek/megamek/commit/27c35b8c6a1e2046ac48ade3bde5c19ff3c3bb6f", "message": "Update arty handler to use ammo carrier", "committedDate": "2020-04-11T17:37:34Z", "type": "commit"}, {"oid": "42e6f9d33244f4eca6665b3adc43f3c6945e6924", "url": "https://github.com/MegaMek/megamek/commit/42e6f9d33244f4eca6665b3adc43f3c6945e6924", "message": "WIP reloading ammo at disconnect", "committedDate": "2020-04-11T17:42:27Z", "type": "commit"}, {"oid": "3834ad7e0eb8e4859bc5d621db6a376fdfe79023", "url": "https://github.com/MegaMek/megamek/commit/3834ad7e0eb8e4859bc5d621db6a376fdfe79023", "message": "Set AmmoId in waa using entity of ammo mounted", "committedDate": "2020-04-12T15:14:46Z", "type": "commit"}, {"oid": "ebb25a0137fd054f357c1885cc7fe3ae9c58e721", "url": "https://github.com/MegaMek/megamek/commit/ebb25a0137fd054f357c1885cc7fe3ae9c58e721", "message": "Update isTowing value when disconnecting a trailer", "committedDate": "2020-04-12T15:55:03Z", "type": "commit"}, {"oid": "a4e62a9b182619855e0985018905f8d11db07346", "url": "https://github.com/MegaMek/megamek/commit/a4e62a9b182619855e0985018905f8d11db07346", "message": "Undo changes to system panel", "committedDate": "2020-04-12T16:09:29Z", "type": "commit"}, {"oid": "8bfd94c1e439a01a74f499489d1e64092ca0cb3c", "url": "https://github.com/MegaMek/megamek/commit/8bfd94c1e439a01a74f499489d1e64092ca0cb3c", "message": "Show train ammo in WeaponPanel display", "committedDate": "2020-04-12T16:40:12Z", "type": "commit"}, {"oid": "27f8efa619f768a4319e183bca6b403b85e44113", "url": "https://github.com/MegaMek/megamek/commit/27f8efa619f768a4319e183bca6b403b85e44113", "message": "Merge branch 'master' of https://github.com/MegaMek/megamek into Towing_Improvements_1", "committedDate": "2020-04-12T16:41:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzIyMzY1Nw==", "url": "https://github.com/MegaMek/megamek/pull/1844#discussion_r407223657", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        sb.append('['+ \"TR] \"); //$NON-NLS-1$\n          \n          \n            \n                        sb.append(\"[TR] \"); //$NON-NLS-1$", "author": "sixlettervariables", "createdAt": "2020-04-12T16:48:20Z", "path": "megamek/src/megamek/client/ui/swing/unitDisplay/WeaponPanel.java", "diffHunk": "@@ -2128,7 +2139,9 @@ private String formatAmmo(Mounted m) {\n         int ammoIndex = m.getDesc().indexOf(\n                 Messages.getString(\"MechDisplay.0\")); //$NON-NLS-1$\n         int loc = m.getLocation();\n-        if (loc != Entity.LOC_NONE) {\n+        if (!m.getEntity().equals(entity)) {\n+            sb.append('['+ \"TR] \"); //$NON-NLS-1$", "originalCommit": "27f8efa619f768a4319e183bca6b403b85e44113", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUwODIwMw==", "url": "https://github.com/MegaMek/megamek/pull/1844#discussion_r407508203", "bodyText": "Fixed", "author": "mkerensky", "createdAt": "2020-04-13T14:31:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzIyMzY1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "8307d6adc63d2e0b6d675aeca82d12395dd1bebd", "chunk": "diff --git a/megamek/src/megamek/client/ui/swing/unitDisplay/WeaponPanel.java b/megamek/src/megamek/client/ui/swing/unitDisplay/WeaponPanel.java\nindex 4e7d304352..9e64dd9fc6 100644\n--- a/megamek/src/megamek/client/ui/swing/unitDisplay/WeaponPanel.java\n+++ b/megamek/src/megamek/client/ui/swing/unitDisplay/WeaponPanel.java\n\n@@ -2140,7 +2140,7 @@ public class WeaponPanel extends PicMap implements ListSelectionListener,\n                 Messages.getString(\"MechDisplay.0\")); //$NON-NLS-1$\n         int loc = m.getLocation();\n         if (!m.getEntity().equals(entity)) {\n-            sb.append('['+ \"TR] \"); //$NON-NLS-1$\n+            sb.append(\"[TR] \"); //$NON-NLS-1$\n         } else if (loc != Entity.LOC_NONE) {\n             sb.append('[').append(entity.getLocationAbbr(loc)).append(\"] \"); //$NON-NLS-1$\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzIyMzc3MA==", "url": "https://github.com/MegaMek/megamek/pull/1844#discussion_r407223770", "bodyText": "Small craft can tow entities?", "author": "sixlettervariables", "createdAt": "2020-04-12T16:49:00Z", "path": "megamek/src/megamek/common/Compute.java", "diffHunk": "@@ -6678,7 +6677,7 @@ public static boolean inDeadZone(IGame game, Entity ae, Targetable target) {\n                 if ((en.getOwner().equals(other.getOwner()) || (en.getOwner()\n                                                                   .getTeam() == other.getOwner().getTeam()))\n                     && !en.equals(other)\n-                    && (other instanceof SmallCraft)\n+                    && ((other instanceof SmallCraft) || other.getTowing() != Entity.NONE || other.getTowedBy() != Entity.NONE)", "originalCommit": "27f8efa619f768a4319e183bca6b403b85e44113", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUwOTc0Mw==", "url": "https://github.com/MegaMek/megamek/pull/1844#discussion_r407509743", "bodyText": "This is code for loading infantry aboard multi-hex units, and yes, trains handle it like Dropships", "author": "mkerensky", "createdAt": "2020-04-13T14:34:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzIyMzc3MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzIyNDA4Mg==", "url": "https://github.com/MegaMek/megamek/pull/1844#discussion_r407224082", "bodyText": "Could this return null if aaa.getAmmoCarrier() returns Entity.NONE? Or can that never happen?", "author": "sixlettervariables", "createdAt": "2020-04-12T16:51:25Z", "path": "megamek/src/megamek/common/weapons/ArtilleryWeaponIndirectFireHandler.java", "diffHunk": "@@ -152,7 +152,9 @@ public boolean handle(IGame.Phase phase, Vector<Report> vPhaseReport) {\n             System.err.println(\"Artillery Entity is null!\");\n             return true;\n         }\n-        Mounted ammoUsed = ae.getEquipment(aaa.getAmmoId());\n+        //Trailers can share ammo, which means the entity carrying the ammo might\n+        Entity ammoCarrier = game.getEntity(aaa.getAmmoCarrier());", "originalCommit": "27f8efa619f768a4319e183bca6b403b85e44113", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUxMTc1Nw==", "url": "https://github.com/MegaMek/megamek/pull/1844#discussion_r407511757", "bodyText": "That can't happen. AmmoCarrier will return the firing entity 95% of the time.", "author": "mkerensky", "createdAt": "2020-04-13T14:38:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzIyNDA4Mg=="}], "type": "inlineReview", "revised_code": {"commit": "4f57aae0f831e2196ed6316a293a88bab147a18c", "chunk": "diff --git a/megamek/src/megamek/common/weapons/ArtilleryWeaponIndirectFireHandler.java b/megamek/src/megamek/common/weapons/ArtilleryWeaponIndirectFireHandler.java\nindex 69286d4a94..91aee54039 100644\n--- a/megamek/src/megamek/common/weapons/ArtilleryWeaponIndirectFireHandler.java\n+++ b/megamek/src/megamek/common/weapons/ArtilleryWeaponIndirectFireHandler.java\n\n@@ -152,7 +152,8 @@ public class ArtilleryWeaponIndirectFireHandler extends AmmoWeaponHandler {\n             System.err.println(\"Artillery Entity is null!\");\n             return true;\n         }\n-        //Trailers can share ammo, which means the entity carrying the ammo might\n+        //Trailers can share ammo, which means the entity carrying the ammo might not be\n+        //the firing entity\n         Entity ammoCarrier = game.getEntity(aaa.getAmmoCarrier());\n         Mounted ammoUsed = ammoCarrier.getEquipment(aaa.getAmmoId());\n         final AmmoType atype = ammoUsed == null ? null : (AmmoType) ammoUsed\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzIyNTk2Mg==", "url": "https://github.com/MegaMek/megamek/pull/1844#discussion_r407225962", "bodyText": "Needs a continue; here to avoid an NPE:\nhttps://lgtm.com/projects/g/MegaMek/megamek/snapshot/01ffc9b23acdb201d74d30b8fbf713894c95eb95/files/megamek/src/megamek/client/bot/princess/FireControl.java#x7c149b9bf1a4a99f:1", "author": "sixlettervariables", "createdAt": "2020-04-12T17:06:42Z", "path": "megamek/src/megamek/client/bot/princess/FireControl.java", "diffHunk": "@@ -2527,6 +2527,7 @@ void loadAmmo(final Entity shooter,\n             }", "originalCommit": "27f8efa619f768a4319e183bca6b403b85e44113", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUxNzk0Nw==", "url": "https://github.com/MegaMek/megamek/pull/1844#discussion_r407517947", "bodyText": "Good catch on ArtilleryBayWeapon(77).  I don't think either line in Compute needs it - those seem to be 'fake' weapon attack actions created but not finalized to calculate damage.\nI'll do some further playtesting with this on my next battle and see if I encounter unforeseen issues.", "author": "mkerensky", "createdAt": "2020-04-13T14:50:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzIyNTk2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "b9ec41a1e8d3340e4a913357be73357eee3dded1", "chunk": "diff --git a/megamek/src/megamek/client/bot/princess/FireControl.java b/megamek/src/megamek/client/bot/princess/FireControl.java\nindex f6b459f495..663a42c585 100644\n--- a/megamek/src/megamek/client/bot/princess/FireControl.java\n+++ b/megamek/src/megamek/client/bot/princess/FireControl.java\n\n@@ -2524,6 +2524,7 @@ public class FireControl {\n                 owner.log(getClass(), \"loadAmmo(Entity, Targetable)\", LogLevel.WARNING,\n                           shooter.getDisplayName() + \" tried to load \" + currentWeapon.getName() + \" with ammo \" +\n                           mountedAmmo.getDesc() + \" but failed somehow.\");\n+                continue;\n             }\n             final WeaponAttackAction action = info.getAction();\n             action.setAmmoId(shooter.getEquipmentNum(mountedAmmo));\n"}}, {"oid": "8307d6adc63d2e0b6d675aeca82d12395dd1bebd", "url": "https://github.com/MegaMek/megamek/commit/8307d6adc63d2e0b6d675aeca82d12395dd1bebd", "message": "Fix stringBuffer text in formatAmmo", "committedDate": "2020-04-13T14:31:55Z", "type": "commit"}, {"oid": "4f57aae0f831e2196ed6316a293a88bab147a18c", "url": "https://github.com/MegaMek/megamek/commit/4f57aae0f831e2196ed6316a293a88bab147a18c", "message": "Finish partial comment in artyindirecthandler", "committedDate": "2020-04-13T14:37:05Z", "type": "commit"}, {"oid": "b6c069df2c28bc3a47123c9776de4d62fe1af069", "url": "https://github.com/MegaMek/megamek/commit/b6c069df2c28bc3a47123c9776de4d62fe1af069", "message": "Resave long tom ammo trailer with trailer flag set", "committedDate": "2020-04-13T14:38:00Z", "type": "commit"}, {"oid": "39e12585c65988d8ae7d15f0b798f0cf8cec7e68", "url": "https://github.com/MegaMek/megamek/commit/39e12585c65988d8ae7d15f0b798f0cf8cec7e68", "message": "setAmmoCarrier for artyBayWeapon", "committedDate": "2020-04-13T14:49:12Z", "type": "commit"}, {"oid": "b9ec41a1e8d3340e4a913357be73357eee3dded1", "url": "https://github.com/MegaMek/megamek/commit/b9ec41a1e8d3340e4a913357be73357eee3dded1", "message": "Add continue at FireControl 2527", "committedDate": "2020-04-13T14:54:00Z", "type": "commit"}, {"oid": "871742bd2be2586a649ab60efce128c2f5b3adeb", "url": "https://github.com/MegaMek/megamek/commit/871742bd2be2586a649ab60efce128c2f5b3adeb", "message": "Merge branch 'master' of https://github.com/MegaMek/megamek into Towing_Improvements_1", "committedDate": "2020-04-17T15:11:24Z", "type": "commit"}, {"oid": "1d1119a69a4bff216dd0e605dcc7ace4b88e4b07", "url": "https://github.com/MegaMek/megamek/commit/1d1119a69a4bff216dd0e605dcc7ace4b88e4b07", "message": "Prevent princess from firing with no valid ammo", "committedDate": "2020-04-17T16:11:06Z", "type": "commit"}, {"oid": "c0f49810176133b7bff6b064a717930b760dd7a4", "url": "https://github.com/MegaMek/megamek/commit/c0f49810176133b7bff6b064a717930b760dd7a4", "message": "Add comment", "committedDate": "2020-04-17T16:20:44Z", "type": "commit"}]}