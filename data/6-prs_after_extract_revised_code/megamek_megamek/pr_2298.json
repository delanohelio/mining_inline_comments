{"pr_number": 2298, "pr_title": "VTOL pathfinding and movement corrections", "pr_createdAt": "2020-10-04T17:19:28Z", "pr_url": "https://github.com/MegaMek/megamek/pull/2298", "timeline": [{"oid": "37129054a19291717abe0a5fc0899ceb2beb9cc2", "url": "https://github.com/MegaMek/megamek/commit/37129054a19291717abe0a5fc0899ceb2beb9cc2", "message": "VTOL pathfinding and movement corrections", "committedDate": "2020-10-04T16:57:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI3MzYyMQ==", "url": "https://github.com/MegaMek/megamek/pull/2298#discussion_r499273621", "bodyText": "If this takes into account height() being one less, as below, can you include that note here too?", "author": "sixlettervariables", "createdAt": "2020-10-04T18:15:54Z", "path": "megamek/src/megamek/common/Entity.java", "diffHunk": "@@ -2233,6 +2241,11 @@ public boolean canGoUp(int assumedElevation, Coords assumedPos) {\n                 break;\n             case VTOL:\n                 maxAlt = hex.surface() + 50;\n+                // When under a bridge, restrict upward movement\n+                if (hex.containsTerrain(Terrains.BRIDGE_ELEV)\n+                        && assumedElevation < hex.terrainLevel(Terrains.BRIDGE_ELEV)) {\n+                    maxAlt = hex.terrainLevel(Terrains.BRIDGE_ELEV) - height() - 1;   ", "originalCommit": "37129054a19291717abe0a5fc0899ceb2beb9cc2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI4ODI3NQ==", "url": "https://github.com/MegaMek/megamek/pull/2298#discussion_r499288275", "bodyText": "Done.", "author": "SJuliez", "createdAt": "2020-10-04T20:59:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI3MzYyMQ=="}], "type": "inlineReview", "revised_code": {"commit": "4dbd21daf01a7687e470eea91c06379aada8eee9", "chunk": "diff --git a/megamek/src/megamek/common/Entity.java b/megamek/src/megamek/common/Entity.java\nindex 1a45a484ff..caca6db311 100644\n--- a/megamek/src/megamek/common/Entity.java\n+++ b/megamek/src/megamek/common/Entity.java\n\n@@ -2242,6 +2242,7 @@ public abstract class Entity extends TurnOrdered implements Transporter,\n             case VTOL:\n                 maxAlt = hex.surface() + 50;\n                 // When under a bridge, restrict upward movement\n+                // \"- 1\" to correct that height() reports one less than the rules (TW p.99) say\n                 if (hex.containsTerrain(Terrains.BRIDGE_ELEV)\n                         && assumedElevation < hex.terrainLevel(Terrains.BRIDGE_ELEV)) {\n                     maxAlt = hex.terrainLevel(Terrains.BRIDGE_ELEV) - height() - 1;   \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI3MzY3Mw==", "url": "https://github.com/MegaMek/megamek/pull/2298#discussion_r499273673", "bodyText": "Is <= proper for \"under\" a bridge?", "author": "sixlettervariables", "createdAt": "2020-10-04T18:16:18Z", "path": "megamek/src/megamek/common/Entity.java", "diffHunk": "@@ -2287,23 +2300,34 @@ public boolean isElevationValid(int assumedElevation, IHex hex) {\n         int assumedAlt = assumedElevation + hex.surface();\n         if (getMovementMode() == EntityMovementMode.VTOL) {\n             if ((this instanceof Infantry)\n-                && (hex.containsTerrain(Terrains.BUILDING)\n-                    || hex.containsTerrain(Terrains.WOODS) || hex\n-                    .containsTerrain(Terrains.JUNGLE))) {\n+                    && (hex.containsTerrain(Terrains.BUILDING)\n+                            || hex.containsTerrain(Terrains.WOODS) \n+                            || hex.containsTerrain(Terrains.JUNGLE))) {\n                 // VTOL BA (sylph) can move as ground unit as well\n                 return ((assumedElevation <= 50) && (assumedAlt >= hex.floor()));\n-            } else if (hex.containsTerrain(Terrains.BRIDGE_ELEV)) {\n-                // fly under a bridge as long as there is enough clearance below and above the unit\n-                return (assumedElevation <= 50)\n-                        && assumedElevation > hex.floor()\n-                        && (assumedElevation > hex.terrainLevel(Terrains.BRIDGE_ELEV)\n-                                || assumedElevation + height() < hex.terrainLevel(Terrains.BRIDGE_ELEV) - 1);\n-            } else if (hex.containsTerrain(Terrains.WOODS)\n-                       || hex.containsTerrain(Terrains.WATER)\n-                       || hex.containsTerrain(Terrains.JUNGLE)) {\n-                return ((assumedElevation <= 50) && (assumedAlt > hex.ceiling()));\n-            }\n-            return ((assumedElevation <= 50) && (assumedAlt >= hex.ceiling()));\n+            } else {\n+                // VTOLs can be anywhere on or above ground and fly beneath bridges,\n+                // land on buildings and ignore planted fields and industrial zone \n+                // but cannot land on water or trees\n+                // As always, height() reports one less than the rules (TW p.99) say\n+                // Units may move under a bridge if their top is \n+                // lower than or equal to the bridge height (TW p.62)\n+                boolean allowed = (assumedElevation <= 50) && (assumedElevation >= 0);\n+                if (hex.containsTerrain(Terrains.BRIDGE_ELEV)) {\n+                    allowed &= (assumedElevation >= hex.terrainLevel(Terrains.BRIDGE_ELEV))\n+                            || (assumedElevation + height() + 1 <= hex.terrainLevel(Terrains.BRIDGE_ELEV));", "originalCommit": "37129054a19291717abe0a5fc0899ceb2beb9cc2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI4MzcxOQ==", "url": "https://github.com/MegaMek/megamek/pull/2298#discussion_r499283719", "bodyText": "TW says a unit may move under a bridge so long as the height of the unit is less than or equal to the bridge level. I.E. a mech fits under a level 2 bridge. A heli, elevation 1 and height 1 (0 in MM for whatever reason), should also fit under a bridge. I think (hope) this one is correct.", "author": "SJuliez", "createdAt": "2020-10-04T20:06:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI3MzY3Mw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI3MzczNw==", "url": "https://github.com/MegaMek/megamek/pull/2298#discussion_r499273737", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (!(source.getEntity().getMovementMode() == EntityMovementMode.VTOL)) {\n          \n          \n            \n                    if (source.getEntity().getMovementMode() != EntityMovementMode.VTOL) {", "author": "sixlettervariables", "createdAt": "2020-10-04T18:17:09Z", "path": "megamek/src/megamek/common/pathfinder/PathDecorator.java", "diffHunk": "@@ -160,37 +162,58 @@\n     }\n     \n     /**\n-     * Given a path, adds \"UP\" steps to it so that a forward movement can pass over intervening terrain\n+     * For units using VTOL movement, add \"UP\" steps to the end of the MovePath source \n+     * so that a forward movement can pass over intervening terrain\n      */\n     public static void AdjustElevationForForwardMovement(MovePath source) {\n+        // Do this only for VTOLs\n+        if (!(source.getEntity().getMovementMode() == EntityMovementMode.VTOL)) {", "originalCommit": "37129054a19291717abe0a5fc0899ceb2beb9cc2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4dbd21daf01a7687e470eea91c06379aada8eee9", "chunk": "diff --git a/megamek/src/megamek/common/pathfinder/PathDecorator.java b/megamek/src/megamek/common/pathfinder/PathDecorator.java\nindex 7a7f060212..0d64b9bcbd 100644\n--- a/megamek/src/megamek/common/pathfinder/PathDecorator.java\n+++ b/megamek/src/megamek/common/pathfinder/PathDecorator.java\n\n@@ -167,7 +167,7 @@ public class PathDecorator {\n      */\n     public static void AdjustElevationForForwardMovement(MovePath source) {\n         // Do this only for VTOLs\n-        if (!(source.getEntity().getMovementMode() == EntityMovementMode.VTOL)) {\n+        if (source.getEntity().getMovementMode() != EntityMovementMode.VTOL) {\n             return;\n         }\n         \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI3NDc4OA==", "url": "https://github.com/MegaMek/megamek/pull/2298#discussion_r499274788", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    } else if (type == Terrains.BLDG_ELEV && level < 1) {\n          \n          \n            \n                        rv = false;\n          \n          \n            \n                    } else if (type == Terrains.BRIDGE_ELEV && level < 0) {\n          \n          \n            \n                    } else if ((type == Terrains.BLDG_ELEV) && (level < 1)) {\n          \n          \n            \n                        rv = false;\n          \n          \n            \n                    } else if ((type == Terrains.BRIDGE_ELEV) && (level < 0)) {", "author": "Windchild292", "createdAt": "2020-10-04T18:28:36Z", "path": "megamek/src/megamek/common/Terrain.java", "diffHunk": "@@ -637,6 +637,10 @@ public boolean isValid(StringBuffer errBuff) {\n             rv = false;\n         } else if (type == Terrains.FOLIAGE_ELEV && (level < 1 || level > 3)) {\n             rv = false;\n+        } else if (type == Terrains.BLDG_ELEV && level < 1) {\n+            rv = false;\n+        } else if (type == Terrains.BRIDGE_ELEV && level < 0) {", "originalCommit": "37129054a19291717abe0a5fc0899ceb2beb9cc2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4dbd21daf01a7687e470eea91c06379aada8eee9", "chunk": "diff --git a/megamek/src/megamek/common/Terrain.java b/megamek/src/megamek/common/Terrain.java\nindex 9baa732624..b3dfb1d62d 100644\n--- a/megamek/src/megamek/common/Terrain.java\n+++ b/megamek/src/megamek/common/Terrain.java\n\n@@ -637,9 +637,9 @@ public class Terrain implements ITerrain, Serializable {\n             rv = false;\n         } else if (type == Terrains.FOLIAGE_ELEV && (level < 1 || level > 3)) {\n             rv = false;\n-        } else if (type == Terrains.BLDG_ELEV && level < 1) {\n+        } else if ((type == Terrains.BLDG_ELEV) && (level < 1)) {\n             rv = false;\n-        } else if (type == Terrains.BRIDGE_ELEV && level < 0) {\n+        } else if ((type == Terrains.BRIDGE_ELEV) && (level < 0)) {\n             rv = false;\n         }\n \n"}}, {"oid": "4dbd21daf01a7687e470eea91c06379aada8eee9", "url": "https://github.com/MegaMek/megamek/commit/4dbd21daf01a7687e470eea91c06379aada8eee9", "message": "Review Suggestions", "committedDate": "2020-10-04T20:12:04Z", "type": "commit"}]}