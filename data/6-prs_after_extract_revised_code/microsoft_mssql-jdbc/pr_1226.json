{"pr_number": 1226, "pr_title": "Fixed errors identified by Semmle", "pr_createdAt": "2020-01-03T23:57:11Z", "pr_url": "https://github.com/microsoft/mssql-jdbc/pull/1226", "timeline": [{"oid": "c780ced5bf5471b15e2d395d000c3634d299c263", "url": "https://github.com/microsoft/mssql-jdbc/commit/c780ced5bf5471b15e2d395d000c3634d299c263", "message": "fixes from Semmle scan", "committedDate": "2020-01-03T22:43:50Z", "type": "commit"}, {"oid": "e5baa6365bb9b92a5406be9c495ab8a06c604c1e", "url": "https://github.com/microsoft/mssql-jdbc/commit/e5baa6365bb9b92a5406be9c495ab8a06c604c1e", "message": "fixes from Semmle scan", "committedDate": "2020-01-03T23:48:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDAwNzA1Nw==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1226#discussion_r364007057", "bodyText": "I don't really think this is a relevant check, but a better way would be to catch the array index out of bounds exception and rethrow.", "author": "rene-ye", "createdAt": "2020-01-07T23:50:11Z", "path": "src/main/java/com/microsoft/sqlserver/jdbc/IOBuffer.java", "diffHunk": "@@ -3776,7 +3776,14 @@ void writeString(String value) throws SQLServerException {\n             while (bytesCopied < bytesToCopy) {\n                 char ch = value.charAt(charsCopied++);\n                 valueBytes[bytesCopied++] = (byte) ((ch >> 0) & 0xFF);\n-                valueBytes[bytesCopied++] = (byte) ((ch >> 8) & 0xFF);\n+\n+                if (bytesCopied > bytesToCopy) {\n+                    MessageFormat form = new MessageFormat(SQLServerException.getErrString(\"R_indexOutOfRange\"));\n+                    Object[] msgArgs = {bytesCopied};\n+                    error(form.format(msgArgs), SQLState.DATA_EXCEPTION_NOT_SPECIFIC, DriverError.NOT_SET);\n+                }\n+                valueBytes[bytesCopied] = (byte) ((ch >> 8) & 0xFF);\n+                bytesCopied++;", "originalCommit": "e5baa6365bb9b92a5406be9c495ab8a06c604c1e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDAyNTA5MA==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1226#discussion_r364025090", "bodyText": "I did this cos adding a try doesn't fix the error for Semmle. It's stupid. Ok I changed it", "author": "lilgreenbird", "createdAt": "2020-01-08T01:07:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDAwNzA1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "9e1645412504a492514126f4b5faee8ee5f714d8", "chunk": "diff --git a/src/main/java/com/microsoft/sqlserver/jdbc/IOBuffer.java b/src/main/java/com/microsoft/sqlserver/jdbc/IOBuffer.java\nindex c878dc9a..cce80fd2 100644\n--- a/src/main/java/com/microsoft/sqlserver/jdbc/IOBuffer.java\n+++ b/src/main/java/com/microsoft/sqlserver/jdbc/IOBuffer.java\n\n@@ -3773,20 +3773,19 @@ final class TDSWriter {\n                 bytesToCopy = valueBytes.length;\n \n             int bytesCopied = 0;\n-            while (bytesCopied < bytesToCopy) {\n-                char ch = value.charAt(charsCopied++);\n-                valueBytes[bytesCopied++] = (byte) ((ch >> 0) & 0xFF);\n-\n-                if (bytesCopied > bytesToCopy) {\n-                    MessageFormat form = new MessageFormat(SQLServerException.getErrString(\"R_indexOutOfRange\"));\n-                    Object[] msgArgs = {bytesCopied};\n-                    error(form.format(msgArgs), SQLState.DATA_EXCEPTION_NOT_SPECIFIC, DriverError.NOT_SET);\n+            try {\n+                while (bytesCopied < bytesToCopy) {\n+                    char ch = value.charAt(charsCopied++);\n+                    valueBytes[bytesCopied++] = (byte) ((ch >> 0) & 0xFF);\n+                    valueBytes[bytesCopied++] = (byte) ((ch >> 8) & 0xFF);\n                 }\n-                valueBytes[bytesCopied] = (byte) ((ch >> 8) & 0xFF);\n-                bytesCopied++;\n-            }\n \n-            writeBytes(valueBytes, 0, bytesCopied);\n+                writeBytes(valueBytes, 0, bytesCopied);\n+            } catch (ArrayIndexOutOfBoundsException e) {\n+                MessageFormat form = new MessageFormat(SQLServerException.getErrString(\"R_indexOutOfRange\"));\n+                Object[] msgArgs = {bytesCopied};\n+                error(form.format(msgArgs), SQLState.DATA_EXCEPTION_NOT_SPECIFIC, DriverError.NOT_SET);\n+            }\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDAxNDg1NA==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1226#discussion_r364014854", "bodyText": "Same here, if we're really worried this may cause an out of index access then we can catch and rethrow it.", "author": "rene-ye", "createdAt": "2020-01-08T00:22:34Z", "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerXAResource.java", "diffHunk": "@@ -845,8 +845,19 @@ public void forget(Xid xid) throws XAException {\n                 power = power * 256;\n             }\n             offset += 4;\n-            int gid_len = (r.bData[offset++] & 0x00FF);\n-            int bid_len = (r.bData[offset++] & 0x00FF);\n+            int gid_len = (r.bData[offset] & 0x00FF);\n+            if (offset++ > r.bData.length) {\n+                MessageFormat form = new MessageFormat(SQLServerException.getErrString(\"R_indexOutOfRange\"));\n+                Object[] msgArgs = {offset};\n+                XAException xex = new XAException(form.format(msgArgs));\n+                xex.errorCode = XAException.XAER_RMERR;\n+                if (xaLogger.isLoggable(Level.FINER))\n+                    xaLogger.finer(toString() + \" exception:\" + xex);\n+                throw xex;\n+            }\n+            int bid_len = (r.bData[offset] & 0x00FF);\n+            offset++;", "originalCommit": "e5baa6365bb9b92a5406be9c495ab8a06c604c1e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDAyNTEwMw==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1226#discussion_r364025103", "bodyText": "I did this cos adding a try doesn't fix the error for Semmle. It's stupid. Ok I changed it", "author": "lilgreenbird", "createdAt": "2020-01-08T01:07:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDAxNDg1NA=="}], "type": "inlineReview", "revised_code": {"commit": "9e1645412504a492514126f4b5faee8ee5f714d8", "chunk": "diff --git a/src/main/java/com/microsoft/sqlserver/jdbc/SQLServerXAResource.java b/src/main/java/com/microsoft/sqlserver/jdbc/SQLServerXAResource.java\nindex 9284025c..a3de4ad9 100644\n--- a/src/main/java/com/microsoft/sqlserver/jdbc/SQLServerXAResource.java\n+++ b/src/main/java/com/microsoft/sqlserver/jdbc/SQLServerXAResource.java\n\n@@ -844,9 +844,20 @@ public final class SQLServerXAResource implements javax.transaction.xa.XAResourc\n                 formatId += x;\n                 power = power * 256;\n             }\n-            offset += 4;\n-            int gid_len = (r.bData[offset] & 0x00FF);\n-            if (offset++ > r.bData.length) {\n+\n+            try {\n+                offset += 4;\n+                int gid_len = (r.bData[offset++] & 0x00FF);\n+                int bid_len = (r.bData[offset++] & 0x00FF);\n+                byte gid[] = new byte[gid_len];\n+                byte bid[] = new byte[bid_len];\n+                System.arraycopy(r.bData, offset, gid, 0, gid_len);\n+                offset += gid_len;\n+                System.arraycopy(r.bData, offset, bid, 0, bid_len);\n+                offset += bid_len;\n+                XidImpl xid = new XidImpl(formatId, gid, bid);\n+                al.add(xid);\n+            } catch (ArrayIndexOutOfBoundsException e) {\n                 MessageFormat form = new MessageFormat(SQLServerException.getErrString(\"R_indexOutOfRange\"));\n                 Object[] msgArgs = {offset};\n                 XAException xex = new XAException(form.format(msgArgs));\n"}}, {"oid": "9e1645412504a492514126f4b5faee8ee5f714d8", "url": "https://github.com/microsoft/mssql-jdbc/commit/9e1645412504a492514126f4b5faee8ee5f714d8", "message": "review updates", "committedDate": "2020-01-08T01:08:29Z", "type": "commit"}]}