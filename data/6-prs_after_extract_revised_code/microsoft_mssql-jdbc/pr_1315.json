{"pr_number": 1315, "pr_title": "Fix | Close resources and skip AE tests by default", "pr_createdAt": "2020-04-16T20:10:08Z", "pr_url": "https://github.com/microsoft/mssql-jdbc/pull/1315", "timeline": [{"oid": "3397aac557edc17f05f8dd48e8be2be1fca62f80", "url": "https://github.com/microsoft/mssql-jdbc/commit/3397aac557edc17f05f8dd48e8be2be1fca62f80", "message": "Closable resource fixes", "committedDate": "2020-04-16T20:08:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE3NDMzOQ==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1315#discussion_r413174339", "bodyText": "Can't you put this into try with resources?", "author": "ulvii", "createdAt": "2020-04-22T17:26:10Z", "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerCertificateUtils.java", "diffHunk": "@@ -81,10 +81,15 @@\n     private static KeyManager[] readPKCS12Certificate(String certPath,\r\n             String keyPassword) throws NoSuchAlgorithmException, CertificateException, FileNotFoundException, IOException, UnrecoverableKeyException, KeyStoreException, SQLServerException {\r\n         KeyStore keystore = KeyStore.getInstance(PKCS12_ALG);\r\n+        FileInputStream certStream = null;\r\n         try {\r\n-            keystore.load(new FileInputStream(certPath), keyPassword.toCharArray());\r\n+            certStream = new FileInputStream(certPath);\r\n+            keystore.load(certStream, keyPassword.toCharArray());\r\n         } catch (FileNotFoundException e) {\r\n             throw new SQLServerException(SQLServerException.getErrString(\"R_clientCertError\"), null, 0, null);\r\n+        } finally {\r", "originalCommit": "3397aac557edc17f05f8dd48e8be2be1fca62f80", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "16171d8af739c987a5fc5320fbad15b54833f803", "chunk": "diff --git a/src/main/java/com/microsoft/sqlserver/jdbc/SQLServerCertificateUtils.java b/src/main/java/com/microsoft/sqlserver/jdbc/SQLServerCertificateUtils.java\nindex 89515e23..267f984b 100644\n--- a/src/main/java/com/microsoft/sqlserver/jdbc/SQLServerCertificateUtils.java\n+++ b/src/main/java/com/microsoft/sqlserver/jdbc/SQLServerCertificateUtils.java\n\n@@ -81,15 +81,10 @@ final class SQLServerCertificateUtils {\n     private static KeyManager[] readPKCS12Certificate(String certPath,\n             String keyPassword) throws NoSuchAlgorithmException, CertificateException, FileNotFoundException, IOException, UnrecoverableKeyException, KeyStoreException, SQLServerException {\n         KeyStore keystore = KeyStore.getInstance(PKCS12_ALG);\n-        FileInputStream certStream = null;\n-        try {\n-            certStream = new FileInputStream(certPath);\n+        try (FileInputStream certStream = new FileInputStream(certPath)) {\n             keystore.load(certStream, keyPassword.toCharArray());\n         } catch (FileNotFoundException e) {\n             throw new SQLServerException(SQLServerException.getErrString(\"R_clientCertError\"), null, 0, null);\n-        } finally {\n-            if (null != certStream)\n-                certStream.close();\n         }\n         KeyManagerFactory keyManagerFactory = KeyManagerFactory.getInstance(SUN_X_509);\n         keyManagerFactory.init(keystore, keyPassword.toCharArray());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzMyNzc0Nw==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1315#discussion_r413327747", "bodyText": "This line is already covered in PR 1313, you should remove this in one of them (probably in the other one)", "author": "peterbae", "createdAt": "2020-04-22T20:57:53Z", "path": "src/test/java/com/microsoft/sqlserver/jdbc/clientcertauth/ClientCertificateAuthenticationTest.java", "diffHunk": "@@ -2,7 +2,7 @@\n  * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\r\n  * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\r\n  */\r\n-package com.microsoft.sqlserver.clientcertauth;\r\n+package com.microsoft.sqlserver.jdbc.clientcertauth;\r", "originalCommit": "3397aac557edc17f05f8dd48e8be2be1fca62f80", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "16171d8af739c987a5fc5320fbad15b54833f803", "chunk": "diff --git a/src/test/java/com/microsoft/sqlserver/jdbc/clientcertauth/ClientCertificateAuthenticationTest.java b/src/test/java/com/microsoft/sqlserver/clientcertauth/ClientCertificateAuthenticationTest.java\nsimilarity index 96%\nrename from src/test/java/com/microsoft/sqlserver/jdbc/clientcertauth/ClientCertificateAuthenticationTest.java\nrename to src/test/java/com/microsoft/sqlserver/clientcertauth/ClientCertificateAuthenticationTest.java\nindex f4df5482..acf746d0 100644\n--- a/src/test/java/com/microsoft/sqlserver/jdbc/clientcertauth/ClientCertificateAuthenticationTest.java\n+++ b/src/test/java/com/microsoft/sqlserver/clientcertauth/ClientCertificateAuthenticationTest.java\n\n@@ -2,7 +2,7 @@\n  * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\n  * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\n  */\n-package com.microsoft.sqlserver.jdbc.clientcertauth;\n+package com.microsoft.sqlserver.clientcertauth;\n \n import static org.junit.Assert.assertTrue;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQwODEzNg==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1315#discussion_r413408136", "bodyText": "can use try with resource here too", "author": "lilgreenbird", "createdAt": "2020-04-22T23:46:54Z", "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerCertificateUtils.java", "diffHunk": "@@ -277,7 +287,7 @@ private static InputStream fileToStream(String fname) throws IOException, SQLSer\n             dis.readFully(bytes);\r\n             ByteArrayInputStream bais = new ByteArrayInputStream(bytes);\r\n             return bais;\r\n-        } catch (FileNotFoundException e) { \r\n+        } catch (FileNotFoundException e) {\r\n             throw new SQLServerException(SQLServerException.getErrString(\"R_clientCertError\"), null, 0, null);\r\n         } finally {\r\n             if (null != dis) {\r", "originalCommit": "3397aac557edc17f05f8dd48e8be2be1fca62f80", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "16171d8af739c987a5fc5320fbad15b54833f803", "chunk": "diff --git a/src/main/java/com/microsoft/sqlserver/jdbc/SQLServerCertificateUtils.java b/src/main/java/com/microsoft/sqlserver/jdbc/SQLServerCertificateUtils.java\nindex 89515e23..267f984b 100644\n--- a/src/main/java/com/microsoft/sqlserver/jdbc/SQLServerCertificateUtils.java\n+++ b/src/main/java/com/microsoft/sqlserver/jdbc/SQLServerCertificateUtils.java\n\n@@ -278,24 +273,12 @@ final class SQLServerCertificateUtils {\n     }\n \n     private static InputStream fileToStream(String fname) throws IOException, SQLServerException {\n-        FileInputStream fis = null;\n-        DataInputStream dis = null;\n-        try {\n-            fis = new FileInputStream(fname);\n-            dis = new DataInputStream(fis);\n+        try (FileInputStream fis = new FileInputStream(fname); DataInputStream dis = new DataInputStream(fis)) {\n             byte[] bytes = new byte[dis.available()];\n             dis.readFully(bytes);\n-            ByteArrayInputStream bais = new ByteArrayInputStream(bytes);\n-            return bais;\n+            return new ByteArrayInputStream(bytes);\n         } catch (FileNotFoundException e) {\n             throw new SQLServerException(SQLServerException.getErrString(\"R_clientCertError\"), null, 0, null);\n-        } finally {\n-            if (null != dis) {\n-                dis.close();\n-            }\n-            if (null != fis) {\n-                fis.close();\n-            }\n         }\n     }\n \n"}}, {"oid": "16171d8af739c987a5fc5320fbad15b54833f803", "url": "https://github.com/microsoft/mssql-jdbc/commit/16171d8af739c987a5fc5320fbad15b54833f803", "message": "address comments", "committedDate": "2020-04-23T16:23:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAwOTQ5Mw==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1315#discussion_r414009493", "bodyText": "use the autocloseable syntax for InputStream here instead of manually calling certStream.close()?", "author": "peterbae", "createdAt": "2020-04-23T18:01:45Z", "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerCertificateUtils.java", "diffHunk": "@@ -203,10 +203,15 @@ private static PrivateKey loadPrivateKeyFromPVK(String keyPath,\n         }\r\n     }\r\n \r\n-    private static Certificate loadCertificate(String certificatePem) throws IOException, GeneralSecurityException, SQLServerException {\r\n+    private static Certificate loadCertificate(\r\n+            String certificatePem) throws IOException, GeneralSecurityException, SQLServerException {\r\n         CertificateFactory certificateFactory = CertificateFactory.getInstance(\"X509\");\r\n-        InputStream certstream = fileToStream(certificatePem);\r\n-        return certificateFactory.generateCertificate(certstream);\r\n+        InputStream certStream = fileToStream(certificatePem);\r", "originalCommit": "16171d8af739c987a5fc5320fbad15b54833f803", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d9674304fca6d2b130617341e2a908ff8faaa845", "chunk": "diff --git a/src/main/java/com/microsoft/sqlserver/jdbc/SQLServerCertificateUtils.java b/src/main/java/com/microsoft/sqlserver/jdbc/SQLServerCertificateUtils.java\nindex 267f984b..94b9cb99 100644\n--- a/src/main/java/com/microsoft/sqlserver/jdbc/SQLServerCertificateUtils.java\n+++ b/src/main/java/com/microsoft/sqlserver/jdbc/SQLServerCertificateUtils.java\n\n@@ -206,11 +206,8 @@ final class SQLServerCertificateUtils {\n     private static Certificate loadCertificate(\n             String certificatePem) throws IOException, GeneralSecurityException, SQLServerException {\n         CertificateFactory certificateFactory = CertificateFactory.getInstance(\"X509\");\n-        InputStream certStream = fileToStream(certificatePem);\n-        try {\n+        try (InputStream certStream = fileToStream(certificatePem)) {\n             return certificateFactory.generateCertificate(certStream);\n-        } finally {\n-            certStream.close();\n         }\n     }\n \n"}}, {"oid": "d9674304fca6d2b130617341e2a908ff8faaa845", "url": "https://github.com/microsoft/mssql-jdbc/commit/d9674304fca6d2b130617341e2a908ff8faaa845", "message": "comments", "committedDate": "2020-04-23T18:53:35Z", "type": "commit"}]}