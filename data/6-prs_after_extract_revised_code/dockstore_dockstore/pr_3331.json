{"pr_number": 3331, "pr_title": "Feature/3328/delete gh app workflow branch", "pr_createdAt": "2020-03-18T18:59:34Z", "pr_url": "https://github.com/dockstore/dockstore/pull/3331", "timeline": [{"oid": "ad9561a9f97cb83693b3550f0c1c974e3973b87c", "url": "https://github.com/dockstore/dockstore/commit/ad9561a9f97cb83693b3550f0c1c974e3973b87c", "message": "added endpoint for deleting branches when they are deleted on github", "committedDate": "2020-03-18T15:14:13Z", "type": "commit"}, {"oid": "047a69bd6a0455375f3f039673c1316f19225b5e", "url": "https://github.com/dockstore/dockstore/commit/047a69bd6a0455375f3f039673c1316f19225b5e", "message": "test for deleting branches", "committedDate": "2020-03-18T16:27:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU3NTg1Mg==", "url": "https://github.com/dockstore/dockstore/pull/3331#discussion_r394575852", "bodyText": "We have a constant for \"bearer\" now.\nI think HttpStatus + \"\" is preferred over \"418\"", "author": "garyluu", "createdAt": "2020-03-18T19:03:18Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java", "diffHunk": "@@ -1838,4 +1838,19 @@ public void deleteWorkflow(@ApiParam(hidden = true) @Parameter(hidden = true, na\n         @ApiParam(value = \"GitHub installation ID\", required = true) @FormParam(\"installationId\") String installationId) {\n         return githubWebhookRelease(repository, username, gitReference, installationId);\n     }\n+\n+    @POST\n+    @Path(\"/github/delete\")\n+    @Timed\n+    @Consumes(MediaType.APPLICATION_FORM_URLENCODED)\n+    @UnitOfWork\n+    @RolesAllowed({ \"curator\", \"admin\" })\n+    @Operation(description = \"Handles the deletion of a branch on GitHub. Will delete all workflow versions that match.\", security = @SecurityRequirement(name = \"bearer\"), responses = @ApiResponse(responseCode = \"418\", description = \"This code tells AWS Lambda not to retry.\"))", "originalCommit": "047a69bd6a0455375f3f039673c1316f19225b5e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYxNDI4Ng==", "url": "https://github.com/dockstore/dockstore/pull/3331#discussion_r394614286", "bodyText": "It will only delete at most one workflow version per workflow, but it could do it for multiple workflows. Don't know if that's worth capturing, but I was initially confused as to how it could delete multiple versions when we just added a constraint that ensures only one version can exist.  I can't think of better way to phrase it off-hand. :(", "author": "coverbeck", "createdAt": "2020-03-18T20:17:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU3NTg1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTAxMjQ0Mg==", "url": "https://github.com/dockstore/dockstore/pull/3331#discussion_r395012442", "bodyText": "@garyluu I can't find 418 in HttpStatus.", "author": "agduncan94", "createdAt": "2020-03-19T13:10:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU3NTg1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTAzMDA3MA==", "url": "https://github.com/dockstore/dockstore/pull/3331#discussion_r395030070", "bodyText": "\ud83d\ude22   not even HttpServletResponse has it either", "author": "garyluu", "createdAt": "2020-03-19T13:37:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU3NTg1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTA2MjMyNg==", "url": "https://github.com/dockstore/dockstore/pull/3331#discussion_r395062326", "bodyText": "Was confused too, maybe the description should be longer.\nLike \"Handles the deletion of a branch on GitHub. Will delete all workflow versions that match in all workflows that share the same repository path prefix\" ? Or all workflows that are the same when ignoring workflow name?", "author": "denis-yuen", "createdAt": "2020-03-19T14:22:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU3NTg1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "70ee93ddbdddccf48bc5d23823606aa861541608", "chunk": "diff --git a/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java b/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java\nindex f9f69d6be..436548b3e 100644\n--- a/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java\n+++ b/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java\n\n@@ -1836,21 +1836,24 @@ public class WorkflowResource extends AbstractWorkflowResource<Workflow>\n         @ApiParam(value = \"Username of user on GitHub who triggered action\", required = true) @FormParam(\"username\") String username,\n         @ApiParam(value = \"Full git reference for a GitHub branch/tag. Ex. refs/heads/master or refs/tags/v1.0\", required = true) @FormParam(\"gitReference\") String gitReference,\n         @ApiParam(value = \"GitHub installation ID\", required = true) @FormParam(\"installationId\") String installationId) {\n+        LOG.info(\"Branch/tag \" + gitReference + \" pushed to \" + repository + \"(\" + username + \")\");\n         return githubWebhookRelease(repository, username, gitReference, installationId);\n     }\n \n-    @POST\n-    @Path(\"/github/delete\")\n+    @DELETE\n+    @Path(\"/github\")\n     @Timed\n     @Consumes(MediaType.APPLICATION_FORM_URLENCODED)\n     @UnitOfWork\n     @RolesAllowed({ \"curator\", \"admin\" })\n-    @Operation(description = \"Handles the deletion of a branch on GitHub. Will delete all workflow versions that match.\", security = @SecurityRequirement(name = \"bearer\"), responses = @ApiResponse(responseCode = \"418\", description = \"This code tells AWS Lambda not to retry.\"))\n-    @ApiOperation(value = \"Handles the deletion of a branch on GitHub. Will delete all workflow versions that match.\", authorizations = {\n-            @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, response = Workflow.class, responseContainer = \"List\")\n-    public List<Workflow> handleGitHubBranchDeletion(@ApiParam(hidden = true) @Parameter(hidden = true, name = \"user\", in = ParameterIn.HEADER) @Auth User user,\n-            @ApiParam(value = \"Repository path (ex. dockstore/dockstore-ui2)\", required = true) @FormParam(\"repository\") String repository,\n-            @ApiParam(value = \"Full git reference for a GitHub branch/tag. Ex. refs/heads/master or refs/tags/v1.0\", required = true) @FormParam(\"gitReference\") String gitReference) {\n-        return githubWebhookDelete(repository, gitReference);\n+    @Operation(description = \"Handles the deletion of a branch on GitHub. Will delete all workflow versions from all workflows that match.\", security = @SecurityRequirement(name = JWT_SECURITY_DEFINITION_NAME), responses = @ApiResponse(responseCode = \"418\", description = \"This code tells AWS Lambda not to retry.\"))\n+    @ApiOperation(value = \"Handles the deletion of a branch on GitHub. Will delete all workflow versions from all workflows that match.\", authorizations = {\n+            @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, response = Response.class)\n+    public Response handleGitHubBranchDeletion(@ApiParam(hidden = true) @Parameter(hidden = true, name = \"user\", in = ParameterIn.HEADER) @Auth User user,\n+            @ApiParam(value = \"Repository path (ex. dockstore/dockstore-ui2)\", required = true) @QueryParam(\"repository\") String repository,\n+            @ApiParam(value = \"Full git reference for a GitHub branch/tag. Ex. refs/heads/master or refs/tags/v1.0\", required = true) @QueryParam(\"gitReference\") String gitReference) {\n+        LOG.info(\"Branch/tag \" + gitReference + \" deleted from \" + repository);\n+        githubWebhookDelete(repository, gitReference);\n+        return Response.status(HttpStatus.SC_NO_CONTENT).build();\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU3ODkzMw==", "url": "https://github.com/dockstore/dockstore/pull/3331#discussion_r394578933", "bodyText": "could pass in mode too when finding by path", "author": "garyluu", "createdAt": "2020-03-18T19:09:10Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java", "diffHunk": "@@ -238,6 +242,24 @@ protected void updateDBWorkflowWithSourceControlWorkflow(Workflow workflow, Work\n         }\n     }\n \n+    /**\n+     * Handle webhooks from GitHub apps after branch deletion (redirected from AWS Lambda)\n+     * - Delete version for corresponding service and workflow\n+     * @param repository Repository path (ex. dockstore/dockstore-ui2)\n+     * @param gitReference Git reference from GitHub (ex. refs/tags/1.0)\n+     * @return List of updated workflows\n+     */\n+    protected List<Workflow> githubWebhookDelete(String repository, String gitReference) {\n+        // Retrieve name from gitReference\n+        Pair<String, String> referencePair = parseGitHubReference(gitReference);\n+\n+        // Find all workflows and services that are github apps and use the given repo\n+        List<Workflow> workflows = workflowDAO.findAllByPath(\"github.com/\" + repository, false).stream().filter(workflow -> Objects.equals(workflow.getMode(), DOCKSTORE_YML)).collect(", "originalCommit": "047a69bd6a0455375f3f039673c1316f19225b5e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTAyNTM4NQ==", "url": "https://github.com/dockstore/dockstore/pull/3331#discussion_r395025385", "bodyText": "Is there a findAllByPath function that has mode as a param?", "author": "agduncan94", "createdAt": "2020-03-19T13:30:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU3ODkzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTAyNjg2OQ==", "url": "https://github.com/dockstore/dockstore/pull/3331#discussion_r395026869", "bodyText": "no", "author": "garyluu", "createdAt": "2020-03-19T13:33:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU3ODkzMw=="}], "type": "inlineReview", "revised_code": {"commit": "70ee93ddbdddccf48bc5d23823606aa861541608", "chunk": "diff --git a/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java b/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java\nindex 6e59478b7..1cce2f96f 100644\n--- a/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java\n+++ b/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java\n\n@@ -251,12 +248,14 @@ public abstract class AbstractWorkflowResource<T extends Workflow> implements So\n      */\n     protected List<Workflow> githubWebhookDelete(String repository, String gitReference) {\n         // Retrieve name from gitReference\n-        Pair<String, String> referencePair = parseGitHubReference(gitReference);\n+        String gitReferenceName = GitHelper.parseGitHubReference(gitReference);\n \n         // Find all workflows and services that are github apps and use the given repo\n         List<Workflow> workflows = workflowDAO.findAllByPath(\"github.com/\" + repository, false).stream().filter(workflow -> Objects.equals(workflow.getMode(), DOCKSTORE_YML)).collect(\n                 Collectors.toList());\n-        workflows.forEach(workflow -> workflow.getWorkflowVersions().removeIf(workflowVersion -> Objects.equals(workflowVersion.getName(), referencePair.getRight())));\n+\n+        // Delete all non-frozen versions that have the same git reference name\n+        workflows.forEach(workflow -> workflow.getWorkflowVersions().removeIf(workflowVersion -> Objects.equals(workflowVersion.getName(), gitReferenceName) && !workflowVersion.isFrozen()));\n         return workflows;\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU5NzE5Mg==", "url": "https://github.com/dockstore/dockstore/pull/3331#discussion_r394597192", "bodyText": "If we're going more RESTful, the method should be a @DELETE, and the path should be a resource/noun (don't have the verb \"delete\"). But if you do that, I think you need to make the parameters be query parameters rather than form parameters; something like:\nDELETE /workflows/github?repository=<repo>&reference=<ref>\n\nIf you do that, then technically you're supposed to return the deleted entity(ies), not a list of the remaining entities. Or you can optionally return a 204 with no content.", "author": "coverbeck", "createdAt": "2020-03-18T19:44:31Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java", "diffHunk": "@@ -1838,4 +1838,19 @@ public void deleteWorkflow(@ApiParam(hidden = true) @Parameter(hidden = true, na\n         @ApiParam(value = \"GitHub installation ID\", required = true) @FormParam(\"installationId\") String installationId) {\n         return githubWebhookRelease(repository, username, gitReference, installationId);\n     }\n+\n+    @POST\n+    @Path(\"/github/delete\")", "originalCommit": "047a69bd6a0455375f3f039673c1316f19225b5e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTAyMjg4NQ==", "url": "https://github.com/dockstore/dockstore/pull/3331#discussion_r395022885", "bodyText": "Should I also change the endpoint for releases? Currently, it is POST /workflows/github/release. Does POST /workflows/github make more sense?", "author": "agduncan94", "createdAt": "2020-03-19T13:27:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU5NzE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE3MzMzMw==", "url": "https://github.com/dockstore/dockstore/pull/3331#discussion_r395173333", "bodyText": "On further reflection, I think repository and reference could just be path parameters instead of query parameters, although I'm not sure because the resource represented by this endpoint, a GitHub repo, is modifying a Dockstore workflow, which is a different resource. But maybe something like: /workflows/github/<repository>/<reference>. I don't know you could argue this stuff for days, so either way. That said, regardless of the path, I think it should be a DELETE.\nI think POST is fine for the other endpoint, as the creates/modifies.", "author": "coverbeck", "createdAt": "2020-03-19T16:51:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU5NzE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIyMDk0NQ==", "url": "https://github.com/dockstore/dockstore/pull/3331#discussion_r395220945", "bodyText": "Yeah the disconnect between resources made me a bit confused with how to name the path. I think I'll just use query params and the DELETE type.", "author": "agduncan94", "createdAt": "2020-03-19T18:04:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU5NzE5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "70ee93ddbdddccf48bc5d23823606aa861541608", "chunk": "diff --git a/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java b/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java\nindex f9f69d6be..436548b3e 100644\n--- a/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java\n+++ b/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java\n\n@@ -1836,21 +1836,24 @@ public class WorkflowResource extends AbstractWorkflowResource<Workflow>\n         @ApiParam(value = \"Username of user on GitHub who triggered action\", required = true) @FormParam(\"username\") String username,\n         @ApiParam(value = \"Full git reference for a GitHub branch/tag. Ex. refs/heads/master or refs/tags/v1.0\", required = true) @FormParam(\"gitReference\") String gitReference,\n         @ApiParam(value = \"GitHub installation ID\", required = true) @FormParam(\"installationId\") String installationId) {\n+        LOG.info(\"Branch/tag \" + gitReference + \" pushed to \" + repository + \"(\" + username + \")\");\n         return githubWebhookRelease(repository, username, gitReference, installationId);\n     }\n \n-    @POST\n-    @Path(\"/github/delete\")\n+    @DELETE\n+    @Path(\"/github\")\n     @Timed\n     @Consumes(MediaType.APPLICATION_FORM_URLENCODED)\n     @UnitOfWork\n     @RolesAllowed({ \"curator\", \"admin\" })\n-    @Operation(description = \"Handles the deletion of a branch on GitHub. Will delete all workflow versions that match.\", security = @SecurityRequirement(name = \"bearer\"), responses = @ApiResponse(responseCode = \"418\", description = \"This code tells AWS Lambda not to retry.\"))\n-    @ApiOperation(value = \"Handles the deletion of a branch on GitHub. Will delete all workflow versions that match.\", authorizations = {\n-            @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, response = Workflow.class, responseContainer = \"List\")\n-    public List<Workflow> handleGitHubBranchDeletion(@ApiParam(hidden = true) @Parameter(hidden = true, name = \"user\", in = ParameterIn.HEADER) @Auth User user,\n-            @ApiParam(value = \"Repository path (ex. dockstore/dockstore-ui2)\", required = true) @FormParam(\"repository\") String repository,\n-            @ApiParam(value = \"Full git reference for a GitHub branch/tag. Ex. refs/heads/master or refs/tags/v1.0\", required = true) @FormParam(\"gitReference\") String gitReference) {\n-        return githubWebhookDelete(repository, gitReference);\n+    @Operation(description = \"Handles the deletion of a branch on GitHub. Will delete all workflow versions from all workflows that match.\", security = @SecurityRequirement(name = JWT_SECURITY_DEFINITION_NAME), responses = @ApiResponse(responseCode = \"418\", description = \"This code tells AWS Lambda not to retry.\"))\n+    @ApiOperation(value = \"Handles the deletion of a branch on GitHub. Will delete all workflow versions from all workflows that match.\", authorizations = {\n+            @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, response = Response.class)\n+    public Response handleGitHubBranchDeletion(@ApiParam(hidden = true) @Parameter(hidden = true, name = \"user\", in = ParameterIn.HEADER) @Auth User user,\n+            @ApiParam(value = \"Repository path (ex. dockstore/dockstore-ui2)\", required = true) @QueryParam(\"repository\") String repository,\n+            @ApiParam(value = \"Full git reference for a GitHub branch/tag. Ex. refs/heads/master or refs/tags/v1.0\", required = true) @QueryParam(\"gitReference\") String gitReference) {\n+        LOG.info(\"Branch/tag \" + gitReference + \" deleted from \" + repository);\n+        githubWebhookDelete(repository, gitReference);\n+        return Response.status(HttpStatus.SC_NO_CONTENT).build();\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU5OTkwNA==", "url": "https://github.com/dockstore/dockstore/pull/3331#discussion_r394599904", "bodyText": "I'm sort of torn on this because Pairs do you make your life easier and I've used them. On the other hand, it makes the code hard to read up above on line 259 -- I have to look at this code to see what getRight() returns. If the types were different, e.g., String and Integer, then maybe... But I lean towards creating an inner class that makes it clear what is what.\nAlso, you never use the left part of the pair. Is that intentional or are you not checking for something? If you are never going to use it, then another option is just have this method return a String with the name.", "author": "coverbeck", "createdAt": "2020-03-18T19:49:33Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java", "diffHunk": "@@ -536,4 +558,24 @@ private String gitHubAppSetup(String installationId) {\n         }\n         return installationAccessToken;\n     }\n+\n+    /**\n+     * Parse git references (ex. refs/heads/feature/foobar) and returns a pair of the branch type and name\n+     * @param gitReference Git Reference of the form refs/tags/name or refs/heads/name\n+     * @return Pair of reference information\n+     */\n+    private Pair<String, String> parseGitHubReference(String gitReference) {", "originalCommit": "047a69bd6a0455375f3f039673c1316f19225b5e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDk5ODEwMg==", "url": "https://github.com/dockstore/dockstore/pull/3331#discussion_r394998102", "bodyText": "I have been making too many inner classes recently so wanted to reduce that, but ya I'll just edit it to only return the name. I was just returning both in case in the future someone needed both.", "author": "agduncan94", "createdAt": "2020-03-19T12:44:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU5OTkwNA=="}], "type": "inlineReview", "revised_code": {"commit": "70ee93ddbdddccf48bc5d23823606aa861541608", "chunk": "diff --git a/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java b/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java\nindex 6e59478b7..1cce2f96f 100644\n--- a/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java\n+++ b/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java\n\n@@ -558,24 +557,4 @@ public abstract class AbstractWorkflowResource<T extends Workflow> implements So\n         }\n         return installationAccessToken;\n     }\n-\n-    /**\n-     * Parse git references (ex. refs/heads/feature/foobar) and returns a pair of the branch type and name\n-     * @param gitReference Git Reference of the form refs/tags/name or refs/heads/name\n-     * @return Pair of reference information\n-     */\n-    private Pair<String, String> parseGitHubReference(String gitReference) {\n-        // Match the github reference (ex. refs/heads/feature/foobar or refs/tags/1.0)\n-        Pattern pattern = Pattern.compile(\"^refs/(tags|heads)/([a-zA-Z0-9]+([./_-]?[a-zA-Z0-9]+)*)$\");\n-        Matcher matcher = pattern.matcher(gitReference);\n-\n-        if (!matcher.find()) {\n-            String msg = \"Reference \" + gitReference + \" is not of the valid form\";\n-            LOG.error(msg);\n-            throw new CustomWebApplicationException(msg, LAMBDA_FAILURE);\n-        }\n-        String gitBranchType = matcher.group(1);\n-        String gitBranchName = matcher.group(2);\n-        return new MutablePair(gitBranchType, gitBranchName);\n-    }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYwMDc1Mg==", "url": "https://github.com/dockstore/dockstore/pull/3331#discussion_r394600752", "bodyText": "Even though the DB policies will catch it, I don't know if the whole transaction gets rolled back or it fails silently, so you should not try to delete frozen versions.", "author": "coverbeck", "createdAt": "2020-03-18T19:51:08Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java", "diffHunk": "@@ -238,6 +242,24 @@ protected void updateDBWorkflowWithSourceControlWorkflow(Workflow workflow, Work\n         }\n     }\n \n+    /**\n+     * Handle webhooks from GitHub apps after branch deletion (redirected from AWS Lambda)\n+     * - Delete version for corresponding service and workflow\n+     * @param repository Repository path (ex. dockstore/dockstore-ui2)\n+     * @param gitReference Git reference from GitHub (ex. refs/tags/1.0)\n+     * @return List of updated workflows\n+     */\n+    protected List<Workflow> githubWebhookDelete(String repository, String gitReference) {\n+        // Retrieve name from gitReference\n+        Pair<String, String> referencePair = parseGitHubReference(gitReference);\n+\n+        // Find all workflows and services that are github apps and use the given repo\n+        List<Workflow> workflows = workflowDAO.findAllByPath(\"github.com/\" + repository, false).stream().filter(workflow -> Objects.equals(workflow.getMode(), DOCKSTORE_YML)).collect(\n+                Collectors.toList());\n+        workflows.forEach(workflow -> workflow.getWorkflowVersions().removeIf(workflowVersion -> Objects.equals(workflowVersion.getName(), referencePair.getRight())));", "originalCommit": "047a69bd6a0455375f3f039673c1316f19225b5e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "70ee93ddbdddccf48bc5d23823606aa861541608", "chunk": "diff --git a/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java b/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java\nindex 6e59478b7..1cce2f96f 100644\n--- a/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java\n+++ b/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java\n\n@@ -251,12 +248,14 @@ public abstract class AbstractWorkflowResource<T extends Workflow> implements So\n      */\n     protected List<Workflow> githubWebhookDelete(String repository, String gitReference) {\n         // Retrieve name from gitReference\n-        Pair<String, String> referencePair = parseGitHubReference(gitReference);\n+        String gitReferenceName = GitHelper.parseGitHubReference(gitReference);\n \n         // Find all workflows and services that are github apps and use the given repo\n         List<Workflow> workflows = workflowDAO.findAllByPath(\"github.com/\" + repository, false).stream().filter(workflow -> Objects.equals(workflow.getMode(), DOCKSTORE_YML)).collect(\n                 Collectors.toList());\n-        workflows.forEach(workflow -> workflow.getWorkflowVersions().removeIf(workflowVersion -> Objects.equals(workflowVersion.getName(), referencePair.getRight())));\n+\n+        // Delete all non-frozen versions that have the same git reference name\n+        workflows.forEach(workflow -> workflow.getWorkflowVersions().removeIf(workflowVersion -> Objects.equals(workflowVersion.getName(), gitReferenceName) && !workflowVersion.isFrozen()));\n         return workflows;\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYwMzg4Mw==", "url": "https://github.com/dockstore/dockstore/pull/3331#discussion_r394603883", "bodyText": "It would be nice to have a unit test for this method -- regexes are hard to review.", "author": "coverbeck", "createdAt": "2020-03-18T19:57:13Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java", "diffHunk": "@@ -536,4 +558,24 @@ private String gitHubAppSetup(String installationId) {\n         }\n         return installationAccessToken;\n     }\n+\n+    /**\n+     * Parse git references (ex. refs/heads/feature/foobar) and returns a pair of the branch type and name\n+     * @param gitReference Git Reference of the form refs/tags/name or refs/heads/name\n+     * @return Pair of reference information\n+     */\n+    private Pair<String, String> parseGitHubReference(String gitReference) {", "originalCommit": "047a69bd6a0455375f3f039673c1316f19225b5e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "70ee93ddbdddccf48bc5d23823606aa861541608", "chunk": "diff --git a/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java b/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java\nindex 6e59478b7..1cce2f96f 100644\n--- a/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java\n+++ b/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java\n\n@@ -558,24 +557,4 @@ public abstract class AbstractWorkflowResource<T extends Workflow> implements So\n         }\n         return installationAccessToken;\n     }\n-\n-    /**\n-     * Parse git references (ex. refs/heads/feature/foobar) and returns a pair of the branch type and name\n-     * @param gitReference Git Reference of the form refs/tags/name or refs/heads/name\n-     * @return Pair of reference information\n-     */\n-    private Pair<String, String> parseGitHubReference(String gitReference) {\n-        // Match the github reference (ex. refs/heads/feature/foobar or refs/tags/1.0)\n-        Pattern pattern = Pattern.compile(\"^refs/(tags|heads)/([a-zA-Z0-9]+([./_-]?[a-zA-Z0-9]+)*)$\");\n-        Matcher matcher = pattern.matcher(gitReference);\n-\n-        if (!matcher.find()) {\n-            String msg = \"Reference \" + gitReference + \" is not of the valid form\";\n-            LOG.error(msg);\n-            throw new CustomWebApplicationException(msg, LAMBDA_FAILURE);\n-        }\n-        String gitBranchType = matcher.group(1);\n-        String gitBranchName = matcher.group(2);\n-        return new MutablePair(gitBranchType, gitBranchName);\n-    }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYwNTk3Nw==", "url": "https://github.com/dockstore/dockstore/pull/3331#discussion_r394605977", "bodyText": "This is going to be  the stringtags or heads isn't it? Shouldn't you convert this to a Version.ReferenceType?\nBut see my above comments -- you aren't actually using this. And if you do need to use it, then maybe a Pair<ReferenceType, String> is OK instead of creating a new class.", "author": "coverbeck", "createdAt": "2020-03-18T20:01:16Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java", "diffHunk": "@@ -536,4 +558,24 @@ private String gitHubAppSetup(String installationId) {\n         }\n         return installationAccessToken;\n     }\n+\n+    /**\n+     * Parse git references (ex. refs/heads/feature/foobar) and returns a pair of the branch type and name\n+     * @param gitReference Git Reference of the form refs/tags/name or refs/heads/name\n+     * @return Pair of reference information\n+     */\n+    private Pair<String, String> parseGitHubReference(String gitReference) {\n+        // Match the github reference (ex. refs/heads/feature/foobar or refs/tags/1.0)\n+        Pattern pattern = Pattern.compile(\"^refs/(tags|heads)/([a-zA-Z0-9]+([./_-]?[a-zA-Z0-9]+)*)$\");\n+        Matcher matcher = pattern.matcher(gitReference);\n+\n+        if (!matcher.find()) {\n+            String msg = \"Reference \" + gitReference + \" is not of the valid form\";\n+            LOG.error(msg);\n+            throw new CustomWebApplicationException(msg, LAMBDA_FAILURE);\n+        }\n+        String gitBranchType = matcher.group(1);", "originalCommit": "047a69bd6a0455375f3f039673c1316f19225b5e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTAzMDMxNw==", "url": "https://github.com/dockstore/dockstore/pull/3331#discussion_r395030317", "bodyText": "I agree, but decided to just change the function to return the git reference name.", "author": "agduncan94", "createdAt": "2020-03-19T13:38:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYwNTk3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "70ee93ddbdddccf48bc5d23823606aa861541608", "chunk": "diff --git a/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java b/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java\nindex 6e59478b7..1cce2f96f 100644\n--- a/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java\n+++ b/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java\n\n@@ -558,24 +557,4 @@ public abstract class AbstractWorkflowResource<T extends Workflow> implements So\n         }\n         return installationAccessToken;\n     }\n-\n-    /**\n-     * Parse git references (ex. refs/heads/feature/foobar) and returns a pair of the branch type and name\n-     * @param gitReference Git Reference of the form refs/tags/name or refs/heads/name\n-     * @return Pair of reference information\n-     */\n-    private Pair<String, String> parseGitHubReference(String gitReference) {\n-        // Match the github reference (ex. refs/heads/feature/foobar or refs/tags/1.0)\n-        Pattern pattern = Pattern.compile(\"^refs/(tags|heads)/([a-zA-Z0-9]+([./_-]?[a-zA-Z0-9]+)*)$\");\n-        Matcher matcher = pattern.matcher(gitReference);\n-\n-        if (!matcher.find()) {\n-            String msg = \"Reference \" + gitReference + \" is not of the valid form\";\n-            LOG.error(msg);\n-            throw new CustomWebApplicationException(msg, LAMBDA_FAILURE);\n-        }\n-        String gitBranchType = matcher.group(1);\n-        String gitBranchName = matcher.group(2);\n-        return new MutablePair(gitBranchType, gitBranchName);\n-    }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY0ODk3OQ==", "url": "https://github.com/dockstore/dockstore/pull/3331#discussion_r394648979", "bodyText": "Also, could you log the repository and gitReference? Tracking down what happened in prod with another issue is making me realize that logging this sort of data could end up being very useful.", "author": "coverbeck", "createdAt": "2020-03-18T21:26:05Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java", "diffHunk": "@@ -1838,4 +1838,19 @@ public void deleteWorkflow(@ApiParam(hidden = true) @Parameter(hidden = true, na\n         @ApiParam(value = \"GitHub installation ID\", required = true) @FormParam(\"installationId\") String installationId) {\n         return githubWebhookRelease(repository, username, gitReference, installationId);\n     }\n+\n+    @POST\n+    @Path(\"/github/delete\")\n+    @Timed\n+    @Consumes(MediaType.APPLICATION_FORM_URLENCODED)\n+    @UnitOfWork\n+    @RolesAllowed({ \"curator\", \"admin\" })\n+    @Operation(description = \"Handles the deletion of a branch on GitHub. Will delete all workflow versions that match.\", security = @SecurityRequirement(name = \"bearer\"), responses = @ApiResponse(responseCode = \"418\", description = \"This code tells AWS Lambda not to retry.\"))\n+    @ApiOperation(value = \"Handles the deletion of a branch on GitHub. Will delete all workflow versions that match.\", authorizations = {\n+            @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, response = Workflow.class, responseContainer = \"List\")\n+    public List<Workflow> handleGitHubBranchDeletion(@ApiParam(hidden = true) @Parameter(hidden = true, name = \"user\", in = ParameterIn.HEADER) @Auth User user,\n+            @ApiParam(value = \"Repository path (ex. dockstore/dockstore-ui2)\", required = true) @FormParam(\"repository\") String repository,\n+            @ApiParam(value = \"Full git reference for a GitHub branch/tag. Ex. refs/heads/master or refs/tags/v1.0\", required = true) @FormParam(\"gitReference\") String gitReference) {\n+        return githubWebhookDelete(repository, gitReference);", "originalCommit": "047a69bd6a0455375f3f039673c1316f19225b5e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "70ee93ddbdddccf48bc5d23823606aa861541608", "chunk": "diff --git a/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java b/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java\nindex f9f69d6be..436548b3e 100644\n--- a/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java\n+++ b/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java\n\n@@ -1836,21 +1836,24 @@ public class WorkflowResource extends AbstractWorkflowResource<Workflow>\n         @ApiParam(value = \"Username of user on GitHub who triggered action\", required = true) @FormParam(\"username\") String username,\n         @ApiParam(value = \"Full git reference for a GitHub branch/tag. Ex. refs/heads/master or refs/tags/v1.0\", required = true) @FormParam(\"gitReference\") String gitReference,\n         @ApiParam(value = \"GitHub installation ID\", required = true) @FormParam(\"installationId\") String installationId) {\n+        LOG.info(\"Branch/tag \" + gitReference + \" pushed to \" + repository + \"(\" + username + \")\");\n         return githubWebhookRelease(repository, username, gitReference, installationId);\n     }\n \n-    @POST\n-    @Path(\"/github/delete\")\n+    @DELETE\n+    @Path(\"/github\")\n     @Timed\n     @Consumes(MediaType.APPLICATION_FORM_URLENCODED)\n     @UnitOfWork\n     @RolesAllowed({ \"curator\", \"admin\" })\n-    @Operation(description = \"Handles the deletion of a branch on GitHub. Will delete all workflow versions that match.\", security = @SecurityRequirement(name = \"bearer\"), responses = @ApiResponse(responseCode = \"418\", description = \"This code tells AWS Lambda not to retry.\"))\n-    @ApiOperation(value = \"Handles the deletion of a branch on GitHub. Will delete all workflow versions that match.\", authorizations = {\n-            @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, response = Workflow.class, responseContainer = \"List\")\n-    public List<Workflow> handleGitHubBranchDeletion(@ApiParam(hidden = true) @Parameter(hidden = true, name = \"user\", in = ParameterIn.HEADER) @Auth User user,\n-            @ApiParam(value = \"Repository path (ex. dockstore/dockstore-ui2)\", required = true) @FormParam(\"repository\") String repository,\n-            @ApiParam(value = \"Full git reference for a GitHub branch/tag. Ex. refs/heads/master or refs/tags/v1.0\", required = true) @FormParam(\"gitReference\") String gitReference) {\n-        return githubWebhookDelete(repository, gitReference);\n+    @Operation(description = \"Handles the deletion of a branch on GitHub. Will delete all workflow versions from all workflows that match.\", security = @SecurityRequirement(name = JWT_SECURITY_DEFINITION_NAME), responses = @ApiResponse(responseCode = \"418\", description = \"This code tells AWS Lambda not to retry.\"))\n+    @ApiOperation(value = \"Handles the deletion of a branch on GitHub. Will delete all workflow versions from all workflows that match.\", authorizations = {\n+            @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, response = Response.class)\n+    public Response handleGitHubBranchDeletion(@ApiParam(hidden = true) @Parameter(hidden = true, name = \"user\", in = ParameterIn.HEADER) @Auth User user,\n+            @ApiParam(value = \"Repository path (ex. dockstore/dockstore-ui2)\", required = true) @QueryParam(\"repository\") String repository,\n+            @ApiParam(value = \"Full git reference for a GitHub branch/tag. Ex. refs/heads/master or refs/tags/v1.0\", required = true) @QueryParam(\"gitReference\") String gitReference) {\n+        LOG.info(\"Branch/tag \" + gitReference + \" deleted from \" + repository);\n+        githubWebhookDelete(repository, gitReference);\n+        return Response.status(HttpStatus.SC_NO_CONTENT).build();\n     }\n }\n"}}, {"oid": "70ee93ddbdddccf48bc5d23823606aa861541608", "url": "https://github.com/dockstore/dockstore/commit/70ee93ddbdddccf48bc5d23823606aa861541608", "message": "fixes from pr", "committedDate": "2020-03-19T14:43:05Z", "type": "commit"}, {"oid": "d264a95bdd77c604b08f80903224faa0fdbb799a", "url": "https://github.com/dockstore/dockstore/commit/d264a95bdd77c604b08f80903224faa0fdbb799a", "message": "fix security issue in swagger", "committedDate": "2020-03-19T15:53:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE1NDU3NA==", "url": "https://github.com/dockstore/dockstore/pull/3331#discussion_r395154574", "bodyText": "Oh crud, I missed this.  It's not JWT_SECURITY_DEFINITION_NAME , it's some other constant that has OPENAPI in its name.  For some reason our swagger is \"BEARER\" but our openapi is \"bearer\". So there's two constants", "author": "garyluu", "createdAt": "2020-03-19T16:24:28Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java", "diffHunk": "@@ -1828,29 +1828,32 @@ public void deleteWorkflow(@ApiParam(hidden = true) @Parameter(hidden = true, na\n     @Consumes(MediaType.APPLICATION_FORM_URLENCODED)\n     @UnitOfWork\n     @RolesAllowed({ \"curator\", \"admin\" })\n-    @Operation(description = \"Handle a release of a repository on GitHub. Will create a workflow/service and version when necessary.\", security = @SecurityRequirement(name = \"bearer\"), responses = @ApiResponse(responseCode = \"418\", description = \"This code tells AWS Lambda not to retry.\"))\n+    @Operation(description = \"Handle a release of a repository on GitHub. Will create a workflow/service and version when necessary.\", security = @SecurityRequirement(name = JWT_SECURITY_DEFINITION_NAME), responses = @ApiResponse(responseCode = \"418\", description = \"This code tells AWS Lambda not to retry.\"))", "originalCommit": "70ee93ddbdddccf48bc5d23823606aa861541608", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "319178e35f741aa4d9ec25214b01d7c27ad08b72", "chunk": "diff --git a/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java b/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java\nindex 436548b3e..1bb927a94 100644\n--- a/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java\n+++ b/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java\n\n@@ -1828,7 +1829,7 @@ public class WorkflowResource extends AbstractWorkflowResource<Workflow>\n     @Consumes(MediaType.APPLICATION_FORM_URLENCODED)\n     @UnitOfWork\n     @RolesAllowed({ \"curator\", \"admin\" })\n-    @Operation(description = \"Handle a release of a repository on GitHub. Will create a workflow/service and version when necessary.\", security = @SecurityRequirement(name = JWT_SECURITY_DEFINITION_NAME), responses = @ApiResponse(responseCode = \"418\", description = \"This code tells AWS Lambda not to retry.\"))\n+    @Operation(description = \"Handle a release of a repository on GitHub. Will create a workflow/service and version when necessary.\", security = @SecurityRequirement(name = OPENAPI_JWT_SECURITY_DEFINITION_NAME), responses = @ApiResponse(responseCode = \"418\", description = \"This code tells AWS Lambda not to retry.\"))\n     @ApiOperation(value = \"Handle a release of a repository on GitHub. Will create a workflow/service and version when necessary.\", authorizations = {\n         @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, response = Workflow.class, responseContainer = \"List\")\n     public List<Workflow> handleGitHubRelease(@ApiParam(hidden = true) @Parameter(hidden = true, name = \"user\", in = ParameterIn.HEADER) @Auth User user,\n"}}, {"oid": "319178e35f741aa4d9ec25214b01d7c27ad08b72", "url": "https://github.com/dockstore/dockstore/commit/319178e35f741aa4d9ec25214b01d7c27ad08b72", "message": "small pr changes", "committedDate": "2020-03-19T16:44:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg4OTQ0NQ==", "url": "https://github.com/dockstore/dockstore/pull/3331#discussion_r395889445", "bodyText": "I would have put this in a unit test in dockstore-webservice, e.g., in GitHelperTest.java, that way you can run test tests locally and more quickly.", "author": "coverbeck", "createdAt": "2020-03-20T21:05:39Z", "path": "dockstore-integration-testing/src/test/java/io/dockstore/client/cli/WorkflowIT.java", "diffHunk": "@@ -1761,6 +1763,53 @@ public void testWorkflowVersionAliasesAreReturned() throws ApiException {\n \n     }\n \n+    @Test\n+    public void testGitReferenceParsing() {", "originalCommit": "319178e35f741aa4d9ec25214b01d7c27ad08b72", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6c0546273b187058f821a898eedd46d82ae7764d", "chunk": "diff --git a/dockstore-integration-testing/src/test/java/io/dockstore/client/cli/WorkflowIT.java b/dockstore-integration-testing/src/test/java/io/dockstore/client/cli/WorkflowIT.java\nindex 14a4fd849..271cb9481 100644\n--- a/dockstore-integration-testing/src/test/java/io/dockstore/client/cli/WorkflowIT.java\n+++ b/dockstore-integration-testing/src/test/java/io/dockstore/client/cli/WorkflowIT.java\n\n@@ -1763,53 +1761,6 @@ public class WorkflowIT extends BaseIT {\n \n     }\n \n-    @Test\n-    public void testGitReferenceParsing() {\n-        String reference = GitHelper.parseGitHubReference(\"refs/heads/foobar\");\n-        assertEquals(\"foobar\", reference);\n-\n-        reference = GitHelper.parseGitHubReference(\"refs/heads/feature/foobar\");\n-        assertEquals(\"feature/foobar\", reference);\n-\n-        reference = GitHelper.parseGitHubReference(\"refs/tags/foobar\");\n-        assertEquals(\"foobar\", reference);\n-\n-        reference = GitHelper.parseGitHubReference(\"refs/tags/feature/foobar\");\n-        assertEquals(\"feature/foobar\", reference);\n-\n-        reference = GitHelper.parseGitHubReference(\"refs/heads/foo_bar\");\n-        assertEquals(\"foo_bar\", reference);\n-\n-        reference = GitHelper.parseGitHubReference(\"refs/tags/feature/foo-bar\");\n-        assertEquals(\"feature/foo-bar\", reference);\n-\n-        reference = GitHelper.parseGitHubReference(\"refs/tags/feature/foobar12\");\n-        assertEquals(\"feature/foobar12\", reference);\n-\n-        try {\n-            GitHelper.parseGitHubReference(\"refs/fake/foobar\");\n-            fail(\"Should throw exception\");\n-        } catch (CustomWebApplicationException ex) {\n-            assertEquals(ex.getResponse().getStatus(), 418);\n-        }\n-\n-        try {\n-            GitHelper.parseGitHubReference(\"refs/fake/feature/foobar\");\n-            fail(\"Should throw exception\");\n-        } catch (CustomWebApplicationException ex) {\n-            assertEquals(ex.getResponse().getStatus(), 418);\n-        }\n-\n-        try {\n-            GitHelper.parseGitHubReference(\"feature/foobar\");\n-            fail(\"Should throw exception\");\n-        } catch (CustomWebApplicationException ex) {\n-            assertEquals(ex.getResponse().getStatus(), 418);\n-        }\n-\n-\n-    }\n-\n     /**\n      * We need an EntryVersionHelper instance so we can call EntryVersionHelper.writeStreamAsZip; getDAO never gets invoked.\n      */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg5MDYxNw==", "url": "https://github.com/dockstore/dockstore/pull/3331#discussion_r395890617", "bodyText": "I would have this return an Optional, and make the caller responsible for throwing an exception. Seems odd to have lambda exception being thrown from a method that parses a string.", "author": "coverbeck", "createdAt": "2020-03-20T21:08:46Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/GitHelper.java", "diffHunk": "@@ -0,0 +1,42 @@\n+package io.dockstore.webservice.helpers;\n+\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+import io.dockstore.webservice.CustomWebApplicationException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static io.dockstore.webservice.Constants.LAMBDA_FAILURE;\n+\n+/**\n+ * A helper class for handling git related problems\n+ * @author aduncan\n+ */\n+public final class GitHelper {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(GitHelper.class);\n+\n+    private GitHelper() {\n+\n+    }\n+\n+    /**\n+     * Parse git references (ex. refs/heads/feature/foobar) and returns a reference name\n+     * @param gitReference Git Reference of the form refs/tags/name or refs/heads/name\n+     * @return Git reference name\n+     */\n+    public static String parseGitHubReference(String gitReference) {", "originalCommit": "319178e35f741aa4d9ec25214b01d7c27ad08b72", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6c0546273b187058f821a898eedd46d82ae7764d", "chunk": "diff --git a/dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/GitHelper.java b/dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/GitHelper.java\nindex 933c02f98..39edf5193 100644\n--- a/dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/GitHelper.java\n+++ b/dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/GitHelper.java\n\n@@ -1,14 +1,12 @@\n package io.dockstore.webservice.helpers;\n \n+import java.util.Optional;\n import java.util.regex.Matcher;\n import java.util.regex.Pattern;\n \n-import io.dockstore.webservice.CustomWebApplicationException;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import static io.dockstore.webservice.Constants.LAMBDA_FAILURE;\n-\n /**\n  * A helper class for handling git related problems\n  * @author aduncan\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg5MTczNw==", "url": "https://github.com/dockstore/dockstore/pull/3331#discussion_r395891737", "bodyText": "I don't think you want this any more", "author": "coverbeck", "createdAt": "2020-03-20T21:11:55Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java", "diffHunk": "@@ -1828,14 +1829,32 @@ public void deleteWorkflow(@ApiParam(hidden = true) @Parameter(hidden = true, na\n     @Consumes(MediaType.APPLICATION_FORM_URLENCODED)\n     @UnitOfWork\n     @RolesAllowed({ \"curator\", \"admin\" })\n-    @Operation(description = \"Handle a release of a repository on GitHub. Will create a workflow/service and version when necessary.\", security = @SecurityRequirement(name = \"bearer\"), responses = @ApiResponse(responseCode = \"418\", description = \"This code tells AWS Lambda not to retry.\"))\n+    @Operation(description = \"Handle a release of a repository on GitHub. Will create a workflow/service and version when necessary.\", security = @SecurityRequirement(name = OPENAPI_JWT_SECURITY_DEFINITION_NAME), responses = @ApiResponse(responseCode = \"418\", description = \"This code tells AWS Lambda not to retry.\"))\n     @ApiOperation(value = \"Handle a release of a repository on GitHub. Will create a workflow/service and version when necessary.\", authorizations = {\n         @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, response = Workflow.class, responseContainer = \"List\")\n     public List<Workflow> handleGitHubRelease(@ApiParam(hidden = true) @Parameter(hidden = true, name = \"user\", in = ParameterIn.HEADER) @Auth User user,\n         @ApiParam(value = \"Repository path (ex. dockstore/dockstore-ui2)\", required = true) @FormParam(\"repository\") String repository,\n         @ApiParam(value = \"Username of user on GitHub who triggered action\", required = true) @FormParam(\"username\") String username,\n         @ApiParam(value = \"Full git reference for a GitHub branch/tag. Ex. refs/heads/master or refs/tags/v1.0\", required = true) @FormParam(\"gitReference\") String gitReference,\n         @ApiParam(value = \"GitHub installation ID\", required = true) @FormParam(\"installationId\") String installationId) {\n+        LOG.info(\"Branch/tag \" + gitReference + \" pushed to \" + repository + \"(\" + username + \")\");\n         return githubWebhookRelease(repository, username, gitReference, installationId);\n     }\n+\n+    @DELETE\n+    @Path(\"/github\")\n+    @Timed\n+    @Consumes(MediaType.APPLICATION_FORM_URLENCODED)", "originalCommit": "319178e35f741aa4d9ec25214b01d7c27ad08b72", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6c0546273b187058f821a898eedd46d82ae7764d", "chunk": "diff --git a/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java b/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java\nindex 1bb927a94..4f425ea4a 100644\n--- a/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java\n+++ b/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java\n\n@@ -1844,7 +1844,6 @@ public class WorkflowResource extends AbstractWorkflowResource<Workflow>\n     @DELETE\n     @Path(\"/github\")\n     @Timed\n-    @Consumes(MediaType.APPLICATION_FORM_URLENCODED)\n     @UnitOfWork\n     @RolesAllowed({ \"curator\", \"admin\" })\n     @Operation(description = \"Handles the deletion of a branch on GitHub. Will delete all workflow versions that match in all workflows that share the same repository.\", security = @SecurityRequirement(name = OPENAPI_JWT_SECURITY_DEFINITION_NAME), responses = @ApiResponse(responseCode = \"418\", description = \"This code tells AWS Lambda not to retry.\"))\n"}}, {"oid": "6c0546273b187058f821a898eedd46d82ae7764d", "url": "https://github.com/dockstore/dockstore/commit/6c0546273b187058f821a898eedd46d82ae7764d", "message": "more fixes from PR", "committedDate": "2020-03-23T13:39:22Z", "type": "commit"}]}