{"pr_number": 3257, "pr_title": "Constrain unique version names for workflow versions plus tags", "pr_createdAt": "2020-02-21T21:05:59Z", "pr_url": "https://github.com/dockstore/dockstore/pull/3257", "timeline": [{"oid": "8717843fcaa09108db18c370784caf3aaba2ec36", "url": "https://github.com/dockstore/dockstore/commit/8717843fcaa09108db18c370784caf3aaba2ec36", "message": "WIP", "committedDate": "2020-02-21T15:35:19Z", "type": "commit"}, {"oid": "0c157f2c2f142f5d5b135c10690dff0c422f1ab6", "url": "https://github.com/dockstore/dockstore/commit/0c157f2c2f142f5d5b135c10690dff0c422f1ab6", "message": "Locally working db changes\n\n* addresses duplicate workflow versions\n* no way to not touch tags at the same time due to inheritance\n* will need to test well for side-effects\n* particularly refresh/upsert/etc", "committedDate": "2020-02-21T21:02:11Z", "type": "commit"}, {"oid": "4151582f527d26780e1113458b72bfa701662cfe", "url": "https://github.com/dockstore/dockstore/commit/4151582f527d26780e1113458b72bfa701662cfe", "message": "Remove constraint for version due to inheritance", "committedDate": "2020-02-21T21:53:54Z", "type": "commit"}, {"oid": "8ce552e6779411a48a25430514194ac6918a7de4", "url": "https://github.com/dockstore/dockstore/commit/8ce552e6779411a48a25430514194ac6918a7de4", "message": "Delete less content in migration due to services", "committedDate": "2020-02-21T22:09:24Z", "type": "commit"}, {"oid": "8b03a7143725f56c9611541026529976ee8bd694", "url": "https://github.com/dockstore/dockstore/commit/8b03a7143725f56c9611541026529976ee8bd694", "message": "Some patches for edge cases, probably need more", "committedDate": "2020-02-24T19:58:07Z", "type": "commit"}, {"oid": "04399624b0b5cb43130e55362320b3a10cd1cdf3", "url": "https://github.com/dockstore/dockstore/commit/04399624b0b5cb43130e55362320b3a10cd1cdf3", "message": "validation fixes", "committedDate": "2020-02-24T20:54:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY1OTQ0MQ==", "url": "https://github.com/dockstore/dockstore/pull/3257#discussion_r383659441", "bodyText": "I don't understand the need for this -- on line 214 you've already verified that the map does not contain the name. How could the map now contain the name? Can line 221/223 change the name? Otherwise this seems redundant. Or I'm missing something.", "author": "coverbeck", "createdAt": "2020-02-25T05:00:52Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java", "diffHunk": "@@ -217,11 +217,17 @@ protected void updateDBWorkflowWithSourceControlWorkflow(Workflow workflow, Work\n                 }\n                 workflowVersionFromDB.update(version);\n             } else {\n-                // create a new one and replace the old one\n+                // attach real workflow\n+                workflow.addWorkflowVersion(version);\n+\n                 final long workflowVersionId = workflowVersionDAO.create(version);\n                 releaseCreated = true;\n                 workflowVersionFromDB = workflowVersionDAO.findById(workflowVersionId);\n                 workflow.getWorkflowVersions().add(workflowVersionFromDB);\n+                // create a new one and replace the old one if it exists\n+                if (existingVersionMap.containsKey(workflowVersionFromDB.getName())) {", "originalCommit": "8b03a7143725f56c9611541026529976ee8bd694", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzk3NzQ2OQ==", "url": "https://github.com/dockstore/dockstore/pull/3257#discussion_r383977469", "bodyText": "I think it should be redundant, I probably had something else in mind.", "author": "denis-yuen", "createdAt": "2020-02-25T16:06:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY1OTQ0MQ=="}], "type": "inlineReview", "revised_code": {"commit": "7d73182c9884431e7ee3ac2527db2d93211a0a29", "chunk": "diff --git a/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java b/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java\nindex 1c622535c..f60a7d61b 100644\n--- a/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java\n+++ b/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java\n\n@@ -224,10 +224,6 @@ public abstract class AbstractWorkflowResource<T extends Workflow> implements So\n                 releaseCreated = true;\n                 workflowVersionFromDB = workflowVersionDAO.findById(workflowVersionId);\n                 workflow.getWorkflowVersions().add(workflowVersionFromDB);\n-                // create a new one and replace the old one if it exists\n-                if (existingVersionMap.containsKey(workflowVersionFromDB.getName())) {\n-                    workflowVersionDAO.delete(existingVersionMap.get(workflowVersionFromDB.getName()));\n-                }\n                 existingVersionMap.put(workflowVersionFromDB.getName(), workflowVersionFromDB);\n             }\n \n"}}, {"oid": "7d73182c9884431e7ee3ac2527db2d93211a0a29", "url": "https://github.com/dockstore/dockstore/commit/7d73182c9884431e7ee3ac2527db2d93211a0a29", "message": "PR feedback", "committedDate": "2020-02-25T16:12:00Z", "type": "commit"}, {"oid": "6bc0d2dc45e5300c996f6fd7f4f5388e55546fd1", "url": "https://github.com/dockstore/dockstore/commit/6bc0d2dc45e5300c996f6fd7f4f5388e55546fd1", "message": "Travis-CI update?\n\nhttps://changelog.travis-ci.com/", "committedDate": "2020-02-25T16:22:46Z", "type": "commit"}]}