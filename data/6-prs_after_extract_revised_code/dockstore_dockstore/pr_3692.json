{"pr_number": 3692, "pr_title": "Feature/2834/record parsing info", "pr_createdAt": "2020-07-24T20:46:35Z", "pr_url": "https://github.com/dockstore/dockstore/pull/3692", "timeline": [{"oid": "2a088e2f294270a450e2b479d9b4e115d2648830", "url": "https://github.com/dockstore/dockstore/commit/2a088e2f294270a450e2b479d9b4e115d2648830", "message": "Add new elementcollection", "committedDate": "2020-07-21T20:48:44Z", "type": "commit"}, {"oid": "9c46a8a839fa488abcd259b3d31ae79ee1c1b141", "url": "https://github.com/dockstore/dockstore/commit/9c46a8a839fa488abcd259b3d31ae79ee1c1b141", "message": "Add migration", "committedDate": "2020-07-24T00:35:27Z", "type": "commit"}, {"oid": "0367a476d09b677cc1a330ca46e0b0f171224447", "url": "https://github.com/dockstore/dockstore/commit/0367a476d09b677cc1a330ca46e0b0f171224447", "message": "Add warning message", "committedDate": "2020-07-24T00:35:27Z", "type": "commit"}, {"oid": "683bd691aca7a6628d334e1b2a1a08cc121c2587", "url": "https://github.com/dockstore/dockstore/commit/683bd691aca7a6628d334e1b2a1a08cc121c2587", "message": "Parse descriptors for type of imports", "committedDate": "2020-07-24T00:35:27Z", "type": "commit"}, {"oid": "41883a4f20ffba9f3b538138a1596c47415c2e8f", "url": "https://github.com/dockstore/dockstore/commit/41883a4f20ffba9f3b538138a1596c47415c2e8f", "message": "Actually return the ParsedInformation", "committedDate": "2020-07-24T00:35:27Z", "type": "commit"}, {"oid": "fff6c0ccf9107cb89e88979b256c9ea2483b6859", "url": "https://github.com/dockstore/dockstore/commit/fff6c0ccf9107cb89e88979b256c9ea2483b6859", "message": "Add test", "committedDate": "2020-07-24T20:11:18Z", "type": "commit"}, {"oid": "ea6b5c251d8ade2d97e2f80d406a9ab92c65e13f", "url": "https://github.com/dockstore/dockstore/commit/ea6b5c251d8ade2d97e2f80d406a9ab92c65e13f", "message": "Fix test", "committedDate": "2020-07-24T20:11:18Z", "type": "commit"}, {"oid": "2f6e9d1576c792fa1472e5d36e035db22fc1d4ad", "url": "https://github.com/dockstore/dockstore/commit/2f6e9d1576c792fa1472e5d36e035db22fc1d4ad", "message": "Fix migration?", "committedDate": "2020-07-24T20:11:18Z", "type": "commit"}, {"oid": "37763a69d4eabc926214d5b78709d47f1a6028c5", "url": "https://github.com/dockstore/dockstore/commit/37763a69d4eabc926214d5b78709d47f1a6028c5", "message": "Update swagger/openapi", "committedDate": "2020-07-24T20:11:18Z", "type": "commit"}, {"oid": "4e4827a3cb0fd9a5beea0191503949983aa6655c", "url": "https://github.com/dockstore/dockstore/commit/4e4827a3cb0fd9a5beea0191503949983aa6655c", "message": "Merge branch 'develop' into feature/2834/recordParsingInfo", "committedDate": "2020-07-28T14:14:58Z", "type": "commit"}, {"oid": "79e0078318aa359437183ce04f25e99620f6989a", "url": "https://github.com/dockstore/dockstore/commit/79e0078318aa359437183ce04f25e99620f6989a", "message": "Attempt to fix database", "committedDate": "2020-07-28T17:57:21Z", "type": "commit"}, {"oid": "79e0078318aa359437183ce04f25e99620f6989a", "url": "https://github.com/dockstore/dockstore/commit/79e0078318aa359437183ce04f25e99620f6989a", "message": "Attempt to fix database", "committedDate": "2020-07-28T17:57:21Z", "type": "forcePushed"}, {"oid": "ff561e388ea8ec4037b0ea27c26c8740977074e0", "url": "https://github.com/dockstore/dockstore/commit/ff561e388ea8ec4037b0ea27c26c8740977074e0", "message": "Fix orphans", "committedDate": "2020-07-28T21:45:24Z", "type": "commit"}, {"oid": "fc5ac87d968ac3777422ac765b94336fff250a56", "url": "https://github.com/dockstore/dockstore/commit/fc5ac87d968ac3777422ac765b94336fff250a56", "message": "Self review", "committedDate": "2020-07-28T23:48:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM0OTc5NQ==", "url": "https://github.com/dockstore/dockstore/pull/3692#discussion_r462349795", "bodyText": "Can this be split into two shorter tests for CWL and WDL separately?\n(Makes it easier to debug in the future if one language parsing method is broken)", "author": "denis-yuen", "createdAt": "2020-07-29T14:36:57Z", "path": "dockstore-integration-testing/src/test/java/io/dockstore/client/cli/WorkflowIT.java", "diffHunk": "@@ -205,6 +206,74 @@ private Workflow manualRegisterAndPublish(WorkflowsApi workflowsApi, String work\n         return workflow;\n     }\n \n+    // Tests 6 things:\n+    // WDL workflow with local imports\n+    // WDL workflow with HTTP imports\n+    // CWL workflow with local imports\n+    // CWL workflow with HTTP imports\n+    // WDL workflow with HTTP imports and local imports and nested\n+    // CWL workflow with HTTP imports and local imports and nested\n+    @Test\n+    public void testLanguageParsingInformation() {", "originalCommit": "fc5ac87d968ac3777422ac765b94336fff250a56", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "aa1760fdbdd3f8b329d280d670d6856f7da4b350", "chunk": "diff --git a/dockstore-integration-testing/src/test/java/io/dockstore/client/cli/WorkflowIT.java b/dockstore-integration-testing/src/test/java/io/dockstore/client/cli/WorkflowIT.java\nindex a86f1bb5f..a36194424 100644\n--- a/dockstore-integration-testing/src/test/java/io/dockstore/client/cli/WorkflowIT.java\n+++ b/dockstore-integration-testing/src/test/java/io/dockstore/client/cli/WorkflowIT.java\n\n@@ -206,15 +206,12 @@ public class WorkflowIT extends BaseIT {\n         return workflow;\n     }\n \n-    // Tests 6 things:\n+    // Tests 3 things:\n     // WDL workflow with local imports\n     // WDL workflow with HTTP imports\n-    // CWL workflow with local imports\n-    // CWL workflow with HTTP imports\n     // WDL workflow with HTTP imports and local imports and nested\n-    // CWL workflow with HTTP imports and local imports and nested\n     @Test\n-    public void testLanguageParsingInformation() {\n+    public void testWDLLanguageParsingInformation() {\n         final ApiClient webClient = getWebClient(USER_2_USERNAME, testingPostgres);\n         WorkflowsApi workflowApi = new WorkflowsApi(webClient);\n         Workflow wdl = workflowApi\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM1MjEzOA==", "url": "https://github.com/dockstore/dockstore/pull/3692#discussion_r462352138", "bodyText": "Might become more clear further down, but since this only is two booleans, it might be worth looking into making this embedded https://www.baeldung.com/jpa-embedded-embeddable so you can still interact with this as an object but it has no independent id and/or table from version metadata", "author": "denis-yuen", "createdAt": "2020-07-29T14:39:57Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/core/ParsedInformation.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package io.dockstore.webservice.core;\n+\n+import javax.persistence.Entity;\n+import javax.persistence.EnumType;\n+import javax.persistence.Enumerated;\n+import javax.persistence.GeneratedValue;\n+import javax.persistence.Id;\n+\n+import io.dockstore.common.DescriptorLanguage;\n+\n+/**\n+ * This is for information gained after parsing the workflow with a language parser (WDLHandler, CWLHandler, etc)\n+ *\n+ * Putting DescriptorLanguage here instead of using a map with DescriptorLanguage because there may be cases where the language is\n+ * irrelevant. For example, workflows only have one language.\n+ */\n+@Entity\n+public class ParsedInformation {\n+    @Id\n+    @GeneratedValue\n+    private Long id;", "originalCommit": "fc5ac87d968ac3777422ac765b94336fff250a56", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQxMjQ0NA==", "url": "https://github.com/dockstore/dockstore/pull/3692#discussion_r462412444", "bodyText": "First thing I tried, couldn't do it because it's OneToMany instead of OneToOne.  See this commit on what it originally was 79e0078\nWait...that's @elementcollection vs @embedded, will give that a try", "author": "garyluu", "createdAt": "2020-07-29T16:01:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM1MjEzOA=="}], "type": "inlineReview", "revised_code": {"commit": "5362e8bdef6b2309f925e1bb73389a48584d0a4e", "chunk": "diff --git a/dockstore-webservice/src/main/java/io/dockstore/webservice/core/ParsedInformation.java b/dockstore-webservice/src/main/java/io/dockstore/webservice/core/ParsedInformation.java\nindex 7a1aa0e4d..23feb4cfb 100644\n--- a/dockstore-webservice/src/main/java/io/dockstore/webservice/core/ParsedInformation.java\n+++ b/dockstore-webservice/src/main/java/io/dockstore/webservice/core/ParsedInformation.java\n\n@@ -1,10 +1,8 @@\n package io.dockstore.webservice.core;\n \n-import javax.persistence.Entity;\n+import javax.persistence.Embeddable;\n import javax.persistence.EnumType;\n import javax.persistence.Enumerated;\n-import javax.persistence.GeneratedValue;\n-import javax.persistence.Id;\n \n import io.dockstore.common.DescriptorLanguage;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM1MzUxMg==", "url": "https://github.com/dockstore/dockstore/pull/3692#discussion_r462353512", "bodyText": "Ah rats", "author": "denis-yuen", "createdAt": "2020-07-29T14:41:45Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/core/Version.java", "diffHunk": "@@ -141,7 +141,9 @@\n     @ApiModelProperty(value = \"True if user has altered the tag\", position = 8)\n     private boolean dirtyBit = false;\n \n-    @JsonIgnore\n+    // Warning: this is eagerly loaded because of two reasons:", "originalCommit": "fc5ac87d968ac3777422ac765b94336fff250a56", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM1NTI5NQ==", "url": "https://github.com/dockstore/dockstore/pull/3692#discussion_r462355295", "bodyText": "could this be a problem if some jerk has a folder with a name like httpStuffIgot/data/?\nhttps://commons.apache.org/proper/commons-validator/apidocs/org/apache/commons/validator/routines/UrlValidator.html might be an option already on our classpath", "author": "denis-yuen", "createdAt": "2020-07-29T14:44:06Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/CWLHandler.java", "diffHunk": "@@ -492,6 +495,19 @@ private void handleMap(String repositoryId, String parentFilePath, Version versi\n         }\n     }\n \n+    /**\n+     * Sets the type of imports in ParsedInformation based on the import string\n+     * @param parsedInformation     A version's version metadata's\n+     * @param mapValue              Import string (should be either a local import or an HTTP(s) import\n+     */\n+    private void setImportsBasedOnMapValue(ParsedInformation parsedInformation, String mapValue) {\n+        if (mapValue.startsWith(\"http\")) {", "originalCommit": "fc5ac87d968ac3777422ac765b94336fff250a56", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "71ccbf02ab997596fe66539749d307fe848ddeb6", "chunk": "diff --git a/dockstore-webservice/src/main/java/io/dockstore/webservice/languages/CWLHandler.java b/dockstore-webservice/src/main/java/io/dockstore/webservice/languages/CWLHandler.java\nindex 3eea5e80c..37cd2f0e3 100644\n--- a/dockstore-webservice/src/main/java/io/dockstore/webservice/languages/CWLHandler.java\n+++ b/dockstore-webservice/src/main/java/io/dockstore/webservice/languages/CWLHandler.java\n\n@@ -500,8 +501,10 @@ public class CWLHandler implements LanguageHandlerInterface {\n      * @param parsedInformation     A version's version metadata's\n      * @param mapValue              Import string (should be either a local import or an HTTP(s) import\n      */\n-    private void setImportsBasedOnMapValue(ParsedInformation parsedInformation, String mapValue) {\n-        if (mapValue.startsWith(\"http\")) {\n+    public static void setImportsBasedOnMapValue(ParsedInformation parsedInformation, String mapValue) {\n+        String[] schemes = {\"http\", \"https\"};\n+        UrlValidator urlValidator = new UrlValidator(schemes);\n+        if (urlValidator.isValid(mapValue)) {\n             parsedInformation.setHasHTTPImports(true);\n         } else {\n             parsedInformation.setHasLocalImports(true);\n"}}, {"oid": "71ccbf02ab997596fe66539749d307fe848ddeb6", "url": "https://github.com/dockstore/dockstore/commit/71ccbf02ab997596fe66539749d307fe848ddeb6", "message": "Simple PR changes", "committedDate": "2020-07-29T16:19:23Z", "type": "commit"}, {"oid": "aa1760fdbdd3f8b329d280d670d6856f7da4b350", "url": "https://github.com/dockstore/dockstore/commit/aa1760fdbdd3f8b329d280d670d6856f7da4b350", "message": "Seperate test", "committedDate": "2020-07-29T16:23:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQxNjM2Ng==", "url": "https://github.com/dockstore/dockstore/pull/3692#discussion_r462416366", "bodyText": "Why is this Long instead of long? I think Long should only be used if it's nullable.", "author": "coverbeck", "createdAt": "2020-07-29T16:07:53Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/core/ParsedInformation.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package io.dockstore.webservice.core;\n+\n+import javax.persistence.Entity;\n+import javax.persistence.EnumType;\n+import javax.persistence.Enumerated;\n+import javax.persistence.GeneratedValue;\n+import javax.persistence.Id;\n+\n+import io.dockstore.common.DescriptorLanguage;\n+\n+/**\n+ * This is for information gained after parsing the workflow with a language parser (WDLHandler, CWLHandler, etc)\n+ *\n+ * Putting DescriptorLanguage here instead of using a map with DescriptorLanguage because there may be cases where the language is\n+ * irrelevant. For example, workflows only have one language.\n+ */\n+@Entity\n+public class ParsedInformation {\n+    @Id\n+    @GeneratedValue\n+    private Long id;", "originalCommit": "fc5ac87d968ac3777422ac765b94336fff250a56", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5362e8bdef6b2309f925e1bb73389a48584d0a4e", "chunk": "diff --git a/dockstore-webservice/src/main/java/io/dockstore/webservice/core/ParsedInformation.java b/dockstore-webservice/src/main/java/io/dockstore/webservice/core/ParsedInformation.java\nindex 7a1aa0e4d..23feb4cfb 100644\n--- a/dockstore-webservice/src/main/java/io/dockstore/webservice/core/ParsedInformation.java\n+++ b/dockstore-webservice/src/main/java/io/dockstore/webservice/core/ParsedInformation.java\n\n@@ -1,10 +1,8 @@\n package io.dockstore.webservice.core;\n \n-import javax.persistence.Entity;\n+import javax.persistence.Embeddable;\n import javax.persistence.EnumType;\n import javax.persistence.Enumerated;\n-import javax.persistence.GeneratedValue;\n-import javax.persistence.Id;\n \n import io.dockstore.common.DescriptorLanguage;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQyMjYzMg==", "url": "https://github.com/dockstore/dockstore/pull/3692#discussion_r462422632", "bodyText": "This would normally result in a database record being persisted. However, if this ends up getting called from a read-only transaction, it won't be saved.\n\nMaybe this doesn't get called from a read-only transaction (don't have the whole flow in my head), in which case this whole comment is moot.\nIt looks very lightweight, so no big deal if it's not saved?\n\nPointing it out just in case.", "author": "coverbeck", "createdAt": "2020-07-29T16:17:04Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/LanguageHandlerInterface.java", "diffHunk": "@@ -171,6 +172,19 @@ default String getCleanDAG(String mainDescriptorPath, String mainDescriptor, Set\n         return DAGHelper.cleanDAG(getContent(mainDescriptorPath, mainDescriptor, secondarySourceFiles, type, dao));\n     }\n \n+    default ParsedInformation getParsedInformation(Version version, DescriptorLanguage descriptorLanguage) {\n+        Optional<ParsedInformation> foundParsedInformation = version.getVersionMetadata().getParsedInformationSet().stream()\n+                .filter(parsedInformation -> parsedInformation.getDescriptorLanguage() == descriptorLanguage).findFirst();\n+        if (foundParsedInformation.isPresent()) {\n+            return foundParsedInformation.get();\n+        } else {\n+            ParsedInformation parsedInformation = new ParsedInformation();\n+            parsedInformation.setDescriptorLanguage(descriptorLanguage);\n+            version.getVersionMetadata().getParsedInformationSet().add(parsedInformation);", "originalCommit": "fc5ac87d968ac3777422ac765b94336fff250a56", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ0MDkzMA==", "url": "https://github.com/dockstore/dockstore/pull/3692#discussion_r462440930", "bodyText": "It's lightweight enough that's it's no big deal\nThe language parsing code (the majority of CWLHandler and WDLHandler) would then have to be disabled alongside this which is outside the scope of this PR", "author": "garyluu", "createdAt": "2020-07-29T16:46:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQyMjYzMg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "ad2c8c610feb9aedbd57edbc7aaaa502e4570813", "url": "https://github.com/dockstore/dockstore/commit/ad2c8c610feb9aedbd57edbc7aaaa502e4570813", "message": "Add one more test", "committedDate": "2020-07-29T16:29:15Z", "type": "commit"}, {"oid": "5362e8bdef6b2309f925e1bb73389a48584d0a4e", "url": "https://github.com/dockstore/dockstore/commit/5362e8bdef6b2309f925e1bb73389a48584d0a4e", "message": "@Embedded attempt", "committedDate": "2020-07-29T16:50:18Z", "type": "commit"}, {"oid": "282b8f5a0b3f4d99f3ed705dd41666057864e7cb", "url": "https://github.com/dockstore/dockstore/commit/282b8f5a0b3f4d99f3ed705dd41666057864e7cb", "message": "Element collection list", "committedDate": "2020-07-29T19:57:35Z", "type": "commit"}, {"oid": "e47dbdb6fd44eed37ef1619e2369206fe25c80f0", "url": "https://github.com/dockstore/dockstore/commit/e47dbdb6fd44eed37ef1619e2369206fe25c80f0", "message": "Merge branch 'develop' into feature/2834/recordParsingInfo", "committedDate": "2020-07-30T04:44:37Z", "type": "commit"}, {"oid": "a5ad965e1a23e4313606a9af874a34f19dcb17ba", "url": "https://github.com/dockstore/dockstore/commit/a5ad965e1a23e4313606a9af874a34f19dcb17ba", "message": "Merge branch 'develop' into feature/2834/recordParsingInfo", "committedDate": "2020-07-30T20:00:36Z", "type": "commit"}, {"oid": "57a8653a740c263c273f7a10ff4eb528cd7b6463", "url": "https://github.com/dockstore/dockstore/commit/57a8653a740c263c273f7a10ff4eb528cd7b6463", "message": "Merge branch 'develop' into feature/2834/recordParsingInfo", "committedDate": "2020-07-31T02:04:25Z", "type": "commit"}]}