{"pr_number": 3789, "pr_title": "@jsonignore sourcefiles", "pr_createdAt": "2020-09-03T20:39:42Z", "pr_url": "https://github.com/dockstore/dockstore/pull/3789", "timeline": [{"oid": "2f762689923d40f7405a75d5f96b4cb410f3bc7f", "url": "https://github.com/dockstore/dockstore/commit/2f762689923d40f7405a75d5f96b4cb410f3bc7f", "message": "@jsonignore sourcefiles", "committedDate": "2020-09-03T20:31:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzMyNzk3Mg==", "url": "https://github.com/dockstore/dockstore/pull/3789#discussion_r483327972", "bodyText": "I don't understand this. Why do you have a loop on an always empty array?\nDo you expect this code to be turned back on? If so, should there be a TODO? If not, shouldn't you just delete it?", "author": "coverbeck", "createdAt": "2020-09-04T00:55:21Z", "path": "dockstore-event-consumer/src/main/java/io/dockstore/consumer/handler/DOIHandler.java", "diffHunk": "@@ -127,7 +129,9 @@ public boolean handleMessage(DOIMessage message) {\n                 // upload a new file\n                 int depositionID = returnDeposit.getId();\n                 FilesApi filesApi = new FilesApi(zenodoClient);\n-                for (SourceFile file : tag.getSourceFiles()) {\n+                // This code isn't used currently, so changing it to get around @JsonIgnore being added to sourcefiles. Previously iterated through tag.getSourcefiles()", "originalCommit": "2f762689923d40f7405a75d5f96b4cb410f3bc7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzczNTcwOQ==", "url": "https://github.com/dockstore/dockstore/pull/3789#discussion_r483735709", "bodyText": "I think Denis said this was a concept for how you could hook up something like zenodo to dockstore, but Walt went with a different approach. I don't know if it ever be used, but figured it would be good to keep as a reference for possible future work.\nI'll comment this section out instead of changing it.", "author": "NatalieEO", "createdAt": "2020-09-04T16:36:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzMyNzk3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "4492030c9ab1a9715b0a907e52ddba1659cbbefc", "chunk": "diff --git a/dockstore-event-consumer/src/main/java/io/dockstore/consumer/handler/DOIHandler.java b/dockstore-event-consumer/src/main/java/io/dockstore/consumer/handler/DOIHandler.java\nindex 3deb1e179..218ef97dd 100644\n--- a/dockstore-event-consumer/src/main/java/io/dockstore/consumer/handler/DOIHandler.java\n+++ b/dockstore-event-consumer/src/main/java/io/dockstore/consumer/handler/DOIHandler.java\n\n@@ -128,15 +121,14 @@ public class DOIHandler implements MessageHandler<DOIMessage> {\n                 returnDeposit = depositApi.createDeposit(deposit);\n                 // upload a new file\n                 int depositionID = returnDeposit.getId();\n-                FilesApi filesApi = new FilesApi(zenodoClient);\n-                // This code isn't used currently, so changing it to get around @JsonIgnore being added to sourcefiles. Previously iterated through tag.getSourcefiles()\n-                List<SourceFile> sourceFileList = new ArrayList<>();\n-                for (SourceFile file : sourceFileList) {\n-                    Path tempFile = Files.createTempFile(\"temp\", \"file\");\n-                    FileUtils.writeStringToFile(tempFile.toFile(), file.getContent(), StandardCharsets.UTF_8);\n-                    // file name is passsed in but seems to be ignore\n-                    filesApi.createFile(depositionID, tempFile.toFile(), new File(file.getPath()).getName());\n-                }\n+                // Commenting out to get around json ignoring source files. The files in this section aren't used, but keeping them around for reference for possible future work.\n+                // FilesApi filesApi = new FilesApi(zenodoClient);\n+                //                for (SourceFile file : tag.getSourceFiles()) {\n+                //                    Path tempFile = Files.createTempFile(\"temp\", \"file\");\n+                //                    FileUtils.writeStringToFile(tempFile.toFile(), file.getContent(), StandardCharsets.UTF_8);\n+                //                    // file name is passsed in but seems to be ignore\n+                //                    filesApi.createFile(depositionID, tempFile.toFile(), new File(file.getPath()).getName());\n+                //                }\n                 // TODO: this would be fleshed out to populate descriptors, secondary descriptors, test json, dockerfiles, etc.\n                 // TODO: this could use a progress indicator, uploading docker images seems slow\n                 //DepositionFile file = filesApi.createFile(depositionID, dockerImageFile, dockerImageFile.getAbsolutePath());\n"}}, {"oid": "4492030c9ab1a9715b0a907e52ddba1659cbbefc", "url": "https://github.com/dockstore/dockstore/commit/4492030c9ab1a9715b0a907e52ddba1659cbbefc", "message": "only add extra tools to a few test files instead of all of them. Just comment out a section in DOIHandler", "committedDate": "2020-09-04T16:57:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg2NjU4MQ==", "url": "https://github.com/dockstore/dockstore/pull/3789#discussion_r483866581", "bodyText": "Mismatch count in the error message. You can leave the number out of our error message. It will automatically say expected 6 actual w/e", "author": "garyluu", "createdAt": "2020-09-04T22:21:19Z", "path": "dockstore-integration-testing/src/test/java/io/dockstore/client/cli/GeneralIT.java", "diffHunk": "@@ -197,7 +155,7 @@ private String getPathfromDB(String type) {\n     public void testListAvailableContainers() {\n \n         final long count = testingPostgres.runSelectStatement(\"select count(*) from tool where ispublished='f'\", long.class);\n-        assertEquals(\"there should be 4 entries, there are \" + count, 4, count);\n+        assertEquals(\"there should be 4 entries, there are \" + count, 6, count);", "originalCommit": "4492030c9ab1a9715b0a907e52ddba1659cbbefc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ad2e8ea1a79f79dcf7d2f3a65a7e5572ac3de4dd", "chunk": "diff --git a/dockstore-integration-testing/src/test/java/io/dockstore/client/cli/GeneralIT.java b/dockstore-integration-testing/src/test/java/io/dockstore/client/cli/GeneralIT.java\nindex bfc60333d..db7188fb6 100644\n--- a/dockstore-integration-testing/src/test/java/io/dockstore/client/cli/GeneralIT.java\n+++ b/dockstore-integration-testing/src/test/java/io/dockstore/client/cli/GeneralIT.java\n\n@@ -155,7 +155,7 @@ public class GeneralIT extends BaseIT {\n     public void testListAvailableContainers() {\n \n         final long count = testingPostgres.runSelectStatement(\"select count(*) from tool where ispublished='f'\", long.class);\n-        assertEquals(\"there should be 4 entries, there are \" + count, 6, count);\n+        assertEquals(\"unpublished entries should match\", 6, count);\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg2NjkzOQ==", "url": "https://github.com/dockstore/dockstore/pull/3789#discussion_r483866939", "bodyText": "error message mismatch here and everywhere", "author": "garyluu", "createdAt": "2020-09-04T22:22:57Z", "path": "dockstore-integration-testing/src/test/java/io/dockstore/client/cli/SwaggerClientIT.java", "diffHunk": "@@ -512,17 +482,15 @@ public void testHidingTags() throws ApiException {\n         ApiClient client = getAdminWebClient();\n \n         ContainersApi containersApi = new ContainersApi(client);\n-        // register one more to give us something to look at\n-        DockstoreTool c = getContainer();\n-        c.getWorkflowVersions().get(0).setHidden(true);\n-        c = containersApi.registerManual(c);\n+        // Tool contains 2 versions, 1 is hidden\n+        DockstoreTool c = containersApi.getContainerByToolPath(REGISTRY_HUB_DOCKER_COM_SEQWARE_SEQWARE, null);\n \n-        assertEquals(\"should see one tag as an admin, saw \" + c.getWorkflowVersions().size(), 1, c.getWorkflowVersions().size());\n+        assertEquals(\"should see one tag as an admin, saw \" + c.getWorkflowVersions().size(), 2, c.getWorkflowVersions().size());", "originalCommit": "4492030c9ab1a9715b0a907e52ddba1659cbbefc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ad2e8ea1a79f79dcf7d2f3a65a7e5572ac3de4dd", "chunk": "diff --git a/dockstore-integration-testing/src/test/java/io/dockstore/client/cli/SwaggerClientIT.java b/dockstore-integration-testing/src/test/java/io/dockstore/client/cli/SwaggerClientIT.java\nindex f75b5277d..27e244033 100644\n--- a/dockstore-integration-testing/src/test/java/io/dockstore/client/cli/SwaggerClientIT.java\n+++ b/dockstore-integration-testing/src/test/java/io/dockstore/client/cli/SwaggerClientIT.java\n\n@@ -485,13 +485,12 @@ public class SwaggerClientIT extends BaseIT {\n         // Tool contains 2 versions, 1 is hidden\n         DockstoreTool c = containersApi.getContainerByToolPath(REGISTRY_HUB_DOCKER_COM_SEQWARE_SEQWARE, null);\n \n-        assertEquals(\"should see one tag as an admin, saw \" + c.getWorkflowVersions().size(), 2, c.getWorkflowVersions().size());\n+        assertEquals(\"should see all tags even if hidden as an admin\", 2, c.getWorkflowVersions().size());\n \n         ApiClient muggleClient = getWebClient();\n         ContainersApi muggleContainersApi = new ContainersApi(muggleClient);\n         final DockstoreTool registeredContainer = muggleContainersApi.getPublishedContainer(c.getId(), null);\n-        assertEquals(\"should see no tags as a regular user, saw \" + registeredContainer.getWorkflowVersions().size(), 1,\n-            registeredContainer.getWorkflowVersions().size());\n+        assertEquals(\"should only see non-hidden tags as a regular user\", 1, registeredContainer.getWorkflowVersions().size());\n     }\n \n     @Test\n"}}, {"oid": "ad2e8ea1a79f79dcf7d2f3a65a7e5572ac3de4dd", "url": "https://github.com/dockstore/dockstore/commit/ad2e8ea1a79f79dcf7d2f3a65a7e5572ac3de4dd", "message": "update test asseartion messages, add comment", "committedDate": "2020-09-05T00:09:58Z", "type": "commit"}, {"oid": "4477d65d20620ebc2039dbb6d058947eb33035cd", "url": "https://github.com/dockstore/dockstore/commit/4477d65d20620ebc2039dbb6d058947eb33035cd", "message": "Merge branch 'develop' into feature/3644/ignoreSourceFiles", "committedDate": "2020-09-05T00:10:38Z", "type": "commit"}]}