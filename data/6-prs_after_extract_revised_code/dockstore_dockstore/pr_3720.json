{"pr_number": 3720, "pr_title": "3487/smart refresh", "pr_createdAt": "2020-08-06T15:35:25Z", "pr_url": "https://github.com/dockstore/dockstore/pull/3720", "timeline": [{"oid": "5a5a3d5dc3eec967babed2da3e0df5a98800be1c", "url": "https://github.com/dockstore/dockstore/commit/5a5a3d5dc3eec967babed2da3e0df5a98800be1c", "message": "first pass at smart refresh for refresh workflow and refresh workflow version", "committedDate": "2020-08-01T19:02:15Z", "type": "commit"}, {"oid": "f3d578cffc5e707068ca8f4e44248b2b51599395", "url": "https://github.com/dockstore/dockstore/commit/f3d578cffc5e707068ca8f4e44248b2b51599395", "message": "fix tests", "committedDate": "2020-08-01T19:36:13Z", "type": "commit"}, {"oid": "9d6506ca8c0b2437978eebacf7adb2ebcfe154f7", "url": "https://github.com/dockstore/dockstore/commit/9d6506ca8c0b2437978eebacf7adb2ebcfe154f7", "message": "fix bitbucket issue, add logging", "committedDate": "2020-08-01T20:15:32Z", "type": "commit"}, {"oid": "fd66f736d2ad69d2c4fa9e83682d1ee1c242ccd5", "url": "https://github.com/dockstore/dockstore/commit/fd66f736d2ad69d2c4fa9e83682d1ee1c242ccd5", "message": "test for smart refresh: github, bitbucket and gitlab", "committedDate": "2020-08-04T19:26:16Z", "type": "commit"}, {"oid": "b7ea324b4952749b000ca61bd8dfc311ec97f4d3", "url": "https://github.com/dockstore/dockstore/commit/b7ea324b4952749b000ca61bd8dfc311ec97f4d3", "message": "default tests to soft refresh", "committedDate": "2020-08-04T19:49:59Z", "type": "commit"}, {"oid": "db67e4b2821b7863b717e9008a9c0348881b6448", "url": "https://github.com/dockstore/dockstore/commit/db67e4b2821b7863b717e9008a9c0348881b6448", "message": "changed some more tests", "committedDate": "2020-08-04T19:56:02Z", "type": "commit"}, {"oid": "5a813725e223f62d764b6438144fecc0952e43c5", "url": "https://github.com/dockstore/dockstore/commit/5a813725e223f62d764b6438144fecc0952e43c5", "message": "missed one more", "committedDate": "2020-08-04T19:57:08Z", "type": "commit"}, {"oid": "0506ad484de66e2b4207c6a04cf1da0a13c29032", "url": "https://github.com/dockstore/dockstore/commit/0506ad484de66e2b4207c6a04cf1da0a13c29032", "message": "fix failing migration", "committedDate": "2020-08-04T20:47:11Z", "type": "commit"}, {"oid": "fb9acd121276bbe6bbb519f378f7d34991f16a57", "url": "https://github.com/dockstore/dockstore/commit/fb9acd121276bbe6bbb519f378f7d34991f16a57", "message": "fix failing tests", "committedDate": "2020-08-05T15:15:33Z", "type": "commit"}, {"oid": "aa7d4bd4713f49ef51cd9877fc3c062fc7303c88", "url": "https://github.com/dockstore/dockstore/commit/aa7d4bd4713f49ef51cd9877fc3c062fc7303c88", "message": "change existing versions to be synced", "committedDate": "2020-08-05T17:13:20Z", "type": "commit"}, {"oid": "34d1344489df36a926bdf43e70344c0cbf140041", "url": "https://github.com/dockstore/dockstore/commit/34d1344489df36a926bdf43e70344c0cbf140041", "message": "default to false", "committedDate": "2020-08-05T18:25:05Z", "type": "commit"}, {"oid": "5a1adf0a42a8b927dd1cf6800938f4ab318d97f7", "url": "https://github.com/dockstore/dockstore/commit/5a1adf0a42a8b927dd1cf6800938f4ab318d97f7", "message": "another migration fix", "committedDate": "2020-08-05T19:01:41Z", "type": "commit"}, {"oid": "51398c02a73802ff25c09eb576a3a1bd9d45b58e", "url": "https://github.com/dockstore/dockstore/commit/51398c02a73802ff25c09eb576a3a1bd9d45b58e", "message": "updates from PR comments", "committedDate": "2020-08-06T18:45:23Z", "type": "commit"}, {"oid": "c9b12c62f54cfebb14167d7ce25c0a9d02e04c81", "url": "https://github.com/dockstore/dockstore/commit/c9b12c62f54cfebb14167d7ce25c0a9d02e04c81", "message": "fix filtering", "committedDate": "2020-08-06T18:58:04Z", "type": "commit"}, {"oid": "aae5f436e4a4fc384da3a87d2d244dfd2f4b8dac", "url": "https://github.com/dockstore/dockstore/commit/aae5f436e4a4fc384da3a87d2d244dfd2f4b8dac", "message": "fix failing test", "committedDate": "2020-08-06T20:18:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE2NjI5MA==", "url": "https://github.com/dockstore/dockstore/pull/3720#discussion_r467166290", "bodyText": "Totally optional, but only because it took me a bit to understand this: Either add a comment saying something to the effect that there is no need to change because the version has not changed, or create a function for the if condition whose name represents that.\nI guess the disconnect is that cognitively SKIP_COMMIT_ID != unmodified to me.", "author": "coverbeck", "createdAt": "2020-08-07T17:12:37Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/SourceCodeRepoInterface.java", "diffHunk": "@@ -332,7 +353,9 @@ public void updateEntryMetadata(final Entry<?, ?> entry, final DescriptorLanguag\n             Workflow workflow = (Workflow)entry;\n             workflow.getWorkflowVersions().forEach(workflowVersion -> {\n                 String filePath = workflowVersion.getWorkflowPath();\n-                updateVersionMetadata(filePath, workflowVersion, type, repositoryId);\n+                if (!Objects.equals(SKIP_COMMIT_ID, workflowVersion.getCommitID())) {", "originalCommit": "aae5f436e4a4fc384da3a87d2d244dfd2f4b8dac", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "97114a366ebcd453289fcd2d5ac2489841ac1eb5", "chunk": "diff --git a/dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/SourceCodeRepoInterface.java b/dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/SourceCodeRepoInterface.java\nindex 586d32c13..b5c7c2b48 100644\n--- a/dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/SourceCodeRepoInterface.java\n+++ b/dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/SourceCodeRepoInterface.java\n\n@@ -353,6 +353,7 @@ public abstract class SourceCodeRepoInterface {\n             Workflow workflow = (Workflow)entry;\n             workflow.getWorkflowVersions().forEach(workflowVersion -> {\n                 String filePath = workflowVersion.getWorkflowPath();\n+                // Don't update metadata for versions that have not changed\n                 if (!Objects.equals(SKIP_COMMIT_ID, workflowVersion.getCommitID())) {\n                     updateVersionMetadata(filePath, workflowVersion, type, repositoryId);\n                 }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE2OTk2Nw==", "url": "https://github.com/dockstore/dockstore/pull/3720#discussion_r467169967", "bodyText": "I know I suggested the stream/filter, but by making it a Set there is the possibility that a version may get filtered out that wasn't being filtered before. Probably never happens with our data, but still... I would just get rid of the set and the intermediate variable, and use forEach directly on the stream:\nnewWorkflow.getWorkflowVersions().stream()\n    .filter(workflowVersion -> !Objects.equals(SKIP_COMMIT_ID, workflowVersion.getCommitID()))\n    .forEach(version -> {\n        WorkflowVersion workflowVersionFromDB = existingVersionMap.get(version.getName());\n        ...\n});", "author": "coverbeck", "createdAt": "2020-08-07T17:20:19Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java", "diffHunk": "@@ -166,10 +168,15 @@ protected void updateDBWorkflowWithSourceControlWorkflow(Workflow workflow, Work\n             }\n         }\n \n+        // Remove versions that do not need to be updated\n+        Set<WorkflowVersion> filteredVersions = newWorkflow.getWorkflowVersions().stream().filter(workflowVersion -> !Objects.equals(SKIP_COMMIT_ID, workflowVersion.getCommitID())).collect(", "originalCommit": "aae5f436e4a4fc384da3a87d2d244dfd2f4b8dac", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "97114a366ebcd453289fcd2d5ac2489841ac1eb5", "chunk": "diff --git a/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java b/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java\nindex 55d0920ff..870d467fc 100644\n--- a/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java\n+++ b/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java\n\n@@ -168,36 +167,34 @@ public abstract class AbstractWorkflowResource<T extends Workflow> implements So\n             }\n         }\n \n-        // Remove versions that do not need to be updated\n-        Set<WorkflowVersion> filteredVersions = newWorkflow.getWorkflowVersions().stream().filter(workflowVersion -> !Objects.equals(SKIP_COMMIT_ID, workflowVersion.getCommitID())).collect(\n-                Collectors.toSet());\n-\n-        // Then copy over content that changed\n-        for (WorkflowVersion version : filteredVersions) {\n-            WorkflowVersion workflowVersionFromDB = existingVersionMap.get(version.getName());\n-\n-            // skip frozen versions\n-            if (existingVersionMap.containsKey(version.getName())) {\n-                if (workflowVersionFromDB.isFrozen()) {\n-                    continue;\n-                }\n-                workflowVersionFromDB.update(version);\n-            } else {\n-                // attach real workflow\n-                workflow.addWorkflowVersion(version);\n-\n-                final long workflowVersionId = workflowVersionDAO.create(version);\n-                workflowVersionFromDB = workflowVersionDAO.findById(workflowVersionId);\n-                this.eventDAO.createAddTagToEntryEvent(user, workflow, workflowVersionFromDB);\n-                workflow.getWorkflowVersions().add(workflowVersionFromDB);\n-                existingVersionMap.put(workflowVersionFromDB.getName(), workflowVersionFromDB);\n-            }\n-            workflowVersionFromDB.setToolTableJson(null);\n-            workflowVersionFromDB.setDagJson(null);\n+        // Then copy over content that changed (ignore versions that have not changed)\n+        newWorkflow.getWorkflowVersions().stream()\n+                .filter(workflowVersion -> !Objects.equals(SKIP_COMMIT_ID, workflowVersion.getCommitID()))\n+                .forEach(version -> {\n+                    WorkflowVersion workflowVersionFromDB = existingVersionMap.get(version.getName());\n+\n+                    // skip frozen versions\n+                    if (existingVersionMap.containsKey(version.getName())) {\n+                        if (workflowVersionFromDB.isFrozen()) {\n+                            return;\n+                        }\n+                        workflowVersionFromDB.update(version);\n+                    } else {\n+                        // attach real workflow\n+                        workflow.addWorkflowVersion(version);\n+\n+                        final long workflowVersionId = workflowVersionDAO.create(version);\n+                        workflowVersionFromDB = workflowVersionDAO.findById(workflowVersionId);\n+                        this.eventDAO.createAddTagToEntryEvent(user, workflow, workflowVersionFromDB);\n+                        workflow.getWorkflowVersions().add(workflowVersionFromDB);\n+                        existingVersionMap.put(workflowVersionFromDB.getName(), workflowVersionFromDB);\n+                    }\n+                    workflowVersionFromDB.setToolTableJson(null);\n+                    workflowVersionFromDB.setDagJson(null);\n \n-            // Update sourcefiles\n-            updateDBVersionSourceFilesWithRemoteVersionSourceFiles(workflowVersionFromDB, version);\n-        }\n+                    // Update sourcefiles\n+                    updateDBVersionSourceFilesWithRemoteVersionSourceFiles(workflowVersionFromDB, version);\n+                });\n     }\n \n     /**\n"}}, {"oid": "97114a366ebcd453289fcd2d5ac2489841ac1eb5", "url": "https://github.com/dockstore/dockstore/commit/97114a366ebcd453289fcd2d5ac2489841ac1eb5", "message": "some suggestions from PR", "committedDate": "2020-08-07T20:11:37Z", "type": "commit"}, {"oid": "a9a851bee4b979f47b866fc2d4e4208611fa0502", "url": "https://github.com/dockstore/dockstore/commit/a9a851bee4b979f47b866fc2d4e4208611fa0502", "message": "fix inconsistent test", "committedDate": "2020-08-07T23:07:57Z", "type": "commit"}, {"oid": "e818fad74104b69fd8e0b5c5f02733dd82578fff", "url": "https://github.com/dockstore/dockstore/commit/e818fad74104b69fd8e0b5c5f02733dd82578fff", "message": "use yq 3.3.2", "committedDate": "2020-08-10T15:24:26Z", "type": "commit"}]}