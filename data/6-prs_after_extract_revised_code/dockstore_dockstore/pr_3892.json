{"pr_number": 3892, "pr_title": "use actual GitHub path as testparam path, don't use /test.json by default", "pr_createdAt": "2020-10-28T14:35:35Z", "pr_url": "https://github.com/dockstore/dockstore/pull/3892", "timeline": [{"oid": "dbd46dfe3f2bcc73348381632185abebbae77869", "url": "https://github.com/dockstore/dockstore/commit/dbd46dfe3f2bcc73348381632185abebbae77869", "message": "use actual GitHub path as testparam path, don't use test.json by default", "committedDate": "2020-10-27T21:16:04Z", "type": "commit"}, {"oid": "b0a4fba56486ae1772b00b59215f531383a6162c", "url": "https://github.com/dockstore/dockstore/commit/b0a4fba56486ae1772b00b59215f531383a6162c", "message": "fix duplicate sourceFile detection", "committedDate": "2020-10-28T14:11:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzU5OTI4Nw==", "url": "https://github.com/dockstore/dockstore/pull/3892#discussion_r513599287", "bodyText": "It was like this, but I think you could move this to before line 739, saving the unnecessary reading of the GitHub file and creation of a SourceFile if there actually is a duplicate.\nPerformance-wise, I'm sure it's negligible, and I doubt there are rarely, if ever, any cases of duplicate files like this, but it might make the code slightly easier to read.\nJust nit-picking, and I don't feel super-strongly about this, but just noticed it as I was trying to understand the code.", "author": "coverbeck", "createdAt": "2020-10-28T16:44:17Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/GitHubSourceCodeRepo.java", "diffHunk": "@@ -736,19 +736,19 @@ private WorkflowVersion setupWorkflowFilesForGitHubVersion(Triple<String, Date,\n             if (testParameterPaths != null) {\n                 List<String> missingParamFiles = new ArrayList<>();\n                 for (String testParameterPath : testParameterPaths) {\n-                    String testJsonContent = this.readFileFromRepo(testParameterPath, ref.getLeft(), repository);\n-                    if (testJsonContent != null) {\n-                        SourceFile testJson = new SourceFile();\n-                        // find type from file type, then find matching test param type\n-                        testJson.setType(workflow.getDescriptorType().getTestParamType());\n-                        testJson.setPath(workflow.getDefaultTestParameterFilePath());\n-                        testJson.setAbsolutePath(workflow.getDefaultTestParameterFilePath());\n-                        testJson.setContent(testJsonContent);\n+                    String testFileContent = this.readFileFromRepo(testParameterPath, ref.getLeft(), repository);\n+                    if (testFileContent != null) {\n+                        SourceFile testFile = new SourceFile();\n+                        // find type from file type\n+                        testFile.setType(workflow.getDescriptorType().getTestParamType());\n+                        testFile.setPath(testParameterPath);\n+                        testFile.setAbsolutePath(testParameterPath);\n+                        testFile.setContent(testFileContent);\n \n                         // Only add test parameter file if it hasn't already been added\n-                        boolean hasDuplicate = version.getSourceFiles().stream().anyMatch((SourceFile sf) -> sf.getPath().equals(workflow.getDefaultTestParameterFilePath()) && sf.getType() == testJson.getType());\n+                        boolean hasDuplicate = version.getSourceFiles().stream().anyMatch((SourceFile sf) -> sf.getPath().equals(testFile.getPath()) && sf.getType() == testFile.getType());", "originalCommit": "b0a4fba56486ae1772b00b59215f531383a6162c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMxNDYwNQ==", "url": "https://github.com/dockstore/dockstore/pull/3892#discussion_r515314605", "bodyText": "Addressed in c68e5ae", "author": "GFJHogue", "createdAt": "2020-10-30T18:58:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzU5OTI4Nw=="}], "type": "inlineReview", "revised_code": {"commit": "c68e5aec322769f6c7ae08c3f57c5156a705bd29", "chunk": "diff --git a/dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/GitHubSourceCodeRepo.java b/dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/GitHubSourceCodeRepo.java\nindex 2e4d3bac6..7b46fc787 100644\n--- a/dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/GitHubSourceCodeRepo.java\n+++ b/dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/GitHubSourceCodeRepo.java\n\n@@ -736,6 +736,11 @@ public class GitHubSourceCodeRepo extends SourceCodeRepoInterface {\n             if (testParameterPaths != null) {\n                 List<String> missingParamFiles = new ArrayList<>();\n                 for (String testParameterPath : testParameterPaths) {\n+                    // Only add test parameter file if it hasn't already been added\n+                    boolean hasDuplicate = version.getSourceFiles().stream().anyMatch((SourceFile sf) -> sf.getPath().equals(testParameterPath) && sf.getType() == workflow.getDescriptorType().getTestParamType());\n+                    if (hasDuplicate) {\n+                        continue;\n+                    }\n                     String testFileContent = this.readFileFromRepo(testParameterPath, ref.getLeft(), repository);\n                     if (testFileContent != null) {\n                         SourceFile testFile = new SourceFile();\n"}}, {"oid": "53ecdca1585811524ba3b73d9fba0115f94feba1", "url": "https://github.com/dockstore/dockstore/commit/53ecdca1585811524ba3b73d9fba0115f94feba1", "message": "test .dockstore.yml workflow test param file path", "committedDate": "2020-10-30T18:40:58Z", "type": "commit"}, {"oid": "c68e5aec322769f6c7ae08c3f57c5156a705bd29", "url": "https://github.com/dockstore/dockstore/commit/c68e5aec322769f6c7ae08c3f57c5156a705bd29", "message": "check for duplicate path before reading file from repo", "committedDate": "2020-10-30T18:57:24Z", "type": "commit"}, {"oid": "eb40f8279da2007dbc93b68a307a4c74868439de", "url": "https://github.com/dockstore/dockstore/commit/eb40f8279da2007dbc93b68a307a4c74868439de", "message": "Merge branch 'develop' into feature/3851/dont-assume-json-testparam", "committedDate": "2020-10-30T18:59:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjEwNTI2MQ==", "url": "https://github.com/dockstore/dockstore/pull/3892#discussion_r516105261", "bodyText": "Would also like a test for a Galaxy workflow with a yaml test parameter file to cover our bases\nEdit: can see from above, this is unlikely to catch anything, but just in case", "author": "denis-yuen", "createdAt": "2020-11-02T16:43:22Z", "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/WebhookIT.java", "diffHunk": "@@ -535,6 +535,22 @@ public void testInvalidDockstoreYmlFiles() throws Exception {\n         }\n     }\n \n+    /**\n+     * Test that a .dockstore.yml workflow has the expected path for its test parameter file.\n+     */\n+    @Test\n+    public void testTestParameterPaths() throws Exception {\n+        CommonTestUtilities.cleanStatePrivate2(SUPPORT, false);\n+        final ApiClient webClient = getWebClient(BasicIT.USER_2_USERNAME, testingPostgres);\n+        WorkflowsApi client = new WorkflowsApi(webClient);\n+\n+        client.handleGitHubRelease(workflowRepo, BasicIT.USER_2_USERNAME, \"refs/heads/master\", installationId);\n+        Workflow workflow = client.getWorkflowByPath(\"github.com/\" + workflowRepo + \"/foobar\", \"\", false);\n+        WorkflowVersion version = workflow.getWorkflowVersions().get(0);\n+        List<SourceFile> sourceFiles = fileDAO.findSourceFilesByVersion(version.getId());\n+        assertTrue(\"Test file should have the expected path\", sourceFiles.stream().filter(sourceFile -> sourceFile.getPath().equals(\"/dockstore.wdl.json\")).findFirst().isPresent());", "originalCommit": "eb40f8279da2007dbc93b68a307a4c74868439de", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "4894f0f11f790f5b10f843487644dfba3a872771", "url": "https://github.com/dockstore/dockstore/commit/4894f0f11f790f5b10f843487644dfba3a872771", "message": "add Galaxy test", "committedDate": "2020-11-03T17:53:54Z", "type": "commit"}, {"oid": "0fa1818360910e88142ff3fc11c0b44b3fbecd12", "url": "https://github.com/dockstore/dockstore/commit/0fa1818360910e88142ff3fc11c0b44b3fbecd12", "message": "Merge branch 'develop' into feature/3851/dont-assume-json-testparam", "committedDate": "2020-11-03T17:54:21Z", "type": "commit"}, {"oid": "621264c4f150f9eaa7f6c9d321aced4825e18bd7", "url": "https://github.com/dockstore/dockstore/commit/621264c4f150f9eaa7f6c9d321aced4825e18bd7", "message": "fix checkstyle", "committedDate": "2020-11-03T19:17:35Z", "type": "commit"}, {"oid": "5254876bb4247ca18ab69858c50ae3cdf2e2bbb9", "url": "https://github.com/dockstore/dockstore/commit/5254876bb4247ca18ab69858c50ae3cdf2e2bbb9", "message": "Merge branch 'develop' into feature/3851/dont-assume-json-testparam", "committedDate": "2020-11-03T21:35:33Z", "type": "commit"}]}