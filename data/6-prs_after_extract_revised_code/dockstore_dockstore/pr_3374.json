{"pr_number": 3374, "pr_title": "Feature/3345/default version", "pr_createdAt": "2020-04-03T02:06:44Z", "pr_url": "https://github.com/dockstore/dockstore/pull/3374", "timeline": [{"oid": "af105295225aeab031bc6c8063e571fc4a579c4d", "url": "https://github.com/dockstore/dockstore/commit/af105295225aeab031bc6c8063e571fc4a579c4d", "message": "Add tests, fix behaviour", "committedDate": "2020-04-03T14:44:01Z", "type": "forcePushed"}, {"oid": "9019d398dec60e77bd5b7fac2e85f7f971cc6327", "url": "https://github.com/dockstore/dockstore/commit/9019d398dec60e77bd5b7fac2e85f7f971cc6327", "message": "Remove old function", "committedDate": "2020-04-03T16:13:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI5NDMxMw==", "url": "https://github.com/dockstore/dockstore/pull/3374#discussion_r403294313", "bodyText": "Thinking it might be better to just choose the newest version available and setting that to the default version (in the case that there is at least one left).", "author": "denis-yuen", "createdAt": "2020-04-03T20:08:22Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractHostedEntryResource.java", "diffHunk": "@@ -361,6 +364,10 @@ public T deleteHostedVersion(@ApiParam(hidden = true) @Auth User user,\n         checkEntry(entry);\n         checkUserCanUpdate(user, entry);\n         checkHosted(entry);\n+        // If the version that's about to be deleted is the default version, unset it\n+        if (entry.getActualDefaultVersion().getName().equals(version)) {\n+            entry.setActualDefaultVersion(null);", "originalCommit": "9019d398dec60e77bd5b7fac2e85f7f971cc6327", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM0MjIzMQ==", "url": "https://github.com/dockstore/dockstore/pull/3374#discussion_r403342231", "bodyText": "Ok, that's do-able", "author": "garyluu", "createdAt": "2020-04-03T21:21:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI5NDMxMw=="}], "type": "inlineReview", "revised_code": {"commit": "7a54d598d3183efa827f654328b705dc7ef5cb26", "chunk": "diff --git a/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractHostedEntryResource.java b/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractHostedEntryResource.java\nindex 94f605f1a..c997f3b25 100644\n--- a/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractHostedEntryResource.java\n+++ b/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractHostedEntryResource.java\n\n@@ -366,7 +366,9 @@ public abstract class AbstractHostedEntryResource<T extends Entry<T, U>, U exten\n         checkHosted(entry);\n         // If the version that's about to be deleted is the default version, unset it\n         if (entry.getActualDefaultVersion().getName().equals(version)) {\n-            entry.setActualDefaultVersion(null);\n+            Optional<U> max = entry.getWorkflowVersions().stream().filter(v -> !Objects.equals(v.getName(), version))\n+                    .max(Comparator.comparingLong(ver -> ver.getDate().getTime()));\n+            entry.setActualDefaultVersion(max.orElse(null));\n         }\n         entry.getWorkflowVersions().removeIf(v -> Objects.equals(v.getName(), version));\n         PublicStateManager.getInstance().handleIndexUpdate(entry, StateManagerMode.UPDATE);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMwMDgwNg==", "url": "https://github.com/dockstore/dockstore/pull/3374#discussion_r403300806", "bodyText": "This is changing from the default always being the most recent to being \"sticky\".\nThoughts?", "author": "denis-yuen", "createdAt": "2020-04-03T20:17:20Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractHostedEntryResource.java", "diffHunk": "@@ -238,10 +238,13 @@ T saveVersion(User user, Long entryId, T entry, U version, Set<SourceFile> versi\n         validatedVersion.setParent(entry);\n         long l = getVersionDAO().create(validatedVersion);\n         entry.getWorkflowVersions().add(getVersionDAO().findById(l));\n-        entry.checkAndSetDefaultVersion(validatedVersion.getName());\n+        // Only set if the default version isn't already there\n+        if (entry.getDefaultVersion() == null) {", "originalCommit": "9019d398dec60e77bd5b7fac2e85f7f971cc6327", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM0MTk0OA==", "url": "https://github.com/dockstore/dockstore/pull/3374#discussion_r403341948", "bodyText": "I think the problem was that the user keeps refreshing the entire organization and the UI would change the implicit default version to the most recent one (which they did not want).  This will set the default version to the most recent one once.  If it's the wrong one they can just change it to whatever.\nFor hosted ones, we also want to avoid changing too often (like if they were doing small modifications for testing purposes)", "author": "garyluu", "createdAt": "2020-04-03T21:20:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMwMDgwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM0NDE5MQ==", "url": "https://github.com/dockstore/dockstore/pull/3374#discussion_r403344191", "bodyText": "seems reasonable, pinging @coverbeck @wshands for thoughts", "author": "denis-yuen", "createdAt": "2020-04-03T21:26:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMwMDgwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM5NDQwOQ==", "url": "https://github.com/dockstore/dockstore/pull/3374#discussion_r403394409", "bodyText": "Agreed, the implicit default version has led to confusion with Terra team.", "author": "coverbeck", "createdAt": "2020-04-04T00:23:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMwMDgwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg0NTkyOQ==", "url": "https://github.com/dockstore/dockstore/pull/3374#discussion_r406845929", "bodyText": "I agree", "author": "wshands", "createdAt": "2020-04-10T16:55:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMwMDgwNg=="}], "type": "inlineReview", "revised_code": {"commit": "2f8fd2b1cf104cc116ca9bb9da4a9234ed117b5f", "chunk": "diff --git a/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractHostedEntryResource.java b/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractHostedEntryResource.java\nindex 94f605f1a..c302b9929 100644\n--- a/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractHostedEntryResource.java\n+++ b/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractHostedEntryResource.java\n\n@@ -238,13 +238,10 @@ public abstract class AbstractHostedEntryResource<T extends Entry<T, U>, U exten\n         validatedVersion.setParent(entry);\n         long l = getVersionDAO().create(validatedVersion);\n         entry.getWorkflowVersions().add(getVersionDAO().findById(l));\n-        // Only set if the default version isn't already there\n-        if (entry.getDefaultVersion() == null) {\n-            entry.checkAndSetDefaultVersion(validatedVersion.getName());\n-        }\n+        entry.checkAndSetDefaultVersion(validatedVersion.getName());\n         // Set entry-level metadata to this latest version\n         // TODO: handle when latest version is removed\n-        entry.setActualDefaultVersion(validatedVersion);\n+        entry.setDefaultVersion(validatedVersion.getName());\n         entry.syncMetadataWithDefault();\n         FileFormatHelper.updateFileFormats(entry.getWorkflowVersions(), fileFormatDAO);\n         // TODO: Not setting lastModified for hosted tools now because we plan to get rid of the lastmodified column in Tool table in the future.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMxMjcyMQ==", "url": "https://github.com/dockstore/dockstore/pull/3374#discussion_r403312721", "bodyText": "Not sure this is the right date to sort on. This is generated by the DB with @UpdateTimestamp\nI think this means that it will change when something like frozen is set.", "author": "denis-yuen", "createdAt": "2020-04-03T20:32:54Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/SourceCodeRepoInterface.java", "diffHunk": "@@ -354,7 +363,10 @@ public void setDefaultBranchIfNotSet(Entry entry, String repositoryId) {\n                             String reference = workflowVersion.getReference();\n                             return branch.equals(reference);\n                         }).findFirst();\n-                firstWorkflowVersion.ifPresent(version -> entry.checkAndSetDefaultVersion(version.getName()));\n+                firstWorkflowVersion.ifPresentOrElse(version -> entry.checkAndSetDefaultVersion(version.getName()), () -> {\n+                    Version newestVersion = Collections.max(workflowVersions, Comparator.comparingInt(s -> s.getDbUpdateDate().getNanos()));", "originalCommit": "9019d398dec60e77bd5b7fac2e85f7f971cc6327", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM0NDUyOQ==", "url": "https://github.com/dockstore/dockstore/pull/3374#discussion_r403344529", "bodyText": "do you think lastBuilt for tags and lastModified for workflowversion is better?", "author": "garyluu", "createdAt": "2020-04-03T21:27:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMxMjcyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM0OTgwNg==", "url": "https://github.com/dockstore/dockstore/pull/3374#discussion_r403349806", "bodyText": "Looking at \"Dates/Timestamps in Database for Tools and Workflows\" in the shared drive, looks like yes", "author": "denis-yuen", "createdAt": "2020-04-03T21:40:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMxMjcyMQ=="}], "type": "inlineReview", "revised_code": {"commit": "7a54d598d3183efa827f654328b705dc7ef5cb26", "chunk": "diff --git a/dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/SourceCodeRepoInterface.java b/dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/SourceCodeRepoInterface.java\nindex a19507651..0076f341e 100644\n--- a/dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/SourceCodeRepoInterface.java\n+++ b/dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/SourceCodeRepoInterface.java\n\n@@ -364,7 +364,7 @@ public abstract class SourceCodeRepoInterface {\n                             return branch.equals(reference);\n                         }).findFirst();\n                 firstWorkflowVersion.ifPresentOrElse(version -> entry.checkAndSetDefaultVersion(version.getName()), () -> {\n-                    Version newestVersion = Collections.max(workflowVersions, Comparator.comparingInt(s -> s.getDbUpdateDate().getNanos()));\n+                    Version newestVersion = Collections.max(workflowVersions, Comparator.comparingLong(s -> s.getDate().getTime()));\n                     entry.setActualDefaultVersion(newestVersion);\n                 });\n             }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM5MzEyOQ==", "url": "https://github.com/dockstore/dockstore/pull/3374#discussion_r403393129", "bodyText": "Can you put the implementation in entry? Looks like the Tool and Workflow implementations are identical.", "author": "coverbeck", "createdAt": "2020-04-04T00:16:46Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/core/Tool.java", "diffHunk": "@@ -158,6 +166,25 @@ public Tool(long id, String name) {\n         workflowVersions = new TreeSet<>();\n     }\n \n+    @Override\n+    public String getDefaultVersion() {", "originalCommit": "bbe44d9bf10f44793d50f24455b98c312287ee02", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7a54d598d3183efa827f654328b705dc7ef5cb26", "chunk": "diff --git a/dockstore-webservice/src/main/java/io/dockstore/webservice/core/Tool.java b/dockstore-webservice/src/main/java/io/dockstore/webservice/core/Tool.java\nindex 8d1090170..f673ac8c0 100644\n--- a/dockstore-webservice/src/main/java/io/dockstore/webservice/core/Tool.java\n+++ b/dockstore-webservice/src/main/java/io/dockstore/webservice/core/Tool.java\n\n@@ -166,15 +166,6 @@ public class Tool extends Entry<Tool, Tag> {\n         workflowVersions = new TreeSet<>();\n     }\n \n-    @Override\n-    public String getDefaultVersion() {\n-        if (this.getActualDefaultVersion() != null) {\n-            return this.getActualDefaultVersion().getName();\n-        } else {\n-            return null;\n-        }\n-    }\n-\n     @Override\n     public void setActualDefaultVersion(Tag version) {\n         this.actualDefaultVersion = version;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM5NTY3OA==", "url": "https://github.com/dockstore/dockstore/pull/3374#discussion_r403395678", "bodyText": "Shouldn't the filter be !Object.equals(...? You're trying to grab the max date of all versions excluding the version you're about to delete?", "author": "coverbeck", "createdAt": "2020-04-04T00:30:05Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractHostedEntryResource.java", "diffHunk": "@@ -361,6 +364,12 @@ public T deleteHostedVersion(@ApiParam(hidden = true) @Auth User user,\n         checkEntry(entry);\n         checkUserCanUpdate(user, entry);\n         checkHosted(entry);\n+        // If the version that's about to be deleted is the default version, unset it\n+        if (entry.getActualDefaultVersion().getName().equals(version)) {\n+            Optional<U> max = entry.getWorkflowVersions().stream().filter(v -> Objects.equals(v.getName(), version))", "originalCommit": "bbe44d9bf10f44793d50f24455b98c312287ee02", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7a54d598d3183efa827f654328b705dc7ef5cb26", "chunk": "diff --git a/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractHostedEntryResource.java b/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractHostedEntryResource.java\nindex 6b5125348..c997f3b25 100644\n--- a/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractHostedEntryResource.java\n+++ b/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractHostedEntryResource.java\n\n@@ -366,7 +366,7 @@ public abstract class AbstractHostedEntryResource<T extends Entry<T, U>, U exten\n         checkHosted(entry);\n         // If the version that's about to be deleted is the default version, unset it\n         if (entry.getActualDefaultVersion().getName().equals(version)) {\n-            Optional<U> max = entry.getWorkflowVersions().stream().filter(v -> Objects.equals(v.getName(), version))\n+            Optional<U> max = entry.getWorkflowVersions().stream().filter(v -> !Objects.equals(v.getName(), version))\n                     .max(Comparator.comparingLong(ver -> ver.getDate().getTime()));\n             entry.setActualDefaultVersion(max.orElse(null));\n         }\n"}}, {"oid": "7a54d598d3183efa827f654328b705dc7ef5cb26", "url": "https://github.com/dockstore/dockstore/commit/7a54d598d3183efa827f654328b705dc7ef5cb26", "message": "Simplify", "committedDate": "2020-04-06T14:46:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE5MDIyOA==", "url": "https://github.com/dockstore/dockstore/pull/3374#discussion_r404190228", "bodyText": "Why call this actual default version instead of just default version?", "author": "agduncan94", "createdAt": "2020-04-06T15:39:03Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/core/Tool.java", "diffHunk": "@@ -143,6 +146,11 @@\n     @Cascade(CascadeType.DETACH)\n     private final SortedSet<Tag> workflowVersions;\n \n+    @JsonIgnore\n+    @OneToOne(targetEntity = Tag.class, fetch = FetchType.LAZY)\n+    @JoinColumn(name = \"actualDefaultVersion\", referencedColumnName = \"id\")", "originalCommit": "7a54d598d3183efa827f654328b705dc7ef5cb26", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE5MzM5Nw==", "url": "https://github.com/dockstore/dockstore/pull/3374#discussion_r404193397", "bodyText": "it already exists", "author": "garyluu", "createdAt": "2020-04-06T15:43:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE5MDIyOA=="}], "type": "inlineReview", "revised_code": {"commit": "2f8fd2b1cf104cc116ca9bb9da4a9234ed117b5f", "chunk": "diff --git a/dockstore-webservice/src/main/java/io/dockstore/webservice/core/Tool.java b/dockstore-webservice/src/main/java/io/dockstore/webservice/core/Tool.java\nindex f673ac8c0..a7852355a 100644\n--- a/dockstore-webservice/src/main/java/io/dockstore/webservice/core/Tool.java\n+++ b/dockstore-webservice/src/main/java/io/dockstore/webservice/core/Tool.java\n\n@@ -146,15 +147,15 @@ public class Tool extends Entry<Tool, Tag> {\n     @Cascade(CascadeType.DETACH)\n     private final SortedSet<Tag> workflowVersions;\n \n-    @JsonIgnore\n-    @OneToOne(targetEntity = Tag.class, fetch = FetchType.LAZY)\n-    @JoinColumn(name = \"actualDefaultVersion\", referencedColumnName = \"id\")\n-    private Tag actualDefaultVersion;\n-\n     @Transient\n     @JsonProperty\n     private Set<Tag> tags = null;\n \n+    @JsonIgnore\n+    @OneToOne(targetEntity = Tag.class, fetch = FetchType.LAZY)\n+    @JoinColumn(name = \"actualDefaultVersion\", referencedColumnName = \"id\", foreignKey = @ForeignKey(name = \"fk_tool_default_tag\"))\n+    private Tag actualDefaultVersion;\n+\n     public Tool() {\n         workflowVersions = new TreeSet<>();\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE5MTI1Ng==", "url": "https://github.com/dockstore/dockstore/pull/3374#discussion_r404191256", "bodyText": "Removing this might break the CLI. Can you confirm if this is the case or not?\n(and how broken or not it is)", "author": "denis-yuen", "createdAt": "2020-04-06T15:40:26Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/core/Entry.java", "diffHunk": "@@ -136,10 +136,6 @@\n     @ApiModelProperty(value = \"This is the email of the git organization\", position = 6)\n     private String email;\n \n-    @Column", "originalCommit": "7a54d598d3183efa827f654328b705dc7ef5cb26", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIwMDgwNg==", "url": "https://github.com/dockstore/dockstore/pull/3374#discussion_r404200806", "bodyText": "CLI and the UI is based on the swagger.yaml . I made sure to not alter it. It seems unlikely to break.", "author": "garyluu", "createdAt": "2020-04-06T15:53:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE5MTI1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "2f8fd2b1cf104cc116ca9bb9da4a9234ed117b5f", "chunk": "diff --git a/dockstore-webservice/src/main/java/io/dockstore/webservice/core/Entry.java b/dockstore-webservice/src/main/java/io/dockstore/webservice/core/Entry.java\nindex dbb477de5..5b21064ab 100644\n--- a/dockstore-webservice/src/main/java/io/dockstore/webservice/core/Entry.java\n+++ b/dockstore-webservice/src/main/java/io/dockstore/webservice/core/Entry.java\n\n@@ -136,6 +136,10 @@ public abstract class Entry<S extends Entry, T extends Version> implements Compa\n     @ApiModelProperty(value = \"This is the email of the git organization\", position = 6)\n     private String email;\n \n+    @Column\n+    @ApiModelProperty(value = \"This is the default version of the entry\", position = 7)\n+    private String defaultVersion;\n+\n     @Column\n     @JsonProperty(\"is_published\")\n     @ApiModelProperty(value = \"Implementation specific visibility in this web service\", position = 8)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE5MzQ2MQ==", "url": "https://github.com/dockstore/dockstore/pull/3374#discussion_r404193461", "bodyText": "Javadoc this (looks like a date for the underlying content, whether descriptor files or docker image) and", "author": "denis-yuen", "createdAt": "2020-04-06T15:43:21Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/core/Version.java", "diffHunk": "@@ -195,6 +196,9 @@ public String getVerifiedSource() {\n         }\n     }\n \n+    @JsonIgnore", "originalCommit": "7a54d598d3183efa827f654328b705dc7ef5cb26", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "768557fc142437cb91464668164917e1298d3c70", "chunk": "diff --git a/dockstore-webservice/src/main/java/io/dockstore/webservice/core/Version.java b/dockstore-webservice/src/main/java/io/dockstore/webservice/core/Version.java\nindex e094ec756..5743311c5 100644\n--- a/dockstore-webservice/src/main/java/io/dockstore/webservice/core/Version.java\n+++ b/dockstore-webservice/src/main/java/io/dockstore/webservice/core/Version.java\n\n@@ -196,6 +196,10 @@ public abstract class Version<T extends Version> implements Comparable<T> {\n         }\n     }\n \n+    /**\n+     * Used to determine the \"newer\" version. WorkflowVersion relies on last_modified, Tag relies on last_built.\n+     * @return  The date used to determine the \"newer\" version\n+     */\n     @JsonIgnore\n     public abstract Date getDate();\n \n"}}, {"oid": "768557fc142437cb91464668164917e1298d3c70", "url": "https://github.com/dockstore/dockstore/commit/768557fc142437cb91464668164917e1298d3c70", "message": "Add comment", "committedDate": "2020-04-06T16:26:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc2MzI1OQ==", "url": "https://github.com/dockstore/dockstore/pull/3374#discussion_r405763259", "bodyText": "I feel like we should give the user with a warning that they're deleting the default version so we're setting the new default to latest. Maybe we should log this message to surface in the UI?", "author": "Ldcabansay", "createdAt": "2020-04-08T19:31:10Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractHostedEntryResource.java", "diffHunk": "@@ -361,6 +364,12 @@ public T deleteHostedVersion(@ApiParam(hidden = true) @Auth User user,\n         checkEntry(entry);\n         checkUserCanUpdate(user, entry);\n         checkHosted(entry);\n+        // If the version that's about to be deleted is the default version, unset it\n+        if (entry.getActualDefaultVersion().getName().equals(version)) {\n+            Optional<U> max = entry.getWorkflowVersions().stream().filter(v -> !Objects.equals(v.getName(), version))\n+                    .max(Comparator.comparingLong(ver -> ver.getDate().getTime()));\n+            entry.setActualDefaultVersion(max.orElse(null));", "originalCommit": "768557fc142437cb91464668164917e1298d3c70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc2NTg0OA==", "url": "https://github.com/dockstore/dockstore/pull/3374#discussion_r405765848", "bodyText": "@garyluu please create a follow-up ticket", "author": "denis-yuen", "createdAt": "2020-04-08T19:36:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc2MzI1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc4Mzc5Ng==", "url": "https://github.com/dockstore/dockstore/pull/3374#discussion_r405783796", "bodyText": "#3381", "author": "garyluu", "createdAt": "2020-04-08T20:09:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc2MzI1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "2f8fd2b1cf104cc116ca9bb9da4a9234ed117b5f", "chunk": "diff --git a/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractHostedEntryResource.java b/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractHostedEntryResource.java\nindex c997f3b25..c302b9929 100644\n--- a/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractHostedEntryResource.java\n+++ b/dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractHostedEntryResource.java\n\n@@ -364,12 +361,6 @@ public abstract class AbstractHostedEntryResource<T extends Entry<T, U>, U exten\n         checkEntry(entry);\n         checkUserCanUpdate(user, entry);\n         checkHosted(entry);\n-        // If the version that's about to be deleted is the default version, unset it\n-        if (entry.getActualDefaultVersion().getName().equals(version)) {\n-            Optional<U> max = entry.getWorkflowVersions().stream().filter(v -> !Objects.equals(v.getName(), version))\n-                    .max(Comparator.comparingLong(ver -> ver.getDate().getTime()));\n-            entry.setActualDefaultVersion(max.orElse(null));\n-        }\n         entry.getWorkflowVersions().removeIf(v -> Objects.equals(v.getName(), version));\n         PublicStateManager.getInstance().handleIndexUpdate(entry, StateManagerMode.UPDATE);\n         return entry;\n"}}, {"oid": "2f8fd2b1cf104cc116ca9bb9da4a9234ed117b5f", "url": "https://github.com/dockstore/dockstore/commit/2f8fd2b1cf104cc116ca9bb9da4a9234ed117b5f", "message": "Add new column, temporarily add new property", "committedDate": "2020-04-08T21:26:13Z", "type": "commit"}, {"oid": "042657f5385ae2385d8e263a09c173d2559b10ab", "url": "https://github.com/dockstore/dockstore/commit/042657f5385ae2385d8e263a09c173d2559b10ab", "message": "Overwrite previous default version", "committedDate": "2020-04-08T21:26:13Z", "type": "commit"}, {"oid": "3d34d7611b6fffc6c23951326c5517a77b1e48b3", "url": "https://github.com/dockstore/dockstore/commit/3d34d7611b6fffc6c23951326c5517a77b1e48b3", "message": "Fix", "committedDate": "2020-04-08T21:26:13Z", "type": "commit"}, {"oid": "c5c5331b4b57fd42d8ae9cb13b135baa19ffb77e", "url": "https://github.com/dockstore/dockstore/commit/c5c5331b4b57fd42d8ae9cb13b135baa19ffb77e", "message": "Migrate to new column", "committedDate": "2020-04-08T21:26:13Z", "type": "commit"}, {"oid": "be1caa552a60e8824db93e32ea6d09fcdd64e513", "url": "https://github.com/dockstore/dockstore/commit/be1caa552a60e8824db93e32ea6d09fcdd64e513", "message": "Remove old column", "committedDate": "2020-04-08T21:26:53Z", "type": "commit"}, {"oid": "d6a7e24ac648eaa1ac1f2aa24d6cdfba3338173c", "url": "https://github.com/dockstore/dockstore/commit/d6a7e24ac648eaa1ac1f2aa24d6cdfba3338173c", "message": "Fix one test", "committedDate": "2020-04-08T21:26:53Z", "type": "commit"}, {"oid": "9337609ce452b9adfc12ad7efe5c4e990ae4a4c5", "url": "https://github.com/dockstore/dockstore/commit/9337609ce452b9adfc12ad7efe5c4e990ae4a4c5", "message": "Fix some tests", "committedDate": "2020-04-08T21:26:54Z", "type": "commit"}, {"oid": "6c01af057ff72a16463a2b16c46e652b07e030b7", "url": "https://github.com/dockstore/dockstore/commit/6c01af057ff72a16463a2b16c46e652b07e030b7", "message": "Remove old function", "committedDate": "2020-04-08T21:26:54Z", "type": "commit"}, {"oid": "193a6c187086afb77a9a4b873ee9144a43d2fad0", "url": "https://github.com/dockstore/dockstore/commit/193a6c187086afb77a9a4b873ee9144a43d2fad0", "message": "Change how recentVersion is determined", "committedDate": "2020-04-08T21:26:54Z", "type": "commit"}, {"oid": "70eaab0ef73e63aedabbcdca611b2a414fb440f8", "url": "https://github.com/dockstore/dockstore/commit/70eaab0ef73e63aedabbcdca611b2a414fb440f8", "message": "Try getting newest version", "committedDate": "2020-04-08T21:26:54Z", "type": "commit"}, {"oid": "398c8919b20deb29ccdf5ad4db671231d725ac15", "url": "https://github.com/dockstore/dockstore/commit/398c8919b20deb29ccdf5ad4db671231d725ac15", "message": "Simplify", "committedDate": "2020-04-08T21:26:54Z", "type": "commit"}, {"oid": "15bc0c33f1ba355a281a98ea6b61a2ae3a7059c3", "url": "https://github.com/dockstore/dockstore/commit/15bc0c33f1ba355a281a98ea6b61a2ae3a7059c3", "message": "Add comment", "committedDate": "2020-04-08T21:26:54Z", "type": "commit"}, {"oid": "15bc0c33f1ba355a281a98ea6b61a2ae3a7059c3", "url": "https://github.com/dockstore/dockstore/commit/15bc0c33f1ba355a281a98ea6b61a2ae3a7059c3", "message": "Add comment", "committedDate": "2020-04-08T21:26:54Z", "type": "forcePushed"}, {"oid": "98b6971b19cea2e5131aae4892aac7671eb0ea0e", "url": "https://github.com/dockstore/dockstore/commit/98b6971b19cea2e5131aae4892aac7671eb0ea0e", "message": "Merge branch 'develop' into feature/3345/defaultVersion", "committedDate": "2020-04-09T17:52:42Z", "type": "commit"}]}