{"pr_number": 3339, "pr_title": "Remove some unnecessary properties from ES", "pr_createdAt": "2020-03-20T21:31:20Z", "pr_url": "https://github.com/dockstore/dockstore/pull/3339", "timeline": [{"oid": "67fde30986c3776bd61a5c2ed5e8c8d5098e7864", "url": "https://github.com/dockstore/dockstore/commit/67fde30986c3776bd61a5c2ed5e8c8d5098e7864", "message": "Remove some unnecessary properties from ES", "committedDate": "2020-03-20T21:29:42Z", "type": "commit"}, {"oid": "22289dd14e415ced77fe7d93e82fcc1fc90c25d5", "url": "https://github.com/dockstore/dockstore/commit/22289dd14e415ced77fe7d93e82fcc1fc90c25d5", "message": "Generate another object instead of trying to detach Hibernate", "committedDate": "2020-03-21T00:46:31Z", "type": "commit"}, {"oid": "92267398402fc0f0d6f737eb4761e6632316005a", "url": "https://github.com/dockstore/dockstore/commit/92267398402fc0f0d6f737eb4761e6632316005a", "message": "Add aliases", "committedDate": "2020-03-23T15:04:23Z", "type": "commit"}, {"oid": "89affa96b317949c1336b11b7167434916b42460", "url": "https://github.com/dockstore/dockstore/commit/89affa96b317949c1336b11b7167434916b42460", "message": "Remove description too", "committedDate": "2020-03-23T18:16:25Z", "type": "commit"}, {"oid": "4f9ea45962281940ef8475af0f31089f9008f409", "url": "https://github.com/dockstore/dockstore/commit/4f9ea45962281940ef8475af0f31089f9008f409", "message": "Fix for missing workflow project links", "committedDate": "2020-03-23T18:22:31Z", "type": "commit"}, {"oid": "49c7bd03269b1610ac9fb3da002594bc1f012511", "url": "https://github.com/dockstore/dockstore/commit/49c7bd03269b1610ac9fb3da002594bc1f012511", "message": "Cleanup + add simple test", "committedDate": "2020-03-23T19:57:10Z", "type": "commit"}, {"oid": "fab3156dd5f320bc4dcc230d2f84e3732ba0e6b9", "url": "https://github.com/dockstore/dockstore/commit/fab3156dd5f320bc4dcc230d2f84e3732ba0e6b9", "message": "Fix checkstyle", "committedDate": "2020-03-23T20:03:56Z", "type": "commit"}, {"oid": "56ff6d682be0faf1e751078771c255521fd13316", "url": "https://github.com/dockstore/dockstore/commit/56ff6d682be0faf1e751078771c255521fd13316", "message": "Fix tag cloud", "committedDate": "2020-03-23T20:19:40Z", "type": "commit"}, {"oid": "eb72a9385f14ef18e5979c7d6d21d7de104dbbeb", "url": "https://github.com/dockstore/dockstore/commit/eb72a9385f14ef18e5979c7d6d21d7de104dbbeb", "message": "Merge branch 'fix/3337/ESReduceIndexing' of github.com:dockstore/dockstore into fix/3337/ESReduceIndexing", "committedDate": "2020-03-23T20:19:52Z", "type": "commit"}, {"oid": "e70ecb5ebfe7c8049b95f0b439c4017abb0b1f3d", "url": "https://github.com/dockstore/dockstore/commit/e70ecb5ebfe7c8049b95f0b439c4017abb0b1f3d", "message": "Fix tests", "committedDate": "2020-03-23T20:27:01Z", "type": "commit"}, {"oid": "d3f8bae12e8413f4a38409f5fce004986c3da631", "url": "https://github.com/dockstore/dockstore/commit/d3f8bae12e8413f4a38409f5fce004986c3da631", "message": "Ignore Gitlab tests for now", "committedDate": "2020-03-23T22:45:11Z", "type": "commit"}, {"oid": "986752a69c2c5fed864308507bfd63863ea69afd", "url": "https://github.com/dockstore/dockstore/commit/986752a69c2c5fed864308507bfd63863ea69afd", "message": "Clone workflowversions too", "committedDate": "2020-03-24T15:24:57Z", "type": "commit"}, {"oid": "ea154b9e5ef437c76162c53b624bf40b94d479b9", "url": "https://github.com/dockstore/dockstore/commit/ea154b9e5ef437c76162c53b624bf40b94d479b9", "message": "Update verified", "committedDate": "2020-03-24T15:34:54Z", "type": "commit"}, {"oid": "69f8cd9e1c9996b72343e2dba561a01d364c1b9d", "url": "https://github.com/dockstore/dockstore/commit/69f8cd9e1c9996b72343e2dba561a01d364c1b9d", "message": "Fix test", "committedDate": "2020-03-24T16:05:14Z", "type": "commit"}, {"oid": "fd69562caeae5a5fa05b22badbe3dec15438007b", "url": "https://github.com/dockstore/dockstore/commit/fd69562caeae5a5fa05b22badbe3dec15438007b", "message": "Fix file formats", "committedDate": "2020-03-24T19:32:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUwMDYzMw==", "url": "https://github.com/dockstore/dockstore/pull/3339#discussion_r397500633", "bodyText": "I guess there are few enough services at this point where this is not an issue? I feel like it should eventually be tackled, but I believe you're rewriting the whole thing for 1.9?", "author": "coverbeck", "createdAt": "2020-03-24T22:29:42Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/statelisteners/ElasticListener.java", "diffHunk": "@@ -228,16 +232,110 @@ private String getNDJSON(List<Entry> publishedEntries) {\n      * @return The Elasticsearch object string to be placed into the index\n      * @throws IOException  Mapper problems\n      */\n-    public static JsonNode dockstoreEntryToElasticSearchObject(Entry entry) throws IOException {\n+    public static JsonNode dockstoreEntryToElasticSearchObject(final Entry entry) throws IOException {\n         Set<Version> workflowVersions = entry.getWorkflowVersions();\n         boolean verified = workflowVersions.stream().anyMatch(Version::isVerified);\n         Set<String> verifiedPlatforms = getVerifiedPlatforms(workflowVersions);\n-        JsonNode jsonNode = MAPPER.readTree(MAPPER.writeValueAsString(entry));\n+        Entry detachedEntry = removeIrrelevantProperties(entry);\n+        JsonNode jsonNode = MAPPER.readTree(MAPPER.writeValueAsString(detachedEntry));\n         ((ObjectNode)jsonNode).put(\"verified\", verified);\n         ((ObjectNode)jsonNode).put(\"verified_platforms\", MAPPER.valueToTree(verifiedPlatforms));\n         return jsonNode;\n     }\n \n+    /**\n+     * Remove some stuff that should not be indexed by ES.\n+     * This is not ideal, we should be including things we want indexed, not removing.\n+     * @param entry\n+     */\n+    private static Entry removeIrrelevantProperties(final Entry entry) {\n+        Entry detachedEntry;\n+        if (entry instanceof Tool) {\n+            Tool tool = (Tool) entry;\n+            Tool detachedTool = new Tool();\n+            tool.getWorkflowVersions().forEach(version -> {\n+                Hibernate.initialize(version.getSourceFiles());\n+            });\n+\n+            // These are for facets\n+            detachedTool.setDefaultWdlPath(tool.getDefaultWdlPath());\n+            detachedTool.setDefaultCwlPath(tool.getDefaultCwlPath());\n+            detachedTool.setNamespace(tool.getNamespace());\n+            detachedTool.setRegistry(tool.getRegistry());\n+            detachedTool.setPrivateAccess(tool.isPrivateAccess());\n+\n+            // These are for table\n+            detachedTool.setGitUrl(tool.getGitUrl());\n+            detachedTool.setName(tool.getName());\n+            detachedTool.setToolname(tool.getToolname());\n+            detachedEntry = detachedTool;\n+        } else if (entry instanceof BioWorkflow) {\n+            BioWorkflow bioWorkflow = (BioWorkflow) entry;\n+            BioWorkflow detachedBioWorkflow = new BioWorkflow();\n+            // These are for facets\n+            detachedBioWorkflow.setDescriptorType(bioWorkflow.getDescriptorType());\n+            detachedBioWorkflow.setSourceControl(bioWorkflow.getSourceControl());\n+            detachedBioWorkflow.setOrganization(bioWorkflow.getOrganization());\n+\n+            // These are for table\n+            detachedBioWorkflow.setWorkflowName(bioWorkflow.getWorkflowName());\n+            detachedBioWorkflow.setRepository(bioWorkflow.getRepository());\n+            detachedBioWorkflow.setGitUrl(bioWorkflow.getGitUrl());\n+            detachedEntry = detachedBioWorkflow;\n+        } else {\n+            return entry;", "originalCommit": "fd69562caeae5a5fa05b22badbe3dec15438007b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUwNzA3Mw==", "url": "https://github.com/dockstore/dockstore/pull/3339#discussion_r397507073", "bodyText": "Rewriting in the context of GitHub apps? I don't think that will affect this aspect of things", "author": "denis-yuen", "createdAt": "2020-03-24T22:46:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUwMDYzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUxMTE1NQ==", "url": "https://github.com/dockstore/dockstore/pull/3339#discussion_r397511155", "bodyText": "I meant for ES itself -- I thought @garyluu mentioned something about changing the index or indexes. I don't know ES API at all, but it seems like you should be able to index the source files and still not have a huge response when requests are made from the client.", "author": "coverbeck", "createdAt": "2020-03-24T22:56:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUwMDYzMw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUwMTEyMg==", "url": "https://github.com/dockstore/dockstore/pull/3339#discussion_r397501122", "bodyText": "How many workflows/tools is this an issue for?", "author": "coverbeck", "createdAt": "2020-03-24T22:30:58Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/statelisteners/ElasticListener.java", "diffHunk": "@@ -228,16 +232,110 @@ private String getNDJSON(List<Entry> publishedEntries) {\n      * @return The Elasticsearch object string to be placed into the index\n      * @throws IOException  Mapper problems\n      */\n-    public static JsonNode dockstoreEntryToElasticSearchObject(Entry entry) throws IOException {\n+    public static JsonNode dockstoreEntryToElasticSearchObject(final Entry entry) throws IOException {\n         Set<Version> workflowVersions = entry.getWorkflowVersions();\n         boolean verified = workflowVersions.stream().anyMatch(Version::isVerified);\n         Set<String> verifiedPlatforms = getVerifiedPlatforms(workflowVersions);\n-        JsonNode jsonNode = MAPPER.readTree(MAPPER.writeValueAsString(entry));\n+        Entry detachedEntry = removeIrrelevantProperties(entry);\n+        JsonNode jsonNode = MAPPER.readTree(MAPPER.writeValueAsString(detachedEntry));\n         ((ObjectNode)jsonNode).put(\"verified\", verified);\n         ((ObjectNode)jsonNode).put(\"verified_platforms\", MAPPER.valueToTree(verifiedPlatforms));\n         return jsonNode;\n     }\n \n+    /**\n+     * Remove some stuff that should not be indexed by ES.\n+     * This is not ideal, we should be including things we want indexed, not removing.\n+     * @param entry\n+     */\n+    private static Entry removeIrrelevantProperties(final Entry entry) {\n+        Entry detachedEntry;\n+        if (entry instanceof Tool) {\n+            Tool tool = (Tool) entry;\n+            Tool detachedTool = new Tool();\n+            tool.getWorkflowVersions().forEach(version -> {\n+                Hibernate.initialize(version.getSourceFiles());\n+            });\n+\n+            // These are for facets\n+            detachedTool.setDefaultWdlPath(tool.getDefaultWdlPath());\n+            detachedTool.setDefaultCwlPath(tool.getDefaultCwlPath());\n+            detachedTool.setNamespace(tool.getNamespace());\n+            detachedTool.setRegistry(tool.getRegistry());\n+            detachedTool.setPrivateAccess(tool.isPrivateAccess());\n+\n+            // These are for table\n+            detachedTool.setGitUrl(tool.getGitUrl());\n+            detachedTool.setName(tool.getName());\n+            detachedTool.setToolname(tool.getToolname());\n+            detachedEntry = detachedTool;\n+        } else if (entry instanceof BioWorkflow) {\n+            BioWorkflow bioWorkflow = (BioWorkflow) entry;\n+            BioWorkflow detachedBioWorkflow = new BioWorkflow();\n+            // These are for facets\n+            detachedBioWorkflow.setDescriptorType(bioWorkflow.getDescriptorType());\n+            detachedBioWorkflow.setSourceControl(bioWorkflow.getSourceControl());\n+            detachedBioWorkflow.setOrganization(bioWorkflow.getOrganization());\n+\n+            // These are for table\n+            detachedBioWorkflow.setWorkflowName(bioWorkflow.getWorkflowName());\n+            detachedBioWorkflow.setRepository(bioWorkflow.getRepository());\n+            detachedBioWorkflow.setGitUrl(bioWorkflow.getGitUrl());\n+            detachedEntry = detachedBioWorkflow;\n+        } else {\n+            return entry;\n+        }\n+        detachedEntry.setDescription(entry.getDescription());\n+        detachedEntry.setAuthor(entry.getAuthor());\n+        detachedEntry.setAliases(entry.getAliases());\n+        detachedEntry.setLabels((SortedSet<Label>)entry.getLabels());\n+        detachedEntry.setCheckerWorkflow(entry.getCheckerWorkflow());\n+        Set<Version> detachedVersions = cloneWorkflowVersion(entry.getWorkflowVersions());\n+        detachedEntry.setWorkflowVersions(detachedVersions);\n+        entry.getStarredUsers().forEach(user -> detachedEntry.addStarredUser((User)user));\n+        String defaultVersion = entry.getDefaultVersion();\n+        if (defaultVersion != null) {\n+            boolean saneDefaultVersion = detachedVersions.stream().anyMatch(version -> defaultVersion.equals(version.getName()) || defaultVersion.equals(version.getReference()));\n+            if (saneDefaultVersion) {\n+                // If the tool/workflow has a default version, only keep the default version (and its sourcefile contents and description)\n+                Set<Version> newWorkflowVersions = detachedEntry.getWorkflowVersions();\n+                newWorkflowVersions.forEach(version -> {\n+                    if (!defaultVersion.equals(version.getReference()) && !defaultVersion.equals(version.getName())) {\n+                        version.setDescriptionAndDescriptionSource(null, null);\n+                        SortedSet<SourceFile> sourceFiles = version.getSourceFiles();\n+                        sourceFiles.forEach(sourceFile -> sourceFile.setContent(\"\"));\n+                    }\n+                });\n+            } else {\n+                LOGGER.error(\"Entry has a default version that doesn't exist: \" + entry.getEntryPath());", "originalCommit": "fd69562caeae5a5fa05b22badbe3dec15438007b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUxMjI3Nw==", "url": "https://github.com/dockstore/dockstore/pull/3339#discussion_r397512277", "bodyText": "an issue was made for this already", "author": "garyluu", "createdAt": "2020-03-24T22:59:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUwMTEyMg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUwMzY5Mw==", "url": "https://github.com/dockstore/dockstore/pull/3339#discussion_r397503693", "bodyText": "cloneWorkflowVersions (but don't change it)", "author": "coverbeck", "createdAt": "2020-03-24T22:37:32Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/statelisteners/ElasticListener.java", "diffHunk": "@@ -228,16 +232,110 @@ private String getNDJSON(List<Entry> publishedEntries) {\n      * @return The Elasticsearch object string to be placed into the index\n      * @throws IOException  Mapper problems\n      */\n-    public static JsonNode dockstoreEntryToElasticSearchObject(Entry entry) throws IOException {\n+    public static JsonNode dockstoreEntryToElasticSearchObject(final Entry entry) throws IOException {\n         Set<Version> workflowVersions = entry.getWorkflowVersions();\n         boolean verified = workflowVersions.stream().anyMatch(Version::isVerified);\n         Set<String> verifiedPlatforms = getVerifiedPlatforms(workflowVersions);\n-        JsonNode jsonNode = MAPPER.readTree(MAPPER.writeValueAsString(entry));\n+        Entry detachedEntry = removeIrrelevantProperties(entry);\n+        JsonNode jsonNode = MAPPER.readTree(MAPPER.writeValueAsString(detachedEntry));\n         ((ObjectNode)jsonNode).put(\"verified\", verified);\n         ((ObjectNode)jsonNode).put(\"verified_platforms\", MAPPER.valueToTree(verifiedPlatforms));\n         return jsonNode;\n     }\n \n+    /**\n+     * Remove some stuff that should not be indexed by ES.\n+     * This is not ideal, we should be including things we want indexed, not removing.\n+     * @param entry\n+     */\n+    private static Entry removeIrrelevantProperties(final Entry entry) {\n+        Entry detachedEntry;\n+        if (entry instanceof Tool) {\n+            Tool tool = (Tool) entry;\n+            Tool detachedTool = new Tool();\n+            tool.getWorkflowVersions().forEach(version -> {\n+                Hibernate.initialize(version.getSourceFiles());\n+            });\n+\n+            // These are for facets\n+            detachedTool.setDefaultWdlPath(tool.getDefaultWdlPath());\n+            detachedTool.setDefaultCwlPath(tool.getDefaultCwlPath());\n+            detachedTool.setNamespace(tool.getNamespace());\n+            detachedTool.setRegistry(tool.getRegistry());\n+            detachedTool.setPrivateAccess(tool.isPrivateAccess());\n+\n+            // These are for table\n+            detachedTool.setGitUrl(tool.getGitUrl());\n+            detachedTool.setName(tool.getName());\n+            detachedTool.setToolname(tool.getToolname());\n+            detachedEntry = detachedTool;\n+        } else if (entry instanceof BioWorkflow) {\n+            BioWorkflow bioWorkflow = (BioWorkflow) entry;\n+            BioWorkflow detachedBioWorkflow = new BioWorkflow();\n+            // These are for facets\n+            detachedBioWorkflow.setDescriptorType(bioWorkflow.getDescriptorType());\n+            detachedBioWorkflow.setSourceControl(bioWorkflow.getSourceControl());\n+            detachedBioWorkflow.setOrganization(bioWorkflow.getOrganization());\n+\n+            // These are for table\n+            detachedBioWorkflow.setWorkflowName(bioWorkflow.getWorkflowName());\n+            detachedBioWorkflow.setRepository(bioWorkflow.getRepository());\n+            detachedBioWorkflow.setGitUrl(bioWorkflow.getGitUrl());\n+            detachedEntry = detachedBioWorkflow;\n+        } else {\n+            return entry;\n+        }\n+        detachedEntry.setDescription(entry.getDescription());\n+        detachedEntry.setAuthor(entry.getAuthor());\n+        detachedEntry.setAliases(entry.getAliases());\n+        detachedEntry.setLabels((SortedSet<Label>)entry.getLabels());\n+        detachedEntry.setCheckerWorkflow(entry.getCheckerWorkflow());\n+        Set<Version> detachedVersions = cloneWorkflowVersion(entry.getWorkflowVersions());\n+        detachedEntry.setWorkflowVersions(detachedVersions);\n+        entry.getStarredUsers().forEach(user -> detachedEntry.addStarredUser((User)user));\n+        String defaultVersion = entry.getDefaultVersion();\n+        if (defaultVersion != null) {\n+            boolean saneDefaultVersion = detachedVersions.stream().anyMatch(version -> defaultVersion.equals(version.getName()) || defaultVersion.equals(version.getReference()));\n+            if (saneDefaultVersion) {\n+                // If the tool/workflow has a default version, only keep the default version (and its sourcefile contents and description)\n+                Set<Version> newWorkflowVersions = detachedEntry.getWorkflowVersions();\n+                newWorkflowVersions.forEach(version -> {\n+                    if (!defaultVersion.equals(version.getReference()) && !defaultVersion.equals(version.getName())) {\n+                        version.setDescriptionAndDescriptionSource(null, null);\n+                        SortedSet<SourceFile> sourceFiles = version.getSourceFiles();\n+                        sourceFiles.forEach(sourceFile -> sourceFile.setContent(\"\"));\n+                    }\n+                });\n+            } else {\n+                LOGGER.error(\"Entry has a default version that doesn't exist: \" + entry.getEntryPath());\n+            }\n+        }\n+        return detachedEntry;\n+    }\n+\n+    private static Set<Version> cloneWorkflowVersion(final Set<Version> originalWorkflowVersions) {", "originalCommit": "fd69562caeae5a5fa05b22badbe3dec15438007b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "a5f523c5bcd99aec5a4d237b97d67b04befe31fc", "url": "https://github.com/dockstore/dockstore/commit/a5f523c5bcd99aec5a4d237b97d67b04befe31fc", "message": "Iterate to get ready for release", "committedDate": "2020-03-24T22:49:25Z", "type": "commit"}, {"oid": "a5f523c5bcd99aec5a4d237b97d67b04befe31fc", "url": "https://github.com/dockstore/dockstore/commit/a5f523c5bcd99aec5a4d237b97d67b04befe31fc", "message": "Iterate to get ready for release", "committedDate": "2020-03-24T22:49:25Z", "type": "forcePushed"}]}