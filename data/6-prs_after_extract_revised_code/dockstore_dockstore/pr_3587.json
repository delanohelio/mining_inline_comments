{"pr_number": 3587, "pr_title": "Feature/3035/requirements map error", "pr_createdAt": "2020-06-19T15:16:03Z", "pr_url": "https://github.com/dockstore/dockstore/pull/3587", "timeline": [{"oid": "893b293f218dea1dc87ae06eec689b53e540bd75", "url": "https://github.com/dockstore/dockstore/commit/893b293f218dea1dc87ae06eec689b53e540bd75", "message": "support for cwl requirements and hints as maps", "committedDate": "2020-06-19T14:05:14Z", "type": "commit"}, {"oid": "fbf26fa997f50e3ba36987a0a18ab87cc4fc9c41", "url": "https://github.com/dockstore/dockstore/commit/fbf26fa997f50e3ba36987a0a18ab87cc4fc9c41", "message": "added test for requirements", "committedDate": "2020-06-19T14:52:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkxNTEzNQ==", "url": "https://github.com/dockstore/dockstore/pull/3587#discussion_r442915135", "bodyText": "You could create constants for \"requirements\" and \"hints\", since they're each referenced twice in the file, but not worth going through another iteration of the PR.", "author": "coverbeck", "createdAt": "2020-06-19T15:46:51Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/CWLHandler.java", "diffHunk": "@@ -564,6 +569,10 @@ private String parseSecondaryFile(String stepDockerRequirement, String secondary\n             List<Object> cltRequirements = null;\n             List<Object> cltHints = null;\n \n+            // CWLAvro only supports requirements and hints as an array, must be converted\n+            entryJson = convertJSONObjectToArray(\"requirements\", entryJson);", "originalCommit": "fbf26fa997f50e3ba36987a0a18ab87cc4fc9c41", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d09222d40015a8e1a0a86cf8af50c1ce5270dc27", "chunk": "diff --git a/dockstore-webservice/src/main/java/io/dockstore/webservice/languages/CWLHandler.java b/dockstore-webservice/src/main/java/io/dockstore/webservice/languages/CWLHandler.java\nindex 1831054d9..bd514e132 100644\n--- a/dockstore-webservice/src/main/java/io/dockstore/webservice/languages/CWLHandler.java\n+++ b/dockstore-webservice/src/main/java/io/dockstore/webservice/languages/CWLHandler.java\n\n@@ -569,10 +564,6 @@ public class CWLHandler implements LanguageHandlerInterface {\n             List<Object> cltRequirements = null;\n             List<Object> cltHints = null;\n \n-            // CWLAvro only supports requirements and hints as an array, must be converted\n-            entryJson = convertJSONObjectToArray(\"requirements\", entryJson);\n-            entryJson = convertJSONObjectToArray(\"hints\", entryJson);\n-\n             if (isExpressionTool(secondaryFileContents, yaml)) {\n                 final ExpressionTool expressionTool = gson.fromJson(entryJson.toString(), ExpressionTool.class);\n                 cltRequirements = expressionTool.getRequirements();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkxMDAwMw==", "url": "https://github.com/dockstore/dockstore/pull/3587#discussion_r442910003", "bodyText": "cwl => CWL", "author": "garyluu", "createdAt": "2020-06-19T15:36:47Z", "path": "dockstore-integration-testing/src/test/java/io/dockstore/client/cli/DAGWorkflowTestIT.java", "diffHunk": "@@ -118,6 +118,25 @@ public void testWorkflowDAGCWL() throws ApiException {\n \n     }\n \n+    @Test\n+    public void testWorkflowDAGCWLRequirementMap() throws ApiException {\n+        // Input: snaptools_create_snap_file.cwl\n+        // Repo: SnapTools\n+        // Branch: feature/docker_cwl_req_in_min\n+        // Test: normal cwl workflow DAG with requirement map", "originalCommit": "fbf26fa997f50e3ba36987a0a18ab87cc4fc9c41", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2de6d812c602a346a1be2f7c65bce36b64c4e425", "chunk": "diff --git a/dockstore-integration-testing/src/test/java/io/dockstore/client/cli/DAGWorkflowTestIT.java b/dockstore-integration-testing/src/test/java/io/dockstore/client/cli/DAGWorkflowTestIT.java\nindex 770d0342e..06f087aad 100644\n--- a/dockstore-integration-testing/src/test/java/io/dockstore/client/cli/DAGWorkflowTestIT.java\n+++ b/dockstore-integration-testing/src/test/java/io/dockstore/client/cli/DAGWorkflowTestIT.java\n\n@@ -123,13 +124,13 @@ public class DAGWorkflowTestIT extends BaseIT {\n         // Input: snaptools_create_snap_file.cwl\n         // Repo: SnapTools\n         // Branch: feature/docker_cwl_req_in_min\n-        // Test: normal cwl workflow DAG with requirement map\n+        // Test: normal CWL workflow DAG with requirement map\n \n-        final List<String> strings = getJSON(\"DockstoreTestUser2/SnapTools\", \"/snaptools_create_snap_file.cwl\", \"cwl\", \"feature/docker_cwl_req_in_main\");\n+        final List<String> strings = getJSON(\"DockstoreTestUser2/SnapTools\", \"/snaptools_create_snap_file.cwl\", DescriptorLanguage.CWL.getShortName(), \"feature/docker_cwl_req_in_main\");\n         int countNode = countNodeInJSON(strings);\n \n         Assert.assertTrue(\"JSON should not be blank\", strings.size() > 0);\n-        Assert.assertEquals(\"JSON should have eight nodes (including start and end)\", countNode, 8);\n+        Assert.assertEquals(\"JSON should have eight nodes (including start and end)\", 8, countNode);\n         Assert.assertTrue(\"node data should have snaptools_preprocess_reads as tool\", strings.get(0).contains(\"snaptools_preprocess_reads\"));\n         Assert.assertTrue(\"node data should have snaptools_create_ref_genome_size_file as tool\", strings.get(0).contains(\"snaptools_create_ref_genome_size_file\"));\n         Assert.assertTrue(\"edge should connect snaptools_preprocess_reads and snaptools_create_ref_genome_size_file\",\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkxMDYxMQ==", "url": "https://github.com/dockstore/dockstore/pull/3587#discussion_r442910611", "bodyText": "cwl => DescriptorLanguage.CWL.getShortName()", "author": "garyluu", "createdAt": "2020-06-19T15:38:01Z", "path": "dockstore-integration-testing/src/test/java/io/dockstore/client/cli/DAGWorkflowTestIT.java", "diffHunk": "@@ -118,6 +118,25 @@ public void testWorkflowDAGCWL() throws ApiException {\n \n     }\n \n+    @Test\n+    public void testWorkflowDAGCWLRequirementMap() throws ApiException {\n+        // Input: snaptools_create_snap_file.cwl\n+        // Repo: SnapTools\n+        // Branch: feature/docker_cwl_req_in_min\n+        // Test: normal cwl workflow DAG with requirement map\n+\n+        final List<String> strings = getJSON(\"DockstoreTestUser2/SnapTools\", \"/snaptools_create_snap_file.cwl\", \"cwl\", \"feature/docker_cwl_req_in_main\");", "originalCommit": "fbf26fa997f50e3ba36987a0a18ab87cc4fc9c41", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2de6d812c602a346a1be2f7c65bce36b64c4e425", "chunk": "diff --git a/dockstore-integration-testing/src/test/java/io/dockstore/client/cli/DAGWorkflowTestIT.java b/dockstore-integration-testing/src/test/java/io/dockstore/client/cli/DAGWorkflowTestIT.java\nindex 770d0342e..06f087aad 100644\n--- a/dockstore-integration-testing/src/test/java/io/dockstore/client/cli/DAGWorkflowTestIT.java\n+++ b/dockstore-integration-testing/src/test/java/io/dockstore/client/cli/DAGWorkflowTestIT.java\n\n@@ -123,13 +124,13 @@ public class DAGWorkflowTestIT extends BaseIT {\n         // Input: snaptools_create_snap_file.cwl\n         // Repo: SnapTools\n         // Branch: feature/docker_cwl_req_in_min\n-        // Test: normal cwl workflow DAG with requirement map\n+        // Test: normal CWL workflow DAG with requirement map\n \n-        final List<String> strings = getJSON(\"DockstoreTestUser2/SnapTools\", \"/snaptools_create_snap_file.cwl\", \"cwl\", \"feature/docker_cwl_req_in_main\");\n+        final List<String> strings = getJSON(\"DockstoreTestUser2/SnapTools\", \"/snaptools_create_snap_file.cwl\", DescriptorLanguage.CWL.getShortName(), \"feature/docker_cwl_req_in_main\");\n         int countNode = countNodeInJSON(strings);\n \n         Assert.assertTrue(\"JSON should not be blank\", strings.size() > 0);\n-        Assert.assertEquals(\"JSON should have eight nodes (including start and end)\", countNode, 8);\n+        Assert.assertEquals(\"JSON should have eight nodes (including start and end)\", 8, countNode);\n         Assert.assertTrue(\"node data should have snaptools_preprocess_reads as tool\", strings.get(0).contains(\"snaptools_preprocess_reads\"));\n         Assert.assertTrue(\"node data should have snaptools_create_ref_genome_size_file as tool\", strings.get(0).contains(\"snaptools_create_ref_genome_size_file\"));\n         Assert.assertTrue(\"edge should connect snaptools_preprocess_reads and snaptools_create_ref_genome_size_file\",\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkxMDc3Mw==", "url": "https://github.com/dockstore/dockstore/pull/3587#discussion_r442910773", "bodyText": "expected then actual", "author": "garyluu", "createdAt": "2020-06-19T15:38:20Z", "path": "dockstore-integration-testing/src/test/java/io/dockstore/client/cli/DAGWorkflowTestIT.java", "diffHunk": "@@ -118,6 +118,25 @@ public void testWorkflowDAGCWL() throws ApiException {\n \n     }\n \n+    @Test\n+    public void testWorkflowDAGCWLRequirementMap() throws ApiException {\n+        // Input: snaptools_create_snap_file.cwl\n+        // Repo: SnapTools\n+        // Branch: feature/docker_cwl_req_in_min\n+        // Test: normal cwl workflow DAG with requirement map\n+\n+        final List<String> strings = getJSON(\"DockstoreTestUser2/SnapTools\", \"/snaptools_create_snap_file.cwl\", \"cwl\", \"feature/docker_cwl_req_in_main\");\n+        int countNode = countNodeInJSON(strings);\n+\n+        Assert.assertTrue(\"JSON should not be blank\", strings.size() > 0);\n+        Assert.assertEquals(\"JSON should have eight nodes (including start and end)\", countNode, 8);", "originalCommit": "fbf26fa997f50e3ba36987a0a18ab87cc4fc9c41", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2de6d812c602a346a1be2f7c65bce36b64c4e425", "chunk": "diff --git a/dockstore-integration-testing/src/test/java/io/dockstore/client/cli/DAGWorkflowTestIT.java b/dockstore-integration-testing/src/test/java/io/dockstore/client/cli/DAGWorkflowTestIT.java\nindex 770d0342e..06f087aad 100644\n--- a/dockstore-integration-testing/src/test/java/io/dockstore/client/cli/DAGWorkflowTestIT.java\n+++ b/dockstore-integration-testing/src/test/java/io/dockstore/client/cli/DAGWorkflowTestIT.java\n\n@@ -123,13 +124,13 @@ public class DAGWorkflowTestIT extends BaseIT {\n         // Input: snaptools_create_snap_file.cwl\n         // Repo: SnapTools\n         // Branch: feature/docker_cwl_req_in_min\n-        // Test: normal cwl workflow DAG with requirement map\n+        // Test: normal CWL workflow DAG with requirement map\n \n-        final List<String> strings = getJSON(\"DockstoreTestUser2/SnapTools\", \"/snaptools_create_snap_file.cwl\", \"cwl\", \"feature/docker_cwl_req_in_main\");\n+        final List<String> strings = getJSON(\"DockstoreTestUser2/SnapTools\", \"/snaptools_create_snap_file.cwl\", DescriptorLanguage.CWL.getShortName(), \"feature/docker_cwl_req_in_main\");\n         int countNode = countNodeInJSON(strings);\n \n         Assert.assertTrue(\"JSON should not be blank\", strings.size() > 0);\n-        Assert.assertEquals(\"JSON should have eight nodes (including start and end)\", countNode, 8);\n+        Assert.assertEquals(\"JSON should have eight nodes (including start and end)\", 8, countNode);\n         Assert.assertTrue(\"node data should have snaptools_preprocess_reads as tool\", strings.get(0).contains(\"snaptools_preprocess_reads\"));\n         Assert.assertTrue(\"node data should have snaptools_create_ref_genome_size_file as tool\", strings.get(0).contains(\"snaptools_create_ref_genome_size_file\"));\n         Assert.assertTrue(\"edge should connect snaptools_preprocess_reads and snaptools_create_ref_genome_size_file\",\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkxMDg4MA==", "url": "https://github.com/dockstore/dockstore/pull/3587#discussion_r442910880", "bodyText": "CWL \ud83d\udc4d", "author": "garyluu", "createdAt": "2020-06-19T15:38:36Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/CWLHandler.java", "diffHunk": "@@ -583,6 +592,28 @@ private String parseSecondaryFile(String stepDockerRequirement, String secondary\n         return stepDockerRequirement;\n     }\n \n+    /**\n+     * Converts a JSON Object in CWL to JSON Array", "originalCommit": "fbf26fa997f50e3ba36987a0a18ab87cc4fc9c41", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d09222d40015a8e1a0a86cf8af50c1ce5270dc27", "chunk": "diff --git a/dockstore-webservice/src/main/java/io/dockstore/webservice/languages/CWLHandler.java b/dockstore-webservice/src/main/java/io/dockstore/webservice/languages/CWLHandler.java\nindex 1831054d9..bd514e132 100644\n--- a/dockstore-webservice/src/main/java/io/dockstore/webservice/languages/CWLHandler.java\n+++ b/dockstore-webservice/src/main/java/io/dockstore/webservice/languages/CWLHandler.java\n\n@@ -592,28 +583,6 @@ public class CWLHandler implements LanguageHandlerInterface {\n         return stepDockerRequirement;\n     }\n \n-    /**\n-     * Converts a JSON Object in CWL to JSON Array\n-     * @param keyName Name of key to convert (Ex. requirements, hints)\n-     * @param entryJson JSON representation of file\n-     * @return Updated JSON representation of file\n-     */\n-    private JSONObject convertJSONObjectToArray(String keyName, JSONObject entryJson) {\n-        if (entryJson.has(keyName)) {\n-            if (entryJson.get(keyName) instanceof JSONObject) {\n-                JSONArray reqArray = new JSONArray();\n-                JSONObject requirements = (JSONObject)entryJson.get(keyName);\n-                requirements.keySet().stream().forEach(key -> {\n-                    JSONObject newReqEntry = requirements.getJSONObject(key);\n-                    newReqEntry.put(\"class\", key);\n-                    reqArray.put(newReqEntry);\n-                });\n-                entryJson.put(keyName, reqArray);\n-            }\n-        }\n-        return entryJson;\n-    }\n-\n     /**\n      * Given a list of CWL requirements, will return the DockerPull information if present.\n      * If not will return the current docker path (currentDefault)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkxNzIxMw==", "url": "https://github.com/dockstore/dockstore/pull/3587#discussion_r442917213", "bodyText": "Optional: should be a way to stream + map requirements to reqArray", "author": "garyluu", "createdAt": "2020-06-19T15:50:51Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/CWLHandler.java", "diffHunk": "@@ -583,6 +592,28 @@ private String parseSecondaryFile(String stepDockerRequirement, String secondary\n         return stepDockerRequirement;\n     }\n \n+    /**\n+     * Converts a JSON Object in CWL to JSON Array\n+     * @param keyName Name of key to convert (Ex. requirements, hints)\n+     * @param entryJson JSON representation of file\n+     * @return Updated JSON representation of file\n+     */\n+    private JSONObject convertJSONObjectToArray(String keyName, JSONObject entryJson) {\n+        if (entryJson.has(keyName)) {\n+            if (entryJson.get(keyName) instanceof JSONObject) {\n+                JSONArray reqArray = new JSONArray();", "originalCommit": "fbf26fa997f50e3ba36987a0a18ab87cc4fc9c41", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d09222d40015a8e1a0a86cf8af50c1ce5270dc27", "chunk": "diff --git a/dockstore-webservice/src/main/java/io/dockstore/webservice/languages/CWLHandler.java b/dockstore-webservice/src/main/java/io/dockstore/webservice/languages/CWLHandler.java\nindex 1831054d9..bd514e132 100644\n--- a/dockstore-webservice/src/main/java/io/dockstore/webservice/languages/CWLHandler.java\n+++ b/dockstore-webservice/src/main/java/io/dockstore/webservice/languages/CWLHandler.java\n\n@@ -592,28 +583,6 @@ public class CWLHandler implements LanguageHandlerInterface {\n         return stepDockerRequirement;\n     }\n \n-    /**\n-     * Converts a JSON Object in CWL to JSON Array\n-     * @param keyName Name of key to convert (Ex. requirements, hints)\n-     * @param entryJson JSON representation of file\n-     * @return Updated JSON representation of file\n-     */\n-    private JSONObject convertJSONObjectToArray(String keyName, JSONObject entryJson) {\n-        if (entryJson.has(keyName)) {\n-            if (entryJson.get(keyName) instanceof JSONObject) {\n-                JSONArray reqArray = new JSONArray();\n-                JSONObject requirements = (JSONObject)entryJson.get(keyName);\n-                requirements.keySet().stream().forEach(key -> {\n-                    JSONObject newReqEntry = requirements.getJSONObject(key);\n-                    newReqEntry.put(\"class\", key);\n-                    reqArray.put(newReqEntry);\n-                });\n-                entryJson.put(keyName, reqArray);\n-            }\n-        }\n-        return entryJson;\n-    }\n-\n     /**\n      * Given a list of CWL requirements, will return the DockerPull information if present.\n      * If not will return the current docker path (currentDefault)\n"}}, {"oid": "2de6d812c602a346a1be2f7c65bce36b64c4e425", "url": "https://github.com/dockstore/dockstore/commit/2de6d812c602a346a1be2f7c65bce36b64c4e425", "message": "updates from PR", "committedDate": "2020-06-19T17:06:06Z", "type": "commit"}, {"oid": "d09222d40015a8e1a0a86cf8af50c1ce5270dc27", "url": "https://github.com/dockstore/dockstore/commit/d09222d40015a8e1a0a86cf8af50c1ce5270dc27", "message": "Update pull_robot swagger (#3584)\n\n* Update pull_robot swagger", "committedDate": "2020-06-23T18:12:13Z", "type": "commit"}, {"oid": "eb95ea66fd29a6c9185acc12c65e11dfed9c9def", "url": "https://github.com/dockstore/dockstore/commit/eb95ea66fd29a6c9185acc12c65e11dfed9c9def", "message": "Merge branch 'develop' into feature/3035/requirements-map-error", "committedDate": "2020-06-24T13:29:50Z", "type": "commit"}, {"oid": "a9a88af3f9a9020bf163de4654df7588e66b6661", "url": "https://github.com/dockstore/dockstore/commit/a9a88af3f9a9020bf163de4654df7588e66b6661", "message": "Revert \"Merge branch 'develop' into feature/3035/requirements-map-error\"\n\nThis reverts commit eb95ea66fd29a6c9185acc12c65e11dfed9c9def, reversing\nchanges made to 2de6d812c602a346a1be2f7c65bce36b64c4e425.", "committedDate": "2020-06-24T13:35:13Z", "type": "commit"}]}