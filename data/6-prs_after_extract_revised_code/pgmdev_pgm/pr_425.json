{"pr_number": 425, "pr_title": "Introduce non-dynamic map pools", "pr_createdAt": "2020-04-22T06:11:27Z", "pr_url": "https://github.com/PGMDev/PGM/pull/425", "timeline": [{"oid": "3991ba77820d8b26b8532431c6e6d4cfcb5c369d", "url": "https://github.com/PGMDev/PGM/commit/3991ba77820d8b26b8532431c6e6d4cfcb5c369d", "message": "Introduce non-dynamic map pools\n* /setpool command and new random order option for map pools\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>", "committedDate": "2020-04-22T06:08:54Z", "type": "commit"}, {"oid": "fac796da30411477a8bf3758efcfdf69d80a2728", "url": "https://github.com/PGMDev/PGM/commit/fac796da30411477a8bf3758efcfdf69d80a2728", "message": "Update random -> shuffled\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>", "committedDate": "2020-04-22T07:03:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzA0MzA2Nw==", "url": "https://github.com/PGMDev/PGM/pull/425#discussion_r413043067", "bodyText": "Not sure this event is necessary. Since you're just printing to chat, I would skip the event and just print.", "author": "Electroid", "createdAt": "2020-04-22T14:41:19Z", "path": "core/src/main/java/tc/oc/pgm/events/MapPoolAdjustEvent.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package tc.oc.pgm.events;\n+\n+import javax.annotation.Nullable;\n+import org.bukkit.command.CommandSender;\n+import org.bukkit.event.Event;\n+import org.bukkit.event.HandlerList;\n+import tc.oc.pgm.api.match.Match;\n+import tc.oc.pgm.rotation.MapPool;\n+\n+/** MapPoolAdjustEvent is called when the active {@link MapPool} is set to another * */\n+public class MapPoolAdjustEvent extends Event {", "originalCommit": "fac796da30411477a8bf3758efcfdf69d80a2728", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI0MDI3OQ==", "url": "https://github.com/PGMDev/PGM/pull/425#discussion_r413240279", "bodyText": "@Electroid So personally I plan on having a plugin which is going to listen to this event, to be used in order to perform other cool stuff. As I wanted to keep specific features out of PGM for the sake of not evading the scope. Is that alright or would you still like it removed?", "author": "applenick", "createdAt": "2020-04-22T18:58:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzA0MzA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzMyMDg5Ng==", "url": "https://github.com/PGMDev/PGM/pull/425#discussion_r413320896", "bodyText": "Hmm, I'm okay with keeping this for now, but there's no guarantees it will still exist when the API is published and 1.0 is released. So you can keep it for now.", "author": "Electroid", "createdAt": "2020-04-22T20:47:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzA0MzA2Nw=="}], "type": "inlineReview", "revised_code": {"commit": "0837db3cf78b1f306e6a9a7dd9fdbe53c950dbcc", "chunk": "diff --git a/core/src/main/java/tc/oc/pgm/events/MapPoolAdjustEvent.java b/core/src/main/java/tc/oc/pgm/events/MapPoolAdjustEvent.java\nindex 83a487a6..d6551760 100644\n--- a/core/src/main/java/tc/oc/pgm/events/MapPoolAdjustEvent.java\n+++ b/core/src/main/java/tc/oc/pgm/events/MapPoolAdjustEvent.java\n\n@@ -1,5 +1,6 @@\n package tc.oc.pgm.events;\n \n+import java.time.Duration;\n import javax.annotation.Nullable;\n import org.bukkit.command.CommandSender;\n import org.bukkit.event.Event;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM3MTIzMQ==", "url": "https://github.com/PGMDev/PGM/pull/425#discussion_r413371231", "bodyText": "Based on the wording in #326 i do not think PGM should depend on the community module being present.", "author": "KingOfSquares", "createdAt": "2020-04-22T22:18:53Z", "path": "core/src/main/java/tc/oc/pgm/commands/AdminCommands.java", "diffHunk": "@@ -12,23 +12,30 @@\n import javax.annotation.Nullable;\n import net.kyori.text.TranslatableComponent;\n import net.kyori.text.format.TextColor;\n-import org.bukkit.ChatColor;\n+import net.md_5.bungee.api.ChatColor;\n import org.bukkit.command.CommandSender;\n import tc.oc.pgm.api.PGM;\n import tc.oc.pgm.api.Permissions;\n import tc.oc.pgm.api.map.MapInfo;\n import tc.oc.pgm.api.map.MapOrder;\n import tc.oc.pgm.api.match.Match;\n-import tc.oc.pgm.api.match.MatchManager;\n import tc.oc.pgm.api.party.Competitor;\n+import tc.oc.pgm.community.commands.ModerationCommands;", "originalCommit": "fac796da30411477a8bf3758efcfdf69d80a2728", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0837db3cf78b1f306e6a9a7dd9fdbe53c950dbcc", "chunk": "diff --git a/core/src/main/java/tc/oc/pgm/commands/AdminCommands.java b/core/src/main/java/tc/oc/pgm/commands/AdminCommands.java\nindex 102051b8..21c9aece 100644\n--- a/core/src/main/java/tc/oc/pgm/commands/AdminCommands.java\n+++ b/core/src/main/java/tc/oc/pgm/commands/AdminCommands.java\n\n@@ -20,7 +20,6 @@ import tc.oc.pgm.api.map.MapInfo;\n import tc.oc.pgm.api.map.MapOrder;\n import tc.oc.pgm.api.match.Match;\n import tc.oc.pgm.api.party.Competitor;\n-import tc.oc.pgm.community.commands.ModerationCommands;\n import tc.oc.pgm.cycle.CycleCountdown;\n import tc.oc.pgm.listeners.ChatDispatcher;\n import tc.oc.pgm.restart.CancelRestartEvent;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM3MjExMw==", "url": "https://github.com/PGMDev/PGM/pull/425#discussion_r413372113", "bodyText": "Im guessing this will be displayed if someone does /setpool -r and there is no dynamic pools present? I think there should be a more intuitive response if so (e.g \"No dynamic pools loaded\")\nThis could maybe be located in getAppropriateDynamicPool?", "author": "KingOfSquares", "createdAt": "2020-04-22T22:20:35Z", "path": "core/src/main/java/tc/oc/pgm/commands/AdminCommands.java", "diffHunk": "@@ -115,13 +124,61 @@ public static void setNext(\n                   .translate(\"command.admin.cancelRestart.restartUnqueued\", sender));\n     }\n \n-    sender.sendMessage(\n-        ChatColor.DARK_PURPLE\n-            + AllTranslations.get()\n-                .translate(\n-                    \"command.admin.set.success\",\n-                    sender,\n-                    ChatColor.GOLD + map.getName() + ChatColor.DARK_PURPLE));\n+    Component mapName = new PersonalizedText(map.getName()).color(ChatColor.DARK_PURPLE);\n+    Component successful =\n+        new PersonalizedTranslatable(\n+                \"command.admin.set.success\",\n+                ModerationCommands.formatStaffName(sender, match),\n+                mapName)\n+            .getPersonalizedText()\n+            .color(ChatColor.GRAY);\n+    ChatDispatcher.broadcastAdminChatMessage(successful, match);\n+  }\n+\n+  @Command(\n+      aliases = {\"setpool\", \"setrot\"},\n+      desc = \"Set a custom map pool or revert to dynamic\",\n+      usage = \"[pool name] -r (revert to dynamic)\",\n+      flags = \"r\",\n+      perms = Permissions.SETNEXT)\n+  public static void setPool(\n+      CommandSender sender,\n+      Match match,\n+      MapOrder mapOrder,\n+      @Nullable String poolName,\n+      @Switch('r') boolean reset)\n+      throws CommandException {\n+    if (!match.getCountdown().getAll(CycleCountdown.class).isEmpty()) {\n+      sender.sendMessage(\n+          new PersonalizedTranslatable(\"command.admin.setPool.activeCycle\")\n+              .getPersonalizedText()\n+              .color(ChatColor.RED));\n+      return;\n+    }\n+    MapPoolManager mapPoolManager = MapPoolCommands.getMapPoolManager(sender, mapOrder);\n+    MapPool newPool =\n+        reset\n+            ? mapPoolManager.getAppropriateDynamicPool(match).orElse(null)\n+            : mapPoolManager.getMapPoolByName(poolName);\n+\n+    if (newPool == null) {\n+      Component noPoolError =\n+          new PersonalizedTranslatable(\"command.pools.noPoolMatch\")", "originalCommit": "fac796da30411477a8bf3758efcfdf69d80a2728", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0837db3cf78b1f306e6a9a7dd9fdbe53c950dbcc", "chunk": "diff --git a/core/src/main/java/tc/oc/pgm/commands/AdminCommands.java b/core/src/main/java/tc/oc/pgm/commands/AdminCommands.java\nindex 102051b8..21c9aece 100644\n--- a/core/src/main/java/tc/oc/pgm/commands/AdminCommands.java\n+++ b/core/src/main/java/tc/oc/pgm/commands/AdminCommands.java\n\n@@ -128,7 +128,7 @@ public class AdminCommands {\n     Component successful =\n         new PersonalizedTranslatable(\n                 \"command.admin.set.success\",\n-                ModerationCommands.formatStaffName(sender, match),\n+                UsernameFormatUtils.formatStaffName(sender, match),\n                 mapName)\n             .getPersonalizedText()\n             .color(ChatColor.GRAY);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM3NjczMA==", "url": "https://github.com/PGMDev/PGM/pull/425#discussion_r413376730", "bodyText": "What about *0.5 so it stays consistent with the line above?", "author": "KingOfSquares", "createdAt": "2020-04-22T22:30:43Z", "path": "core/src/main/java/tc/oc/pgm/rotation/MapPoolManager.java", "diffHunk": "@@ -170,15 +172,30 @@ public void setNextMap(MapInfo map) {\n     activeMapPool.setNextMap(map); // Notify pool a next map has been set\n   }\n \n-  @Override\n-  public void matchEnded(Match match) {\n-    int activePlayers = match.getPlayers().size() - (match.getObservers().size() / 2);\n-\n-    mapPools.stream()\n+  public Optional<MapPool> getAppropriateDynamicPool(Match match) {\n+    int obs =\n+        match.getModule(BlitzMatchModule.class) != null\n+            ? (int) (match.getObservers().size() * 0.85)\n+            : (match.getObservers().size() / 2);", "originalCommit": "fac796da30411477a8bf3758efcfdf69d80a2728", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0837db3cf78b1f306e6a9a7dd9fdbe53c950dbcc", "chunk": "diff --git a/core/src/main/java/tc/oc/pgm/rotation/MapPoolManager.java b/core/src/main/java/tc/oc/pgm/rotation/MapPoolManager.java\nindex 9c433ce3..37496b5a 100644\n--- a/core/src/main/java/tc/oc/pgm/rotation/MapPoolManager.java\n+++ b/core/src/main/java/tc/oc/pgm/rotation/MapPoolManager.java\n\n@@ -176,7 +198,7 @@ public class MapPoolManager implements MapOrder {\n     int obs =\n         match.getModule(BlitzMatchModule.class) != null\n             ? (int) (match.getObservers().size() * 0.85)\n-            : (match.getObservers().size() / 2);\n+            : (int) (match.getObservers().size() * 0.5);\n     int activePlayers = match.getPlayers().size() - obs;\n     return mapPools.stream()\n         .filter(rot -> activePlayers >= rot.getPlayers())\n"}}, {"oid": "0837db3cf78b1f306e6a9a7dd9fdbe53c950dbcc", "url": "https://github.com/PGMDev/PGM/commit/0837db3cf78b1f306e6a9a7dd9fdbe53c950dbcc", "message": "Add timelimit flag to /setpool\n* Also clean up various things\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>", "committedDate": "2020-04-23T07:06:10Z", "type": "commit"}, {"oid": "33823f748da4ac350375cd2f3f97757e1f8b0154", "url": "https://github.com/PGMDev/PGM/commit/33823f748da4ac350375cd2f3f97757e1f8b0154", "message": "Merge branch 'master' into non-dynamic-pools", "committedDate": "2020-04-26T19:15:56Z", "type": "commit"}]}