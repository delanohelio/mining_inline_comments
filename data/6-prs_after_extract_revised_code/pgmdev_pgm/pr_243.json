{"pr_number": 243, "pr_title": "Add a cooldown to /report, resolves Electroid#242", "pr_createdAt": "2020-01-17T18:53:34Z", "pr_url": "https://github.com/PGMDev/PGM/pull/243", "timeline": [{"oid": "ab2afed9879bc067a3d26a753089f4b12ba2dcce", "url": "https://github.com/PGMDev/PGM/commit/ab2afed9879bc067a3d26a753089f4b12ba2dcce", "message": "Add a cooldown to /report\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>", "committedDate": "2020-01-17T18:43:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA5MDYwNw==", "url": "https://github.com/PGMDev/PGM/pull/243#discussion_r368090607", "bodyText": "Should use a guava expiring cache, and maybe just use the UUID as key (if the command sender is the console just always allow)", "author": "Pablete1234", "createdAt": "2020-01-17T19:07:16Z", "path": "src/main/java/tc/oc/pgm/commands/ModerationCommands.java", "diffHunk": "@@ -18,16 +24,40 @@\n \n public class ModerationCommands {\n \n+  private static final int REPORT_COOLDOWN_SECONDS = 15;\n+\n+  private final Map<CommandSender, Instant> lastReportSent = new WeakHashMap<>();", "originalCommit": "ab2afed9879bc067a3d26a753089f4b12ba2dcce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEwMzg3Ng==", "url": "https://github.com/PGMDev/PGM/pull/243#discussion_r368103876", "bodyText": "Also exempt players with the Permissions.STAFF", "author": "Electroid", "createdAt": "2020-01-17T19:38:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA5MDYwNw=="}], "type": "inlineReview", "revised_code": {"commit": "6fdb0482b5e98d9dc0d94394e0c04fe5b16a3aaf", "chunk": "diff --git a/src/main/java/tc/oc/pgm/commands/ModerationCommands.java b/src/main/java/tc/oc/pgm/commands/ModerationCommands.java\nindex 0257d75..c0d4e34 100644\n--- a/src/main/java/tc/oc/pgm/commands/ModerationCommands.java\n+++ b/src/main/java/tc/oc/pgm/commands/ModerationCommands.java\n\n@@ -26,35 +29,50 @@ public class ModerationCommands {\n \n   private static final int REPORT_COOLDOWN_SECONDS = 15;\n \n-  private final Map<CommandSender, Instant> lastReportSent = new WeakHashMap<>();\n+  private static final LoadingCache<UUID, Instant> lastReportSent =\n+      CacheBuilder.newBuilder()\n+          .weakKeys()\n+          .expireAfterWrite(REPORT_COOLDOWN_SECONDS, TimeUnit.SECONDS)\n+          .build(\n+              new CacheLoader<UUID, Instant>() {\n+                @Override\n+                public Instant load(UUID uuid) throws Exception {\n+                  return Instant.now();\n+                }\n+              });\n \n   @Command(\n       aliases = {\"report\"},\n       usage = \"<player> <reason>\",\n       desc = \"Report a player who is breaking the rules\")\n-  public void report(\n+  public static void report(\n       CommandSender commandSender,\n       MatchPlayer matchPlayer,\n       Match match,\n       Player player,\n       @Text String reason)\n       throws CommandException {\n-    // Check if player has a cooldown\n-    Instant lastReport = lastReportSent.get(commandSender);\n-    if (lastReport != null) {\n-      Duration timeSinceReport = Duration.between(lastReport, Instant.now());\n-      long secondsRemaining = REPORT_COOLDOWN_SECONDS - timeSinceReport.getSeconds();\n-      if (secondsRemaining > 0) {\n-        throw new CommandException(\n-            AllTranslations.get()\n-                .translate(\n-                    \"command.report.cooldown\",\n-                    commandSender,\n-                    ChatColor.AQUA\n-                        + (secondsRemaining\n-                            + \" second\"\n-                            + (secondsRemaining != 1 ? \"s\" : \"\")\n-                            + ChatColor.RED)));\n+    if (!commandSender.hasPermission(Permissions.STAFF) && commandSender instanceof Player) {\n+      // Check for cooldown\n+      Instant lastReport = lastReportSent.getIfPresent(matchPlayer.getId());\n+      if (lastReport != null) {\n+        Duration timeSinceReport = Duration.between(lastReport, Instant.now());\n+        long secondsRemaining = REPORT_COOLDOWN_SECONDS - timeSinceReport.getSeconds();\n+        if (secondsRemaining > 0) {\n+          throw new CommandException(\n+              AllTranslations.get()\n+                  .translate(\n+                      \"command.report.cooldown\",\n+                      commandSender,\n+                      ChatColor.AQUA\n+                          + (secondsRemaining\n+                              + \" second\"\n+                              + (secondsRemaining != 1 ? \"s\" : \"\")\n+                              + ChatColor.RED)));\n+        }\n+      } else {\n+        // Player has no cooldown, so add one\n+        lastReportSent.put(matchPlayer.getId(), Instant.now());\n       }\n     }\n \n"}}, {"oid": "6fdb0482b5e98d9dc0d94394e0c04fe5b16a3aaf", "url": "https://github.com/PGMDev/PGM/commit/6fdb0482b5e98d9dc0d94394e0c04fe5b16a3aaf", "message": "Use a cache for report cooldowns\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>", "committedDate": "2020-01-17T20:12:51Z", "type": "commit"}, {"oid": "dfe414456cd1d35066d533a6331b060e0f137685", "url": "https://github.com/PGMDev/PGM/commit/dfe414456cd1d35066d533a6331b060e0f137685", "message": "Clean up cache for report cooldowns\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>", "committedDate": "2020-01-17T20:22:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEyNTcyMA==", "url": "https://github.com/PGMDev/PGM/pull/243#discussion_r368125720", "bodyText": "Using uuis, no need for weak keys", "author": "Pablete1234", "createdAt": "2020-01-17T20:36:42Z", "path": "src/main/java/tc/oc/pgm/commands/ModerationCommands.java", "diffHunk": "@@ -18,6 +26,14 @@\n \n public class ModerationCommands {\n \n+  private static final int REPORT_COOLDOWN_SECONDS = 15;\n+\n+  private static final Cache<UUID, Instant> lastReportSent =\n+      CacheBuilder.newBuilder()\n+          .weakKeys()", "originalCommit": "dfe414456cd1d35066d533a6331b060e0f137685", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEyNjI2MA==", "url": "https://github.com/PGMDev/PGM/pull/243#discussion_r368126260", "bodyText": "Ah thanks, I was unsure! I\u2019ll adjust that now", "author": "applenick", "createdAt": "2020-01-17T20:37:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEyNTcyMA=="}], "type": "inlineReview", "revised_code": {"commit": "abe07e8b03d7870add0bbd256e580db42d1a017f", "chunk": "diff --git a/src/main/java/tc/oc/pgm/commands/ModerationCommands.java b/src/main/java/tc/oc/pgm/commands/ModerationCommands.java\nindex 29f11a1..de31cec 100644\n--- a/src/main/java/tc/oc/pgm/commands/ModerationCommands.java\n+++ b/src/main/java/tc/oc/pgm/commands/ModerationCommands.java\n\n@@ -29,10 +29,7 @@ public class ModerationCommands {\n   private static final int REPORT_COOLDOWN_SECONDS = 15;\n \n   private static final Cache<UUID, Instant> lastReportSent =\n-      CacheBuilder.newBuilder()\n-          .weakKeys()\n-          .expireAfterWrite(REPORT_COOLDOWN_SECONDS, TimeUnit.SECONDS)\n-          .build();\n+      CacheBuilder.newBuilder().expireAfterWrite(REPORT_COOLDOWN_SECONDS, TimeUnit.SECONDS).build();\n \n   @Command(\n       aliases = {\"report\"},\n"}}, {"oid": "abe07e8b03d7870add0bbd256e580db42d1a017f", "url": "https://github.com/PGMDev/PGM/commit/abe07e8b03d7870add0bbd256e580db42d1a017f", "message": "Remove weak keys, and make cooldown message generic\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>", "committedDate": "2020-01-17T20:47:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIxOTA2Mw==", "url": "https://github.com/PGMDev/PGM/pull/243#discussion_r368219063", "bodyText": "This should be translatable.", "author": "TheMolkaPL", "createdAt": "2020-01-18T10:09:16Z", "path": "src/main/java/tc/oc/pgm/commands/ModerationCommands.java", "diffHunk": "@@ -27,7 +40,32 @@ public static void report(\n       MatchPlayer matchPlayer,\n       Match match,\n       Player player,\n-      @Text String reason) {\n+      @Text String reason)\n+      throws CommandException {\n+    if (!commandSender.hasPermission(Permissions.STAFF) && commandSender instanceof Player) {\n+      // Check for cooldown\n+      Instant lastReport = lastReportSent.getIfPresent(matchPlayer.getId());\n+      if (lastReport != null) {\n+        Duration timeSinceReport = Duration.between(lastReport, Instant.now());\n+        long secondsRemaining = REPORT_COOLDOWN_SECONDS - timeSinceReport.getSeconds();\n+        if (secondsRemaining > 0) {\n+          throw new CommandException(\n+              AllTranslations.get()\n+                  .translate(\n+                      \"command.cooldown\",\n+                      commandSender,\n+                      ChatColor.AQUA\n+                          + (secondsRemaining\n+                              + \" second\"\n+                              + (secondsRemaining != 1 ? \"s\" : \"\")", "originalCommit": "abe07e8b03d7870add0bbd256e580db42d1a017f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIzODE5NQ==", "url": "https://github.com/PGMDev/PGM/pull/243#discussion_r368238195", "bodyText": "Thanks Molka, I should have done this from the beginning!", "author": "applenick", "createdAt": "2020-01-18T17:26:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIxOTA2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "567cc7fa5bc84c19bdcdf299ab3cf9f3ecae1729", "chunk": "diff --git a/src/main/java/tc/oc/pgm/commands/ModerationCommands.java b/src/main/java/tc/oc/pgm/commands/ModerationCommands.java\nindex de31cec..3ad1bfd 100644\n--- a/src/main/java/tc/oc/pgm/commands/ModerationCommands.java\n+++ b/src/main/java/tc/oc/pgm/commands/ModerationCommands.java\n\n@@ -49,16 +48,15 @@ public class ModerationCommands {\n         Duration timeSinceReport = Duration.between(lastReport, Instant.now());\n         long secondsRemaining = REPORT_COOLDOWN_SECONDS - timeSinceReport.getSeconds();\n         if (secondsRemaining > 0) {\n-          throw new CommandException(\n-              AllTranslations.get()\n-                  .translate(\n-                      \"command.cooldown\",\n-                      commandSender,\n-                      ChatColor.AQUA\n-                          + (secondsRemaining\n-                              + \" second\"\n-                              + (secondsRemaining != 1 ? \"s\" : \"\")\n-                              + ChatColor.RED)));\n+          Component secondsLeft =\n+              new PersonalizedText(\n+                      secondsRemaining + \" second\" + (secondsRemaining != 1 ? \"s\" : \"\"))\n+                  .color(ChatColor.AQUA);\n+          commandSender.sendMessage(\n+              new PersonalizedTranslatable(\"command.cooldown\", secondsLeft)\n+                  .getPersonalizedText()\n+                  .color(ChatColor.RED));\n+          return;\n         }\n       } else {\n         // Player has no cooldown, so add one\n"}}, {"oid": "567cc7fa5bc84c19bdcdf299ab3cf9f3ecae1729", "url": "https://github.com/PGMDev/PGM/commit/567cc7fa5bc84c19bdcdf299ab3cf9f3ecae1729", "message": "Update report cooldown to use translatable\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>", "committedDate": "2020-01-18T17:17:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIzODQ5OQ==", "url": "https://github.com/PGMDev/PGM/pull/243#discussion_r368238499", "bodyText": "I think this should be called LAST_REPORT_SENT.", "author": "TheMolkaPL", "createdAt": "2020-01-18T17:34:46Z", "path": "src/main/java/tc/oc/pgm/commands/ModerationCommands.java", "diffHunk": "@@ -18,6 +25,11 @@\n \n public class ModerationCommands {\n \n+  private static final int REPORT_COOLDOWN_SECONDS = 15;\n+\n+  private static final Cache<UUID, Instant> lastReportSent =\n+      CacheBuilder.newBuilder().expireAfterWrite(REPORT_COOLDOWN_SECONDS, TimeUnit.SECONDS).build();", "originalCommit": "567cc7fa5bc84c19bdcdf299ab3cf9f3ecae1729", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIzODg2OA==", "url": "https://github.com/PGMDev/PGM/pull/243#discussion_r368238868", "bodyText": "I meant something like this: :P\nhttps://github.com/Electroid/PGM/blob/31ebbcc74002981fcf05dc0af45e861a77d07aca/src/main/i18n/templates/strings.properties#L672-L674\n\nWhoops! \ud83d\ude06\nI\u2019ll make the adjustments now, thanks again haha.", "author": "applenick", "createdAt": "2020-01-18T17:42:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIzODQ5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "6ef42e675fcc391c78944dae445445ecb271dbe5", "chunk": "diff --git a/src/main/java/tc/oc/pgm/commands/ModerationCommands.java b/src/main/java/tc/oc/pgm/commands/ModerationCommands.java\nindex 3ad1bfd..f6a2cb0 100644\n--- a/src/main/java/tc/oc/pgm/commands/ModerationCommands.java\n+++ b/src/main/java/tc/oc/pgm/commands/ModerationCommands.java\n\n@@ -27,7 +27,7 @@ public class ModerationCommands {\n \n   private static final int REPORT_COOLDOWN_SECONDS = 15;\n \n-  private static final Cache<UUID, Instant> lastReportSent =\n+  private static final Cache<UUID, Instant> LAST_REPORT_SENT =\n       CacheBuilder.newBuilder().expireAfterWrite(REPORT_COOLDOWN_SECONDS, TimeUnit.SECONDS).build();\n \n   @Command(\n"}}, {"oid": "6ef42e675fcc391c78944dae445445ecb271dbe5", "url": "https://github.com/PGMDev/PGM/commit/6ef42e675fcc391c78944dae445445ecb271dbe5", "message": "Update report cooldown to actually use translatables\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>", "committedDate": "2020-01-18T17:50:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI5NjE0Nw==", "url": "https://github.com/PGMDev/PGM/pull/243#discussion_r368296147", "bodyText": "I would use Integer.toString(secondsRemaining), otherwise looks good to me.", "author": "TheMolkaPL", "createdAt": "2020-01-19T13:58:39Z", "path": "src/main/java/tc/oc/pgm/commands/ModerationCommands.java", "diffHunk": "@@ -27,7 +39,36 @@ public static void report(\n       MatchPlayer matchPlayer,\n       Match match,\n       Player player,\n-      @Text String reason) {\n+      @Text String reason)\n+      throws CommandException {\n+    if (!commandSender.hasPermission(Permissions.STAFF) && commandSender instanceof Player) {\n+      // Check for cooldown\n+      Instant lastReport = LAST_REPORT_SENT.getIfPresent(matchPlayer.getId());\n+      if (lastReport != null) {\n+        Duration timeSinceReport = Duration.between(lastReport, Instant.now());\n+        long secondsRemaining = REPORT_COOLDOWN_SECONDS - timeSinceReport.getSeconds();\n+        if (secondsRemaining > 0) {\n+          Component secondsComponent = new PersonalizedText(\"\" + secondsRemaining);", "originalCommit": "6ef42e675fcc391c78944dae445445ecb271dbe5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODcxMjY4NA==", "url": "https://github.com/PGMDev/PGM/pull/243#discussion_r368712684", "bodyText": "Oh snap, I did not see your suggestion! I\u2019m adjusting this right now. \ud83d\udc4d", "author": "applenick", "createdAt": "2020-01-20T20:18:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI5NjE0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "3acbf054b77450703b5c7a98d6a8c2059fe763e0", "chunk": "diff --git a/src/main/java/tc/oc/pgm/commands/ModerationCommands.java b/src/main/java/tc/oc/pgm/commands/ModerationCommands.java\nindex f6a2cb0..a922ab7 100644\n--- a/src/main/java/tc/oc/pgm/commands/ModerationCommands.java\n+++ b/src/main/java/tc/oc/pgm/commands/ModerationCommands.java\n\n@@ -48,7 +48,7 @@ public class ModerationCommands {\n         Duration timeSinceReport = Duration.between(lastReport, Instant.now());\n         long secondsRemaining = REPORT_COOLDOWN_SECONDS - timeSinceReport.getSeconds();\n         if (secondsRemaining > 0) {\n-          Component secondsComponent = new PersonalizedText(\"\" + secondsRemaining);\n+          Component secondsComponent = new PersonalizedText(Long.toString(secondsRemaining));\n           Component secondsLeftComponent =\n               new PersonalizedTranslatable(\n                       secondsRemaining != 1\n"}}, {"oid": "3acbf054b77450703b5c7a98d6a8c2059fe763e0", "url": "https://github.com/PGMDev/PGM/commit/3acbf054b77450703b5c7a98d6a8c2059fe763e0", "message": "Clean up formatting for seconds remaining\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>", "committedDate": "2020-01-20T20:21:40Z", "type": "commit"}, {"oid": "36477cbbabbb0d2e20f24a5d4cedf33b922c7feb", "url": "https://github.com/PGMDev/PGM/commit/36477cbbabbb0d2e20f24a5d4cedf33b922c7feb", "message": "Merge branch 'master' into report-cooldown", "committedDate": "2020-01-20T23:17:29Z", "type": "commit"}]}