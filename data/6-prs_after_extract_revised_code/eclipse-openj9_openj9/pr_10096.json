{"pr_number": 10096, "pr_title": "Move static fields and methods from MethodHandle to MethodHandleHelper", "pr_createdAt": "2020-07-06T20:29:46Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/10096", "timeline": [{"oid": "589973e340386c660af79c42c03da3ba5c3d5f19", "url": "https://github.com/eclipse-openj9/openj9/commit/589973e340386c660af79c42c03da3ba5c3d5f19", "message": "Add MethodHandleHelper which includes static methods from OpenJ9 MethodHandle\n\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-07-06T20:34:52Z", "type": "forcePushed"}, {"oid": "afb21aea6e6b48b86e60a2830344d00ee80bbd0f", "url": "https://github.com/eclipse-openj9/openj9/commit/afb21aea6e6b48b86e60a2830344d00ee80bbd0f", "message": "Update native dependencies to use MethodHandleHelper\n\nThe names of the following Java native methods are updated in native\ncode since they are moved from the MethodHandle to MethodHandleHelper\nclass:\n- getCPTypeAt\n- getCPMethodTypeAt\n- getCPMethodHandleAt\n- getCPClassNameAt\n- getCPConstantDynamicAt\n\nThe names of the following Java methods, which are invoked from native\ncode, are updated since they are moved from the MethodHandle to\nMethodHandleHelper class:\n- sendResolveMethodHandle\n- resolveInvokeDynamic\n- resolveConstantDynamic\n- constructorPlaceHolder\n\nThe above MethodHandleHelper Java methods will be used in both OpenJ9\nand OpenJDK JSR292 implementations.\n\nRelated: https://github.com/eclipse/openj9/issues/7352\n\nCo-authored-by: Jack Lu <Jack.S.Lu@ibm.com>\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-10-05T23:02:56Z", "type": "forcePushed"}, {"oid": "616b46f83d3bc2eb40d53a57efd05e9dca03f430", "url": "https://github.com/eclipse-openj9/openj9/commit/616b46f83d3bc2eb40d53a57efd05e9dca03f430", "message": "Update native dependencies to use MethodHandleHelper\n\nThe names of the following Java native methods are updated in native\ncode since they are moved from the MethodHandle to MethodHandleHelper\nclass:\n- getCPTypeAt\n- getCPMethodTypeAt\n- getCPMethodHandleAt\n- getCPClassNameAt\n- getCPConstantDynamicAt\n\nThe names of the following Java methods, which are invoked from native\ncode, are updated since they are moved from the MethodHandle to\nMethodHandleHelper class:\n- sendResolveMethodHandle\n- resolveInvokeDynamic\n- resolveConstantDynamic\n- constructorPlaceHolder\n\nThe above MethodHandleHelper Java methods will be used in both OpenJ9\nand OpenJDK JSR292 implementations.\n\nRelated: https://github.com/eclipse/openj9/issues/7352\n\nCo-authored-by: Jack Lu <Jack.S.Lu@ibm.com>\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-10-05T23:29:34Z", "type": "forcePushed"}, {"oid": "05b1803ea9601fd004e63079057a646d4a9568ea", "url": "https://github.com/eclipse-openj9/openj9/commit/05b1803ea9601fd004e63079057a646d4a9568ea", "message": "Update native dependencies to use MethodHandleHelper\n\nThe names of the following Java native methods are updated in native\ncode since they are moved from the MethodHandle to MethodHandleHelper\nclass:\n- getCPTypeAt\n- getCPMethodTypeAt\n- getCPMethodHandleAt\n- getCPClassNameAt\n- getCPConstantDynamicAt\n\nThe names of the following Java methods, which are invoked from native\ncode, are updated since they are moved from the MethodHandle to\nMethodHandleHelper class:\n- sendResolveMethodHandle\n- resolveInvokeDynamic\n- resolveConstantDynamic\n- constructorPlaceHolder\n\nThe above MethodHandleHelper Java methods will be used in both OpenJ9\nand OpenJDK JSR292 implementations.\n\nRelated: https://github.com/eclipse/openj9/issues/7352\n\nCo-authored-by: Jack Lu <Jack.S.Lu@ibm.com>\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-10-06T00:04:47Z", "type": "forcePushed"}, {"oid": "c5378a73841b1bf7429f764d4ce892d48a24ee46", "url": "https://github.com/eclipse-openj9/openj9/commit/c5378a73841b1bf7429f764d4ce892d48a24ee46", "message": "Update native dependencies to use MethodHandleHelper\n\nThe names of the following Java native methods are updated in native\ncode since they are moved from the MethodHandle to MethodHandleHelper\nclass:\n- getCPTypeAt\n- getCPMethodTypeAt\n- getCPMethodHandleAt\n- getCPClassNameAt\n- getCPConstantDynamicAt\n\nThe names of the following Java methods, which are invoked from native\ncode, are updated since they are moved from the MethodHandle to\nMethodHandleHelper class:\n- sendResolveMethodHandle\n- resolveInvokeDynamic\n- resolveConstantDynamic\n- constructorPlaceHolder\n\nThe above MethodHandleHelper Java methods will be used in both OpenJ9\nand OpenJDK JSR292 implementations.\n\nRelated: https://github.com/eclipse/openj9/issues/7352\n\nCo-authored-by: Jack Lu <Jack.S.Lu@ibm.com>\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-10-06T02:48:34Z", "type": "forcePushed"}, {"oid": "a5491e7a817b567d40b181b82d34270d3fb2c9f1", "url": "https://github.com/eclipse-openj9/openj9/commit/a5491e7a817b567d40b181b82d34270d3fb2c9f1", "message": "Update native dependencies to use MethodHandleHelper\n\nThe names of the following Java native methods are updated in native\ncode since they are moved from the MethodHandle to MethodHandleHelper\nclass:\n- getCPTypeAt\n- getCPMethodTypeAt\n- getCPMethodHandleAt\n- getCPClassNameAt\n- getCPConstantDynamicAt\n\nThe names of the following Java methods, which are invoked from native\ncode, are updated since they are moved from the MethodHandle to\nMethodHandleHelper class:\n- sendResolveMethodHandle\n- resolveInvokeDynamic\n- resolveConstantDynamic\n- constructorPlaceHolder\n\nThe above MethodHandleHelper Java methods will be used in both OpenJ9\nand OpenJDK JSR292 implementations.\n\nRelated: https://github.com/eclipse/openj9/issues/7352\n\nCo-authored-by: Jack Lu <Jack.S.Lu@ibm.com>\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-10-06T02:57:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM4NjU5NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10096#discussion_r500386594", "bodyText": "There are a lot of xxxxPlaceHolder methods.  Why is only this one being moved?", "author": "DanHeidinga", "createdAt": "2020-10-06T15:24:32Z", "path": "jcl/src/java.base/share/classes/java/lang/invoke/MethodHandle.java", "diffHunk": "@@ -1521,19 +1052,6 @@ private MethodHandle filterArgumentsPlaceHolder(int index, int parentOffset, int\n \t\treturn this;\n \t}\n \t\n-\t/*[IF ]*/\n-\t/*\n-\t * Used to preserve the new objectRef on the stack when avoiding the call-in for\n-\t * constructorHandles.  Must return 'this' so stackmapper will keep the object\n-\t * alive.\n-\t */\n-\t/*[ENDIF]*/\n-\t@SuppressWarnings(\"unused\")\n-\t@VMCONSTANTPOOL_METHOD\n-\tprivate static Object constructorPlaceHolder(Object newObjectRef) {", "originalCommit": "a5491e7a817b567d40b181b82d34270d3fb2c9f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQwODQ0NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10096#discussion_r500408444", "bodyText": "Other xxxxPlaceHolder methods are non-static. Similar JCL init issues were not seen with non-static MH methods. So, only the static MH.constructorPlaceHolder is being moved.", "author": "babsingh", "createdAt": "2020-10-06T15:49:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM4NjU5NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM4NjgxNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10096#discussion_r500386817", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            /*[INCLUDE-IF Sidecar17]*/\n          \n          \n            \n            /*[INCLUDE-IF Sidecar18]*/", "author": "DanHeidinga", "createdAt": "2020-10-06T15:24:45Z", "path": "jcl/src/java.base/share/classes/java/lang/invoke/MethodHandleHelper.java", "diffHunk": "@@ -0,0 +1,528 @@\n+/*[INCLUDE-IF Sidecar17]*/", "originalCommit": "a5491e7a817b567d40b181b82d34270d3fb2c9f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQxNTE3NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10096#discussion_r500415175", "bodyText": "Updated.", "author": "babsingh", "createdAt": "2020-10-06T15:58:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM4NjgxNw=="}], "type": "inlineReview", "revised_code": {"commit": "5ff4d79740d8516f612d1b470b631389b2907013", "chunk": "diff --git a/jcl/src/java.base/share/classes/java/lang/invoke/MethodHandleHelper.java b/jcl/src/java.base/share/classes/java/lang/invoke/MethodHandleHelper.java\nindex 446429a14..7fc4df22a 100644\n--- a/jcl/src/java.base/share/classes/java/lang/invoke/MethodHandleHelper.java\n+++ b/jcl/src/java.base/share/classes/java/lang/invoke/MethodHandleHelper.java\n\n@@ -1,4 +1,4 @@\n-/*[INCLUDE-IF Sidecar17]*/\n+/*[INCLUDE-IF Sidecar18]*/\n /*******************************************************************************\n  * Copyright (c) 2020, 2020 IBM Corp. and others\n  *\n"}}, {"oid": "5ff4d79740d8516f612d1b470b631389b2907013", "url": "https://github.com/eclipse-openj9/openj9/commit/5ff4d79740d8516f612d1b470b631389b2907013", "message": "Update native dependencies to use MethodHandleHelper\n\nThe names of the following Java native methods are updated in native\ncode since they are moved from the MethodHandle to MethodHandleHelper\nclass:\n- getCPTypeAt\n- getCPMethodTypeAt\n- getCPMethodHandleAt\n- getCPClassNameAt\n- getCPConstantDynamicAt\n\nThe names of the following Java methods, which are invoked from native\ncode, are updated since they are moved from the MethodHandle to\nMethodHandleHelper class:\n- sendResolveMethodHandle\n- resolveInvokeDynamic\n- resolveConstantDynamic\n- constructorPlaceHolder\n\nThe above MethodHandleHelper Java methods will be used in both OpenJ9\nand OpenJDK JSR292 implementations.\n\nRelated: https://github.com/eclipse/openj9/issues/7352\n\nCo-authored-by: Jack Lu <Jack.S.Lu@ibm.com>\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-10-06T15:56:40Z", "type": "forcePushed"}, {"oid": "e274536005daa55bb555e1abedb16aeaaca3abd8", "url": "https://github.com/eclipse-openj9/openj9/commit/e274536005daa55bb555e1abedb16aeaaca3abd8", "message": "Update native dependencies to use MethodHandleHelper\n\nThe names of the following Java native methods are updated in native\ncode since they are moved from the MethodHandle to MethodHandleHelper\nclass:\n- getCPTypeAt\n- getCPMethodTypeAt\n- getCPMethodHandleAt\n- getCPClassNameAt\n- getCPConstantDynamicAt\n\nThe names of the following Java methods, which are invoked from native\ncode, are updated since they are moved from the MethodHandle to\nMethodHandleHelper class:\n- sendResolveMethodHandle\n- resolveInvokeDynamic\n- resolveConstantDynamic\n- constructorPlaceHolder\n\nThe above MethodHandleHelper Java methods will be used in both OpenJ9\nand OpenJDK JSR292 implementations.\n\nRelated: https://github.com/eclipse/openj9/issues/7352\n\nCo-authored-by: Jack Lu <Jack.S.Lu@ibm.com>\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-10-06T18:20:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTc4NTA0MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10096#discussion_r501785040", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public final class MethodHandleHelper {\n          \n          \n            \n            final class MethodHandleHelper {\n          \n      \n    \n    \n  \n\nNeeds to be package protected.\nThis PR is already tested. Shall I update this PR or do this change in a follow-up PR?", "author": "babsingh", "createdAt": "2020-10-08T14:51:51Z", "path": "jcl/src/java.base/share/classes/java/lang/invoke/MethodHandleHelper.java", "diffHunk": "@@ -0,0 +1,528 @@\n+/*[INCLUDE-IF Sidecar18-SE]*/\n+/*******************************************************************************\n+ * Copyright (c) 2020, 2020 IBM Corp. and others\n+ *\n+ * This program and the accompanying materials are made available under\n+ * the terms of the Eclipse Public License 2.0 which accompanies this\n+ * distribution and is available at https://www.eclipse.org/legal/epl-2.0/\n+ * or the Apache License, Version 2.0 which accompanies this distribution and\n+ * is available at https://www.apache.org/licenses/LICENSE-2.0.\n+ *\n+ * This Source Code may also be made available under the following\n+ * Secondary Licenses when the conditions for such availability set\n+ * forth in the Eclipse Public License, v. 2.0 are satisfied: GNU\n+ * General Public License, version 2 with the GNU Classpath\n+ * Exception [1] and GNU General Public License, version 2 with the\n+ * OpenJDK Assembly Exception [2].\n+ *\n+ * [1] https://www.gnu.org/software/classpath/license.html\n+ * [2] http://openjdk.java.net/legal/assembly-exception.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0 OR Apache-2.0 OR GPL-2.0 WITH Classpath-exception-2.0 OR LicenseRef-GPL-2.0 WITH Assembly-exception\n+ *******************************************************************************/\n+package java.lang.invoke;\n+\n+import java.lang.invoke.MethodHandles.Lookup;\n+import java.util.ArrayList;\n+import java.util.Objects;\n+\n+import com.ibm.oti.util.Msg;\n+import com.ibm.oti.vm.VM;\n+import com.ibm.oti.vm.VMLangAccess;\n+\n+/*[IF Sidecar19-SE]\n+import jdk.internal.misc.Unsafe;\n+import jdk.internal.reflect.ConstantPool;\n+/*[ELSE]*/\n+import sun.misc.Unsafe;\n+import sun.reflect.ConstantPool;\n+/*[ENDIF]*/\n+\n+import com.ibm.jit.JITHelpers;\n+\n+/**\n+ * Static methods for the MethodHandle class.\n+ */\n+public final class MethodHandleHelper {", "originalCommit": "e274536005daa55bb555e1abedb16aeaaca3abd8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTc4OTU3OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10096#discussion_r501789579", "bodyText": "in this PR please.  We'll rerun tests as required - likely only a single platform", "author": "DanHeidinga", "createdAt": "2020-10-08T14:57:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTc4NTA0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTgwNjUxMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10096#discussion_r501806510", "bodyText": "Updated.", "author": "babsingh", "createdAt": "2020-10-08T15:20:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTc4NTA0MA=="}], "type": "inlineReview", "revised_code": {"commit": "1471b23a4cfb236f406081f2bddce421d977e6b1", "chunk": "diff --git a/jcl/src/java.base/share/classes/java/lang/invoke/MethodHandleHelper.java b/jcl/src/java.base/share/classes/java/lang/invoke/MethodHandleHelper.java\nindex 49db434d4..d5cb53aed 100644\n--- a/jcl/src/java.base/share/classes/java/lang/invoke/MethodHandleHelper.java\n+++ b/jcl/src/java.base/share/classes/java/lang/invoke/MethodHandleHelper.java\n\n@@ -43,7 +43,7 @@ import com.ibm.jit.JITHelpers;\n /**\n  * Static methods for the MethodHandle class.\n  */\n-public final class MethodHandleHelper {\n+final class MethodHandleHelper {\n \tstatic final Unsafe UNSAFE = Unsafe.getUnsafe();\n \n \tstatic final JITHelpers JITHELPERS = JITHelpers.getHelpers();\n"}}, {"oid": "1471b23a4cfb236f406081f2bddce421d977e6b1", "url": "https://github.com/eclipse-openj9/openj9/commit/1471b23a4cfb236f406081f2bddce421d977e6b1", "message": "Move static fields and methods from MethodHandle to MethodHandleHelper\n\nThe code has been verbatim moved from MethodHandle to\nMethodHandleHelper.\n\nThe following static final fields are moved from MethodHandle to\nMethodHandleHelper:\n- UNSAFE\n- JITHELPERS\n- BSM_ARGUMENT_SIZE\n- BSM_ARGUMENT_COUNT_OFFSET\n- BSM_ARGUMENTS_OFFSET\n- BSM_LOOKUP_ARGUMENT_INDEX\n- BSM_NAME_ARGUMENT_INDEX\n- BSM_TYPE_ARGUMENT_INDEX\n- BSM_OPTIONAL_ARGUMENTS_START_INDEX\n\nThe following native static methods are moved from MethodHandle to\nMethodHandleHelper:\n- getCPTypeAt\n- getCPMethodTypeAt\n- getCPMethodHandleAt\n- getCPClassNameAt\n- getCPConstantDynamicAt\n\nThe following Java static methods are moved from MethodHandle to\nMethodHandleHelper:\n- resolveConstantDynamic\n- constructorPlaceHolder\n- invokeBsm\n- resolveInvokeDynamic\n- sendResolveMethodHandle\n- resolveFieldHandleHelper\n- getClassFromJ9Class\n- fromFieldDescriptorString\n- getAdditionalBsmArg\n- throwNoClassDefFoundError\n- getJ9ClassFromClass\n\nThis is done to support the OpenJDK MethodHandle class. Some of the\nabove Java static methods will be updated to support the OpenJDK\nMethodHandle class.\n\nThis will also resolve a limitation of vmconstantpool.xml, which exposes\nsome of the above Java static methods in the native code. The OpenJDK\nMethodHandle class does not have the above Java static methods. Having\nthe static methods in MethodHandleHelper allows them to be exposed to\nboth OpenJ9 and OpenJDK implementations. This prevents the JCL\ninitialization crash, associated to vmconstantpool.xml, when the OpenJDK\nMethodHandle class is enabled.\n\nRelated: https://github.com/eclipse/openj9/issues/7352\n\nCo-authored-by: Jack Lu <Jack.S.Lu@ibm.com>\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-10-08T15:18:43Z", "type": "commit"}, {"oid": "b301f8de035ea1bc45f69682c72b7ef100d5f3d8", "url": "https://github.com/eclipse-openj9/openj9/commit/b301f8de035ea1bc45f69682c72b7ef100d5f3d8", "message": "Update Java dependencies to use MethodHandleHelper static fields/methods\n\nPreviously, the MethodHandle class contained UNSAFE, JITHELPERS and\ngetJ9ClassFromClass. Since these items have been moved from the\nMethodHandle to MethodHandleHelper class, the associated Java\ndependencies have been updated to use UNSAFE, JITHELPERS and\ngetJ9ClassFromClass from the MethodHandleHelper class.\n\nRelated: https://github.com/eclipse/openj9/issues/7352\n\nCo-authored-by: Jack Lu <Jack.S.Lu@ibm.com>\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-10-08T15:18:50Z", "type": "commit"}, {"oid": "a9d4fef8490a36020843d6b69d7d5023aa7153d4", "url": "https://github.com/eclipse-openj9/openj9/commit/a9d4fef8490a36020843d6b69d7d5023aa7153d4", "message": "Update native dependencies to use MethodHandleHelper\n\nThe names of the following Java native methods are updated in native\ncode since they are moved from the MethodHandle to MethodHandleHelper\nclass:\n- getCPTypeAt\n- getCPMethodTypeAt\n- getCPMethodHandleAt\n- getCPClassNameAt\n- getCPConstantDynamicAt\n\nThe names of the following Java methods, which are invoked from native\ncode, are updated since they are moved from the MethodHandle to\nMethodHandleHelper class:\n- sendResolveMethodHandle\n- resolveInvokeDynamic\n- resolveConstantDynamic\n- constructorPlaceHolder\n\nThe above MethodHandleHelper Java methods will be used in both OpenJ9\nand OpenJDK JSR292 implementations.\n\nRelated: https://github.com/eclipse/openj9/issues/7352\n\nCo-authored-by: Jack Lu <Jack.S.Lu@ibm.com>\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-10-08T15:18:50Z", "type": "commit"}, {"oid": "a9d4fef8490a36020843d6b69d7d5023aa7153d4", "url": "https://github.com/eclipse-openj9/openj9/commit/a9d4fef8490a36020843d6b69d7d5023aa7153d4", "message": "Update native dependencies to use MethodHandleHelper\n\nThe names of the following Java native methods are updated in native\ncode since they are moved from the MethodHandle to MethodHandleHelper\nclass:\n- getCPTypeAt\n- getCPMethodTypeAt\n- getCPMethodHandleAt\n- getCPClassNameAt\n- getCPConstantDynamicAt\n\nThe names of the following Java methods, which are invoked from native\ncode, are updated since they are moved from the MethodHandle to\nMethodHandleHelper class:\n- sendResolveMethodHandle\n- resolveInvokeDynamic\n- resolveConstantDynamic\n- constructorPlaceHolder\n\nThe above MethodHandleHelper Java methods will be used in both OpenJ9\nand OpenJDK JSR292 implementations.\n\nRelated: https://github.com/eclipse/openj9/issues/7352\n\nCo-authored-by: Jack Lu <Jack.S.Lu@ibm.com>\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-10-08T15:18:50Z", "type": "forcePushed"}]}