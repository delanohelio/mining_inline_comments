{"pr_number": 8405, "pr_title": "Grow StringBuffer and StringBuilder aggressively from 1G to 2G", "pr_createdAt": "2020-01-24T20:08:02Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/8405", "timeline": [{"oid": "5244e305da1d5f1a9928fbed05d33c3fd44ca680", "url": "https://github.com/eclipse-openj9/openj9/commit/5244e305da1d5f1a9928fbed05d33c3fd44ca680", "message": "Grow StringBuffer and StringBuilder aggressively from 1G to 2G\n\nWhen `-Djava.lang.stringBufferAndBuilder.growAggressively` or\n`-Djava.lang.stringBufferAndBuilder.growAggressively=true` is set on\nthe command line, and doubling the capacity overflows Integer.MAX_VALUE, \ngrow StringBuffer and StringBuilder to Integer.MAX_VALUE instead of\nonly increasing the capacity by the size of the String being appended.\nCompatible with Hotspot behavior.\n\nAdd testing for the same.\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-01-24T20:15:22Z", "type": "forcePushed"}, {"oid": "74c79308b4a0b176b900c6366638276c91a350c5", "url": "https://github.com/eclipse-openj9/openj9/commit/74c79308b4a0b176b900c6366638276c91a350c5", "message": "Grow StringBuffer and StringBuilder aggressively from 1G to 2G\n\nAffects jdk8 only. jdk11 and later already grow aggressively.\nWhen `-Djava.lang.stringBufferAndBuilder.growAggressively` or\n`-Djava.lang.stringBufferAndBuilder.growAggressively=true` is set on\nthe command line, and doubling the capacity overflows Integer.MAX_VALUE, \ngrow StringBuffer and StringBuilder to Integer.MAX_VALUE instead of\nonly increasing the capacity by the size of the String being appended.\nCompatible with Hotspot behavior.\n\nAdd testing for the same.\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-01-24T21:30:45Z", "type": "forcePushed"}, {"oid": "7c3b34d02529c6fe19e7171887bb682025c4e2ce", "url": "https://github.com/eclipse-openj9/openj9/commit/7c3b34d02529c6fe19e7171887bb682025c4e2ce", "message": "Grow StringBuffer and StringBuilder aggressively from 1G to 2G\n\nAffects jdk8 only. jdk11 and later already grow aggressively.\nWhen `-Djava.lang.stringBufferAndBuilder.growAggressively` or\n`-Djava.lang.stringBufferAndBuilder.growAggressively=true` is set on\nthe command line, and doubling the capacity overflows Integer.MAX_VALUE, \ngrow StringBuffer and StringBuilder to Integer.MAX_VALUE instead of\nonly increasing the capacity by the size of the String being appended.\nCompatible with Hotspot behavior.\n\nAdd testing for the same.\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-01-24T22:33:35Z", "type": "forcePushed"}, {"oid": "68783b8892c7033ac3c07465b467a8d7d6fee213", "url": "https://github.com/eclipse-openj9/openj9/commit/68783b8892c7033ac3c07465b467a8d7d6fee213", "message": "Grow StringBuffer and StringBuilder aggressively from 1G to 2G\n\nAffects jdk8 only. jdk11 and later already grow aggressively.\nWhen `-Djava.lang.stringBufferAndBuilder.growAggressively` or\n`-Djava.lang.stringBufferAndBuilder.growAggressively=true` is set on\nthe command line, and doubling the capacity overflows Integer.MAX_VALUE, \ngrow StringBuffer and StringBuilder to Integer.MAX_VALUE instead of\nonly increasing the capacity by the size of the String being appended.\nCompatible with Hotspot behavior.\n\nAdd testing for the same.\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-01-24T22:57:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk0MTAyMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8405#discussion_r372941020", "bodyText": "nits: Inconsistent indenting (here and the closing }); missing space around = in for loops.", "author": "keithc-ca", "createdAt": "2020-01-30T13:17:55Z", "path": "test/functional/cmdLineTests/cmdLineTest_J9tests/src/TestStringBufferAndBuilderGrowth.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020, 2020 IBM Corp. and others\n+ *\n+ * This program and the accompanying materials are made available under\n+ * the terms of the Eclipse Public License 2.0 which accompanies this\n+ * distribution and is available at https://www.eclipse.org/legal/epl-2.0/\n+ * or the Apache License, Version 2.0 which accompanies this distribution and\n+ * is available at https://www.apache.org/licenses/LICENSE-2.0.\n+ *\n+ * This Source Code may also be made available under the following\n+ * Secondary Licenses when the conditions for such availability set\n+ * forth in the Eclipse Public License, v. 2.0 are satisfied: GNU\n+ * General Public License, version 2 with the GNU Classpath\n+ * Exception [1] and GNU General Public License, version 2 with the\n+ * OpenJDK Assembly Exception [2].\n+ *\n+ * [1] https://www.gnu.org/software/classpath/license.html\n+ * [2] http://openjdk.java.net/legal/assembly-exception.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0 OR Apache-2.0 OR GPL-2.0 WITH Classpath-exception-2.0 OR LicenseRef-GPL-2.0 WITH Assembly-exception\n+ *******************************************************************************/\n+\n+/**\n+ * @file TestStringBufferAndBuilderGrowth.java\n+ * @brief Grows a StringBuffer and StringBuilder to Integer.MAX_VALUE\n+ */\n+\n+public class TestStringBufferAndBuilderGrowth {\n+\n+public static void main(String[] args) {", "originalCommit": "68783b8892c7033ac3c07465b467a8d7d6fee213", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE1MzM0Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8405#discussion_r373153343", "bodyText": "Fixed", "author": "pshipton", "createdAt": "2020-01-30T19:38:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk0MTAyMA=="}], "type": "inlineReview", "revised_code": {"commit": "a24fbae13ea5d466b7422832c22d93f36c68177a", "chunk": "diff --git a/test/functional/cmdLineTests/cmdLineTest_J9tests/src/TestStringBufferAndBuilderGrowth.java b/test/functional/cmdLineTests/cmdLineTest_J9tests/src/TestStringBufferAndBuilderGrowth.java\nindex 12c7e629f..978a75d4b 100644\n--- a/test/functional/cmdLineTests/cmdLineTest_J9tests/src/TestStringBufferAndBuilderGrowth.java\n+++ b/test/functional/cmdLineTests/cmdLineTest_J9tests/src/TestStringBufferAndBuilderGrowth.java\n\n@@ -24,34 +24,43 @@\n  * @file TestStringBufferAndBuilderGrowth.java\n  * @brief Grows a StringBuffer and StringBuilder to Integer.MAX_VALUE\n  */\n-\n public class TestStringBufferAndBuilderGrowth {\n \n public static void main(String[] args) {\n-\t\tchar[] cbuf = new char[Integer.MAX_VALUE / 32];\n+\tchar[] cbuf = new char[Integer.MAX_VALUE / 32];\n \n- \t\tStringBuffer sbuf = new StringBuffer((Integer.MAX_VALUE / 2) + 1);\n-\t\tfor (int i=0; i < 17; i++) {\n-\t\t\ttry {\n-\t \t \t\tsbuf.append(cbuf);\n-\t\t\t} catch (OutOfMemoryError e) {\n-\t\t\t\tSystem.out.println(\"OOM StringBuffer occurred iteration \" + i);\n-\t\t\t\treturn;\n-\t\t\t}\n+\t// Create a StringBuffer big enough that the default algorithm to\n+\t// grow it will overflow Integer.MAX_VALUE. Some smaller sizes could\n+\t// be used without affecting the test, such as the default size, but\n+\t// starting it big avoids unnecessary copying so the test runs faster.\n+\tStringBuffer sbuf = new StringBuffer((Integer.MAX_VALUE / 2) + 1);\n+\t// 17 iterations adds approximately 1G + 64M (minus a few bytes)\n+\t// to the Buffer, causing it to grow\n+\tfor (int i = 0; i < 17; i++) {\n+\t\ttry {\n+ \t \t\tsbuf.append(cbuf);\n+\t\t} catch (OutOfMemoryError e) {\n+\t\t\tSystem.out.println(\"OOM StringBuffer occurred iteration \" + i);\n+\t\t\treturn;\n \t\t}\n-\t\tint sbufCapacity = sbuf.capacity();\n+\t}\n+\tint sbufCapacity = sbuf.capacity();\n+\t// sbuf is no longer used after this point and will be GCed. Nulling it\n+\t// isn't technically required for OpenJ9, but make it explicit for clarity.\n+\tsbuf = null;\n \n- \t\tStringBuilder sbld = new StringBuilder((Integer.MAX_VALUE / 2) + 1);\n-\t\tfor (int i=0; i < 17; i++) {\n-\t\t\ttry {\n-\t \t \t\tsbld.append(cbuf);\n-\t\t\t} catch (OutOfMemoryError e) {\n-\t\t\t\tSystem.out.println(\"OOM StringBuilder occurred iteration \" + i);\n-\t\t\t\treturn;\n-\t\t\t}\n+\t// Duplicate the above test for StringBuilder\n+\tStringBuilder sbld = new StringBuilder((Integer.MAX_VALUE / 2) + 1);\n+\tfor (int i = 0; i < 17; i++) {\n+\t\ttry {\n+ \t \t\tsbld.append(cbuf);\n+\t\t} catch (OutOfMemoryError e) {\n+\t\t\tSystem.out.println(\"OOM StringBuilder occurred iteration \" + i);\n+\t\t\treturn;\n \t\t}\n-\t\tint sbldCapacity = sbld.capacity();\n+\t}\n+\tint sbldCapacity = sbld.capacity();\n \n-\t\tSystem.out.println(\"StringBuffer capacity=\" + sbufCapacity + \" StringBuilder capacity=\" + sbldCapacity);\n+\tSystem.out.println(\"StringBuffer capacity=\" + sbufCapacity + \" StringBuilder capacity=\" + sbldCapacity);\n }\n }\n"}}, {"oid": "a24fbae13ea5d466b7422832c22d93f36c68177a", "url": "https://github.com/eclipse-openj9/openj9/commit/a24fbae13ea5d466b7422832c22d93f36c68177a", "message": "Grow StringBuffer and StringBuilder aggressively from 1G to 2G\n\nAffects jdk8 only. jdk11 and later already grow aggressively.\nWhen `-Djava.lang.stringBufferAndBuilder.growAggressively` or\n`-Djava.lang.stringBufferAndBuilder.growAggressively=true` is set on\nthe command line, and doubling the capacity overflows Integer.MAX_VALUE, \ngrow StringBuffer and StringBuilder to Integer.MAX_VALUE instead of\nonly increasing the capacity by the size of the String being appended.\nCompatible with Hotspot behavior.\n\nAdd testing for the same.\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-01-30T19:37:17Z", "type": "forcePushed"}, {"oid": "0301b816ac60791c4d6dfecf4eb06079e57536b8", "url": "https://github.com/eclipse-openj9/openj9/commit/0301b816ac60791c4d6dfecf4eb06079e57536b8", "message": "Grow StringBuffer and StringBuilder aggressively from 1G to 2G\n\nAffects jdk8 only. jdk11 and later already grow aggressively.\nWhen `-Djava.lang.stringBufferAndBuilder.growAggressively` or\n`-Djava.lang.stringBufferAndBuilder.growAggressively=true` is set on\nthe command line, and doubling the capacity overflows Integer.MAX_VALUE, \ngrow StringBuffer and StringBuilder to Integer.MAX_VALUE instead of\nonly increasing the capacity by the size of the String being appended.\nCompatible with Hotspot behavior.\n\nAdd testing for the same.\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-01-30T19:45:12Z", "type": "commit"}, {"oid": "0301b816ac60791c4d6dfecf4eb06079e57536b8", "url": "https://github.com/eclipse-openj9/openj9/commit/0301b816ac60791c4d6dfecf4eb06079e57536b8", "message": "Grow StringBuffer and StringBuilder aggressively from 1G to 2G\n\nAffects jdk8 only. jdk11 and later already grow aggressively.\nWhen `-Djava.lang.stringBufferAndBuilder.growAggressively` or\n`-Djava.lang.stringBufferAndBuilder.growAggressively=true` is set on\nthe command line, and doubling the capacity overflows Integer.MAX_VALUE, \ngrow StringBuffer and StringBuilder to Integer.MAX_VALUE instead of\nonly increasing the capacity by the size of the String being appended.\nCompatible with Hotspot behavior.\n\nAdd testing for the same.\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-01-30T19:45:12Z", "type": "forcePushed"}]}