{"pr_number": 8334, "pr_title": "Avoids the concern about enqueue causing clear to be called", "pr_createdAt": "2020-01-17T20:29:05Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/8334", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEyNjU2Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8334#discussion_r368126567", "bodyText": "I believe this code should be moved to clearImpl() as well.  Otherwise, we could just null the field directly.\nNote, clearImpl() can be mad synchronized as its the method that needs to keep the referent and state consistent", "author": "DanHeidinga", "createdAt": "2020-01-17T20:38:42Z", "path": "jcl/src/java.base/share/classes/java/lang/ref/Reference.java", "diffHunk": "@@ -116,14 +116,21 @@ public boolean tryHandlePendingReference() {\n  */\t\n public void clear() {\n \tsynchronized(this) {\n-\t\treferent = null;\n+\t\tclearImpl();\n \t\t/* change the state to cleared if it's not already cleared or enqueued */\n \t\tif (STATE_INITIAL == state) {", "originalCommit": "29e792f446705e1bbc9be911370943425e1ffb91", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODYxOTIwMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8334#discussion_r368619200", "bodyText": "done", "author": "LinHu2016", "createdAt": "2020-01-20T15:55:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEyNjU2Nw=="}], "type": "inlineReview", "revised_code": {"commit": "2c2270f92fad398bcd02b2d83cd18f065979ade6", "chunk": "diff --git a/jcl/src/java.base/share/classes/java/lang/ref/Reference.java b/jcl/src/java.base/share/classes/java/lang/ref/Reference.java\nindex fcd915ae2..5a8a7451a 100644\n--- a/jcl/src/java.base/share/classes/java/lang/ref/Reference.java\n+++ b/jcl/src/java.base/share/classes/java/lang/ref/Reference.java\n\n@@ -115,20 +115,20 @@ public abstract class Reference<T> extends Object {\n  * Make the referent null.  This does not force the reference object to be enqueued.\n  */\t\n public void clear() {\n-\tsynchronized(this) {\n-\t\tclearImpl();\n-\t\t/* change the state to cleared if it's not already cleared or enqueued */\n-\t\tif (STATE_INITIAL == state) {\n-\t\t\tstate = STATE_CLEARED;\n-\t\t}\n-\t}\n+\tclearImpl();\n }\n \n /**\n  * set the referent to null.\n  */\t\n private void clearImpl() {\n-\treferent = null;\n+\tsynchronized(this) {\n+\t\treferent = null;\n+\t\t/* change the state to cleared if it's not already cleared or enqueued */\n+\t\tif (STATE_INITIAL == state) {\n+\t\t\tstate = STATE_CLEARED;\n+\t\t}\n+\t}\n }\n \n /**\n"}}, {"oid": "2c2270f92fad398bcd02b2d83cd18f065979ade6", "url": "https://github.com/eclipse-openj9/openj9/commit/2c2270f92fad398bcd02b2d83cd18f065979ade6", "message": "Avoids the concern about enqueue causing clear to be called\n\n\tnew private method clearImpl for setting the referent to null.\n\tclearImpl() is called from clear() and enqueue()\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>", "committedDate": "2020-01-20T15:52:14Z", "type": "commit"}, {"oid": "2c2270f92fad398bcd02b2d83cd18f065979ade6", "url": "https://github.com/eclipse-openj9/openj9/commit/2c2270f92fad398bcd02b2d83cd18f065979ade6", "message": "Avoids the concern about enqueue causing clear to be called\n\n\tnew private method clearImpl for setting the referent to null.\n\tclearImpl() is called from clear() and enqueue()\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>", "committedDate": "2020-01-20T15:52:14Z", "type": "forcePushed"}]}