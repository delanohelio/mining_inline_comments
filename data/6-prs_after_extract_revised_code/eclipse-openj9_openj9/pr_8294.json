{"pr_number": 8294, "pr_title": "Improve handling of endianness", "pr_createdAt": "2020-01-13T22:55:06Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/8294", "timeline": [{"oid": "d4392cee695a6ea4b9bf8a4a5ec74f556be39875", "url": "https://github.com/eclipse-openj9/openj9/commit/d4392cee695a6ea4b9bf8a4a5ec74f556be39875", "message": "Change copyright\n\nChange copyright to 2020 for involved files.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>", "committedDate": "2020-01-13T23:20:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTczMzI0Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8294#discussion_r369733243", "bodyText": "why is this better? having a static final with no depenencies in the JCL should be more predictable. The static final here is also a primitive type so can be constant folded unlike nativeOrder() which returns an object so we can only get a known object constraint. This doesn't seem like an improvement...", "author": "andrewcraik", "createdAt": "2020-01-22T18:38:06Z", "path": "jcl/src/java.base/share/classes/com/ibm/jit/JITHelpers.java", "diffHunk": "@@ -462,7 +462,7 @@ public char byteToCharUnsigned(byte b) {\n \tpublic native boolean acmplt(Object lhs, Object rhs);\n \n \tprivate static long storeBits(long dest, int width, long value, int vwidth, int offset) {\n-\t\tint offsetToModify = IS_PLATFORM_LITTLE_ENDIAN ? ((offset * vwidth) % width) : ((width - 1) - ((offset * vwidth) % width));\n+\t\tint offsetToModify = (ByteOrder.nativeOrder() == ByteOrder.LITTLE_ENDIAN) ? ((offset * vwidth) % width) : ((width - 1) - ((offset * vwidth) % width));", "originalCommit": "d4392cee695a6ea4b9bf8a4a5ec74f556be39875", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc0MzAyNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8294#discussion_r369743024", "bodyText": "This is simply avoiding duplication of logic. Referencing #4741 for the background. ByteOrder.nativeOrder() is a user land API, and we want such calls folded away as the typical (and only) use case is to compare against ByteOrder.LITTLE_ENDIAN and ByteOrder.BIG_ENDIAN. We already more or less did this with JITHelpers.IS_PLATFORM_LITTLE_ENDIAN, but in a different way.\nThere is no reason why we should have two nearly identical ways of determining endianness. This PR consolidates everything to add support for folding away the userland API (which will benefit all code; JCL or not), and as such we eat our own dogfood and use the same API in the JCL.\nIt is no different than the rest of the fields in classes found in foldFinalFieldsIn. StringCompressionFlag is another such example.", "author": "fjeremic", "createdAt": "2020-01-22T18:57:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTczMzI0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgyNzE0NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8294#discussion_r369827145", "bodyText": "There are two good reasons for keeping the code 1) it means we do not add a dependency from an OpenJ9 class onto the JCL (in a seemingly unrelated package and 2) the fact the field is a primitive allows the filed to become a constant rather than just an object constraint - this can simplify eliminating tests at low optimization levels.", "author": "andrewcraik", "createdAt": "2020-01-22T21:59:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTczMzI0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgyODE2Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8294#discussion_r369828167", "bodyText": "we don't have to respect modification of the JITHelper internal final field while we do have to do the same for ByteOrder (at least notionally) - basically it simplifies handling eliminating the field load.", "author": "andrewcraik", "createdAt": "2020-01-22T22:01:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTczMzI0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg0NDM1Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/8294#discussion_r369844352", "bodyText": "I see your point. It certainly is more complex under the hood if ByteOrder.nativeOrder() is used instead of IS_PLATFORM_LITTLE_ENDIAN in JITHelpers. I don't think reverting back is a deal breaker. What I would like to see is removal of the isPlatformLittleEndian() native method though. This logic is already duplicated for nativeOrder [1]. We can just reuse [1] instead (Unsafe.isBigEndian()).\n@simonameng can you make the appropriate changes?\n[1] https://github.com/eclipse/openj9/blob/83f3cbdb4c413343da35f449bb97174c618df478/runtime/jcl/common/sun_misc_Unsafe.cpp#L704-L712", "author": "fjeremic", "createdAt": "2020-01-22T22:38:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTczMzI0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTkyMzEwMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/8294#discussion_r369923102", "bodyText": "@fjeremic Sure. I'll reuse Java_sun_misc_Unsafe_isBigEndian0 in the JITHelpers instead of ByteOrder.nativeOrder()", "author": "simonameng", "createdAt": "2020-01-23T04:03:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTczMzI0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE0NjU5OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8294#discussion_r370146598", "bodyText": "That sounds like a reasonable compromise - use Unsafe to init the field and use the field in the JITHelpers where needed sounds like a good plan.", "author": "andrewcraik", "createdAt": "2020-01-23T14:24:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTczMzI0Mw=="}], "type": "inlineReview", "revised_code": {"commit": "15d15b015a7887092fc5db812eaa548ec371646d", "chunk": "diff --git a/jcl/src/java.base/share/classes/com/ibm/jit/JITHelpers.java b/jcl/src/java.base/share/classes/com/ibm/jit/JITHelpers.java\nindex 261d4461f..db4ae3112 100644\n--- a/jcl/src/java.base/share/classes/com/ibm/jit/JITHelpers.java\n+++ b/jcl/src/java.base/share/classes/com/ibm/jit/JITHelpers.java\n\n@@ -462,7 +462,7 @@ public final class JITHelpers {\n \tpublic native boolean acmplt(Object lhs, Object rhs);\n \n \tprivate static long storeBits(long dest, int width, long value, int vwidth, int offset) {\n-\t\tint offsetToModify = (ByteOrder.nativeOrder() == ByteOrder.LITTLE_ENDIAN) ? ((offset * vwidth) % width) : ((width - 1) - ((offset * vwidth) % width));\n+\t\tint offsetToModify = IS_BIG_ENDIAN ? ((width - 1) - ((offset * vwidth) % width)) : ((offset * vwidth) % width);\n \n \t\tlong vmask = (-1 >>> ((8 - vwidth) * 8));\n \t\tlong dmask = ~(vmask << (8 * offsetToModify));\n"}}, {"oid": "15d15b015a7887092fc5db812eaa548ec371646d", "url": "https://github.com/eclipse-openj9/openj9/commit/15d15b015a7887092fc5db812eaa548ec371646d", "message": "Add native function 'isBigEndian' in JITHelpers.java\n\nAdd native function 'isBigEndian' in 'JITHelpers.java' following the implementation of 'Java_sun_misc_Unsafe_isBigEndian0' for consistency. Because 'Unsafe.isBigEndian' is introduced for Java9+ only. We cannot use the function directly.\n\nAlso, deprecate 'runtime/jcl/uma/jithelpers_jni_exports.xml' in favor of the new implemented function 'isBigEndian'.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>", "committedDate": "2020-02-06T20:14:14Z", "type": "forcePushed"}, {"oid": "4fd0f9e23d52ad0cf51d5280520479fb65f47623", "url": "https://github.com/eclipse-openj9/openj9/commit/4fd0f9e23d52ad0cf51d5280520479fb65f47623", "message": "Add native function 'isBigEndian' in JITHelpers.java\n\nAdd native function 'isBigEndian' following the implementation of 'Java_sun_misc_Unsafe_isBigEndian0'.\n\nDeprecate `IS_PLATFORM_LITTLE_ENDIAN` with `isBigEndian` function.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>", "committedDate": "2020-02-06T21:00:22Z", "type": "forcePushed"}, {"oid": "54938c0c0d31ff50115ac0984eab8caf5e555a45", "url": "https://github.com/eclipse-openj9/openj9/commit/54938c0c0d31ff50115ac0984eab8caf5e555a45", "message": "Add native function 'isBigEndian' in JITHelpers.java\n\nAdd native function 'isBigEndian' following the implementation of 'Java_sun_misc_Unsafe_isBigEndian0'.\n\nDeprecate `IS_PLATFORM_LITTLE_ENDIAN` with `isBigEndian` function.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>", "committedDate": "2020-02-06T21:04:02Z", "type": "forcePushed"}, {"oid": "ca2381c0bac08bd5f96ae731c8f6d413b772a132", "url": "https://github.com/eclipse-openj9/openj9/commit/ca2381c0bac08bd5f96ae731c8f6d413b772a132", "message": "Add native function 'isBigEndian' in JITHelpers.java\n\nAdd native function 'isBigEndian' following the implementation of 'Java_sun_misc_Unsafe_isBigEndian0'.\n\nDeprecate `IS_PLATFORM_LITTLE_ENDIAN` with `isBigEndian` function.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>", "committedDate": "2020-02-06T21:06:21Z", "type": "forcePushed"}, {"oid": "e572188cf2091a26587e720125bb85105af029fd", "url": "https://github.com/eclipse-openj9/openj9/commit/e572188cf2091a26587e720125bb85105af029fd", "message": "Use 'putByteInArrayByIndex' in Test_JITHelpers.java\n\nUse `putByteInArrayByIndex` function to put the zero byte into the\nright index of `char[]`, instead of checking the `byteOrder` and\nthen doing `&= 0x00FF` or `&= 0xFF00`\n\nSigned-off-by: simonameng <simonameng97@gmail.com>", "committedDate": "2020-02-06T21:24:20Z", "type": "commit"}, {"oid": "3b10478d58186d4999a928b4b94144b676946904", "url": "https://github.com/eclipse-openj9/openj9/commit/3b10478d58186d4999a928b4b94144b676946904", "message": "Inline and fold away 'nativeOrder' and 'byteOrder' function\n\nAdd `nativeOrder` and `byteOrder` to j9 method list, worth inlining\nlist and 'foldFinalFieldsIn' list.\n\nChange copyright in relevant files.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>", "committedDate": "2020-02-06T21:25:23Z", "type": "commit"}, {"oid": "c3b31dfd306d222a956ce4dd122bd8f1f0aa1b09", "url": "https://github.com/eclipse-openj9/openj9/commit/c3b31dfd306d222a956ce4dd122bd8f1f0aa1b09", "message": "Add native function 'isBigEndian' in JITHelpers.java\n\nAdd native function 'isBigEndian' following the implementation\nof 'Java_sun_misc_Unsafe_isBigEndian0'.\n\nDeprecate `IS_PLATFORM_LITTLE_ENDIAN` with `isBigEndian` function.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>", "committedDate": "2020-02-06T21:26:07Z", "type": "commit"}, {"oid": "c3b31dfd306d222a956ce4dd122bd8f1f0aa1b09", "url": "https://github.com/eclipse-openj9/openj9/commit/c3b31dfd306d222a956ce4dd122bd8f1f0aa1b09", "message": "Add native function 'isBigEndian' in JITHelpers.java\n\nAdd native function 'isBigEndian' following the implementation\nof 'Java_sun_misc_Unsafe_isBigEndian0'.\n\nDeprecate `IS_PLATFORM_LITTLE_ENDIAN` with `isBigEndian` function.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>", "committedDate": "2020-02-06T21:26:07Z", "type": "forcePushed"}]}