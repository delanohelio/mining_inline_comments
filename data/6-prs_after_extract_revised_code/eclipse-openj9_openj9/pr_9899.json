{"pr_number": 9899, "pr_title": "[Test] Disable the timeout setting on RISC-V", "pr_createdAt": "2020-06-16T14:56:26Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/9899", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTExMzYwNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/9899#discussion_r441113606", "bodyText": "This is going to break Linux.", "author": "pshipton", "createdAt": "2020-06-16T20:11:56Z", "path": "test/functional/cmdline_options_tester/src/Test.java", "diffHunk": "@@ -409,7 +409,9 @@ public void dumpVerboseOutput(boolean result) {\n \n \tpublic static int getUnixPID(Process process) throws Exception {\n \t\tClass<?> cl = process.getClass();\n-\t\tif (!cl.getName().equals(\"java.lang.UNIXProcess\")) {\n+\t\tif (!cl.getName().equals(\"java.lang.UNIXProcess\") \n+\t\t|| !cl.getName().equals(\"java.lang.ProcessImpl\")  /* intended for Fedora_Linux/RISC-V */", "originalCommit": "5b2da262f1fe15edd90c590a8c3ebef94d08b272", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTExNjI2MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9899#discussion_r441116260", "bodyText": "Nope, the change was verified on personal builds (including all platforms)", "author": "ChengJin01", "createdAt": "2020-06-16T20:17:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTExMzYwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTExNjg3OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9899#discussion_r441116879", "bodyText": "If you are concerned with the potential issue,  we can add the check to ensure it only exists on RISC-V.", "author": "ChengJin01", "createdAt": "2020-06-16T20:18:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTExMzYwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEyNjgwOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9899#discussion_r441126808", "bodyText": "When cl is UNIXProcess, if (!(true) || !(false)) or if (false || true) is always true, so on Linux it will return 0. This code is only used when a timeout occurs, so a test would have to hang in order to see it no longer works on Unix.\n\nwe can add the check to ensure it only exists on RISC-V.\n\nthis would be better", "author": "pshipton", "createdAt": "2020-06-16T20:36:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTExMzYwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEzMTkwNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9899#discussion_r441131905", "bodyText": "Added as suggested above.", "author": "ChengJin01", "createdAt": "2020-06-16T20:46:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTExMzYwNg=="}], "type": "inlineReview", "revised_code": {"commit": "906724f52764099452146c022619d9b0595242a2", "chunk": "diff --git a/test/functional/cmdline_options_tester/src/Test.java b/test/functional/cmdline_options_tester/src/Test.java\nindex 80f6adfb2..20b78aa0c 100644\n--- a/test/functional/cmdline_options_tester/src/Test.java\n+++ b/test/functional/cmdline_options_tester/src/Test.java\n\n@@ -410,7 +413,7 @@ class Test {\n \tpublic static int getUnixPID(Process process) throws Exception {\n \t\tClass<?> cl = process.getClass();\n \t\tif (!cl.getName().equals(\"java.lang.UNIXProcess\") \n-\t\t|| !cl.getName().equals(\"java.lang.ProcessImpl\")  /* intended for Fedora_Linux/RISC-V */\n+\t\t|| (!cl.getName().equals(\"java.lang.ProcessImpl\") && isRiscv)  /* intended for Fedora_Linux/RISC-V */\n \t\t) {\n \t\t\treturn 0;\n \t\t}\n"}}, {"oid": "906724f52764099452146c022619d9b0595242a2", "url": "https://github.com/eclipse-openj9/openj9/commit/906724f52764099452146c022619d9b0595242a2", "message": "[Test] Disable JIT & the timeout setting on RISC-V\n\nThe code change is to disable JIT in test code\nand disable the timeout setting due to the lack\nof JIT on RISC-V.\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-06-16T20:45:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE0MzYzNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9899#discussion_r441143635", "bodyText": "The check against ProcessImpl is not needed and is confusing, pls use if (!cl.getName().equals(\"java.lang.UNIXProcess\") || isRiscv)", "author": "pshipton", "createdAt": "2020-06-16T21:09:43Z", "path": "test/functional/cmdline_options_tester/src/Test.java", "diffHunk": "@@ -409,7 +412,9 @@ public void dumpVerboseOutput(boolean result) {\n \n \tpublic static int getUnixPID(Process process) throws Exception {\n \t\tClass<?> cl = process.getClass();\n-\t\tif (!cl.getName().equals(\"java.lang.UNIXProcess\")) {\n+\t\tif (!cl.getName().equals(\"java.lang.UNIXProcess\") \n+\t\t|| (!cl.getName().equals(\"java.lang.ProcessImpl\") && isRiscv)  /* intended for Fedora_Linux/RISC-V */", "originalCommit": "906724f52764099452146c022619d9b0595242a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE1NjMxMQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9899#discussion_r441156311", "bodyText": "Agree and fixed in this way.", "author": "ChengJin01", "createdAt": "2020-06-16T21:36:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE0MzYzNQ=="}], "type": "inlineReview", "revised_code": {"commit": "9b6753fff9b540464ef59be5dbefc828e784bd5d", "chunk": "diff --git a/test/functional/cmdline_options_tester/src/Test.java b/test/functional/cmdline_options_tester/src/Test.java\nindex 20b78aa0c..61d095cc1 100644\n--- a/test/functional/cmdline_options_tester/src/Test.java\n+++ b/test/functional/cmdline_options_tester/src/Test.java\n\n@@ -412,9 +412,7 @@ class Test {\n \n \tpublic static int getUnixPID(Process process) throws Exception {\n \t\tClass<?> cl = process.getClass();\n-\t\tif (!cl.getName().equals(\"java.lang.UNIXProcess\") \n-\t\t|| (!cl.getName().equals(\"java.lang.ProcessImpl\") && isRiscv)  /* intended for Fedora_Linux/RISC-V */\n-\t\t) {\n+\t\tif (!cl.getName().equals(\"java.lang.UNIXProcess\") || isRiscv ) {\n \t\t\treturn 0;\n \t\t}\n \t\tField field = cl.getDeclaredField(\"pid\");\n"}}, {"oid": "9b6753fff9b540464ef59be5dbefc828e784bd5d", "url": "https://github.com/eclipse-openj9/openj9/commit/9b6753fff9b540464ef59be5dbefc828e784bd5d", "message": "[Test] Disable JIT & the timeout setting on RISC-V\n\nThe code change is to disable JIT in test code\nand disable the timeout setting due to the lack\nof JIT on RISC-V.\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-06-16T21:34:41Z", "type": "forcePushed"}, {"oid": "5fbda2da49fa44897add6b4f1d92dec280777a5c", "url": "https://github.com/eclipse-openj9/openj9/commit/5fbda2da49fa44897add6b4f1d92dec280777a5c", "message": "[Test] Disable JIT & the timeout setting on RISC-V\n\nThe code change is to disable JIT in test code\nand disable the timeout setting due to the lack\nof JIT on RISC-V.\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-06-16T21:35:33Z", "type": "forcePushed"}, {"oid": "5cb219337b7be53bb20b2484444152bbf1a07fd8", "url": "https://github.com/eclipse-openj9/openj9/commit/5cb219337b7be53bb20b2484444152bbf1a07fd8", "message": "[Test] Disable JIT & the timeout setting on RISC-V\n\nThe code change is to disable JIT in test code\nand disable the timeout setting due to the lack\nof JIT on RISC-V.\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-06-17T16:57:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc3OTYzNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9899#discussion_r441779635", "bodyText": "Is it better to change the default timeout when testing on riscv rather than modifying the test framework?", "author": "pshipton", "createdAt": "2020-06-17T19:21:47Z", "path": "test/functional/cmdline_options_tester/src/Test.java", "diffHunk": "@@ -546,7 +549,10 @@ public ProcessKiller(Process proc, long timeout, String exeToDebug) {\n \t\tpublic synchronized void run() {\n \t\t\tfinal long endTime = System.currentTimeMillis() + _procTimeout;\n \t\t\twhile (_proc.isAlive()) {\n-\t\t\t\tlong currTimeout = endTime - System.currentTimeMillis();\n+\t\t\t\t/* Set up a fixed timer without timeout for test on RISC-V\n+\t\t\t\t * as it is pretty slow without JIT support for now.\n+\t\t\t\t */\n+\t\t\t\tlong currTimeout = (isRiscv) ? _procTimeout : (endTime - System.currentTimeMillis());", "originalCommit": "5cb219337b7be53bb20b2484444152bbf1a07fd8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4NjE1Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9899#discussion_r441786157", "bodyText": "Currently the idea of the code is looping out there by setting up the fixed time (which is always > 0) to get the test involved to complete.  I am not sure what the default timeout is gonna be as it is hard to anticipate how long it takes to finish.", "author": "ChengJin01", "createdAt": "2020-06-17T19:34:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc3OTYzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc5NzU0OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9899#discussion_r441797549", "bodyText": "The default could be set arbitrarily large, such as 24 hours or anything that makes sense.", "author": "pshipton", "createdAt": "2020-06-17T19:56:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc3OTYzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgwOTAwMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9899#discussion_r441809000", "bodyText": "Will try to change the code  at /test/functional/cmdline_options_tester/src/TestConfigParser.java\nString timeout = (String)attributes.get(\"timeout\");\n_currentTest = new Test( id, timeout, _debugCmdOnTimeout ); <--- change it for risc-v\n\nto see how it goes this way.", "author": "ChengJin01", "createdAt": "2020-06-17T20:19:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc3OTYzNQ=="}], "type": "inlineReview", "revised_code": {"commit": "7b87d806a30144707bfc729ac078ecdb9eee38ae", "chunk": "diff --git a/test/functional/cmdline_options_tester/src/Test.java b/test/functional/cmdline_options_tester/src/Test.java\nindex 50988c396..e1568e6bd 100644\n--- a/test/functional/cmdline_options_tester/src/Test.java\n+++ b/test/functional/cmdline_options_tester/src/Test.java\n\n@@ -549,10 +549,7 @@ class Test {\n \t\tpublic synchronized void run() {\n \t\t\tfinal long endTime = System.currentTimeMillis() + _procTimeout;\n \t\t\twhile (_proc.isAlive()) {\n-\t\t\t\t/* Set up a fixed timer without timeout for test on RISC-V\n-\t\t\t\t * as it is pretty slow without JIT support for now.\n-\t\t\t\t */\n-\t\t\t\tlong currTimeout = (isRiscv) ? _procTimeout : (endTime - System.currentTimeMillis());\n+\t\t\t\tlong currTimeout = endTime - System.currentTimeMillis();\n \t\t\t\tif (currTimeout > 0) {\n \t\t\t\t\ttry {\n \t\t\t\t\t\t_proc.waitFor(currTimeout, TimeUnit.MILLISECONDS);\n"}}, {"oid": "bdf780e908a326200bcc41972bc4d1a3044330c2", "url": "https://github.com/eclipse-openj9/openj9/commit/bdf780e908a326200bcc41972bc4d1a3044330c2", "message": "[Test] Disable the timeout setting on RISC-V\n\nThe code change is to disable the timeout setting\ndue to the lack of JIT on RISC-V.\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-06-17T20:41:00Z", "type": "forcePushed"}, {"oid": "7b87d806a30144707bfc729ac078ecdb9eee38ae", "url": "https://github.com/eclipse-openj9/openj9/commit/7b87d806a30144707bfc729ac078ecdb9eee38ae", "message": "[Test] Disable the timeout setting on RISC-V\n\nThe code change is to disable the timeout setting\ndue to the lack of JIT on RISC-V.\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-06-17T22:41:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTkzNjUzMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9899#discussion_r441936530", "bodyText": "Seems a little excessive for a single test to run for 10 days.", "author": "pshipton", "createdAt": "2020-06-18T02:42:06Z", "path": "test/functional/cmdline_options_tester/src/TestConfigParser.java", "diffHunk": "@@ -156,6 +159,10 @@ public void xmlStartElement(String elementName, Hashtable attributes) {\n \t\t\t\t\tString modeHints = (String)attributes.get(\"modeHints\");\n \t\t\t\t\tif (hasAllowedHints(modeHints)) {\n \t\t\t\t\t\tString timeout = (String)attributes.get(\"timeout\");\n+\t\t\t\t\t\t\n+\t\t\t\t\t\t/* Set 10 days (864000 secs) for timeout on RISC-V due to the lack of JIT */", "originalCommit": "7b87d806a30144707bfc729ac078ecdb9eee38ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTkzOTE1Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9899#discussion_r441939153", "bodyText": "It won't be necessary in most of cases. The idea is to simply disable the timer to some extent to ensure we cover all test cases in /test/functional/cmdLineTests. (e.g. DDR related test which runs extremely slow on the hardware and even worse on the emulator).", "author": "ChengJin01", "createdAt": "2020-06-18T02:52:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTkzNjUzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk0Mzc2NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9899#discussion_r441943765", "bodyText": "Ok, but the timeout is for an individual command line test, not a suite of tests. How long does the DDR test take?", "author": "pshipton", "createdAt": "2020-06-18T03:11:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTkzNjUzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk0NjcxMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9899#discussion_r441946713", "bodyText": "Yes, that's we expect to do for individual tests.  According to my previous experience, it took from a couple of hours to half of a day to finish, depending on the size of the generated core dumps.", "author": "ChengJin01", "createdAt": "2020-06-18T03:23:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTkzNjUzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk1MzE0MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9899#discussion_r441953140", "bodyText": "Then you can use something like 16 hours for the timeout, rather than 10 days.", "author": "pshipton", "createdAt": "2020-06-18T03:51:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTkzNjUzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk1NTM1Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/9899#discussion_r441955352", "bodyText": "Updated to 16 hours as suggested. We still have a chance to adjust in the future if any issue with timeout is detected in there.", "author": "ChengJin01", "createdAt": "2020-06-18T04:00:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTkzNjUzMA=="}], "type": "inlineReview", "revised_code": {"commit": "c18c7f8c23dd1098ce9daf9128f4013c7f17e127", "chunk": "diff --git a/test/functional/cmdline_options_tester/src/TestConfigParser.java b/test/functional/cmdline_options_tester/src/TestConfigParser.java\nindex 5321e5101..56147ebfb 100644\n--- a/test/functional/cmdline_options_tester/src/TestConfigParser.java\n+++ b/test/functional/cmdline_options_tester/src/TestConfigParser.java\n\n@@ -160,8 +160,8 @@ class TestConfigParser {\n \t\t\t\t\tif (hasAllowedHints(modeHints)) {\n \t\t\t\t\t\tString timeout = (String)attributes.get(\"timeout\");\n \t\t\t\t\t\t\n-\t\t\t\t\t\t/* Set 10 days (864000 secs) for timeout on RISC-V due to the lack of JIT */\n-\t\t\t\t\t\ttimeout = (isRiscv) ? \"864000\" : timeout;\n+\t\t\t\t\t\t/* Set 16 hours (57600 secs) for timeout on RISC-V due to the lack of JIT */\n+\t\t\t\t\t\ttimeout = (isRiscv) ? \"57600\" : timeout;\n \t\t\t\t\t\t\n \t\t\t\t\t\t_currentTest = new Test( id, timeout, _debugCmdOnTimeout );\n \t\t\t\t\t} else {\n"}}, {"oid": "c18c7f8c23dd1098ce9daf9128f4013c7f17e127", "url": "https://github.com/eclipse-openj9/openj9/commit/c18c7f8c23dd1098ce9daf9128f4013c7f17e127", "message": "[Test] Disable the timeout setting on RISC-V\n\nThe code change is to disable the timeout setting\ndue to the lack of JIT on RISC-V.\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-06-18T03:58:58Z", "type": "commit"}, {"oid": "c18c7f8c23dd1098ce9daf9128f4013c7f17e127", "url": "https://github.com/eclipse-openj9/openj9/commit/c18c7f8c23dd1098ce9daf9128f4013c7f17e127", "message": "[Test] Disable the timeout setting on RISC-V\n\nThe code change is to disable the timeout setting\ndue to the lack of JIT on RISC-V.\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-06-18T03:58:58Z", "type": "forcePushed"}]}