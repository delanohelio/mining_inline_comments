{"pr_number": 10979, "pr_title": "Use valueOf instead of primitive wrapper constructors", "pr_createdAt": "2020-10-23T18:42:47Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/10979", "timeline": [{"oid": "7c6f4f5869f8831588afc36bd943fd934fd92adc", "url": "https://github.com/eclipse-openj9/openj9/commit/7c6f4f5869f8831588afc36bd943fd934fd92adc", "message": "Use valueOf instead of primitive wrapper constructors\n\nSearch and replace of `new PrimitiveType(` with `PrimitiveType.valueOf(`\n\nFixes: #10937\n\n[ci skip]\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>", "committedDate": "2020-10-23T18:47:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA5MjY5OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10979#discussion_r511092698", "bodyText": "Any requirement for these to be unique objects?  valueOf will use the Integer cache where new Integer wouldn't", "author": "DanHeidinga", "createdAt": "2020-10-23T19:11:49Z", "path": "test/functional/JIT_Test/src/jit/test/vich/JNILocalRef.java", "diffHunk": "@@ -53,38 +53,38 @@ public JNILocalRef() {\n \t@Test(groups = { \"level.sanity\",\"component.jit\" })\n \tpublic void testJNILocalRef()\n \t{\n-\t\tObject o1 = new Integer(0);\n-\t\tObject o2 = new Integer(0);\n-\t\tObject o3 = new Integer(0);\n-\t\tObject o4 = new Integer(0);\n-\t\tObject o5 = new Integer(0);\n-\t\tObject o6 = new Integer(0);\n-\t\tObject o7 = new Integer(0);\n-\t\tObject o8 = new Integer(0);\n-\t\tObject o9 = new Integer(0);\n-\t\tObject o10 = new Integer(0);\n-\t\tObject o11 = new Integer(0);\n-\t\tObject o12 = new Integer(0);\n-\t\tObject o13 = new Integer(0);\n-\t\tObject o14 = new Integer(0);\n-\t\tObject o15 = new Integer(0);\n-\t\tObject o16 = new Integer(0);\n-\t\tObject o17 = new Integer(0);\n-\t\tObject o18 = new Integer(0);\n-\t\tObject o19 = new Integer(0);\n-\t\tObject o20 = new Integer(0);\n-\t\tObject o21 = new Integer(0);\n-\t\tObject o22 = new Integer(0);\n-\t\tObject o23 = new Integer(0);\n-\t\tObject o24 = new Integer(0);\n-\t\tObject o25 = new Integer(0);\n-\t\tObject o26 = new Integer(0);\n-\t\tObject o27 = new Integer(0);\n-\t\tObject o28 = new Integer(0);\n-\t\tObject o29 = new Integer(0);\n-\t\tObject o30 = new Integer(0);\n-\t\tObject o31 = new Integer(0);\n-\t\tObject o32 = new Integer(0);\n+\t\tObject o1 = Integer.valueOf(0);\n+\t\tObject o2 = Integer.valueOf(0);", "originalCommit": "7c6f4f5869f8831588afc36bd943fd934fd92adc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEwMDQwOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10979#discussion_r511100409", "bodyText": "This probably does change the sense of the test, but this test is pretty useless these days, and continues to pass with these changes.", "author": "gacholio", "createdAt": "2020-10-23T19:20:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA5MjY5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE0MDQ5Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/10979#discussion_r511140496", "bodyText": "Updated to use unique objects.", "author": "gacholio", "createdAt": "2020-10-23T20:28:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA5MjY5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE0NTUwMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10979#discussion_r511145500", "bodyText": "Changing them to new Object() is potentially giving our selves more work in the future considering that Object may become an abstract class. For these sort of things where we need a ref type but dont really care what kind we should just define a static inner class.", "author": "tajila", "createdAt": "2020-10-23T20:41:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA5MjY5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE0OTU5OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10979#discussion_r511149599", "bodyText": "Updated.", "author": "gacholio", "createdAt": "2020-10-23T20:51:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA5MjY5OA=="}], "type": "inlineReview", "revised_code": {"commit": "a67c53f3b30a0c16f68921720bdb9868bf1bd0cb", "chunk": "diff --git a/test/functional/JIT_Test/src/jit/test/vich/JNILocalRef.java b/test/functional/JIT_Test/src/jit/test/vich/JNILocalRef.java\nindex f2597e784..06ad184aa 100644\n--- a/test/functional/JIT_Test/src/jit/test/vich/JNILocalRef.java\n+++ b/test/functional/JIT_Test/src/jit/test/vich/JNILocalRef.java\n\n@@ -53,38 +53,38 @@ public class JNILocalRef {\n \t@Test(groups = { \"level.sanity\",\"component.jit\" })\n \tpublic void testJNILocalRef()\n \t{\n-\t\tObject o1 = Integer.valueOf(0);\n-\t\tObject o2 = Integer.valueOf(0);\n-\t\tObject o3 = Integer.valueOf(0);\n-\t\tObject o4 = Integer.valueOf(0);\n-\t\tObject o5 = Integer.valueOf(0);\n-\t\tObject o6 = Integer.valueOf(0);\n-\t\tObject o7 = Integer.valueOf(0);\n-\t\tObject o8 = Integer.valueOf(0);\n-\t\tObject o9 = Integer.valueOf(0);\n-\t\tObject o10 = Integer.valueOf(0);\n-\t\tObject o11 = Integer.valueOf(0);\n-\t\tObject o12 = Integer.valueOf(0);\n-\t\tObject o13 = Integer.valueOf(0);\n-\t\tObject o14 = Integer.valueOf(0);\n-\t\tObject o15 = Integer.valueOf(0);\n-\t\tObject o16 = Integer.valueOf(0);\n-\t\tObject o17 = Integer.valueOf(0);\n-\t\tObject o18 = Integer.valueOf(0);\n-\t\tObject o19 = Integer.valueOf(0);\n-\t\tObject o20 = Integer.valueOf(0);\n-\t\tObject o21 = Integer.valueOf(0);\n-\t\tObject o22 = Integer.valueOf(0);\n-\t\tObject o23 = Integer.valueOf(0);\n-\t\tObject o24 = Integer.valueOf(0);\n-\t\tObject o25 = Integer.valueOf(0);\n-\t\tObject o26 = Integer.valueOf(0);\n-\t\tObject o27 = Integer.valueOf(0);\n-\t\tObject o28 = Integer.valueOf(0);\n-\t\tObject o29 = Integer.valueOf(0);\n-\t\tObject o30 = Integer.valueOf(0);\n-\t\tObject o31 = Integer.valueOf(0);\n-\t\tObject o32 = Integer.valueOf(0);\n+\t\tObject o1 = new Object();\n+\t\tObject o2 = new Object();\n+\t\tObject o3 = new Object();\n+\t\tObject o4 = new Object();\n+\t\tObject o5 = new Object();\n+\t\tObject o6 = new Object();\n+\t\tObject o7 = new Object();\n+\t\tObject o8 = new Object();\n+\t\tObject o9 = new Object();\n+\t\tObject o10 = new Object();\n+\t\tObject o11 = new Object();\n+\t\tObject o12 = new Object();\n+\t\tObject o13 = new Object();\n+\t\tObject o14 = new Object();\n+\t\tObject o15 = new Object();\n+\t\tObject o16 = new Object();\n+\t\tObject o17 = new Object();\n+\t\tObject o18 = new Object();\n+\t\tObject o19 = new Object();\n+\t\tObject o20 = new Object();\n+\t\tObject o21 = new Object();\n+\t\tObject o22 = new Object();\n+\t\tObject o23 = new Object();\n+\t\tObject o24 = new Object();\n+\t\tObject o25 = new Object();\n+\t\tObject o26 = new Object();\n+\t\tObject o27 = new Object();\n+\t\tObject o28 = new Object();\n+\t\tObject o29 = new Object();\n+\t\tObject o30 = new Object();\n+\t\tObject o31 = new Object();\n+\t\tObject o32 = new Object();\n \t\t\n \t\ttry\n \t\t{\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA5NjUyNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10979#discussion_r511096526", "bodyText": "Similar concern about caching of Boolean.valueOf() and changing the test as the lifetime of the Boolean is now much longer", "author": "DanHeidinga", "createdAt": "2020-10-23T19:16:18Z", "path": "test/functional/Java8andUp/src/org/openj9/test/java/lang/ref/Test_PhantomReference.java", "diffHunk": "@@ -42,7 +42,7 @@ protected void doneSuite() {\n \t@Test\n \tpublic void test_get() {\n \t\tReferenceQueue rq = new ReferenceQueue();\n-\t\tbool = new Boolean(false);\n+\t\tbool = Boolean.valueOf(false);\n \t\tPhantomReference pr = new PhantomReference(bool, rq);", "originalCommit": "7c6f4f5869f8831588afc36bd943fd934fd92adc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEwMDkyOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10979#discussion_r511100928", "bodyText": "There's only one use here, so I don't think it matters.", "author": "gacholio", "createdAt": "2020-10-23T19:21:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA5NjUyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEyOTMwMQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10979#discussion_r511129301", "bodyText": "Only 1 use in this test but are you sure no other code in the class library is using Boolean.valueOf(false)?  The PhantomRef presumable will indicate when the bool has been collected and that may never happen due to using a cached version,", "author": "DanHeidinga", "createdAt": "2020-10-23T20:01:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA5NjUyNg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA5NjkxMQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10979#discussion_r511096911", "bodyText": "Same concern about extended life time here", "author": "DanHeidinga", "createdAt": "2020-10-23T19:16:45Z", "path": "test/functional/Java8andUp/src/org/openj9/test/java/lang/ref/Test_PhantomReference.java", "diffHunk": "@@ -53,7 +53,7 @@ public void test_get() {\n \t@Test\n \tpublic void test_Constructor() {\n \t\tReferenceQueue rq = new ReferenceQueue();\n-\t\tbool = new Boolean(true);\n+\t\tbool = Boolean.valueOf(true);", "originalCommit": "7c6f4f5869f8831588afc36bd943fd934fd92adc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEwMTg2MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10979#discussion_r511101861", "bodyText": "Single use.", "author": "gacholio", "createdAt": "2020-10-23T19:22:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA5NjkxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEyNTk2NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10979#discussion_r511125965", "bodyText": "I've never understood what phantom does - aside from the potentially cached object, this test appears broken in two other ways:\n\nusing sleep is extremely unreliable\nthe bool variable is never set to null, so there's no guarantee it won't be collected even without the caching", "author": "gacholio", "createdAt": "2020-10-23T19:54:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA5NjkxMQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA5NzQ0NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10979#discussion_r511097445", "bodyText": "Similar concerns with this test", "author": "DanHeidinga", "createdAt": "2020-10-23T19:17:22Z", "path": "test/functional/Java8andUp/src/org/openj9/test/java/lang/ref/Test_ReferenceQueue.java", "diffHunk": "@@ -55,7 +55,7 @@ public void run() {\n \t\t\tsynchronized (rq) {\n \t\t\t\t// store in a static so it won't be gc'ed because the jit\n \t\t\t\t// optimized it out\n-\t\t\t\tinteger = new Integer(667);\n+\t\t\t\tinteger = Integer.valueOf(667);", "originalCommit": "7c6f4f5869f8831588afc36bd943fd934fd92adc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEwMTU4NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10979#discussion_r511101584", "bodyText": "Single use, and realistically, no one is caching 667.", "author": "gacholio", "createdAt": "2020-10-23T19:22:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA5NzQ0NQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "a67c53f3b30a0c16f68921720bdb9868bf1bd0cb", "url": "https://github.com/eclipse-openj9/openj9/commit/a67c53f3b30a0c16f68921720bdb9868bf1bd0cb", "message": "Use valueOf instead of primitive wrapper constructors\n\nSearch and replace of `new PrimitiveType(` with `PrimitiveType.valueOf(`\n\nFix the vich test so that it continues to ensure 32 unique objects.\n\nFixes: #10937\n\n[ci skip]\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>", "committedDate": "2020-10-23T20:28:14Z", "type": "forcePushed"}, {"oid": "a4d2db2a95a5bc20bf6d2d4754ee0426ea6aade4", "url": "https://github.com/eclipse-openj9/openj9/commit/a4d2db2a95a5bc20bf6d2d4754ee0426ea6aade4", "message": "Use valueOf instead of primitive wrapper constructors\n\nSearch and replace of `new PrimitiveType(` with `PrimitiveType.valueOf(`\n\nFix the vich test so that it continues to ensure 32 unique objects.\n\nFixes: #10937\n\n[ci skip]\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>", "committedDate": "2020-10-23T20:49:21Z", "type": "forcePushed"}, {"oid": "1604c280c1b68b03e19b6d53d37bb5cd1adad99a", "url": "https://github.com/eclipse-openj9/openj9/commit/1604c280c1b68b03e19b6d53d37bb5cd1adad99a", "message": "Use valueOf instead of primitive wrapper constructors\n\nSearch and replace of `new PrimitiveType(` with `PrimitiveType.valueOf(`\n\nFix the vich test so that it continues to ensure 32 unique objects.\n\nFixes: #10937\n\n[ci skip]\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>", "committedDate": "2020-10-23T21:04:02Z", "type": "forcePushed"}, {"oid": "829ba91478ff41bec309392f260e5290e3882a20", "url": "https://github.com/eclipse-openj9/openj9/commit/829ba91478ff41bec309392f260e5290e3882a20", "message": "Use valueOf instead of primitive wrapper constructors\n\nSearch and replace of `new PrimitiveType(` with `PrimitiveType.valueOf(`\n\nFix the vich test so that it continues to ensure 32 unique objects.\n\nFixes: #10937\n\n[ci skip]\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>", "committedDate": "2020-10-23T21:16:46Z", "type": "commit"}, {"oid": "829ba91478ff41bec309392f260e5290e3882a20", "url": "https://github.com/eclipse-openj9/openj9/commit/829ba91478ff41bec309392f260e5290e3882a20", "message": "Use valueOf instead of primitive wrapper constructors\n\nSearch and replace of `new PrimitiveType(` with `PrimitiveType.valueOf(`\n\nFix the vich test so that it continues to ensure 32 unique objects.\n\nFixes: #10937\n\n[ci skip]\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>", "committedDate": "2020-10-23T21:16:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA3MzA3NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10979#discussion_r512073075", "bodyText": "Hopefully this comment is no longer true: Perhaps it should be deleted?", "author": "keithc-ca", "createdAt": "2020-10-26T15:56:55Z", "path": "jcl/src/java.base/share/classes/java/lang/reflect/Array.java", "diffHunk": "@@ -71,7 +71,7 @@ public static Object get(Object array, int index) throws IllegalArgumentExceptio\n \t\treturn ((short[])array)[index];\n \t} else if (arrayClass == byte[].class) {\n \t\t/* Avoiding Byte cache yields 5x performance improvement. */\n-\t\treturn new Byte(((byte[])array)[index]);\n+\t\treturn Byte.valueOf(((byte[])array)[index]);", "originalCommit": "829ba91478ff41bec309392f260e5290e3882a20", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA4NzgzOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10979#discussion_r512087838", "bodyText": "This was an optimization that was made when we switched from the native implementation to the Java implementation as the Java implementation was more \"JIT friendly\". Perhaps @andrewcraik knows if this is still the case.", "author": "tajila", "createdAt": "2020-10-26T16:17:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA3MzA3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5Nzc4Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10979#discussion_r512097783", "bodyText": "If nothing else, it should be changed to match the pattern of the rest of the code.", "author": "gacholio", "createdAt": "2020-10-26T16:30:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA3MzA3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjEyNjExOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10979#discussion_r512126119", "bodyText": "I do not know if this is still the case - that conversion happened quite a long time ago. The code would need to be benchmarked to know if the change to Byte.valueOf is performance neutral and if bypassing the Byte cache still yields a performance boost. I think any decision to change this needs perf testing since it was clearly important and so we need to verify the best way to handle the operations. Doing the new directly could allow for stack allocation when valueof may not (due to the cache pathways). I am not sure why the optimization was only applied in this specific case, but it being different is not sufficient to warrant a change without perf evaluation IMO.", "author": "andrewcraik", "createdAt": "2020-10-26T17:05:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA3MzA3NQ=="}], "type": "inlineReview", "revised_code": null}]}