{"pr_number": 50, "pr_title": " Use SQL procedures for updates to the STOCK table.", "pr_createdAt": "2020-09-16T09:42:59Z", "pr_url": "https://github.com/yugabyte/tpcc/pull/50", "timeline": [{"oid": "af9aa79d15b96fba54811272df4da1ac7fe3734e", "url": "https://github.com/yugabyte/tpcc/commit/af9aa79d15b96fba54811272df4da1ac7fe3734e", "message": "Use PgSql procedures for updates to the STOCK table.\n\nSummary:\nCurrently we batch the updates only when they are part of a PGSQL\nprocedure. Given that we have to perform 10 updates on an average in a\nNewOrder transaction we use the stored procedures to perform these\nupdates.\n\nThe stored procedures are created after the Loading of all the tables\nare done.\n\nThe usage of these stored procedures is controlled by the\n'useStoredProcedures' argument in the xml config\n\nReviewers:\nMihnea", "committedDate": "2020-09-23T00:35:22Z", "type": "forcePushed"}, {"oid": "6cd88710943bed1bbfde189fd553360dddf148a6", "url": "https://github.com/yugabyte/tpcc/commit/6cd88710943bed1bbfde189fd553360dddf148a6", "message": "Use PgSql procedures for updates to the STOCK table.\n\nSummary:\nCurrently we batch the updates only when they are part of a PGSQL\nprocedure. Given that we have to perform 10 updates on an average in a\nNewOrder transaction we use the stored procedures to perform these\nupdates.\n\nThe stored procedures are created after the Loading of all the tables\nare done.\n\nThe usage of these stored procedures is controlled by the\n'useStoredProcedures' argument in the xml config\n\nReviewers:\nMihnea", "committedDate": "2020-09-23T02:32:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE3MjI3MA==", "url": "https://github.com/yugabyte/tpcc/pull/50#discussion_r495172270", "bodyText": "nit: capitalize sql->SQL, also I think you can put the LANGUAGE clause before AS as it's clearer when reading procedures.", "author": "m-iancu", "createdAt": "2020-09-25T18:50:22Z", "path": "src/com/oltpbenchmark/benchmarks/tpcc/TPCCLoader.java", "diffHunk": "@@ -210,6 +214,33 @@ protected void EnableForeignKeyConstraints(Connection conn) {\n     }\n   }\n \n+  protected void CreatePgSqlProcedures(Connection conn) throws SQLException {\n+    try {\n+      Statement st = conn.createStatement();\n+\n+      StringBuilder argsSb = new StringBuilder();\n+      StringBuilder updateStatements = new StringBuilder();\n+\n+      argsSb.append(\"wid int\");\n+      for (int i = 1; i <= 15; ++i) {\n+        argsSb.append(String.format(\", i%d int, q%d int, y%d int, r%d int\", i, i, i, i));\n+        updateStatements.append(String.format(\n+          \"UPDATE STOCK SET S_QUANTITY = q%d, S_YTD = y%d, S_ORDER_CNT = S_ORDER_CNT + 1, \" +\n+          \"S_REMOTE_CNT = r%d WHERE S_W_ID = wid AND S_I_ID = i%d;\",\n+          i, i, i, i));\n+        String updateStmt =\n+          String.format(\"CREATE PROCEDURE updatestock%d (%s) AS '%s' LANGUAGE sql;\",", "originalCommit": "6cd88710943bed1bbfde189fd553360dddf148a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE4MTA5Mg==", "url": "https://github.com/yugabyte/tpcc/pull/50#discussion_r495181092", "bodyText": "Done.", "author": "psudheer21", "createdAt": "2020-09-25T19:09:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE3MjI3MA=="}], "type": "inlineReview", "revised_code": {"commit": "e84cb4ddb74e539169e4d0cf8af5509cb9d6ef83", "chunk": "diff --git a/src/com/oltpbenchmark/benchmarks/tpcc/TPCCLoader.java b/src/com/oltpbenchmark/benchmarks/tpcc/TPCCLoader.java\nindex af6c2a9..ccb9630 100644\n--- a/src/com/oltpbenchmark/benchmarks/tpcc/TPCCLoader.java\n+++ b/src/com/oltpbenchmark/benchmarks/tpcc/TPCCLoader.java\n\n@@ -214,7 +214,7 @@ public class TPCCLoader extends Loader<TPCCBenchmark> {\n     }\n   }\n \n-  protected void CreatePgSqlProcedures(Connection conn) throws SQLException {\n+  protected void CreateSqlProcedures(Connection conn) throws SQLException {\n     try {\n       Statement st = conn.createStatement();\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE3MzE0Nw==", "url": "https://github.com/yugabyte/tpcc/pull/50#discussion_r495173147", "bodyText": "nit: why not just i?", "author": "m-iancu", "createdAt": "2020-09-25T18:52:14Z", "path": "src/com/oltpbenchmark/benchmarks/tpcc/procedures/NewOrder.java", "diffHunk": "@@ -496,6 +513,56 @@ void storeInfo(int[] itemIDs, int[] supplierWhs, int[] orderQuantities,\n     }\n   }\n \n+  void updateStockUsingProcedures(int o_ol_cnt, int w_id,\n+                                  int[] itemIDs, int[] supplierWarehouseIDs,\n+                                  int[] orderQuantities, int[] s_qty_arr,\n+                                  int[] ytd_arr, int[] remote_cnt_arr,\n+                                  Connection conn) throws  SQLException {\n+\n+    Map<Integer, HashSet<Integer>> input = new HashMap<>();\n+    for (int ii = 0; ii < o_ol_cnt; ++ii) {", "originalCommit": "6cd88710943bed1bbfde189fd553360dddf148a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE4MTk1Ng==", "url": "https://github.com/yugabyte/tpcc/pull/50#discussion_r495181956", "bodyText": "Done.", "author": "psudheer21", "createdAt": "2020-09-25T19:11:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE3MzE0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "e84cb4ddb74e539169e4d0cf8af5509cb9d6ef83", "chunk": "diff --git a/src/com/oltpbenchmark/benchmarks/tpcc/procedures/NewOrder.java b/src/com/oltpbenchmark/benchmarks/tpcc/procedures/NewOrder.java\nindex 74098f6..613d1bd 100644\n--- a/src/com/oltpbenchmark/benchmarks/tpcc/procedures/NewOrder.java\n+++ b/src/com/oltpbenchmark/benchmarks/tpcc/procedures/NewOrder.java\n\n@@ -520,9 +520,9 @@ public class NewOrder extends TPCCProcedure {\n                                   Connection conn) throws  SQLException {\n \n     Map<Integer, HashSet<Integer>> input = new HashMap<>();\n-    for (int ii = 0; ii < o_ol_cnt; ++ii) {\n-      int itemId = itemIDs[ii];\n-      int supplierWh = supplierWarehouseIDs[ii];\n+    for (int i = 0; i < o_ol_cnt; ++i) {\n+      int itemId = itemIDs[i];\n+      int supplierWh = supplierWarehouseIDs[i];\n       if (!input.containsKey(supplierWh)) {\n         input.put(supplierWh, new HashSet<>());\n       }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE3MzIyOQ==", "url": "https://github.com/yugabyte/tpcc/pull/50#discussion_r495173229", "bodyText": "ditto", "author": "m-iancu", "createdAt": "2020-09-25T18:52:24Z", "path": "src/com/oltpbenchmark/benchmarks/tpcc/procedures/NewOrder.java", "diffHunk": "@@ -496,6 +513,56 @@ void storeInfo(int[] itemIDs, int[] supplierWhs, int[] orderQuantities,\n     }\n   }\n \n+  void updateStockUsingProcedures(int o_ol_cnt, int w_id,\n+                                  int[] itemIDs, int[] supplierWarehouseIDs,\n+                                  int[] orderQuantities, int[] s_qty_arr,\n+                                  int[] ytd_arr, int[] remote_cnt_arr,\n+                                  Connection conn) throws  SQLException {\n+\n+    Map<Integer, HashSet<Integer>> input = new HashMap<>();\n+    for (int ii = 0; ii < o_ol_cnt; ++ii) {\n+      int itemId = itemIDs[ii];\n+      int supplierWh = supplierWarehouseIDs[ii];\n+      if (!input.containsKey(supplierWh)) {\n+        input.put(supplierWh, new HashSet<>());\n+      }\n+      input.get(supplierWh).add(itemId);\n+    }\n+\n+    for (Map.Entry<Integer, HashSet<Integer>> entry : input.entrySet()) {\n+      int whId = entry.getKey();\n+      int numEntries = entry.getValue().size();\n+      stmtUpdateStockProcedure =\n+        this.getPreparedStatement(conn, stmtUpdateStockProcedureSQL[numEntries - 1]);\n+\n+      int ii = 1;", "originalCommit": "6cd88710943bed1bbfde189fd553360dddf148a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE4MTk5Nw==", "url": "https://github.com/yugabyte/tpcc/pull/50#discussion_r495181997", "bodyText": "Done.", "author": "psudheer21", "createdAt": "2020-09-25T19:11:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE3MzIyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "e84cb4ddb74e539169e4d0cf8af5509cb9d6ef83", "chunk": "diff --git a/src/com/oltpbenchmark/benchmarks/tpcc/procedures/NewOrder.java b/src/com/oltpbenchmark/benchmarks/tpcc/procedures/NewOrder.java\nindex 74098f6..613d1bd 100644\n--- a/src/com/oltpbenchmark/benchmarks/tpcc/procedures/NewOrder.java\n+++ b/src/com/oltpbenchmark/benchmarks/tpcc/procedures/NewOrder.java\n\n@@ -520,9 +520,9 @@ public class NewOrder extends TPCCProcedure {\n                                   Connection conn) throws  SQLException {\n \n     Map<Integer, HashSet<Integer>> input = new HashMap<>();\n-    for (int ii = 0; ii < o_ol_cnt; ++ii) {\n-      int itemId = itemIDs[ii];\n-      int supplierWh = supplierWarehouseIDs[ii];\n+    for (int i = 0; i < o_ol_cnt; ++i) {\n+      int itemId = itemIDs[i];\n+      int supplierWh = supplierWarehouseIDs[i];\n       if (!input.containsKey(supplierWh)) {\n         input.put(supplierWh, new HashSet<>());\n       }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE3Mzg5OA==", "url": "https://github.com/yugabyte/tpcc/pull/50#discussion_r495173898", "bodyText": "nit: maybe just say CreateSqlProcedures since this isn't Postgres (rather Yugabyte/YSQL).\nDitto about using PGSQL in the summary.", "author": "m-iancu", "createdAt": "2020-09-25T18:53:48Z", "path": "src/com/oltpbenchmark/benchmarks/tpcc/TPCCLoader.java", "diffHunk": "@@ -210,6 +214,33 @@ protected void EnableForeignKeyConstraints(Connection conn) {\n     }\n   }\n \n+  protected void CreatePgSqlProcedures(Connection conn) throws SQLException {", "originalCommit": "6cd88710943bed1bbfde189fd553360dddf148a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE4MjE0OA==", "url": "https://github.com/yugabyte/tpcc/pull/50#discussion_r495182148", "bodyText": "Done.", "author": "psudheer21", "createdAt": "2020-09-25T19:11:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE3Mzg5OA=="}], "type": "inlineReview", "revised_code": {"commit": "e84cb4ddb74e539169e4d0cf8af5509cb9d6ef83", "chunk": "diff --git a/src/com/oltpbenchmark/benchmarks/tpcc/TPCCLoader.java b/src/com/oltpbenchmark/benchmarks/tpcc/TPCCLoader.java\nindex af6c2a9..ccb9630 100644\n--- a/src/com/oltpbenchmark/benchmarks/tpcc/TPCCLoader.java\n+++ b/src/com/oltpbenchmark/benchmarks/tpcc/TPCCLoader.java\n\n@@ -214,7 +214,7 @@ public class TPCCLoader extends Loader<TPCCBenchmark> {\n     }\n   }\n \n-  protected void CreatePgSqlProcedures(Connection conn) throws SQLException {\n+  protected void CreateSqlProcedures(Connection conn) throws SQLException {\n     try {\n       Statement st = conn.createStatement();\n \n"}}, {"oid": "e84cb4ddb74e539169e4d0cf8af5509cb9d6ef83", "url": "https://github.com/yugabyte/tpcc/commit/e84cb4ddb74e539169e4d0cf8af5509cb9d6ef83", "message": "Use SQL procedures for updates to the STOCK table.\n\nSummary:\nCurrently we batch the updates only when they are part of a SQL\nprocedure. Given that we have to perform 10 updates on an average in a\nNewOrder transaction we use the stored procedures to perform these\nupdates.\n\nThe stored procedures are created after the Loading of all the tables\nare done.\n\nThe usage of these stored procedures is controlled by the\n'useStoredProcedures' argument in the xml config\n\nReviewers:\nMihnea", "committedDate": "2020-09-25T19:12:27Z", "type": "forcePushed"}, {"oid": "ce84a179045f310162f4cbb777e0894f1dcc73b6", "url": "https://github.com/yugabyte/tpcc/commit/ce84a179045f310162f4cbb777e0894f1dcc73b6", "message": "Use SQL procedures for updates to the STOCK table.\n\nSummary:\nCurrently we batch the updates only when they are part of a SQL\nprocedure. Given that we have to perform 10 updates on an average in a\nNewOrder transaction we use the stored procedures to perform these\nupdates.\n\nThe stored procedures are created after the Loading of all the tables\nare done.\n\nThe usage of these stored procedures is controlled by the\n'useStoredProcedures' argument in the xml config\n\nReviewers:\nMihnea", "committedDate": "2020-09-25T21:18:06Z", "type": "forcePushed"}, {"oid": "626f6f254285156b90866cfe928eec89de068c8f", "url": "https://github.com/yugabyte/tpcc/commit/626f6f254285156b90866cfe928eec89de068c8f", "message": "Use SQL procedures for updates to the STOCK table.\n\nSummary:\nCurrently we batch the updates only when they are part of a SQL\nprocedure. Given that we have to perform 10 updates on an average in a\nNewOrder transaction we use the stored procedures to perform these\nupdates.\n\nThe stored procedures are created after the Loading of all the tables\nare done.\n\nThe usage of these stored procedures is controlled by the\n'useStoredProcedures' argument in the xml config\n\nReviewers:\nMihnea", "committedDate": "2020-09-26T01:01:58Z", "type": "commit"}, {"oid": "626f6f254285156b90866cfe928eec89de068c8f", "url": "https://github.com/yugabyte/tpcc/commit/626f6f254285156b90866cfe928eec89de068c8f", "message": "Use SQL procedures for updates to the STOCK table.\n\nSummary:\nCurrently we batch the updates only when they are part of a SQL\nprocedure. Given that we have to perform 10 updates on an average in a\nNewOrder transaction we use the stored procedures to perform these\nupdates.\n\nThe stored procedures are created after the Loading of all the tables\nare done.\n\nThe usage of these stored procedures is controlled by the\n'useStoredProcedures' argument in the xml config\n\nReviewers:\nMihnea", "committedDate": "2020-09-26T01:01:58Z", "type": "forcePushed"}]}