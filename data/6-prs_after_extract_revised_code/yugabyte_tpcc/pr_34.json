{"pr_number": 34, "pr_title": "Reduce the memory consumption of TPC-C benchmark.", "pr_createdAt": "2020-07-01T21:04:33Z", "pr_url": "https://github.com/yugabyte/tpcc/pull/34", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIxNzU0OA==", "url": "https://github.com/yugabyte/tpcc/pull/34#discussion_r449217548", "bodyText": "Please extra space:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                protected  TransactionTypes transactionTypes;\n          \n          \n            \n                protected  Map<Class<? extends Procedure>, Procedure> class_procedures = new HashMap<Class<? extends Procedure>, Procedure>();\n          \n          \n            \n                protected TransactionTypes transactionTypes;\n          \n          \n            \n                protected Map<Class<? extends Procedure>, Procedure> class_procedures = new HashMap<Class<? extends Procedure>, Procedure>();", "author": "ndeodhar", "createdAt": "2020-07-02T19:10:56Z", "path": "src/com/oltpbenchmark/api/Worker.java", "diffHunk": "@@ -57,17 +55,9 @@\n     private final int id;\n     private final T benchmarkModule;\n     protected final HikariDataSource dataSource;\n-    protected final WorkloadConfiguration wrkld;\n-    protected final TransactionTypes transactionTypes;\n-    protected final Map<TransactionType, Procedure> procedures = new HashMap<TransactionType, Procedure>();\n-    protected final Map<String, Procedure> name_procedures = new HashMap<String, Procedure>();\n-    protected final Map<Class<? extends Procedure>, Procedure> class_procedures = new HashMap<Class<? extends Procedure>, Procedure>();\n-\n-    private final Histogram<TransactionType> txnSuccess = new Histogram<TransactionType>();\n-    private final Histogram<TransactionType> txnAbort = new Histogram<TransactionType>();\n-    private final Histogram<TransactionType> txnRetry = new Histogram<TransactionType>();\n-    private final Histogram<TransactionType> txnErrors = new Histogram<TransactionType>();\n-    private final Map<TransactionType, Histogram<String>> txnAbortMessages = new HashMap<TransactionType, Histogram<String>>();\n+    protected static WorkloadConfiguration wrkld;\n+    protected  TransactionTypes transactionTypes;\n+    protected  Map<Class<? extends Procedure>, Procedure> class_procedures = new HashMap<Class<? extends Procedure>, Procedure>();", "originalCommit": "5590823b522910557ad33c040af34f8e4e7f88e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTI1MTY0MA==", "url": "https://github.com/yugabyte/tpcc/pull/34#discussion_r449251640", "bodyText": "Done.", "author": "psudheer21", "createdAt": "2020-07-02T20:30:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIxNzU0OA=="}], "type": "inlineReview", "revised_code": {"commit": "154f4e4f2ce7f222c8668ba6ed35739c29d58f26", "chunk": "diff --git a/src/com/oltpbenchmark/api/Worker.java b/src/com/oltpbenchmark/api/Worker.java\nindex 14fba4b..26a5823 100644\n--- a/src/com/oltpbenchmark/api/Worker.java\n+++ b/src/com/oltpbenchmark/api/Worker.java\n\n@@ -56,8 +56,8 @@ public abstract class Worker<T extends BenchmarkModule> implements Runnable {\n     private final T benchmarkModule;\n     protected final HikariDataSource dataSource;\n     protected static WorkloadConfiguration wrkld;\n-    protected  TransactionTypes transactionTypes;\n-    protected  Map<Class<? extends Procedure>, Procedure> class_procedures = new HashMap<Class<? extends Procedure>, Procedure>();\n+    protected TransactionTypes transactionTypes;\n+    protected Map<Class<? extends Procedure>, Procedure> class_procedures = new HashMap<Class<? extends Procedure>, Procedure>();\n \n     private boolean seenDone = false;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIxODYyNA==", "url": "https://github.com/yugabyte/tpcc/pull/34#discussion_r449218624", "bodyText": "Can we remove instead of commenting out?", "author": "ndeodhar", "createdAt": "2020-07-02T19:13:12Z", "path": "src/com/oltpbenchmark/api/Worker.java", "diffHunk": "@@ -149,40 +137,20 @@ public final int getAndResetIntervalRequests() {\n         return latencies;\n     }\n \n-    public final Procedure getProcedure(TransactionType type) {\n-        return (this.procedures.get(type));\n-    }\n+    //public final Procedure getProcedure(TransactionType type) {", "originalCommit": "5590823b522910557ad33c040af34f8e4e7f88e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTI1MTc2Mw==", "url": "https://github.com/yugabyte/tpcc/pull/34#discussion_r449251763", "bodyText": "Done.", "author": "psudheer21", "createdAt": "2020-07-02T20:31:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIxODYyNA=="}], "type": "inlineReview", "revised_code": {"commit": "154f4e4f2ce7f222c8668ba6ed35739c29d58f26", "chunk": "diff --git a/src/com/oltpbenchmark/api/Worker.java b/src/com/oltpbenchmark/api/Worker.java\nindex 14fba4b..26a5823 100644\n--- a/src/com/oltpbenchmark/api/Worker.java\n+++ b/src/com/oltpbenchmark/api/Worker.java\n\n@@ -137,15 +137,6 @@ public abstract class Worker<T extends BenchmarkModule> implements Runnable {\n         return latencies;\n     }\n \n-    //public final Procedure getProcedure(TransactionType type) {\n-    //    return (this.procedures.get(type));\n-    //}\n-\n-    @Deprecated\n-    //public final Procedure getProcedure(String name) {\n-    //    return (this.name_procedures.get(name));\n-    //}\n-\n     @SuppressWarnings(\"unchecked\")\n     public final <P extends Procedure> P getProcedure(Class<P> procClass) {\n         return (P) (this.class_procedures.get(procClass));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIxODc1OQ==", "url": "https://github.com/yugabyte/tpcc/pull/34#discussion_r449218759", "bodyText": "Please remove", "author": "ndeodhar", "createdAt": "2020-07-02T19:13:31Z", "path": "src/com/oltpbenchmark/api/Worker.java", "diffHunk": "@@ -497,7 +454,7 @@ protected final TransactionType doWork(boolean measure, SubmittedProcedure piece\n                                                ex.getClass().getSimpleName(), next, this.toString(),\n                                                ex.getMessage(), ex.getErrorCode(), ex.getSQLState()), ex);\n \n-                    this.txnErrors.put(next);\n+                    //this.txnErrors.put(next);", "originalCommit": "5590823b522910557ad33c040af34f8e4e7f88e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTI1MTkwMg==", "url": "https://github.com/yugabyte/tpcc/pull/34#discussion_r449251902", "bodyText": "Done.", "author": "psudheer21", "createdAt": "2020-07-02T20:31:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIxODc1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "154f4e4f2ce7f222c8668ba6ed35739c29d58f26", "chunk": "diff --git a/src/com/oltpbenchmark/api/Worker.java b/src/com/oltpbenchmark/api/Worker.java\nindex 14fba4b..26a5823 100644\n--- a/src/com/oltpbenchmark/api/Worker.java\n+++ b/src/com/oltpbenchmark/api/Worker.java\n\n@@ -454,8 +445,6 @@ public abstract class Worker<T extends BenchmarkModule> implements Runnable {\n                                                ex.getClass().getSimpleName(), next, this.toString(),\n                                                ex.getMessage(), ex.getErrorCode(), ex.getSQLState()), ex);\n \n-                    //this.txnErrors.put(next);\n-\n \t\t    if (this.wrkld.getDBType().shouldUseTransactions()) {\n \t\t\tif (savepoint != null) {\n \t\t\t    conn.rollback(savepoint);\n"}}, {"oid": "154f4e4f2ce7f222c8668ba6ed35739c29d58f26", "url": "https://github.com/yugabyte/tpcc/commit/154f4e4f2ce7f222c8668ba6ed35739c29d58f26", "message": "Reduce the memory consumption of TPC-C benchmark.\n\nSummary:\nThe original code was pre allocating a large array for the latency\nresults assuming that they were not going to use a lot of threads.\nHowever, in the TPCC case we have a large number with each thread doing\nvery small number of operations. So this change reduces the size of the\narrays.\n\nRemoved some other components like histograms that were not being used\nthat contribute to the memory bloat.\n\nAdded some more cleanup of the code as well.\n\nReviewers:\nNeha", "committedDate": "2020-07-02T20:51:34Z", "type": "commit"}, {"oid": "154f4e4f2ce7f222c8668ba6ed35739c29d58f26", "url": "https://github.com/yugabyte/tpcc/commit/154f4e4f2ce7f222c8668ba6ed35739c29d58f26", "message": "Reduce the memory consumption of TPC-C benchmark.\n\nSummary:\nThe original code was pre allocating a large array for the latency\nresults assuming that they were not going to use a lot of threads.\nHowever, in the TPCC case we have a large number with each thread doing\nvery small number of operations. So this change reduces the size of the\narrays.\n\nRemoved some other components like histograms that were not being used\nthat contribute to the memory bloat.\n\nAdded some more cleanup of the code as well.\n\nReviewers:\nNeha", "committedDate": "2020-07-02T20:51:34Z", "type": "forcePushed"}]}