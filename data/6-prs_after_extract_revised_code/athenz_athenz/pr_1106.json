{"pr_number": 1106, "pr_title": "validation of role/group members", "pr_createdAt": "2020-09-09T16:07:12Z", "pr_url": "https://github.com/AthenZ/athenz/pull/1106", "timeline": [{"oid": "971b11171592311f967f40f29847320bc512c100", "url": "https://github.com/AthenZ/athenz/commit/971b11171592311f967f40f29847320bc512c100", "message": "validation of role/group members", "committedDate": "2020-09-09T16:06:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg3MjA5Nw==", "url": "https://github.com/AthenZ/athenz/pull/1106#discussion_r485872097", "bodyText": "we can have a check for idx == -1 here as well", "author": "abvaidya", "createdAt": "2020-09-09T19:42:49Z", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java", "diffHunk": "@@ -3192,7 +3192,67 @@ void updateRoleMemberUserAuthorityExpiry(final Role role, final String caller) {\n         }\n     }\n \n-    void validateRoleMemberPrincipal(final String memberName, int principalType, final String userAuthorityFilter, final String caller) {\n+    void validateUserPrincipal(final String memberName, boolean validateUserMember, final String userAuthorityFilter,\n+                               final String caller) {\n+\n+        if (userAuthority == null) {\n+            return;\n+        }\n+\n+        if (validateUserMember) {\n+            if (!userAuthority.isValidUser(memberName)) {\n+                throw ZMSUtils.requestError(\"Principal \" + memberName + \" is not valid\", caller);\n+            }\n+        }\n+\n+        // once we know it's a valid principal and we have a user\n+        // authority filter configured, we'll check that as well\n+        // if we're already determined that the principal is not\n+        // valid there is no point of running this check\n+\n+        if (!StringUtil.isEmpty(userAuthorityFilter)) {\n+            if (!ZMSUtils.isUserAuthorityFilterValid(userAuthority, userAuthorityFilter, memberName)) {\n+                throw ZMSUtils.requestError(\"Invalid member: \" + memberName +\n+                        \". Required user authority filter not valid for the member\", caller);\n+            }\n+        }\n+    }\n+\n+    void validateServicePrincipal(final String memberName, final String caller) {\n+\n+        int idx = memberName.lastIndexOf('.');\n+        if (idx == -1) {\n+            throw ZMSUtils.requestError(\"Principal \" + memberName + \" is not valid\", caller);\n+        }\n+\n+        final String domainName = memberName.substring(0, idx);\n+        final String serviceName = memberName.substring(idx + 1);\n+\n+        // first we need to check if the domain is on the list of\n+        // our skip domains for service member validation. these\n+        // are typically domains (like for ci/cd) where services\n+        // are dynamic and do not need to be registered in Athenz\n+\n+        if (!validateServiceMemberSkipDomains.contains(domainName)) {\n+            if (dbService.getServiceIdentity(domainName, serviceName, true) == null) {\n+                throw ZMSUtils.requestError(\"Principal \" + memberName + \" is not a valid service\", caller);\n+            }\n+        }\n+    }\n+\n+    void validateGroupPrincipal(final String memberName, final String caller) {\n+\n+        int idx = memberName.indexOf(AuthorityConsts.GROUP_SEP);\n+        final String domainName = memberName.substring(0, idx);", "originalCommit": "971b11171592311f967f40f29847320bc512c100", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg4MTU5MQ==", "url": "https://github.com/AthenZ/athenz/pull/1106#discussion_r485881591", "bodyText": "We don't need it. ZMSUtils.principalType sets the principal type to GROUP only if it contains the AuthorityConsts.GROUP_SEP value thus idx will never be -1. We do need it for service use case since the function treats non user/group types as service thus we need additional validation there.", "author": "havetisyan", "createdAt": "2020-09-09T19:53:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg3MjA5Nw=="}], "type": "inlineReview", "revised_code": null}]}