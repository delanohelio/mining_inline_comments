{"pr_number": 924, "pr_title": "new zms api to delete pending members", "pr_createdAt": "2020-03-30T01:51:45Z", "pr_url": "https://github.com/AthenZ/athenz/pull/924", "timeline": [{"oid": "e670b4f9e99981e5769a71f52dc6519b73c850ef", "url": "https://github.com/AthenZ/athenz/commit/e670b4f9e99981e5769a71f52dc6519b73c850ef", "message": "new zms api to delete pending members", "committedDate": "2020-03-30T01:49:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM4MTM1NA==", "url": "https://github.com/AthenZ/athenz/pull/924#discussion_r400381354", "bodyText": "should this be autoCommit=false?", "author": "abvaidya", "createdAt": "2020-03-30T17:50:57Z", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/DBService.java", "diffHunk": "@@ -1230,7 +1230,54 @@ void executeDeleteMembership(ResourceContext ctx, String domainName, String role\n             }\n         }\n     }\n-    \n+\n+    void executeDeletePendingMembership(ResourceContext ctx, String domainName, String roleName,\n+                String normalizedMember, String auditRef, String caller) {\n+\n+        // our exception handling code does the check for retry count\n+        // and throws the exception it had received when the retry\n+        // count reaches 0\n+\n+        for (int retryCount = defaultRetryCount; ; retryCount--) {\n+\n+            try (ObjectStoreConnection con = store.getConnection(true, true)) {", "originalCommit": "e670b4f9e99981e5769a71f52dc6519b73c850ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQzMjEyOQ==", "url": "https://github.com/AthenZ/athenz/pull/924#discussion_r400432129", "bodyText": "For single operations, we have auto commit enabled.", "author": "havetisyan", "createdAt": "2020-03-30T19:15:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM4MTM1NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM4MTc3Nw==", "url": "https://github.com/AthenZ/athenz/pull/924#discussion_r400381777", "bodyText": "should this be deletependingmembership_timing?", "author": "abvaidya", "createdAt": "2020-03-30T17:51:37Z", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java", "diffHunk": "@@ -3282,6 +3282,56 @@ void sendMembershipApprovalNotification(final String domain, final String org, f\n         notificationManager.sendNotifications(notifications);\n     }\n \n+    public void deletePendingMembership(ResourceContext ctx, String domainName, String roleName,\n+            String memberName, String auditRef) {\n+\n+        final String caller = \"deletependingmembership\";\n+        metric.increment(ZMSConsts.HTTP_DELETE);\n+        logPrincipal(ctx);\n+\n+        if (readOnlyMode) {\n+            throw ZMSUtils.requestError(SERVER_READ_ONLY_MESSAGE, caller);\n+        }\n+\n+        validateRequest(ctx.request(), caller);\n+\n+        validate(domainName, TYPE_DOMAIN_NAME, caller);\n+        validate(roleName, TYPE_ENTITY_NAME, caller);\n+        validate(memberName, TYPE_MEMBER_NAME, caller);\n+\n+        // for consistent handling of all requests, we're going to convert\n+        // all incoming object values into lower case (e.g. domain, role,\n+        // policy, service, etc name)\n+\n+        domainName = domainName.toLowerCase();\n+        roleName = roleName.toLowerCase();\n+        memberName = normalizeDomainAliasUser(memberName.toLowerCase());\n+\n+        final String principalDomain = getPrincipalDomain(ctx);\n+        metric.increment(ZMSConsts.HTTP_REQUEST, domainName, principalDomain);\n+        metric.increment(caller, domainName, principalDomain);\n+        Object timerMetric = metric.startTiming(\"deletemembership_timing\", domainName, principalDomain);", "originalCommit": "e670b4f9e99981e5769a71f52dc6519b73c850ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQzMjI0MQ==", "url": "https://github.com/AthenZ/athenz/pull/924#discussion_r400432241", "bodyText": "fixed.", "author": "havetisyan", "createdAt": "2020-03-30T19:16:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM4MTc3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "5425a18f57bfb6f5b24694e5dccb4744d48f0b6e", "chunk": "diff --git a/servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java b/servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java\nindex b842b7d91..b57bc7110 100644\n--- a/servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java\n+++ b/servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java\n\n@@ -3310,7 +3310,7 @@ public class ZMSImpl implements Authorizer, KeyStore, ZMSHandler {\n         final String principalDomain = getPrincipalDomain(ctx);\n         metric.increment(ZMSConsts.HTTP_REQUEST, domainName, principalDomain);\n         metric.increment(caller, domainName, principalDomain);\n-        Object timerMetric = metric.startTiming(\"deletemembership_timing\", domainName, principalDomain);\n+        Object timerMetric = metric.startTiming(\"deletependingmembership_timing\", domainName, principalDomain);\n \n         // verify that request is properly authenticated for this request\n \n"}}, {"oid": "5425a18f57bfb6f5b24694e5dccb4744d48f0b6e", "url": "https://github.com/AthenZ/athenz/commit/5425a18f57bfb6f5b24694e5dccb4744d48f0b6e", "message": "fixed metric name", "committedDate": "2020-03-30T19:17:05Z", "type": "commit"}]}