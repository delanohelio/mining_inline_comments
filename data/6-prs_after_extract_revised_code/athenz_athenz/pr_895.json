{"pr_number": 895, "pr_title": "Refactor EmailNotificatioService and expose HttpDriver HttpPost method", "pr_createdAt": "2020-03-05T12:43:20Z", "pr_url": "https://github.com/AthenZ/athenz/pull/895", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI2OTU1NQ==", "url": "https://github.com/AthenZ/athenz/pull/895#discussion_r388269555", "bodyText": "Removed unused members", "author": "OferLevi85", "createdAt": "2020-03-05T12:44:00Z", "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/http/HttpDriver.java", "diffHunk": "@@ -59,10 +58,6 @@\n     private static final int DEFAULT_CLIENT_READ_TIMEOUT_MS = 5000;\n \n     private final String baseUrl;\n-    private final String truststorePath;", "originalCommit": "569908b2a80af697e3c85ffa786917014ec1c245", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI3MDAwNw==", "url": "https://github.com/AthenZ/athenz/pull/895#discussion_r388270007", "bodyText": "Expose doPost that accepts HttpPost for more complicated posts.", "author": "OferLevi85", "createdAt": "2020-03-05T12:44:57Z", "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/http/HttpDriver.java", "diffHunk": "@@ -261,16 +252,14 @@ public String doGet(final String url) throws IOException {\n \n     /**\n      * doPost performs post operation and returns a string\n-     * @param url target url\n-     * @param fields form fields that need to posted to the url\n+     * @param httpPost\n      * @return response string\n      * @throws IOException\n      */\n-    public String doPost(final String url, final List<NameValuePair> fields) throws IOException {\n-        LOGGER.debug(\"Requesting from {} with query {}\", url, fields);\n-\n-        HttpPost httpPost = new HttpPost(url);\n-        httpPost.setEntity(new UrlEncodedFormEntity(fields));\n+    public String doPost(HttpPost httpPost) throws IOException {\n+        String url = httpPost.getURI().toString();", "originalCommit": "569908b2a80af697e3c85ffa786917014ec1c245", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI3MDkwMg==", "url": "https://github.com/AthenZ/athenz/pull/895#discussion_r388270902", "bodyText": "As @abvaidya suggested, extracted the MimeMessage construction so providers will not need to implement it.", "author": "OferLevi85", "createdAt": "2020-03-05T12:46:47Z", "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/impl/AWSEmailProvider.java", "diffHunk": "@@ -27,77 +27,20 @@\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import javax.mail.Session;\n-import javax.mail.internet.InternetAddress;\n-import javax.mail.internet.MimeBodyPart;\n import javax.mail.internet.MimeMessage;\n-import javax.mail.internet.MimeMultipart;\n import java.io.ByteArrayOutputStream;\n import java.nio.ByteBuffer;\n import java.util.Collection;\n-import java.util.Properties;\n-\n-import static com.yahoo.athenz.common.server.notification.NotificationServiceConstants.CHARSET_UTF_8;\n-import static com.yahoo.athenz.common.server.notification.NotificationServiceConstants.HTML_LOGO_CID_PLACEHOLDER;\n \n public class AWSEmailProvider implements EmailProvider {\n     private static final Logger LOGGER = LoggerFactory.getLogger(AWSEmailProvider.class);\n     private final AmazonSimpleEmailService ses;\n \n     @Override\n-    public boolean sendEmail(String subject, String body, boolean status, Collection<String> recipients, String from, byte[] logoImage) {\n+    public boolean sendEmail(boolean status, Collection<String> recipients, String from, MimeMessage mimeMessage) {", "originalCommit": "569908b2a80af697e3c85ffa786917014ec1c245", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI3NDA1OQ==", "url": "https://github.com/AthenZ/athenz/pull/895#discussion_r388274059", "bodyText": "I have changed the interface but it is unlikely that someone already implemented a new EmailProvider.", "author": "OferLevi85", "createdAt": "2020-03-05T12:53:16Z", "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/EmailProvider.java", "diffHunk": "@@ -16,19 +16,18 @@\n \n package com.yahoo.athenz.common.server.notification;\n \n+import javax.mail.internet.MimeMessage;\n import java.util.Collection;\n \n public interface EmailProvider {\n \n     /**\n      * Send an email through the provider\n-     * @param subject\n-     * @param body\n      * @param status\n      * @param recipients\n      * @param from\n-     * @param logoImage\n+     * @param mimeMessage\n      * @return true if mail was sent\n      */\n-    boolean sendEmail(String subject, String body, boolean status, Collection<String> recipients, String from, byte[] logoImage);", "originalCommit": "569908b2a80af697e3c85ffa786917014ec1c245", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "28cac3359629b65841cc239b56d0be4275aed533", "url": "https://github.com/AthenZ/athenz/commit/28cac3359629b65841cc239b56d0be4275aed533", "message": "Refactor EmailNotificatioService and expost HttpDriver HttpPost\n\n1. Refactor EmailNotificationService to have a getMimeMessage method that will create a MimeMessage (instead of having each provider implement it)\n2. Expose a post method in HttpDriver that accepts HttpPost as argument (for more complicated posts)", "committedDate": "2020-03-05T14:04:08Z", "type": "commit"}]}