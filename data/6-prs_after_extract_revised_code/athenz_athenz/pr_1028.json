{"pr_number": 1028, "pr_title": "ZTS Client to read access tokens from file system", "pr_createdAt": "2020-07-06T09:38:13Z", "pr_url": "https://github.com/AthenZ/athenz/pull/1028", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM3Njc4MQ==", "url": "https://github.com/AthenZ/athenz/pull/1028#discussion_r453376781", "bodyText": "this should be an error if file based access tokens is enabled and we're not able to read them from disk.", "author": "havetisyan", "createdAt": "2020-07-12T23:32:43Z", "path": "clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSClient.java", "diffHunk": "@@ -1168,31 +1192,41 @@ public AccessTokenResponse getAccessToken(String domainName, List<String> roleNa\n             }\n         }\n \n+        // if no hit then we need to look up in disk\n+        try {\n+            accessTokenResponse = ztsFileUtil.lookupAccessTokenFromDisk(domainName, roleNames);\n+        } catch (IOException e) {\n+            LOG.warn(\"GetAccessToken: failed to load access token from disk \", e.getMessage());", "originalCommit": "f752126dc7dcbe37f728dd8bb39276727269d071", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4a483e2be4baf10c7e0af37c4b77b70ccd3e9989", "chunk": "diff --git a/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSClient.java b/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSClient.java\nindex 6b172737f..f72c3985e 100644\n--- a/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSClient.java\n+++ b/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSClient.java\n\n@@ -1194,9 +1189,9 @@ public class ZTSClient implements Closeable {\n \n         // if no hit then we need to look up in disk\n         try {\n-            accessTokenResponse = ztsFileUtil.lookupAccessTokenFromDisk(domainName, roleNames);\n+            accessTokenResponse = ztsAccessTokenFileLoader.lookupAccessTokenFromDisk(domainName, roleNames);\n         } catch (IOException e) {\n-            LOG.warn(\"GetAccessToken: failed to load access token from disk \", e.getMessage());\n+            LOG.error(\"GetAccessToken: failed to load access token from disk \", e.getMessage());\n         }\n \n         // if no hit then we need to request a new token from ZTS\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM3Njk1OA==", "url": "https://github.com/AthenZ/athenz/pull/1028#discussion_r453376958", "bodyText": "we should use pathSeparator instead of \"/\"", "author": "havetisyan", "createdAt": "2020-07-12T23:34:25Z", "path": "clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSFileUtil.java", "diffHunk": "@@ -0,0 +1,105 @@\n+package com.yahoo.athenz.zts;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.yahoo.athenz.auth.token.AccessToken;\n+import com.yahoo.athenz.auth.token.jwts.JwtsSigningKeyResolver;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.*;\n+\n+public class ZTSFileUtil {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(ZTSFileUtil.class);\n+\n+    static private final String DEFAULT_ACCESS_TOKEN_DIR_PATH = \"/var/lib/sia/tokens/\";\n+    static private final String ACCESS_TOKEN_PATH_PROPERTY = \"zts.client.accesstoken.path\";\n+    static private final String ROLE_NAME_CONNECTOR = \",\";\n+    private JwtsSigningKeyResolver accessSignKeyResolver = null;\n+    private ObjectMapper objectMapper = new ObjectMapper();\n+    private Map<String, String> roleNameMap;\n+\n+    public ZTSFileUtil(JwtsSigningKeyResolver resolver) {\n+        roleNameMap = new HashMap<>();\n+        accessSignKeyResolver = resolver;\n+    }\n+\n+    public void preload() {\n+        String path = System.getProperty(ACCESS_TOKEN_PATH_PROPERTY, DEFAULT_ACCESS_TOKEN_DIR_PATH);\n+        File dir = new File(path);\n+\n+        // preload the map from the domain, rolesname to file path\n+        if (dir.exists() && dir.isDirectory()) {\n+            for (File domainDir: dir.listFiles()) {\n+                if (domainDir.isDirectory()) {\n+                    for (File tokenFile: domainDir.listFiles()) {\n+                        if (!tokenFile.isDirectory()) {\n+                            AccessTokenResponse accessTokenResponse = null;\n+                            try {\n+                                accessTokenResponse = objectMapper.readValue(tokenFile, AccessTokenResponse.class);\n+                            } catch (IOException e) {\n+                                LOG.warn(\"Failed to load or parse token file: {}\", tokenFile);\n+                            }\n+\n+                            if (accessTokenResponse == null) {\n+                                continue;\n+                            }\n+\n+                            AccessTokenResponseCacheEntry cacheEntry = new AccessTokenResponseCacheEntry(accessTokenResponse);\n+\n+                            if (!cacheEntry.isExpired(-1)) {\n+                                try {\n+                                    addToRoleMap(domainDir.getName(), tokenFile.getName(), accessTokenResponse);\n+                                } catch (IOException e) {\n+                                    LOG.warn(\"Failed to put role map for token: {}\", tokenFile.getName());\n+                                }\n+                            }\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+\n+    }\n+\n+    // function load the access token from file\n+    public AccessTokenResponse lookupAccessTokenFromDisk(String domain, List<String> rolesName) throws IOException {\n+        String path = System.getProperty(ACCESS_TOKEN_PATH_PROPERTY, DEFAULT_ACCESS_TOKEN_DIR_PATH);\n+        LOG.debug(\"Trying to fetch access token from disk for domain: {}, roleNames: {}\", domain, rolesName);\n+        String rolesStr = getRolesStr(domain, rolesName);\n+        String fileName = roleNameMap.get(rolesStr);\n+        if (fileName == null) {\n+            return null;\n+        }\n+        File tokenFile = new File(path + \"/\" + domain + \"/\" + fileName);", "originalCommit": "f752126dc7dcbe37f728dd8bb39276727269d071", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4a483e2be4baf10c7e0af37c4b77b70ccd3e9989", "chunk": "diff --git a/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSFileUtil.java b/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\nsimilarity index 57%\nrename from clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSFileUtil.java\nrename to clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\nindex d01606b75..88a18c48b 100644\n--- a/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSFileUtil.java\n+++ b/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\n\n@@ -10,27 +10,32 @@ import java.io.File;\n import java.io.IOException;\n import java.util.*;\n \n-public class ZTSFileUtil {\n+public class ZTSAccessTokenFileLoader {\n \n-    private static final Logger LOG = LoggerFactory.getLogger(ZTSFileUtil.class);\n+    private static final Logger LOG = LoggerFactory.getLogger(ZTSAccessTokenFileLoader.class);\n \n+    static public final String ACCESS_TOKEN_PATH_PROPERTY = \"athenz.zts.client.accesstoken.path\";\n     static private final String DEFAULT_ACCESS_TOKEN_DIR_PATH = \"/var/lib/sia/tokens/\";\n-    static private final String ACCESS_TOKEN_PATH_PROPERTY = \"zts.client.accesstoken.path\";\n     static private final String ROLE_NAME_CONNECTOR = \",\";\n-    private JwtsSigningKeyResolver accessSignKeyResolver = null;\n+    static private final String DOMAIN_ROLE_CONNECTOR = \":role:\";\n+    final private String path;\n+    private JwtsSigningKeyResolver accessSignKeyResolver;\n     private ObjectMapper objectMapper = new ObjectMapper();\n     private Map<String, String> roleNameMap;\n \n-    public ZTSFileUtil(JwtsSigningKeyResolver resolver) {\n+    public ZTSAccessTokenFileLoader(JwtsSigningKeyResolver resolver) {\n         roleNameMap = new HashMap<>();\n         accessSignKeyResolver = resolver;\n+        path = System.getProperty(ACCESS_TOKEN_PATH_PROPERTY, DEFAULT_ACCESS_TOKEN_DIR_PATH);\n     }\n \n     public void preload() {\n-        String path = System.getProperty(ACCESS_TOKEN_PATH_PROPERTY, DEFAULT_ACCESS_TOKEN_DIR_PATH);\n         File dir = new File(path);\n \n-        // preload the map from the domain, rolesname to file path\n+        // preload the map from the <domain, rolesname> -> <file path>\n+        // expected dir should be <base token path>/<domain dir>/<token file>s\n+        // after preload the map, when we look up the access token,\n+        // the map will directly read the required file\n         if (dir.exists() && dir.isDirectory()) {\n             for (File domainDir: dir.listFiles()) {\n                 if (domainDir.isDirectory()) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM3NzAwMQ==", "url": "https://github.com/AthenZ/athenz/pull/1028#discussion_r453377001", "bodyText": "make this and other String variables as final as necessary.", "author": "havetisyan", "createdAt": "2020-07-12T23:34:56Z", "path": "clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSFileUtil.java", "diffHunk": "@@ -0,0 +1,105 @@\n+package com.yahoo.athenz.zts;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.yahoo.athenz.auth.token.AccessToken;\n+import com.yahoo.athenz.auth.token.jwts.JwtsSigningKeyResolver;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.*;\n+\n+public class ZTSFileUtil {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(ZTSFileUtil.class);\n+\n+    static private final String DEFAULT_ACCESS_TOKEN_DIR_PATH = \"/var/lib/sia/tokens/\";\n+    static private final String ACCESS_TOKEN_PATH_PROPERTY = \"zts.client.accesstoken.path\";\n+    static private final String ROLE_NAME_CONNECTOR = \",\";\n+    private JwtsSigningKeyResolver accessSignKeyResolver = null;\n+    private ObjectMapper objectMapper = new ObjectMapper();\n+    private Map<String, String> roleNameMap;\n+\n+    public ZTSFileUtil(JwtsSigningKeyResolver resolver) {\n+        roleNameMap = new HashMap<>();\n+        accessSignKeyResolver = resolver;\n+    }\n+\n+    public void preload() {\n+        String path = System.getProperty(ACCESS_TOKEN_PATH_PROPERTY, DEFAULT_ACCESS_TOKEN_DIR_PATH);\n+        File dir = new File(path);\n+\n+        // preload the map from the domain, rolesname to file path\n+        if (dir.exists() && dir.isDirectory()) {\n+            for (File domainDir: dir.listFiles()) {\n+                if (domainDir.isDirectory()) {\n+                    for (File tokenFile: domainDir.listFiles()) {\n+                        if (!tokenFile.isDirectory()) {\n+                            AccessTokenResponse accessTokenResponse = null;\n+                            try {\n+                                accessTokenResponse = objectMapper.readValue(tokenFile, AccessTokenResponse.class);\n+                            } catch (IOException e) {\n+                                LOG.warn(\"Failed to load or parse token file: {}\", tokenFile);\n+                            }\n+\n+                            if (accessTokenResponse == null) {\n+                                continue;\n+                            }\n+\n+                            AccessTokenResponseCacheEntry cacheEntry = new AccessTokenResponseCacheEntry(accessTokenResponse);\n+\n+                            if (!cacheEntry.isExpired(-1)) {\n+                                try {\n+                                    addToRoleMap(domainDir.getName(), tokenFile.getName(), accessTokenResponse);\n+                                } catch (IOException e) {\n+                                    LOG.warn(\"Failed to put role map for token: {}\", tokenFile.getName());\n+                                }\n+                            }\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+\n+    }\n+\n+    // function load the access token from file\n+    public AccessTokenResponse lookupAccessTokenFromDisk(String domain, List<String> rolesName) throws IOException {\n+        String path = System.getProperty(ACCESS_TOKEN_PATH_PROPERTY, DEFAULT_ACCESS_TOKEN_DIR_PATH);", "originalCommit": "f752126dc7dcbe37f728dd8bb39276727269d071", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjExNTI5OQ==", "url": "https://github.com/AthenZ/athenz/pull/1028#discussion_r456115299", "bodyText": "updated", "author": "MartinTrojans", "createdAt": "2020-07-16T22:32:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM3NzAwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "4a483e2be4baf10c7e0af37c4b77b70ccd3e9989", "chunk": "diff --git a/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSFileUtil.java b/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\nsimilarity index 57%\nrename from clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSFileUtil.java\nrename to clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\nindex d01606b75..88a18c48b 100644\n--- a/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSFileUtil.java\n+++ b/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\n\n@@ -10,27 +10,32 @@ import java.io.File;\n import java.io.IOException;\n import java.util.*;\n \n-public class ZTSFileUtil {\n+public class ZTSAccessTokenFileLoader {\n \n-    private static final Logger LOG = LoggerFactory.getLogger(ZTSFileUtil.class);\n+    private static final Logger LOG = LoggerFactory.getLogger(ZTSAccessTokenFileLoader.class);\n \n+    static public final String ACCESS_TOKEN_PATH_PROPERTY = \"athenz.zts.client.accesstoken.path\";\n     static private final String DEFAULT_ACCESS_TOKEN_DIR_PATH = \"/var/lib/sia/tokens/\";\n-    static private final String ACCESS_TOKEN_PATH_PROPERTY = \"zts.client.accesstoken.path\";\n     static private final String ROLE_NAME_CONNECTOR = \",\";\n-    private JwtsSigningKeyResolver accessSignKeyResolver = null;\n+    static private final String DOMAIN_ROLE_CONNECTOR = \":role:\";\n+    final private String path;\n+    private JwtsSigningKeyResolver accessSignKeyResolver;\n     private ObjectMapper objectMapper = new ObjectMapper();\n     private Map<String, String> roleNameMap;\n \n-    public ZTSFileUtil(JwtsSigningKeyResolver resolver) {\n+    public ZTSAccessTokenFileLoader(JwtsSigningKeyResolver resolver) {\n         roleNameMap = new HashMap<>();\n         accessSignKeyResolver = resolver;\n+        path = System.getProperty(ACCESS_TOKEN_PATH_PROPERTY, DEFAULT_ACCESS_TOKEN_DIR_PATH);\n     }\n \n     public void preload() {\n-        String path = System.getProperty(ACCESS_TOKEN_PATH_PROPERTY, DEFAULT_ACCESS_TOKEN_DIR_PATH);\n         File dir = new File(path);\n \n-        // preload the map from the domain, rolesname to file path\n+        // preload the map from the <domain, rolesname> -> <file path>\n+        // expected dir should be <base token path>/<domain dir>/<token file>s\n+        // after preload the map, when we look up the access token,\n+        // the map will directly read the required file\n         if (dir.exists() && dir.isDirectory()) {\n             for (File domainDir: dir.listFiles()) {\n                 if (domainDir.isDirectory()) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM3NzE2Mg==", "url": "https://github.com/AthenZ/athenz/pull/1028#discussion_r453377162", "bodyText": "no need to create this object and and instead we can just have:\nreturn objectMapper.readValue(tokenFile, AccessTokenResponse.class);", "author": "havetisyan", "createdAt": "2020-07-12T23:35:48Z", "path": "clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSFileUtil.java", "diffHunk": "@@ -0,0 +1,105 @@\n+package com.yahoo.athenz.zts;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.yahoo.athenz.auth.token.AccessToken;\n+import com.yahoo.athenz.auth.token.jwts.JwtsSigningKeyResolver;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.*;\n+\n+public class ZTSFileUtil {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(ZTSFileUtil.class);\n+\n+    static private final String DEFAULT_ACCESS_TOKEN_DIR_PATH = \"/var/lib/sia/tokens/\";\n+    static private final String ACCESS_TOKEN_PATH_PROPERTY = \"zts.client.accesstoken.path\";\n+    static private final String ROLE_NAME_CONNECTOR = \",\";\n+    private JwtsSigningKeyResolver accessSignKeyResolver = null;\n+    private ObjectMapper objectMapper = new ObjectMapper();\n+    private Map<String, String> roleNameMap;\n+\n+    public ZTSFileUtil(JwtsSigningKeyResolver resolver) {\n+        roleNameMap = new HashMap<>();\n+        accessSignKeyResolver = resolver;\n+    }\n+\n+    public void preload() {\n+        String path = System.getProperty(ACCESS_TOKEN_PATH_PROPERTY, DEFAULT_ACCESS_TOKEN_DIR_PATH);\n+        File dir = new File(path);\n+\n+        // preload the map from the domain, rolesname to file path\n+        if (dir.exists() && dir.isDirectory()) {\n+            for (File domainDir: dir.listFiles()) {\n+                if (domainDir.isDirectory()) {\n+                    for (File tokenFile: domainDir.listFiles()) {\n+                        if (!tokenFile.isDirectory()) {\n+                            AccessTokenResponse accessTokenResponse = null;\n+                            try {\n+                                accessTokenResponse = objectMapper.readValue(tokenFile, AccessTokenResponse.class);\n+                            } catch (IOException e) {\n+                                LOG.warn(\"Failed to load or parse token file: {}\", tokenFile);\n+                            }\n+\n+                            if (accessTokenResponse == null) {\n+                                continue;\n+                            }\n+\n+                            AccessTokenResponseCacheEntry cacheEntry = new AccessTokenResponseCacheEntry(accessTokenResponse);\n+\n+                            if (!cacheEntry.isExpired(-1)) {\n+                                try {\n+                                    addToRoleMap(domainDir.getName(), tokenFile.getName(), accessTokenResponse);\n+                                } catch (IOException e) {\n+                                    LOG.warn(\"Failed to put role map for token: {}\", tokenFile.getName());\n+                                }\n+                            }\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+\n+    }\n+\n+    // function load the access token from file\n+    public AccessTokenResponse lookupAccessTokenFromDisk(String domain, List<String> rolesName) throws IOException {\n+        String path = System.getProperty(ACCESS_TOKEN_PATH_PROPERTY, DEFAULT_ACCESS_TOKEN_DIR_PATH);\n+        LOG.debug(\"Trying to fetch access token from disk for domain: {}, roleNames: {}\", domain, rolesName);\n+        String rolesStr = getRolesStr(domain, rolesName);\n+        String fileName = roleNameMap.get(rolesStr);\n+        if (fileName == null) {\n+            return null;\n+        }\n+        File tokenFile = new File(path + \"/\" + domain + \"/\" + fileName);\n+\n+        AccessTokenResponse accessTokenResponse = objectMapper.readValue(tokenFile, AccessTokenResponse.class);", "originalCommit": "f752126dc7dcbe37f728dd8bb39276727269d071", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4a483e2be4baf10c7e0af37c4b77b70ccd3e9989", "chunk": "diff --git a/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSFileUtil.java b/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\nsimilarity index 57%\nrename from clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSFileUtil.java\nrename to clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\nindex d01606b75..88a18c48b 100644\n--- a/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSFileUtil.java\n+++ b/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\n\n@@ -10,27 +10,32 @@ import java.io.File;\n import java.io.IOException;\n import java.util.*;\n \n-public class ZTSFileUtil {\n+public class ZTSAccessTokenFileLoader {\n \n-    private static final Logger LOG = LoggerFactory.getLogger(ZTSFileUtil.class);\n+    private static final Logger LOG = LoggerFactory.getLogger(ZTSAccessTokenFileLoader.class);\n \n+    static public final String ACCESS_TOKEN_PATH_PROPERTY = \"athenz.zts.client.accesstoken.path\";\n     static private final String DEFAULT_ACCESS_TOKEN_DIR_PATH = \"/var/lib/sia/tokens/\";\n-    static private final String ACCESS_TOKEN_PATH_PROPERTY = \"zts.client.accesstoken.path\";\n     static private final String ROLE_NAME_CONNECTOR = \",\";\n-    private JwtsSigningKeyResolver accessSignKeyResolver = null;\n+    static private final String DOMAIN_ROLE_CONNECTOR = \":role:\";\n+    final private String path;\n+    private JwtsSigningKeyResolver accessSignKeyResolver;\n     private ObjectMapper objectMapper = new ObjectMapper();\n     private Map<String, String> roleNameMap;\n \n-    public ZTSFileUtil(JwtsSigningKeyResolver resolver) {\n+    public ZTSAccessTokenFileLoader(JwtsSigningKeyResolver resolver) {\n         roleNameMap = new HashMap<>();\n         accessSignKeyResolver = resolver;\n+        path = System.getProperty(ACCESS_TOKEN_PATH_PROPERTY, DEFAULT_ACCESS_TOKEN_DIR_PATH);\n     }\n \n     public void preload() {\n-        String path = System.getProperty(ACCESS_TOKEN_PATH_PROPERTY, DEFAULT_ACCESS_TOKEN_DIR_PATH);\n         File dir = new File(path);\n \n-        // preload the map from the domain, rolesname to file path\n+        // preload the map from the <domain, rolesname> -> <file path>\n+        // expected dir should be <base token path>/<domain dir>/<token file>s\n+        // after preload the map, when we look up the access token,\n+        // the map will directly read the required file\n         if (dir.exists() && dir.isDirectory()) {\n             for (File domainDir: dir.listFiles()) {\n                 if (domainDir.isDirectory()) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM3NzE5Ng==", "url": "https://github.com/AthenZ/athenz/pull/1028#discussion_r453377196", "bodyText": "this should be final", "author": "havetisyan", "createdAt": "2020-07-12T23:36:11Z", "path": "clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSFileUtil.java", "diffHunk": "@@ -0,0 +1,105 @@\n+package com.yahoo.athenz.zts;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.yahoo.athenz.auth.token.AccessToken;\n+import com.yahoo.athenz.auth.token.jwts.JwtsSigningKeyResolver;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.*;\n+\n+public class ZTSFileUtil {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(ZTSFileUtil.class);\n+\n+    static private final String DEFAULT_ACCESS_TOKEN_DIR_PATH = \"/var/lib/sia/tokens/\";\n+    static private final String ACCESS_TOKEN_PATH_PROPERTY = \"zts.client.accesstoken.path\";\n+    static private final String ROLE_NAME_CONNECTOR = \",\";\n+    private JwtsSigningKeyResolver accessSignKeyResolver = null;\n+    private ObjectMapper objectMapper = new ObjectMapper();\n+    private Map<String, String> roleNameMap;\n+\n+    public ZTSFileUtil(JwtsSigningKeyResolver resolver) {\n+        roleNameMap = new HashMap<>();\n+        accessSignKeyResolver = resolver;\n+    }\n+\n+    public void preload() {\n+        String path = System.getProperty(ACCESS_TOKEN_PATH_PROPERTY, DEFAULT_ACCESS_TOKEN_DIR_PATH);\n+        File dir = new File(path);\n+\n+        // preload the map from the domain, rolesname to file path\n+        if (dir.exists() && dir.isDirectory()) {\n+            for (File domainDir: dir.listFiles()) {\n+                if (domainDir.isDirectory()) {\n+                    for (File tokenFile: domainDir.listFiles()) {\n+                        if (!tokenFile.isDirectory()) {\n+                            AccessTokenResponse accessTokenResponse = null;\n+                            try {\n+                                accessTokenResponse = objectMapper.readValue(tokenFile, AccessTokenResponse.class);\n+                            } catch (IOException e) {\n+                                LOG.warn(\"Failed to load or parse token file: {}\", tokenFile);\n+                            }\n+\n+                            if (accessTokenResponse == null) {\n+                                continue;\n+                            }\n+\n+                            AccessTokenResponseCacheEntry cacheEntry = new AccessTokenResponseCacheEntry(accessTokenResponse);\n+\n+                            if (!cacheEntry.isExpired(-1)) {\n+                                try {\n+                                    addToRoleMap(domainDir.getName(), tokenFile.getName(), accessTokenResponse);\n+                                } catch (IOException e) {\n+                                    LOG.warn(\"Failed to put role map for token: {}\", tokenFile.getName());\n+                                }\n+                            }\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+\n+    }\n+\n+    // function load the access token from file\n+    public AccessTokenResponse lookupAccessTokenFromDisk(String domain, List<String> rolesName) throws IOException {\n+        String path = System.getProperty(ACCESS_TOKEN_PATH_PROPERTY, DEFAULT_ACCESS_TOKEN_DIR_PATH);\n+        LOG.debug(\"Trying to fetch access token from disk for domain: {}, roleNames: {}\", domain, rolesName);\n+        String rolesStr = getRolesStr(domain, rolesName);\n+        String fileName = roleNameMap.get(rolesStr);\n+        if (fileName == null) {\n+            return null;\n+        }\n+        File tokenFile = new File(path + \"/\" + domain + \"/\" + fileName);\n+\n+        AccessTokenResponse accessTokenResponse = objectMapper.readValue(tokenFile, AccessTokenResponse.class);\n+\n+        return accessTokenResponse;\n+    }\n+\n+    static private String getRolesStr(String domain, List<String> roleNames) {\n+        if (roleNames == null || roleNames.isEmpty()) {\n+            //if no role name specific, should return all roles\n+            return \"*\";\n+        }\n+        Collections.sort(roleNames);\n+        return domain + ROLE_NAME_CONNECTOR + String.join(ROLE_NAME_CONNECTOR, roleNames);\n+    }\n+\n+    private void addToRoleMap(String domain, String fileName, AccessTokenResponse accessTokenResponse) throws IOException {\n+        // parse roles from access token\n+        String token = accessTokenResponse.getAccess_token();", "originalCommit": "f752126dc7dcbe37f728dd8bb39276727269d071", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4a483e2be4baf10c7e0af37c4b77b70ccd3e9989", "chunk": "diff --git a/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSFileUtil.java b/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\nsimilarity index 57%\nrename from clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSFileUtil.java\nrename to clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\nindex d01606b75..88a18c48b 100644\n--- a/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSFileUtil.java\n+++ b/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\n\n@@ -10,27 +10,32 @@ import java.io.File;\n import java.io.IOException;\n import java.util.*;\n \n-public class ZTSFileUtil {\n+public class ZTSAccessTokenFileLoader {\n \n-    private static final Logger LOG = LoggerFactory.getLogger(ZTSFileUtil.class);\n+    private static final Logger LOG = LoggerFactory.getLogger(ZTSAccessTokenFileLoader.class);\n \n+    static public final String ACCESS_TOKEN_PATH_PROPERTY = \"athenz.zts.client.accesstoken.path\";\n     static private final String DEFAULT_ACCESS_TOKEN_DIR_PATH = \"/var/lib/sia/tokens/\";\n-    static private final String ACCESS_TOKEN_PATH_PROPERTY = \"zts.client.accesstoken.path\";\n     static private final String ROLE_NAME_CONNECTOR = \",\";\n-    private JwtsSigningKeyResolver accessSignKeyResolver = null;\n+    static private final String DOMAIN_ROLE_CONNECTOR = \":role:\";\n+    final private String path;\n+    private JwtsSigningKeyResolver accessSignKeyResolver;\n     private ObjectMapper objectMapper = new ObjectMapper();\n     private Map<String, String> roleNameMap;\n \n-    public ZTSFileUtil(JwtsSigningKeyResolver resolver) {\n+    public ZTSAccessTokenFileLoader(JwtsSigningKeyResolver resolver) {\n         roleNameMap = new HashMap<>();\n         accessSignKeyResolver = resolver;\n+        path = System.getProperty(ACCESS_TOKEN_PATH_PROPERTY, DEFAULT_ACCESS_TOKEN_DIR_PATH);\n     }\n \n     public void preload() {\n-        String path = System.getProperty(ACCESS_TOKEN_PATH_PROPERTY, DEFAULT_ACCESS_TOKEN_DIR_PATH);\n         File dir = new File(path);\n \n-        // preload the map from the domain, rolesname to file path\n+        // preload the map from the <domain, rolesname> -> <file path>\n+        // expected dir should be <base token path>/<domain dir>/<token file>s\n+        // after preload the map, when we look up the access token,\n+        // the map will directly read the required file\n         if (dir.exists() && dir.isDirectory()) {\n             for (File domainDir: dir.listFiles()) {\n                 if (domainDir.isDirectory()) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM3NzIzMg==", "url": "https://github.com/AthenZ/athenz/pull/1028#discussion_r453377232", "bodyText": "any exceptions should be logger as error", "author": "havetisyan", "createdAt": "2020-07-12T23:36:41Z", "path": "clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSFileUtil.java", "diffHunk": "@@ -0,0 +1,105 @@\n+package com.yahoo.athenz.zts;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.yahoo.athenz.auth.token.AccessToken;\n+import com.yahoo.athenz.auth.token.jwts.JwtsSigningKeyResolver;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.*;\n+\n+public class ZTSFileUtil {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(ZTSFileUtil.class);\n+\n+    static private final String DEFAULT_ACCESS_TOKEN_DIR_PATH = \"/var/lib/sia/tokens/\";\n+    static private final String ACCESS_TOKEN_PATH_PROPERTY = \"zts.client.accesstoken.path\";\n+    static private final String ROLE_NAME_CONNECTOR = \",\";\n+    private JwtsSigningKeyResolver accessSignKeyResolver = null;\n+    private ObjectMapper objectMapper = new ObjectMapper();\n+    private Map<String, String> roleNameMap;\n+\n+    public ZTSFileUtil(JwtsSigningKeyResolver resolver) {\n+        roleNameMap = new HashMap<>();\n+        accessSignKeyResolver = resolver;\n+    }\n+\n+    public void preload() {\n+        String path = System.getProperty(ACCESS_TOKEN_PATH_PROPERTY, DEFAULT_ACCESS_TOKEN_DIR_PATH);\n+        File dir = new File(path);\n+\n+        // preload the map from the domain, rolesname to file path\n+        if (dir.exists() && dir.isDirectory()) {\n+            for (File domainDir: dir.listFiles()) {\n+                if (domainDir.isDirectory()) {\n+                    for (File tokenFile: domainDir.listFiles()) {\n+                        if (!tokenFile.isDirectory()) {\n+                            AccessTokenResponse accessTokenResponse = null;\n+                            try {\n+                                accessTokenResponse = objectMapper.readValue(tokenFile, AccessTokenResponse.class);\n+                            } catch (IOException e) {\n+                                LOG.warn(\"Failed to load or parse token file: {}\", tokenFile);\n+                            }\n+\n+                            if (accessTokenResponse == null) {\n+                                continue;\n+                            }\n+\n+                            AccessTokenResponseCacheEntry cacheEntry = new AccessTokenResponseCacheEntry(accessTokenResponse);\n+\n+                            if (!cacheEntry.isExpired(-1)) {\n+                                try {\n+                                    addToRoleMap(domainDir.getName(), tokenFile.getName(), accessTokenResponse);\n+                                } catch (IOException e) {\n+                                    LOG.warn(\"Failed to put role map for token: {}\", tokenFile.getName());\n+                                }\n+                            }\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+\n+    }\n+\n+    // function load the access token from file\n+    public AccessTokenResponse lookupAccessTokenFromDisk(String domain, List<String> rolesName) throws IOException {\n+        String path = System.getProperty(ACCESS_TOKEN_PATH_PROPERTY, DEFAULT_ACCESS_TOKEN_DIR_PATH);\n+        LOG.debug(\"Trying to fetch access token from disk for domain: {}, roleNames: {}\", domain, rolesName);\n+        String rolesStr = getRolesStr(domain, rolesName);\n+        String fileName = roleNameMap.get(rolesStr);\n+        if (fileName == null) {\n+            return null;\n+        }\n+        File tokenFile = new File(path + \"/\" + domain + \"/\" + fileName);\n+\n+        AccessTokenResponse accessTokenResponse = objectMapper.readValue(tokenFile, AccessTokenResponse.class);\n+\n+        return accessTokenResponse;\n+    }\n+\n+    static private String getRolesStr(String domain, List<String> roleNames) {\n+        if (roleNames == null || roleNames.isEmpty()) {\n+            //if no role name specific, should return all roles\n+            return \"*\";\n+        }\n+        Collections.sort(roleNames);\n+        return domain + ROLE_NAME_CONNECTOR + String.join(ROLE_NAME_CONNECTOR, roleNames);\n+    }\n+\n+    private void addToRoleMap(String domain, String fileName, AccessTokenResponse accessTokenResponse) throws IOException {\n+        // parse roles from access token\n+        String token = accessTokenResponse.getAccess_token();\n+\n+        try {\n+            AccessToken accessToken = new AccessToken(token, accessSignKeyResolver);\n+            List<String> roleNames = accessToken.getScope();\n+            roleNameMap.put(getRolesStr(domain, roleNames), fileName);\n+        } catch (Exception e) {\n+            LOG.warn(\"Got error to parse access token file {}, error: {}\", fileName, e.getMessage());", "originalCommit": "f752126dc7dcbe37f728dd8bb39276727269d071", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4a483e2be4baf10c7e0af37c4b77b70ccd3e9989", "chunk": "diff --git a/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSFileUtil.java b/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\nsimilarity index 57%\nrename from clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSFileUtil.java\nrename to clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\nindex d01606b75..88a18c48b 100644\n--- a/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSFileUtil.java\n+++ b/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\n\n@@ -10,27 +10,32 @@ import java.io.File;\n import java.io.IOException;\n import java.util.*;\n \n-public class ZTSFileUtil {\n+public class ZTSAccessTokenFileLoader {\n \n-    private static final Logger LOG = LoggerFactory.getLogger(ZTSFileUtil.class);\n+    private static final Logger LOG = LoggerFactory.getLogger(ZTSAccessTokenFileLoader.class);\n \n+    static public final String ACCESS_TOKEN_PATH_PROPERTY = \"athenz.zts.client.accesstoken.path\";\n     static private final String DEFAULT_ACCESS_TOKEN_DIR_PATH = \"/var/lib/sia/tokens/\";\n-    static private final String ACCESS_TOKEN_PATH_PROPERTY = \"zts.client.accesstoken.path\";\n     static private final String ROLE_NAME_CONNECTOR = \",\";\n-    private JwtsSigningKeyResolver accessSignKeyResolver = null;\n+    static private final String DOMAIN_ROLE_CONNECTOR = \":role:\";\n+    final private String path;\n+    private JwtsSigningKeyResolver accessSignKeyResolver;\n     private ObjectMapper objectMapper = new ObjectMapper();\n     private Map<String, String> roleNameMap;\n \n-    public ZTSFileUtil(JwtsSigningKeyResolver resolver) {\n+    public ZTSAccessTokenFileLoader(JwtsSigningKeyResolver resolver) {\n         roleNameMap = new HashMap<>();\n         accessSignKeyResolver = resolver;\n+        path = System.getProperty(ACCESS_TOKEN_PATH_PROPERTY, DEFAULT_ACCESS_TOKEN_DIR_PATH);\n     }\n \n     public void preload() {\n-        String path = System.getProperty(ACCESS_TOKEN_PATH_PROPERTY, DEFAULT_ACCESS_TOKEN_DIR_PATH);\n         File dir = new File(path);\n \n-        // preload the map from the domain, rolesname to file path\n+        // preload the map from the <domain, rolesname> -> <file path>\n+        // expected dir should be <base token path>/<domain dir>/<token file>s\n+        // after preload the map, when we look up the access token,\n+        // the map will directly read the required file\n         if (dir.exists() && dir.isDirectory()) {\n             for (File domainDir: dir.listFiles()) {\n                 if (domainDir.isDirectory()) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM3NzQ2Mg==", "url": "https://github.com/AthenZ/athenz/pull/1028#discussion_r453377462", "bodyText": "we should add more comments here as far what is the expected directory structure otherwise it's not easy to follow why we're keep traversing, etc", "author": "havetisyan", "createdAt": "2020-07-12T23:38:58Z", "path": "clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSFileUtil.java", "diffHunk": "@@ -0,0 +1,105 @@\n+package com.yahoo.athenz.zts;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.yahoo.athenz.auth.token.AccessToken;\n+import com.yahoo.athenz.auth.token.jwts.JwtsSigningKeyResolver;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.*;\n+\n+public class ZTSFileUtil {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(ZTSFileUtil.class);\n+\n+    static private final String DEFAULT_ACCESS_TOKEN_DIR_PATH = \"/var/lib/sia/tokens/\";\n+    static private final String ACCESS_TOKEN_PATH_PROPERTY = \"zts.client.accesstoken.path\";\n+    static private final String ROLE_NAME_CONNECTOR = \",\";\n+    private JwtsSigningKeyResolver accessSignKeyResolver = null;\n+    private ObjectMapper objectMapper = new ObjectMapper();\n+    private Map<String, String> roleNameMap;\n+\n+    public ZTSFileUtil(JwtsSigningKeyResolver resolver) {\n+        roleNameMap = new HashMap<>();\n+        accessSignKeyResolver = resolver;\n+    }\n+\n+    public void preload() {\n+        String path = System.getProperty(ACCESS_TOKEN_PATH_PROPERTY, DEFAULT_ACCESS_TOKEN_DIR_PATH);\n+        File dir = new File(path);\n+\n+        // preload the map from the domain, rolesname to file path", "originalCommit": "f752126dc7dcbe37f728dd8bb39276727269d071", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4a483e2be4baf10c7e0af37c4b77b70ccd3e9989", "chunk": "diff --git a/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSFileUtil.java b/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\nsimilarity index 57%\nrename from clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSFileUtil.java\nrename to clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\nindex d01606b75..88a18c48b 100644\n--- a/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSFileUtil.java\n+++ b/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\n\n@@ -10,27 +10,32 @@ import java.io.File;\n import java.io.IOException;\n import java.util.*;\n \n-public class ZTSFileUtil {\n+public class ZTSAccessTokenFileLoader {\n \n-    private static final Logger LOG = LoggerFactory.getLogger(ZTSFileUtil.class);\n+    private static final Logger LOG = LoggerFactory.getLogger(ZTSAccessTokenFileLoader.class);\n \n+    static public final String ACCESS_TOKEN_PATH_PROPERTY = \"athenz.zts.client.accesstoken.path\";\n     static private final String DEFAULT_ACCESS_TOKEN_DIR_PATH = \"/var/lib/sia/tokens/\";\n-    static private final String ACCESS_TOKEN_PATH_PROPERTY = \"zts.client.accesstoken.path\";\n     static private final String ROLE_NAME_CONNECTOR = \",\";\n-    private JwtsSigningKeyResolver accessSignKeyResolver = null;\n+    static private final String DOMAIN_ROLE_CONNECTOR = \":role:\";\n+    final private String path;\n+    private JwtsSigningKeyResolver accessSignKeyResolver;\n     private ObjectMapper objectMapper = new ObjectMapper();\n     private Map<String, String> roleNameMap;\n \n-    public ZTSFileUtil(JwtsSigningKeyResolver resolver) {\n+    public ZTSAccessTokenFileLoader(JwtsSigningKeyResolver resolver) {\n         roleNameMap = new HashMap<>();\n         accessSignKeyResolver = resolver;\n+        path = System.getProperty(ACCESS_TOKEN_PATH_PROPERTY, DEFAULT_ACCESS_TOKEN_DIR_PATH);\n     }\n \n     public void preload() {\n-        String path = System.getProperty(ACCESS_TOKEN_PATH_PROPERTY, DEFAULT_ACCESS_TOKEN_DIR_PATH);\n         File dir = new File(path);\n \n-        // preload the map from the domain, rolesname to file path\n+        // preload the map from the <domain, rolesname> -> <file path>\n+        // expected dir should be <base token path>/<domain dir>/<token file>s\n+        // after preload the map, when we look up the access token,\n+        // the map will directly read the required file\n         if (dir.exists() && dir.isDirectory()) {\n             for (File domainDir: dir.listFiles()) {\n                 if (domainDir.isDirectory()) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM3Nzg0NA==", "url": "https://github.com/AthenZ/athenz/pull/1028#discussion_r453377844", "bodyText": "this should also be an error", "author": "havetisyan", "createdAt": "2020-07-12T23:42:13Z", "path": "clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSFileUtil.java", "diffHunk": "@@ -0,0 +1,105 @@\n+package com.yahoo.athenz.zts;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.yahoo.athenz.auth.token.AccessToken;\n+import com.yahoo.athenz.auth.token.jwts.JwtsSigningKeyResolver;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.*;\n+\n+public class ZTSFileUtil {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(ZTSFileUtil.class);\n+\n+    static private final String DEFAULT_ACCESS_TOKEN_DIR_PATH = \"/var/lib/sia/tokens/\";\n+    static private final String ACCESS_TOKEN_PATH_PROPERTY = \"zts.client.accesstoken.path\";\n+    static private final String ROLE_NAME_CONNECTOR = \",\";\n+    private JwtsSigningKeyResolver accessSignKeyResolver = null;\n+    private ObjectMapper objectMapper = new ObjectMapper();\n+    private Map<String, String> roleNameMap;\n+\n+    public ZTSFileUtil(JwtsSigningKeyResolver resolver) {\n+        roleNameMap = new HashMap<>();\n+        accessSignKeyResolver = resolver;\n+    }\n+\n+    public void preload() {\n+        String path = System.getProperty(ACCESS_TOKEN_PATH_PROPERTY, DEFAULT_ACCESS_TOKEN_DIR_PATH);\n+        File dir = new File(path);\n+\n+        // preload the map from the domain, rolesname to file path\n+        if (dir.exists() && dir.isDirectory()) {\n+            for (File domainDir: dir.listFiles()) {\n+                if (domainDir.isDirectory()) {\n+                    for (File tokenFile: domainDir.listFiles()) {\n+                        if (!tokenFile.isDirectory()) {\n+                            AccessTokenResponse accessTokenResponse = null;\n+                            try {\n+                                accessTokenResponse = objectMapper.readValue(tokenFile, AccessTokenResponse.class);\n+                            } catch (IOException e) {\n+                                LOG.warn(\"Failed to load or parse token file: {}\", tokenFile);", "originalCommit": "f752126dc7dcbe37f728dd8bb39276727269d071", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4a483e2be4baf10c7e0af37c4b77b70ccd3e9989", "chunk": "diff --git a/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSFileUtil.java b/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\nsimilarity index 57%\nrename from clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSFileUtil.java\nrename to clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\nindex d01606b75..88a18c48b 100644\n--- a/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSFileUtil.java\n+++ b/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\n\n@@ -10,27 +10,32 @@ import java.io.File;\n import java.io.IOException;\n import java.util.*;\n \n-public class ZTSFileUtil {\n+public class ZTSAccessTokenFileLoader {\n \n-    private static final Logger LOG = LoggerFactory.getLogger(ZTSFileUtil.class);\n+    private static final Logger LOG = LoggerFactory.getLogger(ZTSAccessTokenFileLoader.class);\n \n+    static public final String ACCESS_TOKEN_PATH_PROPERTY = \"athenz.zts.client.accesstoken.path\";\n     static private final String DEFAULT_ACCESS_TOKEN_DIR_PATH = \"/var/lib/sia/tokens/\";\n-    static private final String ACCESS_TOKEN_PATH_PROPERTY = \"zts.client.accesstoken.path\";\n     static private final String ROLE_NAME_CONNECTOR = \",\";\n-    private JwtsSigningKeyResolver accessSignKeyResolver = null;\n+    static private final String DOMAIN_ROLE_CONNECTOR = \":role:\";\n+    final private String path;\n+    private JwtsSigningKeyResolver accessSignKeyResolver;\n     private ObjectMapper objectMapper = new ObjectMapper();\n     private Map<String, String> roleNameMap;\n \n-    public ZTSFileUtil(JwtsSigningKeyResolver resolver) {\n+    public ZTSAccessTokenFileLoader(JwtsSigningKeyResolver resolver) {\n         roleNameMap = new HashMap<>();\n         accessSignKeyResolver = resolver;\n+        path = System.getProperty(ACCESS_TOKEN_PATH_PROPERTY, DEFAULT_ACCESS_TOKEN_DIR_PATH);\n     }\n \n     public void preload() {\n-        String path = System.getProperty(ACCESS_TOKEN_PATH_PROPERTY, DEFAULT_ACCESS_TOKEN_DIR_PATH);\n         File dir = new File(path);\n \n-        // preload the map from the domain, rolesname to file path\n+        // preload the map from the <domain, rolesname> -> <file path>\n+        // expected dir should be <base token path>/<domain dir>/<token file>s\n+        // after preload the map, when we look up the access token,\n+        // the map will directly read the required file\n         if (dir.exists() && dir.isDirectory()) {\n             for (File domainDir: dir.listFiles()) {\n                 if (domainDir.isDirectory()) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM3Nzg4Ng==", "url": "https://github.com/AthenZ/athenz/pull/1028#discussion_r453377886", "bodyText": "here as well let's make this an error", "author": "havetisyan", "createdAt": "2020-07-12T23:42:44Z", "path": "clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSFileUtil.java", "diffHunk": "@@ -0,0 +1,105 @@\n+package com.yahoo.athenz.zts;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.yahoo.athenz.auth.token.AccessToken;\n+import com.yahoo.athenz.auth.token.jwts.JwtsSigningKeyResolver;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.*;\n+\n+public class ZTSFileUtil {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(ZTSFileUtil.class);\n+\n+    static private final String DEFAULT_ACCESS_TOKEN_DIR_PATH = \"/var/lib/sia/tokens/\";\n+    static private final String ACCESS_TOKEN_PATH_PROPERTY = \"zts.client.accesstoken.path\";\n+    static private final String ROLE_NAME_CONNECTOR = \",\";\n+    private JwtsSigningKeyResolver accessSignKeyResolver = null;\n+    private ObjectMapper objectMapper = new ObjectMapper();\n+    private Map<String, String> roleNameMap;\n+\n+    public ZTSFileUtil(JwtsSigningKeyResolver resolver) {\n+        roleNameMap = new HashMap<>();\n+        accessSignKeyResolver = resolver;\n+    }\n+\n+    public void preload() {\n+        String path = System.getProperty(ACCESS_TOKEN_PATH_PROPERTY, DEFAULT_ACCESS_TOKEN_DIR_PATH);\n+        File dir = new File(path);\n+\n+        // preload the map from the domain, rolesname to file path\n+        if (dir.exists() && dir.isDirectory()) {\n+            for (File domainDir: dir.listFiles()) {\n+                if (domainDir.isDirectory()) {\n+                    for (File tokenFile: domainDir.listFiles()) {\n+                        if (!tokenFile.isDirectory()) {\n+                            AccessTokenResponse accessTokenResponse = null;\n+                            try {\n+                                accessTokenResponse = objectMapper.readValue(tokenFile, AccessTokenResponse.class);\n+                            } catch (IOException e) {\n+                                LOG.warn(\"Failed to load or parse token file: {}\", tokenFile);\n+                            }\n+\n+                            if (accessTokenResponse == null) {\n+                                continue;\n+                            }\n+\n+                            AccessTokenResponseCacheEntry cacheEntry = new AccessTokenResponseCacheEntry(accessTokenResponse);\n+\n+                            if (!cacheEntry.isExpired(-1)) {\n+                                try {\n+                                    addToRoleMap(domainDir.getName(), tokenFile.getName(), accessTokenResponse);\n+                                } catch (IOException e) {\n+                                    LOG.warn(\"Failed to put role map for token: {}\", tokenFile.getName());", "originalCommit": "f752126dc7dcbe37f728dd8bb39276727269d071", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4a483e2be4baf10c7e0af37c4b77b70ccd3e9989", "chunk": "diff --git a/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSFileUtil.java b/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\nsimilarity index 57%\nrename from clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSFileUtil.java\nrename to clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\nindex d01606b75..88a18c48b 100644\n--- a/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSFileUtil.java\n+++ b/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\n\n@@ -10,27 +10,32 @@ import java.io.File;\n import java.io.IOException;\n import java.util.*;\n \n-public class ZTSFileUtil {\n+public class ZTSAccessTokenFileLoader {\n \n-    private static final Logger LOG = LoggerFactory.getLogger(ZTSFileUtil.class);\n+    private static final Logger LOG = LoggerFactory.getLogger(ZTSAccessTokenFileLoader.class);\n \n+    static public final String ACCESS_TOKEN_PATH_PROPERTY = \"athenz.zts.client.accesstoken.path\";\n     static private final String DEFAULT_ACCESS_TOKEN_DIR_PATH = \"/var/lib/sia/tokens/\";\n-    static private final String ACCESS_TOKEN_PATH_PROPERTY = \"zts.client.accesstoken.path\";\n     static private final String ROLE_NAME_CONNECTOR = \",\";\n-    private JwtsSigningKeyResolver accessSignKeyResolver = null;\n+    static private final String DOMAIN_ROLE_CONNECTOR = \":role:\";\n+    final private String path;\n+    private JwtsSigningKeyResolver accessSignKeyResolver;\n     private ObjectMapper objectMapper = new ObjectMapper();\n     private Map<String, String> roleNameMap;\n \n-    public ZTSFileUtil(JwtsSigningKeyResolver resolver) {\n+    public ZTSAccessTokenFileLoader(JwtsSigningKeyResolver resolver) {\n         roleNameMap = new HashMap<>();\n         accessSignKeyResolver = resolver;\n+        path = System.getProperty(ACCESS_TOKEN_PATH_PROPERTY, DEFAULT_ACCESS_TOKEN_DIR_PATH);\n     }\n \n     public void preload() {\n-        String path = System.getProperty(ACCESS_TOKEN_PATH_PROPERTY, DEFAULT_ACCESS_TOKEN_DIR_PATH);\n         File dir = new File(path);\n \n-        // preload the map from the domain, rolesname to file path\n+        // preload the map from the <domain, rolesname> -> <file path>\n+        // expected dir should be <base token path>/<domain dir>/<token file>s\n+        // after preload the map, when we look up the access token,\n+        // the map will directly read the required file\n         if (dir.exists() && dir.isDirectory()) {\n             for (File domainDir: dir.listFiles()) {\n                 if (domainDir.isDirectory()) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM3ODI4MQ==", "url": "https://github.com/AthenZ/athenz/pull/1028#discussion_r453378281", "bodyText": "we should add test cases where we have invalid access tokens on disk and make sure those are correctly handled and skipped by the client", "author": "havetisyan", "createdAt": "2020-07-12T23:46:09Z", "path": "clients/java/zts/core/src/test/java/com/yahoo/athenz/zts/ZTSClientTest.java", "diffHunk": "@@ -3014,6 +3019,31 @@ public void testGetAccessTokenCacheKeySSLContext() {\n         client.close();\n     }\n \n+    @Test\n+    public void testGetAccessTokenFromFile() {", "originalCommit": "f752126dc7dcbe37f728dd8bb39276727269d071", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTk0OTgwNA==", "url": "https://github.com/AthenZ/athenz/pull/1028#discussion_r455949804", "bodyText": "Added invalid access token", "author": "MartinTrojans", "createdAt": "2020-07-16T17:24:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM3ODI4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "4a483e2be4baf10c7e0af37c4b77b70ccd3e9989", "chunk": "diff --git a/clients/java/zts/core/src/test/java/com/yahoo/athenz/zts/ZTSClientTest.java b/clients/java/zts/core/src/test/java/com/yahoo/athenz/zts/ZTSClientTest.java\nindex 4160dec34..02e4a0414 100644\n--- a/clients/java/zts/core/src/test/java/com/yahoo/athenz/zts/ZTSClientTest.java\n+++ b/clients/java/zts/core/src/test/java/com/yahoo/athenz/zts/ZTSClientTest.java\n\n@@ -3026,8 +3027,9 @@ public class ZTSClientTest {\n         PublicKey publicKey = Crypto.loadPublicKey(ecPublicKey);\n         resolver.addPublicKey(\"eckey1\", publicKey);\n         Path path = Paths.get(\"./src/test/resources/\");\n-        System.setProperty(\"zts.client.accesstoken.path\", path.toString());\n+        System.setProperty(ZTSAccessTokenFileLoader.ACCESS_TOKEN_PATH_PROPERTY, path.toString());\n         setupTokenFile();\n+        setupInvalidTokenFile();\n \n         Principal principal = SimplePrincipal.create(\"user_domain\", \"user\",\n                 \"auth_creds\", PRINCIPAL_AUTHORITY);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM3ODcxOQ==", "url": "https://github.com/AthenZ/athenz/pull/1028#discussion_r453378719", "bodyText": "I'm not sure why we're only setting the resolver here and not doing anything else since it means after I do this I also need to call initZtsFileUtil to set the resolver and call preload. So why just within this call we reload the file util object ourselves instead of asking the user to do it.", "author": "havetisyan", "createdAt": "2020-07-12T23:50:19Z", "path": "clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSClient.java", "diffHunk": "@@ -327,6 +334,23 @@ public static void lookupZTSUrl() {\n             }\n         }\n     }\n+\n+    public static void initZtsFileUtil() {\n+        ztsFileUtil = new ZTSFileUtil(getAccessTokenSignKeyResolver());\n+        ztsFileUtil.preload();\n+    }\n+\n+    public static void setAccessTokenSignKeyResolver(JwtsSigningKeyResolver jwtsSigningKeyResolver) {", "originalCommit": "f752126dc7dcbe37f728dd8bb39276727269d071", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTk0OTQwMA==", "url": "https://github.com/AthenZ/athenz/pull/1028#discussion_r455949400", "bodyText": "Having setAccessTokenSignKeyResolver and getAccessTokenSignKeyResolver is for setting mock resolver in unit test", "author": "MartinTrojans", "createdAt": "2020-07-16T17:23:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM3ODcxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE2MTU0OA==", "url": "https://github.com/AthenZ/athenz/pull/1028#discussion_r456161548", "bodyText": "but we still need to make them usable since they're declared as public. so rather than just having a resolver kept as a member variable, we can call the init method again to reinitialize the file utility and you don't need the getAccessTokenSignKeyResolver() at all.\nThis also gives the client the flexibility for someone who doesn't want to use the conf file but define their own resolver, so that they can do so and pass it to the client.", "author": "havetisyan", "createdAt": "2020-07-17T01:05:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM3ODcxOQ=="}], "type": "inlineReview", "revised_code": {"commit": "4a483e2be4baf10c7e0af37c4b77b70ccd3e9989", "chunk": "diff --git a/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSClient.java b/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSClient.java\nindex 6b172737f..f72c3985e 100644\n--- a/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSClient.java\n+++ b/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSClient.java\n\n@@ -335,23 +335,18 @@ public class ZTSClient implements Closeable {\n         }\n     }\n \n-    public static void initZtsFileUtil() {\n-        ztsFileUtil = new ZTSFileUtil(getAccessTokenSignKeyResolver());\n-        ztsFileUtil.preload();\n+    public static void initZTSAccessTokenFileLoader() {\n+        if (resolver == null) {\n+            resolver = new JwtsSigningKeyResolver(null, null);\n+        }\n+        ztsAccessTokenFileLoader = new ZTSAccessTokenFileLoader(resolver);\n+        ztsAccessTokenFileLoader.preload();\n     }\n \n     public static void setAccessTokenSignKeyResolver(JwtsSigningKeyResolver jwtsSigningKeyResolver) {\n         resolver = jwtsSigningKeyResolver;\n     }\n \n-    public static JwtsSigningKeyResolver getAccessTokenSignKeyResolver() {\n-        if (resolver == null) {\n-            return new JwtsSigningKeyResolver(null, null);\n-        } else {\n-            return resolver;\n-        }\n-    }\n-    \n     /**\n      * Constructs a new ZTSClient object with default settings.\n      * The url for ZTS Server is automatically retrieved from the athenz\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM3ODc0NQ==", "url": "https://github.com/AthenZ/athenz/pull/1028#discussion_r453378745", "bodyText": "based on the previous comment for the setAccessTokenSignKeyResolver I don't think we need this function at all.", "author": "havetisyan", "createdAt": "2020-07-12T23:50:41Z", "path": "clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSClient.java", "diffHunk": "@@ -327,6 +334,23 @@ public static void lookupZTSUrl() {\n             }\n         }\n     }\n+\n+    public static void initZtsFileUtil() {\n+        ztsFileUtil = new ZTSFileUtil(getAccessTokenSignKeyResolver());\n+        ztsFileUtil.preload();\n+    }\n+\n+    public static void setAccessTokenSignKeyResolver(JwtsSigningKeyResolver jwtsSigningKeyResolver) {\n+        resolver = jwtsSigningKeyResolver;\n+    }\n+\n+    public static JwtsSigningKeyResolver getAccessTokenSignKeyResolver() {", "originalCommit": "f752126dc7dcbe37f728dd8bb39276727269d071", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTk0OTQ0Mg==", "url": "https://github.com/AthenZ/athenz/pull/1028#discussion_r455949442", "bodyText": "Having setAccessTokenSignKeyResolver and getAccessTokenSignKeyResolver is for setting mock resolver in unit test", "author": "MartinTrojans", "createdAt": "2020-07-16T17:23:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM3ODc0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE2MTY2Mg==", "url": "https://github.com/AthenZ/athenz/pull/1028#discussion_r456161662", "bodyText": "the unit tests can only be done with the set method . no need for this get method.", "author": "havetisyan", "createdAt": "2020-07-17T01:06:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM3ODc0NQ=="}], "type": "inlineReview", "revised_code": {"commit": "4a483e2be4baf10c7e0af37c4b77b70ccd3e9989", "chunk": "diff --git a/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSClient.java b/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSClient.java\nindex 6b172737f..f72c3985e 100644\n--- a/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSClient.java\n+++ b/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSClient.java\n\n@@ -335,23 +335,18 @@ public class ZTSClient implements Closeable {\n         }\n     }\n \n-    public static void initZtsFileUtil() {\n-        ztsFileUtil = new ZTSFileUtil(getAccessTokenSignKeyResolver());\n-        ztsFileUtil.preload();\n+    public static void initZTSAccessTokenFileLoader() {\n+        if (resolver == null) {\n+            resolver = new JwtsSigningKeyResolver(null, null);\n+        }\n+        ztsAccessTokenFileLoader = new ZTSAccessTokenFileLoader(resolver);\n+        ztsAccessTokenFileLoader.preload();\n     }\n \n     public static void setAccessTokenSignKeyResolver(JwtsSigningKeyResolver jwtsSigningKeyResolver) {\n         resolver = jwtsSigningKeyResolver;\n     }\n \n-    public static JwtsSigningKeyResolver getAccessTokenSignKeyResolver() {\n-        if (resolver == null) {\n-            return new JwtsSigningKeyResolver(null, null);\n-        } else {\n-            return resolver;\n-        }\n-    }\n-    \n     /**\n      * Constructs a new ZTSClient object with default settings.\n      * The url for ZTS Server is automatically retrieved from the athenz\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM3ODgxNg==", "url": "https://github.com/AthenZ/athenz/pull/1028#discussion_r453378816", "bodyText": "Let's call it more specific ZTSAccessTokenFileLoader instead of ZTSFileUtil", "author": "havetisyan", "createdAt": "2020-07-12T23:51:15Z", "path": "clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSClient.java", "diffHunk": "@@ -172,6 +174,7 @@\n     private static ServiceLoader<ZTSClientService> ztsTokenProviders;\n     private static AtomicReference<Set<String>> svcLoaderCacheKeys;\n     private static PrivateKeyStore PRIVATE_KEY_STORE = loadServicePrivateKey();\n+    private static ZTSFileUtil ztsFileUtil;", "originalCommit": "f752126dc7dcbe37f728dd8bb39276727269d071", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4a483e2be4baf10c7e0af37c4b77b70ccd3e9989", "chunk": "diff --git a/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSClient.java b/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSClient.java\nindex 6b172737f..f72c3985e 100644\n--- a/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSClient.java\n+++ b/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSClient.java\n\n@@ -174,7 +174,7 @@ public class ZTSClient implements Closeable {\n     private static ServiceLoader<ZTSClientService> ztsTokenProviders;\n     private static AtomicReference<Set<String>> svcLoaderCacheKeys;\n     private static PrivateKeyStore PRIVATE_KEY_STORE = loadServicePrivateKey();\n-    private static ZTSFileUtil ztsFileUtil;\n+    private static ZTSAccessTokenFileLoader ztsAccessTokenFileLoader;\n \n     enum TokenType {\n         ROLE,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM3ODk0MA==", "url": "https://github.com/AthenZ/athenz/pull/1028#discussion_r453378940", "bodyText": "all of our property names start with athenz.", "author": "havetisyan", "createdAt": "2020-07-12T23:52:22Z", "path": "clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSFileUtil.java", "diffHunk": "@@ -0,0 +1,105 @@\n+package com.yahoo.athenz.zts;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.yahoo.athenz.auth.token.AccessToken;\n+import com.yahoo.athenz.auth.token.jwts.JwtsSigningKeyResolver;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.*;\n+\n+public class ZTSFileUtil {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(ZTSFileUtil.class);\n+\n+    static private final String DEFAULT_ACCESS_TOKEN_DIR_PATH = \"/var/lib/sia/tokens/\";\n+    static private final String ACCESS_TOKEN_PATH_PROPERTY = \"zts.client.accesstoken.path\";", "originalCommit": "f752126dc7dcbe37f728dd8bb39276727269d071", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4a483e2be4baf10c7e0af37c4b77b70ccd3e9989", "chunk": "diff --git a/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSFileUtil.java b/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\nsimilarity index 57%\nrename from clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSFileUtil.java\nrename to clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\nindex d01606b75..88a18c48b 100644\n--- a/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSFileUtil.java\n+++ b/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\n\n@@ -10,27 +10,32 @@ import java.io.File;\n import java.io.IOException;\n import java.util.*;\n \n-public class ZTSFileUtil {\n+public class ZTSAccessTokenFileLoader {\n \n-    private static final Logger LOG = LoggerFactory.getLogger(ZTSFileUtil.class);\n+    private static final Logger LOG = LoggerFactory.getLogger(ZTSAccessTokenFileLoader.class);\n \n+    static public final String ACCESS_TOKEN_PATH_PROPERTY = \"athenz.zts.client.accesstoken.path\";\n     static private final String DEFAULT_ACCESS_TOKEN_DIR_PATH = \"/var/lib/sia/tokens/\";\n-    static private final String ACCESS_TOKEN_PATH_PROPERTY = \"zts.client.accesstoken.path\";\n     static private final String ROLE_NAME_CONNECTOR = \",\";\n-    private JwtsSigningKeyResolver accessSignKeyResolver = null;\n+    static private final String DOMAIN_ROLE_CONNECTOR = \":role:\";\n+    final private String path;\n+    private JwtsSigningKeyResolver accessSignKeyResolver;\n     private ObjectMapper objectMapper = new ObjectMapper();\n     private Map<String, String> roleNameMap;\n \n-    public ZTSFileUtil(JwtsSigningKeyResolver resolver) {\n+    public ZTSAccessTokenFileLoader(JwtsSigningKeyResolver resolver) {\n         roleNameMap = new HashMap<>();\n         accessSignKeyResolver = resolver;\n+        path = System.getProperty(ACCESS_TOKEN_PATH_PROPERTY, DEFAULT_ACCESS_TOKEN_DIR_PATH);\n     }\n \n     public void preload() {\n-        String path = System.getProperty(ACCESS_TOKEN_PATH_PROPERTY, DEFAULT_ACCESS_TOKEN_DIR_PATH);\n         File dir = new File(path);\n \n-        // preload the map from the domain, rolesname to file path\n+        // preload the map from the <domain, rolesname> -> <file path>\n+        // expected dir should be <base token path>/<domain dir>/<token file>s\n+        // after preload the map, when we look up the access token,\n+        // the map will directly read the required file\n         if (dir.exists() && dir.isDirectory()) {\n             for (File domainDir: dir.listFiles()) {\n                 if (domainDir.isDirectory()) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE1NzkyNw==", "url": "https://github.com/AthenZ/athenz/pull/1028#discussion_r456157927", "bodyText": "Instead of defining our path separator we should use File.pathSeparator", "author": "havetisyan", "createdAt": "2020-07-17T00:52:33Z", "path": "clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java", "diffHunk": "@@ -0,0 +1,105 @@\n+package com.yahoo.athenz.zts;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.yahoo.athenz.auth.token.AccessToken;\n+import com.yahoo.athenz.auth.token.jwts.JwtsSigningKeyResolver;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.*;\n+\n+public class ZTSAccessTokenFileLoader {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(ZTSAccessTokenFileLoader.class);\n+\n+    static public final String ACCESS_TOKEN_PATH_PROPERTY = \"athenz.zts.client.accesstoken.path\";\n+    static private final String DEFAULT_ACCESS_TOKEN_DIR_PATH = \"/var/lib/sia/tokens/\";\n+    static private final String ROLE_NAME_CONNECTOR = \",\";\n+    static private final String PATH_SEPARATOR = \"/\";", "originalCommit": "b84de099b370c9cfa6728a68d0f633d553680efa", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4a483e2be4baf10c7e0af37c4b77b70ccd3e9989", "chunk": "diff --git a/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java b/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\nindex 68c706351..88a18c48b 100644\n--- a/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\n+++ b/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\n\n@@ -17,7 +17,8 @@ public class ZTSAccessTokenFileLoader {\n     static public final String ACCESS_TOKEN_PATH_PROPERTY = \"athenz.zts.client.accesstoken.path\";\n     static private final String DEFAULT_ACCESS_TOKEN_DIR_PATH = \"/var/lib/sia/tokens/\";\n     static private final String ROLE_NAME_CONNECTOR = \",\";\n-    static private final String PATH_SEPARATOR = \"/\";\n+    static private final String DOMAIN_ROLE_CONNECTOR = \":role:\";\n+    final private String path;\n     private JwtsSigningKeyResolver accessSignKeyResolver;\n     private ObjectMapper objectMapper = new ObjectMapper();\n     private Map<String, String> roleNameMap;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE1ODMwNQ==", "url": "https://github.com/AthenZ/athenz/pull/1028#discussion_r456158305", "bodyText": "we should have both rolesStr and fileName as final", "author": "havetisyan", "createdAt": "2020-07-17T00:54:07Z", "path": "clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java", "diffHunk": "@@ -0,0 +1,105 @@\n+package com.yahoo.athenz.zts;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.yahoo.athenz.auth.token.AccessToken;\n+import com.yahoo.athenz.auth.token.jwts.JwtsSigningKeyResolver;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.*;\n+\n+public class ZTSAccessTokenFileLoader {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(ZTSAccessTokenFileLoader.class);\n+\n+    static public final String ACCESS_TOKEN_PATH_PROPERTY = \"athenz.zts.client.accesstoken.path\";\n+    static private final String DEFAULT_ACCESS_TOKEN_DIR_PATH = \"/var/lib/sia/tokens/\";\n+    static private final String ROLE_NAME_CONNECTOR = \",\";\n+    static private final String PATH_SEPARATOR = \"/\";\n+    private JwtsSigningKeyResolver accessSignKeyResolver;\n+    private ObjectMapper objectMapper = new ObjectMapper();\n+    private Map<String, String> roleNameMap;\n+\n+    public ZTSAccessTokenFileLoader(JwtsSigningKeyResolver resolver) {\n+        roleNameMap = new HashMap<>();\n+        accessSignKeyResolver = resolver;\n+    }\n+\n+    public void preload() {\n+        final String path = System.getProperty(ACCESS_TOKEN_PATH_PROPERTY, DEFAULT_ACCESS_TOKEN_DIR_PATH);\n+        File dir = new File(path);\n+\n+        // preload the map from the <domain, rolesname> -> <file path>\n+        // expected dir should be <base token path>/<domain dir>/<token file>s\n+        // after preload the map, when we look up the access token,\n+        // the map will directly read the required file\n+        if (dir.exists() && dir.isDirectory()) {\n+            for (File domainDir: dir.listFiles()) {\n+                if (domainDir.isDirectory()) {\n+                    for (File tokenFile: domainDir.listFiles()) {\n+                        if (!tokenFile.isDirectory()) {\n+                            AccessTokenResponse accessTokenResponse = null;\n+                            try {\n+                                accessTokenResponse = objectMapper.readValue(tokenFile, AccessTokenResponse.class);\n+                            } catch (IOException e) {\n+                                LOG.error(\"Failed to load or parse token file: {}\", tokenFile);\n+                            }\n+\n+                            // if access token parsed fail, continue to scan tokens\n+                            if (accessTokenResponse == null) {\n+                                continue;\n+                            }\n+\n+                            AccessTokenResponseCacheEntry cacheEntry = new AccessTokenResponseCacheEntry(accessTokenResponse);\n+\n+                            // check access token is still valid\n+                            if (!cacheEntry.isExpired(-1)) {\n+                                addToRoleMap(domainDir.getName(), tokenFile.getName(), accessTokenResponse);\n+                            }\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+\n+    }\n+\n+    // function load the access token from file\n+    public AccessTokenResponse lookupAccessTokenFromDisk(String domain, List<String> rolesName) throws IOException {\n+        LOG.debug(\"Trying to fetch access token from disk for domain: {}, roleNames: {}\", domain, rolesName);\n+        final String path = System.getProperty(ACCESS_TOKEN_PATH_PROPERTY, DEFAULT_ACCESS_TOKEN_DIR_PATH);\n+        String rolesStr = getRolesStr(domain, rolesName);\n+        String fileName = roleNameMap.get(rolesStr);", "originalCommit": "b84de099b370c9cfa6728a68d0f633d553680efa", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4a483e2be4baf10c7e0af37c4b77b70ccd3e9989", "chunk": "diff --git a/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java b/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\nindex 68c706351..88a18c48b 100644\n--- a/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\n+++ b/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\n\n@@ -17,7 +17,8 @@ public class ZTSAccessTokenFileLoader {\n     static public final String ACCESS_TOKEN_PATH_PROPERTY = \"athenz.zts.client.accesstoken.path\";\n     static private final String DEFAULT_ACCESS_TOKEN_DIR_PATH = \"/var/lib/sia/tokens/\";\n     static private final String ROLE_NAME_CONNECTOR = \",\";\n-    static private final String PATH_SEPARATOR = \"/\";\n+    static private final String DOMAIN_ROLE_CONNECTOR = \":role:\";\n+    final private String path;\n     private JwtsSigningKeyResolver accessSignKeyResolver;\n     private ObjectMapper objectMapper = new ObjectMapper();\n     private Map<String, String> roleNameMap;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE1OTMyNA==", "url": "https://github.com/AthenZ/athenz/pull/1028#discussion_r456159324", "bodyText": "The list given to us might be immutable so we can't just call sort on it. Make a copy of the list and then sort that list.", "author": "havetisyan", "createdAt": "2020-07-17T00:57:45Z", "path": "clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java", "diffHunk": "@@ -0,0 +1,105 @@\n+package com.yahoo.athenz.zts;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.yahoo.athenz.auth.token.AccessToken;\n+import com.yahoo.athenz.auth.token.jwts.JwtsSigningKeyResolver;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.*;\n+\n+public class ZTSAccessTokenFileLoader {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(ZTSAccessTokenFileLoader.class);\n+\n+    static public final String ACCESS_TOKEN_PATH_PROPERTY = \"athenz.zts.client.accesstoken.path\";\n+    static private final String DEFAULT_ACCESS_TOKEN_DIR_PATH = \"/var/lib/sia/tokens/\";\n+    static private final String ROLE_NAME_CONNECTOR = \",\";\n+    static private final String PATH_SEPARATOR = \"/\";\n+    private JwtsSigningKeyResolver accessSignKeyResolver;\n+    private ObjectMapper objectMapper = new ObjectMapper();\n+    private Map<String, String> roleNameMap;\n+\n+    public ZTSAccessTokenFileLoader(JwtsSigningKeyResolver resolver) {\n+        roleNameMap = new HashMap<>();\n+        accessSignKeyResolver = resolver;\n+    }\n+\n+    public void preload() {\n+        final String path = System.getProperty(ACCESS_TOKEN_PATH_PROPERTY, DEFAULT_ACCESS_TOKEN_DIR_PATH);\n+        File dir = new File(path);\n+\n+        // preload the map from the <domain, rolesname> -> <file path>\n+        // expected dir should be <base token path>/<domain dir>/<token file>s\n+        // after preload the map, when we look up the access token,\n+        // the map will directly read the required file\n+        if (dir.exists() && dir.isDirectory()) {\n+            for (File domainDir: dir.listFiles()) {\n+                if (domainDir.isDirectory()) {\n+                    for (File tokenFile: domainDir.listFiles()) {\n+                        if (!tokenFile.isDirectory()) {\n+                            AccessTokenResponse accessTokenResponse = null;\n+                            try {\n+                                accessTokenResponse = objectMapper.readValue(tokenFile, AccessTokenResponse.class);\n+                            } catch (IOException e) {\n+                                LOG.error(\"Failed to load or parse token file: {}\", tokenFile);\n+                            }\n+\n+                            // if access token parsed fail, continue to scan tokens\n+                            if (accessTokenResponse == null) {\n+                                continue;\n+                            }\n+\n+                            AccessTokenResponseCacheEntry cacheEntry = new AccessTokenResponseCacheEntry(accessTokenResponse);\n+\n+                            // check access token is still valid\n+                            if (!cacheEntry.isExpired(-1)) {\n+                                addToRoleMap(domainDir.getName(), tokenFile.getName(), accessTokenResponse);\n+                            }\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+\n+    }\n+\n+    // function load the access token from file\n+    public AccessTokenResponse lookupAccessTokenFromDisk(String domain, List<String> rolesName) throws IOException {\n+        LOG.debug(\"Trying to fetch access token from disk for domain: {}, roleNames: {}\", domain, rolesName);\n+        final String path = System.getProperty(ACCESS_TOKEN_PATH_PROPERTY, DEFAULT_ACCESS_TOKEN_DIR_PATH);\n+        String rolesStr = getRolesStr(domain, rolesName);\n+        String fileName = roleNameMap.get(rolesStr);\n+        if (fileName == null) {\n+            return null;\n+        }\n+        File tokenFile = new File(path + PATH_SEPARATOR + domain + PATH_SEPARATOR + fileName);\n+\n+        return objectMapper.readValue(tokenFile, AccessTokenResponse.class);\n+    }\n+\n+    static private String getRolesStr(String domain, List<String> roleNames) {\n+        if (roleNames == null || roleNames.isEmpty()) {\n+            //if no role name specific, should return all roles\n+            return \"*\";\n+        }\n+        Collections.sort(roleNames);", "originalCommit": "b84de099b370c9cfa6728a68d0f633d553680efa", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4a483e2be4baf10c7e0af37c4b77b70ccd3e9989", "chunk": "diff --git a/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java b/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\nindex 68c706351..88a18c48b 100644\n--- a/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\n+++ b/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\n\n@@ -17,7 +17,8 @@ public class ZTSAccessTokenFileLoader {\n     static public final String ACCESS_TOKEN_PATH_PROPERTY = \"athenz.zts.client.accesstoken.path\";\n     static private final String DEFAULT_ACCESS_TOKEN_DIR_PATH = \"/var/lib/sia/tokens/\";\n     static private final String ROLE_NAME_CONNECTOR = \",\";\n-    static private final String PATH_SEPARATOR = \"/\";\n+    static private final String DOMAIN_ROLE_CONNECTOR = \":role:\";\n+    final private String path;\n     private JwtsSigningKeyResolver accessSignKeyResolver;\n     private ObjectMapper objectMapper = new ObjectMapper();\n     private Map<String, String> roleNameMap;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE1OTQ5OA==", "url": "https://github.com/AthenZ/athenz/pull/1028#discussion_r456159498", "bodyText": "we should probably just get this property in the constructor and not get it every time in this method", "author": "havetisyan", "createdAt": "2020-07-17T00:58:26Z", "path": "clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java", "diffHunk": "@@ -0,0 +1,105 @@\n+package com.yahoo.athenz.zts;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.yahoo.athenz.auth.token.AccessToken;\n+import com.yahoo.athenz.auth.token.jwts.JwtsSigningKeyResolver;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.*;\n+\n+public class ZTSAccessTokenFileLoader {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(ZTSAccessTokenFileLoader.class);\n+\n+    static public final String ACCESS_TOKEN_PATH_PROPERTY = \"athenz.zts.client.accesstoken.path\";\n+    static private final String DEFAULT_ACCESS_TOKEN_DIR_PATH = \"/var/lib/sia/tokens/\";\n+    static private final String ROLE_NAME_CONNECTOR = \",\";\n+    static private final String PATH_SEPARATOR = \"/\";\n+    private JwtsSigningKeyResolver accessSignKeyResolver;\n+    private ObjectMapper objectMapper = new ObjectMapper();\n+    private Map<String, String> roleNameMap;\n+\n+    public ZTSAccessTokenFileLoader(JwtsSigningKeyResolver resolver) {\n+        roleNameMap = new HashMap<>();\n+        accessSignKeyResolver = resolver;\n+    }\n+\n+    public void preload() {\n+        final String path = System.getProperty(ACCESS_TOKEN_PATH_PROPERTY, DEFAULT_ACCESS_TOKEN_DIR_PATH);\n+        File dir = new File(path);\n+\n+        // preload the map from the <domain, rolesname> -> <file path>\n+        // expected dir should be <base token path>/<domain dir>/<token file>s\n+        // after preload the map, when we look up the access token,\n+        // the map will directly read the required file\n+        if (dir.exists() && dir.isDirectory()) {\n+            for (File domainDir: dir.listFiles()) {\n+                if (domainDir.isDirectory()) {\n+                    for (File tokenFile: domainDir.listFiles()) {\n+                        if (!tokenFile.isDirectory()) {\n+                            AccessTokenResponse accessTokenResponse = null;\n+                            try {\n+                                accessTokenResponse = objectMapper.readValue(tokenFile, AccessTokenResponse.class);\n+                            } catch (IOException e) {\n+                                LOG.error(\"Failed to load or parse token file: {}\", tokenFile);\n+                            }\n+\n+                            // if access token parsed fail, continue to scan tokens\n+                            if (accessTokenResponse == null) {\n+                                continue;\n+                            }\n+\n+                            AccessTokenResponseCacheEntry cacheEntry = new AccessTokenResponseCacheEntry(accessTokenResponse);\n+\n+                            // check access token is still valid\n+                            if (!cacheEntry.isExpired(-1)) {\n+                                addToRoleMap(domainDir.getName(), tokenFile.getName(), accessTokenResponse);\n+                            }\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+\n+    }\n+\n+    // function load the access token from file\n+    public AccessTokenResponse lookupAccessTokenFromDisk(String domain, List<String> rolesName) throws IOException {\n+        LOG.debug(\"Trying to fetch access token from disk for domain: {}, roleNames: {}\", domain, rolesName);\n+        final String path = System.getProperty(ACCESS_TOKEN_PATH_PROPERTY, DEFAULT_ACCESS_TOKEN_DIR_PATH);", "originalCommit": "b84de099b370c9cfa6728a68d0f633d553680efa", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4a483e2be4baf10c7e0af37c4b77b70ccd3e9989", "chunk": "diff --git a/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java b/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\nindex 68c706351..88a18c48b 100644\n--- a/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\n+++ b/clients/java/zts/core/src/main/java/com/yahoo/athenz/zts/ZTSAccessTokenFileLoader.java\n\n@@ -17,7 +17,8 @@ public class ZTSAccessTokenFileLoader {\n     static public final String ACCESS_TOKEN_PATH_PROPERTY = \"athenz.zts.client.accesstoken.path\";\n     static private final String DEFAULT_ACCESS_TOKEN_DIR_PATH = \"/var/lib/sia/tokens/\";\n     static private final String ROLE_NAME_CONNECTOR = \",\";\n-    static private final String PATH_SEPARATOR = \"/\";\n+    static private final String DOMAIN_ROLE_CONNECTOR = \":role:\";\n+    final private String path;\n     private JwtsSigningKeyResolver accessSignKeyResolver;\n     private ObjectMapper objectMapper = new ObjectMapper();\n     private Map<String, String> roleNameMap;\n"}}, {"oid": "4a483e2be4baf10c7e0af37c4b77b70ccd3e9989", "url": "https://github.com/AthenZ/athenz/commit/4a483e2be4baf10c7e0af37c4b77b70ccd3e9989", "message": "ZTS Client to read access tokens from file system", "committedDate": "2020-07-17T12:43:45Z", "type": "commit"}]}