{"pr_number": 1105, "pr_title": "support adding groups as role members", "pr_createdAt": "2020-09-04T17:18:24Z", "pr_url": "https://github.com/AthenZ/athenz/pull/1105", "timeline": [{"oid": "2cf7e42addedf3940956b5873f87394a61a38f33", "url": "https://github.com/AthenZ/athenz/commit/2cf7e42addedf3940956b5873f87394a61a38f33", "message": "support adding groups as role members", "committedDate": "2020-09-04T17:14:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgwNDcxMw==", "url": "https://github.com/AthenZ/athenz/pull/1105#discussion_r483804713", "bodyText": "This method is always going to return true, so does it make sense to just remove it?", "author": "abvaidya", "createdAt": "2020-09-04T19:16:13Z", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java", "diffHunk": "@@ -3566,7 +3617,7 @@ String enforcedUserAuthorityFilter(final String roleUserAuthorityFilter, final S\n     }\n \n     boolean shouldValidateRoleMembers(final String userAuthorityFilter) {\n-        return validateUserRoleMembers || validateServiceRoleMembers || userAuthorityFilter != null;\n+        return validateGroupRoleMembers || validateUserRoleMembers || validateServiceRoleMembers || userAuthorityFilter != null;", "originalCommit": "2cf7e42addedf3940956b5873f87394a61a38f33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgwNzEyNw==", "url": "https://github.com/AthenZ/athenz/pull/1105#discussion_r483807127", "bodyText": "I see all references are removed?", "author": "abvaidya", "createdAt": "2020-09-04T19:22:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgwNDcxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgwOTk3Mg==", "url": "https://github.com/AthenZ/athenz/pull/1105#discussion_r483809972", "bodyText": "eventually yes, it will be removed. I've removed in a couple of place already. once other functionality is added, it will slowly be removed", "author": "havetisyan", "createdAt": "2020-09-04T19:29:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgwNDcxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgxNTA5OQ==", "url": "https://github.com/AthenZ/athenz/pull/1105#discussion_r483815099", "bodyText": "ok, looks like it got cleaned up in all place, so I'll remove it in this PR as well.", "author": "havetisyan", "createdAt": "2020-09-04T19:43:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgwNDcxMw=="}], "type": "inlineReview", "revised_code": {"commit": "7923fd9b518f1e915bc08e5e821eb1eef16ee359", "chunk": "diff --git a/servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java b/servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java\nindex 68db4ed3f..af3788edf 100644\n--- a/servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java\n+++ b/servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java\n\n@@ -3616,10 +3615,6 @@ public class ZMSImpl implements Authorizer, KeyStore, ZMSHandler {\n         return ZMSUtils.combineUserAuthorityFilters(roleUserAuthorityFilter, domainUserAuthorityFilter);\n     }\n \n-    boolean shouldValidateRoleMembers(final String userAuthorityFilter) {\n-        return validateGroupRoleMembers || validateUserRoleMembers || validateServiceRoleMembers || userAuthorityFilter != null;\n-    }\n-\n     String getUserAuthorityExpiryAttr(final String userAuthorityExpiry) {\n \n         // we must have a valid user authority\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgwNjQ2Mw==", "url": "https://github.com/AthenZ/athenz/pull/1105#discussion_r483806463", "bodyText": "instead of looping over again, can we set the principal type which adding them to \"normalizedGroupMembers\" above?", "author": "abvaidya", "createdAt": "2020-09-04T19:20:27Z", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java", "diffHunk": "@@ -8043,6 +8095,13 @@ void normalizeGroupMembers(Group group) {\n                 addNormalizedGroupMember(normalizedMembers, member);\n             }\n         }\n+\n+        // go through each member and set the principal type\n+\n+        for (GroupMember member : normalizedMembers.values()) {", "originalCommit": "2cf7e42addedf3940956b5873f87394a61a38f33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgxMTg1Mw==", "url": "https://github.com/AthenZ/athenz/pull/1105#discussion_r483811853", "bodyText": "sure, we'll just need to add some logic to skip duplicates and don't waste lookup operations.", "author": "havetisyan", "createdAt": "2020-09-04T19:34:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgwNjQ2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "7923fd9b518f1e915bc08e5e821eb1eef16ee359", "chunk": "diff --git a/servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java b/servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java\nindex 68db4ed3f..af3788edf 100644\n--- a/servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java\n+++ b/servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java\n\n@@ -8092,14 +8089,14 @@ public class ZMSImpl implements Authorizer, KeyStore, ZMSHandler {\n         List<GroupMember> groupMembers = group.getGroupMembers();\n         if (groupMembers != null) {\n             for (GroupMember member : groupMembers) {\n-                addNormalizedGroupMember(normalizedMembers, member);\n-            }\n-        }\n \n-        // go through each member and set the principal type\n+                // if our member was added to the normalized map then we\n+                // also need to set the principal type\n \n-        for (GroupMember member : normalizedMembers.values()) {\n-            member.setPrincipalType(principalType(member.getMemberName()));\n+                if (addNormalizedGroupMember(normalizedMembers, member)) {\n+                    member.setPrincipalType(principalType(member.getMemberName()));\n+                }\n+            }\n         }\n \n         group.setGroupMembers(new ArrayList<>(normalizedMembers.values()));\n"}}, {"oid": "7923fd9b518f1e915bc08e5e821eb1eef16ee359", "url": "https://github.com/AthenZ/athenz/commit/7923fd9b518f1e915bc08e5e821eb1eef16ee359", "message": "address review comments", "committedDate": "2020-09-04T19:53:13Z", "type": "commit"}]}