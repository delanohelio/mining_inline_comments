{"pr_number": 1124, "pr_title": "Part 1 - Metric notifications", "pr_createdAt": "2020-10-01T21:01:47Z", "pr_url": "https://github.com/AthenZ/athenz/pull/1124", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUxODc1OQ==", "url": "https://github.com/AthenZ/athenz/pull/1124#discussion_r498518759", "bodyText": "Will implement this in server_common in next PR", "author": "OferLevi85", "createdAt": "2020-10-01T21:19:13Z", "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/metrics/Metric.java", "diffHunk": "@@ -86,6 +88,15 @@ default void increment(String metric, String requestDomainName, String principal\n         increment(metric, requestDomainName);\n     }\n \n+    /**\n+     * Increment the counter for the specified metric with the specified attributes\n+     * @param metric Name of the counter\n+     * @param attributes Attributes for the metric (tags)\n+     */\n+    default void increment(String metric, Map<String, String> attributes) {", "originalCommit": "3a943d0a4921d7434ef00f27e0b35b5fc2d1ca8c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d32d42e8c8c447f2f0d7d5d9d16f60a53fb6662d", "chunk": "diff --git a/libs/java/server_common/src/main/java/com/yahoo/athenz/common/metrics/Metric.java b/libs/java/server_common/src/main/java/com/yahoo/athenz/common/metrics/Metric.java\nindex ad2f68b74..be104df10 100644\n--- a/libs/java/server_common/src/main/java/com/yahoo/athenz/common/metrics/Metric.java\n+++ b/libs/java/server_common/src/main/java/com/yahoo/athenz/common/metrics/Metric.java\n\n@@ -91,9 +89,9 @@ public interface Metric {\n     /**\n      * Increment the counter for the specified metric with the specified attributes\n      * @param metric Name of the counter\n-     * @param attributes Attributes for the metric (tags)\n+     * @param attributes a sorted array of tag key-value pairs in a flattened array\n      */\n-    default void increment(String metric, Map<String, String> attributes) {\n+    default void increment(String metric, final String... attributes) {\n         // No op\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUxOTUzNQ==", "url": "https://github.com/AthenZ/athenz/pull/1124#discussion_r498519535", "bodyText": "Notification Manager can now send notifications to multiple Notification Services.\nUsers will need to specify the NotificationServiceFactory classes in a comma-separated property.", "author": "OferLevi85", "createdAt": "2020-10-01T21:21:21Z", "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/NotificationManager.java", "diffHunk": "@@ -30,22 +31,28 @@\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(NotificationManager.class);\n \n-    private NotificationService notificationService;\n+    private List<NotificationService> notificationServices = new ArrayList<>();\n     private ScheduledExecutorService scheduledExecutor;\n     private List<NotificationTask> notificationTasks;\n \n     public NotificationManager(List<NotificationTask> notificationTasks) {\n         this.notificationTasks = notificationTasks;\n-        String notificationServiceFactoryClass = System.getProperty(NOTIFICATION_PROP_SERVICE_FACTORY_CLASS);\n-        if (notificationServiceFactoryClass != null) {\n-            NotificationServiceFactory notificationServiceFactory;\n-            try {", "originalCommit": "3a943d0a4921d7434ef00f27e0b35b5fc2d1ca8c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d32d42e8c8c447f2f0d7d5d9d16f60a53fb6662d", "chunk": "diff --git a/libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/NotificationManager.java b/libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/NotificationManager.java\nindex fe19ef68a..b295e2674 100644\n--- a/libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/NotificationManager.java\n+++ b/libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/NotificationManager.java\n\n@@ -38,7 +38,7 @@ public class NotificationManager {\n     public NotificationManager(List<NotificationTask> notificationTasks) {\n         this.notificationTasks = notificationTasks;\n         String notificationServiceFactoryClasses = System.getProperty(NOTIFICATION_PROP_SERVICE_FACTORY_CLASS);\n-        if (!StringUtils.isNullOrEmpty(notificationServiceFactoryClasses)) {\n+        if (!StringUtil.isEmpty(notificationServiceFactoryClasses)) {\n             String[] notificationServiceFactoryClassArray = notificationServiceFactoryClasses.split(\",\");\n             for (String notificationServiceFactoryClass : notificationServiceFactoryClassArray) {\n                 NotificationServiceFactory notificationServiceFactory;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUyMzMzOQ==", "url": "https://github.com/AthenZ/athenz/pull/1124#discussion_r498523339", "bodyText": "Load a metric object and pass it to MetricNotificationService.\nThe metric can be a different implementation than the one used by ZTS / ZMS.", "author": "OferLevi85", "createdAt": "2020-10-01T21:31:12Z", "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/impl/MetricNotificationServiceFactory.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ *  Copyright 2020 Verizon Media\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+\n+package com.yahoo.athenz.common.server.notification.impl;\n+\n+import com.yahoo.athenz.common.metrics.Metric;\n+import com.yahoo.athenz.common.metrics.MetricFactory;\n+import com.yahoo.athenz.common.server.notification.NotificationService;\n+import com.yahoo.athenz.common.server.notification.NotificationServiceFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static com.yahoo.athenz.common.ServerCommonConsts.METRIC_DEFAULT_FACTORY_CLASS;\n+\n+public class MetricNotificationServiceFactory implements NotificationServiceFactory {\n+\n+    public static final String NOTIFICATION_PROP_METRIC_FACTORY_CLASS = \"athenz.notification.metric_factory_class\";\n+\n+    private final static Logger LOG = LoggerFactory.getLogger(MetricNotificationServiceFactory.class);\n+\n+    @Override\n+    public NotificationService create() {\n+        return new MetricNotificationService(loadMetricObject());\n+    }\n+\n+    Metric loadMetricObject() {\n+\n+        String metricFactoryClass = System.getProperty(NOTIFICATION_PROP_METRIC_FACTORY_CLASS,", "originalCommit": "3a943d0a4921d7434ef00f27e0b35b5fc2d1ca8c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUzMzcwOQ==", "url": "https://github.com/AthenZ/athenz/pull/1124#discussion_r498533709", "bodyText": "why are we using this from the mysql library? I believe jetty already has one called identically so maybe we should be using that instead?", "author": "havetisyan", "createdAt": "2020-10-01T21:58:29Z", "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/NotificationManager.java", "diffHunk": "@@ -16,6 +16,7 @@\n \n package com.yahoo.athenz.common.server.notification;\n \n+import com.mysql.cj.util.StringUtils;", "originalCommit": "3a943d0a4921d7434ef00f27e0b35b5fc2d1ca8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODYyMzk2Mg==", "url": "https://github.com/AthenZ/athenz/pull/1124#discussion_r498623962", "bodyText": "Yeah, I didn't notice it during auto-import, fixing it", "author": "OferLevi85", "createdAt": "2020-10-02T05:31:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUzMzcwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "d32d42e8c8c447f2f0d7d5d9d16f60a53fb6662d", "chunk": "diff --git a/libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/NotificationManager.java b/libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/NotificationManager.java\nindex fe19ef68a..b295e2674 100644\n--- a/libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/NotificationManager.java\n+++ b/libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/NotificationManager.java\n\n@@ -16,7 +16,7 @@\n \n package com.yahoo.athenz.common.server.notification;\n \n-import com.mysql.cj.util.StringUtils;\n+import org.eclipse.jetty.util.StringUtil;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n"}}, {"oid": "4a09049d1a73383d06854acf37dc9c8a7d514d6a", "url": "https://github.com/AthenZ/athenz/commit/4a09049d1a73383d06854acf37dc9c8a7d514d6a", "message": "Part 1 - Metric notifications\n1. Added metric interface for a dynamic number of attributes / tags\n2. Enabled NotificationManager to send notifications through more than one\nNotificationService", "committedDate": "2020-10-02T15:02:28Z", "type": "commit"}, {"oid": "d32d42e8c8c447f2f0d7d5d9d16f60a53fb6662d", "url": "https://github.com/AthenZ/athenz/commit/d32d42e8c8c447f2f0d7d5d9d16f60a53fb6662d", "message": "Added notification types to Notifications\nThey will be used as an attribute when recording metrics", "committedDate": "2020-10-02T15:02:40Z", "type": "commit"}, {"oid": "d32d42e8c8c447f2f0d7d5d9d16f60a53fb6662d", "url": "https://github.com/AthenZ/athenz/commit/d32d42e8c8c447f2f0d7d5d9d16f60a53fb6662d", "message": "Added notification types to Notifications\nThey will be used as an attribute when recording metrics", "committedDate": "2020-10-02T15:02:40Z", "type": "forcePushed"}]}