{"pr_number": 926, "pr_title": "Fixed a bug where big emails caused http client to crash", "pr_createdAt": "2020-03-30T22:50:01Z", "pr_url": "https://github.com/AthenZ/athenz/pull/926", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU1MTMwNA==", "url": "https://github.com/AthenZ/athenz/pull/926#discussion_r400551304", "bodyText": "where are we using this object - I only see two references in log debug and error points. In which case why are we doing this here at all? We can do a private method to return the query and then have something like:\nif (LOGGER.isDebugEnabled()) {\nLOGGER.debug(...., getPostQuery(httpPost);\n}\nand then further down:\n} catch (IOException ex) {\nLOGGER.error(......, getPostQuery(httpPost), ...);\n}", "author": "havetisyan", "createdAt": "2020-03-30T23:18:34Z", "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/http/HttpDriver.java", "diffHunk": "@@ -258,7 +259,9 @@ public String doGet(final String url) throws IOException {\n      */\n     public String doPost(HttpPost httpPost) throws IOException {\n         String url = httpPost.getURI().toString();\n-        String query = EntityUtils.toString(httpPost.getEntity());\n+        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();\n+        httpPost.getEntity().writeTo(byteArrayOutputStream);\n+        String query = byteArrayOutputStream.toString();", "originalCommit": "8600dc607f33c9dbf0ed6c05f5dcd0b609dbb615", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYwMjA4Mw==", "url": "https://github.com/AthenZ/athenz/pull/926#discussion_r400602083", "bodyText": "Thanks you're right I should have thought about it. It will also enable me to cleanly surround it with try-catch so if it will fail in the future it won't stop the client from sending the message.", "author": "OferLevi85", "createdAt": "2020-03-31T02:14:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU1MTMwNA=="}], "type": "inlineReview", "revised_code": {"commit": "d3b1607151a0afb974e78bbf5dad34fb3f872469", "chunk": "diff --git a/libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/http/HttpDriver.java b/libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/http/HttpDriver.java\nindex 5b7d321a7..1af976c8e 100644\n--- a/libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/http/HttpDriver.java\n+++ b/libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/http/HttpDriver.java\n\n@@ -259,10 +259,7 @@ public class HttpDriver implements Closeable {\n      */\n     public String doPost(HttpPost httpPost) throws IOException {\n         String url = httpPost.getURI().toString();\n-        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();\n-        httpPost.getEntity().writeTo(byteArrayOutputStream);\n-        String query = byteArrayOutputStream.toString();\n-        LOGGER.debug(\"Requesting from {} with query {}\", url, query);\n+        LOGGER.debug(\"Requesting from {} with query {}\", url, getPostQuery(httpPost));\n \n         // Retry when IOException occurs\n         for (int i = 0; i <  clientMaxRetries;  i++) {\n"}}, {"oid": "d3b1607151a0afb974e78bbf5dad34fb3f872469", "url": "https://github.com/AthenZ/athenz/commit/d3b1607151a0afb974e78bbf5dad34fb3f872469", "message": "Fixed a bug where big emails caused http client to crash\nhttpPost.getEntity is limited to 25k and will throw an exception if it is bigger.", "committedDate": "2020-03-31T02:18:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYwNDE1OA==", "url": "https://github.com/AthenZ/athenz/pull/926#discussion_r400604158", "bodyText": "we should put this in If (LOGGER.isDebugEnabled()) block otherwise we'll do all the work for the getPostQuery, then pass the argument to the function which will just throw it away since in production we don't have debug enabled (so the getPostQuery call is just wasted).", "author": "havetisyan", "createdAt": "2020-03-31T02:22:33Z", "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/http/HttpDriver.java", "diffHunk": "@@ -258,8 +259,7 @@ public String doGet(final String url) throws IOException {\n      */\n     public String doPost(HttpPost httpPost) throws IOException {\n         String url = httpPost.getURI().toString();\n-        String query = EntityUtils.toString(httpPost.getEntity());\n-        LOGGER.debug(\"Requesting from {} with query {}\", url, query);\n+        LOGGER.debug(\"Requesting from {} with query {}\", url, getPostQuery(httpPost));", "originalCommit": "d3b1607151a0afb974e78bbf5dad34fb3f872469", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4bece7e78774ec2dee5c01e5b1061473c062b19e", "chunk": "diff --git a/libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/http/HttpDriver.java b/libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/http/HttpDriver.java\nindex 1af976c8e..52ea416c3 100644\n--- a/libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/http/HttpDriver.java\n+++ b/libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/http/HttpDriver.java\n\n@@ -259,8 +259,9 @@ public class HttpDriver implements Closeable {\n      */\n     public String doPost(HttpPost httpPost) throws IOException {\n         String url = httpPost.getURI().toString();\n-        LOGGER.debug(\"Requesting from {} with query {}\", url, getPostQuery(httpPost));\n-\n+        if (LOGGER.isDebugEnabled()) {\n+            LOGGER.debug(\"Requesting from {} with query {}\", url, getPostQuery(httpPost));\n+        }\n         // Retry when IOException occurs\n         for (int i = 0; i <  clientMaxRetries;  i++) {\n             try (CloseableHttpResponse response = this.client.execute(httpPost)) {\n"}}, {"oid": "4bece7e78774ec2dee5c01e5b1061473c062b19e", "url": "https://github.com/AthenZ/athenz/commit/4bece7e78774ec2dee5c01e5b1061473c062b19e", "message": "Fixed a bug where big emails caused http client to crash\nhttpPost.getEntity is limited to 25k and will throw an exception if it is bigger.", "committedDate": "2020-03-31T02:54:06Z", "type": "commit"}, {"oid": "4bece7e78774ec2dee5c01e5b1061473c062b19e", "url": "https://github.com/AthenZ/athenz/commit/4bece7e78774ec2dee5c01e5b1061473c062b19e", "message": "Fixed a bug where big emails caused http client to crash\nhttpPost.getEntity is limited to 25k and will throw an exception if it is bigger.", "committedDate": "2020-03-31T02:54:06Z", "type": "forcePushed"}]}