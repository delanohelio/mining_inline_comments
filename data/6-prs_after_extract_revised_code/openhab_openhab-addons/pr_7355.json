{"pr_number": 7355, "pr_title": "[lgwebos] Fix missing update of power channel state", "pr_createdAt": "2020-04-13T12:04:30Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/7355", "timeline": [{"oid": "307d645d4cda978e1af14236944279af655db2fa", "url": "https://github.com/openhab/openhab-addons/commit/307d645d4cda978e1af14236944279af655db2fa", "message": "[lgwebos] Fix missing update of power channel state\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-04-14T11:27:39Z", "type": "forcePushed"}, {"oid": "8fb58f56fd4cbf4d7836b70e393804efe8426d45", "url": "https://github.com/openhab/openhab-addons/commit/8fb58f56fd4cbf4d7836b70e393804efe8426d45", "message": "[lgwebos] Fix missing update of power channel state\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-04-14T14:23:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM3OTcxNQ==", "url": "https://github.com/openhab/openhab-addons/pull/7355#discussion_r408379715", "bodyText": "app  is know to be updated to empty values during app switches on TV. it will lead to temporary false power channel states. users will trigger scenes incorrectly.", "author": "sprehn", "createdAt": "2020-04-14T19:24:16Z", "path": "bundles/org.openhab.binding.lgwebos/src/main/java/org/openhab/binding/lgwebos/internal/LauncherApplication.java", "diffHunk": "@@ -120,10 +120,12 @@ public void onError(@Nullable String error) {\n \n             @Override\n             public void onSuccess(@Nullable AppInfo appInfo) {\n-                if (appInfo == null) {\n+                if (appInfo == null || appInfo.getId().isEmpty()) {\n                     handler.postUpdate(channelId, UnDefType.UNDEF);\n+                    handler.getSocket().disconnecting();", "originalCommit": "8fb58f56fd4cbf4d7836b70e393804efe8426d45", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b38d319c6afb8ac0a7cde586589a534e8339288d", "chunk": "diff --git a/bundles/org.openhab.binding.lgwebos/src/main/java/org/openhab/binding/lgwebos/internal/LauncherApplication.java b/bundles/org.openhab.binding.lgwebos/src/main/java/org/openhab/binding/lgwebos/internal/LauncherApplication.java\nindex e3afaced0b..f140536abb 100644\n--- a/bundles/org.openhab.binding.lgwebos/src/main/java/org/openhab/binding/lgwebos/internal/LauncherApplication.java\n+++ b/bundles/org.openhab.binding.lgwebos/src/main/java/org/openhab/binding/lgwebos/internal/LauncherApplication.java\n\n@@ -122,10 +122,8 @@ public class LauncherApplication extends BaseChannelHandler<AppInfo> {\n             public void onSuccess(@Nullable AppInfo appInfo) {\n                 if (appInfo == null || appInfo.getId().isEmpty()) {\n                     handler.postUpdate(channelId, UnDefType.UNDEF);\n-                    handler.getSocket().disconnecting();\n                 } else {\n                     handler.postUpdate(channelId, new StringType(appInfo.getId()));\n-                    handler.getSocket().stopDisconnecting();\n                 }\n             }\n         };\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM3OTc5Mg==", "url": "https://github.com/openhab/openhab-addons/pull/7355#discussion_r408379792", "bodyText": "same here, we should not use this to reset to registered from a temporary empty app\nhowever...\n\nBut we need something to move from DISCONNECTING to REGISTERED when TV is switched ON again (with WOL or simply the TV remote control). I think we should consider the receiving of data on the web socket as a trigger for that.\n\nI somewhat doubt that WOL will abort the shutdown process.\nhm... it may work for remote control. if it works I am fine", "author": "sprehn", "createdAt": "2020-04-14T19:24:26Z", "path": "bundles/org.openhab.binding.lgwebos/src/main/java/org/openhab/binding/lgwebos/internal/LauncherApplication.java", "diffHunk": "@@ -120,10 +120,12 @@ public void onError(@Nullable String error) {\n \n             @Override\n             public void onSuccess(@Nullable AppInfo appInfo) {\n-                if (appInfo == null) {\n+                if (appInfo == null || appInfo.getId().isEmpty()) {\n                     handler.postUpdate(channelId, UnDefType.UNDEF);\n+                    handler.getSocket().disconnecting();\n                 } else {\n                     handler.postUpdate(channelId, new StringType(appInfo.getId()));\n+                    handler.getSocket().stopDisconnecting();", "originalCommit": "8fb58f56fd4cbf4d7836b70e393804efe8426d45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODcwODUyNg==", "url": "https://github.com/openhab/openhab-addons/pull/7355#discussion_r408708526", "bodyText": "It works for remote control. For WOL, I have to try again your version but I think I remember I received the app just after the WOL.", "author": "lolodomo", "createdAt": "2020-04-15T09:33:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM3OTc5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "b38d319c6afb8ac0a7cde586589a534e8339288d", "chunk": "diff --git a/bundles/org.openhab.binding.lgwebos/src/main/java/org/openhab/binding/lgwebos/internal/LauncherApplication.java b/bundles/org.openhab.binding.lgwebos/src/main/java/org/openhab/binding/lgwebos/internal/LauncherApplication.java\nindex e3afaced0b..f140536abb 100644\n--- a/bundles/org.openhab.binding.lgwebos/src/main/java/org/openhab/binding/lgwebos/internal/LauncherApplication.java\n+++ b/bundles/org.openhab.binding.lgwebos/src/main/java/org/openhab/binding/lgwebos/internal/LauncherApplication.java\n\n@@ -122,10 +122,8 @@ public class LauncherApplication extends BaseChannelHandler<AppInfo> {\n             public void onSuccess(@Nullable AppInfo appInfo) {\n                 if (appInfo == null || appInfo.getId().isEmpty()) {\n                     handler.postUpdate(channelId, UnDefType.UNDEF);\n-                    handler.getSocket().disconnecting();\n                 } else {\n                     handler.postUpdate(channelId, new StringType(appInfo.getId()));\n-                    handler.getSocket().stopDisconnecting();\n                 }\n             }\n         };\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM4MjMxMA==", "url": "https://github.com/openhab/openhab-addons/pull/7355#discussion_r408382310", "bodyText": "agree with this call here, but in LGWebOSTVSocket::powerOff should set the disconnecting state on successful response.", "author": "sprehn", "createdAt": "2020-04-14T19:28:57Z", "path": "bundles/org.openhab.binding.lgwebos/src/main/java/org/openhab/binding/lgwebos/internal/PowerControlPower.java", "diffHunk": "@@ -51,11 +49,7 @@ public void onReceiveCommand(String channelId, LGWebOSHandler handler, Command c\n              */\n             handler.postUpdate(channelId, OnOffType.OFF);\n         } else if (OnOffType.OFF == command) {\n-            if (powerOn) {\n-                handler.getSocket().powerOff(getDefaultResponseListener());\n-            } else {\n-                logger.debug(\"Received OFF - Ignored as the TV is already off.\");\n-            }\n+            handler.getSocket().powerOff(getDefaultResponseListener());", "originalCommit": "8fb58f56fd4cbf4d7836b70e393804efe8426d45", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "b38d319c6afb8ac0a7cde586589a534e8339288d", "url": "https://github.com/openhab/openhab-addons/commit/b38d319c6afb8ac0a7cde586589a534e8339288d", "message": "[lgwebos] Fix missing update of power channel state\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-04-15T10:22:01Z", "type": "forcePushed"}, {"oid": "95b867065c44ccc839a2d40412ffae687a65197c", "url": "https://github.com/openhab/openhab-addons/commit/95b867065c44ccc839a2d40412ffae687a65197c", "message": "[lgwebos] Fix missing update of power channel state\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-04-15T10:36:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc1MTQ5Nw==", "url": "https://github.com/openhab/openhab-addons/pull/7355#discussion_r408751497", "bodyText": "Instead of handling this in onMessage. Let's do it this way to keep those concerns in one coherent in one place:\n public void powerOff(final ResponseListener<CommandConfirmation> listener) {\n        String uri = \"ssap://system/turnOff\";\n\n        ResponseListener<CommandConfirmation> interceptor = new ResponseListener<CommandConfirmation>() {\n\n            @Override\n            public void onSuccess(CommandConfirmation confirmation) {\n                if (confirmation.getReturnValue() && state == State.REGISTERED) {\n                    setState(State.DISCONNECTING);\n                }\n                listener.onSuccess(confirmation);\n            }\n\n            @Override\n            public void onError(String message) {\n                listener.onError(message);\n            }\n        };\n        ServiceCommand<CommandConfirmation> request = new ServiceCommand<>(uri, null,\n                x -> GSON.fromJson(x, CommandConfirmation.class), interceptor);\n        sendCommand(request);\n    }\n\nsame for the application listener", "author": "sprehn", "createdAt": "2020-04-15T10:49:37Z", "path": "bundles/org.openhab.binding.lgwebos/src/main/java/org/openhab/binding/lgwebos/internal/handler/LGWebOSTVSocket.java", "diffHunk": "@@ -365,7 +370,25 @@ public void onMessage(String message) {\n                     break;\n                 }\n                 try {\n-                    request.processResponse(response.getPayload().getAsJsonObject());\n+                    JsonObject jsonResponse = response.getPayload().getAsJsonObject();", "originalCommit": "95b867065c44ccc839a2d40412ffae687a65197c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc2NjM2Ng==", "url": "https://github.com/openhab/openhab-addons/pull/7355#discussion_r408766366", "bodyText": "Yes, that looks cleaner like this.", "author": "lolodomo", "createdAt": "2020-04-15T11:18:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc1MTQ5Nw=="}], "type": "inlineReview", "revised_code": {"commit": "ab3e4bdf3cd5d59983683d426802d3bd2af43f2f", "chunk": "diff --git a/bundles/org.openhab.binding.lgwebos/src/main/java/org/openhab/binding/lgwebos/internal/handler/LGWebOSTVSocket.java b/bundles/org.openhab.binding.lgwebos/src/main/java/org/openhab/binding/lgwebos/internal/handler/LGWebOSTVSocket.java\nindex e71d363d2a..84c88166f0 100644\n--- a/bundles/org.openhab.binding.lgwebos/src/main/java/org/openhab/binding/lgwebos/internal/handler/LGWebOSTVSocket.java\n+++ b/bundles/org.openhab.binding.lgwebos/src/main/java/org/openhab/binding/lgwebos/internal/handler/LGWebOSTVSocket.java\n\n@@ -380,10 +413,9 @@ public class LGWebOSTVSocket {\n                     } else if (request.getTarget().equals(FOREGROUND_APP)) {\n                         AppInfo appInfo = GSON.fromJson(jsonResponse, AppInfo.class);\n                         if (appInfo.getId().isEmpty()) {\n-                            if (state == State.REGISTERED) {\n-                                setState(State.DISCONNECTING);\n-                            }\n+                            scheduleDisconectingJob();\n                         } else {\n+                            stopDisconnectingJob();\n                             if (state == State.DISCONNECTING) {\n                                 setState(State.REGISTERED);\n                             }\n"}}, {"oid": "ab3e4bdf3cd5d59983683d426802d3bd2af43f2f", "url": "https://github.com/openhab/openhab-addons/commit/ab3e4bdf3cd5d59983683d426802d3bd2af43f2f", "message": "[lgwebos] Fix missing update of power channel state\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-04-15T11:13:00Z", "type": "forcePushed"}, {"oid": "81a2db07fc844a6dec3a8b53ec954d3077bee369", "url": "https://github.com/openhab/openhab-addons/commit/81a2db07fc844a6dec3a8b53ec954d3077bee369", "message": "[lgwebos] Fix missing update of power channel state\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-04-15T11:40:39Z", "type": "commit"}, {"oid": "81a2db07fc844a6dec3a8b53ec954d3077bee369", "url": "https://github.com/openhab/openhab-addons/commit/81a2db07fc844a6dec3a8b53ec954d3077bee369", "message": "[lgwebos] Fix missing update of power channel state\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-04-15T11:40:39Z", "type": "forcePushed"}, {"oid": "55e4ac747db9bf217efd026ea4ce3f890717b7be", "url": "https://github.com/openhab/openhab-addons/commit/55e4ac747db9bf217efd026ea4ce3f890717b7be", "message": "Update the disconnecting delay to 2 seconds rather than 5\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-04-15T12:02:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTE1ODg3NQ==", "url": "https://github.com/openhab/openhab-addons/pull/7355#discussion_r409158875", "bodyText": "I hate to make you do this as part of this PR but the issue is bad enough and I don't want it to get worse.\nPlease order the fields by: static final -> final -> non-final.", "author": "cpmeister", "createdAt": "2020-04-15T21:58:54Z", "path": "bundles/org.openhab.binding.lgwebos/src/main/java/org/openhab/binding/lgwebos/internal/handler/LGWebOSTVSocket.java", "diffHunk": "@@ -114,6 +118,11 @@\n     private final Logger logger = LoggerFactory.getLogger(LGWebOSTVSocket.class);\n     private int nextRequestId = 0;\n \n+    private final ScheduledExecutorService scheduler;\n+    private @Nullable ScheduledFuture<?> disconnectingJob;\n+\n+    private static final int DISCONNECTING_DELAY_SECONDS = 2;", "originalCommit": "55e4ac747db9bf217efd026ea4ce3f890717b7be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQwOTQwNg==", "url": "https://github.com/openhab/openhab-addons/pull/7355#discussion_r409409406", "bodyText": "Done for the classes LGWebOSHandler and LGWebOSTVSocket.", "author": "lolodomo", "createdAt": "2020-04-16T09:21:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTE1ODg3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQzMjg4Ng==", "url": "https://github.com/openhab/openhab-addons/pull/7355#discussion_r409432886", "bodyText": "Please note that the variable logger is very often set at first, even before the static fields. I don't know why and whether it is a good practice. With your request change, this is not the case here.", "author": "lolodomo", "createdAt": "2020-04-16T09:58:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTE1ODg3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "b200eff7c99f2423aa01e614aa1272ae6d935cd5", "chunk": "diff --git a/bundles/org.openhab.binding.lgwebos/src/main/java/org/openhab/binding/lgwebos/internal/handler/LGWebOSTVSocket.java b/bundles/org.openhab.binding.lgwebos/src/main/java/org/openhab/binding/lgwebos/internal/handler/LGWebOSTVSocket.java\nindex d317866729..b0cca08f92 100644\n--- a/bundles/org.openhab.binding.lgwebos/src/main/java/org/openhab/binding/lgwebos/internal/handler/LGWebOSTVSocket.java\n+++ b/bundles/org.openhab.binding.lgwebos/src/main/java/org/openhab/binding/lgwebos/internal/handler/LGWebOSTVSocket.java\n\n@@ -104,37 +126,18 @@ public class LGWebOSTVSocket {\n \n     private State state = State.DISCONNECTED;\n \n-    private final ConfigProvider config;\n-    private final WebSocketClient client;\n     private @Nullable Session session;\n-    private final URI destUri;\n     private @Nullable WebOSTVSocketListener listener;\n-    private final LGWebOSTVKeyboardInput keyboardInput;\n+\n     /**\n      * Requests to which we are awaiting response.\n      */\n     private HashMap<Integer, ServiceCommand<?>> requests = new HashMap<>();\n \n-    private final Logger logger = LoggerFactory.getLogger(LGWebOSTVSocket.class);\n     private int nextRequestId = 0;\n \n-    private final ScheduledExecutorService scheduler;\n     private @Nullable ScheduledFuture<?> disconnectingJob;\n \n-    private static final int DISCONNECTING_DELAY_SECONDS = 2;\n-\n-    private static final String FOREGROUND_APP = \"ssap://com.webos.applicationManager/getForegroundAppInfo\";\n-    // private static final String APP_STATUS = \"ssap://com.webos.service.appstatus/getAppStatus\";\n-    // private static final String APP_STATE = \"ssap://system.launcher/getAppState\";\n-    private static final String VOLUME = \"ssap://audio/getVolume\";\n-    private static final String MUTE = \"ssap://audio/getMute\";\n-    // private static final String VOLUME_STATUS = \"ssap://audio/getStatus\";\n-    private static final String CHANNEL_LIST = \"ssap://tv/getChannelList\";\n-    private static final String CHANNEL = \"ssap://tv/getCurrentChannel\";\n-    // private static final String PROGRAM = \"ssap://tv/getChannelProgramInfo\";\n-    // private static final String CURRENT_PROGRAM = \"ssap://tv/getChannelCurrentProgramInfo\";\n-    // private static final String THREED_STATUS = \"ssap://com.webos.service.tv.display/get3DStatus\";\n-\n     public LGWebOSTVSocket(WebSocketClient client, ConfigProvider config, String host, int port,\n             ScheduledExecutorService scheduler) {\n         this.config = config;\n"}}, {"oid": "b200eff7c99f2423aa01e614aa1272ae6d935cd5", "url": "https://github.com/openhab/openhab-addons/commit/b200eff7c99f2423aa01e614aa1272ae6d935cd5", "message": "Fix declaration order of fields\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-04-16T09:17:44Z", "type": "commit"}, {"oid": "0641abeca8e0fc4969a2327bffb080b1bacab38f", "url": "https://github.com/openhab/openhab-addons/commit/0641abeca8e0fc4969a2327bffb080b1bacab38f", "message": "Add method disconnecting\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-04-16T11:41:20Z", "type": "commit"}, {"oid": "cf0e3e7b51e9fd7a89b803831ea13032c36084e7", "url": "https://github.com/openhab/openhab-addons/commit/cf0e3e7b51e9fd7a89b803831ea13032c36084e7", "message": "Don't forget to stop the disconnecting job\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-04-16T11:49:01Z", "type": "commit"}, {"oid": "6b3c2cac3e4c53c3194052393e3f779bf4989eb2", "url": "https://github.com/openhab/openhab-addons/commit/6b3c2cac3e4c53c3194052393e3f779bf4989eb2", "message": "Make disconnecting method private\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-04-16T17:04:00Z", "type": "commit"}, {"oid": "28a4c60c44f7ba112fbe5612a706ef6b996e95e8", "url": "https://github.com/openhab/openhab-addons/commit/28a4c60c44f7ba112fbe5612a706ef6b996e95e8", "message": "Reduce a log level\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-04-16T18:26:15Z", "type": "commit"}]}