{"pr_number": 7347, "pr_title": "[insteon] Improve hub message processing", "pr_createdAt": "2020-04-12T00:25:05Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/7347", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE0MTM3MA==", "url": "https://github.com/openhab/openhab-addons/pull/7347#discussion_r407141370", "bodyText": "You aren't going to log this message anymore?", "author": "cpmeister", "createdAt": "2020-04-12T03:46:23Z", "path": "bundles/org.openhab.binding.insteon/src/main/java/org/openhab/binding/insteon/internal/driver/Port.java", "diffHunk": "@@ -300,21 +300,23 @@ public void run() {\n         }\n \n         private void processMessages() {\n-            try {\n-                // must call processData() until we get a null pointer back\n-                for (Msg m = msgFactory.processData(); m != null; m = msgFactory.processData()) {\n-                    toAllListeners(m);\n-                    notifyWriter(m);\n-                }\n-            } catch (IOException e) {\n-                // got bad data from modem,\n-                // unblock those waiting for ack\n-                logger.warn(\"bad data received: {}\", e.getMessage());", "originalCommit": "3bd1fde7518a1e879104b4c8bf63309c4e76b7d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE1OTc0NA==", "url": "https://github.com/openhab/openhab-addons/pull/7347#discussion_r407159744", "bodyText": "This was removed because it was getting logged twice just before the IOException is raised. That's why the bad data received prefix was moved to the other log statement.", "author": "jsetton", "createdAt": "2020-04-12T07:31:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE0MTM3MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE0MjI1OA==", "url": "https://github.com/openhab/openhab-addons/pull/7347#discussion_r407142258", "bodyText": "Is there any way to prevent calling getHexByte if it wouldn't be logged anyway? Maybe call it inside the bail method?", "author": "cpmeister", "createdAt": "2020-04-12T04:00:03Z", "path": "bundles/org.openhab.binding.insteon/src/main/java/org/openhab/binding/insteon/internal/message/MsgFactory.java", "diffHunk": "@@ -93,44 +108,48 @@ public void addData(byte[] data, int len) {\n         // Now see if we have enough data for a complete message.\n         // If not, we return null, and expect this method to be called again\n         // when more data has come in.\n-        int msgLen = -1;\n-        boolean isExtended = false;\n         if (end > 1) {\n             // we have some data, but do we have enough to read the entire header?\n             int headerLength = Msg.getHeaderLength(buf[1]);\n-            isExtended = Msg.isExtended(buf, end, headerLength);\n+            boolean isExtended = Msg.isExtended(buf, end, headerLength);\n             logger.trace(\"header length expected: {} extended: {}\", headerLength, isExtended);\n             if (headerLength < 0) {\n                 removeFromBuffer(1); // get rid of the leading 0x02 so draining works\n-                bail(\"got unknown command code \" + Utils.getHexByte(buf[1]));\n+                bail(\"got unknown command code \" + Utils.getHexByte(buf[0]));\n             } else if (headerLength >= 2) {\n                 if (end >= headerLength) {\n                     // only when the header is complete do we know that isExtended is correct!\n-                    msgLen = Msg.getMessageLength(buf[1], isExtended);\n+                    int msgLen = Msg.getMessageLength(buf[1], isExtended);\n+                    logger.trace(\"msgLen expected: {}\", msgLen);\n                     if (msgLen < 0) {\n                         // Cannot make sense out of the combined command code & isExtended flag.\n                         removeFromBuffer(1);\n-                        bail(\"unknown command code/ext flag: \" + Utils.getHexByte(buf[1]));\n+                        bail(\"got unknown command code/ext flag \" + Utils.getHexByte(buf[0]));", "originalCommit": "3bd1fde7518a1e879104b4c8bf63309c4e76b7d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE1OTgwMA==", "url": "https://github.com/openhab/openhab-addons/pull/7347#discussion_r407159800", "bodyText": "The message is being logged in the bail method. So I am unsure why you are asking this?", "author": "jsetton", "createdAt": "2020-04-12T07:32:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE0MjI1OA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE0MjI3MA==", "url": "https://github.com/openhab/openhab-addons/pull/7347#discussion_r407142270", "bodyText": "please fix the indentation.", "author": "cpmeister", "createdAt": "2020-04-12T04:00:17Z", "path": "bundles/org.openhab.binding.insteon/src/main/java/org/openhab/binding/insteon/internal/message/MsgFactory.java", "diffHunk": "@@ -56,9 +66,13 @@ public MsgFactory() {\n     public void addData(byte[] data, int len) {\n         int l = len;\n         if (l + end > MAX_MSG_LEN) {\n-            logger.warn(\"warn: truncating excessively long message!\");\n+            logger.warn(\"truncating excessively long message!\");\n             l = MAX_MSG_LEN - end;\n         }\n+        // indicate new data can be processed if length > 0\n+        if (l > 0) {\n+          done = false;", "originalCommit": "3bd1fde7518a1e879104b4c8bf63309c4e76b7d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE1OTgzNg==", "url": "https://github.com/openhab/openhab-addons/pull/7347#discussion_r407159836", "bodyText": "Sure.", "author": "jsetton", "createdAt": "2020-04-12T07:32:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE0MjI3MA=="}], "type": "inlineReview", "revised_code": {"commit": "859aab3b3cce0cdb572013ffc4ab1c0501fbb8e0", "chunk": "diff --git a/bundles/org.openhab.binding.insteon/src/main/java/org/openhab/binding/insteon/internal/message/MsgFactory.java b/bundles/org.openhab.binding.insteon/src/main/java/org/openhab/binding/insteon/internal/message/MsgFactory.java\nindex 27dc4d2e69..26fd5a737f 100644\n--- a/bundles/org.openhab.binding.insteon/src/main/java/org/openhab/binding/insteon/internal/message/MsgFactory.java\n+++ b/bundles/org.openhab.binding.insteon/src/main/java/org/openhab/binding/insteon/internal/message/MsgFactory.java\n\n@@ -71,7 +71,7 @@ public class MsgFactory {\n         }\n         // indicate new data can be processed if length > 0\n         if (l > 0) {\n-          done = false;\n+            done = false;\n         }\n         // append the new data to the one we already have\n         System.arraycopy(data, 0, buf, end, l);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE0MjYxOA==", "url": "https://github.com/openhab/openhab-addons/pull/7347#discussion_r407142618", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    logger.trace(\"keeping buffer len {} data: {}\", end, Utils.getHexString(buf, end));\n          \n          \n            \n                    if(logger.isTraceEnabled()){\n          \n          \n            \n                        logger.trace(\"keeping buffer len {} data: {}\", end, Utils.getHexString(buf, end));\n          \n          \n            \n                    }", "author": "cpmeister", "createdAt": "2020-04-12T04:05:58Z", "path": "bundles/org.openhab.binding.insteon/src/main/java/org/openhab/binding/insteon/internal/message/MsgFactory.java", "diffHunk": "@@ -93,44 +108,48 @@ public void addData(byte[] data, int len) {\n         // Now see if we have enough data for a complete message.\n         // If not, we return null, and expect this method to be called again\n         // when more data has come in.\n-        int msgLen = -1;\n-        boolean isExtended = false;\n         if (end > 1) {\n             // we have some data, but do we have enough to read the entire header?\n             int headerLength = Msg.getHeaderLength(buf[1]);\n-            isExtended = Msg.isExtended(buf, end, headerLength);\n+            boolean isExtended = Msg.isExtended(buf, end, headerLength);\n             logger.trace(\"header length expected: {} extended: {}\", headerLength, isExtended);\n             if (headerLength < 0) {\n                 removeFromBuffer(1); // get rid of the leading 0x02 so draining works\n-                bail(\"got unknown command code \" + Utils.getHexByte(buf[1]));\n+                bail(\"got unknown command code \" + Utils.getHexByte(buf[0]));\n             } else if (headerLength >= 2) {\n                 if (end >= headerLength) {\n                     // only when the header is complete do we know that isExtended is correct!\n-                    msgLen = Msg.getMessageLength(buf[1], isExtended);\n+                    int msgLen = Msg.getMessageLength(buf[1], isExtended);\n+                    logger.trace(\"msgLen expected: {}\", msgLen);\n                     if (msgLen < 0) {\n                         // Cannot make sense out of the combined command code & isExtended flag.\n                         removeFromBuffer(1);\n-                        bail(\"unknown command code/ext flag: \" + Utils.getHexByte(buf[1]));\n+                        bail(\"got unknown command code/ext flag \" + Utils.getHexByte(buf[0]));\n+                    } else if (msgLen > 0) {\n+                        if (end >= msgLen) {\n+                            msg = Msg.createMessage(buf, msgLen, isExtended);\n+                            removeFromBuffer(msgLen);\n+                        }\n+                    } else { // should never happen\n+                        logger.warn(\"invalid message length, internal error!\");\n                     }\n                 }\n             } else { // should never happen\n                 logger.warn(\"invalid header length, internal error!\");\n-                msgLen = -1;\n             }\n         }\n-        logger.trace(\"msgLen expected: {}\", msgLen);\n-        Msg msg = null;\n-        if (msgLen > 0 && end >= msgLen) {\n-            msg = Msg.createMessage(buf, msgLen, isExtended);\n-            removeFromBuffer(msgLen);\n+        // indicate no more messages available in buffer if empty or undefined message\n+        if (end == 0 || msg == null) {\n+            logger.trace(\"done processing current buffer data\");\n+            done = true;\n         }\n         logger.trace(\"keeping buffer len {} data: {}\", end, Utils.getHexString(buf, end));", "originalCommit": "3bd1fde7518a1e879104b4c8bf63309c4e76b7d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE2MDAxNw==", "url": "https://github.com/openhab/openhab-addons/pull/7347#discussion_r407160017", "bodyText": "There are a ton of logger.trace calls across the code. What's the point of this?", "author": "jsetton", "createdAt": "2020-04-12T07:34:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE0MjYxOA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "859aab3b3cce0cdb572013ffc4ab1c0501fbb8e0", "url": "https://github.com/openhab/openhab-addons/commit/859aab3b3cce0cdb572013ffc4ab1c0501fbb8e0", "message": "improved message processing\n\nSigned-off-by: jsetton <jeremy.setton@gmail.com>", "committedDate": "2020-04-12T07:41:39Z", "type": "commit"}, {"oid": "e548f46ef78191ac3846280dafc80d8f456a7a5d", "url": "https://github.com/openhab/openhab-addons/commit/e548f46ef78191ac3846280dafc80d8f456a7a5d", "message": "added undocumented 0x5c message code definition\n\nSigned-off-by: jsetton <jeremy.setton@gmail.com>", "committedDate": "2020-04-12T07:41:54Z", "type": "commit"}, {"oid": "e548f46ef78191ac3846280dafc80d8f456a7a5d", "url": "https://github.com/openhab/openhab-addons/commit/e548f46ef78191ac3846280dafc80d8f456a7a5d", "message": "added undocumented 0x5c message code definition\n\nSigned-off-by: jsetton <jeremy.setton@gmail.com>", "committedDate": "2020-04-12T07:41:54Z", "type": "forcePushed"}]}