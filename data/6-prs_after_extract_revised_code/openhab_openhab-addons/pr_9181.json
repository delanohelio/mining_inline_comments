{"pr_number": 9181, "pr_title": "[modbus] BaseModbusThingHandler: Add ability to retrieve slave address", "pr_createdAt": "2020-11-30T08:24:54Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/9181", "timeline": [{"oid": "1301b7db9c9fecb46d69d71cdfc0d7ac524b65cd", "url": "https://github.com/openhab/openhab-addons/commit/1301b7db9c9fecb46d69d71cdfc0d7ac524b65cd", "message": "[modbus] BaseModbusThingHandler: Add ability to retrieve slave address\n\nSigned-off-by: Fabian Wolter <github@fabian-wolter.de>", "committedDate": "2020-11-30T08:04:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc3NTQ4NQ==", "url": "https://github.com/openhab/openhab-addons/pull/9181#discussion_r532775485", "bodyText": "Hmm this will now raise unchecked exception when bridge is offline e.g due to configuration error? When bridge is having configuration error, the slave id is not available.\nPerhaps the configuration error of bridge is the only situation when these methods can fail?\nShould it set thing to offline with BRIDGE_OFFLINE instead of raising unchecked exception to framework?", "author": "ssalonen", "createdAt": "2020-11-30T17:34:36Z", "path": "bundles/org.openhab.binding.modbus/src/main/java/org/openhab/binding/modbus/handler/BaseModbusThingHandler.java", "diffHunk": "@@ -59,9 +58,27 @@ public BaseModbusThingHandler(Thing thing) {\n     public void initialize() {", "originalCommit": "1301b7db9c9fecb46d69d71cdfc0d7ac524b65cd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzYzNzYwMA==", "url": "https://github.com/openhab/openhab-addons/pull/9181#discussion_r533637600", "bodyText": "I see no other chance to prevent the Thing from being initialized. Setting the Thing status has no effect as it will be overwritten by any updateStatus() in initialize() of the \"user\" class. Do you have a suggestion?", "author": "fwolter", "createdAt": "2020-12-01T18:40:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc3NTQ4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzkzMTIzMg==", "url": "https://github.com/openhab/openhab-addons/pull/9181#discussion_r533931232", "bodyText": "Good point...\nI looked at some examples from the code base\n\nAbstractModbusEndpointThingHandler parent class sets thing OFFLINE. initialize not implemented in child class\nBeaconBluetoothHandler (in bluetooth) parent class sets thing OFFLINE. Child class (RuuviTagHandler) has check\n\n        if (getThing().getStatus() != ThingStatus.OFFLINE) {\n            heartbeatFuture = scheduler.scheduleWithFixedDelay(this::heartbeat, 0, HEARTBEAT_TIMEOUT_MINUTES,\n                    TimeUnit.MINUTES);\n\nI there might be race condition here... Ist getThing().getStatus() update instantaneous?\n\nIT100BridgeHandler extends DSCAlarmBaseBridgeHandler super initialize is called conditionally when config is otherwise OK.\n\nDo we typically expect to override the initialize method in child class?", "author": "ssalonen", "createdAt": "2020-12-02T06:45:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc3NTQ4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDMxMDE5Mw==", "url": "https://github.com/openhab/openhab-addons/pull/9181#discussion_r534310193", "bodyText": "It's always good to have a second pair of eyes. The examples inspired me to come up with a slightly other solution.\nThe BaseModbusThingHandler got a new abstract method modbusInitialize(), which is only called, when the Modbus Bridge is configured correctly. That way the Thing can be set to offline in a normal way. Also, the user doesn't need to call super.initialize() anymore, which was error-prone. So, the boolean flag could be dropped, too. I made the initialize() method final to prevent the user from overriding it wrongly.", "author": "fwolter", "createdAt": "2020-12-02T16:34:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc3NTQ4NQ=="}], "type": "inlineReview", "revised_code": {"commit": "9e074518f9945d993f3af4f4acadbd9aae07ea13", "chunk": "diff --git a/bundles/org.openhab.binding.modbus/src/main/java/org/openhab/binding/modbus/handler/BaseModbusThingHandler.java b/bundles/org.openhab.binding.modbus/src/main/java/org/openhab/binding/modbus/handler/BaseModbusThingHandler.java\nindex 71ca46f41f..727261e5d4 100644\n--- a/bundles/org.openhab.binding.modbus/src/main/java/org/openhab/binding/modbus/handler/BaseModbusThingHandler.java\n+++ b/bundles/org.openhab.binding.modbus/src/main/java/org/openhab/binding/modbus/handler/BaseModbusThingHandler.java\n\n@@ -59,7 +59,7 @@ public abstract class BaseModbusThingHandler extends BaseThingHandler {\n         getModbus();\n \n         try {\n-            getEndpoint().getSlaveId();\n+            getBridgeHandler().getSlaveId();\n         } catch (EndpointNotInitializedException e) {\n             throw new IllegalStateException(e);\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc3NzgzMg==", "url": "https://github.com/openhab/openhab-addons/pull/9181#discussion_r532777832", "bodyText": "Consider renaming the method as it no longer returns endpoint", "author": "ssalonen", "createdAt": "2020-11-30T17:38:10Z", "path": "bundles/org.openhab.binding.modbus/src/main/java/org/openhab/binding/modbus/handler/BaseModbusThingHandler.java", "diffHunk": "@@ -164,6 +172,16 @@ public ModbusSlaveEndpoint getEndpoint() {\n      * @return the {@link ModbusCommunicationInterface}\n      */\n     private ModbusCommunicationInterface getModbus() {\n+        ModbusCommunicationInterface communicationInterface = getEndpoint().getCommunicationInterface();\n+\n+        if (communicationInterface == null) {\n+            throw new IllegalStateException(\"Failed to retrieve Modbus communication interface\");\n+        } else {\n+            return communicationInterface;\n+        }\n+    }\n+\n+    private ModbusEndpointThingHandler getEndpoint() {", "originalCommit": "1301b7db9c9fecb46d69d71cdfc0d7ac524b65cd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9e074518f9945d993f3af4f4acadbd9aae07ea13", "chunk": "diff --git a/bundles/org.openhab.binding.modbus/src/main/java/org/openhab/binding/modbus/handler/BaseModbusThingHandler.java b/bundles/org.openhab.binding.modbus/src/main/java/org/openhab/binding/modbus/handler/BaseModbusThingHandler.java\nindex 71ca46f41f..727261e5d4 100644\n--- a/bundles/org.openhab.binding.modbus/src/main/java/org/openhab/binding/modbus/handler/BaseModbusThingHandler.java\n+++ b/bundles/org.openhab.binding.modbus/src/main/java/org/openhab/binding/modbus/handler/BaseModbusThingHandler.java\n\n@@ -172,7 +172,7 @@ public abstract class BaseModbusThingHandler extends BaseThingHandler {\n      * @return the {@link ModbusCommunicationInterface}\n      */\n     private ModbusCommunicationInterface getModbus() {\n-        ModbusCommunicationInterface communicationInterface = getEndpoint().getCommunicationInterface();\n+        ModbusCommunicationInterface communicationInterface = getBridgeHandler().getCommunicationInterface();\n \n         if (communicationInterface == null) {\n             throw new IllegalStateException(\"Failed to retrieve Modbus communication interface\");\n"}}, {"oid": "9e074518f9945d993f3af4f4acadbd9aae07ea13", "url": "https://github.com/openhab/openhab-addons/commit/9e074518f9945d993f3af4f4acadbd9aae07ea13", "message": "Refactor\n\nSigned-off-by: Fabian Wolter <github@fabian-wolter.de>", "committedDate": "2020-12-01T18:34:12Z", "type": "commit"}, {"oid": "ce1efe17f635d74e64645568771e06e371c361ed", "url": "https://github.com/openhab/openhab-addons/commit/ce1efe17f635d74e64645568771e06e371c361ed", "message": "Refactor #2\n\nSigned-off-by: Fabian Wolter <github@fabian-wolter.de>", "committedDate": "2020-12-02T16:32:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI2MjQyOQ==", "url": "https://github.com/openhab/openhab-addons/pull/9181#discussion_r536262429", "bodyText": "I don't think this is true?", "author": "ssalonen", "createdAt": "2020-12-04T17:33:44Z", "path": "bundles/org.openhab.binding.modbus/src/main/java/org/openhab/binding/modbus/handler/BaseModbusThingHandler.java", "diffHunk": "@@ -43,23 +42,53 @@\n public abstract class BaseModbusThingHandler extends BaseThingHandler {\n     private List<PollTask> periodicPollers = Collections.synchronizedList(new ArrayList<>());\n     private List<Future<?>> oneTimePollers = Collections.synchronizedList(new ArrayList<>());\n-    private volatile boolean initialized;\n \n     public BaseModbusThingHandler(Thing thing) {\n         super(thing);\n     }\n \n     /**\n-     * This method must be invoked in the base class' initialize() method before any other initialization is done.\n-     * It will throw an unchecked exception if the {@link ModbusCommunicationInterface} is not accessible (fail-fast).\n-     * This prevents any further initialization of the Thing. The framework will set the ThingStatus to\n-     * HANDLER_INITIALIZING_ERROR and display the exception's message.\n+     * This method is called when the Thing is being initialized, but only if the Modbus Bridge is configured correctly.\n+     * The code that normally goes into `BaseThingHandler.initialize()` like configuration reading and validation goes\n+     * here.\n      */\n+    public abstract void modbusInitialize();\n+\n     @Override\n-    public void initialize() {\n-        getModbus();\n+    final public void initialize() {\n+        try {\n+            // check if the Bridge is configured correctly (fail-fast)\n+            getModbus();\n+            getBridgeHandler().getSlaveId();\n+\n+            modbusInitialize();\n+        } catch (EndpointNotInitializedException | IllegalStateException e) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR,\n+                    \"Modbus initialization failed: \" + e.getMessage());\n+        }\n+    }\n+\n+    /**\n+     * Get Slave ID, also called as unit id, represented by the thing\n+     *\n+     * @return slave id represented by this thing handler\n+     * @throws EndpointNotInitializedException in case the initialization is not complete", "originalCommit": "ce1efe17f635d74e64645568771e06e371c361ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI5ODQ1Mw==", "url": "https://github.com/openhab/openhab-addons/pull/9181#discussion_r536298453", "bodyText": "You're right. I removed it.", "author": "fwolter", "createdAt": "2020-12-04T18:34:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI2MjQyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "011cedca524f23de0ac70604351a3d0a61879c99", "chunk": "diff --git a/bundles/org.openhab.binding.modbus/src/main/java/org/openhab/binding/modbus/handler/BaseModbusThingHandler.java b/bundles/org.openhab.binding.modbus/src/main/java/org/openhab/binding/modbus/handler/BaseModbusThingHandler.java\nindex aca117e657..26544f9bb5 100644\n--- a/bundles/org.openhab.binding.modbus/src/main/java/org/openhab/binding/modbus/handler/BaseModbusThingHandler.java\n+++ b/bundles/org.openhab.binding.modbus/src/main/java/org/openhab/binding/modbus/handler/BaseModbusThingHandler.java\n\n@@ -55,30 +55,28 @@ public abstract class BaseModbusThingHandler extends BaseThingHandler {\n     public abstract void modbusInitialize();\n \n     @Override\n-    final public void initialize() {\n+    public final void initialize() {\n         try {\n             // check if the Bridge is configured correctly (fail-fast)\n             getModbus();\n-            getBridgeHandler().getSlaveId();\n-\n-            modbusInitialize();\n-        } catch (EndpointNotInitializedException | IllegalStateException e) {\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR,\n-                    \"Modbus initialization failed: \" + e.getMessage());\n+            getSlaveId();\n+        } catch (IllegalStateException e) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.BRIDGE_UNINITIALIZED, e.getMessage());\n         }\n+\n+        modbusInitialize();\n     }\n \n     /**\n      * Get Slave ID, also called as unit id, represented by the thing\n      *\n      * @return slave id represented by this thing handler\n-     * @throws EndpointNotInitializedException in case the initialization is not complete\n      */\n     public int getSlaveId() {\n         try {\n             return getBridgeHandler().getSlaveId();\n         } catch (EndpointNotInitializedException e) {\n-            throw new IllegalStateException(e);\n+            throw new IllegalStateException(\"Bridge not initialized\");\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI2MzY0NA==", "url": "https://github.com/openhab/openhab-addons/pull/9181#discussion_r536263644", "bodyText": "BRIDGE_OFFLINE would be more correct for cases when bridge is offline? It would direct the user to look at the bridge error message.\nAre there any other reasons we expect the initialization to fail?", "author": "ssalonen", "createdAt": "2020-12-04T17:35:44Z", "path": "bundles/org.openhab.binding.modbus/src/main/java/org/openhab/binding/modbus/handler/BaseModbusThingHandler.java", "diffHunk": "@@ -43,23 +42,53 @@\n public abstract class BaseModbusThingHandler extends BaseThingHandler {\n     private List<PollTask> periodicPollers = Collections.synchronizedList(new ArrayList<>());\n     private List<Future<?>> oneTimePollers = Collections.synchronizedList(new ArrayList<>());\n-    private volatile boolean initialized;\n \n     public BaseModbusThingHandler(Thing thing) {\n         super(thing);\n     }\n \n     /**\n-     * This method must be invoked in the base class' initialize() method before any other initialization is done.\n-     * It will throw an unchecked exception if the {@link ModbusCommunicationInterface} is not accessible (fail-fast).\n-     * This prevents any further initialization of the Thing. The framework will set the ThingStatus to\n-     * HANDLER_INITIALIZING_ERROR and display the exception's message.\n+     * This method is called when the Thing is being initialized, but only if the Modbus Bridge is configured correctly.\n+     * The code that normally goes into `BaseThingHandler.initialize()` like configuration reading and validation goes\n+     * here.\n      */\n+    public abstract void modbusInitialize();\n+\n     @Override\n-    public void initialize() {\n-        getModbus();\n+    final public void initialize() {\n+        try {\n+            // check if the Bridge is configured correctly (fail-fast)\n+            getModbus();\n+            getBridgeHandler().getSlaveId();\n+\n+            modbusInitialize();\n+        } catch (EndpointNotInitializedException | IllegalStateException e) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR,", "originalCommit": "ce1efe17f635d74e64645568771e06e371c361ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI5OTUxMg==", "url": "https://github.com/openhab/openhab-addons/pull/9181#discussion_r536299512", "bodyText": "I saw there's a ThingStatusDetail.BRIDGE_UNINITIALIZED. I think that would fit even better. I moved the invocation of the abstract method out of the try-block, that only a Bridge error could lead to a BRIDGE_UNINITIALIZED.", "author": "fwolter", "createdAt": "2020-12-04T18:36:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI2MzY0NA=="}], "type": "inlineReview", "revised_code": {"commit": "011cedca524f23de0ac70604351a3d0a61879c99", "chunk": "diff --git a/bundles/org.openhab.binding.modbus/src/main/java/org/openhab/binding/modbus/handler/BaseModbusThingHandler.java b/bundles/org.openhab.binding.modbus/src/main/java/org/openhab/binding/modbus/handler/BaseModbusThingHandler.java\nindex aca117e657..26544f9bb5 100644\n--- a/bundles/org.openhab.binding.modbus/src/main/java/org/openhab/binding/modbus/handler/BaseModbusThingHandler.java\n+++ b/bundles/org.openhab.binding.modbus/src/main/java/org/openhab/binding/modbus/handler/BaseModbusThingHandler.java\n\n@@ -55,30 +55,28 @@ public abstract class BaseModbusThingHandler extends BaseThingHandler {\n     public abstract void modbusInitialize();\n \n     @Override\n-    final public void initialize() {\n+    public final void initialize() {\n         try {\n             // check if the Bridge is configured correctly (fail-fast)\n             getModbus();\n-            getBridgeHandler().getSlaveId();\n-\n-            modbusInitialize();\n-        } catch (EndpointNotInitializedException | IllegalStateException e) {\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR,\n-                    \"Modbus initialization failed: \" + e.getMessage());\n+            getSlaveId();\n+        } catch (IllegalStateException e) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.BRIDGE_UNINITIALIZED, e.getMessage());\n         }\n+\n+        modbusInitialize();\n     }\n \n     /**\n      * Get Slave ID, also called as unit id, represented by the thing\n      *\n      * @return slave id represented by this thing handler\n-     * @throws EndpointNotInitializedException in case the initialization is not complete\n      */\n     public int getSlaveId() {\n         try {\n             return getBridgeHandler().getSlaveId();\n         } catch (EndpointNotInitializedException e) {\n-            throw new IllegalStateException(e);\n+            throw new IllegalStateException(\"Bridge not initialized\");\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI2NTg2MA==", "url": "https://github.com/openhab/openhab-addons/pull/9181#discussion_r536265860", "bodyText": "According to javadoc, null communication interface is returned when initialization is incomplete == bridge is not online.\nBy failing fast (check bridge status) we can offer better error message to user?", "author": "ssalonen", "createdAt": "2020-12-04T17:39:18Z", "path": "bundles/org.openhab.binding.modbus/src/main/java/org/openhab/binding/modbus/handler/BaseModbusThingHandler.java", "diffHunk": "@@ -164,6 +178,16 @@ public ModbusSlaveEndpoint getEndpoint() {\n      * @return the {@link ModbusCommunicationInterface}\n      */\n     private ModbusCommunicationInterface getModbus() {\n+        ModbusCommunicationInterface communicationInterface = getBridgeHandler().getCommunicationInterface();\n+\n+        if (communicationInterface == null) {\n+            throw new IllegalStateException(\"Failed to retrieve Modbus communication interface\");", "originalCommit": "ce1efe17f635d74e64645568771e06e371c361ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI5OTkxMQ==", "url": "https://github.com/openhab/openhab-addons/pull/9181#discussion_r536299911", "bodyText": "I reworked all error messages to achieve easier debugging for the user.", "author": "fwolter", "createdAt": "2020-12-04T18:37:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI2NTg2MA=="}], "type": "inlineReview", "revised_code": {"commit": "011cedca524f23de0ac70604351a3d0a61879c99", "chunk": "diff --git a/bundles/org.openhab.binding.modbus/src/main/java/org/openhab/binding/modbus/handler/BaseModbusThingHandler.java b/bundles/org.openhab.binding.modbus/src/main/java/org/openhab/binding/modbus/handler/BaseModbusThingHandler.java\nindex aca117e657..26544f9bb5 100644\n--- a/bundles/org.openhab.binding.modbus/src/main/java/org/openhab/binding/modbus/handler/BaseModbusThingHandler.java\n+++ b/bundles/org.openhab.binding.modbus/src/main/java/org/openhab/binding/modbus/handler/BaseModbusThingHandler.java\n\n@@ -167,21 +166,11 @@ public abstract class BaseModbusThingHandler extends BaseThingHandler {\n         return future;\n     }\n \n-    /**\n-     * Retrieves the {@link ModbusCommunicationInterface} and does some validity checking.\n-     * Sets the ThingStatus to offline if it couldn't be retrieved and throws an unchecked exception.\n-     *\n-     * The unchecked exception should not be caught by the implementing class, as the initialization of the Thing\n-     * already fails if the {@link ModbusCommunicationInterface} cannot be retrieved.\n-     *\n-     * @throws IllegalStateException if the {@link ModbusCommunicationInterface} couldn't be retrieved.\n-     * @return the {@link ModbusCommunicationInterface}\n-     */\n     private ModbusCommunicationInterface getModbus() {\n         ModbusCommunicationInterface communicationInterface = getBridgeHandler().getCommunicationInterface();\n \n         if (communicationInterface == null) {\n-            throw new IllegalStateException(\"Failed to retrieve Modbus communication interface\");\n+            throw new IllegalStateException(\"Bridge not initialized\");\n         } else {\n             return communicationInterface;\n         }\n"}}, {"oid": "011cedca524f23de0ac70604351a3d0a61879c99", "url": "https://github.com/openhab/openhab-addons/commit/011cedca524f23de0ac70604351a3d0a61879c99", "message": "Rework error handling\n\nSigned-off-by: Fabian Wolter <github@fabian-wolter.de>", "committedDate": "2020-12-04T18:39:37Z", "type": "commit"}]}