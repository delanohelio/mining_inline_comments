{"pr_number": 9199, "pr_title": "[ipcamera] Improve ONVIF discovery and bug fixes.", "pr_createdAt": "2020-12-02T12:13:01Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/9199", "timeline": [{"oid": "944202cd086901a8f13ba9673aedb1e23e3b24a1", "url": "https://github.com/openhab/openhab-addons/commit/944202cd086901a8f13ba9673aedb1e23e3b24a1", "message": "Fix Offline detection and Improve discovery.\n\n\nSigned-off-by: Matthew Skinner <matt@pcmus.com>", "committedDate": "2020-11-29T04:37:25Z", "type": "commit"}, {"oid": "66fe756e24beed885d0f785bb4aeced24b2778cb", "url": "https://github.com/openhab/openhab-addons/commit/66fe756e24beed885d0f785bb4aeced24b2778cb", "message": "Motion options bug fix.\n\n\nSigned-off-by: Matthew Skinner <matt@pcmus.com>", "committedDate": "2020-11-29T06:22:30Z", "type": "commit"}, {"oid": "82dd7f93cc1df82d8b423460b3fa911f5a1ea23f", "url": "https://github.com/openhab/openhab-addons/commit/82dd7f93cc1df82d8b423460b3fa911f5a1ea23f", "message": "Message content bug fix.\n\n\nSigned-off-by: Matthew Skinner <matt@pcmus.com>", "committedDate": "2020-11-29T13:26:46Z", "type": "commit"}, {"oid": "5d9877d9fa7e8420ab833848f63b833a80164f60", "url": "https://github.com/openhab/openhab-addons/commit/5d9877d9fa7e8420ab833848f63b833a80164f60", "message": "Fix all handlers to process all chunks as one.\n\n\nSigned-off-by: Matthew Skinner <matt@pcmus.com>", "committedDate": "2020-12-01T06:21:10Z", "type": "commit"}, {"oid": "babfe24669e5e57faa767b705b02f487a9b3c7fe", "url": "https://github.com/openhab/openhab-addons/commit/babfe24669e5e57faa767b705b02f487a9b3c7fe", "message": "Remove password from FFmpeg command log.\n\n\nSigned-off-by: Matthew Skinner <matt@pcmus.com>", "committedDate": "2020-12-01T10:58:24Z", "type": "commit"}, {"oid": "bfaefff0f8126d412b3eb2ee4cbffdfaaead166d", "url": "https://github.com/openhab/openhab-addons/commit/bfaefff0f8126d412b3eb2ee4cbffdfaaead166d", "message": "Reverse some changes after testing.\n\n\nSigned-off-by: Matthew Skinner <matt@pcmus.com>", "committedDate": "2020-12-02T10:48:19Z", "type": "commit"}, {"oid": "d27e48cb9744034fdb158d3dc0afb676818f053e", "url": "https://github.com/openhab/openhab-addons/commit/d27e48cb9744034fdb158d3dc0afb676818f053e", "message": "Instar reverse.\n\n\nSigned-off-by: Matthew Skinner <matt@pcmus.com>", "committedDate": "2020-12-02T11:03:17Z", "type": "commit"}, {"oid": "bca198146376aea515e7ec040e8ed8f751ab0d10", "url": "https://github.com/openhab/openhab-addons/commit/bca198146376aea515e7ec040e8ed8f751ab0d10", "message": "clean up\n\n\nSigned-off-by: Matthew Skinner <matt@pcmus.com>", "committedDate": "2020-12-02T11:47:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM5MTYyOQ==", "url": "https://github.com/openhab/openhab-addons/pull/9199#discussion_r536391629", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                ffmpegCommand.replaceAll(password, \"passwordRemoved\"));\n          \n          \n            \n                                ffmpegCommand.replaceAll(password, \"********\"));", "author": "cpmeister", "createdAt": "2020-12-04T21:32:03Z", "path": "bundles/org.openhab.binding.ipcamera/src/main/java/org/openhab/binding/ipcamera/internal/Ffmpeg.java", "diffHunk": "@@ -169,7 +171,8 @@ public void run() {\n     public void startConverting() {\n         if (!ipCameraFfmpegThread.isAlive()) {\n             ipCameraFfmpegThread = new IpCameraFfmpegThread();\n-            logger.debug(\"Starting ffmpeg with this command now:{}\", ffmpegCommand);\n+            logger.debug(\"Starting ffmpeg with this command now:{}\",\n+                    ffmpegCommand.replaceAll(password, \"passwordRemoved\"));", "originalCommit": "bca198146376aea515e7ec040e8ed8f751ab0d10", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1293922d512b1487927eba0b0e2134ee1bd92c2e", "chunk": "diff --git a/bundles/org.openhab.binding.ipcamera/src/main/java/org/openhab/binding/ipcamera/internal/Ffmpeg.java b/bundles/org.openhab.binding.ipcamera/src/main/java/org/openhab/binding/ipcamera/internal/Ffmpeg.java\nindex d5e3cffa05..84ca9eb096 100644\n--- a/bundles/org.openhab.binding.ipcamera/src/main/java/org/openhab/binding/ipcamera/internal/Ffmpeg.java\n+++ b/bundles/org.openhab.binding.ipcamera/src/main/java/org/openhab/binding/ipcamera/internal/Ffmpeg.java\n\n@@ -172,7 +172,7 @@ public class Ffmpeg {\n         if (!ipCameraFfmpegThread.isAlive()) {\n             ipCameraFfmpegThread = new IpCameraFfmpegThread();\n             logger.debug(\"Starting ffmpeg with this command now:{}\",\n-                    ffmpegCommand.replaceAll(password, \"passwordRemoved\"));\n+                    ffmpegCommand.replaceAll(password, \"********\"));\n             ipCameraFfmpegThread.start();\n             running = true;\n             if (format.equals(FFmpegFormat.HLS)) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM5NTIzMQ==", "url": "https://github.com/openhab/openhab-addons/pull/9199#discussion_r536395231", "bodyText": ".toString() might be an expensive operation, so calling it twice when you only need to call it once is a bad practice. The way it was before only called it once. What were you trying to address here with this change?", "author": "cpmeister", "createdAt": "2020-12-04T21:40:13Z", "path": "bundles/org.openhab.binding.ipcamera/src/main/java/org/openhab/binding/ipcamera/internal/HikvisionHandler.java", "diffHunk": "@@ -64,18 +64,13 @@ public HikvisionHandler(ThingHandler handler, int nvrChannel) {\n     // This handles the incoming http replies back from the camera.\n     @Override\n     public void channelRead(@Nullable ChannelHandlerContext ctx, @Nullable Object msg) throws Exception {\n-        if (msg == null || ctx == null) {\n+        if (msg == null || ctx == null || msg.toString().isEmpty()) {\n             return;\n         }\n-        String content = \"\";\n-        int debounce = 3;\n         try {\n-            content = msg.toString();\n-            if (content.isEmpty()) {\n-                return;\n-            }\n+            int debounce = 3;\n+            String content = msg.toString();\n             logger.trace(\"HTTP Result back from camera is \\t:{}:\", content);\n-", "originalCommit": "bca198146376aea515e7ec040e8ed8f751ab0d10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjUxNjQxNg==", "url": "https://github.com/openhab/openhab-addons/pull/9199#discussion_r536516416", "bodyText": "FIXED: I looked into it and what I was trying to address does not happen anymore. I have removed it back to only calling it once, thanks for pointing it out.", "author": "Skinah", "createdAt": "2020-12-05T05:14:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM5NTIzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "7cae07ca51f222914b628badc12e366ce8c246e7", "chunk": "diff --git a/bundles/org.openhab.binding.ipcamera/src/main/java/org/openhab/binding/ipcamera/internal/HikvisionHandler.java b/bundles/org.openhab.binding.ipcamera/src/main/java/org/openhab/binding/ipcamera/internal/HikvisionHandler.java\nindex 97970777ff..bb819c0ac3 100644\n--- a/bundles/org.openhab.binding.ipcamera/src/main/java/org/openhab/binding/ipcamera/internal/HikvisionHandler.java\n+++ b/bundles/org.openhab.binding.ipcamera/src/main/java/org/openhab/binding/ipcamera/internal/HikvisionHandler.java\n\n@@ -64,7 +64,7 @@ public class HikvisionHandler extends ChannelDuplexHandler {\n     // This handles the incoming http replies back from the camera.\n     @Override\n     public void channelRead(@Nullable ChannelHandlerContext ctx, @Nullable Object msg) throws Exception {\n-        if (msg == null || ctx == null || msg.toString().isEmpty()) {\n+        if (msg == null || ctx == null) {\n             return;\n         }\n         try {\n"}}, {"oid": "1293922d512b1487927eba0b0e2134ee1bd92c2e", "url": "https://github.com/openhab/openhab-addons/commit/1293922d512b1487927eba0b0e2134ee1bd92c2e", "message": "Update bundles/org.openhab.binding.ipcamera/src/main/java/org/openhab/binding/ipcamera/internal/Ffmpeg.java\r\n\r\nSigned-off-by: Matthew Skinner <matt@pcmus.com>\n\nCo-authored-by: Connor Petty <mistercpp2000@gmail.com>", "committedDate": "2020-12-05T01:47:41Z", "type": "commit"}, {"oid": "7cae07ca51f222914b628badc12e366ce8c246e7", "url": "https://github.com/openhab/openhab-addons/commit/7cae07ca51f222914b628badc12e366ce8c246e7", "message": "Remove un-needed tostring()\n\n\nSigned-off-by: Matthew Skinner <matt@pcmus.com>", "committedDate": "2020-12-05T05:06:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjUxOTgxMA==", "url": "https://github.com/openhab/openhab-addons/pull/9199#discussion_r536519810", "bodyText": "Does this still return a future that you should wait for? Or do you not need to do that anymore?", "author": "cpmeister", "createdAt": "2020-12-05T05:39:22Z", "path": "bundles/org.openhab.binding.ipcamera/src/main/java/org/openhab/binding/ipcamera/internal/onvif/OnvifDiscovery.java", "diffHunk": "@@ -213,26 +215,21 @@ protected void channelRead0(@Nullable ChannelHandlerContext ctx, DatagramPacket\n                 }).option(ChannelOption.SO_BROADCAST, true).option(ChannelOption.SO_REUSEADDR, true)\n                 .option(ChannelOption.IP_MULTICAST_LOOP_DISABLED, false).option(ChannelOption.SO_RCVBUF, 2048)\n                 .option(ChannelOption.IP_MULTICAST_TTL, 255).option(ChannelOption.IP_MULTICAST_IF, networkInterface);\n-\n-        datagramChannel = (DatagramChannel) bootstrap.bind(localNetworkAddress).sync().channel();\n-        datagramChannel.joinGroup(multiCastAddress, networkInterface).sync();\n-        ChannelFuture chFuture;\n-        if (port == 1900) {\n-            String ssdp = \"M-SEARCH * HTTP/1.1\\n\" + \"HOST: 239.255.255.250:1900\\n\" + \"MAN: \\\"ssdp:discover\\\"\\n\"\n-                    + \"MX: 1\\n\" + \"ST: urn:dial-multiscreen-org:service:dial:1\\n\"\n-                    + \"USER-AGENT: Microsoft Edge/83.0.478.61 Windows\\n\" + \"\\n\" + \"\";\n-            ByteBuf ssdpProbeMessage = Unpooled.copiedBuffer(ssdp, 0, ssdp.length(), StandardCharsets.UTF_8);\n-            datagramPacket = new DatagramPacket(ssdpProbeMessage, multiCastAddress, localNetworkAddress);\n-            chFuture = datagramChannel.writeAndFlush(datagramPacket);\n-        } else {\n-            chFuture = datagramChannel.writeAndFlush(datagramPacket);\n+        ChannelGroup openChannels = new DefaultChannelGroup(GlobalEventExecutor.INSTANCE);\n+        for (NetworkInterface nic : nics) {\n+            DatagramChannel datagramChannel = (DatagramChannel) bootstrap.option(ChannelOption.IP_MULTICAST_IF, nic)\n+                    .bind(new InetSocketAddress(0)).sync().channel();\n+            datagramChannel\n+                    .joinGroup(new InetSocketAddress(InetAddress.getByName(\"239.255.255.250\"), 3702), networkInterface)\n+                    .sync();\n+            openChannels.add(datagramChannel);\n+        }\n+        if (!openChannels.isEmpty()) {\n+            openChannels.writeAndFlush(wsDiscovery());", "originalCommit": "7cae07ca51f222914b628badc12e366ce8c246e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjk1NTkwMA==", "url": "https://github.com/openhab/openhab-addons/pull/9199#discussion_r536955900", "bodyText": "I don\u2019t need to use a future as it gives no benefits and only increases code length.", "author": "Skinah", "createdAt": "2020-12-06T04:51:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjUxOTgxMA=="}], "type": "inlineReview", "revised_code": null}]}