{"pr_number": 7903, "pr_title": "[Robonect] Use global openHAB timezone for DateTime objects", "pr_createdAt": "2020-06-12T08:56:08Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/7903", "timeline": [{"oid": "ce778f72dcd243ffab32a615c3e84e5ee7e8da23", "url": "https://github.com/openhab/openhab-addons/commit/ce778f72dcd243ffab32a615c3e84e5ee7e8da23", "message": "[Robonect] Use global openHAB timezone for DateTime objects\n\nUse the timezone that has been configured by the user in openHAB settings\nfor all robonect messages instead of UTC.\n\nFixes #7848\n\nSigned-off-by: Stefan Triller <github@stefantriller.de>", "committedDate": "2020-06-12T08:55:28Z", "type": "commit"}, {"oid": "3d6be63be7fd8da4a94d6ba598e21dfbcb22c99a", "url": "https://github.com/openhab/openhab-addons/commit/3d6be63be7fd8da4a94d6ba598e21dfbcb22c99a", "message": "[robonect] Provide timezone configuration parameter on thing\n\nSigned-off-by: Stefan Triller <github@stefantriller.de>", "committedDate": "2020-06-12T14:03:38Z", "type": "commit"}, {"oid": "7ced56692ae29397b0cb8897a7fc8ffc00c48d94", "url": "https://github.com/openhab/openhab-addons/commit/7ced56692ae29397b0cb8897a7fc8ffc00c48d94", "message": "[robonect] Use openHAB timezone on error\n\nSigned-off-by: Stefan Triller <github@stefantriller.de>", "committedDate": "2020-06-12T14:32:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY3MDQwNw==", "url": "https://github.com/openhab/openhab-addons/pull/7903#discussion_r439670407", "bodyText": "This will throw an NPE if timeZoneString is null.", "author": "cpmeister", "createdAt": "2020-06-12T22:45:39Z", "path": "bundles/org.openhab.binding.robonect/src/main/java/org/openhab/binding/robonect/internal/handler/RobonectHandler.java", "diffHunk": "@@ -329,6 +345,16 @@ public void initialize() {\n         RobonectConfig robonectConfig = getConfigAs(RobonectConfig.class);\n         RobonectEndpoint endpoint = new RobonectEndpoint(robonectConfig.getHost(), robonectConfig.getUser(),\n                 robonectConfig.getPassword());\n+\n+        String timeZoneString = robonectConfig.getTimezone();\n+        try {\n+            timeZone = ZoneId.of(timeZoneString);", "originalCommit": "7ced56692ae29397b0cb8897a7fc8ffc00c48d94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTcyMjYzMQ==", "url": "https://github.com/openhab/openhab-addons/pull/7903#discussion_r439722631", "bodyText": "Thanks, good catch!\nI have fixed it.", "author": "t2000", "createdAt": "2020-06-13T08:51:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY3MDQwNw=="}], "type": "inlineReview", "revised_code": {"commit": "beb09bf852be0fb88cd2f31a92f51a5543ae2cfb", "chunk": "diff --git a/bundles/org.openhab.binding.robonect/src/main/java/org/openhab/binding/robonect/internal/handler/RobonectHandler.java b/bundles/org.openhab.binding.robonect/src/main/java/org/openhab/binding/robonect/internal/handler/RobonectHandler.java\nindex 422c155766..99b434586c 100644\n--- a/bundles/org.openhab.binding.robonect/src/main/java/org/openhab/binding/robonect/internal/handler/RobonectHandler.java\n+++ b/bundles/org.openhab.binding.robonect/src/main/java/org/openhab/binding/robonect/internal/handler/RobonectHandler.java\n\n@@ -348,7 +348,13 @@ public class RobonectHandler extends BaseThingHandler {\n \n         String timeZoneString = robonectConfig.getTimezone();\n         try {\n-            timeZone = ZoneId.of(timeZoneString);\n+            if (timeZoneString != null) {\n+                timeZone = ZoneId.of(timeZoneString);\n+            } else {\n+                logger.warn(\"No timezone provided, falling back to the default timezone configured in openHAB: '{}'\",\n+                        timeZoneProvider.getTimeZone());\n+                timeZone = timeZoneProvider.getTimeZone();\n+            }\n         } catch (DateTimeException e) {\n             logger.warn(\"Error setting timezone '{}', falling back to the default timezone configured in openHAB: '{}'\",\n                     timeZoneString, timeZoneProvider.getTimeZone(), e);\n"}}, {"oid": "beb09bf852be0fb88cd2f31a92f51a5543ae2cfb", "url": "https://github.com/openhab/openhab-addons/commit/beb09bf852be0fb88cd2f31a92f51a5543ae2cfb", "message": "[robonect] Fix NPE\n\nSigned-off-by: Stefan Triller <github@stefantriller.de>", "committedDate": "2020-06-13T08:51:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTc2NzEzOQ==", "url": "https://github.com/openhab/openhab-addons/pull/7903#discussion_r439767139", "bodyText": "I think instead of caching this value in a field, you might consider dynamically creating it every time since its value should fall back to the timeZoneProvider timezone whenever it isn't specified by the config.\nThe problem I see is that the value returned by timeZoneProvider might change over time if the user changes settings in runtime.\nSo any value returned by timeZoneProvider should never be cached since it might change at any time, without notification.", "author": "cpmeister", "createdAt": "2020-06-13T20:30:25Z", "path": "bundles/org.openhab.binding.robonect/src/main/java/org/openhab/binding/robonect/internal/handler/RobonectHandler.java", "diffHunk": "@@ -71,12 +74,16 @@\n     private ScheduledFuture<?> pollingJob;\n \n     private HttpClient httpClient;\n+    private TimeZoneProvider timeZoneProvider;\n+\n+    private ZoneId timeZone = ZoneId.of(\"Europe/Berlin\");", "originalCommit": "beb09bf852be0fb88cd2f31a92f51a5543ae2cfb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTc3NzMzNw==", "url": "https://github.com/openhab/openhab-addons/pull/7903#discussion_r439777337", "bodyText": "My suggestion is to more or less replace uses of timeZone with a new method getTimeZone().", "author": "cpmeister", "createdAt": "2020-06-13T23:25:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTc2NzEzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgxMjk3Mg==", "url": "https://github.com/openhab/openhab-addons/pull/7903#discussion_r439812972", "bodyText": "I haven't thought about this. thanks for pointing it out!\nI have added a commit to change this.", "author": "t2000", "createdAt": "2020-06-14T10:08:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTc2NzEzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI4MTAzOQ==", "url": "https://github.com/openhab/openhab-addons/pull/7903#discussion_r440281039", "bodyText": "I thought about this again and noticed that if you change the configuration of the thing, the handler gets restarted anyway, because it doesn't overwrite handleConfigurationUpdate and thus the BaseThingHandler#handleConfigurationUpdate will call dispose() and initialize(), so my previous implementation would also read the changed value within initialize().\nI leave it up to you, to include the commit with the change or to drop it during merge.", "author": "t2000", "createdAt": "2020-06-15T15:59:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTc2NzEzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI4NDU1NA==", "url": "https://github.com/openhab/openhab-addons/pull/7903#discussion_r440284554", "bodyText": "Edit: I decided to drop my commit because it was difficult to fix the tests (accessing the config ran into an NPE).", "author": "t2000", "createdAt": "2020-06-15T16:04:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTc2NzEzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM4Mjk4NQ==", "url": "https://github.com/openhab/openhab-addons/pull/7903#discussion_r440382985", "bodyText": "I was referring to the return value of timeZoneProvider changing during runtime. A change in the return value wouldn't notify the handler and it wouldn't restart the handler or binding in any way. The binding shouldn't save what timeZoneProvider return into a field.", "author": "cpmeister", "createdAt": "2020-06-15T19:00:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTc2NzEzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDYwNDU4MQ==", "url": "https://github.com/openhab/openhab-addons/pull/7903#discussion_r440604581", "bodyText": "Hmm, I think we are talking about two different things here:\n\nThe timezone of the thing and its fallbacks.\nThe timezone as it should be presented to the user.\n\nFor point 2 I am always using the currently configured time in convertUnitToDateTimeType()\n// we provide the time in the format as configured in the openHAB settings\n ZonedDateTime zdt = adjustedInstant.atZone(timeZoneProvider.getTimeZone());\n\nas its always requested from the timeZoneProvider.\nFor point 1. the information from the timeZoneProvider acts as a fallback only for the lifetime of the Thinghandler, or until someone sets the correct time on the thing (because then dispose and initialize will be called anyway.\nSo do you want me to change this, even if its just a fallback and even a warning is printed to the user to make him aware of that he should add the correct zone to his Thing configuration? I am fine with doing so, if you think its better. I just wanted to clarify things and see if I have understood you correctly.", "author": "t2000", "createdAt": "2020-06-16T06:03:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTc2NzEzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA1NTM3OA==", "url": "https://github.com/openhab/openhab-addons/pull/7903#discussion_r441055378", "bodyText": "I am fine with doing so, if you think its better. I just wanted to clarify things and see if I have understood you correctly.\n\nYep you have understood me correctly.", "author": "cpmeister", "createdAt": "2020-06-16T18:23:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTc2NzEzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYyNDcyOA==", "url": "https://github.com/openhab/openhab-addons/pull/7903#discussion_r441624728", "bodyText": "Great :)\ni have now changed it in a way that the warning about the not set timezone on the thing will only be printed once on the startup of the handler and if it is not set, I get it from the timezoneProvider at runtime for every call.", "author": "t2000", "createdAt": "2020-06-17T15:14:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTc2NzEzOQ=="}], "type": "inlineReview", "revised_code": {"commit": "75421753c9d3073c7378cb5ae4c99ecc662a8a93", "chunk": "diff --git a/bundles/org.openhab.binding.robonect/src/main/java/org/openhab/binding/robonect/internal/handler/RobonectHandler.java b/bundles/org.openhab.binding.robonect/src/main/java/org/openhab/binding/robonect/internal/handler/RobonectHandler.java\nindex 99b434586c..e1029cd755 100644\n--- a/bundles/org.openhab.binding.robonect/src/main/java/org/openhab/binding/robonect/internal/handler/RobonectHandler.java\n+++ b/bundles/org.openhab.binding.robonect/src/main/java/org/openhab/binding/robonect/internal/handler/RobonectHandler.java\n\n@@ -76,7 +76,7 @@ public class RobonectHandler extends BaseThingHandler {\n     private HttpClient httpClient;\n     private TimeZoneProvider timeZoneProvider;\n \n-    private ZoneId timeZone = ZoneId.of(\"Europe/Berlin\");\n+    private ZoneId timeZone;\n \n     private RobonectClient robonectClient;\n \n"}}, {"oid": "beb09bf852be0fb88cd2f31a92f51a5543ae2cfb", "url": "https://github.com/openhab/openhab-addons/commit/beb09bf852be0fb88cd2f31a92f51a5543ae2cfb", "message": "[robonect] Fix NPE\n\nSigned-off-by: Stefan Triller <github@stefantriller.de>", "committedDate": "2020-06-13T08:51:17Z", "type": "forcePushed"}, {"oid": "75421753c9d3073c7378cb5ae4c99ecc662a8a93", "url": "https://github.com/openhab/openhab-addons/commit/75421753c9d3073c7378cb5ae4c99ecc662a8a93", "message": "[robonect] Always get timezone from openHAB settings if not set on Thing\n\nSigned-off-by: Stefan Triller <github@stefantriller.de>", "committedDate": "2020-06-17T15:12:38Z", "type": "commit"}]}