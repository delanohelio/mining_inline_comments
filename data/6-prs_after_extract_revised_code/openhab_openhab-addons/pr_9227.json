{"pr_number": 9227, "pr_title": "[icalendar] Reload calendar file asynchronously", "pr_createdAt": "2020-12-04T19:29:59Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/9227", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM4NTYyNQ==", "url": "https://github.com/openhab/openhab-addons/pull/9227#discussion_r536385625", "bodyText": "Maybe it would be better to just let the scheduled pull task handle the asynchronous part instead?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            updateStatus(ThingStatus.UNKNOWN);\n          \n          \n            \n            \n          \n          \n            \n                            scheduler.submit(() -> {\n          \n          \n            \n                                // reload calendar file asynchronously\n          \n          \n            \n                                if (reloadCalendar()) {\n          \n          \n            \n                                    updateStatus(ThingStatus.ONLINE);\n          \n          \n            \n                                    updateStates();\n          \n          \n            \n                                    rescheduleCalendarStateUpdate();\n          \n          \n            \n                                } else {\n          \n          \n            \n                                    updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR,\n          \n          \n            \n                                            \"The calendar seems to be configured correctly, but the local copy of calendar could not be loaded.\");\n          \n          \n            \n                                }\n          \n          \n            \n                            });\n          \n          \n            \n                            pullJobFuture = scheduler.scheduleWithFixedDelay(regularPull, refreshTime, refreshTime,\n          \n          \n            \n                                    TimeUnit.MINUTES);\n          \n          \n            \n                            updateStatus(ThingStatus.UNKNOWN);\n          \n          \n            \n                            pullJobFuture = scheduler.scheduleWithFixedDelay(regularPull, 0, refreshTime,\n          \n          \n            \n                                    TimeUnit.MINUTES);", "author": "cpmeister", "createdAt": "2020-12-04T21:19:30Z", "path": "bundles/org.openhab.binding.icalendar/src/main/java/org/openhab/binding/icalendar/internal/handler/ICalendarHandler.java", "diffHunk": "@@ -154,14 +152,19 @@ public void initialize() {\n             }\n             final long refreshTime = refreshTimeBD.longValue();\n             if (calendarFile.isFile()) {\n-                if (reloadCalendar()) {\n-                    updateStatus(ThingStatus.ONLINE);\n-                    updateStates();\n-                    rescheduleCalendarStateUpdate();\n-                } else {\n-                    updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR,\n-                            \"The calendar seems to be configured correctly, but the local copy of calendar could not be loaded.\");\n-                }\n+                updateStatus(ThingStatus.UNKNOWN);\n+\n+                scheduler.submit(() -> {\n+                    // reload calendar file asynchronously\n+                    if (reloadCalendar()) {\n+                        updateStatus(ThingStatus.ONLINE);\n+                        updateStates();\n+                        rescheduleCalendarStateUpdate();\n+                    } else {\n+                        updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR,\n+                                \"The calendar seems to be configured correctly, but the local copy of calendar could not be loaded.\");\n+                    }\n+                });\n                 pullJobFuture = scheduler.scheduleWithFixedDelay(regularPull, refreshTime, refreshTime,\n                         TimeUnit.MINUTES);", "originalCommit": "02bd093d133e941609e3d10d08857b6fa4de91ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzEwOTgxNQ==", "url": "https://github.com/openhab/openhab-addons/pull/9227#discussion_r537109815", "bodyText": "I am not sure if that will work. IIRC downloading the calendar is not part of the pull job. We might want to ask @daMihe for his opinion.", "author": "cweitkamp", "createdAt": "2020-12-06T19:47:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM4NTYyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzExMzA1MA==", "url": "https://github.com/openhab/openhab-addons/pull/9227#discussion_r537113050", "bodyText": "Asynchronously loading the calendar works, it's already triggered by PullJob via CalendarUpdateListener.onCalendarUpdated() this way (regularly via scheduleWithFixedDelay). However, just using the PullJob for reloading may cause the calendar to be in OFFLINE state if e.g. being offline even if a cached copy exists. So i think this is not a good idea.", "author": "daMihe", "createdAt": "2020-12-06T20:05:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM4NTYyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI0NjA5Nw==", "url": "https://github.com/openhab/openhab-addons/pull/9227#discussion_r537246097", "bodyText": "Well this PR will put the calendar into an UNKNOWN state, which is a kind of offline state, while it loads the cached copy anyway. If we can assert that any stored copy of the calendar is a valid one then I can see allowing the binding to initially enter an ONLINE state if it finds a file is present already.", "author": "cpmeister", "createdAt": "2020-12-07T05:46:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM4NTYyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgzNDYzMg==", "url": "https://github.com/openhab/openhab-addons/pull/9227#discussion_r537834632", "bodyText": "Yes, sounds reasonable. I just saw that reloadCalendar() calls rescheduleCalendarStateUpdate() too which makes the second call inside the if superfluous. I will remove that too.", "author": "cweitkamp", "createdAt": "2020-12-07T21:09:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM4NTYyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg3MDE4MA==", "url": "https://github.com/openhab/openhab-addons/pull/9227#discussion_r537870180", "bodyText": "Yes this seems to be redundant. You can also remove the updateStatus inside the if as its already done in updateStates. I assume this went into code about time and after several changes.", "author": "daMihe", "createdAt": "2020-12-07T22:09:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM4NTYyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODU0MzU2MQ==", "url": "https://github.com/openhab/openhab-addons/pull/9227#discussion_r538543561", "bodyText": "Dine in 906c1c2.", "author": "cweitkamp", "createdAt": "2020-12-08T16:07:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM4NTYyNQ=="}], "type": "inlineReview", "revised_code": {"commit": "906c1c273faecf1a243199598b2b832554b4627d", "chunk": "diff --git a/bundles/org.openhab.binding.icalendar/src/main/java/org/openhab/binding/icalendar/internal/handler/ICalendarHandler.java b/bundles/org.openhab.binding.icalendar/src/main/java/org/openhab/binding/icalendar/internal/handler/ICalendarHandler.java\nindex b59763c23a..a32c22c79b 100644\n--- a/bundles/org.openhab.binding.icalendar/src/main/java/org/openhab/binding/icalendar/internal/handler/ICalendarHandler.java\n+++ b/bundles/org.openhab.binding.icalendar/src/main/java/org/openhab/binding/icalendar/internal/handler/ICalendarHandler.java\n\n@@ -152,14 +152,12 @@ public class ICalendarHandler extends BaseBridgeHandler implements CalendarUpdat\n             }\n             final long refreshTime = refreshTimeBD.longValue();\n             if (calendarFile.isFile()) {\n-                updateStatus(ThingStatus.UNKNOWN);\n+                updateStatus(ThingStatus.ONLINE);\n \n                 scheduler.submit(() -> {\n                     // reload calendar file asynchronously\n                     if (reloadCalendar()) {\n-                        updateStatus(ThingStatus.ONLINE);\n                         updateStates();\n-                        rescheduleCalendarStateUpdate();\n                     } else {\n                         updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR,\n                                 \"The calendar seems to be configured correctly, but the local copy of calendar could not be loaded.\");\n"}}, {"oid": "06003c1188f6d8a3b0ae55f68224be214ef2173f", "url": "https://github.com/openhab/openhab-addons/commit/06003c1188f6d8a3b0ae55f68224be214ef2173f", "message": "Reload calendar file asynchronously\n\nSigned-off-by: Christoph Weitkamp <github@christophweitkamp.de>", "committedDate": "2020-12-08T07:36:13Z", "type": "commit"}, {"oid": "906c1c273faecf1a243199598b2b832554b4627d", "url": "https://github.com/openhab/openhab-addons/commit/906c1c273faecf1a243199598b2b832554b4627d", "message": "Incorporated comments from review\n\nSigned-off-by: Christoph Weitkamp <github@christophweitkamp.de>", "committedDate": "2020-12-08T07:42:15Z", "type": "commit"}, {"oid": "906c1c273faecf1a243199598b2b832554b4627d", "url": "https://github.com/openhab/openhab-addons/commit/906c1c273faecf1a243199598b2b832554b4627d", "message": "Incorporated comments from review\n\nSigned-off-by: Christoph Weitkamp <github@christophweitkamp.de>", "committedDate": "2020-12-08T07:42:15Z", "type": "forcePushed"}]}