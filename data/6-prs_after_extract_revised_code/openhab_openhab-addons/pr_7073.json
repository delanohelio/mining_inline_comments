{"pr_number": 7073, "pr_title": "[bluetooth.bluez] Fix for bluez discovery scheduler death (#7072)", "pr_createdAt": "2020-02-27T01:10:49Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/7073", "timeline": [{"oid": "24aadfaca5fbbe5940041fbaae1033199926c5aa", "url": "https://github.com/openhab/openhab-addons/commit/24aadfaca5fbbe5940041fbaae1033199926c5aa", "message": "Fix for issue #7072\n\nSigned-off-by: Connor Petty <cpmeister@users.noreply.github.com>", "committedDate": "2020-02-27T00:54:56Z", "type": "commit"}, {"oid": "667d9151f0ce157b7a84c89096adc2f55c872aeb", "url": "https://github.com/openhab/openhab-addons/commit/667d9151f0ce157b7a84c89096adc2f55c872aeb", "message": "cleanup status error message\n\nSigned-off-by: Connor Petty <cpmeister@users.noreply.github.com>", "committedDate": "2020-02-27T01:10:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkyOTA3OQ==", "url": "https://github.com/openhab/openhab-addons/pull/7073#discussion_r384929079", "bodyText": "Why is this message parsing necessary? And I guess you need to check if the message is null before calling lastIndex()", "author": "J-N-K", "createdAt": "2020-02-27T06:07:11Z", "path": "bundles/org.openhab.binding.bluetooth.bluez/src/main/java/org/openhab/binding/bluetooth/bluez/handler/BlueZBridgeHandler.java", "diffHunk": "@@ -155,33 +155,48 @@ public void removeDiscoveryListener(@Nullable BluetoothDiscoveryListener listene\n     }\n \n     private void startDiscovery() {\n+        // we need to make sure the adapter is powered first\n+        if (!adapter.getPowered()) {\n+            adapter.setPowered(true);\n+        }\n         if (!adapter.getDiscovering()) {\n             adapter.setRssiDiscoveryFilter(-96);\n             adapter.startDiscovery();\n         }\n     }\n \n     private void refreshDevices() {\n-        logger.debug(\"Refreshing Bluetooth device list...\");\n-        List<tinyb.BluetoothDevice> tinybDevices = adapter.getDevices();\n-        logger.debug(\"Found {} Bluetooth devices.\", tinybDevices.size());\n-        for (tinyb.BluetoothDevice tinybDevice : tinybDevices) {\n-            BlueZBluetoothDevice device = getDevice(new BluetoothAddress(tinybDevice.getAddress()));\n-            device.updateTinybDevice(tinybDevice);\n-            notifyDiscoveryListeners(device);\n-        }\n-        // clean up orphaned entries\n-        synchronized (devices) {\n-            for (BlueZBluetoothDevice device : devices.values()) {\n-                if (shouldRemove(device)) {\n-                    logger.debug(\"Removing device '{}' due to inactivity\", device.getAddress());\n-                    device.dispose();\n-                    devices.remove(device.getAddress());\n+        try {\n+            logger.debug(\"Refreshing Bluetooth device list...\");\n+            List<tinyb.BluetoothDevice> tinybDevices = adapter.getDevices();\n+            logger.debug(\"Found {} Bluetooth devices.\", tinybDevices.size());\n+            for (tinyb.BluetoothDevice tinybDevice : tinybDevices) {\n+                BlueZBluetoothDevice device = getDevice(new BluetoothAddress(tinybDevice.getAddress()));\n+                device.updateTinybDevice(tinybDevice);\n+                notifyDiscoveryListeners(device);\n+            }\n+            // clean up orphaned entries\n+            synchronized (devices) {\n+                for (BlueZBluetoothDevice device : devices.values()) {\n+                    if (shouldRemove(device)) {\n+                        logger.debug(\"Removing device '{}' due to inactivity\", device.getAddress());\n+                        device.dispose();\n+                        devices.remove(device.getAddress());\n+                    }\n                 }\n             }\n+            // For whatever reason, bluez will sometimes turn off scanning. So we just make sure it keeps running.\n+            startDiscovery();\n+            // everything went fine, so lets switch to online\n+            updateStatus(ThingStatus.ONLINE);\n+        } catch (BluetoothException ex) {\n+            String message = ex.getMessage();", "originalCommit": "667d9151f0ce157b7a84c89096adc2f55c872aeb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzMDI2Ng==", "url": "https://github.com/openhab/openhab-addons/pull/7073#discussion_r384930266", "bodyText": "I chose to parse out the most user friendly part of the message since it would be displayed to the user. Otherwise it would look like tinyb.BluetoothException: GDBus.Error:org.bluez.Error.NotReady: Resource Not Ready. I'm parsing it so it just comes out to Resource Not Ready. But you are correct that I should null check so I will add that.", "author": "cpmeister", "createdAt": "2020-02-27T06:12:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkyOTA3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDk3NTE5Ng==", "url": "https://github.com/openhab/openhab-addons/pull/7073#discussion_r384975196", "bodyText": "In General I dislike string parsing in front of logging as it is done Always, no matter what log level is set. In this case however it happens only very rarely, therfore I'm fine with it.", "author": "J-N-K", "createdAt": "2020-02-27T08:29:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkyOTA3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "5522d7546c9454d24354474f9eaaeeebc103f866", "chunk": "diff --git a/bundles/org.openhab.binding.bluetooth.bluez/src/main/java/org/openhab/binding/bluetooth/bluez/handler/BlueZBridgeHandler.java b/bundles/org.openhab.binding.bluetooth.bluez/src/main/java/org/openhab/binding/bluetooth/bluez/handler/BlueZBridgeHandler.java\nindex bca154f896..e8f0ed2c45 100644\n--- a/bundles/org.openhab.binding.bluetooth.bluez/src/main/java/org/openhab/binding/bluetooth/bluez/handler/BlueZBridgeHandler.java\n+++ b/bundles/org.openhab.binding.bluetooth.bluez/src/main/java/org/openhab/binding/bluetooth/bluez/handler/BlueZBridgeHandler.java\n\n@@ -191,9 +191,11 @@ public class BlueZBridgeHandler extends BaseBridgeHandler implements BluetoothAd\n             updateStatus(ThingStatus.ONLINE);\n         } catch (BluetoothException ex) {\n             String message = ex.getMessage();\n-            int idx = message.lastIndexOf(':');\n-            if (idx != -1) {\n-                message = message.substring(idx).trim();\n+            if (message != null) {\n+                int idx = message.lastIndexOf(':');\n+                if (idx != -1) {\n+                    message = message.substring(idx).trim();\n+                }\n             }\n             updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR, message);\n         }\n"}}, {"oid": "5522d7546c9454d24354474f9eaaeeebc103f866", "url": "https://github.com/openhab/openhab-addons/commit/5522d7546c9454d24354474f9eaaeeebc103f866", "message": "Added null check\n\nSigned-off-by: Connor Petty <cpmeister@users.noreply.github.com>", "committedDate": "2020-02-27T06:13:50Z", "type": "commit"}]}