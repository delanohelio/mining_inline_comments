{"pr_number": 7201, "pr_title": "[neohub] fix blocking bug on socket read; improved error handling & logging", "pr_createdAt": "2020-03-21T11:20:36Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/7201", "timeline": [{"oid": "1bc1d669175ac2de26f297c84c697309a3ec6497", "url": "https://github.com/openhab/openhab-addons/commit/1bc1d669175ac2de26f297c84c697309a3ec6497", "message": "[neohub] prevent socket read from blocking; improved error handling and reporting\n\nSigned-off-by: Andrew Fiddian-Green <software@whitebear.ch>", "committedDate": "2020-03-21T11:10:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjAyNzc0Nw==", "url": "https://github.com/openhab/openhab-addons/pull/7201#discussion_r396027747", "bodyText": "Private?", "author": "cpmeister", "createdAt": "2020-03-21T20:47:35Z", "path": "bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubBindingConstants.java", "diffHunk": "@@ -116,5 +116,13 @@\n      */\n     public static final String VAL_OFF = \"Off\";\n     public static final String VAL_HEATING = \"Heating\";\n+    \n+    /*\n+     * logger message strings\n+     */\n+    private static final String PLEASE_REPORT_BUG = \"Unexpected situation - please report a bug: \";", "originalCommit": "1bc1d669175ac2de26f297c84c697309a3ec6497", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA4MjY5OA==", "url": "https://github.com/openhab/openhab-addons/pull/7201#discussion_r396082698", "bodyText": "Changed to public", "author": "andrewfg", "createdAt": "2020-03-22T11:29:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjAyNzc0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "a1651869cc96c39829d3c1db8336f071f63da32a", "chunk": "diff --git a/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubBindingConstants.java b/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubBindingConstants.java\nindex e7a20aa7a5..371fbeeda9 100644\n--- a/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubBindingConstants.java\n+++ b/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubBindingConstants.java\n\n@@ -120,7 +120,7 @@ public class NeoHubBindingConstants {\n     /*\n      * logger message strings\n      */\n-    private static final String PLEASE_REPORT_BUG = \"Unexpected situation - please report a bug: \";\n+    public static final String PLEASE_REPORT_BUG = \"Unexpected situation - please report a bug: \";\n     public static final String MSG_HUB_CONFIG = PLEASE_REPORT_BUG + \"hub needs to be initialized!\";\n     public static final String MSG_HUB_COMM = PLEASE_REPORT_BUG + \"error communicating with the hub!\";\n     public static final String MSG_FMT_POLL_ERR = \"Polling error: {}\";\n"}}, {"oid": "a1651869cc96c39829d3c1db8336f071f63da32a", "url": "https://github.com/openhab/openhab-addons/commit/a1651869cc96c39829d3c1db8336f071f63da32a", "message": "[neohub] fixed typo; responded to reviewer input\n\nSigned-off-by: Andrew Fiddian-Green <software@whitebear.ch>", "committedDate": "2020-03-22T11:20:43Z", "type": "commit"}, {"oid": "d55d0aca36fa04cbb6343ee092f67f97737de6f4", "url": "https://github.com/openhab/openhab-addons/commit/d55d0aca36fa04cbb6343ee092f67f97737de6f4", "message": "[neohub] fixed typo\n\nSigned-off-by: Andrew Fiddian-Green <software@whitebear.ch>", "committedDate": "2020-03-22T11:21:22Z", "type": "commit"}, {"oid": "6595713ee03edb9c5acbef99dbe7d57596f4353b", "url": "https://github.com/openhab/openhab-addons/commit/6595713ee03edb9c5acbef99dbe7d57596f4353b", "message": "[neohub] socket.sendMessage() is no longer synchronized, so we must synchronize access to cachedInfoResponse\n\nSigned-off-by: Andrew Fiddian-Green <software@whitebear.ch>", "committedDate": "2020-03-22T11:27:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUyMDY4MQ==", "url": "https://github.com/openhab/openhab-addons/pull/7201#discussion_r396520681", "bodyText": "Synchronization serves no purpose here since assigning a variable is an atomic operation. Please remove the synchronized block. If you really want to you can make cachedInfoResponse volatile.", "author": "cpmeister", "createdAt": "2020-03-23T15:06:14Z", "path": "bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java", "diffHunk": "@@ -179,25 +179,64 @@ public synchronized NeoHubReturnResult toNeoHubSendChannelValue(String commandSt\n      * \n      */\n     protected NeoHubInfoResponse fromNeoHubFetchPollingResponse() {\n-        if (socket == null || config == null) {\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.NONE);\n+        if (socket == null) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR);\n+            logger.warn(MSG_HUB_COMM);\n+            synchronized (this) {\n+                cachedInfoResponse = null;\n+            }", "originalCommit": "6595713ee03edb9c5acbef99dbe7d57596f4353b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU5NDkxOQ==", "url": "https://github.com/openhab/openhab-addons/pull/7201#discussion_r396594919", "bodyText": "Oh that\u2019s interesting. I come from a background in other compiled languages, where pointer assignments are not guaranteed to be atomic. But if Java has mechanisms to ensure atomicity, then I am very happy. I learned something new today.", "author": "andrewfg", "createdAt": "2020-03-23T16:43:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUyMDY4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYwMTE5Mg==", "url": "https://github.com/openhab/openhab-addons/pull/7201#discussion_r396601192", "bodyText": "Well adding volatile truly makes it atomic, but I think the code here would work just fine without volatile.", "author": "cpmeister", "createdAt": "2020-03-23T16:51:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUyMDY4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIxOTgxNQ==", "url": "https://github.com/openhab/openhab-addons/pull/7201#discussion_r397219815", "bodyText": "After careful thought, I realised that cachedInfoResponse is not actually needed, so I have re-coded to eliminate it entirely.", "author": "andrewfg", "createdAt": "2020-03-24T14:59:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUyMDY4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "f2fed41b4b3b6c4684fa6c009a0f5766052544b7", "chunk": "diff --git a/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java b/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java\nindex 1a2bf91853..ba5edd8484 100644\n--- a/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java\n+++ b/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java\n\n@@ -179,21 +175,8 @@ public class NeoHubHandler extends BaseBridgeHandler {\n      * \n      */\n     protected NeoHubInfoResponse fromNeoHubFetchPollingResponse() {\n-        if (socket == null) {\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR);\n-            logger.warn(MSG_HUB_COMM);\n-            synchronized (this) {\n-                cachedInfoResponse = null;\n-            }\n-            return null;\n-        }\n-\n-        if (config == null) {\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR);\n+        if (socket == null || config == null) {\n             logger.warn(MSG_HUB_CONFIG);\n-            synchronized (this) {\n-                cachedInfoResponse = null;\n-            }\n             return null;\n         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUyMDgxMQ==", "url": "https://github.com/openhab/openhab-addons/pull/7201#discussion_r396520811", "bodyText": "see above", "author": "cpmeister", "createdAt": "2020-03-23T15:06:26Z", "path": "bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java", "diffHunk": "@@ -179,25 +179,64 @@ public synchronized NeoHubReturnResult toNeoHubSendChannelValue(String commandSt\n      * \n      */\n     protected NeoHubInfoResponse fromNeoHubFetchPollingResponse() {\n-        if (socket == null || config == null) {\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.NONE);\n+        if (socket == null) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR);\n+            logger.warn(MSG_HUB_COMM);\n+            synchronized (this) {\n+                cachedInfoResponse = null;\n+            }\n+            return null;\n+        }\n+\n+        if (config == null) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR);\n+            logger.warn(MSG_HUB_CONFIG);\n+            synchronized (this) {\n+                cachedInfoResponse = null;\n+            }", "originalCommit": "6595713ee03edb9c5acbef99dbe7d57596f4353b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIyMDI5Ng==", "url": "https://github.com/openhab/openhab-addons/pull/7201#discussion_r397220296", "bodyText": "eliminated cachedInfoResponse", "author": "andrewfg", "createdAt": "2020-03-24T14:59:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUyMDgxMQ=="}], "type": "inlineReview", "revised_code": {"commit": "f2fed41b4b3b6c4684fa6c009a0f5766052544b7", "chunk": "diff --git a/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java b/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java\nindex 1a2bf91853..ba5edd8484 100644\n--- a/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java\n+++ b/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java\n\n@@ -179,21 +175,8 @@ public class NeoHubHandler extends BaseBridgeHandler {\n      * \n      */\n     protected NeoHubInfoResponse fromNeoHubFetchPollingResponse() {\n-        if (socket == null) {\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR);\n-            logger.warn(MSG_HUB_COMM);\n-            synchronized (this) {\n-                cachedInfoResponse = null;\n-            }\n-            return null;\n-        }\n-\n-        if (config == null) {\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR);\n+        if (socket == null || config == null) {\n             logger.warn(MSG_HUB_CONFIG);\n-            synchronized (this) {\n-                cachedInfoResponse = null;\n-            }\n             return null;\n         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUyMDg3Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7201#discussion_r396520873", "bodyText": "see above", "author": "cpmeister", "createdAt": "2020-03-23T15:06:32Z", "path": "bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java", "diffHunk": "@@ -179,25 +179,64 @@ public synchronized NeoHubReturnResult toNeoHubSendChannelValue(String commandSt\n      * \n      */\n     protected NeoHubInfoResponse fromNeoHubFetchPollingResponse() {\n-        if (socket == null || config == null) {\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.NONE);\n+        if (socket == null) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR);\n+            logger.warn(MSG_HUB_COMM);\n+            synchronized (this) {\n+                cachedInfoResponse = null;\n+            }\n+            return null;\n+        }\n+\n+        if (config == null) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR);\n+            logger.warn(MSG_HUB_CONFIG);\n+            synchronized (this) {\n+                cachedInfoResponse = null;\n+            }\n             return null;\n         }\n \n         try {\n             @Nullable\n             String response = socket.sendMessage(CMD_CODE_INFO);\n+            \n+            NeoHubInfoResponse newInfoResponse = NeoHubInfoResponse.createInfoResponse(response);\n+\n+            if (newInfoResponse == null) {\n+                logger.warn(MSG_FMT_POLL_ERR, \"failed to create InfoResponse\");\n+                updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR);\n+                synchronized (this) {\n+                    cachedInfoResponse = null;\n+                }", "originalCommit": "6595713ee03edb9c5acbef99dbe7d57596f4353b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIyMDUzOA==", "url": "https://github.com/openhab/openhab-addons/pull/7201#discussion_r397220538", "bodyText": "eliminated cachedInfoResponse", "author": "andrewfg", "createdAt": "2020-03-24T15:00:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUyMDg3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "f2fed41b4b3b6c4684fa6c009a0f5766052544b7", "chunk": "diff --git a/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java b/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java\nindex 1a2bf91853..ba5edd8484 100644\n--- a/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java\n+++ b/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java\n\n@@ -179,21 +175,8 @@ public class NeoHubHandler extends BaseBridgeHandler {\n      * \n      */\n     protected NeoHubInfoResponse fromNeoHubFetchPollingResponse() {\n-        if (socket == null) {\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR);\n-            logger.warn(MSG_HUB_COMM);\n-            synchronized (this) {\n-                cachedInfoResponse = null;\n-            }\n-            return null;\n-        }\n-\n-        if (config == null) {\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR);\n+        if (socket == null || config == null) {\n             logger.warn(MSG_HUB_CONFIG);\n-            synchronized (this) {\n-                cachedInfoResponse = null;\n-            }\n             return null;\n         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUyMTQ2Mg==", "url": "https://github.com/openhab/openhab-addons/pull/7201#discussion_r396521462", "bodyText": "see above", "author": "cpmeister", "createdAt": "2020-03-23T15:07:22Z", "path": "bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java", "diffHunk": "@@ -179,25 +179,64 @@ public synchronized NeoHubReturnResult toNeoHubSendChannelValue(String commandSt\n      * \n      */\n     protected NeoHubInfoResponse fromNeoHubFetchPollingResponse() {\n-        if (socket == null || config == null) {\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.NONE);\n+        if (socket == null) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR);\n+            logger.warn(MSG_HUB_COMM);\n+            synchronized (this) {\n+                cachedInfoResponse = null;\n+            }\n+            return null;\n+        }\n+\n+        if (config == null) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR);\n+            logger.warn(MSG_HUB_CONFIG);\n+            synchronized (this) {\n+                cachedInfoResponse = null;\n+            }\n             return null;\n         }\n \n         try {\n             @Nullable\n             String response = socket.sendMessage(CMD_CODE_INFO);\n+            \n+            NeoHubInfoResponse newInfoResponse = NeoHubInfoResponse.createInfoResponse(response);\n+\n+            if (newInfoResponse == null) {\n+                logger.warn(MSG_FMT_POLL_ERR, \"failed to create InfoResponse\");\n+                updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR);\n+                synchronized (this) {\n+                    cachedInfoResponse = null;\n+                }\n+                return null;\n+            }\n \n-            lastInfoResponse = NeoHubInfoResponse.createInfoResponse(response);\n+            if (newInfoResponse.getDevices() == null) {\n+                logger.warn(MSG_FMT_POLL_ERR, \"no devices found\");\n+                updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR);\n+                synchronized (this) {\n+                    cachedInfoResponse = null;\n+                }", "originalCommit": "6595713ee03edb9c5acbef99dbe7d57596f4353b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIyMDcxNQ==", "url": "https://github.com/openhab/openhab-addons/pull/7201#discussion_r397220715", "bodyText": "eliminated cachedInfoResponse", "author": "andrewfg", "createdAt": "2020-03-24T15:00:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUyMTQ2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "f2fed41b4b3b6c4684fa6c009a0f5766052544b7", "chunk": "diff --git a/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java b/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java\nindex 1a2bf91853..ba5edd8484 100644\n--- a/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java\n+++ b/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java\n\n@@ -179,21 +175,8 @@ public class NeoHubHandler extends BaseBridgeHandler {\n      * \n      */\n     protected NeoHubInfoResponse fromNeoHubFetchPollingResponse() {\n-        if (socket == null) {\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR);\n-            logger.warn(MSG_HUB_COMM);\n-            synchronized (this) {\n-                cachedInfoResponse = null;\n-            }\n-            return null;\n-        }\n-\n-        if (config == null) {\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR);\n+        if (socket == null || config == null) {\n             logger.warn(MSG_HUB_CONFIG);\n-            synchronized (this) {\n-                cachedInfoResponse = null;\n-            }\n             return null;\n         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUyMTU5OQ==", "url": "https://github.com/openhab/openhab-addons/pull/7201#discussion_r396521599", "bodyText": "see above", "author": "cpmeister", "createdAt": "2020-03-23T15:07:33Z", "path": "bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java", "diffHunk": "@@ -179,25 +179,64 @@ public synchronized NeoHubReturnResult toNeoHubSendChannelValue(String commandSt\n      * \n      */\n     protected NeoHubInfoResponse fromNeoHubFetchPollingResponse() {\n-        if (socket == null || config == null) {\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.NONE);\n+        if (socket == null) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR);\n+            logger.warn(MSG_HUB_COMM);\n+            synchronized (this) {\n+                cachedInfoResponse = null;\n+            }\n+            return null;\n+        }\n+\n+        if (config == null) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR);\n+            logger.warn(MSG_HUB_CONFIG);\n+            synchronized (this) {\n+                cachedInfoResponse = null;\n+            }\n             return null;\n         }\n \n         try {\n             @Nullable\n             String response = socket.sendMessage(CMD_CODE_INFO);\n+            \n+            NeoHubInfoResponse newInfoResponse = NeoHubInfoResponse.createInfoResponse(response);\n+\n+            if (newInfoResponse == null) {\n+                logger.warn(MSG_FMT_POLL_ERR, \"failed to create InfoResponse\");\n+                updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR);\n+                synchronized (this) {\n+                    cachedInfoResponse = null;\n+                }\n+                return null;\n+            }\n \n-            lastInfoResponse = NeoHubInfoResponse.createInfoResponse(response);\n+            if (newInfoResponse.getDevices() == null) {\n+                logger.warn(MSG_FMT_POLL_ERR, \"no devices found\");\n+                updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR);\n+                synchronized (this) {\n+                    cachedInfoResponse = null;\n+                }\n+                return null;\n+            }\n+\n+            synchronized (this) {\n+                cachedInfoResponse = newInfoResponse; \n+            }", "originalCommit": "6595713ee03edb9c5acbef99dbe7d57596f4353b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIyMDg0Nw==", "url": "https://github.com/openhab/openhab-addons/pull/7201#discussion_r397220847", "bodyText": "eliminated cachedInfoResponse", "author": "andrewfg", "createdAt": "2020-03-24T15:00:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUyMTU5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "f2fed41b4b3b6c4684fa6c009a0f5766052544b7", "chunk": "diff --git a/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java b/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java\nindex 1a2bf91853..ba5edd8484 100644\n--- a/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java\n+++ b/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java\n\n@@ -179,21 +175,8 @@ public class NeoHubHandler extends BaseBridgeHandler {\n      * \n      */\n     protected NeoHubInfoResponse fromNeoHubFetchPollingResponse() {\n-        if (socket == null) {\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR);\n-            logger.warn(MSG_HUB_COMM);\n-            synchronized (this) {\n-                cachedInfoResponse = null;\n-            }\n-            return null;\n-        }\n-\n-        if (config == null) {\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR);\n+        if (socket == null || config == null) {\n             logger.warn(MSG_HUB_CONFIG);\n-            synchronized (this) {\n-                cachedInfoResponse = null;\n-            }\n             return null;\n         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUyMTY4Ng==", "url": "https://github.com/openhab/openhab-addons/pull/7201#discussion_r396521686", "bodyText": "see above", "author": "cpmeister", "createdAt": "2020-03-23T15:07:40Z", "path": "bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java", "diffHunk": "@@ -179,25 +179,64 @@ public synchronized NeoHubReturnResult toNeoHubSendChannelValue(String commandSt\n      * \n      */\n     protected NeoHubInfoResponse fromNeoHubFetchPollingResponse() {\n-        if (socket == null || config == null) {\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.NONE);\n+        if (socket == null) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR);\n+            logger.warn(MSG_HUB_COMM);\n+            synchronized (this) {\n+                cachedInfoResponse = null;\n+            }\n+            return null;\n+        }\n+\n+        if (config == null) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR);\n+            logger.warn(MSG_HUB_CONFIG);\n+            synchronized (this) {\n+                cachedInfoResponse = null;\n+            }\n             return null;\n         }\n \n         try {\n             @Nullable\n             String response = socket.sendMessage(CMD_CODE_INFO);\n+            \n+            NeoHubInfoResponse newInfoResponse = NeoHubInfoResponse.createInfoResponse(response);\n+\n+            if (newInfoResponse == null) {\n+                logger.warn(MSG_FMT_POLL_ERR, \"failed to create InfoResponse\");\n+                updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR);\n+                synchronized (this) {\n+                    cachedInfoResponse = null;\n+                }\n+                return null;\n+            }\n \n-            lastInfoResponse = NeoHubInfoResponse.createInfoResponse(response);\n+            if (newInfoResponse.getDevices() == null) {\n+                logger.warn(MSG_FMT_POLL_ERR, \"no devices found\");\n+                updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR);\n+                synchronized (this) {\n+                    cachedInfoResponse = null;\n+                }\n+                return null;\n+            }\n+\n+            synchronized (this) {\n+                cachedInfoResponse = newInfoResponse; \n+            }\n \n             if (getThing().getStatus() != ThingStatus.ONLINE) {\n                 updateStatus(ThingStatus.ONLINE, ThingStatusDetail.NONE);\n             }\n \n-            return lastInfoResponse;\n+            return newInfoResponse;\n+\n         } catch (Exception e) {\n-            logger.warn(\"set value error \\\"{}\\\"\", e.getMessage());\n+            logger.warn(MSG_FMT_POLL_ERR, e.getMessage());\n             updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR);\n+            synchronized (this) {\n+                cachedInfoResponse = null;\n+            }", "originalCommit": "6595713ee03edb9c5acbef99dbe7d57596f4353b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIyMTAxNg==", "url": "https://github.com/openhab/openhab-addons/pull/7201#discussion_r397221016", "bodyText": "eliminated cachedInfoResponse", "author": "andrewfg", "createdAt": "2020-03-24T15:00:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUyMTY4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "f2fed41b4b3b6c4684fa6c009a0f5766052544b7", "chunk": "diff --git a/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java b/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java\nindex 1a2bf91853..ba5edd8484 100644\n--- a/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java\n+++ b/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java\n\n@@ -179,21 +175,8 @@ public class NeoHubHandler extends BaseBridgeHandler {\n      * \n      */\n     protected NeoHubInfoResponse fromNeoHubFetchPollingResponse() {\n-        if (socket == null) {\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR);\n-            logger.warn(MSG_HUB_COMM);\n-            synchronized (this) {\n-                cachedInfoResponse = null;\n-            }\n-            return null;\n-        }\n-\n-        if (config == null) {\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR);\n+        if (socket == null || config == null) {\n             logger.warn(MSG_HUB_CONFIG);\n-            synchronized (this) {\n-                cachedInfoResponse = null;\n-            }\n             return null;\n         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUyMzAxMw==", "url": "https://github.com/openhab/openhab-addons/pull/7201#discussion_r396523013", "bodyText": "Synchronization isn't provided the thread safety here, instead it is the fact you are assigning cachedInfoResponse to a local variable that is giving you the thread safety. So please remove the synchronized block.", "author": "cpmeister", "createdAt": "2020-03-23T15:09:24Z", "path": "bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java", "diffHunk": "@@ -209,15 +248,20 @@ protected NeoHubInfoResponse fromNeoHubFetchPollingResponse() {\n      */\n     private synchronized void lazyPollingSchedulerExecute() {\n         fromNeoHubFetchPollingResponse();\n+        \n+        NeoHubInfoResponse myInfoResponse; \n+        synchronized (this) {\n+            myInfoResponse = cachedInfoResponse;\n+        }", "originalCommit": "6595713ee03edb9c5acbef99dbe7d57596f4353b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIyMTE5Mg==", "url": "https://github.com/openhab/openhab-addons/pull/7201#discussion_r397221192", "bodyText": "eliminated cachedInfoResponse", "author": "andrewfg", "createdAt": "2020-03-24T15:00:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUyMzAxMw=="}], "type": "inlineReview", "revised_code": {"commit": "f2fed41b4b3b6c4684fa6c009a0f5766052544b7", "chunk": "diff --git a/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java b/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java\nindex 1a2bf91853..ba5edd8484 100644\n--- a/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java\n+++ b/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java\n\n@@ -247,21 +217,16 @@ public class NeoHubHandler extends BaseBridgeHandler {\n      * handlers\n      */\n     private synchronized void lazyPollingSchedulerExecute() {\n-        fromNeoHubFetchPollingResponse();\n-        \n-        NeoHubInfoResponse myInfoResponse; \n-        synchronized (this) {\n-            myInfoResponse = cachedInfoResponse;\n-        }\n+        NeoHubInfoResponse infoResponse = fromNeoHubFetchPollingResponse(); \n \n-        if (myInfoResponse != null) {\n+        if (infoResponse != null) {\n             List<Thing> children = getThing().getThings();\n \n             // dispatch myInfoResponse to each of the hub's owned devices ..\n             for (Thing child : children) {\n                 ThingHandler device = child.getHandler();\n                 if (device instanceof NeoBaseHandler) {\n-                    ((NeoBaseHandler) device).toBaseSendPollResponse(this, myInfoResponse);\n+                    ((NeoBaseHandler) device).toBaseSendPollResponse(infoResponse);\n                 }\n             }\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUyNDIxMA==", "url": "https://github.com/openhab/openhab-addons/pull/7201#discussion_r396524210", "bodyText": "What you should do here instead is assign cachedInfoResponse to a local variable THEN null check the variable. These two synchronized blocks aren't doing any good here.", "author": "cpmeister", "createdAt": "2020-03-23T15:10:54Z", "path": "bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java", "diffHunk": "@@ -244,10 +288,18 @@ private void fastPollingSchedulerExecute() {\n      * \n      */\n     public boolean isConfigured(String deviceName) {\n-        if (lastInfoResponse == null) {\n+        boolean noInfoResponse;\n+        synchronized (this) {\n+            noInfoResponse = cachedInfoResponse == null;\n+        }\n+        if (noInfoResponse) {\n             fromNeoHubFetchPollingResponse();\n         }\n-        return lastInfoResponse != null && lastInfoResponse.getDeviceInfo(deviceName) != null;\n+        NeoHubInfoResponse myInfoResponse;\n+        synchronized (this) {\n+            myInfoResponse = cachedInfoResponse;\n+        }\n+        return myInfoResponse != null && myInfoResponse.getDeviceInfo(deviceName) != null;", "originalCommit": "6595713ee03edb9c5acbef99dbe7d57596f4353b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIyMTQyOA==", "url": "https://github.com/openhab/openhab-addons/pull/7201#discussion_r397221428", "bodyText": "eliminated cachedInfoResponse", "author": "andrewfg", "createdAt": "2020-03-24T15:01:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUyNDIxMA=="}], "type": "inlineReview", "revised_code": {"commit": "f2fed41b4b3b6c4684fa6c009a0f5766052544b7", "chunk": "diff --git a/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java b/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java\nindex 1a2bf91853..ba5edd8484 100644\n--- a/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java\n+++ b/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java\n\n@@ -281,41 +246,4 @@ public class NeoHubHandler extends BaseBridgeHandler {\n         }\n     }\n \n-    /**\n-     * determine if the particular device name is configured in the hub\n-     * \n-     * @return the device is fully configured\n-     * \n-     */\n-    public boolean isConfigured(String deviceName) {\n-        boolean noInfoResponse;\n-        synchronized (this) {\n-            noInfoResponse = cachedInfoResponse == null;\n-        }\n-        if (noInfoResponse) {\n-            fromNeoHubFetchPollingResponse();\n-        }\n-        NeoHubInfoResponse myInfoResponse;\n-        synchronized (this) {\n-            myInfoResponse = cachedInfoResponse;\n-        }\n-        return myInfoResponse != null && myInfoResponse.getDeviceInfo(deviceName) != null;\n-    }\n-\n-    /**\n-     * determine if the particular device name is communicating with the hub\n-     * \n-     * @return the device is fully configured and talking to the hub\n-     * \n-     */\n-    public boolean isOnline(String deviceName) {\n-        DeviceInfo deviceInfo;\n-        NeoHubInfoResponse myInfoResponse; \n-        synchronized (this) {\n-            myInfoResponse = cachedInfoResponse;\n-        }\n-        return isConfigured(deviceName) && myInfoResponse != null && \n-                (deviceInfo = myInfoResponse.getDeviceInfo(deviceName)) != null\n-                && !deviceInfo.isOffline();\n-    }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUyNDQ1OA==", "url": "https://github.com/openhab/openhab-addons/pull/7201#discussion_r396524458", "bodyText": "see other comment", "author": "cpmeister", "createdAt": "2020-03-23T15:11:11Z", "path": "bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java", "diffHunk": "@@ -258,7 +310,12 @@ public boolean isConfigured(String deviceName) {\n      */\n     public boolean isOnline(String deviceName) {\n         DeviceInfo deviceInfo;\n-        return isConfigured(deviceName) && (deviceInfo = lastInfoResponse.getDeviceInfo(deviceName)) != null\n+        NeoHubInfoResponse myInfoResponse; \n+        synchronized (this) {\n+            myInfoResponse = cachedInfoResponse;\n+        }", "originalCommit": "6595713ee03edb9c5acbef99dbe7d57596f4353b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIyMTU3Mg==", "url": "https://github.com/openhab/openhab-addons/pull/7201#discussion_r397221572", "bodyText": "eliminated cachedInfoResponse", "author": "andrewfg", "createdAt": "2020-03-24T15:01:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUyNDQ1OA=="}], "type": "inlineReview", "revised_code": {"commit": "f2fed41b4b3b6c4684fa6c009a0f5766052544b7", "chunk": "diff --git a/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java b/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java\nindex 1a2bf91853..ba5edd8484 100644\n--- a/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java\n+++ b/bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java\n\n@@ -281,41 +246,4 @@ public class NeoHubHandler extends BaseBridgeHandler {\n         }\n     }\n \n-    /**\n-     * determine if the particular device name is configured in the hub\n-     * \n-     * @return the device is fully configured\n-     * \n-     */\n-    public boolean isConfigured(String deviceName) {\n-        boolean noInfoResponse;\n-        synchronized (this) {\n-            noInfoResponse = cachedInfoResponse == null;\n-        }\n-        if (noInfoResponse) {\n-            fromNeoHubFetchPollingResponse();\n-        }\n-        NeoHubInfoResponse myInfoResponse;\n-        synchronized (this) {\n-            myInfoResponse = cachedInfoResponse;\n-        }\n-        return myInfoResponse != null && myInfoResponse.getDeviceInfo(deviceName) != null;\n-    }\n-\n-    /**\n-     * determine if the particular device name is communicating with the hub\n-     * \n-     * @return the device is fully configured and talking to the hub\n-     * \n-     */\n-    public boolean isOnline(String deviceName) {\n-        DeviceInfo deviceInfo;\n-        NeoHubInfoResponse myInfoResponse; \n-        synchronized (this) {\n-            myInfoResponse = cachedInfoResponse;\n-        }\n-        return isConfigured(deviceName) && myInfoResponse != null && \n-                (deviceInfo = myInfoResponse.getDeviceInfo(deviceName)) != null\n-                && !deviceInfo.isOffline();\n-    }\n }\n"}}, {"oid": "f2fed41b4b3b6c4684fa6c009a0f5766052544b7", "url": "https://github.com/openhab/openhab-addons/commit/f2fed41b4b3b6c4684fa6c009a0f5766052544b7", "message": "[neohub] eliminated dependency on having a cachedInfoResponse\n\nSigned-off-by: Andrew Fiddian-Green <software@whitebear.ch>", "committedDate": "2020-03-24T14:56:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUwNDYwMg==", "url": "https://github.com/openhab/openhab-addons/pull/7201#discussion_r397504602", "bodyText": "why are you removing this updateStatus?", "author": "cpmeister", "createdAt": "2020-03-24T22:39:46Z", "path": "bundles/org.openhab.binding.neohub/src/main/java/org/openhab/binding/neohub/internal/NeoHubHandler.java", "diffHunk": "@@ -180,23 +176,36 @@ public synchronized NeoHubReturnResult toNeoHubSendChannelValue(String commandSt\n      */\n     protected NeoHubInfoResponse fromNeoHubFetchPollingResponse() {\n         if (socket == null || config == null) {\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.NONE);", "originalCommit": "f2fed41b4b3b6c4684fa6c009a0f5766052544b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc2Njc4Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7201#discussion_r397766783", "bodyText": "It is just a question of being consistent. The binding has two functions: a) polling/reading from the bridge, and b) issuing/writing commands to the bridge. The polling function reads states from the bridge, and updates the Thing and Channel states in OH accordingly. Whereas the command function responds to commands from OH and writes states to the bridge. As a general principle updateStatus should be done in the polling (read states) part of the code. The code that I modified here is part of the command (write states) function, so to be consistent it should NOT be changing the Thing status. It is not a big deal if we eliminate the updateStatus here, because the respective error will anyway always be picked up on the next polling cycle.", "author": "andrewfg", "createdAt": "2020-03-25T10:57:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUwNDYwMg=="}], "type": "inlineReview", "revised_code": null}]}