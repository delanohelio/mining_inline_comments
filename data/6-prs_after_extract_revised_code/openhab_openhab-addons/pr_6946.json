{"pr_number": 6946, "pr_title": "[mqtt] Fix increment commands in PercentageValue.", "pr_createdAt": "2020-02-01T07:12:06Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/6946", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc2ODU3MQ==", "url": "https://github.com/openhab/openhab-addons/pull/6946#discussion_r373768571", "bodyText": "Do we have to calculate this every time?\nCan't this be a member variable?", "author": "jochen314", "createdAt": "2020-02-01T09:19:38Z", "path": "bundles/org.openhab.binding.mqtt.generic/src/main/java/org/openhab/binding/mqtt/generic/values/PercentageValue.java", "diffHunk": "@@ -95,12 +95,13 @@ public void update(Command command) throws IllegalArgumentException {\n         } else //\n                // Increase or decrease by \"step\"\n         if (command instanceof IncreaseDecreaseType) {\n+            final BigDecimal stepPercent = step.multiply(HUNDRED).divide(span, MathContext.DECIMAL128);", "originalCommit": "139c7cc498a2055229fe2cebf154845051869eed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzIyMQ==", "url": "https://github.com/openhab/openhab-addons/pull/6946#discussion_r373797221", "bodyText": "Done", "author": "scarito", "createdAt": "2020-02-01T19:22:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc2ODU3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "c157704d6f109fe5c211b25e3b63d0f425fda5b1", "chunk": "diff --git a/bundles/org.openhab.binding.mqtt.generic/src/main/java/org/openhab/binding/mqtt/generic/values/PercentageValue.java b/bundles/org.openhab.binding.mqtt.generic/src/main/java/org/openhab/binding/mqtt/generic/values/PercentageValue.java\nindex d77b067768..38b23122e2 100644\n--- a/bundles/org.openhab.binding.mqtt.generic/src/main/java/org/openhab/binding/mqtt/generic/values/PercentageValue.java\n+++ b/bundles/org.openhab.binding.mqtt.generic/src/main/java/org/openhab/binding/mqtt/generic/values/PercentageValue.java\n\n@@ -95,7 +97,6 @@ public class PercentageValue extends Value {\n         } else //\n                // Increase or decrease by \"step\"\n         if (command instanceof IncreaseDecreaseType) {\n-            final BigDecimal stepPercent = step.multiply(HUNDRED).divide(span, MathContext.DECIMAL128);\n             if (((IncreaseDecreaseType) command) == IncreaseDecreaseType.INCREASE) {\n                 final BigDecimal v = oldvalue.toBigDecimal().add(stepPercent);\n                 state = v.compareTo(HUNDRED) <= 0 ? new PercentType(v) : PercentType.HUNDRED;\n"}}, {"oid": "c157704d6f109fe5c211b25e3b63d0f425fda5b1", "url": "https://github.com/openhab/openhab-addons/commit/c157704d6f109fe5c211b25e3b63d0f425fda5b1", "message": "[mqtt] Fix increment commands in PercentageValue.\n\nConvert step size to percentage before using with\nINCREASE/DECREASE/UP/DOWN commands.  The raw min, max,\nand step size were being used with the percentage value.\n\nSigned-off-by: Michael Scarito <ms.github@mit.edu>", "committedDate": "2020-02-01T19:21:10Z", "type": "commit"}, {"oid": "c157704d6f109fe5c211b25e3b63d0f425fda5b1", "url": "https://github.com/openhab/openhab-addons/commit/c157704d6f109fe5c211b25e3b63d0f425fda5b1", "message": "[mqtt] Fix increment commands in PercentageValue.\n\nConvert step size to percentage before using with\nINCREASE/DECREASE/UP/DOWN commands.  The raw min, max,\nand step size were being used with the percentage value.\n\nSigned-off-by: Michael Scarito <ms.github@mit.edu>", "committedDate": "2020-02-01T19:21:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgyODQ3NQ==", "url": "https://github.com/openhab/openhab-addons/pull/6946#discussion_r373828475", "bodyText": "For performance sake: Do we really need DECIMAL128 or would something lower be sufficient?", "author": "J-N-K", "createdAt": "2020-02-02T08:28:55Z", "path": "bundles/org.openhab.binding.mqtt.generic/src/main/java/org/openhab/binding/mqtt/generic/values/PercentageValue.java", "diffHunk": "@@ -69,6 +70,7 @@ public PercentageValue(@Nullable BigDecimal min, @Nullable BigDecimal max, @Null\n         }\n         this.span = this.max.subtract(this.min);\n         this.step = step == null ? BigDecimal.ONE : step;\n+        this.stepPercent = this.step.multiply(HUNDRED).divide(this.span, MathContext.DECIMAL128);", "originalCommit": "c157704d6f109fe5c211b25e3b63d0f425fda5b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzg1MjI1MQ==", "url": "https://github.com/openhab/openhab-addons/pull/6946#discussion_r373852251", "bodyText": "Well, this is a deeper problem.\nThe PercentageValue has inputs from 2 sources:\n\nMQTT will sent values between min and `max' or the on/off Strings\nThe UI will sent PercentType, IncreaseDecreaseType, or UpDownType\nIs that correct?\nThen the value will be used in 2 destination:\nMQTT will expect values between min and max\nThe UI will use PercentType to render the current value.\n\nThe conversion between the MQTT world (min...max) to the percent world (0...100) will have th posibility of loosing precision.\ne.g. If the MQTT world is [0...300], then the value incomming value 100 cannot be mapped to the percent value exactly. Then mapping the exact same value back to MQTT will yield a differenet value, because of the rounding needed.\nCurrently we do not have any information about he presicion, the MQTT world expects.\nDo we have any information about our front-end? What precision are ther working with?", "author": "jochen314", "createdAt": "2020-02-02T14:58:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgyODQ3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzg5ODkzNw==", "url": "https://github.com/openhab/openhab-addons/pull/6946#discussion_r373898937", "bodyText": "I was just matching the convention of the file for precision.  I think if the goal is to retain double precision in both percentage and MQTT domain using a 128 bit decimal will work, assuming you round back to doubles at output.  As long as you consistently round before outputting/receiving a value on both MQTT and openhab sides, you shouldn't have any loss of precision.\nMy MQTT side just expects integers so I'd be fine using floating point values everywhere and rounding.", "author": "scarito", "createdAt": "2020-02-03T02:10:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgyODQ3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTg1NjE3MQ==", "url": "https://github.com/openhab/openhab-addons/pull/6946#discussion_r379856171", "bodyText": "Can one of you help me understand what's needed to submit this PR?  I don't think these issues of precision relate to this specific change but rather to the implementation of the entire class.", "author": "scarito", "createdAt": "2020-02-15T21:08:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgyODQ3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkxNjM3Nw==", "url": "https://github.com/openhab/openhab-addons/pull/6946#discussion_r379916377", "bodyText": "@jochen314 So you would vote for keeping DECIMAL128?", "author": "J-N-K", "createdAt": "2020-02-16T16:43:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgyODQ3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkyMTU1NA==", "url": "https://github.com/openhab/openhab-addons/pull/6946#discussion_r379921554", "bodyText": "At least for now.\nI think, it would be another PR change the behaviour of the class in this respect.\nAnd I do not see, what would be the best solution for it", "author": "jochen314", "createdAt": "2020-02-16T18:02:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgyODQ3NQ=="}], "type": "inlineReview", "revised_code": null}]}