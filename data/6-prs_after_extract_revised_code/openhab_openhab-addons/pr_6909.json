{"pr_number": 6909, "pr_title": "[hueemulation] Fixes to prevent Alexa errors when using voice commands and the app (#6690)", "pr_createdAt": "2020-01-26T19:11:54Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/6909", "timeline": [{"oid": "90e5a89b8881f2f4ca53e0ea79991834696f19d1", "url": "https://github.com/openhab/openhab-addons/commit/90e5a89b8881f2f4ca53e0ea79991834696f19d1", "message": "Correct state to prevent Alexa reporting device errors.\n\nSigned-off-by: Mike Major <mike_j_major@hotmail.com>", "committedDate": "2020-01-26T17:53:51Z", "type": "commit"}, {"oid": "fdc567ad9e765cb7c65aa7adf2477ca4a70e58ed", "url": "https://github.com/openhab/openhab-addons/commit/fdc567ad9e765cb7c65aa7adf2477ca4a70e58ed", "message": "Minimum hue brightness should be 1 not 0.\n\nSigned-off-by: Mike Major <mike_j_major@hotmail.com>", "committedDate": "2020-01-27T22:13:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQxNTgzNw==", "url": "https://github.com/openhab/openhab-addons/pull/6909#discussion_r373415837", "bodyText": "Usage of as is tricky here. Because the as as used with the openHAB State class returns a new instance. So the contract to be assumed should be the method returns a new instance. Here it's assumed it returns the same object. But if that would change this code will break here. Because the code below will than make changes on the local variable only and not on the object returned. It would be better to do an instanceof check and a cast :\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                HueStateColorBulb c = hueState.as(HueStateColorBulb.class);\n          \n          \n            \n                                HueStateColorBulb c = (HueStateColorBulb) hueState;\n          \n      \n    \n    \n  \n\nSame below with HueStateBulb", "author": "Hilbrand", "createdAt": "2020-01-31T10:38:49Z", "path": "bundles/org.openhab.io.hueemulation/src/main/java/org/openhab/io/hueemulation/internal/StateUtils.java", "diffHunk": "@@ -413,4 +413,48 @@ public static Command commandByItemState(State state) throws IllegalStateExcepti\n         }\n         return t;\n     }\n+\n+    /**\n+     * Compute the hue state from a given item state and a device type.\n+     * If the item state matches the last command. the hue state is adjusted\n+     * to use the values from the last hue state change. This is done to prevent\n+     * Alexa reporting device errors.\n+     * \n+     * @param itemState The item state\n+     * @param deviceType The device type\n+     * @param lastCommand The last command\n+     * @param lastHueChange The last hue state change\n+     * @return A hue light state\n+     */\n+    public static AbstractHueState adjustedColorStateFromItemState(State itemState, @Nullable DeviceType deviceType,\n+            @Nullable Command lastCommand, @Nullable HueStateChange lastHueChange) {\n+\n+        AbstractHueState hueState = colorStateFromItemState(itemState, deviceType);\n+\n+        if (lastCommand != null && lastHueChange != null) {\n+            if (lastCommand instanceof HSBType) {\n+                if (itemState.as(HSBType.class).equals(lastCommand)) {\n+                    HueStateColorBulb c = hueState.as(HueStateColorBulb.class);", "originalCommit": "fdc567ad9e765cb7c65aa7adf2477ca4a70e58ed", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e2a8aa93d28b1f8d185043f69b9d93ac07013abf", "chunk": "diff --git a/bundles/org.openhab.io.hueemulation/src/main/java/org/openhab/io/hueemulation/internal/StateUtils.java b/bundles/org.openhab.io.hueemulation/src/main/java/org/openhab/io/hueemulation/internal/StateUtils.java\nindex a72d776d5a..1a4439cc74 100644\n--- a/bundles/org.openhab.io.hueemulation/src/main/java/org/openhab/io/hueemulation/internal/StateUtils.java\n+++ b/bundles/org.openhab.io.hueemulation/src/main/java/org/openhab/io/hueemulation/internal/StateUtils.java\n\n@@ -433,8 +433,8 @@ public class StateUtils {\n \n         if (lastCommand != null && lastHueChange != null) {\n             if (lastCommand instanceof HSBType) {\n-                if (itemState.as(HSBType.class).equals(lastCommand)) {\n-                    HueStateColorBulb c = hueState.as(HueStateColorBulb.class);\n+                if (hueState instanceof HueStateColorBulb && itemState.as(HSBType.class).equals(lastCommand)) {\n+                    HueStateColorBulb c = (HueStateColorBulb) hueState;\n \n                     if (lastHueChange.bri != null) {\n                         c.bri = lastHueChange.bri;\n"}}, {"oid": "e2a8aa93d28b1f8d185043f69b9d93ac07013abf", "url": "https://github.com/openhab/openhab-addons/commit/e2a8aa93d28b1f8d185043f69b9d93ac07013abf", "message": "Updated with review comments and return CT value in status\n\nSigned-off-by: Mike Major <mike_j_major@hotmail.com>", "committedDate": "2020-01-31T15:49:45Z", "type": "commit"}]}