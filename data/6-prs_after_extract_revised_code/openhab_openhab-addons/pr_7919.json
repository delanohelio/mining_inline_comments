{"pr_number": 7919, "pr_title": "[amazonechocontrol] fix memory/thread leak and failing connection", "pr_createdAt": "2020-06-14T15:40:14Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/7919", "timeline": [{"oid": "874d5d187c3a19590f0101b90877297dc283e8ef", "url": "https://github.com/openhab/openhab-addons/commit/874d5d187c3a19590f0101b90877297dc283e8ef", "message": "fix memory leak on failing websocket\n\nSigned-off-by: Jan N. Klug <jan.n.klug@rub.de>", "committedDate": "2020-06-14T15:41:45Z", "type": "commit"}, {"oid": "874d5d187c3a19590f0101b90877297dc283e8ef", "url": "https://github.com/openhab/openhab-addons/commit/874d5d187c3a19590f0101b90877297dc283e8ef", "message": "fix memory leak on failing websocket\n\nSigned-off-by: Jan N. Klug <jan.n.klug@rub.de>", "committedDate": "2020-06-14T15:41:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg0NzI4OA==", "url": "https://github.com/openhab/openhab-addons/pull/7919#discussion_r439847288", "bodyText": "Where is this counter and the one below it being used? I see them being incremented, but i don't see where anything is done with that count", "author": "digitaldan", "createdAt": "2020-06-14T16:41:18Z", "path": "bundles/org.openhab.binding.amazonechocontrol/src/main/java/org/openhab/binding/amazonechocontrol/internal/WebSocketConnection.java", "diffHunk": "@@ -64,6 +68,9 @@\n     Listener listener;\n     boolean closed;\n     IWebSocketCommandHandler webSocketCommandHandler;\n+    private long messageCounter = 0;", "originalCommit": "874d5d187c3a19590f0101b90877297dc283e8ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1MDA5NQ==", "url": "https://github.com/openhab/openhab-addons/pull/7919#discussion_r439850095", "bodyText": "Good point. I originally thought that unfinished requests lead to the shutdown faults and logged the sent and received messages on close. I forgot to remove the counters later.", "author": "J-N-K", "createdAt": "2020-06-14T17:16:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg0NzI4OA=="}], "type": "inlineReview", "revised_code": {"commit": "3f68feb0cade0267fe4408f39c7d8a31b69cd194", "chunk": "diff --git a/bundles/org.openhab.binding.amazonechocontrol/src/main/java/org/openhab/binding/amazonechocontrol/internal/WebSocketConnection.java b/bundles/org.openhab.binding.amazonechocontrol/src/main/java/org/openhab/binding/amazonechocontrol/internal/WebSocketConnection.java\nindex 16fb57ab88..0968317a22 100644\n--- a/bundles/org.openhab.binding.amazonechocontrol/src/main/java/org/openhab/binding/amazonechocontrol/internal/WebSocketConnection.java\n+++ b/bundles/org.openhab.binding.amazonechocontrol/src/main/java/org/openhab/binding/amazonechocontrol/internal/WebSocketConnection.java\n\n@@ -58,19 +58,16 @@ import com.google.gson.JsonSyntaxException;\n public class WebSocketConnection {\n     private final Logger logger = LoggerFactory.getLogger(WebSocketConnection.class);\n     private final Gson gson = new Gson();\n-    WebSocketClient webSocketClient;\n-    @Nullable\n-    Session session;\n-    @Nullable\n-    Timer pingTimer;\n-    @Nullable\n-    Timer pongTimeoutTimer;\n-    Listener listener;\n-    boolean closed;\n-    IWebSocketCommandHandler webSocketCommandHandler;\n-    private long messageCounter = 0;\n-    private long messageReceived = 0;\n-    private @Nullable Future<Session> future;\n+    private final WebSocketClient webSocketClient;\n+    private final IWebSocketCommandHandler webSocketCommandHandler;\n+    private final Listener listener;\n+\n+    private @Nullable Session session;\n+    private @Nullable Timer pingTimer;\n+    private @Nullable Timer pongTimeoutTimer;\n+    private @Nullable Future<?> sessionFuture;\n+\n+    private boolean closed;\n \n     public WebSocketConnection(String amazonSite, List<HttpCookie> sessionCookies,\n             IWebSocketCommandHandler webSocketCommandHandler) throws IOException {\n"}}, {"oid": "3f68feb0cade0267fe4408f39c7d8a31b69cd194", "url": "https://github.com/openhab/openhab-addons/commit/3f68feb0cade0267fe4408f39c7d8a31b69cd194", "message": "address review comment and fix some smaller issues\n\nSigned-off-by: Jan N. Klug <jan.n.klug@rub.de>", "committedDate": "2020-06-14T17:14:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg2Njg5OA==", "url": "https://github.com/openhab/openhab-addons/pull/7919#discussion_r439866898", "bodyText": "I know this is not part of you change, but I wonder if we should reduce this to debug?  Info seem very chatty here.", "author": "digitaldan", "createdAt": "2020-06-14T20:58:15Z", "path": "bundles/org.openhab.binding.amazonechocontrol/src/main/java/org/openhab/binding/amazonechocontrol/internal/WebSocketConnection.java", "diffHunk": "@@ -424,7 +440,22 @@ public void onWebSocketClose(int code, @Nullable String reason) {\n         @Override\n         public void onWebSocketError(@Nullable Throwable error) {\n             logger.info(\"Web Socket error\", error);", "originalCommit": "3f68feb0cade0267fe4408f39c7d8a31b69cd194", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg2ODMzNA==", "url": "https://github.com/openhab/openhab-addons/pull/7919#discussion_r439868334", "bodyText": "I was thinking of that, too. Maybe we should change that when we fix the underlying connection problem and leave it as-is for now, so we can better track if we are successful there.", "author": "J-N-K", "createdAt": "2020-06-14T21:17:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg2Njg5OA=="}], "type": "inlineReview", "revised_code": {"commit": "73340c0b201e9c3130d4061727b084f27125b9a1", "chunk": "diff --git a/bundles/org.openhab.binding.amazonechocontrol/src/main/java/org/openhab/binding/amazonechocontrol/internal/WebSocketConnection.java b/bundles/org.openhab.binding.amazonechocontrol/src/main/java/org/openhab/binding/amazonechocontrol/internal/WebSocketConnection.java\nindex 0968317a22..5e47ad5b57 100644\n--- a/bundles/org.openhab.binding.amazonechocontrol/src/main/java/org/openhab/binding/amazonechocontrol/internal/WebSocketConnection.java\n+++ b/bundles/org.openhab.binding.amazonechocontrol/src/main/java/org/openhab/binding/amazonechocontrol/internal/WebSocketConnection.java\n\n@@ -427,17 +428,18 @@ public class WebSocketConnection {\n             }\n         }\n \n-        @Override\n+        @OnWebSocketMessage\n         public void onWebSocketText(@Nullable String message) {\n+            logger.trace(\"Received text message: '{}'\", message);\n         }\n \n-        @Override\n+        @OnWebSocketClose\n         public void onWebSocketClose(int code, @Nullable String reason) {\n             logger.info(\"Web Socket close {}. Reason: {}\", code, reason);\n             WebSocketConnection.this.close();\n         }\n \n-        @Override\n+        @OnWebSocketError\n         public void onWebSocketError(@Nullable Throwable error) {\n             logger.info(\"Web Socket error\", error);\n             if (!closed) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM0ODM3OQ==", "url": "https://github.com/openhab/openhab-addons/pull/7919#discussion_r440348379", "bodyText": "I'm not sure how useful logging the future would be since I don't think it implements a toString().", "author": "cpmeister", "createdAt": "2020-06-15T17:55:54Z", "path": "bundles/org.openhab.binding.amazonechocontrol/src/main/java/org/openhab/binding/amazonechocontrol/internal/WebSocketConnection.java", "diffHunk": "@@ -155,8 +159,15 @@ public void close() {\n                 logger.debug(\"Closing sessing failed\", e);\n             }\n         }\n+        logger.trace(\"Connect future = {}\", sessionFuture);", "originalCommit": "3f68feb0cade0267fe4408f39c7d8a31b69cd194", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ2MzU5OA==", "url": "https://github.com/openhab/openhab-addons/pull/7919#discussion_r440463598", "bodyText": "That makes sense. It print the status of the future (cancelled, completed, etc):\nConnect future = java.util.concurrent.CompletableFuture@485b17bb[Completed normally]", "author": "J-N-K", "createdAt": "2020-06-15T21:42:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM0ODM3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "73340c0b201e9c3130d4061727b084f27125b9a1", "chunk": "diff --git a/bundles/org.openhab.binding.amazonechocontrol/src/main/java/org/openhab/binding/amazonechocontrol/internal/WebSocketConnection.java b/bundles/org.openhab.binding.amazonechocontrol/src/main/java/org/openhab/binding/amazonechocontrol/internal/WebSocketConnection.java\nindex 0968317a22..5e47ad5b57 100644\n--- a/bundles/org.openhab.binding.amazonechocontrol/src/main/java/org/openhab/binding/amazonechocontrol/internal/WebSocketConnection.java\n+++ b/bundles/org.openhab.binding.amazonechocontrol/src/main/java/org/openhab/binding/amazonechocontrol/internal/WebSocketConnection.java\n\n@@ -156,7 +157,7 @@ public class WebSocketConnection {\n             try {\n                 session.close();\n             } catch (Exception e) {\n-                logger.debug(\"Closing sessing failed\", e);\n+                logger.debug(\"Closing session failed\", e);\n             }\n         }\n         logger.trace(\"Connect future = {}\", sessionFuture);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM2MDk3Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7919#discussion_r440360973", "bodyText": "It always bothered me that we are not overriding the default executor used by the WebSocketClient. The default one has a min thread count of 8 and all the threads are non-daemon. I'd prefer if we provided our own thread pool so we can use an existing thread pool for all these connections instead of creating new ones each time.\nIt would also give us an opportunity to give the threads names that would tie them to this binding.", "author": "cpmeister", "createdAt": "2020-06-15T18:19:30Z", "path": "bundles/org.openhab.binding.amazonechocontrol/src/main/java/org/openhab/binding/amazonechocontrol/internal/WebSocketConnection.java", "diffHunk": "@@ -54,16 +58,16 @@\n public class WebSocketConnection {\n     private final Logger logger = LoggerFactory.getLogger(WebSocketConnection.class);\n     private final Gson gson = new Gson();\n-    WebSocketClient webSocketClient;\n-    @Nullable\n-    Session session;\n-    @Nullable\n-    Timer pingTimer;\n-    @Nullable\n-    Timer pongTimeoutTimer;\n-    Listener listener;\n-    boolean closed;\n-    IWebSocketCommandHandler webSocketCommandHandler;\n+    private final WebSocketClient webSocketClient;\n+    private final IWebSocketCommandHandler webSocketCommandHandler;\n+    private final Listener listener;\n+\n+    private @Nullable Session session;\n+    private @Nullable Timer pingTimer;\n+    private @Nullable Timer pongTimeoutTimer;\n+    private @Nullable Future<?> sessionFuture;\n+\n+    private boolean closed;\n \n     public WebSocketConnection(String amazonSite, List<HttpCookie> sessionCookies,\n             IWebSocketCommandHandler webSocketCommandHandler) throws IOException {", "originalCommit": "3f68feb0cade0267fe4408f39c7d8a31b69cd194", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "73340c0b201e9c3130d4061727b084f27125b9a1", "chunk": "diff --git a/bundles/org.openhab.binding.amazonechocontrol/src/main/java/org/openhab/binding/amazonechocontrol/internal/WebSocketConnection.java b/bundles/org.openhab.binding.amazonechocontrol/src/main/java/org/openhab/binding/amazonechocontrol/internal/WebSocketConnection.java\nindex 0968317a22..5e47ad5b57 100644\n--- a/bundles/org.openhab.binding.amazonechocontrol/src/main/java/org/openhab/binding/amazonechocontrol/internal/WebSocketConnection.java\n+++ b/bundles/org.openhab.binding.amazonechocontrol/src/main/java/org/openhab/binding/amazonechocontrol/internal/WebSocketConnection.java\n\n@@ -60,7 +64,7 @@ public class WebSocketConnection {\n     private final Gson gson = new Gson();\n     private final WebSocketClient webSocketClient;\n     private final IWebSocketCommandHandler webSocketCommandHandler;\n-    private final Listener listener;\n+    private final AmazonEchoControlWebSocket amazonEchoControlWebSocket;\n \n     private @Nullable Session session;\n     private @Nullable Timer pingTimer;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM2NTI0MQ==", "url": "https://github.com/openhab/openhab-addons/pull/7919#discussion_r440365241", "bodyText": "Why are two separate Timer instances required? Can't you use just a single Timer for all scheduling tasks?", "author": "cpmeister", "createdAt": "2020-06-15T18:27:24Z", "path": "bundles/org.openhab.binding.amazonechocontrol/src/main/java/org/openhab/binding/amazonechocontrol/internal/WebSocketConnection.java", "diffHunk": "@@ -54,16 +58,16 @@\n public class WebSocketConnection {\n     private final Logger logger = LoggerFactory.getLogger(WebSocketConnection.class);\n     private final Gson gson = new Gson();\n-    WebSocketClient webSocketClient;\n-    @Nullable\n-    Session session;\n-    @Nullable\n-    Timer pingTimer;\n-    @Nullable\n-    Timer pongTimeoutTimer;\n-    Listener listener;\n-    boolean closed;\n-    IWebSocketCommandHandler webSocketCommandHandler;\n+    private final WebSocketClient webSocketClient;\n+    private final IWebSocketCommandHandler webSocketCommandHandler;\n+    private final Listener listener;\n+\n+    private @Nullable Session session;\n+    private @Nullable Timer pingTimer;\n+    private @Nullable Timer pongTimeoutTimer;", "originalCommit": "3f68feb0cade0267fe4408f39c7d8a31b69cd194", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "73340c0b201e9c3130d4061727b084f27125b9a1", "chunk": "diff --git a/bundles/org.openhab.binding.amazonechocontrol/src/main/java/org/openhab/binding/amazonechocontrol/internal/WebSocketConnection.java b/bundles/org.openhab.binding.amazonechocontrol/src/main/java/org/openhab/binding/amazonechocontrol/internal/WebSocketConnection.java\nindex 0968317a22..5e47ad5b57 100644\n--- a/bundles/org.openhab.binding.amazonechocontrol/src/main/java/org/openhab/binding/amazonechocontrol/internal/WebSocketConnection.java\n+++ b/bundles/org.openhab.binding.amazonechocontrol/src/main/java/org/openhab/binding/amazonechocontrol/internal/WebSocketConnection.java\n\n@@ -60,7 +64,7 @@ public class WebSocketConnection {\n     private final Gson gson = new Gson();\n     private final WebSocketClient webSocketClient;\n     private final IWebSocketCommandHandler webSocketCommandHandler;\n-    private final Listener listener;\n+    private final AmazonEchoControlWebSocket amazonEchoControlWebSocket;\n \n     private @Nullable Session session;\n     private @Nullable Timer pingTimer;\n"}}, {"oid": "73340c0b201e9c3130d4061727b084f27125b9a1", "url": "https://github.com/openhab/openhab-addons/commit/73340c0b201e9c3130d4061727b084f27125b9a1", "message": "more fixes\n\nSigned-off-by: Jan N. Klug <jan.n.klug@rub.de>", "committedDate": "2020-06-15T21:32:48Z", "type": "commit"}, {"oid": "54f5ee534c5d8e3bc2ffee13952b683521024d9b", "url": "https://github.com/openhab/openhab-addons/commit/54f5ee534c5d8e3bc2ffee13952b683521024d9b", "message": "remove leftovers\n\nSigned-off-by: Jan N. Klug <jan.n.klug@rub.de>", "committedDate": "2020-06-15T21:41:00Z", "type": "commit"}]}