{"pr_number": 9168, "pr_title": "[ojelectronics] Add discovery; enable writable properties", "pr_createdAt": "2020-11-29T12:08:49Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/9168", "timeline": [{"oid": "bbda3043e092ae6f1669629c2d7aabc98ce34427", "url": "https://github.com/openhab/openhab-addons/commit/bbda3043e092ae6f1669629c2d7aabc98ce34427", "message": "Fixed warnings\n\nSigned-off-by: EvilPingu <ckittel@gmx.de>", "committedDate": "2020-11-29T16:08:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAwMzI0MQ==", "url": "https://github.com/openhab/openhab-addons/pull/9168#discussion_r533003241", "bodyText": "Why not make updatedValues a non-null field and just initially populate it with an empty list?", "author": "cpmeister", "createdAt": "2020-12-01T00:59:17Z", "path": "bundles/org.openhab.binding.ojelectronics/src/main/java/org/openhab/binding/ojelectronics/internal/ThermostatHandler.java", "diffHunk": "@@ -101,31 +122,106 @@ public void handleThermostatRefresh(Thermostat thermostat) {\n         channelrefreshActions.forEach((channelUID, action) -> action.accept(thermostat));\n     }\n \n+    /**\n+     * Gets a {@link Thermostat} with changed values or null if nothing has changed\n+     *\n+     * @return The changed {@link Thermostat}\n+     */\n+    public @Nullable Thermostat tryHandleAndGetUpdatedThermostat() {\n+        final LinkedList<SimpleImmutableEntry<String, Command>> updatedValues = this.updatedValues;\n+        if (updatedValues == null || updatedValues.size() == 0) {\n+            return null;\n+        }\n+        this.updatedValues = null;\n+        updatedValues.forEach(item -> {\n+            if (updateThermostatValueActions.containsKey(item.getKey())) {\n+                final @Nullable Consumer<Command> consumer = updateThermostatValueActions.get(item.getKey());\n+                if (consumer != null) {\n+                    consumer.accept(item.getValue());\n+                }\n+            }\n+        });\n+        return currentThermostat;\n+    }\n+\n+    private LinkedList<SimpleImmutableEntry<String, Command>> ensureUpdatedValueListExists() {\n+        final LinkedList<SimpleImmutableEntry<String, Command>> updatedValues = this.updatedValues;\n+        if (updatedValues != null) {\n+            return updatedValues;\n+        }\n+        LinkedList<SimpleImmutableEntry<String, Command>> internalUpdatedValue = new LinkedList<>();\n+        this.updatedValues = internalUpdatedValue;\n+        return internalUpdatedValue;\n+    }", "originalCommit": "bbda3043e092ae6f1669629c2d7aabc98ce34427", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzU0NjY1OA==", "url": "https://github.com/openhab/openhab-addons/pull/9168#discussion_r533546658", "bodyText": "I fixed it too.", "author": "EvilPingu", "createdAt": "2020-12-01T16:25:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAwMzI0MQ=="}], "type": "inlineReview", "revised_code": {"commit": "e331a261ebd3980db7f0ecac6c97ed71cd5de31d", "chunk": "diff --git a/bundles/org.openhab.binding.ojelectronics/src/main/java/org/openhab/binding/ojelectronics/internal/ThermostatHandler.java b/bundles/org.openhab.binding.ojelectronics/src/main/java/org/openhab/binding/ojelectronics/internal/ThermostatHandler.java\nindex e2dc9e1ebf..fa08f34b53 100644\n--- a/bundles/org.openhab.binding.ojelectronics/src/main/java/org/openhab/binding/ojelectronics/internal/ThermostatHandler.java\n+++ b/bundles/org.openhab.binding.ojelectronics/src/main/java/org/openhab/binding/ojelectronics/internal/ThermostatHandler.java\n\n@@ -135,10 +131,7 @@ public class ThermostatHandler extends BaseThingHandler {\n         this.updatedValues = null;\n         updatedValues.forEach(item -> {\n             if (updateThermostatValueActions.containsKey(item.getKey())) {\n-                final @Nullable Consumer<Command> consumer = updateThermostatValueActions.get(item.getKey());\n-                if (consumer != null) {\n-                    consumer.accept(item.getValue());\n-                }\n+                updateThermostatValueActions.get(item.getKey()).accept(item.getValue());\n             }\n         });\n         return currentThermostat;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAwNTc0OA==", "url": "https://github.com/openhab/openhab-addons/pull/9168#discussion_r533005748", "bodyText": "?", "author": "cpmeister", "createdAt": "2020-12-01T01:06:28Z", "path": "bundles/org.openhab.binding.ojelectronics/src/main/java/org/openhab/binding/ojelectronics/internal/OJCloudHandlerFactory.java", "diffHunk": "@@ -69,5 +69,5 @@ public boolean supportsThingType(ThingTypeUID thingTypeUID) {\n             return handler;\n         }\n         return null;\n-    }\n+    };", "originalCommit": "bbda3043e092ae6f1669629c2d7aabc98ce34427", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzU0NTM2MQ==", "url": "https://github.com/openhab/openhab-addons/pull/9168#discussion_r533545361", "bodyText": "I fixed it", "author": "EvilPingu", "createdAt": "2020-12-01T16:23:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAwNTc0OA=="}], "type": "inlineReview", "revised_code": {"commit": "5151869e5f2450672d7fde8369ff470b388eb72e", "chunk": "diff --git a/bundles/org.openhab.binding.ojelectronics/src/main/java/org/openhab/binding/ojelectronics/internal/OJCloudHandlerFactory.java b/bundles/org.openhab.binding.ojelectronics/src/main/java/org/openhab/binding/ojelectronics/internal/OJCloudHandlerFactory.java\nindex 631fc553c8..17aae9ab66 100644\n--- a/bundles/org.openhab.binding.ojelectronics/src/main/java/org/openhab/binding/ojelectronics/internal/OJCloudHandlerFactory.java\n+++ b/bundles/org.openhab.binding.ojelectronics/src/main/java/org/openhab/binding/ojelectronics/internal/OJCloudHandlerFactory.java\n\n@@ -69,5 +69,5 @@ public class OJCloudHandlerFactory extends BaseThingHandlerFactory {\n             return handler;\n         }\n         return null;\n-    };\n+    }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAwODA3OQ==", "url": "https://github.com/openhab/openhab-addons/pull/9168#discussion_r533008079", "bodyText": "Instead of using the default ZoneId, try using the one provided by the TimeZoneProvider osgi service. You will have to get the service as a @Reference in the ThingHandlerFactory and then pass it in through the constructor of this handler.", "author": "cpmeister", "createdAt": "2020-12-01T01:13:42Z", "path": "bundles/org.openhab.binding.ojelectronics/src/main/java/org/openhab/binding/ojelectronics/internal/ThermostatHandler.java", "diffHunk": "@@ -158,6 +254,42 @@ private void updateGroupName(Thermostat thermostat) {\n         updateState(BindingConstants.CHANNEL_OWD5_GROUPNAME, StringType.valueOf(thermostat.groupName));\n     }\n \n+    private void updateVacationEnabled(Thermostat thermostat) {\n+        updateState(BindingConstants.CHANNEL_OWD5_VACATIONENABLED,\n+                thermostat.online ? OpenClosedType.OPEN : OpenClosedType.CLOSED);\n+    }\n+\n+    private void updateVacationBeginDay(Thermostat thermostat) {\n+        updateState(BindingConstants.CHANNEL_OWD5_VACATIONBEGINDAY,\n+                new DateTimeType(\n+                        ZonedDateTime.ofInstant(thermostat.vacationBeginDay.toInstant(), ZoneId.systemDefault())\n+                                .truncatedTo(ChronoUnit.DAYS)));", "originalCommit": "bbda3043e092ae6f1669629c2d7aabc98ce34427", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzU0NjMwNg==", "url": "https://github.com/openhab/openhab-addons/pull/9168#discussion_r533546306", "bodyText": "Thanks for the hint. I fixed it.", "author": "EvilPingu", "createdAt": "2020-12-01T16:24:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAwODA3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "e331a261ebd3980db7f0ecac6c97ed71cd5de31d", "chunk": "diff --git a/bundles/org.openhab.binding.ojelectronics/src/main/java/org/openhab/binding/ojelectronics/internal/ThermostatHandler.java b/bundles/org.openhab.binding.ojelectronics/src/main/java/org/openhab/binding/ojelectronics/internal/ThermostatHandler.java\nindex e2dc9e1ebf..fa08f34b53 100644\n--- a/bundles/org.openhab.binding.ojelectronics/src/main/java/org/openhab/binding/ojelectronics/internal/ThermostatHandler.java\n+++ b/bundles/org.openhab.binding.ojelectronics/src/main/java/org/openhab/binding/ojelectronics/internal/ThermostatHandler.java\n\n@@ -254,42 +244,6 @@ public class ThermostatHandler extends BaseThingHandler {\n         updateState(BindingConstants.CHANNEL_OWD5_GROUPNAME, StringType.valueOf(thermostat.groupName));\n     }\n \n-    private void updateVacationEnabled(Thermostat thermostat) {\n-        updateState(BindingConstants.CHANNEL_OWD5_VACATIONENABLED,\n-                thermostat.online ? OpenClosedType.OPEN : OpenClosedType.CLOSED);\n-    }\n-\n-    private void updateVacationBeginDay(Thermostat thermostat) {\n-        updateState(BindingConstants.CHANNEL_OWD5_VACATIONBEGINDAY,\n-                new DateTimeType(\n-                        ZonedDateTime.ofInstant(thermostat.vacationBeginDay.toInstant(), ZoneId.systemDefault())\n-                                .truncatedTo(ChronoUnit.DAYS)));\n-    }\n-\n-    private void updateVacationBeginDay(Command command) {\n-        if (command instanceof DateTimeType) {\n-            currentThermostat.vacationBeginDay = Date\n-                    .from(((DateTimeType) command).getZonedDateTime().toInstant().truncatedTo(ChronoUnit.DAYS));\n-        } else {\n-            logger.warn(\"Unable to set value {}\", command);\n-        }\n-    }\n-\n-    private void updateVacationEndDay(Thermostat thermostat) {\n-        updateState(BindingConstants.CHANNEL_OWD5_VACATIONENDDAY,\n-                new DateTimeType(ZonedDateTime.ofInstant(thermostat.vacationEndDay.toInstant(), ZoneId.systemDefault())\n-                        .truncatedTo(ChronoUnit.DAYS)));\n-    }\n-\n-    private void updateVacationEndDay(Command command) {\n-        if (command instanceof DateTimeType) {\n-            currentThermostat.vacationEndDay = Date\n-                    .from(((DateTimeType) command).getZonedDateTime().toInstant().truncatedTo(ChronoUnit.DAYS));\n-        } else {\n-            logger.warn(\"Unable to set value {}\", command);\n-        }\n-    }\n-\n     private @Nullable String getRegulationMode(int regulationMode) {\n         return REGULATION_MODES.get(regulationMode);\n     }\n"}}, {"oid": "e331a261ebd3980db7f0ecac6c97ed71cd5de31d", "url": "https://github.com/openhab/openhab-addons/commit/e331a261ebd3980db7f0ecac6c97ed71cd5de31d", "message": "Add methods to update via Command; Add discovery\n\nSigned-off-by: EvilPingu <ckittel@gmx.de>", "committedDate": "2020-12-01T15:50:11Z", "type": "commit"}, {"oid": "a1842cb9cf5c1781f633d8654dde75acf972cda1", "url": "https://github.com/openhab/openhab-addons/commit/a1842cb9cf5c1781f633d8654dde75acf972cda1", "message": "add vacation channels; rework README\n\nSigned-off-by: EvilPingu <ckittel@gmx.de>", "committedDate": "2020-12-01T15:50:11Z", "type": "commit"}, {"oid": "8b318b89d5e82a86c30a73138363c5571ae6178c", "url": "https://github.com/openhab/openhab-addons/commit/8b318b89d5e82a86c30a73138363c5571ae6178c", "message": "Fixed warnings\n\nSigned-off-by: EvilPingu <ckittel@gmx.de>", "committedDate": "2020-12-01T15:50:11Z", "type": "commit"}, {"oid": "8b318b89d5e82a86c30a73138363c5571ae6178c", "url": "https://github.com/openhab/openhab-addons/commit/8b318b89d5e82a86c30a73138363c5571ae6178c", "message": "Fixed warnings\n\nSigned-off-by: EvilPingu <ckittel@gmx.de>", "committedDate": "2020-12-01T15:50:11Z", "type": "forcePushed"}, {"oid": "5151869e5f2450672d7fde8369ff470b388eb72e", "url": "https://github.com/openhab/openhab-addons/commit/5151869e5f2450672d7fde8369ff470b388eb72e", "message": "Fixed code review issues\n\nSigned-off-by: EvilPingu <ckittel@gmx.de>", "committedDate": "2020-12-02T19:15:41Z", "type": "commit"}, {"oid": "5151869e5f2450672d7fde8369ff470b388eb72e", "url": "https://github.com/openhab/openhab-addons/commit/5151869e5f2450672d7fde8369ff470b388eb72e", "message": "Fixed code review issues\n\nSigned-off-by: EvilPingu <ckittel@gmx.de>", "committedDate": "2020-12-02T19:15:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU0ODcxMw==", "url": "https://github.com/openhab/openhab-addons/pull/9168#discussion_r535548713", "bodyText": "Since the user can change the timezone in the openHAB during runtime, you shouldn't cache time zone from TimeZoneProvider. So you will need to pass the TimeZoneProvider into the ThermostatHandler instead.", "author": "cpmeister", "createdAt": "2020-12-03T20:05:32Z", "path": "bundles/org.openhab.binding.ojelectronics/src/main/java/org/openhab/binding/ojelectronics/internal/ThermostatHandlerFactory.java", "diffHunk": "@@ -36,6 +40,17 @@\n public class ThermostatHandlerFactory extends BaseThingHandlerFactory {\n \n     private static final Set<ThingTypeUID> SUPPORTED_THING_TYPES_UIDS = Collections.singleton(THING_TYPE_OWD5);\n+    private final ZoneId timeZone;\n+\n+    /**\n+     * Creates a new factory\n+     *\n+     * @param httpClientFactory Factory for HttpClient\n+     */\n+    @Activate\n+    public ThermostatHandlerFactory(@Reference TimeZoneProvider timeZoneProvider) {\n+        this.timeZone = timeZoneProvider.getTimeZone();", "originalCommit": "5151869e5f2450672d7fde8369ff470b388eb72e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjAzNzM4Nw==", "url": "https://github.com/openhab/openhab-addons/pull/9168#discussion_r536037387", "bodyText": "I changed this.", "author": "EvilPingu", "createdAt": "2020-12-04T11:38:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU0ODcxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA3OTAwNw==", "url": "https://github.com/openhab/openhab-addons/pull/9168#discussion_r536079007", "bodyText": "@cpmeister By the way: Why does my builds always fail?", "author": "EvilPingu", "createdAt": "2020-12-04T12:54:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU0ODcxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkwMTc4Ng==", "url": "https://github.com/openhab/openhab-addons/pull/9168#discussion_r537901786", "bodyText": "Almost all of the jenkins builds are failing for one reason or another. It mostly has to do with timing dependent unit tests that are failing because of the high load on the server. As long as your project builds and your project's unit tests pass I wouldn't worry about it.", "author": "cpmeister", "createdAt": "2020-12-07T23:07:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU0ODcxMw=="}], "type": "inlineReview", "revised_code": {"commit": "2beeaca59e058dc782c8b152d31ce7075f7fe8ac", "chunk": "diff --git a/bundles/org.openhab.binding.ojelectronics/src/main/java/org/openhab/binding/ojelectronics/internal/ThermostatHandlerFactory.java b/bundles/org.openhab.binding.ojelectronics/src/main/java/org/openhab/binding/ojelectronics/internal/ThermostatHandlerFactory.java\nindex a0ce64018d..70843e20a5 100644\n--- a/bundles/org.openhab.binding.ojelectronics/src/main/java/org/openhab/binding/ojelectronics/internal/ThermostatHandlerFactory.java\n+++ b/bundles/org.openhab.binding.ojelectronics/src/main/java/org/openhab/binding/ojelectronics/internal/ThermostatHandlerFactory.java\n\n@@ -40,7 +39,7 @@ import org.osgi.service.component.annotations.Reference;\n public class ThermostatHandlerFactory extends BaseThingHandlerFactory {\n \n     private static final Set<ThingTypeUID> SUPPORTED_THING_TYPES_UIDS = Collections.singleton(THING_TYPE_OWD5);\n-    private final ZoneId timeZone;\n+    private final TimeZoneProvider timeZoneProvider;\n \n     /**\n      * Creates a new factory\n"}}, {"oid": "2beeaca59e058dc782c8b152d31ce7075f7fe8ac", "url": "https://github.com/openhab/openhab-addons/commit/2beeaca59e058dc782c8b152d31ce7075f7fe8ac", "message": "Fixed code review issues: Corrected TimeZone-Hanlding\n\nSigned-off-by: EvilPingu <ckittel@gmx.de>", "committedDate": "2020-12-05T08:55:32Z", "type": "forcePushed"}, {"oid": "716a1a66d0c98effd5fce8a19e81f746036c3e33", "url": "https://github.com/openhab/openhab-addons/commit/716a1a66d0c98effd5fce8a19e81f746036c3e33", "message": "Fixed code review issues: Corrected TimeZone-Handling\n\nSigned-off-by: EvilPingu <ckittel@gmx.de>", "committedDate": "2020-12-06T16:14:48Z", "type": "commit"}, {"oid": "716a1a66d0c98effd5fce8a19e81f746036c3e33", "url": "https://github.com/openhab/openhab-addons/commit/716a1a66d0c98effd5fce8a19e81f746036c3e33", "message": "Fixed code review issues: Corrected TimeZone-Handling\n\nSigned-off-by: EvilPingu <ckittel@gmx.de>", "committedDate": "2020-12-06T16:14:48Z", "type": "forcePushed"}]}