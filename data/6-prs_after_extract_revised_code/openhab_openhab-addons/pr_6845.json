{"pr_number": 6845, "pr_title": "[mqtt.homie] Add Dimmer functionality", "pr_createdAt": "2020-01-16T12:05:58Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/6845", "timeline": [{"oid": "3da2ea91d91f46682776349c29e06fbce432dd0f", "url": "https://github.com/openhab/openhab-addons/commit/3da2ea91d91f46682776349c29e06fbce432dd0f", "message": "added changes", "committedDate": "2020-01-16T12:24:43Z", "type": "commit"}, {"oid": "6dc8f8ac1b2fd2e9f98132daff28f98ef7af44aa", "url": "https://github.com/openhab/openhab-addons/commit/6dc8f8ac1b2fd2e9f98132daff28f98ef7af44aa", "message": "removing whitespaces", "committedDate": "2020-01-16T12:25:00Z", "type": "commit"}, {"oid": "393ec6bd56c1ba077a16457964ab37fcac739be4", "url": "https://github.com/openhab/openhab-addons/commit/393ec6bd56c1ba077a16457964ab37fcac739be4", "message": "reverting classpath files to original", "committedDate": "2020-01-16T12:25:16Z", "type": "commit"}, {"oid": "393ec6bd56c1ba077a16457964ab37fcac739be4", "url": "https://github.com/openhab/openhab-addons/commit/393ec6bd56c1ba077a16457964ab37fcac739be4", "message": "reverting classpath files to original", "committedDate": "2020-01-16T12:25:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUxMDA5NA==", "url": "https://github.com/openhab/openhab-addons/pull/6845#discussion_r367510094", "bodyText": "Why are you checking if the 'format' field contains the \"%\" sign? Shouldn't this be:\nif (attributes.unit != null && attributes.unit.contains(\"%\")) {\nHomie V4 specification defines that, for integer and float, \"format\" can only describe 'a range of payloads e.g. 10:15' (https://homieiot.github.io/specification/#property-attributes).\nPerhaps there is something I'm misssing \ud83e\udd14\nEDIT: Perhaps we should also check if the format is 0:100, so that we can ensure that the  published value is not outside the Percentage range (0-100).", "author": "bodiroga", "createdAt": "2020-01-16T16:12:46Z", "path": "bundles/org.openhab.binding.mqtt.homie/src/main/java/org/openhab/binding/mqtt/homie/internal/homie300/Property.java", "diffHunk": "@@ -187,13 +188,16 @@ public void createChannelFromAttribute() {\n                 BigDecimal min = s.length == 2 ? convertFromString(s[0]) : null;\n                 BigDecimal max = s.length == 2 ? convertFromString(s[1]) : null;\n                 BigDecimal step = (min != null && max != null)\n-                        ? max.subtract(min).divide(new BigDecimal(100.0), new MathContext(isDecimal ? 2 : 0))\n-                        : null;\n+                           ? max.subtract(min).divide(new BigDecimal(100.0), new MathContext(isDecimal ? 2 : 0))\n+                           : null;\n                 if (step != null && !isDecimal && step.intValue() <= 0) {\n-                    step = new BigDecimal(1);\n+                        step = new BigDecimal(1);\n+                }\n+                if(attributes.unit != null && attributes.format.contains(\"%\")) {", "originalCommit": "393ec6bd56c1ba077a16457964ab37fcac739be4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg2MTQ4NQ==", "url": "https://github.com/openhab/openhab-addons/pull/6845#discussion_r367861485", "bodyText": "I forgot to add the latest changes to this branch. I will push them as I changed this already to unit.\nNot really, when I tested it OpenHab calculated the value from the format range from the Percentage value. So if your format is 0:200 and you have the Dimmer set to 50% the value which will be sent to MQTT is 100. I find it useful for values where you need dimmmer functionality but your range goes from 0 to 255 and OpenHab should display it as Dimmer.", "author": "szwenni", "createdAt": "2020-01-17T10:15:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUxMDA5NA=="}], "type": "inlineReview", "revised_code": {"commit": "154335b61071e0d4f771b1aa285ab3c9ff2e79b1", "chunk": "diff --git a/bundles/org.openhab.binding.mqtt.homie/src/main/java/org/openhab/binding/mqtt/homie/internal/homie300/Property.java b/bundles/org.openhab.binding.mqtt.homie/src/main/java/org/openhab/binding/mqtt/homie/internal/homie300/Property.java\nindex 8bf38d031d..6340c04213 100644\n--- a/bundles/org.openhab.binding.mqtt.homie/src/main/java/org/openhab/binding/mqtt/homie/internal/homie300/Property.java\n+++ b/bundles/org.openhab.binding.mqtt.homie/src/main/java/org/openhab/binding/mqtt/homie/internal/homie300/Property.java\n\n@@ -193,7 +193,7 @@ public class Property implements AttributeChanged {\n                 if (step != null && !isDecimal && step.intValue() <= 0) {\n                         step = new BigDecimal(1);\n                 }\n-                if(attributes.unit != null && attributes.format.contains(\"%\")) {\n+                if(attributes.unit != null && attributes.unit.contains(\"%\")) {\n                     value = new PercentageValue(min, max, step, null, null);\n                 } else {\n                     value = new NumberValue(min, max, step, attributes.unit);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUxMTE1OQ==", "url": "https://github.com/openhab/openhab-addons/pull/6845#discussion_r367511159", "bodyText": "Is there any formatting problem here? There are 3 more spaces in this lines.", "author": "bodiroga", "createdAt": "2020-01-16T16:14:35Z", "path": "bundles/org.openhab.binding.mqtt.homie/src/main/java/org/openhab/binding/mqtt/homie/internal/homie300/Property.java", "diffHunk": "@@ -187,13 +188,16 @@ public void createChannelFromAttribute() {\n                 BigDecimal min = s.length == 2 ? convertFromString(s[0]) : null;\n                 BigDecimal max = s.length == 2 ? convertFromString(s[1]) : null;\n                 BigDecimal step = (min != null && max != null)\n-                        ? max.subtract(min).divide(new BigDecimal(100.0), new MathContext(isDecimal ? 2 : 0))\n-                        : null;\n+                           ? max.subtract(min).divide(new BigDecimal(100.0), new MathContext(isDecimal ? 2 : 0))", "originalCommit": "393ec6bd56c1ba077a16457964ab37fcac739be4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg2MjM1OA==", "url": "https://github.com/openhab/openhab-addons/pull/6845#discussion_r367862358", "bodyText": "Fixed this in the latest commit", "author": "szwenni", "createdAt": "2020-01-17T10:17:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUxMTE1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "154335b61071e0d4f771b1aa285ab3c9ff2e79b1", "chunk": "diff --git a/bundles/org.openhab.binding.mqtt.homie/src/main/java/org/openhab/binding/mqtt/homie/internal/homie300/Property.java b/bundles/org.openhab.binding.mqtt.homie/src/main/java/org/openhab/binding/mqtt/homie/internal/homie300/Property.java\nindex 8bf38d031d..6340c04213 100644\n--- a/bundles/org.openhab.binding.mqtt.homie/src/main/java/org/openhab/binding/mqtt/homie/internal/homie300/Property.java\n+++ b/bundles/org.openhab.binding.mqtt.homie/src/main/java/org/openhab/binding/mqtt/homie/internal/homie300/Property.java\n\n@@ -193,7 +193,7 @@ public class Property implements AttributeChanged {\n                 if (step != null && !isDecimal && step.intValue() <= 0) {\n                         step = new BigDecimal(1);\n                 }\n-                if(attributes.unit != null && attributes.format.contains(\"%\")) {\n+                if(attributes.unit != null && attributes.unit.contains(\"%\")) {\n                     value = new PercentageValue(min, max, step, null, null);\n                 } else {\n                     value = new NumberValue(min, max, step, attributes.unit);\n"}}, {"oid": "154335b61071e0d4f771b1aa285ab3c9ff2e79b1", "url": "https://github.com/openhab/openhab-addons/commit/154335b61071e0d4f771b1aa285ab3c9ff2e79b1", "message": "changed format to unit\n\nSigned-off-by: Sven Kroeger <svenni.kroeger@gmail.com>", "committedDate": "2020-01-17T10:13:34Z", "type": "commit"}, {"oid": "6a953f27fb34d633dfe0ba6c3cffe6d6d13af533", "url": "https://github.com/openhab/openhab-addons/commit/6a953f27fb34d633dfe0ba6c3cffe6d6d13af533", "message": "Fixed Formatting in Property.java\n\nSigned-off-by: Sven Kroeger <svenni.kroeger@gmail.com>", "committedDate": "2020-01-17T10:16:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIyNTUxNA==", "url": "https://github.com/openhab/openhab-addons/pull/6845#discussion_r368225514", "bodyText": "New spacing problem? Have you applied the openHAB formatter to your Eclipse IDE?", "author": "bodiroga", "createdAt": "2020-01-18T12:53:21Z", "path": "bundles/org.openhab.binding.mqtt.homie/src/main/java/org/openhab/binding/mqtt/homie/internal/homie300/Property.java", "diffHunk": "@@ -190,10 +191,13 @@ public void createChannelFromAttribute() {\n                         ? max.subtract(min).divide(new BigDecimal(100.0), new MathContext(isDecimal ? 2 : 0))\n                         : null;\n                 if (step != null && !isDecimal && step.intValue() <= 0) {\n-                    step = new BigDecimal(1);\n+                        step = new BigDecimal(1);", "originalCommit": "6a953f27fb34d633dfe0ba6c3cffe6d6d13af533", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIyODEyOQ==", "url": "https://github.com/openhab/openhab-addons/pull/6845#discussion_r368228129", "bodyText": "Now it looks correct, the auto formatter seems to have problems in the switch case statement somehow.", "author": "szwenni", "createdAt": "2020-01-18T13:54:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIyNTUxNA=="}], "type": "inlineReview", "revised_code": {"commit": "72c73048ffdaea8741f6adfbaee3ff96957a4348", "chunk": "diff --git a/bundles/org.openhab.binding.mqtt.homie/src/main/java/org/openhab/binding/mqtt/homie/internal/homie300/Property.java b/bundles/org.openhab.binding.mqtt.homie/src/main/java/org/openhab/binding/mqtt/homie/internal/homie300/Property.java\nindex 8d1a56d694..0ca6508e2b 100644\n--- a/bundles/org.openhab.binding.mqtt.homie/src/main/java/org/openhab/binding/mqtt/homie/internal/homie300/Property.java\n+++ b/bundles/org.openhab.binding.mqtt.homie/src/main/java/org/openhab/binding/mqtt/homie/internal/homie300/Property.java\n\n@@ -191,9 +191,9 @@ public class Property implements AttributeChanged {\n                         ? max.subtract(min).divide(new BigDecimal(100.0), new MathContext(isDecimal ? 2 : 0))\n                         : null;\n                 if (step != null && !isDecimal && step.intValue() <= 0) {\n-                        step = new BigDecimal(1);\n+                    step = new BigDecimal(1);\n                 }\n-                if(attributes.unit != null && attributes.unit.contains(\"%\")) {\n+                if (attributes.unit != null && attributes.unit.contains(\"%\")) {\n                     value = new PercentageValue(min, max, step, null, null);\n                 } else {\n                     value = new NumberValue(min, max, step, attributes.unit);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIyNTU5NQ==", "url": "https://github.com/openhab/openhab-addons/pull/6845#discussion_r368225595", "bodyText": "if (attribute.unit != null && attributes.unit.contains(\"%\")) {\nWe usually place a white space between the 'if' and the parenthesis. Let's keep this coherent across the file.", "author": "bodiroga", "createdAt": "2020-01-18T12:55:16Z", "path": "bundles/org.openhab.binding.mqtt.homie/src/main/java/org/openhab/binding/mqtt/homie/internal/homie300/Property.java", "diffHunk": "@@ -190,10 +191,13 @@ public void createChannelFromAttribute() {\n                         ? max.subtract(min).divide(new BigDecimal(100.0), new MathContext(isDecimal ? 2 : 0))\n                         : null;\n                 if (step != null && !isDecimal && step.intValue() <= 0) {\n-                    step = new BigDecimal(1);\n+                        step = new BigDecimal(1);\n+                }\n+                if(attributes.unit != null && attributes.unit.contains(\"%\")) {", "originalCommit": "6a953f27fb34d633dfe0ba6c3cffe6d6d13af533", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIyODEzNg==", "url": "https://github.com/openhab/openhab-addons/pull/6845#discussion_r368228136", "bodyText": "Fixed it", "author": "szwenni", "createdAt": "2020-01-18T13:54:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIyNTU5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "72c73048ffdaea8741f6adfbaee3ff96957a4348", "chunk": "diff --git a/bundles/org.openhab.binding.mqtt.homie/src/main/java/org/openhab/binding/mqtt/homie/internal/homie300/Property.java b/bundles/org.openhab.binding.mqtt.homie/src/main/java/org/openhab/binding/mqtt/homie/internal/homie300/Property.java\nindex 8d1a56d694..0ca6508e2b 100644\n--- a/bundles/org.openhab.binding.mqtt.homie/src/main/java/org/openhab/binding/mqtt/homie/internal/homie300/Property.java\n+++ b/bundles/org.openhab.binding.mqtt.homie/src/main/java/org/openhab/binding/mqtt/homie/internal/homie300/Property.java\n\n@@ -191,9 +191,9 @@ public class Property implements AttributeChanged {\n                         ? max.subtract(min).divide(new BigDecimal(100.0), new MathContext(isDecimal ? 2 : 0))\n                         : null;\n                 if (step != null && !isDecimal && step.intValue() <= 0) {\n-                        step = new BigDecimal(1);\n+                    step = new BigDecimal(1);\n                 }\n-                if(attributes.unit != null && attributes.unit.contains(\"%\")) {\n+                if (attributes.unit != null && attributes.unit.contains(\"%\")) {\n                     value = new PercentageValue(min, max, step, null, null);\n                 } else {\n                     value = new NumberValue(min, max, step, attributes.unit);\n"}}, {"oid": "72c73048ffdaea8741f6adfbaee3ff96957a4348", "url": "https://github.com/openhab/openhab-addons/commit/72c73048ffdaea8741f6adfbaee3ff96957a4348", "message": "Formatting\n\nSigned-off-by: Sven Kroeger <svenni.kroeger@gmail.com>", "committedDate": "2020-01-18T13:51:11Z", "type": "commit"}]}