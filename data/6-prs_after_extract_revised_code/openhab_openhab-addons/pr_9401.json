{"pr_number": 9401, "pr_title": "[comfoair] improve data handling", "pr_createdAt": "2020-12-16T19:24:09Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/9401", "timeline": [{"oid": "d68a85f48b077934f3bdb57dcf7b6568e1b2791e", "url": "https://github.com/openhab/openhab-addons/commit/d68a85f48b077934f3bdb57dcf7b6568e1b2791e", "message": "improve data handling and suspend\n\nSigned-off-by: Hans B\u00f6hm <h.boehm@gmx.at>", "committedDate": "2020-12-08T12:53:14Z", "type": "commit"}, {"oid": "720c6a1a9a4c60bc2566933cd2a9c2b4e78b7364", "url": "https://github.com/openhab/openhab-addons/commit/720c6a1a9a4c60bc2566933cd2a9c2b4e78b7364", "message": "fix command position\n\nSigned-off-by: Hans B\u00f6hm <h.boehm@gmx.at>", "committedDate": "2020-12-08T14:27:36Z", "type": "commit"}, {"oid": "6003c782318cce5c2d8870c83cbe717015d6d83c", "url": "https://github.com/openhab/openhab-addons/commit/6003c782318cce5c2d8870c83cbe717015d6d83c", "message": "add ACK to subResponse\n\nSigned-off-by: Hans B\u00f6hm <h.boehm@gmx.at>", "committedDate": "2020-12-09T10:12:54Z", "type": "commit"}, {"oid": "b69486d977a1de6aa900784f467d082a488f080b", "url": "https://github.com/openhab/openhab-addons/commit/b69486d977a1de6aa900784f467d082a488f080b", "message": "fix data position\n\nSigned-off-by: Hans B\u00f6hm <h.boehm@gmx.at>", "committedDate": "2020-12-09T10:37:03Z", "type": "commit"}, {"oid": "e065cfa29defa1fb4e85bad4c4dbed77f7d86729", "url": "https://github.com/openhab/openhab-addons/commit/e065cfa29defa1fb4e85bad4c4dbed77f7d86729", "message": "fix reactivation, trim too long responses\n\nSigned-off-by: Hans B\u00f6hm <h.boehm@gmx.at>", "committedDate": "2020-12-14T21:34:00Z", "type": "commit"}, {"oid": "a05aa66de22a19103365db70a15f7ab8cc863d2c", "url": "https://github.com/openhab/openhab-addons/commit/a05aa66de22a19103365db70a15f7ab8cc863d2c", "message": "ensure correct setting of activation channel\n\nSigned-off-by: Hans B\u00f6hm <h.boehm@gmx.at>", "committedDate": "2020-12-16T18:59:20Z", "type": "commit"}, {"oid": "1bb3b54f8d8d0bfef826f10ea776d1b3e4e55c73", "url": "https://github.com/openhab/openhab-addons/commit/1bb3b54f8d8d0bfef826f10ea776d1b3e4e55c73", "message": "Remove @SuppressWarnings(null), which is not needed anymore\n\nSigned-off-by: Hans B\u00f6hm <h.boehm@gmx.at>", "committedDate": "2020-12-20T18:07:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU2MDU0NQ==", "url": "https://github.com/openhab/openhab-addons/pull/9401#discussion_r547560545", "bodyText": "Why are you updating states while the handler is getting disposed? Disposal usually indicates that openHAB is shutting down so you shouldn't delay it by creating new events.", "author": "cpmeister", "createdAt": "2020-12-22T23:45:47Z", "path": "bundles/org.openhab.binding.comfoair/src/main/java/org/openhab/binding/comfoair/internal/ComfoAirHandler.java", "diffHunk": "@@ -140,6 +152,8 @@ public void dispose() {\n             comfoAirConnector.close();\n         }\n \n+        updateState(ACTIVATE_CHANNEL_ID, OnOffType.OFF);", "originalCommit": "1bb3b54f8d8d0bfef826f10ea776d1b3e4e55c73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzg4NzA4Mg==", "url": "https://github.com/openhab/openhab-addons/pull/9401#discussion_r547887082", "bodyText": "I added these (also in the connect() method) to ensure that it is reflected in the item/channel state that the control is handed back to the external controller by comfoAirConnector.close()\n\n  \n    \n      openhab-addons/bundles/org.openhab.binding.comfoair/src/main/java/org/openhab/binding/comfoair/internal/ComfoAirSerialConnector.java\n    \n    \n        Lines 114 to 121\n      in\n      1bb3b54\n    \n    \n    \n    \n\n        \n          \n           ComfoAirCommand command = ComfoAirCommandType.getChangeCommand(ComfoAirCommandType.ACTIVATE.getKey(), \n        \n\n        \n          \n                   OnOffType.OFF); \n        \n\n        \n          \n            \n        \n\n        \n          \n           if (command != null) { \n        \n\n        \n          \n               sendCommand(command, ComfoAirCommandType.Constants.EMPTY_INT_ARRAY); \n        \n\n        \n          \n           } else { \n        \n\n        \n          \n               logger.debug(\"Failure while creating COMMAND: {}\", command); \n        \n\n        \n          \n           } \n        \n    \n  \n\n\nI admit that I'm not quite sure if this is necessary (if openHAB is shut down probably not, but what if the thing is just deactivated?). Thus, I'm fine with removing it here, if you think it's overkill.", "author": "boehan", "createdAt": "2020-12-23T10:25:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU2MDU0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODMzNTM2Mg==", "url": "https://github.com/openhab/openhab-addons/pull/9401#discussion_r548335362", "bodyText": "In the case where the thing is deactivated it might be ok. But since you can't tell the difference between thing deactivation and openhab shutdown it is better to play it safe and always treat it as a shutdown. So please remove any channel updates during disposal. If you need to send some commands to the device as part of shutdown then that is ok.", "author": "cpmeister", "createdAt": "2020-12-24T00:54:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU2MDU0NQ=="}], "type": "inlineReview", "revised_code": {"commit": "ad10f1adb1b81b65edede9498d7270445eaf8f25", "chunk": "diff --git a/bundles/org.openhab.binding.comfoair/src/main/java/org/openhab/binding/comfoair/internal/ComfoAirHandler.java b/bundles/org.openhab.binding.comfoair/src/main/java/org/openhab/binding/comfoair/internal/ComfoAirHandler.java\nindex c627f1e3e5..e2d4506345 100644\n--- a/bundles/org.openhab.binding.comfoair/src/main/java/org/openhab/binding/comfoair/internal/ComfoAirHandler.java\n+++ b/bundles/org.openhab.binding.comfoair/src/main/java/org/openhab/binding/comfoair/internal/ComfoAirHandler.java\n\n@@ -152,8 +152,6 @@ public class ComfoAirHandler extends BaseThingHandler {\n             comfoAirConnector.close();\n         }\n \n-        updateState(ACTIVATE_CHANNEL_ID, OnOffType.OFF);\n-\n         final ScheduledFuture<?> localPoller = poller;\n \n         if (localPoller != null) {\n"}}, {"oid": "ad10f1adb1b81b65edede9498d7270445eaf8f25", "url": "https://github.com/openhab/openhab-addons/commit/ad10f1adb1b81b65edede9498d7270445eaf8f25", "message": "Remove updateState on dispose\n\nSigned-off-by: Hans B\u00f6hm <h.boehm@gmx.at>", "committedDate": "2020-12-24T10:39:02Z", "type": "commit"}]}