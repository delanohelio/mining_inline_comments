{"pr_number": 8802, "pr_title": "[automower] Add planner, calendar and command channels", "pr_createdAt": "2020-10-19T10:52:15Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/8802", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQ2Nzc5Mw==", "url": "https://github.com/openhab/openhab-addons/pull/8802#discussion_r519467793", "bodyText": "As you don't do anything with the AutomowerCommand in case the command is a refresh I would fetch the command in the else clause of the refresh check...", "author": "maxpg", "createdAt": "2020-11-08T19:38:19Z", "path": "bundles/org.openhab.binding.automower/src/main/java/org/openhab/binding/automower/internal/things/AutomowerHandler.java", "diffHunk": "@@ -89,9 +110,24 @@ public AutomowerHandler(Thing thing) {\n \n     @Override\n     public void handleCommand(ChannelUID channelUID, Command command) {\n-        if (command instanceof RefreshType) {\n+        Optional<AutomowerCommand> commandName = AutomowerCommand.fromChannelUID(channelUID);", "originalCommit": "c14957e725b14132e7f2a9289d8848454706d637", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE3MTk0MA==", "url": "https://github.com/openhab/openhab-addons/pull/8802#discussion_r527171940", "bodyText": "@marcinczeczko can you comment on this?", "author": "fwolter", "createdAt": "2020-11-19T20:18:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQ2Nzc5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4Mjg3MTY2MA==", "url": "https://github.com/openhab/openhab-addons/pull/8802#discussion_r582871660", "bodyText": "Yep, it's a good idea. Will fix that", "author": "marcinczeczko", "createdAt": "2021-02-25T14:22:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQ2Nzc5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4Mjg3MjMwMA==", "url": "https://github.com/openhab/openhab-addons/pull/8802#discussion_r582872300", "bodyText": "Good point. Will update", "author": "marcinczeczko", "createdAt": "2021-02-25T14:23:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQ2Nzc5Mw=="}], "type": "inlineReview", "revised_code": {"commit": "b03627265628654315ffed21d9b3f26b2cbc62cf", "chunk": "diff --git a/bundles/org.openhab.binding.automower/src/main/java/org/openhab/binding/automower/internal/things/AutomowerHandler.java b/bundles/org.openhab.binding.automower/src/main/java/org/openhab/binding/automower/internal/things/AutomowerHandler.java\nindex 89f02d624f..cbc2744b9c 100644\n--- a/bundles/org.openhab.binding.automower/src/main/java/org/openhab/binding/automower/internal/things/AutomowerHandler.java\n+++ b/bundles/org.openhab.binding.automower/src/main/java/org/openhab/binding/automower/internal/things/AutomowerHandler.java\n\n@@ -110,16 +110,15 @@ public class AutomowerHandler extends BaseThingHandler {\n \n     @Override\n     public void handleCommand(ChannelUID channelUID, Command command) {\n-        Optional<AutomowerCommand> commandName = AutomowerCommand.fromChannelUID(channelUID);\n-        logger.debug(\"Received Automower command: {}\", commandName);\n-\n         if (RefreshType.REFRESH == command) {\n             logger.debug(\"Refreshing channel '{}'\", channelUID);\n             refreshChannels(channelUID);\n-        } else if (commandName.isPresent()) {\n-            logger.debug(\"Sending command '{}'\", commandName.get());\n-            getCommandValue(command).ifPresentOrElse(duration -> sendAutomowerCommand(commandName.get(), duration),\n-                    () -> sendAutomowerCommand(commandName.get()));\n+        } else {\n+            AutomowerCommand.fromChannelUID(channelUID).ifPresent(commandName -> {\n+                logger.debug(\"Sending command '{}'\", commandName);\n+                getCommandValue(command).ifPresentOrElse(duration -> sendAutomowerCommand(commandName, duration),\n+                        () -> sendAutomowerCommand(commandName));\n+            });\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQ2ODA0Ng==", "url": "https://github.com/openhab/openhab-addons/pull/8802#discussion_r519468046", "bodyText": "Thanks for fixing the problem with the error timestamp :-)", "author": "maxpg", "createdAt": "2020-11-08T19:40:34Z", "path": "bundles/org.openhab.binding.automower/src/main/java/org/openhab/binding/automower/internal/things/AutomowerHandler.java", "diffHunk": "@@ -243,26 +279,48 @@ public void sendAutomowerCommand(AutomowerCommand command, long commandDurationM\n         updateAutomowerState();\n     }\n \n+    private String restrictedState(RestrictedReason reason) {\n+        return \"RESTRICTED_\" + reason.name();\n+    }\n+\n     private void updateChannelState(Mower mower) {\n         if (isValidResult(mower)) {\n-            updateState(CHANNEL_MOWER_NAME, new StringType(mower.getAttributes().getSystem().getName()));\n-\n             updateState(CHANNEL_STATUS_MODE, new StringType(mower.getAttributes().getMower().getMode().name()));\n             updateState(CHANNEL_STATUS_ACTIVITY, new StringType(mower.getAttributes().getMower().getActivity().name()));\n-            updateState(CHANNEL_STATUS_STATE, new StringType(mower.getAttributes().getMower().getState().name()));\n \n-            Instant statusTimestamp = Instant.ofEpochMilli(mower.getAttributes().getMetadata().getStatusTimestamp());\n+            if (mower.getAttributes().getMower().getState() != State.RESTRICTED) {\n+                updateState(CHANNEL_STATUS_STATE, new StringType(mower.getAttributes().getMower().getState().name()));\n+            } else {\n+                updateState(CHANNEL_STATUS_STATE,\n+                        new StringType(restrictedState(mower.getAttributes().getPlanner().getRestrictedReason())));\n+            }\n+\n             updateState(CHANNEL_STATUS_LAST_UPDATE,\n-                    new DateTimeType(ZonedDateTime.ofInstant(statusTimestamp, ZoneId.systemDefault())));\n+                    new DateTimeType(toZonedDateTime(mower.getAttributes().getMetadata().getStatusTimestamp())));\n             updateState(CHANNEL_STATUS_BATTERY, new QuantityType<Dimensionless>(\n                     mower.getAttributes().getBattery().getBatteryPercent(), SmartHomeUnits.PERCENT));\n \n             updateState(CHANNEL_STATUS_ERROR_CODE, new DecimalType(mower.getAttributes().getMower().getErrorCode()));\n \n-            Instant errorCodeTimestamp = Instant.ofEpochMilli(mower.getAttributes().getMower().getErrorCodeTimestamp());\n-            updateState(CHANNEL_STATUS_ERROR_TIMESTAMP,\n-                    new DateTimeType(ZonedDateTime.ofInstant(errorCodeTimestamp, ZoneId.systemDefault())));\n+            long errorCodeTimestamp = mower.getAttributes().getMower().getErrorCodeTimestamp();\n+            if (errorCodeTimestamp == 0L) {\n+                updateState(CHANNEL_STATUS_ERROR_TIMESTAMP, UnDefType.NULL);", "originalCommit": "c14957e725b14132e7f2a9289d8848454706d637", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4Mjg3MDY4Mg==", "url": "https://github.com/openhab/openhab-addons/pull/8802#discussion_r582870682", "bodyText": "No problem :)", "author": "marcinczeczko", "createdAt": "2021-02-25T14:21:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQ2ODA0Ng=="}], "type": "inlineReview", "revised_code": {"commit": "b03627265628654315ffed21d9b3f26b2cbc62cf", "chunk": "diff --git a/bundles/org.openhab.binding.automower/src/main/java/org/openhab/binding/automower/internal/things/AutomowerHandler.java b/bundles/org.openhab.binding.automower/src/main/java/org/openhab/binding/automower/internal/things/AutomowerHandler.java\nindex 89f02d624f..cbc2744b9c 100644\n--- a/bundles/org.openhab.binding.automower/src/main/java/org/openhab/binding/automower/internal/things/AutomowerHandler.java\n+++ b/bundles/org.openhab.binding.automower/src/main/java/org/openhab/binding/automower/internal/things/AutomowerHandler.java\n\n@@ -298,7 +297,7 @@ public class AutomowerHandler extends BaseThingHandler {\n             updateState(CHANNEL_STATUS_LAST_UPDATE,\n                     new DateTimeType(toZonedDateTime(mower.getAttributes().getMetadata().getStatusTimestamp())));\n             updateState(CHANNEL_STATUS_BATTERY, new QuantityType<Dimensionless>(\n-                    mower.getAttributes().getBattery().getBatteryPercent(), SmartHomeUnits.PERCENT));\n+                    mower.getAttributes().getBattery().getBatteryPercent(), Units.PERCENT));\n \n             updateState(CHANNEL_STATUS_ERROR_CODE, new DecimalType(mower.getAttributes().getMower().getErrorCode()));\n \n"}}, {"oid": "b03627265628654315ffed21d9b3f26b2cbc62cf", "url": "https://github.com/openhab/openhab-addons/commit/b03627265628654315ffed21d9b3f26b2cbc62cf", "message": "Fixed review comments", "committedDate": "2021-02-25T22:04:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTkxNzE3OQ==", "url": "https://github.com/openhab/openhab-addons/pull/8802#discussion_r585917179", "bodyText": "The user can set an individual timezone in OH's settings. You can obtain it by injecting TimeZoneProvider.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    ZonedDateTime gmt = ZonedDateTime.ofInstant(Instant.ofEpochMilli(timestamp), ZoneOffset.UTC);\n          \n          \n            \n                    return ZonedDateTime.of(gmt.getYear(), gmt.getMonthValue(), gmt.getDayOfMonth(), gmt.getHour(), gmt.getMinute(),\n          \n          \n            \n                            gmt.getSecond(), gmt.getNano(), ZoneId.systemDefault());\n          \n          \n            \n                    LocalDateTime local = LocalDateTime.ofInstant(Instant.ofEpochMilli(timestamp), ZoneOffset.UTC);\n          \n          \n            \n                    return ZonedDateTime.of(local, timeZoneProvider.getTimeZone());", "author": "fwolter", "createdAt": "2021-03-02T21:19:24Z", "path": "bundles/org.openhab.binding.automower/src/main/java/org/openhab/binding/automower/internal/things/AutomowerHandler.java", "diffHunk": "@@ -280,4 +337,19 @@ private void initializeProperties(Mower mower) {\n \n         updateProperties(properties);\n     }\n+\n+    /**\n+     * Converts timestamp returned by the Automower API into local time-zone.\n+     * Timestamp returned by the API doesn't have offset and it always in the current time zone - it can be treated as\n+     * UTC.\n+     * Method builds a ZonedDateTime with same hour value but in the current system timezone.\n+     * \n+     * @param timestamp - Automower API timestamp\n+     * @return ZonedDateTime in system timezone\n+     */\n+    private ZonedDateTime toZonedDateTime(long timestamp) {\n+        ZonedDateTime gmt = ZonedDateTime.ofInstant(Instant.ofEpochMilli(timestamp), ZoneOffset.UTC);\n+        return ZonedDateTime.of(gmt.getYear(), gmt.getMonthValue(), gmt.getDayOfMonth(), gmt.getHour(), gmt.getMinute(),\n+                gmt.getSecond(), gmt.getNano(), ZoneId.systemDefault());", "originalCommit": "b03627265628654315ffed21d9b3f26b2cbc62cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjIzMjk4NQ==", "url": "https://github.com/openhab/openhab-addons/pull/8802#discussion_r586232985", "bodyText": "fixed", "author": "marcinczeczko", "createdAt": "2021-03-03T09:00:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTkxNzE3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "46a057eac25d4492cda3029002e24fa70b926c13", "chunk": "diff --git a/bundles/org.openhab.binding.automower/src/main/java/org/openhab/binding/automower/internal/things/AutomowerHandler.java b/bundles/org.openhab.binding.automower/src/main/java/org/openhab/binding/automower/internal/things/AutomowerHandler.java\nindex cbc2744b9c..ed3ef4d302 100644\n--- a/bundles/org.openhab.binding.automower/src/main/java/org/openhab/binding/automower/internal/things/AutomowerHandler.java\n+++ b/bundles/org.openhab.binding.automower/src/main/java/org/openhab/binding/automower/internal/things/AutomowerHandler.java\n\n@@ -348,8 +349,7 @@ public class AutomowerHandler extends BaseThingHandler {\n      * @return ZonedDateTime in system timezone\n      */\n     private ZonedDateTime toZonedDateTime(long timestamp) {\n-        ZonedDateTime gmt = ZonedDateTime.ofInstant(Instant.ofEpochMilli(timestamp), ZoneOffset.UTC);\n-        return ZonedDateTime.of(gmt.getYear(), gmt.getMonthValue(), gmt.getDayOfMonth(), gmt.getHour(), gmt.getMinute(),\n-                gmt.getSecond(), gmt.getNano(), ZoneId.systemDefault());\n+        LocalDateTime local = LocalDateTime.ofInstant(Instant.ofEpochMilli(timestamp), ZoneOffset.UTC);\n+        return ZonedDateTime.of(local, timeZoneProvider.getTimeZone());\n     }\n }\n"}}, {"oid": "46a057eac25d4492cda3029002e24fa70b926c13", "url": "https://github.com/openhab/openhab-addons/commit/46a057eac25d4492cda3029002e24fa70b926c13", "message": "[Automower] Enhanced binding:\n\t- Added support for the planner and calendar data\n\t- Added command channels\n\t- Updated docs\n\nSigned-off-by: Marcin Czeczko <marcin.czeczko@gmail.com>", "committedDate": "2021-03-03T08:59:33Z", "type": "commit"}, {"oid": "46a057eac25d4492cda3029002e24fa70b926c13", "url": "https://github.com/openhab/openhab-addons/commit/46a057eac25d4492cda3029002e24fa70b926c13", "message": "[Automower] Enhanced binding:\n\t- Added support for the planner and calendar data\n\t- Added command channels\n\t- Updated docs\n\nSigned-off-by: Marcin Czeczko <marcin.czeczko@gmail.com>", "committedDate": "2021-03-03T08:59:33Z", "type": "forcePushed"}, {"oid": "fb14699a51c9b53868aa6fdc6b0a2c23306356ab", "url": "https://github.com/openhab/openhab-addons/commit/fb14699a51c9b53868aa6fdc6b0a2c23306356ab", "message": "[Automower] Fixed consts with channel ids after removal of channel\ngroups. Improved the mower state update:\n- Cache the last read state from API\n- Use cached mower state so the items linked will always be up to date\n  without the need to wait for API refresh period.\n\nSigned-off-by: Marcin Czeczko <marcin.czeczko@gmail.com>", "committedDate": "2021-03-03T10:32:50Z", "type": "forcePushed"}, {"oid": "75303ff9bd8cbbbfcdf06c7bedbff9e61e6209a3", "url": "https://github.com/openhab/openhab-addons/commit/75303ff9bd8cbbbfcdf06c7bedbff9e61e6209a3", "message": "[Automower] Fixed consts with channel ids after removal of channel\ngroups. Improved the mower state update:\n- Cache the last read state from API\n- Use cached mower state so the items linked will always be up to date\n  without the need to wait for API refresh period.\n- Use timeZoneProvider to user user set timezone.\n\nSigned-off-by: Marcin Czeczko <marcin.czeczko@gmail.com>", "committedDate": "2021-03-04T07:36:01Z", "type": "commit"}, {"oid": "75303ff9bd8cbbbfcdf06c7bedbff9e61e6209a3", "url": "https://github.com/openhab/openhab-addons/commit/75303ff9bd8cbbbfcdf06c7bedbff9e61e6209a3", "message": "[Automower] Fixed consts with channel ids after removal of channel\ngroups. Improved the mower state update:\n- Cache the last read state from API\n- Use cached mower state so the items linked will always be up to date\n  without the need to wait for API refresh period.\n- Use timeZoneProvider to user user set timezone.\n\nSigned-off-by: Marcin Czeczko <marcin.czeczko@gmail.com>", "committedDate": "2021-03-04T07:36:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjczMDU0Mw==", "url": "https://github.com/openhab/openhab-addons/pull/8802#discussion_r602730543", "bodyText": "Did you remove this by intention?", "author": "fwolter", "createdAt": "2021-03-27T15:11:25Z", "path": "bundles/org.openhab.binding.automower/src/main/java/org/openhab/binding/automower/internal/things/AutomowerHandler.java", "diffHunk": "@@ -51,29 +53,39 @@\n import org.openhab.core.thing.binding.ThingHandlerService;\n import org.openhab.core.types.Command;\n import org.openhab.core.types.RefreshType;\n+import org.openhab.core.types.Type;\n+import org.openhab.core.types.UnDefType;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n+import com.google.gson.Gson;\n+\n /**\n  * The {@link AutomowerHandler} is responsible for handling commands, which are\n  * sent to one of the channels.\n  *\n  * @author Markus Pfleger - Initial contribution\n+ * @author Marcin Czeczko - Added support for planner & calendar data\n  */\n-@NonNullByDefault", "originalCommit": "75303ff9bd8cbbbfcdf06c7bedbff9e61e6209a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDQ2NjU0Ng==", "url": "https://github.com/openhab/openhab-addons/pull/8802#discussion_r604466546", "bodyText": "I think I did it intentionally that time due to the new class field mowerState but apparently I forgot to clean it up. Already fixed it.", "author": "marcinczeczko", "createdAt": "2021-03-30T22:14:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjczMDU0Mw=="}], "type": "inlineReview", "revised_code": {"commit": "0a3ef6ce74e94f8644cc517af64a63f825e28be5", "chunk": "diff --git a/bundles/org.openhab.binding.automower/src/main/java/org/openhab/binding/automower/internal/things/AutomowerHandler.java b/bundles/org.openhab.binding.automower/src/main/java/org/openhab/binding/automower/internal/things/AutomowerHandler.java\nindex e5f50317d0..de705216ad 100644\n--- a/bundles/org.openhab.binding.automower/src/main/java/org/openhab/binding/automower/internal/things/AutomowerHandler.java\n+++ b/bundles/org.openhab.binding.automower/src/main/java/org/openhab/binding/automower/internal/things/AutomowerHandler.java\n\n@@ -67,6 +67,7 @@ import com.google.gson.Gson;\n  * @author Markus Pfleger - Initial contribution\n  * @author Marcin Czeczko - Added support for planner & calendar data\n  */\n+@NonNullByDefault\n public class AutomowerHandler extends BaseThingHandler {\n     public static final Set<ThingTypeUID> SUPPORTED_THING_TYPES = Collections.singleton(THING_TYPE_AUTOMOWER);\n     private static final String NO_ID = \"NO_ID\";\n"}}, {"oid": "0a3ef6ce74e94f8644cc517af64a63f825e28be5", "url": "https://github.com/openhab/openhab-addons/commit/0a3ef6ce74e94f8644cc517af64a63f825e28be5", "message": "Rolledback NotNullByDefault annotation\n\nSigned-off-by: Marcin Czeczko <marcin.czeczko@gmail.com>", "committedDate": "2021-03-30T22:16:19Z", "type": "commit"}, {"oid": "0a3ef6ce74e94f8644cc517af64a63f825e28be5", "url": "https://github.com/openhab/openhab-addons/commit/0a3ef6ce74e94f8644cc517af64a63f825e28be5", "message": "Rolledback NotNullByDefault annotation\n\nSigned-off-by: Marcin Czeczko <marcin.czeczko@gmail.com>", "committedDate": "2021-03-30T22:16:19Z", "type": "forcePushed"}]}