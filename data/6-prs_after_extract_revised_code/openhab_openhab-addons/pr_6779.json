{"pr_number": 6779, "pr_title": "[miio] Xiaomi Robot Vacuum Channel \"state_code\" and \"error_code\" added", "pr_createdAt": "2020-01-06T15:56:48Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/6779", "timeline": [{"oid": "82739e354f31cf0a40907f013aea802271e01e72", "url": "https://github.com/openhab/openhab-addons/commit/82739e354f31cf0a40907f013aea802271e01e72", "message": "[miio] Channel state_code and error_code added\n\nUp to now, the status and error codes have only been output as text. On the one hand, this makes it complicated to create a mapping for your own status/error message (for example, in another language), and on the other hand, messages that are not yet implemented are only passed on as \"UNKNOWN\".\n\nThe two channels state_code and error_code now output the integers directly, so a mapping to numbers can be easily done and new codes are also output.\n\nSigned-off-by: Markus Schraufstetter <markus.schraufstetter@gmail.com>", "committedDate": "2020-01-06T15:48:11Z", "type": "commit"}, {"oid": "3d3220526848af89cd79c1fa02adf5616ce2690e", "url": "https://github.com/openhab/openhab-addons/commit/3d3220526848af89cd79c1fa02adf5616ce2690e", "message": "[miio] Direct forwarding of the codes so that status/error codes which are not known to the binding are also forwarded and are not displayed as status code 0 or error code -1.\n\nSigned-off-by: Markus Schraufstetter <markus.schraufstetter@gmail.com>", "committedDate": "2020-01-06T22:22:02Z", "type": "commit"}, {"oid": "1bc03762cc6f50fe9c6a6ad523d0a5e52958f911", "url": "https://github.com/openhab/openhab-addons/commit/1bc03762cc6f50fe9c6a6ad523d0a5e52958f911", "message": "[miio] Fixed unique labels for the two new channels\n\nSigned-off-by: Markus Schraufstetter <markus.schraufstetter@gmail.com>", "committedDate": "2020-01-09T11:29:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY5NjUzMA==", "url": "https://github.com/openhab/openhab-addons/pull/6779#discussion_r364696530", "bodyText": "Sorry for catching this not in the earlier review, but the codechecker also complaints that this is not camelcase\nShould be changed to errorCode", "author": "marcelrv", "createdAt": "2020-01-09T11:45:36Z", "path": "bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/handler/MiIoVacuumHandler.java", "diffHunk": "@@ -131,8 +131,9 @@ private boolean updateVacuumStatus(JsonObject statusData) {\n         updateState(CHANNEL_CLEAN_TIME,\n                 new DecimalType(TimeUnit.SECONDS.toMinutes(statusData.get(\"clean_time\").getAsLong())));\n         updateState(CHANNEL_DND_ENABLED, new DecimalType(statusData.get(\"dnd_enabled\").getAsBigDecimal()));\n-        updateState(CHANNEL_ERROR_CODE,\n-                new StringType(VacuumErrorType.getType(statusData.get(\"error_code\").getAsInt()).getDescription()));\n+        VacuumErrorType error_code = VacuumErrorType.getType(statusData.get(\"error_code\").getAsInt());", "originalCommit": "1bc03762cc6f50fe9c6a6ad523d0a5e52958f911", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "642dec1368322e0ab8d8ee2f0b86fd995bc61b25", "chunk": "diff --git a/bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/handler/MiIoVacuumHandler.java b/bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/handler/MiIoVacuumHandler.java\nindex eaedbc848a..48e49b6981 100644\n--- a/bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/handler/MiIoVacuumHandler.java\n+++ b/bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/handler/MiIoVacuumHandler.java\n\n@@ -131,13 +131,13 @@ public class MiIoVacuumHandler extends MiIoAbstractHandler {\n         updateState(CHANNEL_CLEAN_TIME,\n                 new DecimalType(TimeUnit.SECONDS.toMinutes(statusData.get(\"clean_time\").getAsLong())));\n         updateState(CHANNEL_DND_ENABLED, new DecimalType(statusData.get(\"dnd_enabled\").getAsBigDecimal()));\n-        VacuumErrorType error_code = VacuumErrorType.getType(statusData.get(\"error_code\").getAsInt());\n-        updateState(CHANNEL_ERROR, new StringType(error_code.getDescription()));\n+        VacuumErrorType errorCode = VacuumErrorType.getType(statusData.get(\"error_code\").getAsInt());\n+        updateState(CHANNEL_ERROR, new StringType(errorCode.getDescription()));\n         updateState(CHANNEL_ERROR_CODE, new DecimalType(statusData.get(\"error_code\").getAsInt()));\n         int fanLevel = statusData.get(\"fan_power\").getAsInt();\n-        FanModeType fanpower = FanModeType.getType(fanLevel);\n+        FanModeType fanPower = FanModeType.getType(fanLevel);\n         updateState(CHANNEL_FAN_POWER, new DecimalType(fanLevel));\n-        updateState(CHANNEL_FAN_CONTROL, new DecimalType(fanpower.getId()));\n+        updateState(CHANNEL_FAN_CONTROL, new DecimalType(fanPower.getId()));\n         updateState(CHANNEL_IN_CLEANING, new DecimalType(statusData.get(\"in_cleaning\").getAsBigDecimal()));\n         updateState(CHANNEL_MAP_PRESENT, new DecimalType(statusData.get(\"map_present\").getAsBigDecimal()));\n         StatusType state = StatusType.getType(statusData.get(\"state\").getAsInt());\n"}}, {"oid": "642dec1368322e0ab8d8ee2f0b86fd995bc61b25", "url": "https://github.com/openhab/openhab-addons/commit/642dec1368322e0ab8d8ee2f0b86fd995bc61b25", "message": "[miio] camelcase formatting\n\nSigned-off-by: Markus Schraufstetter <markus.schraufstetter@gmail.com>", "committedDate": "2020-01-09T11:59:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQxOTkyNQ==", "url": "https://github.com/openhab/openhab-addons/pull/6779#discussion_r365419925", "bodyText": "What is the benefit of writing this in two lines instead of one?", "author": "J-N-K", "createdAt": "2020-01-10T20:35:41Z", "path": "bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/handler/MiIoVacuumHandler.java", "diffHunk": "@@ -131,16 +131,18 @@ private boolean updateVacuumStatus(JsonObject statusData) {\n         updateState(CHANNEL_CLEAN_TIME,\n                 new DecimalType(TimeUnit.SECONDS.toMinutes(statusData.get(\"clean_time\").getAsLong())));\n         updateState(CHANNEL_DND_ENABLED, new DecimalType(statusData.get(\"dnd_enabled\").getAsBigDecimal()));\n-        updateState(CHANNEL_ERROR_CODE,\n-                new StringType(VacuumErrorType.getType(statusData.get(\"error_code\").getAsInt()).getDescription()));\n+        VacuumErrorType errorCode = VacuumErrorType.getType(statusData.get(\"error_code\").getAsInt());", "originalCommit": "642dec1368322e0ab8d8ee2f0b86fd995bc61b25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUxOTc0Mw==", "url": "https://github.com/openhab/openhab-addons/pull/6779#discussion_r365519743", "bodyText": "This has no real advantage. I had only taken it from the original code to make it consistent.", "author": "Markkuuss", "createdAt": "2020-01-11T12:52:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQxOTkyNQ=="}], "type": "inlineReview", "revised_code": {"commit": "a9cb4a46ca9ca7f8d8f312ff3ea01dff160c8161", "chunk": "diff --git a/bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/handler/MiIoVacuumHandler.java b/bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/handler/MiIoVacuumHandler.java\nindex 48e49b6981..2eb46ee7b8 100644\n--- a/bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/handler/MiIoVacuumHandler.java\n+++ b/bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/handler/MiIoVacuumHandler.java\n\n@@ -132,8 +132,8 @@ public class MiIoVacuumHandler extends MiIoAbstractHandler {\n                 new DecimalType(TimeUnit.SECONDS.toMinutes(statusData.get(\"clean_time\").getAsLong())));\n         updateState(CHANNEL_DND_ENABLED, new DecimalType(statusData.get(\"dnd_enabled\").getAsBigDecimal()));\n         VacuumErrorType errorCode = VacuumErrorType.getType(statusData.get(\"error_code\").getAsInt());\n-        updateState(CHANNEL_ERROR, new StringType(errorCode.getDescription()));\n-        updateState(CHANNEL_ERROR_CODE, new DecimalType(statusData.get(\"error_code\").getAsInt()));\n+        updateState(CHANNEL_ERROR_CODE, new StringType(errorCode.getDescription()));\n+        updateState(CHANNEL_ERROR_ID, new DecimalType(statusData.get(\"error_code\").getAsInt()));\n         int fanLevel = statusData.get(\"fan_power\").getAsInt();\n         FanModeType fanPower = FanModeType.getType(fanLevel);\n         updateState(CHANNEL_FAN_POWER, new DecimalType(fanLevel));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQyMDEyNQ==", "url": "https://github.com/openhab/openhab-addons/pull/6779#discussion_r365420125", "bodyText": "Same here: why is thsi a local variable (and other states are not)?", "author": "J-N-K", "createdAt": "2020-01-10T20:36:12Z", "path": "bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/handler/MiIoVacuumHandler.java", "diffHunk": "@@ -131,16 +131,18 @@ private boolean updateVacuumStatus(JsonObject statusData) {\n         updateState(CHANNEL_CLEAN_TIME,\n                 new DecimalType(TimeUnit.SECONDS.toMinutes(statusData.get(\"clean_time\").getAsLong())));\n         updateState(CHANNEL_DND_ENABLED, new DecimalType(statusData.get(\"dnd_enabled\").getAsBigDecimal()));\n-        updateState(CHANNEL_ERROR_CODE,\n-                new StringType(VacuumErrorType.getType(statusData.get(\"error_code\").getAsInt()).getDescription()));\n+        VacuumErrorType errorCode = VacuumErrorType.getType(statusData.get(\"error_code\").getAsInt());\n+        updateState(CHANNEL_ERROR, new StringType(errorCode.getDescription()));\n+        updateState(CHANNEL_ERROR_CODE, new DecimalType(statusData.get(\"error_code\").getAsInt()));\n         int fanLevel = statusData.get(\"fan_power\").getAsInt();\n-        FanModeType fanpower = FanModeType.getType(fanLevel);\n+        FanModeType fanPower = FanModeType.getType(fanLevel);", "originalCommit": "642dec1368322e0ab8d8ee2f0b86fd995bc61b25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUxOTcwMA==", "url": "https://github.com/openhab/openhab-addons/pull/6779#discussion_r365519700", "bodyText": "You are right, this makes no sense, I just made a small camel case changes. I just took it from the original code.", "author": "Markkuuss", "createdAt": "2020-01-11T12:51:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQyMDEyNQ=="}], "type": "inlineReview", "revised_code": {"commit": "a9cb4a46ca9ca7f8d8f312ff3ea01dff160c8161", "chunk": "diff --git a/bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/handler/MiIoVacuumHandler.java b/bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/handler/MiIoVacuumHandler.java\nindex 48e49b6981..2eb46ee7b8 100644\n--- a/bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/handler/MiIoVacuumHandler.java\n+++ b/bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/handler/MiIoVacuumHandler.java\n\n@@ -132,8 +132,8 @@ public class MiIoVacuumHandler extends MiIoAbstractHandler {\n                 new DecimalType(TimeUnit.SECONDS.toMinutes(statusData.get(\"clean_time\").getAsLong())));\n         updateState(CHANNEL_DND_ENABLED, new DecimalType(statusData.get(\"dnd_enabled\").getAsBigDecimal()));\n         VacuumErrorType errorCode = VacuumErrorType.getType(statusData.get(\"error_code\").getAsInt());\n-        updateState(CHANNEL_ERROR, new StringType(errorCode.getDescription()));\n-        updateState(CHANNEL_ERROR_CODE, new DecimalType(statusData.get(\"error_code\").getAsInt()));\n+        updateState(CHANNEL_ERROR_CODE, new StringType(errorCode.getDescription()));\n+        updateState(CHANNEL_ERROR_ID, new DecimalType(statusData.get(\"error_code\").getAsInt()));\n         int fanLevel = statusData.get(\"fan_power\").getAsInt();\n         FanModeType fanPower = FanModeType.getType(fanLevel);\n         updateState(CHANNEL_FAN_POWER, new DecimalType(fanLevel));\n"}}, {"oid": "a9cb4a46ca9ca7f8d8f312ff3ea01dff160c8161", "url": "https://github.com/openhab/openhab-addons/commit/a9cb4a46ca9ca7f8d8f312ff3ea01dff160c8161", "message": "[miio] Renamed to \"ID\" to avoid breaking changes.\n\nSigned-off-by: Markus Schraufstetter <markus.schraufstetter@gmail.com>", "committedDate": "2020-01-11T12:33:56Z", "type": "commit"}, {"oid": "00683b75564945231c83f55482231b225467ae26", "url": "https://github.com/openhab/openhab-addons/commit/00683b75564945231c83f55482231b225467ae26", "message": "[miio] Code refactoring\n\nSigned-off-by: Markus Schraufstetter <markus.schraufstetter@gmail.com>", "committedDate": "2020-01-11T12:44:28Z", "type": "commit"}]}