{"pr_number": 9094, "pr_title": "[yioremote] Make the Binding compatible to new firmware version of YIO Dock", "pr_createdAt": "2020-11-21T20:20:59Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/9094", "timeline": [{"oid": "596e8308e4365465d7b8d74e34bd2974f7fc5916", "url": "https://github.com/openhab/openhab-addons/commit/596e8308e4365465d7b8d74e34bd2974f7fc5916", "message": "Make the Binding compatible to new firmware version of YIO Dock\n\nSign Off Michael Loercher <michaelloercher\n\nSigned-off-by: Michael Loercher <MichaelLoercher@web.de>", "committedDate": "2020-11-21T20:29:41Z", "type": "commit"}, {"oid": "7d6917ea31a85c520ec071ffd8a580534e83b8c0", "url": "https://github.com/openhab/openhab-addons/commit/7d6917ea31a85c520ec071ffd8a580534e83b8c0", "message": "removed senseles debug\n\nSigned-off-by: Michael Loercher<MichaelLoercher@web.de>\nSigned-off-by: Michael Loercher <MichaelLoercher@web.de>", "committedDate": "2020-11-21T21:26:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk2NjAwMw==", "url": "https://github.com/openhab/openhab-addons/pull/9094#discussion_r528966003", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    JsonObject pingMessage = new JsonObject();\n          \n          \n            \n                    pingMessage.addProperty(\"type\", type);\n          \n          \n            \n                    pingMessage.addProperty(\"command\", command);\n          \n          \n            \n                    return pingMessage.toString();\n          \n          \n            \n                    return getPingMessageJsonObject().toString();", "author": "cpmeister", "createdAt": "2020-11-23T20:07:44Z", "path": "bundles/org.openhab.binding.yioremote/src/main/java/org/openhab/binding/yioremote/internal/dto/PingMessage.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.yioremote.internal.dto;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+\n+import com.google.gson.JsonObject;\n+\n+/**\n+ * The {@link PingMessage} the AuthenticationMessage DTO\n+ *\n+ *\n+ * @author Michael Loercher - Initial contribution\n+ */\n+@NonNullByDefault\n+public class PingMessage {\n+    private String type = \"dock\";\n+    private String command = \"ping\";\n+\n+    public String getType() {\n+        return type;\n+    }\n+\n+    public String getcommand() {\n+        return command;\n+    }\n+\n+    public void setToken(String command) {\n+        this.command = command;\n+    }\n+\n+    public JsonObject getPingMessageJsonObject() {\n+        JsonObject pingMessage = new JsonObject();\n+        pingMessage.addProperty(\"type\", type);\n+        pingMessage.addProperty(\"command\", command);\n+        return pingMessage;\n+    }\n+\n+    public String getPingMessageString() {\n+        JsonObject pingMessage = new JsonObject();\n+        pingMessage.addProperty(\"type\", type);\n+        pingMessage.addProperty(\"command\", command);\n+        return pingMessage.toString();", "originalCommit": "64aaca92bced592e65b0c2aa995338437bba872e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk4NjEyMg==", "url": "https://github.com/openhab/openhab-addons/pull/9094#discussion_r528986122", "bodyText": "done", "author": "miloit", "createdAt": "2020-11-23T20:47:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk2NjAwMw=="}], "type": "inlineReview", "revised_code": {"commit": "295d0ffdbd3fa45af068cafde7f3462f42b7d1b3", "chunk": "diff --git a/bundles/org.openhab.binding.yioremote/src/main/java/org/openhab/binding/yioremote/internal/dto/PingMessage.java b/bundles/org.openhab.binding.yioremote/src/main/java/org/openhab/binding/yioremote/internal/dto/PingMessage.java\nindex e93448e59a..574990129c 100644\n--- a/bundles/org.openhab.binding.yioremote/src/main/java/org/openhab/binding/yioremote/internal/dto/PingMessage.java\n+++ b/bundles/org.openhab.binding.yioremote/src/main/java/org/openhab/binding/yioremote/internal/dto/PingMessage.java\n\n@@ -47,9 +47,6 @@ public class PingMessage {\n     }\n \n     public String getPingMessageString() {\n-        JsonObject pingMessage = new JsonObject();\n-        pingMessage.addProperty(\"type\", type);\n-        pingMessage.addProperty(\"command\", command);\n-        return pingMessage.toString();\n+        return getPingMessageJsonObject.toString();\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk2NzU2OQ==", "url": "https://github.com/openhab/openhab-addons/pull/9094#discussion_r528967569", "bodyText": "resetHeartbeat() always returns true now, so this code will never get called anymore...", "author": "cpmeister", "createdAt": "2020-11-23T20:10:46Z", "path": "bundles/org.openhab.binding.yioremote/src/main/java/org/openhab/binding/yioremote/internal/YIOremoteDockHandler.java", "diffHunk": "@@ -337,11 +337,30 @@ private void disposeWebsocketPollingJob() {\n     private void pollingWebsocketJob() {\n         switch (yioRemoteDockActualStatus) {\n             case AUTHENTICATION_COMPLETE:\n-                if (getAndResetHeartbeat()) {\n-                    updateChannelString(GROUP_OUTPUT, STATUS_STRING_CHANNEL,\n-                            irCodeReceivedHandler.getCode() + irCodeReceivedHandler.getFormat());\n-                    logger.debug(\"heartBeat ok\");\n+                if (resetHeartbeat()) {\n                     sendMessage(YioRemoteMessages.HEARTBEAT_MESSAGE, \"\");\n+                    yioRemoteDockActualStatus = YioRemoteDockHandleStatus.CHECK_PONG;\n+                } else {\n+                    yioRemoteDockActualStatus = YioRemoteDockHandleStatus.COMMUNICATION_ERROR;\n+                }\n+                break;\n+            case SEND_PING:\n+                if (resetHeartbeat()) {\n+                    sendMessage(YioRemoteMessages.HEARTBEAT_MESSAGE, \"\");\n+                    yioRemoteDockActualStatus = YioRemoteDockHandleStatus.CHECK_PONG;\n+                } else {\n+                    yioRemoteDockActualStatus = YioRemoteDockHandleStatus.COMMUNICATION_ERROR;\n+                    updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR,\n+                            \"Connection lost no ping from YIO DOCK\");\n+                    disposeWebsocketPollingJob();\n+                    reconnectWebsocket();", "originalCommit": "64aaca92bced592e65b0c2aa995338437bba872e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk4NzA5MA==", "url": "https://github.com/openhab/openhab-addons/pull/9094#discussion_r528987090", "bodyText": "done", "author": "miloit", "createdAt": "2020-11-23T20:49:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk2NzU2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "295d0ffdbd3fa45af068cafde7f3462f42b7d1b3", "chunk": "diff --git a/bundles/org.openhab.binding.yioremote/src/main/java/org/openhab/binding/yioremote/internal/YIOremoteDockHandler.java b/bundles/org.openhab.binding.yioremote/src/main/java/org/openhab/binding/yioremote/internal/YIOremoteDockHandler.java\nindex 4555c56f34..004ebcc302 100644\n--- a/bundles/org.openhab.binding.yioremote/src/main/java/org/openhab/binding/yioremote/internal/YIOremoteDockHandler.java\n+++ b/bundles/org.openhab.binding.yioremote/src/main/java/org/openhab/binding/yioremote/internal/YIOremoteDockHandler.java\n\n@@ -337,24 +337,14 @@ public class YIOremoteDockHandler extends BaseThingHandler {\n     private void pollingWebsocketJob() {\n         switch (yioRemoteDockActualStatus) {\n             case AUTHENTICATION_COMPLETE:\n-                if (resetHeartbeat()) {\n-                    sendMessage(YioRemoteMessages.HEARTBEAT_MESSAGE, \"\");\n-                    yioRemoteDockActualStatus = YioRemoteDockHandleStatus.CHECK_PONG;\n-                } else {\n-                    yioRemoteDockActualStatus = YioRemoteDockHandleStatus.COMMUNICATION_ERROR;\n-                }\n+                resetHeartbeat();\n+                sendMessage(YioRemoteMessages.HEARTBEAT_MESSAGE, \"\");\n+                yioRemoteDockActualStatus = YioRemoteDockHandleStatus.CHECK_PONG;\n                 break;\n             case SEND_PING:\n-                if (resetHeartbeat()) {\n-                    sendMessage(YioRemoteMessages.HEARTBEAT_MESSAGE, \"\");\n-                    yioRemoteDockActualStatus = YioRemoteDockHandleStatus.CHECK_PONG;\n-                } else {\n-                    yioRemoteDockActualStatus = YioRemoteDockHandleStatus.COMMUNICATION_ERROR;\n-                    updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR,\n-                            \"Connection lost no ping from YIO DOCK\");\n-                    disposeWebsocketPollingJob();\n-                    reconnectWebsocket();\n-                }\n+\t\t\t\tresetHeartbeat();\n+                sendMessage(YioRemoteMessages.HEARTBEAT_MESSAGE, \"\");\n+                yioRemoteDockActualStatus = YioRemoteDockHandleStatus.CHECK_PONG;\n                 break;\n             case CHECK_PONG:\n                 if (getHeartbeat()) {\n"}}, {"oid": "c88b9c1b02b0382c69f60e60b1ac689c68b1c462", "url": "https://github.com/openhab/openhab-addons/commit/c88b9c1b02b0382c69f60e60b1ac689c68b1c462", "message": "revert files to origin\n\nSigned-off-by: Michael Loercher <michaelloercher@web.de>", "committedDate": "2020-11-23T20:38:17Z", "type": "commit"}, {"oid": "295d0ffdbd3fa45af068cafde7f3462f42b7d1b3", "url": "https://github.com/openhab/openhab-addons/commit/295d0ffdbd3fa45af068cafde7f3462f42b7d1b3", "message": "changed\n\nSigned-off-by: Michael Loercher <michaelloercher@web.de>", "committedDate": "2020-11-23T20:50:03Z", "type": "commit"}, {"oid": "eab1d1f638183e3175ed2251a85f6dbddec06fb9", "url": "https://github.com/openhab/openhab-addons/commit/eab1d1f638183e3175ed2251a85f6dbddec06fb9", "message": "Delete .classpath\n\nSigned-off-by: Michael Loercher <michaelloercher@web.de>", "committedDate": "2020-11-23T20:58:40Z", "type": "commit"}, {"oid": "fce356a362d2092289717693e256e1826765186c", "url": "https://github.com/openhab/openhab-addons/commit/fce356a362d2092289717693e256e1826765186c", "message": "changes for easier read\n\nSigned-off-by: Michael Loercher<michaelloercher@web.de>\nSigned-off-by: Michael Loercher <MichaelLoercher@web.de>", "committedDate": "2020-11-23T21:03:31Z", "type": "commit"}, {"oid": "9abb4d31dd0193b50c4acb83b141cdb60e1d1c9a", "url": "https://github.com/openhab/openhab-addons/commit/9abb4d31dd0193b50c4acb83b141cdb60e1d1c9a", "message": "Update of code\n\nSigned-off-by: Michael Loercher<michaelloercher@web.de>\nSigned-off-by: Michael Loercher <MichaelLoercher@web.de>", "committedDate": "2020-11-25T20:44:15Z", "type": "commit"}, {"oid": "ceed1a49d77fc06d2d8abcad89cfa9235c39f763", "url": "https://github.com/openhab/openhab-addons/commit/ceed1a49d77fc06d2d8abcad89cfa9235c39f763", "message": "code updates\n\nSigned-off-by: Michael Loercher<michaelloercher@web.de>\nSigned-off-by: Michael Loercher <MichaelLoercher@web.de>", "committedDate": "2020-11-25T20:54:37Z", "type": "commit"}]}