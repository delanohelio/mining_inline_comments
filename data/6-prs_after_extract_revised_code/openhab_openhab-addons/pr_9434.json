{"pr_number": 9434, "pr_title": "[homematic] For non HmIP dimmers stateDescription values must be corrected too", "pr_createdAt": "2020-12-19T17:27:13Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/9434", "timeline": [{"oid": "7a6aec45d0b6609a523e2750baf80b1e0a9c7537", "url": "https://github.com/openhab/openhab-addons/commit/7a6aec45d0b6609a523e2750baf80b1e0a9c7537", "message": "For non HmIP dimmers stateDescription values must be corrected too\n\nOlder HM dimmers are using a maximum values of 1.0. But also for these\ndevices the values must be corrected.\n\n\nSigned-off-by: Martin Herbst <develop@mherbst.de>", "committedDate": "2020-12-19T17:25:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM2ODA3NQ==", "url": "https://github.com/openhab/openhab-addons/pull/9434#discussion_r546368075", "bodyText": "float and double shouldn't be compared with ==. You could use >= and <=.", "author": "fwolter", "createdAt": "2020-12-20T12:09:09Z", "path": "bundles/org.openhab.binding.homematic/src/main/java/org/openhab/binding/homematic/internal/type/HomematicTypeGeneratorImpl.java", "diffHunk": "@@ -279,8 +279,9 @@ public StateOption createOption(String value, String description) {\n                 BigDecimal min = MetadataUtils.createBigDecimal(dp.getMinValue());\n                 BigDecimal max = MetadataUtils.createBigDecimal(dp.getMaxValue());\n                 BigDecimal step = MetadataUtils.createBigDecimal(dp.getStep());\n-                if (ITEM_TYPE_DIMMER.equals(itemType) && dp.getMaxValue().doubleValue() == 1.01d) {\n-                    // For dimmers with a max value of 1.01 the values must be corrected\n+                if (ITEM_TYPE_DIMMER.equals(itemType)\n+                        && (dp.getMaxValue().doubleValue() == 1.01d || dp.getMaxValue().doubleValue() == 1.0d)) {\n+                    // For dimmers with a max value of 1.01 or 1.0 the values must be corrected", "originalCommit": "7a6aec45d0b6609a523e2750baf80b1e0a9c7537", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM3Nzc3OA==", "url": "https://github.com/openhab/openhab-addons/pull/9434#discussion_r546377778", "bodyText": "I agree with you, that == is normally not a good idea for float/double. In this case I tested it with these values, but I changed the comparison to make it more safe.", "author": "MHerbst", "createdAt": "2020-12-20T13:33:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM2ODA3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM4MTEzMQ==", "url": "https://github.com/openhab/openhab-addons/pull/9434#discussion_r546381131", "bodyText": "Wouldn't it be better to create a new BigDecimal(dp.getMaxValue().toString()) and use compareTo(new BigDecimal(\"1.01\"))? Then the compared values would still make sense for the reader of the code.", "author": "XeS0r", "createdAt": "2020-12-20T14:01:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM2ODA3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM4MjgxNQ==", "url": "https://github.com/openhab/openhab-addons/pull/9434#discussion_r546382815", "bodyText": "I thought about using BigDecimal for the comparison but I wanted to avoid the overhead.", "author": "MHerbst", "createdAt": "2020-12-20T14:15:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM2ODA3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM4NzI2OQ==", "url": "https://github.com/openhab/openhab-addons/pull/9434#discussion_r546387269", "bodyText": "I've checked the code and maxValue from HmDataPoint() is already converted to BigDecimal() at that point. Therefore we could simply use the max variable for comparism.\nmax.compareTo(BigDecimal.valueof(\"1.0\") == 0 || max.compareTo(BigDecimal.valueof(\"1.01\") == 0\nMaybe that is a better solution. What do you think?", "author": "XeS0r", "createdAt": "2020-12-20T14:53:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM2ODA3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQxMjMxMQ==", "url": "https://github.com/openhab/openhab-addons/pull/9434#discussion_r546412311", "bodyText": "Hmm, I think this would be similar to my original solution with \"==\".", "author": "MHerbst", "createdAt": "2020-12-20T18:30:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM2ODA3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQxNTUxOA==", "url": "https://github.com/openhab/openhab-addons/pull/9434#discussion_r546415518", "bodyText": "max is BigDecimal() and therefore compareTo() would honor it's value properly instead of \"==\".", "author": "XeS0r", "createdAt": "2020-12-20T19:00:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM2ODA3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU5MzE3MQ==", "url": "https://github.com/openhab/openhab-addons/pull/9434#discussion_r546593171", "bodyText": "How should we proceed? I would really like to see this fix in OH3 before it will be released.", "author": "XeS0r", "createdAt": "2020-12-21T09:17:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM2ODA3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY2MDc0NQ==", "url": "https://github.com/openhab/openhab-addons/pull/9434#discussion_r546660745", "bodyText": "I agree to @XeS0r this is even more elegeant. The final version of OH3 is probably already built. In any case there's a complete freeze. So, this will probably go into 3.1.", "author": "fwolter", "createdAt": "2020-12-21T11:43:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM2ODA3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njg0OTU4Mg==", "url": "https://github.com/openhab/openhab-addons/pull/9434#discussion_r546849582", "bodyText": "OK, you conviced me. I have changed it to compareTo (valueOf is not available for String, instead a constructor must be used)", "author": "MHerbst", "createdAt": "2020-12-21T18:00:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM2ODA3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODg5OTUwNQ==", "url": "https://github.com/openhab/openhab-addons/pull/9434#discussion_r548899505", "bodyText": "@fwolter I have changed the coding according to your proposal. Maybe you can find some time to review it again (and hopefully merge it).", "author": "MHerbst", "createdAt": "2020-12-25T18:22:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM2ODA3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "123ca66459e04c30a66c5979b5dd3fbf445133dc", "chunk": "diff --git a/bundles/org.openhab.binding.homematic/src/main/java/org/openhab/binding/homematic/internal/type/HomematicTypeGeneratorImpl.java b/bundles/org.openhab.binding.homematic/src/main/java/org/openhab/binding/homematic/internal/type/HomematicTypeGeneratorImpl.java\nindex 15e1c0c8a5..1ae0724f56 100644\n--- a/bundles/org.openhab.binding.homematic/src/main/java/org/openhab/binding/homematic/internal/type/HomematicTypeGeneratorImpl.java\n+++ b/bundles/org.openhab.binding.homematic/src/main/java/org/openhab/binding/homematic/internal/type/HomematicTypeGeneratorImpl.java\n\n@@ -279,8 +279,8 @@ public class HomematicTypeGeneratorImpl implements HomematicTypeGenerator {\n                 BigDecimal min = MetadataUtils.createBigDecimal(dp.getMinValue());\n                 BigDecimal max = MetadataUtils.createBigDecimal(dp.getMaxValue());\n                 BigDecimal step = MetadataUtils.createBigDecimal(dp.getStep());\n-                if (ITEM_TYPE_DIMMER.equals(itemType)\n-                        && (dp.getMaxValue().doubleValue() == 1.01d || dp.getMaxValue().doubleValue() == 1.0d)) {\n+                if (ITEM_TYPE_DIMMER.equals(itemType) && dp.getMaxValue().doubleValue() > 0.9d \n+                        && dp.getMaxValue().doubleValue() <= 1.01d)) {\n                     // For dimmers with a max value of 1.01 or 1.0 the values must be corrected\n                     min = MetadataUtils.createBigDecimal(0);\n                     max = MetadataUtils.createBigDecimal(100);\n"}}, {"oid": "123ca66459e04c30a66c5979b5dd3fbf445133dc", "url": "https://github.com/openhab/openhab-addons/commit/123ca66459e04c30a66c5979b5dd3fbf445133dc", "message": "Address review comments and make comparison safer\n\nSigned-off-by: Martin Herbst <develop@mherbst.de>", "committedDate": "2020-12-20T13:28:52Z", "type": "commit"}, {"oid": "82ab0880b289ca043abec8ddfdea990218874e58", "url": "https://github.com/openhab/openhab-addons/commit/82ab0880b289ca043abec8ddfdea990218874e58", "message": "One closing bracket too much\n\nSigned-off-by: Martin Herbst <develop@mherbst.de>", "committedDate": "2020-12-20T13:31:55Z", "type": "commit"}, {"oid": "6d5ff3c3f4d8c61c0da2374c9a8fb27cfb27dbfa", "url": "https://github.com/openhab/openhab-addons/commit/6d5ff3c3f4d8c61c0da2374c9a8fb27cfb27dbfa", "message": "Changed comparison to check with \"equals\"\n\nSigned-off-by: Martin Herbst <develop@mherbst.de>", "committedDate": "2020-12-21T17:59:18Z", "type": "commit"}]}