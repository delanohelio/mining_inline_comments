{"pr_number": 1688, "pr_title": "HIVE-24403: change min_history_level to make it compatible with older versions", "pr_createdAt": "2020-11-18T20:10:10Z", "pr_url": "https://github.com/apache/hive/pull/1688", "timeline": [{"oid": "8f19c8825125ee029bc2cbdc44b5a0532890e0c6", "url": "https://github.com/apache/hive/commit/8f19c8825125ee029bc2cbdc44b5a0532890e0c6", "message": "HIVE-24403: change min_history_level to make it compatible with older versions", "committedDate": "2020-11-18T20:06:27Z", "type": "commit"}, {"oid": "8860053501848d78491929abb1cc240b3f4dcec7", "url": "https://github.com/apache/hive/commit/8860053501848d78491929abb1cc240b3f4dcec7", "message": "Add test and tableNotExist check", "committedDate": "2020-11-19T11:25:04Z", "type": "commit"}, {"oid": "1220f0210ee0b669728e8976b8e2f8293463b5ea", "url": "https://github.com/apache/hive/commit/1220f0210ee0b669728e8976b8e2f8293463b5ea", "message": "Fix test results", "committedDate": "2020-11-19T15:42:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI0MjUzNg==", "url": "https://github.com/apache/hive/pull/1688#discussion_r530242536", "bodyText": "That's not a test class. Production code becomes massive because of that.", "author": "deniskuzZ", "createdAt": "2020-11-25T09:54:01Z", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnDbUtil.java", "diffHunk": "@@ -385,6 +391,26 @@ public static String queryToString(Configuration conf, String query, boolean inc\n     return sb.toString();\n   }\n \n+  /**\n+   * This is only for testing, it does not use the connectionPool from TxnHandler!\n+   * @param conf\n+   * @param query\n+   * @throws Exception\n+   */\n+  @VisibleForTesting\n+  public static void executeUpdate(Configuration conf, String query)", "originalCommit": "1220f0210ee0b669728e8976b8e2f8293463b5ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM1NzE1MA==", "url": "https://github.com/apache/hive/pull/1688#discussion_r534357150", "bodyText": "Well, this class is a test utility.\n/**\n\nUtility methods for creating and destroying txn database/schema, plus methods for\nquerying against metastore tables.\nPlaced here in a separate class so it can be shared across unit tests.\n*/\npublic final class TxnDbUtil\n\nThe problem is more like getEpochFn and executeQueriesInBatchNoCount was added to this class, those are production code. I know it would be nicer if it would be in a test package, but then it would be harder to use in 5 different projects", "author": "pvargacl", "createdAt": "2020-12-02T17:39:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI0MjUzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM2NjU0MQ==", "url": "https://github.com/apache/hive/pull/1688#discussion_r534366541", "bodyText": "in this case we should consider refactoring this class", "author": "deniskuzZ", "createdAt": "2020-12-02T17:53:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI0MjUzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTA1MDA2OA==", "url": "https://github.com/apache/hive/pull/1688#discussion_r535050068", "bodyText": "Created a Jira for that: https://issues.apache.org/jira/browse/HIVE-24477", "author": "pvargacl", "createdAt": "2020-12-03T10:12:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI0MjUzNg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI0NzQ4NA==", "url": "https://github.com/apache/hive/pull/1688#discussion_r530247484", "bodyText": "you can just select 1", "author": "deniskuzZ", "createdAt": "2020-11-25T10:00:55Z", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java", "diffHunk": "@@ -390,6 +404,42 @@ public void setConf(Configuration conf){\n     }\n   }\n \n+  /**\n+   * Check if min_history_level table is usable\n+   * @return\n+   * @throws MetaException\n+   */\n+  private boolean checkMinHistoryLevelTable(boolean configValue) throws MetaException {\n+    if (!configValue) {\n+      // don't check it if disabled\n+      return false;\n+    }\n+    Connection dbConn = null;\n+    boolean tableExists = true;\n+    try {\n+      dbConn = getDbConn(Connection.TRANSACTION_READ_COMMITTED);\n+      try (Statement stmt = dbConn.createStatement()) {\n+        // Dummy query to see if table exists\n+        try (ResultSet rs = stmt.executeQuery(\"SELECT MIN(\\\"MHL_MIN_OPEN_TXNID\\\") FROM \\\"MIN_HISTORY_LEVEL\\\"\")) {", "originalCommit": "1220f0210ee0b669728e8976b8e2f8293463b5ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM1NzU2Nw==", "url": "https://github.com/apache/hive/pull/1688#discussion_r534357567", "bodyText": "fixed", "author": "pvargacl", "createdAt": "2020-12-02T17:39:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI0NzQ4NA=="}], "type": "inlineReview", "revised_code": {"commit": "1a18b24af8518ac1daae894045076a4c8ea3ebf1", "chunk": "diff --git a/standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java b/standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java\nindex 19cad652ec..5fa525b4bd 100644\n--- a/standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java\n+++ b/standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java\n\n@@ -420,7 +421,7 @@ private boolean checkMinHistoryLevelTable(boolean configValue) throws MetaExcept\n       dbConn = getDbConn(Connection.TRANSACTION_READ_COMMITTED);\n       try (Statement stmt = dbConn.createStatement()) {\n         // Dummy query to see if table exists\n-        try (ResultSet rs = stmt.executeQuery(\"SELECT MIN(\\\"MHL_MIN_OPEN_TXNID\\\") FROM \\\"MIN_HISTORY_LEVEL\\\"\")) {\n+        try (ResultSet rs = stmt.executeQuery(\"SELECT 1 FROM \\\"MIN_HISTORY_LEVEL\\\"\")) {\n           rs.next();\n         }\n       }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI1MDU5NA==", "url": "https://github.com/apache/hive/pull/1688#discussion_r530250594", "bodyText": "why not to embed getMinOpenTxnIdWaterMark(dbConn) inside of addTxnToMinHistoryLevel and remove above minOpenTxnId block?", "author": "deniskuzZ", "createdAt": "2020-11-25T10:05:30Z", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java", "diffHunk": "@@ -670,6 +725,8 @@ public OpenTxnsResponse openTxns(OpenTxnRequest rqst) throws MetaException {\n \n       assert txnIds.size() == numTxns;\n \n+      addTxnToMinHistoryLevel(dbConn, txnIds, minOpenTxnId);", "originalCommit": "1220f0210ee0b669728e8976b8e2f8293463b5ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM2NTcxNA==", "url": "https://github.com/apache/hive/pull/1688#discussion_r534365714", "bodyText": "That was my first intent, but it resulted in lock timeout, after inserting the new records in the txns table, the min open select was not running", "author": "pvargacl", "createdAt": "2020-12-02T17:51:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI1MDU5NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI1MzcwOA==", "url": "https://github.com/apache/hive/pull/1688#discussion_r530253708", "bodyText": "Are you covering the case that schema change doesn't force any restart? Lot's of code duplication, can you wrap needed methods with aspect?", "author": "deniskuzZ", "createdAt": "2020-11-25T10:10:17Z", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java", "diffHunk": "@@ -5094,6 +5153,99 @@ public void countOpenTxns() throws MetaException {\n     }\n   }\n \n+  /**\n+   * Add min history level entry for each generated txn record\n+   * @param dbConn Connection\n+   * @param txnIds new transaction ids\n+   * @deprecated Remove this method when min_history_level table is dropped\n+   * @throws SQLException ex\n+   */\n+  @Deprecated\n+  private void addTxnToMinHistoryLevel(Connection dbConn, List<Long> txnIds, long minOpenTxnId) throws SQLException {\n+    if (!useMinHistoryLevel) {\n+      return;\n+    }\n+    // Need to register minimum open txnid for current transactions into MIN_HISTORY table.\n+    try (Statement stmt = dbConn.createStatement()) {\n+\n+      List<String> rows = txnIds.stream().map(txnId -> txnId + \", \" + minOpenTxnId).collect(Collectors.toList());\n+\n+      // Insert transaction entries into MIN_HISTORY_LEVEL.\n+      List<String> inserts =\n+          sqlGenerator.createInsertValuesStmt(\"\\\"MIN_HISTORY_LEVEL\\\" (\\\"MHL_TXNID\\\", \\\"MHL_MIN_OPEN_TXNID\\\")\", rows);\n+      for (String insert : inserts) {\n+        LOG.debug(\"Going to execute insert <\" + insert + \">\");\n+        stmt.execute(insert);\n+      }\n+      LOG.info(\"Added entries to MIN_HISTORY_LEVEL for current txns: (\" + txnIds + \") with min_open_txn: \" + minOpenTxnId);\n+    } catch (SQLException e) {\n+      if (dbProduct.isTableNotExists(e)) {\n+        // If the table does not exists anymore, we disable the flag and start to work the new way\n+        // This enables to switch to the new functionality without a restart\n+        useMinHistoryLevel = false;", "originalCommit": "1220f0210ee0b669728e8976b8e2f8293463b5ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM4MzM4NA==", "url": "https://github.com/apache/hive/pull/1688#discussion_r534383384", "bodyText": "The idea is multiple HMS is using the same backend db, you upgrade them one by one, the last one changes the schema, all the others change to the new functionality, after the first call to min_history table. Do you have any practical example of wrapping them in aspect, I do not want to much more code complexity just to avoid checking an exception in four places.", "author": "pvargacl", "createdAt": "2020-12-02T18:19:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI1MzcwOA=="}], "type": "inlineReview", "revised_code": {"commit": "1a18b24af8518ac1daae894045076a4c8ea3ebf1", "chunk": "diff --git a/standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java b/standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java\nindex 19cad652ec..5fa525b4bd 100644\n--- a/standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java\n+++ b/standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java\n\n@@ -5179,7 +5192,7 @@ private void addTxnToMinHistoryLevel(Connection dbConn, List<Long> txnIds, long\n       }\n       LOG.info(\"Added entries to MIN_HISTORY_LEVEL for current txns: (\" + txnIds + \") with min_open_txn: \" + minOpenTxnId);\n     } catch (SQLException e) {\n-      if (dbProduct.isTableNotExists(e)) {\n+      if (dbProduct.isTableNotExistsError(e)) {\n         // If the table does not exists anymore, we disable the flag and start to work the new way\n         // This enables to switch to the new functionality without a restart\n         useMinHistoryLevel = false;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI4NDQ5NQ==", "url": "https://github.com/apache/hive/pull/1688#discussion_r530284495", "bodyText": "maybe rename to isTableNotExistsError", "author": "deniskuzZ", "createdAt": "2020-11-25T10:58:12Z", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/DatabaseProduct.java", "diffHunk": "@@ -186,6 +186,19 @@ public boolean isDeadlock(SQLException e) {\n             || e.getMessage().contains(\"can't serialize access for this transaction\"))));\n   }\n \n+  /**\n+   * Is the given exception a table not found exception\n+   * @param e Exception\n+   * @return\n+   */\n+  public boolean isTableNotExists(SQLException e) {", "originalCommit": "1220f0210ee0b669728e8976b8e2f8293463b5ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM4NTEwNA==", "url": "https://github.com/apache/hive/pull/1688#discussion_r534385104", "bodyText": "Done", "author": "pvargacl", "createdAt": "2020-12-02T18:22:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI4NDQ5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "1a18b24af8518ac1daae894045076a4c8ea3ebf1", "chunk": "diff --git a/standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/DatabaseProduct.java b/standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/DatabaseProduct.java\nindex 1f82623c02..45aff35b9a 100644\n--- a/standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/DatabaseProduct.java\n+++ b/standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/DatabaseProduct.java\n\n@@ -191,7 +191,7 @@ public boolean isDeadlock(SQLException e) {\n    * @param e Exception\n    * @return\n    */\n-  public boolean isTableNotExists(SQLException e) {\n+  public boolean isTableNotExistsError(SQLException e) {\n     return (isPOSTGRES() && \"42P01\".equalsIgnoreCase(e.getSQLState()))\n         || (isMYSQL() && \"42S02\".equalsIgnoreCase(e.getSQLState()))\n         || (isORACLE() && \"42000\".equalsIgnoreCase(e.getSQLState()) && e.getMessage().contains(\"ORA-00942\"))\n"}}, {"oid": "2be472755fe31521147f56206f3c0adc7002e0f2", "url": "https://github.com/apache/hive/commit/2be472755fe31521147f56206f3c0adc7002e0f2", "message": "Merge remote-tracking branch 'origin/master' into HIVE-24403-min_history_rollback\n\n# Conflicts:\n#\tstandalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnStore.java", "committedDate": "2020-12-02T13:39:47Z", "type": "commit"}, {"oid": "1a18b24af8518ac1daae894045076a4c8ea3ebf1", "url": "https://github.com/apache/hive/commit/1a18b24af8518ac1daae894045076a4c8ea3ebf1", "message": "address review comments", "committedDate": "2020-12-02T18:27:33Z", "type": "commit"}]}