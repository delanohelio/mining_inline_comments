{"pr_number": 1532, "pr_title": "HIVE-20137: truncate for transactional tables", "pr_createdAt": "2020-09-28T13:48:55Z", "pr_url": "https://github.com/apache/hive/pull/1532", "timeline": [{"oid": "7becbb6e86215c239a3739948bcba8acad999ab9", "url": "https://github.com/apache/hive/commit/7becbb6e86215c239a3739948bcba8acad999ab9", "message": "HIVE-20137: truncate for transactional tables", "committedDate": "2020-09-28T13:46:12Z", "type": "commit"}, {"oid": "639d2f67a0c7a15368b74e97f8f96713a2e42c15", "url": "https://github.com/apache/hive/commit/639d2f67a0c7a15368b74e97f8f96713a2e42c15", "message": "Fix tests", "committedDate": "2020-09-28T20:32:52Z", "type": "commit"}, {"oid": "923e859aa3901bc7eb7193ca623c57679c9404b4", "url": "https://github.com/apache/hive/commit/923e859aa3901bc7eb7193ca623c57679c9404b4", "message": "Quickstat overrides truncated values", "committedDate": "2020-09-29T12:05:17Z", "type": "commit"}, {"oid": "d0a942a9916809e02130647980229c6a3ac76b35", "url": "https://github.com/apache/hive/commit/d0a942a9916809e02130647980229c6a3ac76b35", "message": "Quickstat overrides truncated values - test fix", "committedDate": "2020-09-29T15:43:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA3MTk5MQ==", "url": "https://github.com/apache/hive/pull/1532#discussion_r498071991", "bodyText": "could we remove those and reference constants from AcidConstants directly", "author": "deniskuzZ", "createdAt": "2020-10-01T08:29:27Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/io/AcidUtils.java", "diffHunk": "@@ -114,16 +114,16 @@\n public class AcidUtils {\n   // This key will be put in the conf file when planning an acid operation\n   public static final String CONF_ACID_KEY = \"hive.doing.acid\";\n-  public static final String BASE_PREFIX = \"base_\";\n+  public static final String BASE_PREFIX = AcidConstants.BASE_PREFIX;", "originalCommit": "d0a942a9916809e02130647980229c6a3ac76b35", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODIwNDk4Nw==", "url": "https://github.com/apache/hive/pull/1532#discussion_r498204987", "bodyText": "I am not sure I want to remove these public constants, the AcidUtils is unfortunately is being used by spark-acid and it might break compatibility...", "author": "pvargacl", "createdAt": "2020-10-01T12:28:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA3MTk5MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA3MjQxMw==", "url": "https://github.com/apache/hive/pull/1532#discussion_r498072413", "bodyText": "could we rename local var to truncateFiles or something (same as below)", "author": "deniskuzZ", "createdAt": "2020-10-01T08:30:10Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/ddl/table/misc/truncate/TruncateTableAnalyzer.java", "diffHunk": "@@ -112,23 +113,27 @@ private void checkTruncateEligibility(ASTNode ast, ASTNode root, String tableNam\n \n   private void addTruncateTableOutputs(ASTNode root, Table table, Map<String, String> partitionSpec)\n       throws SemanticException {\n+    boolean shared = AcidUtils.isTransactionalTable(table) &&", "originalCommit": "d0a942a9916809e02130647980229c6a3ac76b35", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ff482be8cca848b0e41820efd420211eadd5c3eb", "chunk": "diff --git a/ql/src/java/org/apache/hadoop/hive/ql/ddl/table/misc/truncate/TruncateTableAnalyzer.java b/ql/src/java/org/apache/hadoop/hive/ql/ddl/table/misc/truncate/TruncateTableAnalyzer.java\nindex e63e94a0de..ee8a3a162e 100644\n--- a/ql/src/java/org/apache/hadoop/hive/ql/ddl/table/misc/truncate/TruncateTableAnalyzer.java\n+++ b/ql/src/java/org/apache/hadoop/hive/ql/ddl/table/misc/truncate/TruncateTableAnalyzer.java\n\n@@ -113,10 +113,10 @@ private void checkTruncateEligibility(ASTNode ast, ASTNode root, String tableNam\n \n   private void addTruncateTableOutputs(ASTNode root, Table table, Map<String, String> partitionSpec)\n       throws SemanticException {\n-    boolean shared = AcidUtils.isTransactionalTable(table) &&\n+    boolean truncateKeepsDataFiles = AcidUtils.isTransactionalTable(table) &&\n         MetastoreConf.getBoolVar(conf, MetastoreConf.ConfVars.TRUNCATE_ACID_USE_BASE);\n     WriteEntity.WriteType writeType =\n-        shared ? WriteEntity.WriteType.DDL_EXCL_WRITE : WriteEntity.WriteType.DDL_EXCLUSIVE;\n+        truncateKeepsDataFiles ? WriteEntity.WriteType.DDL_EXCL_WRITE : WriteEntity.WriteType.DDL_EXCLUSIVE;\n     if (partitionSpec == null) {\n       if (!table.isPartitioned()) {\n         outputs.add(new WriteEntity(table, writeType));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA3NjcyMQ==", "url": "https://github.com/apache/hive/pull/1532#discussion_r498076721", "bodyText": "Do you think it would make sense to move metaFile creation under MetaDataFile class, not sure however it should be under AcidConstants?", "author": "deniskuzZ", "createdAt": "2020-10-01T08:37:07Z", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/HiveMetaStore.java", "diffHunk": "@@ -3357,6 +3355,52 @@ private void truncateTableInternal(String dbName, String tableName, List<String>\n       }\n     }\n \n+    /**\n+     * Add an empty baseDir with a truncate metadatafile\n+     * @param location\n+     * @param writeId\n+     * @param fs\n+     * @throws Exception\n+     */\n+    private void addTruncateBaseFile(Path location, long writeId, FileSystem fs) throws Exception {\n+      Path basePath = new Path(location, AcidConstants.baseDir(writeId));\n+      fs.mkdirs(basePath);\n+      // We can not leave the folder empty, otherwise it will be skipped at some file listing in AcidUtils\n+      // No need for a data file, a simple metadata is enough", "originalCommit": "d0a942a9916809e02130647980229c6a3ac76b35", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODIyNDc3Ng==", "url": "https://github.com/apache/hive/pull/1532#discussion_r498224776", "bodyText": "added the write to the MetaDataFile and moved it out from the AcidConstants class", "author": "pvargacl", "createdAt": "2020-10-01T13:00:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA3NjcyMQ=="}], "type": "inlineReview", "revised_code": {"commit": "ff482be8cca848b0e41820efd420211eadd5c3eb", "chunk": "diff --git a/standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/HiveMetaStore.java b/standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/HiveMetaStore.java\nindex 12c9f3a131..aded417eb0 100644\n--- a/standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/HiveMetaStore.java\n+++ b/standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/HiveMetaStore.java\n\n@@ -3357,9 +3355,9 @@ private void truncateTableInternal(String dbName, String tableName, List<String>\n \n     /**\n      * Add an empty baseDir with a truncate metadatafile\n-     * @param location\n-     * @param writeId\n-     * @param fs\n+     * @param location partition or table directory\n+     * @param writeId allocated writeId\n+     * @param fs FileSystem\n      * @throws Exception\n      */\n     private void addTruncateBaseFile(Path location, long writeId, FileSystem fs) throws Exception {\n"}}, {"oid": "ff482be8cca848b0e41820efd420211eadd5c3eb", "url": "https://github.com/apache/hive/commit/ff482be8cca848b0e41820efd420211eadd5c3eb", "message": "Address review comments", "committedDate": "2020-10-01T12:46:00Z", "type": "commit"}]}