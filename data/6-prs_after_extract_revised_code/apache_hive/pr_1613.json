{"pr_number": 1613, "pr_title": "HIVE-24314: compactor.Cleaner should not set state mark cleaned if it didn't remove any files", "pr_createdAt": "2020-10-27T11:03:43Z", "pr_url": "https://github.com/apache/hive/pull/1613", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDEwMjY0OA==", "url": "https://github.com/apache/hive/pull/1613#discussion_r514102648", "bodyText": "You can use org.apache.hive.common.util.Ref for this", "author": "pvargacl", "createdAt": "2020-10-29T09:05:30Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/txn/compactor/Cleaner.java", "diffHunk": "@@ -201,16 +201,17 @@ private void clean(CompactionInfo ci, long minOpenTxnGLB) throws MetaException {\n         LOG.debug(\"Cleaning based on writeIdList: \" + validWriteIdList);\n       }\n \n+      final boolean[] removedFiles = new boolean[1];", "originalCommit": "57615ae80154e618edd3c5802d13597654fc2cb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDM2MzYzMQ==", "url": "https://github.com/apache/hive/pull/1613#discussion_r514363631", "bodyText": "Done.", "author": "klcopp", "createdAt": "2020-10-29T15:45:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDEwMjY0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkwMDY5Nw==", "url": "https://github.com/apache/hive/pull/1613#discussion_r514900697", "bodyText": "+1", "author": "pvargacl", "createdAt": "2020-10-30T06:49:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDEwMjY0OA=="}], "type": "inlineReview", "revised_code": {"commit": "b3c2309cccf6e77e4a4d209d4e15d3fd3ba598b5", "chunk": "diff --git a/ql/src/java/org/apache/hadoop/hive/ql/txn/compactor/Cleaner.java b/ql/src/java/org/apache/hadoop/hive/ql/txn/compactor/Cleaner.java\nindex fd0ff0b863..d558ff45b8 100644\n--- a/ql/src/java/org/apache/hadoop/hive/ql/txn/compactor/Cleaner.java\n+++ b/ql/src/java/org/apache/hadoop/hive/ql/txn/compactor/Cleaner.java\n\n@@ -201,9 +201,9 @@ private void clean(CompactionInfo ci, long minOpenTxnGLB) throws MetaException {\n         LOG.debug(\"Cleaning based on writeIdList: \" + validWriteIdList);\n       }\n \n-      final boolean[] removedFiles = new boolean[1];\n+      Ref<Boolean> removedFiles = Ref.from(false);\n       if (runJobAsSelf(ci.runAs)) {\n-        removedFiles[0] = removeFiles(location, validWriteIdList, ci);\n+        removedFiles.value = removeFiles(location, validWriteIdList, ci);\n       } else {\n         LOG.info(\"Cleaning as user \" + ci.runAs + \" for \" + ci.getFullPartitionName());\n         UserGroupInformation ugi = UserGroupInformation.createProxyUser(ci.runAs,\n"}}, {"oid": "681c37ea2fa8c4fd9135c7b94294499521400b80", "url": "https://github.com/apache/hive/commit/681c37ea2fa8c4fd9135c7b94294499521400b80", "message": "HIVE-24314: compactor.Cleaner should not set state mark cleaned if it didn't remove any files", "committedDate": "2020-11-02T15:08:55Z", "type": "commit"}, {"oid": "b3c2309cccf6e77e4a4d209d4e15d3fd3ba598b5", "url": "https://github.com/apache/hive/commit/b3c2309cccf6e77e4a4d209d4e15d3fd3ba598b5", "message": "Addressed review comments, ignored tests that will be fixed in #1618", "committedDate": "2020-11-02T15:08:55Z", "type": "commit"}, {"oid": "ca37ae3fd8fbfc6f67521b03dd050c5f4eb7dfc5", "url": "https://github.com/apache/hive/commit/ca37ae3fd8fbfc6f67521b03dd050c5f4eb7dfc5", "message": "Additional logging", "committedDate": "2020-11-02T15:08:55Z", "type": "commit"}, {"oid": "3c1ce0b9f071aad4f1ed70a82c6c0270b48fc0ec", "url": "https://github.com/apache/hive/commit/3c1ce0b9f071aad4f1ed70a82c6c0270b48fc0ec", "message": "Ignored wrong test", "committedDate": "2020-11-02T15:08:55Z", "type": "commit"}, {"oid": "3c1ce0b9f071aad4f1ed70a82c6c0270b48fc0ec", "url": "https://github.com/apache/hive/commit/3c1ce0b9f071aad4f1ed70a82c6c0270b48fc0ec", "message": "Ignored wrong test", "committedDate": "2020-11-02T15:08:55Z", "type": "forcePushed"}]}