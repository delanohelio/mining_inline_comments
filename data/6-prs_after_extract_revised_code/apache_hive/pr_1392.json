{"pr_number": 1392, "pr_title": "HIVE-24074: Incorrect handling of timestamp in Parquet/Avro when written in certain time zones in versions before Hive 3.x", "pr_createdAt": "2020-08-11T20:53:03Z", "pr_url": "https://github.com/apache/hive/pull/1392", "timeline": [{"oid": "62b1dddac2897dee6429d10c391327a11a837e46", "url": "https://github.com/apache/hive/commit/62b1dddac2897dee6429d10c391327a11a837e46", "message": "[WiP] Parquet conversion tz", "committedDate": "2020-08-11T20:52:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg2MjY3OA==", "url": "https://github.com/apache/hive/pull/1392#discussion_r468862678", "bodyText": "should this be a threadlocal value? using this way is pretty slow iirc..", "author": "prasanthj", "createdAt": "2020-08-11T21:01:42Z", "path": "common/src/java/org/apache/hadoop/hive/common/type/TimestampTZUtil.java", "diffHunk": "@@ -145,13 +149,33 @@ public static ZoneId parseTimeZone(String timeZoneStr) {\n     }\n   }\n \n+  public static Timestamp convertTimestampToZone(Timestamp ts, ZoneId fromZone, ZoneId toZone) {\n+    return convertTimestampToZone(ts, fromZone, toZone, false);\n+  }\n+\n   /**\n    * Timestamps are technically time zone agnostic, and this method sort of cheats its logic.\n    * Timestamps are supposed to represent nanos since [UTC epoch]. Here,\n    * the input timestamp represents nanoseconds since [epoch at fromZone], and\n    * we return a Timestamp representing nanoseconds since [epoch at toZone].\n    */\n-  public static Timestamp convertTimestampToZone(Timestamp ts, ZoneId fromZone, ZoneId toZone) {\n+  public static Timestamp convertTimestampToZone(Timestamp ts, ZoneId fromZone, ZoneId toZone,\n+      boolean legacyConversion) {\n+    if (legacyConversion) {\n+      try {\n+        DateFormat formatter = new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss\");", "originalCommit": "62b1dddac2897dee6429d10c391327a11a837e46", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg2NDU0NA==", "url": "https://github.com/apache/hive/pull/1392#discussion_r468864544", "bodyText": "Yes, that's right. I'll change it in follow-up commit.", "author": "jcamachor", "createdAt": "2020-08-11T21:05:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg2MjY3OA=="}], "type": "inlineReview", "revised_code": {"commit": "7c36fa04d7e5af1cd0925d0c93d91a56cc7c314c", "chunk": "diff --git a/common/src/java/org/apache/hadoop/hive/common/type/TimestampTZUtil.java b/common/src/java/org/apache/hadoop/hive/common/type/TimestampTZUtil.java\nindex 31359d18a7..1d2f820de1 100644\n--- a/common/src/java/org/apache/hadoop/hive/common/type/TimestampTZUtil.java\n+++ b/common/src/java/org/apache/hadoop/hive/common/type/TimestampTZUtil.java\n\n@@ -149,6 +149,16 @@ public static ZoneId parseTimeZone(String timeZoneStr) {\n     }\n   }\n \n+  private static final ThreadLocal<DateFormat> LEGACY_DATE_FORMATTER = new ThreadLocal<>();\n+\n+  private static DateFormat getLegacyDateFormatter() {\n+    //Calendar.getInstance calculates the current-time needlessly, so cache an instance.\n+    if (LEGACY_DATE_FORMATTER.get() == null) {\n+      LEGACY_DATE_FORMATTER.set(new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss\"));\n+    }\n+    return LEGACY_DATE_FORMATTER.get();\n+  }\n+\n   public static Timestamp convertTimestampToZone(Timestamp ts, ZoneId fromZone, ZoneId toZone) {\n     return convertTimestampToZone(ts, fromZone, toZone, false);\n   }\n"}}, {"oid": "7c36fa04d7e5af1cd0925d0c93d91a56cc7c314c", "url": "https://github.com/apache/hive/commit/7c36fa04d7e5af1cd0925d0c93d91a56cc7c314c", "message": "test file changes and addressing review comments", "committedDate": "2020-08-11T22:46:53Z", "type": "commit"}, {"oid": "718d4d2600e8342b15b786986aa9befac99223ec", "url": "https://github.com/apache/hive/commit/718d4d2600e8342b15b786986aa9befac99223ec", "message": "remove outdated comment", "committedDate": "2020-08-11T22:48:43Z", "type": "commit"}, {"oid": "6523fd6f91432db620322f9a54167e045e19661b", "url": "https://github.com/apache/hive/commit/6523fd6f91432db620322f9a54167e045e19661b", "message": "adding debug config", "committedDate": "2020-08-12T02:21:13Z", "type": "commit"}, {"oid": "dd34bb31b32c7c366d295faf9638b5cc6f183ddb", "url": "https://github.com/apache/hive/commit/dd34bb31b32c7c366d295faf9638b5cc6f183ddb", "message": "tests", "committedDate": "2020-08-25T00:09:01Z", "type": "commit"}, {"oid": "eeb96a9b62321b2fe7dde9f17154c45b3bafd555", "url": "https://github.com/apache/hive/commit/eeb96a9b62321b2fe7dde9f17154c45b3bafd555", "message": "isolate new tests", "committedDate": "2020-08-26T22:57:00Z", "type": "commit"}, {"oid": "cab508ebdc2bc9d483de6eaaf7ab1e37cc683d0a", "url": "https://github.com/apache/hive/commit/cab508ebdc2bc9d483de6eaaf7ab1e37cc683d0a", "message": "Revert \"isolate new tests\"\n\nThis reverts commit eeb96a9b62321b2fe7dde9f17154c45b3bafd555.", "committedDate": "2020-08-28T03:05:59Z", "type": "commit"}, {"oid": "b7e096103382dccf9a1f2e6074a4d7a1b3eb8498", "url": "https://github.com/apache/hive/commit/b7e096103382dccf9a1f2e6074a4d7a1b3eb8498", "message": "disable after test run to avoid side effects", "committedDate": "2020-08-28T03:06:22Z", "type": "commit"}]}