{"pr_number": 1078, "pr_title": "HIVE-23266: Remove QueryWrapper from ObjectStore", "pr_createdAt": "2020-06-08T17:21:15Z", "pr_url": "https://github.com/apache/hive/pull/1078", "timeline": [{"oid": "91e914dd3873c2b31cc89626fda1fa8ae7869a8d", "url": "https://github.com/apache/hive/commit/91e914dd3873c2b31cc89626fda1fa8ae7869a8d", "message": "Initial commit", "committedDate": "2020-06-08T17:19:50Z", "type": "commit"}, {"oid": "e529efddcf087862150197db0e85b69c1e073bf6", "url": "https://github.com/apache/hive/commit/e529efddcf087862150197db0e85b69c1e073bf6", "message": "Fixed exception handling for partition lookup.  Fixed meta tool Exception wrapping.", "committedDate": "2020-06-08T17:19:50Z", "type": "commit"}, {"oid": "17cb9f7278f47bc300a89850ba7e8c2b2c785283", "url": "https://github.com/apache/hive/commit/17cb9f7278f47bc300a89850ba7e8c2b2c785283", "message": "Fixed error with leaked lock", "committedDate": "2020-06-08T17:19:50Z", "type": "commit"}, {"oid": "1134e04e43eec4bc66d641c3e2b1ca9bd8a6c59c", "url": "https://github.com/apache/hive/commit/1134e04e43eec4bc66d641c3e2b1ca9bd8a6c59c", "message": "Remove check status of transaction for partitions", "committedDate": "2020-06-08T17:19:50Z", "type": "commit"}, {"oid": "9023a61a5098097080301da72367946b064f3a94", "url": "https://github.com/apache/hive/commit/9023a61a5098097080301da72367946b064f3a94", "message": "Do not retrieve all records for raw queries", "committedDate": "2020-06-08T17:19:50Z", "type": "commit"}, {"oid": "f0e130eac2bd5aac20ed58a4b98392062a0d73cb", "url": "https://github.com/apache/hive/commit/f0e130eac2bd5aac20ed58a4b98392062a0d73cb", "message": "Retrieve results for executeJDOQLSelect within the open Query", "committedDate": "2020-06-08T17:19:50Z", "type": "commit"}, {"oid": "2a1f52917002f434ebcbb22c1d5f356a7733f9d3", "url": "https://github.com/apache/hive/commit/2a1f52917002f434ebcbb22c1d5f356a7733f9d3", "message": "Better handle exception being thrown by listMPartitionsWithProjection", "committedDate": "2020-06-08T17:51:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE0NzY5MA==", "url": "https://github.com/apache/hive/pull/1078#discussion_r437147690", "bodyText": "what if exception happens when getPartitionsInternal,  the transaction may become unbalanced", "author": "dengzhhu653", "createdAt": "2020-06-09T05:35:24Z", "path": "standalone-metastore/metastore-server/src/test/java/org/apache/hadoop/hive/metastore/VerifyingObjectStore.java", "diffHunk": "@@ -93,9 +93,11 @@ public boolean getPartitionsByExpr(String catName, String dbName, String tblName\n   @Override\n   public List<Partition> getPartitions(\n       String catName, String dbName, String tableName, int maxParts) throws MetaException, NoSuchObjectException {\n+    openTransaction();\n     List<Partition> sqlResults = getPartitionsInternal(catName, dbName, tableName, maxParts, true, false);\n     List<Partition> ormResults = getPartitionsInternal(catName, dbName, tableName, maxParts, false, true);\n     verifyLists(sqlResults, ormResults, Partition.class);\n+    commitTransaction();", "originalCommit": "2a1f52917002f434ebcbb22c1d5f356a7733f9d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ1ODQxNg==", "url": "https://github.com/apache/hive/pull/1078#discussion_r437458416", "bodyText": "This is a test class.  If things become unbalanced here it doesn't really matter because the test will fail from Exception anyway.", "author": "belugabehr", "createdAt": "2020-06-09T14:17:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE0NzY5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzc4Njg5NQ==", "url": "https://github.com/apache/hive/pull/1078#discussion_r437786895", "bodyText": "OK, got it.", "author": "dengzhhu653", "createdAt": "2020-06-10T00:00:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE0NzY5MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE0ODk1OQ==", "url": "https://github.com/apache/hive/pull/1078#discussion_r437148959", "bodyText": "rollbackAndCleanup", "author": "dengzhhu653", "createdAt": "2020-06-09T05:39:36Z", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/ObjectStore.java", "diffHunk": "@@ -7109,22 +7121,37 @@ protected String describeResult() {\n   }\n \n   @Override\n-  public List<HiveObjectPrivilege> listPrincipalDBGrantsAll(\n-      String principalName, PrincipalType principalType) {\n-    try (QueryWrapper queryWrapper = new QueryWrapper()) {\n-      return convertDB(listPrincipalAllDBGrant(principalName, principalType, queryWrapper));\n+  public List<HiveObjectPrivilege> listPrincipalDBGrantsAll(String principalName, PrincipalType principalType) {\n+    List<HiveObjectPrivilege> results = Collections.emptyList();\n+    try {\n+      openTransaction();\n+      results = convertDB(listPrincipalAllDBGrant(principalName, principalType));\n+      commitTransaction();\n+    } catch (Exception e) {\n+      throw new RuntimeException(e);\n+    } finally {\n+      rollbackAndCleanup(true, null);\n     }\n+    return results;\n   }\n \n   @Override\n   public List<HiveObjectPrivilege> listDBGrantsAll(String catName, String dbName) {\n-    return listDBGrantsAll(catName, dbName, null);\n+    List<HiveObjectPrivilege> results = Collections.emptyList();\n+    try {\n+      openTransaction();\n+      results = listDBGrantsAll(catName, dbName, null);\n+      commitTransaction();\n+    } catch (Exception e) {\n+      throw new RuntimeException(e);\n+    } finally {\n+      rollbackAndCleanup(true, null);", "originalCommit": "2a1f52917002f434ebcbb22c1d5f356a7733f9d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ1ODc2NA==", "url": "https://github.com/apache/hive/pull/1078#discussion_r437458764", "bodyText": "I'm sorry?", "author": "belugabehr", "createdAt": "2020-06-09T14:17:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE0ODk1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzc4NjM0NA==", "url": "https://github.com/apache/hive/pull/1078#discussion_r437786344", "bodyText": "Sorry for the delay, my concern is that set success to true on rollbackAndCleanup here may make the transaction unable to rollback.", "author": "dengzhhu653", "createdAt": "2020-06-09T23:58:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE0ODk1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg0NDUyNQ==", "url": "https://github.com/apache/hive/pull/1078#discussion_r438844525", "bodyText": "OK.  I just took a look at it.  'true' here means 'do not roll back'.  This particular method is a top-level method and it is read-only.  Therefore, there will never be anything to roll back.", "author": "belugabehr", "createdAt": "2020-06-11T14:51:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE0ODk1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "2f63831582fac2ad7462cd40376f76a0bf66f686", "chunk": "diff --git a/standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/ObjectStore.java b/standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/ObjectStore.java\nindex e367367c7f..2854405d0c 100644\n--- a/standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/ObjectStore.java\n+++ b/standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/ObjectStore.java\n\n@@ -7123,14 +7122,15 @@ protected String describeResult() {\n   @Override\n   public List<HiveObjectPrivilege> listPrincipalDBGrantsAll(String principalName, PrincipalType principalType) {\n     List<HiveObjectPrivilege> results = Collections.emptyList();\n+    boolean success = false;\n     try {\n       openTransaction();\n       results = convertDB(listPrincipalAllDBGrant(principalName, principalType));\n-      commitTransaction();\n+      success = commitTransaction();\n     } catch (Exception e) {\n       throw new RuntimeException(e);\n     } finally {\n-      rollbackAndCleanup(true, null);\n+      rollbackAndCleanup(success, null);\n     }\n     return results;\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE1MDI5NQ==", "url": "https://github.com/apache/hive/pull/1078#discussion_r437150295", "bodyText": "The transaction may unable to rollback when exception happens.", "author": "dengzhhu653", "createdAt": "2020-06-09T05:43:46Z", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/ObjectStore.java", "diffHunk": "@@ -7109,22 +7121,37 @@ protected String describeResult() {\n   }\n \n   @Override\n-  public List<HiveObjectPrivilege> listPrincipalDBGrantsAll(\n-      String principalName, PrincipalType principalType) {\n-    try (QueryWrapper queryWrapper = new QueryWrapper()) {\n-      return convertDB(listPrincipalAllDBGrant(principalName, principalType, queryWrapper));\n+  public List<HiveObjectPrivilege> listPrincipalDBGrantsAll(String principalName, PrincipalType principalType) {\n+    List<HiveObjectPrivilege> results = Collections.emptyList();\n+    try {\n+      openTransaction();\n+      results = convertDB(listPrincipalAllDBGrant(principalName, principalType));\n+      commitTransaction();\n+    } catch (Exception e) {\n+      throw new RuntimeException(e);\n+    } finally {\n+      rollbackAndCleanup(true, null);", "originalCommit": "2a1f52917002f434ebcbb22c1d5f356a7733f9d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ1OTA5MQ==", "url": "https://github.com/apache/hive/pull/1078#discussion_r437459091", "bodyText": "Why is that?", "author": "belugabehr", "createdAt": "2020-06-09T14:18:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE1MDI5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzc4MzE1NA==", "url": "https://github.com/apache/hive/pull/1078#discussion_r437783154", "bodyText": "hive/standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/ObjectStore.java\n    \n    \n        Lines 11729 to 11739\n      in\n      871ee80\n    \n    \n    \n    \n\n        \n          \n           void rollbackAndCleanup(boolean success, Query query) { \n        \n\n        \n          \n             try { \n        \n\n        \n          \n               if (!success) { \n        \n\n        \n          \n                 rollbackTransaction(); \n        \n\n        \n          \n               } \n        \n\n        \n          \n             } finally { \n        \n\n        \n          \n               if (query != null) { \n        \n\n        \n          \n                 query.closeAll(); \n        \n\n        \n          \n               } \n        \n\n        \n          \n             } \n        \n\n        \n          \n           } \n        \n    \n  \n\n\nI'm wondering that the opened transaction may be unable to be committed when exception happens on listPrincipalAllDBGrant  or rolled back as we set the success to true  on the method rollbackAndCleanup. Could you explain more about why set success to true here?  Thanks @belugabehr", "author": "dengzhhu653", "createdAt": "2020-06-09T23:48:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE1MDI5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg0NDk1Ng==", "url": "https://github.com/apache/hive/pull/1078#discussion_r438844956", "bodyText": "@dengzhhu653\nThis particular method is a top-level method and it is read-only.  Therefore, there will never be anything to roll back.", "author": "belugabehr", "createdAt": "2020-06-11T14:52:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE1MDI5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg3MjgwMg==", "url": "https://github.com/apache/hive/pull/1078#discussion_r438872802", "bodyText": "When exception happens in this method, if the same ObjectStore tries to create table afterwards,  he may be unable to commit the transaction as openTrasactionCalls should be greater than 0 or rollback as the method commitTransaction returns true, the modification would be lost when metastore client shutdown.", "author": "dengzhhu653", "createdAt": "2020-06-11T15:30:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE1MDI5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODkwOTE0Nw==", "url": "https://github.com/apache/hive/pull/1078#discussion_r438909147", "bodyText": "@dengzhhu653 OK, I am following you now.  I will address this is new push.  Thanks so much.\nThis whole setup is pretty wonky (hence my inspiration to simplify the Query close stuff in this PR) and I'd like to address, but in another JIRA.", "author": "belugabehr", "createdAt": "2020-06-11T16:16:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE1MDI5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTExODk0Mw==", "url": "https://github.com/apache/hive/pull/1078#discussion_r439118943", "bodyText": "I found that using try (QueryWrapper wrapper = new QueryWrapper()) does not need to add a catch clause comparing to try(Query q = pm.newQuery(....)).", "author": "dengzhhu653", "createdAt": "2020-06-11T23:09:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE1MDI5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "2f63831582fac2ad7462cd40376f76a0bf66f686", "chunk": "diff --git a/standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/ObjectStore.java b/standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/ObjectStore.java\nindex e367367c7f..2854405d0c 100644\n--- a/standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/ObjectStore.java\n+++ b/standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/ObjectStore.java\n\n@@ -7123,14 +7122,15 @@ protected String describeResult() {\n   @Override\n   public List<HiveObjectPrivilege> listPrincipalDBGrantsAll(String principalName, PrincipalType principalType) {\n     List<HiveObjectPrivilege> results = Collections.emptyList();\n+    boolean success = false;\n     try {\n       openTransaction();\n       results = convertDB(listPrincipalAllDBGrant(principalName, principalType));\n-      commitTransaction();\n+      success = commitTransaction();\n     } catch (Exception e) {\n       throw new RuntimeException(e);\n     } finally {\n-      rollbackAndCleanup(true, null);\n+      rollbackAndCleanup(success, null);\n     }\n     return results;\n   }\n"}}, {"oid": "14a722c75804746be417c45001d75a7ed45b2859", "url": "https://github.com/apache/hive/commit/14a722c75804746be417c45001d75a7ed45b2859", "message": "Trivial change to remove whitespace", "committedDate": "2020-06-11T14:55:47Z", "type": "commit"}, {"oid": "2f63831582fac2ad7462cd40376f76a0bf66f686", "url": "https://github.com/apache/hive/commit/2f63831582fac2ad7462cd40376f76a0bf66f686", "message": "Track success and rollback if required", "committedDate": "2020-06-11T16:18:02Z", "type": "commit"}]}