{"pr_number": 1432, "pr_title": "HIVE-24072 HiveAggregateJoinTransposeRule may try to create an invalid transformation", "pr_createdAt": "2020-08-25T15:42:14Z", "pr_url": "https://github.com/apache/hive/pull/1432", "timeline": [{"oid": "469c8fec41e15916758fa02330a45adf8980f51f", "url": "https://github.com/apache/hive/commit/469c8fec41e15916758fa02330a45adf8980f51f", "message": "a", "committedDate": "2020-08-03T15:55:33Z", "type": "commit"}, {"oid": "43701563c5f69780899a00ab125872094cf63d4b", "url": "https://github.com/apache/hive/commit/43701563c5f69780899a00ab125872094cf63d4b", "message": "disable unstable tests", "committedDate": "2020-08-04T09:56:40Z", "type": "commit"}, {"oid": "4560fc77d479a3d14492fc1957804dd5eaa62940", "url": "https://github.com/apache/hive/commit/4560fc77d479a3d14492fc1957804dd5eaa62940", "message": "some changes", "committedDate": "2020-08-11T08:26:50Z", "type": "commit"}, {"oid": "5eab19dbf84d05d030ecda567596008e1d7a07f6", "url": "https://github.com/apache/hive/commit/5eab19dbf84d05d030ecda567596008e1d7a07f6", "message": "git staMerge remote-tracking branch 'apache/master' into DWX-4878-aggpush", "committedDate": "2020-08-11T08:27:21Z", "type": "commit"}, {"oid": "92e2ef6d034cfeb6795daf386e8fd4e78f8f04ed", "url": "https://github.com/apache/hive/commit/92e2ef6d034cfeb6795daf386e8fd4e78f8f04ed", "message": "use tpch .001", "committedDate": "2020-08-11T08:29:50Z", "type": "commit"}, {"oid": "159bbc5e4a4acdae18c4e19b437768934c75e3a8", "url": "https://github.com/apache/hive/commit/159bbc5e4a4acdae18c4e19b437768934c75e3a8", "message": "update q.out", "committedDate": "2020-08-11T09:05:04Z", "type": "commit"}, {"oid": "b9fbd6a9dd869016240ee397748af94d9e0628ad", "url": "https://github.com/apache/hive/commit/b9fbd6a9dd869016240ee397748af94d9e0628ad", "message": "fix", "committedDate": "2020-08-25T08:33:44Z", "type": "commit"}, {"oid": "6b761df6b287f7fe0e32f3965d2b7236b1b168bc", "url": "https://github.com/apache/hive/commit/6b761df6b287f7fe0e32f3965d2b7236b1b168bc", "message": "add a", "committedDate": "2020-08-25T09:29:42Z", "type": "commit"}, {"oid": "2775462c430b24f6087af675b42f58964d4d9889", "url": "https://github.com/apache/hive/commit/2775462c430b24f6087af675b42f58964d4d9889", "message": "update", "committedDate": "2020-08-25T13:53:01Z", "type": "commit"}, {"oid": "e60a56c9a79e4bde40f58e84e44bda8fa4d098a3", "url": "https://github.com/apache/hive/commit/e60a56c9a79e4bde40f58e84e44bda8fa4d098a3", "message": "why intersect", "committedDate": "2020-08-25T14:28:01Z", "type": "commit"}, {"oid": "98cb30e6640c32cedca0cd39befa3017d94f09b0", "url": "https://github.com/apache/hive/commit/98cb30e6640c32cedca0cd39befa3017d94f09b0", "message": "add", "committedDate": "2020-08-25T15:41:04Z", "type": "commit"}, {"oid": "57750a44529fcf9e779241c4466c03d34202e338", "url": "https://github.com/apache/hive/commit/57750a44529fcf9e779241c4466c03d34202e338", "message": "cleanup", "committedDate": "2020-08-27T15:12:11Z", "type": "commit"}, {"oid": "b84a24fc41d81dc936927ff239ab0e17f25a6c30", "url": "https://github.com/apache/hive/commit/b84a24fc41d81dc936927ff239ab0e17f25a6c30", "message": "update q.out", "committedDate": "2020-08-27T15:18:29Z", "type": "commit"}, {"oid": "74520518ba7afd974f4aae069286661768303651", "url": "https://github.com/apache/hive/commit/74520518ba7afd974f4aae069286661768303651", "message": "remove EXPLAIN; update q.out", "committedDate": "2020-08-27T15:21:34Z", "type": "commit"}, {"oid": "0b915d5a01c5d5d73d4428074175c1ebe279139b", "url": "https://github.com/apache/hive/commit/0b915d5a01c5d5d73d4428074175c1ebe279139b", "message": "resultset diffs against old", "committedDate": "2020-08-27T15:25:13Z", "type": "commit"}, {"oid": "fa705cb8e21b2f5f75574fd1288bf9ff0dba234c", "url": "https://github.com/apache/hive/commit/fa705cb8e21b2f5f75574fd1288bf9ff0dba234c", "message": "restore patch", "committedDate": "2020-08-27T15:25:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODUwODM0NA==", "url": "https://github.com/apache/hive/pull/1432#discussion_r478508344", "bodyText": "@jcamachor\nI think this intersect is not needed; it cause some trouble in case\n\ngrouped by say 1,3,4\ncolumns 1,2,3 is coming from left side of join; column 2 is the join key\nthe intersect will remove column 2 ; which will induce a shift in the mapping - and will rotate in the join key into a projkect later on\n\nI think in calcite the following is true:\nfor a join betwen inputs:\n\nT1(a,b,c)\nT2(d,e,f)\nthe output is always a,b,c,d,e,f - independently the join condition\nso I see no rational need for this intersect...it was here for a few years now...and the class \"borned\" with this line in it...", "author": "kgyrtkirk", "createdAt": "2020-08-27T15:31:09Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/optimizer/calcite/rules/HiveAggregateJoinTransposeRule.java", "diffHunk": "@@ -145,8 +145,7 @@ public void onMatch(RelOptRuleCall call) {\n         int fieldCount = joinInput.getRowType().getFieldCount();\n         final ImmutableBitSet fieldSet =\n             ImmutableBitSet.range(offset, offset + fieldCount);\n-        final ImmutableBitSet belowAggregateKeyNotShifted =\n-            belowAggregateColumns.intersect(fieldSet);", "originalCommit": "fa705cb8e21b2f5f75574fd1288bf9ff0dba234c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI3OTg1Mg==", "url": "https://github.com/apache/hive/pull/1432#discussion_r480279852", "bodyText": "belowAggregateColumns includes the aggregate fields for all inputs together with the join keys (L120). Intersection is supposed to gather only those applicable to current input in the loop, it should not remove column 2 unless I am missing anything...", "author": "jcamachor", "createdAt": "2020-08-31T17:32:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODUwODM0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDM4NTc0OA==", "url": "https://github.com/apache/hive/pull/1432#discussion_r484385748", "bodyText": "right; the column which was causing the trouble was the preceeding join's joinkey.\nthe issue was caused by\n\nthat between the previous / and current join there were no projects - so all the join keys of the previous join were present in the input\nmeanwhile the aggregate had references to 0,2,... columns - which were unique; so the logic assumed that the joinInput could be used as is\n\nhowever..because column 1 was present in the input; but not in the output this have caused that the actual join was not in sync with the mapping being created\nI think the patch may make more sense than the above reasoning :)", "author": "kgyrtkirk", "createdAt": "2020-09-07T11:55:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODUwODM0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTMyMTI1Mg==", "url": "https://github.com/apache/hive/pull/1432#discussion_r485321252", "bodyText": "Yes, this makes sense now!", "author": "jcamachor", "createdAt": "2020-09-09T03:52:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODUwODM0NA=="}], "type": "inlineReview", "revised_code": {"commit": "cd6c9cda7c1ff8ed49ac61c2e417d1a2e724315c", "chunk": "diff --git a/ql/src/java/org/apache/hadoop/hive/ql/optimizer/calcite/rules/HiveAggregateJoinTransposeRule.java b/ql/src/java/org/apache/hadoop/hive/ql/optimizer/calcite/rules/HiveAggregateJoinTransposeRule.java\nindex 10b8bb8100..76ca54b8da 100644\n--- a/ql/src/java/org/apache/hadoop/hive/ql/optimizer/calcite/rules/HiveAggregateJoinTransposeRule.java\n+++ b/ql/src/java/org/apache/hadoop/hive/ql/optimizer/calcite/rules/HiveAggregateJoinTransposeRule.java\n\n@@ -145,7 +145,8 @@ public void onMatch(RelOptRuleCall call) {\n         int fieldCount = joinInput.getRowType().getFieldCount();\n         final ImmutableBitSet fieldSet =\n             ImmutableBitSet.range(offset, offset + fieldCount);\n-        final ImmutableBitSet belowAggregateKeyNotShifted = fieldSet;\n+        final ImmutableBitSet belowAggregateKeyNotShifted =\n+            belowAggregateColumns.intersect(fieldSet);\n         for (Ord<Integer> c : Ord.zip(belowAggregateKeyNotShifted)) {\n           map.put(c.e, belowOffset + c.i);\n         }\n"}}, {"oid": "683b63cf161128dbea670b606db849833388306c", "url": "https://github.com/apache/hive/commit/683b63cf161128dbea670b606db849833388306c", "message": "git stMerge remote-tracking branch 'apache/master' into HIVE-24072-aggjoin-mapping", "committedDate": "2020-09-02T14:03:35Z", "type": "commit"}, {"oid": "60359407d9a20a364bff92c6d0417f5f3995032c", "url": "https://github.com/apache/hive/commit/60359407d9a20a364bff92c6d0417f5f3995032c", "message": "remove duplicate semicolon", "committedDate": "2020-09-03T14:49:58Z", "type": "commit"}, {"oid": "f19549a7768c3a00b11e7093e167d47666c3c4d1", "url": "https://github.com/apache/hive/commit/f19549a7768c3a00b11e7093e167d47666c3c4d1", "message": "add tpch18", "committedDate": "2020-09-03T14:52:15Z", "type": "commit"}, {"oid": "cd6c9cda7c1ff8ed49ac61c2e417d1a2e724315c", "url": "https://github.com/apache/hive/commit/cd6c9cda7c1ff8ed49ac61c2e417d1a2e724315c", "message": "put back intersect", "committedDate": "2020-09-07T04:51:05Z", "type": "commit"}, {"oid": "ee00ba27aaea73461553143147c43be29b6e09ac", "url": "https://github.com/apache/hive/commit/ee00ba27aaea73461553143147c43be29b6e09ac", "message": "fix", "committedDate": "2020-09-07T11:47:53Z", "type": "commit"}, {"oid": "aef16e6b5bba03057ce03122506bbf87715561bb", "url": "https://github.com/apache/hive/commit/aef16e6b5bba03057ce03122506bbf87715561bb", "message": "redo", "committedDate": "2020-09-07T11:49:37Z", "type": "commit"}, {"oid": "6abcd5d8f8a2c84f4f0ab266d43681687f169a02", "url": "https://github.com/apache/hive/commit/6abcd5d8f8a2c84f4f0ab266d43681687f169a02", "message": "remove tpch18", "committedDate": "2020-09-07T14:16:44Z", "type": "commit"}]}