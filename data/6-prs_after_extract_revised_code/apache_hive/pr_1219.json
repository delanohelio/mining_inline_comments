{"pr_number": 1219, "pr_title": "HIVE-23525: TestAcidTxnCleanerService is unstable", "pr_createdAt": "2020-07-07T12:17:48Z", "pr_url": "https://github.com/apache/hive/pull/1219", "timeline": [{"oid": "3fb62cf2a06ceb7613fdc4689bc2e804c357f9ce", "url": "https://github.com/apache/hive/commit/3fb62cf2a06ceb7613fdc4689bc2e804c357f9ce", "message": "HIVE-23525: TestAcidTxnCleanerService is unstable", "committedDate": "2020-07-07T12:16:44Z", "type": "commit"}, {"oid": "e0a47d167f03e4071cfaaa0fbf3f60e75f0e5b78", "url": "https://github.com/apache/hive/commit/e0a47d167f03e4071cfaaa0fbf3f60e75f0e5b78", "message": "Remove ignore", "committedDate": "2020-07-07T12:21:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgyMjY1Ng==", "url": "https://github.com/apache/hive/pull/1219#discussion_r450822656", "bodyText": "nit: should", "author": "pvary", "createdAt": "2020-07-07T12:22:17Z", "path": "standalone-metastore/metastore-server/src/test/java/org/apache/hadoop/hive/metastore/txn/TestAcidTxnCleanerService.java", "diffHunk": "@@ -135,7 +136,7 @@ public void cleansCommittedAndEmptyAbortedOnly() throws Exception {\n \n     // kept only the 5 non-empty aborted ones\n     Assert.assertEquals(5, getTxnCount());\n-    Assert.assertEquals(15, getMaxTxnId());\n+    Assert.assertTrue(\"The max txnId shoul be at least 15\", getMaxTxnId() >= 15);", "originalCommit": "3fb62cf2a06ceb7613fdc4689bc2e804c357f9ce", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "88f07505f97630914e99461109cbde9cc95f5628", "chunk": "diff --git a/standalone-metastore/metastore-server/src/test/java/org/apache/hadoop/hive/metastore/txn/TestAcidTxnCleanerService.java b/standalone-metastore/metastore-server/src/test/java/org/apache/hadoop/hive/metastore/txn/TestAcidTxnCleanerService.java\nindex cb5b583446..495fd4bfad 100644\n--- a/standalone-metastore/metastore-server/src/test/java/org/apache/hadoop/hive/metastore/txn/TestAcidTxnCleanerService.java\n+++ b/standalone-metastore/metastore-server/src/test/java/org/apache/hadoop/hive/metastore/txn/TestAcidTxnCleanerService.java\n\n@@ -136,7 +134,7 @@ public void cleansCommittedAndEmptyAbortedOnly() throws Exception {\n \n     // kept only the 5 non-empty aborted ones\n     Assert.assertEquals(5, getTxnCount());\n-    Assert.assertTrue(\"The max txnId shoul be at least 15\", getMaxTxnId() >= 15);\n+    Assert.assertTrue(\"The max txnId should be at least 15\", getMaxTxnId() >= 15);\n   }\n \n   @Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgyMjc2MQ==", "url": "https://github.com/apache/hive/pull/1219#discussion_r450822761", "bodyText": "nit: should", "author": "pvary", "createdAt": "2020-07-07T12:22:28Z", "path": "standalone-metastore/metastore-server/src/test/java/org/apache/hadoop/hive/metastore/txn/TestAcidTxnCleanerService.java", "diffHunk": "@@ -148,16 +149,16 @@ public void cleansEmptyAbortedBatchTxns() throws Exception {\n         TxnStore.TIMED_OUT_TXN_ABORT_BATCH_SIZE + 50);\n     OpenTxnsResponse resp = txnHandler.openTxns(new OpenTxnRequest(\n         TxnStore.TIMED_OUT_TXN_ABORT_BATCH_SIZE + 50, \"user\", \"hostname\"));\n+    txnHandler.setOpenTxnTimeOutMillis(1);\n     txnHandler.abortTxns(new AbortTxnsRequest(resp.getTxn_ids()));\n     GetOpenTxnsResponse openTxns = txnHandler.getOpenTxns();\n     Assert.assertEquals(TxnStore.TIMED_OUT_TXN_ABORT_BATCH_SIZE + 50 + 1, openTxns.getOpen_txnsSize());\n-    txnHandler.setOpenTxnTimeOutMillis(1);\n \n     underTest.run();\n \n     openTxns = txnHandler.getOpenTxns();\n     Assert.assertEquals(2, openTxns.getOpen_txnsSize());\n-    Assert.assertEquals(TxnStore.TIMED_OUT_TXN_ABORT_BATCH_SIZE + 50 + 1, getMaxTxnId());\n+    Assert.assertTrue(\"The max txnId shoul be at least\", getMaxTxnId() >= TxnStore.TIMED_OUT_TXN_ABORT_BATCH_SIZE + 50 + 1);", "originalCommit": "3fb62cf2a06ceb7613fdc4689bc2e804c357f9ce", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "88f07505f97630914e99461109cbde9cc95f5628", "chunk": "diff --git a/standalone-metastore/metastore-server/src/test/java/org/apache/hadoop/hive/metastore/txn/TestAcidTxnCleanerService.java b/standalone-metastore/metastore-server/src/test/java/org/apache/hadoop/hive/metastore/txn/TestAcidTxnCleanerService.java\nindex cb5b583446..495fd4bfad 100644\n--- a/standalone-metastore/metastore-server/src/test/java/org/apache/hadoop/hive/metastore/txn/TestAcidTxnCleanerService.java\n+++ b/standalone-metastore/metastore-server/src/test/java/org/apache/hadoop/hive/metastore/txn/TestAcidTxnCleanerService.java\n\n@@ -158,7 +156,7 @@ public void cleansEmptyAbortedBatchTxns() throws Exception {\n \n     openTxns = txnHandler.getOpenTxns();\n     Assert.assertEquals(2, openTxns.getOpen_txnsSize());\n-    Assert.assertTrue(\"The max txnId shoul be at least\", getMaxTxnId() >= TxnStore.TIMED_OUT_TXN_ABORT_BATCH_SIZE + 50 + 1);\n+    Assert.assertTrue(\"The max txnId should be at least\", getMaxTxnId() >= TxnStore.TIMED_OUT_TXN_ABORT_BATCH_SIZE + 50 + 1);\n   }\n \n   private void openNonEmptyThenAbort() throws MetaException, NoSuchTxnException, TxnAbortedException {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgyMzMwMQ==", "url": "https://github.com/apache/hive/pull/1219#discussion_r450823301", "bodyText": "Why is this change?", "author": "pvary", "createdAt": "2020-07-07T12:23:30Z", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java", "diffHunk": "@@ -568,6 +568,7 @@ public OpenTxnsResponse openTxns(OpenTxnRequest rqst) throws MetaException {\n            */\n           LOG.error(\"OpenTxnTimeOut exceeded commit duration {}, deleting transactionIds: {}\", elapsedMillis, txnIds);\n           deleteInvalidOpenTransactions(dbConn, txnIds);\n+          dbConn.commit();", "originalCommit": "3fb62cf2a06ceb7613fdc4689bc2e804c357f9ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgyOTE4Nw==", "url": "https://github.com/apache/hive/pull/1219#discussion_r450829187", "bodyText": "It was missing, the delete was not persisted. When I was testing manually, I didn't notice, because I was querying back the data on the same connection...\nIt does not cause a big problem, these transactions would be cleaned up eventually when they time out.", "author": "pvargacl", "createdAt": "2020-07-07T12:34:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgyMzMwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg0NDExMQ==", "url": "https://github.com/apache/hive/pull/1219#discussion_r450844111", "bodyText": "I thought close(null, stmt, dbConn) commits, but you are right, that it does not commit.\nShall we create a test case for this? :)", "author": "pvary", "createdAt": "2020-07-07T12:58:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgyMzMwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg0NDI4NQ==", "url": "https://github.com/apache/hive/pull/1219#discussion_r450844285", "bodyText": "Maybe in a follow-up jira...", "author": "pvary", "createdAt": "2020-07-07T12:59:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgyMzMwMQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "88f07505f97630914e99461109cbde9cc95f5628", "url": "https://github.com/apache/hive/commit/88f07505f97630914e99461109cbde9cc95f5628", "message": "typos", "committedDate": "2020-07-07T12:30:18Z", "type": "commit"}]}