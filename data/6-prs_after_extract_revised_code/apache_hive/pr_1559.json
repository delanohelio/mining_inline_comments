{"pr_number": 1559, "pr_title": "HIVE-24236: Fixed possible Connection leaks in TxnHandler (Yongzhi Chen, reviewed by Denys Kuzmenko)", "pr_createdAt": "2020-10-06T14:53:02Z", "pr_url": "https://github.com/apache/hive/pull/1559", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQxMTk3OA==", "url": "https://github.com/apache/hive/pull/1559#discussion_r500411978", "bodyText": "that's redundant", "author": "deniskuzZ", "createdAt": "2020-10-06T15:54:21Z", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java", "diffHunk": "@@ -5250,20 +5252,22 @@ public LockHandle acquireLock(String key) throws MetaException {\n           derbySemaphore.acquire();\n         }\n         LOG.debug(quoteString(key) + \" locked by \" + quoteString(TxnHandler.hostname));\n+        needToCloseConn = false;  //The connection is good, we need not close it\n         //OK, so now we have a lock\n         return new LockHandleImpl(dbConn, stmt, rs, key, derbySemaphore);\n       } catch (SQLException ex) {\n-        rollbackDBConn(dbConn);\n-        close(rs, stmt, dbConn);\n         checkRetryable(dbConn, ex, \"acquireLock(\" + key + \")\");\n         throw new MetaException(\"Unable to lock \" + quoteString(key) + \" due to: \" + getMessage(ex) + \"; \" + StringUtils.stringifyException(ex));\n       }\n       catch(InterruptedException ex) {\n-        rollbackDBConn(dbConn);\n-        close(rs, stmt, dbConn);\n         throw new MetaException(\"Unable to lock \" + quoteString(key) + \" due to: \" + ex.getMessage() + StringUtils.stringifyException(ex));\n       }\n       finally {\n+        if (needToCloseConn) {\n+          rollbackDBConn(dbConn);\n+          close(rs, stmt, dbConn);\n+          needToCloseConn = false;", "originalCommit": "1ef76ca24601c659e732c4227e2864b160a89344", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQzMzU4NQ==", "url": "https://github.com/apache/hive/pull/1559#discussion_r500433585", "bodyText": "Will remove", "author": "yongzhi", "createdAt": "2020-10-06T16:26:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQxMTk3OA=="}], "type": "inlineReview", "revised_code": {"commit": "3037e0bf0805319363e4cb097f34d9cf9e62ae38", "chunk": "diff --git a/standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java b/standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java\nindex 024df2b2d7..f3dc6be12a 100644\n--- a/standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java\n+++ b/standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java\n\n@@ -5266,7 +5265,6 @@ public LockHandle acquireLock(String key) throws MetaException {\n         if (needToCloseConn) {\n           rollbackDBConn(dbConn);\n           close(rs, stmt, dbConn);\n-          needToCloseConn = false;\n         }\n         unlockInternal();\n       }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQxMzA2Mg==", "url": "https://github.com/apache/hive/pull/1559#discussion_r500413062", "bodyText": "that won't work if thread was interrupted right after getting the connection, set it to true by default.", "author": "deniskuzZ", "createdAt": "2020-10-06T15:55:49Z", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java", "diffHunk": "@@ -5213,11 +5213,13 @@ public LockHandle acquireLock(String key) throws MetaException {\n     Connection dbConn = null;\n     Statement stmt = null;\n     ResultSet rs = null;\n+    boolean needToCloseConn = false;\n     try {\n       try {\n         String sqlStmt = sqlGenerator.addForUpdateClause(\"SELECT \\\"MT_COMMENT\\\" FROM \\\"AUX_TABLE\\\" WHERE \\\"MT_KEY1\\\"=\" + quoteString(key) + \" and \\\"MT_KEY2\\\"=0\");\n         lockInternal();\n         dbConn = getDbConn(Connection.TRANSACTION_READ_COMMITTED, connPoolMutex);\n+        needToCloseConn = true;", "originalCommit": "1ef76ca24601c659e732c4227e2864b160a89344", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQxODQ1Nw==", "url": "https://github.com/apache/hive/pull/1559#discussion_r500418457", "bodyText": "Also I think this LockHandle should implement AutoCloseable and close active connection if any.", "author": "deniskuzZ", "createdAt": "2020-10-06T16:03:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQxMzA2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ0NjIzMw==", "url": "https://github.com/apache/hive/pull/1559#discussion_r500446233", "bodyText": "AutoCloseable may not be necessary, lockHandle implement releaseLocks()  which close the connection.  It uses with acquireLock in our codes in following pattern:\nTxnStore.MutexAPI.LockHandle handle = null;\ntry {\nhandle = txnHandler.getMutexAPI().acquireLock(TxnStore.MUTEX_KEY.TxnCleaner.name());\nlong start = System.currentTimeMillis();\ntxnHandler.cleanEmptyAbortedAndCommittedTxns();\nLOG.debug(\"Txn cleaner service took: {} seconds.\", elapsedSince(start));\n} catch (Throwable t) {\nLOG.error(\"Unexpected error in thread: {}, message: {}\", Thread.currentThread().getName(), t.getMessage(), t);\n} finally {\nif (handle != null) {\nhandle.releaseLocks();\n}\n}\nWill fix the variable needToCloseConn", "author": "yongzhi", "createdAt": "2020-10-06T16:45:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQxMzA2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUyMDA3NA==", "url": "https://github.com/apache/hive/pull/1559#discussion_r500520074", "bodyText": "hopefully it's done like this everywhere, otherwise we might get same issue but in different place", "author": "deniskuzZ", "createdAt": "2020-10-06T18:45:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQxMzA2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUzNTA5NA==", "url": "https://github.com/apache/hive/pull/1559#discussion_r500535094", "bodyText": "Yes, I checked every place that acquireLock is called, they are always matching.", "author": "yongzhi", "createdAt": "2020-10-06T19:11:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQxMzA2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "3037e0bf0805319363e4cb097f34d9cf9e62ae38", "chunk": "diff --git a/standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java b/standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java\nindex 024df2b2d7..f3dc6be12a 100644\n--- a/standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java\n+++ b/standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java\n\n@@ -5213,13 +5213,12 @@ public LockHandle acquireLock(String key) throws MetaException {\n     Connection dbConn = null;\n     Statement stmt = null;\n     ResultSet rs = null;\n-    boolean needToCloseConn = false;\n+    boolean needToCloseConn = true;\n     try {\n       try {\n         String sqlStmt = sqlGenerator.addForUpdateClause(\"SELECT \\\"MT_COMMENT\\\" FROM \\\"AUX_TABLE\\\" WHERE \\\"MT_KEY1\\\"=\" + quoteString(key) + \" and \\\"MT_KEY2\\\"=0\");\n         lockInternal();\n         dbConn = getDbConn(Connection.TRANSACTION_READ_COMMITTED, connPoolMutex);\n-        needToCloseConn = true;\n         stmt = dbConn.createStatement();\n         if(LOG.isDebugEnabled()) {\n           LOG.debug(\"About to execute SQL: \" + sqlStmt);\n"}}, {"oid": "3037e0bf0805319363e4cb097f34d9cf9e62ae38", "url": "https://github.com/apache/hive/commit/3037e0bf0805319363e4cb097f34d9cf9e62ae38", "message": "HIVE-24236: Fixed possible Connection leaks in TxnHandler", "committedDate": "2020-10-06T16:51:14Z", "type": "commit"}, {"oid": "3037e0bf0805319363e4cb097f34d9cf9e62ae38", "url": "https://github.com/apache/hive/commit/3037e0bf0805319363e4cb097f34d9cf9e62ae38", "message": "HIVE-24236: Fixed possible Connection leaks in TxnHandler", "committedDate": "2020-10-06T16:51:14Z", "type": "forcePushed"}, {"oid": "1d6b4643ed0ef0f4a1c51cc865994c14bbd654d6", "url": "https://github.com/apache/hive/commit/1d6b4643ed0ef0f4a1c51cc865994c14bbd654d6", "message": "To trigger the pre-commit tests", "committedDate": "2020-10-07T20:47:18Z", "type": "commit"}]}