{"pr_number": 1168, "pr_title": "Null exception setting email", "pr_createdAt": "2020-09-28T19:20:22Z", "pr_url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1168", "timeline": [{"oid": "641ad11a4922aa1c3c5a878bb0020d11fd94daa5", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/641ad11a4922aa1c3c5a878bb0020d11fd94daa5", "message": "Add callback when email task gets queued", "committedDate": "2020-09-25T18:57:39Z", "type": "commit"}, {"oid": "14e88b17c8cab15dc53d0a905ef0cf7cf2d06233", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/14e88b17c8cab15dc53d0a905ef0cf7cf2d06233", "message": "Fixed EmailUpdateHandler test case", "committedDate": "2020-09-25T19:50:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE3OTMwMw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1168#discussion_r496179303", "bodyText": "remote params shouldn't be null at this point, because of the shouldQueueTaskForInit check. Why is it needed?", "author": "Jeasmine", "createdAt": "2020-09-28T19:22:28Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignal.java", "diffHunk": "@@ -1319,7 +1322,7 @@ public void run() {\n          return;\n       }\n \n-      if (getRemoteParams().useEmailAuth && emailAuthHash == null) {\n+      if (getRemoteParams() != null && getRemoteParams().useEmailAuth && emailAuthHash == null) {", "originalCommit": "14e88b17c8cab15dc53d0a905ef0cf7cf2d06233", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE4MTQ1Mw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1168#discussion_r496181453", "bodyText": "When there is a connection issue and the remote configuration is not previously setup, then getRemoteParams() is Null and this is the breaking point for the issue found.", "author": "andrespelaezp", "createdAt": "2020-09-28T19:26:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE3OTMwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjIwMTA5NQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1168#discussion_r496201095", "bodyText": "Sry I might be missing some part, but shouldQueueTaskForInit check for remote == null, if remote is still null because the network failed, then the task should be queue again, or why is it not being queue again?", "author": "Jeasmine", "createdAt": "2020-09-28T20:04:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE3OTMwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjIwMjYxMw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1168#discussion_r496202613", "bodyText": "It does get queued, but it also continues evaluating the statements below. Another approach could be a return statement within the task schedule block, what do you think?", "author": "andrespelaezp", "createdAt": "2020-09-28T20:07:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE3OTMwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjIwMzk0Mw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1168#discussion_r496203943", "bodyText": "oooh I see, that method is missing the return! good catch, so that is why is failing", "author": "Jeasmine", "createdAt": "2020-09-28T20:10:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE3OTMwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjIwNDEzOA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1168#discussion_r496204138", "bodyText": "No other changes should be needed but the return stmt", "author": "Jeasmine", "createdAt": "2020-09-28T20:10:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE3OTMwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjIwNDI5MA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1168#discussion_r496204290", "bodyText": "compare with the other methods using shouldQueueTaskForInit", "author": "Jeasmine", "createdAt": "2020-09-28T20:10:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE3OTMwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc0Nzk1Mg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1168#discussion_r497747952", "bodyText": "This is redundant code, the shouldQueueTaskForInit check and the return added above would cover this so I think we should remove the null check that was added in this PR.", "author": "jkasten2", "createdAt": "2020-09-30T19:26:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE3OTMwMw=="}], "type": "inlineReview", "revised_code": {"commit": "8ee6b4632c0cb8bced1d180dbf8221ec582a1f61", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignal.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignal.java\nindex 285d4782..f8136486 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignal.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignal.java\n\n@@ -1322,7 +1320,7 @@ public class OneSignal {\n          return;\n       }\n \n-      if (getRemoteParams() != null && getRemoteParams().useEmailAuth && emailAuthHash == null) {\n+      if (getRemoteParams().useEmailAuth && emailAuthHash == null) {\n          String errorMessage = \"Email authentication (auth token) is set to REQUIRED for this application. Please provide an auth token from your backend server or change the setting in the OneSignal dashboard.\";\n          if (callback != null)\n             callback.onFailure(new EmailUpdateError(EmailErrorType.REQUIRES_EMAIL_AUTH, errorMessage));\n"}}, {"oid": "60830c060ab4acacc398ae459185f12a6954588e", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/60830c060ab4acacc398ae459185f12a6954588e", "message": "Added return statement inside setEmail shouldQueueTaskForInit", "committedDate": "2020-09-28T20:22:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc0NjIyMg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1168#discussion_r497746222", "bodyText": "I don't think we should change / add new APIs to address this bug fix PR. However I am open to a proposal on a new API to best handle this scenario for all our methods for consistency.\nJust some feedback on the API itself though, I would expect a return value from setEmail instead of a callback that it has been queued.", "author": "jkasten2", "createdAt": "2020-09-30T19:23:10Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignal.java", "diffHunk": "@@ -1299,13 +1300,16 @@ public static void setEmail(@NonNull final String email, @Nullable final String\n       if (taskController.shouldQueueTaskForInit(OSTaskController.SET_EMAIL)) {\n          logger.error(\"Waiting for remote params. \" +\n                  \"Moving \" + OSTaskController.SET_EMAIL + \" operation to a pending task queue.\");\n+         if (callback != null)\n+            callback.onTaskQueued();", "originalCommit": "60830c060ab4acacc398ae459185f12a6954588e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI1MDM4MQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1168#discussion_r498250381", "bodyText": "Noted, I will keep this in mind for a future integration", "author": "andrespelaezp", "createdAt": "2020-10-01T13:37:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc0NjIyMg=="}], "type": "inlineReview", "revised_code": {"commit": "8ee6b4632c0cb8bced1d180dbf8221ec582a1f61", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignal.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignal.java\nindex 4d802d49..f8136486 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignal.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignal.java\n\n@@ -1300,8 +1299,6 @@ public class OneSignal {\n       if (taskController.shouldQueueTaskForInit(OSTaskController.SET_EMAIL)) {\n          logger.error(\"Waiting for remote params. \" +\n                  \"Moving \" + OSTaskController.SET_EMAIL + \" operation to a pending task queue.\");\n-         if (callback != null)\n-            callback.onTaskQueued();\n          taskController.addTaskToQueue(new Runnable() {\n             @Override\n             public void run() {\n"}}, {"oid": "8ee6b4632c0cb8bced1d180dbf8221ec582a1f61", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/8ee6b4632c0cb8bced1d180dbf8221ec582a1f61", "message": "Removed callback for email task queued", "committedDate": "2020-10-01T13:39:30Z", "type": "commit"}, {"oid": "1c9f8409c4c4429b7782b37cb7a3f2172135dd1d", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/1c9f8409c4c4429b7782b37cb7a3f2172135dd1d", "message": "Removed callback for email task queued", "committedDate": "2020-10-01T16:22:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUyMzEzOQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1168#discussion_r498523139", "bodyText": "This also needs to be removed", "author": "jkasten2", "createdAt": "2020-10-01T21:30:40Z", "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/MainOneSignalClassRunner.java", "diffHunk": "@@ -1637,6 +1637,11 @@ public void onSuccess() {\n       public void onFailure(OneSignal.EmailUpdateError error) {\n          emailFiredFailure = error;\n       }\n+\n+      @Override", "originalCommit": "1c9f8409c4c4429b7782b37cb7a3f2172135dd1d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3140f79c2f182737ca581b5ee456dcbf9a0525a5", "chunk": "diff --git a/OneSignalSDK/unittest/src/test/java/com/test/onesignal/MainOneSignalClassRunner.java b/OneSignalSDK/unittest/src/test/java/com/test/onesignal/MainOneSignalClassRunner.java\nindex c0f633db..19ae39a7 100644\n--- a/OneSignalSDK/unittest/src/test/java/com/test/onesignal/MainOneSignalClassRunner.java\n+++ b/OneSignalSDK/unittest/src/test/java/com/test/onesignal/MainOneSignalClassRunner.java\n\n@@ -1637,11 +1637,6 @@ public class MainOneSignalClassRunner {\n       public void onFailure(OneSignal.EmailUpdateError error) {\n          emailFiredFailure = error;\n       }\n-\n-      @Override\n-      public void onTaskQueued() {\n-         emailFiredSuccess = false;\n-      }\n    }\n \n    @Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUyMzM3Mg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1168#discussion_r498523372", "bodyText": "TravisCI is failing due to a Java compile error due to this interface method no longer existing.", "author": "jkasten2", "createdAt": "2020-10-01T21:31:17Z", "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/MainOneSignalClassRunner.java", "diffHunk": "@@ -1637,6 +1637,11 @@ public void onSuccess() {\n       public void onFailure(OneSignal.EmailUpdateError error) {\n          emailFiredFailure = error;\n       }\n+\n+      @Override", "originalCommit": "1c9f8409c4c4429b7782b37cb7a3f2172135dd1d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3140f79c2f182737ca581b5ee456dcbf9a0525a5", "chunk": "diff --git a/OneSignalSDK/unittest/src/test/java/com/test/onesignal/MainOneSignalClassRunner.java b/OneSignalSDK/unittest/src/test/java/com/test/onesignal/MainOneSignalClassRunner.java\nindex c0f633db..19ae39a7 100644\n--- a/OneSignalSDK/unittest/src/test/java/com/test/onesignal/MainOneSignalClassRunner.java\n+++ b/OneSignalSDK/unittest/src/test/java/com/test/onesignal/MainOneSignalClassRunner.java\n\n@@ -1637,11 +1637,6 @@ public class MainOneSignalClassRunner {\n       public void onFailure(OneSignal.EmailUpdateError error) {\n          emailFiredFailure = error;\n       }\n-\n-      @Override\n-      public void onTaskQueued() {\n-         emailFiredSuccess = false;\n-      }\n    }\n \n    @Test\n"}}, {"oid": "3140f79c2f182737ca581b5ee456dcbf9a0525a5", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/3140f79c2f182737ca581b5ee456dcbf9a0525a5", "message": "Removed email task callback from MainOneSignalClassRunner", "committedDate": "2020-10-02T18:13:55Z", "type": "commit"}]}