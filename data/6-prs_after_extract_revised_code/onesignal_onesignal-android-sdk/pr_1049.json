{"pr_number": 1049, "pr_title": "Fix DIRECT IAM influence being cache", "pr_createdAt": "2020-06-09T02:06:26Z", "pr_url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1049", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzUwMzA4MQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1049#discussion_r437503081", "bodyText": "A comment should be added to explain that within cacheState for IAM tracker we always downgrade DIRECT since leaving the app while showing an IAM would be a DIRECT state", "author": "mikechoch", "createdAt": "2020-06-09T15:12:31Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/influence/OSInAppMessageTracker.java", "diffHunk": "@@ -95,6 +95,7 @@ void addSessionData(@NonNull JSONObject jsonObject, OSInfluence influence) {\n \n     @Override\n     public void cacheState() {\n-        dataRepository.cacheIAMInfluenceType(influenceType == null ? OSInfluenceType.UNATTRIBUTED : influenceType);\n+        OSInfluenceType influenceTypeToCache = influenceType == null ? OSInfluenceType.UNATTRIBUTED : influenceType;\n+        dataRepository.cacheIAMInfluenceType(influenceTypeToCache == OSInfluenceType.DIRECT ? OSInfluenceType.INDIRECT : influenceTypeToCache);\n     }", "originalCommit": "85969cb66a1c941068dbb4c721aa0f0ed4add057", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f9c27578ddca5c124317df3299ab4c95708b440b", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/influence/OSInAppMessageTracker.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/influence/OSInAppMessageTracker.java\nindex cf29a33e..17354431 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/influence/OSInAppMessageTracker.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/influence/OSInAppMessageTracker.java\n\n@@ -95,6 +95,9 @@ class OSInAppMessageTracker extends OSChannelTracker {\n \n     @Override\n     public void cacheState() {\n+        // We only need to cache INDIRECT and UNATTRIBUTED influence types\n+        // DIRECT is downgrade to INDIRECT to avoid inconsistency state\n+        // where the app might be close before dismissing current displayed IAM\n         OSInfluenceType influenceTypeToCache = influenceType == null ? OSInfluenceType.UNATTRIBUTED : influenceType;\n         dataRepository.cacheIAMInfluenceType(influenceTypeToCache == OSInfluenceType.DIRECT ? OSInfluenceType.INDIRECT : influenceTypeToCache);\n     }\n"}}, {"oid": "f9c27578ddca5c124317df3299ab4c95708b440b", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/f9c27578ddca5c124317df3299ab4c95708b440b", "message": "Fix DIRECT IAM influence being cache\n\n   * IAM Direct influence shoudn't be cache because DIRECT Influence will be only while the IAM is being display\n   * Instead of caching DIRECT cache INDIRECT", "committedDate": "2020-06-09T16:31:50Z", "type": "commit"}, {"oid": "f9c27578ddca5c124317df3299ab4c95708b440b", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/f9c27578ddca5c124317df3299ab4c95708b440b", "message": "Fix DIRECT IAM influence being cache\n\n   * IAM Direct influence shoudn't be cache because DIRECT Influence will be only while the IAM is being display\n   * Instead of caching DIRECT cache INDIRECT", "committedDate": "2020-06-09T16:31:50Z", "type": "forcePushed"}]}