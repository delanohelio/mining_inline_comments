{"pr_number": 1099, "pr_title": "Fix ANR due to on_focus call being call from MainThread", "pr_createdAt": "2020-07-24T16:44:21Z", "pr_url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1099", "timeline": [{"oid": "1df6c8e841245fdbfeb747affff9363b8f531f93", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/1df6c8e841245fdbfeb747affff9363b8f531f93", "message": "Fix ANR due to on_focus call being call from MainThread\n\n* When attempSessionUpgrade is call, onFocus call can end being call from mainThread\n* Add MainThread check on makeRequest\n* Throw RuntimeException when running network calls from MainThread", "committedDate": "2020-07-24T16:45:01Z", "type": "forcePushed"}, {"oid": "dd2bacd956288dd412338e0e5ec2cf2d0bcd602b", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/dd2bacd956288dd412338e0e5ec2cf2d0bcd602b", "message": "Fix ANR due to on_focus call being call from MainThread\n\n* When attempSessionUpgrade is call, onFocus call can end being call from mainThread\n* Add MainThread check on makeRequest\n* Throw RuntimeException when running network calls from MainThread\n* For testing Shadow OSUtils isThreadRunningOnMainThread", "committedDate": "2020-07-24T17:39:24Z", "type": "forcePushed"}, {"oid": "ed30278c05a241d25da4812d7be0590ac8577399", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/ed30278c05a241d25da4812d7be0590ac8577399", "message": "Fix ANR due to on_focus call being call from MainThread\n\n* When attempSessionUpgrade is call, onFocus call can end being call from mainThread\n* Add MainThread check on makeRequest\n* Throw RuntimeException when running network calls from MainThread\n* For testing Shadow OSUtils isThreadRunningOnMainThread", "committedDate": "2020-07-24T17:49:34Z", "type": "forcePushed"}, {"oid": "a2245df1eb2e83d47acead4f16af0dc65c5aa32a", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/a2245df1eb2e83d47acead4f16af0dc65c5aa32a", "message": "Fix ANR due to on_focus call being call from MainThread\n\n* When attempSessionUpgrade is call, onFocus call can end being call from mainThread\n* Add MainThread check on makeRequest\n* Throw RuntimeException when running network calls from MainThread\n* For testing Shadow OSUtils isThreadRunningOnMainThread", "committedDate": "2020-07-24T18:57:59Z", "type": "forcePushed"}, {"oid": "49f03821eadb618b8d674b3d0ff1be5b45aef992", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/49f03821eadb618b8d674b3d0ff1be5b45aef992", "message": "Fix ANR due to on_focus call being call from MainThread\n\n* When attempSessionUpgrade is call, onFocus call can end being call from mainThread\n* Add MainThread check on makeRequest\n* Throw RuntimeException when running network calls from MainThread\n* For testing Shadow OSUtils isThreadRunningOnMainThread", "committedDate": "2020-07-24T19:13:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI0MDU3MQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1099#discussion_r460240571", "bodyText": "Let's put this before the privacy consent check. This means we will fail faster so we can detect issues sooner if this become a problem in the future.", "author": "jkasten2", "createdAt": "2020-07-24T19:13:59Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalRestClient.java", "diffHunk": "@@ -103,7 +104,10 @@ private static void makeRequest(final String url, final String method, final JSO\n       // If not a GET request, check if the user provided privacy consent if the application is set to require user privacy consent\n       if (method != null && OneSignal.shouldLogUserPrivacyConsentErrorMessageForMethodName(null))\n          return;\n-   \n+\n+      if (OSUtils.isThreadRunningOnMainThread())", "originalCommit": "49f03821eadb618b8d674b3d0ff1be5b45aef992", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b7f4b8db9d31b12e0fcf0bf643b27094cc2df711", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalRestClient.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalRestClient.java\nindex cc3e3b61..2972fb73 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalRestClient.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalRestClient.java\n\n@@ -101,13 +101,13 @@ class OneSignalRestClient {\n    }\n    \n    private static void makeRequest(final String url, final String method, final JSONObject jsonBody, final ResponseHandler responseHandler, final int timeout, final String cacheKey) {\n+      if (OSUtils.isThreadRunningOnMainThread())\n+         throw new OneSignalNetworkCallException(\"Method: \" + method + \" was called from the Main Thread!\");\n+\n       // If not a GET request, check if the user provided privacy consent if the application is set to require user privacy consent\n       if (method != null && OneSignal.shouldLogUserPrivacyConsentErrorMessageForMethodName(null))\n          return;\n \n-      if (OSUtils.isThreadRunningOnMainThread())\n-         throw new OneSignalNetworkCallException(\"Method: \" + method + \" was called from the Main Thread!\");\n-\n       final Thread[] callbackThread = new Thread[1];\n       Thread connectionThread = new Thread(new Runnable() {\n          public void run() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI0MDk5MA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1099#discussion_r460240990", "bodyText": "We shouldn't be overriding this for the tests. We will want to know in the tests if we have an issue with a network call being made on the main thread.", "author": "jkasten2", "createdAt": "2020-07-24T19:14:58Z", "path": "OneSignalSDK/unittest/src/test/java/com/onesignal/ShadowOSUtils.java", "diffHunk": "@@ -88,6 +89,11 @@ public static void resetStatics() {\n \n    }\n \n+   @Implementation\n+   public static boolean isThreadRunningOnMainThread() {", "originalCommit": "49f03821eadb618b8d674b3d0ff1be5b45aef992", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI1MTkzOA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1099#discussion_r460251938", "bodyText": "yeah U r right", "author": "Jeasmine", "createdAt": "2020-07-24T19:38:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI0MDk5MA=="}], "type": "inlineReview", "revised_code": {"commit": "b7f4b8db9d31b12e0fcf0bf643b27094cc2df711", "chunk": "diff --git a/OneSignalSDK/unittest/src/test/java/com/onesignal/ShadowOSUtils.java b/OneSignalSDK/unittest/src/test/java/com/onesignal/ShadowOSUtils.java\nindex 904f5dd0..bf1e5bc1 100644\n--- a/OneSignalSDK/unittest/src/test/java/com/onesignal/ShadowOSUtils.java\n+++ b/OneSignalSDK/unittest/src/test/java/com/onesignal/ShadowOSUtils.java\n\n@@ -89,11 +88,6 @@ public class ShadowOSUtils {\n \n    }\n \n-   @Implementation\n-   public static boolean isThreadRunningOnMainThread() {\n-      return false;\n-   }\n-\n    public String getCarrierName() {\n       return carrierName;\n    }\n"}}, {"oid": "b7f4b8db9d31b12e0fcf0bf643b27094cc2df711", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/b7f4b8db9d31b12e0fcf0bf643b27094cc2df711", "message": "Fix ANR due to on_focus call being call from MainThread\n\n* When attempSessionUpgrade is call, onFocus call can end being call from mainThread\n* Add MainThread check on makeRequest\n* Throw RuntimeException when running network calls from MainThread\n* For testing Shadow OSUtils isThreadRunningOnMainThread", "committedDate": "2020-07-24T19:49:08Z", "type": "forcePushed"}, {"oid": "d76b2fb38e877d6e4c9e8b80eba2a0eaf0880194", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/d76b2fb38e877d6e4c9e8b80eba2a0eaf0880194", "message": "Fix ANR due to on_focus call being call from MainThread\n\n* When attempSessionUpgrade is call, onFocus call can end being call from mainThread\n* Add MainThread check on makeRequest\n* Throw RuntimeException when running network calls from MainThread\n* For testing Shadow OSUtils isThreadRunningOnMainThread", "committedDate": "2020-07-24T19:50:14Z", "type": "forcePushed"}, {"oid": "4dea98ddcec5a9da7d58f5783ff88a8923a5faad", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/4dea98ddcec5a9da7d58f5783ff88a8923a5faad", "message": "Fix ANR due to on_focus call being call from MainThread\n\n* When attempSessionUpgrade is call, onFocus call can end being call from mainThread\n* Add MainThread check on makeRequest\n* Throw RuntimeException when running network calls from MainThread\n* For testing Shadow OSUtils isThreadRunningOnMainThread", "committedDate": "2020-07-24T19:51:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI3NTM1Mw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1099#discussion_r460275353", "bodyText": "This could be changed to just OneSignalRestClient.get(\"URL\", null, null); which is asynchronous. This would simplify this.\nOr does this create any issues with the tests getting stuck?", "author": "jkasten2", "createdAt": "2020-07-24T20:35:03Z", "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/RESTClientRunner.java", "diffHunk": "@@ -92,23 +99,38 @@ public void testRESTClientFallbackTimeout() throws Exception {\n \n    @Test\n    public void SDKHeaderIsIncludedInGetCalls() throws Exception {\n-      OneSignalRestClient.getSync(\"URL\", null, null);\n+      new Thread(new Runnable() {\n+         @Override\n+         public void run() {\n+            OneSignalRestClient.getSync(\"URL\", null, null);", "originalCommit": "4dea98ddcec5a9da7d58f5783ff88a8923a5faad", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2a5788e026a9cf328e8331807c609efec57d5a71", "chunk": "diff --git a/OneSignalSDK/unittest/src/test/java/com/test/onesignal/RESTClientRunner.java b/OneSignalSDK/unittest/src/test/java/com/test/onesignal/RESTClientRunner.java\nindex 995ad222..0dafd743 100644\n--- a/OneSignalSDK/unittest/src/test/java/com/test/onesignal/RESTClientRunner.java\n+++ b/OneSignalSDK/unittest/src/test/java/com/test/onesignal/RESTClientRunner.java\n\n@@ -99,12 +92,7 @@ public class RESTClientRunner {\n \n    @Test\n    public void SDKHeaderIsIncludedInGetCalls() throws Exception {\n-      new Thread(new Runnable() {\n-         @Override\n-         public void run() {\n-            OneSignalRestClient.getSync(\"URL\", null, null);\n-         }\n-      }, OS_REST_CLIENT).start();\n+      OneSignalRestClient.get(\"URL\", null, null);\n       threadAndTaskWait();\n \n       assertEquals(SDK_VERSION_HTTP_HEADER, getLastHTTPHeaderProp(\"SDK-Version\"));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI3NTkyMg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1099#discussion_r460275922", "bodyText": "how about more simply isRunningOnMainThread?", "author": "rgomezp", "createdAt": "2020-07-24T20:36:32Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSUtils.java", "diffHunk": "@@ -475,6 +475,10 @@ static boolean areNotificationsEnabled(Context  context) {\n       return true;\n    }\n \n+   static boolean isThreadRunningOnMainThread() {", "originalCommit": "4dea98ddcec5a9da7d58f5783ff88a8923a5faad", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2a5788e026a9cf328e8331807c609efec57d5a71", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSUtils.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSUtils.java\nindex 6b6f503a..8478f6de 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSUtils.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSUtils.java\n\n@@ -475,7 +475,7 @@ class OSUtils {\n       return true;\n    }\n \n-   static boolean isThreadRunningOnMainThread() {\n+   static boolean isRunningOnMainThread() {\n       return Thread.currentThread().equals(Looper.getMainLooper().getThread());\n    }\n \n"}}, {"oid": "2a5788e026a9cf328e8331807c609efec57d5a71", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/2a5788e026a9cf328e8331807c609efec57d5a71", "message": "Fix ANR due to on_focus call being call from MainThread\n\n* When attempSessionUpgrade is call, onFocus call can end being call from mainThread\n* Add MainThread check on makeRequest\n* Throw RuntimeException when running network calls from MainThread\n* For testing Shadow OSUtils isThreadRunningOnMainThread", "committedDate": "2020-07-24T20:39:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk3MTkwOA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1099#discussion_r460971908", "bodyText": "OneSignalRestClient.post(\"URL\", null,null);\nneeds a space between null,null\nOneSignalRestClient.post(\"URL\", null, null);", "author": "mikechoch", "createdAt": "2020-07-27T15:23:12Z", "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/RESTClientRunner.java", "diffHunk": "@@ -92,23 +92,23 @@ public void testRESTClientFallbackTimeout() throws Exception {\n \n    @Test\n    public void SDKHeaderIsIncludedInGetCalls() throws Exception {\n-      OneSignalRestClient.getSync(\"URL\", null, null);\n+      OneSignalRestClient.get(\"URL\", null, null);\n       threadAndTaskWait();\n \n       assertEquals(SDK_VERSION_HTTP_HEADER, getLastHTTPHeaderProp(\"SDK-Version\"));\n    }\n \n    @Test\n    public void SDKHeaderIsIncludedInPostCalls() throws Exception {\n-      OneSignalRestClient.postSync(\"URL\", null,null);\n+      OneSignalRestClient.post(\"URL\", null,null);", "originalCommit": "2a5788e026a9cf328e8331807c609efec57d5a71", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b32da4f1cd67f03afe9ccad130a524c5bb4401de", "chunk": "diff --git a/OneSignalSDK/unittest/src/test/java/com/test/onesignal/RESTClientRunner.java b/OneSignalSDK/unittest/src/test/java/com/test/onesignal/RESTClientRunner.java\nindex 0dafd743..0abbde81 100644\n--- a/OneSignalSDK/unittest/src/test/java/com/test/onesignal/RESTClientRunner.java\n+++ b/OneSignalSDK/unittest/src/test/java/com/test/onesignal/RESTClientRunner.java\n\n@@ -100,7 +100,7 @@ public class RESTClientRunner {\n \n    @Test\n    public void SDKHeaderIsIncludedInPostCalls() throws Exception {\n-      OneSignalRestClient.post(\"URL\", null,null);\n+      OneSignalRestClient.post(\"URL\", null, null);\n       threadAndTaskWait();\n \n       assertEquals(SDK_VERSION_HTTP_HEADER, getLastHTTPHeaderProp(\"SDK-Version\"));\n"}}, {"oid": "b32da4f1cd67f03afe9ccad130a524c5bb4401de", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/b32da4f1cd67f03afe9ccad130a524c5bb4401de", "message": "Fix ANR due to on_focus call being call from MainThread\n\n* When attempSessionUpgrade is call, onFocus call can end being call from mainThread\n* Add MainThread check on makeRequest\n* Throw RuntimeException when running network calls from MainThread\n* For testing Shadow OSUtils isThreadRunningOnMainThread", "committedDate": "2020-07-27T15:37:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk5Mjk1Nw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1099#discussion_r460992957", "bodyText": "Whoops found another missing a space", "author": "mikechoch", "createdAt": "2020-07-27T15:53:46Z", "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/RESTClientRunner.java", "diffHunk": "@@ -82,7 +82,7 @@ public void testRESTClientFallbackTimeout() throws Exception {\n          mockThreadHang = true;\n       }};\n \n-      OneSignalRestClient.getSync(\"URL\", null,\"\");\n+      OneSignalRestClient.get(\"URL\", null,\"\");", "originalCommit": "b32da4f1cd67f03afe9ccad130a524c5bb4401de", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "edf0064c5caa9f79245fbe027114173e8f99aa76", "chunk": "diff --git a/OneSignalSDK/unittest/src/test/java/com/test/onesignal/RESTClientRunner.java b/OneSignalSDK/unittest/src/test/java/com/test/onesignal/RESTClientRunner.java\nindex 0abbde81..e4045dbf 100644\n--- a/OneSignalSDK/unittest/src/test/java/com/test/onesignal/RESTClientRunner.java\n+++ b/OneSignalSDK/unittest/src/test/java/com/test/onesignal/RESTClientRunner.java\n\n@@ -82,7 +82,7 @@ public class RESTClientRunner {\n          mockThreadHang = true;\n       }};\n \n-      OneSignalRestClient.get(\"URL\", null,\"\");\n+      OneSignalRestClient.get(\"URL\", null, \"\");\n       threadAndTaskWait();\n \n       assertTrue(ShadowOneSignalRestClientWithMockConnection.lastConnection.getDidInterruptMockHang());\n"}}, {"oid": "edf0064c5caa9f79245fbe027114173e8f99aa76", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/edf0064c5caa9f79245fbe027114173e8f99aa76", "message": "Fix ANR due to on_focus call being call from MainThread\n\n* When attempSessionUpgrade is call, onFocus call can end being call from mainThread\n* Add MainThread check on makeRequest\n* Throw RuntimeException when running network calls from MainThread\n* For testing Shadow OSUtils isThreadRunningOnMainThread", "committedDate": "2020-07-27T21:18:49Z", "type": "commit"}, {"oid": "edf0064c5caa9f79245fbe027114173e8f99aa76", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/edf0064c5caa9f79245fbe027114173e8f99aa76", "message": "Fix ANR due to on_focus call being call from MainThread\n\n* When attempSessionUpgrade is call, onFocus call can end being call from mainThread\n* Add MainThread check on makeRequest\n* Throw RuntimeException when running network calls from MainThread\n* For testing Shadow OSUtils isThreadRunningOnMainThread", "committedDate": "2020-07-27T21:18:49Z", "type": "forcePushed"}]}