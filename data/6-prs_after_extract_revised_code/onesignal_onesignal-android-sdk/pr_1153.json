{"pr_number": 1153, "pr_title": "Fix setRequiresUserPrivacyConsent race condition", "pr_createdAt": "2020-09-17T21:26:51Z", "pr_url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1153", "timeline": [{"oid": "00fc19fc6dbf0dd6a58ec9e5955dfba10bee9c2d", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/00fc19fc6dbf0dd6a58ec9e5955dfba10bee9c2d", "message": "Added test to reproduce PrivacyConsent issue", "committedDate": "2020-09-18T00:00:05Z", "type": "forcePushed"}, {"oid": "69084b774158c679fb329b1669b69e497f50a31e", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/69084b774158c679fb329b1669b69e497f50a31e", "message": "Added test to reproduce PrivacyConsent issue", "committedDate": "2020-09-21T20:11:56Z", "type": "commit"}, {"oid": "69084b774158c679fb329b1669b69e497f50a31e", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/69084b774158c679fb329b1669b69e497f50a31e", "message": "Added test to reproduce PrivacyConsent issue", "committedDate": "2020-09-21T20:11:56Z", "type": "forcePushed"}, {"oid": "4c48bf3afd002a41ef784ac32b9a31c020676dfd", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/4c48bf3afd002a41ef784ac32b9a31c020676dfd", "message": "Removed default requires_user_privacy_consent\n\n* Removed this default remote param as it isn't included in the REST API\nresponse today from the backend.\n  - Updated 2 tests that were expecting default false being there.\n* setRequiresUserPrivacyConsent_withTrue_CalledFirst_DoesNOTCreatePlayer\nadded in the last commit now fails as a repo case than we can now fix\nin a future commit", "committedDate": "2020-09-21T20:43:45Z", "type": "commit"}, {"oid": "4c48bf3afd002a41ef784ac32b9a31c020676dfd", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/4c48bf3afd002a41ef784ac32b9a31c020676dfd", "message": "Removed default requires_user_privacy_consent\n\n* Removed this default remote param as it isn't included in the REST API\nresponse today from the backend.\n  - Updated 2 tests that were expecting default false being there.\n* setRequiresUserPrivacyConsent_withTrue_CalledFirst_DoesNOTCreatePlayer\nadded in the last commit now fails as a repo case than we can now fix\nin a future commit", "committedDate": "2020-09-21T20:43:45Z", "type": "forcePushed"}, {"oid": "bc50858dcc631bb3223123af04a0985081ab195c", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/bc50858dcc631bb3223123af04a0985081ab195c", "message": "Removed setRequiresUserPrivacyConsent pre-init\n\n* This extra check sometimes delays setting requiresUserPrivacyConsent\nto long where the player create call has already kicked off.\n* If the remote params call finishes later and contains the\nrequires_user_privacy_consent key it can still override.", "committedDate": "2020-09-21T21:35:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc5MzQ3OA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1153#discussion_r492793478", "bodyText": "there is a method for doing this under ShadowOneSignalRestClient\nsetRemoteParamsRequirePrivacyConsent", "author": "Jeasmine", "createdAt": "2020-09-22T14:44:25Z", "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/RemoteParamsTests.java", "diffHunk": "@@ -150,7 +150,9 @@ public void testUserPrivacyConsentRequired_UserConfigurationOverrideByRemotePara\n \n     @Test\n     public void testUserPrivacyConsentNotRequired_UserConfigurationOverrideByRemoteParams() throws Exception {\n-        ShadowOneSignalRestClient.setRemoteParamsGetHtmlResponse();\n+        JSONObject remoteParams = new JSONObject();\n+        remoteParams.put(\"requires_user_privacy_consent\", false);", "originalCommit": "4c48bf3afd002a41ef784ac32b9a31c020676dfd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk2MjAxMA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1153#discussion_r492962010", "bodyText": "Updated", "author": "jkasten2", "createdAt": "2020-09-22T18:52:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc5MzQ3OA=="}], "type": "inlineReview", "revised_code": {"commit": "e7834920d5fc5e3584b260b39a910a2c49f73a0d", "chunk": "diff --git a/OneSignalSDK/unittest/src/test/java/com/test/onesignal/RemoteParamsTests.java b/OneSignalSDK/unittest/src/test/java/com/test/onesignal/RemoteParamsTests.java\nindex e0af8f51..8ffcfc80 100644\n--- a/OneSignalSDK/unittest/src/test/java/com/test/onesignal/RemoteParamsTests.java\n+++ b/OneSignalSDK/unittest/src/test/java/com/test/onesignal/RemoteParamsTests.java\n\n@@ -150,9 +150,7 @@ public class RemoteParamsTests {\n \n     @Test\n     public void testUserPrivacyConsentNotRequired_UserConfigurationOverrideByRemoteParams() throws Exception {\n-        JSONObject remoteParams = new JSONObject();\n-        remoteParams.put(\"requires_user_privacy_consent\", false);\n-        ShadowOneSignalRestClient.setRemoteParamsGetHtmlResponse(remoteParams);\n+        ShadowOneSignalRestClient.setRemoteParamsRequirePrivacyConsent(false);\n \n         OneSignal.setRequiresUserPrivacyConsent(true);\n         OneSignalInit();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc5NTg0OQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1153#discussion_r492795849", "bodyText": "what will happen if the user put setRequiresUserPrivacyConsent as false, and then remote params comes with requiresUserPrivacyConsent as true?", "author": "Jeasmine", "createdAt": "2020-09-22T14:47:18Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignal.java", "diffHunk": "@@ -1012,19 +1012,6 @@ public static boolean requiresUserPrivacyConsent() {\n     * This method will be replaced by remote params set\n     */\n    public static void setRequiresUserPrivacyConsent(final boolean required) {\n-      if (taskController.shouldQueueTaskForInit(OSTaskController.SET_REQUIRES_USER_PRIVACY_CONSENT)) {", "originalCommit": "bc50858dcc631bb3223123af04a0985081ab195c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk2MTc1OA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1153#discussion_r492961758", "bodyText": "Good catch, this does work correctly by respecting the remote param. Added test in commit eaf2db6 to address this.", "author": "jkasten2", "createdAt": "2020-09-22T18:52:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc5NTg0OQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "e7834920d5fc5e3584b260b39a910a2c49f73a0d", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/e7834920d5fc5e3584b260b39a910a2c49f73a0d", "message": "fixup! Removed default requires_user_privacy_consent", "committedDate": "2020-09-22T18:45:36Z", "type": "commit"}, {"oid": "eaf2db6b1bbac5ad34ac59e146989a7e12f0308d", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/eaf2db6b1bbac5ad34ac59e146989a7e12f0308d", "message": "fixup! Removed setRequiresUserPrivacyConsent pre-init", "committedDate": "2020-09-22T18:51:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA0NTMwNw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1153#discussion_r493045307", "bodyText": "change to  ShadowOneSignalRestClient.setRemoteParamsRequirePrivacyConsent(false);", "author": "Jeasmine", "createdAt": "2020-09-22T21:30:47Z", "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/RemoteParamsTests.java", "diffHunk": "@@ -174,7 +172,9 @@ public void testUserPrivacyConsentRequired_UserConfigurationNotOverrideRemotePar\n \n     @Test\n     public void testUserPrivacyConsentNotRequired_UserConfigurationNotOverrideRemoteParams() throws Exception {\n-        ShadowOneSignalRestClient.setRemoteParamsGetHtmlResponse();\n+        JSONObject remoteParams = new JSONObject();\n+        remoteParams.put(\"requires_user_privacy_consent\", false);\n+        ShadowOneSignalRestClient.setRemoteParamsGetHtmlResponse(remoteParams);", "originalCommit": "eaf2db6b1bbac5ad34ac59e146989a7e12f0308d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA2MjM3Mw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1153#discussion_r493062373", "bodyText": "ah my bad, I changed two instances but there was other pre-existing code I copied this from.\nI am just going to update them all in another commit in this PR.", "author": "jkasten2", "createdAt": "2020-09-22T22:11:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA0NTMwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA2ODEzNQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1153#discussion_r493068135", "bodyText": "@Jeasmine Fixed in commit 8a6b882", "author": "jkasten2", "createdAt": "2020-09-22T22:26:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA0NTMwNw=="}], "type": "inlineReview", "revised_code": {"commit": "8a6b8828738abe803f38d6014d6969ca8a6c4753", "chunk": "diff --git a/OneSignalSDK/unittest/src/test/java/com/test/onesignal/RemoteParamsTests.java b/OneSignalSDK/unittest/src/test/java/com/test/onesignal/RemoteParamsTests.java\nindex 8ffcfc80..20942aff 100644\n--- a/OneSignalSDK/unittest/src/test/java/com/test/onesignal/RemoteParamsTests.java\n+++ b/OneSignalSDK/unittest/src/test/java/com/test/onesignal/RemoteParamsTests.java\n\n@@ -172,9 +168,7 @@ public class RemoteParamsTests {\n \n     @Test\n     public void testUserPrivacyConsentNotRequired_UserConfigurationNotOverrideRemoteParams() throws Exception {\n-        JSONObject remoteParams = new JSONObject();\n-        remoteParams.put(\"requires_user_privacy_consent\", false);\n-        ShadowOneSignalRestClient.setRemoteParamsGetHtmlResponse(remoteParams);\n+        ShadowOneSignalRestClient.setRemoteParamsRequirePrivacyConsent(false);\n \n         OneSignalInit();\n         threadAndTaskWait();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA1Njc0Mw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1153#discussion_r493056743", "bodyText": "will this still work if only depending on remote params? I suppose that yes because of the test setting false and being true from remote params, but just checking", "author": "Jeasmine", "createdAt": "2020-09-22T21:56:47Z", "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/OneSignalInitializationIntegrationTestsRunner.java", "diffHunk": "@@ -0,0 +1,85 @@\n+package com.test.onesignal;\r\n+\r\n+import androidx.test.core.app.ApplicationProvider;\r\n+\r\n+import com.onesignal.OneSignal;\r\n+import com.onesignal.ShadowCustomTabsClient;\r\n+import com.onesignal.ShadowCustomTabsSession;\r\n+import com.onesignal.ShadowOSUtils;\r\n+import com.onesignal.ShadowOneSignalRestClient;\r\n+import com.onesignal.ShadowPushRegistratorFCM;\r\n+import com.onesignal.StaticResetHelper;\r\n+import com.onesignal.example.BlankActivity;\r\n+\r\n+import org.junit.Before;\r\n+import org.junit.BeforeClass;\r\n+import org.junit.Test;\r\n+import org.junit.runner.RunWith;\r\n+import org.robolectric.Robolectric;\r\n+import org.robolectric.RobolectricTestRunner;\r\n+import org.robolectric.android.controller.ActivityController;\r\n+import org.robolectric.annotation.Config;\r\n+import org.robolectric.shadows.ShadowLog;\r\n+\r\n+import static com.onesignal.ShadowOneSignalRestClient.setRemoteParamsGetHtmlResponse;\r\n+import static com.test.onesignal.TestHelpers.threadAndTaskWait;\r\n+\r\n+@Config(\r\n+        packageName = \"com.onesignal.example\",\r\n+        shadows = {\r\n+            ShadowOSUtils.class,\r\n+            ShadowOneSignalRestClient.class,\r\n+            ShadowPushRegistratorFCM.class,\r\n+            ShadowCustomTabsClient.class,\r\n+            ShadowCustomTabsSession.class,\r\n+        },\r\n+        sdk = 26\r\n+)\r\n+\r\n+@RunWith(RobolectricTestRunner.class)\r\n+public class OneSignalInitializationIntegrationTestsRunner {\r\n+    private ActivityController<BlankActivity> blankActivityController;\r\n+\r\n+    @BeforeClass // Runs only once, before any tests\r\n+    public static void setUpClass() throws Exception {\r\n+        ShadowLog.stream = System.out;\r\n+        TestHelpers.beforeTestSuite();\r\n+        StaticResetHelper.saveStaticValues();\r\n+    }\r\n+\r\n+    @Before\r\n+    public void beforeEachTest() throws Exception {\r\n+        TestHelpers.beforeTestInitAndCleanup();\r\n+        setRemoteParamsGetHtmlResponse();\r\n+        blankActivityController = Robolectric.buildActivity(BlankActivity.class).create();\r\n+    }\r\n+\r\n+    private static final String APP_ID = \"11111111-2222-3333-4444-55555555555\";\r\n+    private static void helper_OneSignal_initWithAppContext() {\r\n+        OneSignal.initWithContext(ApplicationProvider.getApplicationContext());\r\n+    }\r\n+\r\n+    @Test\r\n+    public void setRequiresUserPrivacyConsent_withTrue_CalledFirst_DoesNOTCreatePlayer() throws Exception {\r\n+        OneSignal.setRequiresUserPrivacyConsent(true);\r\n+\r\n+        OneSignal.setAppId(APP_ID);\r\n+        helper_OneSignal_initWithAppContext();\r\n+        threadAndTaskWait();\r\n+\r\n+        RestClientAsserts.assertRemoteParamsWasTheOnlyNetworkCall();\r\n+    }\r\n+\r\n+    @Test\r\n+    public void setRequiresUserPrivacyConsent_withFalseAndRemoteTrue_DoesNOTCreatePlayer() throws Exception {\r\n+        ShadowOneSignalRestClient.setRemoteParamsRequirePrivacyConsent(true);\r\n+        OneSignal.setRequiresUserPrivacyConsent(false);\r\n+\r\n+        OneSignal.setAppId(APP_ID);\r\n+        helper_OneSignal_initWithAppContext();\r\n+        threadAndTaskWait();\r\n+\r\n+        RestClientAsserts.assertRemoteParamsWasTheOnlyNetworkCall();\r\n+    }\r", "originalCommit": "eaf2db6b1bbac5ad34ac59e146989a7e12f0308d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA1OTg2OA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1153#discussion_r493059868", "bodyText": "yes, correct. This test confirms this scenario.", "author": "jkasten2", "createdAt": "2020-09-22T22:04:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA1Njc0Mw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "8a6b8828738abe803f38d6014d6969ca8a6c4753", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/8a6b8828738abe803f38d6014d6969ca8a6c4753", "message": "Test clean up of requires_user_privacy_consent", "committedDate": "2020-09-22T22:25:53Z", "type": "commit"}]}