{"pr_number": 1192, "pr_title": "Notification Open now uses an Activity instead of Broadcast", "pr_createdAt": "2020-10-20T15:25:58Z", "pr_url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1192", "timeline": [{"oid": "edcb4e34cadf001591ebec77e06cc4827cf9bb10", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/edcb4e34cadf001591ebec77e06cc4827cf9bb10", "message": "Notification Open should use Activity instead of Broadcast\n\n* Switch to using NotificationOpenedActivity.class in GenerateNotification.java\n* Remove Intent flags from startOrResumeApp and use Activity Context instead of the normal context\n* Update tests to account for the new behavior", "committedDate": "2020-10-20T17:13:38Z", "type": "commit"}, {"oid": "edcb4e34cadf001591ebec77e06cc4827cf9bb10", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/edcb4e34cadf001591ebec77e06cc4827cf9bb10", "message": "Notification Open should use Activity instead of Broadcast\n\n* Switch to using NotificationOpenedActivity.class in GenerateNotification.java\n* Remove Intent flags from startOrResumeApp and use Activity Context instead of the normal context\n* Update tests to account for the new behavior", "committedDate": "2020-10-20T17:13:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMyMjgxNQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1192#discussion_r512322815", "bodyText": "Mike tried to switch this notification dismiss action to an Activity before in the past and it resulted in a visual flicker. Do these flags completely prevent that?", "author": "jkasten2", "createdAt": "2020-10-26T23:10:08Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/GenerateNotification.java", "diffHunk": "@@ -133,28 +122,20 @@ private static CharSequence getTitle(JSONObject fcmJson) {\n    }\n \n    private static PendingIntent getNewActionPendingIntent(int requestCode, Intent intent) {\n-      if (openerIsBroadcast)\n-         return PendingIntent.getBroadcast(currentContext, requestCode, intent, PendingIntent.FLAG_UPDATE_CURRENT);\n       return PendingIntent.getActivity(currentContext, requestCode, intent, PendingIntent.FLAG_UPDATE_CURRENT);\n    }\n \n    private static Intent getNewBaseIntent(int notificationId) {\n-      Intent intent = new Intent(currentContext, notificationOpenedClass)\n-                        .putExtra(BUNDLE_KEY_ANDROID_NOTIFICATION_ID, notificationId);\n-\n-      if (openerIsBroadcast)\n-         return intent;\n-      return intent.addFlags(Intent.FLAG_ACTIVITY_SINGLE_TOP | Intent.FLAG_ACTIVITY_CLEAR_TOP);\n+     return new Intent(currentContext, notificationOpenedClass)\n+             .putExtra(BUNDLE_KEY_ANDROID_NOTIFICATION_ID, notificationId)\n+             .addFlags(Intent.FLAG_ACTIVITY_SINGLE_TOP | Intent.FLAG_ACTIVITY_CLEAR_TOP);\n    }\n \n    private static Intent getNewBaseDeleteIntent(int notificationId) {\n-      Intent intent = new Intent(currentContext, notificationOpenedClass)\n-          .putExtra(BUNDLE_KEY_ANDROID_NOTIFICATION_ID, notificationId)\n-          .putExtra(\"dismissed\", true);\n-\n-      if (openerIsBroadcast)\n-         return intent;\n-      return intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_MULTIPLE_TASK | Intent.FLAG_ACTIVITY_NO_ANIMATION);\n+      return new Intent(currentContext, notificationOpenedClass)\n+              .putExtra(BUNDLE_KEY_ANDROID_NOTIFICATION_ID, notificationId)\n+              .putExtra(\"dismissed\", true)\n+              .addFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_MULTIPLE_TASK | Intent.FLAG_ACTIVITY_NO_ANIMATION);", "originalCommit": "edcb4e34cadf001591ebec77e06cc4827cf9bb10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg1NjA0Nw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1192#discussion_r516856047", "bodyText": "good catch! there is no flicker but the process is being closed", "author": "Jeasmine", "createdAt": "2020-11-03T17:58:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMyMjgxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk5MDE2Mg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1192#discussion_r516990162", "bodyText": "We might have to use a BroadcastReceiver for the dismisses. If we use an Activity for dismisses it could result in odd focus behavior in the app with extra onPause and onResume calls each time a notification is swiped away we would want to avoid.", "author": "jkasten2", "createdAt": "2020-11-03T22:22:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMyMjgxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAwMDYzOA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1192#discussion_r517000638", "bodyText": "Yeah, seems like the most reasonable solution, using intent for dismissing tracking, ends on weirds behaviors", "author": "Jeasmine", "createdAt": "2020-11-03T22:48:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMyMjgxNQ=="}], "type": "inlineReview", "revised_code": {"commit": "211e23d61d7501a4a269dade0a7f523d383d2a17", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/GenerateNotification.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/GenerateNotification.java\nindex 717d64cf..ece96bb6 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/GenerateNotification.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/GenerateNotification.java\n\n@@ -122,6 +130,16 @@ class GenerateNotification {\n    }\n \n    private static PendingIntent getNewActionPendingIntent(int requestCode, Intent intent) {\n+     return  getNewActionPendingIntent(false, requestCode, intent);\n+   }\n+\n+   /**\n+    * Notification delete is processed by Broadcast Receiver to avoid creation of activities that can end\n+    * on weird UI interaction\n+    */\n+   private static PendingIntent getNewActionPendingIntent(boolean openerIsBroadcast, int requestCode, Intent intent) {\n+      if (openerIsBroadcast)\n+         return PendingIntent.getBroadcast(currentContext, requestCode, intent, PendingIntent.FLAG_UPDATE_CURRENT);\n       return PendingIntent.getActivity(currentContext, requestCode, intent, PendingIntent.FLAG_UPDATE_CURRENT);\n    }\n \n"}}, {"oid": "211e23d61d7501a4a269dade0a7f523d383d2a17", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/211e23d61d7501a4a269dade0a7f523d383d2a17", "message": "Handle delete intent with broadcast receiver\n\n* Using activities for handling delete can end on some weird behavior on the UI", "committedDate": "2020-11-04T03:14:23Z", "type": "commit"}, {"oid": "211e23d61d7501a4a269dade0a7f523d383d2a17", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/211e23d61d7501a4a269dade0a7f523d383d2a17", "message": "Handle delete intent with broadcast receiver\n\n* Using activities for handling delete can end on some weird behavior on the UI", "committedDate": "2020-11-04T03:14:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU1MDk3OQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1192#discussion_r519550979", "bodyText": "Instead of NotificationOpenedActivity shouldn't this be NotificationOpenedReceiver or NotificationDismissReceiver?", "author": "jkasten2", "createdAt": "2020-11-09T04:49:11Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/GenerateNotification.java", "diffHunk": "@@ -79,6 +79,7 @@\n    public static final String BUNDLE_KEY_ONESIGNAL_DATA = \"onesignalData\";\n \n    private static Class<?> notificationOpenedClass = NotificationOpenedActivity.class;\n+   private static Class<?> notificationCloseClass = NotificationOpenedActivity.class;", "originalCommit": "211e23d61d7501a4a269dade0a7f523d383d2a17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU1MTcwOA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1192#discussion_r519551708", "bodyText": "The more correct terminology would be \"dismissed\" instead of \"closed\" for a notification.", "author": "jkasten2", "createdAt": "2020-11-09T04:52:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU1MDk3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "57a43103f8dbb8649631e4789354263b3692a276", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/GenerateNotification.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/GenerateNotification.java\nindex ece96bb6..a69a58e8 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/GenerateNotification.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/GenerateNotification.java\n\n@@ -78,8 +77,8 @@ class GenerateNotification {\n    //   notification Intent.\n    public static final String BUNDLE_KEY_ONESIGNAL_DATA = \"onesignalData\";\n \n-   private static Class<?> notificationOpenedClass = NotificationOpenedActivity.class;\n-   private static Class<?> notificationCloseClass = NotificationOpenedActivity.class;\n+   private static Class<?> notificationOpenedClass = NotificationOpenedReceiver.class;\n+   private static Class<?> notificationDismissedClass = NotificationDismissReceiver.class;\n    private static Resources contextResources = null;\n    private static Context currentContext = null;\n    private static String packageName = null;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU1MzUwMg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1192#discussion_r519553502", "bodyText": "This runtime check was in place since there was a change in a non-major release and we had to support both as someone may not have updated their AndroidManifest.xml.\nWe can now just safely assume NotificationDismissReceiver will always be there now in 4.0.0", "author": "jkasten2", "createdAt": "2020-11-09T04:59:46Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/GenerateNotification.java", "diffHunk": "@@ -92,6 +93,13 @@ private static void setStatics(Context inContext) {\n       currentContext = inContext;\n       packageName = currentContext.getPackageName();\n       contextResources = currentContext.getResources();\n+\n+      PackageManager packageManager = currentContext.getPackageManager();\n+      Intent intent = new Intent(currentContext, NotificationOpenedReceiver.class);\n+      intent.setPackage(currentContext.getPackageName());\n+      if (packageManager.queryBroadcastReceivers(intent, 0).size() > 0)", "originalCommit": "211e23d61d7501a4a269dade0a7f523d383d2a17", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "57a43103f8dbb8649631e4789354263b3692a276", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/GenerateNotification.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/GenerateNotification.java\nindex ece96bb6..a69a58e8 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/GenerateNotification.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/GenerateNotification.java\n\n@@ -93,13 +92,6 @@ class GenerateNotification {\n       currentContext = inContext;\n       packageName = currentContext.getPackageName();\n       contextResources = currentContext.getResources();\n-\n-      PackageManager packageManager = currentContext.getPackageManager();\n-      Intent intent = new Intent(currentContext, NotificationOpenedReceiver.class);\n-      intent.setPackage(currentContext.getPackageName());\n-      if (packageManager.queryBroadcastReceivers(intent, 0).size() > 0)\n-         notificationCloseClass = NotificationOpenedReceiver.class;\n-      OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"GenerateNotification notificationCloseClass: \" + notificationCloseClass);\n    }\n \n    @WorkerThread\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU1NzgzMw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1192#discussion_r519557833", "bodyText": "We can safely remove the openerIsBroadcast check as the open action will always be an Activity", "author": "jkasten2", "createdAt": "2020-11-09T05:18:21Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/GenerateNotification.java", "diffHunk": "@@ -122,6 +130,16 @@ private static CharSequence getTitle(JSONObject fcmJson) {\n    }\n \n    private static PendingIntent getNewActionPendingIntent(int requestCode, Intent intent) {\n+     return  getNewActionPendingIntent(false, requestCode, intent);\n+   }\n+\n+   /**\n+    * Notification delete is processed by Broadcast Receiver to avoid creation of activities that can end\n+    * on weird UI interaction\n+    */\n+   private static PendingIntent getNewActionPendingIntent(boolean openerIsBroadcast, int requestCode, Intent intent) {\n+      if (openerIsBroadcast)", "originalCommit": "211e23d61d7501a4a269dade0a7f523d383d2a17", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "57a43103f8dbb8649631e4789354263b3692a276", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/GenerateNotification.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/GenerateNotification.java\nindex ece96bb6..a69a58e8 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/GenerateNotification.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/GenerateNotification.java\n\n@@ -129,28 +121,27 @@ class GenerateNotification {\n       return currentContext.getPackageManager().getApplicationLabel(currentContext.getApplicationInfo());\n    }\n \n-   private static PendingIntent getNewActionPendingIntent(int requestCode, Intent intent) {\n-     return  getNewActionPendingIntent(false, requestCode, intent);\n-   }\n \n    /**\n     * Notification delete is processed by Broadcast Receiver to avoid creation of activities that can end\n     * on weird UI interaction\n     */\n-   private static PendingIntent getNewActionPendingIntent(boolean openerIsBroadcast, int requestCode, Intent intent) {\n-      if (openerIsBroadcast)\n-         return PendingIntent.getBroadcast(currentContext, requestCode, intent, PendingIntent.FLAG_UPDATE_CURRENT);\n+   private static PendingIntent getNewActionPendingIntent(int requestCode, Intent intent) {\n       return PendingIntent.getActivity(currentContext, requestCode, intent, PendingIntent.FLAG_UPDATE_CURRENT);\n    }\n \n+   private static PendingIntent getNewDismissActionPendingIntent(int requestCode, Intent intent) {\n+      return PendingIntent.getBroadcast(currentContext, requestCode, intent, PendingIntent.FLAG_UPDATE_CURRENT);\n+   }\n+\n    private static Intent getNewBaseIntent(int notificationId) {\n      return new Intent(currentContext, notificationOpenedClass)\n              .putExtra(BUNDLE_KEY_ANDROID_NOTIFICATION_ID, notificationId)\n              .addFlags(Intent.FLAG_ACTIVITY_SINGLE_TOP | Intent.FLAG_ACTIVITY_CLEAR_TOP);\n    }\n \n-   private static Intent getNewBaseDeleteIntent(int notificationId) {\n-      return new Intent(currentContext, notificationCloseClass)\n+   private static Intent getNewBaseDismissIntent(int notificationId) {\n+      return new Intent(currentContext, notificationDismissedClass)\n               .putExtra(BUNDLE_KEY_ANDROID_NOTIFICATION_ID, notificationId)\n               .putExtra(\"dismissed\", true);\n    }\n"}}, {"oid": "57a43103f8dbb8649631e4789354263b3692a276", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/57a43103f8dbb8649631e4789354263b3692a276", "message": "Codereview comments", "committedDate": "2020-11-10T18:44:19Z", "type": "commit"}]}