{"pr_number": 969, "pr_title": "Feature/add set external id callback", "pr_createdAt": "2020-03-09T21:50:53Z", "pr_url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/969", "timeline": [{"oid": "2b94e59ff55467802c001986864f5267a3b6e5ea", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/2b94e59ff55467802c001986864f5267a3b6e5ea", "message": "Adding a callback to the set external id method\n* This now handles the email and normal id case for changing external id with a callback\n* WIP - Add unit testing", "committedDate": "2020-03-09T18:04:32Z", "type": "commit"}, {"oid": "87464aed1c41845e910a80fb2894398b6bc2a1ee", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/87464aed1c41845e910a80fb2894398b6bc2a1ee", "message": "Finishing with external id updating callback\n* Callback will handle 3 cases\n  * Normal external id update (Success w/ newExternalUserId)\n  * Duplicate external id update (Success w/ externalUserId)\n  * Failed external id update (Failure w/ ExternalUserId error)\n* Wrote 3 unit tests for testing external user id\n  * Normal setExternalUserId success\n  * Duplicate setExternalUserId success\n  * setExternalUserId failure\n* Updated the UserStateSynchronizer class and those that inherit from it\n  * UserStateEmailSynchronizer needed to implement the new getExternalUserId method\n  * UserStatePushSynchronizer needed to implement the new getExternalUserId method", "committedDate": "2020-03-09T21:50:08Z", "type": "commit"}, {"oid": "ac5eff0e6b8b6e5040a0f0c5ba2fc7b8fe7ad6f0", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/ac5eff0e6b8b6e5040a0f0c5ba2fc7b8fe7ad6f0", "message": "Fixed 1 unit test for externalUserId callback and added 1 unit test\n* Fixed sendSameExternalUserId_withCallbackSuccess, which was not trying to send same external user id back to back\n* Added sendDifferentExternalUserId_withCallbackSuccess, which tests successful callback for changed changing the external user id", "committedDate": "2020-03-09T22:05:27Z", "type": "commit"}, {"oid": "d775b5054c61de0649818dd0dd71ed95d9e26ef2", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/d775b5054c61de0649818dd0dd71ed95d9e26ef2", "message": "Update to the a unit test for set external user id callback tests\n*  sendExternalUserId_withCallbackFailure_andWithCallbackSuccess now makes a second request for success after a failure, making sure that on failure a successful request should be made in expected conditions\n  * Example... Network failure flag is true and an attempt to set external id fails and a error is passed back. Network failure flag is false now and an additional attempt succeeds and returns the correct successfully set external user id.", "committedDate": "2020-03-09T22:16:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA1MTQ1Mw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/969#discussion_r390051453", "bodyText": "Remove ExternalUserIdUpdateHandler, both onSuccess and onFailure are blank.", "author": "jkasten2", "createdAt": "2020-03-10T01:45:58Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignal.java", "diffHunk": "@@ -1524,7 +1549,17 @@ public static void removeExternalUserId() {\n          return;\n \n       // to remove the external user ID, the API requires an empty string\n-      setExternalUserId(\"\");\n+      setExternalUserId(\"\", new ExternalUserIdUpdateHandler() {", "originalCommit": "d775b5054c61de0649818dd0dd71ed95d9e26ef2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e70890aab247c79a19e58b1ca4d084522c6f9b6c", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignal.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignal.java\nindex da7a77f5..88f5eea3 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignal.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignal.java\n\n@@ -1548,18 +1539,15 @@ public class OneSignal {\n       if (shouldLogUserPrivacyConsentErrorMessageForMethodName(\"removeExternalUserId()\"))\n          return;\n \n-      // to remove the external user ID, the API requires an empty string\n-      setExternalUserId(\"\", new ExternalUserIdUpdateHandler() {\n-         @Override\n-         public void onSuccess(String newExternalUserId) {\n-\n-         }\n+      removeExternalUserId(null);\n+   }\n \n-         @Override\n-         public void onFailure(ExternalUserIdError error) {\n+   public static void removeExternalUserId(final OSExternalUserIdUpdateCompletionHandler completionHandler) {\n+      if (shouldLogUserPrivacyConsentErrorMessageForMethodName(\"removeExternalUserId()\"))\n+         return;\n \n-         }\n-      });\n+      // to remove the external user ID, the API requires an empty string\n+      setExternalUserId(\"\", completionHandler);\n    }\n \n    /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ1MjkwNw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/969#discussion_r390452907", "bodyText": "Can the id be a generic one? Although it's a demo app, It should exclude reference to its developers, what do you think?", "author": "Jeasmine", "createdAt": "2020-03-10T16:38:51Z", "path": "OneSignalSDK/app/src/main/java/com/onesignal/MainActivity.java", "diffHunk": "@@ -268,6 +268,18 @@ public void onUnsubscribeClicked(View v) {\n \n    public void onSendTagsClicked(View v) {\n       try {\n+         OneSignal.setExternalUserId(\"mikechoch_\" + sendTagsCounter, new OneSignal.ExternalUserIdUpdateHandler() {", "originalCommit": "d775b5054c61de0649818dd0dd71ed95d9e26ef2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgzMzY5Ng==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/969#discussion_r395833696", "bodyText": "I did this lazy for testing, there is a text field now haha", "author": "mikechoch", "createdAt": "2020-03-20T18:56:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ1MjkwNw=="}], "type": "inlineReview", "revised_code": {"commit": "e70890aab247c79a19e58b1ca4d084522c6f9b6c", "chunk": "diff --git a/OneSignalSDK/app/src/main/java/com/onesignal/MainActivity.java b/OneSignalSDK/app/src/main/java/com/onesignal/MainActivity.java\nindex dfb05ee5..667e46c7 100644\n--- a/OneSignalSDK/app/src/main/java/com/onesignal/MainActivity.java\n+++ b/OneSignalSDK/app/src/main/java/com/onesignal/MainActivity.java\n\n@@ -268,18 +298,6 @@ public class MainActivity extends Activity implements OSEmailSubscriptionObserve\n \n    public void onSendTagsClicked(View v) {\n       try {\n-         OneSignal.setExternalUserId(\"mikechoch_\" + sendTagsCounter, new OneSignal.ExternalUserIdUpdateHandler() {\n-            @Override\n-            public void onSuccess(String newExternalUserId) {\n-               OneSignal.onesignalLog(OneSignal.LOG_LEVEL.VERBOSE, newExternalUserId + \" was set SUCCESS\");\n-            }\n-\n-            @Override\n-            public void onFailure(OneSignal.ExternalUserIdError error) {\n-               OneSignal.onesignalLog(OneSignal.LOG_LEVEL.VERBOSE, \"Error setting external id: \" + error.getMessage() + \" with code: \" + error.getCode());\n-            }\n-         });\n-\n          OneSignal.sendTags(new JSONObject(\"{\\\"counter\\\" : \" + sendTagsCounter + \", \\\"test_value\\\" : \\\"test_key\\\"}\"), new OneSignal.ChangeTagsUpdateHandler() {\n             @Override\n             public void onSuccess(JSONObject tags) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ1Nzg3Nw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/969#discussion_r390457877", "bodyText": "can you mark it with @nullable?", "author": "Jeasmine", "createdAt": "2020-03-10T16:46:00Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/UserStateEmailSynchronizer.java", "diffHunk": "@@ -22,6 +22,12 @@ GetTagsResult getTags(boolean fromServer) {\n         return null;\n     }\n \n+    // Email external id not readable from SDK\n+    @Override\n+    String getExternalId(boolean fromServer) {", "originalCommit": "d775b5054c61de0649818dd0dd71ed95d9e26ef2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgzMzg3Mw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/969#discussion_r395833873", "bodyText": "Sure!", "author": "mikechoch", "createdAt": "2020-03-20T18:57:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ1Nzg3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "010ccfc832f974b5a4b813459fae3ab9a534841f", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/UserStateEmailSynchronizer.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/UserStateEmailSynchronizer.java\nindex ad883f7d..3a20c6a7 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/UserStateEmailSynchronizer.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/UserStateEmailSynchronizer.java\n\n@@ -24,7 +32,7 @@ class UserStateEmailSynchronizer extends UserStateSynchronizer {\n \n     // Email external id not readable from SDK\n     @Override\n-    String getExternalId(boolean fromServer) {\n+    @Nullable String getExternalId(boolean fromServer) {\n         return null;\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ1NzkyNw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/969#discussion_r390457927", "bodyText": "can you mark it with @nullable?", "author": "Jeasmine", "createdAt": "2020-03-10T16:46:05Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/UserStatePushSynchronizer.java", "diffHunk": "@@ -63,6 +63,13 @@ void onSuccess(String responseStr) {\n         }\n     }\n \n+    @Override\n+    String getExternalId(boolean fromServer) {", "originalCommit": "d775b5054c61de0649818dd0dd71ed95d9e26ef2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "010ccfc832f974b5a4b813459fae3ab9a534841f", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/UserStatePushSynchronizer.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/UserStatePushSynchronizer.java\nindex dbfb16ce..ed9cb569 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/UserStatePushSynchronizer.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/UserStatePushSynchronizer.java\n\n@@ -64,7 +72,7 @@ class UserStatePushSynchronizer extends UserStateSynchronizer {\n     }\n \n     @Override\n-    String getExternalId(boolean fromServer) {\n+    @Nullable String getExternalId(boolean fromServer) {\n         synchronized(syncLock) {\n             return toSyncUserState.syncValues.optString(\"external_user_id\", null);\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ1ODg3MQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/969#discussion_r390458871", "bodyText": "mark it as @nullable", "author": "Jeasmine", "createdAt": "2020-03-10T16:47:33Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/UserStateSynchronizer.java", "diffHunk": "@@ -44,11 +44,14 @@ String getRegistrationId() {\n \n     abstract GetTagsResult getTags(boolean fromServer);\n \n+    abstract String getExternalId(boolean fromServer);", "originalCommit": "d775b5054c61de0649818dd0dd71ed95d9e26ef2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e70890aab247c79a19e58b1ca4d084522c6f9b6c", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/UserStateSynchronizer.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/UserStateSynchronizer.java\nindex a90e65d5..a1cf3dd7 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/UserStateSynchronizer.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/UserStateSynchronizer.java\n\n@@ -51,7 +66,11 @@ abstract class UserStateSynchronizer {\n     // Maintain a list of handlers so that if the user calls\n     //    sendTags() multiple times it will call each callback\n     final private Queue<ChangeTagsUpdateHandler> sendTagsHandlers = new ConcurrentLinkedQueue<>();\n-    final private Queue<OneSignal.ExternalUserIdUpdateHandler> updateExternalUserIdHandlers = new ConcurrentLinkedQueue<>();\n+    final private Queue<OneSignal.OSInternalExternalUserIdUpdateCompletionHandler> externalUserIdUpdateHandlers = new ConcurrentLinkedQueue<>();\n+\n+    boolean hasQueuedHandlers() {\n+        return externalUserIdUpdateHandlers.size() > 0;\n+    }\n \n     class NetworkHandlerThread extends HandlerThread {\n         protected static final int NETWORK_HANDLER_USERSTATE = 0;\n"}}, {"oid": "e70890aab247c79a19e58b1ca4d084522c6f9b6c", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/e70890aab247c79a19e58b1ca4d084522c6f9b6c", "message": "Added email and ext user id UI elements for testing in old demo app\n* Email has set and logout buttons along with text field\n* External user id has set and remove buttons along with text field\n\nModified the payload of the completion handlers now to give back specific success results for push and email channels since both are sep player records inside of the DB\n* Format is as follows: { \"channel\" : { \"success\" : boolean } }\n\nSeveral scenarios needed to be handled for setting external along side email...\n7 main scenarios:\n* Set external user id before init/register (no email set and email set)\n* Set external user id before setting email\n* Set external user id after setting email\n* Set external user id after logging out email\n* Changing external user id (no email set and email set)", "committedDate": "2020-03-20T18:45:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgzODgxMw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/969#discussion_r395838813", "bodyText": "A 2nd todo?", "author": "jkasten2", "createdAt": "2020-03-20T19:07:35Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalPrefs.java", "diffHunk": "@@ -40,12 +40,16 @@\n \n class OneSignalPrefs {\n \n+    // TODO:\n+    //  1. Fix all of the SharedPreference Keys so they are organized by usage with comments\n+    //  2.", "originalCommit": "e70890aab247c79a19e58b1ca4d084522c6f9b6c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg5Mjk2MQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/969#discussion_r395892961", "bodyText": "didnt finish typing my TODO here haha", "author": "mikechoch", "createdAt": "2020-03-20T21:15:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgzODgxMw=="}], "type": "inlineReview", "revised_code": {"commit": "010ccfc832f974b5a4b813459fae3ab9a534841f", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalPrefs.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalPrefs.java\nindex d12ef8b5..e8b3c7da 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalPrefs.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalPrefs.java\n\n@@ -40,9 +40,20 @@ import java.util.Set;\n \n class OneSignalPrefs {\n \n-    // TODO:\n+    // TODO: Remove this once the tasks below have been finished...\n     //  1. Fix all of the SharedPreference Keys so they are organized by usage with comments\n-    //  2.\n+    //  ex.\n+    //   // In-App Messaging\n+    //   public static final String PREFS_OS_CACHED_IAMS = \"PREFS_OS_CACHED_IAMS\";\n+    //   public static final String PREFS_OS_DISMISSED_IAMS = \"PREFS_OS_DISPLAYED_IAMS\";\n+    //   public static final String PREFS_OS_IMPRESSIONED_IAMS = \"PREFS_OS_IMPRESSIONED_IAMS\";\n+    //   public static final String PREFS_OS_CLICKED_CLICK_IDS_IAMS = \"PREFS_OS_CLICKED_CLICK_IDS_IAMS\";\n+    //  2. Match keys with value names\n+    //  ex.\n+    //   public static final String PREFS_OS_LAST_LOCATION_TIME = \"OS_LAST_LOCATION_TIME\";\n+    //  3. Follow syntax and make new names relevant (specific and as short as possible)\n+    //  ex.\n+    //   Start with prefix \"PREFS_OS_\" + \"LAST_LOCATION_TIME\"\n \n     // SharedPreferences Instances\n     public static final String PREFS_ONESIGNAL = OneSignal.class.getSimpleName();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg0Njc5Mw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/969#discussion_r395846793", "bodyText": "is this ok? can you remove it?", "author": "Jeasmine", "createdAt": "2020-03-20T19:25:04Z", "path": "OneSignalSDK/app/src/main/java/com/onesignal/example/OneSignalExampleApp.java", "diffHunk": "@@ -71,7 +71,7 @@ public void onCreate() {\n          new ExampleNotificationReceivedHandler()\n       );\n \n-      OneSignal.sendTag(\"test1\", \"test1\");\n+//      OneSignal.sendTag(\"test1\", \"test1\");", "originalCommit": "e70890aab247c79a19e58b1ca4d084522c6f9b6c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg5MzA0MQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/969#discussion_r395893041", "bodyText": "Sure, just the demo app", "author": "mikechoch", "createdAt": "2020-03-20T21:15:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg0Njc5Mw=="}], "type": "inlineReview", "revised_code": {"commit": "fc6c074ee3a3a01009afa38980fa0f2afb833d16", "chunk": "diff --git a/OneSignalSDK/app/src/main/java/com/onesignal/example/OneSignalExampleApp.java b/OneSignalSDK/app/src/main/java/com/onesignal/example/OneSignalExampleApp.java\nindex e4a33849..e1b1af56 100644\n--- a/OneSignalSDK/app/src/main/java/com/onesignal/example/OneSignalExampleApp.java\n+++ b/OneSignalSDK/app/src/main/java/com/onesignal/example/OneSignalExampleApp.java\n\n@@ -70,8 +70,6 @@ public class OneSignalExampleApp extends Application {\n          new ExampleNotificationOpenedHandler(),\n          new ExampleNotificationReceivedHandler()\n       );\n-\n-//      OneSignal.sendTag(\"test1\", \"test1\");\n    }\n \n    public static void setOneSignalAppId(@NonNull Context context, @NonNull String id) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg0NzY2Ng==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/969#discussion_r395847666", "bodyText": "good refactor!", "author": "Jeasmine", "createdAt": "2020-03-20T19:27:02Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalStateSynchronizer.java", "diffHunk": "@@ -33,21 +33,46 @@\n import org.json.JSONObject;\n import com.onesignal.OneSignal.ChangeTagsUpdateHandler;\n \n+import java.util.HashMap;\n+import java.util.Iterator;\n+\n class OneSignalStateSynchronizer {\n \n-   private static UserStatePushSynchronizer userStatePushSynchronizer;\n-   private static UserStateEmailSynchronizer userStateEmailSynchronizer;\n+   enum UserStateSynchronizerType {\n+      PUSH,\n+      EMAIL;\n+\n+      public boolean isPush() {\n+         return this.equals(PUSH);\n+      }\n+\n+      public boolean isEmail() {\n+         return this.equals(EMAIL);\n+      }\n+   }\n \n+   // Each class abstracts from UserStateSynchronizer and this will allow us to handle different channels for specific method calls and requests\n+   // Each time we create a new UserStateSynchronizer we should add it to the userStateSynchronizers HashMap\n+   // Currently we have 2 channels:\n+   //    1. Push\n+   //    2. Email\n+   //    Add more channels...\n+   private static HashMap<UserStateSynchronizerType, UserStateSynchronizer> userStateSynchronizers =  new HashMap<>();", "originalCommit": "e70890aab247c79a19e58b1ca4d084522c6f9b6c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg5MzExNA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/969#discussion_r395893114", "bodyText": "Thanks!", "author": "mikechoch", "createdAt": "2020-03-20T21:15:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg0NzY2Ng=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg0OTE2Ng==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/969#discussion_r395849166", "bodyText": "can \"external_user_id\" be on a constant?", "author": "Jeasmine", "createdAt": "2020-03-20T19:30:19Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/UserStatePushSynchronizer.java", "diffHunk": "@@ -63,6 +69,13 @@ void onSuccess(String responseStr) {\n         }\n     }\n \n+    @Override\n+    String getExternalId(boolean fromServer) {\n+        synchronized(syncLock) {\n+            return toSyncUserState.syncValues.optString(\"external_user_id\", null);", "originalCommit": "e70890aab247c79a19e58b1ca4d084522c6f9b6c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg5MzIzNg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/969#discussion_r395893236", "bodyText": "We dont use constants for any of our other keys. We should eventually migrate to do this though", "author": "mikechoch", "createdAt": "2020-03-20T21:15:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg0OTE2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "010ccfc832f974b5a4b813459fae3ab9a534841f", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/UserStatePushSynchronizer.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/UserStatePushSynchronizer.java\nindex fbad0f01..ed9cb569 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/UserStatePushSynchronizer.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/UserStatePushSynchronizer.java\n\n@@ -70,7 +72,7 @@ class UserStatePushSynchronizer extends UserStateSynchronizer {\n     }\n \n     @Override\n-    String getExternalId(boolean fromServer) {\n+    @Nullable String getExternalId(boolean fromServer) {\n         synchronized(syncLock) {\n             return toSyncUserState.syncValues.optString(\"external_user_id\", null);\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg1MTg4NQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/969#discussion_r395851885", "bodyText": "this that if for one userStateSynchronizer there are handler this will cancel the callback. Why isnt this called before the try catch?", "author": "Jeasmine", "createdAt": "2020-03-20T19:36:25Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalStateSynchronizer.java", "diffHunk": "@@ -174,9 +203,46 @@ static void logoutEmail() {\n       getEmailStateSynchronizer().logoutEmail();\n    }\n \n-   static void setExternalUserId(String externalId) throws JSONException {\n-      getPushStateSynchronizer().setExternalUserId(externalId);\n-      getEmailStateSynchronizer().setExternalUserId(externalId);\n+   static void setExternalUserId(String externalId, final OneSignal.OSExternalUserIdUpdateCompletionHandler completionHandler) throws JSONException {\n+      final JSONObject responses = new JSONObject();\n+      // Create a handler for internal usage, this is where the developers completion handler will be called,\n+      //  which happens once all handlers for each channel have been processed\n+      OneSignal.OSInternalExternalUserIdUpdateCompletionHandler handler = new OneSignal.OSInternalExternalUserIdUpdateCompletionHandler() {\n+         @Override\n+         public void onComplete(String channel, boolean success) {\n+            OneSignal.onesignalLog(OneSignal.LOG_LEVEL.VERBOSE, \"Completed request to update external user id for channel: \" + channel + \" and success: \" + success);\n+            try {\n+               // Latest channel success status will be overwriting previous ones since we only care about latest request status\n+               // That way the completion handler is allowing the developer to handle the most recent scenario\n+               responses.put(channel, new JSONObject().put(\"success\", success));\n+            } catch (JSONException e) {\n+               OneSignal.onesignalLog(OneSignal.LOG_LEVEL.ERROR, \"Error while adding the success status of external id for channel: \" + channel);\n+               e.printStackTrace();\n+            }\n+\n+            for (UserStateSynchronizer userStateSynchronizer : userStateSynchronizers.values()) {\n+               if (userStateSynchronizer.hasQueuedHandlers()) {", "originalCommit": "e70890aab247c79a19e58b1ca4d084522c6f9b6c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg5MzU2Mw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/969#discussion_r395893563", "bodyText": "We check if any other handlers for the Push or Email channel exist. We wont return completion until all handlers are done being processed", "author": "mikechoch", "createdAt": "2020-03-20T21:16:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg1MTg4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkyMjEyNw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/969#discussion_r395922127", "bodyText": "Steps until this point:\n\nInit responses\nCreate handler\nAdd handler to each channel\nAwait for completion and all handlers to be done on each channel\nAll channels done processing handlers, now lets return completion with most recent status from each channel", "author": "mikechoch", "createdAt": "2020-03-20T22:48:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg1MTg4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkyNDI4Mw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/969#discussion_r395924283", "bodyText": "oooh i see, i looked it wrong, Thx!", "author": "Jeasmine", "createdAt": "2020-03-20T22:57:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg1MTg4NQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "010ccfc832f974b5a4b813459fae3ab9a534841f", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/010ccfc832f974b5a4b813459fae3ab9a534841f", "message": "PR review comment fixing\n* Small nits nothing major\n* Added more TODO comments, remove unused code, added some annotations for nullable returns on abstraction for getExternalId", "committedDate": "2020-03-20T23:01:59Z", "type": "commit"}, {"oid": "fc6c074ee3a3a01009afa38980fa0f2afb833d16", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/fc6c074ee3a3a01009afa38980fa0f2afb833d16", "message": "Remove sendTag comment from demo app", "committedDate": "2020-03-20T23:03:31Z", "type": "commit"}]}