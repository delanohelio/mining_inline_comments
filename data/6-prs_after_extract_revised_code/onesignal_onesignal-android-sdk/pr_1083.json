{"pr_number": 1083, "pr_title": "Fix/only call foreground handler while app in foreground", "pr_createdAt": "2020-07-01T21:30:59Z", "pr_url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1083", "timeline": [{"oid": "efefa66755e408baed5355ca3c66064119b15011", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/efefa66755e408baed5355ca3c66064119b15011", "message": "`NotificationWillShowInForeground` won't fire when app is in background\n* Added a unit test for testing this as well", "committedDate": "2020-07-01T21:30:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY1MzEyMw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1083#discussion_r448653123", "bodyText": "Would like to see the isInForeground() check as its own if statement so this is easier to read.", "author": "jkasten2", "createdAt": "2020-07-01T22:42:44Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignal.java", "diffHunk": "@@ -2142,7 +2142,7 @@ static void handleNotificationReceived(OSNotificationGenerationJob notifJob, boo\n     */\n    static void fireNotificationWillShowInForegroundHandlers(OSNotificationGenerationJob notifJob) {\n       // No ExtNotificationWillShowInForegroundHandler or AppNotificationWillShowInForegroundHandler was setup, show the notification\n-      if (extNotificationWillShowInForegroundHandler == null && appNotificationWillShowInForegroundHandler == null) {\n+      if (extNotificationWillShowInForegroundHandler == null && appNotificationWillShowInForegroundHandler == null || !isInForeground()) {", "originalCommit": "efefa66755e408baed5355ca3c66064119b15011", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY1NTIwOQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1083#discussion_r448655209", "bodyText": "Yeah I like that, agreed", "author": "mikechoch", "createdAt": "2020-07-01T22:49:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY1MzEyMw=="}], "type": "inlineReview", "revised_code": {"commit": "c66d8b37195ae3b54f6c79a8198569f9c679bc2c", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignal.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignal.java\nindex 832309d8..c91f7fa9 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignal.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignal.java\n\n@@ -2140,20 +2162,15 @@ public class OneSignal {\n     * TODO: Enqueue this method for the extNotificationWillShowInForegroundHandler/appNotificationWillShowInForegroundHandler\n     *    with a WorkManager Worker eventually\n     */\n-   static void fireNotificationWillShowInForegroundHandlers(OSNotificationGenerationJob notifJob) {\n-      // No ExtNotificationWillShowInForegroundHandler or AppNotificationWillShowInForegroundHandler was setup, show the notification\n-      if (extNotificationWillShowInForegroundHandler == null && appNotificationWillShowInForegroundHandler == null || !isInForeground()) {\n-         GenerateNotification.fromJsonPayload(notifJob);\n-         return;\n-      }\n-\n-      // No ExtNotificationWillShowInForegroundHandler was setup, use the AppNotificationWillShowInForegroundHandler to start\n-      if (extNotificationWillShowInForegroundHandler == null) {\n-         appNotificationWillShowInForegroundHandler.notificationWillShowInForeground(notifJob.toAppNotificationGenerationJob());\n+   static void fireForegroundHandlers(OSNotificationGenerationJob notifJob) {\n+      if (OneSignal.extNotificationWillShowInForegroundHandler == null) {\n+         OneSignal.onesignalLog(OneSignal.LOG_LEVEL.INFO, \"No extNotificationWillShowInForegroundHandler setup, fire appNotificationWillShowInForegroundHandler\");\n+         OneSignal.appNotificationWillShowInForegroundHandler.notificationWillShowInForeground(notifJob.toAppNotificationGenerationJob());\n          return;\n       }\n \n-      extNotificationWillShowInForegroundHandler.notificationWillShowInForeground(notifJob.toExtNotificationGenerationJob());\n+      OneSignal.onesignalLog(OneSignal.LOG_LEVEL.INFO, \"extNotificationWillShowInForegroundHandler and appNotificationWillShowInForegroundHandler setup, fire extNotificationWillShowInForegroundHandler\");\n+      OneSignal.extNotificationWillShowInForegroundHandler.notificationWillShowInForeground(notifJob.toExtNotificationGenerationJob());\n    }\n \n    // Called when opening a notification\n"}}, {"oid": "c66d8b37195ae3b54f6c79a8198569f9c679bc2c", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/c66d8b37195ae3b54f6c79a8198569f9c679bc2c", "message": "Broke up `fireNotificationWillShowInForegroundHandlers` method\n* Split up `fireNotificationWillShowInForegroundHandlers` into two methods\n  * `boolean shouldFireForegroundHandlers` and `void fireForegroundHandlers`\n* Refactored `ProcessJobForDisplay` to `processJobForDisplay`\n* Removed unused imports and methods\n  * `bundleAsJsonArray` and `saveAndProcessNotification`", "committedDate": "2020-07-02T22:39:37Z", "type": "commit"}, {"oid": "8087f3a36c89398da2e5c7e74f01c1e02d9bfa51", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/8087f3a36c89398da2e5c7e74f01c1e02d9bfa51", "message": "Forgot to add `AppNotificationWillShowInForegroundHandler` to unit test", "committedDate": "2020-07-02T22:45:31Z", "type": "commit"}]}