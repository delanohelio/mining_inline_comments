{"pr_number": 927, "pr_title": "Make IAM able to re display multiple times", "pr_createdAt": "2020-01-21T19:06:27Z", "pr_url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMwNzMwMQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r369307301", "bodyText": "displaysQuantity should be displayQuantity", "author": "mikechoch", "createdAt": "2020-01-21T23:56:32Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java", "diffHunk": "@@ -34,24 +43,42 @@\n     @NonNull\n     public ArrayList<ArrayList<OSTrigger>> triggers;\n \n+    //Last IAM display time in seconds\n+    private long lastDisplayTime = -1;\n+    //Current quantity of displays\n+    private int displaysQuantity = 0;", "originalCommit": "e4e1d4c461a38d4cc875e30bf7e7b9b358c74efe", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "78e25829f7f929eb61a3404c80679457d0aaf05d", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java\nindex f24c53cd..f21fc819 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java\n\n@@ -43,17 +46,23 @@ class OSInAppMessage {\n     @NonNull\n     public ArrayList<ArrayList<OSTrigger>> triggers;\n \n+    /**\n+     * IAM clicks associated to this IAM\n+     */\n+    @NonNull\n+    private Set<String> clickedClickIds;\n+\n     //Last IAM display time in seconds\n-    private long lastDisplayTime = -1;\n+    private double lastDisplayTime = -1;\n     //Current quantity of displays\n-    private int displaysQuantity = 0;\n+    private int displayQuantity = 0;\n     //Quantity of displays limit\n-    private int displaysLimit = Integer.MAX_VALUE;\n+    private int displayLimit = Integer.MAX_VALUE;\n     //Delay between displays in seconds\n-    private long delay = 0;\n+    private double displayDelay = 0;\n     private double displayDuration;\n \n-    private boolean reDisplayEnabled = false;\n+    private boolean redisplayEnabled = false;\n     private boolean actionTaken;\n     boolean isPreview;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMwNzM5NQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r369307395", "bodyText": "displaysLimit should be displayLimit", "author": "mikechoch", "createdAt": "2020-01-21T23:56:53Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java", "diffHunk": "@@ -34,24 +43,42 @@\n     @NonNull\n     public ArrayList<ArrayList<OSTrigger>> triggers;\n \n+    //Last IAM display time in seconds\n+    private long lastDisplayTime = -1;\n+    //Current quantity of displays\n+    private int displaysQuantity = 0;\n+    //Quantity of displays limit\n+    private int displaysLimit = Integer.MAX_VALUE;", "originalCommit": "e4e1d4c461a38d4cc875e30bf7e7b9b358c74efe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQyNTYxNA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r371425614", "bodyText": "Let's make display limit default to 1 since normal IAMs only show once?", "author": "mikechoch", "createdAt": "2020-01-27T19:06:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMwNzM5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI1NTE1Mg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r374255152", "bodyText": "taking https://github.com/OneSignal/engineering/pull/92/files as reference, it says that if limit is missing make it MAX_INT", "author": "Jeasmine", "createdAt": "2020-02-03T18:07:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMwNzM5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDMxNTI5Mw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r374315293", "bodyText": "@jkasten2 Did we decide to keep this MAX_INT as default?", "author": "mikechoch", "createdAt": "2020-02-03T20:10:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMwNzM5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA2MTU4NA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r381061584", "bodyText": "Yes, we can use MAX_INT incase the backend passes back a redisplay section but without any params. @mikechoch This property was moved to OSInAppMessageDisplayStats so I think this is more clear now. Marking this as resolved.", "author": "jkasten2", "createdAt": "2020-02-19T03:38:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMwNzM5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "78e25829f7f929eb61a3404c80679457d0aaf05d", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java\nindex f24c53cd..f21fc819 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java\n\n@@ -43,17 +46,23 @@ class OSInAppMessage {\n     @NonNull\n     public ArrayList<ArrayList<OSTrigger>> triggers;\n \n+    /**\n+     * IAM clicks associated to this IAM\n+     */\n+    @NonNull\n+    private Set<String> clickedClickIds;\n+\n     //Last IAM display time in seconds\n-    private long lastDisplayTime = -1;\n+    private double lastDisplayTime = -1;\n     //Current quantity of displays\n-    private int displaysQuantity = 0;\n+    private int displayQuantity = 0;\n     //Quantity of displays limit\n-    private int displaysLimit = Integer.MAX_VALUE;\n+    private int displayLimit = Integer.MAX_VALUE;\n     //Delay between displays in seconds\n-    private long delay = 0;\n+    private double displayDelay = 0;\n     private double displayDuration;\n \n-    private boolean reDisplayEnabled = false;\n+    private boolean redisplayEnabled = false;\n     private boolean actionTaken;\n     boolean isPreview;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMwODI5NQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r369308295", "bodyText": "Lets rename delay to displayDelay, so it is a little more specific", "author": "mikechoch", "createdAt": "2020-01-21T23:59:56Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java", "diffHunk": "@@ -34,24 +43,42 @@\n     @NonNull\n     public ArrayList<ArrayList<OSTrigger>> triggers;\n \n+    //Last IAM display time in seconds\n+    private long lastDisplayTime = -1;\n+    //Current quantity of displays\n+    private int displaysQuantity = 0;\n+    //Quantity of displays limit\n+    private int displaysLimit = Integer.MAX_VALUE;\n+    //Delay between displays in seconds\n+    private long delay = 0;", "originalCommit": "e4e1d4c461a38d4cc875e30bf7e7b9b358c74efe", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "78e25829f7f929eb61a3404c80679457d0aaf05d", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java\nindex f24c53cd..f21fc819 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java\n\n@@ -43,17 +46,23 @@ class OSInAppMessage {\n     @NonNull\n     public ArrayList<ArrayList<OSTrigger>> triggers;\n \n+    /**\n+     * IAM clicks associated to this IAM\n+     */\n+    @NonNull\n+    private Set<String> clickedClickIds;\n+\n     //Last IAM display time in seconds\n-    private long lastDisplayTime = -1;\n+    private double lastDisplayTime = -1;\n     //Current quantity of displays\n-    private int displaysQuantity = 0;\n+    private int displayQuantity = 0;\n     //Quantity of displays limit\n-    private int displaysLimit = Integer.MAX_VALUE;\n+    private int displayLimit = Integer.MAX_VALUE;\n     //Delay between displays in seconds\n-    private long delay = 0;\n+    private double displayDelay = 0;\n     private double displayDuration;\n \n-    private boolean reDisplayEnabled = false;\n+    private boolean redisplayEnabled = false;\n     private boolean actionTaken;\n     boolean isPreview;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMwODU2MQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r369308561", "bodyText": "reDisplayEnabled should be redisplayEnabled\nRedisplay is one word, so no capitol D", "author": "mikechoch", "createdAt": "2020-01-22T00:00:57Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java", "diffHunk": "@@ -34,24 +43,42 @@\n     @NonNull\n     public ArrayList<ArrayList<OSTrigger>> triggers;\n \n+    //Last IAM display time in seconds\n+    private long lastDisplayTime = -1;\n+    //Current quantity of displays\n+    private int displaysQuantity = 0;\n+    //Quantity of displays limit\n+    private int displaysLimit = Integer.MAX_VALUE;\n+    //Delay between displays in seconds\n+    private long delay = 0;\n     private double displayDuration;\n \n+    private boolean reDisplayEnabled = false;", "originalCommit": "e4e1d4c461a38d4cc875e30bf7e7b9b358c74efe", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "78e25829f7f929eb61a3404c80679457d0aaf05d", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java\nindex f24c53cd..f21fc819 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java\n\n@@ -43,17 +46,23 @@ class OSInAppMessage {\n     @NonNull\n     public ArrayList<ArrayList<OSTrigger>> triggers;\n \n+    /**\n+     * IAM clicks associated to this IAM\n+     */\n+    @NonNull\n+    private Set<String> clickedClickIds;\n+\n     //Last IAM display time in seconds\n-    private long lastDisplayTime = -1;\n+    private double lastDisplayTime = -1;\n     //Current quantity of displays\n-    private int displaysQuantity = 0;\n+    private int displayQuantity = 0;\n     //Quantity of displays limit\n-    private int displaysLimit = Integer.MAX_VALUE;\n+    private int displayLimit = Integer.MAX_VALUE;\n     //Delay between displays in seconds\n-    private long delay = 0;\n+    private double displayDelay = 0;\n     private double displayDuration;\n \n-    private boolean reDisplayEnabled = false;\n+    private boolean redisplayEnabled = false;\n     private boolean actionTaken;\n     boolean isPreview;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMwOTQwMw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r369309403", "bodyText": "increaseDisplayQuantity should be incrementDisplayQuantity\nincrease could be any quantity, increment means to add 1 to a current value", "author": "mikechoch", "createdAt": "2020-01-22T00:04:05Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java", "diffHunk": "@@ -137,22 +189,86 @@ boolean takeActionAsUnique() {\n         return actionTaken = true;\n     }\n \n-    public double getDisplayDuration() {\n+    double getDisplayDuration() {\n         return displayDuration;\n     }\n \n-    public void setDisplayDuration(double displayDuration) {\n+    void setDisplayDuration(double displayDuration) {\n         this.displayDuration = displayDuration;\n     }\n \n+    int getDisplaysQuantity() {\n+        return displaysQuantity;\n+    }\n+\n+    void setDisplaysQuantity(int displaysQuantity) {\n+        this.displaysQuantity = displaysQuantity;\n+    }\n+\n+    void increaseDisplayQuantity() {\n+        this.displaysQuantity++;", "originalCommit": "e4e1d4c461a38d4cc875e30bf7e7b9b358c74efe", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "78e25829f7f929eb61a3404c80679457d0aaf05d", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java\nindex f24c53cd..f21fc819 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java\n\n@@ -197,51 +208,71 @@ class OSInAppMessage {\n         this.displayDuration = displayDuration;\n     }\n \n-    int getDisplaysQuantity() {\n-        return displaysQuantity;\n+    int getDisplayQuantity() {\n+        return displayQuantity;\n     }\n \n-    void setDisplaysQuantity(int displaysQuantity) {\n-        this.displaysQuantity = displaysQuantity;\n+    void setDisplayQuantity(int displayQuantity) {\n+        this.displayQuantity = displayQuantity;\n     }\n \n-    void increaseDisplayQuantity() {\n-        this.displaysQuantity++;\n+    int getDisplayLimit() {\n+        return displayLimit;\n     }\n \n-    int getDisplaysLimit() {\n-        return displaysLimit;\n+    void incrementDisplayQuantity() {\n+        this.displayQuantity++;\n     }\n \n-    long getDelay() {\n-        return delay;\n+    double getDisplayDelay() {\n+        return displayDelay;\n     }\n \n-    long getLastDisplayTime() {\n+    double getLastDisplayTime() {\n         return lastDisplayTime;\n     }\n \n-    void setLastDisplayTime(long lastDisplayTime) {\n+    void setLastDisplayTime(double lastDisplayTime) {\n         this.lastDisplayTime = lastDisplayTime;\n     }\n \n-    boolean isReDisplayEnabled() {\n-        return reDisplayEnabled;\n+    boolean isRedisplayEnabled() {\n+        return redisplayEnabled;\n     }\n \n-    boolean isRemainingDisplays() {\n-        return displaysQuantity <= displaysLimit;\n+    boolean shouldDisplayAgain() {\n+        return displayQuantity <= displayLimit;\n     }\n \n     boolean isDelayTimeSatisfied() {\n-        if (lastDisplayTime == -1) {\n+        if (lastDisplayTime < 0) {\n             lastDisplayTime = new Date().getTime() / 1000; //Current time in seconds\n             return true;\n         }\n \n+        double currentTimeInSeconds = new Date().getTime() / 1000;\n         //Calculate gap between display times\n-        long diffInSeconds = new Date().getTime() / 1000 - lastDisplayTime;\n-        return diffInSeconds >= delay;\n+        double diffInSeconds = currentTimeInSeconds - lastDisplayTime;\n+        OneSignal.Log(OneSignal.LOG_LEVEL.DEBUG, \"OSInAppMessage lastDisplayTime: \" + lastDisplayTime +\n+                \" currentTimeInSeconds: \" + currentTimeInSeconds + \" diffInSeconds: \" + diffInSeconds + \" displayDelay: \" + displayDelay);\n+        return diffInSeconds >= displayDelay;\n+    }\n+\n+    @NonNull\n+    Set<String> getClickedClickIds() {\n+        return clickedClickIds;\n+    }\n+\n+    boolean isClickAvailable(String clickId) {\n+        return redisplayEnabled && !clickedClickIds.contains(clickId);\n+    }\n+\n+    void clearClickIds() {\n+        clickedClickIds.clear();\n+    }\n+\n+    void addClickId(String clickId) {\n+        clickedClickIds.add(clickId);\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMwOTY2Ng==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r369309666", "bodyText": "isRemainingDisplays should be shouldDisplayAgain", "author": "mikechoch", "createdAt": "2020-01-22T00:05:02Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java", "diffHunk": "@@ -137,22 +189,86 @@ boolean takeActionAsUnique() {\n         return actionTaken = true;\n     }\n \n-    public double getDisplayDuration() {\n+    double getDisplayDuration() {\n         return displayDuration;\n     }\n \n-    public void setDisplayDuration(double displayDuration) {\n+    void setDisplayDuration(double displayDuration) {\n         this.displayDuration = displayDuration;\n     }\n \n+    int getDisplaysQuantity() {\n+        return displaysQuantity;\n+    }\n+\n+    void setDisplaysQuantity(int displaysQuantity) {\n+        this.displaysQuantity = displaysQuantity;\n+    }\n+\n+    void increaseDisplayQuantity() {\n+        this.displaysQuantity++;\n+    }\n+\n+    int getDisplaysLimit() {\n+        return displaysLimit;\n+    }\n+\n+    long getDelay() {\n+        return delay;\n+    }\n+\n+    long getLastDisplayTime() {\n+        return lastDisplayTime;\n+    }\n+\n+    void setLastDisplayTime(long lastDisplayTime) {\n+        this.lastDisplayTime = lastDisplayTime;\n+    }\n+\n+    boolean isReDisplayEnabled() {\n+        return reDisplayEnabled;\n+    }\n+\n+    boolean isRemainingDisplays() {", "originalCommit": "e4e1d4c461a38d4cc875e30bf7e7b9b358c74efe", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "78e25829f7f929eb61a3404c80679457d0aaf05d", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java\nindex f24c53cd..f21fc819 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java\n\n@@ -197,51 +208,71 @@ class OSInAppMessage {\n         this.displayDuration = displayDuration;\n     }\n \n-    int getDisplaysQuantity() {\n-        return displaysQuantity;\n+    int getDisplayQuantity() {\n+        return displayQuantity;\n     }\n \n-    void setDisplaysQuantity(int displaysQuantity) {\n-        this.displaysQuantity = displaysQuantity;\n+    void setDisplayQuantity(int displayQuantity) {\n+        this.displayQuantity = displayQuantity;\n     }\n \n-    void increaseDisplayQuantity() {\n-        this.displaysQuantity++;\n+    int getDisplayLimit() {\n+        return displayLimit;\n     }\n \n-    int getDisplaysLimit() {\n-        return displaysLimit;\n+    void incrementDisplayQuantity() {\n+        this.displayQuantity++;\n     }\n \n-    long getDelay() {\n-        return delay;\n+    double getDisplayDelay() {\n+        return displayDelay;\n     }\n \n-    long getLastDisplayTime() {\n+    double getLastDisplayTime() {\n         return lastDisplayTime;\n     }\n \n-    void setLastDisplayTime(long lastDisplayTime) {\n+    void setLastDisplayTime(double lastDisplayTime) {\n         this.lastDisplayTime = lastDisplayTime;\n     }\n \n-    boolean isReDisplayEnabled() {\n-        return reDisplayEnabled;\n+    boolean isRedisplayEnabled() {\n+        return redisplayEnabled;\n     }\n \n-    boolean isRemainingDisplays() {\n-        return displaysQuantity <= displaysLimit;\n+    boolean shouldDisplayAgain() {\n+        return displayQuantity <= displayLimit;\n     }\n \n     boolean isDelayTimeSatisfied() {\n-        if (lastDisplayTime == -1) {\n+        if (lastDisplayTime < 0) {\n             lastDisplayTime = new Date().getTime() / 1000; //Current time in seconds\n             return true;\n         }\n \n+        double currentTimeInSeconds = new Date().getTime() / 1000;\n         //Calculate gap between display times\n-        long diffInSeconds = new Date().getTime() / 1000 - lastDisplayTime;\n-        return diffInSeconds >= delay;\n+        double diffInSeconds = currentTimeInSeconds - lastDisplayTime;\n+        OneSignal.Log(OneSignal.LOG_LEVEL.DEBUG, \"OSInAppMessage lastDisplayTime: \" + lastDisplayTime +\n+                \" currentTimeInSeconds: \" + currentTimeInSeconds + \" diffInSeconds: \" + diffInSeconds + \" displayDelay: \" + displayDelay);\n+        return diffInSeconds >= displayDelay;\n+    }\n+\n+    @NonNull\n+    Set<String> getClickedClickIds() {\n+        return clickedClickIds;\n+    }\n+\n+    boolean isClickAvailable(String clickId) {\n+        return redisplayEnabled && !clickedClickIds.contains(clickId);\n+    }\n+\n+    void clearClickIds() {\n+        clickedClickIds.clear();\n+    }\n+\n+    void addClickId(String clickId) {\n+        clickedClickIds.add(clickId);\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxMDUzMg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r369310532", "bodyText": "Why aren't we using the previous messages instead?", "author": "mikechoch", "createdAt": "2020-01-22T00:08:11Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -27,16 +29,20 @@\n     }};\n \n     public static final String IN_APP_MESSAGES_JSON_KEY = \"in_app_messages\";\n+    private static final String OS_SAVE_IN_APP_MESSAGE = \"OS_SAVE_IN_APP_MESSAGE\";\n \n     OSTriggerController triggerController;\n     private OSSystemConditionController systemConditionController;\n+    private OSInAppMessageRepository inAppMessageRepository;\n \n     // IAMs loaded remotely from on_session\n     //   If on_session won't be called this will be loaded from cache\n     @NonNull private ArrayList<OSInAppMessage> messages;\n     // IAMs that have had their trigger(s) evaluated to true;\n     //   This mean they have been added to the queue to display, or have already displayed\n-    @NonNull final private Set<String> triggeredMessages;\n+    @NonNull final private Set<String> dismissedAndToDismissMessages;\n+    // IAMs displayed with last displayed time and quantity of displays data\n+    @NonNull final private List<OSInAppMessage> displayedMessagesData;", "originalCommit": "e4e1d4c461a38d4cc875e30bf7e7b9b358c74efe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTcwMTAwNQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r369701005", "bodyText": "do you mean ArrayList messages?\ni think is more clear to have separate responsibilities. But i can mix the logic to whenever the message is set add the data for redisplay,  although it will trigger another for loop. We can discuss this if you want", "author": "Jeasmine", "createdAt": "2020-01-22T17:32:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxMDUzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg3MzYzMw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r370873633", "bodyText": "I am wondering why we have\n@NonNull private ArrayList<OSInAppMessage> messages;\nand\n@NonNull final private List<OSInAppMessage> displayedMessagesData;\nShouldn't we just have one list of messages that we obtain from the on_session or cached IAMs?", "author": "mikechoch", "createdAt": "2020-01-24T22:40:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxMDUzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQwNzA1OQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r371407059", "bodyText": "yeah i can mix the logics", "author": "Jeasmine", "createdAt": "2020-01-27T18:28:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxMDUzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQyMDQ0MQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r371420441", "bodyText": "I think we should have a single @NonNull private ArrayList<OSInAppMessage> messages; that contains on IAMs pulled down for the current session\nI cant tell if you are agreeing or not haha?", "author": "mikechoch", "createdAt": "2020-01-27T18:56:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxMDUzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ2MDkzMA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r371460930", "bodyText": "@mikechoch and I talked about this. Our ArrayList<OSInAppMessage> messages is a list of all IAMs from our server so we should keep this list untouched.\nTo read and write our two new properties I think we should create a new class to store them under. We can call this something like OSInAppMessageDisplayStats which will hold our displayQuantity and lastTimeDisplayed. This can still be referenced by OSInAppMessage as a property.", "author": "jkasten2", "createdAt": "2020-01-27T20:18:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxMDUzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjAwNzExOQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r372007119", "bodyText": "ok that make sense. I agree with that the message list should kept untouched.", "author": "Jeasmine", "createdAt": "2020-01-28T19:23:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxMDUzMg=="}], "type": "inlineReview", "revised_code": {"commit": "78e25829f7f929eb61a3404c80679457d0aaf05d", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\nindex f6b6a798..4e9663f8 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n\n@@ -40,7 +40,7 @@ class OSInAppMessageController implements OSDynamicTriggerControllerObserver, OS\n     @NonNull private ArrayList<OSInAppMessage> messages;\n     // IAMs that have had their trigger(s) evaluated to true;\n     //   This mean they have been added to the queue to display, or have already displayed\n-    @NonNull final private Set<String> dismissedAndToDismissMessages;\n+    @NonNull final private Set<String> dismissedMessages;\n     // IAMs displayed with last displayed time and quantity of displays data\n     @NonNull final private List<OSInAppMessage> displayedMessagesData;\n     // IAMs that have been displayed to the user\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxMDcxNA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r369310714", "bodyText": "dismissedAndToDismissMessages should be dismissedMessages, no need to over complicate the name", "author": "mikechoch", "createdAt": "2020-01-22T00:08:50Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -27,16 +29,20 @@\n     }};\n \n     public static final String IN_APP_MESSAGES_JSON_KEY = \"in_app_messages\";\n+    private static final String OS_SAVE_IN_APP_MESSAGE = \"OS_SAVE_IN_APP_MESSAGE\";\n \n     OSTriggerController triggerController;\n     private OSSystemConditionController systemConditionController;\n+    private OSInAppMessageRepository inAppMessageRepository;\n \n     // IAMs loaded remotely from on_session\n     //   If on_session won't be called this will be loaded from cache\n     @NonNull private ArrayList<OSInAppMessage> messages;\n     // IAMs that have had their trigger(s) evaluated to true;\n     //   This mean they have been added to the queue to display, or have already displayed\n-    @NonNull final private Set<String> triggeredMessages;\n+    @NonNull final private Set<String> dismissedAndToDismissMessages;", "originalCommit": "e4e1d4c461a38d4cc875e30bf7e7b9b358c74efe", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "78e25829f7f929eb61a3404c80679457d0aaf05d", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\nindex f6b6a798..4e9663f8 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n\n@@ -40,7 +40,7 @@ class OSInAppMessageController implements OSDynamicTriggerControllerObserver, OS\n     @NonNull private ArrayList<OSInAppMessage> messages;\n     // IAMs that have had their trigger(s) evaluated to true;\n     //   This mean they have been added to the queue to display, or have already displayed\n-    @NonNull final private Set<String> dismissedAndToDismissMessages;\n+    @NonNull final private Set<String> dismissedMessages;\n     // IAMs displayed with last displayed time and quantity of displays data\n     @NonNull final private List<OSInAppMessage> displayedMessagesData;\n     // IAMs that have been displayed to the user\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxMTExNA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r369311114", "bodyText": "Why is this <p> here?", "author": "mikechoch", "createdAt": "2020-01-22T00:10:22Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java", "diffHunk": "@@ -21,7 +30,7 @@\n     /**\n      * Allows in-app messages to use multiple language variants, or to have variations between\n      * different device types (ie. a different image for phones vs. tablets, etc.).\n-     *\n+     * <p>", "originalCommit": "e4e1d4c461a38d4cc875e30bf7e7b9b358c74efe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTYxMjI4MA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r369612280", "bodyText": "reformat code stuff, i will remove it", "author": "Jeasmine", "createdAt": "2020-01-22T15:02:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxMTExNA=="}], "type": "inlineReview", "revised_code": {"commit": "78e25829f7f929eb61a3404c80679457d0aaf05d", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java\nindex f24c53cd..f21fc819 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java\n\n@@ -30,7 +33,7 @@ class OSInAppMessage {\n     /**\n      * Allows in-app messages to use multiple language variants, or to have variations between\n      * different device types (ie. a different image for phones vs. tablets, etc.).\n-     * <p>\n+     *\n      * An example: {'ios' : {'en' : 'wfgkv-...', 'es' : '56ytdygd...' }}\n      */\n     @NonNull\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxMTU0NA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r369311544", "bodyText": "Pass null into here instead, if possible", "author": "mikechoch", "createdAt": "2020-01-22T00:11:56Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -51,41 +57,44 @@\n \n     @Nullable private static OSInAppMessageController sharedInstance;\n     public static OSInAppMessageController getController() {\n+        OneSignalDbHelper dbHelper = OneSignal.getDBHelperInstance();\n+\n         // Make sure only Android 4.4 devices and higher can use IAMs\n         if (Build.VERSION.SDK_INT <= Build.VERSION_CODES.JELLY_BEAN_MR2) {\n-            sharedInstance = new OSInAppMessageDummyController();\n+            sharedInstance = new OSInAppMessageDummyController(dbHelper);", "originalCommit": "e4e1d4c461a38d4cc875e30bf7e7b9b358c74efe", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "78e25829f7f929eb61a3404c80679457d0aaf05d", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\nindex f6b6a798..4e9663f8 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n\n@@ -61,7 +61,7 @@ class OSInAppMessageController implements OSDynamicTriggerControllerObserver, OS\n \n         // Make sure only Android 4.4 devices and higher can use IAMs\n         if (Build.VERSION.SDK_INT <= Build.VERSION_CODES.JELLY_BEAN_MR2) {\n-            sharedInstance = new OSInAppMessageDummyController(dbHelper);\n+            sharedInstance = new OSInAppMessageDummyController(null);\n         }\n \n         if (sharedInstance == null)\n"}}, {"oid": "78e25829f7f929eb61a3404c80679457d0aaf05d", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/78e25829f7f929eb61a3404c80679457d0aaf05d", "message": "Add click functionality for redisplay\n\n  * Make IAM track click UUI to enable multiple clicks on same IAM", "committedDate": "2020-01-27T05:51:35Z", "type": "forcePushed"}, {"oid": "0e299a3c91fbf35febf972fce65d34abb794a98f", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/0e299a3c91fbf35febf972fce65d34abb794a98f", "message": "Add click functionality for redisplay\n\n  * Make IAM track click UUI to enable multiple clicks on same IAM", "committedDate": "2020-01-27T05:58:25Z", "type": "forcePushed"}, {"oid": "2eab6f5daa346f25aefcb082de36bea951d61f3a", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/2eab6f5daa346f25aefcb082de36bea951d61f3a", "message": "Add click functionality for redisplay\n\n  * Make IAM track click UUI to enable multiple clicks on same IAM", "committedDate": "2020-01-27T16:05:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQxOTQyMw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r371419423", "bodyText": "Prefer adding curly braces if more than one line is under an if statement.", "author": "jkasten2", "createdAt": "2020-01-27T18:54:06Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java", "diffHunk": "@@ -105,8 +159,16 @@ JSONObject toJSONObject() {\n                 variants.put(key, converted);\n             }\n \n-            json.put(\"variants\", variants);\n-            json.put(\"display_duration\", this.displayDuration);\n+            json.put(IAM_VARIANTS, variants);\n+            json.put(DISPLAY_DURATION, this.displayDuration);\n+            json.put(DISPLAY_LIMIT, this.displayLimit);\n+            json.put(DISPLAY_DELAY, this.displayDelay);\n+\n+            if (redisplayEnabled)", "originalCommit": "2eab6f5daa346f25aefcb082de36bea951d61f3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDMxNTM4MA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r374315380", "bodyText": "Agree with this", "author": "mikechoch", "createdAt": "2020-02-03T20:10:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQxOTQyMw=="}], "type": "inlineReview", "revised_code": {"commit": "76d40edb26f587169ae829ad8167c30584a36679", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java\nindex f21fc819..48974094 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java\n\n@@ -161,14 +141,9 @@ class OSInAppMessage {\n \n             json.put(IAM_VARIANTS, variants);\n             json.put(DISPLAY_DURATION, this.displayDuration);\n-            json.put(DISPLAY_LIMIT, this.displayLimit);\n-            json.put(DISPLAY_DELAY, this.displayDelay);\n \n-            if (redisplayEnabled)\n-                json.put(IAM_RE_DISPLAY, new JSONObject() {{\n-                    put(DISPLAY_LIMIT, displayLimit);\n-                    put(DISPLAY_DELAY, displayDelay);\n-                }});\n+            if (displayStats.isRedisplayEnabled())\n+                json.put(IAM_RE_DISPLAY, displayStats.toJSONObject());\n \n             JSONArray orConditions = new JSONArray();\n             for (ArrayList<OSTrigger> andArray : this.triggers) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQyOTE4Mw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r371429183", "bodyText": "This if would never be true as we new up a OSInAppMessageDummyController instead for per 4.4 devices.", "author": "jkasten2", "createdAt": "2020-01-27T19:13:50Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -94,6 +102,14 @@ protected OSInAppMessageController() {\n         );\n         if (tempClickedMessageIdsSet != null)\n             clickedClickIds.addAll(tempClickedMessageIdsSet);\n+\n+        if (Build.VERSION.SDK_INT <= Build.VERSION_CODES.JELLY_BEAN_MR2) {", "originalCommit": "2eab6f5daa346f25aefcb082de36bea951d61f3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjAwNzUxMA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r372007510", "bodyText": "true! i added this for some test case, but i will check", "author": "Jeasmine", "createdAt": "2020-01-28T19:24:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQyOTE4Mw=="}], "type": "inlineReview", "revised_code": {"commit": "76d40edb26f587169ae829ad8167c30584a36679", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\nindex 83708499..c72d9359 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n\n@@ -103,12 +103,13 @@ class OSInAppMessageController implements OSDynamicTriggerControllerObserver, OS\n         if (tempClickedMessageIdsSet != null)\n             clickedClickIds.addAll(tempClickedMessageIdsSet);\n \n-        if (Build.VERSION.SDK_INT <= Build.VERSION_CODES.JELLY_BEAN_MR2) {\n-            displayedMessagesData = new ArrayList<>();\n-        } else {\n-            inAppMessageRepository = new OSInAppMessageRepository(dbInstance);\n-            displayedMessagesData = inAppMessageRepository.getAllInAppMessages();\n-        }\n+        initRedisplayData(dbInstance);\n+    }\n+\n+    void initRedisplayData(OneSignalDbHelper dbInstance) {\n+        inAppMessageRepository = new OSInAppMessageRepository(dbInstance);\n+        displayedMessagesData = inAppMessageRepository.getAllInAppMessages();\n+\n         OneSignal.Log(OneSignal.LOG_LEVEL.DEBUG, \"displayedMessagesData: \" + displayedMessagesData.toString());\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQzMDE5OA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r371430198", "bodyText": "nit, remove space after (", "author": "jkasten2", "createdAt": "2020-01-27T19:15:52Z", "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/InAppMessagingUnitTests.java", "diffHunk": "@@ -153,6 +157,97 @@ public void testBuiltMessageVariants() {\n         assertEquals(message.variants.get(\"android\").get(\"en\"), InAppMessagingHelpers.TEST_ENGLISH_ANDROID_VARIANT_ID);\n     }\n \n+    @Test\n+    public void testBuiltMessageReDisplay() throws JSONException {\n+        OSTestInAppMessage message = InAppMessagingHelpers.buildTestMessageWitRedisplay(\n+                LIMIT,\n+                DELAY\n+        );\n+        assertTrue(message.isRedisplayEnabled());\n+        assertEquals(LIMIT, message.getDisplayLimit());\n+        assertEquals(DELAY, message.getDisplayDelay());\n+        assertEquals(-1.0, message.getLastDisplayTime());\n+        assertEquals(0, message.getDisplayQuantity());\n+\n+        OSTestInAppMessage messageWithoutDisplay = InAppMessagingHelpers.buildTestMessageWithSingleTrigger(\n+                OSTriggerKind.SESSION_TIME,\n+                null,\n+                OSTriggerOperator.GREATER_THAN_OR_EQUAL_TO.toString(),\n+                3\n+        );\n+        assertFalse(messageWithoutDisplay.isRedisplayEnabled());\n+        assertEquals(Integer.MAX_VALUE, messageWithoutDisplay.getDisplayLimit());\n+        assertEquals(0.0, messageWithoutDisplay.getDisplayDelay());\n+        assertEquals(-1.0, messageWithoutDisplay.getLastDisplayTime());\n+        assertEquals(0, messageWithoutDisplay.getDisplayQuantity());\n+    }\n+\n+    @Test\n+    public void testBuiltMessageRedisplayLimit() throws JSONException {\n+        OSTestInAppMessage message = InAppMessagingHelpers.buildTestMessageWitRedisplay(\n+                LIMIT,\n+                DELAY\n+        );\n+\n+        for (int i = 0; i < LIMIT; i++) {\n+            assertTrue( message.shouldDisplayAgain());", "originalCommit": "2eab6f5daa346f25aefcb082de36bea951d61f3a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "76d40edb26f587169ae829ad8167c30584a36679", "chunk": "diff --git a/OneSignalSDK/unittest/src/test/java/com/test/onesignal/InAppMessagingUnitTests.java b/OneSignalSDK/unittest/src/test/java/com/test/onesignal/InAppMessagingUnitTests.java\nindex ca16c844..51ed8fa7 100644\n--- a/OneSignalSDK/unittest/src/test/java/com/test/onesignal/InAppMessagingUnitTests.java\n+++ b/OneSignalSDK/unittest/src/test/java/com/test/onesignal/InAppMessagingUnitTests.java\n\n@@ -163,11 +163,11 @@ public class InAppMessagingUnitTests {\n                 LIMIT,\n                 DELAY\n         );\n-        assertTrue(message.isRedisplayEnabled());\n-        assertEquals(LIMIT, message.getDisplayLimit());\n-        assertEquals(DELAY, message.getDisplayDelay());\n-        assertEquals(-1.0, message.getLastDisplayTime());\n-        assertEquals(0, message.getDisplayQuantity());\n+        assertTrue(message.getDisplayStats().isRedisplayEnabled());\n+        assertEquals(LIMIT, message.getDisplayStats().getDisplayLimit());\n+        assertEquals(DELAY, message.getDisplayStats().getDisplayDelay());\n+        assertEquals(-1.0, message.getDisplayStats().getLastDisplayTime());\n+        assertEquals(0, message.getDisplayStats().getDisplayQuantity());\n \n         OSTestInAppMessage messageWithoutDisplay = InAppMessagingHelpers.buildTestMessageWithSingleTrigger(\n                 OSTriggerKind.SESSION_TIME,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQzNjIwNg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r371436206", "bodyText": "Here we need to add a check to only re-display if a trigger was updated that is in this IAM's trigger set.\nThis prevents the IAM from reshowing over and over until it hits it's display limit since evaluateInAppMessages is called each time an IAM is dismissed.", "author": "jkasten2", "createdAt": "2020-01-27T19:27:41Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -303,17 +323,48 @@ void onFailure(int statusCode, String response, Throwable throwable) {\n         }\n     }\n \n+    /**\n+     * In order to an IAM to be re display, two condition need to be satisfied\n+     *  - Gap between displays\n+     *  - Quantity of displays\n+     *\n+     * For re display, the message need to be removed from the arrays that track the display\n+     * */\n+    private void setDataForReDisplay(OSInAppMessage message) {\n+        if (!message.isRedisplayEnabled())\n+            return;\n+\n+        int index = displayedMessagesData.indexOf(message);\n+        if (index != -1) {\n+            OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"setDataForReDisplay: \" + message.messageId);\n+\n+            OSInAppMessage savedIAM = displayedMessagesData.get(index);\n+            message.setLastDisplayTime(savedIAM.getLastDisplayTime());\n+            message.setDisplayQuantity(savedIAM.getDisplayQuantity());\n+\n+            if (message.isDelayTimeSatisfied() && message.shouldDisplayAgain()) {", "originalCommit": "2eab6f5daa346f25aefcb082de36bea951d61f3a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "76d40edb26f587169ae829ad8167c30584a36679", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\nindex 83708499..c72d9359 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n\n@@ -331,7 +333,7 @@ class OSInAppMessageController implements OSDynamicTriggerControllerObserver, OS\n      * For re display, the message need to be removed from the arrays that track the display\n      * */\n     private void setDataForReDisplay(OSInAppMessage message) {\n-        if (!message.isRedisplayEnabled())\n+        if (!message.getDisplayStats().isRedisplayEnabled())\n             return;\n \n         int index = displayedMessagesData.indexOf(message);\n"}}, {"oid": "76d40edb26f587169ae829ad8167c30584a36679", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/76d40edb26f587169ae829ad8167c30584a36679", "message": "Add OSInAppMessageDisplayStats stats and trigger validation\n\n  * Only IAM that have their triggers changed and can redisplay may redisplay", "committedDate": "2020-01-29T21:22:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIzMTM1MQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r373231351", "bodyText": "ReDisplay should be Redisplay", "author": "mikechoch", "createdAt": "2020-01-30T22:36:26Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -303,17 +325,47 @@ void onFailure(int statusCode, String response, Throwable throwable) {\n         }\n     }\n \n+    /**\n+     * In order to an IAM to be re display, two condition need to be satisfied\n+     *  - Gap between displays\n+     *  - Quantity of displays\n+     *\n+     * For re display, the message need to be removed from the arrays that track the display\n+     * */\n+    private void setDataForReDisplay(OSInAppMessage message) {", "originalCommit": "76d40edb26f587169ae829ad8167c30584a36679", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b066d9fd76845dfe82be5048aea6abc774e1254b", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\nindex c72d9359..2250fc6c 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n\n@@ -332,13 +332,13 @@ class OSInAppMessageController implements OSDynamicTriggerControllerObserver, OS\n      *\n      * For re display, the message need to be removed from the arrays that track the display\n      * */\n-    private void setDataForReDisplay(OSInAppMessage message) {\n+    private void setDataForRedisplay(OSInAppMessage message) {\n         if (!message.getDisplayStats().isRedisplayEnabled())\n             return;\n \n         int index = displayedMessagesData.indexOf(message);\n         if (index != -1) {\n-            OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"setDataForReDisplay: \" + message.messageId);\n+            OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"setDataForRedisplay: \" + message.messageId);\n \n             OSInAppMessage savedIAM = displayedMessagesData.get(index);\n             message.getDisplayStats().setDisplayStats(savedIAM.getDisplayStats());\n"}}, {"oid": "b066d9fd76845dfe82be5048aea6abc774e1254b", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/b066d9fd76845dfe82be5048aea6abc774e1254b", "message": "Rename to redisplay", "committedDate": "2020-02-03T18:09:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY5NjYyOA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r372696628", "bodyText": "We need to also call checkTriggerChanges() in removeTriggersForKeys as well, as they could have a condition to display on trigger does not exists.", "author": "jkasten2", "createdAt": "2020-01-29T23:59:36Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -553,6 +587,7 @@ public void messageTriggerConditionChanged() {\n      */\n     void addTriggers(Map<String, Object> newTriggers) {\n         triggerController.addTriggers(newTriggers);\n+        checkTriggerChanges(newTriggers);", "originalCommit": "76d40edb26f587169ae829ad8167c30584a36679", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgxMTYyMw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r374811623", "bodyText": "ok, i had doubts about this", "author": "Jeasmine", "createdAt": "2020-02-04T17:22:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY5NjYyOA=="}], "type": "inlineReview", "revised_code": {"commit": "f022bf8858aabf177ae7dd7c46aa4e6f62dd363d", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\nindex c72d9359..6721d82e 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n\n@@ -587,12 +578,13 @@ class OSInAppMessageController implements OSDynamicTriggerControllerObserver, OS\n      */\n     void addTriggers(Map<String, Object> newTriggers) {\n         triggerController.addTriggers(newTriggers);\n-        checkTriggerChanges(newTriggers);\n+        checkTriggerChanged(newTriggers.keySet());\n         evaluateInAppMessages();\n     }\n \n     void removeTriggersForKeys(Collection<String> keys) {\n         triggerController.removeTriggersForKeys(keys);\n+        checkTriggerChanged(keys);\n         evaluateInAppMessages();\n     }\n \n"}}, {"oid": "f022bf8858aabf177ae7dd7c46aa4e6f62dd363d", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/f022bf8858aabf177ae7dd7c46aa4e6f62dd363d", "message": "Improve code", "committedDate": "2020-02-04T17:23:53Z", "type": "forcePushed"}, {"oid": "69d6475284b5a1adb63571e7f99f04166e75d364", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/69d6475284b5a1adb63571e7f99f04166e75d364", "message": "Improve code", "committedDate": "2020-02-04T17:24:47Z", "type": "forcePushed"}, {"oid": "33954ef0cd1a80b625526574ed3de498ce95058b", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/33954ef0cd1a80b625526574ed3de498ce95058b", "message": "Add TimeTravel to testing\n\n  * Remove thread sleep\n  * Add Date generator to mock new date times for delays\n  * Add remove trigger test", "committedDate": "2020-02-10T06:54:39Z", "type": "forcePushed"}, {"oid": "d29f7eb76a212cf016163fd9970a1f08de5af6d0", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/d29f7eb76a212cf016163fd9970a1f08de5af6d0", "message": "Add TimeTravel to testing\n\n  * Remove thread sleep\n  * Add Date generator to mock new date times for delays\n  * Add remove trigger test", "committedDate": "2020-02-10T06:57:45Z", "type": "forcePushed"}, {"oid": "3ebe8352de384a3a02970dc2b519a9f692d97cd4", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/3ebe8352de384a3a02970dc2b519a9f692d97cd4", "message": "Add TimeTravel to testing\n\n  * Remove thread sleep\n  * Add Date generator to mock new date times for delays\n  * Add remove trigger test", "committedDate": "2020-02-11T19:11:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA2MDAxNA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r381060014", "bodyText": "We can clean up this DateGenerator by using  System.currentTimeMillis()  instead.  This way we can use advanceSystemTimeBy in our tests for mocking time.", "author": "jkasten2", "createdAt": "2020-02-19T03:31:07Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -94,6 +106,22 @@ protected OSInAppMessageController() {\n         );\n         if (tempClickedMessageIdsSet != null)\n             clickedClickIds.addAll(tempClickedMessageIdsSet);\n+\n+        initRedisplayData(dbInstance);\n+    }\n+\n+    /*\n+    * For testing purposes\n+    * */\n+    public DateGenerator getDateGenerator() {", "originalCommit": "3ebe8352de384a3a02970dc2b519a9f692d97cd4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU4OTExNQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r381589115", "bodyText": "oh men, why i didn't see this", "author": "Jeasmine", "createdAt": "2020-02-19T22:41:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA2MDAxNA=="}], "type": "inlineReview", "revised_code": {"commit": "353f5635f7df1dd7394f953c27e5ac0b964ee4e6", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\nindex 5e594f9a..58cbdd16 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n\n@@ -110,13 +108,6 @@ class OSInAppMessageController implements OSDynamicTriggerControllerObserver, OS\n         initRedisplayData(dbInstance);\n     }\n \n-    /*\n-    * For testing purposes\n-    * */\n-    public DateGenerator getDateGenerator() {\n-        return dateGenerator;\n-    }\n-\n     void initRedisplayData(OneSignalDbHelper dbInstance) {\n         inAppMessageRepository = new OSInAppMessageRepository(dbInstance);\n         displayedMessagesData = inAppMessageRepository.getAllInAppMessages();\n"}}, {"oid": "353f5635f7df1dd7394f953c27e5ac0b964ee4e6", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/353f5635f7df1dd7394f953c27e5ac0b964ee4e6", "message": "Add TimeTravel to testing\n\n  * Remove thread sleep\n  * Add Date generator to mock new date times for delays\n  * Add remove trigger test", "committedDate": "2020-02-20T02:41:57Z", "type": "forcePushed"}, {"oid": "478c14eeb0d8208a8308a0b479f674fca25851b5", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/478c14eeb0d8208a8308a0b479f674fca25851b5", "message": "Add TimeTravel to testing\n\n  * Remove thread sleep\n  * Add Date generator to mock new date times for delays\n  * Add remove trigger test", "committedDate": "2020-02-20T03:16:59Z", "type": "forcePushed"}, {"oid": "a67cf61aff0f6f39acf1263ae8d90eec2b1ed831", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/a67cf61aff0f6f39acf1263ae8d90eec2b1ed831", "message": "Display once per session IAM with redisplay\n\n   * Add no trigger check, display once per session\n   * Add displayed param to IAM\n   * Add test for cold start and init OneSignal", "committedDate": "2020-02-27T23:28:10Z", "type": "forcePushed"}, {"oid": "b32a9fc3edea311f55d422ce1732e36c7fde56f6", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/b32a9fc3edea311f55d422ce1732e36c7fde56f6", "message": "Make IAM able to re display multiple times\n\n  * Changes on OSInAppMessage class, add two new params delay and limit\n  * Make OSInAppMessageController handle the multiple re displays\n  * Save on local database quantity of displays and last display time per IAM\n  * Add unit test for new functionality", "committedDate": "2020-02-28T00:35:32Z", "type": "commit"}, {"oid": "725ead7ca221c2e196871cdb1fb398b10292ec41", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/725ead7ca221c2e196871cdb1fb398b10292ec41", "message": "Remove IAM from db\n\n  * Remove IAMs with redisplay from DB when lastDisplay is\n    older than six month", "committedDate": "2020-02-28T00:40:55Z", "type": "commit"}, {"oid": "fc48c25dcb454e5e9c7cedeb8c41f1b599717969", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/fc48c25dcb454e5e9c7cedeb8c41f1b599717969", "message": "Display once per session IAM with redisplay\n\n   * Add no trigger check, display once per session\n   * Add displayed param to IAM\n   * Add test for cold start and init OneSignal", "committedDate": "2020-02-28T00:44:28Z", "type": "commit"}, {"oid": "4a35ed0f8d4c9dfeb7b41220ae0f7fc94d4d9a8e", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/4a35ed0f8d4c9dfeb7b41220ae0f7fc94d4d9a8e", "message": "Improve code after rebasing\n\n  * Remove IAMController Shadow from testing\n  * Changes parts of IAMSController", "committedDate": "2020-02-28T18:50:18Z", "type": "forcePushed"}, {"oid": "3413fd7edc3e50fe8f5dfbca0f5f18841f116105", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/3413fd7edc3e50fe8f5dfbca0f5f18841f116105", "message": "Improve code after rebasing\n\n  * Remove IAMController Shadow from testing\n  * Changes parts of IAMSController", "committedDate": "2020-02-28T18:54:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkwMjIyNg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r385902226", "bodyText": "Change dbInstance to dbHelper, most of our codebase is dbHelper", "author": "mikechoch", "createdAt": "2020-02-28T20:15:23Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -110,7 +110,7 @@ protected OSInAppMessageController(OneSignalDbHelper dbInstance) {\n         initRedisplayData(dbInstance);\n     }\n \n-    void initRedisplayData(OneSignalDbHelper dbInstance) {\n+    protected void initRedisplayData(OneSignalDbHelper dbInstance) {", "originalCommit": "3413fd7edc3e50fe8f5dfbca0f5f18841f116105", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "aa466764f9636ad993652100d5b3518a91c859af", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\nindex 6cdcecf6..b77d2f77 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n\n@@ -107,11 +107,11 @@ class OSInAppMessageController implements OSDynamicTriggerControllerObserver, OS\n         if (tempClickedMessageIdsSet != null)\n             clickedClickIds.addAll(tempClickedMessageIdsSet);\n \n-        initRedisplayData(dbInstance);\n+        initRedisplayData(dbHelper);\n     }\n \n-    protected void initRedisplayData(OneSignalDbHelper dbInstance) {\n-        inAppMessageRepository = new OSInAppMessageRepository(dbInstance);\n+    protected void initRedisplayData(OneSignalDbHelper dbHelper) {\n+        inAppMessageRepository = new OSInAppMessageRepository(dbHelper);\n         redisplayedInAppMessages = inAppMessageRepository.getRedisplayedInAppMessages();\n \n         OneSignal.Log(OneSignal.LOG_LEVEL.DEBUG, \"redisplayedInAppMessages: \" + redisplayedInAppMessages.toString());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkwMzU2Ng==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r385903566", "bodyText": "Using contains with an oObject is dangerous. This could be true or false and not represent the String messageId, this should be changed back", "author": "mikechoch", "createdAt": "2020-02-28T20:18:34Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -402,7 +402,7 @@ private void setDataForRedisplay(OSInAppMessage message) {\n     private void queueMessageForDisplay(@NonNull OSInAppMessage message) {\n         synchronized (messageDisplayQueue) {\n             // Make sure no message is ever added to the queue more than once\n-            if (!isInAppMessageQueued(message)) {", "originalCommit": "3413fd7edc3e50fe8f5dfbca0f5f18841f116105", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkwNjc5Mw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r385906793", "bodyText": "Yeah agree, thas why i have the equals and hash overriden", "author": "Jeasmine", "createdAt": "2020-02-28T20:26:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkwMzU2Ng=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkwMzc2NQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r385903765", "bodyText": "Nice clean up!", "author": "mikechoch", "createdAt": "2020-02-28T20:19:02Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -467,8 +456,7 @@ void messageWasDismissed(@NonNull OSInAppMessage message) {\n     private void dismissCurrentMessage() {\n         synchronized (messageDisplayQueue) {\n             if (messageDisplayQueue.size() > 0) {\n-                String removedMessageId = messageDisplayQueue.get(0).messageId;\n-                messageDisplayQueue.remove(0);\n+                String removedMessageId = messageDisplayQueue.remove(0).messageId;", "originalCommit": "3413fd7edc3e50fe8f5dfbca0f5f18841f116105", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "aa466764f9636ad993652100d5b3518a91c859af", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/aa466764f9636ad993652100d5b3518a91c859af", "message": "Improve code after rebasing\n\n  * Remove IAMController Shadow from testing\n  * Changes parts of IAMSController", "committedDate": "2020-02-28T20:27:09Z", "type": "commit"}, {"oid": "aa466764f9636ad993652100d5b3518a91c859af", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/aa466764f9636ad993652100d5b3518a91c859af", "message": "Improve code after rebasing\n\n  * Remove IAMController Shadow from testing\n  * Changes parts of IAMSController", "committedDate": "2020-02-28T20:27:09Z", "type": "forcePushed"}]}