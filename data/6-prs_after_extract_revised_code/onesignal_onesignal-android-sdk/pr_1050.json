{"pr_number": 1050, "pr_title": "Adding 2 layers of control to prevent locks in SQL DB and minor clean up", "pr_createdAt": "2020-06-09T18:14:46Z", "pr_url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1050", "timeline": [{"oid": "76f1fc66ecbbe329a4c28470b375cd5210c20669", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/76f1fc66ecbbe329a4c28470b375cd5210c20669", "message": "Adding 2 layers of SQL DB security and minor clean up\n* Removed the commented `enableWriteAheadLogging`\n  * No need for this as this allows concurrent read and writes to occur and we would rather pause a read while a write occurs\n  * Pausing will ensure that we are querying the most updated data\n* 2 layers of security for SQL DB regarding `OSInAppMessageRepository.java`\n  * First one will be transactions using `beginTransaction`, `setTransactionSuccessful`, and `endTransaction` methods wherever we `insert`, `delete`, or `update`\n  * Second one is keeping TABLE manipulation or reading within the same file and setting these methods as synchronized so that any other TABLE touching that occurs won't happen till any current methods are complete\n  * The combination of the two steps should help prevent any conflicts between SQL DB and solve the locking issues\n\n* WIP - Making sure any DB reading and writing is from the same file so `synchronized` along with transactions provide this 2 layer security around our single SQL DB instance", "committedDate": "2020-06-09T18:14:08Z", "type": "commit"}, {"oid": "8c9d3dc694f91bbdaa7bb2c1d8c87fd21a7342c8", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/8c9d3dc694f91bbdaa7bb2c1d8c87fd21a7342c8", "message": "Forgot to change `Throwable` to `SQLException` instead\n* Fixed within `OSInAppMessageRepository.java`", "committedDate": "2020-06-09T18:22:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYzODk0OQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1050#discussion_r437638949", "bodyText": "maybe move it to the IAM Repository file?", "author": "Jeasmine", "createdAt": "2020-06-09T18:37:16Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalCacheCleaner.java", "diffHunk": "@@ -1,24 +1,19 @@\n package com.onesignal;\n \n-import com.onesignal.OneSignalDbContract.NotificationTable;\n-import com.onesignal.influence.model.OSInfluenceChannel;\n-import com.onesignal.outcomes.OSOutcomeTableProvider;\n-\n import android.content.Context;\n-import android.database.Cursor;\n+import android.database.SQLException;\n import android.database.sqlite.SQLiteDatabase;\n import android.os.Process;\n import android.support.annotation.WorkerThread;\n \n-import org.json.JSONArray;\n-import org.json.JSONException;\n-\n-import java.util.Set;\n+import com.onesignal.OneSignalDbContract.NotificationTable;\n+import com.onesignal.influence.model.OSInfluenceChannel;\n+import com.onesignal.outcomes.OSOutcomeTableProvider;\n \n class OneSignalCacheCleaner {\n \n     private final static long NOTIFICATION_CACHE_DATA_LIFETIME = 604_800L; // 7 days in seconds\n-    private final static long IAM_CACHE_DATA_LIFETIME = 15_552_000L; // 6 months in seconds\n+    final static long IAM_CACHE_DATA_LIFETIME = 15_552_000L; // 6 months in seconds", "originalCommit": "8c9d3dc694f91bbdaa7bb2c1d8c87fd21a7342c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM2NjUyMw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1050#discussion_r438366523", "bodyText": "IAM Repository file is responsible for the SQL calls, but do you think we should keep our cache clean times together or split them up?\nI just think its easier to read when we keep the notification time and IAM time in one spot and others will be added here as well.\nMaybe you have another point of view?", "author": "mikechoch", "createdAt": "2020-06-10T19:43:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYzODk0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQxNTU3NA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1050#discussion_r438415574", "bodyText": "I see what you are saying, I think more about IAM responsibility inside one file, all notification responsibility in another file, even if this file is cleaning all tables, from my point of view each file has the responsibility to maintain the table thas is responsible for.\nSo in this case IamRepository will handle save, deletes, cleaning.", "author": "Jeasmine", "createdAt": "2020-06-10T21:22:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYzODk0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUwOTg3OA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1050#discussion_r438509878", "bodyText": "Moved to IAM Repository file", "author": "mikechoch", "createdAt": "2020-06-11T02:35:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYzODk0OQ=="}], "type": "inlineReview", "revised_code": {"commit": "2feac9dbb75de8777357e462c1ef60629ce57130", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalCacheCleaner.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalCacheCleaner.java\nindex 1627e14c..fd4f74ea 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalCacheCleaner.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalCacheCleaner.java\n\n@@ -12,8 +12,7 @@ import com.onesignal.outcomes.OSOutcomeTableProvider;\n \n class OneSignalCacheCleaner {\n \n-    private final static long NOTIFICATION_CACHE_DATA_LIFETIME = 604_800L; // 7 days in seconds\n-    final static long IAM_CACHE_DATA_LIFETIME = 15_552_000L; // 6 months in seconds\n+    private final static long NOTIFICATION_CACHE_DATA_LIFETIME = 604_800L; // 7 days in second\n \n     private final static String OS_DELETE_CACHED_NOTIFICATIONS_THREAD = \"OS_DELETE_CACHED_NOTIFICATIONS_THREAD\";\n     private final static String OS_DELETE_CACHED_REDISPLAYED_IAMS_THREAD = \"OS_DELETE_CACHED_REDISPLAYED_IAMS_THREAD\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYzOTQ2Mg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1050#discussion_r437639462", "bodyText": "maybe access it throw OneSignal.java? or add it to the method params? because there should be already a repository instance alive if we have more that one instance then te synchronized won't work", "author": "Jeasmine", "createdAt": "2020-06-09T18:38:13Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalCacheCleaner.java", "diffHunk": "@@ -61,73 +66,13 @@ public void run() {\n      * 3. Use queried data to clean SharedPreferences\n      */\n     @WorkerThread\n-    synchronized static void cleanCachedInAppMessages(final SQLiteDatabase writableDb) {\n+    synchronized static void cleanCachedInAppMessages(final OneSignalDbHelper dbHelper) {\n         new Thread(new Runnable() {\n             @Override\n             public void run() {\n                 Thread.currentThread().setPriority(Process.THREAD_PRIORITY_BACKGROUND);\n-\n-                // 1. Query for all old message ids and old clicked click ids\n-                String[] retColumns = new String[]{\n-                        OneSignalDbContract.InAppMessageTable.COLUMN_NAME_MESSAGE_ID,\n-                        OneSignalDbContract.InAppMessageTable.COLUMN_CLICK_IDS\n-                };\n-\n-                String whereStr = OneSignalDbContract.InAppMessageTable.COLUMN_NAME_LAST_DISPLAY + \" < ?\";\n-\n-                String sixMonthsAgoInSeconds = String.valueOf((System.currentTimeMillis() / 1_000L) - IAM_CACHE_DATA_LIFETIME);\n-                String[] whereArgs = new String[]{sixMonthsAgoInSeconds};\n-\n-                Set<String> oldMessageIds = OSUtils.newConcurrentSet();\n-                Set<String> oldClickedClickIds = OSUtils.newConcurrentSet();\n-\n-                Cursor cursor = null;\n-                try {\n-                    cursor = writableDb.query(OneSignalDbContract.InAppMessageTable.TABLE_NAME,\n-                            retColumns,\n-                            whereStr,\n-                            whereArgs,\n-                            null,\n-                            null,\n-                            null);\n-\n-                    if (cursor == null || cursor.getCount() == 0) {\n-                        OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Attempted to clean 6 month old IAM data, but none exists!\");\n-                        return;\n-                    }\n-\n-                    // From cursor get all of the old message ids and old clicked click ids\n-                    if (cursor.moveToFirst()) {\n-                        do {\n-                            String oldMessageId = cursor.getString(\n-                                    cursor.getColumnIndex(\n-                                            OneSignalDbContract.InAppMessageTable.COLUMN_NAME_MESSAGE_ID));\n-                            String oldClickIds = cursor.getString(\n-                                    cursor.getColumnIndex(\n-                                            OneSignalDbContract.InAppMessageTable.COLUMN_CLICK_IDS));\n-\n-                            oldMessageIds.add(oldMessageId);\n-                            oldClickedClickIds.addAll(OSUtils.newStringSetFromJSONArray(new JSONArray(oldClickIds)));\n-                        } while (cursor.moveToNext());\n-                    }\n-                } catch (JSONException e) {\n-                    e.printStackTrace();\n-                } finally {\n-                    if (cursor != null && !cursor.isClosed())\n-                        cursor.close();\n-                }\n-\n-                // 2. Delete old IAMs from SQL\n-                writableDb.delete(\n-                        OneSignalDbContract.InAppMessageTable.TABLE_NAME,\n-                        whereStr,\n-                        whereArgs);\n-\n-                // 3. Use queried data to clean SharedPreferences\n-                cleanInAppMessageIds(oldMessageIds);\n-                cleanInAppMessageClickedClickIds(oldClickedClickIds);\n+                new OSInAppMessageRepository(dbHelper).cleanCachedInAppMessages();", "originalCommit": "8c9d3dc694f91bbdaa7bb2c1d8c87fd21a7342c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM2Njc1Ng==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1050#discussion_r438366756", "bodyText": "Really good point, will do that now!", "author": "mikechoch", "createdAt": "2020-06-10T19:44:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYzOTQ2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "bbabeabb9e8b63fb2ed94cc0e85e7bd19215e218", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalCacheCleaner.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalCacheCleaner.java\nindex 1627e14c..858af238 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalCacheCleaner.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalCacheCleaner.java\n\n@@ -71,7 +71,11 @@ class OneSignalCacheCleaner {\n             @Override\n             public void run() {\n                 Thread.currentThread().setPriority(Process.THREAD_PRIORITY_BACKGROUND);\n-                new OSInAppMessageRepository(dbHelper).cleanCachedInAppMessages();\n+\n+                OSInAppMessageRepository inAppMessageRepository = OSInAppMessageController\n+                        .getController()\n+                        .getInAppMessageRepository(dbHelper);\n+                inAppMessageRepository.cleanCachedInAppMessages();\n             }\n         }, OS_DELETE_CACHED_REDISPLAYED_IAMS_THREAD).start();\n     }\n"}}, {"oid": "bbabeabb9e8b63fb2ed94cc0e85e7bd19215e218", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/bbabeabb9e8b63fb2ed94cc0e85e7bd19215e218", "message": "Using singleton `OSInAppMessageController.java` instead of new\n* Created singleton based `getInAppMessageRepository` method inside of `OSInAppMessageController.java` class\n* This allows the synchronized to apply to multiple methods being called from the class instance\n* Deleted unused thread name since new Thread was moved toi cache cleaning file with different thread name now", "committedDate": "2020-06-10T20:53:44Z", "type": "commit"}, {"oid": "df4ce782a8fb511c6d68134bb27b6af29181bd4b", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/df4ce782a8fb511c6d68134bb27b6af29181bd4b", "message": "Needed to change defaults again for `getStringSet`\n* `OneSignalCacheCleaner.java` was rearranged a bit and it caused conflicts\n* `OSInAppMessageRepository.java` now has those correct changes an the default was flipped `OSUtils.<String>newConcurrentSet()` to `null`", "committedDate": "2020-06-10T20:56:45Z", "type": "commit"}, {"oid": "53c86e58f11fb14a244e4239f072f1fc65c40a97", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/53c86e58f11fb14a244e4239f072f1fc65c40a97", "message": "Merge branch 'master' into fix/sql_db_lock_added_more_transactions", "committedDate": "2020-06-10T20:57:27Z", "type": "commit"}, {"oid": "27d22f1e956e0a36c2c38581c02fbc796a404cd2", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/27d22f1e956e0a36c2c38581c02fbc796a404cd2", "message": "Reverted to new instance within `initRedisplayData`\n* Changed the `new OSInAppMessageRepository(dbHelper);` to `getInAppMessageRepository(dbHelper);` and it broke a UnitTest in Travis", "committedDate": "2020-06-10T21:34:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQyNDQ5Ng==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1050#discussion_r438424496", "bodyText": "Tests are failing after this commit.\nIf you add OSInAppMessageRepository to StaticResetHelper.java I think it might fix the tests.", "author": "jkasten2", "createdAt": "2020-06-10T21:41:54Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -122,8 +121,15 @@ protected OSInAppMessageController(OneSignalDbHelper dbHelper) {\n         initRedisplayData(dbHelper);\n     }\n \n+    OSInAppMessageRepository getInAppMessageRepository(OneSignalDbHelper dbHelper) {", "originalCommit": "bbabeabb9e8b63fb2ed94cc0e85e7bd19215e218", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQzNDg5Ng==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1050#discussion_r438434896", "bodyText": "Thank you, attempting this now\nWeird thing is everything passes locally", "author": "mikechoch", "createdAt": "2020-06-10T22:08:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQyNDQ5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQzOTEyMQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1050#discussion_r438439121", "bodyText": "You are implying I should add a line like this\nclasses.add(new ClassState(OSInAppMessageRepository.class, null));\ninside the\nStaticResetHelper.java?", "author": "mikechoch", "createdAt": "2020-06-10T22:19:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQyNDQ5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ0MDIzNg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1050#discussion_r438440236", "bodyText": "yes, that might fix the tests", "author": "jkasten2", "createdAt": "2020-06-10T22:22:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQyNDQ5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ2MTY3OQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1050#discussion_r438461679", "bodyText": "Wasn't the issue, test is flaky on it's own. Nothing in this PR would have affected the failing tests so marking this comment as resolved.", "author": "jkasten2", "createdAt": "2020-06-10T23:29:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQyNDQ5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "42b98e6c4ff2f5eda15ecd68897bb0dd5858c42a", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\nindex fbfb2c74..8b6e318d 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n\n@@ -129,7 +129,7 @@ class OSInAppMessageController implements OSDynamicTriggerControllerObserver, OS\n     }\n \n     protected void initRedisplayData(OneSignalDbHelper dbHelper) {\n-        inAppMessageRepository = getInAppMessageRepository(dbHelper);\n+        inAppMessageRepository = new OSInAppMessageRepository(dbHelper);\n         redisplayedInAppMessages = inAppMessageRepository.getCachedInAppMessages();\n \n         OneSignal.Log(OneSignal.LOG_LEVEL.DEBUG, \"redisplayedInAppMessages: \" + redisplayedInAppMessages.toString());\n"}}, {"oid": "42b98e6c4ff2f5eda15ecd68897bb0dd5858c42a", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/42b98e6c4ff2f5eda15ecd68897bb0dd5858c42a", "message": "Merge branch 'fix/sql_db_lock_added_more_transactions' of github.com:OneSignal/OneSignal-Android-SDK into fix/sql_db_lock_added_more_transactions", "committedDate": "2020-06-10T22:06:26Z", "type": "commit"}, {"oid": "8b7e6897f740a599f0edd1acdce9a07d568c130e", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/8b7e6897f740a599f0edd1acdce9a07d568c130e", "message": "Fixing travis tests\n* After comment added `OSInAppMessageController.java` into `StaticResetHelper.java`", "committedDate": "2020-06-10T22:20:51Z", "type": "commit"}, {"oid": "a3a3caa6505244658f3f0be9d9196bb6475268b3", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/a3a3caa6505244658f3f0be9d9196bb6475268b3", "message": "Removed `StaticResetHelper.java` for `OSInAppMessageRepository.java`", "committedDate": "2020-06-11T02:33:16Z", "type": "commit"}, {"oid": "2feac9dbb75de8777357e462c1ef60629ce57130", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/2feac9dbb75de8777357e462c1ef60629ce57130", "message": "`IAM_CACHE_DATA_LIFETIME` moved to `OSInAppMessageRepository.java`", "committedDate": "2020-06-11T02:35:15Z", "type": "commit"}]}