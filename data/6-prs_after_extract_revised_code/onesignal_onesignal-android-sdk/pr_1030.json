{"pr_number": 1030, "pr_title": "UnitTests for NotificationWillShowInForegroundHandler", "pr_createdAt": "2020-05-22T16:34:00Z", "pr_url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1030", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU2MTYxNg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1030#discussion_r433561616", "bodyText": "usually, if the @return is on the java docs you can add a comment in there to add information about the returned object", "author": "Jeasmine", "createdAt": "2020-06-02T00:44:55Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSNotificationGenerationJob.java", "diffHunk": "@@ -107,10 +108,18 @@ CharSequence getBody() {\n \n    /**\n     * Get the notification additional data json from the payload\n+    * @return", "originalCommit": "1b0dbdbb241a12ab087edd0ca4dbf26d09bd0105", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "54b5f7b5659077c016973b4b8320cbd78fa926b0", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSNotificationGenerationJob.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSNotificationGenerationJob.java\nindex f20d31ba..ac745c68 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSNotificationGenerationJob.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSNotificationGenerationJob.java\n\n@@ -108,18 +107,10 @@ public class OSNotificationGenerationJob {\n \n    /**\n     * Get the notification additional data json from the payload\n-    * @return\n     */\n    JSONObject getAdditionalData() {\n-      try {\n-         return new JSONObject(jsonPayload\n-                 .optString(CUSTOM_PAYLOAD_PARAM))\n-                 .getJSONObject(ADDITIONAL_DATA_PAYLOAD_PARAM);\n-      } catch (JSONException e) {\n-         e.printStackTrace();\n-      }\n-\n-      return new JSONObject();\n+      return jsonPayload.optJSONObject(CUSTOM_PAYLOAD_PARAM)\n+                        .optJSONObject(ADDITIONAL_DATA_PAYLOAD_PARAM);\n    }\n \n    /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU2MTgwMw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1030#discussion_r433561803", "bodyText": "do you need the this. ?", "author": "Jeasmine", "createdAt": "2020-06-02T00:45:37Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSNotificationGenerationJob.java", "diffHunk": "@@ -170,18 +183,21 @@ AppNotificationGenerationJob toAppNotificationGenerationJob() {\n       // The actual notifJob with notification payload data\n       private OSNotificationGenerationJob notifJob;\n \n-      // Handler used to timeout the handler if bubble or complete is not called\n+      // Single Handler used to timeout the handler if bubble or complete is not called\n       private Handler timeoutHandler;\n+      // Single Runnable used to execute code after the handler timeout completes\n+      private Runnable timeoutRunnable;\n \n       NotificationGenerationJob(OSNotificationGenerationJob notifJob) {\n          this.notifJob = notifJob;\n       }\n \n-      void startShowNotificationTimeout(final Runnable timeoutRunnable) {\n-         // If the handler isn't null we do not want to start another\n-         if (timeoutHandler != null)\n+      void startShowNotificationTimeout(final Runnable runnable) {\n+         // If the handler or runnable isn't null we do not want to start another\n+         if (this.timeoutHandler != null || this.timeoutRunnable != null)", "originalCommit": "1b0dbdbb241a12ab087edd0ca4dbf26d09bd0105", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "54b5f7b5659077c016973b4b8320cbd78fa926b0", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSNotificationGenerationJob.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSNotificationGenerationJob.java\nindex f20d31ba..ac745c68 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSNotificationGenerationJob.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSNotificationGenerationJob.java\n\n@@ -183,21 +170,18 @@ public class OSNotificationGenerationJob {\n       // The actual notifJob with notification payload data\n       private OSNotificationGenerationJob notifJob;\n \n-      // Single Handler used to timeout the handler if bubble or complete is not called\n+      // Handler used to timeout the handler if bubble or complete is not called\n       private Handler timeoutHandler;\n-      // Single Runnable used to execute code after the handler timeout completes\n-      private Runnable timeoutRunnable;\n \n       NotificationGenerationJob(OSNotificationGenerationJob notifJob) {\n          this.notifJob = notifJob;\n       }\n \n-      void startShowNotificationTimeout(final Runnable runnable) {\n-         // If the handler or runnable isn't null we do not want to start another\n-         if (this.timeoutHandler != null || this.timeoutRunnable != null)\n+      void startShowNotificationTimeout(final Runnable timeoutRunnable) {\n+         // If the handler isn't null we do not want to start another\n+         if (timeoutHandler != null)\n             return;\n \n-         this.timeoutRunnable = runnable;\n          OSUtils.runOnMainUIThread(new Runnable() {\n             @Override\n             public void run() {\n"}}, {"oid": "54b5f7b5659077c016973b4b8320cbd78fa926b0", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/54b5f7b5659077c016973b4b8320cbd78fa926b0", "message": "Refactor prep for `InFocusDisplayOption` in `NotifForegroundHandler`\n* `NotificationWillShowInForegroundHandler` will be responsible for setting the notifications display type if a dev decides so\n  * Alternative is a global setter that also controls the default for `OSNotificationDisplay` if no `NotificationWillShowInForegroundHandler` is set\n  * Renamed `None` to `SILENT` and `Notification` to `NOTIFICATION` to follow a caps snake-case enum convention\n* Removed `InAppAlert` from `InFocusDisplayOption`\n  * Refactored `InFocusDisplayOption` to `OSNotificationDisplay`\n  * Cleaned out `InAppAlert` related `UnitTests`", "committedDate": "2020-07-01T16:42:50Z", "type": "commit"}, {"oid": "c08a5dbecf7dce583c01c7525ac438f03429f14c", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/c08a5dbecf7dce583c01c7525ac438f03429f14c", "message": "Alert was removed, so isActive check no longer needed here", "committedDate": "2020-07-01T16:44:28Z", "type": "commit"}, {"oid": "5c495925ef8d091f7f3a052c45b6c4ca7b3c086c", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/5c495925ef8d091f7f3a052c45b6c4ca7b3c086c", "message": "Refactor prep for `InFocusDisplayOption` in `NotifForegroundHandler`\n* `NotificationWillShowInForegroundHandler` will be responsible for setting the notifications display type if a dev decides so\n  * Alternative is a global setter that also controls the default for `OSNotificationDisplay` if no `NotificationWillShowInForegroundHandler` is set\n  * Renamed `None` to `SILENT` and `Notification` to `NOTIFICATION` to follow a caps snake-case enum convention\n* Removed `InAppAlert` from `InFocusDisplayOption`\n  * Refactored `InFocusDisplayOption` to `OSNotificationDisplay`\n  * Cleaned out `InAppAlert` related `UnitTests`", "committedDate": "2020-07-01T17:03:18Z", "type": "commit"}, {"oid": "a355e9e1b006ed1c15a10375684d652aee1a59c9", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/a355e9e1b006ed1c15a10375684d652aee1a59c9", "message": "Implementing new NotificationWillShowInForegroundHandlers\n  * 1 can be implemented through the notification extension service and be known as the `ExtNotificationWillShowInForegroundHandler`\n    * This involves a new metadata tag in apps using OneSignal,\n    * On init of OneSignal, searches for an extension service file and save the implementations as global handlers to be used throughout OneSignal codebase\n  * Second one will be implemented through a public OneSignal setter called `setNotificationWillShowInForegroundHandler` and is known as the `AppNotificationWillShowInForegroundHandler`\n    * From these handlers a set of new functionality exists now:\n      * This includes bubbling from ext to app handler to mimic iOS handler before showing notification\n      * Also without bubbling a 30 second timeout will begin counting down before showing notification by default\n  * Renamed `NotificationGenerationJob` to `OSNotificationGenerationJob`\n  * To help keep things private within the handlers, a `NotificationGenerationJob` class was made to be extended by a `ExtNotificationGenerationJob` and `AppNotificationGenerationJob`\n* Removed what is believed to be final Alert based flow for showing a notification\n\n* Unit Tests need to be fixed and new ones added still after validating functionality here\n* Next the Work manager should be implemented to process these one at a time as they come in", "committedDate": "2020-07-01T17:20:16Z", "type": "commit"}, {"oid": "0b9a6c4365efbe3a1275eb76061c9e4f8d8e3b9d", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/0b9a6c4365efbe3a1275eb76061c9e4f8d8e3b9d", "message": "Cleaned up previous commit(s) for this PR\n* UnitTests failing, needed to rework notification display flow a little\n* Removed more Alert based notification code `showNotificationAsAlert`\n* Refactored `ProcessJobForDisplay` to perfection in terms of mimic'ing current master implementation but removing Alert based handling and including new `NotificationWillShowInForegroundHandler`\n* Replaced method `NotificationExtenderService.showNotification` with `GenerateNotification.fromJsonPayload`\n* Removed `OSNotificationGenerationJob` from PackagePrivate helper file because it is public already\n\nDone with fixing unit tests and getting functionality matching previous NotificationReceivedHandler SDK functionality\n* WIP - Need to write new unit tests to test new functionality, this will go in a new PR branched off this PR branch", "committedDate": "2020-07-01T17:30:57Z", "type": "commit"}, {"oid": "97d1a6573b1fd54721c1a5ac2c3f6c71f94f1a25", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/97d1a6573b1fd54721c1a5ac2c3f6c71f94f1a25", "message": "Slight tweaks to the flow of the NotificationWillShowInForegroundHandler\n* Removed unnecessary nested Threads wrapping Runnables\n* 3 NotificationWillShowInForegroundHandler UnitTests built now and all passing correctly\n  * Will use these as a template for other scenarios\n\nUniTests in this commit:\n* `testExtNotificationWillShowInForegroundHandler_completeBubbles_toAppNotificationWillShowInForegroundHandler`\n* `testExtNotificationWillShowInForegroundHandler_completeDoesNotBubble_toAppNotificationWillShowInForegroundHandler`\n* `testExtNotificationWillShowInForegroundHandler_bubblesAfter30SecondTimeout_toAppNotificationWillShowInForegroundHandler`", "committedDate": "2020-07-01T17:49:48Z", "type": "commit"}, {"oid": "13ea5075836dac3148cf17b7d89c6134210ba78c", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/13ea5075836dac3148cf17b7d89c6134210ba78c", "message": "Finished Jira unit tests for NotificationWillShowInForegroundHandler\n* No extension service class tests\n  * Testing the scenario where no foreground handlers have been setup\n  * `testNullExtAndAppNotificationWillShowInForegroundHandlers`\n* `NotificationExtensionService_notifJobPayload` class tests\n  * Testing that the data in the accessible getters is correct for the notifJobs\n  * `testNullExtAndAppNotificationWillShowInForegroundHandlers`\n* `NotificationExtensionService_bubblesAfter30SecondTimeout_toAppNotificationWillShowInForegroundHandler` class tests\n  * Testing 30 second notification timeout bubbling\n  * testNotificationWillShowInForegroundHandler_bubbles30SecondTimeout_forExtAndAppHandlers\n  * testExtNotificationWillShowInForegroundHandler_bubblesAfter30SecondTimeout_withNullAppNotificationWillShowInForegroundHandler\n  * testExtNotificationWillShowInForegroundHandler_bubblesAfter30SecondTimeout_toAppNotificationWillShowInForegroundHandler\n* `NotificationExtensionService_completeDoesNotBubble_toAppNotificationWillShowInForegroundHandler` class tests\n  * Testing scenarios where no bubbling should occur\n  * testExtNotificationWillShowInForegroundHandler_completeDoesNotBubble_toAppNotificationWillShowInForegroundHandler\n  * testExtNotificationWillShowInForegroundHandler_completeDoesNotBubble_toNullAppNotificationWillShowInForegroundHandler\n* `NotificationExtensionService_completeBubbles_toAppNotificationWillShowInForegroundHandler` class tests\n  * Testing scenarios where bubbling is controlled with complete method\n  * testExtNotificationWillShowInForegroundHandler_completeBubbles_toAppNotificationWillShowInForegroundHandler\n  * testExtNotificationWillShowInForegroundHandler_completeBubbles_withNullAppNotificationWillShowInForegroundHandler\n* `NotificationExtensionService_setNotificationDisplayOptionToSilent` class tests\n  * Testing scenarios where `setNotificationDisplayOption` is set to `SILENT`\n  * testExtNotificationWillShowInForegroundHandler_setNotificationDisplayOptionToSilent\n  * testExtNotificationWillShowInForegroundHandler_setNotificationDisplayOptionToSilent_andThenToNotification\n* `NotificationExtensionService_setNotificationDisplayOptionToNotification` class tests\n  * Testing scenarios where `setNotificationDisplayOption` is set to `NOTIFICATION`\n  * testExtNotificationWillShowInForegroundHandler_setNotificationDisplayOptionToNotification\n  * testExtNotificationWillShowInForegroundHandler_setNotificationDisplayOptionToNotification_andThenToSilent", "committedDate": "2020-07-01T17:49:48Z", "type": "commit"}, {"oid": "bdf3bf156e87d8fa7bc845ffb680d3db0b7407e5", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/bdf3bf156e87d8fa7bc845ffb680d3db0b7407e5", "message": "Fixing UnitTest steps comment numbering", "committedDate": "2020-07-01T17:49:48Z", "type": "commit"}, {"oid": "bdf3bf156e87d8fa7bc845ffb680d3db0b7407e5", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/bdf3bf156e87d8fa7bc845ffb680d3db0b7407e5", "message": "Fixing UnitTest steps comment numbering", "committedDate": "2020-07-01T17:49:48Z", "type": "forcePushed"}, {"oid": "a75fe8bf9e937144205cdc82c704ad604a93cdaf", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/a75fe8bf9e937144205cdc82c704ad604a93cdaf", "message": "Minor fixes from PR comments as well as `OSTimeoutHandler` class\n* `OSTimeoutHandler` class extended by a class to create Timeout for that instance of the class\n  * Start timeout with `startTimeout` and stop with `destroyTimeout`\n  * Extended by `NotificationGenerationJob`, which is extended by `AppNotificationGenerationJob` and `ExtNotificationGenerationJob`\n* Added a `isComplete` `boolean` to the `NotificationGenerationJob` class to make sure complete methods can not be called twice\n  * Use case would be that work inside of a handler takes longer than timeout, but also calls complete at the end\n  * `isComplete` would be set `true` already so no way to complete more than once\n* `AppNotificationGenerationJob` and `ExtNotificationGenerationJob` now have `synchronized` on complete methods", "committedDate": "2020-07-01T19:03:22Z", "type": "commit"}, {"oid": "e45d20d240b07d82615579faca32337a8fcf2026", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/e45d20d240b07d82615579faca32337a8fcf2026", "message": "Added 1 unit test for App/Ext `NotificationWillShowInForegroundHandler`\n* Test is in regards to work taking longer than 30 second timeout\n  * Simulate work taking 30+ seconds and make sure complete is not called successfully twice\n  * This is guarded by `synchronized` and `isComplete` `boolean` internal to `NotificationGenerationJob`\n* Using a newly created `callbackCounter` which is used to increment the number of times and event occurred\n  * In this case we only want the App/Ext `NotificationWillShowInForegroundHandler` to fire once", "committedDate": "2020-07-01T19:57:53Z", "type": "commit"}]}