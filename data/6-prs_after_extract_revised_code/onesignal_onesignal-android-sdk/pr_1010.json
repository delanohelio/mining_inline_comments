{"pr_number": 1010, "pr_title": "Fully implement `NotificationWillShowInForeground`", "pr_createdAt": "2020-05-08T17:34:25Z", "pr_url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1010", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA5NjA5Ng==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1010#discussion_r424096096", "bodyText": "If we are removing the getInAppAlertNotificationEnabled flag we should remove the isActive check as well", "author": "jkasten2", "createdAt": "2020-05-12T23:46:24Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/NotificationBundleProcessor.java", "diffHunk": "@@ -541,12 +540,8 @@ private static boolean startExtenderService(Context context, Bundle bundle, Proc\n \n    static boolean shouldDisplay(String body) {\n       boolean hasBody = body != null && !\"\".equals(body);\n-      boolean showAsAlert = OneSignal.getInAppAlertNotificationEnabled();\n       boolean isActive = OneSignal.isAppActive();\n-      return hasBody &&\n-                (OneSignal.getNotificationsWhenActiveEnabled()\n-              || showAsAlert\n-              || !isActive);\n+      return hasBody && !isActive;", "originalCommit": "1ef95bf5443d5da98598aa1ec77f7899ee3df932", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "11ad912ea072725f5ea5e2617a43ba3bd01032cf", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/NotificationBundleProcessor.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/NotificationBundleProcessor.java\nindex b1a60a6f..04750dcf 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/NotificationBundleProcessor.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/NotificationBundleProcessor.java\n\n@@ -539,9 +549,7 @@ class NotificationBundleProcessor {\n    }\n \n    static boolean shouldDisplay(String body) {\n-      boolean hasBody = body != null && !\"\".equals(body);\n-      boolean isActive = OneSignal.isAppActive();\n-      return hasBody && !isActive;\n+      return body != null && !\"\".equals(body);\n    }\n \n    static @NonNull JSONArray newJsonArray(JSONObject jsonObject) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEwMDYzMw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1010#discussion_r424100633", "bodyText": "Redundant APIs create another surface which has a lot of dependencies:\n\nMore SDK code and code paths\nUnit Tests\nManual testing\nDocumentation & Examples\n\nNot saying we would never want a redundant API, just it should have a good use case. In this case if they wanted to not show a notification when the app is in focus for some reason I can't see way they won't want to setup a notifiationWillShowInForegorund handler.", "author": "jkasten2", "createdAt": "2020-05-13T00:02:07Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignal.java", "diffHunk": "@@ -477,6 +487,18 @@ public static void unsubscribeWhenNotificationsAreDisabled(boolean set) {\n       mUnsubscribeWhenNotificationsAreDisabled = set;\n    }\n \n+   /**\n+    * If {@link NotificationWillShowInForegroundHandler} is not set, the ability to control a\n+    *    default {@link OSNotificationDisplay} should still exist\n+    */\n+   public static void setNotificationDisplayOption(OSNotificationDisplay displayOption) {", "originalCommit": "1ef95bf5443d5da98598aa1ec77f7899ee3df932", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8085509da42cb811fe133b3edf84a0218e3140a7", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignal.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignal.java\nindex 4a2c5cae..1188b555 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignal.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignal.java\n\n@@ -487,18 +591,6 @@ public class OneSignal {\n       mUnsubscribeWhenNotificationsAreDisabled = set;\n    }\n \n-   /**\n-    * If {@link NotificationWillShowInForegroundHandler} is not set, the ability to control a\n-    *    default {@link OSNotificationDisplay} should still exist\n-    */\n-   public static void setNotificationDisplayOption(OSNotificationDisplay displayOption) {\n-      mDisplayOption = displayOption;\n-   }\n-\n-   public static OSNotificationDisplay getCurrentNotificationDisplayOption() {\n-      return mDisplayOption;\n-   }\n-\n    /**\n     * 1/2 steps in OneSignal init, relying on setAppContext (usage order does not matter)\n     * Sets the app id OneSignal should use in the application\n"}}, {"oid": "20ebaef04c27c1c6c026eeddca3779603f8bf4ff", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/20ebaef04c27c1c6c026eeddca3779603f8bf4ff", "message": "Refactored `mPromptLocation` to `mAutoPromptLocation`", "committedDate": "2020-05-14T23:42:28Z", "type": "forcePushed"}, {"oid": "11ad912ea072725f5ea5e2617a43ba3bd01032cf", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/11ad912ea072725f5ea5e2617a43ba3bd01032cf", "message": "Alert was removed, so isActive check no longer needed here", "committedDate": "2020-05-21T15:10:59Z", "type": "forcePushed"}, {"oid": "8085509da42cb811fe133b3edf84a0218e3140a7", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/8085509da42cb811fe133b3edf84a0218e3140a7", "message": "Removed Thread for `ProcessJobForDisplay` to fix UnitTests", "committedDate": "2020-07-01T15:03:14Z", "type": "forcePushed"}, {"oid": "aee3ae736021d2e2555386500224925f34f29127", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/aee3ae736021d2e2555386500224925f34f29127", "message": "Mistakes when rebasing, but easy fixes\n* Unnecessary unit test static variables removed\n* `getDBHelperInstance` isn't really necessary as we can easily get a DB instance with `OneSignalDbHelper.getInstance(OneSignal.appContext);`\n* `AppEntryAction` needs to be public, but we might want to move this outside of `OneSignal` class", "committedDate": "2020-07-01T15:43:29Z", "type": "forcePushed"}, {"oid": "d294d0c31dbd9bfa51f9b2780218ed60e9386e66", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/d294d0c31dbd9bfa51f9b2780218ed60e9386e66", "message": "Mistakes when rebasing, but easy fixes\n* Unnecessary unit test static variables removed\n* `getDBHelperInstance` isn't really necessary as we can easily get a DB instance with `OneSignalDbHelper.getInstance(OneSignal.appContext);`\n* `AppEntryAction` needs to be public, but we might want to move this outside of `OneSignal` class", "committedDate": "2020-07-01T15:51:31Z", "type": "forcePushed"}, {"oid": "ec8a46585b1c25e89144bd07c267263db29e2a69", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/ec8a46585b1c25e89144bd07c267263db29e2a69", "message": "Refactor prep for `InFocusDisplayOption` in `NotifForegroundHandler`\n* `NotificationWillShowInForegroundHandler` will be responsible for setting the notifications display type if a dev decides so\n  * Alternative is a global setter that also controls the default for `OSNotificationDisplay` if no `NotificationWillShowInForegroundHandler` is set\n  * Renamed `None` to `SILENT` and `Notification` to `NOTIFICATION` to follow a caps snake-case enum convention\n* Removed `InAppAlert` from `InFocusDisplayOption`\n  * Refactored `InFocusDisplayOption` to `OSNotificationDisplay`\n  * Cleaned out `InAppAlert` related `UnitTests`", "committedDate": "2020-08-21T15:07:41Z", "type": "commit"}, {"oid": "d3ef650f6d6a8181ee55bdb6f9aa085e16ff4851", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/d3ef650f6d6a8181ee55bdb6f9aa085e16ff4851", "message": "Refactored `mPromptLocation` to `mAutoPromptLocation`", "committedDate": "2020-08-21T15:07:41Z", "type": "commit"}, {"oid": "dd0f35e13d1781c042cb7df7d1ede866f1bcb374", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/dd0f35e13d1781c042cb7df7d1ede866f1bcb374", "message": "Alert was removed, so isActive check no longer needed here", "committedDate": "2020-08-21T15:07:41Z", "type": "commit"}, {"oid": "779dd4f3ac9cadb87fd8174944f4295ed0658041", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/779dd4f3ac9cadb87fd8174944f4295ed0658041", "message": "Refactor prep for `InFocusDisplayOption` in `NotifForegroundHandler`\n* `NotificationWillShowInForegroundHandler` will be responsible for setting the notifications display type if a dev decides so\n  * Alternative is a global setter that also controls the default for `OSNotificationDisplay` if no `NotificationWillShowInForegroundHandler` is set\n  * Renamed `None` to `SILENT` and `Notification` to `NOTIFICATION` to follow a caps snake-case enum convention\n* Removed `InAppAlert` from `InFocusDisplayOption`\n  * Refactored `InFocusDisplayOption` to `OSNotificationDisplay`\n  * Cleaned out `InAppAlert` related `UnitTests`", "committedDate": "2020-08-21T15:07:41Z", "type": "commit"}, {"oid": "f8c89af74c775ff45325fa3d4191b505cac534c1", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/f8c89af74c775ff45325fa3d4191b505cac534c1", "message": "Refactor prep for `InFocusDisplayOption` in `NotifForegroundHandler`\n* `NotificationWillShowInForegroundHandler` will be responsible for setting the notifications display type if a dev decides so\n  * Alternative is a global setter that also controls the default for `OSNotificationDisplay` if no `NotificationWillShowInForegroundHandler` is set\n  * Renamed `None` to `SILENT` and `Notification` to `NOTIFICATION` to follow a caps snake-case enum convention\n* Removed `InAppAlert` from `InFocusDisplayOption`\n  * Refactored `InFocusDisplayOption` to `OSNotificationDisplay`\n  * Cleaned out `InAppAlert` related `UnitTests`", "committedDate": "2020-08-21T15:07:41Z", "type": "commit"}, {"oid": "4b99333c3f69542f80def2908b4099db04ffe6db", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/4b99333c3f69542f80def2908b4099db04ffe6db", "message": "Implementing new NotificationWillShowInForegroundHandlers\n  * 1 can be implemented through the notification extension service and be known as the `ExtNotificationWillShowInForegroundHandler`\n    * This involves a new metadata tag in apps using OneSignal,\n    * On init of OneSignal, searches for an extension service file and save the implementations as global handlers to be used throughout OneSignal codebase\n  * Second one will be implemented through a public OneSignal setter called `setNotificationWillShowInForegroundHandler` and is known as the `AppNotificationWillShowInForegroundHandler`\n    * From these handlers a set of new functionality exists now:\n      * This includes bubbling from ext to app handler to mimic iOS handler before showing notification\n      * Also without bubbling a 30 second timeout will begin counting down before showing notification by default\n  * Renamed `NotificationGenerationJob` to `OSNotificationGenerationJob`\n  * To help keep things private within the handlers, a `NotificationGenerationJob` class was made to be extended by a `ExtNotificationGenerationJob` and `AppNotificationGenerationJob`\n* Removed what is believed to be final Alert based flow for showing a notification\n\n* Unit Tests need to be fixed and new ones added still after validating functionality here\n* Next the Work manager should be implemented to process these one at a time as they come in", "committedDate": "2020-08-21T15:13:07Z", "type": "commit"}, {"oid": "70470b366e885fc6d53df084d9cc0c13745ee340", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/70470b366e885fc6d53df084d9cc0c13745ee340", "message": "Fixing review comments\n* Refactored `bubble(boolean bubble)` method to `complete(boolean bubble)`\n* Added additional data getter for `OSNotificationGenerationJob`\n* Added constant keys for params in notification payload\n* Removed `OneSignal.setNotificationDisplayOption` and other related fields", "committedDate": "2020-08-21T15:13:07Z", "type": "commit"}, {"oid": "8667f37644b59a10defcad34b86a99f15324b976", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/8667f37644b59a10defcad34b86a99f15324b976", "message": "Cleaned up previous commit(s) for this PR\n* UnitTests failing, needed to rework notification display flow a little\n* Removed more Alert based notification code `showNotificationAsAlert`\n* Refactored `ProcessJobForDisplay` to perfection in terms of mimic'ing current master implementation but removing Alert based handling and including new `NotificationWillShowInForegroundHandler`\n* Replaced method `NotificationExtenderService.showNotification` with `GenerateNotification.fromJsonPayload`\n* Removed `OSNotificationGenerationJob` from PackagePrivate helper file because it is public already\n\nDone with fixing unit tests and getting functionality matching previous NotificationReceivedHandler SDK functionality\n* WIP - Need to write new unit tests to test new functionality, this will go in a new PR branched off this PR branch", "committedDate": "2020-08-21T15:22:06Z", "type": "commit"}, {"oid": "e1171395e8bb838ec00137c04216efda1e44612f", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/e1171395e8bb838ec00137c04216efda1e44612f", "message": "Removed Thread for `ProcessJobForDisplay` to fix UnitTests", "committedDate": "2020-08-21T15:22:06Z", "type": "commit"}, {"oid": "c0a75846151a3a03d68a69a608bb3b92bdede8be", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/c0a75846151a3a03d68a69a608bb3b92bdede8be", "message": "Mistakes when rebasing, but easy fixes\n* Unnecessary unit test static variables removed\n* `getDBHelperInstance` isn't really necessary as we can easily get a DB instance with `OneSignalDbHelper.getInstance(OneSignal.appContext);`\n* `AppEntryAction` needs to be public, but we might want to move this outside of `OneSignal` class", "committedDate": "2020-08-21T15:29:59Z", "type": "commit"}, {"oid": "7f142be20156151afc1c93f46a825541e0d3ae97", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/7f142be20156151afc1c93f46a825541e0d3ae97", "message": "Refactor prep for `InFocusDisplayOption` in `NotifForegroundHandler`\n* `NotificationWillShowInForegroundHandler` will be responsible for setting the notifications display type if a dev decides so\n  * Alternative is a global setter that also controls the default for `OSNotificationDisplay` if no `NotificationWillShowInForegroundHandler` is set\n  * Renamed `None` to `SILENT` and `Notification` to `NOTIFICATION` to follow a caps snake-case enum convention\n* Removed `InAppAlert` from `InFocusDisplayOption`\n  * Refactored `InFocusDisplayOption` to `OSNotificationDisplay`\n  * Cleaned out `InAppAlert` related `UnitTests`", "committedDate": "2020-08-21T15:29:59Z", "type": "commit"}, {"oid": "df43fdb129488f2d9264924871e6b6a1bdda3079", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/df43fdb129488f2d9264924871e6b6a1bdda3079", "message": "Alert was removed, so isActive check no longer needed here", "committedDate": "2020-08-21T15:29:59Z", "type": "commit"}, {"oid": "7021f1f3bfdeb9de6e9110106f9be3f6caf6ce71", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/7021f1f3bfdeb9de6e9110106f9be3f6caf6ce71", "message": "Refactor prep for `InFocusDisplayOption` in `NotifForegroundHandler`\n* `NotificationWillShowInForegroundHandler` will be responsible for setting the notifications display type if a dev decides so\n  * Alternative is a global setter that also controls the default for `OSNotificationDisplay` if no `NotificationWillShowInForegroundHandler` is set\n  * Renamed `None` to `SILENT` and `Notification` to `NOTIFICATION` to follow a caps snake-case enum convention\n* Removed `InAppAlert` from `InFocusDisplayOption`\n  * Refactored `InFocusDisplayOption` to `OSNotificationDisplay`\n  * Cleaned out `InAppAlert` related `UnitTests`", "committedDate": "2020-08-21T15:29:59Z", "type": "commit"}, {"oid": "c9369e7ca37c1cd0b16de56a9503326ab3a6554f", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/c9369e7ca37c1cd0b16de56a9503326ab3a6554f", "message": "Implementing new NotificationWillShowInForegroundHandlers\n  * 1 can be implemented through the notification extension service and be known as the `ExtNotificationWillShowInForegroundHandler`\n    * This involves a new metadata tag in apps using OneSignal,\n    * On init of OneSignal, searches for an extension service file and save the implementations as global handlers to be used throughout OneSignal codebase\n  * Second one will be implemented through a public OneSignal setter called `setNotificationWillShowInForegroundHandler` and is known as the `AppNotificationWillShowInForegroundHandler`\n    * From these handlers a set of new functionality exists now:\n      * This includes bubbling from ext to app handler to mimic iOS handler before showing notification\n      * Also without bubbling a 30 second timeout will begin counting down before showing notification by default\n  * Renamed `NotificationGenerationJob` to `OSNotificationGenerationJob`\n  * To help keep things private within the handlers, a `NotificationGenerationJob` class was made to be extended by a `ExtNotificationGenerationJob` and `AppNotificationGenerationJob`\n* Removed what is believed to be final Alert based flow for showing a notification\n\n* Unit Tests need to be fixed and new ones added still after validating functionality here\n* Next the Work manager should be implemented to process these one at a time as they come in", "committedDate": "2020-08-21T15:29:59Z", "type": "commit"}, {"oid": "aed775930da56f5903de889d72a54070d55cac4b", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/aed775930da56f5903de889d72a54070d55cac4b", "message": "Cleaned up previous commit(s) for this PR\n* UnitTests failing, needed to rework notification display flow a little\n* Removed more Alert based notification code `showNotificationAsAlert`\n* Refactored `ProcessJobForDisplay` to perfection in terms of mimic'ing current master implementation but removing Alert based handling and including new `NotificationWillShowInForegroundHandler`\n* Replaced method `NotificationExtenderService.showNotification` with `GenerateNotification.fromJsonPayload`\n* Removed `OSNotificationGenerationJob` from PackagePrivate helper file because it is public already\n\nDone with fixing unit tests and getting functionality matching previous NotificationReceivedHandler SDK functionality\n* WIP - Need to write new unit tests to test new functionality, this will go in a new PR branched off this PR branch", "committedDate": "2020-08-21T15:29:59Z", "type": "commit"}, {"oid": "3691e06708bbb225d7e3767509bf2b9ee6c9721d", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/3691e06708bbb225d7e3767509bf2b9ee6c9721d", "message": "Slight tweaks to the flow of the NotificationWillShowInForegroundHandler\n* Removed unnecessary nested Threads wrapping Runnables\n* 3 NotificationWillShowInForegroundHandler UnitTests built now and all passing correctly\n  * Will use these as a template for other scenarios\n\nUniTests in this commit:\n* `testExtNotificationWillShowInForegroundHandler_completeBubbles_toAppNotificationWillShowInForegroundHandler`\n* `testExtNotificationWillShowInForegroundHandler_completeDoesNotBubble_toAppNotificationWillShowInForegroundHandler`\n* `testExtNotificationWillShowInForegroundHandler_bubblesAfter30SecondTimeout_toAppNotificationWillShowInForegroundHandler`", "committedDate": "2020-08-21T16:29:47Z", "type": "commit"}, {"oid": "80e4c45c6c3883661fe3b1d1bd13ca340bbd88cb", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/80e4c45c6c3883661fe3b1d1bd13ca340bbd88cb", "message": "Finished Jira unit tests for NotificationWillShowInForegroundHandler\n* No extension service class tests\n  * Testing the scenario where no foreground handlers have been setup\n  * `testNullExtAndAppNotificationWillShowInForegroundHandlers`\n* `NotificationExtensionService_notifJobPayload` class tests\n  * Testing that the data in the accessible getters is correct for the notifJobs\n  * `testNullExtAndAppNotificationWillShowInForegroundHandlers`\n* `NotificationExtensionService_bubblesAfter30SecondTimeout_toAppNotificationWillShowInForegroundHandler` class tests\n  * Testing 30 second notification timeout bubbling\n  * testNotificationWillShowInForegroundHandler_bubbles30SecondTimeout_forExtAndAppHandlers\n  * testExtNotificationWillShowInForegroundHandler_bubblesAfter30SecondTimeout_withNullAppNotificationWillShowInForegroundHandler\n  * testExtNotificationWillShowInForegroundHandler_bubblesAfter30SecondTimeout_toAppNotificationWillShowInForegroundHandler\n* `NotificationExtensionService_completeDoesNotBubble_toAppNotificationWillShowInForegroundHandler` class tests\n  * Testing scenarios where no bubbling should occur\n  * testExtNotificationWillShowInForegroundHandler_completeDoesNotBubble_toAppNotificationWillShowInForegroundHandler\n  * testExtNotificationWillShowInForegroundHandler_completeDoesNotBubble_toNullAppNotificationWillShowInForegroundHandler\n* `NotificationExtensionService_completeBubbles_toAppNotificationWillShowInForegroundHandler` class tests\n  * Testing scenarios where bubbling is controlled with complete method\n  * testExtNotificationWillShowInForegroundHandler_completeBubbles_toAppNotificationWillShowInForegroundHandler\n  * testExtNotificationWillShowInForegroundHandler_completeBubbles_withNullAppNotificationWillShowInForegroundHandler\n* `NotificationExtensionService_setNotificationDisplayOptionToSilent` class tests\n  * Testing scenarios where `setNotificationDisplayOption` is set to `SILENT`\n  * testExtNotificationWillShowInForegroundHandler_setNotificationDisplayOptionToSilent\n  * testExtNotificationWillShowInForegroundHandler_setNotificationDisplayOptionToSilent_andThenToNotification\n* `NotificationExtensionService_setNotificationDisplayOptionToNotification` class tests\n  * Testing scenarios where `setNotificationDisplayOption` is set to `NOTIFICATION`\n  * testExtNotificationWillShowInForegroundHandler_setNotificationDisplayOptionToNotification\n  * testExtNotificationWillShowInForegroundHandler_setNotificationDisplayOptionToNotification_andThenToSilent", "committedDate": "2020-08-21T16:29:48Z", "type": "commit"}, {"oid": "bc4d07ea87e7926b4831a910be13ef2f5fa4b773", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/bc4d07ea87e7926b4831a910be13ef2f5fa4b773", "message": "Fixing UnitTest steps comment numbering", "committedDate": "2020-08-21T16:29:48Z", "type": "commit"}, {"oid": "0eaed95a54658dae5a97e19d1f2a6d62abfc30f1", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/0eaed95a54658dae5a97e19d1f2a6d62abfc30f1", "message": "Minor fixes from PR comments as well as `OSTimeoutHandler` class\n* `OSTimeoutHandler` class extended by a class to create Timeout for that instance of the class\n  * Start timeout with `startTimeout` and stop with `destroyTimeout`\n  * Extended by `NotificationGenerationJob`, which is extended by `AppNotificationGenerationJob` and `ExtNotificationGenerationJob`\n* Added a `isComplete` `boolean` to the `NotificationGenerationJob` class to make sure complete methods can not be called twice\n  * Use case would be that work inside of a handler takes longer than timeout, but also calls complete at the end\n  * `isComplete` would be set `true` already so no way to complete more than once\n* `AppNotificationGenerationJob` and `ExtNotificationGenerationJob` now have `synchronized` on complete methods", "committedDate": "2020-08-21T16:29:48Z", "type": "commit"}, {"oid": "bc718ab1490ab73b61f1c0d0fd00d4864f598c1b", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/bc718ab1490ab73b61f1c0d0fd00d4864f598c1b", "message": "Added 1 unit test for App/Ext `NotificationWillShowInForegroundHandler`\n* Test is in regards to work taking longer than 30 second timeout\n  * Simulate work taking 30+ seconds and make sure complete is not called successfully twice\n  * This is guarded by `synchronized` and `isComplete` `boolean` internal to `NotificationGenerationJob`\n* Using a newly created `callbackCounter` which is used to increment the number of times and event occurred\n  * In this case we only want the App/Ext `NotificationWillShowInForegroundHandler` to fire once", "committedDate": "2020-08-21T16:35:40Z", "type": "commit"}, {"oid": "bee8aee8285bcb86f37635850e3c81d0fe8ad10a", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/bee8aee8285bcb86f37635850e3c81d0fe8ad10a", "message": "`NotificationWillShowInForeground` won't fire when app is in background\n* Added a unit test for testing this as well", "committedDate": "2020-08-21T16:35:40Z", "type": "commit"}, {"oid": "c932520166c51e4875c141f1fe9dea6028a6060f", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/c932520166c51e4875c141f1fe9dea6028a6060f", "message": "Broke up `fireNotificationWillShowInForegroundHandlers` method\n* Split up `fireNotificationWillShowInForegroundHandlers` into two methods\n  * `boolean shouldFireForegroundHandlers` and `void fireForegroundHandlers`\n* Refactored `ProcessJobForDisplay` to `processJobForDisplay`\n* Removed unused imports and methods\n  * `bundleAsJsonArray` and `saveAndProcessNotification`", "committedDate": "2020-08-21T16:35:40Z", "type": "commit"}, {"oid": "f4228aeaa3360d7f6f926e418d7091cc468080f2", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/f4228aeaa3360d7f6f926e418d7091cc468080f2", "message": "Forgot to add `AppNotificationWillShowInForegroundHandler` to unit test", "committedDate": "2020-08-21T16:35:40Z", "type": "commit"}, {"oid": "ad2332beabed03a7c12e49f051e4a4ba5cdcaffb", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/ad2332beabed03a7c12e49f051e4a4ba5cdcaffb", "message": "WIP - Working on a single Worker `NotificationWorker`\n* `NotificationWillShowInForegroundHandler`\n* `NotificationProcessingHandler`", "committedDate": "2020-08-21T17:11:17Z", "type": "commit"}, {"oid": "23ddcf93af6176d2ac3adaf0f1376a3f5633a875", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/23ddcf93af6176d2ac3adaf0f1376a3f5633a875", "message": "WIP - Single Worker for notification processing and foreground handlers\n* `Worker` class resides within the `OSNotificationWorkManager` class\n  * `NotificationWorker` extends `Worker` class\n  * Constructs a `OSNotificationReceived` instance inside `doWork` override and fires the `OneSignal.NotificationProcessingHandler`\n* Converted `NotificationExtenderService` to `OSNotificationExtender`\n  * Removed extended `JobIntentService`\n  * Removed `onNotificationProcessing` and created a public `OneSignal.NotificationProcessingHandler`\n  * Belongs to the `OSNotificationReceived` class now\n* `OSNotificationReceived` now has 3 methods for handling the `OneSignal.NotificationProcessingHandler`\n  * Extending `OSTimeoutHandler` now and this calls complete method if the `postDelayed` `runnable` is ran\n  * `setModifiedContent`, `display`, and `complete`\n  * Responsible for the `OSNotificationExtender` class so that `setModifiedContent`, `display`, and `complete` may be called\n* Commented out some broken UnitTests for now related to `startExtenderService` method\n  * Refactored now so UnitTests will need to be refactored to accommodate that change\n  * Added `setupWorkManager` to `HMSDataMessageReceivedIntegrationTestsRunner` `beforeEachTest` method\n  * Added `setupWorkManager` to `MainOneSignalClassRunner` `beforeEachTest` method\n* WIP - Need to find a solution for the high priority notifications\n  * Previously processed through a `JobIntentService` relying on `completeWakefulIntent`", "committedDate": "2020-08-21T17:25:25Z", "type": "commit"}, {"oid": "64dc932cacce4d4211c4cf8f57ebeb9899ce12e4", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/64dc932cacce4d4211c4cf8f57ebeb9899ce12e4", "message": "Merge branch 'feature/implement_notification_foreground_handler_with_in_focus_display_option' into feature/add_worker_class_for_processing_and_foreground_handler\n\n# Conflicts:\n#\tOneSignalSDK/onesignal/src/main/java/com/onesignal/NotificationBundleProcessor.java\n#\tOneSignalSDK/onesignal/src/main/java/com/onesignal/NotificationExtenderService.java\n#\tOneSignalSDK/onesignal/src/main/java/com/onesignal/OSNotificationGenerationJob.java\n#\tOneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignal.java\n#\tOneSignalSDK/unittest/build.gradle\n#\tOneSignalSDK/unittest/src/test/java/com/test/onesignal/GenerateNotificationRunner.java\n#\tOneSignalSDK/unittest/src/test/java/com/test/onesignal/TestHelpers.java\n\nAlso fixed unit tests related to changes on this PR in general not associated with the update merge\n* `hasExtenderService` within the `FCMBroadcastReceiver` is no longer necessary\n  * No need to have the `Extender` as a `boolean` anymore", "committedDate": "2020-08-21T17:25:25Z", "type": "commit"}, {"oid": "8fde03af1b7ba457478744ad43247ebf8aa23ebd", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/8fde03af1b7ba457478744ad43247ebf8aa23ebd", "message": "Fixed all UnitTests related to old NotificationExtenderService\n  * Replaced by `NotificationProcessingHandler`, which will be an implemented `interface` in a developers custom app `NotificationExtensionService`\n    * Follows same similar implementation to the `ExtNotificationWillShowInForegroundHandler` as well as the `NotificationOpenedHandler`\n  * Added a `try-catch` around the `NotificationProcessingHandler.notificationProcessing` method call\n    * If something fails we can bail and still show the notification the correct way\n    * Might need to do this in the `NotificationWillShowInForegroundHandler` as well\n  * Added `OSNotificationExtender.setupNotificationExtensionServiceClass()` to `OneSignalPackagePrivateHelper`\n    * For UnitTests so we don't need OneSignal init (`setAppId` and `setAppContext`) to setup a dev's extension service\n  * When calling `showNotification` we will want to call `join` after so that work on thread is completely finished\n\nFixed UnitTest(s)\n  * `shouldNotFailedNotificationExtenderServiceWhenAlertIsNull` is now `testNotificationProcessing_whenAlertIsNull`\n  * `notificationExtenderServiceOverridePropertiesWithSummaryApi17` is now `testNotificationExtensionServiceOverridePropertiesWithSummaryApi17`\n  * `notificationExtenderServiceOverridePropertiesWithSummary` is now `testNotificationExtensionServiceOverridePropertiesWithSummary`\n  * `notificationExtenderServiceOverrideShouldOverrideAndroidNotificationId` is now `testNotificationProcessing_twoNotificationsWithSameOverrideAndroidNotificationId`\n  * `shouldFireNotificationExtenderService` is now `testNotificationExtensionService_notificationProcessingProperties`\n\n  * Commented out `shouldStartFCMServiceOnAndroidOWhenPriorityIsHighAndContainsRemoteResource`\n    * No solution for high priority (> 9) notifications as of now with the `WorkManager`\n\nMinor improvements\n  * Removed unnecessary `new Thread` wrapping the `showNotification` method\n  * Created helper methods for firing both `NotificationWillShowInForegroundHandlers`\n    * Added `try-catch` around the `extNotificationWillShowInForegroundHandler` as well as `appNotificationWillShowInForegroundHandler`\n  * Added comment to the `NotificationProcessingHandler` interface\n  * `TODOs` added to a few pieces of code that will be modified in future\n    * `NotificationOpenedHandler` fired from `fireNotificationOpenedHandler` method\n\nAdded `osNotificationId` param as a unique work id\n  * `OSNotificationWorkManager.beginEnqueueingWork` now has a `osNotificationId` param for giving the WorkRequest a unique id\n    * If we try to trigger another WorkRequest while one with that OS id is already running, we simply ignore the new attempt and let the current job finish\n    * Replaced `enqueue` method with `enqueueUniqueWork` and added the `ExistingWorkPolicy.KEEP`", "committedDate": "2020-08-21T17:35:29Z", "type": "commit"}, {"oid": "7b858b2e3947dca6c860e4b237d12639c4743744", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/7b858b2e3947dca6c860e4b237d12639c4743744", "message": "Fixed some notification restore UnitTests\n* WorkManager uses OneSignal notification id now for creating enqueueing a unique WorkRequest\n  * This should work for showing a new notification and restoring a notification\n  * Fixing the restoring notifications was done by adding the `NotificationTable.COLUMN_NAME_NOTIFICATION_ID` column to the array of String columns. Now when querying SQL for notifications to restore we can access the OneSignal notification id", "committedDate": "2020-08-21T17:35:29Z", "type": "commit"}, {"oid": "b977697f193b0e2a63cfb734ad5e610808573335", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/b977697f193b0e2a63cfb734ad5e610808573335", "message": "Added runtime check before showing a notification (#1110)\n\n* Added runtime check before showing a notification\r\n  * Notification should never be processed for display from the Main Thread\r\n  * This can cause an `ANR` if work is taking too long before showing the notification\r\n  * Created a `OSThrowable` class with a `OSMainThreadException`\r\n\r\n* Broken logic when processing a duplicate notification\r\n  * This was change in this PR #1010\r\n  * Added back the correct logic now and UnitTests pass\r\n\r\n* Replaced `processJobForDisplay` call with Worker kickoff now\r\n  * Found another spot where we may not be trying to kick off the Worker and hence would lead to showing the notification from the MainThread\r\n\r\n* Fix Test due to Roboelectric custom Main Thread Looper shadowing\r\n  * Added `Looper.prepare`, `Looper.loop`, and `Looper.quit` calls for handling the postDelayed runnables\r\n  * Add GenerateNotification.java MainThread check shadow\r\n  * Add to String methods for better log\r\n  * Make OSTimeoutHandler.java a composition reference instead of inheritance\r\n\r\nCo-authored-by: Jeasmine Nahui <jeas.nahui@gmail.com>", "committedDate": "2020-08-21T17:35:29Z", "type": "commit"}, {"oid": "c309bc53a8f24a839ca57b1469474bdf229e75e0", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/c309bc53a8f24a839ca57b1469474bdf229e75e0", "message": "Notification restore revamp to use Worker now\n  * **Deleted Files:**\n    * `NotificationRestorer`\n    * `NotificationRestoreService`\n    * `RestoreJobService`\n    * `RestoreKickoffJobService`\n    * Services all removed from `AndroidManifest` as well since `Worker` acts as a replacement\n  * `UpgradeReceiver` and `BootUpReceiver` now kickoff notification restoring through `OSNotificationRestoreWorkManager`\n\nAdded boolean shouldDelay param to restore work manager\n  * `OSNotificationRestoreWorkManager.beginEnqueueingWork` should have a `boolean shouldDelay` param\n  * When app comes from boot or upgrade, add a 15 second delay to alleviate app doing to much work all at once\n\nFixed UnitTests related to app not being in foreground\n  * The foreground issue is related to foreground handlers not firing now when app is backgrounded\n  * Also fixed a network request assert in another UnitTest\n  * `shouldGenerate2BasicGroupNotifications`", "committedDate": "2020-08-21T17:39:52Z", "type": "commit"}, {"oid": "07429f17fab80ce9beb2a99ab1e8301f55c0d284", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/07429f17fab80ce9beb2a99ab1e8301f55c0d284", "message": "Rebase changes", "committedDate": "2020-08-21T19:03:00Z", "type": "forcePushed"}, {"oid": "375bb4939c11c1d4e219ba330831ce44328c6045", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/375bb4939c11c1d4e219ba330831ce44328c6045", "message": "Fix Tests after Rebase", "committedDate": "2020-08-21T19:10:05Z", "type": "commit"}, {"oid": "375bb4939c11c1d4e219ba330831ce44328c6045", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/375bb4939c11c1d4e219ba330831ce44328c6045", "message": "Fix Tests after Rebase", "committedDate": "2020-08-21T19:10:05Z", "type": "forcePushed"}]}