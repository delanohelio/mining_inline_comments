{"pr_number": 1193, "pr_title": "Add notification duplicate check under Workers", "pr_createdAt": "2020-10-20T23:45:30Z", "pr_url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1193", "timeline": [{"oid": "6fd7674b7f0b1e577a79a0d2072095d09f1afd07", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/6fd7674b7f0b1e577a79a0d2072095d09f1afd07", "message": "Add notification duplicate check under Workers\n\n* If the same notification arrives twice, if the first notification did not end processing, the notification will be processed twice\n* Keep notificationIds in memory for short time duplicates, then we rely on databse duplicate check", "committedDate": "2020-10-21T00:00:46Z", "type": "forcePushed"}, {"oid": "aef3962d11ad2072b722645ca1d699ac6d058bae", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/aef3962d11ad2072b722645ca1d699ac6d058bae", "message": "Add notification duplicate check under Workers\n\n* If the same notification arrives twice, if the first notification did not end processing, the notification will be processed twice\n* Keep notificationIds in memory for short time duplicates, then we rely on databse duplicate check", "committedDate": "2020-10-21T00:06:00Z", "type": "forcePushed"}, {"oid": "18964fa490e9096f653eb69fb4b7c2a1de6a9cc8", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/18964fa490e9096f653eb69fb4b7c2a1de6a9cc8", "message": "Add notification duplicate check under Workers\n\n* If the same notification arrives twice, if the first notification did not end processing, the notification will be processed twice\n* Keep notificationIds in memory for short time duplicates, then we rely on databse duplicate check", "committedDate": "2020-10-21T00:10:42Z", "type": "commit"}, {"oid": "18964fa490e9096f653eb69fb4b7c2a1de6a9cc8", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/18964fa490e9096f653eb69fb4b7c2a1de6a9cc8", "message": "Add notification duplicate check under Workers\n\n* If the same notification arrives twice, if the first notification did not end processing, the notification will be processed twice\n* Keep notificationIds in memory for short time duplicates, then we rely on databse duplicate check", "committedDate": "2020-10-21T00:10:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA1OTg1Mg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1193#discussion_r513059852", "bodyText": "This won't be present if someone decides to omit Google Play Services from their app for FireOS or Huawei build of their app. I recommend using import android.text.TextUtils instead as this is in AndroidX. Then we can use TextUtils.isEmpty instead of Strings.isEmptyOrWhitespace.", "author": "jkasten2", "createdAt": "2020-10-27T22:02:41Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSNotificationWorkManager.java", "diffHunk": "@@ -10,16 +10,28 @@\n import androidx.work.Worker;\n import androidx.work.WorkerParameters;\n \n+import com.google.android.gms.common.util.Strings;", "originalCommit": "18964fa490e9096f653eb69fb4b7c2a1de6a9cc8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzEwNTIwNQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1193#discussion_r513105205", "bodyText": "Good catch!", "author": "Jeasmine", "createdAt": "2020-10-28T00:13:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA1OTg1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "920bf7b07d9fbd4e82f234bab4f3231c35272e10", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSNotificationWorkManager.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSNotificationWorkManager.java\nindex 105374cd..e8770e21 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSNotificationWorkManager.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSNotificationWorkManager.java\n\n@@ -10,13 +10,13 @@ import androidx.work.WorkManager;\n import androidx.work.Worker;\n import androidx.work.WorkerParameters;\n \n-import com.google.android.gms.common.util.Strings;\n-\n import org.json.JSONException;\n import org.json.JSONObject;\n \n import java.util.Set;\n \n+import static com.onesignal.OSUtils.isStringNotEmpty;\n+\n class OSNotificationWorkManager {\n \n     private static final String ANDROID_NOTIF_ID_WORKER_DATA_PARAM = \"android_notif_id\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA2NDE0NQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1193#discussion_r513064145", "bodyText": "Can we combine this logic with OneSignal.isDuplicateNotification somehow? It isn't obvious that we have two ways of checking for duplicates.", "author": "jkasten2", "createdAt": "2020-10-27T22:12:48Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSNotificationWorkManager.java", "diffHunk": "@@ -33,6 +45,19 @@ static void beginEnqueueingWork(Context context, String osNotificationId, int an\n                 .setInputData(inputData)\n                 .build();\n \n+        // Duplicate control\n+        // Keep in memory in going processed notifications, to avoid fast duplicates that already finished work process but are not completed yet\n+        // enqueueUniqueWork might not be enough, if the work already finished then the duplicate notification work might be queued again\n+        if (!Strings.isEmptyOrWhitespace(osNotificationId)) {\n+            if (notificationIds.contains(osNotificationId)) {", "originalCommit": "18964fa490e9096f653eb69fb4b7c2a1de6a9cc8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "920bf7b07d9fbd4e82f234bab4f3231c35272e10", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSNotificationWorkManager.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSNotificationWorkManager.java\nindex 105374cd..e8770e21 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSNotificationWorkManager.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSNotificationWorkManager.java\n\n@@ -45,18 +61,6 @@ class OSNotificationWorkManager {\n                 .setInputData(inputData)\n                 .build();\n \n-        // Duplicate control\n-        // Keep in memory in going processed notifications, to avoid fast duplicates that already finished work process but are not completed yet\n-        // enqueueUniqueWork might not be enough, if the work already finished then the duplicate notification work might be queued again\n-        if (!Strings.isEmptyOrWhitespace(osNotificationId)) {\n-            if (notificationIds.contains(osNotificationId)) {\n-                OneSignal.Log(OneSignal.LOG_LEVEL.DEBUG, \"OSNotificationWorkManager notification with notificationId: \" + osNotificationId + \" already queued\");\n-                return;\n-            } else {\n-                notificationIds.add(osNotificationId);\n-            }\n-        }\n-\n         OneSignal.Log(OneSignal.LOG_LEVEL.DEBUG, \"OSNotificationWorkManager enqueueing notification work with notificationId: \" + osNotificationId + \" and jsonPayload: \" + jsonPayload);\n         WorkManager.getInstance(context)\n                 .enqueueUniqueWork(osNotificationId, ExistingWorkPolicy.KEEP, workRequest);\n"}}, {"oid": "920bf7b07d9fbd4e82f234bab4f3231c35272e10", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/920bf7b07d9fbd4e82f234bab4f3231c35272e10", "message": "Check duplicate under isDuplicateNotification\n\n* Share memory and cache duplicate check", "committedDate": "2020-11-02T19:01:18Z", "type": "commit"}, {"oid": "b51f862d4c65e5d0451cb30dfd83f3a592b7de0c", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/b51f862d4c65e5d0451cb30dfd83f3a592b7de0c", "message": "Remove non null annotation conflicting with kotlin", "committedDate": "2020-11-03T15:17:45Z", "type": "commit"}]}