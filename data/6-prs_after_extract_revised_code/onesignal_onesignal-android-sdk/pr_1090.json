{"pr_number": 1090, "pr_title": "Fix background location update", "pr_createdAt": "2020-07-13T18:33:10Z", "pr_url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1090", "timeline": [{"oid": "8458c80d974e9e499cd637563fbe9f26be872cf8", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/8458c80d974e9e499cd637563fbe9f26be872cf8", "message": "Fix background location update\n\n   * Avoid reschedule an already scheduled or running service\n   * If need to reschedule, reschedule under jobFinished", "committedDate": "2020-07-13T18:34:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcxNzgwNg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1090#discussion_r454717806", "bodyText": "Could use a comment for this if block of why we can't schedule another job now, and that we will once the current job is finished.", "author": "jkasten2", "createdAt": "2020-07-15T00:19:30Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalSyncServiceUtils.java", "diffHunk": "@@ -142,20 +141,21 @@ private static boolean hasBootPermission(Context context) {\n    private static boolean isJobIdRunning(Context context) {\n       final JobScheduler jobScheduler = (JobScheduler) context.getSystemService(Context.JOB_SCHEDULER_SERVICE);\n       for (JobInfo jobInfo : jobScheduler.getAllPendingJobs()) {\n-         if (jobInfo.getId() == OneSignalSyncServiceUtils.SYNC_TASK_ID) {\n+         if (jobInfo.getId() == OneSignalSyncServiceUtils.SYNC_TASK_ID && syncBgThread != null && syncBgThread.isAlive()) {\n             return true;\n          }\n       }\n       return false;\n    }\n \n    @RequiresApi(21)\n-   private static boolean scheduleSyncServiceAsJob(Context context, long delayMs) {\n+   private static void scheduleSyncServiceAsJob(Context context, long delayMs) {\n       OneSignal.Log(OneSignal.LOG_LEVEL.VERBOSE, \"scheduleSyncServiceAsJob:atTime: \" + delayMs);\n \n       if (isJobIdRunning(context)) {\n          OneSignal.Log(OneSignal.LOG_LEVEL.VERBOSE, \"scheduleSyncServiceAsJob Scheduler already running!\");\n-         return false;\n+         needsJobReschedule = true;", "originalCommit": "8458c80d974e9e499cd637563fbe9f26be872cf8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e9ef925b8cdc37d34144d32db904cc7afb304c51", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalSyncServiceUtils.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalSyncServiceUtils.java\nindex f3f36951..ef159873 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalSyncServiceUtils.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalSyncServiceUtils.java\n\n@@ -154,6 +154,8 @@ class OneSignalSyncServiceUtils {\n \n       if (isJobIdRunning(context)) {\n          OneSignal.Log(OneSignal.LOG_LEVEL.VERBOSE, \"scheduleSyncServiceAsJob Scheduler already running!\");\n+         // If a JobScheduler is schedule again while running it will stop current job. We will schedule again when finished.\n+         // This will avoid InterruptionException due to thread.join() or queue.take() running.\n          needsJobReschedule = true;\n          return;\n       }\n"}}, {"oid": "e9ef925b8cdc37d34144d32db904cc7afb304c51", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/e9ef925b8cdc37d34144d32db904cc7afb304c51", "message": "Fix background location update\n\n   * Avoid reschedule an already scheduled or running service\n   * If need to reschedule, reschedule under jobFinished", "committedDate": "2020-07-15T15:01:11Z", "type": "commit"}, {"oid": "937394ff9e60c24dbd675a5b180d53a21aaf277d", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/937394ff9e60c24dbd675a5b180d53a21aaf277d", "message": "Fix background location update\n\n   * Avoid reschedule an already scheduled or running service\n   * If need to reschedule, reschedule under jobFinished", "committedDate": "2020-07-15T14:58:39Z", "type": "forcePushed"}, {"oid": "e9ef925b8cdc37d34144d32db904cc7afb304c51", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/e9ef925b8cdc37d34144d32db904cc7afb304c51", "message": "Fix background location update\n\n   * Avoid reschedule an already scheduled or running service\n   * If need to reschedule, reschedule under jobFinished", "committedDate": "2020-07-15T15:01:11Z", "type": "forcePushed"}]}