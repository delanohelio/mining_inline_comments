{"pr_number": 1149, "pr_title": "Fix IAM not being redisplay by session duration", "pr_createdAt": "2020-09-15T18:53:23Z", "pr_url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1149", "timeline": [{"oid": "94b4e5909a985f4d891011200ea6f712e8e59576", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/94b4e5909a985f4d891011200ea6f712e8e59576", "message": "Fix IAM not being redisplay by SESSION DURATION\n\n* Dynamic triggers weren't being scheduled on second pass due to !dismissedMessages.contains(message.messageId) check before evaluateMessageTriggers\n* Dynamic trigger weren't calling makeRedisplayMessagesAvailableWithTriggers, so no redisplay logic was being handle", "committedDate": "2020-09-15T19:00:43Z", "type": "forcePushed"}, {"oid": "7802af94c4c8de458a68d48df544d8b29fc020ce", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/7802af94c4c8de458a68d48df544d8b29fc020ce", "message": "Fix IAM not being redisplay by SESSION DURATION\n\n* Dynamic triggers weren't being scheduled on the second pass due to !dismissedMessages.contains(message.messageId) check being call before evaluateMessageTriggers, and this is not reset until setDataForRedisplay evaluates to true. If evaluateMessageTriggers is not called then dynamic triggers aren't scheduled\n* Dynamic triggers weren't calling makeRedisplayMessagesAvailableWithTriggers, so no redisplay logic was being handled\n* Add better debug logging", "committedDate": "2020-09-15T19:05:41Z", "type": "forcePushed"}, {"oid": "fb1cc40bbc8c9f44033859fd0377f6f532f3c395", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/fb1cc40bbc8c9f44033859fd0377f6f532f3c395", "message": "Fix IAM not being redisplay by SESSION DURATION\n\n* Dynamic triggers weren't being scheduled on the second pass due to !dismissedMessages.contains(message.messageId) check being call before evaluateMessageTriggers, and this is not reset until setDataForRedisplay evaluates to true. If evaluateMessageTriggers is not called then dynamic triggers aren't scheduled\n* Dynamic triggers weren't calling makeRedisplayMessagesAvailableWithTriggers, so no redisplay logic was being handled\n* Add better debug logging", "committedDate": "2020-09-16T00:18:31Z", "type": "forcePushed"}, {"oid": "1574233fd84f4470beb3c4e83c4428b33581067e", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/1574233fd84f4470beb3c4e83c4428b33581067e", "message": "Fix IAM not being redisplay by SESSION DURATION\n\n* Dynamic triggers weren't being scheduled on the second pass due to !dismissedMessages.contains(message.messageId) check being call before evaluateMessageTriggers, and this is not reset until setDataForRedisplay evaluates to true. If evaluateMessageTriggers is not called then dynamic triggers aren't scheduled\n* Dynamic triggers weren't calling makeRedisplayMessagesAvailableWithTriggers, so no redisplay logic was being handled\n* Add better debug logging", "committedDate": "2020-09-16T00:22:58Z", "type": "forcePushed"}, {"oid": "40379d01cce004b2d414867cd4613da976a185a4", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/40379d01cce004b2d414867cd4613da976a185a4", "message": "Fix IAM not being redisplay by SESSION DURATION\n\n* Dynamic triggers weren't being scheduled on the second pass due to !dismissedMessages.contains(message.messageId) check being call before evaluateMessageTriggers, and this is not reset until setDataForRedisplay evaluates to true. If evaluateMessageTriggers is not called then dynamic triggers aren't scheduled\n* Dynamic triggers weren't calling makeRedisplayMessagesAvailableWithTriggers, so no redisplay logic was being handled\n* Add better debug logging", "committedDate": "2020-09-16T00:25:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM4MTc1MA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1149#discussion_r489381750", "bodyText": "This logic seems odd to me by using a foreach style logic but then looking up an idex. Couldn't this work with a contains check instead?", "author": "jkasten2", "createdAt": "2020-09-16T12:01:02Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -189,19 +190,36 @@ private void processInAppMessageJson(@NonNull JSONArray json) throws JSONExcepti\n         }\n         messages = newMessages;\n \n+        populateRedisplayMessagesTriggers();\n         evaluateInAppMessages();\n     }\n \n+    private void populateRedisplayMessagesTriggers() {\n+        for (OSInAppMessage redisplayMessage : redisplayedInAppMessages) {", "originalCommit": "40379d01cce004b2d414867cd4613da976a185a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQwNDYzNw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1149#discussion_r490404637", "bodyText": "we need the index in order to update, nevertheless, this logic can be improved by using the processInAppMessageJson loop", "author": "Jeasmine", "createdAt": "2020-09-17T16:39:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM4MTc1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU2MjU1Ng==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1149#discussion_r490562556", "bodyText": "\ud83d\udc4d This make it easier to read", "author": "jkasten2", "createdAt": "2020-09-17T21:07:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM4MTc1MA=="}], "type": "inlineReview", "revised_code": {"commit": "87b356645e165d6e5f0366f6e433937c31d74c5e", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\nindex d4769933..5435d73b 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n\n@@ -186,21 +186,20 @@ class OSInAppMessageController implements OSDynamicTriggerControllerObserver, OS\n         for (int i = 0; i < json.length(); i++) {\n             JSONObject messageJson = json.getJSONObject(i);\n             OSInAppMessage message = new OSInAppMessage(messageJson);\n+\n+            populateRedisplayMessageTriggers(message);\n             newMessages.add(message);\n         }\n         messages = newMessages;\n \n-        populateRedisplayMessagesTriggers();\n         evaluateInAppMessages();\n     }\n \n-    private void populateRedisplayMessagesTriggers() {\n-        for (OSInAppMessage redisplayMessage : redisplayedInAppMessages) {\n-            int index = messages.indexOf(redisplayMessage);\n-            if (index > -1) {\n-                OSInAppMessage message = messages.get(index);\n-                redisplayMessage.triggers = message.triggers;\n-            }\n+    private void populateRedisplayMessageTriggers(OSInAppMessage message) {\n+        int index = redisplayedInAppMessages.indexOf(message);\n+        if (index > -1) {\n+            OSInAppMessage redisplayMessage = redisplayedInAppMessages.get(index);\n+            redisplayMessage.triggers = message.triggers;\n         }\n     }\n \n"}}, {"oid": "87b356645e165d6e5f0366f6e433937c31d74c5e", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/87b356645e165d6e5f0366f6e433937c31d74c5e", "message": "Fix IAM not being redisplay by SESSION DURATION\n\n* Dynamic triggers weren't being scheduled on the second pass due to !dismissedMessages.contains(message.messageId) check being call before evaluateMessageTriggers, and this is not reset until setDataForRedisplay evaluates to true. If evaluateMessageTriggers is not called then dynamic triggers aren't scheduled\n* Dynamic triggers weren't calling makeRedisplayMessagesAvailableWithTriggers, so no redisplay logic was being handled\n* Add better debug logging", "committedDate": "2020-09-17T16:38:19Z", "type": "commit"}, {"oid": "87b356645e165d6e5f0366f6e433937c31d74c5e", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/87b356645e165d6e5f0366f6e433937c31d74c5e", "message": "Fix IAM not being redisplay by SESSION DURATION\n\n* Dynamic triggers weren't being scheduled on the second pass due to !dismissedMessages.contains(message.messageId) check being call before evaluateMessageTriggers, and this is not reset until setDataForRedisplay evaluates to true. If evaluateMessageTriggers is not called then dynamic triggers aren't scheduled\n* Dynamic triggers weren't calling makeRedisplayMessagesAvailableWithTriggers, so no redisplay logic was being handled\n* Add better debug logging", "committedDate": "2020-09-17T16:38:19Z", "type": "forcePushed"}, {"oid": "f88a3609f7d904772e3b17ab2206d395c39ba424", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/f88a3609f7d904772e3b17ab2206d395c39ba424", "message": "Reset dynamic session launch time\n\n* If the user puts the app on the background and opens the app after 30 seconds, on a new session, the session launch time was not being reset and due to that IAM with redisplay was being shown immediately.\n* When a new session is started, reset session launch time. This will make IAM with session time trigger and redisplay work properly", "committedDate": "2020-09-28T17:58:34Z", "type": "forcePushed"}, {"oid": "37754b7e22921f3bf6fee6fc3a5975504650d7e4", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/37754b7e22921f3bf6fee6fc3a5975504650d7e4", "message": "Reset dynamic session launch time\n\n* If the user puts the app on the background and opens the app after 30 seconds, on a new session, the session launch time was not being reset and due to that IAM with redisplay was being shown immediately.\n* When a new session is started, reset session launch time. This will make IAM with session time trigger and redisplay work properly", "committedDate": "2020-09-28T17:59:36Z", "type": "forcePushed"}, {"oid": "1e74e3c05c98b91b242d9a31246a303f26ed2354", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/1e74e3c05c98b91b242d9a31246a303f26ed2354", "message": "Reset dynamic session launch time\n\n* If the user puts the app on the background and opens the app after 30 seconds, on a new session, the session launch time was not being reset and due to that IAM with redisplay was being shown immediately.\n* When a new session is started, reset session launch time. This will make IAM with session time trigger and redisplay work properly\n* Refactor IAM Controller getController to avoid static reference", "committedDate": "2020-09-28T17:59:58Z", "type": "commit"}, {"oid": "1e74e3c05c98b91b242d9a31246a303f26ed2354", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/1e74e3c05c98b91b242d9a31246a303f26ed2354", "message": "Reset dynamic session launch time\n\n* If the user puts the app on the background and opens the app after 30 seconds, on a new session, the session launch time was not being reset and due to that IAM with redisplay was being shown immediately.\n* When a new session is started, reset session launch time. This will make IAM with session time trigger and redisplay work properly\n* Refactor IAM Controller getController to avoid static reference", "committedDate": "2020-09-28T17:59:58Z", "type": "forcePushed"}]}