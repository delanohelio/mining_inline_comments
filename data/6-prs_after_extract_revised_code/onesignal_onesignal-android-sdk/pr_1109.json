{"pr_number": 1109, "pr_title": "Fix SQLiteDatabaseLockedException", "pr_createdAt": "2020-08-04T16:18:56Z", "pr_url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1109", "timeline": [{"oid": "e8c6fed8cf701d233a6990e7f07fd8aa47631fb3", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/e8c6fed8cf701d233a6990e7f07fd8aa47631fb3", "message": "Fix SQLiteDatabaseLockedException\n\n  * Synchronize database due to differents threads trying to modify database\n  * Remove database access from other classes that are not OneSignalDBHelper\n  * Create query, insert, update, delete methods on OneSignalDBHelper\n  * Make OneSignalDBHelper the only responsible of altering db", "committedDate": "2020-08-04T16:22:29Z", "type": "forcePushed"}, {"oid": "445f69ca51765a577e6e14b5410934dab88f104c", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/445f69ca51765a577e6e14b5410934dab88f104c", "message": "Fix SQLiteDatabaseLockedException\n\n  * Synchronize database due to differents threads trying to modify database\n  * Remove database access from other classes that are not OneSignalDBHelper\n  * Create query, insert, update, delete methods on OneSignalDBHelper\n  * Make OneSignalDBHelper the only responsible of altering db", "committedDate": "2020-08-04T16:25:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM1NzAzOQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1109#discussion_r465357039", "bodyText": "\ud83d\udc4d So much cleaner with the new dbHelper.update!", "author": "jkasten2", "createdAt": "2020-08-04T22:06:42Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/NotificationBundleProcessor.java", "diffHunk": "@@ -252,31 +238,12 @@ static void markRestoredNotificationAsDismissed(NotificationGenerationJob notifi\n       String whereStr = NotificationTable.COLUMN_NAME_ANDROID_NOTIFICATION_ID + \" = \" + notifiJob.getAndroidIdWithoutCreate();\n \n       OneSignalDbHelper dbHelper = OneSignalDbHelper.getInstance(notifiJob.context);\n-      SQLiteDatabase writableDb = null;\n-\n-      try {\n-         writableDb = dbHelper.getSQLiteDatabaseWithRetries();\n-         writableDb.beginTransaction();\n \n-         ContentValues values = new ContentValues();\n-         values.put(NotificationTable.COLUMN_NAME_DISMISSED, 1);\n+      ContentValues values = new ContentValues();\n+      values.put(NotificationTable.COLUMN_NAME_DISMISSED, 1);\n \n-         writableDb.update(NotificationTable.TABLE_NAME, values, whereStr, null);\n-         BadgeCountUpdater.update(writableDb, notifiJob.context);\n-\n-         writableDb.setTransactionSuccessful();\n-\n-      } catch (Exception e) {\n-         OneSignal.Log(OneSignal.LOG_LEVEL.ERROR, \"Error saving notification record! \", e);\n-      } finally {\n-         if (writableDb != null) {\n-            try {\n-               writableDb.endTransaction(); // May throw if transaction was never opened or DB is full.\n-            } catch (Throwable t) {\n-               OneSignal.Log(OneSignal.LOG_LEVEL.ERROR, \"Error closing transaction! \", t);\n-            }\n-         }\n-      }\n+      dbHelper.update(NotificationTable.TABLE_NAME, values, whereStr, null);", "originalCommit": "445f69ca51765a577e6e14b5410934dab88f104c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM4NDU4Ng==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1109#discussion_r465384586", "bodyText": "Let's add @nonnull and @nullable where it makes sense to these.", "author": "jkasten2", "createdAt": "2020-08-04T23:25:23Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalDb.java", "diffHunk": "@@ -1,9 +1,25 @@\n package com.onesignal;\n \n-import android.database.sqlite.SQLiteDatabase;\n+import android.content.ContentValues;\n+import android.database.Cursor;\n+import android.database.SQLException;\n \n public interface OneSignalDb {\n \n-    SQLiteDatabase getSQLiteDatabaseWithRetries();\n+    Cursor query(String table, String[] columns, String selection,", "originalCommit": "445f69ca51765a577e6e14b5410934dab88f104c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b74fc8b31c5810c9fe8399988eddc6a8fcddb6df", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalDb.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalDb.java\nindex 274f3f6b..d8d35416 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalDb.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalDb.java\n\n@@ -3,23 +3,25 @@ package com.onesignal;\n import android.content.ContentValues;\n import android.database.Cursor;\n import android.database.SQLException;\n+import android.support.annotation.NonNull;\n+import android.support.annotation.Nullable;\n \n public interface OneSignalDb {\n \n-    Cursor query(String table, String[] columns, String selection,\n-                        String[] selectionArgs, String groupBy, String having,\n-                        String orderBy);\n+    Cursor query(@NonNull String table, @Nullable String[] columns, @Nullable String selection,\n+                 String[] selectionArgs, @Nullable String groupBy, @Nullable String having,\n+                 @Nullable String orderBy);\n \n-    Cursor query(String table, String[] columns, String selection,\n-                        String[] selectionArgs, String groupBy, String having,\n-                        String orderBy, String limit);\n+    Cursor query(@NonNull String table, @Nullable String[] columns, @Nullable String selection,\n+                 @Nullable String[] selectionArgs, @Nullable String groupBy, @Nullable String having,\n+                 @Nullable String orderBy, @Nullable String limit);\n \n-    void insert(String table, String nullColumnHack, ContentValues values);\n+    void insert(@NonNull String table, @Nullable String nullColumnHack, @Nullable ContentValues values);\n \n-    void insertOrThrow(String table, String nullColumnHack, ContentValues values)\n+    void insertOrThrow(@NonNull String table, @Nullable String nullColumnHack, @Nullable ContentValues values)\n             throws SQLException;\n \n-    int update(String table, ContentValues values, String whereClause, String[] whereArgs);\n+    int update(@NonNull String table, @NonNull ContentValues values, @Nullable String whereClause, @Nullable String[] whereArgs);\n \n-    void delete(String table, String whereClause, String[] whereArgs);\n+    void delete(@NonNull String table, @Nullable String whereClause, @Nullable String[] whereArgs);\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM4NjI1MQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1109#discussion_r465386251", "bodyText": "We might want to omit the formatting space fixes in this PR since this is going to into master. This way we can avoid extra conflicts this could created with the 4.0.0 branch.", "author": "jkasten2", "createdAt": "2020-08-04T23:30:38Z", "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/GenerateNotificationRunner.java", "diffHunk": "@@ -144,13 +143,12 @@\n         },\n         sdk = 21\n )\n-\n @RunWith(RobolectricTestRunner.class)\n public class GenerateNotificationRunner {\n-   \n+", "originalCommit": "445f69ca51765a577e6e14b5410934dab88f104c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTgzMDU1OQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1109#discussion_r465830559", "bodyText": "Oh you are right, good catch!", "author": "Jeasmine", "createdAt": "2020-08-05T15:55:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM4NjI1MQ=="}], "type": "inlineReview", "revised_code": {"commit": "b74fc8b31c5810c9fe8399988eddc6a8fcddb6df", "chunk": "diff --git a/OneSignalSDK/unittest/src/test/java/com/test/onesignal/GenerateNotificationRunner.java b/OneSignalSDK/unittest/src/test/java/com/test/onesignal/GenerateNotificationRunner.java\nindex c0b8bb93..afcb5b12 100644\n--- a/OneSignalSDK/unittest/src/test/java/com/test/onesignal/GenerateNotificationRunner.java\n+++ b/OneSignalSDK/unittest/src/test/java/com/test/onesignal/GenerateNotificationRunner.java\n\n@@ -145,10 +146,10 @@ import static org.robolectric.Shadows.shadowOf;\n )\n @RunWith(RobolectricTestRunner.class)\n public class GenerateNotificationRunner {\n-\n+   \n    private Activity blankActivity;\n    private static ActivityController<BlankActivity> blankActivityController;\n-\n+   \n    private static final String notifMessage = \"Robo test message\";\n \n    private MockOneSignalDBHelper dbHelper;\n"}}, {"oid": "b74fc8b31c5810c9fe8399988eddc6a8fcddb6df", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/b74fc8b31c5810c9fe8399988eddc6a8fcddb6df", "message": "Fix SQLiteDatabaseLockedException\n\n  * Synchronize database due to differents threads trying to modify database\n  * Remove database access from other classes that are not OneSignalDBHelper\n  * Create query, insert, update, delete methods on OneSignalDBHelper\n  * Make OneSignalDBHelper the only responsible of altering db", "committedDate": "2020-08-05T22:01:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA4NzkxMw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1109#discussion_r467087913", "bodyText": "We should replace this getWritableDatabase() with getSQLiteDatabase() so that we have Exceptions as fallbacks\nAlso should we use getSQLiteDatabaseWithRetries() instead of getSQLiteDatabase()?", "author": "mikechoch", "createdAt": "2020-08-07T14:47:25Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalDbHelper.java", "diffHunk": "@@ -152,16 +163,120 @@ synchronized SQLiteDatabase getSQLiteDatabase() {\n     * <br/><br/>\n     * @see OneSignalDbHelper#getSQLiteDatabase()\n     */\n+   private SQLiteDatabase getSQLiteDatabaseWithRetries() {\n+      synchronized (LOCK) {\n+         int count = 0;\n+         while (true) {\n+            try {\n+               return getWritableDatabase();\n+            } catch (SQLiteCantOpenDatabaseException | SQLiteDatabaseLockedException e) {\n+               if (++count >= DB_OPEN_RETRY_MAX)\n+                  throw e;\n+               SystemClock.sleep(count * DB_OPEN_RETRY_BACKOFF);\n+            }\n+         }\n+      }\n+   }\n+\n+   @Override\n+   public Cursor query(String table, String[] columns, String selection,\n+                       String[] selectionArgs, String groupBy, String having,\n+                       String orderBy) {\n+      synchronized (LOCK) {\n+         return getWritableDatabase().query(table, columns, selection, selectionArgs, groupBy, having, orderBy);", "originalCommit": "b74fc8b31c5810c9fe8399988eddc6a8fcddb6df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY1MDA3Ng==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1109#discussion_r467650076", "bodyText": "\ud83d\udc4d getSQLiteDatabaseWithRetries() is what I would recommend too. Looks like this was changed so marking as resolved.", "author": "jkasten2", "createdAt": "2020-08-10T00:43:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA4NzkxMw=="}], "type": "inlineReview", "revised_code": {"commit": "f6bd2853b13e8fc10502d814cb10e6b0d6bccae3", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalDbHelper.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalDbHelper.java\nindex da774892..eb9f9599 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalDbHelper.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalDbHelper.java\n\n@@ -168,7 +170,7 @@ class OneSignalDbHelper extends SQLiteOpenHelper implements OneSignalDb {\n          int count = 0;\n          while (true) {\n             try {\n-               return getWritableDatabase();\n+               return getSQLiteDatabase();\n             } catch (SQLiteCantOpenDatabaseException | SQLiteDatabaseLockedException e) {\n                if (++count >= DB_OPEN_RETRY_MAX)\n                   throw e;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA4Nzk3NQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1109#discussion_r467087975", "bodyText": "We should replace this getWritableDatabase() with getSQLiteDatabase() so that we have Exceptions as fallbacks\nAlso should we use getSQLiteDatabaseWithRetries() instead of getSQLiteDatabase()?", "author": "mikechoch", "createdAt": "2020-08-07T14:47:32Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalDbHelper.java", "diffHunk": "@@ -152,16 +163,120 @@ synchronized SQLiteDatabase getSQLiteDatabase() {\n     * <br/><br/>\n     * @see OneSignalDbHelper#getSQLiteDatabase()\n     */\n+   private SQLiteDatabase getSQLiteDatabaseWithRetries() {\n+      synchronized (LOCK) {\n+         int count = 0;\n+         while (true) {\n+            try {\n+               return getWritableDatabase();\n+            } catch (SQLiteCantOpenDatabaseException | SQLiteDatabaseLockedException e) {\n+               if (++count >= DB_OPEN_RETRY_MAX)\n+                  throw e;\n+               SystemClock.sleep(count * DB_OPEN_RETRY_BACKOFF);\n+            }\n+         }\n+      }\n+   }\n+\n+   @Override\n+   public Cursor query(String table, String[] columns, String selection,\n+                       String[] selectionArgs, String groupBy, String having,\n+                       String orderBy) {\n+      synchronized (LOCK) {\n+         return getWritableDatabase().query(table, columns, selection, selectionArgs, groupBy, having, orderBy);\n+      }\n+   }\n+\n+   @Override\n+   public Cursor query(String table, String[] columns, String selection, String[] selectionArgs, String groupBy, String having, String orderBy, String limit) {\n+      synchronized (LOCK) {\n+         return getWritableDatabase().query(table, columns, selection, selectionArgs, groupBy, having, orderBy, limit);", "originalCommit": "b74fc8b31c5810c9fe8399988eddc6a8fcddb6df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIxNDU2MQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1109#discussion_r467214561", "bodyText": "good catch!", "author": "Jeasmine", "createdAt": "2020-08-07T18:54:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA4Nzk3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY1MDE5MQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1109#discussion_r467650191", "bodyText": "Confirmed this was fix, marking as resolved.", "author": "jkasten2", "createdAt": "2020-08-10T00:44:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA4Nzk3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "f6bd2853b13e8fc10502d814cb10e6b0d6bccae3", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalDbHelper.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalDbHelper.java\nindex da774892..eb9f9599 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalDbHelper.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalDbHelper.java\n\n@@ -168,7 +170,7 @@ class OneSignalDbHelper extends SQLiteOpenHelper implements OneSignalDb {\n          int count = 0;\n          while (true) {\n             try {\n-               return getWritableDatabase();\n+               return getSQLiteDatabase();\n             } catch (SQLiteCantOpenDatabaseException | SQLiteDatabaseLockedException e) {\n                if (++count >= DB_OPEN_RETRY_MAX)\n                   throw e;\n"}}, {"oid": "f6bd2853b13e8fc10502d814cb10e6b0d6bccae3", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/f6bd2853b13e8fc10502d814cb10e6b0d6bccae3", "message": "Fix SQLiteDatabaseLockedException\n\n  * Synchronize database due to differents threads trying to modify database\n  * Remove database access from other classes that are not OneSignalDBHelper\n  * Create query, insert, update, delete methods on OneSignalDBHelper\n  * Make OneSignalDBHelper the only responsible of altering db", "committedDate": "2020-08-07T18:56:06Z", "type": "commit"}, {"oid": "f6bd2853b13e8fc10502d814cb10e6b0d6bccae3", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/f6bd2853b13e8fc10502d814cb10e6b0d6bccae3", "message": "Fix SQLiteDatabaseLockedException\n\n  * Synchronize database due to differents threads trying to modify database\n  * Remove database access from other classes that are not OneSignalDBHelper\n  * Create query, insert, update, delete methods on OneSignalDBHelper\n  * Make OneSignalDBHelper the only responsible of altering db", "committedDate": "2020-08-07T18:56:06Z", "type": "forcePushed"}]}