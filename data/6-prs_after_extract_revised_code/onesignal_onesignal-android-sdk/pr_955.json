{"pr_number": 955, "pr_title": "Add unattributed outcome and unique outcome for IAM click", "pr_createdAt": "2020-02-18T02:24:14Z", "pr_url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/955", "timeline": [{"oid": "ca78e1c7fa847da30e9d06739f910a3fa9d113eb", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/ca78e1c7fa847da30e9d06739f910a3fa9d113eb", "message": "Add unattributed outcome for IAM click\n\n  * Add send outcome and unique outcome for button and image click\n  * Add test for new case", "committedDate": "2020-02-20T22:04:38Z", "type": "forcePushed"}, {"oid": "f7191f308a6b6e922692e3dc59c88e2b77463d26", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/f7191f308a6b6e922692e3dc59c88e2b77463d26", "message": "Add unattributed outcome for IAM click\n\n  * Add send outcome and unique outcome for button and image click\n  * Add test for new case", "committedDate": "2020-02-21T18:58:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY3Mzk3Mw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/955#discussion_r386673973", "bodyText": "Commented on iOS about this, remove sendUniqueClickActionOutcomeEvent and sendClickActionOutcomeWithValue and use this if statement that reuses our outcome public methods\nif (action.outcome == null && action.outcome.getName().isEmpty())\n    return;\n\nOSInAppMessageOutcome outcome = action.outcome;\nif (outcome.isUnique()) {\n    OneSignal.sendUniqueOutcome(outcome.getName());\n} else if (outcome.getWeight() > 0) {\n    OneSignal.sendOutcomeWithValue(outcome.getName(), outcome.getWeight());\n} else {\n    OneSignal.sendOutcome(outcome.getName());\n}", "author": "mikechoch", "createdAt": "2020-03-02T21:54:41Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -229,23 +229,36 @@ void onFailure(int statusCode, String response, Throwable throwable) {\n         }\n     }\n \n-    void onMessageActionOccurredOnMessage(@NonNull final OSInAppMessage message, @NonNull final JSONObject actionJson) {\n+    void onMessageActionOccurredOnMessage(@NonNull final OSInAppMessage message, @NonNull final JSONObject actionJson) throws JSONException {\n         final OSInAppMessageAction action = new OSInAppMessageAction(actionJson);\n         action.firstClick = message.takeActionAsUnique();\n \n         firePublicClickHandler(action);\n         fireClickAction(action);\n         fireRESTCallForClick(message, action);\n+        fireOutcomeForClick(action);\n     }\n \n-    void onMessageActionOccurredOnPreview(@NonNull final OSInAppMessage message, @NonNull final JSONObject actionJson) {\n+    void onMessageActionOccurredOnPreview(@NonNull final OSInAppMessage message, @NonNull final JSONObject actionJson) throws JSONException {\n         final OSInAppMessageAction action = new OSInAppMessageAction(actionJson);\n         action.firstClick = message.takeActionAsUnique();\n \n         firePublicClickHandler(action);\n         fireClickAction(action);\n     }\n \n+    private void fireOutcomeForClick(@NonNull final OSInAppMessageAction action) {\n+        if (action.outcome != null && !action.outcome.getName().isEmpty()) {\n+            OSInAppMessageOutcome outcome = action.outcome;\n+\n+            if (outcome.isUnique()) {\n+                OneSignal.sendUniqueClickActionOutcomeEvent(outcome.getName());\n+            } else {\n+                OneSignal.sendClickActionOutcomeWithValue(outcome.getName(), outcome.getWeight() > 0 ? (float) outcome.getWeight() : 0);\n+            }", "originalCommit": "f7191f308a6b6e922692e3dc59c88e2b77463d26", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d73334ea3090bd563e0e8db85c91d399a21aa247", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\nindex ce4c1ade..424ba480 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n\n@@ -247,14 +247,19 @@ class OSInAppMessageController implements OSDynamicTriggerControllerObserver, OS\n         fireClickAction(action);\n     }\n \n+    //TODO This is a temporal solution for IAMs outcomes\n+    //     and will potentially change when we track IAMs\n     private void fireOutcomeForClick(@NonNull final OSInAppMessageAction action) {\n         if (action.outcome != null && !action.outcome.getName().isEmpty()) {\n             OSInAppMessageOutcome outcome = action.outcome;\n+            String name = outcome.getName();\n \n             if (outcome.isUnique()) {\n-                OneSignal.sendUniqueClickActionOutcomeEvent(outcome.getName());\n+                OneSignal.sendUniqueClickActionOutcomeEvent(name);\n+            } else if (outcome.getWeight() > 0) {\n+                OneSignal.sendClickActionOutcomeWithValue(name, outcome.getWeight());\n             } else {\n-                OneSignal.sendClickActionOutcomeWithValue(outcome.getName(), outcome.getWeight() > 0 ? (float) outcome.getWeight() : 0);\n+                OneSignal.sendClickActionOutcome(name);\n             }\n         }\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY3NTU2Ng==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/955#discussion_r386675566", "bodyText": "remove this", "author": "mikechoch", "createdAt": "2020-03-02T21:57:58Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignal.java", "diffHunk": "@@ -3110,6 +3119,15 @@ public static void sendOutcome(@NonNull String name, OutcomeCallback callback) {\n       outcomeEventsController.sendOutcomeEvent(name, callback);\n    }\n \n+   static void sendUniqueClickActionOutcomeEvent(@NonNull String name) {", "originalCommit": "f7191f308a6b6e922692e3dc59c88e2b77463d26", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI0MTgwNw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/955#discussion_r387241807", "bodyText": "actually i need this, is for differentiate a common outcome from an IAM outcome, for the time being we are making all unattributed. If you look on the OutcomeVentsController there is sendUniqueClickOutcomeEvent and sendClickOutcomeEventWithValue that work with the getIAMSessionResult().\nAfter all IAM stuff is made this will be remove. Do you want me to put a comment regarding this?", "author": "Jeasmine", "createdAt": "2020-03-03T19:25:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY3NTU2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "fbce453ea86a3a267cea26a26b667a552abe7e3c", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignal.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignal.java\nindex 46c2c085..8e6e0697 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignal.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignal.java\n\n@@ -3119,7 +3127,7 @@ public class OneSignal {\n       outcomeEventsController.sendOutcomeEvent(name, callback);\n    }\n \n-   static void sendUniqueClickActionOutcomeEvent(@NonNull String name) {\n+   static void sendClickActionUniqueOutcome(@NonNull String name) {\n       if (outcomeEventsController == null) {\n          OneSignal.Log(LOG_LEVEL.ERROR, \"Make sure OneSignal.init is called first\");\n          return;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY3NTU3MA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/955#discussion_r386675570", "bodyText": "remove this", "author": "mikechoch", "createdAt": "2020-03-02T21:57:59Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignal.java", "diffHunk": "@@ -3094,6 +3094,15 @@ static OSSessionManager getSessionManager() {\n       return sessionManager;\n    }\n \n+   static void sendClickActionOutcomeWithValue(@NonNull String name, float value) {", "originalCommit": "f7191f308a6b6e922692e3dc59c88e2b77463d26", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI0MTg4OQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/955#discussion_r387241889", "bodyText": "idem", "author": "Jeasmine", "createdAt": "2020-03-03T19:25:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY3NTU3MA=="}], "type": "inlineReview", "revised_code": {"commit": "d73334ea3090bd563e0e8db85c91d399a21aa247", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignal.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignal.java\nindex 46c2c085..c9652d78 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignal.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignal.java\n\n@@ -3094,6 +3094,10 @@ public class OneSignal {\n       return sessionManager;\n    }\n \n+   static void sendClickActionOutcome(@NonNull String name) {\n+      sendClickActionOutcomeWithValue(name, 0);\n+   }\n+\n    static void sendClickActionOutcomeWithValue(@NonNull String name, float value) {\n       if (outcomeEventsController == null) {\n          OneSignal.Log(LOG_LEVEL.ERROR, \"Make sure OneSignal.init is called first\");\n"}}, {"oid": "d73334ea3090bd563e0e8db85c91d399a21aa247", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/d73334ea3090bd563e0e8db85c91d399a21aa247", "message": "Add unattributed outcome for IAM click\n\n  * Add send outcome and unique outcome for button and image click\n  * Add test for new case", "committedDate": "2020-03-04T00:14:49Z", "type": "forcePushed"}, {"oid": "c99abc950e3f76513d443aef1a01d6e1406079d4", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/c99abc950e3f76513d443aef1a01d6e1406079d4", "message": "Add unattributed outcomes for IAM click\n\n  * Add send outcomes and unique outcomes for button and image click\n  * Add test for new case", "committedDate": "2020-03-04T00:32:46Z", "type": "forcePushed"}, {"oid": "566814d4efa6572ea4a9f2a1b194d3d1b42c088a", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/566814d4efa6572ea4a9f2a1b194d3d1b42c088a", "message": "Add unattributed outcomes for IAM click\n\n  * Add send outcomes and unique outcomes for button and image click\n  * Add test for new case", "committedDate": "2020-03-04T00:40:40Z", "type": "forcePushed"}, {"oid": "cc017af930067e09934953c10a2c55a87a128790", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/cc017af930067e09934953c10a2c55a87a128790", "message": "Add unattributed outcomes for IAM click\n\n  * Add send outcomes and unique outcomes for button and image click\n  * Add test for new case", "committedDate": "2020-03-04T00:42:21Z", "type": "forcePushed"}, {"oid": "ae23673a520feece25cfedee477dce842a577307", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/ae23673a520feece25cfedee477dce842a577307", "message": "Add unattributed outcomes for IAM click\n\n  * Add send outcomes and unique outcomes for button and image click\n  * Add test for new case", "committedDate": "2020-03-04T00:50:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQwNjIzNA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/955#discussion_r387406234", "bodyText": "Lets keep all of the name as consistent as possible:\nsendClickActionUniqueOutcome\nsendClickActionOutcomeWithValue\nsendClickActionOutcome", "author": "mikechoch", "createdAt": "2020-03-04T01:50:31Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -267,23 +267,40 @@ void onFailure(int statusCode, String response, Throwable throwable) {\n         }\n     }\n \n-    void onMessageActionOccurredOnMessage(@NonNull final OSInAppMessage message, @NonNull final JSONObject actionJson) {\n+    void onMessageActionOccurredOnMessage(@NonNull final OSInAppMessage message, @NonNull final JSONObject actionJson) throws JSONException {\n         final OSInAppMessageAction action = new OSInAppMessageAction(actionJson);\n         action.firstClick = message.takeActionAsUnique();\n \n         firePublicClickHandler(action);\n         fireClickAction(action);\n         fireRESTCallForClick(message, action);\n+        fireOutcomeForClick(action);\n     }\n \n-    void onMessageActionOccurredOnPreview(@NonNull final OSInAppMessage message, @NonNull final JSONObject actionJson) {\n+    void onMessageActionOccurredOnPreview(@NonNull final OSInAppMessage message, @NonNull final JSONObject actionJson) throws JSONException {\n         final OSInAppMessageAction action = new OSInAppMessageAction(actionJson);\n         action.firstClick = message.takeActionAsUnique();\n \n         firePublicClickHandler(action);\n         fireClickAction(action);\n     }\n \n+    //TODO This is a temporal solution for IAMs outcomes\n+    //     and will potentially change when we track IAMs\n+    private void fireOutcomeForClick(@NonNull final OSInAppMessageAction action) {\n+        for (OSInAppMessageOutcome outcome : action.outcomes) {\n+            String name = outcome.getName();\n+\n+            if (outcome.isUnique()) {\n+                OneSignal.sendUniqueClickActionOutcomeEvent(name);\n+            } else if (outcome.getWeight() > 0) {\n+                OneSignal.sendClickActionOutcomeWithValue(name, outcome.getWeight());\n+            } else {\n+                OneSignal.sendClickActionOutcome(name);", "originalCommit": "ae23673a520feece25cfedee477dce842a577307", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fbce453ea86a3a267cea26a26b667a552abe7e3c", "chunk": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\nindex b03971e4..b6fa2328 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n\n@@ -292,7 +292,7 @@ class OSInAppMessageController implements OSDynamicTriggerControllerObserver, OS\n             String name = outcome.getName();\n \n             if (outcome.isUnique()) {\n-                OneSignal.sendUniqueClickActionOutcomeEvent(name);\n+                OneSignal.sendClickActionUniqueOutcome(name);\n             } else if (outcome.getWeight() > 0) {\n                 OneSignal.sendClickActionOutcomeWithValue(name, outcome.getWeight());\n             } else {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQwNzM3MA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/955#discussion_r387407370", "bodyText": "Lets have 4 separate tests:\n\nNormal outcomes\nWeight outcomes\nUnique outcomes\nMulti outcomes", "author": "mikechoch", "createdAt": "2020-03-04T01:54:40Z", "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/InAppMessageIntegrationTests.java", "diffHunk": "@@ -474,6 +477,137 @@ public void testInAppMessageOnlyReceivesClickIdOnce() throws Exception {\n         assertEquals(1, testClickedMessages.size());\n     }\n \n+    @Test\n+    public void testInAppMessageClickActionOutcome() throws Exception {", "originalCommit": "ae23673a520feece25cfedee477dce842a577307", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fbce453ea86a3a267cea26a26b667a552abe7e3c", "chunk": "diff --git a/OneSignalSDK/unittest/src/test/java/com/test/onesignal/InAppMessageIntegrationTests.java b/OneSignalSDK/unittest/src/test/java/com/test/onesignal/InAppMessageIntegrationTests.java\nindex c219ef29..9d191a4b 100644\n--- a/OneSignalSDK/unittest/src/test/java/com/test/onesignal/InAppMessageIntegrationTests.java\n+++ b/OneSignalSDK/unittest/src/test/java/com/test/onesignal/InAppMessageIntegrationTests.java\n\n@@ -498,6 +498,93 @@ public class InAppMessageIntegrationTests {\n                 null\n         );\n \n+        final JSONArray outcomes = new JSONArray();\n+        outcomes.put(new JSONObject() {{\n+            put(\"name\", IAM_OUTCOME_NAME);\n+        }});\n+        JSONObject action = new JSONObject() {{\n+            put(\"id\", IAM_CLICK_ID);\n+            put(\"outcomes\", outcomes);\n+        }};\n+\n+        OSInAppMessageController.getController().onMessageActionOccurredOnMessage(message, action);\n+\n+        // 3. Ensure outcome is sent\n+        ShadowOneSignalRestClient.Request iamOutcomeRequest = ShadowOneSignalRestClient.requests.get(3);\n+\n+        assertEquals(\"outcomes/measure\", iamOutcomeRequest.url);\n+        // Requests: Param request + Players Request + Click request + Outcome Request\n+        assertEquals(4, ShadowOneSignalRestClient.requests.size());\n+        assertFalse(iamOutcomeRequest.payload.has(\"weight\"));\n+        assertEquals(IAM_OUTCOME_NAME, iamOutcomeRequest.payload.get(\"id\"));\n+        assertEquals(1, iamOutcomeRequest.payload.get(\"device_type\"));\n+    }\n+\n+    @Test\n+    public void testInAppMessageClickActionOutcomeWithValue() throws Exception {\n+        // 1. Init OneSignal\n+        OneSignalInit();\n+        threadAndTaskWait();\n+\n+        // Enable Outcomes\n+        OneSignalPackagePrivateHelper.OneSignalPrefs.saveBool(\n+                OneSignalPackagePrivateHelper.OneSignalPrefs.PREFS_ONESIGNAL,\n+                OneSignalPackagePrivateHelper.OneSignalPrefs.PREFS_OS_UNATTRIBUTED_ENABLED,\n+                true\n+        );\n+\n+        // 2. Create an IAM\n+        final OSTestInAppMessage message = InAppMessagingHelpers.buildTestMessageWithSingleTrigger(\n+                OSTriggerKind.SESSION_TIME,\n+                null,\n+                OSTestTrigger.OSTriggerOperator.NOT_EXISTS.toString(),\n+                null\n+        );\n+\n+        final JSONArray outcomesWithWeight = new JSONArray();\n+        outcomesWithWeight.put(new JSONObject() {{\n+            put(\"name\", IAM_OUTCOME_NAME);\n+            put(\"weight\", IAM_OUTCOME_WEIGHT);\n+        }});\n+        JSONObject actionWithWeight = new JSONObject() {{\n+            put(\"id\", IAM_CLICK_ID);\n+            put(\"outcomes\", outcomesWithWeight);\n+        }};\n+\n+        OSInAppMessageController.getController().onMessageActionOccurredOnMessage(message, actionWithWeight);\n+\n+        // 3. Ensure outcome is sent\n+        ShadowOneSignalRestClient.Request iamOutcomeRequest = ShadowOneSignalRestClient.requests.get(3);\n+\n+        assertEquals(\"outcomes/measure\", iamOutcomeRequest.url);\n+        // Requests: Param request + Players Request + Click request + Outcome Request\n+        assertEquals(4, ShadowOneSignalRestClient.requests.size());\n+        assertEquals(IAM_OUTCOME_WEIGHT, iamOutcomeRequest.payload.get(\"weight\"));\n+        assertEquals(IAM_OUTCOME_NAME, iamOutcomeRequest.payload.get(\"id\"));\n+        assertEquals(1, iamOutcomeRequest.payload.get(\"device_type\"));\n+    }\n+\n+    @Test\n+    public void testInAppMessageClickActionMultipleOutcomes() throws Exception {\n+        // 1. Init OneSignal\n+        OneSignalInit();\n+        threadAndTaskWait();\n+\n+        // Enable Outcomes\n+        OneSignalPackagePrivateHelper.OneSignalPrefs.saveBool(\n+                OneSignalPackagePrivateHelper.OneSignalPrefs.PREFS_ONESIGNAL,\n+                OneSignalPackagePrivateHelper.OneSignalPrefs.PREFS_OS_UNATTRIBUTED_ENABLED,\n+                true\n+        );\n+\n+        // 2. Create an IAM\n+        final OSTestInAppMessage message = InAppMessagingHelpers.buildTestMessageWithSingleTrigger(\n+                OSTriggerKind.SESSION_TIME,\n+                null,\n+                OSTestTrigger.OSTriggerOperator.NOT_EXISTS.toString(),\n+                null\n+        );\n+\n         final JSONArray outcomesWithWeight = new JSONArray();\n         outcomesWithWeight.put(new JSONObject() {{\n             put(\"name\", IAM_OUTCOME_NAME);\n"}}, {"oid": "fbce453ea86a3a267cea26a26b667a552abe7e3c", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/fbce453ea86a3a267cea26a26b667a552abe7e3c", "message": "Add unattributed outcomes for IAM click\n\n  * Add send outcomes and unique outcomes for button and image click\n  * Add test for new case", "committedDate": "2020-03-04T02:04:01Z", "type": "forcePushed"}, {"oid": "1a3f56b1cb38f6cabf126060a18b0767de6b6478", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/1a3f56b1cb38f6cabf126060a18b0767de6b6478", "message": "Add unattributed outcomes for IAM click\n\n  * Add send outcomes and unique outcomes for button and image click\n  * Add test for new case", "committedDate": "2020-03-04T19:05:16Z", "type": "forcePushed"}, {"oid": "f3f9aac4d4f366aeebaeb31ca9f06e7a4491246c", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/f3f9aac4d4f366aeebaeb31ca9f06e7a4491246c", "message": "Add unattributed outcomes for IAM click\n\n  * Add send outcomes and unique outcomes for button and image click\n  * Add test for new case", "committedDate": "2020-03-04T19:38:59Z", "type": "commit"}, {"oid": "f3f9aac4d4f366aeebaeb31ca9f06e7a4491246c", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/f3f9aac4d4f366aeebaeb31ca9f06e7a4491246c", "message": "Add unattributed outcomes for IAM click\n\n  * Add send outcomes and unique outcomes for button and image click\n  * Add test for new case", "committedDate": "2020-03-04T19:38:59Z", "type": "forcePushed"}]}