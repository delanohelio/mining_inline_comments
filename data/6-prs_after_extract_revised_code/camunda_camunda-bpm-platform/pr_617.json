{"pr_number": 617, "pr_title": "[CAM-10378] feat(engine): add id of failed activity to job", "pr_createdAt": "2020-01-10T13:26:06Z", "pr_url": "https://github.com/camunda/camunda-bpm-platform/pull/617", "timeline": [{"oid": "ea2c5d10e675f894d062942c0c012df265c16fb6", "url": "https://github.com/camunda/camunda-bpm-platform/commit/ea2c5d10e675f894d062942c0c012df265c16fb6", "message": "merge ProcessDataContext and ProcessDataLoggingContext\n\n* handle internal properties correctly\n  when disabled in logging configuration", "committedDate": "2020-01-14T09:53:39Z", "type": "forcePushed"}, {"oid": "2c46be093c683e16f2132928213234d4f7f25c54", "url": "https://github.com/camunda/camunda-bpm-platform/commit/2c46be093c683e16f2132928213234d4f7f25c54", "message": "* rename ProcessDataLoggingContext to ProcessDataContext", "committedDate": "2020-01-14T12:18:50Z", "type": "forcePushed"}, {"oid": "8676b1f422671595e2a4d02c2ea9e08821c33e17", "url": "https://github.com/camunda/camunda-bpm-platform/commit/8676b1f422671595e2a4d02c2ea9e08821c33e17", "message": "* rename ProcessDataLoggingContext to ProcessDataContext", "committedDate": "2020-01-14T13:06:42Z", "type": "forcePushed"}, {"oid": "8cca25185bb61b100ff18fde9a5cdb23f24510d3", "url": "https://github.com/camunda/camunda-bpm-platform/commit/8cca25185bb61b100ff18fde9a5cdb23f24510d3", "message": "feat(engine): add id of failed activity to job\n\nrelated to CAM-10378", "committedDate": "2020-01-15T08:08:48Z", "type": "commit"}, {"oid": "ee2747afb9baa9f88438a0baea4f78a1df5a0b40", "url": "https://github.com/camunda/camunda-bpm-platform/commit/ee2747afb9baa9f88438a0baea4f78a1df5a0b40", "message": "* rename ProcessDataLoggingContext to ProcessDataContext", "committedDate": "2020-01-15T08:08:49Z", "type": "forcePushed"}, {"oid": "ed41ac6f09a9dd4c1927ec84ddebafb2c45f1415", "url": "https://github.com/camunda/camunda-bpm-platform/commit/ed41ac6f09a9dd4c1927ec84ddebafb2c45f1415", "message": "* rename ProcessDataLoggingContext to ProcessDataContext", "committedDate": "2020-01-15T11:41:55Z", "type": "commit"}, {"oid": "ed41ac6f09a9dd4c1927ec84ddebafb2c45f1415", "url": "https://github.com/camunda/camunda-bpm-platform/commit/ed41ac6f09a9dd4c1927ec84ddebafb2c45f1415", "message": "* rename ProcessDataLoggingContext to ProcessDataContext", "committedDate": "2020-01-15T11:41:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM3NjYzOA==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/617#discussion_r367376638", "bodyText": "Since we're refactoring, should the fields be set to protected as per the code style?", "author": "koevskinikola", "createdAt": "2020-01-16T11:52:37Z", "path": "engine/src/main/java/org/camunda/bpm/engine/impl/interceptor/ProcessDataContext.java", "diffHunk": "@@ -0,0 +1,292 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH\n+ * under one or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information regarding copyright\n+ * ownership. Camunda licenses this file to you under the Apache License,\n+ * Version 2.0; you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.camunda.bpm.engine.impl.interceptor;\n+\n+import java.util.ArrayDeque;\n+import java.util.ArrayList;\n+import java.util.Deque;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.camunda.bpm.application.ProcessApplicationReference;\n+import org.camunda.bpm.engine.impl.cfg.ProcessEngineConfigurationImpl;\n+import org.camunda.bpm.engine.impl.context.Context;\n+import org.camunda.bpm.engine.impl.persistence.entity.ExecutionEntity;\n+import org.camunda.commons.logging.MdcAccess;\n+\n+/**\n+ * Holds the contextual process data.<br>\n+ *\n+ * New context properties are always part of a section that can be started by\n+ * {@link #pushSection(ExecutionEntity)}. The section keeps track of all pushed\n+ * properties. Those can easily be cleared by popping the section with\n+ * {@link #popSection()} afterwards, e.g. after the successful execution.<br>\n+ *\n+ * A property can be pushed to the logging context (MDC) if there is a configured\n+ * non-empty context name for it in the {@link ProcessEngineConfigurationImpl\n+ * process engine configuration}. The following configuration options are\n+ * available:\n+ * <ul>\n+ * <li>loggingContextActivityId - the context property for the activity id</li>\n+ * <li>loggingContextApplicationName - the context property for the application name</li>\n+ * <li>loggingContextBusinessKey - the context property for the business key</li>\n+ * <li>loggingContextDefinitionId - the context property for the definition id</li>\n+ * <li>loggingContextProcessInstanceId - the context property for the instance id</li>\n+ * <li>loggingContextTenantId - the context property for the tenant id</li>\n+ * </ul>\n+ */\n+public class ProcessDataContext {\n+\n+  private static final String NULL_VALUE = \"~NULL_VALUE~\";\n+\n+  public static final String PROPERTY_ACTIVITY_ID = \"activityId\";\n+\n+  private String mdcPropertyActivityId;", "originalCommit": "ed41ac6f09a9dd4c1927ec84ddebafb2c45f1415", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg1MDE2OQ==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/617#discussion_r367850169", "bodyText": "Absolutely! \ud83d\udc4d", "author": "tmetzke", "createdAt": "2020-01-17T09:50:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM3NjYzOA=="}], "type": "inlineReview", "revised_code": {"commit": "3b6fa7d96799396d367ca2aa2cf011aa959cc738", "chunk": "diff --git a/engine/src/main/java/org/camunda/bpm/engine/impl/interceptor/ProcessDataContext.java b/engine/src/main/java/org/camunda/bpm/engine/impl/interceptor/ProcessDataContext.java\nindex 958696627e..c0210633b9 100644\n--- a/engine/src/main/java/org/camunda/bpm/engine/impl/interceptor/ProcessDataContext.java\n+++ b/engine/src/main/java/org/camunda/bpm/engine/impl/interceptor/ProcessDataContext.java\n\n@@ -52,25 +52,25 @@ import org.camunda.commons.logging.MdcAccess;\n  */\n public class ProcessDataContext {\n \n-  private static final String NULL_VALUE = \"~NULL_VALUE~\";\n-\n   public static final String PROPERTY_ACTIVITY_ID = \"activityId\";\n \n-  private String mdcPropertyActivityId;\n-  private String mdcPropertyApplicationName;\n-  private String mdcPropertyBusinessKey;\n-  private String mdcPropertyDefinitionId;\n-  private String mdcPropertyInstanceId;\n-  private String mdcPropertyTenantId;\n+  protected static final String NULL_VALUE = \"~NULL_VALUE~\";\n+\n+  protected String mdcPropertyActivityId;\n+  protected String mdcPropertyApplicationName;\n+  protected String mdcPropertyBusinessKey;\n+  protected String mdcPropertyDefinitionId;\n+  protected String mdcPropertyInstanceId;\n+  protected String mdcPropertyTenantId;\n \n-  private List<String> mdcPropertyNames = new ArrayList<>();\n-  private Map<String, String> basicToMdcPropertyNames = new HashMap<>();\n-  private boolean handleMdc = false;\n+  protected List<String> mdcPropertyNames = new ArrayList<>();\n+  protected Map<String, String> basicToMdcPropertyNames = new HashMap<>();\n+  protected boolean handleMdc = false;\n \n-  private Map<String, Deque<String>> propertyValues = new HashMap<>();\n+  protected Map<String, Deque<String>> propertyValues = new HashMap<>();\n \n-  private boolean startNewSection = false;\n-  private Deque<List<String>> sections = new ArrayDeque<>();\n+  protected boolean startNewSection = false;\n+  protected Deque<List<String>> sections = new ArrayDeque<>();\n \n   public ProcessDataContext(ProcessEngineConfigurationImpl configuration) {\n     mdcPropertyActivityId = configuration.getLoggingContextActivityId();\n"}}, {"oid": "3b6fa7d96799396d367ca2aa2cf011aa959cc738", "url": "https://github.com/camunda/camunda-bpm-platform/commit/3b6fa7d96799396d367ca2aa2cf011aa959cc738", "message": "chore(engine): make fields protected", "committedDate": "2020-01-17T09:52:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIzNDAzOA==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/617#discussion_r368234038", "bodyText": "Why is named \"Last....\"? Isn't it so that an incident is created because of exactly one exception? Hence there will be exactly one activityId, and hence there will be no \"first\" or \"last\" one.", "author": "fml2", "createdAt": "2020-01-18T16:02:38Z", "path": "engine/src/main/java/org/camunda/bpm/engine/history/HistoricIncident.java", "diffHunk": "@@ -150,4 +150,9 @@\n \n   /** The time the historic incident will be removed. */\n   Date getRemovalTime();\n+\n+  /**\n+   * Returns the id of the activity on which the last exception occurred.\n+   */\n+  String getLastFailingActivityId();", "originalCommit": "3b6fa7d96799396d367ca2aa2cf011aa959cc738", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQwOTkyMg==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/617#discussion_r368409922", "bodyText": "Good point! Will rename that to failedActivityId() \ud83d\udc4d", "author": "tmetzke", "createdAt": "2020-01-20T08:06:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIzNDAzOA=="}], "type": "inlineReview", "revised_code": null}]}