{"pr_number": 714, "pr_title": "CAM-10978: historic variable without delay", "pr_createdAt": "2020-03-12T10:41:27Z", "pr_url": "https://github.com/camunda/camunda-bpm-platform/pull/714", "timeline": [{"oid": "59382711f6d7c741021e4fd8ac7652ae1fe313b3", "url": "https://github.com/camunda/camunda-bpm-platform/commit/59382711f6d7c741021e4fd8ac7652ae1fe313b3", "message": "wip", "committedDate": "2020-03-18T08:46:56Z", "type": "forcePushed"}, {"oid": "5baebb1f9330c95daf2b27242f2a1ad4ae828363", "url": "https://github.com/camunda/camunda-bpm-platform/commit/5baebb1f9330c95daf2b27242f2a1ad4ae828363", "message": "remove comment", "committedDate": "2020-03-18T13:12:55Z", "type": "forcePushed"}, {"oid": "84b9e51ac3bb27e489063e5d6f76d9d058a3618e", "url": "https://github.com/camunda/camunda-bpm-platform/commit/84b9e51ac3bb27e489063e5d6f76d9d058a3618e", "message": "wip", "committedDate": "2020-03-19T16:21:21Z", "type": "forcePushed"}, {"oid": "dd5e91212fcb6fe62e66276c8dcc20356a6fae75", "url": "https://github.com/camunda/camunda-bpm-platform/commit/dd5e91212fcb6fe62e66276c8dcc20356a6fae75", "message": "adjust mig tests", "committedDate": "2020-03-20T07:38:22Z", "type": "forcePushed"}, {"oid": "9d3e0cdd3f6d4217d0a41356f6674b5f7349048a", "url": "https://github.com/camunda/camunda-bpm-platform/commit/9d3e0cdd3f6d4217d0a41356f6674b5f7349048a", "message": "add legacy behavior method for 7.12 case without history", "committedDate": "2020-03-20T15:06:28Z", "type": "forcePushed"}, {"oid": "4bb74627738c0da2666fa9c58cc6020c31507b59", "url": "https://github.com/camunda/camunda-bpm-platform/commit/4bb74627738c0da2666fa9c58cc6020c31507b59", "message": "migration tests", "committedDate": "2020-03-24T06:57:43Z", "type": "forcePushed"}, {"oid": "34bee1481b2cab5e69ccfd9daaba7cfac7f81a4f", "url": "https://github.com/camunda/camunda-bpm-platform/commit/34bee1481b2cab5e69ccfd9daaba7cfac7f81a4f", "message": "move disposal", "committedDate": "2020-03-26T06:54:51Z", "type": "forcePushed"}, {"oid": "0f39b83ab0901c08ab6590cdee7d0fc6ffae8498", "url": "https://github.com/camunda/camunda-bpm-platform/commit/0f39b83ab0901c08ab6590cdee7d0fc6ffae8498", "message": "feat(engine): history creation on asyncBefore start event\n\n* remove delay of historic variables creation on asyncBefore start event\n* set processInstanceId as activityInstanceId for such variables\n* set initial flag to historic variables updates that contain the inital\nvalue of the variables on process instance start\n* query for initial variable updates during process instance restart if\ninitalSetVariables flag is raised\n* keep the legacy details query in process instance restart for instance\ncreated prior 7.13\n* introduce legacy behavior for instance created prior 7.13 that do not\nhave historic data created; migration test cases\n* delay disposal of executionStartContext to guarantee correct initial\nflag set for variable in execution listeners\n* modification test cases\n* restart process instance test cases\n\nRelated to CAM-10978", "committedDate": "2020-03-26T17:32:47Z", "type": "forcePushed"}, {"oid": "4f1c718a3c194a54b67d32df2b9ca2df5b4eddca", "url": "https://github.com/camunda/camunda-bpm-platform/commit/4f1c718a3c194a54b67d32df2b9ca2df5b4eddca", "message": "feat(engine): history creation on asyncBefore start event\n\n* remove delay of historic variables creation on asyncBefore start event\n* set processInstanceId as activityInstanceId for such variables\n* set initial flag to historic variables updates that contain the inital\nvalue of the variables on process instance start\n* query for initial variable updates during process instance restart if\ninitalSetVariables flag is raised\n* keep the legacy details query in process instance restart for instance\ncreated prior 7.13\n* introduce legacy behavior for instance created prior 7.13 that do not\nhave historic data created; migration test cases\n* delay disposal of executionStartContext to guarantee correct initial\nflag set for variable in execution listeners\n* modification test cases\n* restart process instance test cases\n\nRelated to CAM-10978", "committedDate": "2020-03-27T07:31:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMwMzgzOQ==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/714#discussion_r399303839", "bodyText": "Maybe we can clarify a bit what that means.", "author": "ThorbenLindhauer", "createdAt": "2020-03-27T14:27:43Z", "path": "engine/src/main/java/org/camunda/bpm/engine/history/HistoricDetailQuery.java", "diffHunk": "@@ -127,6 +127,9 @@\n   /** Only select historic details that have occurred after the given date (inclusive). */\n   HistoricDetailQuery occurredAfter(Date date);\n \n+  /** Only select historic details that were set during the process start. */", "originalCommit": "e27ad6de50269d3cb5c7b25f1104d346acda2b37", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1862d21ca37bccec93c920faae4c90f11dd9b7f8", "chunk": "diff --git a/engine/src/main/java/org/camunda/bpm/engine/history/HistoricDetailQuery.java b/engine/src/main/java/org/camunda/bpm/engine/history/HistoricDetailQuery.java\nindex 20bff2d9aa..7287cc347c 100644\n--- a/engine/src/main/java/org/camunda/bpm/engine/history/HistoricDetailQuery.java\n+++ b/engine/src/main/java/org/camunda/bpm/engine/history/HistoricDetailQuery.java\n\n@@ -127,9 +127,6 @@ public interface HistoricDetailQuery extends Query<HistoricDetailQuery, Historic\n   /** Only select historic details that have occurred after the given date (inclusive). */\n   HistoricDetailQuery occurredAfter(Date date);\n \n-  /** Only select historic details that were set during the process start. */\n-  HistoricDetailQuery initial();\n-\n   /**\n    * Order by tenant id (needs to be followed by {@link #asc()} or {@link #desc()}).\n    * Note that the ordering of historic details without tenant id is database-specific.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMwOTA4OQ==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/714#discussion_r399309089", "bodyText": "I think this should be the wrapper Boolean class to handle cases with null properly? Same for the field declaration in the entity. Or are the database fields in all cases declared to not allow null and have a proper default value (e.g. INITIAL_ smallint check(INITIAL_ in (1,0)); sounds like it)? In that case we must make sure that rolling-update scenarios still work, i.e. a 7.12 engine creates a history detail in the 7.13 schema.", "author": "ThorbenLindhauer", "createdAt": "2020-03-27T14:34:45Z", "path": "engine/src/main/java/org/camunda/bpm/engine/history/HistoricVariableUpdate.java", "diffHunk": "@@ -60,4 +60,9 @@\n    * @return an error message indicating why the variable value could not be loaded.\n    */\n   String getErrorMessage();\n+\n+  /**\n+   * @return true if the detail historic variable update is created during the process instance start\n+   */\n+  boolean isInitial();", "originalCommit": "e27ad6de50269d3cb5c7b25f1104d346acda2b37", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ed9049ddec70edae86e7621bd9a9aea756aae180", "chunk": "diff --git a/engine/src/main/java/org/camunda/bpm/engine/history/HistoricVariableUpdate.java b/engine/src/main/java/org/camunda/bpm/engine/history/HistoricVariableUpdate.java\nindex 05a6aa5ac9..c2787a2444 100644\n--- a/engine/src/main/java/org/camunda/bpm/engine/history/HistoricVariableUpdate.java\n+++ b/engine/src/main/java/org/camunda/bpm/engine/history/HistoricVariableUpdate.java\n\n@@ -64,5 +64,5 @@ public interface HistoricVariableUpdate extends HistoricDetail {\n   /**\n    * @return true if the detail historic variable update is created during the process instance start\n    */\n-  boolean isInitial();\n+  Boolean isInitial();\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMxNTU1Nw==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/714#discussion_r399315557", "bodyText": "This comment is a bit misleading. You could even consider creating a method #wasCreatedBefore713 in VariableInstanceEntity and have a description there why we can use the definition id to make the distinction.", "author": "ThorbenLindhauer", "createdAt": "2020-03-27T14:43:34Z", "path": "engine/src/main/java/org/camunda/bpm/engine/impl/pvm/runtime/LegacyBehavior.java", "diffHunk": "@@ -635,4 +639,34 @@ public boolean isFulfilled(PvmExecutionImpl element) {\n     return walker.getCurrentElement();\n   }\n \n+  /**\n+   * See #CAM-10978\n+   * Use case process instance with <code>asyncBefore</code> startEvent\n+   * After unifying the history variable's creation<br>\n+   * The following changed:<br>\n+   *   * variables will receive the <code>processInstanceId</code> as <code>activityInstanceId</code> in such cases (previously was the startEvent id)<br>\n+   *   * historic details have new <code>initial</code> property to track initial variables that process is started with<br>\n+   * The jobs created prior <code>7.13</code> and not executed before do not have historic information of variables.\n+   * This method takes care of that.\n+   */\n+  public static void createMissingHistoricVariables(PvmExecutionImpl execution) {\n+    Collection<VariableInstanceEntity> variables = ((ExecutionEntity) execution).getVariablesInternal();\n+\n+    if (variables != null && variables.size() > 0) {\n+      // trigger historic creation if the history is not presented already\n+      for (VariableInstanceEntity variable : variables) {\n+\n+        // processDefinitionId is introduced in 7.13 and for such variable we need to create history", "originalCommit": "e27ad6de50269d3cb5c7b25f1104d346acda2b37", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ed9049ddec70edae86e7621bd9a9aea756aae180", "chunk": "diff --git a/engine/src/main/java/org/camunda/bpm/engine/impl/pvm/runtime/LegacyBehavior.java b/engine/src/main/java/org/camunda/bpm/engine/impl/pvm/runtime/LegacyBehavior.java\nindex 1efbad8769..b956bcb936 100644\n--- a/engine/src/main/java/org/camunda/bpm/engine/impl/pvm/runtime/LegacyBehavior.java\n+++ b/engine/src/main/java/org/camunda/bpm/engine/impl/pvm/runtime/LegacyBehavior.java\n\n@@ -656,17 +653,11 @@ public class LegacyBehavior {\n       // trigger historic creation if the history is not presented already\n       for (VariableInstanceEntity variable : variables) {\n \n-        // processDefinitionId is introduced in 7.13 and for such variable we need to create history\n-        if (variable.getProcessDefinitionId() == null &&\n-            getHistoryLevel().isHistoryEventProduced(HistoryEventTypes.VARIABLE_INSTANCE_CREATE, variable)) {\n+        if (variable.wasCreatedBefore713()) {\n           VariableInstanceHistoryListener.INSTANCE.onCreate(variable, variable.getExecution());\n         }\n       }\n     }\n   }\n \n-  private static HistoryLevel getHistoryLevel() {\n-    return Context.getProcessEngineConfiguration().getHistoryLevel();\n-  }\n-\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMxNjExOQ==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/714#discussion_r399316119", "bodyText": "We can remove this second part, because that is also checked in the listener's #onCreate method.", "author": "ThorbenLindhauer", "createdAt": "2020-03-27T14:44:21Z", "path": "engine/src/main/java/org/camunda/bpm/engine/impl/pvm/runtime/LegacyBehavior.java", "diffHunk": "@@ -635,4 +639,34 @@ public boolean isFulfilled(PvmExecutionImpl element) {\n     return walker.getCurrentElement();\n   }\n \n+  /**\n+   * See #CAM-10978\n+   * Use case process instance with <code>asyncBefore</code> startEvent\n+   * After unifying the history variable's creation<br>\n+   * The following changed:<br>\n+   *   * variables will receive the <code>processInstanceId</code> as <code>activityInstanceId</code> in such cases (previously was the startEvent id)<br>\n+   *   * historic details have new <code>initial</code> property to track initial variables that process is started with<br>\n+   * The jobs created prior <code>7.13</code> and not executed before do not have historic information of variables.\n+   * This method takes care of that.\n+   */\n+  public static void createMissingHistoricVariables(PvmExecutionImpl execution) {\n+    Collection<VariableInstanceEntity> variables = ((ExecutionEntity) execution).getVariablesInternal();\n+\n+    if (variables != null && variables.size() > 0) {\n+      // trigger historic creation if the history is not presented already\n+      for (VariableInstanceEntity variable : variables) {\n+\n+        // processDefinitionId is introduced in 7.13 and for such variable we need to create history\n+        if (variable.getProcessDefinitionId() == null &&\n+            getHistoryLevel().isHistoryEventProduced(HistoryEventTypes.VARIABLE_INSTANCE_CREATE, variable)) {", "originalCommit": "e27ad6de50269d3cb5c7b25f1104d346acda2b37", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ed9049ddec70edae86e7621bd9a9aea756aae180", "chunk": "diff --git a/engine/src/main/java/org/camunda/bpm/engine/impl/pvm/runtime/LegacyBehavior.java b/engine/src/main/java/org/camunda/bpm/engine/impl/pvm/runtime/LegacyBehavior.java\nindex 1efbad8769..b956bcb936 100644\n--- a/engine/src/main/java/org/camunda/bpm/engine/impl/pvm/runtime/LegacyBehavior.java\n+++ b/engine/src/main/java/org/camunda/bpm/engine/impl/pvm/runtime/LegacyBehavior.java\n\n@@ -656,17 +653,11 @@ public class LegacyBehavior {\n       // trigger historic creation if the history is not presented already\n       for (VariableInstanceEntity variable : variables) {\n \n-        // processDefinitionId is introduced in 7.13 and for such variable we need to create history\n-        if (variable.getProcessDefinitionId() == null &&\n-            getHistoryLevel().isHistoryEventProduced(HistoryEventTypes.VARIABLE_INSTANCE_CREATE, variable)) {\n+        if (variable.wasCreatedBefore713()) {\n           VariableInstanceHistoryListener.INSTANCE.onCreate(variable, variable.getExecution());\n         }\n       }\n     }\n   }\n \n-  private static HistoryLevel getHistoryLevel() {\n-    return Context.getProcessEngineConfiguration().getHistoryLevel();\n-  }\n-\n }\n"}}, {"oid": "ed9049ddec70edae86e7621bd9a9aea756aae180", "url": "https://github.com/camunda/camunda-bpm-platform/commit/ed9049ddec70edae86e7621bd9a9aea756aae180", "message": "squash me with c1b77f8e0a\n\nimprove legacy behavior check", "committedDate": "2020-03-30T05:59:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDE1MDk4NA==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/714#discussion_r400150984", "bodyText": "Should we set the default value here since the value is used in a condition in the MyBatis query?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              protected boolean initial;\n          \n          \n            \n              protected boolean initial = false;", "author": "koevskinikola", "createdAt": "2020-03-30T12:27:24Z", "path": "engine/src/main/java/org/camunda/bpm/engine/impl/HistoricDetailQueryImpl.java", "diffHunk": "@@ -56,6 +56,7 @@\n   protected Long sequenceCounter;\n   protected Date occurredBefore;\n   protected Date occurredAfter;\n+  protected boolean initial;", "originalCommit": "628513c7eb15f6bce10e152e6a12df4c834c2217", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1862d21ca37bccec93c920faae4c90f11dd9b7f8", "chunk": "diff --git a/engine/src/main/java/org/camunda/bpm/engine/impl/HistoricDetailQueryImpl.java b/engine/src/main/java/org/camunda/bpm/engine/impl/HistoricDetailQueryImpl.java\nindex c70592e777..aa94cbdbda 100644\n--- a/engine/src/main/java/org/camunda/bpm/engine/impl/HistoricDetailQueryImpl.java\n+++ b/engine/src/main/java/org/camunda/bpm/engine/impl/HistoricDetailQueryImpl.java\n\n@@ -56,7 +56,6 @@ public class HistoricDetailQueryImpl extends AbstractQuery<HistoricDetailQuery,\n   protected Long sequenceCounter;\n   protected Date occurredBefore;\n   protected Date occurredAfter;\n-  protected boolean initial;\n \n   protected boolean excludeTaskRelated = false;\n   protected boolean isByteArrayFetchingEnabled = true;\n"}}, {"oid": "1862d21ca37bccec93c920faae4c90f11dd9b7f8", "url": "https://github.com/camunda/camunda-bpm-platform/commit/1862d21ca37bccec93c920faae4c90f11dd9b7f8", "message": "feat(engine): add processDefinitionId to variable instance\n\n* and remove h2 unique constrain suffix check\nas the suffix changes on alter variable table\n\nRelated to CAM-10978", "committedDate": "2020-04-03T11:24:51Z", "type": "commit"}, {"oid": "346befaed3a47ab51fb21becc30310e553ed70bb", "url": "https://github.com/camunda/camunda-bpm-platform/commit/346befaed3a47ab51fb21becc30310e553ed70bb", "message": "feat(engine): set initial flag of historic variable details\n\nRelated to CAM-10978", "committedDate": "2020-04-03T11:27:39Z", "type": "commit"}, {"oid": "e55a82595c6e2cc9bcbafc62bf93dbe5a2b5f78b", "url": "https://github.com/camunda/camunda-bpm-platform/commit/e55a82595c6e2cc9bcbafc62bf93dbe5a2b5f78b", "message": "feat(engine): history creation on asyncBefore start event\n\n* remove delay of historic variables creation on asyncBefore start event\n* set processInstanceId as activityInstanceId for such variables\n* set initial flag to historic variables updates that contain the inital\nvalue of the variables on process instance start\n* query for initial variable updates during process instance restart if\ninitalSetVariables flag is raised\n* keep the legacy details query in process instance restart for instance\ncreated prior 7.13\n* introduce legacy behavior for instance created prior 7.13 that do not\nhave historic data created; migration test cases\n* delay disposal of executionStartContext to guarantee correct initial\nflag set for variable in execution listeners\n* modification test cases\n* restart process instance test cases\n\nRelated to CAM-10978", "committedDate": "2020-04-03T11:29:13Z", "type": "commit"}, {"oid": "e55a82595c6e2cc9bcbafc62bf93dbe5a2b5f78b", "url": "https://github.com/camunda/camunda-bpm-platform/commit/e55a82595c6e2cc9bcbafc62bf93dbe5a2b5f78b", "message": "feat(engine): history creation on asyncBefore start event\n\n* remove delay of historic variables creation on asyncBefore start event\n* set processInstanceId as activityInstanceId for such variables\n* set initial flag to historic variables updates that contain the inital\nvalue of the variables on process instance start\n* query for initial variable updates during process instance restart if\ninitalSetVariables flag is raised\n* keep the legacy details query in process instance restart for instance\ncreated prior 7.13\n* introduce legacy behavior for instance created prior 7.13 that do not\nhave historic data created; migration test cases\n* delay disposal of executionStartContext to guarantee correct initial\nflag set for variable in execution listeners\n* modification test cases\n* restart process instance test cases\n\nRelated to CAM-10978", "committedDate": "2020-04-03T11:29:13Z", "type": "forcePushed"}]}