{"pr_number": 864, "pr_title": "feat(engine): add installation id on engine start", "pr_createdAt": "2020-06-17T13:07:30Z", "pr_url": "https://github.com/camunda/camunda-bpm-platform/pull/864", "timeline": [{"oid": "280f4e19f8ef9b3dab052fdc245dc0adf7632f5b", "url": "https://github.com/camunda/camunda-bpm-platform/commit/280f4e19f8ef9b3dab052fdc245dc0adf7632f5b", "message": "feat(engine): add installation id on engine start\n\nRelated to CAM-12031", "committedDate": "2020-06-19T14:36:25Z", "type": "forcePushed"}, {"oid": "504fd31ebeae8c55ec5e71a77b1a6771433f686d", "url": "https://github.com/camunda/camunda-bpm-platform/commit/504fd31ebeae8c55ec5e71a77b1a6771433f686d", "message": "feat(engine): add installation id on engine start\n\nRelated to CAM-12031", "committedDate": "2020-06-22T07:13:12Z", "type": "forcePushed"}, {"oid": "17043ee88d29dfdab241f661556d822142b6df14", "url": "https://github.com/camunda/camunda-bpm-platform/commit/17043ee88d29dfdab241f661556d822142b6df14", "message": "feat(engine): add installation id on engine start\n\nRelated to CAM-12031", "committedDate": "2020-06-22T09:06:48Z", "type": "forcePushed"}, {"oid": "f9ee17647d1de6d5a3cba06174b3e9d6a705f38f", "url": "https://github.com/camunda/camunda-bpm-platform/commit/f9ee17647d1de6d5a3cba06174b3e9d6a705f38f", "message": "feat(engine): add installation id on engine start\n\nRelated to CAM-12031", "committedDate": "2020-06-25T08:18:13Z", "type": "commit"}, {"oid": "f9ee17647d1de6d5a3cba06174b3e9d6a705f38f", "url": "https://github.com/camunda/camunda-bpm-platform/commit/f9ee17647d1de6d5a3cba06174b3e9d6a705f38f", "message": "feat(engine): add installation id on engine start\n\nRelated to CAM-12031", "committedDate": "2020-06-25T08:18:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk4NDc3Mw==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/864#discussion_r445984773", "bodyText": "I would suggest to have a constant for \"installationId.lock\" as well.", "author": "mboskamp", "createdAt": "2020-06-26T06:05:31Z", "path": "engine/src/main/java/org/camunda/bpm/engine/impl/BootstrapEngineCommand.java", "diffHunk": "@@ -129,4 +133,50 @@ protected void createTelemetryProperty(CommandContext commandContext) {\n     commandContext.getPropertyManager().insert(property);\n     LOG.creatingTelemetryPropertyInDatabase(telemetryEnabled);\n   }\n+\n+  public void initializeInstallationId(CommandContext commandContext) {\n+    checkInstallationIdLockExists(commandContext);\n+\n+    String databaseInstallationId = databaseInstallationId(commandContext);\n+\n+    if (databaseInstallationId == null || databaseInstallationId.isEmpty()) {\n+\n+      commandContext.getPropertyManager().acquireExclusiveLockForInstallationId();\n+      databaseInstallationId = databaseInstallationId(commandContext);\n+\n+      if (databaseInstallationId == null || databaseInstallationId.isEmpty()) {\n+        LOG.noInstallationIdPropertyFound();\n+        createInstallationProperty(commandContext);\n+      }\n+    } else {\n+      LOG.installationIdPropertyFound(databaseInstallationId);\n+      commandContext.getProcessEngineConfiguration().setInstallationId(databaseInstallationId);\n+    }\n+  }\n+\n+  protected void createInstallationProperty(CommandContext commandContext) {\n+    String installationId = UUID.randomUUID().toString();\n+    PropertyEntity property = new PropertyEntity(INSTALLATION_PROPERTY_NAME, installationId);\n+    commandContext.getPropertyManager().insert(property);\n+    LOG.creatingInstallationPropertyInDatabase(property.getValue());\n+    commandContext.getProcessEngineConfiguration().setInstallationId(installationId);\n+  }\n+\n+  protected String databaseInstallationId(CommandContext commandContext) {\n+    try {\n+      PropertyEntity installationIdProperty = commandContext.getPropertyManager().findPropertyById(INSTALLATION_PROPERTY_NAME);\n+      return installationIdProperty != null ? installationIdProperty.getValue() : null;\n+    } catch (Exception e) {\n+      LOG.couldNotSelectInstallationId(e.getMessage());\n+      return null;\n+    }\n+  }\n+\n+  protected void checkInstallationIdLockExists(CommandContext commandContext) {\n+    PropertyEntity installationIdProperty = commandContext.getPropertyManager().findPropertyById(\"installationId.lock\");", "originalCommit": "f9ee17647d1de6d5a3cba06174b3e9d6a705f38f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjEyNDg0Ng==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/864#discussion_r446124846", "bodyText": "I prefer to do it in a separate ticket as it seems that it will be better to have a central place of the lock names as well as the property names.", "author": "yanavasileva", "createdAt": "2020-06-26T11:22:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk4NDc3Mw=="}], "type": "inlineReview", "revised_code": null}]}