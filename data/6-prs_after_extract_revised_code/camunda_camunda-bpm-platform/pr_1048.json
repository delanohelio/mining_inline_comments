{"pr_number": 1048, "pr_title": "CAM-12524: fix(engine): detect crdb errors on tx commit", "pr_createdAt": "2020-10-05T15:33:18Z", "pr_url": "https://github.com/camunda/camunda-bpm-platform/pull/1048", "timeline": [{"oid": "dbaab5a3d730f2bdaecbf5aad10214b06ee9eeb7", "url": "https://github.com/camunda/camunda-bpm-platform/commit/dbaab5a3d730f2bdaecbf5aad10214b06ee9eeb7", "message": "fix(engine): detect crdb errors on tx commit\n\n* When CockroachDB is used, a CRDB concurrency error may occur on transaction commit.\n  To ensure that these errors are still detected as OLEs, we must catch them and wrap\n  them in a CrdbTransactionRetryException\n\nRelated to CAM-12524", "committedDate": "2020-10-06T13:55:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjUwMjQwOA==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/1048#discussion_r506502408", "bodyText": "If people use this constructor, they will run into a NullPointerException in the catch block. If you we want to keep this constructor because it is strictly speaking public API, then we should make rule out the possibility for the NPE and instead degrade the service (e.g. CRDB exception handling doesn't work then).", "author": "ThorbenLindhauer", "createdAt": "2020-10-16T14:46:22Z", "path": "engine-spring/core/src/main/java/org/camunda/bpm/engine/spring/SpringTransactionInterceptor.java", "diffHunk": "@@ -31,21 +34,36 @@\n   \n   protected PlatformTransactionManager transactionManager;\n   protected int transactionPropagation;\n+  protected ProcessEngineConfigurationImpl processEngineConfiguration;\n   \n   public SpringTransactionInterceptor(PlatformTransactionManager transactionManager, int transactionPropagation) {\n+    this(transactionManager, transactionPropagation, null);\n+  }", "originalCommit": "dbaab5a3d730f2bdaecbf5aad10214b06ee9eeb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDkyOTUwOQ==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/1048#discussion_r510929509", "bodyText": "I added a null check and deprecated the constructor with a Javadoc explaining the reason and alternative.", "author": "koevskinikola", "createdAt": "2020-10-23T14:37:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjUwMjQwOA=="}], "type": "inlineReview", "revised_code": {"commit": "1f7f88ad511cf4c212222184bccaeb9e89be2ac3", "chunk": "diff --git a/engine-spring/core/src/main/java/org/camunda/bpm/engine/spring/SpringTransactionInterceptor.java b/engine-spring/core/src/main/java/org/camunda/bpm/engine/spring/SpringTransactionInterceptor.java\nindex ea28a9a2b0..93a7b181e0 100644\n--- a/engine-spring/core/src/main/java/org/camunda/bpm/engine/spring/SpringTransactionInterceptor.java\n+++ b/engine-spring/core/src/main/java/org/camunda/bpm/engine/spring/SpringTransactionInterceptor.java\n\n@@ -31,11 +33,21 @@ import org.springframework.transaction.support.TransactionTemplate;\n  * @author Tom Baeyens\n  */\n public class SpringTransactionInterceptor extends CommandInterceptor {\n-  \n+\n   protected PlatformTransactionManager transactionManager;\n   protected int transactionPropagation;\n   protected ProcessEngineConfigurationImpl processEngineConfiguration;\n-  \n+\n+  /**\n+   * This constructor doesn't pass an instance of the {@link ProcessEngineConfigurationImpl} class.\n+   * As a result, if it is used with CockroachDB, concurrency conflicts that occur on transaction\n+   * commit will not be handled by the process engine.\n+   *\n+   * @deprecated use the {@link #SpringTransactionInterceptor(PlatformTransactionManager, int, ProcessEngineConfigurationImpl)}\n+   *    constructor to ensure that when used with CockroachDB, concurrency conflicts that occur\n+   *    on transaction commit are detected and handled.\n+   */\n+  @Deprecated\n   public SpringTransactionInterceptor(PlatformTransactionManager transactionManager, int transactionPropagation) {\n     this(transactionManager, transactionPropagation, null);\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjUwMzQyNg==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/1048#discussion_r506503426", "bodyText": "I cannot follow why this is needed and I also struggle to look this up in Spring myself. Can you please provide a better explanation in code here? Else we will have trouble touching this code again in the future.", "author": "ThorbenLindhauer", "createdAt": "2020-10-16T14:47:33Z", "path": "engine/src/main/java/org/camunda/bpm/engine/impl/db/sql/DbSqlSession.java", "diffHunk": "@@ -302,7 +304,34 @@ public static boolean isCrdbConcurrencyConflict(Throwable cause) {\n     return false;\n   }\n \n+  /**\n+   * In cases where CockroachDB is used, and a failed operation is detected,\n+   * the method checks if the exception was caused by a CockroachDB\n+   * <code>TransactionRetryException</code>. This method may be used when a\n+   * CRDB Error occurs on commit, and a Command Context is not available, as\n+   * it has already been closed. This is the case with Spring/JTA transaction\n+   * interceptors.\n+   *\n+   * @param cause for which an operation failed\n+   * @param configuration of the Process Engine\n+   * @return true if the failure was due to a CRDB <code>TransactionRetryException</code>.\n+   *          Otherwise, it's false.\n+   */\n+  public static boolean isCrdbConcurrencyConflictOnCommit(Throwable cause, ProcessEngineConfigurationImpl configuration) {\n+    // only check when CRDB is used\n+    if (DatabaseUtil.checkDatabaseType(configuration, DbSqlSessionFactory.CRDB)) {\n+      // with externally managed transactions, the real cause is sometimes suppressed\n+      List<Throwable> causes = new ArrayList<>(Arrays.asList(cause.getSuppressed()));\n+      causes.add(cause);", "originalCommit": "dbaab5a3d730f2bdaecbf5aad10214b06ee9eeb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDg5MDA1MA==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/1048#discussion_r510890050", "bodyText": "This part is when JTA is used, since it suppresses the CRDB error and provides a RollbackException instead, so the real cause is not detected. I will expand on the explanation that it is only for JTA.", "author": "koevskinikola", "createdAt": "2020-10-23T13:38:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjUwMzQyNg=="}], "type": "inlineReview", "revised_code": {"commit": "1f7f88ad511cf4c212222184bccaeb9e89be2ac3", "chunk": "diff --git a/engine/src/main/java/org/camunda/bpm/engine/impl/db/sql/DbSqlSession.java b/engine/src/main/java/org/camunda/bpm/engine/impl/db/sql/DbSqlSession.java\nindex ec8e6fea44..33ce8f5a49 100644\n--- a/engine/src/main/java/org/camunda/bpm/engine/impl/db/sql/DbSqlSession.java\n+++ b/engine/src/main/java/org/camunda/bpm/engine/impl/db/sql/DbSqlSession.java\n\n@@ -320,7 +322,9 @@ public abstract class DbSqlSession extends AbstractPersistenceSession {\n   public static boolean isCrdbConcurrencyConflictOnCommit(Throwable cause, ProcessEngineConfigurationImpl configuration) {\n     // only check when CRDB is used\n     if (DatabaseUtil.checkDatabaseType(configuration, DbSqlSessionFactory.CRDB)) {\n-      // with externally managed transactions, the real cause is sometimes suppressed\n+      // with Java EE (JTA) transactions, the real cause is suppressed,\n+      // and replaced with a RollbackException. We need to look into the\n+      // suppressed exceptions to find the CRDB TransactionRetryError.\n       List<Throwable> causes = new ArrayList<>(Arrays.asList(cause.getSuppressed()));\n       causes.add(cause);\n       for (Throwable throwable : causes) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjUwNDg3Ng==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/1048#discussion_r506504876", "bodyText": "Same possibility for NullPointerException here. I guess here we can remove the constructor, because it's impl.", "author": "ThorbenLindhauer", "createdAt": "2020-10-16T14:49:26Z", "path": "engine/src/main/java/org/camunda/bpm/engine/impl/interceptor/JtaTransactionInterceptor.java", "diffHunk": "@@ -28,21 +28,31 @@\n import javax.transaction.TransactionManager;\n \n import org.camunda.bpm.engine.impl.ProcessEngineLogger;\n+import org.camunda.bpm.engine.impl.cfg.ProcessEngineConfigurationImpl;\n import org.camunda.bpm.engine.impl.cmd.CommandLogger;\n+import org.camunda.bpm.engine.impl.db.sql.DbSqlSession;\n \n /**\n  * @author Guillaume Nodet\n  */\n public class JtaTransactionInterceptor extends CommandInterceptor {\n \n-  private final static CommandLogger LOG = ProcessEngineLogger.CMD_LOGGER;\n+  protected final static CommandLogger LOG = ProcessEngineLogger.CMD_LOGGER;\n \n-  private final TransactionManager transactionManager;\n-  private final boolean requiresNew;\n+  protected final TransactionManager transactionManager;\n+  protected final boolean requiresNew;\n+  protected ProcessEngineConfigurationImpl processEngineConfiguration;\n \n   public JtaTransactionInterceptor(TransactionManager transactionManager, boolean requiresNew) {\n+    this(transactionManager, requiresNew, null);\n+  }", "originalCommit": "dbaab5a3d730f2bdaecbf5aad10214b06ee9eeb7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1f7f88ad511cf4c212222184bccaeb9e89be2ac3", "chunk": "diff --git a/engine/src/main/java/org/camunda/bpm/engine/impl/interceptor/JtaTransactionInterceptor.java b/engine/src/main/java/org/camunda/bpm/engine/impl/interceptor/JtaTransactionInterceptor.java\nindex 1dc15fa6e0..acd887753d 100644\n--- a/engine/src/main/java/org/camunda/bpm/engine/impl/interceptor/JtaTransactionInterceptor.java\n+++ b/engine/src/main/java/org/camunda/bpm/engine/impl/interceptor/JtaTransactionInterceptor.java\n\n@@ -43,10 +43,6 @@ public class JtaTransactionInterceptor extends CommandInterceptor {\n   protected final boolean requiresNew;\n   protected ProcessEngineConfigurationImpl processEngineConfiguration;\n \n-  public JtaTransactionInterceptor(TransactionManager transactionManager, boolean requiresNew) {\n-    this(transactionManager, requiresNew, null);\n-  }\n-\n   public JtaTransactionInterceptor(TransactionManager transactionManager,\n                                    boolean requiresNew,\n                                    ProcessEngineConfigurationImpl processEngineConfiguration) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjUyNDUzNA==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/1048#discussion_r506524534", "bodyText": "Can we at least write a unit test directly for the SpringTransactionInterceptor class? I.e. mock the transaction manager interface and then test the logic?\nSame for JTA.", "author": "ThorbenLindhauer", "createdAt": "2020-10-16T15:05:54Z", "path": "engine-spring/core/src/test/java/org/camunda/bpm/engine/spring/test/transaction/crdb/CrdbTxRetryOnCommitTest.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH\n+ * under one or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information regarding copyright\n+ * ownership. Camunda licenses this file to you under the Apache License,\n+ * Version 2.0; you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.camunda.bpm.engine.spring.test.transaction.crdb;\n+\n+import org.camunda.bpm.engine.CrdbTransactionRetryException;\n+import org.camunda.bpm.engine.impl.cfg.ProcessEngineConfigurationImpl;\n+import org.camunda.bpm.engine.test.Deployment;\n+import org.camunda.bpm.engine.test.ProcessEngineRule;\n+import org.junit.Ignore;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.ExpectedException;\n+import org.junit.runner.RunWith;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.test.context.ContextConfiguration;\n+import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;\n+\n+/**\n+ * This tests simulates a CockroachDB concurrency error on TX commit.\n+ */\n+@RunWith(SpringJUnit4ClassRunner.class)\n+@ContextConfiguration(locations = {\"classpath:org/camunda/bpm/engine/spring/test/transaction/\" +\n+    \"CrdbTransactionIntegrationTest-applicationContext.xml\"})\n+public class CrdbTxRetryOnCommitTest {\n+\n+  @Rule\n+  @Autowired\n+  public ProcessEngineRule rule;\n+\n+  @Rule\n+  public ExpectedException thrown = ExpectedException.none();\n+\n+  @Autowired\n+  public ProcessEngineConfigurationImpl processEngineConfiguration;\n+\n+  /**\n+   * Scenario can't be successfully run without modifying runtime code\n+   * since we only use H2 in the Spring integration tests, and this test\n+   * requires the hard-coded CRDB check to work.\n+   */", "originalCommit": "dbaab5a3d730f2bdaecbf5aad10214b06ee9eeb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkyNTQzNA==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/1048#discussion_r511925434", "bodyText": "The problem is that the \"concurrency error\" detection logic only kicks in if we use CRDB.\nI'm not sure what we would achieve by mocking the transaction manager interface since the same CRDB validation would still be present. One idea would be to mock the transaction manager interface and test the DbSqlSession.isCrdbConcurrencyConflictOnCommit(...) method.\nUPDATE: I'd like to discuss this further since I don't see how we can test this without modifying runtime code.", "author": "koevskinikola", "createdAt": "2020-10-26T12:34:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjUyNDUzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQ5MTU3NQ==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/1048#discussion_r516491575", "bodyText": "Why not mock the engine configuration as well? Not great, but better than no test.", "author": "ThorbenLindhauer", "createdAt": "2020-11-03T08:27:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjUyNDUzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY4NjUyOQ==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/1048#discussion_r518686529", "bodyText": "@ThorbenLindhauer have a look at the last commit (a27fbc6). I temporarily swap out the databaseType property to test out the SpringTransactionInterceptor logic. The Spring Integration test works like this.\nI tried to implement something similar for JTA in the Process Engine test suite without success. We test the JtaProcessEngineConfiguration in the QA integration-tests-engine module. However, we only use Postgres in the related jobs. Do you think I should try to implement a test there?", "author": "koevskinikola", "createdAt": "2020-11-06T11:16:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjUyNDUzNA=="}], "type": "inlineReview", "revised_code": {"commit": "1f7f88ad511cf4c212222184bccaeb9e89be2ac3", "chunk": "diff --git a/engine-spring/core/src/test/java/org/camunda/bpm/engine/spring/test/transaction/crdb/CrdbTxRetryOnCommitTest.java b/engine-spring/core/src/test/java/org/camunda/bpm/engine/spring/test/transaction/crdb/CrdbTxRetryOnCommitTest.java\nindex 35d61b8ae3..b6438895dc 100644\n--- a/engine-spring/core/src/test/java/org/camunda/bpm/engine/spring/test/transaction/crdb/CrdbTxRetryOnCommitTest.java\n+++ b/engine-spring/core/src/test/java/org/camunda/bpm/engine/spring/test/transaction/crdb/CrdbTxRetryOnCommitTest.java\n\n@@ -18,9 +18,11 @@ package org.camunda.bpm.engine.spring.test.transaction.crdb;\n \n import org.camunda.bpm.engine.CrdbTransactionRetryException;\n import org.camunda.bpm.engine.impl.cfg.ProcessEngineConfigurationImpl;\n+import org.camunda.bpm.engine.impl.db.sql.DbSqlSessionFactory;\n import org.camunda.bpm.engine.test.Deployment;\n import org.camunda.bpm.engine.test.ProcessEngineRule;\n-import org.junit.Ignore;\n+import org.junit.After;\n+import org.junit.Before;\n import org.junit.Rule;\n import org.junit.Test;\n import org.junit.rules.ExpectedException;\n"}}, {"oid": "1f7f88ad511cf4c212222184bccaeb9e89be2ac3", "url": "https://github.com/camunda/camunda-bpm-platform/commit/1f7f88ad511cf4c212222184bccaeb9e89be2ac3", "message": "WIP", "committedDate": "2020-10-26T13:27:05Z", "type": "forcePushed"}, {"oid": "cbe65eb1d419033e404b684f539fed042f797e51", "url": "https://github.com/camunda/camunda-bpm-platform/commit/cbe65eb1d419033e404b684f539fed042f797e51", "message": "fix(engine): detect crdb errors on tx commit\n\n* When CockroachDB is used, a CRDB concurrency error may occur on transaction commit.\n  To ensure that these errors are still detected as OLEs, we must catch them and wrap\n  them in a CrdbTransactionRetryException\n\nRelated to CAM-12524", "committedDate": "2020-11-06T09:36:44Z", "type": "commit"}, {"oid": "479953419e6e4875651d5f9fe13c6af698b5c865", "url": "https://github.com/camunda/camunda-bpm-platform/commit/479953419e6e4875651d5f9fe13c6af698b5c865", "message": "SQUASH ME: implement review hints", "committedDate": "2020-11-06T09:36:44Z", "type": "commit"}, {"oid": "a27fbc6f63dadf07b8739bb448f9b05aa037d273", "url": "https://github.com/camunda/camunda-bpm-platform/commit/a27fbc6f63dadf07b8739bb448f9b05aa037d273", "message": "SQUASH ME: test CRDB TX Retry error on commit\"", "committedDate": "2020-11-06T11:11:11Z", "type": "commit"}, {"oid": "a27fbc6f63dadf07b8739bb448f9b05aa037d273", "url": "https://github.com/camunda/camunda-bpm-platform/commit/a27fbc6f63dadf07b8739bb448f9b05aa037d273", "message": "SQUASH ME: test CRDB TX Retry error on commit\"", "committedDate": "2020-11-06T11:11:11Z", "type": "forcePushed"}, {"oid": "277e7000e4c20d43a04c3c8349a1f0b32281f283", "url": "https://github.com/camunda/camunda-bpm-platform/commit/277e7000e4c20d43a04c3c8349a1f0b32281f283", "message": "add test for JTA interceptor", "committedDate": "2020-11-10T16:09:48Z", "type": "commit"}, {"oid": "277e7000e4c20d43a04c3c8349a1f0b32281f283", "url": "https://github.com/camunda/camunda-bpm-platform/commit/277e7000e4c20d43a04c3c8349a1f0b32281f283", "message": "add test for JTA interceptor", "committedDate": "2020-11-10T16:09:48Z", "type": "forcePushed"}]}