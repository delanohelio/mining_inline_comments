{"pr_number": 740, "pr_title": "Rip/gh682/request context n3", "pr_createdAt": "2020-07-10T12:47:53Z", "pr_url": "https://github.com/zowe/api-layer/pull/740", "timeline": [{"oid": "f58c008b206f55e1b921c10864113a103b933c72", "url": "https://github.com/zowe/api-layer/commit/f58c008b206f55e1b921c10864113a103b933c72", "message": "change status test\n\nSigned-off-by: achmelo <a.chmelo@gmail.com>", "committedDate": "2020-07-08T05:54:26Z", "type": "commit"}, {"oid": "f762c40099d7646810996df2631e25fe57b3fbbc", "url": "https://github.com/zowe/api-layer/commit/f762c40099d7646810996df2631e25fe57b3fbbc", "message": "update status test, refresh routes after LB\n\nSigned-off-by: achmelo <a.chmelo@gmail.com>", "committedDate": "2020-07-09T09:14:56Z", "type": "commit"}, {"oid": "5f1dc3296529155c3946735cee9e431e6877a6a8", "url": "https://github.com/zowe/api-layer/commit/5f1dc3296529155c3946735cee9e431e6877a6a8", "message": "move LB update to route locator\n\nSigned-off-by: achmelo <a.chmelo@gmail.com>", "committedDate": "2020-07-09T11:41:23Z", "type": "commit"}, {"oid": "0e5213b661ee2e05de11ea44ed7e6f4bd3c1fcdf", "url": "https://github.com/zowe/api-layer/commit/0e5213b661ee2e05de11ea44ed7e6f4bd3c1fcdf", "message": "lb event listener\n\nSigned-off-by: achmelo <a.chmelo@gmail.com>", "committedDate": "2020-07-09T13:30:26Z", "type": "commit"}, {"oid": "fce311a6e2a3e0209074ea06af54ccda9a8b698a", "url": "https://github.com/zowe/api-layer/commit/fce311a6e2a3e0209074ea06af54ccda9a8b698a", "message": "new listener for route refresh\n\nSigned-off-by: achmelo <a.chmelo@gmail.com>", "committedDate": "2020-07-10T07:54:06Z", "type": "commit"}, {"oid": "2229217e34c3fae123166592507ea51f1f5dd3be", "url": "https://github.com/zowe/api-layer/commit/2229217e34c3fae123166592507ea51f1f5dd3be", "message": "remove refreshing routes and LB for eureka events\n\nSigned-off-by: achmelo <a.chmelo@gmail.com>", "committedDate": "2020-07-10T08:06:21Z", "type": "commit"}, {"oid": "28531c8aa7619d37e0672b68dce25b35b5718d43", "url": "https://github.com/zowe/api-layer/commit/28531c8aa7619d37e0672b68dce25b35b5718d43", "message": "move listeners from eureka event to spring\n\nSigned-off-by: achmelo <a.chmelo@gmail.com>", "committedDate": "2020-07-10T09:32:41Z", "type": "commit"}, {"oid": "26355399de5c510b466d9c54f2d71758ee07c17d", "url": "https://github.com/zowe/api-layer/commit/26355399de5c510b466d9c54f2d71758ee07c17d", "message": "@Order of event listeners\n\nSigned-off-by: jandadav <janda.david@gmail.com>", "committedDate": "2020-07-10T09:55:43Z", "type": "commit"}, {"oid": "2b1ff6d0ab1301e8c8ae97f6e979d5d73fbd8488", "url": "https://github.com/zowe/api-layer/commit/2b1ff6d0ab1301e8c8ae97f6e979d5d73fbd8488", "message": "Merge remote-tracking branch 'origin/rip/GH682/request_context_n3' into rip/GH682/request_context_n3\n\n# Conflicts:\n#\tgateway-service/src/main/java/org/zowe/apiml/gateway/metadata/service/LoadBalancerEventListener.java", "committedDate": "2020-07-10T09:57:46Z", "type": "commit"}, {"oid": "eae28aedf9c45278c47b0bc79abf7ffcf54d6360", "url": "https://github.com/zowe/api-layer/commit/eae28aedf9c45278c47b0bc79abf7ffcf54d6360", "message": "merge\n\nSigned-off-by: achmelo <a.chmelo@gmail.com>", "committedDate": "2020-07-10T10:03:57Z", "type": "commit"}, {"oid": "7a1c59a82f9f7d1aec6ce51dabd533a758404c19", "url": "https://github.com/zowe/api-layer/commit/7a1c59a82f9f7d1aec6ce51dabd533a758404c19", "message": "new tag to exclude test on internal jenkins\nunit test for refresh event listener\n\nSigned-off-by: achmelo <a.chmelo@gmail.com>", "committedDate": "2020-07-10T12:44:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg1NDI4OQ==", "url": "https://github.com/zowe/api-layer/pull/740#discussion_r452854289", "bodyText": "Are there any left? Could this class be removed?", "author": "jandadav", "createdAt": "2020-07-10T13:47:28Z", "path": "gateway-service/src/main/java/org/zowe/apiml/gateway/config/EurekaEventsRegistry.java", "diffHunk": "@@ -25,7 +25,7 @@\n public class EurekaEventsRegistry {\n \n     private final EurekaClient eurekaClient;\n-    private final List<MetadataProcessor> processors;\n+    private final List<EurekaEventListener> processors;", "originalCommit": "7a1c59a82f9f7d1aec6ce51dabd533a758404c19", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU2MjI4Ng==", "url": "https://github.com/zowe/api-layer/pull/740#discussion_r453562286", "bodyText": "not used anymore, class deleted", "author": "achmelo", "createdAt": "2020-07-13T10:46:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg1NDI4OQ=="}], "type": "inlineReview", "revised_code": {"commit": "481da36a194d6dec7a12288ecead470aba098e6d", "chunk": "diff --git a/gateway-service/src/main/java/org/zowe/apiml/gateway/config/EurekaEventsRegistry.java b/gateway-service/src/main/java/org/zowe/apiml/gateway/config/EurekaEventsRegistry.java\ndeleted file mode 100644\nindex 5b702c53..00000000\n--- a/gateway-service/src/main/java/org/zowe/apiml/gateway/config/EurekaEventsRegistry.java\n+++ /dev/null\n\n@@ -1,34 +0,0 @@\n-/*\n- * This program and the accompanying materials are made available under the terms of the\n- * Eclipse Public License v2.0 which accompanies this distribution, and is available at\n- * https://www.eclipse.org/legal/epl-v20.html\n- *\n- * SPDX-License-Identifier: EPL-2.0\n- *\n- * Copyright Contributors to the Zowe Project.\n- */\n-package org.zowe.apiml.gateway.config;\n-\n-import com.netflix.discovery.EurekaClient;\n-import com.netflix.discovery.EurekaEventListener;\n-import lombok.RequiredArgsConstructor;\n-import lombok.extern.slf4j.Slf4j;\n-import org.springframework.boot.context.event.ApplicationReadyEvent;\n-import org.springframework.context.annotation.Configuration;\n-import org.springframework.context.event.EventListener;\n-\n-import java.util.List;\n-\n-@Configuration\n-@Slf4j\n-@RequiredArgsConstructor\n-public class EurekaEventsRegistry {\n-\n-    private final EurekaClient eurekaClient;\n-    private final List<EurekaEventListener> processors;\n-\n-    @EventListener\n-    public void onApplicationEvent(ApplicationReadyEvent event) {\n-        processors.forEach(eurekaClient::registerEventListener);\n-    }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg1NTg5OQ==", "url": "https://github.com/zowe/api-layer/pull/740#discussion_r452855899", "bodyText": "I think you are missing several events, in which the routes do get refreshed.\nCompare with cases in\norg.springframework.cloud.netflix.zuul.ZuulServerAutoConfiguration.ZuulRefreshListener#onApplicationEvent", "author": "jandadav", "createdAt": "2020-07-10T13:50:08Z", "path": "gateway-service/src/main/java/org/zowe/apiml/gateway/metadata/service/RefreshEventListener.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/*\n+ * This program and the accompanying materials are made available under the terms of the\n+ * Eclipse Public License v2.0 which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-v20.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Copyright Contributors to the Zowe Project.\n+ */\n+package org.zowe.apiml.gateway.metadata.service;\n+\n+import org.springframework.cloud.client.discovery.event.HeartbeatEvent;\n+import org.springframework.context.ApplicationEvent;\n+import org.springframework.context.ApplicationListener;\n+\n+public abstract class RefreshEventListener implements ApplicationListener<ApplicationEvent> {\n+\n+    @Override\n+    public void onApplicationEvent(ApplicationEvent event) {\n+        if (isRefreshEvent(event)) {\n+            refresh();\n+        }\n+    }\n+\n+    public abstract void refresh();\n+\n+\n+    boolean isRefreshEvent(ApplicationEvent event) {\n+        return event instanceof HeartbeatEvent;", "originalCommit": "7a1c59a82f9f7d1aec6ce51dabd533a758404c19", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU2MjA2Mg==", "url": "https://github.com/zowe/api-layer/pull/740#discussion_r453562062", "bodyText": "added events same as in ZullServerAutoConfiguration", "author": "achmelo", "createdAt": "2020-07-13T10:46:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg1NTg5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "a2ea8fe796df6ec64df027ee87ec3efbf9c0fe4a", "chunk": "diff --git a/gateway-service/src/main/java/org/zowe/apiml/gateway/metadata/service/RefreshEventListener.java b/gateway-service/src/main/java/org/zowe/apiml/gateway/metadata/service/RefreshEventListener.java\nindex 05efae15..01af5111 100644\n--- a/gateway-service/src/main/java/org/zowe/apiml/gateway/metadata/service/RefreshEventListener.java\n+++ b/gateway-service/src/main/java/org/zowe/apiml/gateway/metadata/service/RefreshEventListener.java\n\n@@ -10,8 +10,13 @@\n package org.zowe.apiml.gateway.metadata.service;\n \n import org.springframework.cloud.client.discovery.event.HeartbeatEvent;\n+import org.springframework.cloud.client.discovery.event.InstanceRegisteredEvent;\n+import org.springframework.cloud.client.discovery.event.ParentHeartbeatEvent;\n+import org.springframework.cloud.context.scope.refresh.RefreshScopeRefreshedEvent;\n+import org.springframework.cloud.netflix.zuul.RoutesRefreshedEvent;\n import org.springframework.context.ApplicationEvent;\n import org.springframework.context.ApplicationListener;\n+import org.springframework.context.event.ContextRefreshedEvent;\n \n public abstract class RefreshEventListener implements ApplicationListener<ApplicationEvent> {\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg2MDc3MA==", "url": "https://github.com/zowe/api-layer/pull/740#discussion_r452860770", "bodyText": "This name should describe more closely what this object does. It is not a listener, it's load balancer registry ... In other pieces of code it looks weird.", "author": "jandadav", "createdAt": "2020-07-10T13:57:59Z", "path": "gateway-service/src/main/java/org/zowe/apiml/gateway/metadata/service/LoadBalancerEventListener.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * This program and the accompanying materials are made available under the terms of the\n+ * Eclipse Public License v2.0 which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-v20.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Copyright Contributors to the Zowe Project.\n+ */\n+package org.zowe.apiml.gateway.metadata.service;\n+\n+import com.netflix.loadbalancer.DynamicServerListLoadBalancer;\n+import org.springframework.core.annotation.Order;\n+import org.springframework.stereotype.Service;\n+\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+@Service\n+@Order(10)\n+public class LoadBalancerEventListener extends RefreshEventListener {", "originalCommit": "7a1c59a82f9f7d1aec6ce51dabd533a758404c19", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU2MTY4MQ==", "url": "https://github.com/zowe/api-layer/pull/740#discussion_r453561681", "bodyText": "renamed to LoadBalancerRegistry", "author": "achmelo", "createdAt": "2020-07-13T10:45:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg2MDc3MA=="}], "type": "inlineReview", "revised_code": {"commit": "a2ea8fe796df6ec64df027ee87ec3efbf9c0fe4a", "chunk": "diff --git a/gateway-service/src/main/java/org/zowe/apiml/gateway/metadata/service/LoadBalancerEventListener.java b/gateway-service/src/main/java/org/zowe/apiml/gateway/metadata/service/LoadBalancerRegistry.java\nsimilarity index 93%\nrename from gateway-service/src/main/java/org/zowe/apiml/gateway/metadata/service/LoadBalancerEventListener.java\nrename to gateway-service/src/main/java/org/zowe/apiml/gateway/metadata/service/LoadBalancerRegistry.java\nindex b05a2cd7..907cae5c 100644\n--- a/gateway-service/src/main/java/org/zowe/apiml/gateway/metadata/service/LoadBalancerEventListener.java\n+++ b/gateway-service/src/main/java/org/zowe/apiml/gateway/metadata/service/LoadBalancerRegistry.java\n\n@@ -18,7 +18,7 @@ import java.util.concurrent.ConcurrentHashMap;\n \n @Service\n @Order(10)\n-public class LoadBalancerEventListener extends RefreshEventListener {\n+public class LoadBalancerRegistry extends RefreshEventListener {\n \n     private Map<String, DynamicServerListLoadBalancer> loadBalancerRegistry = new ConcurrentHashMap<>();\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQzNDQzMg==", "url": "https://github.com/zowe/api-layer/pull/740#discussion_r453434432", "bodyText": "Sonar has some good suggestions about these Thread.sleep(). I would implement them.", "author": "jandadav", "createdAt": "2020-07-13T04:56:34Z", "path": "integration-tests/src/test/java/org/zowe/apiml/gatewayservice/AuthenticationOnDeploymentTest.java", "diffHunk": "@@ -186,4 +186,79 @@ void testReregistration() throws Exception {\n \n         }\n     }\n+\n+    @Test\n+    @Flaky\n+    @NotForMainframeTest\n+    void testServiceStatus() throws Exception {\n+\n+        String serviceId = \"testservice4\";\n+        String host = InetAddress.getLocalHost().getHostName();\n+\n+        List<Integer> ports = Arrays.asList(5678, 5679, 5680);\n+\n+        try (\n+            final VirtualService service1 = new VirtualService(serviceId, 5678);\n+            final VirtualService service2 = new VirtualService(serviceId, 5679);\n+            final VirtualService service3 = new VirtualService(serviceId, 5680)\n+        ) {\n+\n+\n+            service1.addVerifyServlet().start();\n+            service2.addVerifyServlet().start();\n+            service3.addVerifyServlet().start();\n+            for (int i = 0; i < 10; i++) {\n+\n+                ports.forEach(port -> {\n+                    given().when()\n+                        .put(\"https://localhost:10011/eureka/apps/\" + serviceId + \"/\" + host + \":\" + serviceId + \":\" + port + \"/status?value=OUT_OF_SERVICE\")\n+                        .then().statusCode(SC_OK);\n+                });\n+                Thread.sleep(100);", "originalCommit": "7a1c59a82f9f7d1aec6ce51dabd533a758404c19", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU2MTY0NQ==", "url": "https://github.com/zowe/api-layer/pull/740#discussion_r453561645", "bodyText": "replaced with awaitility", "author": "achmelo", "createdAt": "2020-07-13T10:45:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQzNDQzMg=="}], "type": "inlineReview", "revised_code": {"commit": "a2ea8fe796df6ec64df027ee87ec3efbf9c0fe4a", "chunk": "diff --git a/integration-tests/src/test/java/org/zowe/apiml/gatewayservice/AuthenticationOnDeploymentTest.java b/integration-tests/src/test/java/org/zowe/apiml/gatewayservice/AuthenticationOnDeploymentTest.java\nindex aef1276e..d80f55bc 100644\n--- a/integration-tests/src/test/java/org/zowe/apiml/gatewayservice/AuthenticationOnDeploymentTest.java\n+++ b/integration-tests/src/test/java/org/zowe/apiml/gatewayservice/AuthenticationOnDeploymentTest.java\n\n@@ -207,56 +210,61 @@ public class AuthenticationOnDeploymentTest {\n             service1.addVerifyServlet().start();\n             service2.addVerifyServlet().start();\n             service3.addVerifyServlet().start();\n-            for (int i = 0; i < 10; i++) {\n+            String verifyUrl = service1.getGatewayVerifyUrls().get(0);\n+            for (int i = 0; i < 5; i++) {\n \n-                ports.forEach(port -> {\n+                ports.forEach(port -> await().atMost(5, TimeUnit.SECONDS).until(() ->\n                     given().when()\n                         .put(\"https://localhost:10011/eureka/apps/\" + serviceId + \"/\" + host + \":\" + serviceId + \":\" + port + \"/status?value=OUT_OF_SERVICE\")\n-                        .then().statusCode(SC_OK);\n-                });\n-                Thread.sleep(100);\n-                given().when()\n-                    .put(\"https://localhost:10011/eureka/apps/\" + serviceId + \"/\" + host + \":\" + serviceId + \":\" + 5678 + \"/status?value=UP\")\n-                    .then().statusCode(SC_OK);\n-                Thread.sleep(100);\n-                service1.getGatewayVerifyUrls().forEach(x ->\n+                        .then().extract().statusCode() == SC_OK\n+                ));\n+\n+                await().atMost(5, TimeUnit.SECONDS).until(() ->\n+                    given().when()\n+                        .put(\"https://localhost:10011/eureka/apps/\" + serviceId + \"/\" + host + \":\" + serviceId + \":\" + 5678 + \"/status?value=UP\")\n+                        .then().extract().statusCode() == SC_OK\n+                );\n+\n+                await().atMost(5, TimeUnit.SECONDS).until(() ->\n                     given()\n-                        .when().get(x + \"/test\")\n-                        .then().body(is(\"\")).statusCode(is(SC_OK))\n+                        .when().get(verifyUrl + \"/test\")\n+                        .then().extract().statusCode() == SC_OK\n                 );\n \n+\n //                unregister service1\n-                given().when().delete(\"https://localhost:10011/eureka/apps/\" + serviceId + \"/\" + host + \":\" + serviceId + \":\" + 5678).then().statusCode(SC_OK);\n+                await().atMost(5, TimeUnit.SECONDS).until(() ->\n+                    given().when()\n+                        .delete(\"https://localhost:10011/eureka/apps/\" + serviceId + \"/\" + host + \":\" + serviceId + \":\" + 5678)\n+                        .then().extract().statusCode() == SC_OK\n+                );\n \n-                Thread.sleep(100);\n //                set service2 UP\n-                given().when()\n+                await().atMost(5, TimeUnit.SECONDS).until(() -> given().when()\n                     .put(\"https://localhost:10011/eureka/apps/\" + serviceId + \"/\" + host + \":\" + serviceId + \":\" + 5679 + \"/status?value=UP\")\n-                    .then().statusCode(SC_OK);\n+                    .then().extract().statusCode() == SC_OK);\n \n //                call service2\n-                Thread.sleep(100);\n-                service2.getGatewayVerifyUrls().forEach(x ->\n-                    given()\n-                        .when().get(x + \"/test\")\n-                        .then().body(is(\"\")).statusCode(is(SC_OK))\n-                );\n+                await().atMost(5, TimeUnit.SECONDS).until(() -> given()\n+                    .when().get(verifyUrl + \"/test\")\n+                    .then().extract().statusCode() == SC_OK);\n \n //                set service3 UP\n-                given().when()\n+                await().atMost(5, TimeUnit.SECONDS).until(() -> given().when()\n                     .put(\"https://localhost:10011/eureka/apps/\" + serviceId + \"/\" + host + \":\" + serviceId + \":\" + 5680 + \"/status?value=UP\")\n-                    .then().statusCode(SC_OK);\n+                    .then().extract().statusCode() == SC_OK);\n \n //                call service3\n-                Thread.sleep(100);\n-                service3.getGatewayVerifyUrls().forEach(x ->\n-                    given()\n-                        .when().get(x + \"/test\")\n-                        .then().body(is(\"\")).statusCode(is(SC_OK))\n+                await().atMost(5, TimeUnit.SECONDS).until(\n+                    () -> given()\n+                        .when().get(verifyUrl + \"/test\")\n+                        .then().extract().statusCode() == SC_OK\n                 );\n \n-                service1.start(\"UP\");\n-                Thread.sleep(100);\n+                await().atMost(5, TimeUnit.SECONDS).until(\n+                    () -> service1.postRegistration(\"UP\")\n+                        .then().extract().statusCode() == SC_NO_CONTENT\n+                );\n             }\n \n         }\n"}}, {"oid": "a2ea8fe796df6ec64df027ee87ec3efbf9c0fe4a", "url": "https://github.com/zowe/api-layer/commit/a2ea8fe796df6ec64df027ee87ec3efbf9c0fe4a", "message": "rename LB registry, replace sleep with await\n\nSigned-off-by: achmelo <a.chmelo@gmail.com>", "committedDate": "2020-07-13T10:15:07Z", "type": "commit"}, {"oid": "481da36a194d6dec7a12288ecead470aba098e6d", "url": "https://github.com/zowe/api-layer/commit/481da36a194d6dec7a12288ecead470aba098e6d", "message": "delete unused eureka events registry\n\nSigned-off-by: achmelo <a.chmelo@gmail.com>", "committedDate": "2020-07-13T10:17:25Z", "type": "commit"}, {"oid": "b7b54d63c659d14d38ff12ac8d3686c025437260", "url": "https://github.com/zowe/api-layer/commit/b7b54d63c659d14d38ff12ac8d3686c025437260", "message": "Merge branch 'master' into rip/GH682/request_context_n3", "committedDate": "2020-07-13T10:18:02Z", "type": "commit"}, {"oid": "04aa0d454a45404e7703e30734ac7560cea9fc24", "url": "https://github.com/zowe/api-layer/commit/04aa0d454a45404e7703e30734ac7560cea9fc24", "message": "rename field, fix code smell\n\nSigned-off-by: achmelo <a.chmelo@gmail.com>", "committedDate": "2020-07-13T10:48:07Z", "type": "commit"}]}