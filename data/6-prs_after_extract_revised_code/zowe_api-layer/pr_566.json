{"pr_number": 566, "pr_title": "Export z/OSMF JWT public key", "pr_createdAt": "2020-03-19T18:39:16Z", "pr_url": "https://github.com/zowe/api-layer/pull/566", "timeline": [{"oid": "1fb48a1f0230066a275ecc8dafe96b4ab404736c", "url": "https://github.com/zowe/api-layer/commit/1fb48a1f0230066a275ecc8dafe96b4ab404736c", "message": "Export z/OSMF JWT public key\n\nSigned-off-by: Petr Plavjanik <plavjanik@gmail.com>", "committedDate": "2020-03-19T18:28:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM0NDU1Mw==", "url": "https://github.com/zowe/api-layer/pull/566#discussion_r395344553", "bodyText": "Could be written using block (row) of data instant of chars", "author": "pj892031", "createdAt": "2020-03-19T22:02:22Z", "path": "gateway-service/src/main/java/org/zowe/apiml/gateway/security/login/zosmf/JwkToPublicKeyConverter.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/*\n+ * This program and the accompanying materials are made available under the terms of the\n+ * Eclipse Public License v2.0 which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-v20.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Copyright Contributors to the Zowe Project.\n+ */\n+package org.zowe.apiml.gateway.security.login.zosmf;\n+\n+import java.security.PublicKey;\n+import java.text.ParseException;\n+import java.util.Base64;\n+\n+import com.nimbusds.jose.JOSEException;\n+import com.nimbusds.jose.jwk.JWKSet;\n+\n+public class JwkToPublicKeyConverter {\n+\n+    /**\n+     * Converts the first public key in JWT in JSON to PEM format.\n+     */\n+    public String convertFirstPublicKeyJwkToPem(String jwkJson) {\n+        try {\n+            PublicKey key = JWKSet.parse(jwkJson).toPublicJWKSet().getKeys().get(0).toRSAKey().toPublicKey();\n+            String encoded = Base64.getEncoder().encodeToString(key.getEncoded());\n+            StringBuilder s = new StringBuilder();\n+            s.append(\"-----BEGIN PUBLIC KEY-----\");\n+            for (int i = 0; i < encoded.length(); i++) {", "originalCommit": "1fb48a1f0230066a275ecc8dafe96b4ab404736c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM0NDkzNQ==", "url": "https://github.com/zowe/api-layer/pull/566#discussion_r395344935", "bodyText": "I think it is not necessary to check last character, it can write one row with 65 characters", "author": "pj892031", "createdAt": "2020-03-19T22:03:23Z", "path": "gateway-service/src/main/java/org/zowe/apiml/gateway/security/login/zosmf/JwkToPublicKeyConverter.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/*\n+ * This program and the accompanying materials are made available under the terms of the\n+ * Eclipse Public License v2.0 which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-v20.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Copyright Contributors to the Zowe Project.\n+ */\n+package org.zowe.apiml.gateway.security.login.zosmf;\n+\n+import java.security.PublicKey;\n+import java.text.ParseException;\n+import java.util.Base64;\n+\n+import com.nimbusds.jose.JOSEException;\n+import com.nimbusds.jose.jwk.JWKSet;\n+\n+public class JwkToPublicKeyConverter {\n+\n+    /**\n+     * Converts the first public key in JWT in JSON to PEM format.\n+     */\n+    public String convertFirstPublicKeyJwkToPem(String jwkJson) {\n+        try {\n+            PublicKey key = JWKSet.parse(jwkJson).toPublicJWKSet().getKeys().get(0).toRSAKey().toPublicKey();\n+            String encoded = Base64.getEncoder().encodeToString(key.getEncoded());\n+            StringBuilder s = new StringBuilder();\n+            s.append(\"-----BEGIN PUBLIC KEY-----\");\n+            for (int i = 0; i < encoded.length(); i++) {\n+                if (((i % 64) == 0) && (i != (encoded.length() - 1))) {", "originalCommit": "1fb48a1f0230066a275ecc8dafe96b4ab404736c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM0NDk5MQ==", "url": "https://github.com/zowe/api-layer/pull/566#discussion_r395344991", "bodyText": "'s'", "author": "pj892031", "createdAt": "2020-03-19T22:03:32Z", "path": "gateway-service/src/main/java/org/zowe/apiml/gateway/security/login/zosmf/JwkToPublicKeyConverter.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/*\n+ * This program and the accompanying materials are made available under the terms of the\n+ * Eclipse Public License v2.0 which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-v20.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Copyright Contributors to the Zowe Project.\n+ */\n+package org.zowe.apiml.gateway.security.login.zosmf;\n+\n+import java.security.PublicKey;\n+import java.text.ParseException;\n+import java.util.Base64;\n+\n+import com.nimbusds.jose.JOSEException;\n+import com.nimbusds.jose.jwk.JWKSet;\n+\n+public class JwkToPublicKeyConverter {\n+\n+    /**\n+     * Converts the first public key in JWT in JSON to PEM format.\n+     */\n+    public String convertFirstPublicKeyJwkToPem(String jwkJson) {\n+        try {\n+            PublicKey key = JWKSet.parse(jwkJson).toPublicJWKSet().getKeys().get(0).toRSAKey().toPublicKey();\n+            String encoded = Base64.getEncoder().encodeToString(key.getEncoded());\n+            StringBuilder s = new StringBuilder();\n+            s.append(\"-----BEGIN PUBLIC KEY-----\");\n+            for (int i = 0; i < encoded.length(); i++) {\n+                if (((i % 64) == 0) && (i != (encoded.length() - 1))) {\n+                    s.append(\"\\n\");", "originalCommit": "1fb48a1f0230066a275ecc8dafe96b4ab404736c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM0NTE5NQ==", "url": "https://github.com/zowe/api-layer/pull/566#discussion_r395345195", "bodyText": "It can use BufferedWriter", "author": "pj892031", "createdAt": "2020-03-19T22:04:05Z", "path": "gateway-service/src/main/java/org/zowe/apiml/gateway/security/login/zosmf/ZosmfJwkToPublicKey.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * This program and the accompanying materials are made available under the terms of the\n+ * Eclipse Public License v2.0 which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-v20.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Copyright Contributors to the Zowe Project.\n+ */\n+package org.zowe.apiml.gateway.security.login.zosmf;\n+\n+import java.io.FileNotFoundException;\n+import java.io.PrintWriter;\n+\n+import org.springframework.stereotype.Component;\n+import org.springframework.web.client.HttpClientErrorException;\n+import org.springframework.web.client.RestTemplate;\n+\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.slf4j.Slf4j;\n+\n+@Component\n+@RequiredArgsConstructor\n+@Slf4j\n+public class ZosmfJwkToPublicKey {\n+\n+    protected final RestTemplate restTemplateWithoutKeystore;\n+\n+    /**\n+     * Write public key that can be used to validate z/OSMF JWT tokens.\n+     * @param zosmfUrl Base URL of z/OSMF without trailing /\n+     * @param filename File name of the resulting PEM file\n+     * @return True when the file has been updated\n+     * @throws FileNotFoundException when the filename is invalid\n+     */\n+    public boolean updateJwtPublicKeyFile(String zosmfUrl, String filename) throws FileNotFoundException {\n+        try {\n+            String jwkJson = restTemplateWithoutKeystore.getForObject(zosmfUrl + \"/jwt/ibm/api/zOSMFBuilder/jwk\",\n+                    String.class);\n+            JwkToPublicKeyConverter converter = new JwkToPublicKeyConverter();\n+            String pem = converter.convertFirstPublicKeyJwkToPem(jwkJson);\n+            try (PrintWriter out = new PrintWriter(filename)) {", "originalCommit": "1fb48a1f0230066a275ecc8dafe96b4ab404736c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ4NTUwMg==", "url": "https://github.com/zowe/api-layer/pull/566#discussion_r395485502", "bodyText": "Just info. Up to you :)\nhttps://www.baeldung.com/junit-5-temporary-directory", "author": "ilkinabdullayev", "createdAt": "2020-03-20T08:12:30Z", "path": "gateway-service/src/test/java/org/zowe/apiml/gateway/security/login/zosmf/ZosmfJwkToPublicKeyTest.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * This program and the accompanying materials are made available under the terms of the\n+ * Eclipse Public License v2.0 which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-v20.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Copyright Contributors to the Zowe Project.\n+ */\n+\n+package org.zowe.apiml.gateway.security.login.zosmf;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+\n+import org.junit.jupiter.api.Test;\n+import org.springframework.web.client.RestTemplate;\n+\n+public class ZosmfJwkToPublicKeyTest {\n+\n+    @Test\n+    public void zosmfJwkIsConvertedToPublicKey() throws IOException {\n+        RestTemplate restTemplate = mock(RestTemplate.class);\n+        String jwk = \"{\\\"keys\\\":[{\\\"kty\\\":\\\"RSA\\\",\\\"e\\\":\\\"AQAB\\\",\\\"use\\\":\\\"sig\\\",\\\"kid\\\":\\\"ozG_ySMHRsVQFmN1mVBeS-WtCupY1r-K7ewben09IBg\\\",\\\"alg\\\":\\\"RS256\\\",\\\"n\\\":\\\"wRdwksGIAR2A4cHsoOsYcGp5AmQl5ZjF5xIPXeyjkaLHmNTMvjixdWso1ecVlVeg_6pIXzMRhmOvmjXjz1PLfI2GD3drmeqsStjISWdDfH_rIQCYc9wYbWIZ3bQ0wFRDaVpZ6iOZ2iNcIevvZQKNw9frJthKSMM52JtsgwrgN--Ub2cKWioU_d52SC2SfDzOdnChqlU7xkqXwKXSUqcGM92A35dJJXkwbZhAHnDy5FST1HqYq27MOLzBkChw1bJQHZtlSqkxcHPxphnnbFKQmwRVUvyC5kfBemX-7Mzp1wDogt5lGvBAf3Eq8rFxaevAke327rM7q2KqO_LDMN2J-Q\\\"}]}\";\n+        String expectedPublicKey = \"-----BEGIN PUBLIC KEY-----\\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAwRdwksGIAR2A4cHsoOsY\\ncGp5AmQl5ZjF5xIPXeyjkaLHmNTMvjixdWso1ecVlVeg/6pIXzMRhmOvmjXjz1PL\\nfI2GD3drmeqsStjISWdDfH/rIQCYc9wYbWIZ3bQ0wFRDaVpZ6iOZ2iNcIevvZQKN\\nw9frJthKSMM52JtsgwrgN++Ub2cKWioU/d52SC2SfDzOdnChqlU7xkqXwKXSUqcG\\nM92A35dJJXkwbZhAHnDy5FST1HqYq27MOLzBkChw1bJQHZtlSqkxcHPxphnnbFKQ\\nmwRVUvyC5kfBemX+7Mzp1wDogt5lGvBAf3Eq8rFxaevAke327rM7q2KqO/LDMN2J\\n+QIDAQAB\\n-----END PUBLIC KEY-----\";\n+\n+        when(restTemplate.getForObject(\"https://zosmf:1433/jwt/ibm/api/zOSMFBuilder/jwk\", String.class)).thenReturn(jwk);\n+\n+        ZosmfJwkToPublicKey zosmfJwkToPublicKey = new ZosmfJwkToPublicKey(restTemplate);\n+\n+        File f = File.createTempFile(\"jwt\", null, new File(System.getProperty(\"java.io.tmpdir\")));\n+        try {\n+            String filename = f.getName();\n+            assertTrue(zosmfJwkToPublicKey.updateJwtPublicKeyFile(\"https://zosmf:1433\", filename));\n+            assertEquals(expectedPublicKey, new String(Files.readAllBytes(Paths.get(filename))).trim());\n+        } finally {\n+            f.delete();\n+        }", "originalCommit": "1fb48a1f0230066a275ecc8dafe96b4ab404736c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTU3ODk0Nw==", "url": "https://github.com/zowe/api-layer/pull/566#discussion_r395578947", "bodyText": "Thanks. That looks more useful :-) I will give it a try", "author": "plavjanik", "createdAt": "2020-03-20T11:32:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ4NTUwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTYwMDQyNQ==", "url": "https://github.com/zowe/api-layer/pull/566#discussion_r395600425", "bodyText": "I have tried but I am not able to get rid of org.junit.jupiter.api.extension.ParameterResolutionException: No ParameterResolver registered for parameter [java.nio.file.Path tempDir]", "author": "plavjanik", "createdAt": "2020-03-20T12:21:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ4NTUwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTYwMDc3Nw==", "url": "https://github.com/zowe/api-layer/pull/566#discussion_r395600777", "bodyText": "Feel free to do it in this branch if you want", "author": "plavjanik", "createdAt": "2020-03-20T12:22:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ4NTUwMg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "7b2850e2d79f7fb21fe45546a1440139a5eea333", "url": "https://github.com/zowe/api-layer/commit/7b2850e2d79f7fb21fe45546a1440139a5eea333", "message": "Enable using z/OSMF JWT token if supported by z/OSMF", "committedDate": "2020-03-20T11:30:20Z", "type": "commit"}, {"oid": "be747164d9f9b43bbf9e55005babfa525ce0c2d4", "url": "https://github.com/zowe/api-layer/commit/be747164d9f9b43bbf9e55005babfa525ce0c2d4", "message": "Merge branch 'master' into zosmf-jwt-public-key", "committedDate": "2020-03-20T11:32:38Z", "type": "commit"}, {"oid": "5a2a2aa8c5eaeec5de23ee4896022b5dca4aa61e", "url": "https://github.com/zowe/api-layer/commit/5a2a2aa8c5eaeec5de23ee4896022b5dca4aa61e", "message": "Merge branch 'master' into zosmf-jwt-public-key", "committedDate": "2020-03-24T10:01:23Z", "type": "commit"}, {"oid": "a9301324e8a03aeb1bd2c53817072dda03ab15c9", "url": "https://github.com/zowe/api-layer/commit/a9301324e8a03aeb1bd2c53817072dda03ab15c9", "message": "Merge branch 'master' into zosmf-jwt-public-key", "committedDate": "2020-03-25T07:22:33Z", "type": "commit"}]}