{"pr_number": 508, "pr_title": "Enable encoded slashes on Tomcat", "pr_createdAt": "2020-02-17T14:20:08Z", "pr_url": "https://github.com/zowe/api-layer/pull/508", "timeline": [{"oid": "c8e01b9bae62fa9848462b3b4ac361b7d316def1", "url": "https://github.com/zowe/api-layer/commit/c8e01b9bae62fa9848462b3b4ac361b7d316def1", "message": "re-written unit tests for TomcatFilter\n\nSigned-off-by: Elena Kubantseva <elena.kubantseva@broadcom.com>", "committedDate": "2020-02-17T14:27:00Z", "type": "forcePushed"}, {"oid": "6c8a8e7569c3e67cf814701e606a6a3ebd6de359", "url": "https://github.com/zowe/api-layer/commit/6c8a8e7569c3e67cf814701e606a6a3ebd6de359", "message": "re-written unit tests for TomcatFilter\n\nSigned-off-by: Elena Kubantseva <elena.kubantseva@broadcom.com>", "committedDate": "2020-02-18T08:59:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE1MTM2OQ==", "url": "https://github.com/zowe/api-layer/pull/508#discussion_r381151369", "bodyText": "May I ask why reference type(not primitive boolean)? It requires to check whether is null:\nboolean allowEncoded = allowEncodedSlashes != null && allowEncodedSlashes;", "author": "ilkinabdullayev", "createdAt": "2020-02-19T08:54:18Z", "path": "gateway-service/src/main/java/org/zowe/apiml/gateway/filters/pre/TomcatFilter.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * This program and the accompanying materials are made available under the terms of the\n+ * Eclipse Public License v2.0 which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-v20.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Copyright Contributors to the Zowe Project.\n+ */\n+package org.zowe.apiml.gateway.filters.pre;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import lombok.RequiredArgsConstructor;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.MediaType;\n+import org.springframework.stereotype.Component;\n+import org.zowe.apiml.message.core.Message;\n+import org.zowe.apiml.message.core.MessageService;\n+import org.zowe.apiml.message.log.ApimlLogger;\n+import org.zowe.apiml.product.logging.annotations.InjectApimlLogger;\n+\n+import javax.servlet.*;\n+import javax.servlet.annotation.WebFilter;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import java.io.IOException;\n+import java.net.URLDecoder;\n+\n+@Component\n+@WebFilter\n+@RequiredArgsConstructor\n+public class TomcatFilter implements Filter {\n+\n+    private final MessageService messageService;\n+    private final ObjectMapper mapper;\n+\n+    @Value(\"${apiml.service.allowEncodedSlashes:#{false}}\")\n+    private Boolean allowEncodedSlashes;", "originalCommit": "5cd5dc059ee6494599b389e059bad4246757cc73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTIzMjEzNA==", "url": "https://github.com/zowe/api-layer/pull/508#discussion_r381232134", "bodyText": "I did it because of unit tests, where we need to reset this field, and for this porpose I used 'ReflectionTestUtils.setField', where the value of field is Object. I forgot about autoboxing...", "author": "arxioly", "createdAt": "2020-02-19T11:23:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE1MTM2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "b889d4eb8b5b7c490b8e08abcfd64d3aebc6224d", "chunk": "diff --git a/gateway-service/src/main/java/org/zowe/apiml/gateway/filters/pre/TomcatFilter.java b/gateway-service/src/main/java/org/zowe/apiml/gateway/filters/pre/TomcatFilter.java\nindex fddf662e..c826de9d 100644\n--- a/gateway-service/src/main/java/org/zowe/apiml/gateway/filters/pre/TomcatFilter.java\n+++ b/gateway-service/src/main/java/org/zowe/apiml/gateway/filters/pre/TomcatFilter.java\n\n@@ -36,7 +36,7 @@ public class TomcatFilter implements Filter {\n     private final ObjectMapper mapper;\n \n     @Value(\"${apiml.service.allowEncodedSlashes:#{false}}\")\n-    private Boolean allowEncodedSlashes;\n+    private boolean allowEncodedSlashes;\n \n     @InjectApimlLogger\n     private final ApimlLogger apimlLog = ApimlLogger.empty();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE1NjM2Ng==", "url": "https://github.com/zowe/api-layer/pull/508#discussion_r381156366", "bodyText": "ApimlLogger has method that takes Message as a argument.\n   /**\n     * Method which allows to log text in its level type, without passing message parameters.\n     *\n     * @param message the message\n     */\n    public void log(Message message) {", "author": "ilkinabdullayev", "createdAt": "2020-02-19T09:04:02Z", "path": "gateway-service/src/main/java/org/zowe/apiml/gateway/filters/pre/TomcatFilter.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * This program and the accompanying materials are made available under the terms of the\n+ * Eclipse Public License v2.0 which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-v20.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Copyright Contributors to the Zowe Project.\n+ */\n+package org.zowe.apiml.gateway.filters.pre;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import lombok.RequiredArgsConstructor;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.MediaType;\n+import org.springframework.stereotype.Component;\n+import org.zowe.apiml.message.core.Message;\n+import org.zowe.apiml.message.core.MessageService;\n+import org.zowe.apiml.message.log.ApimlLogger;\n+import org.zowe.apiml.product.logging.annotations.InjectApimlLogger;\n+\n+import javax.servlet.*;\n+import javax.servlet.annotation.WebFilter;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import java.io.IOException;\n+import java.net.URLDecoder;\n+\n+@Component\n+@WebFilter\n+@RequiredArgsConstructor\n+public class TomcatFilter implements Filter {\n+\n+    private final MessageService messageService;\n+    private final ObjectMapper mapper;\n+\n+    @Value(\"${apiml.service.allowEncodedSlashes:#{false}}\")\n+    private Boolean allowEncodedSlashes;\n+\n+    @InjectApimlLogger\n+    private final ApimlLogger apimlLog = ApimlLogger.empty();\n+\n+    @Override\n+    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {\n+        HttpServletRequest req = (HttpServletRequest) request;\n+        HttpServletResponse res = (HttpServletResponse) response;\n+\n+        String uri = req.getRequestURI();\n+        String decodedUri = URLDecoder.decode(uri, \"UTF-8\");\n+        final boolean isRequestEncoded = !uri.equals(decodedUri);\n+\n+        Message message = messageService.createMessage(\"org.zowe.apiml.gateway.requestContainEncodedSlash\", uri);\n+        boolean allowEncoded = allowEncodedSlashes != null && allowEncodedSlashes;\n+        if (!allowEncoded && isRequestEncoded) {\n+            res.setStatus(HttpStatus.BAD_REQUEST.value());\n+            res.setContentType(MediaType.APPLICATION_JSON_UTF8_VALUE);\n+            try {\n+                mapper.writeValue(res.getWriter(), message.mapToView());\n+            } catch (IOException e) {\n+                apimlLog.log(\"org.zowe.apiml.security.errorWrittingResponse\", e.getMessage());\n+                throw new ServletException(\"Error writing response\", e);\n+            }\n+            apimlLog.log(\"org.zowe.apiml.gateway.requestContainEncodedSlash\", uri);", "originalCommit": "5cd5dc059ee6494599b389e059bad4246757cc73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTI0MDE1OA==", "url": "https://github.com/zowe/api-layer/pull/508#discussion_r381240158", "bodyText": "Sorry, My wrong:\nSo,\nIn the line 53 you have message instance already. In the line 64, with same params Message instance is created inside APIMLogger. My point was that you can send your message object to APIMLLogger which you have already.", "author": "ilkinabdullayev", "createdAt": "2020-02-19T11:42:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE1NjM2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTI0MTEwNQ==", "url": "https://github.com/zowe/api-layer/pull/508#discussion_r381241105", "bodyText": "Good point. Thanks!", "author": "arxioly", "createdAt": "2020-02-19T11:44:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE1NjM2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "b889d4eb8b5b7c490b8e08abcfd64d3aebc6224d", "chunk": "diff --git a/gateway-service/src/main/java/org/zowe/apiml/gateway/filters/pre/TomcatFilter.java b/gateway-service/src/main/java/org/zowe/apiml/gateway/filters/pre/TomcatFilter.java\nindex fddf662e..c826de9d 100644\n--- a/gateway-service/src/main/java/org/zowe/apiml/gateway/filters/pre/TomcatFilter.java\n+++ b/gateway-service/src/main/java/org/zowe/apiml/gateway/filters/pre/TomcatFilter.java\n\n@@ -36,7 +36,7 @@ public class TomcatFilter implements Filter {\n     private final ObjectMapper mapper;\n \n     @Value(\"${apiml.service.allowEncodedSlashes:#{false}}\")\n-    private Boolean allowEncodedSlashes;\n+    private boolean allowEncodedSlashes;\n \n     @InjectApimlLogger\n     private final ApimlLogger apimlLog = ApimlLogger.empty();\n"}}, {"oid": "8b3c66f9d5a07b26df09696d578e0a98ac4c67f2", "url": "https://github.com/zowe/api-layer/commit/8b3c66f9d5a07b26df09696d578e0a98ac4c67f2", "message": "ignore integration test\n\nSigned-off-by: cZikos <christos.zikos@broadcom.com>", "committedDate": "2020-02-19T11:55:37Z", "type": "forcePushed"}, {"oid": "b889d4eb8b5b7c490b8e08abcfd64d3aebc6224d", "url": "https://github.com/zowe/api-layer/commit/b889d4eb8b5b7c490b8e08abcfd64d3aebc6224d", "message": "removed redundant log messages\n\nSigned-off-by: Elena Kubantseva <elena.kubantseva@broadcom.com>", "committedDate": "2020-02-19T14:59:53Z", "type": "forcePushed"}, {"oid": "7a7f6f67533b670d30ebf9555d14c2fb8f06285f", "url": "https://github.com/zowe/api-layer/commit/7a7f6f67533b670d30ebf9555d14c2fb8f06285f", "message": "remove stacktrace\n\nSigned-off-by: cZikos <christos.zikos@broadcom.com>", "committedDate": "2020-02-20T12:10:34Z", "type": "forcePushed"}, {"oid": "81169db6bf3695ba9395d22e1a92f65146ba4d72", "url": "https://github.com/zowe/api-layer/commit/81169db6bf3695ba9395d22e1a92f65146ba4d72", "message": "first commit\n\nSigned-off-by: cZikos <christos.zikos@broadcom.com>", "committedDate": "2020-02-20T14:52:32Z", "type": "commit"}, {"oid": "a73a4d177770358c1640e9b70c929e394e5ae094", "url": "https://github.com/zowe/api-layer/commit/a73a4d177770358c1640e9b70c929e394e5ae094", "message": "merge spring changes\n\nSigned-off-by: cZikos <christos.zikos@broadcom.com>", "committedDate": "2020-02-20T14:52:32Z", "type": "commit"}, {"oid": "c5a502b4677272bfcdf0c43838155516d19d30bf", "url": "https://github.com/zowe/api-layer/commit/c5a502b4677272bfcdf0c43838155516d19d30bf", "message": "minor fixes after merge\n\nSigned-off-by: cZikos <christos.zikos@broadcom.com>", "committedDate": "2020-02-20T14:52:32Z", "type": "commit"}, {"oid": "fc9f6752f7ee5ee9dfe370aaea5b0777da175d35", "url": "https://github.com/zowe/api-layer/commit/fc9f6752f7ee5ee9dfe370aaea5b0777da175d35", "message": "unused logger removed\n\nSigned-off-by: Vsevolod Khanin <vsevolod.khanin@broadcom.com>", "committedDate": "2020-02-20T14:52:33Z", "type": "commit"}, {"oid": "a426242a691af731c76aa2083ae6dbd992f92ac0", "url": "https://github.com/zowe/api-layer/commit/a426242a691af731c76aa2083ae6dbd992f92ac0", "message": "added http interceptor\n\nSigned-off-by: Elena Kubantseva <elena.kubantseva@broadcom.com>", "committedDate": "2020-02-20T14:53:33Z", "type": "commit"}, {"oid": "c00f0b872221013150e6e68acc6bac129b88117f", "url": "https://github.com/zowe/api-layer/commit/c00f0b872221013150e6e68acc6bac129b88117f", "message": "Merge master + create sample valve\n\nSigned-off-by: cZikos <christos.zikos@broadcom.com>", "committedDate": "2020-02-20T14:54:05Z", "type": "commit"}, {"oid": "04b13781f4458997b466443309fb66030644bf5d", "url": "https://github.com/zowe/api-layer/commit/04b13781f4458997b466443309fb66030644bf5d", "message": "Merge master + create sample valve\n\nSigned-off-by: cZikos <christos.zikos@broadcom.com>", "committedDate": "2020-02-20T14:54:06Z", "type": "commit"}, {"oid": "eddb76b7cae2ac93e695d03cce6e149819dea2e4", "url": "https://github.com/zowe/api-layer/commit/eddb76b7cae2ac93e695d03cce6e149819dea2e4", "message": "added servlet filter instead of valve and interceptor\n\nSigned-off-by: Elena Kubantseva <elena.kubantseva@broadcom.com>", "committedDate": "2020-02-20T14:55:05Z", "type": "commit"}, {"oid": "085ce18db5ebfb9627955dc5ed0ea666fbe0b37f", "url": "https://github.com/zowe/api-layer/commit/085ce18db5ebfb9627955dc5ed0ea666fbe0b37f", "message": "re-written unit tests for TomcatFilter\n\nSigned-off-by: Elena Kubantseva <elena.kubantseva@broadcom.com>", "committedDate": "2020-02-20T14:55:05Z", "type": "commit"}, {"oid": "2c86d3aeb6967b212a31a15c3a4b280ca3c83ba4", "url": "https://github.com/zowe/api-layer/commit/2c86d3aeb6967b212a31a15c3a4b280ca3c83ba4", "message": "ignore integration test\n\nSigned-off-by: cZikos <christos.zikos@broadcom.com>", "committedDate": "2020-02-20T14:55:05Z", "type": "commit"}, {"oid": "d18373a59755ec55544c9cdbbf3aed302c867c8c", "url": "https://github.com/zowe/api-layer/commit/d18373a59755ec55544c9cdbbf3aed302c867c8c", "message": "some fixes\n\nSigned-off-by: Elena Kubantseva <elena.kubantseva@broadcom.com>", "committedDate": "2020-02-20T14:55:06Z", "type": "commit"}, {"oid": "dea9f699f7eeab094fb0a1d6f4c01d4116ae983c", "url": "https://github.com/zowe/api-layer/commit/dea9f699f7eeab094fb0a1d6f4c01d4116ae983c", "message": "one more small change\n\nSigned-off-by: Elena Kubantseva <elena.kubantseva@broadcom.com>", "committedDate": "2020-02-20T14:55:06Z", "type": "commit"}, {"oid": "d5d01ff1b5ff4b63a439eafe2a880d16aa5e033f", "url": "https://github.com/zowe/api-layer/commit/d5d01ff1b5ff4b63a439eafe2a880d16aa5e033f", "message": "removed redundant log messages\n\nSigned-off-by: Elena Kubantseva <elena.kubantseva@broadcom.com>", "committedDate": "2020-02-20T14:55:06Z", "type": "commit"}, {"oid": "525ca3962e17cd05459b23cf1775a415ceea671c", "url": "https://github.com/zowe/api-layer/commit/525ca3962e17cd05459b23cf1775a415ceea671c", "message": "fix unit test\n\nSigned-off-by: cZikos <christos.zikos@broadcom.com>", "committedDate": "2020-02-20T14:55:06Z", "type": "commit"}, {"oid": "b7bbee14ace154e617c0383fb91d58e4bf324021", "url": "https://github.com/zowe/api-layer/commit/b7bbee14ace154e617c0383fb91d58e4bf324021", "message": "fix integration test and typo\n\nSigned-off-by: cZikos <christos.zikos@broadcom.com>", "committedDate": "2020-02-20T14:55:06Z", "type": "commit"}, {"oid": "e0e75166fca24c31f1105d88b3b384f2a800b8b1", "url": "https://github.com/zowe/api-layer/commit/e0e75166fca24c31f1105d88b3b384f2a800b8b1", "message": "remove stacktrace\n\nSigned-off-by: cZikos <christos.zikos@broadcom.com>", "committedDate": "2020-02-20T14:55:06Z", "type": "commit"}, {"oid": "820be569c0e7b34337809e17769e0266bab1f470", "url": "https://github.com/zowe/api-layer/commit/820be569c0e7b34337809e17769e0266bab1f470", "message": "remove unused imports\n\nSigned-off-by: cZikos <christos.zikos@broadcom.com>", "committedDate": "2020-02-20T14:55:06Z", "type": "commit"}, {"oid": "f45e93a35f038be2ae75bfc440adb441b0f89878", "url": "https://github.com/zowe/api-layer/commit/f45e93a35f038be2ae75bfc440adb441b0f89878", "message": "fix discoverable client swagger url\n\nSigned-off-by: cZikos <christos.zikos@broadcom.com>", "committedDate": "2020-02-20T14:55:06Z", "type": "commit"}, {"oid": "7f3b7eab06c0a9cb94683bc49a582e0fcd30f219", "url": "https://github.com/zowe/api-layer/commit/7f3b7eab06c0a9cb94683bc49a582e0fcd30f219", "message": "change default property\n\nSigned-off-by: cZikos <christos.zikos@broadcom.com>", "committedDate": "2020-02-20T14:55:06Z", "type": "commit"}, {"oid": "7f3b7eab06c0a9cb94683bc49a582e0fcd30f219", "url": "https://github.com/zowe/api-layer/commit/7f3b7eab06c0a9cb94683bc49a582e0fcd30f219", "message": "change default property\n\nSigned-off-by: cZikos <christos.zikos@broadcom.com>", "committedDate": "2020-02-20T14:55:06Z", "type": "forcePushed"}]}