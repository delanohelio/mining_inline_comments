{"pr_number": 1338, "pr_title": "Fix unused dependencies breaking with gradle 6.4", "pr_createdAt": "2020-05-13T16:41:13Z", "pr_url": "https://github.com/palantir/gradle-baseline/pull/1338", "timeline": [{"oid": "52b382231d58c2bc30736adb58171b00f47a28fb", "url": "https://github.com/palantir/gradle-baseline/commit/52b382231d58c2bc30736adb58171b00f47a28fb", "message": "Copy all compileClasspath attributes", "committedDate": "2020-05-13T11:51:34Z", "type": "commit"}, {"oid": "072dd925c68432a3ad9dd3a889abc8c9a7b20911", "url": "https://github.com/palantir/gradle-baseline/commit/072dd925c68432a3ad9dd3a889abc8c9a7b20911", "message": "make sure dependenciesConfigurations are resolved as task inputs", "committedDate": "2020-05-13T11:54:09Z", "type": "commit"}, {"oid": "c12a2318dd2377e07d61c3d00671c0a1abbdad57", "url": "https://github.com/palantir/gradle-baseline/commit/c12a2318dd2377e07d61c3d00671c0a1abbdad57", "message": "manually set up LIBRARY_ELEMENTS_ATTRIBUTE when allowed", "committedDate": "2020-05-13T14:51:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU5MTAzMA==", "url": "https://github.com/palantir/gradle-baseline/pull/1338#discussion_r424591030", "bodyText": "this is really the key, if you don't set this then gradle doesn't wire up the tasks that produce various files inside these configurations as inputs...\nI think we were just getting lucky before.", "author": "dansanduleac", "createdAt": "2020-05-13T16:58:09Z", "path": "gradle-baseline-java/src/main/groovy/com/palantir/baseline/tasks/CheckUnusedDependenciesTask.java", "diffHunk": "@@ -176,7 +176,7 @@ private boolean shouldIgnore(ResolvedArtifact artifact) {\n         return ignore.get().contains(BaselineExactDependencies.asString(artifact));\n     }\n \n-    @Input\n+    @InputFiles", "originalCommit": "c12a2318dd2377e07d61c3d00671c0a1abbdad57", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "01cab0571f2228d3a5cd54c2e01e32322f90ea4a", "chunk": "diff --git a/gradle-baseline-java/src/main/groovy/com/palantir/baseline/tasks/CheckUnusedDependenciesTask.java b/gradle-baseline-java/src/main/groovy/com/palantir/baseline/tasks/CheckUnusedDependenciesTask.java\nindex a6b98b10..8c31420c 100644\n--- a/gradle-baseline-java/src/main/groovy/com/palantir/baseline/tasks/CheckUnusedDependenciesTask.java\n+++ b/gradle-baseline-java/src/main/groovy/com/palantir/baseline/tasks/CheckUnusedDependenciesTask.java\n\n@@ -176,7 +176,7 @@ public class CheckUnusedDependenciesTask extends DefaultTask {\n         return ignore.get().contains(BaselineExactDependencies.asString(artifact));\n     }\n \n-    @InputFiles\n+    @Classpath\n     public final Provider<List<Configuration>> getDependenciesConfigurations() {\n         return dependenciesConfigurations;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU5MjQ4Nw==", "url": "https://github.com/palantir/gradle-baseline/pull/1338#discussion_r424592487", "bodyText": "This is mostly an optimisation so we don't force the production of jars since we can use the classes dirs.\nGradle 6.4 has made it so that it sometimes forces jars when resolving compileClasspath in order to be able to confidently extract the Automatic-Module-Name if there is one set in the manifest.\nHowever I think we can always just use the classes dir for this case, as it won't change the behaviour.", "author": "dansanduleac", "createdAt": "2020-05-13T17:00:27Z", "path": "gradle-baseline-java/src/main/groovy/com/palantir/baseline/plugins/BaselineExactDependencies.java", "diffHunk": "@@ -99,11 +101,20 @@ private static void configureSourceSet(\n                             compile.toString(), implementation.toString()));\n                     conf.setVisible(false);\n                     conf.setCanBeConsumed(false);\n-                    // Important! this ensures we resolve 'compile' variants rather than 'runtime'\n-                    // This is the same attribute that's being set on compileClasspath\n-                    conf.getAttributes()\n-                            .attribute(\n-                                    Usage.USAGE_ATTRIBUTE, project.getObjects().named(Usage.class, Usage.JAVA_API));\n+\n+                    conf.attributes(attributes -> {\n+                        // This ensures we resolve 'compile' variants rather than 'runtime'\n+                        // This is the same attribute that's being set on compileClasspath\n+                        attributes.attribute(\n+                                Usage.USAGE_ATTRIBUTE, project.getObjects().named(Usage.class, Usage.JAVA_API));\n+                        // Ensure we resolve the classes directory for local projects where possible, rather than the\n+                        // 'jar' file. We can only do this on Gradle 5.6+, otherwise do nothing.\n+                        if (GradleVersion.current().compareTo(GradleVersion.version(\"5.6\")) >= 0) {\n+                            attributes.attribute(\n+                                    LibraryElements.LIBRARY_ELEMENTS_ATTRIBUTE,\n+                                    project.getObjects().named(LibraryElements.class, LibraryElements.CLASSES));\n+                        }\n+                    });", "originalCommit": "c12a2318dd2377e07d61c3d00671c0a1abbdad57", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgyMDY0Nw==", "url": "https://github.com/palantir/gradle-baseline/pull/1338#discussion_r424820647", "bodyText": "should this be @Classpath?", "author": "ferozco", "createdAt": "2020-05-14T01:28:19Z", "path": "gradle-baseline-java/src/main/groovy/com/palantir/baseline/tasks/CheckImplicitDependenciesTask.java", "diffHunk": "@@ -142,7 +142,7 @@ private boolean shouldIgnore(ResolvedArtifact artifact) {\n         return ignore.get().contains(BaselineExactDependencies.asString(artifact));\n     }\n \n-    @Input\n+    @InputFiles", "originalCommit": "c12a2318dd2377e07d61c3d00671c0a1abbdad57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA1OTQ4Mw==", "url": "https://github.com/palantir/gradle-baseline/pull/1338#discussion_r425059483", "bodyText": "good catch, yep that will fix any ordering issues!", "author": "dansanduleac", "createdAt": "2020-05-14T11:16:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgyMDY0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "01cab0571f2228d3a5cd54c2e01e32322f90ea4a", "chunk": "diff --git a/gradle-baseline-java/src/main/groovy/com/palantir/baseline/tasks/CheckImplicitDependenciesTask.java b/gradle-baseline-java/src/main/groovy/com/palantir/baseline/tasks/CheckImplicitDependenciesTask.java\nindex 8d8d5937..9c320816 100644\n--- a/gradle-baseline-java/src/main/groovy/com/palantir/baseline/tasks/CheckImplicitDependenciesTask.java\n+++ b/gradle-baseline-java/src/main/groovy/com/palantir/baseline/tasks/CheckImplicitDependenciesTask.java\n\n@@ -142,7 +142,7 @@ public class CheckImplicitDependenciesTask extends DefaultTask {\n         return ignore.get().contains(BaselineExactDependencies.asString(artifact));\n     }\n \n-    @InputFiles\n+    @Classpath\n     public final Provider<List<Configuration>> getDependenciesConfigurations() {\n         return dependenciesConfigurations;\n     }\n"}}, {"oid": "62d722e1dac78a27fc07fc622a9c1b9027bcf8c0", "url": "https://github.com/palantir/gradle-baseline/commit/62d722e1dac78a27fc07fc622a9c1b9027bcf8c0", "message": "good catch!", "committedDate": "2020-05-14T11:16:00Z", "type": "commit"}, {"oid": "9bf59fda560a3cc47096261902ce9652d8dfa6f6", "url": "https://github.com/palantir/gradle-baseline/commit/9bf59fda560a3cc47096261902ce9652d8dfa6f6", "message": "Add generated changelog entries", "committedDate": "2020-05-14T11:16:00Z", "type": "commit"}, {"oid": "30a33e8e44d39a889984312434b45b06e081dcf0", "url": "https://github.com/palantir/gradle-baseline/commit/30a33e8e44d39a889984312434b45b06e081dcf0", "message": "fix test, and test checkImplicitDependencies too", "committedDate": "2020-05-14T13:09:27Z", "type": "commit"}, {"oid": "01cab0571f2228d3a5cd54c2e01e32322f90ea4a", "url": "https://github.com/palantir/gradle-baseline/commit/01cab0571f2228d3a5cd54c2e01e32322f90ea4a", "message": "oops make the right things @Classpath", "committedDate": "2020-05-14T13:11:58Z", "type": "commit"}]}