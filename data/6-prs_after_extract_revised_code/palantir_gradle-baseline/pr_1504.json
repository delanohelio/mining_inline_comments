{"pr_number": 1504, "pr_title": "Errorprone rule to check that all fields in immutables builders have been initialized", "pr_createdAt": "2020-10-09T15:39:56Z", "pr_url": "https://github.com/palantir/gradle-baseline/pull/1504", "timeline": [{"oid": "3c520d1d9812d95a315135e4e5db6303dac3536f", "url": "https://github.com/palantir/gradle-baseline/commit/3c520d1d9812d95a315135e4e5db6303dac3536f", "message": "Check that all required builder fields have been initialized", "committedDate": "2020-10-06T15:34:25Z", "type": "commit"}, {"oid": "4c070fc8166a3ae3b848bc4b15cad4097a28ec7c", "url": "https://github.com/palantir/gradle-baseline/commit/4c070fc8166a3ae3b848bc4b15cad4097a28ec7c", "message": "Handle constructors and from methods", "committedDate": "2020-10-06T15:48:48Z", "type": "commit"}, {"oid": "9031d01cbc2e895e8449dc7c79eb6b83623bee29", "url": "https://github.com/palantir/gradle-baseline/commit/9031d01cbc2e895e8449dc7c79eb6b83623bee29", "message": "Add tests", "committedDate": "2020-10-06T17:43:57Z", "type": "commit"}, {"oid": "9792eb6714a8c25b4aecf678960e326c115063c6", "url": "https://github.com/palantir/gradle-baseline/commit/9792eb6714a8c25b4aecf678960e326c115063c6", "message": "Reduce method complexity", "committedDate": "2020-10-06T18:15:09Z", "type": "commit"}, {"oid": "a26f562325748b50c3c122d01ec0e8def6344386", "url": "https://github.com/palantir/gradle-baseline/commit/a26f562325748b50c3c122d01ec0e8def6344386", "message": "Check that method does nothing but construct builder", "committedDate": "2020-10-06T18:45:39Z", "type": "commit"}, {"oid": "68d68c5e1b882b55182ab1462361299709a58401", "url": "https://github.com/palantir/gradle-baseline/commit/68d68c5e1b882b55182ab1462361299709a58401", "message": "Clean up code", "committedDate": "2020-10-07T17:04:59Z", "type": "commit"}, {"oid": "3da67e651d714069658ed7a68690d137900e376d", "url": "https://github.com/palantir/gradle-baseline/commit/3da67e651d714069658ed7a68690d137900e376d", "message": "Switch to using method names to detect initialized fields", "committedDate": "2020-10-08T14:42:22Z", "type": "commit"}, {"oid": "ba6da262690b17ae9dc7ffd39a29b66a34b6b7ca", "url": "https://github.com/palantir/gradle-baseline/commit/ba6da262690b17ae9dc7ffd39a29b66a34b6b7ca", "message": "Support custom init formats", "committedDate": "2020-10-08T14:58:18Z", "type": "commit"}, {"oid": "6db947c5c589429b3aaa0c74ba65ac43bfc789eb", "url": "https://github.com/palantir/gradle-baseline/commit/6db947c5c589429b3aaa0c74ba65ac43bfc789eb", "message": "Support custom get format", "committedDate": "2020-10-08T15:53:19Z", "type": "commit"}, {"oid": "8dc6b5662d0584caffa28661d290601e177c27f0", "url": "https://github.com/palantir/gradle-baseline/commit/8dc6b5662d0584caffa28661d290601e177c27f0", "message": "Fix stack overflow exception when annotations are included recursively", "committedDate": "2020-10-08T16:12:56Z", "type": "commit"}, {"oid": "25520271f6b0c238ac5ee30aa1d916c1c77af387", "url": "https://github.com/palantir/gradle-baseline/commit/25520271f6b0c238ac5ee30aa1d916c1c77af387", "message": "Support style annotations on packages", "committedDate": "2020-10-08T17:09:22Z", "type": "commit"}, {"oid": "20a2c85d8ddaba31d8516d6413a840db26a84c75", "url": "https://github.com/palantir/gradle-baseline/commit/20a2c85d8ddaba31d8516d6413a840db26a84c75", "message": "Refactor tests", "committedDate": "2020-10-08T17:41:55Z", "type": "commit"}, {"oid": "eac63baeccc57e5a5175f6dad064d22e06c089fc", "url": "https://github.com/palantir/gradle-baseline/commit/eac63baeccc57e5a5175f6dad064d22e06c089fc", "message": "Support immutables based on abstract classes too", "committedDate": "2020-10-08T17:53:51Z", "type": "commit"}, {"oid": "2ba55cb4f17c951806734c3c7c9b38e00607a6f5", "url": "https://github.com/palantir/gradle-baseline/commit/2ba55cb4f17c951806734c3c7c9b38e00607a6f5", "message": "Avoid class not found exception at runtime by not instantiating the immutable annotation", "committedDate": "2020-10-09T11:14:32Z", "type": "commit"}, {"oid": "ea74fece470b556786baf3a8278048e4233b1dde", "url": "https://github.com/palantir/gradle-baseline/commit/ea74fece470b556786baf3a8278048e4233b1dde", "message": "Don't search for @Value.Style annotations because it will only lead to class not found exceptions", "committedDate": "2020-10-09T13:40:23Z", "type": "commit"}, {"oid": "bac610f15b47af8f32252c47735ade4c0db90e0b", "url": "https://github.com/palantir/gradle-baseline/commit/bac610f15b47af8f32252c47735ade4c0db90e0b", "message": "Update tests and add to readme", "committedDate": "2020-10-09T15:24:54Z", "type": "commit"}, {"oid": "354254907e8a1e6c44083d59a5e71708e777e579", "url": "https://github.com/palantir/gradle-baseline/commit/354254907e8a1e6c44083d59a5e71708e777e579", "message": "Add generated changelog entries", "committedDate": "2020-10-09T15:24:54Z", "type": "commit"}, {"oid": "cbdf5e31a651c8a14ee13f1cce6c23d29ccb15f3", "url": "https://github.com/palantir/gradle-baseline/commit/cbdf5e31a651c8a14ee13f1cce6c23d29ccb15f3", "message": "Update README.md\n\nCo-authored-by: Carter Kozak <ckozak@ckozak.net>", "committedDate": "2020-10-09T15:49:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU0Nzg5Mg==", "url": "https://github.com/palantir/gradle-baseline/pull/1504#discussion_r502547892", "bodyText": "this is kinda amazing that it works! given that it relies on internal implementation details of immutables, I wonder if we coudl get this error-prone rule upstreamed into https://github.com/immutables/immutables so that if they ever decide to change the internal representation then CI will catch their change??", "author": "iamdanfox", "createdAt": "2020-10-09T16:36:12Z", "path": "baseline-error-prone/src/main/java/com/palantir/baseline/errorprone/ImmutablesBuilderMissingInitialization.java", "diffHunk": "@@ -0,0 +1,315 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.baseline.errorprone;\n+\n+import com.google.auto.service.AutoService;\n+import com.google.common.base.CaseFormat;\n+import com.google.common.base.Joiner;\n+import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.Sets;\n+import com.google.common.collect.Streams;\n+import com.google.errorprone.BugPattern;\n+import com.google.errorprone.BugPattern.LinkType;\n+import com.google.errorprone.VisitorState;\n+import com.google.errorprone.bugpatterns.BugChecker;\n+import com.google.errorprone.bugpatterns.BugChecker.MethodInvocationTreeMatcher;\n+import com.google.errorprone.matchers.Description;\n+import com.google.errorprone.matchers.Matcher;\n+import com.google.errorprone.matchers.Matchers;\n+import com.google.errorprone.util.ASTHelpers;\n+import com.sun.source.tree.ExpressionTree;\n+import com.sun.source.tree.MethodInvocationTree;\n+import com.sun.source.tree.MethodTree;\n+import com.sun.source.tree.NewClassTree;\n+import com.sun.source.tree.ReturnTree;\n+import com.sun.tools.javac.code.Symbol;\n+import com.sun.tools.javac.code.Symbol.ClassSymbol;\n+import com.sun.tools.javac.code.Symbol.MethodSymbol;\n+import com.sun.tools.javac.code.Type;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+import org.immutables.value.Generated;\n+\n+/**\n+ * Checks that all required fields in an immutables.org generated builder have been populated.\n+ *\n+ * To make it decidable, it is limited to builders that are constructed by calling {@code new ImmutableType.Builder()},\n+ * {@code new Type.Builder()} (where Type.Builder extends ImmutableType.Builder), or a method that only calls one of\n+ * those constructors and returns the result, and are never stored into a variable. Builders that do not meet these\n+ * conditions are assumed to populate all fields, and are ignored.\n+ *\n+ * Mandatory fields are determined by inspecting the generated builder source to find the initBits that are updated by\n+ * each method, to find any that do not get set. If Immutables changes the way that they check for required fields, this\n+ * check will stop working (but the check will probably pass).\n+ */\n+@AutoService(BugChecker.class)\n+@BugPattern(\n+        name = \"ImmutablesBuilderMissingInitialization\",\n+        linkType = LinkType.CUSTOM,\n+        link = \"https://github.com/palantir/gradle-baseline#baseline-error-prone-checks\",\n+        severity = BugPattern.SeverityLevel.ERROR,\n+        summary = \"All required fields of an Immutables builder must be initialized\")\n+public final class ImmutablesBuilderMissingInitialization extends BugChecker implements MethodInvocationTreeMatcher {\n+\n+    private static final String FIELD_INIT_BITS_PREFIX = \"INIT_BIT_\";\n+\n+    /**\n+     * Prefixes on the interface getter methods that may be stripped by immutables.\n+     *\n+     * The default immutables style just uses get*, but some places use is* too and we can't load the style to check\n+     * what to remove. It doesn't matter if we remove too much, because we only do a suffix match on the methods.\n+     *\n+     * This should only help when the unprefixed field name is an identifier, because in other cases immutables already\n+     * uses the unprefixed name.\n+     */\n+    private static final ImmutableSet<String> GET_PREFIXES = ImmutableSet.of(\"GET_\", \"IS_\");\n+\n+    private static final Matcher<ExpressionTree> builderMethodMatcher = Matchers.instanceMethod()\n+            .onClass(ImmutablesBuilderMissingInitialization::extendsImmutablesGeneratedClass)\n+            .named(\"build\")\n+            .withParameters();\n+\n+    @Override\n+    public Description matchMethodInvocation(MethodInvocationTree tree, VisitorState state) {\n+        // Check that the method is a builder's build() method\n+        if (!builderMethodMatcher.matches(tree, state)) {\n+            return Description.NO_MATCH;\n+        }\n+        ClassSymbol builderClass = ASTHelpers.enclosingClass(ASTHelpers.getSymbol(tree));\n+        ClassSymbol immutableClass = ASTHelpers.enclosingClass(builderClass);\n+        if (immutableClass == null) {\n+            return Description.NO_MATCH;\n+        }\n+        Optional<ClassSymbol> interfaceClass = Streams.concat(\n+                        immutableClass.getInterfaces().stream(), Stream.of(immutableClass.getSuperclass()))\n+                .map(type -> type.tsym)\n+                .map(filterByType(ClassSymbol.class))\n+                .flatMap(Streams::stream)\n+                .filter(classSymbol ->\n+                        ASTHelpers.hasAnnotation(classSymbol, \"org.immutables.value.Value.Immutable\", state))\n+                .findAny();\n+        if (!interfaceClass.isPresent()) {\n+            return Description.NO_MATCH;\n+        }\n+\n+        // Mandatory fields have a private static final constant in the generated builder named INIT_BIT_varname, where\n+        // varname is the UPPER_UNDERSCORE version of the variable name. Find these fields to get the mandatory fields.\n+        // nb. this isn't part of any immutables API, so could break.", "originalCommit": "cbdf5e31a651c8a14ee13f1cce6c23d29ccb15f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU1MjEwNg==", "url": "https://github.com/palantir/gradle-baseline/pull/1504#discussion_r502552106", "bodyText": "One concern I would have with upstreaming this is that it's not totally compliant with custom @Value.Style annotations, and can never be because the annotation (eg @ImmutablesStyle internally) is often brought in as a compileOnly dependency, so if it's consumed from a different compilation unit (eg using immutable classes that were generated in the main sourceset from test code) it will not be possible to recover the original style. That only affects an edge case where the get style has been customized and the field with that part removed is an identifier (eg getPublic), so maybe it's not a big deal (I solved it here by hard coding the style to get* and is*and bailing if there are fields that can't be initialized after transforming like that). There are other ways that the style could in theory be changed (eg changing the name of the from method) that I don't think we would be able to handle.\nInstead, if it were upstreamed then I'd prefer to go with an annotations-based approach, as mentioned above.", "author": "jackwickham", "createdAt": "2020-10-09T16:44:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU0Nzg5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "e0412d3a05b8d5bb9af55382cad7ab5704d5b69f", "chunk": "diff --git a/baseline-error-prone/src/main/java/com/palantir/baseline/errorprone/ImmutablesBuilderMissingInitialization.java b/baseline-error-prone/src/main/java/com/palantir/baseline/errorprone/ImmutablesBuilderMissingInitialization.java\nindex b96077c8..3a5ec972 100644\n--- a/baseline-error-prone/src/main/java/com/palantir/baseline/errorprone/ImmutablesBuilderMissingInitialization.java\n+++ b/baseline-error-prone/src/main/java/com/palantir/baseline/errorprone/ImmutablesBuilderMissingInitialization.java\n\n@@ -51,14 +51,15 @@ import org.immutables.value.Generated;\n /**\n  * Checks that all required fields in an immutables.org generated builder have been populated.\n  *\n- * To make it decidable, it is limited to builders that are constructed by calling {@code new ImmutableType.Builder()},\n- * {@code new Type.Builder()} (where Type.Builder extends ImmutableType.Builder), or a method that only calls one of\n- * those constructors and returns the result, and are never stored into a variable. Builders that do not meet these\n+ * To make it decidable, the implementation is limited to the common case where: the builder is constructed in place\n+ * using new ImmutableType.Builder() or new Type.Builder() (where Type.Builder extends ImmutableType.Builder), or using\n+ * a method that does nothing other than construct and return the builder; and the builder is never stored to a\n+ * variable, so the builder only lives within a single statement. Builders that do not meet these\n  * conditions are assumed to populate all fields, and are ignored.\n  *\n- * Mandatory fields are determined by inspecting the generated builder source to find the initBits that are updated by\n- * each method, to find any that do not get set. If Immutables changes the way that they check for required fields, this\n- * check will stop working (but the check will probably pass).\n+ * Mandatory fields are determined by inspecting the generated builder class to find fields that have INIT_BIT_\n+ * constants, which are used by Immutables to track whether required fields have been initialized. Methods that end with\n+ * the name of a field are assumed to initialize that field.\n  */\n @AutoService(BugChecker.class)\n @BugPattern(\n"}}, {"oid": "e0412d3a05b8d5bb9af55382cad7ab5704d5b69f", "url": "https://github.com/palantir/gradle-baseline/commit/e0412d3a05b8d5bb9af55382cad7ab5704d5b69f", "message": "Update javadoc", "committedDate": "2020-10-09T16:48:40Z", "type": "commit"}]}