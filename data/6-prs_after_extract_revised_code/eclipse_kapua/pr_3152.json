{"pr_number": 3152, "pr_title": "Extend accountSelfEdit support in Configurations", "pr_createdAt": "2020-11-24T17:37:28Z", "pr_url": "https://github.com/eclipse/kapua/pull/3152", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEzODk2Mw==", "url": "https://github.com/eclipse/kapua/pull/3152#discussion_r530138963", "bodyText": "I think that this message should be \"The configuration \"%s\" cannot be changed by this user in this account\" or something similar. What do you think?", "author": "LeoNerdoG", "createdAt": "2020-11-25T06:43:12Z", "path": "commons/src/main/java/org/eclipse/kapua/commons/configuration/AbstractKapuaConfigurableService.java", "diffHunk": "@@ -391,18 +393,35 @@ public void setConfigValues(KapuaId scopeId, KapuaId parentId, Map<String, Objec\n         KapuaLocator locator = KapuaLocator.getInstance();\n         AuthorizationService authorizationService = locator.getService(AuthorizationService.class);\n         PermissionFactory permissionFactory = locator.getFactory(PermissionFactory.class);\n-        UserService userService = locator.getService(UserService.class);\n+        KapuaTocd ocd = getConfigMetadata(scopeId, false);\n \n+        UserService userService = locator.getService(UserService.class);\n         String rootUserName = SystemSetting.getInstance().getString(SystemSettingKey.SYS_ADMIN_USERNAME);\n         User rootUser = KapuaSecurityUtils.doPrivileged(() -> userService.findByName(rootUserName));\n-        if (!KapuaSecurityUtils.getSession().getUserId().equals(rootUser.getId()) && KapuaSecurityUtils.getSession().getScopeId().equals(scopeId)) {\n-            // Prevent someone to change his own configurations, unless it's the root user\n-            throw KapuaException.internalError(\"An user cannot change service settings on his own account\");\n+\n+        Map<String, Object> originalValues = getConfigValues(scopeId);\n+\n+        for (KapuaTad ad : ocd.getAD()) {\n+            boolean allowSelfEdit = Boolean.parseBoolean(ad.getOtherAttributes().getOrDefault(new QName(\"allowSelfEdit\"), \"false\"));\n+\n+            boolean preventChange =\n+                    // if current user is not root user...\n+                    !KapuaSecurityUtils.getSession().getUserId().equals(rootUser.getId()) &&\n+                    // current configuration does not allow self edit...\n+                    !allowSelfEdit &&\n+                    // a configuration for the current logged account is about to be changed...\n+                    KapuaSecurityUtils.getSession().getScopeId().equals(scopeId) &&\n+                    // and the new value is different from the other one...\n+                    !originalValues.get(ad.getId()).equals(values.get(ad.getId()));\n+\n+            if (preventChange) {\n+                // ... prevent the change!\n+                throw KapuaException.internalError(String.format(\"The configuration \\\"%s\\\" cannot be changed from an user of the account\", ad.getId()));", "originalCommit": "03132d2c3f37f8bca9fae09340ceef394e3e71e5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg3OTcxMQ==", "url": "https://github.com/eclipse/kapua/pull/3152#discussion_r530879711", "bodyText": "Yes, this could work", "author": "lorthirk", "createdAt": "2020-11-26T09:17:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEzODk2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "67ae331eaa809cca56f5311b24eccbdd5d67795f", "chunk": "diff --git a/commons/src/main/java/org/eclipse/kapua/commons/configuration/AbstractKapuaConfigurableService.java b/commons/src/main/java/org/eclipse/kapua/commons/configuration/AbstractKapuaConfigurableService.java\nindex c3997b271b..714c215463 100644\n--- a/commons/src/main/java/org/eclipse/kapua/commons/configuration/AbstractKapuaConfigurableService.java\n+++ b/commons/src/main/java/org/eclipse/kapua/commons/configuration/AbstractKapuaConfigurableService.java\n\n@@ -416,7 +416,7 @@ public abstract class AbstractKapuaConfigurableService extends AbstractKapuaServ\n \n             if (preventChange) {\n                 // ... prevent the change!\n-                throw KapuaException.internalError(String.format(\"The configuration \\\"%s\\\" cannot be changed from an user of the account\", ad.getId()));\n+                throw KapuaException.internalError(String.format(\"The configuration \\\"%s\\\" cannot be changed by this user in this account\", ad.getId()));\n             }\n         }\n \n"}}, {"oid": "67ae331eaa809cca56f5311b24eccbdd5d67795f", "url": "https://github.com/eclipse/kapua/commit/67ae331eaa809cca56f5311b24eccbdd5d67795f", "message": "Mark CredentialService configurations as \"allowSelfEdit\"\n\nSigned-off-by: Claudio Mezzasalma <claudio.mezzasalma@eurotech.com>", "committedDate": "2020-11-26T10:57:09Z", "type": "forcePushed"}, {"oid": "21c69b3c587523ef2ab4644b900879fc2692e073", "url": "https://github.com/eclipse/kapua/commit/21c69b3c587523ef2ab4644b900879fc2692e073", "message": "Mark CredentialService configurations as \"allowSelfEdit\"\n\nSigned-off-by: Claudio Mezzasalma <claudio.mezzasalma@eurotech.com>", "committedDate": "2020-11-29T09:53:19Z", "type": "forcePushed"}, {"oid": "1fb31a938c818de2a3d8f4be3c91cee49057e3b3", "url": "https://github.com/eclipse/kapua/commit/1fb31a938c818de2a3d8f4be3c91cee49057e3b3", "message": "Mark CredentialService configurations as \"allowSelfEdit\"\n\nSigned-off-by: Claudio Mezzasalma <claudio.mezzasalma@eurotech.com>", "committedDate": "2020-11-30T08:15:16Z", "type": "forcePushed"}, {"oid": "4eab9efab6715fc09073ccb8eb1ff1143a13b39b", "url": "https://github.com/eclipse/kapua/commit/4eab9efab6715fc09073ccb8eb1ff1143a13b39b", "message": "Mark CredentialService configurations as \"allowSelfEdit\"\n\nSigned-off-by: Claudio Mezzasalma <claudio.mezzasalma@eurotech.com>", "committedDate": "2020-11-30T09:27:09Z", "type": "forcePushed"}, {"oid": "de537a81ea1099c30b3230cf5a1486b8c6b71eda", "url": "https://github.com/eclipse/kapua/commit/de537a81ea1099c30b3230cf5a1486b8c6b71eda", "message": "Mark CredentialService configurations as \"allowSelfEdit\"\n\nSigned-off-by: Claudio Mezzasalma <claudio.mezzasalma@eurotech.com>", "committedDate": "2020-11-30T13:51:05Z", "type": "forcePushed"}, {"oid": "203e1064cd85b1dc9960fbc629473b056c128e89", "url": "https://github.com/eclipse/kapua/commit/203e1064cd85b1dc9960fbc629473b056c128e89", "message": "Mark CredentialService configurations as \"allowSelfEdit\"\n\nSigned-off-by: Claudio Mezzasalma <claudio.mezzasalma@eurotech.com>", "committedDate": "2020-12-01T11:44:02Z", "type": "forcePushed"}, {"oid": "eb6cc3878ced15dc8dec42de1240672e3192f302", "url": "https://github.com/eclipse/kapua/commit/eb6cc3878ced15dc8dec42de1240672e3192f302", "message": "Mark CredentialService configurations as \"allowSelfEdit\"\n\nSigned-off-by: Claudio Mezzasalma <claudio.mezzasalma@eurotech.com>", "committedDate": "2020-12-09T09:16:07Z", "type": "forcePushed"}, {"oid": "ceaf1c1aafef1a415e6ed6447329e74d82ca04e1", "url": "https://github.com/eclipse/kapua/commit/ceaf1c1aafef1a415e6ed6447329e74d82ca04e1", "message": "More services should not be configurable\n\nSigned-off-by: Claudio Mezzasalma <claudio.mezzasalma@eurotech.com>", "committedDate": "2020-12-09T09:20:46Z", "type": "commit"}, {"oid": "20b6787656011661bc4315b042eb5ec83e66f20c", "url": "https://github.com/eclipse/kapua/commit/20b6787656011661bc4315b042eb5ec83e66f20c", "message": "Extend \"allowSelfEdit\" support\n\nSigned-off-by: Claudio Mezzasalma <claudio.mezzasalma@eurotech.com>", "committedDate": "2020-12-09T09:21:04Z", "type": "commit"}, {"oid": "11a52e0ea8f5f6fe608f6ae5b97d95e00e598b82", "url": "https://github.com/eclipse/kapua/commit/11a52e0ea8f5f6fe608f6ae5b97d95e00e598b82", "message": "Mark CredentialService configurations as \"allowSelfEdit\"\n\nSigned-off-by: Claudio Mezzasalma <claudio.mezzasalma@eurotech.com>", "committedDate": "2020-12-09T09:21:04Z", "type": "commit"}, {"oid": "11a52e0ea8f5f6fe608f6ae5b97d95e00e598b82", "url": "https://github.com/eclipse/kapua/commit/11a52e0ea8f5f6fe608f6ae5b97d95e00e598b82", "message": "Mark CredentialService configurations as \"allowSelfEdit\"\n\nSigned-off-by: Claudio Mezzasalma <claudio.mezzasalma@eurotech.com>", "committedDate": "2020-12-09T09:21:04Z", "type": "forcePushed"}]}