{"pr_number": 6860, "pr_title": "Destroy Dataset with a Mapped DataFile", "pr_createdAt": "2020-04-28T03:05:50Z", "pr_url": "https://github.com/IQSS/dataverse/pull/6860", "timeline": [{"oid": "b8b8e3ce8ad5472ff00d7027703b4e206629d986", "url": "https://github.com/IQSS/dataverse/commit/b8b8e3ce8ad5472ff00d7027703b4e206629d986", "message": "make sure that we delete both the worldmap entities on the dataverse side, and possible\nremote layer data. #4093", "committedDate": "2020-04-28T02:17:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjY3MDQ4NA==", "url": "https://github.com/IQSS/dataverse/pull/6860#discussion_r416670484", "bodyText": "I had forgotten that there's a DeleteMapLayerMetadataCommand but this comment makes me wonder why we don't call it. I get that we don't need to call it thanks to the cascade, but would calling the command cause problems? Does it do more than we want? It seems to clean up thumbnails, for example. Also, there's tiny typo above: dedicatd.", "author": "pdurbin", "createdAt": "2020-04-28T14:42:01Z", "path": "src/main/java/edu/harvard/iq/dataverse/engine/command/impl/DeleteDataFileCommand.java", "diffHunk": "@@ -210,6 +213,31 @@ public FileVisitResult postVisitDirectory(final Path dir, final IOException e)\n         } catch (Exception e) {\n             logger.log(Level.WARNING, \"Identifier deletion was not successfull:\", e.getMessage());\n         }\n+        \n+        // If there is a Map Layer associated with this file, we may need to \n+        // try and remove the layer data on the WorldMap side. \n+        if (ctxt.mapLayerMetadata().findMetadataByDatafile(doomed) != null) {\n+            // (We need an AuthenticatedUser in order to produce a WorldMap token!)\n+            String id = getUser().getIdentifier();\n+            id = id.startsWith(\"@\") ? id.substring(1) : id;\n+            AuthenticatedUser authenticatedUser = ctxt.authentication().getAuthenticatedUser(id);\n+            try {\n+                ctxt.mapLayerMetadata().deleteMapLayerFromWorldMap(doomed, authenticatedUser);\n+\n+                // We have the dedicatd command DeleteMapLayerMetadataCommand, but \n+                // there's no need to use it explicitly, since the Dataverse-side\n+                // MapLayerMetadata entity will be deleted by the database \n+                // cascade on the DataFile. -- L.A. Apr. 2020", "originalCommit": "b8b8e3ce8ad5472ff00d7027703b4e206629d986", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjgyMDE0Ng==", "url": "https://github.com/IQSS/dataverse/pull/6860#discussion_r416820146", "bodyText": "I'm still curious about these questions but there's no need to hold this up from QA so I moved it over. This pull request adds a lot of value.", "author": "pdurbin", "createdAt": "2020-04-28T18:09:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjY3MDQ4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjg0OTM2OA==", "url": "https://github.com/IQSS/dataverse/pull/6860#discussion_r416849368", "bodyText": "Sorry, missed the original question 4 hours ago. I guess the answer is, the delete layer command is a more surgical tool; it's for a case where we just need to delete the layer, without touching the file.\nCalling it in the context of trying to wipe everything, including the datafile and all its associated physical files, would not hurt, strictly speaking - but I couldn't think of why we would want to call it either; seeing how the cascade is more reliable? It does remove the map thumbnails - but then we run a full physical file cleanup after DeleteDataFileCommand, that will delete all aux files associated with the datafile, thumbnails and otherwise.\nAnd then again there is the fact the command doesn't do everything we need, either. It does not attempt to go out and remove whatever possible data may be sitting on the WorldMap side. I could only assume that it was by design.\nMy attitude with this PR was to check in something ASAP that works and doesn't break things.\nI generally sympathize with the goals of making things cleaner; calling commands instead of database queries and such. But in the case of WorldMap, the whole is a big hack - isn't it? Our attempt to \"think about it some more\" to see if we were doing everything right resulted in a 2.5 year delay, and a whole bunch of these un-destructible datasets still sitting in production...", "author": "landreev", "createdAt": "2020-04-28T18:57:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjY3MDQ4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjg1MzI3Mg==", "url": "https://github.com/IQSS/dataverse/pull/6860#discussion_r416853272", "bodyText": "Yes, agreed. I don't think this will break anything and it definitely adds value. Thanks for the explanation.", "author": "pdurbin", "createdAt": "2020-04-28T19:04:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjY3MDQ4NA=="}], "type": "inlineReview", "revised_code": null}]}