{"pr_number": 6622, "pr_title": "6290 dataset role mgmt api", "pr_createdAt": "2020-02-06T21:01:53Z", "pr_url": "https://github.com/IQSS/dataverse/pull/6622", "timeline": [{"oid": "ba9b90e743a77aad735aeaf438c966fc6e437d84", "url": "https://github.com/IQSS/dataverse/commit/ba9b90e743a77aad735aeaf438c966fc6e437d84", "message": "#6290 add DS Role api and tests", "committedDate": "2020-02-05T21:44:41Z", "type": "commit"}, {"oid": "7d7a28809d387b409b32526c2db54079c60288fa", "url": "https://github.com/IQSS/dataverse/commit/7d7a28809d387b409b32526c2db54079c60288fa", "message": "Merge branch 'develop' into 6290-dataset-role-mgmt-api", "committedDate": "2020-02-05T21:44:55Z", "type": "commit"}, {"oid": "dac1ad19f76bbb083e1f9668f2e20abf86009336", "url": "https://github.com/IQSS/dataverse/commit/dac1ad19f76bbb083e1f9668f2e20abf86009336", "message": "#6290 cannot add role without permission", "committedDate": "2020-02-06T16:11:49Z", "type": "commit"}, {"oid": "3c24610e991ef52d5d05e2db1f03d039c4b648c7", "url": "https://github.com/IQSS/dataverse/commit/3c24610e991ef52d5d05e2db1f03d039c4b648c7", "message": "Merge branch 'develop' into 6290-dataset-role-mgmt-api", "committedDate": "2020-02-06T18:04:25Z", "type": "commit"}, {"oid": "6286fc124aeac6950a701d52cfa0b62020c8deaa", "url": "https://github.com/IQSS/dataverse/commit/6286fc124aeac6950a701d52cfa0b62020c8deaa", "message": "Merge branch 'develop' into 6290-dataset-role-mgmt-api", "committedDate": "2020-02-06T20:23:59Z", "type": "commit"}, {"oid": "cd120eed71ac51d68005b1fe8aa61ddf098826ee", "url": "https://github.com/IQSS/dataverse/commit/cd120eed71ac51d68005b1fe8aa61ddf098826ee", "message": "Merge branch 'develop' into 6290-dataset-role-mgmt-api", "committedDate": "2020-02-06T20:37:47Z", "type": "commit"}, {"oid": "ba7f66c10555cc0e03fc9052f470e5dde4a5a026", "url": "https://github.com/IQSS/dataverse/commit/ba7f66c10555cc0e03fc9052f470e5dde4a5a026", "message": "#6290 Add doc to dataset role api", "committedDate": "2020-02-06T20:50:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA4ODQ3Nw==", "url": "https://github.com/IQSS/dataverse/pull/6622#discussion_r376088477", "bodyText": "I think the new-ish rule is that when we touch APIs we should put the English in a bundle.", "author": "pdurbin", "createdAt": "2020-02-06T21:21:15Z", "path": "src/main/java/edu/harvard/iq/dataverse/api/Datasets.java", "diffHunk": "@@ -1084,24 +1086,38 @@ public Response getLinks(@PathParam(\"id\") String idSupplied ) {\n     }\n \n     /**\n-     * @todo Make this real. Currently only used for API testing. Copied from\n-     * the equivalent API endpoint for dataverses and simplified with values\n-     * hard coded.\n+     * Add a given assignment to a given user or group\n+     * @param ra role assignment DTO\n+     * @param id dataset id\n+     * @param apiKey\n      */\n     @POST\n     @Path(\"{identifier}/assignments\")\n-    public Response createAssignment(String userOrGroup, @PathParam(\"identifier\") String id, @QueryParam(\"key\") String apiKey) {\n-        boolean apiTestingOnly = true;\n-        if (apiTestingOnly) {\n-            return error(Response.Status.FORBIDDEN, \"This is only for API tests.\");\n-        }\n+    public Response createAssignment(RoleAssignmentDTO ra, @PathParam(\"identifier\") String id, @QueryParam(\"key\") String apiKey) {\n         try {\n             Dataset dataset = findDatasetOrDie(id);\n-            RoleAssignee assignee = findAssignee(userOrGroup);\n+            \n+            RoleAssignee assignee = findAssignee(ra.getAssignee());\n             if (assignee == null) {\n                 return error(Response.Status.BAD_REQUEST, \"Assignee not found\");\n+            }           \n+            \n+            DataverseRole theRole;\n+            Dataverse dv = dataset.getOwner();\n+            theRole = null;\n+            while ((theRole == null) && (dv != null)) {\n+                for (DataverseRole aRole : rolesSvc.availableRoles(dv.getId())) {\n+                    if (aRole.getAlias().equals(ra.getRole())) {\n+                        theRole = aRole;\n+                        break;\n+                    }\n+                }\n+                dv = dv.getOwner();\n             }\n-            DataverseRole theRole = rolesSvc.findBuiltinRoleByAlias(\"admin\");\n+            if (theRole == null) {\n+                return error(Status.BAD_REQUEST, \"Can't find role named '\" + ra.getRole() + \"' in dataverse \" + dataset.getOwner());", "originalCommit": "ba7f66c10555cc0e03fc9052f470e5dde4a5a026", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzMxNzE5Mw==", "url": "https://github.com/IQSS/dataverse/pull/6622#discussion_r377317193", "bodyText": "Added revoke and api messages to the Bundle.", "author": "sekmiller", "createdAt": "2020-02-10T21:08:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA4ODQ3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "9eb308ad82a2de3fd4bbd8d16e2c9fe47325b15a", "chunk": "diff --git a/src/main/java/edu/harvard/iq/dataverse/api/Datasets.java b/src/main/java/edu/harvard/iq/dataverse/api/Datasets.java\nindex d581676a5..bf54b9bd6 100644\n--- a/src/main/java/edu/harvard/iq/dataverse/api/Datasets.java\n+++ b/src/main/java/edu/harvard/iq/dataverse/api/Datasets.java\n\n@@ -1099,7 +1102,7 @@ public class Datasets extends AbstractApiBean {\n             \n             RoleAssignee assignee = findAssignee(ra.getAssignee());\n             if (assignee == null) {\n-                return error(Response.Status.BAD_REQUEST, \"Assignee not found\");\n+                return error(Response.Status.BAD_REQUEST, BundleUtil.getStringFromBundle(\"datasets.api.grant.role.assignee.not.found.error\"));\n             }           \n             \n             DataverseRole theRole;\n"}}, {"oid": "039bd5e199ff50b4426a249bf60cf8b465e8742f", "url": "https://github.com/IQSS/dataverse/commit/039bd5e199ff50b4426a249bf60cf8b465e8742f", "message": "#6920 add revoke role api for datasets", "committedDate": "2020-02-10T19:18:09Z", "type": "commit"}, {"oid": "1b191a44e77ce2280077d24962a1c64b8749bcd0", "url": "https://github.com/IQSS/dataverse/commit/1b191a44e77ce2280077d24962a1c64b8749bcd0", "message": "Merge branch 'develop' into 6290-dataset-role-mgmt-api", "committedDate": "2020-02-10T19:19:28Z", "type": "commit"}, {"oid": "9eb308ad82a2de3fd4bbd8d16e2c9fe47325b15a", "url": "https://github.com/IQSS/dataverse/commit/9eb308ad82a2de3fd4bbd8d16e2c9fe47325b15a", "message": "#6290 bundle-ize api messages", "committedDate": "2020-02-10T21:01:14Z", "type": "commit"}, {"oid": "f341af23adf611ef08b01a94b061cedd07521e4e", "url": "https://github.com/IQSS/dataverse/commit/f341af23adf611ef08b01a94b061cedd07521e4e", "message": "#6290 Add doc for revoke role on Dataset", "committedDate": "2020-02-10T22:15:46Z", "type": "commit"}, {"oid": "fed7f86ca2c0d59fcbc9eae44c7024de76b02260", "url": "https://github.com/IQSS/dataverse/commit/fed7f86ca2c0d59fcbc9eae44c7024de76b02260", "message": "#6290 fix doc typo", "committedDate": "2020-02-10T22:17:35Z", "type": "commit"}, {"oid": "7d60cc65bcda09192f64d6d3ee39a2579b3843db", "url": "https://github.com/IQSS/dataverse/commit/7d60cc65bcda09192f64d6d3ee39a2579b3843db", "message": "Merge branch 'develop' into 6290-dataset-role-mgmt-api", "committedDate": "2020-02-11T14:50:17Z", "type": "commit"}, {"oid": "71e3e036dbc043619f40d8c0e7ecbff614738a38", "url": "https://github.com/IQSS/dataverse/commit/71e3e036dbc043619f40d8c0e7ecbff614738a38", "message": "#6290 fix list dataset roles after merge conflict", "committedDate": "2020-02-11T14:59:16Z", "type": "commit"}, {"oid": "a064189b23917095a0c5e10bd641ff415bc50bd6", "url": "https://github.com/IQSS/dataverse/commit/a064189b23917095a0c5e10bd641ff415bc50bd6", "message": "#6290 add code block tags", "committedDate": "2020-02-11T15:02:09Z", "type": "commit"}, {"oid": "d1dafdcbc509f16e9317e183fe91970c88dae260", "url": "https://github.com/IQSS/dataverse/commit/d1dafdcbc509f16e9317e183fe91970c88dae260", "message": "reformat", "committedDate": "2020-02-11T15:04:49Z", "type": "commit"}, {"oid": "4e3de66da0c87290b90a129b1848fb6cf4ed1a84", "url": "https://github.com/IQSS/dataverse/commit/4e3de66da0c87290b90a129b1848fb6cf4ed1a84", "message": "once again", "committedDate": "2020-02-11T15:08:58Z", "type": "commit"}, {"oid": "9a1ff014e9b4da99db35941d392c5c32e8a92228", "url": "https://github.com/IQSS/dataverse/commit/9a1ff014e9b4da99db35941d392c5c32e8a92228", "message": "Update native-api.rst", "committedDate": "2020-02-11T15:12:11Z", "type": "commit"}, {"oid": "0a7d066e34521566cc0308f259c1b0f70df8d60e", "url": "https://github.com/IQSS/dataverse/commit/0a7d066e34521566cc0308f259c1b0f70df8d60e", "message": "Update native-api.rst", "committedDate": "2020-02-11T15:13:28Z", "type": "commit"}, {"oid": "60988887c50f76081d24672fd396aea087419aee", "url": "https://github.com/IQSS/dataverse/commit/60988887c50f76081d24672fd396aea087419aee", "message": "Update native-api.rst", "committedDate": "2020-02-12T20:29:12Z", "type": "commit"}, {"oid": "7288f919adcf4d8b287628bf568c623d3413d4ad", "url": "https://github.com/IQSS/dataverse/commit/7288f919adcf4d8b287628bf568c623d3413d4ad", "message": "Update native-api.rst", "committedDate": "2020-02-12T22:14:56Z", "type": "commit"}, {"oid": "9e311549b4f43efdbf376dbce262af155486f637", "url": "https://github.com/IQSS/dataverse/commit/9e311549b4f43efdbf376dbce262af155486f637", "message": "#6290 get role assignments at DV level for DS", "committedDate": "2020-02-13T15:07:42Z", "type": "commit"}, {"oid": "b7c60509708a39c32b89ee5259b85f353606fd80", "url": "https://github.com/IQSS/dataverse/commit/b7c60509708a39c32b89ee5259b85f353606fd80", "message": "Merge branch 'develop' into 6290-dataset-role-mgmt-api", "committedDate": "2020-02-13T15:08:23Z", "type": "commit"}, {"oid": "b7b3645e70411c60526527df5920cb2708d78802", "url": "https://github.com/IQSS/dataverse/commit/b7b3645e70411c60526527df5920cb2708d78802", "message": "Update native-api.rst", "committedDate": "2020-02-13T15:43:35Z", "type": "commit"}]}