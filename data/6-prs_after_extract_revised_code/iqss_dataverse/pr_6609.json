{"pr_number": 6609, "pr_title": "6524 dataset size api", "pr_createdAt": "2020-02-04T19:00:48Z", "pr_url": "https://github.com/IQSS/dataverse/pull/6609", "timeline": [{"oid": "802ae7bd0224439543673769a467b08e714560ed", "url": "https://github.com/IQSS/dataverse/commit/802ae7bd0224439543673769a467b08e714560ed", "message": "#6524 add dataset size api", "committedDate": "2020-01-29T17:24:17Z", "type": "commit"}, {"oid": "e7de306df8cb91872a2ac672c305b42a94d97fb6", "url": "https://github.com/IQSS/dataverse/commit/e7de306df8cb91872a2ac672c305b42a94d97fb6", "message": "Merge branch 'develop' into 6524-dataset-size-api", "committedDate": "2020-01-29T17:24:32Z", "type": "commit"}, {"oid": "9457fec308a7c5537befcdb4c150134081226383", "url": "https://github.com/IQSS/dataverse/commit/9457fec308a7c5537befcdb4c150134081226383", "message": "#6524 add api endpoints for file storage/download size\n\nat dataset/version level", "committedDate": "2020-02-03T18:46:31Z", "type": "commit"}, {"oid": "dcc857d6bcc615ae08058e718ea1de3c14d6deb8", "url": "https://github.com/IQSS/dataverse/commit/dcc857d6bcc615ae08058e718ea1de3c14d6deb8", "message": "Merge branch 'develop' into 6524-dataset-size-api", "committedDate": "2020-02-03T18:46:47Z", "type": "commit"}, {"oid": "fef91a8c6f30c2330536922d1b522b0c44ce3af5", "url": "https://github.com/IQSS/dataverse/commit/fef91a8c6f30c2330536922d1b522b0c44ce3af5", "message": "#6524 update bundle", "committedDate": "2020-02-03T21:15:03Z", "type": "commit"}, {"oid": "2d18b8158eeeb6cba9ea164256f839a61b11321c", "url": "https://github.com/IQSS/dataverse/commit/2d18b8158eeeb6cba9ea164256f839a61b11321c", "message": "#6524 add doc for dataset storage size", "committedDate": "2020-02-04T15:11:22Z", "type": "commit"}, {"oid": "04f8a222b9c26f1675c439f64f5a02ada1b70b4c", "url": "https://github.com/IQSS/dataverse/commit/04f8a222b9c26f1675c439f64f5a02ada1b70b4c", "message": "#6524 fix api url", "committedDate": "2020-02-04T15:12:48Z", "type": "commit"}, {"oid": "88851575b79cbbdbc94f0af65fd89827b001850c", "url": "https://github.com/IQSS/dataverse/commit/88851575b79cbbdbc94f0af65fd89827b001850c", "message": "#6524 fix required permission for storage size", "committedDate": "2020-02-04T15:14:42Z", "type": "commit"}, {"oid": "7237c4f6a44ffc72943e1d978a5f3eb599fb7edf", "url": "https://github.com/IQSS/dataverse/commit/7237c4f6a44ffc72943e1d978a5f3eb599fb7edf", "message": "#6524 allow user with view draft permission to get size of download", "committedDate": "2020-02-04T15:29:28Z", "type": "commit"}, {"oid": "8669089ef59acca06304f088797f1217b599d5a9", "url": "https://github.com/IQSS/dataverse/commit/8669089ef59acca06304f088797f1217b599d5a9", "message": "#6524 Add doc for download size", "committedDate": "2020-02-04T16:42:59Z", "type": "commit"}, {"oid": "770192b9e7e3c17dcd81192f51d7c3cc27414cda", "url": "https://github.com/IQSS/dataverse/commit/770192b9e7e3c17dcd81192f51d7c3cc27414cda", "message": "Merge branch 'develop' into 6524-dataset-size-api", "committedDate": "2020-02-04T19:03:14Z", "type": "commit"}, {"oid": "9dc2fdafbc387fb848e1c3b7edb5c95dc5993d0e", "url": "https://github.com/IQSS/dataverse/commit/9dc2fdafbc387fb848e1c3b7edb5c95dc5993d0e", "message": "#6524 remove unused import", "committedDate": "2020-02-04T19:08:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTM5MTEwMA==", "url": "https://github.com/IQSS/dataverse/pull/6609#discussion_r375391100", "bodyText": "Sorry to nitpick but it's \"tally\" without an \"e\".", "author": "pdurbin", "createdAt": "2020-02-05T17:12:33Z", "path": "src/main/java/edu/harvard/iq/dataverse/DatasetServiceBean.java", "diffHunk": "@@ -866,45 +866,67 @@ public void obtainPersistentIdentifiersForDatafiles(Dataset dataset) {\n     }\n     \n     public long findStorageSize(Dataset dataset) throws IOException {\n-        return findStorageSize(dataset, false);\n+        return findStorageSize(dataset, false, \"storage\", null);\n     }\n     \n+    \n+    public long findStorageSize(Dataset dataset, boolean countCachedExtras) throws IOException {\n+        return findStorageSize(dataset, countCachedExtras, \"storage\", null);\n+    }\n+  \n     /**\n      * Returns the total byte size of the files in this dataset \n      * \n      * @param dataset\n      * @param countCachedExtras boolean indicating if the cached disposable extras should also be counted\n+     * @param mode String indicating whether we are getting the result for storage (entire dataset) or download version based\n+     * @param version optional param for dataset version\n      * @return total size \n      * @throws IOException if it can't access the objects via StorageIO \n      * (in practice, this can only happen when called with countCachedExtras=true; when run in the \n      * default mode, the method doesn't need to access the storage system, as the \n      * sizes of the main files are recorded in the database)\n      */\n-    public long findStorageSize(Dataset dataset, boolean countCachedExtras) throws IOException {\n+    public long findStorageSize(Dataset dataset, boolean countCachedExtras, String mode, DatasetVersion version) throws IOException {\n         long total = 0L; \n         \n         if (dataset.isHarvested()) {\n             return 0L;\n         }\n+\n+        List<DataFile> filesToTalley = new ArrayList();", "originalCommit": "9dc2fdafbc387fb848e1c3b7edb5c95dc5993d0e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "87225bd46ef25f6d152f075c5eed5b3687882f41", "chunk": "diff --git a/src/main/java/edu/harvard/iq/dataverse/DatasetServiceBean.java b/src/main/java/edu/harvard/iq/dataverse/DatasetServiceBean.java\nindex 74f99416d..eb77104e5 100644\n--- a/src/main/java/edu/harvard/iq/dataverse/DatasetServiceBean.java\n+++ b/src/main/java/edu/harvard/iq/dataverse/DatasetServiceBean.java\n\n@@ -866,12 +867,12 @@ public class DatasetServiceBean implements java.io.Serializable {\n     }\n     \n     public long findStorageSize(Dataset dataset) throws IOException {\n-        return findStorageSize(dataset, false, \"storage\", null);\n+        return findStorageSize(dataset, false, GetDatasetStorageSizeCommand.Mode.STORAGE, null);\n     }\n     \n     \n     public long findStorageSize(Dataset dataset, boolean countCachedExtras) throws IOException {\n-        return findStorageSize(dataset, countCachedExtras, \"storage\", null);\n+        return findStorageSize(dataset, countCachedExtras, GetDatasetStorageSizeCommand.Mode.STORAGE, null);\n     }\n   \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQyNzgyMg==", "url": "https://github.com/IQSS/dataverse/pull/6609#discussion_r375427822", "bodyText": "It would be nice to document the accepted values for \"mode\".", "author": "pdurbin", "createdAt": "2020-02-05T18:23:28Z", "path": "src/main/java/edu/harvard/iq/dataverse/DatasetServiceBean.java", "diffHunk": "@@ -866,45 +866,67 @@ public void obtainPersistentIdentifiersForDatafiles(Dataset dataset) {\n     }\n     \n     public long findStorageSize(Dataset dataset) throws IOException {\n-        return findStorageSize(dataset, false);\n+        return findStorageSize(dataset, false, \"storage\", null);\n     }\n     \n+    \n+    public long findStorageSize(Dataset dataset, boolean countCachedExtras) throws IOException {\n+        return findStorageSize(dataset, countCachedExtras, \"storage\", null);\n+    }\n+  \n     /**\n      * Returns the total byte size of the files in this dataset \n      * \n      * @param dataset\n      * @param countCachedExtras boolean indicating if the cached disposable extras should also be counted\n+     * @param mode String indicating whether we are getting the result for storage (entire dataset) or download version based", "originalCommit": "9dc2fdafbc387fb848e1c3b7edb5c95dc5993d0e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "87225bd46ef25f6d152f075c5eed5b3687882f41", "chunk": "diff --git a/src/main/java/edu/harvard/iq/dataverse/DatasetServiceBean.java b/src/main/java/edu/harvard/iq/dataverse/DatasetServiceBean.java\nindex 74f99416d..eb77104e5 100644\n--- a/src/main/java/edu/harvard/iq/dataverse/DatasetServiceBean.java\n+++ b/src/main/java/edu/harvard/iq/dataverse/DatasetServiceBean.java\n\n@@ -866,12 +867,12 @@ public class DatasetServiceBean implements java.io.Serializable {\n     }\n     \n     public long findStorageSize(Dataset dataset) throws IOException {\n-        return findStorageSize(dataset, false, \"storage\", null);\n+        return findStorageSize(dataset, false, GetDatasetStorageSizeCommand.Mode.STORAGE, null);\n     }\n     \n     \n     public long findStorageSize(Dataset dataset, boolean countCachedExtras) throws IOException {\n-        return findStorageSize(dataset, countCachedExtras, \"storage\", null);\n+        return findStorageSize(dataset, countCachedExtras, GetDatasetStorageSizeCommand.Mode.STORAGE, null);\n     }\n   \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQyODMzNA==", "url": "https://github.com/IQSS/dataverse/pull/6609#discussion_r375428334", "bodyText": "Instead of a String for \"mode\" and enum would be nice. More type safe that way. And auto documenting.", "author": "pdurbin", "createdAt": "2020-02-05T18:24:31Z", "path": "src/main/java/edu/harvard/iq/dataverse/engine/command/impl/GetDatasetStorageSizeCommand.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * To change this license header, choose License Headers in Project Properties.\n+ * To change this template file, choose Tools | Templates\n+ * and open the template in the editor.\n+ */\n+package edu.harvard.iq.dataverse.engine.command.impl;\n+\n+import edu.harvard.iq.dataverse.Dataset;\n+import edu.harvard.iq.dataverse.DatasetVersion;\n+import edu.harvard.iq.dataverse.Dataverse;\n+import edu.harvard.iq.dataverse.authorization.Permission;\n+import edu.harvard.iq.dataverse.engine.command.AbstractCommand;\n+import edu.harvard.iq.dataverse.engine.command.CommandContext;\n+import edu.harvard.iq.dataverse.engine.command.DataverseRequest;\n+import edu.harvard.iq.dataverse.engine.command.RequiredPermissions;\n+import edu.harvard.iq.dataverse.engine.command.exception.CommandException;\n+import edu.harvard.iq.dataverse.util.BundleUtil;\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.logging.Logger;\n+\n+/**\n+ *\n+ * @author skraffmi\n+ */\n+@RequiredPermissions({})\n+public class GetDatasetStorageSizeCommand extends AbstractCommand<Long> {\n+\n+    private static final Logger logger = Logger.getLogger(GetDataverseStorageSizeCommand.class.getCanonicalName());\n+\n+    private final Dataset dataset;\n+    private final Boolean countCachedFiles;\n+    private final String mode;", "originalCommit": "9dc2fdafbc387fb848e1c3b7edb5c95dc5993d0e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "87225bd46ef25f6d152f075c5eed5b3687882f41", "chunk": "diff --git a/src/main/java/edu/harvard/iq/dataverse/engine/command/impl/GetDatasetStorageSizeCommand.java b/src/main/java/edu/harvard/iq/dataverse/engine/command/impl/GetDatasetStorageSizeCommand.java\nindex c167c5139..271c9f214 100644\n--- a/src/main/java/edu/harvard/iq/dataverse/engine/command/impl/GetDatasetStorageSizeCommand.java\n+++ b/src/main/java/edu/harvard/iq/dataverse/engine/command/impl/GetDatasetStorageSizeCommand.java\n\n@@ -32,18 +32,23 @@ public class GetDatasetStorageSizeCommand extends AbstractCommand<Long> {\n \n     private final Dataset dataset;\n     private final Boolean countCachedFiles;\n-    private final String mode;\n+    private final Mode mode;\n     private final DatasetVersion version;\n+    \n+    public enum Mode {\n+\n+        STORAGE, DOWNLOAD\n+    };\n \n     public GetDatasetStorageSizeCommand(DataverseRequest aRequest, Dataset target) {\n         super(aRequest, target);\n         dataset = target;\n         countCachedFiles = false;\n-        mode = \"download\";\n+        mode = Mode.DOWNLOAD;\n         version = null;\n     }\n \n-    public GetDatasetStorageSizeCommand(DataverseRequest aRequest, Dataset target, boolean countCachedFiles, String mode, DatasetVersion version) {\n+    public GetDatasetStorageSizeCommand(DataverseRequest aRequest, Dataset target, boolean countCachedFiles, Mode mode, DatasetVersion version) {\n         super(aRequest, target);\n         dataset = target;\n         this.countCachedFiles = countCachedFiles;\n"}}, {"oid": "915c9e05aacc3479f12dd48e54f46dd568b179b2", "url": "https://github.com/IQSS/dataverse/commit/915c9e05aacc3479f12dd48e54f46dd568b179b2", "message": "Merge branch 'develop' into 6524-dataset-size-api", "committedDate": "2020-02-05T22:01:21Z", "type": "commit"}, {"oid": "87225bd46ef25f6d152f075c5eed5b3687882f41", "url": "https://github.com/IQSS/dataverse/commit/87225bd46ef25f6d152f075c5eed5b3687882f41", "message": "#6524 make \"mode\" enum and fix tests", "committedDate": "2020-02-06T15:19:21Z", "type": "commit"}, {"oid": "bd3b97fde322c6f5dd68fdde196f9819c6915b20", "url": "https://github.com/IQSS/dataverse/commit/bd3b97fde322c6f5dd68fdde196f9819c6915b20", "message": "#6524 fix typo", "committedDate": "2020-02-06T15:22:33Z", "type": "commit"}, {"oid": "8ed63c5770f213ce0bf30243c6aa63a94a7e52ac", "url": "https://github.com/IQSS/dataverse/commit/8ed63c5770f213ce0bf30243c6aa63a94a7e52ac", "message": "Merge branch 'develop' into 6524-dataset-size-api", "committedDate": "2020-02-06T18:58:05Z", "type": "commit"}, {"oid": "9478caa13eda109cf353abdc6394e19d3036ffe5", "url": "https://github.com/IQSS/dataverse/commit/9478caa13eda109cf353abdc6394e19d3036ffe5", "message": "#6524 fix required permissions add tests", "committedDate": "2020-02-06T19:32:16Z", "type": "commit"}]}