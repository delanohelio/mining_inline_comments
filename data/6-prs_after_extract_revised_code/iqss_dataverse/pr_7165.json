{"pr_number": 7165, "pr_title": "7159 fix restassured etc", "pr_createdAt": "2020-08-06T13:08:55Z", "pr_url": "https://github.com/IQSS/dataverse/pull/7165", "timeline": [{"oid": "a0d94a4d6c18dd8113452f29015af98c24ebfbd1", "url": "https://github.com/IQSS/dataverse/commit/a0d94a4d6c18dd8113452f29015af98c24ebfbd1", "message": "Followup fixes for PR #6918. Missing additions to UtilIT.java needed for RestAssured to work;\nbut also some changes for the application proper to address some problematic things in the\nexecution framework of the publish commands. Will explain more in the PR. (#7159)", "committedDate": "2020-08-05T22:53:18Z", "type": "commit"}, {"oid": "1c95927af39f1d6fbd0c6a5026ac6ba2f8eb14d3", "url": "https://github.com/IQSS/dataverse/commit/1c95927af39f1d6fbd0c6a5026ac6ba2f8eb14d3", "message": "Merge branch 'develop' into 7159-fix-restassured-etc", "committedDate": "2020-08-05T23:03:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQxNDc3Mw==", "url": "https://github.com/IQSS/dataverse/pull/7165#discussion_r466414773", "bodyText": "if this submit fails, isn't something beyond logging required?", "author": "qqmyers", "createdAt": "2020-08-06T13:32:48Z", "path": "src/main/java/edu/harvard/iq/dataverse/DatasetServiceBean.java", "diffHunk": "@@ -780,21 +780,36 @@ public WorkflowComment addWorkflowComment(WorkflowComment workflowComment) {\n         return workflowComment;\n     }\n     \n+    /**\n+     * This method used to throw CommandException, which was pretty pointless \n+     * seeing how it's called asynchronously. As of v5.0 any CommanExceptiom \n+     * thrown by the FinalizeDatasetPublicationCommand below will be caught \n+     * and we'll log it as a warning - which is the best we can do at this point.\n+     * Any failure notifications to users should be sent from inside the command.\n+     */\n     @Asynchronous\n-    public void callFinalizePublishCommandAsynchronously(Long datasetId, CommandContext ctxt, DataverseRequest request, boolean isPidPrePublished) throws CommandException {\n+    public void callFinalizePublishCommandAsynchronously(Long datasetId, CommandContext ctxt, DataverseRequest request, boolean isPidPrePublished) {\n \n         // Since we are calling the next command asynchronously anyway - sleep here \n         // for a few seconds, just in case, to make sure the database update of \n         // the dataset initiated by the PublishDatasetCommand has finished, \n         // to avoid any concurrency/optimistic lock issues. \n-        try {\n-            Thread.sleep(15000);\n+        // Aug. 2020/v5.0: It appears to be working consistently without any \n+        // sleep here, after the call the method has been moved to the onSuccess()\n+        // portion of the PublishDatasetCommand. I'm going to leave the 1 second\n+        // sleep commented-out below for now: -- L.A.\n+        /*try {\n+            Thread.sleep(1000);\n         } catch (Exception ex) {\n-            logger.warning(\"Failed to sleep for 15 seconds.\");\n-        }\n+            logger.warning(\"Failed to sleep for 1 second.\");\n+        }*/\n         logger.fine(\"Running FinalizeDatasetPublicationCommand, asynchronously\");\n         Dataset theDataset = find(datasetId);\n-        commandEngine.submit(new FinalizeDatasetPublicationCommand(theDataset, request, isPidPrePublished));\n+        try {\n+            commandEngine.submit(new FinalizeDatasetPublicationCommand(theDataset, request, isPidPrePublished));\n+        } catch (CommandException cex) {\n+            logger.warning(\"CommandException caught when executing the asynchronous portion of the Dataset Publication Command.\");\n+        }", "originalCommit": "1c95927af39f1d6fbd0c6a5026ac6ba2f8eb14d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQyNzcyMQ==", "url": "https://github.com/IQSS/dataverse/pull/7165#discussion_r466427721", "bodyText": "Not sure what else could be done here.  I added a comment there; we weren't even logging before - that method was throwing CommandException - which was pointless combined with Async.\nThe main idea is that the finalize command should send any notifications, or do any other failure handling internally.", "author": "landreev", "createdAt": "2020-08-06T13:51:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQxNDc3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "d15fa77209c03090e79c259d9d8d2bebd3c9ede6", "chunk": "diff --git a/src/main/java/edu/harvard/iq/dataverse/DatasetServiceBean.java b/src/main/java/edu/harvard/iq/dataverse/DatasetServiceBean.java\nindex 945fcb61e..c4049f3be 100644\n--- a/src/main/java/edu/harvard/iq/dataverse/DatasetServiceBean.java\n+++ b/src/main/java/edu/harvard/iq/dataverse/DatasetServiceBean.java\n\n@@ -788,21 +788,22 @@ public class DatasetServiceBean implements java.io.Serializable {\n      * Any failure notifications to users should be sent from inside the command.\n      */\n     @Asynchronous\n+    @TransactionAttribute(TransactionAttributeType.SUPPORTS)\n     public void callFinalizePublishCommandAsynchronously(Long datasetId, CommandContext ctxt, DataverseRequest request, boolean isPidPrePublished) {\n \n         // Since we are calling the next command asynchronously anyway - sleep here \n         // for a few seconds, just in case, to make sure the database update of \n         // the dataset initiated by the PublishDatasetCommand has finished, \n         // to avoid any concurrency/optimistic lock issues. \n-        // Aug. 2020/v5.0: It appears to be working consistently without any \n+        // Aug. 2020/v5.0: It MAY be working consistently without any \n         // sleep here, after the call the method has been moved to the onSuccess()\n         // portion of the PublishDatasetCommand. I'm going to leave the 1 second\n-        // sleep commented-out below for now: -- L.A.\n-        /*try {\n+        // sleep below, for just in case reasons: -- L.A.\n+        try {\n             Thread.sleep(1000);\n         } catch (Exception ex) {\n-            logger.warning(\"Failed to sleep for 1 second.\");\n-        }*/\n+            logger.warning(\"Failed to sleep for a second.\");\n+        }\n         logger.fine(\"Running FinalizeDatasetPublicationCommand, asynchronously\");\n         Dataset theDataset = find(datasetId);\n         try {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQxNjY0Mg==", "url": "https://github.com/IQSS/dataverse/pull/7165#discussion_r466416642", "bodyText": "does this result in a 200 when the dataset is still inprogress/publishing not yet finalized? Seems like 202 is the right code for that (as it was) and the test should be watching for a 202?", "author": "qqmyers", "createdAt": "2020-08-06T13:35:39Z", "path": "src/main/java/edu/harvard/iq/dataverse/api/Datasets.java", "diffHunk": "@@ -1020,7 +1020,7 @@ public Response publishDataset(@PathParam(\"id\") String id, @QueryParam(\"type\") S\n             PublishDatasetResult res = execCommand(new PublishDatasetCommand(ds,\n                         createDataverseRequest(user),\n                     isMinor));\n-            return res.isCompleted() ? ok(json(res.getDataset())) : accepted(json(res.getDataset()));\n+            return res.isWorkflow() ? accepted(json(res.getDataset())) : ok(json(res.getDataset()));", "originalCommit": "1c95927af39f1d6fbd0c6a5026ac6ba2f8eb14d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQzNDYzNA==", "url": "https://github.com/IQSS/dataverse/pull/7165#discussion_r466434634", "bodyText": "With the async publication in progress it returns a 200; the presence of the \"finalizing\" lock is the indication of it being in progress.\nTo me it seemed like the 202 return code was specifically added for the workflow situation; and there may be some third party code that relies on it in that context. When the async publication was added we just used that mechanism that was there for the workflow.  But using the same code for this scenario seemed wrong.\nAnd most importantly, yes, this allowed me not to have to modify much more RestAssured code.", "author": "landreev", "createdAt": "2020-08-06T14:01:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQxNjY0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQ0NDQ2Nw==", "url": "https://github.com/IQSS/dataverse/pull/7165#discussion_r466444467", "bodyText": "I understand the practicality and don't think it's a big issue in terms of any effect, but I think 202 is the right code for anything asynchronous that could fail after you get your response. If its not worth addressing now, I'd suggest a ToDo/note in the code.", "author": "qqmyers", "createdAt": "2020-08-06T14:15:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQxNjY0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUwMDYxNw==", "url": "https://github.com/IQSS/dataverse/pull/7165#discussion_r466500617", "bodyText": "So maybe the same code 202, but something in the body to differentiate from the \"workflow\" state. As it was implemented, it was returning the code 202 and {\"status\":\"WORKFLOW...} in both cases - which was wrong.\nIt feels like this warrants its own issue - I'll open it.", "author": "landreev", "createdAt": "2020-08-06T15:34:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQxNjY0Mg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQ0OTMwNg==", "url": "https://github.com/IQSS/dataverse/pull/7165#discussion_r466449306", "bodyText": "Broad question - now that finalize is always asynchronous, it looks like these tests check that the publish call succeeds and the lock goes away, but is there anything to check that the async publish succeeded rather than failed? (E.g. test that a new version exists after the lock?).", "author": "qqmyers", "createdAt": "2020-08-06T14:22:29Z", "path": "src/test/java/edu/harvard/iq/dataverse/api/UtilIT.java", "diffHunk": "@@ -2232,12 +2251,27 @@ static Boolean sleepForSearch(String searchPart, String apiToken,  String subTre\n \n     }\n     \n-    \n-    \n+    // backward compatibility version of the method that takes long for the id:\n     static Response checkDatasetLocks(long datasetId, String lockType, String apiToken) {\n+        String datasetIdAsString = String.valueOf(datasetId);\n+        return checkDatasetLocks(datasetIdAsString, lockType, apiToken);\n+    }\n+    \n+    static Response checkDatasetLocks(String idOrPersistentId, String lockType, String apiToken) {", "originalCommit": "1c95927af39f1d6fbd0c6a5026ac6ba2f8eb14d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQ1NzI5Nw==", "url": "https://github.com/IQSS/dataverse/pull/7165#discussion_r466457297", "bodyText": "That would be the proper way to handle it, yes.\nIt didn't look like we were ever checking anything other than the return http code of that publish call. But you are right, even that was more than what we are doing now.\nIn many tests the success of the publish call is tested indirectly, because what the test does requires the dataset to be published. But I agree it would be prudent, to check on the version numbers before and after - or perform some other explicit checks.", "author": "landreev", "createdAt": "2020-08-06T14:32:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQ0OTMwNg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "d15fa77209c03090e79c259d9d8d2bebd3c9ede6", "url": "https://github.com/IQSS/dataverse/commit/d15fa77209c03090e79c259d9d8d2bebd3c9ede6", "message": "Fix for the transaction context in the finalize command execution;\nMoved the unlock calls back to the end of the execute method. #7159", "committedDate": "2020-08-06T19:09:00Z", "type": "commit"}, {"oid": "32756fce3428621a8d28699bbf59cc3fffa5d955", "url": "https://github.com/IQSS/dataverse/commit/32756fce3428621a8d28699bbf59cc3fffa5d955", "message": "making a commit just to kick off another jenkins test run.", "committedDate": "2020-08-06T20:26:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY3MDAzOA==", "url": "https://github.com/IQSS/dataverse/pull/7165#discussion_r466670038", "bodyText": "Did you try it without this? I'd love to get this removed, if we don't actually need it.", "author": "scolapasta", "createdAt": "2020-08-06T20:33:07Z", "path": "src/main/java/edu/harvard/iq/dataverse/DatasetServiceBean.java", "diffHunk": "@@ -780,21 +780,37 @@ public WorkflowComment addWorkflowComment(WorkflowComment workflowComment) {\n         return workflowComment;\n     }\n     \n+    /**\n+     * This method used to throw CommandException, which was pretty pointless \n+     * seeing how it's called asynchronously. As of v5.0 any CommanExceptiom \n+     * thrown by the FinalizeDatasetPublicationCommand below will be caught \n+     * and we'll log it as a warning - which is the best we can do at this point.\n+     * Any failure notifications to users should be sent from inside the command.\n+     */\n     @Asynchronous\n-    public void callFinalizePublishCommandAsynchronously(Long datasetId, CommandContext ctxt, DataverseRequest request, boolean isPidPrePublished) throws CommandException {\n+    @TransactionAttribute(TransactionAttributeType.SUPPORTS)\n+    public void callFinalizePublishCommandAsynchronously(Long datasetId, CommandContext ctxt, DataverseRequest request, boolean isPidPrePublished) {\n \n         // Since we are calling the next command asynchronously anyway - sleep here \n         // for a few seconds, just in case, to make sure the database update of \n         // the dataset initiated by the PublishDatasetCommand has finished, \n         // to avoid any concurrency/optimistic lock issues. \n+        // Aug. 2020/v5.0: It MAY be working consistently without any \n+        // sleep here, after the call the method has been moved to the onSuccess()\n+        // portion of the PublishDatasetCommand. I'm going to leave the 1 second\n+        // sleep below, for just in case reasons: -- L.A.\n         try {\n-            Thread.sleep(15000);\n+            Thread.sleep(1000);", "originalCommit": "32756fce3428621a8d28699bbf59cc3fffa5d955", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjcyMTQ0OA==", "url": "https://github.com/IQSS/dataverse/pull/7165#discussion_r466721448", "bodyText": "Can I leave it in place?\nI initially removed it completely; but I'm just afraid to take it out. Publishing appears to be working (at least I haven't seen it fail yet). But I believe if it happens instantly/very fast, on small datasets w/ fast registration, etc., it can confuse the autorefresh on the page.", "author": "landreev", "createdAt": "2020-08-06T22:34:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY3MDAzOA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY3MTk1OQ==", "url": "https://github.com/IQSS/dataverse/pull/7165#discussion_r466671959", "bodyText": "I guess this is just to be extra safe, but would this ever be false? (since we're already in OnSuccess, that means the execute succeeded, no?", "author": "scolapasta", "createdAt": "2020-08-06T20:37:00Z", "path": "src/main/java/edu/harvard/iq/dataverse/engine/command/impl/PublishDatasetCommand.java", "diffHunk": "@@ -196,6 +199,24 @@ private void verifyCommandArguments() throws IllegalCommandException {\n                 throw new IllegalCommandException(\"Cannot release as minor version. Re-try as major release.\", this);\n             }\n         }\n-    }   \n+    }\n+    \n+    \n+    @Override\n+    public boolean onSuccess(CommandContext ctxt, Object r) {\n+        Dataset dataset = null;\n+        try{\n+            dataset = (Dataset) r;\n+        } catch (ClassCastException e){\n+            dataset  = ((PublishDatasetResult) r).getDataset();\n+        }\n+\n+        if (dataset != null) {", "originalCommit": "32756fce3428621a8d28699bbf59cc3fffa5d955", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjcyMDUwNg==", "url": "https://github.com/IQSS/dataverse/pull/7165#discussion_r466720506", "bodyText": "I guess in case something else still goes wrong, in some other way? - idk.", "author": "landreev", "createdAt": "2020-08-06T22:31:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY3MTk1OQ=="}], "type": "inlineReview", "revised_code": null}]}