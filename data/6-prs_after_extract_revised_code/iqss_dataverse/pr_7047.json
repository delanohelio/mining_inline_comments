{"pr_number": 7047, "pr_title": "Add \"download all\" buttons (including size of dataset) to dataset page", "pr_createdAt": "2020-07-01T19:58:22Z", "pr_url": "https://github.com/IQSS/dataverse/pull/7047", "timeline": [{"oid": "c1a612628e331cdaa29753a8c6369fc7c7bcd9ae", "url": "https://github.com/IQSS/dataverse/commit/c1a612628e331cdaa29753a8c6369fc7c7bcd9ae", "message": "add download all buttons under access button #6118", "committedDate": "2020-06-30T17:12:39Z", "type": "commit"}, {"oid": "3f4ac7f34c2be2948a4a7a0507d31e700adb064a", "url": "https://github.com/IQSS/dataverse/commit/3f4ac7f34c2be2948a4a7a0507d31e700adb064a", "message": "add size to \"download all\" link #6118", "committedDate": "2020-07-01T17:08:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NzIzOA==", "url": "https://github.com/IQSS/dataverse/pull/7047#discussion_r448667238", "bodyText": "I assume this selectAllFiles() is what's responsible for the odd UI behavior... when you select \"Download\" from the Access Dataset dropdown, you get the ZIP download, but now all the files are selected in the files table... that shouldn't be necessary... there has to be a way to get the ZIP without the unexpected UI behavior.", "author": "mheppler", "createdAt": "2020-07-01T23:29:48Z", "path": "src/main/java/edu/harvard/iq/dataverse/DatasetPage.java", "diffHunk": "@@ -2886,8 +2889,35 @@ public void setSelectedDownloadableFiles(List<FileMetadata> selectedDownloadable\n     public void setSelectedNonDownloadableFiles(List<FileMetadata> selectedNonDownloadableFiles) {\n         this.selectedNonDownloadableFiles = selectedNonDownloadableFiles;\n     }\n-    \n-            \n+\n+    public String getSizeOfDataset() {\n+        GetDatasetStorageSizeCommand cmd = new GetDatasetStorageSizeCommand(dvRequestService.getDataverseRequest(), dataset, false, GetDatasetStorageSizeCommand.Mode.DOWNLOAD, workingVersion);\n+        try {\n+            long bytes = commandEngine.submit(cmd);\n+            return FileSizeChecker.bytesToHumanReadable(bytes);\n+        } catch (CommandException ex) {\n+            return \"\";\n+        }\n+    }\n+\n+    public void validateAllFilesForDownloadArchival() {\n+        selectAllFiles();", "originalCommit": "3f4ac7f34c2be2948a4a7a0507d31e700adb064a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE1NzMxMA==", "url": "https://github.com/IQSS/dataverse/pull/7047#discussion_r449157310", "bodyText": "I tried adding clearSelection() to the end like this...\n     public void validateAllFilesForDownloadArchival() {\n         selectAllFiles();\n         boolean guestbookRequired = isDownloadPopupRequired();\n         boolean downloadOriginal = false;\n         validateFilesForDownload(guestbookRequired, downloadOriginal);\n+        clearSelection();\n     }\n\n... but now it thinks no files are selected:\n\nSo yes, I agree a fix would be nice but I'm not sure what that fix is.", "author": "pdurbin", "createdAt": "2020-07-02T17:09:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NzIzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE2MzA1Ng==", "url": "https://github.com/IQSS/dataverse/pull/7047#discussion_r449163056", "bodyText": "Wouldn't the fix be to use a different method than what the one that cares about selected files? i.e\nchange current method to get selected files and get a list, path that to new private method that takes core of current method but uses this new list.\nCreate a new method that generates a list and calls new that new private method.\nYou'd of course have to make sure all the checks for permissions are happening correctly, but I'd expect that to already be in the backend side (i.e. we already shouldn't be relying in the front end to only pass in the permissible values)", "author": "scolapasta", "createdAt": "2020-07-02T17:18:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NzIzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA2NzI1NQ==", "url": "https://github.com/IQSS/dataverse/pull/7047#discussion_r451067255", "bodyText": "@scolapasta @mheppler please see 427c883. This pull request is now much bigger but it no longer uses selectedFiles which is what the checkboxes are connected to.", "author": "pdurbin", "createdAt": "2020-07-07T18:38:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NzIzOA=="}], "type": "inlineReview", "revised_code": {"commit": "427c88356ee9aa684360457b14419d3f8474423a", "chunk": "diff --git a/src/main/java/edu/harvard/iq/dataverse/DatasetPage.java b/src/main/java/edu/harvard/iq/dataverse/DatasetPage.java\nindex f9f0eccb9..5fed0b625 100644\n--- a/src/main/java/edu/harvard/iq/dataverse/DatasetPage.java\n+++ b/src/main/java/edu/harvard/iq/dataverse/DatasetPage.java\n\n@@ -2890,6 +2890,16 @@ public class DatasetPage implements java.io.Serializable {\n         this.selectedNonDownloadableFiles = selectedNonDownloadableFiles;\n     }\n \n+    private List<FileMetadata> selectedNonDownloadallableFiles;\n+\n+    public List<FileMetadata> getSelectedNonDownloadallableFiles() {\n+        return selectedNonDownloadallableFiles;\n+    }\n+\n+    public void setSelectedNonDownloadallableFiles(List<FileMetadata> selectedNonDownloadallableFiles) {\n+        this.selectedNonDownloadallableFiles = selectedNonDownloadallableFiles;\n+    }\n+\n     public String getSizeOfDataset() {\n         GetDatasetStorageSizeCommand cmd = new GetDatasetStorageSizeCommand(dvRequestService.getDataverseRequest(), dataset, false, GetDatasetStorageSizeCommand.Mode.DOWNLOAD, workingVersion);\n         try {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2ODE5Ng==", "url": "https://github.com/IQSS/dataverse/pull/7047#discussion_r448668196", "bodyText": "Bug in the download size displayed. My locally tested datasets are saying the download will be \"300 B\", but the resulting ZIP is 11 KB, or 11,000 B.", "author": "mheppler", "createdAt": "2020-07-01T23:32:29Z", "path": "src/main/java/edu/harvard/iq/dataverse/DatasetPage.java", "diffHunk": "@@ -2886,8 +2889,35 @@ public void setSelectedDownloadableFiles(List<FileMetadata> selectedDownloadable\n     public void setSelectedNonDownloadableFiles(List<FileMetadata> selectedNonDownloadableFiles) {\n         this.selectedNonDownloadableFiles = selectedNonDownloadableFiles;\n     }\n-    \n-            \n+\n+    public String getSizeOfDataset() {\n+        GetDatasetStorageSizeCommand cmd = new GetDatasetStorageSizeCommand(dvRequestService.getDataverseRequest(), dataset, false, GetDatasetStorageSizeCommand.Mode.DOWNLOAD, workingVersion);\n+        try {\n+            long bytes = commandEngine.submit(cmd);\n+            return FileSizeChecker.bytesToHumanReadable(bytes);", "originalCommit": "3f4ac7f34c2be2948a4a7a0507d31e700adb064a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTEzNDk0NQ==", "url": "https://github.com/IQSS/dataverse/pull/7047#discussion_r449134945", "bodyText": "Yes, this what I noted when saying \"riddle me this\" in the description of this pull request (with a screenshot), that there's a mismatch in size. GetDatasetStorageSizeCommand needs discussion in tech hours or #dv-tech (heads up @scolapasta ) or a smaller group. I haven't looked into the implementation but the thing I was wondering about is how we estimate the size of a zip. Text files compress really well. Video files don't. I doubt the number will ever be 100% accurate. But yes, it seems pretty far off right now.", "author": "pdurbin", "createdAt": "2020-07-02T16:28:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2ODE5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE0Mzk4NQ==", "url": "https://github.com/IQSS/dataverse/pull/7047#discussion_r449143985", "bodyText": "We can discuss next tech hours, sure. But isn't the inaccuracy in the wrong direction?\ni.e. the ip should be smaller than the size from GetDatasetStorageSizeCommand? I could imagine a scenario where it would be large (due to zip headers), but in that case, I would expect it to be close in size.\nBut maybe this is \"close\" in this scenario.", "author": "scolapasta", "createdAt": "2020-07-02T16:43:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2ODE5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE0ODUwNw==", "url": "https://github.com/IQSS/dataverse/pull/7047#discussion_r451148507", "bodyText": "As discussed in tech hours, the problem seems to stem from double counting tabular files (counting both the size of the original file and the archival version). I just pushed a fix in 1957776.", "author": "pdurbin", "createdAt": "2020-07-07T21:16:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2ODE5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "427c88356ee9aa684360457b14419d3f8474423a", "chunk": "diff --git a/src/main/java/edu/harvard/iq/dataverse/DatasetPage.java b/src/main/java/edu/harvard/iq/dataverse/DatasetPage.java\nindex f9f0eccb9..5fed0b625 100644\n--- a/src/main/java/edu/harvard/iq/dataverse/DatasetPage.java\n+++ b/src/main/java/edu/harvard/iq/dataverse/DatasetPage.java\n\n@@ -2890,6 +2890,16 @@ public class DatasetPage implements java.io.Serializable {\n         this.selectedNonDownloadableFiles = selectedNonDownloadableFiles;\n     }\n \n+    private List<FileMetadata> selectedNonDownloadallableFiles;\n+\n+    public List<FileMetadata> getSelectedNonDownloadallableFiles() {\n+        return selectedNonDownloadallableFiles;\n+    }\n+\n+    public void setSelectedNonDownloadallableFiles(List<FileMetadata> selectedNonDownloadallableFiles) {\n+        this.selectedNonDownloadallableFiles = selectedNonDownloadallableFiles;\n+    }\n+\n     public String getSizeOfDataset() {\n         GetDatasetStorageSizeCommand cmd = new GetDatasetStorageSizeCommand(dvRequestService.getDataverseRequest(), dataset, false, GetDatasetStorageSizeCommand.Mode.DOWNLOAD, workingVersion);\n         try {\n"}}, {"oid": "054f249a4181672e2ca49245a4c9d138f4c9d37a", "url": "https://github.com/IQSS/dataverse/commit/054f249a4181672e2ca49245a4c9d138f4c9d37a", "message": "add btn-download style class for analytics #6118", "committedDate": "2020-07-02T15:27:32Z", "type": "commit"}, {"oid": "140ba41e4501324bb513bc6fe760e3aa5e8ed55d", "url": "https://github.com/IQSS/dataverse/commit/140ba41e4501324bb513bc6fe760e3aa5e8ed55d", "message": "move ZIP to bundle #6118", "committedDate": "2020-07-02T16:16:49Z", "type": "commit"}, {"oid": "427c88356ee9aa684360457b14419d3f8474423a", "url": "https://github.com/IQSS/dataverse/commit/427c88356ee9aa684360457b14419d3f8474423a", "message": "stop using selectedFiles field #6118", "committedDate": "2020-07-07T18:35:23Z", "type": "commit"}, {"oid": "19577769b5aabe4ab1b9391b0fc0de01857a547b", "url": "https://github.com/IQSS/dataverse/commit/19577769b5aabe4ab1b9391b0fc0de01857a547b", "message": "don't double count tabular files in size #6118", "committedDate": "2020-07-07T21:13:47Z", "type": "commit"}, {"oid": "115353c44aa69a48e1b729d9abeb87a63c6f3411", "url": "https://github.com/IQSS/dataverse/commit/115353c44aa69a48e1b729d9abeb87a63c6f3411", "message": "prevent orig file size from being added to tabular files #6118", "committedDate": "2020-07-16T18:05:57Z", "type": "commit"}, {"oid": "7e79f1beb3372f1d536e67d4558bbf69e649fb56", "url": "https://github.com/IQSS/dataverse/commit/7e79f1beb3372f1d536e67d4558bbf69e649fb56", "message": "use version to determine if tabular download #6118", "committedDate": "2020-07-16T18:45:37Z", "type": "commit"}, {"oid": "c13a5cc688178da83577f59ebc0791301aca6de2", "url": "https://github.com/IQSS/dataverse/commit/c13a5cc688178da83577f59ebc0791301aca6de2", "message": "switch to smaller, simpler download size method #6118\n\nAlso, revert changes to GetDatasetStorageSizeCommand\nand DatasetServiceBean since we won't be using them.", "committedDate": "2020-07-16T20:12:31Z", "type": "commit"}, {"oid": "174ec432811710cc701b341ea99d0e5eb71ecf5d", "url": "https://github.com/IQSS/dataverse/commit/174ec432811710cc701b341ea99d0e5eb71ecf5d", "message": "remove unused imports #6118", "committedDate": "2020-07-16T20:24:55Z", "type": "commit"}]}