{"pr_number": 7410, "pr_title": "don't always return OK from get PID API #7187", "pr_createdAt": "2020-11-13T21:58:40Z", "pr_url": "https://github.com/IQSS/dataverse/pull/7410", "timeline": [{"oid": "116379ed5b0e36fede95660e9628183c54dc349c", "url": "https://github.com/IQSS/dataverse/commit/116379ed5b0e36fede95660e9628183c54dc349c", "message": "don't always return OK from get PID API #7187", "committedDate": "2020-11-13T21:51:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ0NTI1MQ==", "url": "https://github.com/IQSS/dataverse/pull/7410#discussion_r523445251", "bodyText": "Since this is a config problem, BAD_REQUEST is probably not the right response.", "author": "qqmyers", "createdAt": "2020-11-14T17:55:19Z", "path": "src/main/java/edu/harvard/iq/dataverse/api/Pids.java", "diffHunk": "@@ -48,8 +48,12 @@ public Response getPid(@QueryParam(\"persistentId\") String persistentId) {\n         String baseUrl = systemConfig.getDataCiteRestApiUrlString();\n         String username = System.getProperty(\"doi.username\");\n         String password = System.getProperty(\"doi.password\");\n-        JsonObjectBuilder result = PidUtil.queryDoi(persistentId, baseUrl, username, password);\n-        return ok(result);\n+        try {\n+            JsonObjectBuilder result = PidUtil.queryDoi(persistentId, baseUrl, username, password);\n+            return ok(result);\n+        } catch (Exception ex) {\n+            return error(Response.Status.BAD_REQUEST, ex.getLocalizedMessage());", "originalCommit": "116379ed5b0e36fede95660e9628183c54dc349c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQxMDM3Ng==", "url": "https://github.com/IQSS/dataverse/pull/7410#discussion_r524410376", "bodyText": "@qqmyers yeah, 500 probably makes more sense. Fixed in 7c55e2b.", "author": "pdurbin", "createdAt": "2020-11-16T16:43:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ0NTI1MQ=="}], "type": "inlineReview", "revised_code": {"commit": "7c55e2bd3700a05486d161871faa14b8a06722ad", "chunk": "diff --git a/src/main/java/edu/harvard/iq/dataverse/api/Pids.java b/src/main/java/edu/harvard/iq/dataverse/api/Pids.java\nindex 1a2b31e1b..dfbb3fb67 100644\n--- a/src/main/java/edu/harvard/iq/dataverse/api/Pids.java\n+++ b/src/main/java/edu/harvard/iq/dataverse/api/Pids.java\n\n@@ -51,8 +52,8 @@ public class Pids extends AbstractApiBean {\n         try {\n             JsonObjectBuilder result = PidUtil.queryDoi(persistentId, baseUrl, username, password);\n             return ok(result);\n-        } catch (Exception ex) {\n-            return error(Response.Status.BAD_REQUEST, ex.getLocalizedMessage());\n+        } catch (WebApplicationException ex) {\n+            return error(ex.getResponse().getStatusInfo().toEnum(), ex.getLocalizedMessage());\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ0NzQ2NA==", "url": "https://github.com/IQSS/dataverse/pull/7410#discussion_r523447464", "bodyText": "This stops the specific error in the issue from resulting in an OK response, but the other exceptions in this class are still being caught and returned as OK. One option for handling these would be to just throw subclasses of WebApplicationException directly from this class (see, for example, the table on this page for the available exceptions. The edu.harvard.iq.dataverse.api.errorhandlers.WebApplicationExceptionHandler will handle them from there. Each type of error has a default message and any InternalServerErrorExceptions get additional logging.\nYou can also just let any Throwable be caught by the ThrowableHandler - which are returned as 500 errors.\nNeither of these let you pass the exception message on to the user though, so you'd still have to catch exceptions for that in Pids.java if you want to include that in the response (but you could still throw the WebApplicationExceptions to also be able to pass the error type/status code.)", "author": "qqmyers", "createdAt": "2020-11-14T18:20:07Z", "path": "src/main/java/edu/harvard/iq/dataverse/pidproviders/PidUtil.java", "diffHunk": "@@ -45,7 +46,7 @@ public static JsonObjectBuilder queryDoi(String persistentId, String baseUrl, St\n             status = connection.getResponseCode();\n         } catch (IOException ex) {\n             // Hostname not in DNS, for example.\n-            return Json.createObjectBuilder().add(\"response\", ex.getLocalizedMessage());\n+            throw new RuntimeException(BundleUtil.getStringFromBundle(\"pids.datacite.errors.noResponseCode\", Arrays.asList(baseUrl)));", "originalCommit": "116379ed5b0e36fede95660e9628183c54dc349c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQxMDY4OQ==", "url": "https://github.com/IQSS/dataverse/pull/7410#discussion_r524410689", "bodyText": "@qqmyers good ideas. How does 7c55e2b look?", "author": "pdurbin", "createdAt": "2020-11-16T16:43:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ0NzQ2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ2MDU0Mg==", "url": "https://github.com/IQSS/dataverse/pull/7410#discussion_r524460542", "bodyText": "That works - a good way to be able to send a custom message with a 500. I made another commit to try and catch/assign status codes to other types of errors that can occur. See what you think/feel free to reject/edit further.", "author": "qqmyers", "createdAt": "2020-11-16T17:51:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ0NzQ2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ2MzM3OQ==", "url": "https://github.com/IQSS/dataverse/pull/7410#discussion_r524463379", "bodyText": "https://github.com/IQSS/dataverse/pull/7410/files?w=1 makes it easier to see the changes since indenting changed overall...", "author": "qqmyers", "createdAt": "2020-11-16T17:55:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ0NzQ2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUzODMxNA==", "url": "https://github.com/IQSS/dataverse/pull/7410#discussion_r524538314", "bodyText": "@qqmyers as of the commit you added I don't think the case of a PID that can't be found makes sense. Below you can see that when a PID exists, you get a nice \"findable\" message but when you add some characters to the end of the PID such that it doesn't exist, you get a message saying \"API endpoint does not exist on this server\" which doesn't make sense:\nbeamish:dataverse pdurbin$ export PID=doi:10.70122/FK2/9BXT5O\nbeamish:dataverse pdurbin$ \nbeamish:dataverse pdurbin$ curl -s -H \"X-Dataverse-key:$API_TOKEN\" $SERVER_URL/api/pids?persistentId=$PID | jq .\n{\n  \"status\": \"OK\",\n  \"data\": {\n    \"id\": \"10.70122/fk2/9bxt5o\",\n    \"state\": \"findable\"\n  }\n}\nbeamish:dataverse pdurbin$ export PID=doi:10.70122/FK2/9BXT5Ozzz\nbeamish:dataverse pdurbin$ \nbeamish:dataverse pdurbin$ curl -s -H \"X-Dataverse-key:$API_TOKEN\" $SERVER_URL/api/pids?persistentId=$PID | jq .\n{\n  \"status\": \"ERROR\",\n  \"code\": 404,\n  \"message\": \"API endpoint does not exist on this server. Please check your code for typos, or consult our API guide at http://guides.dataverse.org.\",\n  \"requestUrl\": \"http://localhost:8080/api/v1/pids?persistentId=doi:10.70122/FK2/9BXT5Ozzz\",\n  \"requestMethod\": \"GET\"\n}\nbeamish:dataverse pdurbin$", "author": "pdurbin", "createdAt": "2020-11-16T20:02:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ0NzQ2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDU2MjUwNw==", "url": "https://github.com/IQSS/dataverse/pull/7410#discussion_r524562507", "bodyText": "Hmm - 404 seems OK, but the message should probably be updated. I'll change it to \"The resource does not exist in this server\". If you have a better idea, go ahead and change it. If you think it needs a custom response, I think the way you did the 500 error would work. (FWIW: See https://stackoverflow.com/questions/9930695/rest-api-404-bad-uri-or-missing-resource for a discussion of best practice. I haven't looked too far beyond that, but it seems reasonable.)", "author": "qqmyers", "createdAt": "2020-11-16T20:48:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ0NzQ2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDU4MDU0Mw==", "url": "https://github.com/IQSS/dataverse/pull/7410#discussion_r524580543", "bodyText": "@qqmyers honestly, I was happier back with my original commit for this pull request (116379e). We should probably have a call because there's a lot to unpack. For now I'll move this out of code review and put both of us on it.", "author": "pdurbin", "createdAt": "2020-11-16T21:06:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ0NzQ2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDYyMjI3MQ==", "url": "https://github.com/IQSS/dataverse/pull/7410#discussion_r524622271", "bodyText": "The main concern I have for the PR is to get all of the possible exceptions that can occur to result in errors rather than OKs. If you want to cover those a different way, I don't have a problem - just thought it would be easier to show code than trying to add comments. In any case, happy to discuss to help resolve things.", "author": "qqmyers", "createdAt": "2020-11-16T21:44:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ0NzQ2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTMyMDI4MQ==", "url": "https://github.com/IQSS/dataverse/pull/7410#discussion_r541320281", "bodyText": "@qqmyers @pdurbin thanks for the discussion here. If you're both around next week can you take a few minutes to catch up and figure out the next steps to keep this moving?", "author": "djbrooke", "createdAt": "2020-12-11T21:38:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ0NzQ2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTMyNzMzMg==", "url": "https://github.com/IQSS/dataverse/pull/7410#discussion_r541327332", "bodyText": "Sure, some of this is process:\n\nPlease don't change my code without asking.\nLet's not change our \"this API doesn't exist\" message for an issue about PIDs. Let's please consider this separately.\n\nSome if it is technical:\n\nIf a PID doesn't exist on the DataCite side, I'm not sure we should return a 404 from the Dataverse side. What we should definitely return is an informative message. My intention with this API is to allow Dataverse admins to get information about the state of the world on the DataCite side without having to use DataCite's API directly.", "author": "pdurbin", "createdAt": "2020-12-11T21:46:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ0NzQ2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTMyOTk0MQ==", "url": "https://github.com/IQSS/dataverse/pull/7410#discussion_r541329941", "bodyText": "Sounds good, happy to join in also if there's some question of scope.", "author": "djbrooke", "createdAt": "2020-12-11T21:49:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ0NzQ2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjE5MjU5NQ==", "url": "https://github.com/IQSS/dataverse/pull/7410#discussion_r552192595", "bodyText": "@qqmyers I know we haven't had a chance to talk yet but I'm putting this back in code review. Maybe you can take a look and ping me on Slack. Apart from merging the latest from develop...\nIn 00cf232 I reverted the change to the \"endpoint doesn't exist\" message. I'm open to revising this message as a separate effort.\nIn c359cbe I'm not exposing more detail to the Dataverse API user that the the 404 is coming from DataCite and that we're merely passing the information along. Here's how it looks:\ncurl -s -H \"X-Dataverse-key:$API_TOKEN\" $SERVER_URL/api/pids?persistentId=$PID -i\nHTTP/1.1 404 Not Found\nServer: Payara Server  5.2020.6 #badassfish\nX-Powered-By: Servlet/4.0 JSP/2.3 (Payara Server  5.2020.6 #badassfish Java/AdoptOpenJDK/1.8)\nAccess-Control-Allow-Origin: *\nAccess-Control-Allow-Methods: PUT, GET, POST, DELETE, OPTIONS\nAccess-Control-Allow-Headers: Content-Type, X-Dataverse-Key\nContent-Type: application/json;charset=UTF-8\nContent-Length: 95\nX-Frame-Options: SAMEORIGIN\n\n{\"status\":\"ERROR\",\"message\":\"404 (NOT FOUND) from DataCite for DOI doi:10.70122/FK2/9BXT5Ozzz\"}", "author": "pdurbin", "createdAt": "2021-01-05T21:02:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ0NzQ2NA=="}], "type": "inlineReview", "revised_code": {"commit": "7c55e2bd3700a05486d161871faa14b8a06722ad", "chunk": "diff --git a/src/main/java/edu/harvard/iq/dataverse/pidproviders/PidUtil.java b/src/main/java/edu/harvard/iq/dataverse/pidproviders/PidUtil.java\nindex 8e7158334..0ab4dd738 100644\n--- a/src/main/java/edu/harvard/iq/dataverse/pidproviders/PidUtil.java\n+++ b/src/main/java/edu/harvard/iq/dataverse/pidproviders/PidUtil.java\n\n@@ -46,7 +48,7 @@ public class PidUtil {\n             status = connection.getResponseCode();\n         } catch (IOException ex) {\n             // Hostname not in DNS, for example.\n-            throw new RuntimeException(BundleUtil.getStringFromBundle(\"pids.datacite.errors.noResponseCode\", Arrays.asList(baseUrl)));\n+            throw new WebApplicationException(BundleUtil.getStringFromBundle(\"pids.datacite.errors.noResponseCode\", Arrays.asList(baseUrl)), Response.Status.INTERNAL_SERVER_ERROR);\n         }\n         if (status != 200) {\n             InputStream errorStream = connection.getErrorStream();\n"}}, {"oid": "7c55e2bd3700a05486d161871faa14b8a06722ad", "url": "https://github.com/IQSS/dataverse/commit/7c55e2bd3700a05486d161871faa14b8a06722ad", "message": "return 500 error instead of 400 (BAD_REQUEST) #7187", "committedDate": "2020-11-16T16:41:29Z", "type": "commit"}, {"oid": "0190cad09a4c3a2ab4dcff2a0858569da2be1424", "url": "https://github.com/IQSS/dataverse/commit/0190cad09a4c3a2ab4dcff2a0858569da2be1424", "message": "Catching/assigning status codes to other errors", "committedDate": "2020-11-16T17:49:45Z", "type": "commit"}, {"oid": "ee4af2a346444b23e67dab878004c562faf7b249", "url": "https://github.com/IQSS/dataverse/commit/ee4af2a346444b23e67dab878004c562faf7b249", "message": "change 404 msg to handle cases where the specific thing doesn't exist", "committedDate": "2020-11-16T20:49:03Z", "type": "commit"}, {"oid": "00cf232c752b5c625a0f03dbe0b1f9fa4f94da2e", "url": "https://github.com/IQSS/dataverse/commit/00cf232c752b5c625a0f03dbe0b1f9fa4f94da2e", "message": "Revert \"change 404 msg to handle cases where the specific thing doesn't exist\"\n\nThis reverts commit ee4af2a346444b23e67dab878004c562faf7b249.\n\nWe've had this message since the beginning and I'm not comfortable\nchanging it without more discussion with the group. It seems out of\nscope for the current effort for the PID API.", "committedDate": "2021-01-05T20:21:01Z", "type": "commit"}, {"oid": "2ef61d4521986d8d11e8ab851afba5106afb3001", "url": "https://github.com/IQSS/dataverse/commit/2ef61d4521986d8d11e8ab851afba5106afb3001", "message": "Merge branch 'develop' into 7187-get-pids #7187", "committedDate": "2021-01-05T20:23:45Z", "type": "commit"}, {"oid": "c359cbe5ff69fed6197cd5b1098f85fe61f1e986", "url": "https://github.com/IQSS/dataverse/commit/c359cbe5ff69fed6197cd5b1098f85fe61f1e986", "message": "expose more detail of 404 from DataCite via API #7187", "committedDate": "2021-01-05T20:56:20Z", "type": "commit"}]}