{"pr_number": 6774, "pr_title": "2734 preserve orig filename", "pr_createdAt": "2020-03-26T19:45:48Z", "pr_url": "https://github.com/IQSS/dataverse/pull/6774", "timeline": [{"oid": "0e376feb18243897c6894fe3850d24921f23c6df", "url": "https://github.com/IQSS/dataverse/commit/0e376feb18243897c6894fe3850d24921f23c6df", "message": "Merge branch 'develop' into 2734-preserve-orig-filename", "committedDate": "2020-03-24T13:53:28Z", "type": "commit"}, {"oid": "10dd0e34cbe446719fa7921609f958bb47b6c7f6", "url": "https://github.com/IQSS/dataverse/commit/10dd0e34cbe446719fa7921609f958bb47b6c7f6", "message": "Merge branch 'develop' into 2734-preserve-orig-filename", "committedDate": "2020-03-25T17:40:05Z", "type": "commit"}, {"oid": "b30dfaf1a4c2113204809894efc1e1e2a6b5c337", "url": "https://github.com/IQSS/dataverse/commit/b30dfaf1a4c2113204809894efc1e1e2a6b5c337", "message": "#2734 add field to table and write to it on ingest", "committedDate": "2020-03-25T20:18:48Z", "type": "commit"}, {"oid": "98d3844fecafaf18efb92b8f93e221fdf363a5b5", "url": "https://github.com/IQSS/dataverse/commit/98d3844fecafaf18efb92b8f93e221fdf363a5b5", "message": "#2734 add originalFileName to json printer", "committedDate": "2020-03-26T15:49:11Z", "type": "commit"}, {"oid": "1ed9ed1b11664f91f8e3005069c36a1174d16e44", "url": "https://github.com/IQSS/dataverse/commit/1ed9ed1b11664f91f8e3005069c36a1174d16e44", "message": "Merge branch 'develop' into 2734-preserve-orig-filename", "committedDate": "2020-03-26T15:49:32Z", "type": "commit"}, {"oid": "07f208b5b2d22c34e2901a6b94c50b5134d7e7d1", "url": "https://github.com/IQSS/dataverse/commit/07f208b5b2d22c34e2901a6b94c50b5134d7e7d1", "message": "#2734 add orig file name to json printer test", "committedDate": "2020-03-26T18:34:21Z", "type": "commit"}, {"oid": "f1ed82082bea9d10eedf917ed3ad941912a24073", "url": "https://github.com/IQSS/dataverse/commit/f1ed82082bea9d10eedf917ed3ad941912a24073", "message": "#2734 remove unused import", "committedDate": "2020-03-26T19:47:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAxNjQ2Mw==", "url": "https://github.com/IQSS/dataverse/pull/6774#discussion_r399016463", "bodyText": "@sekmiller Am I reading this correctly - that if the current filename has no extension (\"foo\"), this code will return \"foo\"? - shouldn't it still return \"foo.<ORIG_EXT>\"?\n(although this shouldn't really happen - since ingested files should always have the \".tab\" extension)\n(also, it looks like we never checked for this \"no extension\" case before. To be really OCD though, if you call .replace(\".tab\", \".dta\") on something exotic like \"datafile.tabular.tab\" will return \"datafile.dtaular.dta\". See my really old code in StoredOriginalFile.java - I use the regex version of replace there: .replaceAll(\".tab$\", \".dta\"), to make sure I'm only replacing the end part.", "author": "landreev", "createdAt": "2020-03-27T03:32:30Z", "path": "src/main/java/edu/harvard/iq/dataverse/DataFile.java", "diffHunk": "@@ -398,6 +399,29 @@ public Long getOriginalFileSize() {\n         }\n         return null;\n     }\n+    \n+    public String getOriginalFileName() {\n+        if (isTabularData()) {\n+            DataTable dataTable = getDataTable();\n+            if (dataTable != null) {\n+                return dataTable.getOriginalFileName() != null ? dataTable.getOriginalFileName()\n+                        : getDerivedOriginalFileName();\n+            }\n+        }\n+        return null;\n+    }\n+\n+    private String getDerivedOriginalFileName() {\n+        FileMetadata fm = getFileMetadata();\n+        String filename = fm.getLabel();\n+        String originalExtension = FileUtil.generateOriginalExtension(getOriginalFileFormat());\n+        String extensionToRemove = StringUtil.substringIncludingLast(filename, \".\");\n+        if (StringUtil.nonEmpty(extensionToRemove)) {\n+            String newFileName = filename.replace(extensionToRemove, originalExtension);\n+            return newFileName;\n+        }", "originalCommit": "f1ed82082bea9d10eedf917ed3ad941912a24073", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI3MzMwOA==", "url": "https://github.com/IQSS/dataverse/pull/6774#discussion_r399273308", "bodyText": "Good points. I will take another pass at this.", "author": "sekmiller", "createdAt": "2020-03-27T13:43:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAxNjQ2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMyNzMwNw==", "url": "https://github.com/IQSS/dataverse/pull/6774#discussion_r399327307", "bodyText": "@landreev I put in your suggestion on using replaceAll and relying on the fact that a tabular file should always end in \".tab \". It occurs to me that any editing of the file label to anything other than foo.tab will break this (including your \"no extension\" case). How worried should we be about this, and any suggestions to code against it?", "author": "sekmiller", "createdAt": "2020-03-27T14:59:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAxNjQ2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQwODc2Ng==", "url": "https://github.com/IQSS/dataverse/pull/6774#discussion_r399408766", "bodyText": "Answered my own question while out for a run: so the replaceAll(\"tab$\" which I put in should fix 100% of the cases. Since we know it won't I can modify the previous \"look for an extension to replace\" code by adding a $ to the replace string so that inadvertent internal instances of the extension are not replaced, and if there's no extension found just append the extension derived from the file type. All of this points out that even after all this we cannot be certain that we're returning anything like the actual original file name.", "author": "sekmiller", "createdAt": "2020-03-27T16:58:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAxNjQ2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "715fd00c1caf9ce9e93e26f9a796e0db4de06574", "chunk": "diff --git a/src/main/java/edu/harvard/iq/dataverse/DataFile.java b/src/main/java/edu/harvard/iq/dataverse/DataFile.java\nindex c0337f4c9..90625d8f2 100644\n--- a/src/main/java/edu/harvard/iq/dataverse/DataFile.java\n+++ b/src/main/java/edu/harvard/iq/dataverse/DataFile.java\n\n@@ -405,23 +405,12 @@ public class DataFile extends DvObject implements Comparable {\n             DataTable dataTable = getDataTable();\n             if (dataTable != null) {\n                 return dataTable.getOriginalFileName() != null ? dataTable.getOriginalFileName()\n-                        : getDerivedOriginalFileName();\n+                        : getFileMetadata().getLabel().replaceAll(\".tab$\", FileUtil.generateOriginalExtension(getOriginalFileFormat()));\n             }\n         }\n         return null;\n     }\n \n-    private String getDerivedOriginalFileName() {\n-        FileMetadata fm = getFileMetadata();\n-        String filename = fm.getLabel();\n-        String originalExtension = FileUtil.generateOriginalExtension(getOriginalFileFormat());\n-        String extensionToRemove = StringUtil.substringIncludingLast(filename, \".\");\n-        if (StringUtil.nonEmpty(extensionToRemove)) {\n-            String newFileName = filename.replace(extensionToRemove, originalExtension);\n-            return newFileName;\n-        }\n-        return filename;\n-    }\n \n     @Override\n     public boolean isAncestorOf( DvObject other ) {\n"}}, {"oid": "715fd00c1caf9ce9e93e26f9a796e0db4de06574", "url": "https://github.com/IQSS/dataverse/commit/715fd00c1caf9ce9e93e26f9a796e0db4de06574", "message": "#2734 streamline original file name replace", "committedDate": "2020-03-27T15:03:21Z", "type": "commit"}, {"oid": "786593eaebad17d1879b2512eecc4bc50e4b9aa4", "url": "https://github.com/IQSS/dataverse/commit/786593eaebad17d1879b2512eecc4bc50e4b9aa4", "message": "#2734 update uningest with new method", "committedDate": "2020-03-27T15:17:18Z", "type": "commit"}, {"oid": "c46851969a839f832589fefb90c3c9aaad2d5b22", "url": "https://github.com/IQSS/dataverse/commit/c46851969a839f832589fefb90c3c9aaad2d5b22", "message": "#2734 update stored original file", "committedDate": "2020-03-27T15:24:20Z", "type": "commit"}, {"oid": "75b21e3bee0ea302ad661600129917e3e8e51702", "url": "https://github.com/IQSS/dataverse/commit/75b21e3bee0ea302ad661600129917e3e8e51702", "message": "#2734 return handling of one-off cases", "committedDate": "2020-03-27T18:01:45Z", "type": "commit"}, {"oid": "d6a7c2aac3ae4f91717f6399b21406a31218fcd2", "url": "https://github.com/IQSS/dataverse/commit/d6a7c2aac3ae4f91717f6399b21406a31218fcd2", "message": "small changes to simplify StoredOriginalFile\n\nsimplifies the logic, removes unused code", "committedDate": "2020-03-27T20:50:35Z", "type": "commit"}, {"oid": "0856d472502b2a540c13ea0b6b7e298575100e43", "url": "https://github.com/IQSS/dataverse/commit/0856d472502b2a540c13ea0b6b7e298575100e43", "message": "Merge branch 'develop' into 2734-preserve-orig-filename", "committedDate": "2020-04-01T21:41:54Z", "type": "commit"}]}