{"pr_number": 7154, "pr_title": "6641 search ui bug", "pr_createdAt": "2020-07-31T19:44:31Z", "pr_url": "https://github.com/IQSS/dataverse/pull/7154", "timeline": [{"oid": "9a6e59e6a466b960a54182639f8b4413fd9569fd", "url": "https://github.com/IQSS/dataverse/commit/9a6e59e6a466b960a54182639f8b4413fd9569fd", "message": "#6641 remove extra search tags", "committedDate": "2020-07-29T19:44:26Z", "type": "commit"}, {"oid": "e560d246c4991563993884c43cc56fd11c3ae112", "url": "https://github.com/IQSS/dataverse/commit/e560d246c4991563993884c43cc56fd11c3ae112", "message": "Merge branch 'develop' into 6641-search-ui-bug", "committedDate": "2020-07-29T19:44:51Z", "type": "commit"}, {"oid": "333af7627e7fd034799f362adc52879f49c772a2", "url": "https://github.com/IQSS/dataverse/commit/333af7627e7fd034799f362adc52879f49c772a2", "message": "Merge branch 'develop' into 6641-search-ui-bug", "committedDate": "2020-07-30T20:41:06Z", "type": "commit"}, {"oid": "35a8e41a0805ee8114591275afca100be5785c4b", "url": "https://github.com/IQSS/dataverse/commit/35a8e41a0805ee8114591275afca100be5785c4b", "message": "#6641 fix doubling up of subtree and filter queries", "committedDate": "2020-07-31T17:44:58Z", "type": "commit"}, {"oid": "12031a6df70772d6cedb8b7a218d9a960c404888", "url": "https://github.com/IQSS/dataverse/commit/12031a6df70772d6cedb8b7a218d9a960c404888", "message": "Merge branch 'develop' into 6641-search-ui-bug", "committedDate": "2020-07-31T17:45:26Z", "type": "commit"}, {"oid": "9005d9b7cd5891cac6b6e0e3f43d04122732dc6a", "url": "https://github.com/IQSS/dataverse/commit/9005d9b7cd5891cac6b6e0e3f43d04122732dc6a", "message": "#6641 convert subDV ids to alias for facet tags", "committedDate": "2020-07-31T19:37:23Z", "type": "commit"}, {"oid": "9b008f700d3f80078ada9a483bf608f8661cc633", "url": "https://github.com/IQSS/dataverse/commit/9b008f700d3f80078ada9a483bf608f8661cc633", "message": "#6641 code formatting", "committedDate": "2020-07-31T19:49:21Z", "type": "commit"}, {"oid": "25bfd0eb98dadfbde975a337697a82b3393838a6", "url": "https://github.com/IQSS/dataverse/commit/25bfd0eb98dadfbde975a337697a82b3393838a6", "message": "Merge branch 'develop' into 6641-search-ui-bug", "committedDate": "2020-08-03T15:24:43Z", "type": "commit"}, {"oid": "366b76ecc45e501c8c9b02104eec24638f68740c", "url": "https://github.com/IQSS/dataverse/commit/366b76ecc45e501c8c9b02104eec24638f68740c", "message": "Merge branch 'develop' into 6641-search-ui-bug", "committedDate": "2020-08-04T14:59:21Z", "type": "commit"}, {"oid": "5b683851caccc1990d1cbb04c14c69c86d4658fc", "url": "https://github.com/IQSS/dataverse/commit/5b683851caccc1990d1cbb04c14c69c86d4658fc", "message": "#6641 don't show type and subtree facets", "committedDate": "2020-08-04T15:46:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTE3MjA0OA==", "url": "https://github.com/IQSS/dataverse/pull/7154#discussion_r465172048", "bodyText": "The lack of curly braces (preferred) or indentation of the code in the \"if\" is confusing.", "author": "pdurbin", "createdAt": "2020-08-04T16:20:14Z", "path": "src/main/java/edu/harvard/iq/dataverse/search/SearchIncludeFragment.java", "diffHunk": "@@ -291,6 +294,7 @@ public void search(boolean onlyDataRelatedToMe) {\n                 /**\n                  * @todo centralize this into SearchServiceBean\n                  */\n+                if (!isfilterQueryAlreadyInMap(filterDownToSubtree))\n                 filterQueriesFinal.add(filterDownToSubtree);", "originalCommit": "5b683851caccc1990d1cbb04c14c69c86d4658fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQ0NTAwMQ==", "url": "https://github.com/IQSS/dataverse/pull/7154#discussion_r466445001", "bodyText": "re-did curly braces here.", "author": "sekmiller", "createdAt": "2020-08-06T14:16:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTE3MjA0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUwMTg2Ng==", "url": "https://github.com/IQSS/dataverse/pull/7154#discussion_r466501866", "bodyText": "I no longer see the confusing \"if\". Thanks.", "author": "pdurbin", "createdAt": "2020-08-06T15:36:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTE3MjA0OA=="}], "type": "inlineReview", "revised_code": {"commit": "96f94af30262b97cededfc1c48c114783f8e17a9", "chunk": "diff --git a/src/main/java/edu/harvard/iq/dataverse/search/SearchIncludeFragment.java b/src/main/java/edu/harvard/iq/dataverse/search/SearchIncludeFragment.java\nindex bee7ef3e0..f5430ae32 100644\n--- a/src/main/java/edu/harvard/iq/dataverse/search/SearchIncludeFragment.java\n+++ b/src/main/java/edu/harvard/iq/dataverse/search/SearchIncludeFragment.java\n\n@@ -294,8 +280,9 @@ public class SearchIncludeFragment implements java.io.Serializable {\n                 /**\n                  * @todo centralize this into SearchServiceBean\n                  */\n-                if (!isfilterQueryAlreadyInMap(filterDownToSubtree))\n-                filterQueriesFinal.add(filterDownToSubtree);\n+                if (!isfilterQueryAlreadyInMap(filterDownToSubtree)){\n+                    filterQueriesFinal.add(filterDownToSubtree);\n+                }\n //                this.dataverseSubtreeContext = dataversePath;\n             } else {\n //                this.dataverseSubtreeContext = \"all\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTE3NDc1OA==", "url": "https://github.com/IQSS/dataverse/pull/7154#discussion_r465174758", "bodyText": "Is this setFilterQueries the crux of the bug? Of #6641? I see some conversation at cbad027#r360054910 about it was switched from filterQueries to filterQueriesFinal in cbad027 (part of pull request #6473). I guess I'm wondering if a one line change to switch it back from filterQueriesFinal to filterQueries would fix it the bug.", "author": "pdurbin", "createdAt": "2020-08-04T16:24:36Z", "path": "src/main/java/edu/harvard/iq/dataverse/search/SearchIncludeFragment.java", "diffHunk": "@@ -475,12 +481,11 @@ public void search(boolean onlyDataRelatedToMe) {\n                     }\n                 }\n             }\n-            \n-\n-            \n+                        \n             dataversePage.setQuery(query);\n             dataversePage.setFacetCategoryList(facetCategoryList);\n-            dataversePage.setFilterQueries(filterQueriesFinal);\n+            dataversePage.setFilterQueries(filterQueriesDisplay);", "originalCommit": "5b683851caccc1990d1cbb04c14c69c86d4658fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTE4NDk0NQ==", "url": "https://github.com/IQSS/dataverse/pull/7154#discussion_r465184945", "bodyText": "A one line fix, of course would be nice (and preferred) though we should make sure we understand why that line was changed in the first place. @sekmiller can you look at this and try to understand? Maybe build a branch with the one line change to see if it fixes it, then we can decide if how to get both issues to work?", "author": "scolapasta", "createdAt": "2020-08-04T16:41:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTE3NDc1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk1MzA3Mg==", "url": "https://github.com/IQSS/dataverse/pull/7154#discussion_r465953072", "bodyText": "More than a one line fix but fairly simple. The addition of the DVobject types and subtree to the list of filter queries was necessary for the fix in #6268. I added a method to the SearchIncludeFragment getTypeFromFilterQuery in order to not render those filter queries in the search-include-fragment (see lines 341-342)", "author": "sekmiller", "createdAt": "2020-08-05T19:27:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTE3NDc1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUwNjQxNw==", "url": "https://github.com/IQSS/dataverse/pull/7154#discussion_r466506417", "bodyText": "I see. I kept wondering why we're adding more code in this pull request when I thought we'd be reverting something. Because the new types were added recently (DvObject and subtree), now we need to hide them, it sounds like.", "author": "pdurbin", "createdAt": "2020-08-06T15:42:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTE3NDc1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUwOTEyOQ==", "url": "https://github.com/IQSS/dataverse/pull/7154#discussion_r466509129", "bodyText": "Right and also during development I noticed that the filter queries were being added multiple times hence the isFilterQueryAlreadyInMap method.", "author": "sekmiller", "createdAt": "2020-08-06T15:46:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTE3NDc1OA=="}], "type": "inlineReview", "revised_code": {"commit": "96f94af30262b97cededfc1c48c114783f8e17a9", "chunk": "diff --git a/src/main/java/edu/harvard/iq/dataverse/search/SearchIncludeFragment.java b/src/main/java/edu/harvard/iq/dataverse/search/SearchIncludeFragment.java\nindex bee7ef3e0..f5430ae32 100644\n--- a/src/main/java/edu/harvard/iq/dataverse/search/SearchIncludeFragment.java\n+++ b/src/main/java/edu/harvard/iq/dataverse/search/SearchIncludeFragment.java\n\n@@ -484,8 +472,7 @@ public class SearchIncludeFragment implements java.io.Serializable {\n                         \n             dataversePage.setQuery(query);\n             dataversePage.setFacetCategoryList(facetCategoryList);\n-            dataversePage.setFilterQueries(filterQueriesDisplay);\n-            \n+            dataversePage.setFilterQueries(filterQueriesFinal);\n             dataversePage.setSearchResultsCount(searchResultsCount);\n             dataversePage.setSelectedTypesString(selectedTypesString);\n             dataversePage.setSortField(sortField);\n"}}, {"oid": "96f94af30262b97cededfc1c48c114783f8e17a9", "url": "https://github.com/IQSS/dataverse/commit/96f94af30262b97cededfc1c48c114783f8e17a9", "message": "#6641 fix facet display and code cleanup", "committedDate": "2020-08-05T19:07:13Z", "type": "commit"}, {"oid": "934889d3786414116f71da54e60930a80c2bcfb8", "url": "https://github.com/IQSS/dataverse/commit/934889d3786414116f71da54e60930a80c2bcfb8", "message": "Merge branch 'develop' into 6641-search-ui-bug", "committedDate": "2020-08-05T19:07:36Z", "type": "commit"}, {"oid": "3d789c1142196ab614297051f575cfe79c1d56d4", "url": "https://github.com/IQSS/dataverse/commit/3d789c1142196ab614297051f575cfe79c1d56d4", "message": "Merge branch 'develop' into 6641-search-ui-bug", "committedDate": "2020-08-06T20:07:52Z", "type": "commit"}, {"oid": "be40d350e26e62febaec09cb2ac36c5331440f51", "url": "https://github.com/IQSS/dataverse/commit/be40d350e26e62febaec09cb2ac36c5331440f51", "message": "Merge branch 'develop' into 6641-search-ui-bug", "committedDate": "2020-08-07T14:47:43Z", "type": "commit"}]}