{"pr_number": 8238, "pr_title": "ISPN-11704 Change from FileSystemBind to Docker Volume in Server Test Suite", "pr_createdAt": "2020-04-23T19:12:40Z", "pr_url": "https://github.com/infinispan/infinispan/pull/8238", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA1NzYzOQ==", "url": "https://github.com/infinispan/infinispan/pull/8238#discussion_r414057639", "bodyText": "@tristantarrant I didn't find a use case for this? Could you please help me on that ?", "author": "diegolovison", "createdAt": "2020-04-23T19:15:56Z", "path": "server/testdriver/core/src/main/java/org/infinispan/server/test/core/ContainerInfinispanServerDriver.java", "diffHunk": "@@ -155,41 +152,10 @@ protected void start(String name, File rootDir, String configurationFile) {\n                .label(\"name\", \"Infinispan Server\")\n                .label(\"version\", Version.getVersion())\n                .label(\"release\", Version.getVersion())\n-               .label(\"architecture\", \"x86_64\")\n-               .user(\"root\");\n+               .label(\"architecture\", \"x86_64\");\n \n          if (!prebuiltImage) {\n-            if (OS.getCurrentOs() != OS.WINDOWS) {\n-               // We need to remap the UID/GID of the jboss user inside the container to the ones of the user outside so that files created on volume mounts have the correct ownership/permissions\n-               String uid = runProcess(\"id\", \"-u\");\n-               String gid = runProcess(\"id\", \"-g\");\n-\n-               builder\n-                     .run(\"/bin/sh\", \"-c\", \"if [ -x \\\"$(command -v usermod)\\\" ]; then usermod -u \" + uid +\" jboss; fi\")\n-                     .run(\"/bin/sh\", \"-c\", \"if [ -x \\\"$(command -v groupmod)\\\" ]; then groupmod -g \" + gid + \" jboss; fi\");\n-            }\n-            builder\n-                  .copy(\"build\", INFINISPAN_SERVER_HOME)\n-                  .run(\"chown\", \"-R\", \"jboss:jboss\", INFINISPAN_SERVER_HOME)\n-                  .user(\"jboss\");\n-         }\n-         // Copy the resources to a location from where they can be added to the image\n-         try {", "originalCommit": "5fe3ffbfba30ccf784e08496add376a0e5023ac0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDUyOTcwOA==", "url": "https://github.com/infinispan/infinispan/pull/8238#discussion_r414529708", "bodyText": "This is needed when using this out-of-tree. It must be kept", "author": "tristantarrant", "createdAt": "2020-04-24T12:15:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA1NzYzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgwNTM3OQ==", "url": "https://github.com/infinispan/infinispan/pull/8238#discussion_r414805379", "bodyText": "What means using this out-of-tree? What should be the test that must fail if we don't have this code?", "author": "diegolovison", "createdAt": "2020-04-24T19:15:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA1NzYzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTc3NzM3OQ==", "url": "https://github.com/infinispan/infinispan/pull/8238#discussion_r415777379", "bodyText": "I have added the code", "author": "diegolovison", "createdAt": "2020-04-27T12:40:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA1NzYzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk4MDcyMg==", "url": "https://github.com/infinispan/infinispan/pull/8238#discussion_r415980722", "bodyText": "Can you please try running your changes with https://github.com/tristantarrant/infinispan-playground-testdriver ?", "author": "tristantarrant", "createdAt": "2020-04-27T16:51:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA1NzYzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjA4OTUyNQ==", "url": "https://github.com/infinispan/infinispan/pull/8238#discussion_r416089525", "bodyText": "I was not able to create a cluster until tristantarrant/infinispan-playground-testdriver#3\nI have fixed ContainerInfinispanServerDriver\nThe main changes were:\n\npublic static final String IMAGE_USER = \"185\";\nbuilder.run(\"usermod -u \" + IMAGE_USER + \" jboss\");\nThe prebuilt image has the user 185, in this case, now we are also setting the user 185", "author": "diegolovison", "createdAt": "2020-04-27T19:29:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA1NzYzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjM1Nzk0Mw==", "url": "https://github.com/infinispan/infinispan/pull/8238#discussion_r416357943", "bodyText": "I'd prefer doing this dynamically as there is no guarantee that the user id will stay constant and might also change depending on upstream/downstream/version/etc", "author": "tristantarrant", "createdAt": "2020-04-28T06:22:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA1NzYzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjU5MzQ1OA==", "url": "https://github.com/infinispan/infinispan/pull/8238#discussion_r416593458", "bodyText": "I have changed the user to 200 and also removed:\nif (!prebuiltImage) {\n  builder.run(\"usermod -u \" + IMAGE_USER + \" jboss\");\n}\n\nIt means that, if we built the image on the fly, will have a user 200\nIf we use a prebuilt image, we are setting the user to 200\nWhen executing chown or chmod with an UID, Linux won't fail. ( This was a surprise for me)\nI have executed the test in https://github.com/tristantarrant/infinispan-playground-testdriver and it passed.", "author": "diegolovison", "createdAt": "2020-04-28T13:01:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA1NzYzOQ=="}], "type": "inlineReview", "revised_code": {"commit": "81c180ebaa80b7439dc7e0f8e8e90cbdaed68ec7", "chunk": "diff --git a/server/testdriver/core/src/main/java/org/infinispan/server/test/core/ContainerInfinispanServerDriver.java b/server/testdriver/core/src/main/java/org/infinispan/server/test/core/ContainerInfinispanServerDriver.java\nindex c20803d9c9..784979fd15 100644\n--- a/server/testdriver/core/src/main/java/org/infinispan/server/test/core/ContainerInfinispanServerDriver.java\n+++ b/server/testdriver/core/src/main/java/org/infinispan/server/test/core/ContainerInfinispanServerDriver.java\n\n@@ -157,6 +162,24 @@ protected void start(String name, File rootDir, String configurationFile) {\n          if (!prebuiltImage) {\n             builder.copy(\"build\", INFINISPAN_SERVER_HOME);\n          }\n+         // Copy the resources to a location from where they can be added to the image\n+         try {\n+            URI overlayUri = ContainerInfinispanServerDriver.class.getResource(\"/overlay\").toURI();\n+            if (\"jar\".equals(overlayUri.getScheme())) {\n+               try (FileSystem fileSystem = FileSystems.newFileSystem(overlayUri, Collections.emptyMap())) {\n+                  Files.walkFileTree(fileSystem.getPath(\"/overlay\"), new CommonsTestingUtil.CopyFileVisitor(tmp, true, f -> {\n+                     f.setExecutable(true, false);\n+                  }));\n+               }\n+            } else {\n+               Files.walkFileTree(Paths.get(overlayUri), new CommonsTestingUtil.CopyFileVisitor(tmp, true, f -> {\n+                  f.setExecutable(true, false);\n+               }));\n+            }\n+\n+         } catch (Exception e) {\n+            throw new RuntimeException(e);\n+         }\n \n          builder.copy(\"test\", INFINISPAN_SERVER_HOME + \"/server\")\n                .copy(\"tmp\", INFINISPAN_SERVER_HOME)\n"}}, {"oid": "f1f52ea72c28a9abbf8199fa05f4580ce4927a13", "url": "https://github.com/infinispan/infinispan/commit/f1f52ea72c28a9abbf8199fa05f4580ce4927a13", "message": "ISPN-11704 Change from FileSystemBind to Docker Volume in Server Test Suite", "committedDate": "2020-04-24T01:34:23Z", "type": "forcePushed"}, {"oid": "25cf949382118e78876ed7e57530ac41351c5dff", "url": "https://github.com/infinispan/infinispan/commit/25cf949382118e78876ed7e57530ac41351c5dff", "message": "ISPN-11704 Change from FileSystemBind to Docker Volume in Server Test Suite", "committedDate": "2020-04-24T10:46:02Z", "type": "forcePushed"}, {"oid": "00233f33412ffa4723be2344ab3533852601d316", "url": "https://github.com/infinispan/infinispan/commit/00233f33412ffa4723be2344ab3533852601d316", "message": "ISPN-11704 Change from FileSystemBind to Docker Volume in Server Test Suite", "committedDate": "2020-04-24T13:41:32Z", "type": "forcePushed"}, {"oid": "7652bac214a122e05ce37c7ccd36aa2165200780", "url": "https://github.com/infinispan/infinispan/commit/7652bac214a122e05ce37c7ccd36aa2165200780", "message": "ISPN-11704 Change from FileSystemBind to Docker Volume in Server Test Suite", "committedDate": "2020-04-24T18:05:36Z", "type": "forcePushed"}, {"oid": "81c180ebaa80b7439dc7e0f8e8e90cbdaed68ec7", "url": "https://github.com/infinispan/infinispan/commit/81c180ebaa80b7439dc7e0f8e8e90cbdaed68ec7", "message": "ISPN-11704 Change from FileSystemBind to Docker Volume in Server Test Suite", "committedDate": "2020-04-24T20:02:58Z", "type": "forcePushed"}, {"oid": "9729f7897f889ed58be77dc9ffbfc7b75fc8c3b3", "url": "https://github.com/infinispan/infinispan/commit/9729f7897f889ed58be77dc9ffbfc7b75fc8c3b3", "message": "ISPN-11704 Change from FileSystemBind to Docker Volume in Server Test Suite", "committedDate": "2020-04-24T21:19:27Z", "type": "forcePushed"}, {"oid": "b8954e14e9fa363334d1527b13799602113fe36a", "url": "https://github.com/infinispan/infinispan/commit/b8954e14e9fa363334d1527b13799602113fe36a", "message": "ISPN-11704 Change from FileSystemBind to Docker Volume in Server Test Suite", "committedDate": "2020-04-27T19:29:16Z", "type": "forcePushed"}, {"oid": "84741d335ddfa990d5063cc92b0bfe52a674721f", "url": "https://github.com/infinispan/infinispan/commit/84741d335ddfa990d5063cc92b0bfe52a674721f", "message": "ISPN-11704 Change from FileSystemBind to Docker Volume in Server Test Suite", "committedDate": "2020-04-27T19:36:07Z", "type": "forcePushed"}, {"oid": "c8959c520ae951e751dfa2aa441c5432c573d637", "url": "https://github.com/infinispan/infinispan/commit/c8959c520ae951e751dfa2aa441c5432c573d637", "message": "ISPN-11704 Change from FileSystemBind to Docker Volume in Server Test Suite", "committedDate": "2020-04-28T11:37:42Z", "type": "commit"}, {"oid": "c8959c520ae951e751dfa2aa441c5432c573d637", "url": "https://github.com/infinispan/infinispan/commit/c8959c520ae951e751dfa2aa441c5432c573d637", "message": "ISPN-11704 Change from FileSystemBind to Docker Volume in Server Test Suite", "committedDate": "2020-04-28T11:37:42Z", "type": "forcePushed"}]}