{"pr_number": 8517, "pr_title": "ISPN-12065 Add the anchored-keys module to the server", "pr_createdAt": "2020-06-30T09:48:26Z", "pr_url": "https://github.com/infinispan/infinispan/pull/8517", "timeline": [{"oid": "49d84207668adc86aa83c1077bc31c0b5f843b45", "url": "https://github.com/infinispan/infinispan/commit/49d84207668adc86aa83c1077bc31c0b5f843b45", "message": "ISPN-12065 Add the anchored-keys module to the server\n\n- infinispan-anchored-keys added to bom\n- AnchoredKeysIT added", "committedDate": "2020-06-30T14:30:39Z", "type": "commit"}, {"oid": "9a3b8d2ae9b7ba62cea9e120cfd4c485a7cf8387", "url": "https://github.com/infinispan/infinispan/commit/9a3b8d2ae9b7ba62cea9e120cfd4c485a7cf8387", "message": "ISPN-12065 Add org.infinispan.feature.anchored-keys feature flag", "committedDate": "2020-06-30T14:30:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzczNzYyOQ==", "url": "https://github.com/infinispan/infinispan/pull/8517#discussion_r447737629", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  Features features = new Features(classLoader);\n          \n          \n            \n                  Features features = globalConfiguration.features();", "author": "pruivo", "createdAt": "2020-06-30T14:41:04Z", "path": "anchored-keys/src/main/java/org/infinispan/anchored/AnchoredKeysModuleLifecycle.java", "diffHunk": "@@ -43,14 +49,19 @@ public void cacheManagerStarting(GlobalComponentRegistry gcr, GlobalConfiguratio\n \n    @Override\n    public void cacheStarting(ComponentRegistry cr, Configuration configuration, String cacheName) {\n-      AnchoredKeysConfiguration anchoredKeysConfiguration =\n-            configuration.module(AnchoredKeysConfiguration.class);\n+      AnchoredKeysConfiguration anchoredKeysConfiguration = configuration.module(AnchoredKeysConfiguration.class);\n       if (anchoredKeysConfiguration == null || !anchoredKeysConfiguration.enabled())\n          return;\n \n       assert configuration.clustering().cacheMode().isReplicated();\n       assert !configuration.clustering().stateTransfer().awaitInitialTransfer();\n \n+      ClassLoader classLoader = cr.getGlobalComponentRegistry().getGlobalConfiguration().classLoader();\n+      Features features = new Features(classLoader);", "originalCommit": "9a3b8d2ae9b7ba62cea9e120cfd4c485a7cf8387", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc1ODg5NQ==", "url": "https://github.com/infinispan/infinispan/pull/8517#discussion_r447758895", "bodyText": "\ud83d\udc4d I didn't know about that method", "author": "ryanemerson", "createdAt": "2020-06-30T15:08:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzczNzYyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "b3c3332a24e1a476237a4ebb0e358dbe0024f6fe", "chunk": "diff --git a/anchored-keys/src/main/java/org/infinispan/anchored/AnchoredKeysModuleLifecycle.java b/anchored-keys/src/main/java/org/infinispan/anchored/AnchoredKeysModuleLifecycle.java\nindex d8713a5865..8b076cdf7a 100644\n--- a/anchored-keys/src/main/java/org/infinispan/anchored/AnchoredKeysModuleLifecycle.java\n+++ b/anchored-keys/src/main/java/org/infinispan/anchored/AnchoredKeysModuleLifecycle.java\n\n@@ -43,7 +39,6 @@ public void registerDynamicMetadata(ModuleMetadataBuilder.ModuleBuilder moduleBu\n \n    @Override\n    public void cacheManagerStarting(GlobalComponentRegistry gcr, GlobalConfiguration globalConfiguration) {\n-      this.gcr = gcr;\n       this.globalConfiguration = globalConfiguration;\n    }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzczNzk2MA==", "url": "https://github.com/infinispan/infinispan/pull/8517#discussion_r447737960", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                     throw LogFactory.getLog(MethodHandles.lookup().lookupClass()).featureDisabled(ANCHORED_KEYS_FEATURE);\n          \n          \n            \n                     throw Log.CONFIG.featureDisabled(ANCHORED_KEYS_FEATURE);", "author": "pruivo", "createdAt": "2020-06-30T14:41:30Z", "path": "anchored-keys/src/main/java/org/infinispan/anchored/AnchoredKeysModuleLifecycle.java", "diffHunk": "@@ -43,14 +49,19 @@ public void cacheManagerStarting(GlobalComponentRegistry gcr, GlobalConfiguratio\n \n    @Override\n    public void cacheStarting(ComponentRegistry cr, Configuration configuration, String cacheName) {\n-      AnchoredKeysConfiguration anchoredKeysConfiguration =\n-            configuration.module(AnchoredKeysConfiguration.class);\n+      AnchoredKeysConfiguration anchoredKeysConfiguration = configuration.module(AnchoredKeysConfiguration.class);\n       if (anchoredKeysConfiguration == null || !anchoredKeysConfiguration.enabled())\n          return;\n \n       assert configuration.clustering().cacheMode().isReplicated();\n       assert !configuration.clustering().stateTransfer().awaitInitialTransfer();\n \n+      ClassLoader classLoader = cr.getGlobalComponentRegistry().getGlobalConfiguration().classLoader();\n+      Features features = new Features(classLoader);\n+      if (!features.isAvailable(ANCHORED_KEYS_FEATURE)) {\n+         throw LogFactory.getLog(MethodHandles.lookup().lookupClass()).featureDisabled(ANCHORED_KEYS_FEATURE);", "originalCommit": "9a3b8d2ae9b7ba62cea9e120cfd4c485a7cf8387", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzczOTI2Nw==", "url": "https://github.com/infinispan/infinispan/pull/8517#discussion_r447739267", "bodyText": "ps. method in commons logging: org.infinispan.commons.logging.Log;", "author": "pruivo", "createdAt": "2020-06-30T14:43:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzczNzk2MA=="}], "type": "inlineReview", "revised_code": {"commit": "b3c3332a24e1a476237a4ebb0e358dbe0024f6fe", "chunk": "diff --git a/anchored-keys/src/main/java/org/infinispan/anchored/AnchoredKeysModuleLifecycle.java b/anchored-keys/src/main/java/org/infinispan/anchored/AnchoredKeysModuleLifecycle.java\nindex d8713a5865..8b076cdf7a 100644\n--- a/anchored-keys/src/main/java/org/infinispan/anchored/AnchoredKeysModuleLifecycle.java\n+++ b/anchored-keys/src/main/java/org/infinispan/anchored/AnchoredKeysModuleLifecycle.java\n\n@@ -43,7 +39,6 @@ public void registerDynamicMetadata(ModuleMetadataBuilder.ModuleBuilder moduleBu\n \n    @Override\n    public void cacheManagerStarting(GlobalComponentRegistry gcr, GlobalConfiguration globalConfiguration) {\n-      this.gcr = gcr;\n       this.globalConfiguration = globalConfiguration;\n    }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzczODgwMQ==", "url": "https://github.com/infinispan/infinispan/pull/8517#discussion_r447738801", "bodyText": "nitpick/offtopic: unused. just remove it.", "author": "pruivo", "createdAt": "2020-06-30T14:42:39Z", "path": "anchored-keys/src/main/java/org/infinispan/anchored/AnchoredKeysModuleLifecycle.java", "diffHunk": "@@ -28,6 +32,8 @@\n @InfinispanModule(name = \"anchored-keys\", requiredModules = \"core\")\n public final class AnchoredKeysModuleLifecycle implements ModuleLifecycle, DynamicModuleMetadataProvider {\n \n+   public static final String ANCHORED_KEYS_FEATURE = \"anchored-keys\";\n+\n    private GlobalComponentRegistry gcr;", "originalCommit": "9a3b8d2ae9b7ba62cea9e120cfd4c485a7cf8387", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b3c3332a24e1a476237a4ebb0e358dbe0024f6fe", "chunk": "diff --git a/anchored-keys/src/main/java/org/infinispan/anchored/AnchoredKeysModuleLifecycle.java b/anchored-keys/src/main/java/org/infinispan/anchored/AnchoredKeysModuleLifecycle.java\nindex d8713a5865..8b076cdf7a 100644\n--- a/anchored-keys/src/main/java/org/infinispan/anchored/AnchoredKeysModuleLifecycle.java\n+++ b/anchored-keys/src/main/java/org/infinispan/anchored/AnchoredKeysModuleLifecycle.java\n\n@@ -34,7 +31,6 @@\n \n    public static final String ANCHORED_KEYS_FEATURE = \"anchored-keys\";\n \n-   private GlobalComponentRegistry gcr;\n    private GlobalConfiguration globalConfiguration;\n \n    @Override\n"}}, {"oid": "b3c3332a24e1a476237a4ebb0e358dbe0024f6fe", "url": "https://github.com/infinispan/infinispan/commit/b3c3332a24e1a476237a4ebb0e358dbe0024f6fe", "message": "ISPN-12065 Add org.infinispan.feature.anchored-keys feature flag", "committedDate": "2020-06-30T15:14:21Z", "type": "commit"}, {"oid": "b3c3332a24e1a476237a4ebb0e358dbe0024f6fe", "url": "https://github.com/infinispan/infinispan/commit/b3c3332a24e1a476237a4ebb0e358dbe0024f6fe", "message": "ISPN-12065 Add org.infinispan.feature.anchored-keys feature flag", "committedDate": "2020-06-30T15:14:21Z", "type": "forcePushed"}]}