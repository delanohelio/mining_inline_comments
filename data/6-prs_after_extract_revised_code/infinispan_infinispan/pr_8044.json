{"pr_number": 8044, "pr_title": "ISPN-11459 NullPointerException installing continuous query listener on joiner", "pr_createdAt": "2020-03-12T09:08:42Z", "pr_url": "https://github.com/infinispan/infinispan/pull/8044", "timeline": [{"oid": "e2c0e73da4c608a81f79745dd6bf532612e6c5d5", "url": "https://github.com/infinispan/infinispan/commit/e2c0e73da4c608a81f79745dd6bf532612e6c5d5", "message": "ISPN-11459 NullPointerException installing continuous query listener on joiner", "committedDate": "2020-03-12T13:19:03Z", "type": "forcePushed"}, {"oid": "36cd6a7e3c154fef82ced3bc1d695fc71cf37adc", "url": "https://github.com/infinispan/infinispan/commit/36cd6a7e3c154fef82ced3bc1d695fc71cf37adc", "message": "ISPN-11459 NullPointerException installing continuous query listener on joiner", "committedDate": "2020-03-12T13:42:49Z", "type": "forcePushed"}, {"oid": "6feafe6a56de720f4ab4d7876c833333f86e9b08", "url": "https://github.com/infinispan/infinispan/commit/6feafe6a56de720f4ab4d7876c833333f86e9b08", "message": "ISPN-11459 NullPointerException installing continuous query listener on joiner", "committedDate": "2020-03-12T22:22:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQ0MDMyMg==", "url": "https://github.com/infinispan/infinispan/pull/8044#discussion_r392440322", "bodyText": "Why change ?", "author": "wburns", "createdAt": "2020-03-13T19:59:52Z", "path": "query/src/test/java/org/infinispan/query/continuous/AbstractCQMultipleCachesTest.java", "diffHunk": "@@ -133,8 +133,9 @@ public void testCQCacheLeavesAndJoins() {\n          value.setName(\"John\");\n          value.setAge(i + 25);\n          cache(0).put(i, value);\n-         if (i == 4)\n+         if (i == 2) {", "originalCommit": "6feafe6a56de720f4ab4d7876c833333f86e9b08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDk2MTE3OA==", "url": "https://github.com/infinispan/infinispan/pull/8044#discussion_r394961178", "bodyText": "It's so that more entries are affected by the join, with i == 4 all but one entry were received by the listener before the kill/join.", "author": "danberindei", "createdAt": "2020-03-19T11:33:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQ0MDMyMg=="}], "type": "inlineReview", "revised_code": {"commit": "a320312015911df3362393124933e2b39736739d", "chunk": "diff --git a/query/src/test/java/org/infinispan/query/continuous/AbstractCQMultipleCachesTest.java b/query/src/test/java/org/infinispan/query/continuous/AbstractCQMultipleCachesTest.java\nindex 1e2e71ea5c..171a81eaf5 100644\n--- a/query/src/test/java/org/infinispan/query/continuous/AbstractCQMultipleCachesTest.java\n+++ b/query/src/test/java/org/infinispan/query/continuous/AbstractCQMultipleCachesTest.java\n\n@@ -134,6 +134,8 @@ public void testCQCacheLeavesAndJoins() {\n          value.setAge(i + 25);\n          cache(0).put(i, value);\n          if (i == 2) {\n+            // The listener matches entries with age <= 30\n+            // It will receive entries 0..2 before the node is killed, and entries 3..5 after\n             killMember(1);\n          }\n       }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzExMDI0OQ==", "url": "https://github.com/infinispan/infinispan/pull/8044#discussion_r393110249", "bodyText": "I must admit this looks wrong to me until I look at rethrowException. It makes me think it should be a non null exception.", "author": "wburns", "createdAt": "2020-03-16T15:29:13Z", "path": "core/src/main/java/org/infinispan/notifications/cachelistener/CacheNotifierImpl.java", "diffHunk": "@@ -1467,15 +1414,37 @@ private boolean isClusterListenerAvailable(CacheMode mode) {\n                log.tracef(\"Listener %s initial state for cache completed\", generatedId);\n             }\n \n-            if (t != null) {\n-               CompletableFutures.rethrowException(t);\n-            }\n+            CompletableFutures.rethrowException(t);", "originalCommit": "6feafe6a56de720f4ab4d7876c833333f86e9b08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDk2MjU4Ng==", "url": "https://github.com/infinispan/infinispan/pull/8044#discussion_r394962586", "bodyText": "Maybe the name could be better, but throwing the exception only if present is the whole point.\nIf we do the null check outside, then throw CompletableFutures.asCompletionException(t) is even clearer and just a few characters more.", "author": "danberindei", "createdAt": "2020-03-19T11:36:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzExMDI0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDk3MjIyMg==", "url": "https://github.com/infinispan/infinispan/pull/8044#discussion_r394972222", "bodyText": "I renamed the method to rethrowExceptionIfPresent, it's not in a @public package so I didn't keep the old version.", "author": "danberindei", "createdAt": "2020-03-19T11:55:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzExMDI0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTAwNzcwOA==", "url": "https://github.com/infinispan/infinispan/pull/8044#discussion_r395007708", "bodyText": "Sounds good.", "author": "wburns", "createdAt": "2020-03-19T13:02:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzExMDI0OQ=="}], "type": "inlineReview", "revised_code": {"commit": "8f035e62686a2316f1dfe373b4a69a46f8a33bc7", "chunk": "diff --git a/core/src/main/java/org/infinispan/notifications/cachelistener/CacheNotifierImpl.java b/core/src/main/java/org/infinispan/notifications/cachelistener/CacheNotifierImpl.java\nindex c2dd6bdc6f..b6d4d08f7a 100644\n--- a/core/src/main/java/org/infinispan/notifications/cachelistener/CacheNotifierImpl.java\n+++ b/core/src/main/java/org/infinispan/notifications/cachelistener/CacheNotifierImpl.java\n\n@@ -1414,7 +1412,7 @@ private boolean isClusterListenerAvailable(CacheMode mode) {\n                log.tracef(\"Listener %s initial state for cache completed\", generatedId);\n             }\n \n-            CompletableFutures.rethrowException(t);\n+            CompletableFutures.rethrowExceptionIfPresent(t);\n          });\n       }\n \n"}}, {"oid": "a320312015911df3362393124933e2b39736739d", "url": "https://github.com/infinispan/infinispan/commit/a320312015911df3362393124933e2b39736739d", "message": "ISPN-11459 NullPointerException installing continuous query listener on joiner", "committedDate": "2020-03-19T11:31:45Z", "type": "commit"}, {"oid": "a320312015911df3362393124933e2b39736739d", "url": "https://github.com/infinispan/infinispan/commit/a320312015911df3362393124933e2b39736739d", "message": "ISPN-11459 NullPointerException installing continuous query listener on joiner", "committedDate": "2020-03-19T11:31:45Z", "type": "forcePushed"}, {"oid": "8f035e62686a2316f1dfe373b4a69a46f8a33bc7", "url": "https://github.com/infinispan/infinispan/commit/8f035e62686a2316f1dfe373b4a69a46f8a33bc7", "message": "ISPN-11459 Rename rethrowException to rethrowExceptionIfPresent", "committedDate": "2020-03-19T11:52:04Z", "type": "commit"}]}