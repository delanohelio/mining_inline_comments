{"pr_number": 8312, "pr_title": "ISPN-11819 Prevent ContainerInfinispanServerDriver erroneous state with provided server directory", "pr_createdAt": "2020-05-12T17:50:49Z", "pr_url": "https://github.com/infinispan/infinispan/pull/8312", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTc2MzIzNA==", "url": "https://github.com/infinispan/infinispan/pull/8312#discussion_r425763234", "bodyText": "We can replace this method with a call to org.infinispan.commons.Util#recursiveFileRemove", "author": "ryanemerson", "createdAt": "2020-05-15T12:20:53Z", "path": "server/testdriver/core/src/main/java/org/infinispan/server/test/core/ContainerInfinispanServerDriver.java", "diffHunk": "@@ -230,6 +230,32 @@ private void configureSite(List<String> args) {\n       args.add(\"-Djgroups.cluster.mcast_port=\" + configuration.siteDiscoveryPort());\n    }\n \n+   /*\n+    * Once you built the server, you can try to start it and it will create files under the data directory.\n+    * Later, you decided to run some tests and it will take ages to find out that the tests are broken because there\n+    * are files under the data directory.\n+    */\n+   private Path validateServerOutput(Path serverOutputPath) {", "originalCommit": "7e2569148ebe21f53fd744109de7bea0488bfca1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9b82b1e4602bf8d6004d0f1fc6099dc3178be58f", "chunk": "diff --git a/server/testdriver/core/src/main/java/org/infinispan/server/test/core/ContainerInfinispanServerDriver.java b/server/testdriver/core/src/main/java/org/infinispan/server/test/core/ContainerInfinispanServerDriver.java\nindex 0ea35047dc..b58f56f67f 100644\n--- a/server/testdriver/core/src/main/java/org/infinispan/server/test/core/ContainerInfinispanServerDriver.java\n+++ b/server/testdriver/core/src/main/java/org/infinispan/server/test/core/ContainerInfinispanServerDriver.java\n\n@@ -231,28 +232,12 @@ private void configureSite(List<String> args) {\n    }\n \n    /*\n-    * Once you built the server, you can try to start it and it will create files under the data directory.\n-    * Later, you decided to run some tests and it will take ages to find out that the tests are broken because there\n-    * are files under the data directory.\n+    * Removing the `server/data` and `server/log` directories from the local server directory to prevent issues with\n+    * the tests\n     */\n-   private Path validateServerOutput(Path serverOutputPath) {\n-      File serverFolder = new File(serverOutputPath.toFile(), \"server\");\n-      if (serverFolder.exists()) {\n-         File dataFoler = new File(serverFolder, \"data\");\n-         if (dataFoler.exists()) {\n-            File[] files = dataFoler.listFiles();\n-            if (files.length > 0) {\n-               throw new IllegalStateException(\"The data directory must be empty.\");\n-            }\n-         }\n-         File logFolder = new File(serverFolder, \"log\");\n-         if (logFolder.exists()) {\n-            File[] files = dataFoler.listFiles();\n-            if (files.length > 0) {\n-               throw new IllegalStateException(\"Clean the log directory.\");\n-            }\n-         }\n-      }\n+   private Path cleanServerDirectory(Path serverOutputPath) {\n+      Util.recursiveFileRemove(serverOutputPath.resolve(\"server\").resolve(\"data\").toString());\n+      Util.recursiveFileRemove(serverOutputPath.resolve(\"server\").resolve(\"log\").toString());\n       return serverOutputPath;\n    }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTc2NTU1Mw==", "url": "https://github.com/infinispan/infinispan/pull/8312#discussion_r425765553", "bodyText": "We should cleanup the directories before the call to image and we should add a comment explaining why the delete is necessary:\n// Removing the `server/data` and `server/log` directories from the local server directory to prevent issues with the tests\nUtil.recursiveFileRemove(serverOutputPath.resolve(\"server\").resolve(\"data\").toString());\nUtil.recursiveFileRemove(serverOutputPath.resolve(\"server\").resolve(\"log\").toString());", "author": "ryanemerson", "createdAt": "2020-05-15T12:25:26Z", "path": "server/testdriver/core/src/main/java/org/infinispan/server/test/core/ContainerInfinispanServerDriver.java", "diffHunk": "@@ -139,7 +139,7 @@ protected void start(String name, File rootDir, String configurationFile) {\n             image\n                   .withFileFromPath(\"target\", serverOutputPath.getParent())\n                   .withFileFromPath(\"src\", serverOutputPath.getParent().getParent().resolve(\"src\"))\n-                  .withFileFromPath(\"build\", serverOutputPath);\n+                  .withFileFromPath(\"build\", validateServerOutput(serverOutputPath));", "originalCommit": "7e2569148ebe21f53fd744109de7bea0488bfca1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9b82b1e4602bf8d6004d0f1fc6099dc3178be58f", "chunk": "diff --git a/server/testdriver/core/src/main/java/org/infinispan/server/test/core/ContainerInfinispanServerDriver.java b/server/testdriver/core/src/main/java/org/infinispan/server/test/core/ContainerInfinispanServerDriver.java\nindex 0ea35047dc..b58f56f67f 100644\n--- a/server/testdriver/core/src/main/java/org/infinispan/server/test/core/ContainerInfinispanServerDriver.java\n+++ b/server/testdriver/core/src/main/java/org/infinispan/server/test/core/ContainerInfinispanServerDriver.java\n\n@@ -139,7 +140,7 @@ protected void start(String name, File rootDir, String configurationFile) {\n             image\n                   .withFileFromPath(\"target\", serverOutputPath.getParent())\n                   .withFileFromPath(\"src\", serverOutputPath.getParent().getParent().resolve(\"src\"))\n-                  .withFileFromPath(\"build\", validateServerOutput(serverOutputPath));\n+                  .withFileFromPath(\"build\", cleanServerDirectory(serverOutputPath));\n             prebuiltImage = false;\n             log.infof(\"Using local image from server built at '%s'\", serverOutputPath);\n          }\n"}}, {"oid": "9b82b1e4602bf8d6004d0f1fc6099dc3178be58f", "url": "https://github.com/infinispan/infinispan/commit/9b82b1e4602bf8d6004d0f1fc6099dc3178be58f", "message": "ISPN-11819 Prevent ContainerInfinispanServerDriver erroneous state with provided server directory", "committedDate": "2020-05-18T12:03:13Z", "type": "commit"}, {"oid": "9b82b1e4602bf8d6004d0f1fc6099dc3178be58f", "url": "https://github.com/infinispan/infinispan/commit/9b82b1e4602bf8d6004d0f1fc6099dc3178be58f", "message": "ISPN-11819 Prevent ContainerInfinispanServerDriver erroneous state with provided server directory", "committedDate": "2020-05-18T12:03:13Z", "type": "forcePushed"}]}