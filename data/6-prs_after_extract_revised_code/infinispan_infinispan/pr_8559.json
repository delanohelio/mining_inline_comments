{"pr_number": 8559, "pr_title": "ISPN-11304 Add anchored keys documentation in developer guide", "pr_createdAt": "2020-07-16T18:10:45Z", "pr_url": "https://github.com/infinispan/infinispan/pull/8559", "timeline": [{"oid": "6b2b974855bb35d7c31f786a2ef0e468ff08a3a0", "url": "https://github.com/infinispan/infinispan/commit/6b2b974855bb35d7c31f786a2ef0e468ff08a3a0", "message": "ISPN-11304 Add anchored keys documentation in developer guide", "committedDate": "2020-07-21T16:39:44Z", "type": "forcePushed"}, {"oid": "690974e8e80b4081f2d2a963330c8f72cb4983fc", "url": "https://github.com/infinispan/infinispan/commit/690974e8e80b4081f2d2a963330c8f72cb4983fc", "message": "ISPN-11304 Add anchored keys documentation in developer guide", "committedDate": "2020-07-21T21:14:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTMyNzc0NQ==", "url": "https://github.com/infinispan/infinispan/pull/8559#discussion_r459327745", "bodyText": "These should be i18n logs.", "author": "ryanemerson", "createdAt": "2020-07-23T09:35:45Z", "path": "anchored-keys/src/main/java/org/infinispan/anchored/configuration/AnchoredKeysConfigurationBuilder.java", "diffHunk": "@@ -42,12 +50,46 @@ public void validate() {\n       if (!rootBuilder.clustering().cacheMode().isReplicated()) {\n          throw new CacheConfigurationException(\"Anchored keys requires cache to be in replication mode\");\n       }\n-      if (rootBuilder.transaction().transactionMode() != null && rootBuilder.transaction().transactionMode().isTransactional()) {\n+      if (rootBuilder.transaction().transactionMode() != null &&\n+          rootBuilder.transaction().transactionMode().isTransactional()) {\n          throw new CacheConfigurationException(\"Anchored keys do not support transactions\");\n       }\n+      Attribute<Boolean> stateTransferEnabledAttribute =\n+            rootBuilder.clustering().stateTransfer().attributes()\n+                       .attribute(StateTransferConfiguration.FETCH_IN_MEMORY_STATE);\n+      if (!stateTransferEnabledAttribute.get()) {\n+         throw new CacheConfigurationException(\"Anchored keys caches must have state transfer enabled\");\n+      }\n \n-      // TODO Maybe just assert that awaitInitialTransfer is disabled instead?\n+      Attribute<Boolean> awaitStateTransferAttribute =\n+            rootBuilder.clustering().stateTransfer().attributes()\n+                       .attribute(StateTransferConfiguration.AWAIT_INITIAL_TRANSFER);\n+      if (awaitStateTransferAttribute.get() && awaitStateTransferAttribute.isModified()) {\n+         throw new CacheConfigurationException(\n+               \"Anchored keys do not support awaiting for state transfer when starting a cache, please remove the \" +\n+               \"await-initial-transfer attribute from your configuration\");\n+      }\n       rootBuilder.clustering().stateTransfer().awaitInitialTransfer(false);\n+\n+      Attribute<PartitionHandling> whenSplitAttribute =\n+            rootBuilder.clustering().partitionHandling().attributes()\n+                       .attribute(PartitionHandlingConfiguration.WHEN_SPLIT);\n+      if (whenSplitAttribute.get() != PartitionHandling.ALLOW_READ_WRITES && whenSplitAttribute.isModified()) {\n+         throw new CacheConfigurationException(\n+               \"Anchored keys only support partition handling mode ALLOW_READ_WRITES, please remove the when-split \" +\n+               \"attribute from your configuration\");\n+      }\n+      rootBuilder.clustering().partitionHandling().whenSplit(PartitionHandling.ALLOW_READ_WRITES);\n+\n+      Attribute<EntryMergePolicy> mergePolicyAttribute =\n+            rootBuilder.clustering().partitionHandling().attributes()\n+                       .attribute(PartitionHandlingConfiguration.MERGE_POLICY);\n+      if (mergePolicyAttribute.get() != MergePolicy.PREFERRED_NON_NULL && mergePolicyAttribute.isModified()) {\n+         throw new CacheConfigurationException(", "originalCommit": "690974e8e80b4081f2d2a963330c8f72cb4983fc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3527611ad96c6d87928e269838133412e337250f", "chunk": "diff --git a/anchored-keys/src/main/java/org/infinispan/anchored/configuration/AnchoredKeysConfigurationBuilder.java b/anchored-keys/src/main/java/org/infinispan/anchored/configuration/AnchoredKeysConfigurationBuilder.java\nindex 40d04caf85..840b9e4e38 100644\n--- a/anchored-keys/src/main/java/org/infinispan/anchored/configuration/AnchoredKeysConfigurationBuilder.java\n+++ b/anchored-keys/src/main/java/org/infinispan/anchored/configuration/AnchoredKeysConfigurationBuilder.java\n\n@@ -50,46 +42,12 @@ public void validate() {\n       if (!rootBuilder.clustering().cacheMode().isReplicated()) {\n          throw new CacheConfigurationException(\"Anchored keys requires cache to be in replication mode\");\n       }\n-      if (rootBuilder.transaction().transactionMode() != null &&\n-          rootBuilder.transaction().transactionMode().isTransactional()) {\n+      if (rootBuilder.transaction().transactionMode() != null && rootBuilder.transaction().transactionMode().isTransactional()) {\n          throw new CacheConfigurationException(\"Anchored keys do not support transactions\");\n       }\n-      Attribute<Boolean> stateTransferEnabledAttribute =\n-            rootBuilder.clustering().stateTransfer().attributes()\n-                       .attribute(StateTransferConfiguration.FETCH_IN_MEMORY_STATE);\n-      if (!stateTransferEnabledAttribute.get()) {\n-         throw new CacheConfigurationException(\"Anchored keys caches must have state transfer enabled\");\n-      }\n \n-      Attribute<Boolean> awaitStateTransferAttribute =\n-            rootBuilder.clustering().stateTransfer().attributes()\n-                       .attribute(StateTransferConfiguration.AWAIT_INITIAL_TRANSFER);\n-      if (awaitStateTransferAttribute.get() && awaitStateTransferAttribute.isModified()) {\n-         throw new CacheConfigurationException(\n-               \"Anchored keys do not support awaiting for state transfer when starting a cache, please remove the \" +\n-               \"await-initial-transfer attribute from your configuration\");\n-      }\n+      // TODO Maybe just assert that awaitInitialTransfer is disabled instead?\n       rootBuilder.clustering().stateTransfer().awaitInitialTransfer(false);\n-\n-      Attribute<PartitionHandling> whenSplitAttribute =\n-            rootBuilder.clustering().partitionHandling().attributes()\n-                       .attribute(PartitionHandlingConfiguration.WHEN_SPLIT);\n-      if (whenSplitAttribute.get() != PartitionHandling.ALLOW_READ_WRITES && whenSplitAttribute.isModified()) {\n-         throw new CacheConfigurationException(\n-               \"Anchored keys only support partition handling mode ALLOW_READ_WRITES, please remove the when-split \" +\n-               \"attribute from your configuration\");\n-      }\n-      rootBuilder.clustering().partitionHandling().whenSplit(PartitionHandling.ALLOW_READ_WRITES);\n-\n-      Attribute<EntryMergePolicy> mergePolicyAttribute =\n-            rootBuilder.clustering().partitionHandling().attributes()\n-                       .attribute(PartitionHandlingConfiguration.MERGE_POLICY);\n-      if (mergePolicyAttribute.get() != MergePolicy.PREFERRED_NON_NULL && mergePolicyAttribute.isModified()) {\n-         throw new CacheConfigurationException(\n-               \"Anchored keys only support merge policy PREFERRED_NON_NULL, please remove the merge-policy attribute \" +\n-               \"from your configuration\");\n-      }\n-      rootBuilder.clustering().partitionHandling().mergePolicy(MergePolicy.PREFERRED_NON_NULL);\n    }\n \n    @Override\n"}}, {"oid": "7f4e96fd5a58846ea3356653aa44d77c5675a6e0", "url": "https://github.com/infinispan/infinispan/commit/7f4e96fd5a58846ea3356653aa44d77c5675a6e0", "message": "ISPN-11304 Add anchored keys documentation in developer guide", "committedDate": "2020-07-23T13:40:42Z", "type": "forcePushed"}, {"oid": "3527611ad96c6d87928e269838133412e337250f", "url": "https://github.com/infinispan/infinispan/commit/3527611ad96c6d87928e269838133412e337250f", "message": "Update FAQ\n\n* Remove references to JBoss Cache\n* Replace outdated state transfer/readExternal questions\n  with a more relevant one", "committedDate": "2020-07-23T14:21:33Z", "type": "commit"}, {"oid": "30a622659ed272dce4f63631b15171162e2f0c3a", "url": "https://github.com/infinispan/infinispan/commit/30a622659ed272dce4f63631b15171162e2f0c3a", "message": "Remove ZWSP and SHY characters in documentation", "committedDate": "2020-07-23T14:21:33Z", "type": "commit"}, {"oid": "e0596a272885d18f56df0e7549d33486ffbac09e", "url": "https://github.com/infinispan/infinispan/commit/e0596a272885d18f56df0e7549d33486ffbac09e", "message": "ISPN-11304 Mark AnchoredKeysConfiguration[Builder] as experimental", "committedDate": "2020-07-23T14:21:33Z", "type": "commit"}, {"oid": "97a70205a853cce90b09399c960d13046ae52a3f", "url": "https://github.com/infinispan/infinispan/commit/97a70205a853cce90b09399c960d13046ae52a3f", "message": "ISPN-11304 Validate anchored keys configuration requirements\n\n* Require replicated mode\n* Disallow transactions\n* Require state transfer w/out await-initial-transfer\n* Require ALLOW_READ_WRITES and merge policy PREFERRED_NON_NULL", "committedDate": "2020-07-23T15:14:06Z", "type": "commit"}, {"oid": "c9b0466f7fdbb20947c9bce98506016f1a6c618b", "url": "https://github.com/infinispan/infinispan/commit/c9b0466f7fdbb20947c9bce98506016f1a6c618b", "message": "ISPN-11304 Enable anchored keys without explicit enabled=\"true\" in XML", "committedDate": "2020-07-23T15:16:47Z", "type": "commit"}, {"oid": "c5936e6c51173e2a424746b024b608f481399a43", "url": "https://github.com/infinispan/infinispan/commit/c5936e6c51173e2a424746b024b608f481399a43", "message": "adoc", "committedDate": "2020-07-23T15:16:47Z", "type": "forcePushed"}, {"oid": "d7957474bd9dc0d6a1fa86f6147515ce42bba645", "url": "https://github.com/infinispan/infinispan/commit/d7957474bd9dc0d6a1fa86f6147515ce42bba645", "message": "ISPN-11304 Add anchored keys documentation in developer guide", "committedDate": "2020-07-23T15:17:06Z", "type": "commit"}, {"oid": "d7957474bd9dc0d6a1fa86f6147515ce42bba645", "url": "https://github.com/infinispan/infinispan/commit/d7957474bd9dc0d6a1fa86f6147515ce42bba645", "message": "ISPN-11304 Add anchored keys documentation in developer guide", "committedDate": "2020-07-23T15:17:06Z", "type": "forcePushed"}]}