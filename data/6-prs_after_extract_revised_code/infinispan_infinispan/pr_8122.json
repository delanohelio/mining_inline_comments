{"pr_number": 8122, "pr_title": "ISPN-11556 SFS file location not relative to global persistent-location", "pr_createdAt": "2020-03-30T10:26:38Z", "pr_url": "https://github.com/infinispan/infinispan/pull/8122", "timeline": [{"oid": "e3a4b8abc0ca9c1efb18a5a12a093b361f4ee80a", "url": "https://github.com/infinispan/infinispan/commit/e3a4b8abc0ca9c1efb18a5a12a093b361f4ee80a", "message": "ISPN-11556 SFS file location not relative to global persistent-location", "committedDate": "2020-04-01T09:58:14Z", "type": "forcePushed"}, {"oid": "73be561b945cc238cfba9e9a40a616fcbd031f6a", "url": "https://github.com/infinispan/infinispan/commit/73be561b945cc238cfba9e9a40a616fcbd031f6a", "message": "ISPN-11556 SFS file location not relative to global persistent-location", "committedDate": "2020-04-02T11:11:09Z", "type": "forcePushed"}, {"oid": "ca9e907e90cc7c38eadf8a58ab9d443d94e16585", "url": "https://github.com/infinispan/infinispan/commit/ca9e907e90cc7c38eadf8a58ab9d443d94e16585", "message": "ISPN-11556 SFS file location not relative to global persistent-location", "committedDate": "2020-04-02T18:18:26Z", "type": "forcePushed"}, {"oid": "04dd6f97889d90fb38655effdbbbfa5e61271c52", "url": "https://github.com/infinispan/infinispan/commit/04dd6f97889d90fb38655effdbbbfa5e61271c52", "message": "ISPN-11556 SFS file location not relative to global persistent-location", "committedDate": "2020-04-03T09:31:51Z", "type": "forcePushed"}, {"oid": "1180cc3df9b1cf7b2987a8aa4d3a44bb92473657", "url": "https://github.com/infinispan/infinispan/commit/1180cc3df9b1cf7b2987a8aa4d3a44bb92473657", "message": "ISPN-11556 SFS file location not relative to global persistent-location", "committedDate": "2020-04-14T10:08:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE1MDAyNQ==", "url": "https://github.com/infinispan/infinispan/pull/8122#discussion_r408150025", "bodyText": "I know this will make the code a bit uglier, but I wonder if we should change the signature to getQualifiedLocation(GlobalConfiguration globalConfiguration, String location, String cacheName, String qualifier, String... additionalQualifiers).\nOr it seems the qualifiers are optional now?", "author": "wburns", "createdAt": "2020-04-14T13:48:37Z", "path": "core/src/main/java/org/infinispan/persistence/PersistenceUtil.java", "diffHunk": "@@ -154,21 +154,21 @@ public static String sanitizedCacheName(String cacheName) {\n       return cacheName.replaceAll(\"[^a-zA-Z0-9-_\\\\.]\", \"_\");\n    }\n \n-   public static Path getQualifiedLocation(GlobalConfiguration globalConfiguration, String location, String cacheName, String qualifier) {\n+   public static Path getQualifiedLocation(GlobalConfiguration globalConfiguration, String location, String cacheName, String... qualifiers) {", "originalCommit": "1180cc3df9b1cf7b2987a8aa4d3a44bb92473657", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE4MzIyNQ==", "url": "https://github.com/infinispan/infinispan/pull/8122#discussion_r408183225", "bodyText": "I've added a new commit that actually removes my changes to this class. I was thinking about it in the wrong way, instead we should add the \"data\" directory like other stores as it's more descriptive.", "author": "ryanemerson", "createdAt": "2020-04-14T14:31:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE1MDAyNQ=="}], "type": "inlineReview", "revised_code": {"commit": "a7475f2beeda3fad083a7e7bce4ecfdc73d2fe43", "chunk": "diff --git a/core/src/main/java/org/infinispan/persistence/PersistenceUtil.java b/core/src/main/java/org/infinispan/persistence/PersistenceUtil.java\nindex 437fb5c10d..9fbe86bc00 100644\n--- a/core/src/main/java/org/infinispan/persistence/PersistenceUtil.java\n+++ b/core/src/main/java/org/infinispan/persistence/PersistenceUtil.java\n\n@@ -154,21 +154,21 @@ public static String sanitizedCacheName(String cacheName) {\n       return cacheName.replaceAll(\"[^a-zA-Z0-9-_\\\\.]\", \"_\");\n    }\n \n-   public static Path getQualifiedLocation(GlobalConfiguration globalConfiguration, String location, String cacheName, String... qualifiers) {\n+   public static Path getQualifiedLocation(GlobalConfiguration globalConfiguration, String location, String cacheName, String qualifier) {\n       Path persistentLocation = Paths.get(globalConfiguration.globalState().persistentLocation());\n       if (location == null) {\n-         return persistentLocation.resolve(Paths.get(sanitizedCacheName(cacheName), qualifiers));\n+         return persistentLocation.resolve(Paths.get(sanitizedCacheName(cacheName), qualifier));\n       } else {\n          Path path = Paths.get(location);\n          if (path.isAbsolute()) {\n             // Ensure that the path lives under the global persistent location\n             if (path.startsWith(persistentLocation)) {\n-               return path.resolve(Paths.get(sanitizedCacheName(cacheName), qualifiers));\n+               return Paths.get(location, sanitizedCacheName(cacheName), qualifier);\n             } else {\n                throw PERSISTENCE.forbiddenStoreLocation(path, persistentLocation);\n             }\n          } else {\n-            return persistentLocation.resolve(path.resolve(Paths.get(sanitizedCacheName(cacheName), qualifiers)));\n+            return persistentLocation.resolve(path.resolve(Paths.get(sanitizedCacheName(cacheName), qualifier)));\n          }\n       }\n    }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE1MDM2MA==", "url": "https://github.com/infinispan/infinispan/pull/8122#discussion_r408150360", "bodyText": "Should this include the cacheName?", "author": "wburns", "createdAt": "2020-04-14T13:49:02Z", "path": "core/src/main/java/org/infinispan/persistence/file/SingleFileStore.java", "diffHunk": "@@ -106,13 +108,9 @@ public void init(InitializationContext ctx) {\n \n    @Override\n    public void start() {\n+      Path location = PersistenceUtil.getQualifiedLocation(ctx.getGlobalConfiguration(), configuration.location(), ctx.getCache().getName() + \".dat\");", "originalCommit": "1180cc3df9b1cf7b2987a8aa4d3a44bb92473657", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE2MTEyMg==", "url": "https://github.com/infinispan/infinispan/pull/8122#discussion_r408161122", "bodyText": "This was the format that we previously used for the actual file <cache-name>.dat. I just followed this convention.", "author": "ryanemerson", "createdAt": "2020-04-14T14:02:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE1MDM2MA=="}], "type": "inlineReview", "revised_code": {"commit": "a7475f2beeda3fad083a7e7bce4ecfdc73d2fe43", "chunk": "diff --git a/core/src/main/java/org/infinispan/persistence/file/SingleFileStore.java b/core/src/main/java/org/infinispan/persistence/file/SingleFileStore.java\nindex ebecca540c..d78b2b8a23 100644\n--- a/core/src/main/java/org/infinispan/persistence/file/SingleFileStore.java\n+++ b/core/src/main/java/org/infinispan/persistence/file/SingleFileStore.java\n\n@@ -108,9 +108,9 @@ public void init(InitializationContext ctx) {\n \n    @Override\n    public void start() {\n-      Path location = PersistenceUtil.getQualifiedLocation(ctx.getGlobalConfiguration(), configuration.location(), ctx.getCache().getName() + \".dat\");\n+      Path location = PersistenceUtil.getQualifiedLocation(ctx.getGlobalConfiguration(), configuration.location(), ctx.getCache().getName(), \"data\");\n       try {\n-         file = location.toFile();\n+         file = new File(location.toFile(), ctx.getCache().getName() + \".dat\");\n          if (!file.exists()) {\n             File dir = file.getParentFile();\n             if (!dir.mkdirs() && !dir.exists()) {\n"}}, {"oid": "a7475f2beeda3fad083a7e7bce4ecfdc73d2fe43", "url": "https://github.com/infinispan/infinispan/commit/a7475f2beeda3fad083a7e7bce4ecfdc73d2fe43", "message": "ISPN-11556 SFS file location not relative to global persistent-location", "committedDate": "2020-04-16T08:10:53Z", "type": "commit"}, {"oid": "a7475f2beeda3fad083a7e7bce4ecfdc73d2fe43", "url": "https://github.com/infinispan/infinispan/commit/a7475f2beeda3fad083a7e7bce4ecfdc73d2fe43", "message": "ISPN-11556 SFS file location not relative to global persistent-location", "committedDate": "2020-04-16T08:10:53Z", "type": "forcePushed"}]}