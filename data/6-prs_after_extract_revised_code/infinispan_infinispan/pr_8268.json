{"pr_number": 8268, "pr_title": "ISPN-11756 Deprecate IndexingConfiguration.indexShareable() and remov\u2026", "pr_createdAt": "2020-04-30T10:48:25Z", "pr_url": "https://github.com/infinispan/infinispan/pull/8268", "timeline": [{"oid": "86ca221f7497e33e959156687a1ee8e469b60cf0", "url": "https://github.com/infinispan/infinispan/commit/86ca221f7497e33e959156687a1ee8e469b60cf0", "message": "ISPN-11757 Do not allow multiple indexing providers per cache", "committedDate": "2020-04-30T13:25:17Z", "type": "forcePushed"}, {"oid": "604228ab5e2cd8d575c4f6763b49218ce1b5b054", "url": "https://github.com/infinispan/infinispan/commit/604228ab5e2cd8d575c4f6763b49218ce1b5b054", "message": "WIP reindex volatile", "committedDate": "2020-05-01T00:17:48Z", "type": "forcePushed"}, {"oid": "8effb63fd69cf2fbd442c5bf92b6f447f2d95a1f", "url": "https://github.com/infinispan/infinispan/commit/8effb63fd69cf2fbd442c5bf92b6f447f2d95a1f", "message": "WIP Reindex on preload if index provider is volatile", "committedDate": "2020-05-01T07:58:17Z", "type": "forcePushed"}, {"oid": "6f42a5fdb41495e48b40d873934994f3322e88b1", "url": "https://github.com/infinispan/infinispan/commit/6f42a5fdb41495e48b40d873934994f3322e88b1", "message": "ISPN-11760 Volatile indexes should be rebuilt on store preload", "committedDate": "2020-05-01T08:25:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ2Mjk2NA==", "url": "https://github.com/infinispan/infinispan/pull/8268#discussion_r418462964", "bodyText": "The current form of this boolean condition is based on its previous + the need to re-index if the indexing provider is volatile. The two put together ... look odd to me @gustavonalle", "author": "anistor", "createdAt": "2020-05-01T08:37:07Z", "path": "core/src/main/java/org/infinispan/persistence/manager/PersistenceManagerImpl.java", "diffHunk": "@@ -1261,33 +1261,26 @@ private long getFlagsForStateInsertion() {\n             FlagBitSets.SKIP_LOCKING |\n             FlagBitSets.SKIP_XSITE_BACKUP;\n \n-      boolean hasShared = false;\n+      boolean hasSharedStore = false;\n       acquireReadLock();\n       try {\n          for (CacheWriter w : nonTxWriters) {\n             if (getStoreConfig(w).shared()) {\n-               hasShared = true;\n+               hasSharedStore = true;\n                break;\n             }\n          }\n       } finally {\n          releaseReadLock();\n       }\n \n-      if (hasShared) {\n-         if (indexShareable())\n-            flags = EnumUtil.mergeBitSets(flags, FlagBitSets.SKIP_INDEXING);\n-      } else {\n+      if (!hasSharedStore && !configuration.indexing().isVolatile()) {", "originalCommit": "6f42a5fdb41495e48b40d873934994f3322e88b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ4OTg4NQ==", "url": "https://github.com/infinispan/infinispan/pull/8268#discussion_r418489885", "bodyText": "I've changed the && to || and seems ok now.", "author": "anistor", "createdAt": "2020-05-01T10:18:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ2Mjk2NA=="}], "type": "inlineReview", "revised_code": {"commit": "75c6e79133720a6cd75ee2f1654ec90bf7b77589", "chunk": "diff --git a/core/src/main/java/org/infinispan/persistence/manager/PersistenceManagerImpl.java b/core/src/main/java/org/infinispan/persistence/manager/PersistenceManagerImpl.java\nindex 1711dc9b4a..e8db437422 100644\n--- a/core/src/main/java/org/infinispan/persistence/manager/PersistenceManagerImpl.java\n+++ b/core/src/main/java/org/infinispan/persistence/manager/PersistenceManagerImpl.java\n\n@@ -1274,7 +1274,7 @@ private long getFlagsForStateInsertion() {\n          releaseReadLock();\n       }\n \n-      if (!hasSharedStore && !configuration.indexing().isVolatile()) {\n+      if (!hasSharedStore || !configuration.indexing().isVolatile()) {\n          flags = EnumUtil.mergeBitSets(flags, FlagBitSets.SKIP_INDEXING);\n       }\n \n"}}, {"oid": "06027d588864930112e87d85c331eba4faf75f84", "url": "https://github.com/infinispan/infinispan/commit/06027d588864930112e87d85c331eba4faf75f84", "message": "ISPN-11760 Volatile indexes should be rebuilt on store preload", "committedDate": "2020-05-01T09:56:20Z", "type": "forcePushed"}, {"oid": "75c6e79133720a6cd75ee2f1654ec90bf7b77589", "url": "https://github.com/infinispan/infinispan/commit/75c6e79133720a6cd75ee2f1654ec90bf7b77589", "message": "ISPN-11760 Volatile indexes should be rebuilt on store preload", "committedDate": "2020-05-01T10:15:43Z", "type": "forcePushed"}, {"oid": "5ed6ff39f3e1c36c9af57ec5a9a54c0d6fff4826", "url": "https://github.com/infinispan/infinispan/commit/5ed6ff39f3e1c36c9af57ec5a9a54c0d6fff4826", "message": "ISPN-11760 Volatile indexes should be rebuilt on store preload", "committedDate": "2020-05-01T12:56:46Z", "type": "forcePushed"}, {"oid": "68ee3f8724b8e86142dca6bdd11ecd9b703b4069", "url": "https://github.com/infinispan/infinispan/commit/68ee3f8724b8e86142dca6bdd11ecd9b703b4069", "message": "ISPN-11760 Volatile indexes should be rebuilt on store preload", "committedDate": "2020-05-01T14:42:12Z", "type": "forcePushed"}, {"oid": "e94355e9366ae1557ae84ac8a35a20c7f045ede7", "url": "https://github.com/infinispan/infinispan/commit/e94355e9366ae1557ae84ac8a35a20c7f045ede7", "message": "ISPN-11760 Volatile indexes should be rebuilt on store preload", "committedDate": "2020-05-03T08:13:10Z", "type": "forcePushed"}, {"oid": "9610fac93e293feebe18fca393804eb66433eb42", "url": "https://github.com/infinispan/infinispan/commit/9610fac93e293feebe18fca393804eb66433eb42", "message": "ISPN-11760 Volatile indexes should be rebuilt on store preload", "committedDate": "2020-05-03T20:15:04Z", "type": "forcePushed"}, {"oid": "f54c2367103630d8e236e4d89895acc293a0a45e", "url": "https://github.com/infinispan/infinispan/commit/f54c2367103630d8e236e4d89895acc293a0a45e", "message": "ISPN-11760 Volatile indexes should be rebuilt on store preload", "committedDate": "2020-05-04T13:57:57Z", "type": "forcePushed"}, {"oid": "0db279d44389101f6bfdd7d9063b08dc375cba9c", "url": "https://github.com/infinispan/infinispan/commit/0db279d44389101f6bfdd7d9063b08dc375cba9c", "message": "ISPN-11756 Deprecate IndexingConfiguration.indexShareable() and remove all its usages\n\n* this should always return false starting with 11", "committedDate": "2020-05-04T16:05:55Z", "type": "commit"}, {"oid": "f56b940f91bcbf529a0838c2ab101b878fa38ff9", "url": "https://github.com/infinispan/infinispan/commit/f56b940f91bcbf529a0838c2ab101b878fa38ff9", "message": "ISPN-11760 Volatile indexes should be rebuilt on store preload", "committedDate": "2020-05-04T16:08:20Z", "type": "commit"}, {"oid": "f56b940f91bcbf529a0838c2ab101b878fa38ff9", "url": "https://github.com/infinispan/infinispan/commit/f56b940f91bcbf529a0838c2ab101b878fa38ff9", "message": "ISPN-11760 Volatile indexes should be rebuilt on store preload", "committedDate": "2020-05-04T16:08:20Z", "type": "forcePushed"}]}