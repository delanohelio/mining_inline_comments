{"pr_number": 8494, "pr_title": "ISPN-12029 Replace Blocking Executor with an EnhancedQueueExecutor", "pr_createdAt": "2020-06-19T20:54:11Z", "pr_url": "https://github.com/infinispan/infinispan/pull/8494", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE4NzY0MQ==", "url": "https://github.com/infinispan/infinispan/pull/8494#discussion_r443187641", "bodyText": "I suggest renaming BlockingThreadPoolExecutorFactory, using it only on the nonBlocking path looks weird.", "author": "danberindei", "createdAt": "2020-06-21T06:41:11Z", "path": "core/src/main/java/org/infinispan/factories/threads/CoreExecutorFactory.java", "diffHunk": "@@ -0,0 +1,26 @@\n+package org.infinispan.factories.threads;\n+\n+import java.util.concurrent.ExecutorService;\n+\n+import org.infinispan.commons.executors.BlockingThreadPoolExecutorFactory;\n+import org.infinispan.commons.executors.ThreadPoolExecutorFactory;\n+\n+public class CoreExecutorFactory {\n+   private CoreExecutorFactory() { }\n+\n+   public static ThreadPoolExecutorFactory<? extends ExecutorService> executorFactory(int maxThreads, int coreThreads,\n+         int queueLength, long keepAlive, boolean nonBlocking) {\n+      if (nonBlocking) {\n+         return new BlockingThreadPoolExecutorFactory(maxThreads, coreThreads, queueLength, keepAlive, nonBlocking);", "originalCommit": "8a513061b1650c3294479f627eda1d5772d80afe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI4ODUxNQ==", "url": "https://github.com/infinispan/infinispan/pull/8494#discussion_r443288515", "bodyText": "Yeah, I had debated about renaming it to NonBlockingThreadPoolExecutorFactory. I will go ahead and do that and remove the blocking arguments.", "author": "wburns", "createdAt": "2020-06-22T02:20:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE4NzY0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI5MDI4Nw==", "url": "https://github.com/infinispan/infinispan/pull/8494#discussion_r443290287", "bodyText": "Actually I can't rename it as it is a public package. I am thinking instead I will just deprecate the one in commons and add the new class in core where it is private. We can move it later if needed.", "author": "wburns", "createdAt": "2020-06-22T02:30:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE4NzY0MQ=="}], "type": "inlineReview", "revised_code": {"commit": "1d23869935a57b9b8396026a1631f484c09e1ca9", "chunk": "diff --git a/core/src/main/java/org/infinispan/factories/threads/CoreExecutorFactory.java b/core/src/main/java/org/infinispan/factories/threads/CoreExecutorFactory.java\nindex ca99960c5a..9751df8a8f 100644\n--- a/core/src/main/java/org/infinispan/factories/threads/CoreExecutorFactory.java\n+++ b/core/src/main/java/org/infinispan/factories/threads/CoreExecutorFactory.java\n\n@@ -2,7 +2,6 @@\n \n import java.util.concurrent.ExecutorService;\n \n-import org.infinispan.commons.executors.BlockingThreadPoolExecutorFactory;\n import org.infinispan.commons.executors.ThreadPoolExecutorFactory;\n \n public class CoreExecutorFactory {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE4Nzc3Nw==", "url": "https://github.com/infinispan/infinispan/pull/8494#discussion_r443187777", "bodyText": "Couldn't you make BlockingRejectedExecutionHandler implement Executor?", "author": "danberindei", "createdAt": "2020-06-21T06:43:21Z", "path": "core/src/main/java/org/infinispan/factories/threads/EnhancedQueueExecutorFactory.java", "diffHunk": "@@ -0,0 +1,92 @@\n+package org.infinispan.factories.threads;\n+\n+import static org.infinispan.commons.logging.Log.CONFIG;\n+\n+import java.time.Duration;\n+import java.time.temporal.ChronoUnit;\n+import java.util.concurrent.ThreadFactory;\n+\n+import org.infinispan.commons.executors.BlockingResource;\n+import org.infinispan.commons.executors.BlockingThreadPoolExecutorFactory;\n+import org.infinispan.commons.executors.ThreadPoolExecutorFactory;\n+import org.infinispan.commons.util.concurrent.BlockingRejectedExecutionHandler;\n+import org.jboss.threads.EnhancedQueueExecutor;\n+import org.jboss.threads.management.ManageableThreadPoolExecutorService;\n+\n+public class EnhancedQueueExecutorFactory implements ThreadPoolExecutorFactory<ManageableThreadPoolExecutorService> {\n+   private final int maxThreads;\n+   private final int coreThreads;\n+   private final int queueLength;\n+   private final long keepAlive;\n+\n+   public EnhancedQueueExecutorFactory(int maxThreads, int coreThreads, int queueLength, long keepAlive, boolean nonBlocking) {\n+      if (nonBlocking) {\n+         throw new UnsupportedOperationException(\"EnhancedQueryExecutorFactory only supports blocking threads currently!\");\n+      }\n+      this.maxThreads = maxThreads;\n+      this.coreThreads = coreThreads;\n+      this.queueLength = queueLength;\n+      this.keepAlive = keepAlive;\n+   }\n+\n+   public int maxThreads() {\n+      return maxThreads;\n+   }\n+\n+   public int coreThreads() {\n+      return coreThreads;\n+   }\n+\n+   public int queueLength() {\n+      return queueLength;\n+   }\n+\n+   public long keepAlive() {\n+      return keepAlive;\n+   }\n+\n+   public static EnhancedQueueExecutorFactory create(int maxThreads, int queueSize, boolean nonBlocking) {\n+      int coreThreads = queueSize == 0 ? 1 : maxThreads;\n+      return new EnhancedQueueExecutorFactory(maxThreads, coreThreads, queueSize,\n+            BlockingThreadPoolExecutorFactory.DEFAULT_KEEP_ALIVE_MILLIS, nonBlocking);\n+   }\n+\n+   @Override\n+   public ManageableThreadPoolExecutorService createExecutor(ThreadFactory factory) {\n+      if (!(factory instanceof BlockingResource)) {\n+         throw new IllegalStateException(\"Executor factory configured to be blocking and received a thread\" +\n+               \" factory that doesn't create blocking threads!\");\n+      }\n+      EnhancedQueueExecutor.Builder builder = new EnhancedQueueExecutor.Builder();\n+      builder.setThreadFactory(factory);\n+      builder.setCorePoolSize(coreThreads);\n+      builder.setMaximumPoolSize(maxThreads);\n+      builder.setGrowthResistance(0.0f);\n+      builder.setMaximumQueueSize(queueLength);\n+      builder.setKeepAliveTime(Duration.of(keepAlive, ChronoUnit.MILLIS));\n+\n+      EnhancedQueueExecutor enhancedQueueExecutor = builder.build();\n+      enhancedQueueExecutor.setHandoffExecutor(task ->\n+         BlockingRejectedExecutionHandler.getInstance().rejectedExecution(task, enhancedQueueExecutor));", "originalCommit": "8a513061b1650c3294479f627eda1d5772d80afe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI4ODUwNg==", "url": "https://github.com/infinispan/infinispan/pull/8494#discussion_r443288506", "bodyText": "I am not quite sure why we want that. We still need a reference to the original executor service to detect if it is shut down or not.", "author": "wburns", "createdAt": "2020-06-22T02:20:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE4Nzc3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI1NDMxMg==", "url": "https://github.com/infinispan/infinispan/pull/8494#discussion_r446254312", "bodyText": "I was thinking BlockingRejectedExecutionHandler doesn't need to implement RejectedExecutionHandler any more, so it might as well implement Executor and receive the enhancedQueueExecutor as a constructor parameter.", "author": "danberindei", "createdAt": "2020-06-26T15:29:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE4Nzc3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI1NzkxOQ==", "url": "https://github.com/infinispan/infinispan/pull/8494#discussion_r446257919", "bodyText": "Yeah, I personally am not a fan of that. Currently we can easily find all RejectedExecutionHandler implementations which seems much cleaner to me. And it very clearly documents what we should do with a task that is rejected from a blocking executor.\nAlso the resulting class seems really ugly to me in that we create an Executor that takes an ExecutorService but can't submit to it, only check its running state. It seems like a dependency going the wrong direction, where as now it is a much clearer to me.", "author": "wburns", "createdAt": "2020-06-26T15:35:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE4Nzc3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI4NzM1OQ==", "url": "https://github.com/infinispan/infinispan/pull/8494#discussion_r446287359", "bodyText": "Fair enough, it's complicated enough with all those *ExecutorFactory classes, no need for one more Executor.", "author": "danberindei", "createdAt": "2020-06-26T16:30:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE4Nzc3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "1d23869935a57b9b8396026a1631f484c09e1ca9", "chunk": "diff --git a/core/src/main/java/org/infinispan/factories/threads/EnhancedQueueExecutorFactory.java b/core/src/main/java/org/infinispan/factories/threads/EnhancedQueueExecutorFactory.java\nindex 7dfd1178cc..8e4bc314d8 100644\n--- a/core/src/main/java/org/infinispan/factories/threads/EnhancedQueueExecutorFactory.java\n+++ b/core/src/main/java/org/infinispan/factories/threads/EnhancedQueueExecutorFactory.java\n\n@@ -6,56 +6,27 @@\n import java.time.temporal.ChronoUnit;\n import java.util.concurrent.ThreadFactory;\n \n-import org.infinispan.commons.executors.BlockingResource;\n-import org.infinispan.commons.executors.BlockingThreadPoolExecutorFactory;\n-import org.infinispan.commons.executors.ThreadPoolExecutorFactory;\n+import org.infinispan.commons.executors.NonBlockingResource;\n import org.infinispan.commons.util.concurrent.BlockingRejectedExecutionHandler;\n import org.jboss.threads.EnhancedQueueExecutor;\n import org.jboss.threads.management.ManageableThreadPoolExecutorService;\n \n-public class EnhancedQueueExecutorFactory implements ThreadPoolExecutorFactory<ManageableThreadPoolExecutorService> {\n-   private final int maxThreads;\n-   private final int coreThreads;\n-   private final int queueLength;\n-   private final long keepAlive;\n-\n-   public EnhancedQueueExecutorFactory(int maxThreads, int coreThreads, int queueLength, long keepAlive, boolean nonBlocking) {\n-      if (nonBlocking) {\n-         throw new UnsupportedOperationException(\"EnhancedQueryExecutorFactory only supports blocking threads currently!\");\n-      }\n-      this.maxThreads = maxThreads;\n-      this.coreThreads = coreThreads;\n-      this.queueLength = queueLength;\n-      this.keepAlive = keepAlive;\n-   }\n-\n-   public int maxThreads() {\n-      return maxThreads;\n-   }\n-\n-   public int coreThreads() {\n-      return coreThreads;\n-   }\n-\n-   public int queueLength() {\n-      return queueLength;\n-   }\n-\n-   public long keepAlive() {\n-      return keepAlive;\n+public class EnhancedQueueExecutorFactory extends AbstractFixedThreadPoolExecutorFactory<ManageableThreadPoolExecutorService> {\n+   protected EnhancedQueueExecutorFactory(int maxThreads, int coreThreads, int queueLength, long keepAlive) {\n+      super(maxThreads, coreThreads, queueLength, keepAlive);\n    }\n \n-   public static EnhancedQueueExecutorFactory create(int maxThreads, int queueSize, boolean nonBlocking) {\n+   public static EnhancedQueueExecutorFactory create(int maxThreads, int queueSize) {\n       int coreThreads = queueSize == 0 ? 1 : maxThreads;\n       return new EnhancedQueueExecutorFactory(maxThreads, coreThreads, queueSize,\n-            BlockingThreadPoolExecutorFactory.DEFAULT_KEEP_ALIVE_MILLIS, nonBlocking);\n+            NonBlockingThreadPoolExecutorFactory.DEFAULT_KEEP_ALIVE_MILLIS);\n    }\n \n    @Override\n    public ManageableThreadPoolExecutorService createExecutor(ThreadFactory factory) {\n-      if (!(factory instanceof BlockingResource)) {\n+      if (factory instanceof NonBlockingResource) {\n          throw new IllegalStateException(\"Executor factory configured to be blocking and received a thread\" +\n-               \" factory that doesn't create blocking threads!\");\n+               \" factory that creates non-blocking threads!\");\n       }\n       EnhancedQueueExecutor.Builder builder = new EnhancedQueueExecutor.Builder();\n       builder.setThreadFactory(factory);\n"}}, {"oid": "1d23869935a57b9b8396026a1631f484c09e1ca9", "url": "https://github.com/infinispan/infinispan/commit/1d23869935a57b9b8396026a1631f484c09e1ca9", "message": "ISPN-12029 Replace Blocking Executor with an EnhancedQueueExecutor", "committedDate": "2020-06-22T03:32:31Z", "type": "forcePushed"}, {"oid": "e1e35da1f2cc76e072ed181ac8ee3509f088e22e", "url": "https://github.com/infinispan/infinispan/commit/e1e35da1f2cc76e072ed181ac8ee3509f088e22e", "message": "ISPN-12029 Replace Blocking Executor with an EnhancedQueueExecutor", "committedDate": "2020-06-22T14:55:08Z", "type": "forcePushed"}, {"oid": "e505af6c34d9e1598511e8aeacca1f54aecc297c", "url": "https://github.com/infinispan/infinispan/commit/e505af6c34d9e1598511e8aeacca1f54aecc297c", "message": "Add org.jboss.threads module dependency", "committedDate": "2020-06-23T09:21:37Z", "type": "forcePushed"}, {"oid": "e1e35da1f2cc76e072ed181ac8ee3509f088e22e", "url": "https://github.com/infinispan/infinispan/commit/e1e35da1f2cc76e072ed181ac8ee3509f088e22e", "message": "ISPN-12029 Replace Blocking Executor with an EnhancedQueueExecutor", "committedDate": "2020-06-22T14:55:08Z", "type": "forcePushed"}, {"oid": "95d26e86bbfead09eb1ddab5179abfc82974bbcd", "url": "https://github.com/infinispan/infinispan/commit/95d26e86bbfead09eb1ddab5179abfc82974bbcd", "message": "ISPN-12029 Replace Blocking Executor with an EnhancedQueueExecutor", "committedDate": "2020-06-23T14:48:28Z", "type": "forcePushed"}, {"oid": "9ff2f79db1dd2dd63138dbe173e186651af029e9", "url": "https://github.com/infinispan/infinispan/commit/9ff2f79db1dd2dd63138dbe173e186651af029e9", "message": "ISPN-12029 Replace Blocking Executor with an EnhancedQueueExecutor", "committedDate": "2020-06-26T16:15:29Z", "type": "forcePushed"}, {"oid": "e3dea202389124f2693226f3fc3c9462861a359d", "url": "https://github.com/infinispan/infinispan/commit/e3dea202389124f2693226f3fc3c9462861a359d", "message": "ISPN-12029 Replace Blocking Executor with an EnhancedQueueExecutor", "committedDate": "2020-06-26T16:35:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM2ODEwNg==", "url": "https://github.com/infinispan/infinispan/pull/8494#discussion_r446368106", "bodyText": "Should be private, TestNG thinks it's a test method\nhttps://ci.infinispan.org/job/Infinispan/job/PR-8494/13/testReport/junit/org.infinispan.query.remote.impl/ProtobufMetadataManagerInterceptorTest/waitForNoLocks/", "author": "danberindei", "createdAt": "2020-06-26T19:22:21Z", "path": "remote-query/remote-query-server/src/test/java/org/infinispan/query/remote/impl/ProtobufMetadataManagerInterceptorTest.java", "diffHunk": "@@ -318,7 +319,22 @@ public void testStateTransfer() {\n \n    private void assertNoTransactionsAndLocks() {\n       assertNoTransactions();\n-      TestingUtil.assertNoLocks(cache(0));\n-      TestingUtil.assertNoLocks(cache(1));\n+      waitForNoLocks(cache(0));\n+      waitForNoLocks(cache(1));\n+   }\n+\n+   public void waitForNoLocks(Cache<?, ?> cache) {", "originalCommit": "6194c87f03721bf7aba0617b82a60aa6fe2397b6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "81559170c74cb8f37455f9882a402dbd2c139d19", "chunk": "diff --git a/remote-query/remote-query-server/src/test/java/org/infinispan/query/remote/impl/ProtobufMetadataManagerInterceptorTest.java b/remote-query/remote-query-server/src/test/java/org/infinispan/query/remote/impl/ProtobufMetadataManagerInterceptorTest.java\nindex d9e718cb28..9185eaeed9 100644\n--- a/remote-query/remote-query-server/src/test/java/org/infinispan/query/remote/impl/ProtobufMetadataManagerInterceptorTest.java\n+++ b/remote-query/remote-query-server/src/test/java/org/infinispan/query/remote/impl/ProtobufMetadataManagerInterceptorTest.java\n\n@@ -323,7 +323,7 @@ private void assertNoTransactionsAndLocks() {\n       waitForNoLocks(cache(1));\n    }\n \n-   public void waitForNoLocks(Cache<?, ?> cache) {\n+   private void waitForNoLocks(Cache<?, ?> cache) {\n       LockManager lm = TestingUtil.extractLockManager(cache);\n       if (lm != null) {\n          eventually(() -> {\n"}}, {"oid": "125fc215b7d86300a65c6ea433639332eb627080", "url": "https://github.com/infinispan/infinispan/commit/125fc215b7d86300a65c6ea433639332eb627080", "message": "add in explicit jboss threads to feature-pack", "committedDate": "2020-07-13T14:34:49Z", "type": "forcePushed"}, {"oid": "2d3598ea3b1f368b8aa547cc173c3f678c776285", "url": "https://github.com/infinispan/infinispan/commit/2d3598ea3b1f368b8aa547cc173c3f678c776285", "message": "revert upgrade", "committedDate": "2020-07-14T13:34:54Z", "type": "forcePushed"}, {"oid": "81559170c74cb8f37455f9882a402dbd2c139d19", "url": "https://github.com/infinispan/infinispan/commit/81559170c74cb8f37455f9882a402dbd2c139d19", "message": "ISPN-12029 Replace Blocking Executor with an EnhancedQueueExecutor", "committedDate": "2020-07-17T15:07:08Z", "type": "commit"}, {"oid": "81559170c74cb8f37455f9882a402dbd2c139d19", "url": "https://github.com/infinispan/infinispan/commit/81559170c74cb8f37455f9882a402dbd2c139d19", "message": "ISPN-12029 Replace Blocking Executor with an EnhancedQueueExecutor", "committedDate": "2020-07-17T15:07:08Z", "type": "forcePushed"}]}