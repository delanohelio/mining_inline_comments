{"pr_number": 8218, "pr_title": "ISPN-11678 IndexModificationStrategy removal + ISPN-11712 Indexing auto-enabling based on <indexing> presence", "pr_createdAt": "2020-04-20T18:00:11Z", "pr_url": "https://github.com/infinispan/infinispan/pull/8218", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxOTkzNQ==", "url": "https://github.com/infinispan/infinispan/pull/8218#discussion_r411919935", "bodyText": "It still need to read somehow the configured Index, since it is deprecated, not removed. Index.PRIMARY_OWNER should probably throw an exception since it is not a safe option for non-shared indexes,and we removed all shared index managers.  When configured, Index.NONE and Index.ALL should be respected over the automatic detection", "author": "gustavonalle", "createdAt": "2020-04-21T06:55:32Z", "path": "query/src/main/java/org/infinispan/query/impl/LifecycleManager.java", "diffHunk": "@@ -134,8 +133,7 @@ private void createQueryInterceptorIfNeeded(ComponentRegistry cr, Configuration\n       }\n \n       ConcurrentMap<GlobalTransaction, Map<Object, Object>> txOldValues = new ConcurrentHashMap<>();\n-      IndexModificationStrategy indexingStrategy = IndexModificationStrategy.configuredStrategy(searchIntegrator, cfg);\n-      QueryInterceptor queryInterceptor = new QueryInterceptor(searchIntegrator, keyTransformationHandler, indexingStrategy, txOldValues, cache);\n+      QueryInterceptor queryInterceptor = new QueryInterceptor(searchIntegrator, keyTransformationHandler, txOldValues, cache);", "originalCommit": "5ee4c6e6eaa3dac7f6d2e30f8082122fb65cdb0f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk0MzgzNQ==", "url": "https://github.com/infinispan/infinispan/pull/8218#discussion_r411943835", "bodyText": "It still need to read somehow the configured Index, since it is deprecated, not removed. Index.PRIMARY_OWNER should probably throw an exception since it is not a safe option for non-shared indexes,and we removed all shared index managers. When configured, Index.NONE and Index.ALL should be respected over the automatic detection\n\nyes, I've commented about that -> #8204 (comment)", "author": "anistor", "createdAt": "2020-04-21T07:34:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxOTkzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk0NjczNQ==", "url": "https://github.com/infinispan/infinispan/pull/8218#discussion_r411946735", "bodyText": "I still insist on respecting the config:\n\nIndex.NONE -> don't index, log deprecated WARN\nIndex.PRIMARY_OWNER -> throw error\nIndex.ALL -> do nothing, log deprecated WARN", "author": "gustavonalle", "createdAt": "2020-04-21T07:38:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxOTkzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk0OTgxMw==", "url": "https://github.com/infinispan/infinispan/pull/8218#discussion_r411949813", "bodyText": "I'd be also OK with changing the current deprecation WARN logs to mention:  \"Index\" config is deprecated and ignored, please check the upgrade guide", "author": "gustavonalle", "createdAt": "2020-04-21T07:42:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxOTkzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk3Mjc0Ng==", "url": "https://github.com/infinispan/infinispan/pull/8218#discussion_r411972746", "bodyText": "I'm perfectly fine respecting the config, but your \"ISPN-11241 Deprecate Indexing mode\"  basically obliterated that, and was not sure if it was a mistake or intentional :) And the later removals made it worse, turning some code into dead code. So we need to put something back there.", "author": "anistor", "createdAt": "2020-04-21T08:16:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxOTkzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk4NzI5Ng==", "url": "https://github.com/infinispan/infinispan/pull/8218#discussion_r411987296", "bodyText": "It was my mistake. So why don't we settle for this PR + enriching the WARN that those config are ignored?", "author": "gustavonalle", "createdAt": "2020-04-21T08:36:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxOTkzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzc2OTU0Mw==", "url": "https://github.com/infinispan/infinispan/pull/8218#discussion_r413769543", "bodyText": "I've done this, in first and second commit. And added several more commits that are ISPN-11241 floow-up", "author": "anistor", "createdAt": "2020-04-23T12:23:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxOTkzNQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "50b4e20e9cdcf0fc78e31f64a875f8b19a9434bd", "url": "https://github.com/infinispan/infinispan/commit/50b4e20e9cdcf0fc78e31f64a875f8b19a9434bd", "message": "ISPN-11678 IndexModificationStrategy has become a degenerated enum after all the recent removals and can be removed entirely", "committedDate": "2020-04-21T07:14:21Z", "type": "forcePushed"}, {"oid": "93ecd18a9fa5d41f6bf5531aa9f9ab3143a0dd3d", "url": "https://github.com/infinispan/infinispan/commit/93ecd18a9fa5d41f6bf5531aa9f9ab3143a0dd3d", "message": "Remove IndexModificationStrategy\n\n* remove unused method ComponentRegistryUtils.getIndexInspector, we should always use @Inject if possible", "committedDate": "2020-04-21T11:46:20Z", "type": "forcePushed"}, {"oid": "c1b6ec1cbe75f67ef4d0fcaf6d6f9697baac2866", "url": "https://github.com/infinispan/infinispan/commit/c1b6ec1cbe75f67ef4d0fcaf6d6f9697baac2866", "message": "Remove IndexModificationStrategy\n\n* remove unused method ComponentRegistryUtils.getIndexInspector, we should always use @Inject if possible", "committedDate": "2020-04-22T09:56:38Z", "type": "forcePushed"}, {"oid": "e349b3162feb0568dbce3d025782be906e2dd0cd", "url": "https://github.com/infinispan/infinispan/commit/e349b3162feb0568dbce3d025782be906e2dd0cd", "message": "Remove unused IndexingConfigurationBuilder.index() package-local getter", "committedDate": "2020-04-22T11:18:14Z", "type": "forcePushed"}, {"oid": "252893a1e516d0641ac201ad743a754c577ee49b", "url": "https://github.com/infinispan/infinispan/commit/252893a1e516d0641ac201ad743a754c577ee49b", "message": "Remove unused IndexingConfigurationBuilder.index() package-local getter", "committedDate": "2020-04-22T11:33:11Z", "type": "forcePushed"}, {"oid": "83f15f9b76b0bce881f4d6c70bd0251f1af982e4", "url": "https://github.com/infinispan/infinispan/commit/83f15f9b76b0bce881f4d6c70bd0251f1af982e4", "message": "Remove need for explicit index enable from xml configs", "committedDate": "2020-04-23T10:00:03Z", "type": "forcePushed"}, {"oid": "c1b8fd9bcebdfbc625e2d1852ea52c1cc5f26dd8", "url": "https://github.com/infinispan/infinispan/commit/c1b8fd9bcebdfbc625e2d1852ea52c1cc5f26dd8", "message": "Remove need for explicit index enable from xml configs", "committedDate": "2020-04-23T12:27:10Z", "type": "forcePushed"}, {"oid": "295330cbb586ae084a263f85e649918f74135993", "url": "https://github.com/infinispan/infinispan/commit/295330cbb586ae084a263f85e649918f74135993", "message": "Remove need for explicit index enable from xml configs", "committedDate": "2020-04-23T16:06:52Z", "type": "forcePushed"}, {"oid": "6ee3c64617b06c7f3cdc90f434b1b0ec4dba8ce1", "url": "https://github.com/infinispan/infinispan/commit/6ee3c64617b06c7f3cdc90f434b1b0ec4dba8ce1", "message": "Remove need for explicit index enable from xml configs", "committedDate": "2020-04-25T07:27:30Z", "type": "forcePushed"}, {"oid": "566824ccabf36a8e0725982603731cc95ec1992c", "url": "https://github.com/infinispan/infinispan/commit/566824ccabf36a8e0725982603731cc95ec1992c", "message": "ISPN-11712 Remove explicit indexing enabled=\"true\" from xml configs", "committedDate": "2020-04-27T07:01:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU2MjE5MA==", "url": "https://github.com/infinispan/infinispan/pull/8218#discussion_r415562190", "bodyText": "Can we remove unused parameters from here @gustavonalle ?", "author": "anistor", "createdAt": "2020-04-27T07:05:31Z", "path": "query/src/main/java/org/infinispan/query/backend/QueryInterceptor.java", "diffHunk": "@@ -138,19 +135,18 @@ public void prepareForStopping() {\n       stopping.set(true);\n    }\n \n+   //todo [anistor] parameter 'value' is never used", "originalCommit": "566824ccabf36a8e0725982603731cc95ec1992c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTY3MTU3MQ==", "url": "https://github.com/infinispan/infinispan/pull/8218#discussion_r415671571", "bodyText": "I'll remove that then and push an update now to have a new CI run while I work on the docs aspect of it.", "author": "anistor", "createdAt": "2020-04-27T09:50:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU2MjE5MA=="}], "type": "inlineReview", "revised_code": {"commit": "8f609b1fe383bb0ac9deda1a13d5fbde67b0abf4", "chunk": "diff --git a/query/src/main/java/org/infinispan/query/backend/QueryInterceptor.java b/query/src/main/java/org/infinispan/query/backend/QueryInterceptor.java\nindex 48dd6e8c66..f6ae61ca59 100644\n--- a/query/src/main/java/org/infinispan/query/backend/QueryInterceptor.java\n+++ b/query/src/main/java/org/infinispan/query/backend/QueryInterceptor.java\n\n@@ -135,11 +135,10 @@ public void prepareForStopping() {\n       stopping.set(true);\n    }\n \n-   //todo [anistor] parameter 'value' is never used\n-   private boolean shouldModifyIndexes(FlagAffectedCommand command, InvocationContext ctx, Object key, Object value) {\n+   private boolean shouldModifyIndexes(FlagAffectedCommand command, InvocationContext ctx, Object key) {\n       if (isManualIndexing) return false;\n \n-      if (key == null || distributionManager == null) {\n+      if (distributionManager == null || key == null) {\n          return true;\n       }\n \n"}}, {"oid": "8f609b1fe383bb0ac9deda1a13d5fbde67b0abf4", "url": "https://github.com/infinispan/infinispan/commit/8f609b1fe383bb0ac9deda1a13d5fbde67b0abf4", "message": "ISPN-11712 Remove explicit indexing enabled=\"true\" from xml configs", "committedDate": "2020-04-27T10:27:50Z", "type": "forcePushed"}, {"oid": "c263a719ed18addcc29720b7fd7a8abed92747c7", "url": "https://github.com/infinispan/infinispan/commit/c263a719ed18addcc29720b7fd7a8abed92747c7", "message": "ISPN-11712 Remove explicit indexing enabled=\"true\" from xml configs", "committedDate": "2020-04-28T14:35:49Z", "type": "forcePushed"}, {"oid": "262a2ea33f6845ade32063e2780ea1727b1ec492", "url": "https://github.com/infinispan/infinispan/commit/262a2ea33f6845ade32063e2780ea1727b1ec492", "message": "ISPN-11712 Remove explicit indexing enabled=\"true\" from xml configs", "committedDate": "2020-04-28T20:43:46Z", "type": "forcePushed"}, {"oid": "02c2ef108bded1655f183f82b12c4643e5d8f1fc", "url": "https://github.com/infinispan/infinispan/commit/02c2ef108bded1655f183f82b12c4643e5d8f1fc", "message": "ISPN-11712 Remove explicit indexing enabled=\"true\" from xml configs", "committedDate": "2020-04-29T06:57:51Z", "type": "forcePushed"}, {"oid": "458e14551688c37a127b14e3c46f2def7e2b7787", "url": "https://github.com/infinispan/infinispan/commit/458e14551688c37a127b14e3c46f2def7e2b7787", "message": "ISPN-11678 IndexModificationStrategy has become a degenerated enum after all the recent removals and can be removed entirely\n\n* there are only two strategies left: ALL, MANUAL", "committedDate": "2020-04-29T11:20:51Z", "type": "commit"}, {"oid": "3d299539f54e351e5a57784caddf8a9ba794c77c", "url": "https://github.com/infinispan/infinispan/commit/3d299539f54e351e5a57784caddf8a9ba794c77c", "message": "ISPN-11678 Remove IndexModificationStrategy\n\n* the behaviour of MANUAL/ALL can be moved to QueryInteceptor\n* also remove unused method ComponentRegistryUtils.getIndexInspector (we should always use @Inject if possible)", "committedDate": "2020-04-29T11:20:51Z", "type": "commit"}, {"oid": "adc9ce1ed8e6a76757640a9ba72e963ca8e8f43a", "url": "https://github.com/infinispan/infinispan/commit/adc9ce1ed8e6a76757640a9ba72e963ca8e8f43a", "message": "Validation for local indexing no longer needed in AbstractStoreConfigurationBuilder\n\n* this configuration case is not longer possible", "committedDate": "2020-04-29T11:20:51Z", "type": "commit"}, {"oid": "b1080964b0e479c00f034dac20e5401cc1db1e96", "url": "https://github.com/infinispan/infinispan/commit/b1080964b0e479c00f034dac20e5401cc1db1e96", "message": "ISPN-11715 Indexing autoConfig should not override the manual activation/deactivation of indexing", "committedDate": "2020-04-29T11:20:51Z", "type": "commit"}, {"oid": "cb216afdc09d1d4e7819b09c024b5a042edeeb74", "url": "https://github.com/infinispan/infinispan/commit/cb216afdc09d1d4e7819b09c024b5a042edeeb74", "message": "ISPN-11716 Setting the legacy index mode should not override the manual activation/deactivation of indexing\n\n* these two must be mutually exclusive and an exception should be thrown\n* remove unused IndexingConfigurationBuilder.index() package-local getter", "committedDate": "2020-04-29T11:20:51Z", "type": "commit"}, {"oid": "e2037c4788fcb792d55782c64ca3bca339518256", "url": "https://github.com/infinispan/infinispan/commit/e2037c4788fcb792d55782c64ca3bca339518256", "message": "ISPN-11712 Indexing should be enabled by default if the <indexing> element is present and the \"enabled\" attribute is missing\n\n* this cannot be fixed trivially by changing the xsd default", "committedDate": "2020-04-29T11:20:51Z", "type": "commit"}, {"oid": "4f1c2c403a487e0ef215df1c4c953e38416fa1e5", "url": "https://github.com/infinispan/infinispan/commit/4f1c2c403a487e0ef215df1c4c953e38416fa1e5", "message": "ISPN-11712 Remove explicit indexing enabled=\"true\" from xml configs", "committedDate": "2020-04-29T11:20:51Z", "type": "commit"}, {"oid": "4f1c2c403a487e0ef215df1c4c953e38416fa1e5", "url": "https://github.com/infinispan/infinispan/commit/4f1c2c403a487e0ef215df1c4c953e38416fa1e5", "message": "ISPN-11712 Remove explicit indexing enabled=\"true\" from xml configs", "committedDate": "2020-04-29T11:20:51Z", "type": "forcePushed"}]}