{"pr_number": 6037, "pr_title": "Simplify slightly the code", "pr_createdAt": "2020-04-17T13:00:45Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6037", "timeline": [{"oid": "c984320678bd1bdb8d6acd2a60beeba35eb86d61", "url": "https://github.com/ankidroid/Anki-Android/commit/c984320678bd1bdb8d6acd2a60beeba35eb86d61", "message": "Simplify slightly the code", "committedDate": "2020-04-17T13:26:49Z", "type": "forcePushed"}, {"oid": "6fe259aa79b155ce0102c523550cbdff19fe45eb", "url": "https://github.com/ankidroid/Anki-Android/commit/6fe259aa79b155ce0102c523550cbdff19fe45eb", "message": "Simplify slightly the code", "committedDate": "2020-04-17T14:01:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI5MTY4OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6037#discussion_r410291688", "bodyText": "I'm not sure about this one. It seems like a semantic difference unless I'm reading it wrong?\nIt used to be:\nCASE1 - if (cid != 0 && cid != -1) -> a review was undone\nCASE2 - else if (cid != -1) -> reset and get new card\nThat combination means \"reset and get new card\" will happen for all cid where cid is anything but 0 or -1\nNow it is\nCASE1 if (cid == 0) -> reset and get new card\nCASE2 if (cid != 1) -> a review was undone\nNow it is only doing a reset and get new card if cid == 0. That's a much smaller set of cid's that will reset and get new card. Is that valid?\nAm I missing something?", "author": "mikehardy", "createdAt": "2020-04-17T15:17:19Z", "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -865,16 +865,16 @@ private TaskData doInBackgroundUndo(TaskData... params) {\n             Card newCard = null;\n             try {\n                 long cid = col.undo();\n-                if (cid != 0 && cid != -1) {", "originalCommit": "0b8fdab38f3e6674f4c9c4502c22b6fb2d083c58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDMyNTUwOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6037#discussion_r410325508", "bodyText": "In the new case 2, you probably meant \"cid != -1\". instead of \"cid != 1\". You forgot a minus sign.\nEssentially, if you used to go to case 2, it means that cid == 0, since you know that it is not different from both 0 and -1.\nMathematically, the proof is long but easy.\n, \"reset and get a new card\" only occurred iff\n\"(not (cid != 0 && cid != -1)) and (cid !=-1)\" the first of the conjunction because it's in the \"else\" part.\niff\n\"(not cid !=0 || not cid !=-1) and (cid!= -1)\"\niff\n\"(cid ==0 || cid ==-1) && (cid !=-1)\"\niff\n\"(cid ==0 && cid !=-1) || (cid ==-1&&cid!=-1)\"\niff\n\"(cid ==0)|| false\"\niff\n\"cid ==0\", which means that it currently execute \"reset and get new card\"\nNow \"a review was undone\" occurs iff\n\"(not (cid ==0)) && cid !=-1)\"\niff\n\"cid !=0 && cid !=-1\"\niff \"a review was undone\" in the previous case\nSo both codes are equivalent, but the second one is quite more clear I believe", "author": "Arthur-Milchior", "createdAt": "2020-04-17T16:12:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI5MTY4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDcwNzQ0NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6037#discussion_r410707444", "bodyText": "@Arthur-Milchior you haven't responded to my comment here, so this is still waiting for feedback I think", "author": "mikehardy", "createdAt": "2020-04-18T14:49:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI5MTY4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDcxMjY3Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6037#discussion_r410712672", "bodyText": "Okay - I also went over and verified Collection.undo()\nif it returns > 0 it is a card id,  that means get that card, reset, start timer etc.\nif it returns -1 that is the specific value that says \"do not fetch a new card\" (it's commented in there)\nif it returns 0 that is either the default or there was a single card reset/reposition/bury\nTo me this is still confusing to read (why is '-1' important, and why are we only testing if it is not '-1'?) compared with how important it is. We shouldn't require mathematical proofs to know what we're doing\nCould you restructure it to explicitly handle the three possible cases with a little comment even though I think one of them ('-1') is a no-op?\nSomething like this terribly formatted java\nif (cid == 0) { /* card schedule change undone, reset and get new card */ Timber.d(\"Single card non-review change undo succeeded\"); }\nif (cid > 0) { /* card review undone, set up to review that card again */ Timber.d(\"Single card review undo succeeded\"); }\nif (cid < 0) { /* multi-card action undone, no action to take here */ Timber.d(\"Multi-select undo succeeded\"); }\nOr anything similar that explained clearly what a return value in each range in the full set of integers means. I recognize I'm asking for something different than was there originally but I think it's an improvement for future explorers in the area, my future self will appreciate it at least", "author": "mikehardy", "createdAt": "2020-04-18T15:31:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI5MTY4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDcxMzYwMg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6037#discussion_r410713602", "bodyText": "the proof is here to show that I do not change the code semantic. I do not intend to add it in the code. Because it was not clear to you in the previous code that the \"case 2\" was simply \"if cid=0\"\nIf it was needed in the actual code, it would be a great problem", "author": "Arthur-Milchior", "createdAt": "2020-04-18T15:39:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI5MTY4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDcyMzA1Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6037#discussion_r410723053", "bodyText": "The current state / your most recent change works for me, the comments+timbers now let me know right here all integer ranges are handled so as a developer coming in here I wouldn't be lost anymore. Thanks! Let me re-read it then I think yes it will be good to go", "author": "mikehardy", "createdAt": "2020-04-18T17:01:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI5MTY4OA=="}], "type": "inlineReview", "revised_code": {"commit": "f3c62bd28fe4ceb49d12ae48b6b97136abcc819e", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java b/AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java\nindex e89d6a86a..61bc00d78 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java\n\n@@ -874,7 +863,7 @@ public class CollectionTask extends BaseAsyncTask<CollectionTask.TaskData, Colle\n                     newCard.startTimer();\n                     col.reset();\n                     col.getSched().decrementCounts(newCard);\n-                    sHadCardQueue = true;\n+                    sched.deferReset();\n                 }\n                 // TODO: handle leech undoing properly\n                 publishProgress(new TaskData(newCard, 0));\n"}}, {"oid": "f3c62bd28fe4ceb49d12ae48b6b97136abcc819e", "url": "https://github.com/ankidroid/Anki-Android/commit/f3c62bd28fe4ceb49d12ae48b6b97136abcc819e", "message": "inverse if/else to remove indentation", "committedDate": "2020-04-18T11:08:30Z", "type": "forcePushed"}, {"oid": "ca60f1153bd6b2333ee870ffdc430d23617b845b", "url": "https://github.com/ankidroid/Anki-Android/commit/ca60f1153bd6b2333ee870ffdc430d23617b845b", "message": "inverse if/else to remove indentation", "committedDate": "2020-04-18T15:08:51Z", "type": "forcePushed"}, {"oid": "be0f5f9bec9c9a94791ec75783b96b37ba12ed02", "url": "https://github.com/ankidroid/Anki-Android/commit/be0f5f9bec9c9a94791ec75783b96b37ba12ed02", "message": "inverse if/else to remove indentation", "committedDate": "2020-04-18T15:12:13Z", "type": "forcePushed"}, {"oid": "5cb2248385103176f0a06b2cb46725d941cae873", "url": "https://github.com/ankidroid/Anki-Android/commit/5cb2248385103176f0a06b2cb46725d941cae873", "message": "inverse if/else to remove indentation", "committedDate": "2020-04-18T15:41:45Z", "type": "forcePushed"}, {"oid": "1b0da5cdaa03db06aad3a064dc35651b05103810", "url": "https://github.com/ankidroid/Anki-Android/commit/1b0da5cdaa03db06aad3a064dc35651b05103810", "message": "Simplify slightly the code", "committedDate": "2020-04-18T15:43:01Z", "type": "commit"}, {"oid": "a75f820b8985c0f700c3ee31d9561d4503ca2ca1", "url": "https://github.com/ankidroid/Anki-Android/commit/a75f820b8985c0f700c3ee31d9561d4503ca2ca1", "message": "inverse if/else to remove indentation", "committedDate": "2020-04-18T15:43:02Z", "type": "commit"}, {"oid": "a75f820b8985c0f700c3ee31d9561d4503ca2ca1", "url": "https://github.com/ankidroid/Anki-Android/commit/a75f820b8985c0f700c3ee31d9561d4503ca2ca1", "message": "inverse if/else to remove indentation", "committedDate": "2020-04-18T15:43:02Z", "type": "forcePushed"}]}