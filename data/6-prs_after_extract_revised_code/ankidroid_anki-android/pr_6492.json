{"pr_number": 6492, "pr_title": "Augment analytics so we can answer hardware questions", "pr_createdAt": "2020-06-18T03:50:56Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6492", "timeline": [{"oid": "e002d5ba7f3b9637e7ff3d16cc863f8e5d636c1b", "url": "https://github.com/ankidroid/Anki-Android/commit/e002d5ba7f3b9637e7ff3d16cc863f8e5d636c1b", "message": "Augment analytics so we can answer hardware questions\n\n- what hardware are we running on?\n- what operating system version?\n- what screen size?\n\nThis came about when I realized the analytics currently did not answer\nthe question, how many users are using Amazon devices?\n\nWhile I was in there I added the other hardware bits I thought could\nfocus development effort allocation", "committedDate": "2020-06-18T04:01:49Z", "type": "commit"}, {"oid": "e002d5ba7f3b9637e7ff3d16cc863f8e5d636c1b", "url": "https://github.com/ankidroid/Anki-Android/commit/e002d5ba7f3b9637e7ff3d16cc863f8e5d636c1b", "message": "Augment analytics so we can answer hardware questions\n\n- what hardware are we running on?\n- what operating system version?\n- what screen size?\n\nThis came about when I realized the analytics currently did not answer\nthe question, how many users are using Amazon devices?\n\nWhile I was in there I added the other hardware bits I thought could\nfocus development effort allocation", "committedDate": "2020-06-18T04:01:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA4MTQxMg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6492#discussion_r442081412", "bodyText": "These seem erroneous", "author": "david-allison-1", "createdAt": "2020-06-18T09:07:26Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/analytics/UsageAnalytics.java", "diffHunk": "@@ -221,9 +228,9 @@ public static void sendAnalyticsEvent(@NonNull String category, @NonNull String\n      * Send a detailed arbitrary analytics event, with noun/verb pairs and extra data if needed\n      *\n      * @param category the category of event, make your own but use a constant so reporting is good\n-     * @param action the action the user performed\n-     * @param value A value for the event, Integer.MIN_VALUE signifies caller shouldn't send the value\n-     * @param label A label for the event, may be null\n+     * @param action   the action the user performed", "originalCommit": "e002d5ba7f3b9637e7ff3d16cc863f8e5d636c1b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjIzMjg0Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6492#discussion_r442232843", "bodyText": "No, they are fine, they are just textually aligned now fixed-space-horizontal with the beginning of javadoc description for the longest argument 'category', that's what I mentioned before the whitespace-didn't-change thing. Visually it's pleasing. I wouldn't do it manually but the editor did it and it's nice to read when you're reading code so I left it.", "author": "mikehardy", "createdAt": "2020-06-18T13:39:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA4MTQxMg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA4MzQ5Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6492#discussion_r442083492", "bodyText": "Might want to look into how ACRA gets compatScreenHeightDp, possibly from Configuration", "author": "david-allison-1", "createdAt": "2020-06-18T09:10:44Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/analytics/UsageAnalytics.java", "diffHunk": "@@ -278,4 +285,46 @@ public static void sendAnalyticsException(@NonNull String description, boolean f\n         }\n         sAnalytics.exception().exceptionDescription(description).exceptionFatal(fatal).sendAsync();\n     }\n+\n+\n+    /**\n+     * An Android-specific device config generator. Without this it's \"Desktop\" and unknown for all hardware.\n+     * It is interesting to us what devices people use though (for instance: is Amazon Kindle support worth it?\n+     * Is anyone still using e-ink devices? How many people are on tablets? ChromeOS?)\n+     */\n+    private static class AndroidDefaultRequest extends DefaultRequest {\n+        private DefaultRequest setAndroidRequestParameters(Context context) {\n+\n+            // Are we running on really large screens or small screens or ?\n+            try {\n+                WindowManager wm = (WindowManager) context.getSystemService(Context.WINDOW_SERVICE);\n+                Display display = wm.getDefaultDisplay();\n+                Point size = new Point();\n+                display.getSize(size);\n+                this.screenResolution(size.x + \"x\" + size.y);", "originalCommit": "e002d5ba7f3b9637e7ff3d16cc863f8e5d636c1b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjIzODg0NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6492#discussion_r442238845", "bodyText": "They're getting fancier if they are going for Dp (device-independent pixels), I just wanted to collect raw screen size and this is the canonical method according to stack overflow. Confirmed that for real display size this is how they do it as well\nhttps://github.com/ACRA/acra/blob/f12bf576c8ac54fc80c96c04ea066ac4908b1dea/acra-core/src/main/java/org/acra/collector/DisplayManagerCollector.java#L140-L146", "author": "mikehardy", "createdAt": "2020-06-18T13:47:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA4MzQ5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "5420abcd848a2835133998fd0cb71333e095b9df", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/anki/analytics/UsageAnalytics.java b/AnkiDroid/src/main/java/com/ichi2/anki/analytics/UsageAnalytics.java\nindex f9d098847..85e931832 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/anki/analytics/UsageAnalytics.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/anki/analytics/UsageAnalytics.java\n\n@@ -295,7 +295,7 @@ public class UsageAnalytics {\n     private static class AndroidDefaultRequest extends DefaultRequest {\n         private DefaultRequest setAndroidRequestParameters(Context context) {\n \n-            // Are we running on really large screens or small screens or ?\n+            // Are we running on really large screens or small screens? Send raw screen size\n             try {\n                 WindowManager wm = (WindowManager) context.getSystemService(Context.WINDOW_SERVICE);\n                 Display display = wm.getDefaultDisplay();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA4NTM3NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6492#discussion_r442085374", "bodyText": "Got this confused with BuildConfig.DEBUG\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        this.customDimension(1, Build.VERSION.RELEASE); // systemVersion\n          \n          \n            \n                        this.customDimension(1, Build.VERSION.RELEASE); // readable version: \"2.12alpha9\"", "author": "david-allison-1", "createdAt": "2020-06-18T09:13:50Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/analytics/UsageAnalytics.java", "diffHunk": "@@ -278,4 +285,46 @@ public static void sendAnalyticsException(@NonNull String description, boolean f\n         }\n         sAnalytics.exception().exceptionDescription(description).exceptionFatal(fatal).sendAsync();\n     }\n+\n+\n+    /**\n+     * An Android-specific device config generator. Without this it's \"Desktop\" and unknown for all hardware.\n+     * It is interesting to us what devices people use though (for instance: is Amazon Kindle support worth it?\n+     * Is anyone still using e-ink devices? How many people are on tablets? ChromeOS?)\n+     */\n+    private static class AndroidDefaultRequest extends DefaultRequest {\n+        private DefaultRequest setAndroidRequestParameters(Context context) {\n+\n+            // Are we running on really large screens or small screens or ?\n+            try {\n+                WindowManager wm = (WindowManager) context.getSystemService(Context.WINDOW_SERVICE);\n+                Display display = wm.getDefaultDisplay();\n+                Point size = new Point();\n+                display.getSize(size);\n+                this.screenResolution(size.x + \"x\" + size.y);\n+            } catch (RuntimeException e) {\n+                // nothing much to do here, it means we couldn't get WindowManager\n+            }\n+\n+            // We can have up to 20 of these - there might be other things we want to know\n+            // but simply seeing what hardware we are running on should be useful\n+            this.customDimension(1, Build.VERSION.RELEASE); // systemVersion", "originalCommit": "e002d5ba7f3b9637e7ff3d16cc863f8e5d636c1b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjIzNDQ1NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6492#discussion_r442234455", "bodyText": "No, VERSION.RELEASE is systemVersion, like \"10\" for Android 10. After maintaining react-native-device-info for 2 years, I know my build constants ;-)", "author": "mikehardy", "createdAt": "2020-06-18T13:41:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA4NTM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjI1MzMwMA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6492#discussion_r442253300", "bodyText": "\ud83e\udd26 Definitely needed those comments then, thanks!", "author": "david-allison-1", "createdAt": "2020-06-18T14:06:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA4NTM3NA=="}], "type": "inlineReview", "revised_code": {"commit": "5420abcd848a2835133998fd0cb71333e095b9df", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/anki/analytics/UsageAnalytics.java b/AnkiDroid/src/main/java/com/ichi2/anki/analytics/UsageAnalytics.java\nindex f9d098847..85e931832 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/anki/analytics/UsageAnalytics.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/anki/analytics/UsageAnalytics.java\n\n@@ -295,7 +295,7 @@ public class UsageAnalytics {\n     private static class AndroidDefaultRequest extends DefaultRequest {\n         private DefaultRequest setAndroidRequestParameters(Context context) {\n \n-            // Are we running on really large screens or small screens or ?\n+            // Are we running on really large screens or small screens? Send raw screen size\n             try {\n                 WindowManager wm = (WindowManager) context.getSystemService(Context.WINDOW_SERVICE);\n                 Display display = wm.getDefaultDisplay();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA4NzgyNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6492#discussion_r442087825", "bodyText": "Just flagging; I don't think this will trigger #5794", "author": "david-allison-1", "createdAt": "2020-06-18T09:17:48Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/analytics/UsageAnalytics.java", "diffHunk": "@@ -278,4 +285,46 @@ public static void sendAnalyticsException(@NonNull String description, boolean f\n         }\n         sAnalytics.exception().exceptionDescription(description).exceptionFatal(fatal).sendAsync();\n     }\n+\n+\n+    /**\n+     * An Android-specific device config generator. Without this it's \"Desktop\" and unknown for all hardware.\n+     * It is interesting to us what devices people use though (for instance: is Amazon Kindle support worth it?\n+     * Is anyone still using e-ink devices? How many people are on tablets? ChromeOS?)\n+     */\n+    private static class AndroidDefaultRequest extends DefaultRequest {\n+        private DefaultRequest setAndroidRequestParameters(Context context) {\n+\n+            // Are we running on really large screens or small screens or ?\n+            try {\n+                WindowManager wm = (WindowManager) context.getSystemService(Context.WINDOW_SERVICE);\n+                Display display = wm.getDefaultDisplay();\n+                Point size = new Point();\n+                display.getSize(size);\n+                this.screenResolution(size.x + \"x\" + size.y);\n+            } catch (RuntimeException e) {\n+                // nothing much to do here, it means we couldn't get WindowManager\n+            }\n+\n+            // We can have up to 20 of these - there might be other things we want to know\n+            // but simply seeing what hardware we are running on should be useful\n+            this.customDimension(1, Build.VERSION.RELEASE); // systemVersion\n+            this.customDimension(2, Build.BRAND); // brand\n+            this.customDimension(3, Build.MODEL); // model\n+            this.customDimension(4, Build.BOARD); // deviceId\n+\n+            // This is important for google to auto-fingerprint us for default reporting\n+            try {\n+                if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.JELLY_BEAN_MR1) {\n+                    this.userAgent(WebSettings.getDefaultUserAgent(context));", "originalCommit": "e002d5ba7f3b9637e7ff3d16cc863f8e5d636c1b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjIzNTMzMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6492#discussion_r442235331", "bodyText": "I/we (at react-native-device-info) catch RuntimeException on purpose so it never crashes. Nearly 10 million downloads on that piece of code with no reported crashes, I'm comfortable with this block", "author": "mikehardy", "createdAt": "2020-06-18T13:42:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA4NzgyNQ=="}], "type": "inlineReview", "revised_code": {"commit": "5420abcd848a2835133998fd0cb71333e095b9df", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/anki/analytics/UsageAnalytics.java b/AnkiDroid/src/main/java/com/ichi2/anki/analytics/UsageAnalytics.java\nindex f9d098847..85e931832 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/anki/analytics/UsageAnalytics.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/anki/analytics/UsageAnalytics.java\n\n@@ -295,7 +295,7 @@ public class UsageAnalytics {\n     private static class AndroidDefaultRequest extends DefaultRequest {\n         private DefaultRequest setAndroidRequestParameters(Context context) {\n \n-            // Are we running on really large screens or small screens or ?\n+            // Are we running on really large screens or small screens? Send raw screen size\n             try {\n                 WindowManager wm = (WindowManager) context.getSystemService(Context.WINDOW_SERVICE);\n                 Display display = wm.getDefaultDisplay();\n"}}, {"oid": "5420abcd848a2835133998fd0cb71333e095b9df", "url": "https://github.com/ankidroid/Anki-Android/commit/5420abcd848a2835133998fd0cb71333e095b9df", "message": "NF: extended commentary on android-specific analytics values", "committedDate": "2020-06-18T14:00:02Z", "type": "commit"}]}