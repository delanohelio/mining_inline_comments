{"pr_number": 6453, "pr_title": "Strip spaces in deck name", "pr_createdAt": "2020-06-13T12:15:04Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6453", "timeline": [{"oid": "8315849aee4669996e25a5e95b345a8834c87c1d", "url": "https://github.com/ankidroid/Anki-Android/commit/8315849aee4669996e25a5e95b345a8834c87c1d", "message": "Strip spaces in deck name\n\nStarting with 2.1.28, anki strip deck's name. I imitate it. I don't\nuse the same code as they do it in rust and we don't have rust yet.\n\nHowever, since this create compatibility problems between anki and\nankidroid during some sync ( see\nhttps://forums.ankiweb.net/t/decks-with-trailing-spaces/89/4?u=arthurmilchior\n) I believe it should be considered without waiting for\nrust. Especially since it's a small change in term of code.\n\nThe spaces are stripped in two places: when checking for deck\nintegrity, and when changing deck name (i.e. through `id` which\ncreates deck, and through `rename`). No need currently to use it in\nbyName, since it is only called with names already stripped and with\nthe constant \"Custom study session\".", "committedDate": "2020-06-13T12:30:26Z", "type": "commit"}, {"oid": "8315849aee4669996e25a5e95b345a8834c87c1d", "url": "https://github.com/ankidroid/Anki-Android/commit/8315849aee4669996e25a5e95b345a8834c87c1d", "message": "Strip spaces in deck name\n\nStarting with 2.1.28, anki strip deck's name. I imitate it. I don't\nuse the same code as they do it in rust and we don't have rust yet.\n\nHowever, since this create compatibility problems between anki and\nankidroid during some sync ( see\nhttps://forums.ankiweb.net/t/decks-with-trailing-spaces/89/4?u=arthurmilchior\n) I believe it should be considered without waiting for\nrust. Especially since it's a small change in term of code.\n\nThe spaces are stripped in two places: when checking for deck\nintegrity, and when changing deck name (i.e. through `id` which\ncreates deck, and through `rename`). No need currently to use it in\nbyName, since it is only called with names already stripped and with\nthe constant \"Custom study session\".", "committedDate": "2020-06-13T12:30:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTc2MzY0MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6453#discussion_r439763641", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                /** With .28, anki started strips whitespace of deck name.\n          \n          \n            \n                /** With 2.1.28, anki started strips whitespace of deck name.", "author": "mikehardy", "createdAt": "2020-06-13T19:36:27Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java", "diffHunk": "@@ -777,6 +779,27 @@ private void maybeAddToActive() {\n                 \"select id from cards where did in \" + Utils.ids2str(Utils.arrayList2array(dids)), 0));\n     }\n \n+\n+    private static final Pattern spaceAroundSeparator = Pattern.compile(\" *:: *\");\n+    private static String strip(String deckName) {\n+        return spaceAroundSeparator.matcher(deckName.trim()).replaceAll( \"::\");\n+    }\n+\n+    /** With .28, anki started strips whitespace of deck name.", "originalCommit": "8315849aee4669996e25a5e95b345a8834c87c1d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "456b8a9036adde0def848bad303ef06e5a40c5df", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java b/AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java\nindex 61170614e..bc24bdf50 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java\n\n@@ -785,7 +785,7 @@ public class Decks {\n         return spaceAroundSeparator.matcher(deckName.trim()).replaceAll( \"::\");\n     }\n \n-    /** With .28, anki started strips whitespace of deck name.\n+    /** With 2.1.28, anki started strips whitespace of deck name.\n      * This method is here for compatibility while we wait for rust.\n      * It should be executed before other methods, because both \"FOO \" and \"FOO\" will be renamed to the same name,\n      * and so this will need to be renamed by _checkDeckTree.*/\n"}}, {"oid": "456b8a9036adde0def848bad303ef06e5a40c5df", "url": "https://github.com/ankidroid/Anki-Android/commit/456b8a9036adde0def848bad303ef06e5a40c5df", "message": "Update AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java\n\nCo-authored-by: Mike Hardy <github@mikehardy.net>", "committedDate": "2020-06-13T20:23:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM3NDk5Nw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6453#discussion_r441374997", "bodyText": "sSpaceAroundSeparator", "author": "david-allison-1", "createdAt": "2020-06-17T08:31:48Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java", "diffHunk": "@@ -777,6 +779,27 @@ private void maybeAddToActive() {\n                 \"select id from cards where did in \" + Utils.ids2str(Utils.arrayList2array(dids)), 0));\n     }\n \n+\n+    private static final Pattern spaceAroundSeparator = Pattern.compile(\" *:: *\");", "originalCommit": "456b8a9036adde0def848bad303ef06e5a40c5df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM3NTM1Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6453#discussion_r441375353", "bodyText": "Is this the same pattern as the one that Anki uses? Will have have problems such as the triple-colon that you previously solved?", "author": "david-allison-1", "createdAt": "2020-06-17T08:32:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM3NDk5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQwMzMxMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6453#discussion_r441403311", "bodyText": "No triple column problem. The 3rd columnis the first letter of the deck nme, so no reason to strip ant space.\nI have not found where this change is made in rust, so can't tell whether this regexp is used", "author": "Arthur-Milchior", "createdAt": "2020-06-17T09:16:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM3NDk5Nw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM3NjAxOQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6453#discussion_r441376019", "bodyText": "Have you tested this on decks with duplicate names and different spacing?\nHave you tested this on decks which would normalise to the same name: \"Foo\" and \" FOO \"\nCan the user currently call their deck \"\", or \" \", would this generate an invalid name? What happens in Anki Desktop?", "author": "david-allison-1", "createdAt": "2020-06-17T08:33:29Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java", "diffHunk": "@@ -777,6 +779,27 @@ private void maybeAddToActive() {\n                 \"select id from cards where did in \" + Utils.ids2str(Utils.arrayList2array(dids)), 0));\n     }\n \n+\n+    private static final Pattern spaceAroundSeparator = Pattern.compile(\" *:: *\");\n+    private static String strip(String deckName) {\n+        return spaceAroundSeparator.matcher(deckName.trim()).replaceAll( \"::\");\n+    }\n+\n+    /** With 2.1.28, anki started strips whitespace of deck name.\n+     * This method is here for compatibility while we wait for rust.\n+     * It should be executed before other methods, because both \"FOO \" and \"FOO\" will be renamed to the same name,\n+     * and so this will need to be renamed by _checkDeckTree.*/\n+    private void _removeSpaces () {\n+        for (JSONObject deck: all()) {", "originalCommit": "456b8a9036adde0def848bad303ef06e5a40c5df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQwNDQ1Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/6453#discussion_r441404456", "bodyText": "Duplicate name and different spacing was mentionned above. I don t know whether \" \" used to be valid, im pretty sure that \"\" was already not valid", "author": "Arthur-Milchior", "createdAt": "2020-06-17T09:18:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM3NjAxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQxNTgyNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6453#discussion_r441415825", "bodyText": "Just checked: \"FOO   \" is detected to be the same deck as \"foo\" so can't be created. Creating a deck is just ignored. Renaming is rejected with a message stating that this deck already exists.\nI just discovered that ankidroid accepts to create the deck \"\". (and that \"   \" is renamed as \"\", but I was expecting that)", "author": "Arthur-Milchior", "createdAt": "2020-06-17T09:36:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM3NjAxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQzNTYzNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6453#discussion_r441435635", "bodyText": "\"\" is rejected upstream, while \" \" is accepted and then renamed to \"blank\". I corrected it in ankitects/anki#669", "author": "Arthur-Milchior", "createdAt": "2020-06-17T10:09:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM3NjAxOQ=="}], "type": "inlineReview", "revised_code": null}]}