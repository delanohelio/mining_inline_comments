{"pr_number": 7005, "pr_title": "NF: Mock Task manager", "pr_createdAt": "2020-08-30T21:45:31Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/7005", "timeline": [{"oid": "c2ee96822852dc89f297265ef62268e4cdb1dbbb", "url": "https://github.com/ankidroid/Anki-Android/commit/c2ee96822852dc89f297265ef62268e4cdb1dbbb", "message": "NF: remove wait for task", "committedDate": "2020-08-30T21:47:02Z", "type": "forcePushed"}, {"oid": "2121f1bfc86b070f68582bd7052856b05f5da8a8", "url": "https://github.com/ankidroid/Anki-Android/commit/2121f1bfc86b070f68582bd7052856b05f5da8a8", "message": "NF: remove wait for task", "committedDate": "2020-08-30T22:40:35Z", "type": "forcePushed"}, {"oid": "e8d5921aa562af577b749c2d08491a56859598b8", "url": "https://github.com/ankidroid/Anki-Android/commit/e8d5921aa562af577b749c2d08491a56859598b8", "message": "NF: remove wait for task", "committedDate": "2020-08-30T22:54:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTgyODg4Nw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#discussion_r479828887", "bodyText": "There's semantic meaning in the previous name (admittedly the timeout variable can go)\nI feel the new code is harder to reason about", "author": "david-allison-1", "createdAt": "2020-08-30T23:22:49Z", "path": "AnkiDroid/src/test/java/com/ichi2/libanki/sched/AbstractSchedTest.java", "diffHunk": "@@ -96,7 +96,7 @@ public void testUndoResetsCardCountsToCorrectValue() throws InterruptedException\n \n         sched.answerCard(cardBeforeUndo, EASE_3);\n \n-        waitForTask(UNDO, 5000);\n+        getCol().getTaskManager().launchCollectionTask(UNDO);", "originalCommit": "ab66529d7fdc0b43ee695ef61fd4e25c9597f46c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "61bf4686d5bb2eaf4e66174f443a682c5cfb3221", "chunk": "diff --git a/AnkiDroid/src/test/java/com/ichi2/libanki/sched/AbstractSchedTest.java b/AnkiDroid/src/test/java/com/ichi2/libanki/sched/AbstractSchedTest.java\nindex a6cad219f..3d47e2633 100644\n--- a/AnkiDroid/src/test/java/com/ichi2/libanki/sched/AbstractSchedTest.java\n+++ b/AnkiDroid/src/test/java/com/ichi2/libanki/sched/AbstractSchedTest.java\n\n@@ -85,20 +85,21 @@ public class AbstractSchedTest extends RobolectricTest {\n         // #6587\n         addNoteUsingBasicModel(\"Hello\", \"World\");\n \n-        AbstractSched sched = getCol().getSched();\n-        sched.reset();\n+        Collection col = getCol();\n+        AbstractSched sched = col.getSched();\n+        col.reset();\n \n         Card cardBeforeUndo = sched.getCard();\n-        int[] countsBeforeUndo = sched.counts();\n+        Counts countsBeforeUndo = sched.counts();\n         // Not shown in the UI, but there is a state where the card has been removed from the queue, but not answered\n         // where the counts are decremented.\n-        assertThat(countsBeforeUndo, is(new int[] { 0, 0, 0 }));\n+        assertThat(countsBeforeUndo, is(new Counts(0, 0, 0)));\n \n         sched.answerCard(cardBeforeUndo, EASE_3);\n \n-        getCol().getTaskManager().launchCollectionTask(UNDO);\n+        waitFortask(new CollectionTask.Undo(), 5000);\n \n-        int[] countsAfterUndo = sched.counts();\n+        Counts countsAfterUndo = sched.counts();\n \n         assertThat(\"Counts after an undo should be the same as before an undo\", countsAfterUndo, is(countsBeforeUndo));\n     }\n"}}, {"oid": "fe25d963b35999947b7bc3925023b7f2bda9d28d", "url": "https://github.com/ankidroid/Anki-Android/commit/fe25d963b35999947b7bc3925023b7f2bda9d28d", "message": "NF: remove advanceRobolectricLooper except for assume", "committedDate": "2020-08-31T02:15:14Z", "type": "forcePushed"}, {"oid": "0a412903643a2060bd3e504ed1990cd0093527c0", "url": "https://github.com/ankidroid/Anki-Android/commit/0a412903643a2060bd3e504ed1990cd0093527c0", "message": "NF: remove advanceRobolectricLooper except for assume", "committedDate": "2020-08-31T02:23:51Z", "type": "forcePushed"}, {"oid": "66358132e0f30c674dddb937b318bca31e5af136", "url": "https://github.com/ankidroid/Anki-Android/commit/66358132e0f30c674dddb937b318bca31e5af136", "message": "NF: remove advanceRobolectricLooper except for assume", "committedDate": "2020-09-07T17:33:38Z", "type": "forcePushed"}, {"oid": "7918cc27b66c06b683974d9bf1540adea5e5c086", "url": "https://github.com/ankidroid/Anki-Android/commit/7918cc27b66c06b683974d9bf1540adea5e5c086", "message": "NF: remove advanceRobolectricLooper except for assume", "committedDate": "2020-09-07T17:37:27Z", "type": "forcePushed"}, {"oid": "61bf4686d5bb2eaf4e66174f443a682c5cfb3221", "url": "https://github.com/ankidroid/Anki-Android/commit/61bf4686d5bb2eaf4e66174f443a682c5cfb3221", "message": "NF: Allow tests to execute everything in foreground", "committedDate": "2021-01-14T10:33:41Z", "type": "forcePushed"}, {"oid": "0ca54af1ae66e3de93fef9a303db3b5d9c3d2ca3", "url": "https://github.com/ankidroid/Anki-Android/commit/0ca54af1ae66e3de93fef9a303db3b5d9c3d2ca3", "message": "NF: Allow tests to execute everything in foreground", "committedDate": "2021-01-28T20:47:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzYzNjc1NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#discussion_r603636754", "bodyText": "Let's keep the TaskManager methods static, and call .getManager() inside the TaskManager methods, this will reduce the PR down to what matters", "author": "david-allison-1", "createdAt": "2021-03-29T21:49:43Z", "path": "AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java", "diffHunk": "@@ -795,9 +795,9 @@ public void testQueryNextCard() {\n         for(int i = 0; i < 10; i++) {//minimizing fails, when sched.reset() randomly chooses between multiple cards\n             col.reset();\n             nextCard = sched.getCard();\n-            TaskManager.waitToFinish();\n+            TaskManager.getManager().waitToFinish();", "originalCommit": "0ca54af1ae66e3de93fef9a303db3b5d9c3d2ca3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "088b2195108d017da2de43ddaaedb9e0b15b47b3", "chunk": "diff --git a/AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java b/AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java\nindex 154eef2f1..0f5b20ad0 100644\n--- a/AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java\n+++ b/AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java\n\n@@ -795,9 +795,9 @@ public class ContentProviderTest extends InstrumentedTest {\n         for(int i = 0; i < 10; i++) {//minimizing fails, when sched.reset() randomly chooses between multiple cards\n             col.reset();\n             nextCard = sched.getCard();\n-            TaskManager.getManager().waitToFinish();\n+            TaskManager.waitToFinish();\n             if(nextCard != null && nextCard.note().getId() == noteID && nextCard.getOrd() == cardOrd)break;\n-            TaskManager.getManager().waitToFinish();\n+            TaskManager.waitToFinish();\n \n         }\n         assertNotNull(\"Check that there actually is a next scheduled card\", nextCard);\n"}}, {"oid": "088b2195108d017da2de43ddaaedb9e0b15b47b3", "url": "https://github.com/ankidroid/Anki-Android/commit/088b2195108d017da2de43ddaaedb9e0b15b47b3", "message": "NF: Allow tests to execute everything in foreground", "committedDate": "2021-03-30T03:37:15Z", "type": "forcePushed"}, {"oid": "4e08332054997be2cd57adcd8bfcb24167e8400a", "url": "https://github.com/ankidroid/Anki-Android/commit/4e08332054997be2cd57adcd8bfcb24167e8400a", "message": "NF: Allow tests to execute everything in foreground", "committedDate": "2021-03-30T04:04:14Z", "type": "forcePushed"}, {"oid": "84281089ef7a64bbf7fe7d4626c5647e064bbcb2", "url": "https://github.com/ankidroid/Anki-Android/commit/84281089ef7a64bbf7fe7d4626c5647e064bbcb2", "message": "NF: Allow tests to execute everything in foreground", "committedDate": "2021-03-30T04:10:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDA3MzQ1Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#discussion_r604073453", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class SingleTaskManager extends TaskManager{\n          \n          \n            \n            public class SingleTaskManager extends TaskManager {", "author": "david-allison-1", "createdAt": "2021-03-30T13:00:01Z", "path": "AnkiDroid/src/main/java/com/ichi2/async/SingleTaskManager.java", "diffHunk": "@@ -0,0 +1,166 @@\n+package com.ichi2.async;\n+\n+import android.os.AsyncTask;\n+\n+import com.ichi2.utils.ThreadUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import timber.log.Timber;\n+\n+public class SingleTaskManager extends TaskManager{", "originalCommit": "84281089ef7a64bbf7fe7d4626c5647e064bbcb2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "81dc984585ce8b28b6d8ac1d825afb595bf8dfff", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/async/SingleTaskManager.java b/AnkiDroid/src/main/java/com/ichi2/async/SingleTaskManager.java\nindex c5fda8a4f..2183ffe6e 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/async/SingleTaskManager.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/async/SingleTaskManager.java\n\n@@ -14,7 +14,7 @@ import androidx.annotation.NonNull;\n import androidx.annotation.Nullable;\n import timber.log.Timber;\n \n-public class SingleTaskManager extends TaskManager{\n+public class SingleTaskManager extends TaskManager {\n \n     /**\n      * Tasks which are running or waiting to run.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDA3NTI3NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#discussion_r604075274", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void noBackground() {\n          \n          \n            \n                public void runTasksInForeground() {", "author": "david-allison-1", "createdAt": "2021-03-30T13:02:22Z", "path": "AnkiDroid/src/test/java/com/ichi2/anki/RobolectricTest.java", "diffHunk": "@@ -167,10 +172,31 @@ public void tearDown() {\n             //called on each AnkiDroidApp.onCreate(), and spams the build\n             //there is no onDestroy(), so call it here.\n             Timber.uprootAll();\n+\n+            TaskManager.setTaskManager(new SingleTaskManager());\n         }\n     }\n \n \n+    /**\n+     * Ensure that each task in backgrounds are executed immediately instead of being queued.\n+     * This may help debugging test without requiring to guess where `advanceRobolectricLooper` are needed.\n+     */\n+    public void noBackground() {", "originalCommit": "84281089ef7a64bbf7fe7d4626c5647e064bbcb2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "81dc984585ce8b28b6d8ac1d825afb595bf8dfff", "chunk": "diff --git a/AnkiDroid/src/test/java/com/ichi2/anki/RobolectricTest.java b/AnkiDroid/src/test/java/com/ichi2/anki/RobolectricTest.java\nindex 6a10dcaa3..5e1ec0b78 100644\n--- a/AnkiDroid/src/test/java/com/ichi2/anki/RobolectricTest.java\n+++ b/AnkiDroid/src/test/java/com/ichi2/anki/RobolectricTest.java\n\n@@ -173,7 +173,7 @@ public class RobolectricTest implements CollectionGetter {\n             //there is no onDestroy(), so call it here.\n             Timber.uprootAll();\n \n-            TaskManager.setTaskManager(new SingleTaskManager());\n+            background();\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDA3NTQ0MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#discussion_r604075440", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void background() {\n          \n          \n            \n                public void runTasksInBackground() {", "author": "david-allison-1", "createdAt": "2021-03-30T13:02:33Z", "path": "AnkiDroid/src/test/java/com/ichi2/anki/RobolectricTest.java", "diffHunk": "@@ -167,10 +172,31 @@ public void tearDown() {\n             //called on each AnkiDroidApp.onCreate(), and spams the build\n             //there is no onDestroy(), so call it here.\n             Timber.uprootAll();\n+\n+            TaskManager.setTaskManager(new SingleTaskManager());\n         }\n     }\n \n \n+    /**\n+     * Ensure that each task in backgrounds are executed immediately instead of being queued.\n+     * This may help debugging test without requiring to guess where `advanceRobolectricLooper` are needed.\n+     */\n+    public void noBackground() {\n+        TaskManager.setTaskManager(new ForegroundTaskManager(this));\n+        mBackground = false;\n+    }\n+\n+\n+    /**\n+     * Set back the standard background process\n+     */\n+    public void background() {", "originalCommit": "84281089ef7a64bbf7fe7d4626c5647e064bbcb2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNjM5NDMzNA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#discussion_r606394334", "bodyText": "David's suggestion here is good, the API should have mirror naming if it has mirror effect I think", "author": "mikehardy", "createdAt": "2021-04-02T19:54:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDA3NTQ0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNjQwNjMyNw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#discussion_r606406327", "bodyText": "Sorry, I missed it", "author": "Arthur-Milchior", "createdAt": "2021-04-02T20:23:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDA3NTQ0MA=="}], "type": "inlineReview", "revised_code": {"commit": "81dc984585ce8b28b6d8ac1d825afb595bf8dfff", "chunk": "diff --git a/AnkiDroid/src/test/java/com/ichi2/anki/RobolectricTest.java b/AnkiDroid/src/test/java/com/ichi2/anki/RobolectricTest.java\nindex 6a10dcaa3..5e1ec0b78 100644\n--- a/AnkiDroid/src/test/java/com/ichi2/anki/RobolectricTest.java\n+++ b/AnkiDroid/src/test/java/com/ichi2/anki/RobolectricTest.java\n\n@@ -173,7 +173,7 @@ public class RobolectricTest implements CollectionGetter {\n             //there is no onDestroy(), so call it here.\n             Timber.uprootAll();\n \n-            TaskManager.setTaskManager(new SingleTaskManager());\n+            background();\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDA3NTk1Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#discussion_r604075956", "bodyText": "Shouldn't this be a call to background, or else the local variable won't be set", "author": "david-allison-1", "createdAt": "2021-03-30T13:03:16Z", "path": "AnkiDroid/src/test/java/com/ichi2/anki/RobolectricTest.java", "diffHunk": "@@ -167,10 +172,31 @@ public void tearDown() {\n             //called on each AnkiDroidApp.onCreate(), and spams the build\n             //there is no onDestroy(), so call it here.\n             Timber.uprootAll();\n+\n+            TaskManager.setTaskManager(new SingleTaskManager());", "originalCommit": "84281089ef7a64bbf7fe7d4626c5647e064bbcb2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDUyNjA0Nw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#discussion_r604526047", "bodyText": "Nice catch", "author": "Arthur-Milchior", "createdAt": "2021-03-31T01:03:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDA3NTk1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "81dc984585ce8b28b6d8ac1d825afb595bf8dfff", "chunk": "diff --git a/AnkiDroid/src/test/java/com/ichi2/anki/RobolectricTest.java b/AnkiDroid/src/test/java/com/ichi2/anki/RobolectricTest.java\nindex 6a10dcaa3..5e1ec0b78 100644\n--- a/AnkiDroid/src/test/java/com/ichi2/anki/RobolectricTest.java\n+++ b/AnkiDroid/src/test/java/com/ichi2/anki/RobolectricTest.java\n\n@@ -173,7 +173,7 @@ public class RobolectricTest implements CollectionGetter {\n             //there is no onDestroy(), so call it here.\n             Timber.uprootAll();\n \n-            TaskManager.setTaskManager(new SingleTaskManager());\n+            background();\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDA3Njc1NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#discussion_r604076755", "bodyText": "Is it possible to add a warning to exceptions thrown here (as Robolectric does) to warn that a new failure may have something to do with running in the foreground", "author": "david-allison-1", "createdAt": "2021-03-30T13:04:17Z", "path": "AnkiDroid/src/test/java/com/ichi2/async/ForegroundTaskManager.java", "diffHunk": "@@ -0,0 +1,104 @@\n+package com.ichi2.async;\n+\n+import com.ichi2.libanki.CollectionGetter;\n+import com.ichi2.libanki.Collection;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+\n+public class ForegroundTaskManager extends TaskManager {\n+    private final CollectionGetter mColGetter;\n+\n+\n+    public ForegroundTaskManager(CollectionGetter colGetter) {\n+        mColGetter = colGetter;\n+    }\n+\n+    @Override\n+    protected boolean removeTaskConcrete(CollectionTask task) {\n+        return true;\n+    }\n+\n+\n+    @Override\n+    public <ProgressBackground, ResultBackground> CollectionTask<ProgressBackground, ProgressBackground, ResultBackground, ResultBackground> launchCollectionTaskConcrete(CollectionTask.Task<ProgressBackground, ResultBackground> task) {\n+        return launchCollectionTaskConcrete(task, null);\n+    }\n+\n+\n+    @Override\n+    protected void setLatestInstanceConcrete(CollectionTask task) {\n+    }\n+\n+\n+    @Override\n+    public <ProgressListener, ProgressBackground extends ProgressListener, ResultListener, ResultBackground extends ResultListener> CollectionTask<ProgressListener, ProgressBackground, ResultListener, ResultBackground> launchCollectionTaskConcrete(\n+            @NonNull CollectionTask.Task<ProgressBackground, ResultBackground> task,\n+            @Nullable TaskListener<ProgressListener, ResultListener> listener) {\n+        if (listener != null) {\n+            listener.onPreExecute();\n+        }\n+        ResultBackground res = task.task(mColGetter.getCol(), new MockTaskManager<>(listener));", "originalCommit": "84281089ef7a64bbf7fe7d4626c5647e064bbcb2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDUyNzEzMA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#discussion_r604527130", "bodyText": "Done. Not sure about the exact message", "author": "Arthur-Milchior", "createdAt": "2021-03-31T01:07:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDA3Njc1NQ=="}], "type": "inlineReview", "revised_code": {"commit": "81dc984585ce8b28b6d8ac1d825afb595bf8dfff", "chunk": "diff --git a/AnkiDroid/src/test/java/com/ichi2/async/ForegroundTaskManager.java b/AnkiDroid/src/test/java/com/ichi2/async/ForegroundTaskManager.java\nindex 1ec744a46..afe3e7819 100644\n--- a/AnkiDroid/src/test/java/com/ichi2/async/ForegroundTaskManager.java\n+++ b/AnkiDroid/src/test/java/com/ichi2/async/ForegroundTaskManager.java\n\n@@ -5,6 +5,7 @@ import com.ichi2.libanki.Collection;\n \n import androidx.annotation.NonNull;\n import androidx.annotation.Nullable;\n+import timber.log.Timber;\n \n public class ForegroundTaskManager extends TaskManager {\n     private final CollectionGetter mColGetter;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDA4MzM0MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#discussion_r604083341", "bodyText": "\u26a0\ufe0f This is calling the static launchCollectionTask", "author": "david-allison-1", "createdAt": "2021-03-30T13:13:01Z", "path": "AnkiDroid/src/main/java/com/ichi2/async/TaskManager.java", "diffHunk": "@@ -50,11 +48,18 @@ protected static void setLatestInstance(CollectionTask task) {\n      * @param task the task to execute\n      * @return the newly created task\n      */\n+    protected static void setLatestInstance(CollectionTask task) {\n+        sTaskManager.setLatestInstanceConcrete(task);\n+    }\n+\n     public static <ProgressBackground, ResultBackground> CollectionTask<ProgressBackground, ProgressBackground, ResultBackground, ResultBackground> launchCollectionTask(CollectionTask.Task<ProgressBackground, ResultBackground> task) {\n-        return launchCollectionTask(task, null);\n+        return sTaskManager.launchCollectionTask(task);", "originalCommit": "84281089ef7a64bbf7fe7d4626c5647e064bbcb2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b78b85cd58f6b8e698ab597b46737c673ee07e9d", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/async/TaskManager.java b/AnkiDroid/src/main/java/com/ichi2/async/TaskManager.java\nindex 1e2716b98..faf215e66 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/async/TaskManager.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/async/TaskManager.java\n\n@@ -53,7 +52,7 @@ public abstract class TaskManager {\n     }\n \n     public static <ProgressBackground, ResultBackground> CollectionTask<ProgressBackground, ProgressBackground, ResultBackground, ResultBackground> launchCollectionTask(CollectionTask.Task<ProgressBackground, ResultBackground> task) {\n-        return sTaskManager.launchCollectionTask(task);\n+        return sTaskManager.launchCollectionTaskConcrete(task);\n     }\n \n     public abstract <ProgressBackground, ResultBackground> CollectionTask<ProgressBackground, ProgressBackground, ResultBackground, ResultBackground> launchCollectionTaskConcrete(CollectionTask.Task<ProgressBackground, ResultBackground> task);\n"}}, {"oid": "00bfa26def6733a4157bec5326d45dc5a4d49813", "url": "https://github.com/ankidroid/Anki-Android/commit/00bfa26def6733a4157bec5326d45dc5a4d49813", "message": "NF: Allow tests to execute everything in foreground", "committedDate": "2021-03-30T22:45:02Z", "type": "forcePushed"}, {"oid": "b78b85cd58f6b8e698ab597b46737c673ee07e9d", "url": "https://github.com/ankidroid/Anki-Android/commit/b78b85cd58f6b8e698ab597b46737c673ee07e9d", "message": "NF: Allow tests to execute everything in foreground", "committedDate": "2021-03-30T23:06:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDUwNDMxNg==", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#discussion_r604504316", "bodyText": "This should likely still be an abstraction on CollectionTask", "author": "david-allison-1", "createdAt": "2021-03-30T23:53:41Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -906,7 +904,7 @@ protected void onActivityResult(int requestCode, int resultCode, Intent intent)\n                 }\n             } else if (resultCode == Reviewer.RESULT_ABORT_AND_SYNC) {\n                 Timber.i(\"Obtained Abort and Sync result\");\n-                CollectionTask.waitForAllToFinish(4);", "originalCommit": "b78b85cd58f6b8e698ab597b46737c673ee07e9d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDUyNTYyOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#discussion_r604525628", "bodyText": "Why ?\nMy understanding is that CollectionTask deal with the individual tasks and the TaskManager with the queue of tasks. This is relevant to the queue.", "author": "Arthur-Milchior", "createdAt": "2021-03-31T01:02:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDUwNDMxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNTgxNjk4Nw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#discussion_r605816987", "bodyText": "You're correct", "author": "david-allison-1", "createdAt": "2021-04-01T17:10:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDUwNDMxNg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "81dc984585ce8b28b6d8ac1d825afb595bf8dfff", "url": "https://github.com/ankidroid/Anki-Android/commit/81dc984585ce8b28b6d8ac1d825afb595bf8dfff", "message": "NF: Allow tests to execute everything in foreground", "committedDate": "2021-03-31T01:07:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNjM5NTA4NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#discussion_r606395085", "bodyText": "I think I would actually go farther with this!\nI would start with mBackground = false and in the RobolectricTest.setUp I would set the foreground task manager, with cleanup resetting it to foreground\nI think unit tests wanting actual asynchronous testing are the rare case in other words, and the burden should be on them to call runTasksInForeground vs on regular code to call runTasksInBackground (note I picked David's name there", "author": "mikehardy", "createdAt": "2021-04-02T19:56:03Z", "path": "AnkiDroid/src/test/java/com/ichi2/anki/RobolectricTest.java", "diffHunk": "@@ -77,7 +80,9 @@\n import static org.hamcrest.Matchers.is;\n import static org.robolectric.Shadows.shadowOf;\n \n-public class RobolectricTest {\n+public class RobolectricTest implements CollectionGetter {\n+\n+    private static boolean mBackground = true;", "originalCommit": "81dc984585ce8b28b6d8ac1d825afb595bf8dfff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNjQwNTgyMA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#discussion_r606405820", "bodyText": "I would like to merge this PR first.\nI'm okay with doing what you want, but in a different PR. Because if we go your way, we will probably remove also advanceRobolectricLooper and similar functions, as they won't be relevant anymore, and this may lead to some complex tests to deal with, discussion about which tests should or should not be on foreground/background...\nSo, I believe that the request you ask for will take a lot of discussion, and the discussion will be more complex because the current PR\u00a0will be in the change list.\nI'd note that, as far as I know, merging this PR is still a progress, whatever the decision we take for when we should use foreground and background in tests.", "author": "Arthur-Milchior", "createdAt": "2021-04-02T20:22:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNjM5NTA4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNjQzMTk5NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#discussion_r606431994", "bodyText": "Fair point - okay, in this goes, and then hopefully we can switch the default and delete manual looper advance from most tests", "author": "mikehardy", "createdAt": "2021-04-02T21:41:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNjM5NTA4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNjU2MzE5OQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#discussion_r606563199", "bodyText": "I would start with mBackground = false and in the RobolectricTest.setUp I would set the foreground task manager, with cleanup resetting it to foreground\n\nresetting to \"background\" you mean I assume. I don't expect you want both to set to foreground", "author": "Arthur-Milchior", "createdAt": "2021-04-03T01:24:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNjM5NTA4NQ=="}], "type": "inlineReview", "revised_code": {"commit": "450f5296cb3e146de6086230a8e3b8f7dc2f4dd1", "chunk": "diff --git a/AnkiDroid/src/test/java/com/ichi2/anki/RobolectricTest.java b/AnkiDroid/src/test/java/com/ichi2/anki/RobolectricTest.java\nindex 5e1ec0b78..334d90a87 100644\n--- a/AnkiDroid/src/test/java/com/ichi2/anki/RobolectricTest.java\n+++ b/AnkiDroid/src/test/java/com/ichi2/anki/RobolectricTest.java\n\n@@ -80,9 +77,7 @@ import static org.hamcrest.MatcherAssert.assertThat;\n import static org.hamcrest.Matchers.is;\n import static org.robolectric.Shadows.shadowOf;\n \n-public class RobolectricTest implements CollectionGetter {\n-\n-    private static boolean mBackground = true;\n+public class RobolectricTest {\n \n     private final ArrayList<ActivityController<?>> controllersForCleanup = new ArrayList<>();\n \n"}}, {"oid": "450f5296cb3e146de6086230a8e3b8f7dc2f4dd1", "url": "https://github.com/ankidroid/Anki-Android/commit/450f5296cb3e146de6086230a8e3b8f7dc2f4dd1", "message": "NF: moving waitForAllToFinish to TaskManager", "committedDate": "2021-04-02T20:22:55Z", "type": "commit"}, {"oid": "83d180483cd034abc4a20126f23a9cbdbeec796f", "url": "https://github.com/ankidroid/Anki-Android/commit/83d180483cd034abc4a20126f23a9cbdbeec796f", "message": "NF: move addTask entirely in TaskManager\n\nThe manager is supposde to know when a task is added, and deal with it itself", "committedDate": "2021-04-02T20:22:55Z", "type": "commit"}, {"oid": "a5fc11da354a03b37f4c7f1453af84453c5214e9", "url": "https://github.com/ankidroid/Anki-Android/commit/a5fc11da354a03b37f4c7f1453af84453c5214e9", "message": "NF: SingleTaskManager\n\nSpliting TaskManager into an abstract and a concrete part allow to change no call while still allowing to switch implementation.", "committedDate": "2021-04-02T20:22:55Z", "type": "commit"}, {"oid": "c16c79e22ac3f193fca8b65058595c579d73fc69", "url": "https://github.com/ankidroid/Anki-Android/commit/c16c79e22ac3f193fca8b65058595c579d73fc69", "message": "NF: introduce CollectionGetter interface", "committedDate": "2021-04-02T20:22:55Z", "type": "commit"}, {"oid": "c44cb962a07d4f44851ead14efb423c9fc30d2c0", "url": "https://github.com/ankidroid/Anki-Android/commit/c44cb962a07d4f44851ead14efb423c9fc30d2c0", "message": "NF: Allow tests to execute everything in foreground", "committedDate": "2021-04-02T20:23:49Z", "type": "forcePushed"}, {"oid": "003ac75fcb7a80581cf0fd028e3c9db9f6d556ad", "url": "https://github.com/ankidroid/Anki-Android/commit/003ac75fcb7a80581cf0fd028e3c9db9f6d556ad", "message": "NF: Allow tests to execute everything in foreground", "committedDate": "2021-04-02T22:00:20Z", "type": "commit"}, {"oid": "003ac75fcb7a80581cf0fd028e3c9db9f6d556ad", "url": "https://github.com/ankidroid/Anki-Android/commit/003ac75fcb7a80581cf0fd028e3c9db9f6d556ad", "message": "NF: Allow tests to execute everything in foreground", "committedDate": "2021-04-02T22:00:20Z", "type": "forcePushed"}]}