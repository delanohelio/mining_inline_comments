{"pr_number": 7166, "pr_title": "Discard current card in deck picker", "pr_createdAt": "2020-09-19T22:14:38Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/7166", "timeline": [{"oid": "632c45ff477d5bf928d7ad727534cb8fcc8dcc35", "url": "https://github.com/ankidroid/Anki-Android/commit/632c45ff477d5bf928d7ad727534cb8fcc8dcc35", "message": "NF: regressino test for limit of new card after review", "committedDate": "2020-09-19T22:10:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTU5NTgwOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7166#discussion_r491595808", "bodyText": "I feel it'd be better to move this decision inside the method, dependent on a parameter, rather than depending on knowledge of the classes internals.", "author": "david-allison-1", "createdAt": "2020-09-19T23:13:34Z", "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -619,12 +619,18 @@ private TaskData doInBackgroundLoadDeck() {\n     }\n \n \n+    // This method should be called only if the reviewer is closed\n+    // Because it tells the scheduler there is no more current cards\n     private TaskData doInBackgroundLoadDeckCounts() {\n         Timber.d(\"doInBackgroundLoadDeckCounts\");\n         Collection col = getCol();\n+        AbstractSched sched = col.getSched();\n+        // Normally, the current card is already discarded. Here out of precaution because of\n+        // asynchronicity.\n+        sched.discardCurrentCard();", "originalCommit": "ea25088dd9ceae46a11ec40079ff415001ec9273", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTU5OTM4Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/7166#discussion_r491599386", "bodyText": "There is currently no decision to take at all. This is a remark that is potentially relevant only if one day we expect to be able to have both a deck picker and the reviewer shown simultaneously. And if you ever want to do that, there is no way you don't have to know the classes internal, because they both interact a lot with the scheduler in incompatible ways.\nI don't believe there is any reason to offer the option in code, it would be uselessly confusing; if someone want to call this method somewhere else, they would need to find what the parameter means.", "author": "Arthur-Milchior", "createdAt": "2020-09-19T23:20:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTU5NTgwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTYwMzg4MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7166#discussion_r491603880", "bodyText": "if someone want to call this method somewhere else, they would need to find what the parameter means.\n\nThat's exactly the point, a caller should be aware that the state of the method depends on whether there is a card in the scheduler and should be aware of their explicit decision to take it into account, or to ignore it.", "author": "david-allison-1", "createdAt": "2020-09-19T23:30:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTU5NTgwOA=="}], "type": "inlineReview", "revised_code": {"commit": "40313787131ddf2e167a855c52b66ff51ec4fc1e", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java b/AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java\nindex 168cd58380..f8471ff9f7 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java\n\n@@ -619,18 +619,12 @@ public class CollectionTask extends BaseAsyncTask<TaskData, TaskData, TaskData>\n     }\n \n \n-    // This method should be called only if the reviewer is closed\n-    // Because it tells the scheduler there is no more current cards\n     private TaskData doInBackgroundLoadDeckCounts() {\n         Timber.d(\"doInBackgroundLoadDeckCounts\");\n         Collection col = getCol();\n-        AbstractSched sched = col.getSched();\n-        // Normally, the current card is already discarded. Here out of precaution because of\n-        // asynchronicity.\n-        sched.discardCurrentCard();\n         try {\n             // Get due tree\n-            Object[] o = new Object[] {sched.deckDueTree(this)};\n+            Object[] o = new Object[] {col.getSched().deckDueTree(this)};\n             return new TaskData(o);\n         } catch (RuntimeException e) {\n             Timber.e(e, \"doInBackgroundLoadDeckCounts - error\");\n"}}, {"oid": "40313787131ddf2e167a855c52b66ff51ec4fc1e", "url": "https://github.com/ankidroid/Anki-Android/commit/40313787131ddf2e167a855c52b66ff51ec4fc1e", "message": "NF: Last card from reviewer not taken into account in deck picker", "committedDate": "2020-09-20T04:03:40Z", "type": "commit"}, {"oid": "40313787131ddf2e167a855c52b66ff51ec4fc1e", "url": "https://github.com/ankidroid/Anki-Android/commit/40313787131ddf2e167a855c52b66ff51ec4fc1e", "message": "NF: Last card from reviewer not taken into account in deck picker", "committedDate": "2020-09-20T04:03:40Z", "type": "forcePushed"}]}