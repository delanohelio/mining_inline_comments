{"pr_number": 6020, "pr_title": "Collection filename / getCol refactor", "pr_createdAt": "2020-04-15T20:55:40Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6020", "timeline": [{"oid": "9172aca8b8bc1b55e0558c00ecce3a626410a46e", "url": "https://github.com/ankidroid/Anki-Android/commit/9172aca8b8bc1b55e0558c00ecce3a626410a46e", "message": "Uses COLLECTION_FILENAME instead of string constant", "committedDate": "2020-04-15T20:12:17Z", "type": "commit"}, {"oid": "a0c7566a7ac5039185558a888b73f593d78b7990", "url": "https://github.com/ankidroid/Anki-Android/commit/a0c7566a7ac5039185558a888b73f593d78b7990", "message": "getCol in ContentProviderTest (factorizing code)", "committedDate": "2020-04-15T20:48:01Z", "type": "commit"}, {"oid": "02bde3959ea01444ed611300da80c41bdda50cf1", "url": "https://github.com/ankidroid/Anki-Android/commit/02bde3959ea01444ed611300da80c41bdda50cf1", "message": "setTest in Collection Helper\n\nThis will ensure that tests are executed in a separate directory. So\nthis won't need a full sync. And more important, it ensures that\neverything is quick since everything runs on an empty collection. This\nis the difference between 2 minutes of tests and 20 minutes !", "committedDate": "2020-04-15T21:00:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEzNDk1NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6020#discussion_r409134955", "bodyText": "I love the idea.\nI have also struggled with running the connected tests against my main collection on my main real device for fear of polluting my collection. That's a strong enough argument for something like this, but the performance consideration is important as well of course.\nI do not want test code in the 'main' tree if possible though and I've gone to some lengths to avoid it in my own testing. There is almost always a way to have the \"main\" tree be \"clean\" (but maybe more flexible, so you can inject test settings) without having actual test-related code in here.\nIn this instance, perhaps you could sub-class CollectionHelper as TestCollectionHelper in the \"test\" class hierarchy and override the method, then use the TestCollectionHelper to do the same - this is a common and easy pattern", "author": "mikehardy", "createdAt": "2020-04-15T21:08:34Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CollectionHelper.java", "diffHunk": "@@ -116,6 +119,10 @@ public synchronized Collection getCol(Context context) {\n         return mCollection;\n     }\n \n+    public void setTest() {", "originalCommit": "02bde3959ea01444ed611300da80c41bdda50cf1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEzNzc1NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6020#discussion_r409137754", "bodyText": "Another idea I had would be to allow a string parameter for the folder name. This would allow to really easily create a folder by user and thus allow multiple account with very minimal work.\nWhile I believe the idea would be loved by a lot of user, I didn't want to put it in this PR because:\n\nI wasn't sure of my idea, and this need more reflection on my side about what I would suggest (and more discussion later.\u00a0But I don't want to start a discussion without being able to actually show code)\nI wanted to do a small and quick PR in order for it to be accepted quickly and to stop having 20\u00a0minutes of test each time I run them.", "author": "Arthur-Milchior", "createdAt": "2020-04-15T21:14:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEzNDk1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEzODc5MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6020#discussion_r409138791", "bodyText": "Just go for the test override now. The problem with multiple profiles is more than the collection, it's the preferences related to them as well. If you do a TestCollectionHelper you'll probably be done in 1 minute with obviously correct code (that's a guess, and you should double the guess from any developer, so it will be 2 minutes in reality, with one bug no one noticed ;-) )", "author": "mikehardy", "createdAt": "2020-04-15T21:16:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEzNDk1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTE0NDgzOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6020#discussion_r409144838", "bodyText": "I highly doubt that introducing the feature, with the profile limitation, would not already be a huge win.\nThat's by the way a problem with anki add-on. They are not configured user by user, the whole configuration is done for the whole system.", "author": "Arthur-Milchior", "createdAt": "2020-04-15T21:29:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEzNDk1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTE1MTI5Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6020#discussion_r409151293", "bodyText": "It doesn't work. You can't override a static method. And the method returning the path is static. This is why mTest had to be a static class variable.", "author": "Arthur-Milchior", "createdAt": "2020-04-15T21:42:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEzNDk1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTE1NTU0Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6020#discussion_r409155543", "bodyText": "The method getDefaultAnkiDroidDirectory is called in two places. getCurrentAnkiDroidDirectory which is also static and called in a lot of place\nand\nAnkiDroidApp.onCreate. This is called during the tests; and it's going to be not easy to override this given the importance of this class.\nSo I believe that by \"2 minutes\" you're FAR\u00a0TOO\u00a0optimistic", "author": "Arthur-Milchior", "createdAt": "2020-04-15T21:51:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEzNDk1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTE1Nzk3MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6020#discussion_r409157970", "bodyText": "I hadn't thought of the static-ness, that is a bummer\n\nSo I believe that by \"2 minutes\" you're FAR\u00a0TOO\u00a0optimistic\n\nTypical developer! Rubbish estimates ;-)\nI want a solution here, I really like the idea of a test-only connected check. Perhaps on in the test setUp() you could examine the preferences object, save a value for the directory if it exists, and in tearDown() you could restore the directory? Seems a little shaky but might just work.\nWorst case is a developer (who should know what they are doing? They are running connected tests against their device via adb debugging after all) will have to go into their preferences and reset it to /sdcard/AnkiDroid)\nMaybe works?", "author": "mikehardy", "createdAt": "2020-04-15T21:56:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEzNDk1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTE2MzQ5OQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6020#discussion_r409163499", "bodyText": "I don't know what's the preference object.\nI don't like your idea, because if test really fails, the directory restoration won't occur. I have no idea how much certain it is that tearDown will occur.\nAnd test will fail (otherwise, there is no need to run them)", "author": "Arthur-Milchior", "createdAt": "2020-04-15T22:08:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEzNDk1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTE2Mzk5Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6020#discussion_r409163992", "bodyText": "And when I say \"fail\" I also means things such as: the phone get disconnected from the computer, and gradlew is stopped.\nI would not be surprised that tearDown can have problem, because\u00a0I sometime got new decks and cards in my collection after tests with errors", "author": "Arthur-Milchior", "createdAt": "2020-04-15T22:10:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEzNDk1NQ=="}], "type": "inlineReview", "revised_code": {"commit": "6d2cf697f64ba3537627333a124284396cf260d3", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/anki/CollectionHelper.java b/AnkiDroid/src/main/java/com/ichi2/anki/CollectionHelper.java\nindex eeedbc7e96..b84bab7274 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/anki/CollectionHelper.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/anki/CollectionHelper.java\n\n@@ -119,10 +116,6 @@ public class CollectionHelper {\n         return mCollection;\n     }\n \n-    public void setTest() {\n-        mTest = true;\n-    }\n-\n     /**\n      * Call getCol(context) inside try / catch statement.\n      * Send exception report and return null if there was an exception.\n"}}, {"oid": "6d2cf697f64ba3537627333a124284396cf260d3", "url": "https://github.com/ankidroid/Anki-Android/commit/6d2cf697f64ba3537627333a124284396cf260d3", "message": "setTest in Collection Helper\n\nThis will ensure that tests are executed in a separate directory. So\nthis won't need a full sync. And more important, it ensures that\neverything is quick since everything runs on an empty collection. This\nis the difference between 2 minutes of tests and 20 minutes !", "committedDate": "2020-04-15T21:39:09Z", "type": "forcePushed"}, {"oid": "a0c7566a7ac5039185558a888b73f593d78b7990", "url": "https://github.com/ankidroid/Anki-Android/commit/a0c7566a7ac5039185558a888b73f593d78b7990", "message": "getCol in ContentProviderTest (factorizing code)", "committedDate": "2020-04-15T20:48:01Z", "type": "forcePushed"}]}