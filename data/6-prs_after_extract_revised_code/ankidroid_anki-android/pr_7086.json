{"pr_number": 7086, "pr_title": "Implement special field decoration mode", "pr_createdAt": "2020-09-14T16:59:41Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/7086", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODEwNjUyNA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7086#discussion_r488106524", "bodyText": "Could we extract huevoRevuelto(fieldText) out of the for for performance?", "author": "david-allison-1", "createdAt": "2020-09-14T17:33:42Z", "path": "AnkiDroid/src/main/java/com/ichi2/utils/NoteFieldDecorator.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/****************************************************************************************\n+ * Copyright (c) 2020 Mike Hardy <github@mikehardy.net>                                 *\n+ *                                                                                      *\n+ * This program is free software; you can redistribute it and/or modify it under        *\n+ * the terms of the GNU General Public License as published by the Free Software        *\n+ * Foundation; either version 3 of the License, or (at your option) any later           *\n+ * version.                                                                             *\n+ *                                                                                      *\n+ * This program is distributed in the hope that it will be useful, but WITHOUT ANY      *\n+ * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A      *\n+ * PARTICULAR PURPOSE. See the GNU General Public License for more details.             *\n+ *                                                                                      *\n+ * You should have received a copy of the GNU General Public License along with         *\n+ * this program.  If not, see <http://www.gnu.org/licenses/>.                           *\n+ ****************************************************************************************/\n+\n+package com.ichi2.utils;\n+\n+import java.util.Random;\n+\n+public class NoteFieldDecorator {\n+\n+    private static String[] huevoDecorations = {\n+            \"\\uD83D\\uDC8C\",\n+            \"\\uD83D\\uDE3B\",\n+            \"\\uD83D\\uDC96\",\n+            \"\\uD83D\\uDC97\",\n+            \"\\uD83D\\uDC93\",\n+            \"\\uD83D\\uDC9E\",\n+            \"\\uD83D\\uDC95\",\n+            \"\\uD83D\\uDC9F\",\n+            \"\\uD83D\\uDCAF\",\n+            \"\\uD83D\\uDE03\",\n+            \"\\uD83D\\uDE0D\"\n+    };\n+\n+    private static String[] huevoOpciones = {\n+            \"qnr\",\n+            \"gvzenr\",\n+            \"aboantb\",\n+            \"avpbynf-enbhy\",\n+            \"Neguhe-Zvypuve\",\n+            \"zvxruneql\",\n+            \"qnivq-nyyvfba-1\",\n+            \"vavwh\",\n+            \"uffz\",\n+            \"syreq\",\n+            \"rqh-mnzben\",\n+            \"ntehraroret\",\n+            \"bfcnyu\",\n+            \"znaqer\",\n+            \"qnavry-fineq\",\n+            \"vasvalgr7\",\n+            \"Oynvfbeoynqr\",\n+            \"genfuphggre\",\n+            \"qzvgel-gvzbsrri\",\n+            \"inabfgra\",\n+            \"unacvatpuvarfr\",\n+            \"jro5atnl\"\n+    };\n+\n+    public static String aplicaHuevo(String fieldText) {\n+        for (String huevo : huevoOpciones) {\n+            if (huevo.equals(huevoRevuelto(fieldText))) {", "originalCommit": "5eff5cdd1b435f782d0f0e67640d39169e2002c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODExNDMyNw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7086#discussion_r488114327", "bodyText": "good catch, it's onBlur so won't execute too often, but you are still correct", "author": "mikehardy", "createdAt": "2020-09-14T17:47:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODEwNjUyNA=="}], "type": "inlineReview", "revised_code": {"commit": "2a3ce30ecac95e934974f34439a67d56b7ee56ec", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/utils/NoteFieldDecorator.java b/AnkiDroid/src/main/java/com/ichi2/utils/NoteFieldDecorator.java\nindex 92f6ae7c2..cee4213ac 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/utils/NoteFieldDecorator.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/utils/NoteFieldDecorator.java\n\n@@ -20,6 +20,8 @@ import java.util.Random;\n \n public class NoteFieldDecorator {\n \n+    private static Random random = new Random();\n+\n     private static String[] huevoDecorations = {\n             \"\\uD83D\\uDC8C\",\n             \"\\uD83D\\uDE3B\",\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODEwNjgyOQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7086#discussion_r488106829", "bodyText": "This should be using a static Random instance", "author": "david-allison-1", "createdAt": "2020-09-14T17:34:17Z", "path": "AnkiDroid/src/main/java/com/ichi2/utils/NoteFieldDecorator.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/****************************************************************************************\n+ * Copyright (c) 2020 Mike Hardy <github@mikehardy.net>                                 *\n+ *                                                                                      *\n+ * This program is free software; you can redistribute it and/or modify it under        *\n+ * the terms of the GNU General Public License as published by the Free Software        *\n+ * Foundation; either version 3 of the License, or (at your option) any later           *\n+ * version.                                                                             *\n+ *                                                                                      *\n+ * This program is distributed in the hope that it will be useful, but WITHOUT ANY      *\n+ * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A      *\n+ * PARTICULAR PURPOSE. See the GNU General Public License for more details.             *\n+ *                                                                                      *\n+ * You should have received a copy of the GNU General Public License along with         *\n+ * this program.  If not, see <http://www.gnu.org/licenses/>.                           *\n+ ****************************************************************************************/\n+\n+package com.ichi2.utils;\n+\n+import java.util.Random;\n+\n+public class NoteFieldDecorator {\n+\n+    private static String[] huevoDecorations = {\n+            \"\\uD83D\\uDC8C\",\n+            \"\\uD83D\\uDE3B\",\n+            \"\\uD83D\\uDC96\",\n+            \"\\uD83D\\uDC97\",\n+            \"\\uD83D\\uDC93\",\n+            \"\\uD83D\\uDC9E\",\n+            \"\\uD83D\\uDC95\",\n+            \"\\uD83D\\uDC9F\",\n+            \"\\uD83D\\uDCAF\",\n+            \"\\uD83D\\uDE03\",\n+            \"\\uD83D\\uDE0D\"\n+    };\n+\n+    private static String[] huevoOpciones = {\n+            \"qnr\",\n+            \"gvzenr\",\n+            \"aboantb\",\n+            \"avpbynf-enbhy\",\n+            \"Neguhe-Zvypuve\",\n+            \"zvxruneql\",\n+            \"qnivq-nyyvfba-1\",\n+            \"vavwh\",\n+            \"uffz\",\n+            \"syreq\",\n+            \"rqh-mnzben\",\n+            \"ntehraroret\",\n+            \"bfcnyu\",\n+            \"znaqer\",\n+            \"qnavry-fineq\",\n+            \"vasvalgr7\",\n+            \"Oynvfbeoynqr\",\n+            \"genfuphggre\",\n+            \"qzvgel-gvzbsrri\",\n+            \"inabfgra\",\n+            \"unacvatpuvarfr\",\n+            \"jro5atnl\"\n+    };\n+\n+    public static String aplicaHuevo(String fieldText) {\n+        for (String huevo : huevoOpciones) {\n+            if (huevo.equals(huevoRevuelto(fieldText))) {\n+                String decoration = huevoDecorations[getRandomIndex(huevoDecorations.length)];\n+                return String.format(\"%s%s %s %s%s\", decoration, decoration, fieldText, decoration, decoration);\n+            }\n+        }\n+        return fieldText;\n+    }\n+\n+    private static int getRandomIndex(int max) {\n+        return new Random().nextInt(max);", "originalCommit": "5eff5cdd1b435f782d0f0e67640d39169e2002c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODExNDUwOQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7086#discussion_r488114509", "bodyText": "sure, could do", "author": "mikehardy", "createdAt": "2020-09-14T17:48:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODEwNjgyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "2a3ce30ecac95e934974f34439a67d56b7ee56ec", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/utils/NoteFieldDecorator.java b/AnkiDroid/src/main/java/com/ichi2/utils/NoteFieldDecorator.java\nindex 92f6ae7c2..cee4213ac 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/utils/NoteFieldDecorator.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/utils/NoteFieldDecorator.java\n\n@@ -20,6 +20,8 @@ import java.util.Random;\n \n public class NoteFieldDecorator {\n \n+    private static Random random = new Random();\n+\n     private static String[] huevoDecorations = {\n             \"\\uD83D\\uDC8C\",\n             \"\\uD83D\\uDE3B\",\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODEwODY2Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7086#discussion_r488108663", "bodyText": "Could we wrap this in a try...catch, and ideally flip some of the ifs", "author": "david-allison-1", "createdAt": "2020-09-14T17:37:44Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/NoteEditor.java", "diffHunk": "@@ -1498,6 +1499,19 @@ private void initFieldEditText(FieldEditText editText, final int index, String[]\n \n         // Listen for changes in the first field so we can re-check duplicate status.\n         editText.addTextChangedListener(new EditFieldTextWatcher(index));\n+        if (index == 0) {\n+            editText.setOnFocusChangeListener((v, hasFocus) -> {\n+                if (!hasFocus) {", "originalCommit": "5eff5cdd1b435f782d0f0e67640d39169e2002c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODExNDY5Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7086#discussion_r488114693", "bodyText": "yeah first rule of playing around is DO NOT CRASH, I'll wrap it", "author": "mikehardy", "createdAt": "2020-09-14T17:48:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODEwODY2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "2a3ce30ecac95e934974f34439a67d56b7ee56ec", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/anki/NoteEditor.java b/AnkiDroid/src/main/java/com/ichi2/anki/NoteEditor.java\nindex 7dcf4fc24..9736adaa1 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/anki/NoteEditor.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/anki/NoteEditor.java\n\n@@ -1501,14 +1501,24 @@ public class NoteEditor extends AnkiActivity {\n         editText.addTextChangedListener(new EditFieldTextWatcher(index));\n         if (index == 0) {\n             editText.setOnFocusChangeListener((v, hasFocus) -> {\n-                if (!hasFocus) {\n-                    // If first field in two field note loses focus, and second field is empty, apply special decorators\n-                    if (getCurrentFieldStrings().length == 2 && getCurrentFieldStrings()[1].isEmpty()) {\n-                        String decoratedText = NoteFieldDecorator.aplicaHuevo(getCurrentFieldText(0));\n-                        if (!decoratedText.equals(getCurrentFieldText(0))) {\n-                            setFieldValueFromUi(1, decoratedText);\n-                        }\n+                try {\n+                    if (hasFocus) {\n+                        // we only want to decorate when we lose focus\n+                        return;\n+                    }\n+                    String[] currentFieldStrings = getCurrentFieldStrings();\n+                    if (currentFieldStrings.length != 2 || currentFieldStrings[1].length() > 0) {\n+                        // we only decorate on 2-field cards while second field is still empty\n+                        return;\n+                    }\n+                    String firstField = currentFieldStrings[0];\n+                    String decoratedText = NoteFieldDecorator.aplicaHuevo(firstField);\n+                    if (!decoratedText.equals(firstField)) {\n+                        // we only apply the decoration if it is actually different from the first field\n+                        setFieldValueFromUi(1, decoratedText);\n                     }\n+                } catch (Exception e) {\n+                    Timber.w(e, \"Unable to decorate text field\");\n                 }\n             });\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODEwOTc4NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7086#discussion_r488109784", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        \"Neguhe-Zvypuve\",\n          \n          \n            \n                        \"Neguhe-Zvypuvbe\",", "author": "david-allison-1", "createdAt": "2020-09-14T17:39:54Z", "path": "AnkiDroid/src/main/java/com/ichi2/utils/NoteFieldDecorator.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/****************************************************************************************\n+ * Copyright (c) 2020 Mike Hardy <github@mikehardy.net>                                 *\n+ *                                                                                      *\n+ * This program is free software; you can redistribute it and/or modify it under        *\n+ * the terms of the GNU General Public License as published by the Free Software        *\n+ * Foundation; either version 3 of the License, or (at your option) any later           *\n+ * version.                                                                             *\n+ *                                                                                      *\n+ * This program is distributed in the hope that it will be useful, but WITHOUT ANY      *\n+ * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A      *\n+ * PARTICULAR PURPOSE. See the GNU General Public License for more details.             *\n+ *                                                                                      *\n+ * You should have received a copy of the GNU General Public License along with         *\n+ * this program.  If not, see <http://www.gnu.org/licenses/>.                           *\n+ ****************************************************************************************/\n+\n+package com.ichi2.utils;\n+\n+import java.util.Random;\n+\n+public class NoteFieldDecorator {\n+\n+    private static String[] huevoDecorations = {\n+            \"\\uD83D\\uDC8C\",\n+            \"\\uD83D\\uDE3B\",\n+            \"\\uD83D\\uDC96\",\n+            \"\\uD83D\\uDC97\",\n+            \"\\uD83D\\uDC93\",\n+            \"\\uD83D\\uDC9E\",\n+            \"\\uD83D\\uDC95\",\n+            \"\\uD83D\\uDC9F\",\n+            \"\\uD83D\\uDCAF\",\n+            \"\\uD83D\\uDE03\",\n+            \"\\uD83D\\uDE0D\"\n+    };\n+\n+    private static String[] huevoOpciones = {\n+            \"qnr\",\n+            \"gvzenr\",\n+            \"aboantb\",\n+            \"avpbynf-enbhy\",\n+            \"Neguhe-Zvypuve\",", "originalCommit": "5eff5cdd1b435f782d0f0e67640d39169e2002c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODExNTA4NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7086#discussion_r488115085", "bodyText": "must have gotten sloppy as I converted to the storage format \ud83d\ude06 thanks for checking", "author": "mikehardy", "createdAt": "2020-09-14T17:49:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODEwOTc4NA=="}], "type": "inlineReview", "revised_code": {"commit": "2a3ce30ecac95e934974f34439a67d56b7ee56ec", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/utils/NoteFieldDecorator.java b/AnkiDroid/src/main/java/com/ichi2/utils/NoteFieldDecorator.java\nindex 92f6ae7c2..cee4213ac 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/utils/NoteFieldDecorator.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/utils/NoteFieldDecorator.java\n\n@@ -20,6 +20,8 @@ import java.util.Random;\n \n public class NoteFieldDecorator {\n \n+    private static Random random = new Random();\n+\n     private static String[] huevoDecorations = {\n             \"\\uD83D\\uDC8C\",\n             \"\\uD83D\\uDE3B\",\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODExMTQyNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7086#discussion_r488111425", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        \"syreq\",\n          \n          \n            \n                        \"syreqn\",", "author": "david-allison-1", "createdAt": "2020-09-14T17:42:52Z", "path": "AnkiDroid/src/main/java/com/ichi2/utils/NoteFieldDecorator.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/****************************************************************************************\n+ * Copyright (c) 2020 Mike Hardy <github@mikehardy.net>                                 *\n+ *                                                                                      *\n+ * This program is free software; you can redistribute it and/or modify it under        *\n+ * the terms of the GNU General Public License as published by the Free Software        *\n+ * Foundation; either version 3 of the License, or (at your option) any later           *\n+ * version.                                                                             *\n+ *                                                                                      *\n+ * This program is distributed in the hope that it will be useful, but WITHOUT ANY      *\n+ * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A      *\n+ * PARTICULAR PURPOSE. See the GNU General Public License for more details.             *\n+ *                                                                                      *\n+ * You should have received a copy of the GNU General Public License along with         *\n+ * this program.  If not, see <http://www.gnu.org/licenses/>.                           *\n+ ****************************************************************************************/\n+\n+package com.ichi2.utils;\n+\n+import java.util.Random;\n+\n+public class NoteFieldDecorator {\n+\n+    private static String[] huevoDecorations = {\n+            \"\\uD83D\\uDC8C\",\n+            \"\\uD83D\\uDE3B\",\n+            \"\\uD83D\\uDC96\",\n+            \"\\uD83D\\uDC97\",\n+            \"\\uD83D\\uDC93\",\n+            \"\\uD83D\\uDC9E\",\n+            \"\\uD83D\\uDC95\",\n+            \"\\uD83D\\uDC9F\",\n+            \"\\uD83D\\uDCAF\",\n+            \"\\uD83D\\uDE03\",\n+            \"\\uD83D\\uDE0D\"\n+    };\n+\n+    private static String[] huevoOpciones = {\n+            \"qnr\",\n+            \"gvzenr\",\n+            \"aboantb\",\n+            \"avpbynf-enbhy\",\n+            \"Neguhe-Zvypuve\",\n+            \"zvxruneql\",\n+            \"qnivq-nyyvfba-1\",\n+            \"vavwh\",\n+            \"uffz\",\n+            \"syreq\",", "originalCommit": "5eff5cdd1b435f782d0f0e67640d39169e2002c7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2a3ce30ecac95e934974f34439a67d56b7ee56ec", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/utils/NoteFieldDecorator.java b/AnkiDroid/src/main/java/com/ichi2/utils/NoteFieldDecorator.java\nindex 92f6ae7c2..cee4213ac 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/utils/NoteFieldDecorator.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/utils/NoteFieldDecorator.java\n\n@@ -20,6 +20,8 @@ import java.util.Random;\n \n public class NoteFieldDecorator {\n \n+    private static Random random = new Random();\n+\n     private static String[] huevoDecorations = {\n             \"\\uD83D\\uDC8C\",\n             \"\\uD83D\\uDE3B\",\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODExMjg3Nw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7086#discussion_r488112877", "bodyText": "extract getCurrentFieldStrings()", "author": "david-allison-1", "createdAt": "2020-09-14T17:45:20Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/NoteEditor.java", "diffHunk": "@@ -1498,6 +1499,19 @@ private void initFieldEditText(FieldEditText editText, final int index, String[]\n \n         // Listen for changes in the first field so we can re-check duplicate status.\n         editText.addTextChangedListener(new EditFieldTextWatcher(index));\n+        if (index == 0) {\n+            editText.setOnFocusChangeListener((v, hasFocus) -> {\n+                if (!hasFocus) {\n+                    // If first field in two field note loses focus, and second field is empty, apply special decorators\n+                    if (getCurrentFieldStrings().length == 2 && getCurrentFieldStrings()[1].isEmpty()) {", "originalCommit": "5eff5cdd1b435f782d0f0e67640d39169e2002c7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2a3ce30ecac95e934974f34439a67d56b7ee56ec", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/anki/NoteEditor.java b/AnkiDroid/src/main/java/com/ichi2/anki/NoteEditor.java\nindex 7dcf4fc24..9736adaa1 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/anki/NoteEditor.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/anki/NoteEditor.java\n\n@@ -1501,14 +1501,24 @@ public class NoteEditor extends AnkiActivity {\n         editText.addTextChangedListener(new EditFieldTextWatcher(index));\n         if (index == 0) {\n             editText.setOnFocusChangeListener((v, hasFocus) -> {\n-                if (!hasFocus) {\n-                    // If first field in two field note loses focus, and second field is empty, apply special decorators\n-                    if (getCurrentFieldStrings().length == 2 && getCurrentFieldStrings()[1].isEmpty()) {\n-                        String decoratedText = NoteFieldDecorator.aplicaHuevo(getCurrentFieldText(0));\n-                        if (!decoratedText.equals(getCurrentFieldText(0))) {\n-                            setFieldValueFromUi(1, decoratedText);\n-                        }\n+                try {\n+                    if (hasFocus) {\n+                        // we only want to decorate when we lose focus\n+                        return;\n+                    }\n+                    String[] currentFieldStrings = getCurrentFieldStrings();\n+                    if (currentFieldStrings.length != 2 || currentFieldStrings[1].length() > 0) {\n+                        // we only decorate on 2-field cards while second field is still empty\n+                        return;\n+                    }\n+                    String firstField = currentFieldStrings[0];\n+                    String decoratedText = NoteFieldDecorator.aplicaHuevo(firstField);\n+                    if (!decoratedText.equals(firstField)) {\n+                        // we only apply the decoration if it is actually different from the first field\n+                        setFieldValueFromUi(1, decoratedText);\n                     }\n+                } catch (Exception e) {\n+                    Timber.w(e, \"Unable to decorate text field\");\n                 }\n             });\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODExMzE1Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/7086#discussion_r488113152", "bodyText": "extract getCurrentFieldStrings(0)", "author": "david-allison-1", "createdAt": "2020-09-14T17:45:51Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/NoteEditor.java", "diffHunk": "@@ -1498,6 +1499,19 @@ private void initFieldEditText(FieldEditText editText, final int index, String[]\n \n         // Listen for changes in the first field so we can re-check duplicate status.\n         editText.addTextChangedListener(new EditFieldTextWatcher(index));\n+        if (index == 0) {\n+            editText.setOnFocusChangeListener((v, hasFocus) -> {\n+                if (!hasFocus) {\n+                    // If first field in two field note loses focus, and second field is empty, apply special decorators\n+                    if (getCurrentFieldStrings().length == 2 && getCurrentFieldStrings()[1].isEmpty()) {\n+                        String decoratedText = NoteFieldDecorator.aplicaHuevo(getCurrentFieldText(0));", "originalCommit": "5eff5cdd1b435f782d0f0e67640d39169e2002c7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2a3ce30ecac95e934974f34439a67d56b7ee56ec", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/anki/NoteEditor.java b/AnkiDroid/src/main/java/com/ichi2/anki/NoteEditor.java\nindex 7dcf4fc24..9736adaa1 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/anki/NoteEditor.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/anki/NoteEditor.java\n\n@@ -1501,14 +1501,24 @@ public class NoteEditor extends AnkiActivity {\n         editText.addTextChangedListener(new EditFieldTextWatcher(index));\n         if (index == 0) {\n             editText.setOnFocusChangeListener((v, hasFocus) -> {\n-                if (!hasFocus) {\n-                    // If first field in two field note loses focus, and second field is empty, apply special decorators\n-                    if (getCurrentFieldStrings().length == 2 && getCurrentFieldStrings()[1].isEmpty()) {\n-                        String decoratedText = NoteFieldDecorator.aplicaHuevo(getCurrentFieldText(0));\n-                        if (!decoratedText.equals(getCurrentFieldText(0))) {\n-                            setFieldValueFromUi(1, decoratedText);\n-                        }\n+                try {\n+                    if (hasFocus) {\n+                        // we only want to decorate when we lose focus\n+                        return;\n+                    }\n+                    String[] currentFieldStrings = getCurrentFieldStrings();\n+                    if (currentFieldStrings.length != 2 || currentFieldStrings[1].length() > 0) {\n+                        // we only decorate on 2-field cards while second field is still empty\n+                        return;\n+                    }\n+                    String firstField = currentFieldStrings[0];\n+                    String decoratedText = NoteFieldDecorator.aplicaHuevo(firstField);\n+                    if (!decoratedText.equals(firstField)) {\n+                        // we only apply the decoration if it is actually different from the first field\n+                        setFieldValueFromUi(1, decoratedText);\n                     }\n+                } catch (Exception e) {\n+                    Timber.w(e, \"Unable to decorate text field\");\n                 }\n             });\n         }\n"}}, {"oid": "2a3ce30ecac95e934974f34439a67d56b7ee56ec", "url": "https://github.com/ankidroid/Anki-Android/commit/2a3ce30ecac95e934974f34439a67d56b7ee56ec", "message": "Implement special note edit field decoration mode", "committedDate": "2020-09-14T18:06:49Z", "type": "commit"}, {"oid": "2a3ce30ecac95e934974f34439a67d56b7ee56ec", "url": "https://github.com/ankidroid/Anki-Android/commit/2a3ce30ecac95e934974f34439a67d56b7ee56ec", "message": "Implement special note edit field decoration mode", "committedDate": "2020-09-14T18:06:49Z", "type": "forcePushed"}]}