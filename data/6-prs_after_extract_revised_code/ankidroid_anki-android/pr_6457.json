{"pr_number": 6457, "pr_title": "Avoid unhandled out-of-space and OOM on large imports", "pr_createdAt": "2020-06-14T02:57:27Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6457", "timeline": [{"oid": "3c45dff8ade69ab2cf9d866db3acddcdc137973d", "url": "https://github.com/ankidroid/Anki-Android/commit/3c45dff8ade69ab2cf9d866db3acddcdc137973d", "message": "to avoid OOM, process add/update/dirty.. partially", "committedDate": "2020-06-14T01:16:33Z", "type": "commit"}, {"oid": "6fa6c4fa205da287b9e4e20c207c72fcf6ec7b61", "url": "https://github.com/ankidroid/Anki-Android/commit/6fa6c4fa205da287b9e4e20c207c72fcf6ec7b61", "message": "Verify space to unzip, reduce import mem use", "committedDate": "2020-06-14T01:34:51Z", "type": "commit"}, {"oid": "4cb44ffcc803f9294ede244cb72a72d73a492827", "url": "https://github.com/ankidroid/Anki-Android/commit/4cb44ffcc803f9294ede244cb72a72d73a492827", "message": "Handle disk full errors on import gracefully\n\nIf you run out of disk while importing, the errors percolate up\nin the most unexpected ways. This is the actual tested way they show up,\nhandled in a way that the user sees that they ran out of disk in the dialog\nbox, so they can hopefully self help", "committedDate": "2020-06-14T02:13:55Z", "type": "commit"}, {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d", "url": "https://github.com/ankidroid/Anki-Android/commit/51ff7c61445aeafe71e07e83654b01837a95359d", "message": "Gracefully handle post-import cleanup failures\n\nThe user should get a notice that check database will help\nthem, but the import actually worked - the data is fine\n\nThis can happen if you import a very large deck at the limit\nof the space available on your device, because vacuum can take\nso much extra space", "committedDate": "2020-06-14T03:05:15Z", "type": "commit"}, {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d", "url": "https://github.com/ankidroid/Anki-Android/commit/51ff7c61445aeafe71e07e83654b01837a95359d", "message": "Gracefully handle post-import cleanup failures\n\nThe user should get a notice that check database will help\nthem, but the import actually worked - the data is fine\n\nThis can happen if you import a very large deck at the limit\nof the space available on your device, because vacuum can take\nso much extra space", "committedDate": "2020-06-14T03:05:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwNzIyNw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439807227", "bodyText": "This implies that there is an issue in one of the format strings. Definitely don't suppress here.\nEDIT: I tried a PR to turn this into a lint fail, but it didn't fail here.\nLooks like an issue with values_ti where someone translated our comment literally:\n\n  \n    \n      Anki-Android/AnkiDroid/src/main/res/values-ti/01-core.xml\n    \n    \n        Lines 138 to 140\n      in\n      9595b84\n    \n    \n    \n    \n\n        \n          \n               <string name=\"time_quantity_seconds\">\u130d\u12dc_\u1265\u12dd\u1212_\u12ab\u120d\u12a2\u1273\u1275 \n        \n\n        \n          \n           \u1265\u12dd\u1212 \u130d\u12dc \u1218\u12d0\u1250\u1292 \u1293\u12ed \u130d\u12dc \u12a5\u12ee\u121d\u1362\u1265\u12d8\u12ed \u121d\u1265\u12db\u1215\u1295 \u1265\u12d8\u12ed \u1290\u1320\u1265\u1295 \u12a8\u12a3 \u1295\u1325\u1240\u1218\u120e\u121d\u1362 \n        \n\n        \n          \n           s,min,h,d, \u12a5\u12da\u12a6\u121d \u12a8\u121d \u120d\u1219\u12f5(ISO 31-1) \u1218\u12d0\u1240\u1292\u1273\u1275 \u12a8\u121d\u12a1 \u12cd\u1295 \u12ad\u1275\u122d\u130e\u1219 \u12d8\u12ed\u12ad\u12a5\u1209 \u12a2\u12ee\u121d \u1265\u12cd\u1211\u12f1 \u1295 \u124b\u1295\u124b \u1265 \u120b\u1272\u1295 \u1218\u1235\u122d\u1215 \u1243\u120b\u1275\u1362</string> \n        \n    \n  \n\n\nI've fixed the translation", "author": "david-allison-1", "createdAt": "2020-06-14T08:56:16Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Utils.java", "diffHunk": "@@ -138,6 +141,7 @@ public static long intTime(int scale) {\n      * @return The time quantity string. Something like \"3 s\" or \"1.7\n      * yr\". Only months and year have a number after the decimal.\n      */\n+    @SuppressLint(\"StringFormatInvalid\")", "originalCommit": "51ff7c61445aeafe71e07e83654b01837a95359d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg0MTAyMA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439841020", "bodyText": "Interesting that we weren't able to get signal from lint on that. Could you open a separate issue about that with what you tried? Should do a full codebase grep on the suppresslint I slapped on there to make sure it's removed everywhere. Then perhaps the linter needs configuration like which resources to load or something (I don't know...) but if Android Studio is able to see it, we should be able to do it on the command line, so it should be possible in Travis...", "author": "mikehardy", "createdAt": "2020-06-14T15:29:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwNzIyNw=="}], "type": "inlineReview", "revised_code": {"commit": "ed9db84b64ae40f0e80dafff96b07dfd0b90cfd8", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/libanki/Utils.java b/AnkiDroid/src/main/java/com/ichi2/libanki/Utils.java\nindex a46b146b2..190fc5edd 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/libanki/Utils.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/libanki/Utils.java\n\n@@ -141,7 +140,6 @@ public class Utils {\n      * @return The time quantity string. Something like \"3 s\" or \"1.7\n      * yr\". Only months and year have a number after the decimal.\n      */\n-    @SuppressLint(\"StringFormatInvalid\")\n     public static String timeQuantity(Context context, long time_s) {\n         Resources res = context.getResources();\n         // N.B.: the integer s, min, h, d and (one decimal, rounded by format) double for month, year is\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwNzc4MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439807780", "bodyText": "I've wanted to look into this for a while, as it makes stack traces harder to reason about.\nIt's the endTransacttion which throws, so I'd presumed that you should be able to get away with mDst.getDb().getDatabase().inTransaction() without the try..catch. Is this not the case?", "author": "david-allison-1", "createdAt": "2020-06-14T09:03:07Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -147,13 +147,33 @@ private void _import() {\n             publishProgress(100, 100, 50);\n             mDst.getDb().getDatabase().setTransactionSuccessful();\n             mDst.getMedia().getDb().getDatabase().setTransactionSuccessful();\n+        } catch (Exception err) {\n+            Timber.e(err, \"_import() exception\");\n+            throw err;\n         } finally {\n-            mDst.getDb().getDatabase().endTransaction();\n-            mDst.getMedia().getDb().getDatabase().endTransaction();\n+            // These methods throw about invalid transaction even when you try!\n+            if (mDst.getDb().getDatabase().inTransaction()) {", "originalCommit": "51ff7c61445aeafe71e07e83654b01837a95359d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgzNjUzMA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439836530", "bodyText": "Nope. Throws anyway. Thus the note.", "author": "mikehardy", "createdAt": "2020-06-14T14:39:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwNzc4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1OTg2OQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439859869", "bodyText": "Comment wasn't clear for me (try was ambiguous), could we extract this to a Utils class of some sort, as it'll be needed everywhere.\nAlternately, could make a runInTrnasaction method now we have lambdas. But that might be gold-plating", "author": "david-allison-1", "createdAt": "2020-06-14T19:22:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwNzc4MA=="}], "type": "inlineReview", "revised_code": {"commit": "be661ef74d4dacaac62591fa461ec86766867d0e", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java b/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java\nindex 3fa44d045..bfdf9470f 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java\n\n@@ -151,7 +151,7 @@ public class Anki2Importer extends Importer {\n             Timber.e(err, \"_import() exception\");\n             throw err;\n         } finally {\n-            // These methods throw about invalid transaction even when you try!\n+            // endTransaction throws about invalid transaction even when you check first!\n             if (mDst.getDb().getDatabase().inTransaction()) {\n                 try { mDst.getDb().getDatabase().endTransaction(); } catch (Exception e) { Timber.w(e); }\n             }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODAxOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439808018", "bodyText": "The point of executeMany is to perform a for loop in a transaction. We've lost the transaction by moving the logic outside.\nHave you considered turning this into an iterator, so we can keep the current structure, keep a low memory profile and retain the transaction behaviour", "author": "david-allison-1", "createdAt": "2020-06-14T09:06:14Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -253,6 +281,31 @@ private void _importNotes() {\n                     }\n                 }\n                 i++;\n+\n+                // add to col partially, so as to avoid OOM\n+                if (add.size() > thresExecAdd){", "originalCommit": "51ff7c61445aeafe71e07e83654b01837a95359d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgzNjczMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439836731", "bodyText": "Nope. Was just ferrying 2 year old code from 5 year old bugs into a PR that works for the stated problem. Transaction semantics weren't investigated. I'll look at it a bit maybe executemany can be made aware of existing transactions", "author": "mikehardy", "createdAt": "2020-06-14T14:42:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODAxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg0OTgxMg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439849812", "bodyText": "I externalized the txn mgmt in that area", "author": "mikehardy", "createdAt": "2020-06-14T17:12:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODAxOA=="}], "type": "inlineReview", "revised_code": {"commit": "be661ef74d4dacaac62591fa461ec86766867d0e", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java b/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java\nindex 3fa44d045..bfdf9470f 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java\n\n@@ -283,27 +281,27 @@ public class Anki2Importer extends Importer {\n                 i++;\n \n                 // add to col partially, so as to avoid OOM\n-                if (add.size() > thresExecAdd){\n-                    totalAddSize  += add.size();\n-                    mDst.getDb().executeMany(\"insert or replace into notes values (?,?,?,?,?,?,?,?,?,?,?)\", add);\n+                if (add.size() > thresExecAdd) {\n+                    totalAddCount  += add.size();\n+                    addNotes(add);\n                     add.clear();\n-                    Timber.d(\"add notes: \"+totalAddSize);\n+                    Timber.d(\"add notes: %d\", totalAddCount);\n                 }\n                 // add to col partially, so as to avoid OOM\n                 if (update.size() > thresExecUpdate){\n-                    totalUpdateSize  += update.size();\n-                    mDst.getDb().executeMany(\"insert or replace into notes values (?,?,?,?,?,?,?,?,?,?,?)\", update);\n-                    update.clear();//update = new ArrayList<>();\n-                    Timber.d(\"update notes: \"+totalUpdateSize);\n+                    totalUpdateCount  += update.size();\n+                    updateNotes(update);\n+                    update.clear();\n+                    Timber.d(\"update notes: %d\", totalUpdateCount);\n                 }\n                 // add to col partially, so as to avoid OOM\n-                if (dirty.size() > thresExecDirty){\n-                    totalDirtySize  += dirty.size();\n-                   long[] das = Utils.arrayList2array(dirty);\n+                if (dirty.size() > thresExecDirty) {\n+                    totalDirtyCount  += dirty.size();\n+                    long[] das = Utils.arrayList2array(dirty);\n                     mDst.updateFieldCache(das);\n                     mDst.getTags().registerNotes(das);\n-                    dirty.clear();//dirty = new ArrayList<>();\n-                    Timber.d(\"dirty notes: \"+totalDirtySize);\n+                    dirty.clear();\n+                    Timber.d(\"dirty notes: %d\", totalDirtyCount);\n                 }\n \n                 if (total != 0 && (!largeCollection || i % onePercent == 0)) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODE5OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439808198", "bodyText": "Nit: These concatenations inside Timber should be showing lint warnings to use format strings", "author": "david-allison-1", "createdAt": "2020-06-14T09:08:09Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -253,6 +281,31 @@ private void _importNotes() {\n                     }\n                 }\n                 i++;\n+\n+                // add to col partially, so as to avoid OOM\n+                if (add.size() > thresExecAdd){\n+                    totalAddSize  += add.size();\n+                    mDst.getDb().executeMany(\"insert or replace into notes values (?,?,?,?,?,?,?,?,?,?,?)\", add);\n+                    add.clear();\n+                    Timber.d(\"add notes: \"+totalAddSize);", "originalCommit": "51ff7c61445aeafe71e07e83654b01837a95359d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg0MTIxNA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439841214", "bodyText": "I used to get those as well. I also remember Timber lint rules showing some sort of internal linter versioning deprecation, and now they don't work - I wonder if Android Studio upgrade broke that? Timber unfortunately non-responsive at the moment though that maintainer is typically thorough \ud83e\udd14 JakeWharton/timber#391", "author": "mikehardy", "createdAt": "2020-06-14T15:31:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODE5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg0MTU1NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439841554", "bodyText": "Actually, it showed up as lint in the IDE in another area. Some IDE artifact. Anyway, changing them all to formatting now", "author": "mikehardy", "createdAt": "2020-06-14T15:34:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODE5OA=="}], "type": "inlineReview", "revised_code": {"commit": "be661ef74d4dacaac62591fa461ec86766867d0e", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java b/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java\nindex 3fa44d045..bfdf9470f 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java\n\n@@ -283,27 +281,27 @@ public class Anki2Importer extends Importer {\n                 i++;\n \n                 // add to col partially, so as to avoid OOM\n-                if (add.size() > thresExecAdd){\n-                    totalAddSize  += add.size();\n-                    mDst.getDb().executeMany(\"insert or replace into notes values (?,?,?,?,?,?,?,?,?,?,?)\", add);\n+                if (add.size() > thresExecAdd) {\n+                    totalAddCount  += add.size();\n+                    addNotes(add);\n                     add.clear();\n-                    Timber.d(\"add notes: \"+totalAddSize);\n+                    Timber.d(\"add notes: %d\", totalAddCount);\n                 }\n                 // add to col partially, so as to avoid OOM\n                 if (update.size() > thresExecUpdate){\n-                    totalUpdateSize  += update.size();\n-                    mDst.getDb().executeMany(\"insert or replace into notes values (?,?,?,?,?,?,?,?,?,?,?)\", update);\n-                    update.clear();//update = new ArrayList<>();\n-                    Timber.d(\"update notes: \"+totalUpdateSize);\n+                    totalUpdateCount  += update.size();\n+                    updateNotes(update);\n+                    update.clear();\n+                    Timber.d(\"update notes: %d\", totalUpdateCount);\n                 }\n                 // add to col partially, so as to avoid OOM\n-                if (dirty.size() > thresExecDirty){\n-                    totalDirtySize  += dirty.size();\n-                   long[] das = Utils.arrayList2array(dirty);\n+                if (dirty.size() > thresExecDirty) {\n+                    totalDirtyCount  += dirty.size();\n+                    long[] das = Utils.arrayList2array(dirty);\n                     mDst.updateFieldCache(das);\n                     mDst.getTags().registerNotes(das);\n-                    dirty.clear();//dirty = new ArrayList<>();\n-                    Timber.d(\"dirty notes: \"+totalDirtySize);\n+                    dirty.clear();\n+                    Timber.d(\"dirty notes: %d\", totalDirtyCount);\n                 }\n \n                 if (total != 0 && (!largeCollection || i % onePercent == 0)) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODM3NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439808374", "bodyText": "Could you change size for count here. Size (to me) implies a file size.", "author": "david-allison-1", "createdAt": "2020-06-14T09:10:32Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -264,9 +317,15 @@ private void _importNotes() {\n                 cur.close();\n             }\n         }\n+\n+        // summarize partial add/update/dirty results for total values\n+        totalAddSize += add.size();", "originalCommit": "51ff7c61445aeafe71e07e83654b01837a95359d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg0Mzk0OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439843948", "bodyText": "No, size is not a method on ArrayList.", "author": "mikehardy", "createdAt": "2020-06-14T16:02:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg0NDgxMw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439844813", "bodyText": "I was referring to the variable name, but implementer's choice", "author": "david-allison-1", "createdAt": "2020-06-14T16:11:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg0NTM3MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439845370", "bodyText": "Ah! Sure. Still in there haven't pushed the NF whitespace commit", "author": "mikehardy", "createdAt": "2020-06-14T16:18:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODM3NA=="}], "type": "inlineReview", "revised_code": {"commit": "be661ef74d4dacaac62591fa461ec86766867d0e", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java b/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java\nindex 3fa44d045..bfdf9470f 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java\n\n@@ -319,35 +317,40 @@ public class Anki2Importer extends Importer {\n         }\n \n         // summarize partial add/update/dirty results for total values\n-        totalAddSize += add.size();\n-        totalUpdateSize += update.size();\n-        totalDirtySize += dirty.size();\n+        totalAddCount += add.size();\n+        totalUpdateCount += update.size();\n+        totalDirtyCount += dirty.size();\n \n         if (dupes > 0) {\n-            int up = totalUpdateSize;\n-            mLog.add(getRes().getString(R.string.import_update_details, totalUpdateSize, dupes));\n+            mLog.add(getRes().getString(R.string.import_update_details, totalUpdateCount, dupes));\n             if (dupesIgnored.size() > 0) {\n                 mLog.add(getRes().getString(R.string.import_update_ignored));\n-                // TODO: uncomment this and fix above string if we implement a detailed\n-                // log viewer dialog type.\n-                //mLog.addAll(dupesIgnored);\n             }\n         }\n         // export info for calling code\n         mDupes = dupes;\n-        mAdded = totalAddSize;\n-        mUpdated = totalUpdateSize;\n-        Timber.d(\"add notes in total: \" + totalAddSize);\n-        Timber.d(\"update notes in total: \" + totalUpdateSize);\n-        Timber.d(\"dirty notes in total: \" + totalDirtySize);\n+        mAdded = totalAddCount;\n+        mUpdated = totalUpdateCount;\n+        Timber.d(\"add notes total:    %d\", totalAddCount);\n+        Timber.d(\"update notes total: %d\", totalUpdateCount);\n+        Timber.d(\"dirty notes total:  %d\", totalDirtyCount);\n         // add to col (for last chunk)\n-        mDst.getDb().executeMany(\"insert or replace into notes values (?,?,?,?,?,?,?,?,?,?,?)\", add);\n-        mDst.getDb().executeMany(\"insert or replace into notes values (?,?,?,?,?,?,?,?,?,?,?)\", update);\n+        addNotes(add);\n+        add.clear();\n+        updateNotes(update);\n+        update.clear();\n         long[] das = Utils.arrayList2array(dirty);\n         mDst.updateFieldCache(das);\n         mDst.getTags().registerNotes(das);\n     }\n \n+    private void addNotes(List<Object[]> add) {\n+        mDst.getDb().executeMany(\"insert or replace into notes values (?,?,?,?,?,?,?,?,?,?,?)\", add);\n+    }\n+\n+    private void updateNotes(List<Object[]> update) {\n+        mDst.getDb().executeMany(\"insert or replace into notes values (?,?,?,?,?,?,?,?,?,?,?)\", update);\n+    }\n \n     // determine if note is a duplicate, and adjust mid and/or guid as required\n     // returns true if note should be added\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODQxOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439808418", "bodyText": "nit: whitespace", "author": "david-allison-1", "createdAt": "2020-06-14T09:10:57Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -307,7 +369,6 @@ private boolean _uniquifyNote(Object[] note) {\n \t\treturn false;\n     }\n ", "originalCommit": "51ff7c61445aeafe71e07e83654b01837a95359d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgzNjg0Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439836843", "bodyText": "I'll do one nf commit for whitespace and formatting but I wanted to leave the original commit intact as respect for the OP", "author": "mikehardy", "createdAt": "2020-06-14T14:43:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODQxOA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODQ0OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439808448", "bodyText": "nit: whitespace", "author": "david-allison-1", "createdAt": "2020-06-14T09:11:17Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -205,6 +231,8 @@ private void _importNotes() {\n             int onePercent = total/100;\n             int i = 0;\n \n+\n+", "originalCommit": "51ff7c61445aeafe71e07e83654b01837a95359d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "be661ef74d4dacaac62591fa461ec86766867d0e", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java b/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java\nindex 3fa44d045..bfdf9470f 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java\n\n@@ -231,8 +231,6 @@ public class Anki2Importer extends Importer {\n             int onePercent = total/100;\n             int i = 0;\n \n-\n-\n             while (cur.moveToNext()) {\n                 // turn the db result into a mutable list\n                 Object[] note = new Object[]{cur.getLong(0), cur.getString(1), cur.getLong(2),\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODQ3NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439808474", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            if(cards.size() > thresExecCards){\n          \n          \n            \n                            if (cards.size() > thresExecCards){", "author": "david-allison-1", "createdAt": "2020-06-14T09:11:36Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -546,6 +611,21 @@ private void _importCards() {\n                 }\n                 cnt += 1;\n                 i++;\n+                // apply card changes partially\n+                if(cards.size() > thresExecCards){", "originalCommit": "51ff7c61445aeafe71e07e83654b01837a95359d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "be661ef74d4dacaac62591fa461ec86766867d0e", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java b/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java\nindex 3fa44d045..bfdf9470f 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java\n\n@@ -609,21 +611,20 @@ public class Anki2Importer extends Importer {\n                         revlog.add(rev);\n                     }\n                 }\n-                cnt += 1;\n                 i++;\n                 // apply card changes partially\n-                if(cards.size() > thresExecCards){\n-                    totalCardsSize += cards.size();\n-                    mDst.getDb().executeMany(\"insert or ignore into cards values (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)\", cards);\n+                if (cards.size() > thresExecCards) {\n+                    totalCardCount += cards.size();\n+                    insertCards(cards);\n                     cards.clear();\n-                    Timber.d(\"add cards: \"+totalCardsSize);\n+                    Timber.d(\"add cards: %d\", totalCardCount);\n                 }\n                 // apply revlog changes partially\n-                if(revlog.size() > thresExecRevlog){\n-                    totalRevlogSize += revlog.size();\n-                    mDst.getDb().executeMany(\"insert or ignore into revlog values (?,?,?,?,?,?,?,?,?)\", revlog);\n+                if (revlog.size() > thresExecRevlog) {\n+                    totalRevlogCount += revlog.size();\n+                    insertRevlog(revlog);\n                     revlog.clear();\n-                    Timber.d(\"add revlog: \"+totalRevlogSize);\n+                    Timber.d(\"add revlog: %d\", totalRevlogCount);\n                 }\n \n                 if (total != 0 && (!largeCollection || i % onePercent == 0)) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODQ5Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439808496", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            if(revlog.size() > thresExecRevlog){\n          \n          \n            \n                            if (revlog.size() > thresExecRevlog){", "author": "david-allison-1", "createdAt": "2020-06-14T09:11:49Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -546,6 +611,21 @@ private void _importCards() {\n                 }\n                 cnt += 1;\n                 i++;\n+                // apply card changes partially\n+                if(cards.size() > thresExecCards){\n+                    totalCardsSize += cards.size();\n+                    mDst.getDb().executeMany(\"insert or ignore into cards values (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)\", cards);\n+                    cards.clear();\n+                    Timber.d(\"add cards: \"+totalCardsSize);\n+                }\n+                // apply revlog changes partially\n+                if(revlog.size() > thresExecRevlog){", "originalCommit": "51ff7c61445aeafe71e07e83654b01837a95359d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "be661ef74d4dacaac62591fa461ec86766867d0e", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java b/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java\nindex 3fa44d045..bfdf9470f 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java\n\n@@ -609,21 +611,20 @@ public class Anki2Importer extends Importer {\n                         revlog.add(rev);\n                     }\n                 }\n-                cnt += 1;\n                 i++;\n                 // apply card changes partially\n-                if(cards.size() > thresExecCards){\n-                    totalCardsSize += cards.size();\n-                    mDst.getDb().executeMany(\"insert or ignore into cards values (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)\", cards);\n+                if (cards.size() > thresExecCards) {\n+                    totalCardCount += cards.size();\n+                    insertCards(cards);\n                     cards.clear();\n-                    Timber.d(\"add cards: \"+totalCardsSize);\n+                    Timber.d(\"add cards: %d\", totalCardCount);\n                 }\n                 // apply revlog changes partially\n-                if(revlog.size() > thresExecRevlog){\n-                    totalRevlogSize += revlog.size();\n-                    mDst.getDb().executeMany(\"insert or ignore into revlog values (?,?,?,?,?,?,?,?,?)\", revlog);\n+                if (revlog.size() > thresExecRevlog) {\n+                    totalRevlogCount += revlog.size();\n+                    insertRevlog(revlog);\n                     revlog.clear();\n-                    Timber.d(\"add revlog: \"+totalRevlogSize);\n+                    Timber.d(\"add revlog: %d\", totalRevlogCount);\n                 }\n \n                 if (total != 0 && (!largeCollection || i % onePercent == 0)) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODUyNg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439808526", "bodyText": "This logic seems duplicated, can we combine it?", "author": "david-allison-1", "createdAt": "2020-06-14T09:12:07Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -546,6 +611,21 @@ private void _importCards() {\n                 }\n                 cnt += 1;\n                 i++;\n+                // apply card changes partially", "originalCommit": "51ff7c61445aeafe71e07e83654b01837a95359d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg0NDA4MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439844080", "bodyText": "No, they increment independently each card can have many revisions, and the revisions might cause OOM before cards would get there, or vice versa.", "author": "mikehardy", "createdAt": "2020-06-14T16:03:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODUyNg=="}], "type": "inlineReview", "revised_code": {"commit": "be661ef74d4dacaac62591fa461ec86766867d0e", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java b/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java\nindex 3fa44d045..bfdf9470f 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java\n\n@@ -609,21 +611,20 @@ public class Anki2Importer extends Importer {\n                         revlog.add(rev);\n                     }\n                 }\n-                cnt += 1;\n                 i++;\n                 // apply card changes partially\n-                if(cards.size() > thresExecCards){\n-                    totalCardsSize += cards.size();\n-                    mDst.getDb().executeMany(\"insert or ignore into cards values (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)\", cards);\n+                if (cards.size() > thresExecCards) {\n+                    totalCardCount += cards.size();\n+                    insertCards(cards);\n                     cards.clear();\n-                    Timber.d(\"add cards: \"+totalCardsSize);\n+                    Timber.d(\"add cards: %d\", totalCardCount);\n                 }\n                 // apply revlog changes partially\n-                if(revlog.size() > thresExecRevlog){\n-                    totalRevlogSize += revlog.size();\n-                    mDst.getDb().executeMany(\"insert or ignore into revlog values (?,?,?,?,?,?,?,?,?)\", revlog);\n+                if (revlog.size() > thresExecRevlog) {\n+                    totalRevlogCount += revlog.size();\n+                    insertRevlog(revlog);\n                     revlog.clear();\n-                    Timber.d(\"add revlog: \"+totalRevlogSize);\n+                    Timber.d(\"add revlog: %d\", totalRevlogCount);\n                 }\n \n                 if (total != 0 && (!largeCollection || i % onePercent == 0)) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODY0Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439808643", "bodyText": "Optional: could we move these two lines next to each other so it's obvious the spacing is for output purposes.", "author": "david-allison-1", "createdAt": "2020-06-14T09:13:42Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/AnkiPackageImporter.java", "diffHunk": "@@ -64,6 +65,18 @@ public void run() throws ImportExportException {\n                 if (mZip.getEntry(colname) == null) {\n                     colname = CollectionHelper.COLLECTION_FILENAME;\n                 }\n+\n+                // Make sure we have sufficient free space\n+                long uncompressedSize = Utils.calculateUncompressedSize(mZip);\n+                Timber.d(\"Total uncompressed size will be: \" + uncompressedSize);\n+                long availableSpace = Utils.determineBytesAvailable(mCol.getPath());\n+                Timber.d(\"Total available size is:         \" + availableSpace);", "originalCommit": "51ff7c61445aeafe71e07e83654b01837a95359d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "be661ef74d4dacaac62591fa461ec86766867d0e", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/libanki/importer/AnkiPackageImporter.java b/AnkiDroid/src/main/java/com/ichi2/libanki/importer/AnkiPackageImporter.java\nindex 5759bea1e..25375d2cc 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/libanki/importer/AnkiPackageImporter.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/libanki/importer/AnkiPackageImporter.java\n\n@@ -68,11 +68,11 @@ public class AnkiPackageImporter extends Anki2Importer {\n \n                 // Make sure we have sufficient free space\n                 long uncompressedSize = Utils.calculateUncompressedSize(mZip);\n-                Timber.d(\"Total uncompressed size will be: \" + uncompressedSize);\n                 long availableSpace = Utils.determineBytesAvailable(mCol.getPath());\n-                Timber.d(\"Total available size is:         \" + availableSpace);\n+                Timber.d(\"Total uncompressed size will be: %d\", uncompressedSize);\n+                Timber.d(\"Total available size is:         %d\", availableSpace);\n                 if (uncompressedSize > availableSpace) {\n-                    Timber.e(\"Not enough space to unzip, need \" + uncompressedSize + \", available \" + availableSpace);\n+                    Timber.e(\"Not enough space to unzip, need %d, available %d\", uncompressedSize, availableSpace);\n                     mLog.add(getRes().getString(R.string.import_log_insufficient_space, uncompressedSize, availableSpace));\n                     return;\n                 }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODg3Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439808876", "bodyText": "various nitpicks on the placement of the plus\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                Timber.d(\"add cards: \"+totalCardsSize);\n          \n          \n            \n                                Timber.d(\"add cards: \"+ totalCardsSize);", "author": "david-allison-1", "createdAt": "2020-06-14T09:16:22Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -546,6 +611,21 @@ private void _importCards() {\n                 }\n                 cnt += 1;\n                 i++;\n+                // apply card changes partially\n+                if(cards.size() > thresExecCards){\n+                    totalCardsSize += cards.size();\n+                    mDst.getDb().executeMany(\"insert or ignore into cards values (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)\", cards);\n+                    cards.clear();\n+                    Timber.d(\"add cards: \"+totalCardsSize);", "originalCommit": "51ff7c61445aeafe71e07e83654b01837a95359d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "be661ef74d4dacaac62591fa461ec86766867d0e", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java b/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java\nindex 3fa44d045..bfdf9470f 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java\n\n@@ -609,21 +611,20 @@ public class Anki2Importer extends Importer {\n                         revlog.add(rev);\n                     }\n                 }\n-                cnt += 1;\n                 i++;\n                 // apply card changes partially\n-                if(cards.size() > thresExecCards){\n-                    totalCardsSize += cards.size();\n-                    mDst.getDb().executeMany(\"insert or ignore into cards values (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)\", cards);\n+                if (cards.size() > thresExecCards) {\n+                    totalCardCount += cards.size();\n+                    insertCards(cards);\n                     cards.clear();\n-                    Timber.d(\"add cards: \"+totalCardsSize);\n+                    Timber.d(\"add cards: %d\", totalCardCount);\n                 }\n                 // apply revlog changes partially\n-                if(revlog.size() > thresExecRevlog){\n-                    totalRevlogSize += revlog.size();\n-                    mDst.getDb().executeMany(\"insert or ignore into revlog values (?,?,?,?,?,?,?,?,?)\", revlog);\n+                if (revlog.size() > thresExecRevlog) {\n+                    totalRevlogCount += revlog.size();\n+                    insertRevlog(revlog);\n                     revlog.clear();\n-                    Timber.d(\"add revlog: \"+totalRevlogSize);\n+                    Timber.d(\"add revlog: %d\", totalRevlogCount);\n                 }\n \n                 if (total != 0 && (!largeCollection || i % onePercent == 0)) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODkyMg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439808922", "bodyText": "Definitely better with string formatting on this one", "author": "david-allison-1", "createdAt": "2020-06-14T09:16:57Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/AnkiPackageImporter.java", "diffHunk": "@@ -64,6 +65,18 @@ public void run() throws ImportExportException {\n                 if (mZip.getEntry(colname) == null) {\n                     colname = CollectionHelper.COLLECTION_FILENAME;\n                 }\n+\n+                // Make sure we have sufficient free space\n+                long uncompressedSize = Utils.calculateUncompressedSize(mZip);\n+                Timber.d(\"Total uncompressed size will be: \" + uncompressedSize);\n+                long availableSpace = Utils.determineBytesAvailable(mCol.getPath());\n+                Timber.d(\"Total available size is:         \" + availableSpace);\n+                if (uncompressedSize > availableSpace) {\n+                    Timber.e(\"Not enough space to unzip, need \" + uncompressedSize + \", available \" + availableSpace);", "originalCommit": "51ff7c61445aeafe71e07e83654b01837a95359d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "be661ef74d4dacaac62591fa461ec86766867d0e", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/libanki/importer/AnkiPackageImporter.java b/AnkiDroid/src/main/java/com/ichi2/libanki/importer/AnkiPackageImporter.java\nindex 5759bea1e..25375d2cc 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/libanki/importer/AnkiPackageImporter.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/libanki/importer/AnkiPackageImporter.java\n\n@@ -68,11 +68,11 @@ public class AnkiPackageImporter extends Anki2Importer {\n \n                 // Make sure we have sufficient free space\n                 long uncompressedSize = Utils.calculateUncompressedSize(mZip);\n-                Timber.d(\"Total uncompressed size will be: \" + uncompressedSize);\n                 long availableSpace = Utils.determineBytesAvailable(mCol.getPath());\n-                Timber.d(\"Total available size is:         \" + availableSpace);\n+                Timber.d(\"Total uncompressed size will be: %d\", uncompressedSize);\n+                Timber.d(\"Total available size is:         %d\", availableSpace);\n                 if (uncompressedSize > availableSpace) {\n-                    Timber.e(\"Not enough space to unzip, need \" + uncompressedSize + \", available \" + availableSpace);\n+                    Timber.e(\"Not enough space to unzip, need %d, available %d\", uncompressedSize, availableSpace);\n                     mLog.add(getRes().getString(R.string.import_log_insufficient_space, uncompressedSize, availableSpace));\n                     return;\n                 }\n"}}, {"oid": "ed9db84b64ae40f0e80dafff96b07dfd0b90cfd8", "url": "https://github.com/ankidroid/Anki-Android/commit/ed9db84b64ae40f0e80dafff96b07dfd0b90cfd8", "message": "NF: de-lint format strings, fixes were made in crowdin so will persist\n\nJust committing them here to make sure the strings go green, without\ndoing a full strings sync. All verified on crowdin though, the fixes\nare in upstream", "committedDate": "2020-06-14T15:56:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1OTQ4Nw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439859487", "bodyText": "Are these d or v? could have 30000 notes in a collection", "author": "david-allison-1", "createdAt": "2020-06-14T19:16:45Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -253,39 +279,84 @@ private void _importNotes() {\n                     }\n                 }\n                 i++;\n+\n+                // add to col partially, so as to avoid OOM\n+                if (add.size() >= thresExecAdd) {\n+                    totalAddCount  += add.size();\n+                    addNotes(add);\n+                    add.clear();\n+                    Timber.d(\"add notes: %d\", totalAddCount);\n+                }\n+                // add to col partially, so as to avoid OOM\n+                if (update.size() >= thresExecUpdate){\n+                    totalUpdateCount  += update.size();\n+                    updateNotes(update);\n+                    update.clear();\n+                    Timber.d(\"update notes: %d\", totalUpdateCount);\n+                }\n+                // add to col partially, so as to avoid OOM\n+                if (dirty.size() >= thresExecDirty) {\n+                    totalDirtyCount  += dirty.size();\n+                   long[] das = Utils.arrayList2array(dirty);\n+                    mDst.updateFieldCache(das);\n+                    mDst.getTags().registerNotes(das);\n+                    dirty.clear();\n+                    Timber.d(\"dirty notes: %d\", totalDirtyCount);", "originalCommit": "61223b2d9b9da6058fca5a642cb72230bdf043bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI3NDIzNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r440274235", "bodyText": "There were well over that number of notes in the OOM zip I was testing and %d had no problem handling it? I'll investigate", "author": "mikehardy", "createdAt": "2020-06-15T15:49:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1OTQ4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI4MTk0NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r440281945", "bodyText": "I see no 'v' possibility for String.format which is used by Timber internally and then delegates to java.util.Formatter https://developer.android.com/reference/java/util/Formatter#conversions which seems as though it can handle any number you throw at it, and matches my testing experience - no problem with this Timber line", "author": "mikehardy", "createdAt": "2020-06-15T16:00:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1OTQ4Nw=="}], "type": "inlineReview", "revised_code": {"commit": "be661ef74d4dacaac62591fa461ec86766867d0e", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java b/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java\nindex 3b98dcd36..bfdf9470f 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java\n\n@@ -281,23 +281,23 @@ public class Anki2Importer extends Importer {\n                 i++;\n \n                 // add to col partially, so as to avoid OOM\n-                if (add.size() >= thresExecAdd) {\n+                if (add.size() > thresExecAdd) {\n                     totalAddCount  += add.size();\n                     addNotes(add);\n                     add.clear();\n                     Timber.d(\"add notes: %d\", totalAddCount);\n                 }\n                 // add to col partially, so as to avoid OOM\n-                if (update.size() >= thresExecUpdate){\n+                if (update.size() > thresExecUpdate){\n                     totalUpdateCount  += update.size();\n                     updateNotes(update);\n                     update.clear();\n                     Timber.d(\"update notes: %d\", totalUpdateCount);\n                 }\n                 // add to col partially, so as to avoid OOM\n-                if (dirty.size() >= thresExecDirty) {\n+                if (dirty.size() > thresExecDirty) {\n                     totalDirtyCount  += dirty.size();\n-                   long[] das = Utils.arrayList2array(dirty);\n+                    long[] das = Utils.arrayList2array(dirty);\n                     mDst.updateFieldCache(das);\n                     mDst.getTags().registerNotes(das);\n                     dirty.clear();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1OTUwMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439859501", "bodyText": "Nittiest of nits\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                               long[] das = Utils.arrayList2array(dirty);\n          \n          \n            \n                                long[] das = Utils.arrayList2array(dirty);", "author": "david-allison-1", "createdAt": "2020-06-14T19:16:57Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -253,39 +279,84 @@ private void _importNotes() {\n                     }\n                 }\n                 i++;\n+\n+                // add to col partially, so as to avoid OOM\n+                if (add.size() >= thresExecAdd) {\n+                    totalAddCount  += add.size();\n+                    addNotes(add);\n+                    add.clear();\n+                    Timber.d(\"add notes: %d\", totalAddCount);\n+                }\n+                // add to col partially, so as to avoid OOM\n+                if (update.size() >= thresExecUpdate){\n+                    totalUpdateCount  += update.size();\n+                    updateNotes(update);\n+                    update.clear();\n+                    Timber.d(\"update notes: %d\", totalUpdateCount);\n+                }\n+                // add to col partially, so as to avoid OOM\n+                if (dirty.size() >= thresExecDirty) {\n+                    totalDirtyCount  += dirty.size();\n+                   long[] das = Utils.arrayList2array(dirty);", "originalCommit": "61223b2d9b9da6058fca5a642cb72230bdf043bb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "be661ef74d4dacaac62591fa461ec86766867d0e", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java b/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java\nindex 3b98dcd36..bfdf9470f 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java\n\n@@ -281,23 +281,23 @@ public class Anki2Importer extends Importer {\n                 i++;\n \n                 // add to col partially, so as to avoid OOM\n-                if (add.size() >= thresExecAdd) {\n+                if (add.size() > thresExecAdd) {\n                     totalAddCount  += add.size();\n                     addNotes(add);\n                     add.clear();\n                     Timber.d(\"add notes: %d\", totalAddCount);\n                 }\n                 // add to col partially, so as to avoid OOM\n-                if (update.size() >= thresExecUpdate){\n+                if (update.size() > thresExecUpdate){\n                     totalUpdateCount  += update.size();\n                     updateNotes(update);\n                     update.clear();\n                     Timber.d(\"update notes: %d\", totalUpdateCount);\n                 }\n                 // add to col partially, so as to avoid OOM\n-                if (dirty.size() >= thresExecDirty) {\n+                if (dirty.size() > thresExecDirty) {\n                     totalDirtyCount  += dirty.size();\n-                   long[] das = Utils.arrayList2array(dirty);\n+                    long[] das = Utils.arrayList2array(dirty);\n                     mDst.updateFieldCache(das);\n                     mDst.getTags().registerNotes(das);\n                     dirty.clear();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1OTk3Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439859976", "bodyText": "Much nicer, thanks", "author": "david-allison-1", "createdAt": "2020-06-14T19:23:54Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/AnkiPackageImporter.java", "diffHunk": "@@ -64,6 +65,18 @@ public void run() throws ImportExportException {\n                 if (mZip.getEntry(colname) == null) {\n                     colname = CollectionHelper.COLLECTION_FILENAME;\n                 }\n+\n+                // Make sure we have sufficient free space\n+                long uncompressedSize = Utils.calculateUncompressedSize(mZip);\n+                long availableSpace = Utils.determineBytesAvailable(mCol.getPath());\n+                Timber.d(\"Total uncompressed size will be: %d\", uncompressedSize);\n+                Timber.d(\"Total available size is:         %d\", availableSpace);\n+                if (uncompressedSize > availableSpace) {", "originalCommit": "61223b2d9b9da6058fca5a642cb72230bdf043bb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg2MDE1Nw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439860157", "bodyText": "There may be bugs in determineBytesAvailable: #6442 (could also be my issue).\nIf so, do we need a way to override?", "author": "david-allison-1", "createdAt": "2020-06-14T19:26:10Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/AnkiPackageImporter.java", "diffHunk": "@@ -64,6 +65,18 @@ public void run() throws ImportExportException {\n                 if (mZip.getEntry(colname) == null) {\n                     colname = CollectionHelper.COLLECTION_FILENAME;\n                 }\n+\n+                // Make sure we have sufficient free space\n+                long uncompressedSize = Utils.calculateUncompressedSize(mZip);\n+                long availableSpace = Utils.determineBytesAvailable(mCol.getPath());\n+                Timber.d(\"Total uncompressed size will be: %d\", uncompressedSize);\n+                Timber.d(\"Total available size is:         %d\", availableSpace);\n+                if (uncompressedSize > availableSpace) {\n+                    Timber.e(\"Not enough space to unzip, need %d, available %d\", uncompressedSize, availableSpace);\n+                    mLog.add(getRes().getString(R.string.import_log_insufficient_space, uncompressedSize, availableSpace));", "originalCommit": "61223b2d9b9da6058fca5a642cb72230bdf043bb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "be661ef74d4dacaac62591fa461ec86766867d0e", "url": "https://github.com/ankidroid/Anki-Android/commit/be661ef74d4dacaac62591fa461ec86766867d0e", "message": "NF: whitespace and timber log format in importers", "committedDate": "2020-06-15T16:02:54Z", "type": "commit"}, {"oid": "0e984f80b7f21dbf704e0412154025e00ad3f154", "url": "https://github.com/ankidroid/Anki-Android/commit/0e984f80b7f21dbf704e0412154025e00ad3f154", "message": "External txn mgmt in importers new partial commits", "committedDate": "2020-06-15T16:02:57Z", "type": "commit"}, {"oid": "0e984f80b7f21dbf704e0412154025e00ad3f154", "url": "https://github.com/ankidroid/Anki-Android/commit/0e984f80b7f21dbf704e0412154025e00ad3f154", "message": "External txn mgmt in importers new partial commits", "committedDate": "2020-06-15T16:02:57Z", "type": "forcePushed"}]}