{"pr_number": 7792, "pr_title": "Add check that onPageFinished runs on the viewer url", "pr_createdAt": "2020-11-29T02:10:16Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/7792", "timeline": [{"oid": "158f6995c36216441fcbb31e5779dd166ef2e3dd", "url": "https://github.com/ankidroid/Anki-Android/commit/158f6995c36216441fcbb31e5779dd166ef2e3dd", "message": "Add check that onPageFinished runs on the viewer url\n\n* without any anchors", "committedDate": "2020-11-29T02:04:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjIwOTIyMg==", "url": "https://github.com/ankidroid/Anki-Android/pull/7792#discussion_r532209222", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        Timber.d(\"onPageFinished triggered: %s\", url);\n          \n          \n            \n            \n          \n          \n            \n                        // onPageFinished will be called multiple times if the WebView redirects by setting window.location.href\n          \n          \n            \n                        if (url.equals(mViewerUrl)) {\n          \n          \n            \n                            drawFlag();\n          \n          \n            \n                            drawMark();\n          \n          \n            \n                            view.loadUrl(\"javascript:onPageFinished();\");\n          \n          \n            \n                        }\n          \n          \n            \n                        Timber.d(\"Java onPageFinished triggered: %s\", url);\n          \n          \n            \n            \n          \n          \n            \n                        // onPageFinished will be called multiple times if the WebView redirects by setting window.location.href\n          \n          \n            \n                        if (url.equals(mViewerUrl)) {\n          \n          \n            \n                            Timber.d(\"New URL, drawing flags, marks, and triggering JS onPageFinished: %s\", url);\n          \n          \n            \n                            drawFlag();\n          \n          \n            \n                            drawMark();\n          \n          \n            \n                            view.loadUrl(\"javascript:onPageFinished();\");\n          \n          \n            \n                        }", "author": "mikehardy", "createdAt": "2020-11-29T13:22:16Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java", "diffHunk": "@@ -3478,10 +3480,14 @@ private String decodeUrl(String url) {\n         // Run any post-load events in javascript that rely on the window being completely loaded.\n         @Override\n         public void onPageFinished(WebView view, String url) {\n-            Timber.d(\"onPageFinished triggered\");\n-            drawFlag();\n-            drawMark();\n-            view.loadUrl(\"javascript:onPageFinished();\");\n+            Timber.d(\"onPageFinished triggered: %s\", url);\n+\n+            // onPageFinished will be called multiple times if the WebView redirects by setting window.location.href\n+            if (url.equals(mViewerUrl)) {\n+                drawFlag();\n+                drawMark();\n+                view.loadUrl(\"javascript:onPageFinished();\");\n+            }", "originalCommit": "158f6995c36216441fcbb31e5779dd166ef2e3dd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b1a198c0c3df8d0c67e2e16f18abeab651903a45", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java b/AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java\nindex 7b9f8dbe8..1f82cda59 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java\n\n@@ -3480,10 +3480,11 @@ public abstract class AbstractFlashcardViewer extends NavigationDrawerActivity i\n         // Run any post-load events in javascript that rely on the window being completely loaded.\n         @Override\n         public void onPageFinished(WebView view, String url) {\n-            Timber.d(\"onPageFinished triggered: %s\", url);\n+            Timber.d(\"Java onPageFinished triggered: %s\", url);\n \n             // onPageFinished will be called multiple times if the WebView redirects by setting window.location.href\n             if (url.equals(mViewerUrl)) {\n+                Timber.d(\"New URL, drawing flags, marks, and triggering JS onPageFinished: %s\", url);\n                 drawFlag();\n                 drawMark();\n                 view.loadUrl(\"javascript:onPageFinished();\");\n"}}, {"oid": "b1a198c0c3df8d0c67e2e16f18abeab651903a45", "url": "https://github.com/ankidroid/Anki-Android/commit/b1a198c0c3df8d0c67e2e16f18abeab651903a45", "message": "Add additional logging for onPageFinished\n\nCo-authored-by: Mike Hardy <github@mikehardy.net>", "committedDate": "2020-11-30T13:11:28Z", "type": "commit"}]}