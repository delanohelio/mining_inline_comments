{"pr_number": 7306, "pr_title": "NF: Reviewer check whether a card is empty more quickly", "pr_createdAt": "2020-09-29T07:52:52Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/7306", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjcxNTI0NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7306#discussion_r496715244", "bodyText": "could be a constant, also is there any chance of getting at least a basic test of the area altered to make sure it actually didn't break (and to give you something to build on when you learn why it broke in something completely unexpected way later...)", "author": "mikehardy", "createdAt": "2020-09-29T13:27:19Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Models.java", "diffHunk": "@@ -1062,9 +1062,45 @@ private void _updateRequired(Model m) {\n     }\n \n \n+    /**\n+     * @param type Whether the rules to generate this card is is any, all, none\n+     * @param req The fields that must be fill (all), or that suffices (any) to generate the card\n+     * @param trimmedFields the field of a note. Fields are assumed to be trimmed\n+     * @return Whether the card is empty\n+     */\n+    public static boolean emptyStandardCard(String type, JSONArray req, String[] trimmedFields) {\n+        if (\"none\".equals(type)) {\n+            // unsatisfiable template\n+            return true;\n+        }\n+        if (\"all\".equals(type)) {", "originalCommit": "0a5e474d8e32122ad3c31ba3159a656bf208e5fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjgzNzgwNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7306#discussion_r496837805", "bodyText": "It could be a constant, indeed. It can't be an enum since it's an element of JSON\nWe already have test covering whether card are empty or not. That's the test in ModelTest which check which cards are generated (i.e. we only generate the non-empty cards)", "author": "Arthur-Milchior", "createdAt": "2020-09-29T15:50:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjcxNTI0NA=="}], "type": "inlineReview", "revised_code": {"commit": "db505818846281cf4c8ac77cf035f1cecd788618", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/libanki/Models.java b/AnkiDroid/src/main/java/com/ichi2/libanki/Models.java\nindex b82cee4639..dce0923a18 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/libanki/Models.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/libanki/Models.java\n\n@@ -1062,6 +1069,33 @@ public class Models {\n     }\n \n \n+    /**\n+     * @param m A model\n+     * @param ord a card type number of this model\n+     * @param sfld Fields of a note of this model. (Not trimmed)\n+     * @return Whether this card is empty\n+     */\n+    public static boolean emptyCard(Model m, int ord, String[] sfld) {\n+        if (m.getInt(\"type\") == Consts.MODEL_CLOZE) {\n+            // For cloze, getting the list of cloze numbes is linear in the size of the template\n+            // So computing the full list is almost as efficient as checking for a particular number\n+            return !_availClozeOrds(m, sfld, false).contains(ord);\n+        }\n+        return emptyStandardCard(m.getJSONArray(\"req\").getJSONArray(ord), sfld);\n+    }\n+\n+    /**\n+     * @param sr The requirement telling whether a card should be generated.\n+     * @param sfld The vector of fields of a note. (Not trimmed)\n+     * @return Whether the standard card is empty\n+     */\n+    public static boolean emptyStandardCard(JSONArray sr, String[] sfld) {\n+        String[] fields = trimArray(sfld);\n+        String type = sr.getString(1);\n+        JSONArray req = sr.getJSONArray(2);\n+        return emptyStandardCard(type, req, fields);\n+    }\n+\n     /**\n      * @param type Whether the rules to generate this card is is any, all, none\n      * @param req The fields that must be fill (all), or that suffices (any) to generate the card\n"}}, {"oid": "db505818846281cf4c8ac77cf035f1cecd788618", "url": "https://github.com/ankidroid/Anki-Android/commit/db505818846281cf4c8ac77cf035f1cecd788618", "message": "NF: Card.isEmpty consider a single card", "committedDate": "2020-09-29T22:02:14Z", "type": "forcePushed"}, {"oid": "4e4d376e01f1ae9388590e58aee9cb6be6b9d1a5", "url": "https://github.com/ankidroid/Anki-Android/commit/4e4d376e01f1ae9388590e58aee9cb6be6b9d1a5", "message": "NF: Card.isEmpty consider a single card", "committedDate": "2020-10-23T11:26:31Z", "type": "forcePushed"}, {"oid": "74ae7f4824fa6c864a7a37e2b71507b836639ccf", "url": "https://github.com/ankidroid/Anki-Android/commit/74ae7f4824fa6c864a7a37e2b71507b836639ccf", "message": "NF: availords is static\n\nWhether a card is generated or not does not depends on the manager nor on the call at all", "committedDate": "2020-10-23T20:21:07Z", "type": "commit"}, {"oid": "5e3ebedf4221ae92e4ac721ff8f14a5b19f8283f", "url": "https://github.com/ankidroid/Anki-Android/commit/5e3ebedf4221ae92e4ac721ff8f14a5b19f8283f", "message": "NF: trim array in an external method", "committedDate": "2020-10-23T20:21:15Z", "type": "commit"}, {"oid": "97d8567f2d49e24e8e54aa874adac3949fec0d01", "url": "https://github.com/ankidroid/Anki-Android/commit/97d8567f2d49e24e8e54aa874adac3949fec0d01", "message": "NF: split _availStandardOrds from availOrds", "committedDate": "2020-10-23T20:21:15Z", "type": "commit"}, {"oid": "812574439fc62f331b39743393fa1c5d9fb94cd9", "url": "https://github.com/ankidroid/Anki-Android/commit/812574439fc62f331b39743393fa1c5d9fb94cd9", "message": "NF: split availOrds", "committedDate": "2020-10-23T20:21:36Z", "type": "commit"}, {"oid": "8fd738d3a1b05502a5f3c2590f2a9ff57e2cb9fd", "url": "https://github.com/ankidroid/Anki-Android/commit/8fd738d3a1b05502a5f3c2590f2a9ff57e2cb9fd", "message": "NF: Card.isEmpty consider a single card", "committedDate": "2020-10-23T20:21:48Z", "type": "commit"}, {"oid": "8fd738d3a1b05502a5f3c2590f2a9ff57e2cb9fd", "url": "https://github.com/ankidroid/Anki-Android/commit/8fd738d3a1b05502a5f3c2590f2a9ff57e2cb9fd", "message": "NF: Card.isEmpty consider a single card", "committedDate": "2020-10-23T20:21:48Z", "type": "forcePushed"}]}