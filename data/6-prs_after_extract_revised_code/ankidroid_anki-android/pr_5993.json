{"pr_number": 5993, "pr_title": "In-Memory Multimedia Editor", "pr_createdAt": "2020-04-13T10:53:06Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/5993", "timeline": [{"oid": "5e331bc783d90378787e98c99b335f8be8ba3326", "url": "https://github.com/ankidroid/Anki-Android/commit/5e331bc783d90378787e98c99b335f8be8ba3326", "message": "LINT: NoteEditor", "committedDate": "2020-04-13T10:44:47Z", "type": "commit"}, {"oid": "c73658c9c00e42e688f4c37c811e11628206420e", "url": "https://github.com/ankidroid/Anki-Android/commit/c73658c9c00e42e688f4c37c811e11628206420e", "message": "Multimedia Editor - Use Current Field Values\n\nFixes #5992\n\nPreviously, we were using the field values from the existing model in\nthe database when editing fields.\n\nNow, we use the values shown in the UI.", "committedDate": "2020-04-13T12:08:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ4MzYyNA==", "url": "https://github.com/ankidroid/Anki-Android/pull/5993#discussion_r407483624", "bodyText": "This is not the proper use of the Compat infrastructure\nIf you can't put a comment on top of every single API that you add to Compat that explains the difference in behavior across Android versions, and in which exact version you can remove the Compat API with old workaround-implementation and inline the \"modern\" implementation, then it does not belong in Compat", "author": "mikehardy", "createdAt": "2020-04-13T13:41:55Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/FieldEditText.java", "diffHunk": "@@ -18,7 +19,7 @@\n \n public class FieldEditText extends AppCompatEditText {\n \n-    public static final String NEW_LINE = System.getProperty(\"line.separator\");\n+    public static final String NEW_LINE = CompatHelper.getCompat().getLineSeparator();", "originalCommit": "cc63b7965f4e869ba2389a2c4bb3dc11e5642895", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ5NTQ3MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5993#discussion_r407495471", "bodyText": "Wasn't aware. I'll rebase and kill this change.", "author": "david-allison-1", "createdAt": "2020-04-13T14:06:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ4MzYyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUwMTE2MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5993#discussion_r407501161", "bodyText": "I have to admit since deprecation / forward-porting was the first thing I started working on in earnest in the project I feel like Compat is my baby but the structure itself already completely existed, and after learning how it worked I like it. Not sure if there is a better way to handle API differences without just bumping minSdkVersion but this one is certainly powerful and not too hard to drive as a developer. If you ever dig into the stack of deprecation issues you'll become intimately familiar, anyway :-)", "author": "mikehardy", "createdAt": "2020-04-13T14:18:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ4MzYyNA=="}], "type": "inlineReview", "revised_code": {"commit": "30d9d21a8c1dece3af63e76bf08719d80975e59b", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/anki/FieldEditText.java b/AnkiDroid/src/main/java/com/ichi2/anki/FieldEditText.java\nindex fa260dd6b..0c1e03af1 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/anki/FieldEditText.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/anki/FieldEditText.java\n\n@@ -19,7 +18,7 @@ import static android.view.inputmethod.EditorInfo.IME_FLAG_NO_EXTRACT_UI;\n \n public class FieldEditText extends AppCompatEditText {\n \n-    public static final String NEW_LINE = CompatHelper.getCompat().getLineSeparator();\n+    public static final String NEW_LINE = System.getProperty(\"line.separator\");\n \n     private String mName;\n     private int mOrd;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ4NzYxNw==", "url": "https://github.com/ankidroid/Anki-Android/pull/5993#discussion_r407487617", "bodyText": "https://developer.android.com/reference/android/content/Intent#getExtras()\n\"the map of all extras previously added with putExtra(), or null if none have been added.\"\n...you never know", "author": "mikehardy", "createdAt": "2020-04-13T13:50:10Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/multimediacard/activity/MultimediaEditFieldActivity.java", "diffHunk": "@@ -96,15 +96,21 @@ protected void onCreate(Bundle savedInstanceState) {\n             setSupportActionBar(toolbar);\n         }\n \n-        mField = (IField) this.getIntent().getExtras().getSerializable(EXTRA_FIELD);\n+        Intent intent = this.getIntent();\n+        mField = getFieldFromIntent(intent);\n \n-        mNote = (IMultimediaEditableNote) this.getIntent().getSerializableExtra(EXTRA_WHOLE_NOTE);\n+        mNote = (IMultimediaEditableNote) intent.getSerializableExtra(EXTRA_WHOLE_NOTE);\n \n-        mFieldIndex = this.getIntent().getIntExtra(EXTRA_FIELD_INDEX, 0);\n+        mFieldIndex = intent.getIntExtra(EXTRA_FIELD_INDEX, 0);\n \n         recreateEditingUi(ChangeUIRequest.init(mField));\n     }\n \n+    @VisibleForTesting\n+    public static IField getFieldFromIntent(Intent intent) {\n+        return (IField) intent.getExtras().getSerializable(EXTRA_FIELD);", "originalCommit": "c73658c9c00e42e688f4c37c811e11628206420e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ5MTk0NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/5993#discussion_r407491944", "bodyText": "I'm just using this as an accessor to ensure consistency between the reading of the activity output data in the test. There's no code change here.", "author": "david-allison-1", "createdAt": "2020-04-13T13:59:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ4NzYxNw=="}], "type": "inlineReview", "revised_code": {"commit": "30d9d21a8c1dece3af63e76bf08719d80975e59b", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/anki/multimediacard/activity/MultimediaEditFieldActivity.java b/AnkiDroid/src/main/java/com/ichi2/anki/multimediacard/activity/MultimediaEditFieldActivity.java\nindex d3a7bab66..963f982d8 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/anki/multimediacard/activity/MultimediaEditFieldActivity.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/anki/multimediacard/activity/MultimediaEditFieldActivity.java\n\n@@ -96,21 +96,15 @@ public class MultimediaEditFieldActivity extends AnkiActivity\n             setSupportActionBar(toolbar);\n         }\n \n-        Intent intent = this.getIntent();\n-        mField = getFieldFromIntent(intent);\n+        mField = (IField) this.getIntent().getExtras().getSerializable(EXTRA_FIELD);\n \n-        mNote = (IMultimediaEditableNote) intent.getSerializableExtra(EXTRA_WHOLE_NOTE);\n+        mNote = (IMultimediaEditableNote) this.getIntent().getSerializableExtra(EXTRA_WHOLE_NOTE);\n \n-        mFieldIndex = intent.getIntExtra(EXTRA_FIELD_INDEX, 0);\n+        mFieldIndex = this.getIntent().getIntExtra(EXTRA_FIELD_INDEX, 0);\n \n         recreateEditingUi(ChangeUIRequest.init(mField));\n     }\n \n-    @VisibleForTesting\n-    public static IField getFieldFromIntent(Intent intent) {\n-        return (IField) intent.getExtras().getSerializable(EXTRA_FIELD);\n-    }\n-\n \n     private void finishCancel() {\n         Timber.d(\"Completing activity via finishCancel()\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ4ODU5NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5993#discussion_r407488595", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                protected Note addBasicNote(String front, String back) {\n          \n          \n            \n                protected Note getNoteUsingBasicModel(String front, String back) {\n          \n      \n    \n    \n  \n\n...or similar, just a bit more unambiguous that the note itself isn't basic (maybe means a simple note?) but that it is attached to the basic model", "author": "mikehardy", "createdAt": "2020-04-13T13:52:16Z", "path": "AnkiDroid/src/test/java/com/ichi2/anki/RobolectricTest.java", "diffHunk": "@@ -91,4 +95,23 @@ protected JSONObject getCurrentDatabaseModelCopy(String modelName) throws JSONEx\n         Models collectionModels = getCol().getModels();\n         return new JSONObject(collectionModels.byName(modelName).toString().trim());\n     }\n+\n+    protected <T extends AnkiActivity> T startActivityNormallyOpenCollectionWithIntent(Class<T> clazz, Intent i) {\n+        ActivityController multimediaController = Robolectric.buildActivity(clazz, i)\n+                .create().start().resume().visible();\n+        //noinspection unchecked\n+        return (T) multimediaController.get();\n+    }\n+\n+    protected Note addBasicNote(String front, String back) {", "originalCommit": "c73658c9c00e42e688f4c37c811e11628206420e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "30d9d21a8c1dece3af63e76bf08719d80975e59b", "chunk": "diff --git a/AnkiDroid/src/test/java/com/ichi2/anki/RobolectricTest.java b/AnkiDroid/src/test/java/com/ichi2/anki/RobolectricTest.java\nindex 39843338e..10accdf7f 100644\n--- a/AnkiDroid/src/test/java/com/ichi2/anki/RobolectricTest.java\n+++ b/AnkiDroid/src/test/java/com/ichi2/anki/RobolectricTest.java\n\n@@ -95,23 +91,4 @@ public class RobolectricTest {\n         Models collectionModels = getCol().getModels();\n         return new JSONObject(collectionModels.byName(modelName).toString().trim());\n     }\n-\n-    protected <T extends AnkiActivity> T startActivityNormallyOpenCollectionWithIntent(Class<T> clazz, Intent i) {\n-        ActivityController multimediaController = Robolectric.buildActivity(clazz, i)\n-                .create().start().resume().visible();\n-        //noinspection unchecked\n-        return (T) multimediaController.get();\n-    }\n-\n-    protected Note addBasicNote(String front, String back) {\n-\n-        JSONObject basicModel = getCol().getModels().byName(\"Basic\");\n-        Note n = getCol().newNote(basicModel);\n-        n.setField(0, front);\n-        n.setField(1, back);\n-        if (getCol().addNote(n) != 1) {\n-            throw new IllegalStateException(String.format(\"Could not add note: {'%s', '%s'}\", front, back));\n-        }\n-        return n;\n-    }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ4OTYxMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5993#discussion_r407489611", "bodyText": "On first read I thought this was bound to the multimedia work but it looks like you've made a fully general purpose activity starter?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                protected <T extends AnkiActivity> T startActivityNormallyOpenCollectionWithIntent(Class<T> clazz, Intent i) {\n          \n          \n            \n                    ActivityController multimediaController = Robolectric.buildActivity(clazz, i)\n          \n          \n            \n                            .create().start().resume().visible();\n          \n          \n            \n                    //noinspection unchecked\n          \n          \n            \n                    return (T) multimediaController.get();\n          \n          \n            \n                }\n          \n          \n            \n                protected <T extends AnkiActivity> T startActivityNormallyOpenCollectionWithIntent(Class<T> clazz, Intent i) {\n          \n          \n            \n                    ActivityController controller = Robolectric.buildActivity(clazz, i)\n          \n          \n            \n                            .create().start().resume().visible();\n          \n          \n            \n                    //noinspection unchecked\n          \n          \n            \n                    return (T) controller.get();\n          \n          \n            \n                }", "author": "mikehardy", "createdAt": "2020-04-13T13:54:26Z", "path": "AnkiDroid/src/test/java/com/ichi2/anki/RobolectricTest.java", "diffHunk": "@@ -91,4 +95,23 @@ protected JSONObject getCurrentDatabaseModelCopy(String modelName) throws JSONEx\n         Models collectionModels = getCol().getModels();\n         return new JSONObject(collectionModels.byName(modelName).toString().trim());\n     }\n+\n+    protected <T extends AnkiActivity> T startActivityNormallyOpenCollectionWithIntent(Class<T> clazz, Intent i) {\n+        ActivityController multimediaController = Robolectric.buildActivity(clazz, i)\n+                .create().start().resume().visible();\n+        //noinspection unchecked\n+        return (T) multimediaController.get();\n+    }", "originalCommit": "c73658c9c00e42e688f4c37c811e11628206420e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "30d9d21a8c1dece3af63e76bf08719d80975e59b", "chunk": "diff --git a/AnkiDroid/src/test/java/com/ichi2/anki/RobolectricTest.java b/AnkiDroid/src/test/java/com/ichi2/anki/RobolectricTest.java\nindex 39843338e..10accdf7f 100644\n--- a/AnkiDroid/src/test/java/com/ichi2/anki/RobolectricTest.java\n+++ b/AnkiDroid/src/test/java/com/ichi2/anki/RobolectricTest.java\n\n@@ -95,23 +91,4 @@ public class RobolectricTest {\n         Models collectionModels = getCol().getModels();\n         return new JSONObject(collectionModels.byName(modelName).toString().trim());\n     }\n-\n-    protected <T extends AnkiActivity> T startActivityNormallyOpenCollectionWithIntent(Class<T> clazz, Intent i) {\n-        ActivityController multimediaController = Robolectric.buildActivity(clazz, i)\n-                .create().start().resume().visible();\n-        //noinspection unchecked\n-        return (T) multimediaController.get();\n-    }\n-\n-    protected Note addBasicNote(String front, String back) {\n-\n-        JSONObject basicModel = getCol().getModels().byName(\"Basic\");\n-        Note n = getCol().newNote(basicModel);\n-        n.setField(0, front);\n-        n.setField(1, back);\n-        if (getCol().addNote(n) != 1) {\n-            throw new IllegalStateException(String.format(\"Could not add note: {'%s', '%s'}\", front, back));\n-        }\n-        return n;\n-    }\n }\n"}}, {"oid": "30d9d21a8c1dece3af63e76bf08719d80975e59b", "url": "https://github.com/ankidroid/Anki-Android/commit/30d9d21a8c1dece3af63e76bf08719d80975e59b", "message": "NF: Extract updateMultimediaNoteFromFields()", "committedDate": "2020-04-13T14:10:32Z", "type": "commit"}, {"oid": "1f3114283035dd43deb72fc4efab630f9ee48c4f", "url": "https://github.com/ankidroid/Anki-Android/commit/1f3114283035dd43deb72fc4efab630f9ee48c4f", "message": "NF: Extract startMultimediaFieldEditorForField()", "committedDate": "2020-04-13T14:10:32Z", "type": "commit"}, {"oid": "0115496da18f63e9f69ca1c0ca758fa08d01d851", "url": "https://github.com/ankidroid/Anki-Android/commit/0115496da18f63e9f69ca1c0ca758fa08d01d851", "message": "NF: Added Desires", "committedDate": "2020-04-13T14:10:32Z", "type": "commit"}, {"oid": "ffb60f7e86886864375ed88da580f413c1738873", "url": "https://github.com/ankidroid/Anki-Android/commit/ffb60f7e86886864375ed88da580f413c1738873", "message": "NF: Extract: getFieldsAsBundle", "committedDate": "2020-04-13T14:10:33Z", "type": "commit"}, {"oid": "e7457a19a8e0c42f396cf784ba28830080efe2ac", "url": "https://github.com/ankidroid/Anki-Android/commit/e7457a19a8e0c42f396cf784ba28830080efe2ac", "message": "NF: Simplify startMultimediaFieldEditor", "committedDate": "2020-04-13T14:10:33Z", "type": "commit"}, {"oid": "ec9b5848d34929cb1c37f0b2044af262fcf3b79d", "url": "https://github.com/ankidroid/Anki-Android/commit/ec9b5848d34929cb1c37f0b2044af262fcf3b79d", "message": "Multimedia Editor - Use Current Field Values\n\nFixes #5992\n\nPreviously, we were using the field values from the existing model in\nthe database when editing fields.\n\nNow, we use the values shown in the UI.", "committedDate": "2020-04-13T14:32:04Z", "type": "commit"}, {"oid": "ec9b5848d34929cb1c37f0b2044af262fcf3b79d", "url": "https://github.com/ankidroid/Anki-Android/commit/ec9b5848d34929cb1c37f0b2044af262fcf3b79d", "message": "Multimedia Editor - Use Current Field Values\n\nFixes #5992\n\nPreviously, we were using the field values from the existing model in\nthe database when editing fields.\n\nNow, we use the values shown in the UI.", "committedDate": "2020-04-13T14:32:04Z", "type": "forcePushed"}]}