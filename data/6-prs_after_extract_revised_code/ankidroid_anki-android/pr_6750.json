{"pr_number": 6750, "pr_title": "Better undo", "pr_createdAt": "2020-07-25T16:49:38Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6750", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDU0MTIzOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6750#discussion_r460541238", "bodyText": "I think this would be more readable as: Undoable.revertToProvidedState(card, BURY_CARD)", "author": "david-allison-1", "createdAt": "2020-07-26T15:33:22Z", "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -643,19 +653,29 @@ private TaskData doInBackgroundDismissNote(TaskData... params) {\n                 switch (type) {\n                     case BURY_CARD:\n                         // collect undo information\n-                        col.markUndo(new UndoableBuryCard(note.cards(), card.getId()));\n+                        Undoable buryCard = new UndoableFlushAll(BURY_CARD, note.cards(), card.getId());", "originalCommit": "4ab156e68089881a960864f9e132927f22f8d3f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYxMzA1NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6750#discussion_r460613054", "bodyText": "Done.", "author": "Arthur-Milchior", "createdAt": "2020-07-27T02:16:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDU0MTIzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYxMzIxNg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6750#discussion_r460613216", "bodyText": "Should I do a distinct PR for this idea ? Because it was already relevant.\nIn this PR I was trying to concentrate on one idea: moving code to where it is actually used. It seems strange to do other change simultaneously, even if it does improve code quality", "author": "Arthur-Milchior", "createdAt": "2020-07-27T02:17:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDU0MTIzOA=="}], "type": "inlineReview", "revised_code": {"commit": "a9399e19b4095c20d3fb7198e3c730dc7fa1b5b2", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java b/AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java\nindex 02fb7e215b..6a3da47ec4 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java\n\n@@ -653,14 +653,14 @@ public class CollectionTask extends BaseAsyncTask<TaskData, TaskData, TaskData>\n                 switch (type) {\n                     case BURY_CARD:\n                         // collect undo information\n-                        Undoable buryCard = new UndoableFlushAll(BURY_CARD, note.cards(), card.getId());\n+                        Undoable buryCard = revertToProvidedState(BURY_CARD, note.cards(), card.getId());\n                         col.markUndo(buryCard);\n                         // then bury\n                         sched.buryCards(new long[] { card.getId() });\n                         break;\n                     case BURY_NOTE:\n                         // collect undo information\n-                        Undoable buryNote = new UndoableFlushAll(BURY_NOTE, note.cards(), card.getId());\n+                        Undoable buryNote = revertToProvidedState(BURY_NOTE, note.cards(), card.getId());\n                         col.markUndo(buryNote);\n                         // then bury\n                         sched.buryNote(note.getId());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDU2MTQwMw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6750#discussion_r460561403", "bodyText": "nit: I feel a static method accepting a card and enum value, returning a class (name doesn't matter) would be better than a constructor here\n\nAccepting a card makes the intent clear - it's the card that we care about, and getting the siblings is an implementation detail\nThe intent of the method (revertToProvidedState) won't change, and that provides more meaning than the name of the class", "author": "david-allison-1", "createdAt": "2020-07-26T18:58:30Z", "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -643,19 +653,29 @@ private TaskData doInBackgroundDismissNote(TaskData... params) {\n                 switch (type) {\n                     case BURY_CARD:\n                         // collect undo information\n-                        col.markUndo(new UndoableBuryCard(note.cards(), card.getId()));\n+                        Undoable buryCard = new RevertToProvidedState(BURY_CARD, note.cards(), card.getId());", "originalCommit": "63bdf388b2f7c5415579cd0e43b90c0f0d6ec150", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDU3MDQ3Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6750#discussion_r460570472", "bodyText": "Done", "author": "Arthur-Milchior", "createdAt": "2020-07-26T20:34:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDU2MTQwMw=="}], "type": "inlineReview", "revised_code": {"commit": "a9399e19b4095c20d3fb7198e3c730dc7fa1b5b2", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java b/AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java\nindex 10dd3336d4..6a3da47ec4 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java\n\n@@ -653,14 +653,14 @@ public class CollectionTask extends BaseAsyncTask<TaskData, TaskData, TaskData>\n                 switch (type) {\n                     case BURY_CARD:\n                         // collect undo information\n-                        Undoable buryCard = new RevertToProvidedState(BURY_CARD, note.cards(), card.getId());\n+                        Undoable buryCard = revertToProvidedState(BURY_CARD, note.cards(), card.getId());\n                         col.markUndo(buryCard);\n                         // then bury\n                         sched.buryCards(new long[] { card.getId() });\n                         break;\n                     case BURY_NOTE:\n                         // collect undo information\n-                        Undoable buryNote = new RevertToProvidedState(BURY_NOTE, note.cards(), card.getId());\n+                        Undoable buryNote = revertToProvidedState(BURY_NOTE, note.cards(), card.getId());\n                         col.markUndo(buryNote);\n                         // then bury\n                         sched.buryNote(note.getId());\n"}}, {"oid": "a9399e19b4095c20d3fb7198e3c730dc7fa1b5b2", "url": "https://github.com/ankidroid/Anki-Android/commit/a9399e19b4095c20d3fb7198e3c730dc7fa1b5b2", "message": "NF: UndoableFlushAll -> revertToProvidedState", "committedDate": "2020-07-26T20:34:22Z", "type": "forcePushed"}, {"oid": "154f6902df948cd95b86729be22d02ffac92f00c", "url": "https://github.com/ankidroid/Anki-Android/commit/154f6902df948cd95b86729be22d02ffac92f00c", "message": "NF: UndoableReview as anonymous class", "committedDate": "2020-07-27T02:12:32Z", "type": "commit"}, {"oid": "6d4365d3b005b39ce8088371169dfee976d30022", "url": "https://github.com/ankidroid/Anki-Android/commit/6d4365d3b005b39ce8088371169dfee976d30022", "message": "NF: BuryCard simplified", "committedDate": "2020-07-27T02:12:32Z", "type": "commit"}, {"oid": "5a831ba08a4c0edf50d9933c99c0c45626d87a15", "url": "https://github.com/ankidroid/Anki-Android/commit/5a831ba08a4c0edf50d9933c99c0c45626d87a15", "message": "NF: UndoableBuryNote simplified", "committedDate": "2020-07-27T02:12:32Z", "type": "commit"}, {"oid": "231c219e4d10ec7c19e05bad82291c505ffb193e", "url": "https://github.com/ankidroid/Anki-Android/commit/231c219e4d10ec7c19e05bad82291c505ffb193e", "message": "NF: simplifies revertToProvidedState", "committedDate": "2020-07-27T02:16:26Z", "type": "forcePushed"}, {"oid": "5fc760eaf9d95be578431d3ebd71fe9382d6f290", "url": "https://github.com/ankidroid/Anki-Android/commit/5fc760eaf9d95be578431d3ebd71fe9382d6f290", "message": "NF: suspend Card undo simpler", "committedDate": "2020-07-29T11:03:47Z", "type": "commit"}, {"oid": "7a940a41010dedee9df402924363e9bfc868c23b", "url": "https://github.com/ankidroid/Anki-Android/commit/7a940a41010dedee9df402924363e9bfc868c23b", "message": "NF: simplify suspendCardMulti undo", "committedDate": "2020-07-29T11:05:08Z", "type": "commit"}, {"oid": "d34d4fd55be86c2af0fa9fd25ef469fec3a09732", "url": "https://github.com/ankidroid/Anki-Android/commit/d34d4fd55be86c2af0fa9fd25ef469fec3a09732", "message": "NF: UndoableDeleteNote simplified", "committedDate": "2020-07-29T11:06:40Z", "type": "commit"}, {"oid": "e038000d83e950cb4c49ff8c52738a8a5f34094f", "url": "https://github.com/ankidroid/Anki-Android/commit/e038000d83e950cb4c49ff8c52738a8a5f34094f", "message": "NF: UndoableDeleteNoteMulti simplified", "committedDate": "2020-07-29T11:07:47Z", "type": "commit"}, {"oid": "b8aa86242625d36e705c806169a70135ee369a91", "url": "https://github.com/ankidroid/Anki-Android/commit/b8aa86242625d36e705c806169a70135ee369a91", "message": "NF: simplifies UndoableSuspendNote", "committedDate": "2020-07-29T11:08:17Z", "type": "commit"}, {"oid": "6a037b670af22f5069107381a36f4f13837353bc", "url": "https://github.com/ankidroid/Anki-Android/commit/6a037b670af22f5069107381a36f4f13837353bc", "message": "NF: UndoableChangeDeckMulti simplified", "committedDate": "2020-07-29T11:09:15Z", "type": "commit"}, {"oid": "c9c7cc7a361e0cdac77a9b340b825a98d3dc7e87", "url": "https://github.com/ankidroid/Anki-Android/commit/c9c7cc7a361e0cdac77a9b340b825a98d3dc7e87", "message": "NF: simplifies undoable mark note multi", "committedDate": "2020-07-29T11:10:24Z", "type": "commit"}, {"oid": "891e3ea67fe18a5b5f57a59f59423ee2259b00e4", "url": "https://github.com/ankidroid/Anki-Android/commit/891e3ea67fe18a5b5f57a59f59423ee2259b00e4", "message": "NF: simplifies undo Reposition rescheduler reset cards", "committedDate": "2020-07-29T11:11:07Z", "type": "commit"}, {"oid": "40f9e58baa858005812ce7e8430189532d9d8503", "url": "https://github.com/ankidroid/Anki-Android/commit/40f9e58baa858005812ce7e8430189532d9d8503", "message": "NF: remove unused undoable flag", "committedDate": "2020-07-29T11:11:07Z", "type": "commit"}, {"oid": "688d57e90521fe05bbeded7aae06558b7a7fa331", "url": "https://github.com/ankidroid/Anki-Android/commit/688d57e90521fe05bbeded7aae06558b7a7fa331", "message": "NF: Removing spaces", "committedDate": "2020-07-29T11:11:16Z", "type": "commit"}, {"oid": "577d61cf512bb86768c9dea12741cfc1de520c02", "url": "https://github.com/ankidroid/Anki-Android/commit/577d61cf512bb86768c9dea12741cfc1de520c02", "message": "NF: UndoableFlushAll -> revertToProvidedState", "committedDate": "2020-07-29T11:11:26Z", "type": "commit"}, {"oid": "0ab67d8eee16d8288c9300b3c07300d243159611", "url": "https://github.com/ankidroid/Anki-Android/commit/0ab67d8eee16d8288c9300b3c07300d243159611", "message": "NF: simplifies revertToProvidedState", "committedDate": "2020-07-29T11:11:34Z", "type": "commit"}, {"oid": "bf14dc2363436adf64adfa5cdc196d4942e8fd4d", "url": "https://github.com/ankidroid/Anki-Android/commit/bf14dc2363436adf64adfa5cdc196d4942e8fd4d", "message": "Correct undo name for revertToProvidedState", "committedDate": "2020-07-29T11:15:05Z", "type": "commit"}, {"oid": "bf14dc2363436adf64adfa5cdc196d4942e8fd4d", "url": "https://github.com/ankidroid/Anki-Android/commit/bf14dc2363436adf64adfa5cdc196d4942e8fd4d", "message": "Correct undo name for revertToProvidedState", "committedDate": "2020-07-29T11:15:05Z", "type": "forcePushed"}]}