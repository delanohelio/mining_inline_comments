{"pr_number": 5935, "pr_title": "Cache nameMap (performance)", "pr_createdAt": "2020-04-05T17:27:05Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/5935", "timeline": [{"oid": "1dc0ce28c64cab646f6caabc53f733d66d319e4b", "url": "https://github.com/ankidroid/Anki-Android/commit/1dc0ce28c64cab646f6caabc53f733d66d319e4b", "message": "rename _nameMap to nameMap\n\nThe collision disappeared in last commit", "committedDate": "2020-04-05T18:22:23Z", "type": "forcePushed"}, {"oid": "4674f1d6534d8b106e303c318bdecda72e6fd556", "url": "https://github.com/ankidroid/Anki-Android/commit/4674f1d6534d8b106e303c318bdecda72e6fd556", "message": "rename _nameMap to nameMap\n\nThe collision disappeared in last commit", "committedDate": "2020-04-05T19:16:32Z", "type": "forcePushed"}, {"oid": "90a3117641057e7d5579ec85121552cd9ef2fda8", "url": "https://github.com/ankidroid/Anki-Android/commit/90a3117641057e7d5579ec85121552cd9ef2fda8", "message": "rename _nameMap to nameMap\n\nThe collision disappeared in last commit", "committedDate": "2020-04-05T20:53:03Z", "type": "forcePushed"}, {"oid": "1e1e88176915b7025a977c61abbd867034abfb49", "url": "https://github.com/ankidroid/Anki-Android/commit/1e1e88176915b7025a977c61abbd867034abfb49", "message": "rename _nameMap to nameMap\n\nThe collision disappeared in last commit", "committedDate": "2020-04-05T21:03:44Z", "type": "forcePushed"}, {"oid": "28205e06c17d6c21e2f4f070a594a5a32c71abcb", "url": "https://github.com/ankidroid/Anki-Android/commit/28205e06c17d6c21e2f4f070a594a5a32c71abcb", "message": "rename _nameMap to nameMap\n\nThe collision disappeared in last commit", "committedDate": "2020-04-07T00:03:00Z", "type": "forcePushed"}, {"oid": "4ff46c028c59e6cdf9b5dded443f40db3ed482d2", "url": "https://github.com/ankidroid/Anki-Android/commit/4ff46c028c59e6cdf9b5dded443f40db3ed482d2", "message": "rename _nameMap to nameMap\n\nThe collision disappeared in last commit", "committedDate": "2020-04-09T12:38:36Z", "type": "forcePushed"}, {"oid": "d15048bcf2e040fbf04fa2a579a8a8556a5b69df", "url": "https://github.com/ankidroid/Anki-Android/commit/d15048bcf2e040fbf04fa2a579a8a8556a5b69df", "message": "rename _nameMap to nameMap\n\nThe collision disappeared in last commit", "committedDate": "2020-04-11T18:13:41Z", "type": "forcePushed"}, {"oid": "c838928297d32dacccc918e8f16acd1962cc02c7", "url": "https://github.com/ankidroid/Anki-Android/commit/c838928297d32dacccc918e8f16acd1962cc02c7", "message": "remove useless import", "committedDate": "2020-04-13T14:22:38Z", "type": "forcePushed"}, {"oid": "940df5aa513638a61667b3b77e7b43a096bba8af", "url": "https://github.com/ankidroid/Anki-Android/commit/940df5aa513638a61667b3b77e7b43a096bba8af", "message": "rename _nameMap to nameMap\n\nThe collision disappeared in last commit", "committedDate": "2020-06-01T14:23:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM3NDA4OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/5935#discussion_r444374088", "bodyText": "Should follow convention for member variables\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private HashMap<String, JSONObject> nameMap;\n          \n          \n            \n                private HashMap<String, JSONObject> mNameMap;", "author": "mikehardy", "createdAt": "2020-06-23T17:01:57Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java", "diffHunk": "@@ -138,6 +139,7 @@\n     private Collection mCol;\n     private HashMap<Long, JSONObject> mDecks;\n     private HashMap<Long, JSONObject> mDconf;\n+    private HashMap<String, JSONObject> nameMap;", "originalCommit": "940df5aa513638a61667b3b77e7b43a096bba8af", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "500bf6d03146a9edb7c5cac5e293b67a48982380", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java b/AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java\nindex 925bf07dc..6717587ce 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java\n\n@@ -139,7 +139,7 @@ public class Decks {\n     private Collection mCol;\n     private HashMap<Long, JSONObject> mDecks;\n     private HashMap<Long, JSONObject> mDconf;\n-    private HashMap<String, JSONObject> nameMap;\n+    private HashMap<String, JSONObject> mNameMap;\n     private boolean mChanged;\n \n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM3NjAyMg==", "url": "https://github.com/ankidroid/Anki-Android/pull/5935#discussion_r444376022", "bodyText": "I really don't like asserts unless absolutely necessary as they are basically saying \"crash right here\"\nIs there any way to recover from this error? If not - if the data is too corrupt at this point and there is no way to reason about app state, okay\nBut if there is a return value we could send here I'd rather do that.\nI fear this might be a \"crash here\" case, but every single time I see an Assert I will force this inspection, as putting \"crash right here\" code in the app should never be done with out checking a few times.", "author": "mikehardy", "createdAt": "2020-06-23T17:05:14Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java", "diffHunk": "@@ -430,26 +434,69 @@ public JSONObject get(long did, boolean _default) {\n      * Get deck with NAME, ignoring case.\n      */\n     @CheckResult\n-    public @Nullable JSONObject byName(String name) {\n-        for (JSONObject m : mDecks.values()) {\n-            if (equalName(m.getString(\"name\"),name)) {\n-                return m;\n-            }\n+    public JSONObject byName(String name) {\n+        String normalized = normalizeName(name);\n+        JSONObject deck = nameMap.get(normalized);\n+        if (deck == null) {\n+            return null;\n         }\n-        return null;\n+        String deckName = deck.getString(\"name\");\n+        Assert.that(equalName(name, deckName),", "originalCommit": "940df5aa513638a61667b3b77e7b43a096bba8af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM4NDc4OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/5935#discussion_r444384788", "bodyText": "I'm okay with removing the assert. It was nice having it while I tested this PR, because if anything did not go as expected it would crash (and actually, it had been the case while I was testing this feature), but once I'm confident that everything works, there is no reason to test the assertion I believe", "author": "Arthur-Milchior", "createdAt": "2020-06-23T17:20:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM3NjAyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM4NjM5MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/5935#discussion_r444386390", "bodyText": "If it is not mandatory then perhaps the same logic test, but with a sendExceptionReport and return null instead? You'll get your diagnostics but the app should recover?", "author": "mikehardy", "createdAt": "2020-06-23T17:22:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM3NjAyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM5NDAzNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5935#discussion_r444394035", "bodyText": "Done", "author": "Arthur-Milchior", "createdAt": "2020-06-23T17:36:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM3NjAyMg=="}], "type": "inlineReview", "revised_code": {"commit": "500bf6d03146a9edb7c5cac5e293b67a48982380", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java b/AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java\nindex 925bf07dc..6717587ce 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java\n\n@@ -436,13 +437,11 @@ public class Decks {\n     @CheckResult\n     public JSONObject byName(String name) {\n         String normalized = normalizeName(name);\n-        JSONObject deck = nameMap.get(normalized);\n-        if (deck == null) {\n-            return null;\n+        JSONObject deck = mNameMap.get(normalized);\n+        String foundName = deck.getString(\"name\");\n+        if (!equalName(name, foundName)) {\n+            AnkiDroidApp.sendExceptionReport(\"We looked for deck \\\"\" + name + \"\\\" and instead got deck \\\"\" + foundName + \"\\\".\", \"Decks - byName\");\n         }\n-        String deckName = deck.getString(\"name\");\n-        Assert.that(equalName(name, deckName),\n-                \"deck \" + name + \" has been renamed to \" + deckName + \" without update occuring in deck manager. It should not occur\");\n         return deck;\n     }\n \n"}}, {"oid": "500bf6d03146a9edb7c5cac5e293b67a48982380", "url": "https://github.com/ankidroid/Anki-Android/commit/500bf6d03146a9edb7c5cac5e293b67a48982380", "message": "add report if byName gets a wrong result", "committedDate": "2020-06-23T17:35:52Z", "type": "forcePushed"}, {"oid": "d61b03115592c34125f1e2115b820f464dc51412", "url": "https://github.com/ankidroid/Anki-Android/commit/d61b03115592c34125f1e2115b820f464dc51412", "message": "NF: add report if byName gets a wrong result", "committedDate": "2020-06-23T19:37:38Z", "type": "forcePushed"}, {"oid": "50f9995078a56d7d0fa429aaca35b105e1a68029", "url": "https://github.com/ankidroid/Anki-Android/commit/50f9995078a56d7d0fa429aaca35b105e1a68029", "message": "NF: add report if byName gets a wrong result", "committedDate": "2020-06-23T19:42:00Z", "type": "forcePushed"}, {"oid": "154a3e102aea9360d35435ac3ad35978ddba1280", "url": "https://github.com/ankidroid/Anki-Android/commit/154a3e102aea9360d35435ac3ad35978ddba1280", "message": "NF: Cache nameMap\n\nIt'll be used in next commits", "committedDate": "2020-06-23T23:58:46Z", "type": "commit"}, {"oid": "e91d756636bd435351e51afa7397af3a55926bc7", "url": "https://github.com/ankidroid/Anki-Android/commit/e91d756636bd435351e51afa7397af3a55926bc7", "message": "NF: byName uses nameMap", "committedDate": "2020-06-23T23:58:47Z", "type": "commit"}, {"oid": "5f76ef48de27aad51c505ff8138388e75ca3a19f", "url": "https://github.com/ankidroid/Anki-Android/commit/5f76ef48de27aad51c505ff8138388e75ca3a19f", "message": "NF: childMap uses precomputed namemap", "committedDate": "2020-06-23T23:58:47Z", "type": "commit"}, {"oid": "7c047fb4d09c8ecf748012e62d37b423b39df0d8", "url": "https://github.com/ankidroid/Anki-Android/commit/7c047fb4d09c8ecf748012e62d37b423b39df0d8", "message": "NF: Parents no longer takes a name map", "committedDate": "2020-06-23T23:58:47Z", "type": "commit"}, {"oid": "0a0c1e3a51a2b0db1334a8d0f057c195ea94153f", "url": "https://github.com/ankidroid/Anki-Android/commit/0a0c1e3a51a2b0db1334a8d0f057c195ea94153f", "message": "NF: remove method nameMap()\n\nIt became useless since nameMap is used everywhere", "committedDate": "2020-06-23T23:58:47Z", "type": "commit"}, {"oid": "f54ca6eec346d9771c3d06294520e5e62b37757d", "url": "https://github.com/ankidroid/Anki-Android/commit/f54ca6eec346d9771c3d06294520e5e62b37757d", "message": "NF: add report if byName gets a wrong result", "committedDate": "2020-06-23T23:58:47Z", "type": "commit"}, {"oid": "f54ca6eec346d9771c3d06294520e5e62b37757d", "url": "https://github.com/ankidroid/Anki-Android/commit/f54ca6eec346d9771c3d06294520e5e62b37757d", "message": "NF: add report if byName gets a wrong result", "committedDate": "2020-06-23T23:58:47Z", "type": "forcePushed"}]}