{"pr_number": 7631, "pr_title": "Handle Backup restoration-related crashes", "pr_createdAt": "2020-11-09T07:07:24Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/7631", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU4OTAzOQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7631#discussion_r519589039", "bodyText": "There may be a better way to do this (check if Application is an instance of another class), this is the main line that worries me, as if this returns false, it means the process will be killed, and there may be other reasons that this happens", "author": "david-allison-1", "createdAt": "2020-11-09T07:10:21Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/AnkiDroidApp.java", "diffHunk": "@@ -190,6 +191,17 @@ public static InputStream getResourceAsStream(@NonNull String name) {\n     }\n \n \n+    public static boolean wasStartedAfterBackupRestoration() {\n+        return sInstance == null;", "originalCommit": "7d0a6da6dda18a9b2008fe3f13e46d146245e481", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTgyMTc3Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7631#discussion_r519821773", "bodyText": "Seems like you could know for sure if it \"wasStartedAfterBackupRestoration\" if you implemented a BackupAgent a la https://stackoverflow.com/a/57244796/9910298 and stored the related state so you could query the BackupAgent implementation if onRestoreFinished has already been called.\nBut that is likely overkill, I think the assumption is valid now, but it is embedded in the name, perhaps you could change the method name to something that exposes the assumption in case calling code doesn't understand there is an assumption, like \"singletonInstanceInitialized\" with a comment that with current code if onCreate was called, it will always be true, so it can be used as a shorthand for that currently, and thus serves as a shorthand for a backup restoration test", "author": "mikehardy", "createdAt": "2020-11-09T13:41:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU4OTAzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTkzNjExOQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7631#discussion_r519936119", "bodyText": "Renamed to isInitialized", "author": "david-allison-1", "createdAt": "2020-11-09T16:17:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU4OTAzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk0NjIzMg==", "url": "https://github.com/ankidroid/Anki-Android/pull/7631#discussion_r519946232", "bodyText": "works for me!", "author": "mikehardy", "createdAt": "2020-11-09T16:31:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU4OTAzOQ=="}], "type": "inlineReview", "revised_code": {"commit": "b623214493e2a0dffb65682a7c4568a9441450b9", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/anki/AnkiDroidApp.java b/AnkiDroid/src/main/java/com/ichi2/anki/AnkiDroidApp.java\nindex 7b1b29062..bdac31721 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/anki/AnkiDroidApp.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/anki/AnkiDroidApp.java\n\n@@ -191,7 +191,7 @@ public class AnkiDroidApp extends MultiDexApplication {\n     }\n \n \n-    public static boolean wasStartedAfterBackupRestoration() {\n+    public static boolean isInitialized() {\n         return sInstance == null;\n     }\n \n"}}, {"oid": "b623214493e2a0dffb65682a7c4568a9441450b9", "url": "https://github.com/ankidroid/Anki-Android/commit/b623214493e2a0dffb65682a7c4568a9441450b9", "message": "Handle App.onCreate not executing after restore\n\nWhen opened after a backup restore, Application.onCreate is not called.\nWe can't do much here, so send a toast, and exit.\n\nWe need to kill the app process, as finish() does not do this, and will\nlead to the message constantly being shown.\n\nFixes 7630 (just DeckPicker)", "committedDate": "2020-11-09T16:16:27Z", "type": "commit"}, {"oid": "2af35207dbce68794f3dac9d0fa44abc810823b0", "url": "https://github.com/ankidroid/Anki-Android/commit/2af35207dbce68794f3dac9d0fa44abc810823b0", "message": "Speed up ActivityStartupUnderBackupTest\n\nDon't use an Application class - no need", "committedDate": "2020-11-09T16:16:29Z", "type": "commit"}, {"oid": "52296021362f381d5f1dd3726e67ef5f28c4144e", "url": "https://github.com/ankidroid/Anki-Android/commit/52296021362f381d5f1dd3726e67ef5f28c4144e", "message": "Handle App.onCreate not executing after restore\n\nPart 2: Implement all other classes\n\nWhen opened after a backup restore, Application.onCreate is not called.\nWe can't do much here, so send a toast, and exit.\n\nWe need to kill the app process, as finish() does not do this, and will\nlead to the message constantly being shown.\n\nFixes 7630", "committedDate": "2020-11-09T16:16:29Z", "type": "commit"}, {"oid": "52296021362f381d5f1dd3726e67ef5f28c4144e", "url": "https://github.com/ankidroid/Anki-Android/commit/52296021362f381d5f1dd3726e67ef5f28c4144e", "message": "Handle App.onCreate not executing after restore\n\nPart 2: Implement all other classes\n\nWhen opened after a backup restore, Application.onCreate is not called.\nWe can't do much here, so send a toast, and exit.\n\nWe need to kill the app process, as finish() does not do this, and will\nlead to the message constantly being shown.\n\nFixes 7630", "committedDate": "2020-11-09T16:16:29Z", "type": "forcePushed"}]}