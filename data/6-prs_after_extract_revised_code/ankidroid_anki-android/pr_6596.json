{"pr_number": 6596, "pr_title": "Deck tree check deal with name map", "pr_createdAt": "2020-06-30T23:34:58Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6596", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA1NDU4Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/6596#discussion_r448054586", "bodyText": "Is Map<String, JSONObject nameMap> valid syntax?\nI'd have assumed Map<String, JSONObject> nameMap", "author": "david-allison-1", "createdAt": "2020-07-01T00:42:22Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java", "diffHunk": "@@ -468,11 +468,25 @@ public void update(JSONObject g) {\n         save();\n     }\n \n+    /** Recompute the name map. Most operation deal with updating the name map directly,\n+     * however, after a failed safety check, doing the whole computation is easier.*/\n+    private void resetNameMap() {\n+        HashMap<String, JSONObject> nameMap = new HashMap<>(mDecks.size());\n+        for (JSONObject deck: mDecks.values()) {\n+            nameMapAdd(deck.getString(\"name\"), deck, nameMap);\n+        }\n+        mNameMap = nameMap;\n+    }\n+\n     private void nameMapAdd(String name, JSONObject g) {\n-        mNameMap.put(name, g);\n+        nameMapAdd(name, g, mNameMap);\n+    }\n+\n+    private void nameMapAdd(String name, JSONObject g, Map<String, JSONObject nameMap>) {", "originalCommit": "eda119bd5cec8c6da1850d8b39c958929803ee01", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA1NTM2OQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6596#discussion_r448055369", "bodyText": "Clearly, the > should have been before", "author": "Arthur-Milchior", "createdAt": "2020-07-01T00:45:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA1NDU4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "8c313e8b12a391c0d10f6eecac2a5695a43bea8e", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java b/AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java\nindex 80f75a6588..95f79e76bb 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java\n\n@@ -482,7 +482,7 @@ public class Decks {\n         nameMapAdd(name, g, mNameMap);\n     }\n \n-    private void nameMapAdd(String name, JSONObject g, Map<String, JSONObject nameMap>) {\n+    private void nameMapAdd(String name, JSONObject g, Map<String, JSONObject> nameMap) {\n         nameMap.put(name, g);\n         // Normalized name is also added because it's required to use it in by name.\n         // Non normalized is kept for Parent\n"}}, {"oid": "8c313e8b12a391c0d10f6eecac2a5695a43bea8e", "url": "https://github.com/ankidroid/Anki-Android/commit/8c313e8b12a391c0d10f6eecac2a5695a43bea8e", "message": "Deck tree check deal with name map\n\nIt seems I totally forgot to ensure that `_checkDeckTree` change the\nname map. The main problem here being that it changes name using JSON\noperation and not the method `rename`. Actually, using `rename` would\nbe almost impossible, because `rename` would risk to raise an\nexception due to name duplication.\n\nInstead, I simply ensure that the map is created again when there is\nany error.\n\nThis should solve #6590 and also other potential error later.\n\nAs a side note, I am happy that I decided to raise an exception if\nbyName returns a deck with a wrong name. We would note have found it\notherwise, and it seems quite good to see it here", "committedDate": "2020-07-01T00:45:50Z", "type": "commit"}, {"oid": "8c313e8b12a391c0d10f6eecac2a5695a43bea8e", "url": "https://github.com/ankidroid/Anki-Android/commit/8c313e8b12a391c0d10f6eecac2a5695a43bea8e", "message": "Deck tree check deal with name map\n\nIt seems I totally forgot to ensure that `_checkDeckTree` change the\nname map. The main problem here being that it changes name using JSON\noperation and not the method `rename`. Actually, using `rename` would\nbe almost impossible, because `rename` would risk to raise an\nexception due to name duplication.\n\nInstead, I simply ensure that the map is created again when there is\nany error.\n\nThis should solve #6590 and also other potential error later.\n\nAs a side note, I am happy that I decided to raise an exception if\nbyName returns a deck with a wrong name. We would note have found it\notherwise, and it seems quite good to see it here", "committedDate": "2020-07-01T00:45:50Z", "type": "forcePushed"}]}