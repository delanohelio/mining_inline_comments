{"pr_number": 6048, "pr_title": "beforeUpload: save only if some change occured", "pr_createdAt": "2020-04-18T16:49:30Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6048", "timeline": [{"oid": "b9cffb6595f77972d749eb0a2443f81454813ec8", "url": "https://github.com/ankidroid/Anki-Android/commit/b9cffb6595f77972d749eb0a2443f81454813ec8", "message": "Array of JSONObject: save only if modified in beforeUpload", "committedDate": "2020-06-04T18:58:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5MzgyNw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#discussion_r435493827", "bodyText": "For reference: You could use a single | here which will evaluate both sides, but I'm happy with the comment. Feel free to mark as resolved with no action.", "author": "david-allison-1", "createdAt": "2020-06-04T19:17:34Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java", "diffHunk": "@@ -979,13 +979,14 @@ private void gather(HashMap<Long, HashMap> node, List<Long> arr) {\n \n \n     public void beforeUpload() {\n-        for (JSONObject d : all()) {\n-            d.put(\"usn\", 0);\n+        boolean changed_decks = Utils.shouldSave(all());\n+        boolean changed_conf = Utils.shouldSave(allConf());\n+        if (changed_decks || changed_conf) {", "originalCommit": "b9cffb6595f77972d749eb0a2443f81454813ec8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUwNjg0OQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#discussion_r435506849", "bodyText": "Since you are mentioning readability, I do believe the current version to be more clear than using a bitwise or on booleans. I do admit that you're right and that I've not thought of it, so thank you for the feedback.", "author": "Arthur-Milchior", "createdAt": "2020-06-04T19:43:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5MzgyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUxNDkyMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#discussion_r435514921", "bodyText": "No worries - glad I helped. Marking as \"no action needed\"", "author": "david-allison-1", "createdAt": "2020-06-04T19:58:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5MzgyNw=="}], "type": "inlineReview", "revised_code": {"commit": "54888591abadd36e100f0f6f9f8bcde28d03db4f", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java b/AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java\nindex 77169b4a3..a92146849 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java\n\n@@ -979,14 +987,13 @@ public class Decks {\n \n \n     public void beforeUpload() {\n-        boolean changed_decks = Utils.shouldSave(all());\n-        boolean changed_conf = Utils.shouldSave(allConf());\n-        if (changed_decks || changed_conf) {\n-            // shouldSave should always be called on both list, for\n-            // its side effect. Thus the disjunction should not be\n-            // directly applied to the methods.\n-            save();\n+        for (JSONObject d : all()) {\n+            d.put(\"usn\", 0);\n+        }\n+        for (JSONObject c : allConf()) {\n+            c.put(\"usn\", 0);\n         }\n+        save();\n     }\n \n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5MzkzNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#discussion_r435493935", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // shouldSave should always be called on both list, for\n          \n          \n            \n                        // shouldSave should always be called on both lists, for", "author": "david-allison-1", "createdAt": "2020-06-04T19:17:46Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java", "diffHunk": "@@ -979,13 +979,14 @@ private void gather(HashMap<Long, HashMap> node, List<Long> arr) {\n \n \n     public void beforeUpload() {\n-        for (JSONObject d : all()) {\n-            d.put(\"usn\", 0);\n+        boolean changed_decks = Utils.shouldSave(all());\n+        boolean changed_conf = Utils.shouldSave(allConf());\n+        if (changed_decks || changed_conf) {\n+            // shouldSave should always be called on both list, for", "originalCommit": "b9cffb6595f77972d749eb0a2443f81454813ec8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "54888591abadd36e100f0f6f9f8bcde28d03db4f", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java b/AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java\nindex 77169b4a3..a92146849 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java\n\n@@ -979,14 +987,13 @@ public class Decks {\n \n \n     public void beforeUpload() {\n-        boolean changed_decks = Utils.shouldSave(all());\n-        boolean changed_conf = Utils.shouldSave(allConf());\n-        if (changed_decks || changed_conf) {\n-            // shouldSave should always be called on both list, for\n-            // its side effect. Thus the disjunction should not be\n-            // directly applied to the methods.\n-            save();\n+        for (JSONObject d : all()) {\n+            d.put(\"usn\", 0);\n+        }\n+        for (JSONObject c : allConf()) {\n+            c.put(\"usn\", 0);\n         }\n+        save();\n     }\n \n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5NDk4Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#discussion_r435494983", "bodyText": "nit: I think you can iterate mTags here, rather than the keySet.\nYou might want to extract this to a shouldSave in Utils with a different parameter type for readability", "author": "david-allison-1", "createdAt": "2020-06-04T19:19:52Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Tags.java", "diffHunk": "@@ -372,10 +372,16 @@ public boolean inList(String tag, Iterable<String> tags) {\n      */\n \n     public void beforeUpload() {\n+        boolean changed = false;\n         for (String k : mTags.keySet()) {", "originalCommit": "b9cffb6595f77972d749eb0a2443f81454813ec8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUxMzk0NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#discussion_r435513944", "bodyText": "I'll do another PR if you want. I was not touching this line and would prefer the PR to remain smalls and to reduce the risk they are not NF", "author": "Arthur-Milchior", "createdAt": "2020-06-04T19:56:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5NDk4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUxNjU0OQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#discussion_r435516549", "bodyText": "Nope, it's a TreeMap and they are not iterable.", "author": "Arthur-Milchior", "createdAt": "2020-06-04T20:02:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5NDk4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUxNzgzOQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#discussion_r435517839", "bodyText": "Doesn't .entrySet() or .values() work? That sucks. No need for another PR", "author": "david-allison-1", "createdAt": "2020-06-04T20:04:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5NDk4Mw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5NTYyNg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#discussion_r435495626", "bodyText": "if the connection break at this exact moment, the collection will be inconsistent.\n\nIs this handled in the code right now, or do we need an issue to fix this?", "author": "david-allison-1", "createdAt": "2020-06-04T19:21:07Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Utils.java", "diffHunk": "@@ -1017,4 +1017,29 @@ public static float randomFloatInRange(float min, float max) {\n         Random rand = new Random();\n         return rand.nextFloat() * (max - min) + min;\n     }\n+\n+    /**\n+       Set usn to 0 in every object.\n+\n+       Usn zero means that the object is already online. Non-zero usn\n+       means that the object is different than online or is not online.\n+\n+       This method is called during sync, before uploading, so during\n+       an instant, the value will be zero while the object is not\n+       actually online; if the connection break at this exact moment,\n+       the collection will be inconsistent.", "originalCommit": "b9cffb6595f77972d749eb0a2443f81454813ec8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUxMjQ3Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#discussion_r435512472", "bodyText": "This is not handled in the code, as the code is the same as in upstream. It was not handled in upstream either. I do not know whether rust takes care of it or not, rust is too hard for me to read.\nI assume you could take a full copy of the arrays as they are before uploading them, and if the sync fails, restore the copy. However, maybe the upload suceeded and we just never received the confirmation, so the arrays are correct and reverting to previous version would actually be the bug.\nI've no clue whether it ever was a problem for anyone (statistically, I assume it has been), but I've no reason to believe that it was actually an important problem", "author": "Arthur-Milchior", "createdAt": "2020-06-04T19:54:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5NTYyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUxMjg1NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#discussion_r435512855", "bodyText": "I should note in any case that the problem is exactly the same in current master and in this PR. The comment is new but it is about an already existing theoretical problem.", "author": "Arthur-Milchior", "createdAt": "2020-06-04T19:54:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5NTYyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUxNTMwOQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#discussion_r435515309", "bodyText": "Agreed - could you add an issue for someone later to investigate this? I'll do it - #6361", "author": "david-allison-1", "createdAt": "2020-06-04T19:59:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5NTYyNg=="}], "type": "inlineReview", "revised_code": {"commit": "54888591abadd36e100f0f6f9f8bcde28d03db4f", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/libanki/Utils.java b/AnkiDroid/src/main/java/com/ichi2/libanki/Utils.java\nindex 9e4c9dac2..51e6ae6d0 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/libanki/Utils.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/libanki/Utils.java\n\n@@ -1017,29 +1017,4 @@ public class Utils {\n         Random rand = new Random();\n         return rand.nextFloat() * (max - min) + min;\n     }\n-\n-    /**\n-       Set usn to 0 in every object.\n-\n-       Usn zero means that the object is already online. Non-zero usn\n-       means that the object is different than online or is not online.\n-\n-       This method is called during sync, before uploading, so during\n-       an instant, the value will be zero while the object is not\n-       actually online; if the connection break at this exact moment,\n-       the collection will be inconsistent.\n-\n-       @return whether there was a non-zero usn; in this case the list\n-       should be saved before the upload.\n-     */\n-    public static boolean shouldSave(ArrayList<JSONObject> ar) {\n-        boolean changed = false;\n-        for (JSONObject obj: ar) {\n-            if (obj.optInt(\"usn\", 1) != 0) {\n-                obj.put(\"usn\", 0);\n-                changed = true;\n-            }\n-        }\n-        return changed;\n-    }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5NzA1OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#discussion_r435497058", "bodyText": "Nit: needs a name change. should implies it doesn't make changed.\nMaybe markAsRequiringSync", "author": "david-allison-1", "createdAt": "2020-06-04T19:23:50Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Utils.java", "diffHunk": "@@ -1017,4 +1017,29 @@ public static float randomFloatInRange(float min, float max) {\n         Random rand = new Random();\n         return rand.nextFloat() * (max - min) + min;\n     }\n+\n+    /**\n+       Set usn to 0 in every object.\n+\n+       Usn zero means that the object is already online. Non-zero usn\n+       means that the object is different than online or is not online.\n+\n+       This method is called during sync, before uploading, so during\n+       an instant, the value will be zero while the object is not\n+       actually online; if the connection break at this exact moment,\n+       the collection will be inconsistent.\n+\n+       @return whether there was a non-zero usn; in this case the list\n+       should be saved before the upload.\n+     */\n+    public static boolean shouldSave(ArrayList<JSONObject> ar) {", "originalCommit": "b9cffb6595f77972d749eb0a2443f81454813ec8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUxMzQ5NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#discussion_r435513495", "bodyText": "Indeed, the \"save\" action is done by the caller. This method change the USN number. Actually, it is the reason why the save occurs, to save the new usn number (0) in the database.", "author": "Arthur-Milchior", "createdAt": "2020-06-04T19:56:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5NzA1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUxNTA4Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#discussion_r435515082", "bodyText": "I used another name, but changed it to a more descriptive name", "author": "Arthur-Milchior", "createdAt": "2020-06-04T19:59:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5NzA1OA=="}], "type": "inlineReview", "revised_code": {"commit": "54888591abadd36e100f0f6f9f8bcde28d03db4f", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/libanki/Utils.java b/AnkiDroid/src/main/java/com/ichi2/libanki/Utils.java\nindex 9e4c9dac2..51e6ae6d0 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/libanki/Utils.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/libanki/Utils.java\n\n@@ -1017,29 +1017,4 @@ public class Utils {\n         Random rand = new Random();\n         return rand.nextFloat() * (max - min) + min;\n     }\n-\n-    /**\n-       Set usn to 0 in every object.\n-\n-       Usn zero means that the object is already online. Non-zero usn\n-       means that the object is different than online or is not online.\n-\n-       This method is called during sync, before uploading, so during\n-       an instant, the value will be zero while the object is not\n-       actually online; if the connection break at this exact moment,\n-       the collection will be inconsistent.\n-\n-       @return whether there was a non-zero usn; in this case the list\n-       should be saved before the upload.\n-     */\n-    public static boolean shouldSave(ArrayList<JSONObject> ar) {\n-        boolean changed = false;\n-        for (JSONObject obj: ar) {\n-            if (obj.optInt(\"usn\", 1) != 0) {\n-                obj.put(\"usn\", 0);\n-                changed = true;\n-            }\n-        }\n-        return changed;\n-    }\n }\n"}}, {"oid": "54888591abadd36e100f0f6f9f8bcde28d03db4f", "url": "https://github.com/ankidroid/Anki-Android/commit/54888591abadd36e100f0f6f9f8bcde28d03db4f", "message": "Tags: save only if modified in beforeUpload", "committedDate": "2020-06-04T19:43:42Z", "type": "commit"}, {"oid": "4276b2cdd045c68dc1cb4e59a532efe6fbf997e3", "url": "https://github.com/ankidroid/Anki-Android/commit/4276b2cdd045c68dc1cb4e59a532efe6fbf997e3", "message": "Array of JSONObject: save only if modified in beforeUpload", "committedDate": "2020-06-04T19:58:42Z", "type": "commit"}, {"oid": "4276b2cdd045c68dc1cb4e59a532efe6fbf997e3", "url": "https://github.com/ankidroid/Anki-Android/commit/4276b2cdd045c68dc1cb4e59a532efe6fbf997e3", "message": "Array of JSONObject: save only if modified in beforeUpload", "committedDate": "2020-06-04T19:58:42Z", "type": "forcePushed"}]}