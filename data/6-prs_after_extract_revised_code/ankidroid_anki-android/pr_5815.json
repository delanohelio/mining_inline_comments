{"pr_number": 5815, "pr_title": "Fix #5811 - Clicking hint field blocks key input", "pr_createdAt": "2020-03-14T02:01:26Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/5815", "timeline": [{"oid": "40747cdd0102a0821a4f03703984cd24c54d2cbd", "url": "https://github.com/ankidroid/Anki-Android/commit/40747cdd0102a0821a4f03703984cd24c54d2cbd", "message": "Fix #5811 - Clicking hint field blocks key input\n\nUsing a bluetooth mouse and keyboard, clicking a `{{hint:}}` field\nfocused the WebView, disabling navigation via the keyboard and leaving\na permanent text bar input cursor when hovering over the WebView.\n\nWe fix this via implementing and calling new JavaScript function,\nwhich passes control back to the Android UI", "committedDate": "2020-03-14T02:09:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU4MjIzNg==", "url": "https://github.com/ankidroid/Anki-Android/pull/5815#discussion_r392582236", "bodyText": "you have a SIGNAL_NONE which is defensive, but there's no case for it, or Timber.w for the default case. Maybe a quick Timber.w in default that says 'received unexpected signal ...' ?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                default:\n          \n          \n            \n                                default:\n          \n          \n            \n                                    Timber.w(\"Received unexpected signal '%s' from WebView. Ignoring.\", url);\n          \n      \n    \n    \n  \n\nor something like that", "author": "mikehardy", "createdAt": "2020-03-14T12:20:54Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java", "diffHunk": "@@ -1469,11 +1471,18 @@ private boolean filterUrl(String url) {\n                     mFlipCardLayout.performClick();\n                     return true;\n                 }\n-                if (\"signal:typefocus\".equals(url)) {\n-                    // Hide the \u201cSHOW ANSWER\u201d button when the input has focus. The soft keyboard takes up enough space\n-                    // by itself.\n-                    mFlipCardLayout.setVisibility(View.GONE);\n-                    return true;\n+                switch (WebViewSignalParserUtils.getSignalFromUrl(url)) {\n+                    case WebViewSignalParserUtils.TYPE_FOCUS:\n+                        // Hide the \u201cSHOW ANSWER\u201d button when the input has focus. The soft keyboard takes up enough\n+                        // space by itself.\n+                        mFlipCardLayout.setVisibility(View.GONE);\n+                        return true;\n+                    case WebViewSignalParserUtils.RELINQUISH_FOCUS:\n+                        //#5811 - The WebView could be focused via mouse. Allow components to return focus to Android.\n+                        focusAnswerCompletionField();\n+                        return true;\n+                    default:", "originalCommit": "40747cdd0102a0821a4f03703984cd24c54d2cbd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d81a9b8ec42a09b420bc7abc4e61c124f3811c51", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java b/AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java\nindex 1c067ce8a..fb767fc8e 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java\n\n@@ -1471,7 +1484,12 @@ public abstract class AbstractFlashcardViewer extends NavigationDrawerActivity {\n                     mFlipCardLayout.performClick();\n                     return true;\n                 }\n-                switch (WebViewSignalParserUtils.getSignalFromUrl(url)) {\n+                int signalOrdinal = WebViewSignalParserUtils.getSignalFromUrl(url);\n+                switch (signalOrdinal) {\n+                    case WebViewSignalParserUtils.SIGNAL_UNHANDLED:\n+                        break; //continue parsing\n+                    case WebViewSignalParserUtils.SIGNAL_HANDLED:\n+                        return true;\n                     case WebViewSignalParserUtils.TYPE_FOCUS:\n                         // Hide the \u201cSHOW ANSWER\u201d button when the input has focus. The soft keyboard takes up enough\n                         // space by itself.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU4MjMzOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/5815#discussion_r392582338", "bodyText": "My suggestion for defensive programming logging above could alternatively be here, just some notice somewhere would be nice\nIn addition, if you're doing short-circuit returns, you can go from else if statements to just if statements which I think require just a tiny bit less cognitive work to reason about. That's a nit thought", "author": "mikehardy", "createdAt": "2020-03-14T12:23:22Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java", "diffHunk": "@@ -2925,4 +2944,24 @@ protected void dismiss(Collection.DismissType type) {\n         DeckTask.launchDeckTask(DeckTask.TASK_TYPE_DISMISS, mDismissCardHandler,\n                 new DeckTask.TaskData(new Object[]{mCurrentCard, type}));\n     }\n+\n+    /** Signals from a WebView represent actions with no parameters */\n+    @VisibleForTesting\n+    static class WebViewSignalParserUtils {\n+        public static final int SIGNAL_NONE = 0;\n+        public static final int TYPE_FOCUS = 1;\n+        /** Tell the app that we no longer want to focus the WebView and should instead return keyboard focus to a\n+         * native answer input method. */\n+        public static final int RELINQUISH_FOCUS = 2;\n+\n+        public static int getSignalFromUrl(String url) {\n+            if (\"signal:typefocus\".equals(url)) {\n+                return TYPE_FOCUS;\n+            } else if (\"signal:relinquishFocus\".equals(url)) {", "originalCommit": "40747cdd0102a0821a4f03703984cd24c54d2cbd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d81a9b8ec42a09b420bc7abc4e61c124f3811c51", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java b/AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java\nindex 1c067ce8a..fb767fc8e 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java\n\n@@ -2948,20 +3117,39 @@ public abstract class AbstractFlashcardViewer extends NavigationDrawerActivity {\n     /** Signals from a WebView represent actions with no parameters */\n     @VisibleForTesting\n     static class WebViewSignalParserUtils {\n-        public static final int SIGNAL_NONE = 0;\n-        public static final int TYPE_FOCUS = 1;\n+        /** A signal which we did not know how to handle */\n+        public static final int SIGNAL_UNHANDLED = 0;\n+        /** A known signal which should perform a noop */\n+        public static final int SIGNAL_HANDLED = 1;\n+\n+        public static final int TYPE_FOCUS = 2;\n         /** Tell the app that we no longer want to focus the WebView and should instead return keyboard focus to a\n          * native answer input method. */\n-        public static final int RELINQUISH_FOCUS = 2;\n+        public static final int RELINQUISH_FOCUS = 3;\n+\n+        public static final int SHOW_ANSWER = 4;\n+        public static final int ANSWER_ORDINAL_1 = 5;\n+        public static final int ANSWER_ORDINAL_2 = 6;\n+        public static final int ANSWER_ORDINAL_3 = 7;\n+        public static final int ANSWER_ORDINAL_4 = 8;\n \n         public static int getSignalFromUrl(String url) {\n-            if (\"signal:typefocus\".equals(url)) {\n-                return TYPE_FOCUS;\n-            } else if (\"signal:relinquishFocus\".equals(url)) {\n-                return RELINQUISH_FOCUS;\n+            switch (url) {\n+                case \"signal:typefocus\": return TYPE_FOCUS;\n+                case \"signal:relinquishFocus\": return RELINQUISH_FOCUS;\n+                case \"signal:show_answer\": return SHOW_ANSWER;\n+                case \"signal:answer_ease1\": return ANSWER_ORDINAL_1;\n+                case \"signal:answer_ease2\": return ANSWER_ORDINAL_2;\n+                case \"signal:answer_ease3\": return ANSWER_ORDINAL_3;\n+                case \"signal:answer_ease4\": return ANSWER_ORDINAL_4;\n+                default: break;\n+            }\n+\n+            if (url.startsWith(\"signal:answer_ease\")) {\n+                return SIGNAL_HANDLED;\n             }\n \n-            return SIGNAL_NONE; //unknown, or not a signal.\n+            return SIGNAL_UNHANDLED; //unknown, or not a signal.\n         }\n     }\n-}\n+}\n\\ No newline at end of file\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU4MjQ3NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/5815#discussion_r392582474", "bodyText": "@timrae I think this is the only potential change to existing behavior - do you have an opinion? The specific review note is:\n\nConfirm whether selecting the Text Input Field, rather than \"Show Answer\" on a note type with both {{hint:}} and {{type:}} is correct.\nNormally, a {{type:}} field does not have this focus initially.\nBut, even with focus on the text input field, ENTER displays the new card.", "author": "mikehardy", "createdAt": "2020-03-14T12:26:22Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java", "diffHunk": "@@ -1651,6 +1660,16 @@ protected void hideEaseButtons() {\n         mEase3Layout.setVisibility(View.GONE);\n         mEase4Layout.setVisibility(View.GONE);\n         mFlipCardLayout.setVisibility(View.VISIBLE);\n+        focusAnswerCompletionField();", "originalCommit": "40747cdd0102a0821a4f03703984cd24c54d2cbd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjcyNDAyMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5815#discussion_r392724021", "bodyText": "Related and to consider: #4699", "author": "david-allison-1", "createdAt": "2020-03-15T23:15:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU4MjQ3NA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "40747cdd0102a0821a4f03703984cd24c54d2cbd", "url": "https://github.com/ankidroid/Anki-Android/commit/40747cdd0102a0821a4f03703984cd24c54d2cbd", "message": "Fix #5811 - Clicking hint field blocks key input\n\nUsing a bluetooth mouse and keyboard, clicking a `{{hint:}}` field\nfocused the WebView, disabling navigation via the keyboard and leaving\na permanent text bar input cursor when hovering over the WebView.\n\nWe fix this via implementing and calling new JavaScript function,\nwhich passes control back to the Android UI", "committedDate": "2020-03-14T02:09:39Z", "type": "forcePushed"}, {"oid": "d81a9b8ec42a09b420bc7abc4e61c124f3811c51", "url": "https://github.com/ankidroid/Anki-Android/commit/d81a9b8ec42a09b420bc7abc4e61c124f3811c51", "message": "Fix #5811 - Clicking hint field blocks key input\n\nUsing a bluetooth mouse and keyboard, clicking a `{{hint:}}` field\nfocused the WebView, disabling navigation via the keyboard and leaving\na permanent text bar input cursor when hovering over the WebView.\n\nWe fix this via implementing and calling new JavaScript function,\nwhich passes control back to the Android UI", "committedDate": "2020-03-18T15:26:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU0OTgzMA==", "url": "https://github.com/ankidroid/Anki-Android/pull/5815#discussion_r394549830", "bodyText": "I don't understand how a signal that starts with answer_ease is handled, when the 4 we expect are above (and are handled in a switch when they are seen by the caller) but handled is actually not handled? who is handling it? Might be naming semantics - might be better as unhandled with a little more logging about an answer_ease value that we're not expecting?", "author": "mikehardy", "createdAt": "2020-03-18T18:17:28Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java", "diffHunk": "@@ -3092,4 +3113,43 @@ protected void dismiss(Collection.DismissType type) {\n         DeckTask.launchDeckTask(DeckTask.TASK_TYPE_DISMISS, mDismissCardHandler,\n                 new DeckTask.TaskData(new Object[]{mCurrentCard, type}));\n     }\n+\n+    /** Signals from a WebView represent actions with no parameters */\n+    @VisibleForTesting\n+    static class WebViewSignalParserUtils {\n+        /** A signal which we did not know how to handle */\n+        public static final int SIGNAL_UNHANDLED = 0;\n+        /** A known signal which should perform a noop */\n+        public static final int SIGNAL_HANDLED = 1;\n+\n+        public static final int TYPE_FOCUS = 2;\n+        /** Tell the app that we no longer want to focus the WebView and should instead return keyboard focus to a\n+         * native answer input method. */\n+        public static final int RELINQUISH_FOCUS = 3;\n+\n+        public static final int SHOW_ANSWER = 4;\n+        public static final int ANSWER_ORDINAL_1 = 5;\n+        public static final int ANSWER_ORDINAL_2 = 6;\n+        public static final int ANSWER_ORDINAL_3 = 7;\n+        public static final int ANSWER_ORDINAL_4 = 8;\n+\n+        public static int getSignalFromUrl(String url) {\n+            switch (url) {\n+                case \"signal:typefocus\": return TYPE_FOCUS;\n+                case \"signal:relinquishFocus\": return RELINQUISH_FOCUS;\n+                case \"signal:show_answer\": return SHOW_ANSWER;\n+                case \"signal:answer_ease1\": return ANSWER_ORDINAL_1;\n+                case \"signal:answer_ease2\": return ANSWER_ORDINAL_2;\n+                case \"signal:answer_ease3\": return ANSWER_ORDINAL_3;\n+                case \"signal:answer_ease4\": return ANSWER_ORDINAL_4;\n+                default: break;\n+            }\n+\n+            if (url.startsWith(\"signal:answer_ease\")) {\n+                return SIGNAL_HANDLED;", "originalCommit": "d81a9b8ec42a09b420bc7abc4e61c124f3811c51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU1NDgzMw==", "url": "https://github.com/ankidroid/Anki-Android/pull/5815#discussion_r394554833", "bodyText": "Yep, naming.\nCurrently\nUnhandled: We don't know about this, it's not a signal so try intent processing.\nHandled: We know about this, but have no associated action to take.\nMaybe SIGNAL_HANDLED => SIGNAL_NOOP?", "author": "david-allison-1", "createdAt": "2020-03-18T18:26:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU0OTgzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU1NTU4MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/5815#discussion_r394555580", "bodyText": "I guess the aim is: we want to stop execution and return true from a NOOP, and continue processing from anything unhandled.", "author": "david-allison-1", "createdAt": "2020-03-18T18:27:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU0OTgzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU4MTgwNg==", "url": "https://github.com/ankidroid/Anki-Android/pull/5815#discussion_r394581806", "bodyText": "SIGNAL_NOOP sounds good, with an associated Timber.w because it feels like it is unexpected input/state (thus more than info), but we can certainly continue processing (thus not error) ?", "author": "mikehardy", "createdAt": "2020-03-18T19:14:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU0OTgzMA=="}], "type": "inlineReview", "revised_code": {"commit": "8aae1768128d56df6ebfd2c1c4b3a36fae3b5eef", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java b/AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java\nindex fb767fc8e..0e7a15e5e 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java\n\n@@ -3120,7 +3120,7 @@ public abstract class AbstractFlashcardViewer extends NavigationDrawerActivity {\n         /** A signal which we did not know how to handle */\n         public static final int SIGNAL_UNHANDLED = 0;\n         /** A known signal which should perform a noop */\n-        public static final int SIGNAL_HANDLED = 1;\n+        public static final int SIGNAL_NOOP = 1;\n \n         public static final int TYPE_FOCUS = 2;\n         /** Tell the app that we no longer want to focus the WebView and should instead return keyboard focus to a\n"}}, {"oid": "8aae1768128d56df6ebfd2c1c4b3a36fae3b5eef", "url": "https://github.com/ankidroid/Anki-Android/commit/8aae1768128d56df6ebfd2c1c4b3a36fae3b5eef", "message": "Fix #5811 - Clicking hint field blocks key input\n\nUsing a bluetooth mouse and keyboard, clicking a `{{hint:}}` field\nfocused the WebView, disabling navigation via the keyboard and leaving\na permanent text bar input cursor when hovering over the WebView.", "committedDate": "2020-03-18T19:21:09Z", "type": "commit"}, {"oid": "8aae1768128d56df6ebfd2c1c4b3a36fae3b5eef", "url": "https://github.com/ankidroid/Anki-Android/commit/8aae1768128d56df6ebfd2c1c4b3a36fae3b5eef", "message": "Fix #5811 - Clicking hint field blocks key input\n\nUsing a bluetooth mouse and keyboard, clicking a `{{hint:}}` field\nfocused the WebView, disabling navigation via the keyboard and leaving\na permanent text bar input cursor when hovering over the WebView.", "committedDate": "2020-03-18T19:21:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU4Njk0MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5815#discussion_r394586941", "bodyText": "Issue found: Avoid unused imports such as 'com.ichi2.anki.AbstractFlashcardViewer.WebViewSignalParserUtils'", "author": "timrae", "createdAt": "2020-03-18T19:24:27Z", "path": "AnkiDroid/src/test/java/com/ichi2/anki/AbstractFlashcardViewerTest.java", "diffHunk": "@@ -8,6 +8,7 @@\n \n import androidx.test.ext.junit.runners.AndroidJUnit4;\n \n+import static com.ichi2.anki.AbstractFlashcardViewer.WebViewSignalParserUtils.*;", "originalCommit": "8aae1768128d56df6ebfd2c1c4b3a36fae3b5eef", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}