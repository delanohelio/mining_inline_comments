{"pr_number": 5869, "pr_title": "CardBrowser: Multiple Selection Fixes", "pr_createdAt": "2020-03-26T21:42:27Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/5869", "timeline": [{"oid": "a6e6937a661bda6a285bd1f99c5942746d875471", "url": "https://github.com/ankidroid/Anki-Android/commit/a6e6937a661bda6a285bd1f99c5942746d875471", "message": "NF: Add logging", "committedDate": "2020-03-26T20:33:25Z", "type": "commit"}, {"oid": "1a9566c4c35d7905f9d65c966def7e6e323a7994", "url": "https://github.com/ankidroid/Anki-Android/commit/1a9566c4c35d7905f9d65c966def7e6e323a7994", "message": "Extracted deckDropDownItemChanged to allow tests\n\nRoboelectric previously threw a StackOverflow due to an infinite loop\nin setting the position.", "committedDate": "2020-03-26T20:37:23Z", "type": "commit"}, {"oid": "a702a61007980d3ff9cd0317dd36536d9ae9fade", "url": "https://github.com/ankidroid/Anki-Android/commit/a702a61007980d3ff9cd0317dd36536d9ae9fade", "message": "CardBrowser: Initial Unit Tests\n\nWe want to modify the card selection status, keep some initial tests\nwhich do not need to change", "committedDate": "2020-03-26T20:44:15Z", "type": "commit"}, {"oid": "694a60b49e1eeaa62182867998dffc51b6e6a89a", "url": "https://github.com/ankidroid/Anki-Android/commit/694a60b49e1eeaa62182867998dffc51b6e6a89a", "message": "Extract: hasSelectedAllCards", "committedDate": "2020-03-26T20:48:06Z", "type": "commit"}, {"oid": "dbc08919bd4c64f1c2948ad43cec38ccf6f8aa44", "url": "https://github.com/ankidroid/Anki-Android/commit/dbc08919bd4c64f1c2948ad43cec38ccf6f8aa44", "message": "Add 'Select None' as well as 'Select All'\n\nThis allows both Select All and Select None to be displayed when some,\nbut not all cards are selected.", "committedDate": "2020-03-26T21:04:02Z", "type": "commit"}, {"oid": "90553d435c5090984225d1c43892984929b95e34", "url": "https://github.com/ankidroid/Anki-Android/commit/90553d435c5090984225d1c43892984929b95e34", "message": "NF: mActionBarMenu is nullable", "committedDate": "2020-03-26T21:05:02Z", "type": "commit"}, {"oid": "7470546741628e215c1f75072996a8260a3e06a5", "url": "https://github.com/ankidroid/Anki-Android/commit/7470546741628e215c1f75072996a8260a3e06a5", "message": "Add \"Select All\" to Browser when in Single Select\n\nFixes #5464\n\nConsolidates state update for selection updates to onSelectionChanged()\n\nAdds \"Select All\" to the single-select screen which uses the same\nmechanism and same ID as the multiselect \"Select All\"\n\nThis also removes the state where clicking \"Select None\" moves the user\nto a multiselect with no items selected.", "committedDate": "2020-03-26T21:47:40Z", "type": "commit"}, {"oid": "7470546741628e215c1f75072996a8260a3e06a5", "url": "https://github.com/ankidroid/Anki-Android/commit/7470546741628e215c1f75072996a8260a3e06a5", "message": "Add \"Select All\" to Browser when in Single Select\n\nFixes #5464\n\nConsolidates state update for selection updates to onSelectionChanged()\n\nAdds \"Select All\" to the single-select screen which uses the same\nmechanism and same ID as the multiselect \"Select All\"\n\nThis also removes the state where clicking \"Select None\" moves the user\nto a multiselect with no items selected.", "committedDate": "2020-03-26T21:47:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODkxNDU1NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5869#discussion_r398914555", "bodyText": "performed in onSelectionChanged", "author": "david-allison-1", "createdAt": "2020-03-26T21:51:09Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -717,7 +721,6 @@ public void onClick(View v) {\n             // multi-select mode\n             getMenuInflater().inflate(R.menu.card_browser_multiselect, menu);\n             showBackIcon();\n-            updateMultiselectMenu();", "originalCommit": "7470546741628e215c1f75072996a8260a3e06a5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODkxNDk0Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/5869#discussion_r398914946", "bodyText": "updateCardsInList -> updateList -> onSelectionChanged", "author": "david-allison-1", "createdAt": "2020-03-26T21:51:58Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -1438,7 +1463,6 @@ private void removeNotesView(Card[] cards) {\n         protected void actualPostExecute(DeckTask.TaskData result) {\n             Card[] cards = (Card[]) result.getObjArray();\n             updateCardsInList(Arrays.asList(cards), null);\n-            updateMultiselectMenu();", "originalCommit": "7470546741628e215c1f75072996a8260a3e06a5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODkxNTI2Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/5869#discussion_r398915263", "bodyText": "This button had two purposes, we split it into onSelectAll and onSelectNone", "author": "david-allison-1", "createdAt": "2020-03-26T21:52:46Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -1798,28 +1821,47 @@ private void onCheck(int position, View cell) {\n             mCheckedCardPositions.remove(position);\n         }\n \n-        updateMultiselectMenu();\n+       onSelectionChanged();\n+    }\n \n-        if (mCheckedCardPositions.isEmpty()) {\n-            // when 0 are selected: end selection mode\n-            endMultiSelectMode();\n-        } else {\n-            mActionBarTitle.setText(Integer.toString(mCheckedCardPositions.size()));\n+    private void onSelectAll() {\n+        for (int i = 0; i < mCards.size(); i++) {\n+            mCheckedCardPositions.add(i);\n         }\n+        onSelectionChanged();\n     }\n \n-    private void onCheckAll() {\n-        boolean all = mCheckedCardPositions.size() < getCards().size();", "originalCommit": "7470546741628e215c1f75072996a8260a3e06a5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTg1ODA3Nw==", "url": "https://github.com/ankidroid/Anki-Android/pull/5869#discussion_r399858077", "bodyText": "I've seen in one other place that async tasks are sometimes working on CardBrowser member variables, and a clear causes NPEs and ConcurrentModExceptions - how would you feel about changing this from .clear() to creating a new empty object? Feels like a defensive programming improvement to me", "author": "mikehardy", "createdAt": "2020-03-29T21:43:45Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -1825,20 +1830,25 @@ private void onCheck(int position, View cell) {\n         }\n     }\n \n-    private void onCheckAll() {\n-        boolean all = mCheckedCardPositions.size() < getCards().size();\n-        if (all) {\n-            for (int i = 0; i < mCards.size(); i++) {\n-                mCheckedCardPositions.add(i);\n-            }\n-        } else {\n-            mCheckedCardPositions.clear();\n+    private void onSelectAll() {\n+        for (int i = 0; i < mCards.size(); i++) {\n+            mCheckedCardPositions.add(i);\n         }\n+        onSelectionChanged();\n+    }\n+\n+    private void onSelectNone() {\n+        mCheckedCardPositions.clear();", "originalCommit": "dbc08919bd4c64f1c2948ad43cec38ccf6f8aa44", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTg1OTI2MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5869#discussion_r399859261", "bodyText": "It's an improvement, but it hides the problem. Is there a reason we're not using a concurrent structure for this instead?", "author": "david-allison-1", "createdAt": "2020-03-29T21:54:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTg1ODA3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTg2MDEzOQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5869#discussion_r399860139", "bodyText": "no reason in particular :-), in general because concurrency is hard - and simply throwing the old object on the GC (either now, or when async task is finished) seems so easy...", "author": "mikehardy", "createdAt": "2020-03-29T22:02:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTg1ODA3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTg4OTM3Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/5869#discussion_r399889372", "bodyText": "Flipped to a concurrent structure. Doesn't look too painful in this instance", "author": "david-allison-1", "createdAt": "2020-03-30T01:46:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTg1ODA3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "22040be74f19eeec20546c0ed4424929c0658052", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java b/AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java\nindex 823ab46c36..fabd2dcd8e 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java\n\n@@ -1820,14 +1821,7 @@ public class CardBrowser extends NavigationDrawerActivity implements\n             mCheckedCardPositions.remove(position);\n         }\n \n-        updateMultiselectMenu();\n-\n-        if (mCheckedCardPositions.isEmpty()) {\n-            // when 0 are selected: end selection mode\n-            endMultiSelectMode();\n-        } else {\n-            mActionBarTitle.setText(Integer.toString(mCheckedCardPositions.size()));\n-        }\n+       onSelectionChanged();\n     }\n \n     private void onSelectAll() {\n"}}, {"oid": "22040be74f19eeec20546c0ed4424929c0658052", "url": "https://github.com/ankidroid/Anki-Android/commit/22040be74f19eeec20546c0ed4424929c0658052", "message": "Made CheckedCardPositions concurrent\n\nAs it's accessed via an AsyncTask.", "committedDate": "2020-03-30T01:31:18Z", "type": "commit"}, {"oid": "94c58b4fe3a57b27c40ff872c3625b6058bcac3c", "url": "https://github.com/ankidroid/Anki-Android/commit/94c58b4fe3a57b27c40ff872c3625b6058bcac3c", "message": "Make getSelectedCardIds thread safe", "committedDate": "2020-03-31T15:19:44Z", "type": "commit"}]}