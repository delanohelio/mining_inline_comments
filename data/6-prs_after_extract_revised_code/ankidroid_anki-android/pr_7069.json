{"pr_number": 7069, "pr_title": "Correction of 7066", "pr_createdAt": "2020-09-12T15:34:00Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/7069", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQyMTA2Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/7069#discussion_r487421066", "bodyText": "AnkiAssert.assertDoesNotThrow(() -> sched.preloadNextCard());", "author": "david-allison-1", "createdAt": "2020-09-12T15:35:28Z", "path": "AnkiDroid/src/test/java/com/ichi2/libanki/sched/AbstractSchedTest.java", "diffHunk": "@@ -377,4 +377,25 @@ private void addDeckWithExactName(String name) {\n         boolean hasMatch = decks.all().stream().anyMatch(x -> name.equals(x.getString(\"name\")));\n         assertThat(String.format(\"Deck %s should exist\", name), hasMatch, is(true));\n     }\n+\n+\n+\n+    @Test\n+    public void regression_7066() {\n+        Collection col = getCol();\n+        DeckConfig dconf = col.getDecks().getConf(1);\n+        dconf.getJSONObject(\"new\").put(\"bury\", true);\n+        AbstractSched sched = col.getSched();\n+        addNoteUsingBasicAndReversedModel(\"foo\", \"bar\");\n+        addNoteUsingBasicModel(\"plop\", \"foo\");\n+        col.reset();\n+        Card card = sched.getCard();\n+        sched.setCurrentCard(card);\n+        sched.preloadNextCard();\n+        sched.answerCard(card, Consts.BUTTON_THREE);\n+        card = sched.getCard();\n+        sched.setCurrentCard(card);\n+        // Next line was an infinite recursion in 7066. We just want to assert the run halts\n+        sched.preloadNextCard();", "originalCommit": "221617876aa2b484a864deb62ffcb1d41c98ee61", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQyMTgxNw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7069#discussion_r487421817", "bodyText": "May I ask how assertDoesNotThrow test more than running (since it fails if it throws)", "author": "Arthur-Milchior", "createdAt": "2020-09-12T15:44:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQyMTA2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQyMzI1OQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7069#discussion_r487423259", "bodyText": "I think it's mostly an optimization vs Codacy saying \"you should assert in a test\"\n\n/** Helper to sort out \"JUnit tests should include assert() or fail()\" quality check */", "author": "mikehardy", "createdAt": "2020-09-12T16:02:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQyMTA2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQzNTkxMg==", "url": "https://github.com/ankidroid/Anki-Android/pull/7069#discussion_r487435912", "bodyText": "You get an assertion error, rather than a method throwing an exception - which the tools detect differently\nIt's also more explicit that one specific line is under test.", "author": "david-allison-1", "createdAt": "2020-09-12T18:30:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQyMTA2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "661b8369f9f369eb0beee22e1358edc5538b6485", "chunk": "diff --git a/AnkiDroid/src/test/java/com/ichi2/libanki/sched/AbstractSchedTest.java b/AnkiDroid/src/test/java/com/ichi2/libanki/sched/AbstractSchedTest.java\nindex 9ed559ed5..395b75aba 100644\n--- a/AnkiDroid/src/test/java/com/ichi2/libanki/sched/AbstractSchedTest.java\n+++ b/AnkiDroid/src/test/java/com/ichi2/libanki/sched/AbstractSchedTest.java\n\n@@ -395,7 +395,6 @@ mw.col.sched.extendLimits(1, 0)\n         sched.answerCard(card, Consts.BUTTON_THREE);\n         card = sched.getCard();\n         sched.setCurrentCard(card);\n-        // Next line was an infinite recursion in 7066. We just want to assert the run halts\n-        sched.preloadNextCard();\n+        AnkiAssert.assertDoesNotThrow(() -> sched.preloadNextCard());\n     }\n }\n"}}, {"oid": "661b8369f9f369eb0beee22e1358edc5538b6485", "url": "https://github.com/ankidroid/Anki-Android/commit/661b8369f9f369eb0beee22e1358edc5538b6485", "message": "Pre load card deal correctly with end of queue\n\nSome commits ago, I ensured that the counts takes current card into account. It seems I forgot to stop decrementing\ncurrent card when resetting the counts.\nI used to search for use to mCurrentCard and did not find directly obvious that it should not have been an argument to _resetNew.", "committedDate": "2020-09-12T15:45:20Z", "type": "forcePushed"}, {"oid": "9e8fa3cc3b3cd756aa67b2525790161afaf16c3e", "url": "https://github.com/ankidroid/Anki-Android/commit/9e8fa3cc3b3cd756aa67b2525790161afaf16c3e", "message": "NF: regression test for 7066", "committedDate": "2020-09-12T15:46:58Z", "type": "commit"}, {"oid": "7d9383cfb0cbe2237464ef87562029a9adef1ec6", "url": "https://github.com/ankidroid/Anki-Android/commit/7d9383cfb0cbe2237464ef87562029a9adef1ec6", "message": "Pre load card deal correctly with end of queue\n\nSome commits ago, I ensured that the counts takes current card into account. It seems I forgot to stop decrementing\ncurrent card when resetting the counts.\nI used to search for use to mCurrentCard and did not find directly obvious that it should not have been an argument to _resetNew.", "committedDate": "2020-09-12T15:46:58Z", "type": "commit"}, {"oid": "7d9383cfb0cbe2237464ef87562029a9adef1ec6", "url": "https://github.com/ankidroid/Anki-Android/commit/7d9383cfb0cbe2237464ef87562029a9adef1ec6", "message": "Pre load card deal correctly with end of queue\n\nSome commits ago, I ensured that the counts takes current card into account. It seems I forgot to stop decrementing\ncurrent card when resetting the counts.\nI used to search for use to mCurrentCard and did not find directly obvious that it should not have been an argument to _resetNew.", "committedDate": "2020-09-12T15:46:58Z", "type": "forcePushed"}]}