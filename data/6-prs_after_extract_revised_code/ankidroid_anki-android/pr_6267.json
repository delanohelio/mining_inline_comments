{"pr_number": 6267, "pr_title": "display languages in preferences using their own language", "pr_createdAt": "2020-05-24T00:22:24Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6267", "timeline": [{"oid": "785e30855054108a53fb2e539d93e4a2360d0ec8", "url": "https://github.com/ankidroid/Anki-Android/commit/785e30855054108a53fb2e539d93e4a2360d0ec8", "message": "show all available languages in preferences using their own language\nsort languages alphabetically, ignoring upper/lower case\n\nadd comment on exception handler", "committedDate": "2020-05-24T00:10:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU4ODYwNw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6267#discussion_r429588607", "bodyText": "Beware of Arrays.asList. It returns an implementation of List where calling add will crash. This is fine, but for future reference.", "author": "david-allison-1", "createdAt": "2020-05-24T00:34:35Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/Preferences.java", "diffHunk": "@@ -810,22 +810,25 @@ private String replaceStringIfNumeric(String str, String value) {\n \n     private void initializeLanguageDialog(PreferenceScreen screen) {\n         ListPreference languageSelection = (ListPreference) screen.findPreference(LANGUAGE);\n-        Locale currentAppLocale = LanguageUtil.getLocale(AnkiDroidApp.getSharedPrefs(AnkiDroidApp.getInstance())\n-                .getString(Preferences.LANGUAGE, \"\"));\n         if (languageSelection != null) {\n-            Map<String, String> items = new TreeMap<>();\n+            Map<String, List<String>> items = new TreeMap<>();\n             for (String localeCode : LanguageUtil.APP_LANGUAGES) {\n                 Locale loc = LanguageUtil.getLocale(localeCode);\n-                items.put(loc.getDisplayName(currentAppLocale), loc.toString());\n+                //TreeMap always sorted by key.\n+                //      Key is a String: all display names converted to lower case for correct display order.\n+                //      Value is list of 2 strings:\n+                //          1st element is display name with unmodified case\n+                //          2nd element is locale code\n+                items.put(loc.getDisplayName(loc).toLowerCase(), Arrays.asList(loc.getDisplayName(loc), loc.toString()));", "originalCommit": "785e30855054108a53fb2e539d93e4a2360d0ec8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c06dcd3bb79c827c4874a92da449ae2b3c2b54bc", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/anki/Preferences.java b/AnkiDroid/src/main/java/com/ichi2/anki/Preferences.java\nindex 26c400db2..1e07008ee 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/anki/Preferences.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/anki/Preferences.java\n\n@@ -811,24 +811,19 @@ public class Preferences extends AppCompatPreferenceActivity implements Preferen\n     private void initializeLanguageDialog(PreferenceScreen screen) {\n         ListPreference languageSelection = (ListPreference) screen.findPreference(LANGUAGE);\n         if (languageSelection != null) {\n-            Map<String, List<String>> items = new TreeMap<>();\n+            Map<String, String> items = new TreeMap<>(String.CASE_INSENSITIVE_ORDER);\n             for (String localeCode : LanguageUtil.APP_LANGUAGES) {\n                 Locale loc = LanguageUtil.getLocale(localeCode);\n-                //TreeMap always sorted by key.\n-                //      Key is a String: all display names converted to lower case for correct display order.\n-                //      Value is list of 2 strings:\n-                //          1st element is display name with unmodified case\n-                //          2nd element is locale code\n-                items.put(loc.getDisplayName(loc).toLowerCase(), Arrays.asList(loc.getDisplayName(loc), loc.toString()));\n+                items.put(loc.getDisplayName(loc), loc.toString());\n             }\n             CharSequence[] languageDialogLabels = new CharSequence[items.size() + 1];\n             CharSequence[] languageDialogValues = new CharSequence[items.size() + 1];\n             languageDialogLabels[0] = getResources().getString(R.string.language_system);\n             languageDialogValues[0] = \"\";\n             int i = 1;\n-            for (Map.Entry<String, List<String>> e : items.entrySet()) {\n-                languageDialogLabels[i] = e.getValue().get(0); //display name\n-                languageDialogValues[i] = e.getValue().get(1); //locale code\n+            for (Map.Entry<String, String> e : items.entrySet()) {\n+                languageDialogLabels[i] = e.getKey();\n+                languageDialogValues[i] = e.getValue();\n                 i++;\n             }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU4ODc4Nw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6267#discussion_r429588787", "bodyText": "I think this will work, and will allow you to reduce complexity further down (as you'd be able to use the key as-is):\nnew TreeMap(String.CASE_INSENSITIVE_ORDER);", "author": "david-allison-1", "createdAt": "2020-05-24T00:39:07Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/Preferences.java", "diffHunk": "@@ -810,22 +810,25 @@ private String replaceStringIfNumeric(String str, String value) {\n \n     private void initializeLanguageDialog(PreferenceScreen screen) {\n         ListPreference languageSelection = (ListPreference) screen.findPreference(LANGUAGE);\n-        Locale currentAppLocale = LanguageUtil.getLocale(AnkiDroidApp.getSharedPrefs(AnkiDroidApp.getInstance())\n-                .getString(Preferences.LANGUAGE, \"\"));\n         if (languageSelection != null) {\n-            Map<String, String> items = new TreeMap<>();\n+            Map<String, List<String>> items = new TreeMap<>();", "originalCommit": "785e30855054108a53fb2e539d93e4a2360d0ec8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU5MDQzMA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6267#discussion_r429590430", "bodyText": "Well, this is oviously the even simpler solution and also makes the List part unnecessary, so implemented.", "author": "Arthus", "createdAt": "2020-05-24T01:23:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU4ODc4Nw=="}], "type": "inlineReview", "revised_code": {"commit": "c06dcd3bb79c827c4874a92da449ae2b3c2b54bc", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/anki/Preferences.java b/AnkiDroid/src/main/java/com/ichi2/anki/Preferences.java\nindex 26c400db2..1e07008ee 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/anki/Preferences.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/anki/Preferences.java\n\n@@ -811,24 +811,19 @@ public class Preferences extends AppCompatPreferenceActivity implements Preferen\n     private void initializeLanguageDialog(PreferenceScreen screen) {\n         ListPreference languageSelection = (ListPreference) screen.findPreference(LANGUAGE);\n         if (languageSelection != null) {\n-            Map<String, List<String>> items = new TreeMap<>();\n+            Map<String, String> items = new TreeMap<>(String.CASE_INSENSITIVE_ORDER);\n             for (String localeCode : LanguageUtil.APP_LANGUAGES) {\n                 Locale loc = LanguageUtil.getLocale(localeCode);\n-                //TreeMap always sorted by key.\n-                //      Key is a String: all display names converted to lower case for correct display order.\n-                //      Value is list of 2 strings:\n-                //          1st element is display name with unmodified case\n-                //          2nd element is locale code\n-                items.put(loc.getDisplayName(loc).toLowerCase(), Arrays.asList(loc.getDisplayName(loc), loc.toString()));\n+                items.put(loc.getDisplayName(loc), loc.toString());\n             }\n             CharSequence[] languageDialogLabels = new CharSequence[items.size() + 1];\n             CharSequence[] languageDialogValues = new CharSequence[items.size() + 1];\n             languageDialogLabels[0] = getResources().getString(R.string.language_system);\n             languageDialogValues[0] = \"\";\n             int i = 1;\n-            for (Map.Entry<String, List<String>> e : items.entrySet()) {\n-                languageDialogLabels[i] = e.getValue().get(0); //display name\n-                languageDialogValues[i] = e.getValue().get(1); //locale code\n+            for (Map.Entry<String, String> e : items.entrySet()) {\n+                languageDialogLabels[i] = e.getKey();\n+                languageDialogValues[i] = e.getValue();\n                 i++;\n             }\n \n"}}, {"oid": "c06dcd3bb79c827c4874a92da449ae2b3c2b54bc", "url": "https://github.com/ankidroid/Anki-Android/commit/c06dcd3bb79c827c4874a92da449ae2b3c2b54bc", "message": "even simpler solution for case insensitive sorting", "committedDate": "2020-05-24T01:21:16Z", "type": "commit"}]}