{"pr_number": 7600, "pr_title": "NF: calls ids2String without useless conversions", "pr_createdAt": "2020-11-02T11:15:30Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/7600", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTkxMzMxNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7600#discussion_r515913315", "bodyText": "What's the extra comma for?", "author": "david-allison-1", "createdAt": "2020-11-02T11:36:41Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -2609,14 +2609,9 @@ public void confirmDeckDeletion(long did) {\n             return;\n         }\n         // Get the number of cards contained in this deck and its subdecks\n-        TreeMap<String, Long> children = getCol().getDecks().children(did);\n-        long[] dids = new long[children.size() + 1];\n-        dids[0] = did;\n-        int i = 1;\n-        for (Long l : children.values()) {\n-            dids[i++] = l;\n-        }\n-        String ids = Utils.ids2str(dids);\n+        java.util.Collection<Long> children = getCol().getDecks().children(did).values();\n+        children.add(did);\n+        String ids = Utils.ids2str(children)+ \",\";", "originalCommit": "5a9f798b5faa4e8f1a2f7931821f8338984de6bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTkxNjg0Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7600#discussion_r515916843", "bodyText": "THe inital goal was to add the element directly. I then realized it would really not work and so changed and added it in the set of values", "author": "Arthur-Milchior", "createdAt": "2020-11-02T11:43:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTkxMzMxNQ=="}], "type": "inlineReview", "revised_code": {"commit": "3dc1e3cb9ab0028e4081f6332b3fae79bb858973", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java b/AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java\nindex 7bbc228d7..796737ef2 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java\n\n@@ -2611,7 +2611,7 @@ public class DeckPicker extends NavigationDrawerActivity implements\n         // Get the number of cards contained in this deck and its subdecks\n         java.util.Collection<Long> children = getCol().getDecks().children(did).values();\n         children.add(did);\n-        String ids = Utils.ids2str(children)+ \",\";\n+        String ids = Utils.ids2str(children);\n         int cnt = getCol().getDb().queryScalar(\n                 \"select count() from cards where did in \" + ids + \" or odid in \" + ids);\n         // Delete empty decks without warning\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTkxMzgxMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7600#discussion_r515913811", "bodyText": "You can't use array.toString()", "author": "david-allison-1", "createdAt": "2020-11-02T11:37:48Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -2042,7 +2042,7 @@ private void _closeLog() {\n      */\n     public void setUserFlag(int flag, long[] cids)  {\n         assert (0<= flag && flag <= 7);\n-        mDb.execute(\"update cards set flags = (flags & ~?) | ?, usn=?, mod=? where id in \" + Utils.ids2str(cids),\n+        mDb.execute(\"update cards set flags = (flags & ~?) | ?, usn=?, mod=? where id in \" + cids,", "originalCommit": "5a9f798b5faa4e8f1a2f7931821f8338984de6bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTkxNzMzMA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7600#discussion_r515917330", "bodyText": "This is clearly a mistake. I just wanted to remove conversion. thanks", "author": "Arthur-Milchior", "createdAt": "2020-11-02T11:44:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTkxMzgxMQ=="}], "type": "inlineReview", "revised_code": {"commit": "5704d1be3e9d3859f1bbc3ebf08d07ef231b5414", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java b/AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java\nindex d25451b40..446ed4284 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java\n\n@@ -2042,7 +2042,7 @@ public class Collection {\n      */\n     public void setUserFlag(int flag, long[] cids)  {\n         assert (0<= flag && flag <= 7);\n-        mDb.execute(\"update cards set flags = (flags & ~?) | ?, usn=?, mod=? where id in \" + cids,\n+        mDb.execute(\"update cards set flags = (flags & ~?) | ?, usn=?, mod=? where id in \" + Utils.ids2str(cids),\n                     0b111, flag, usn(), getTime().intTime());\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTkxMzk0NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7600#discussion_r515913944", "bodyText": "Ditto - and this needs regression coverage, as the breakage wasn't caught.", "author": "david-allison-1", "createdAt": "2020-11-02T11:38:07Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -2193,7 +2193,7 @@ public Context getContext() {\n     /** Not in libAnki */\n     @CheckResult\n     public List<Long> filterToValidCards(long[] cards) {\n-        return getDb().queryLongList(\"select id from cards where id in \" + Utils.ids2str(cards));\n+        return getDb().queryLongList(\"select id from cards where id in \" + cards);", "originalCommit": "5a9f798b5faa4e8f1a2f7931821f8338984de6bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTkyMDQ4Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/7600#discussion_r515920482", "bodyText": "Added", "author": "Arthur-Milchior", "createdAt": "2020-11-02T11:51:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTkxMzk0NA=="}], "type": "inlineReview", "revised_code": {"commit": "5704d1be3e9d3859f1bbc3ebf08d07ef231b5414", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java b/AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java\nindex d25451b40..446ed4284 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java\n\n@@ -2193,7 +2193,7 @@ public class Collection {\n     /** Not in libAnki */\n     @CheckResult\n     public List<Long> filterToValidCards(long[] cards) {\n-        return getDb().queryLongList(\"select id from cards where id in \" + cards);\n+        return getDb().queryLongList(\"select id from cards where id in \" + Utils.ids2str(cards));\n     }\n \n     public int queryVer() throws UnknownDatabaseVersionException {\n"}}, {"oid": "3dc1e3cb9ab0028e4081f6332b3fae79bb858973", "url": "https://github.com/ankidroid/Anki-Android/commit/3dc1e3cb9ab0028e4081f6332b3fae79bb858973", "message": "NF: calls ids2String without useless conversions\n\nThose values without conversion are already usable as-is", "committedDate": "2020-11-02T11:43:25Z", "type": "forcePushed"}, {"oid": "5704d1be3e9d3859f1bbc3ebf08d07ef231b5414", "url": "https://github.com/ankidroid/Anki-Android/commit/5704d1be3e9d3859f1bbc3ebf08d07ef231b5414", "message": "NF: calls ids2String without useless conversions\n\nThose values without conversion are already usable as-is", "committedDate": "2020-11-02T11:45:04Z", "type": "forcePushed"}, {"oid": "60d7d670de0d05e22bf7b42aa9312f8cd4258bca", "url": "https://github.com/ankidroid/Anki-Android/commit/60d7d670de0d05e22bf7b42aa9312f8cd4258bca", "message": "NF: regression test filterToValidCards", "committedDate": "2020-11-02T12:34:22Z", "type": "forcePushed"}, {"oid": "a2752e4728a77e460f0f9e4b2f396dfd2af79fa6", "url": "https://github.com/ankidroid/Anki-Android/commit/a2752e4728a77e460f0f9e4b2f396dfd2af79fa6", "message": "NF: regression test filterToValidCards", "committedDate": "2020-11-02T13:14:15Z", "type": "forcePushed"}, {"oid": "b41a07dd52c5d78ee083faeabe55949c7d1f7953", "url": "https://github.com/ankidroid/Anki-Android/commit/b41a07dd52c5d78ee083faeabe55949c7d1f7953", "message": "NF: calls ids2String without useless conversions\n\nThose values without conversion are already usable as-is", "committedDate": "2020-11-07T03:04:40Z", "type": "commit"}, {"oid": "5ab25ad059b86c4ca111ec44450b7c250f04c4c4", "url": "https://github.com/ankidroid/Anki-Android/commit/5ab25ad059b86c4ca111ec44450b7c250f04c4c4", "message": "NF: regression test filterToValidCards", "committedDate": "2020-11-07T03:04:40Z", "type": "commit"}, {"oid": "5ab25ad059b86c4ca111ec44450b7c250f04c4c4", "url": "https://github.com/ankidroid/Anki-Android/commit/5ab25ad059b86c4ca111ec44450b7c250f04c4c4", "message": "NF: regression test filterToValidCards", "committedDate": "2020-11-07T03:04:40Z", "type": "forcePushed"}]}