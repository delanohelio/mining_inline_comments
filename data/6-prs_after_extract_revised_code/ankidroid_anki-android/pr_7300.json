{"pr_number": 7300, "pr_title": "Add Analytics event for failing Sanity Check", "pr_createdAt": "2020-09-28T14:43:24Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/7300", "timeline": [{"oid": "47e068862ca21b39854c6beb48b9dfe57d818f9e", "url": "https://github.com/ankidroid/Anki-Android/commit/47e068862ca21b39854c6beb48b9dfe57d818f9e", "message": "NF: Extract sanityCheckError\n\nTo be used in a later commit", "committedDate": "2020-09-28T12:56:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAxNDMyNA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7300#discussion_r496014324", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    UsageAnalytics.sendAnalyticsEvent(\"sanityCheckError\", \"Syncer\");\n          \n          \n            \n                    UsageAnalytics.sendAnalyticsEvent(UsageAnalytics.Categories.SYNCER, \"sanityCheckError\");\n          \n      \n    \n    \n  \n\n\n  \n    \n      Anki-Android/AnkiDroid/src/main/java/com/ichi2/anki/analytics/UsageAnalytics.java\n    \n    \n        Lines 230 to 240\n      in\n      d6de360\n    \n    \n    \n    \n\n        \n          \n               /** \n        \n\n        \n          \n                * Send a detailed arbitrary analytics event, with noun/verb pairs and extra data if needed \n        \n\n        \n          \n                * \n        \n\n        \n          \n                * @param category the category of event, make your own but use a constant so reporting is good \n        \n\n        \n          \n                * @param action   the action the user performed \n        \n\n        \n          \n                * @param value    A value for the event, Integer.MIN_VALUE signifies caller shouldn't send the value \n        \n\n        \n          \n                * @param label    A label for the event, may be null \n        \n\n        \n          \n                */ \n        \n\n        \n          \n               @SuppressWarnings(\"WeakerAccess\") \n        \n\n        \n          \n               public static void sendAnalyticsEvent(@NonNull String category, @NonNull String action, int value, String label) { \n        \n\n        \n          \n                   Timber.d(\"sendAnalyticsEvent() category/action/value/label: %s/%s/%s/%s\", category, action, value, label); \n        \n    \n  \n\n\nI'm referencing a \"dangling\" constant as nothing like that exists yet but I think the arguments are reversed (Syncer would/should be the category?) and constants will help make sure reports line up later by enforcing that the same strings are sent always", "author": "mikehardy", "createdAt": "2020-09-28T15:03:59Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sync/Syncer.java", "diffHunk": "@@ -265,12 +266,18 @@ private void trySetHostNum(JSONObject rMeta) {\n         }\n     }\n \n+    @NonNull\n+    protected Object[] sanityCheckError(JSONObject c, JSONObject sanity) {\n+        mCol.log(\"sanity check failed\", c, sanity);\n+        UsageAnalytics.sendAnalyticsEvent(\"sanityCheckError\", \"Syncer\");", "originalCommit": "b094e7f15dfa30bdd87c7aba8ea09f6c466e536f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c435797620876be727b013f235de60644a21abca", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/libanki/sync/Syncer.java b/AnkiDroid/src/main/java/com/ichi2/libanki/sync/Syncer.java\nindex 71af1aa89..d741fbdcb 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/libanki/sync/Syncer.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/libanki/sync/Syncer.java\n\n@@ -269,7 +269,7 @@ public class Syncer {\n     @NonNull\n     protected Object[] sanityCheckError(JSONObject c, JSONObject sanity) {\n         mCol.log(\"sanity check failed\", c, sanity);\n-        UsageAnalytics.sendAnalyticsEvent(\"sanityCheckError\", \"Syncer\");\n+        UsageAnalytics.sendAnalyticsEvent( UsageAnalytics.Category.SYNCER, \"sanityCheckError\");\n         _forceFullSync();\n         return new Object[] { \"sanityCheckError\", null };\n     }\n"}}, {"oid": "c435797620876be727b013f235de60644a21abca", "url": "https://github.com/ankidroid/Anki-Android/commit/c435797620876be727b013f235de60644a21abca", "message": "DEV: Visual Feedback when dev analytics enabled\n\nI spent a bit of time figuring out:\n* Whether the button did anything\n* Why analytics weren't being sent\n\nThis will stop future me from making the same mistakes", "committedDate": "2020-09-28T16:47:40Z", "type": "forcePushed"}, {"oid": "0556bfb32554b8b0c47fed548a2ce166aa053272", "url": "https://github.com/ankidroid/Anki-Android/commit/0556bfb32554b8b0c47fed548a2ce166aa053272", "message": "DEV: Visual Feedback when dev analytics enabled\n\nI spent a bit of time figuring out:\n* Whether the button did anything\n* Why analytics weren't being sent\n\nThis will stop future me from making the same mistakes", "committedDate": "2020-09-28T16:53:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjExNTQzMw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7300#discussion_r496115433", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    UsageAnalytics.sendAnalyticsEvent( UsageAnalytics.Category.SYNC, \"sanityCheckError\");\n          \n          \n            \n                    UsageAnalytics.sendAnalyticsEvent(UsageAnalytics.Category.SYNC, \"sanityCheckError\");", "author": "mikehardy", "createdAt": "2020-09-28T17:25:13Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sync/Syncer.java", "diffHunk": "@@ -268,6 +269,7 @@ private void trySetHostNum(JSONObject rMeta) {\n     @NonNull\n     protected Object[] sanityCheckError(JSONObject c, JSONObject sanity) {\n         mCol.log(\"sanity check failed\", c, sanity);\n+        UsageAnalytics.sendAnalyticsEvent( UsageAnalytics.Category.SYNC, \"sanityCheckError\");", "originalCommit": "30d2588cd54de9074e5744a77b0765491e1ec6c3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "97afa02c9571deebc77f61d08dc6ebfa81649f2d", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/libanki/sync/Syncer.java b/AnkiDroid/src/main/java/com/ichi2/libanki/sync/Syncer.java\nindex 7f5d4beec..b30897775 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/libanki/sync/Syncer.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/libanki/sync/Syncer.java\n\n@@ -269,7 +269,7 @@ public class Syncer {\n     @NonNull\n     protected Object[] sanityCheckError(JSONObject c, JSONObject sanity) {\n         mCol.log(\"sanity check failed\", c, sanity);\n-        UsageAnalytics.sendAnalyticsEvent( UsageAnalytics.Category.SYNC, \"sanityCheckError\");\n+        UsageAnalytics.sendAnalyticsEvent(UsageAnalytics.Category.SYNC, \"sanityCheckError\");\n         _forceFullSync();\n         return new Object[] { \"sanityCheckError\", null };\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjExNTY1Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/7300#discussion_r496115656", "bodyText": "Suggested change", "author": "mikehardy", "createdAt": "2020-09-28T17:25:37Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/analytics/UsageAnalytics.java", "diffHunk": "@@ -349,4 +349,10 @@ private DefaultRequest setAndroidRequestParameters(Context context) {\n             return this;\n         }\n     }\n+\n+\n+", "originalCommit": "30d2588cd54de9074e5744a77b0765491e1ec6c3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjExNTgxOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7300#discussion_r496115818", "bodyText": "...as long as I'm being picky \ud83e\udd23", "author": "mikehardy", "createdAt": "2020-09-28T17:25:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjExNTY1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "78780999dbf62a3c986752a76502979ef7646c25", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/anki/analytics/UsageAnalytics.java b/AnkiDroid/src/main/java/com/ichi2/anki/analytics/UsageAnalytics.java\nindex 04d20c964..12c6a0938 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/anki/analytics/UsageAnalytics.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/anki/analytics/UsageAnalytics.java\n\n@@ -350,6 +350,11 @@ public class UsageAnalytics {\n         }\n     }\n \n+    public static boolean isEnabled() {\n+        SharedPreferences userPrefs = AnkiDroidApp.getSharedPrefs(AnkiDroidApp.getInstance());\n+        return userPrefs.getBoolean(ANALYTICS_OPTIN_KEY, false);\n+    }\n+\n \n \n     public static class Category {\n"}}, {"oid": "97afa02c9571deebc77f61d08dc6ebfa81649f2d", "url": "https://github.com/ankidroid/Anki-Android/commit/97afa02c9571deebc77f61d08dc6ebfa81649f2d", "message": "Add Sanity Check Failed Analytic Event\n\nThis should theoretically be 0, but it's useful to track regressions\n\nRelated: 6207", "committedDate": "2020-09-29T10:45:50Z", "type": "commit"}, {"oid": "78780999dbf62a3c986752a76502979ef7646c25", "url": "https://github.com/ankidroid/Anki-Android/commit/78780999dbf62a3c986752a76502979ef7646c25", "message": "DEV: Visual Feedback when dev analytics enabled\n\nI spent a bit of time figuring out:\n* Whether the button did anything\n* Why analytics weren't being sent\n\nThis will stop future me from making the same mistakes", "committedDate": "2020-09-29T10:46:04Z", "type": "commit"}, {"oid": "78780999dbf62a3c986752a76502979ef7646c25", "url": "https://github.com/ankidroid/Anki-Android/commit/78780999dbf62a3c986752a76502979ef7646c25", "message": "DEV: Visual Feedback when dev analytics enabled\n\nI spent a bit of time figuring out:\n* Whether the button did anything\n* Why analytics weren't being sent\n\nThis will stop future me from making the same mistakes", "committedDate": "2020-09-29T10:46:04Z", "type": "forcePushed"}]}