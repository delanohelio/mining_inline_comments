{"pr_number": 6140, "pr_title": "Allow import of files with long Unicode Names", "pr_createdAt": "2020-05-09T22:22:32Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6140", "timeline": [{"oid": "493f7a1dcd7fcb537fea23ad74a77ea03717b8f5", "url": "https://github.com/ankidroid/Anki-Android/commit/493f7a1dcd7fcb537fea23ad74a77ea03717b8f5", "message": "NF: Make ImportUtils testable", "committedDate": "2020-05-09T19:25:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU3NDgwNw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6140#discussion_r422574807", "bodyText": "nit: Timber.d(\"\") ?", "author": "mikehardy", "createdAt": "2020-05-10T02:42:50Z", "path": "AnkiDroid/src/main/java/com/ichi2/utils/ImportUtils.java", "diffHunk": "@@ -150,6 +158,36 @@ private String handleContentProviderFile(Context context, Intent intent, Uri dat\n             return errorMessage;\n         }\n \n+\n+        private String ensureValidLength(String fileName) {\n+            //#6137 - filenames can be too long when URLEncoded\n+            try {\n+                String encoded = URLEncoder.encode(fileName, \"UTF-8\");\n+\n+                if (encoded.length() <= fileNameShorteningThreshold) {\n+                    Timber.d(\"\");", "originalCommit": "eb94bcd8fd576375dc28c675af2aa3ab8993ccf1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU3NTQ3NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6140#discussion_r422575474", "bodyText": "\ud83e\udd26, I guess it's still a unique string", "author": "david-allison-1", "createdAt": "2020-05-10T02:51:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU3NDgwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU3NTcxMg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6140#discussion_r422575712", "bodyText": "Nah I think the JVM will optimize it to the same static memory chunk every time since it is unchanged. Haha...ahem.", "author": "mikehardy", "createdAt": "2020-05-10T02:54:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU3NDgwNw=="}], "type": "inlineReview", "revised_code": {"commit": "79e1613516f4918b1324cef7fd5bb5309044a414", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/utils/ImportUtils.java b/AnkiDroid/src/main/java/com/ichi2/utils/ImportUtils.java\nindex b5b3d48ef..8279f1b81 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/utils/ImportUtils.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/utils/ImportUtils.java\n\n@@ -165,12 +165,13 @@ public class ImportUtils {\n                 String encoded = URLEncoder.encode(fileName, \"UTF-8\");\n \n                 if (encoded.length() <= fileNameShorteningThreshold) {\n-                    Timber.d(\"\");\n+                    Timber.d(\"No filename truncation necessary\");\n                     return fileName;\n                 } else {\n                     Timber.d(\"Filename was longer than %d, shortening\", fileNameShorteningThreshold);\n                     //take 90 instead of 100 so we don't get the extension\n-                    String shortenedFileName = encoded.substring(0, 90) + \"...\" + getExtension(fileName);\n+                    int substringLength = fileNameShorteningThreshold - 10;\n+                    String shortenedFileName = encoded.substring(0, substringLength) + \"...\" + getExtension(fileName);\n                     Timber.d(\"Shortened filename '%s' to '%s'\", fileName, shortenedFileName);\n                     //if we don't decode, % is double-encoded\n                     return URLDecoder.decode(shortenedFileName, \"UTF-8\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU3NDg2Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6140#discussion_r422574863", "bodyText": "I think 90 should be fileNameShorteningThreshold - 10 otherwise the numbers are very magic, the 10 for extension adjustment is still a little magic but at least it would be an adjustment off the constant", "author": "mikehardy", "createdAt": "2020-05-10T02:43:43Z", "path": "AnkiDroid/src/main/java/com/ichi2/utils/ImportUtils.java", "diffHunk": "@@ -150,6 +158,36 @@ private String handleContentProviderFile(Context context, Intent intent, Uri dat\n             return errorMessage;\n         }\n \n+\n+        private String ensureValidLength(String fileName) {\n+            //#6137 - filenames can be too long when URLEncoded\n+            try {\n+                String encoded = URLEncoder.encode(fileName, \"UTF-8\");\n+\n+                if (encoded.length() <= fileNameShorteningThreshold) {\n+                    Timber.d(\"\");\n+                    return fileName;\n+                } else {\n+                    Timber.d(\"Filename was longer than %d, shortening\", fileNameShorteningThreshold);\n+                    //take 90 instead of 100 so we don't get the extension\n+                    String shortenedFileName = encoded.substring(0, 90) + \"...\" + getExtension(fileName);", "originalCommit": "eb94bcd8fd576375dc28c675af2aa3ab8993ccf1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU3NTQ0MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6140#discussion_r422575441", "bodyText": "Agreed", "author": "david-allison-1", "createdAt": "2020-05-10T02:51:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU3NDg2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "79e1613516f4918b1324cef7fd5bb5309044a414", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/utils/ImportUtils.java b/AnkiDroid/src/main/java/com/ichi2/utils/ImportUtils.java\nindex b5b3d48ef..8279f1b81 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/utils/ImportUtils.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/utils/ImportUtils.java\n\n@@ -165,12 +165,13 @@ public class ImportUtils {\n                 String encoded = URLEncoder.encode(fileName, \"UTF-8\");\n \n                 if (encoded.length() <= fileNameShorteningThreshold) {\n-                    Timber.d(\"\");\n+                    Timber.d(\"No filename truncation necessary\");\n                     return fileName;\n                 } else {\n                     Timber.d(\"Filename was longer than %d, shortening\", fileNameShorteningThreshold);\n                     //take 90 instead of 100 so we don't get the extension\n-                    String shortenedFileName = encoded.substring(0, 90) + \"...\" + getExtension(fileName);\n+                    int substringLength = fileNameShorteningThreshold - 10;\n+                    String shortenedFileName = encoded.substring(0, substringLength) + \"...\" + getExtension(fileName);\n                     Timber.d(\"Shortened filename '%s' to '%s'\", fileName, shortenedFileName);\n                     //if we don't decode, % is double-encoded\n                     return URLDecoder.decode(shortenedFileName, \"UTF-8\");\n"}}, {"oid": "79e1613516f4918b1324cef7fd5bb5309044a414", "url": "https://github.com/ankidroid/Anki-Android/commit/79e1613516f4918b1324cef7fd5bb5309044a414", "message": "File import: Shorten Filenames to 100 characters\n\nWe URLEncode filenames, and CJK characters are 9x the size when this\nhappens.\n\nNow, we truncate any filenames which would be too long after this.\n\nThis ensures that we avoid \"FileSystemException: File name too long\"", "committedDate": "2020-05-10T02:53:51Z", "type": "forcePushed"}, {"oid": "35857a917f5ea84726d3a8789b9416ed34a12ddd", "url": "https://github.com/ankidroid/Anki-Android/commit/35857a917f5ea84726d3a8789b9416ed34a12ddd", "message": "File import: Shorten Filenames to 100 characters\n\nWe URLEncode filenames, and CJK characters are 9x the size when this\nhappens.\n\nNow, we truncate any filenames which would be too long after this.\n\nThis ensures that we avoid \"FileSystemException: File name too long\"", "committedDate": "2020-05-10T11:01:01Z", "type": "forcePushed"}, {"oid": "b56d7a0e122097149d53087a3028f02e26f276b1", "url": "https://github.com/ankidroid/Anki-Android/commit/b56d7a0e122097149d53087a3028f02e26f276b1", "message": "File import: Shorten Filenames to 100 characters\n\nWe URLEncode filenames, and CJK characters are 9x the size when this\nhappens.\n\nNow, we truncate any filenames which would be too long after this.\n\nThis ensures that we avoid \"FileSystemException: File name too long\"", "committedDate": "2020-05-10T13:33:11Z", "type": "forcePushed"}, {"oid": "39d7d5497d7b792fa0ef3fbadd74515970f20b72", "url": "https://github.com/ankidroid/Anki-Android/commit/39d7d5497d7b792fa0ef3fbadd74515970f20b72", "message": "NF: ImportUtils - Add Regression Test\n\nAlso requires that DialogHandler is reset", "committedDate": "2020-05-10T17:05:35Z", "type": "commit"}, {"oid": "0cbbba9155d6fe5cd6dd0a4cb4c1b3791bba2899", "url": "https://github.com/ankidroid/Anki-Android/commit/0cbbba9155d6fe5cd6dd0a4cb4c1b3791bba2899", "message": "File import: Shorten Filenames to 100 characters\n\nWe URLEncode filenames, and CJK characters are 9x the size when this\nhappens.\n\nNow, we truncate any filenames which would be too long after this.\n\nThis ensures that we avoid \"FileSystemException: File name too long\"", "committedDate": "2020-05-10T17:05:38Z", "type": "commit"}, {"oid": "0cbbba9155d6fe5cd6dd0a4cb4c1b3791bba2899", "url": "https://github.com/ankidroid/Anki-Android/commit/0cbbba9155d6fe5cd6dd0a4cb4c1b3791bba2899", "message": "File import: Shorten Filenames to 100 characters\n\nWe URLEncode filenames, and CJK characters are 9x the size when this\nhappens.\n\nNow, we truncate any filenames which would be too long after this.\n\nThis ensures that we avoid \"FileSystemException: File name too long\"", "committedDate": "2020-05-10T17:05:38Z", "type": "forcePushed"}]}