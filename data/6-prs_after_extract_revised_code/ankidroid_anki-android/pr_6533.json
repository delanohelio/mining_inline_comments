{"pr_number": 6533, "pr_title": "Nested decks support in ContentProviderTest", "pr_createdAt": "2020-06-22T01:19:20Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6533", "timeline": [{"oid": "18d70b0b7f3fd030fdbd1e997b18f10c4facbf02", "url": "https://github.com/ankidroid/Anki-Android/commit/18d70b0b7f3fd030fdbd1e997b18f10c4facbf02", "message": "NF: moving comma at end of line", "committedDate": "2020-06-22T00:47:38Z", "type": "commit"}, {"oid": "b415e749c7267f83d24ad08b19ada20e9067073a", "url": "https://github.com/ankidroid/Anki-Android/commit/b415e749c7267f83d24ad08b19ada20e9067073a", "message": "ContentProviderTest adding nested deck", "committedDate": "2020-06-22T01:16:58Z", "type": "commit"}, {"oid": "1cb9f538423e7eb9dabcac781c6c05c070bd6378", "url": "https://github.com/ankidroid/Anki-Android/commit/1cb9f538423e7eb9dabcac781c6c05c070bd6378", "message": "mTestDeckIds is an array list\n\nThis is required because, with nested decks, the total number of deck\nmay be gerater than the number of deck in the array", "committedDate": "2020-06-22T01:56:53Z", "type": "commit"}, {"oid": "67c597d8c942fd488b2b226459dff62cee4154c8", "url": "https://github.com/ankidroid/Anki-Android/commit/67c597d8c942fd488b2b226459dff62cee4154c8", "message": "ContentProviderTest delete children deck too during cleaning\n\nOtherwise, finding the deck with id did seems to create back its\nparent decks", "committedDate": "2020-06-22T01:57:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI5MzgwNA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6533#discussion_r443293804", "bodyText": "Why is this necessary? Shouldn't id() call _ensureParents? Is this because decks are created, but not added to the list?", "author": "david-allison-1", "createdAt": "2020-06-22T02:49:32Z", "path": "AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java", "diffHunk": "@@ -118,9 +125,21 @@ public void setUp() throws Exception {\n         // create test decks and add one note for every deck\n         mNumDecksBeforeTest = col.getDecks().count();\n         for(int i = 0; i < TEST_DECKS.length; i++) {\n-            long did = col.getDecks().id(TEST_DECKS[i]);\n-            mTestDeckIds[i] = did;\n-            mCreatedNotes.add(setupNewNote(col, mModelId, did, mDummyFields, TEST_TAG));\n+            String fullName = TEST_DECKS[i];\n+            String[] path = col.getDecks().path(fullName);\n+            String partialName = \"\";\n+            // Dealing with each parents of fullName\n+            for (int j = 0; j < path.length; j++) {", "originalCommit": "67c597d8c942fd488b2b226459dff62cee4154c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM3MzkzOQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6533#discussion_r443373939", "bodyText": "id ensure parents, indeed. But if you want mTestDeckIds to contains all ids, then you need to put ids of parents too, even if they are not explicitly in the list of parents.\nFurthermore, during tear-down, you want to remove all added deck; and you have no method \"_ensureRemoveParent\". So you need to actually list all decks you create.\nIn this case, it may work to avoid adding parent decks, because the top level parent of \"cmxieunwoogyxsctnjmv::abcdefgh::ZYXW\" is a deck we also added manually explicitly, and I changed another part of the code to ensure that we remove subdecks of added deck.\nBut if at some point we want to add \"\"iersantenfgh\u00e9e::abcdefgh::ZYXW\" instead, without this loop, we would never remove \"iersantenfgh\u00e9e\". I wanted to ensure that we were not constrained in adding more deck examples.\nFurthermore, I don't want to just remove top level parents of each added deck. Because if I add a deck \"A::B::C\" (that was my first idea actually) but the user already have a deck \"A\" on the smartphone they use for testing, then we would delete \"A\"... this conditional  ensure that in this case \"A\" is deleted iff it was added by us. (I actually used to have a top level deck called A, so I\u00a0was going to accidentally delete my own cards here....)", "author": "Arthur-Milchior", "createdAt": "2020-06-22T07:46:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI5MzgwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQxNjg0MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6533#discussion_r443416840", "bodyText": "That makes sense. Could you add a quick comment", "author": "david-allison-1", "createdAt": "2020-06-22T09:03:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI5MzgwNA=="}], "type": "inlineReview", "revised_code": {"commit": "edbd61c51b6ae0ca8ce6c6eae4718b06e869322e", "chunk": "diff --git a/AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java b/AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java\nindex 859d95fd2..380e1b97a 100644\n--- a/AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java\n+++ b/AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java\n\n@@ -128,10 +128,15 @@ public class ContentProviderTest {\n             String fullName = TEST_DECKS[i];\n             String[] path = col.getDecks().path(fullName);\n             String partialName = \"\";\n-            // Dealing with each parents of fullName\n+            /* Looping over all parents of full name. Adding them to\n+             * mTestDeckIds ensures the deck parents decks get deleted\n+             * too at tear-down.\n+             */\n             for (int j = 0; j < path.length; j++) {\n                 partialName += path[j];\n-                // If parent already exists, don't add a deck again\n+                /* If parent already exists, don't add the deck, so\n+                 * that we are sure it won't get deleted at\n+                 * set-down, */\n                 if (col.getDecks().byName(partialName) != null) {\n                     continue;\n                 }\n"}}, {"oid": "edbd61c51b6ae0ca8ce6c6eae4718b06e869322e", "url": "https://github.com/ankidroid/Anki-Android/commit/edbd61c51b6ae0ca8ce6c6eae4718b06e869322e", "message": "ContentProviderTest: add parents decks to mTestDeckIds", "committedDate": "2020-06-22T09:25:40Z", "type": "commit"}, {"oid": "ebf7e31b4c24c44b227655f9d96003d208e374f8", "url": "https://github.com/ankidroid/Anki-Android/commit/ebf7e31b4c24c44b227655f9d96003d208e374f8", "message": "ContentProviderTest delete children deck too during cleaning\n\nOtherwise, finding the deck with id did seems to create back its\nparent decks", "committedDate": "2020-06-22T09:25:40Z", "type": "commit"}, {"oid": "ebf7e31b4c24c44b227655f9d96003d208e374f8", "url": "https://github.com/ankidroid/Anki-Android/commit/ebf7e31b4c24c44b227655f9d96003d208e374f8", "message": "ContentProviderTest delete children deck too during cleaning\n\nOtherwise, finding the deck with id did seems to create back its\nparent decks", "committedDate": "2020-06-22T09:25:40Z", "type": "forcePushed"}]}