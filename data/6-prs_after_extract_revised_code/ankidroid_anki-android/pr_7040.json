{"pr_number": 7040, "pr_title": "No counts in abstract flash card viewer", "pr_createdAt": "2020-09-07T11:28:05Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/7040", "timeline": [{"oid": "2386455115a94b227a2af80a0637540c56555f0a", "url": "https://github.com/ankidroid/Anki-Android/commit/2386455115a94b227a2af80a0637540c56555f0a", "message": "NF: restorePreferences: get preferences from super", "committedDate": "2020-09-07T10:13:53Z", "type": "commit"}, {"oid": "acb66cf8ace6c20fdc24870331e81bff6a6e9c7c", "url": "https://github.com/ankidroid/Anki-Android/commit/acb66cf8ace6c20fdc24870331e81bff6a6e9c7c", "message": "Counts moved from AbstractFlashcardViewer to Reviewer\n\nFirst, because counts in previewer makes no sens. Eta makes no sens either. And also because it leads to trouble when\npreviewing a card which is not in one of the three standard queues. See https://github.com/ankidroid/Anki-Android/issues/7039", "committedDate": "2020-09-07T13:22:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQyODYzOQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7040#discussion_r484428639", "bodyText": "As mentioned elsewhere I want default values that are obviously \"wrong\" for the type but nevertheless workable in the javascript type system in case math operations are attempted on the result. Please return -1 for all \"number\" types", "author": "mikehardy", "createdAt": "2020-09-07T13:21:33Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java", "diffHunk": "@@ -3783,22 +3718,25 @@ public String init(String jsonData) {\n \n         @JavascriptInterface\n         public String ankiGetNewCardCount() {\n-            return newCount.toString();\n+            return \"\";", "originalCommit": "d6cc4ff7eae3d5762c9012ddec030e67880ec7e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQzMjE5NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7040#discussion_r484432194", "bodyText": "Done", "author": "Arthur-Milchior", "createdAt": "2020-09-07T13:28:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQyODYzOQ=="}], "type": "inlineReview", "revised_code": {"commit": "acb66cf8ace6c20fdc24870331e81bff6a6e9c7c", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java b/AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java\nindex 9392a87ef..03cd70145 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java\n\n@@ -3718,25 +3718,25 @@ see card.js for available functions\n \n         @JavascriptInterface\n         public String ankiGetNewCardCount() {\n-            return \"\";\n+            return getResources().getString(R.string.string_for_js_undefined);\n         }\n \n \n         @JavascriptInterface\n         public String ankiGetLrnCardCount() {\n-            return \"\";\n+            return getResources().getString(R.string.string_for_js_undefined);\n         }\n \n \n         @JavascriptInterface\n         public String ankiGetRevCardCount() {\n-            return \"\";\n+            return getResources().getString(R.string.string_for_js_undefined);\n         }\n \n \n         @JavascriptInterface\n         public int ankiGetETA() {\n-            return 0;\n+            return -1;\n         }\n \n         @JavascriptInterface\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQyOTAzMA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7040#discussion_r484429030", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public class JavasScriptFunction extends AbstractFlashcardViewer.JavaScriptFunction {\n          \n          \n            \n            \n          \n          \n            \n                public class JavasScriptFunction extends AbstractFlashcardViewer.JavaScriptFunction {", "author": "mikehardy", "createdAt": "2020-09-07T13:22:25Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java", "diffHunk": "@@ -1058,4 +1162,33 @@ public boolean onMenuItemClick(MenuItem item) {\n             }\n         }\n     }\n+\n+    public JavasScriptFunction javaScriptFunction() {\n+        return new JavasScriptFunction();\n+    }\n+    public class JavasScriptFunction extends AbstractFlashcardViewer.JavaScriptFunction {", "originalCommit": "d6cc4ff7eae3d5762c9012ddec030e67880ec7e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQzMjQ0MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7040#discussion_r484432440", "bodyText": "Done", "author": "Arthur-Milchior", "createdAt": "2020-09-07T13:29:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQyOTAzMA=="}], "type": "inlineReview", "revised_code": {"commit": "a5831b27c89e0548c283fbdcb5d1fd4e4a1a14a8", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java b/AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java\nindex 8dd2e1a71..5873d212a 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java\n\n@@ -1166,6 +1166,7 @@ public class Reviewer extends AbstractFlashcardViewer {\n     public JavasScriptFunction javaScriptFunction() {\n         return new JavasScriptFunction();\n     }\n+\n     public class JavasScriptFunction extends AbstractFlashcardViewer.JavaScriptFunction {\n         @JavascriptInterface\n         @Override\n"}}, {"oid": "60378dcd16ec632311c10291cdf3a34480693669", "url": "https://github.com/ankidroid/Anki-Android/commit/60378dcd16ec632311c10291cdf3a34480693669", "message": "Counts moved from AbstractFlashcardViewer to Reviewer\n\nFirst, because counts in previewer makes no sens. Eta makes no sens either. And also because it leads to trouble when\npreviewing a card which is not in one of the three standard queues. See https://github.com/ankidroid/Anki-Android/issues/7039", "committedDate": "2020-09-07T13:28:23Z", "type": "forcePushed"}, {"oid": "a5831b27c89e0548c283fbdcb5d1fd4e4a1a14a8", "url": "https://github.com/ankidroid/Anki-Android/commit/a5831b27c89e0548c283fbdcb5d1fd4e4a1a14a8", "message": "Counts moved from AbstractFlashcardViewer to Reviewer\n\nFirst, because counts in previewer makes no sens. Eta makes no sens either. And also because it leads to trouble when\npreviewing a card which is not in one of the three standard queues. See https://github.com/ankidroid/Anki-Android/issues/7039", "committedDate": "2020-09-07T13:28:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQzNjI1OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7040#discussion_r484436258", "bodyText": "Could you leave a comment explaining why, and that this is overridden in a subclass", "author": "david-allison-1", "createdAt": "2020-09-07T13:36:25Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java", "diffHunk": "@@ -3783,22 +3718,25 @@ public String init(String jsonData) {\n \n         @JavascriptInterface\n         public String ankiGetNewCardCount() {\n-            return newCount.toString();\n+            return \"-1\";", "originalCommit": "a5831b27c89e0548c283fbdcb5d1fd4e4a1a14a8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQ0MTQyMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7040#discussion_r484441421", "bodyText": "I updated the Wiki with the policy I'm attempting to put in place: https://github.com/ankidroid/Anki-Android/wiki/AnkiDroid-Javascript-API/_compare/e21015172d53c6a2ade17729b7415141f2975584...1d35c0c37a070f3666c031af56b1717591990e39", "author": "mikehardy", "createdAt": "2020-09-07T13:46:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQzNjI1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQ1Mzk4OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7040#discussion_r484453988", "bodyText": "Done", "author": "Arthur-Milchior", "createdAt": "2020-09-07T14:07:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQzNjI1OA=="}], "type": "inlineReview", "revised_code": {"commit": "13e16207700d853de6ea7ebfaaefb9f70548fee0", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java b/AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java\nindex f44784e2a..086fd6a40 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java\n\n@@ -3716,6 +3716,10 @@ see card.js for available functions\n             return String.valueOf(apiStatusJson);\n         }\n \n+        // This method and the one belows return \"default\" values when there is no count nor ETA.\n+        // Javascript may expect ETA and Counts to be set, this ensure it does not bug too much by providing a value of correct type\n+        // but with a clearly incorrect value.\n+        // It's overridden in the Reviewer, where those values are actually defined.\n         @JavascriptInterface\n         public String ankiGetNewCardCount() {\n             return \"-1\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQzNjU0Nw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7040#discussion_r484436547", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return new JavasScriptFunction();\n          \n          \n            \n                    return new ReviewerJavaScriptFunction();", "author": "david-allison-1", "createdAt": "2020-09-07T13:37:00Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java", "diffHunk": "@@ -1060,4 +1162,34 @@ public boolean onMenuItemClick(MenuItem item) {\n             }\n         }\n     }\n+\n+    public JavasScriptFunction javaScriptFunction() {\n+        return new JavasScriptFunction();", "originalCommit": "a5831b27c89e0548c283fbdcb5d1fd4e4a1a14a8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQ1Mzg2Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/7040#discussion_r484453866", "bodyText": "Done", "author": "Arthur-Milchior", "createdAt": "2020-09-07T14:06:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQzNjU0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "13e16207700d853de6ea7ebfaaefb9f70548fee0", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java b/AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java\nindex 5873d212a..57cf4367b 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java\n\n@@ -1163,11 +1163,11 @@ public class Reviewer extends AbstractFlashcardViewer {\n         }\n     }\n \n-    public JavasScriptFunction javaScriptFunction() {\n-        return new JavasScriptFunction();\n+    public ReviewerJavasScriptFunction javaScriptFunction() {\n+        return new ReviewerJavasScriptFunction();\n     }\n \n-    public class JavasScriptFunction extends AbstractFlashcardViewer.JavaScriptFunction {\n+    public class ReviewerJavasScriptFunction extends JavaScriptFunction {\n         @JavascriptInterface\n         @Override\n         public String ankiGetNewCardCount() {\n"}}, {"oid": "13e16207700d853de6ea7ebfaaefb9f70548fee0", "url": "https://github.com/ankidroid/Anki-Android/commit/13e16207700d853de6ea7ebfaaefb9f70548fee0", "message": "Counts moved from AbstractFlashcardViewer to Reviewer\n\nFirst, because counts in previewer makes no sens. Eta makes no sens either. And also because it leads to trouble when\npreviewing a card which is not in one of the three standard queues. See https://github.com/ankidroid/Anki-Android/issues/7039", "committedDate": "2020-09-07T14:06:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQ1OTYzOQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7040#discussion_r484459639", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public class ReviewerJavasScriptFunction extends JavaScriptFunction {\n          \n          \n            \n                public class ReviewerJavaScriptFunction extends JavaScriptFunction {", "author": "david-allison-1", "createdAt": "2020-09-07T14:18:07Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java", "diffHunk": "@@ -1060,4 +1162,34 @@ public boolean onMenuItemClick(MenuItem item) {\n             }\n         }\n     }\n+\n+    public ReviewerJavasScriptFunction javaScriptFunction() {\n+        return new ReviewerJavasScriptFunction();\n+    }\n+\n+    public class ReviewerJavasScriptFunction extends JavaScriptFunction {", "originalCommit": "13e16207700d853de6ea7ebfaaefb9f70548fee0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQ2OTExNg==", "url": "https://github.com/ankidroid/Anki-Android/pull/7040#discussion_r484469116", "bodyText": "Oops", "author": "Arthur-Milchior", "createdAt": "2020-09-07T14:36:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQ1OTYzOQ=="}], "type": "inlineReview", "revised_code": {"commit": "47149af4cfb4690bed20084ad24f653c8369b88e", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java b/AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java\nindex 57cf4367b..c58b54c62 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java\n\n@@ -1163,11 +1163,11 @@ public class Reviewer extends AbstractFlashcardViewer {\n         }\n     }\n \n-    public ReviewerJavasScriptFunction javaScriptFunction() {\n-        return new ReviewerJavasScriptFunction();\n+    public ReviewerJavaScriptFunction javaScriptFunction() {\n+        return new ReviewerJavaScriptFunction();\n     }\n \n-    public class ReviewerJavasScriptFunction extends JavaScriptFunction {\n+    public class ReviewerJavaScriptFunction extends JavaScriptFunction {\n         @JavascriptInterface\n         @Override\n         public String ankiGetNewCardCount() {\n"}}, {"oid": "47149af4cfb4690bed20084ad24f653c8369b88e", "url": "https://github.com/ankidroid/Anki-Android/commit/47149af4cfb4690bed20084ad24f653c8369b88e", "message": "Counts moved from AbstractFlashcardViewer to Reviewer\n\nFirst, because counts in previewer makes no sens. Eta makes no sens either. And also because it leads to trouble when\npreviewing a card which is not in one of the three standard queues. See https://github.com/ankidroid/Anki-Android/issues/7039", "committedDate": "2020-09-07T14:36:42Z", "type": "commit"}, {"oid": "47149af4cfb4690bed20084ad24f653c8369b88e", "url": "https://github.com/ankidroid/Anki-Android/commit/47149af4cfb4690bed20084ad24f653c8369b88e", "message": "Counts moved from AbstractFlashcardViewer to Reviewer\n\nFirst, because counts in previewer makes no sens. Eta makes no sens either. And also because it leads to trouble when\npreviewing a card which is not in one of the three standard queues. See https://github.com/ankidroid/Anki-Android/issues/7039", "committedDate": "2020-09-07T14:36:42Z", "type": "forcePushed"}]}