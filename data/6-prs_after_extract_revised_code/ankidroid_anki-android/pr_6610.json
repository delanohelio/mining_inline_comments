{"pr_number": 6610, "pr_title": "Optimize model count (performance)", "pr_createdAt": "2020-07-04T15:49:14Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6610", "timeline": [{"oid": "48fdfe435b015fb0dd8bfb5721149e82b0ebf78d", "url": "https://github.com/ankidroid/Anki-Android/commit/48fdfe435b015fb0dd8bfb5721149e82b0ebf78d", "message": "NF: kill Task_Type_Count_Models when ModelBrowser close", "committedDate": "2020-07-04T17:10:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgwMDE2OQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6610#discussion_r449800169", "bodyText": "When would this be called on restore?", "author": "david-allison-1", "createdAt": "2020-07-04T19:43:51Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/ModelBrowser.java", "diffHunk": "@@ -207,6 +207,7 @@ public boolean onOptionsItemSelected(MenuItem item) {\n \n     @Override\n     public void onStop() {\n+        CollectionTask.cancelTask(COUNT_MODELS);", "originalCommit": "48fdfe435b015fb0dd8bfb5721149e82b0ebf78d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgwMDcwMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6610#discussion_r449800701", "bodyText": "Right. Should have been onDestroy", "author": "Arthur-Milchior", "createdAt": "2020-07-04T19:51:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgwMDE2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "fabb154f2563c54c6743d039429c8d5d7c00cc0b", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/anki/ModelBrowser.java b/AnkiDroid/src/main/java/com/ichi2/anki/ModelBrowser.java\nindex 2ccdb0950..ca354868f 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/anki/ModelBrowser.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/anki/ModelBrowser.java\n\n@@ -207,7 +207,6 @@ public class ModelBrowser extends AnkiActivity {\n \n     @Override\n     public void onStop() {\n-        CollectionTask.cancelTask(COUNT_MODELS);\n         super.onStop();\n         if (!isFinishing()) {\n             WidgetStatus.update(this);\n"}}, {"oid": "fabb154f2563c54c6743d039429c8d5d7c00cc0b", "url": "https://github.com/ankidroid/Anki-Android/commit/fabb154f2563c54c6743d039429c8d5d7c00cc0b", "message": "NF: kill Task_Type_Count_Models when ModelBrowser close", "committedDate": "2020-07-04T19:52:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgxMzk4Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/6610#discussion_r449813986", "bodyText": "Have you tested this?\n\n  \n    \n      Anki-Android/AnkiDroid/src/main/java/com/ichi2/anki/ModelBrowser.java\n    \n    \n        Lines 108 to 113\n      in\n      e4543a4\n    \n    \n    \n    \n\n        \n          \n           @Override \n        \n\n        \n          \n           public void onPostExecute(TaskData result) { \n        \n\n        \n          \n            \n        \n\n        \n          \n               if (!result.getBoolean()) { \n        \n\n        \n          \n                   throw new RuntimeException(); \n        \n\n        \n          \n               }", "author": "david-allison-1", "createdAt": "2020-07-04T23:35:42Z", "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -1505,8 +1505,11 @@ public int compare(JSONObject a, JSONObject b) {\n \n         try{\n             for (JSONObject n : models) {\n-                long modID = n.getLong(\"id\");\n-                cardCount.add(col.getModels().nids(col.getModels().get(modID)).size());\n+                if (isCancelled()) {\n+                    Timber.e(\"doInBackgroundLoadModels :: Cancelled\");\n+                    return new TaskData(false);", "originalCommit": "fabb154f2563c54c6743d039429c8d5d7c00cc0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgxNTQ4Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/6610#discussion_r449815486", "bodyText": "Quite hard to say, because even if I can still open and close the list of note type, I can't be sure that the request was actually cancelled.\nI've not check cat to ensure that cancellation was done.\nAccording to https://developer.android.com/reference/android/os/AsyncTask#cancel(boolean)\nonPostExecute is not run when the task is cancelled. I guess that I could as well have returned null", "author": "Arthur-Milchior", "createdAt": "2020-07-05T00:03:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgxMzk4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg2MDExMg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6610#discussion_r449860112", "bodyText": "Okay - let's add a comment that the choice is explicit, then we're good to go", "author": "david-allison-1", "createdAt": "2020-07-05T10:18:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgxMzk4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "9010e5b5c2eb70c7d938108076e14d3ab569f860", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java b/AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java\nindex 0b4e25c02..42a192588 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java\n\n@@ -1507,7 +1548,8 @@ public class CollectionTask extends BaseAsyncTask<CollectionTask.TaskData, Colle\n             for (JSONObject n : models) {\n                 if (isCancelled()) {\n                     Timber.e(\"doInBackgroundLoadModels :: Cancelled\");\n-                    return new TaskData(false);\n+                    // onPostExecute not executed if cancelled. Return value not used.\n+                    return null;\n                 }\n                 cardCount.add(col.getModels().useCount(n));\n             }\n"}}, {"oid": "6a3f4c4e9d6a56a6bdc560729131865c567bc04e", "url": "https://github.com/ankidroid/Anki-Android/commit/6a3f4c4e9d6a56a6bdc560729131865c567bc04e", "message": "NF: kill Task_Type_Count_Models when ModelBrowser close", "committedDate": "2020-07-05T15:21:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg5MjA2OQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6610#discussion_r449892069", "bodyText": "@Arthur-Milchior I think this just needs a comment here and it can merge\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                return new TaskData(false);\n          \n          \n            \n                                // onPostExecute should not be called if canceled, return should not matter. Using false.\n          \n          \n            \n                                return new TaskData(false);", "author": "mikehardy", "createdAt": "2020-07-05T15:55:04Z", "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -1546,8 +1546,11 @@ public int compare(JSONObject a, JSONObject b) {\n \n         try{\n             for (JSONObject n : models) {\n-                long modID = n.getLong(\"id\");\n-                cardCount.add(col.getModels().nids(col.getModels().get(modID)).size());\n+                if (isCancelled()) {\n+                    Timber.e(\"doInBackgroundLoadModels :: Cancelled\");\n+                    return new TaskData(false);", "originalCommit": "6a3f4c4e9d6a56a6bdc560729131865c567bc04e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg5MjMxMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6610#discussion_r449892311", "bodyText": "Comment added. Returning null since we do not actually care about the value", "author": "Arthur-Milchior", "createdAt": "2020-07-05T15:57:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg5MjA2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "9010e5b5c2eb70c7d938108076e14d3ab569f860", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java b/AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java\nindex 3f8d27111..42a192588 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java\n\n@@ -1548,7 +1548,8 @@ public class CollectionTask extends BaseAsyncTask<CollectionTask.TaskData, Colle\n             for (JSONObject n : models) {\n                 if (isCancelled()) {\n                     Timber.e(\"doInBackgroundLoadModels :: Cancelled\");\n-                    return new TaskData(false);\n+                    // onPostExecute not executed if cancelled. Return value not used.\n+                    return null;\n                 }\n                 cardCount.add(col.getModels().useCount(n));\n             }\n"}}, {"oid": "9010e5b5c2eb70c7d938108076e14d3ab569f860", "url": "https://github.com/ankidroid/Anki-Android/commit/9010e5b5c2eb70c7d938108076e14d3ab569f860", "message": "NF: kill Task_Type_Count_Models when ModelBrowser close", "committedDate": "2020-07-05T15:57:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg5NTY2Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/6610#discussion_r449895666", "bodyText": "onPostExecute also crashes on null, could we handle this case if we're going to imply it's fine.", "author": "david-allison-1", "createdAt": "2020-07-05T16:35:19Z", "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -1546,8 +1546,12 @@ public int compare(JSONObject a, JSONObject b) {\n \n         try{\n             for (JSONObject n : models) {\n-                long modID = n.getLong(\"id\");\n-                cardCount.add(col.getModels().nids(col.getModels().get(modID)).size());\n+                if (isCancelled()) {\n+                    Timber.e(\"doInBackgroundLoadModels :: Cancelled\");\n+                    // onPostExecute not executed if cancelled. Return value not used.\n+                    return null;", "originalCommit": "9010e5b5c2eb70c7d938108076e14d3ab569f860", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg5NTk3Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/6610#discussion_r449895976", "bodyText": "I do not understand your request. Do you want onPostExecute to check for non-null value ?\nI guess we could, and behave the same way as when it gets a False value, i.e. throw an exception.\nI fail to see the point, since this method return null only if task is cancelled, and in this case onPostExecute is not executed. So there should be no way for onPostExecute to obtain the null", "author": "Arthur-Milchior", "createdAt": "2020-07-05T16:38:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg5NTY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg5NzA2MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6610#discussion_r449897060", "bodyText": "perhaps even stronger is a change to BaseAsyncTask::onPostExecute that strongly verifies BaseAsyncTask::isCancelled == false, and otherwise does a Timber.w / sendExceptionReport and returns\nBasically we have a fear that there will be unpredictable onPostExecute behavior and the risk is the system does not follow it's guidance that onPostExecute won't happen if cancelled, so let's manage the risk directly instead of in client code?\nI verified BaseAyncTask::onPostExecute is called first in the delegate objects.", "author": "mikehardy", "createdAt": "2020-07-05T16:50:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg5NTY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg5NzQwMA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6610#discussion_r449897400", "bodyText": "I guess to be fully safe until that proposed change to BaseAsyncTask::onPostExecute proves to our satisfaction we are safe, then the client code would also need to null check and say via Timber effectively \"this is never supposed to happen, we were called after a cancel\"", "author": "mikehardy", "createdAt": "2020-07-05T16:54:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg5NTY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg5ODE2Nw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6610#discussion_r449898167", "bodyText": "This is just from a maintenance point of view - people are likely to copy/paste and return null in the future on an edge case, as it looks safe, and we should protect against this.", "author": "david-allison-1", "createdAt": "2020-07-05T17:02:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg5NTY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg5ODM5Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6610#discussion_r449898393", "bodyText": "#6629", "author": "Arthur-Milchior", "createdAt": "2020-07-05T17:05:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg5NTY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg5ODg4NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6610#discussion_r449898885", "bodyText": "To restate. I'm happy that onPostExecute won't run.\nI'm concerned that we've introduced the logic: \"It's OK to return null, as long as we're in an isCanceled() block\", as that breaks the principle of least astonishment", "author": "david-allison-1", "createdAt": "2020-07-05T17:12:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg5NTY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg5OTA0OQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6610#discussion_r449899049", "bodyText": "Then stated most explicitly: to approve you require either null handling, or the return false again? And to be least-surprising returning false might be most consistent?", "author": "mikehardy", "createdAt": "2020-07-05T17:14:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg5NTY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg5OTUwMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6610#discussion_r449899501", "bodyText": "I added back \"False\" then. I have no strong opinion here. My weak opinion is that the least astonishing thing would be to return \"null\" in both cases, since there is nothing \"false\" here.\nActually, I believe there is little reason to catch the potential exception only to throw a new one (with less details) in onPostExecute, so I believe the try/catch should be removed", "author": "Arthur-Milchior", "createdAt": "2020-07-05T17:19:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg5NTY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg5OTg4Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6610#discussion_r449899882", "bodyText": "Returning null and handling it seems like the best option, but yes, would be happy with both options", "author": "david-allison-1", "createdAt": "2020-07-05T17:23:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg5NTY2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "a380613fb92a4857cfd793b843a59140d1419a34", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java b/AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java\nindex 42a192588..32e3e88a8 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java\n\n@@ -1549,7 +1549,7 @@ public class CollectionTask extends BaseAsyncTask<CollectionTask.TaskData, Colle\n                 if (isCancelled()) {\n                     Timber.e(\"doInBackgroundLoadModels :: Cancelled\");\n                     // onPostExecute not executed if cancelled. Return value not used.\n-                    return null;\n+                    return new TaskData(false);\n                 }\n                 cardCount.add(col.getModels().useCount(n));\n             }\n"}}, {"oid": "a380613fb92a4857cfd793b843a59140d1419a34", "url": "https://github.com/ankidroid/Anki-Android/commit/a380613fb92a4857cfd793b843a59140d1419a34", "message": "NF: kill Task_Type_Count_Models when ModelBrowser close", "committedDate": "2020-07-05T17:14:32Z", "type": "forcePushed"}, {"oid": "af086f186b7549ae45ba72c743b838701ccacbd1", "url": "https://github.com/ankidroid/Anki-Android/commit/af086f186b7549ae45ba72c743b838701ccacbd1", "message": "NF: kill Task_Type_Count_Models when ModelBrowser close", "committedDate": "2020-07-05T19:48:09Z", "type": "forcePushed"}, {"oid": "ef3fa794effc954886762f6029342cb4be7e5466", "url": "https://github.com/ankidroid/Anki-Android/commit/ef3fa794effc954886762f6029342cb4be7e5466", "message": "NF: avoid going from id to count model to id", "committedDate": "2020-07-05T23:44:49Z", "type": "commit"}, {"oid": "e912163508b19aa0d542fc38bba95536e3d3c875", "url": "https://github.com/ankidroid/Anki-Android/commit/e912163508b19aa0d542fc38bba95536e3d3c875", "message": "NF: uses sql's count instead of list size", "committedDate": "2020-07-05T23:44:49Z", "type": "commit"}, {"oid": "7ce359195c7ae2e200487cc1a95b918fe1922823", "url": "https://github.com/ankidroid/Anki-Android/commit/7ce359195c7ae2e200487cc1a95b918fe1922823", "message": "NF: doInBackgroundLoadModels cancellable", "committedDate": "2020-07-05T23:44:49Z", "type": "commit"}, {"oid": "729e173142aadbb20d2c05637e316b961182cb80", "url": "https://github.com/ankidroid/Anki-Android/commit/729e173142aadbb20d2c05637e316b961182cb80", "message": "NF: kill Task_Type_Count_Models when ModelBrowser close", "committedDate": "2020-07-05T23:44:49Z", "type": "commit"}, {"oid": "729e173142aadbb20d2c05637e316b961182cb80", "url": "https://github.com/ankidroid/Anki-Android/commit/729e173142aadbb20d2c05637e316b961182cb80", "message": "NF: kill Task_Type_Count_Models when ModelBrowser close", "committedDate": "2020-07-05T23:44:49Z", "type": "forcePushed"}]}