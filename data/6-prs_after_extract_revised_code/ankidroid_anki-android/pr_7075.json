{"pr_number": 7075, "pr_title": "Show useful error when col version is too high", "pr_createdAt": "2020-09-13T02:58:22Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/7075", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ3MzUxNw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7075#discussion_r487473517", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \n          \n          \n            \n            \n          \n          \n            \n                @Nullable", "author": "david-allison-1", "createdAt": "2020-09-13T02:58:58Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CollectionHelper.java", "diffHunk": "@@ -368,4 +370,20 @@ public static void loadCollectionComplete(Collection col) {\n         col.getModels();\n     }\n \n+    public static boolean isFutureAnkiDroidVersion(Context context) {\n+        Integer databaseVersion = getDatabaseVersion(context);\n+        return databaseVersion != null && databaseVersion > SCHEMA_VERSION;\n+    }\n+\n+", "originalCommit": "2cfa1e28608e36c67ea0bf4c7e277b65d4bfb465", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU0MjYwMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7075#discussion_r497542601", "bodyText": "As mentioned elsewhere, I'd prefer if the thing wasn't a possible null boxed value and was either a real value or a constant for unknown (-1) with actual exceptions and handling in case things are unrecoverably busted", "author": "mikehardy", "createdAt": "2020-09-30T14:12:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ3MzUxNw=="}], "type": "inlineReview", "revised_code": {"commit": "98cd640b9336d4deb4cafa1d0fd9bc2d0a8ec036", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/anki/CollectionHelper.java b/AnkiDroid/src/main/java/com/ichi2/anki/CollectionHelper.java\nindex 6682dd448..772794f02 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/anki/CollectionHelper.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/anki/CollectionHelper.java\n\n@@ -370,13 +376,13 @@ public class CollectionHelper {\n         col.getModels();\n     }\n \n-    public static boolean isFutureAnkiDroidVersion(Context context) {\n-        Integer databaseVersion = getDatabaseVersion(context);\n-        return databaseVersion != null && databaseVersion > SCHEMA_VERSION;\n+    public static boolean isFutureAnkiDroidVersion(Context context) throws UnknownDatabaseVersionException {\n+        int databaseVersion = getDatabaseVersion(context);\n+        return databaseVersion > SCHEMA_VERSION;\n     }\n \n \n-    public static Integer getDatabaseVersion(Context context) {\n+    public static int getDatabaseVersion(Context context) throws UnknownDatabaseVersionException {\n         try {\n             Collection col = getInstance().mCollection;\n             return col.queryVer();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ3MzUzNw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7075#discussion_r487473537", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                   // .itemsColor(ContextCompat.getColor(requireContext(), R.color.material_grey_500))", "author": "david-allison-1", "createdAt": "2020-09-13T02:59:16Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/dialogs/DatabaseErrorDialog.java", "diffHunk": "@@ -295,6 +300,31 @@ public MaterialDialog onCreateDialog(Bundle savedInstanceState) {\n                         .onPositive((inner_dialog, which) -> exit())\n                         .show();\n             }\n+            case DIALOG_DB_FUTURE_VERSION: {\n+                List<Integer> values = new ArrayList<>();\n+                CharSequence[] options = new CharSequence[] { UiUtil.makeBold(res.getString(R.string.backup_restore)), UiUtil.makeBold(res.getString(R.string.backup_full_sync_from_server)) };\n+                values.add(0);\n+                values.add(1);\n+                return builder\n+                        .cancelable(false)\n+                        .content(getMessage())\n+                        .iconAttr(R.attr.dialogErrorIcon)\n+                        .positiveText(res.getString(R.string.close))\n+                        .onPositive((inner_dialog, which) -> exit())\n+                        .items(options)\n+                       // .itemsColor(ContextCompat.getColor(requireContext(), R.color.material_grey_500))", "originalCommit": "2cfa1e28608e36c67ea0bf4c7e277b65d4bfb465", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "98cd640b9336d4deb4cafa1d0fd9bc2d0a8ec036", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/anki/dialogs/DatabaseErrorDialog.java b/AnkiDroid/src/main/java/com/ichi2/anki/dialogs/DatabaseErrorDialog.java\nindex 659a735b0..4348dde83 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/anki/dialogs/DatabaseErrorDialog.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/anki/dialogs/DatabaseErrorDialog.java\n\n@@ -300,7 +302,7 @@ public class DatabaseErrorDialog extends AsyncDialogFragment {\n                         .onPositive((inner_dialog, which) -> exit())\n                         .show();\n             }\n-            case DIALOG_DB_FUTURE_VERSION: {\n+            case INCOMPATIBLE_DB_VERSION: {\n                 List<Integer> values = new ArrayList<>();\n                 CharSequence[] options = new CharSequence[] { UiUtil.makeBold(res.getString(R.string.backup_restore)), UiUtil.makeBold(res.getString(R.string.backup_full_sync_from_server)) };\n                 values.add(0);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ3MzU4OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7075#discussion_r487473588", "bodyText": "This might want a nicer abstraction as it's a rough copy of the same code in another method", "author": "david-allison-1", "createdAt": "2020-09-13T02:59:45Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/dialogs/DatabaseErrorDialog.java", "diffHunk": "@@ -295,6 +300,31 @@ public MaterialDialog onCreateDialog(Bundle savedInstanceState) {\n                         .onPositive((inner_dialog, which) -> exit())\n                         .show();\n             }\n+            case DIALOG_DB_FUTURE_VERSION: {\n+                List<Integer> values = new ArrayList<>();\n+                CharSequence[] options = new CharSequence[] { UiUtil.makeBold(res.getString(R.string.backup_restore)), UiUtil.makeBold(res.getString(R.string.backup_full_sync_from_server)) };", "originalCommit": "2cfa1e28608e36c67ea0bf4c7e277b65d4bfb465", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "98cd640b9336d4deb4cafa1d0fd9bc2d0a8ec036", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/anki/dialogs/DatabaseErrorDialog.java b/AnkiDroid/src/main/java/com/ichi2/anki/dialogs/DatabaseErrorDialog.java\nindex 659a735b0..4348dde83 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/anki/dialogs/DatabaseErrorDialog.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/anki/dialogs/DatabaseErrorDialog.java\n\n@@ -300,7 +302,7 @@ public class DatabaseErrorDialog extends AsyncDialogFragment {\n                         .onPositive((inner_dialog, which) -> exit())\n                         .show();\n             }\n-            case DIALOG_DB_FUTURE_VERSION: {\n+            case INCOMPATIBLE_DB_VERSION: {\n                 List<Integer> values = new ArrayList<>();\n                 CharSequence[] options = new CharSequence[] { UiUtil.makeBold(res.getString(R.string.backup_restore)), UiUtil.makeBold(res.getString(R.string.backup_full_sync_from_server)) };\n                 values.add(0);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ3MzYwOQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7075#discussion_r487473609", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                Timber.w(e, \"Failed to get database version\");\n          \n          \n            \n                                Timber.w(e, \"Failed to get database version, using -1\");", "author": "david-allison-1", "createdAt": "2020-09-13T03:00:00Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/dialogs/DatabaseErrorDialog.java", "diffHunk": "@@ -334,6 +364,14 @@ private String getMessage() {\n                 return res().getString(R.string.backup_full_sync_from_server_question);\n             case DIALOG_DB_LOCKED:\n                 return res().getString(R.string.database_locked_summary);\n+            case DIALOG_DB_FUTURE_VERSION:\n+                Integer databaseVersion = null;\n+                try {\n+                    databaseVersion = CollectionHelper.getDatabaseVersion(requireContext());\n+                } catch (Exception e) {\n+                    Timber.w(e, \"Failed to get database version\");", "originalCommit": "2cfa1e28608e36c67ea0bf4c7e277b65d4bfb465", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUzNDQwOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7075#discussion_r497534408", "bodyText": "I like the -1 addition", "author": "mikehardy", "createdAt": "2020-09-30T14:01:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ3MzYwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "98cd640b9336d4deb4cafa1d0fd9bc2d0a8ec036", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/anki/dialogs/DatabaseErrorDialog.java b/AnkiDroid/src/main/java/com/ichi2/anki/dialogs/DatabaseErrorDialog.java\nindex 659a735b0..4348dde83 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/anki/dialogs/DatabaseErrorDialog.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/anki/dialogs/DatabaseErrorDialog.java\n\n@@ -364,14 +366,14 @@ public class DatabaseErrorDialog extends AsyncDialogFragment {\n                 return res().getString(R.string.backup_full_sync_from_server_question);\n             case DIALOG_DB_LOCKED:\n                 return res().getString(R.string.database_locked_summary);\n-            case DIALOG_DB_FUTURE_VERSION:\n-                Integer databaseVersion = null;\n+            case INCOMPATIBLE_DB_VERSION:\n+                int databaseVersion = -1;\n                 try {\n                     databaseVersion = CollectionHelper.getDatabaseVersion(requireContext());\n                 } catch (Exception e) {\n-                    Timber.w(e, \"Failed to get database version\");\n+                    Timber.w(e, \"Failed to get database version, using -1\");\n                 }\n-                return res().getString(R.string.database_version_summary, Consts.SCHEMA_VERSION, databaseVersion == null ? -1 : databaseVersion);\n+                return res().getString(R.string.incompatible_database_version_summary, Consts.SCHEMA_VERSION, databaseVersion);\n             default:\n                 return getArguments().getString(\"dialogMessage\");\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ3MzYzMw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7075#discussion_r487473633", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public Integer queryVer() {\n          \n          \n            \n                public int queryVer() {", "author": "david-allison-1", "createdAt": "2020-09-13T03:00:26Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -2134,6 +2134,10 @@ public Context getContext() {\n         return getDb().queryLongList(\"select id from cards where id in \" + Utils.ids2str(cards));\n     }\n \n+    public Integer queryVer() {", "originalCommit": "2cfa1e28608e36c67ea0bf4c7e277b65d4bfb465", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUzNDc2Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7075#discussion_r497534763", "bodyText": "I prefer types that can't go null personally", "author": "mikehardy", "createdAt": "2020-09-30T14:02:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ3MzYzMw=="}], "type": "inlineReview", "revised_code": {"commit": "98cd640b9336d4deb4cafa1d0fd9bc2d0a8ec036", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java b/AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java\nindex 29ce7cdc4..9eb89fcdc 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java\n\n@@ -2134,8 +2141,12 @@ public class Collection {\n         return getDb().queryLongList(\"select id from cards where id in \" + Utils.ids2str(cards));\n     }\n \n-    public Integer queryVer() {\n-        return getDb().queryScalar(\"select ver from col\");\n+    public Integer queryVer() throws UnknownDatabaseVersionException {\n+        try {\n+            return getDb().queryScalar(\"select ver from col\");\n+        } catch (Exception e) {\n+            throw new UnknownDatabaseVersionException(e);\n+        }\n     }\n \n     //This duplicates _loadScheduler (but returns the value and sets the report limit).\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUzNjM0OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7075#discussion_r497536348", "bodyText": "would prefer a constant -1 int unknown, and a real value here. It's a concrete thing the idea of a version, and seems like it should be strictly known as a real integer or a known constant (-1) that is unknown, with a real Exception if it's unrecoverably busted. I just don't like Nulls really, I'll admit it.", "author": "mikehardy", "createdAt": "2020-09-30T14:04:06Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Storage.java", "diffHunk": "@@ -45,6 +45,16 @@ public static Collection Collection(Context context, String path) {\n         return Collection(context, path, false, false);\n     }\n \n+    @Nullable\n+    public static Integer getDatabaseVersion(String path) {", "originalCommit": "2cfa1e28608e36c67ea0bf4c7e277b65d4bfb465", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "98cd640b9336d4deb4cafa1d0fd9bc2d0a8ec036", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/libanki/Storage.java b/AnkiDroid/src/main/java/com/ichi2/libanki/Storage.java\nindex ffd944709..25ff79fee 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/libanki/Storage.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/libanki/Storage.java\n\n@@ -45,14 +45,13 @@ public class Storage {\n         return Collection(context, path, false, false);\n     }\n \n-    @Nullable\n-    public static Integer getDatabaseVersion(String path) {\n+    public static int getDatabaseVersion(String path) throws UnknownDatabaseVersionException {\n         try {\n             DB db = new DB(path);\n             return db.queryScalar(\"SELECT ver FROM col\");\n         } catch (Exception e) {\n-            Timber.w(e, \"Can't open collection\");\n-            return null;\n+            Timber.w(e, \"Can't open database\");\n+            throw new UnknownDatabaseVersionException(e);\n         }\n     }\n \n"}}, {"oid": "98cd640b9336d4deb4cafa1d0fd9bc2d0a8ec036", "url": "https://github.com/ankidroid/Anki-Android/commit/98cd640b9336d4deb4cafa1d0fd9bc2d0a8ec036", "message": "Show useful error when col version is too high\n\nThis means that the database has been upgraded, and there is currently no\nway of downgrading from an earlier version\n\nFixes 7072", "committedDate": "2020-10-01T11:44:07Z", "type": "forcePushed"}, {"oid": "954feb3e0aa442d7bf1e337604c032d9795fe55a", "url": "https://github.com/ankidroid/Anki-Android/commit/954feb3e0aa442d7bf1e337604c032d9795fe55a", "message": "Show useful error when col version is too high\n\nThis means that the database has been upgraded, and there is currently no\nway of downgrading from an earlier version\n\nFixes 7072", "committedDate": "2020-10-01T13:45:48Z", "type": "forcePushed"}, {"oid": "0c74fccac1bd9cf79281bd2da548d8a7525c5d9d", "url": "https://github.com/ankidroid/Anki-Android/commit/0c74fccac1bd9cf79281bd2da548d8a7525c5d9d", "message": "Show useful error when col version is too high\n\nThis means that the database has been upgraded, and there is currently no\nway of downgrading from an earlier version\n\nFixes 7072", "committedDate": "2020-10-01T18:48:22Z", "type": "commit"}, {"oid": "0c74fccac1bd9cf79281bd2da548d8a7525c5d9d", "url": "https://github.com/ankidroid/Anki-Android/commit/0c74fccac1bd9cf79281bd2da548d8a7525c5d9d", "message": "Show useful error when col version is too high\n\nThis means that the database has been upgraded, and there is currently no\nway of downgrading from an earlier version\n\nFixes 7072", "committedDate": "2020-10-01T18:48:22Z", "type": "forcePushed"}]}