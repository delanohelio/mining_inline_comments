{"pr_number": 6335, "pr_title": "Remove hook for field", "pr_createdAt": "2020-06-02T14:33:18Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6335", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzkzNTQwNA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6335#discussion_r433935404", "bodyText": "Can we keep this here - I fear this will come back to haunt us", "author": "david-allison-1", "createdAt": "2020-06-02T14:48:38Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/template/Template.java", "diffHunk": "@@ -315,13 +315,7 @@ private String render_comment() {\n                         break;\n                 }\n                 if (hook != null) {\n-                    try {\n-                        txt = hook.runFilter(txt, tag);\n-                    } catch (Exception e) {\n-                        String funcName = hook.getClass().getCanonicalName();\n-                        Timber.e(e, \"Exception while running hook fmod_%s : %s\", mod, funcName);", "originalCommit": "081b79ef1c87a4a9956bad89c4595d893808a3a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk2MTM1MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6335#discussion_r433961351", "bodyText": "If it please you, I can", "author": "Arthur-Milchior", "createdAt": "2020-06-02T15:23:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzkzNTQwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk2ODU5OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6335#discussion_r433968598", "bodyText": "Yeah, we have just fought such a long battle against crashes, I like catching exceptions just...in...case - Android platform is endlessly surprising in the ways it can crash", "author": "mikehardy", "createdAt": "2020-06-02T15:34:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzkzNTQwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk2OTgzOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6335#discussion_r433969838", "bodyText": "A \"catch all\" exception is a \"we don't know what'll happen here\".\nI don't particularly like it, but it's much worse if it throws, as it's a \"really important\" path of the application.", "author": "david-allison-1", "createdAt": "2020-06-02T15:35:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzkzNTQwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk3MDk2MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6335#discussion_r433970961", "bodyText": "Rebased to keep an error message. I just use \"fmod\", as \"funcName\" make little sens and give no more information here", "author": "Arthur-Milchior", "createdAt": "2020-06-02T15:37:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzkzNTQwNA=="}], "type": "inlineReview", "revised_code": {"commit": "0f6cd1c2b29407694ae7f6a734e3a393a8353be1", "chunk": "diff --git a/AnkiDroid/src/main/java/com/ichi2/libanki/template/Template.java b/AnkiDroid/src/main/java/com/ichi2/libanki/template/Template.java\nindex 2dd2ad761..286db14c2 100644\n--- a/AnkiDroid/src/main/java/com/ichi2/libanki/template/Template.java\n+++ b/AnkiDroid/src/main/java/com/ichi2/libanki/template/Template.java\n\n@@ -297,25 +297,26 @@ public class Template {\n                 if (txt == null) {\n                     txt = \"\";\n                 }\n-                Hook hook = null;\n-                switch (mod) {\n+                try {\n+                    switch (mod) {\n                     case \"hint\" :\n-                        hook = new Hint();\n+                        txt = runHint(txt, tag);\n                         break;\n                     case \"kanji\" :\n-                        hook = new FuriganaFilters.Kanji();\n+                        txt = FuriganaFilters.kanjiFilter(txt);\n                         break;\n                     case \"kana\" :\n-                        hook = new FuriganaFilters.Kana();\n+                        txt = FuriganaFilters.kanaFilter(txt);\n                         break;\n                     case \"furigana\" :\n-                        hook = new FuriganaFilters.Furigana();\n+                        txt = FuriganaFilters.furiganaFilter(txt);\n                         break;\n                     default :\n                         break;\n-                }\n-                if (hook != null) {\n-                    txt = hook.runFilter(txt, tag);\n+                    }\n+                } catch (Exception e) {\n+                    Timber.e(e, \"Exception while running hook %s\", mod);\n+                    return \"Error in filter \" + mod;\n                 }\n                 if (txt == null) {\n                     return String.format(\"{unknown field %s}\", tag_name);\n"}}, {"oid": "0f6cd1c2b29407694ae7f6a734e3a393a8353be1", "url": "https://github.com/ankidroid/Anki-Android/commit/0f6cd1c2b29407694ae7f6a734e3a393a8353be1", "message": "NF: move formatting filters to template", "committedDate": "2020-06-02T15:35:28Z", "type": "forcePushed"}, {"oid": "757ceca245358ea1d7db0c2eff829e3503a797a6", "url": "https://github.com/ankidroid/Anki-Android/commit/757ceca245358ea1d7db0c2eff829e3503a797a6", "message": "NF: filter: restricted to string->string", "committedDate": "2020-06-02T17:50:20Z", "type": "commit"}, {"oid": "5d5bc0252065456901e0b3682088dcb75e2c8f97", "url": "https://github.com/ankidroid/Anki-Android/commit/5d5bc0252065456901e0b3682088dcb75e2c8f97", "message": "NF: txt: change position", "committedDate": "2020-06-02T17:50:20Z", "type": "commit"}, {"oid": "5539bd34d5d41a53c0c11e9be943ebb06659dcd2", "url": "https://github.com/ankidroid/Anki-Android/commit/5539bd34d5d41a53c0c11e9be943ebb06659dcd2", "message": "NF: rename vars to \"txt\"", "committedDate": "2020-06-02T17:50:20Z", "type": "commit"}, {"oid": "cfbd43d08eedfe5ee27f03417cfe6184b5f1c558", "url": "https://github.com/ankidroid/Anki-Android/commit/cfbd43d08eedfe5ee27f03417cfe6184b5f1c558", "message": "NF: make inner class static", "committedDate": "2020-06-02T17:50:20Z", "type": "commit"}, {"oid": "1651ffafad06162c3e3f7e03ab83f28a101118ef", "url": "https://github.com/ankidroid/Anki-Android/commit/1651ffafad06162c3e3f7e03ab83f28a101118ef", "message": "NF: direct use of filter in fields", "committedDate": "2020-06-02T17:50:20Z", "type": "commit"}, {"oid": "fa90ec4b39df04aa53d037bbbd17a0a1693acc15", "url": "https://github.com/ankidroid/Anki-Android/commit/fa90ec4b39df04aa53d037bbbd17a0a1693acc15", "message": "NF: remove unused runFilter", "committedDate": "2020-06-02T17:50:20Z", "type": "commit"}, {"oid": "90736bee50fce33559b9208ecdc34b4009794b1c", "url": "https://github.com/ankidroid/Anki-Android/commit/90736bee50fce33559b9208ecdc34b4009794b1c", "message": "NF: remove installation of always-on hook", "committedDate": "2020-06-02T17:50:31Z", "type": "commit"}, {"oid": "4fd00d45a8c441f1fe7c3b48f7babc56b7abd153", "url": "https://github.com/ankidroid/Anki-Android/commit/4fd00d45a8c441f1fe7c3b48f7babc56b7abd153", "message": "NF: remove unused install", "committedDate": "2020-06-02T17:50:31Z", "type": "commit"}, {"oid": "47cfb58fdcc85c002fb6e56e047021234fca543c", "url": "https://github.com/ankidroid/Anki-Android/commit/47cfb58fdcc85c002fb6e56e047021234fca543c", "message": "NF: rename HintFilter to Hint", "committedDate": "2020-06-02T17:50:31Z", "type": "commit"}, {"oid": "60bfc3e6a72164dd68b0ef1fa78ca804ef7ba9ab", "url": "https://github.com/ankidroid/Anki-Android/commit/60bfc3e6a72164dd68b0ef1fa78ca804ef7ba9ab", "message": "NF: hints run directly instead of using the hook", "committedDate": "2020-06-02T17:50:31Z", "type": "commit"}, {"oid": "a6b283d6f8164ec65fbbb2c5ab53eb3142b3f3b6", "url": "https://github.com/ankidroid/Anki-Android/commit/a6b283d6f8164ec65fbbb2c5ab53eb3142b3f3b6", "message": "NF:Hint don't inherit from Hook", "committedDate": "2020-06-02T17:50:31Z", "type": "commit"}, {"oid": "1e0c4b76ef4298d80df42b40ccdf18a930421e98", "url": "https://github.com/ankidroid/Anki-Android/commit/1e0c4b76ef4298d80df42b40ccdf18a930421e98", "message": "NF: remove tag parameter", "committedDate": "2020-06-02T17:50:31Z", "type": "commit"}, {"oid": "cabe96fad8bb94c8bafd8b79d70b8a92b56370b4", "url": "https://github.com/ankidroid/Anki-Android/commit/cabe96fad8bb94c8bafd8b79d70b8a92b56370b4", "message": "NF: direct call of filter functions", "committedDate": "2020-06-02T17:50:31Z", "type": "commit"}, {"oid": "419b4a35b4df63abc3a94b7e8c92c7aac55d36cd", "url": "https://github.com/ankidroid/Anki-Android/commit/419b4a35b4df63abc3a94b7e8c92c7aac55d36cd", "message": "NF: remove unused method runFilter", "committedDate": "2020-06-02T17:50:31Z", "type": "commit"}, {"oid": "23c834bad94617efde6b75095bd881d041c72744", "url": "https://github.com/ankidroid/Anki-Android/commit/23c834bad94617efde6b75095bd881d041c72744", "message": "NF: Hint in Template", "committedDate": "2020-06-02T17:50:31Z", "type": "commit"}, {"oid": "b15fe11db893d0115c0b51a5c8887e9ccdc44ead", "url": "https://github.com/ankidroid/Anki-Android/commit/b15fe11db893d0115c0b51a5c8887e9ccdc44ead", "message": "NF: move formatting filters to template", "committedDate": "2020-06-02T17:50:31Z", "type": "commit"}, {"oid": "b15fe11db893d0115c0b51a5c8887e9ccdc44ead", "url": "https://github.com/ankidroid/Anki-Android/commit/b15fe11db893d0115c0b51a5c8887e9ccdc44ead", "message": "NF: move formatting filters to template", "committedDate": "2020-06-02T17:50:31Z", "type": "forcePushed"}]}