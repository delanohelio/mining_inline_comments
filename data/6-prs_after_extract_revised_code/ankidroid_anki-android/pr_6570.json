{"pr_number": 6570, "pr_title": "Schedv2 testing", "pr_createdAt": "2020-06-28T22:17:21Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6570", "timeline": [{"oid": "2ea78ed9836736b9590609e3148d18a57e7a8838", "url": "https://github.com/ankidroid/Anki-Android/commit/2ea78ed9836736b9590609e3148d18a57e7a8838", "message": "NF: de-lint ContentProviderTest", "committedDate": "2020-06-28T21:35:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcwNzA2Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6570#discussion_r446707063", "bodyText": "needs braces", "author": "david-allison-1", "createdAt": "2020-06-28T22:38:39Z", "path": "AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java", "diffHunk": "@@ -118,24 +129,28 @@ public void setUp() throws Exception {\n         Log.i(AnkiDroidApp.TAG, \"setUp()\");\n         mCreatedNotes = new ArrayList<>();\n         final Collection col = getCol();\n+\n+        // We have parameterized the \"schedVersion\" variable, if we are on an emulator\n+        // (so it is safe) we will try to run with multiple scheduler versions\n+        if (InstrumentedTest.isEmulator()) col.changeSchedulerVer(schedVersion);", "originalCommit": "342f8623bc70f5a5efe030afa2e4a3d17eb0fcf8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2e0399cf1fe9b06fcd28d522c379e18d7097624", "chunk": "diff --git a/AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java b/AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java\nindex c00ae7bc3..fc2f07f63 100644\n--- a/AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java\n+++ b/AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java\n\n@@ -132,7 +133,9 @@ public class ContentProviderTest extends InstrumentedTest {\n \n         // We have parameterized the \"schedVersion\" variable, if we are on an emulator\n         // (so it is safe) we will try to run with multiple scheduler versions\n-        if (InstrumentedTest.isEmulator()) col.changeSchedulerVer(schedVersion);\n+        if (InstrumentedTest.isEmulator()) {\n+            col.changeSchedulerVer(schedVersion);\n+        }\n \n         // Add a new basic model that we use for testing purposes (existing models could potentially be corrupted)\n         JSONObject model = StdModels.basicModel.add(col, BASIC_MODEL_NAME);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcwNzI0NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6570#discussion_r446707244", "bodyText": "likewise", "author": "david-allison-1", "createdAt": "2020-06-28T22:40:21Z", "path": "AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java", "diffHunk": "@@ -392,11 +413,10 @@ public void testQueryNotesProjection() {\n         }\n     }\n \n-    private String[] removeFromProjection(String[] inputProjection, int idx) {\n+    private String[] removeFromProjection(@SuppressWarnings(\"SameParameterValue\") String[] inputProjection, int idx) {\n         String[] outputProjection = new String[inputProjection.length - 1];\n-        for (int i = 0; i < idx; i++) {\n-            outputProjection[i] = inputProjection[i];\n-        }\n+        if (idx >= 0) System.arraycopy(inputProjection, 0, outputProjection, 0, idx);", "originalCommit": "342f8623bc70f5a5efe030afa2e4a3d17eb0fcf8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2e0399cf1fe9b06fcd28d522c379e18d7097624", "chunk": "diff --git a/AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java b/AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java\nindex c00ae7bc3..fc2f07f63 100644\n--- a/AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java\n+++ b/AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java\n\n@@ -415,7 +418,9 @@ public class ContentProviderTest extends InstrumentedTest {\n \n     private String[] removeFromProjection(@SuppressWarnings(\"SameParameterValue\") String[] inputProjection, int idx) {\n         String[] outputProjection = new String[inputProjection.length - 1];\n-        if (idx >= 0) System.arraycopy(inputProjection, 0, outputProjection, 0, idx);\n+        if (idx >= 0) {\n+            System.arraycopy(inputProjection, 0, outputProjection, 0, idx);\n+        }\n         //noinspection ManualArrayCopy\n         for (int i = idx + 1; i < inputProjection.length; i++) {\n             outputProjection[i - 1] = inputProjection[i];\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcwNzQ0Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/6570#discussion_r446707446", "bodyText": "Can we use Assume (http://junit.sourceforge.net/javadoc/org/junit/Assume.html) here? Assuming (hehe) it doesn't fail the build.\nIME it's best to explicitly show that a test was ignored, rather than passing with a noop", "author": "david-allison-1", "createdAt": "2020-06-28T22:42:14Z", "path": "AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java", "diffHunk": "@@ -994,8 +1021,11 @@ public void testUpdateTags() {\n \n     /** Test that a null did will not crash the provider (#6378) */\n      @Test\n-     @Ignore(\"#6025 - This causes mild data corruption - should not be run on actual collection\")\n      public void testProviderProvidesDefaultForEmptyModelDeck() {\n+         if (!isEmulator()) {", "originalCommit": "342f8623bc70f5a5efe030afa2e4a3d17eb0fcf8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcxMDc0NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6570#discussion_r446710745", "bodyText": "Perhaps? I've never done that before. I agree with explicit ignore just wasn't even aware that trick existed\nI'll wait to see what @Arthur-Milchior  wants to do with this as it was essentially a sketch of how to expose v2 to more testing with some possible failures already demonstrated", "author": "mikehardy", "createdAt": "2020-06-28T23:16:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcwNzQ0Ng=="}], "type": "inlineReview", "revised_code": {"commit": "d2e0399cf1fe9b06fcd28d522c379e18d7097624", "chunk": "diff --git a/AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java b/AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java\nindex c00ae7bc3..fc2f07f63 100644\n--- a/AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java\n+++ b/AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java\n\n@@ -1013,19 +1019,14 @@ public class ContentProviderTest extends InstrumentedTest {\n         assertEquals(\"two tags\", 2, newTagList.size());\n         assertEquals(\"check first tag\", TEST_TAG, newTagList.get(0));\n         assertEquals(\"check second tag\", tag2, newTagList.get(1));\n-\n-\n     }\n \n \n-\n     /** Test that a null did will not crash the provider (#6378) */\n      @Test\n      public void testProviderProvidesDefaultForEmptyModelDeck() {\n-         if (!isEmulator()) {\n-             // This causes mild data corruption - should not be run on actual collection\"\n-             return;\n-         }\n+         // This causes mild data corruption - should not be run on a collection you care about\n+         assumeTrue(!isEmulator());\n          Collection col = getCol();\n          col.getModels().all().get(0).put(\"did\", JSONObject.NULL);\n          col.save();\n"}}, {"oid": "d2e0399cf1fe9b06fcd28d522c379e18d7097624", "url": "https://github.com/ankidroid/Anki-Android/commit/d2e0399cf1fe9b06fcd28d522c379e18d7097624", "message": "Parameterize the ContentProviderTest across both schedulers\n\nNow we exercise SchedV2 a bit as well which should help\nNote that it is having problems right now but hopefully\nfollowing commits will fix them", "committedDate": "2020-06-29T17:52:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2MzgxNg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6570#discussion_r447163816", "bodyText": "Can we use Utils.arrayList2array here (and in a few other places)?\nNote: actually accepts List<T>", "author": "david-allison-1", "createdAt": "2020-06-29T18:19:48Z", "path": "AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java", "diffHunk": "@@ -176,11 +194,11 @@ public void tearDown() throws Exception {\n         // Delete all notes\n         List<Long> remnantNotes = col.findNotes(\"tag:\" + TEST_TAG);\n         if (remnantNotes.size() > 0) {\n-            long[] nids = new long[remnantNotes.size()];\n+            long[] noteIds = new long[remnantNotes.size()];", "originalCommit": "d2e0399cf1fe9b06fcd28d522c379e18d7097624", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "42ba7bbb324ceec55937ff63e6943ad12c2c2337", "chunk": "diff --git a/AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java b/AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java\nindex fc2f07f63..946ee84c7 100644\n--- a/AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java\n+++ b/AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java\n\n@@ -194,10 +194,7 @@ public class ContentProviderTest extends InstrumentedTest {\n         // Delete all notes\n         List<Long> remnantNotes = col.findNotes(\"tag:\" + TEST_TAG);\n         if (remnantNotes.size() > 0) {\n-            long[] noteIds = new long[remnantNotes.size()];\n-            for (int i = 0; i < remnantNotes.size(); i++) {\n-                noteIds[i] = remnantNotes.get(i);\n-            }\n+            long[] noteIds = Utils.arrayList2array(remnantNotes);\n             col.remNotes(noteIds);\n             col.save();\n             assertEquals(\"Check that remnant notes have been deleted\", 0, col.findNotes(\"tag:\" + TEST_TAG).size());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2NDI4NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6570#discussion_r447164284", "bodyText": "Is this in the right place?", "author": "david-allison-1", "createdAt": "2020-06-29T18:20:39Z", "path": "AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java", "diffHunk": "@@ -392,11 +416,12 @@ public void testQueryNotesProjection() {\n         }\n     }\n \n-    private String[] removeFromProjection(String[] inputProjection, int idx) {\n+    private String[] removeFromProjection(@SuppressWarnings(\"SameParameterValue\") String[] inputProjection, int idx) {\n         String[] outputProjection = new String[inputProjection.length - 1];\n-        for (int i = 0; i < idx; i++) {\n-            outputProjection[i] = inputProjection[i];\n+        if (idx >= 0) {\n+            System.arraycopy(inputProjection, 0, outputProjection, 0, idx);\n         }\n+        //noinspection ManualArrayCopy", "originalCommit": "d2e0399cf1fe9b06fcd28d522c379e18d7097624", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE3NTE5OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6570#discussion_r447175198", "bodyText": "Yes, one of the AndroidStudio auto-refactors for system array copy was valid, the other one did not work correctly but I did not really investigate, just backed that one out and suppressed lint", "author": "mikehardy", "createdAt": "2020-06-29T18:39:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2NDI4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE3ODQyNA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6570#discussion_r447178424", "bodyText": "Does it actually suppress the lint error as it's after the affected line", "author": "david-allison-1", "createdAt": "2020-06-29T18:44:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2NDI4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE4MjU5OQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6570#discussion_r447182599", "bodyText": "Yes it does, there were two copies there both lit up lint view in Android Studio.\nFirst one transformed, no problem.\nSecond one did not. Backed out transform and marked it noinspection, it is for the for loop copy following the line, it definitely works.", "author": "mikehardy", "createdAt": "2020-06-29T18:52:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2NDI4NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2NDc1MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6570#discussion_r447164750", "bodyText": "maybe rename to earlyGraduatingEase", "author": "david-allison-1", "createdAt": "2020-06-29T18:21:28Z", "path": "AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java", "diffHunk": "@@ -829,7 +862,7 @@ public void testAnswerCard(){\n         ContentValues values = new ContentValues();\n         long noteId = card.note().getId();\n         int cardOrd = card.getOrd();\n-        int ease = AbstractFlashcardViewer.EASE_3; //<- insert real ease here\n+        int ease = (schedVersion == 1) ? AbstractFlashcardViewer.EASE_3 : AbstractFlashcardViewer.EASE_4;", "originalCommit": "d2e0399cf1fe9b06fcd28d522c379e18d7097624", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "42ba7bbb324ceec55937ff63e6943ad12c2c2337", "chunk": "diff --git a/AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java b/AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java\nindex fc2f07f63..946ee84c7 100644\n--- a/AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java\n+++ b/AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java\n\n@@ -862,12 +859,12 @@ public class ContentProviderTest extends InstrumentedTest {\n         ContentValues values = new ContentValues();\n         long noteId = card.note().getId();\n         int cardOrd = card.getOrd();\n-        int ease = (schedVersion == 1) ? AbstractFlashcardViewer.EASE_3 : AbstractFlashcardViewer.EASE_4;\n+        int earlyGraduatingEase = (schedVersion == 1) ? AbstractFlashcardViewer.EASE_3 : AbstractFlashcardViewer.EASE_4;\n         long timeTaken = 5000; // 5 seconds\n \n         values.put(FlashCardsContract.ReviewInfo.NOTE_ID, noteId);\n         values.put(FlashCardsContract.ReviewInfo.CARD_ORD, cardOrd);\n-        values.put(FlashCardsContract.ReviewInfo.EASE, ease);\n+        values.put(FlashCardsContract.ReviewInfo.EASE, earlyGraduatingEase);\n         values.put(FlashCardsContract.ReviewInfo.TIME_TAKEN, timeTaken);\n         int updateCount = cr.update(reviewInfoUri, values, null, null);\n         assertEquals(\"Check if update returns 1\", 1, updateCount);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2NTE5NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6570#discussion_r447165194", "bodyText": "Shouldn't this be assumeTrue(isEmulator());\nOr\nassumeThat(\"This causes mild data corruption - should not be run on a collection you care about\", isEmulator())", "author": "david-allison-1", "createdAt": "2020-06-29T18:22:13Z", "path": "AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java", "diffHunk": "@@ -986,16 +1019,14 @@ public void testUpdateTags() {\n         assertEquals(\"two tags\", 2, newTagList.size());\n         assertEquals(\"check first tag\", TEST_TAG, newTagList.get(0));\n         assertEquals(\"check second tag\", tag2, newTagList.get(1));\n-\n-\n     }\n \n \n-\n     /** Test that a null did will not crash the provider (#6378) */\n      @Test\n-     @Ignore(\"#6025 - This causes mild data corruption - should not be run on actual collection\")\n      public void testProviderProvidesDefaultForEmptyModelDeck() {\n+         // This causes mild data corruption - should not be run on a collection you care about\n+         assumeTrue(!isEmulator());", "originalCommit": "d2e0399cf1fe9b06fcd28d522c379e18d7097624", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE3NzMwNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6570#discussion_r447177305", "bodyText": "oh my, thinko. corrected", "author": "mikehardy", "createdAt": "2020-06-29T18:42:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2NTE5NA=="}], "type": "inlineReview", "revised_code": {"commit": "42ba7bbb324ceec55937ff63e6943ad12c2c2337", "chunk": "diff --git a/AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java b/AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java\nindex fc2f07f63..946ee84c7 100644\n--- a/AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java\n+++ b/AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java\n\n@@ -1025,8 +1022,7 @@ public class ContentProviderTest extends InstrumentedTest {\n     /** Test that a null did will not crash the provider (#6378) */\n      @Test\n      public void testProviderProvidesDefaultForEmptyModelDeck() {\n-         // This causes mild data corruption - should not be run on a collection you care about\n-         assumeTrue(!isEmulator());\n+         assumeTrue(\"This causes mild data corruption - should not be run on a collection you care about\", isEmulator());\n          Collection col = getCol();\n          col.getModels().all().get(0).put(\"did\", JSONObject.NULL);\n          col.save();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2NTU3NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6570#discussion_r447165574", "bodyText": "This is marked as changed, but it looks the same - might just be whitespace?", "author": "david-allison-1", "createdAt": "2020-06-29T18:22:51Z", "path": "AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java", "diffHunk": "@@ -1006,10 +1037,8 @@ public void testProviderProvidesDefaultForEmptyModelDeck() {\n          assertNotNull(allModels);\n      }\n \n-\n- private Collection reopenCol() {\n-        CollectionHelper.getInstance().closeCollection(false, \"ContentProviderTest: reopenCol\");\n-        return getCol();\n-    }\n-\n+     private Collection reopenCol() {", "originalCommit": "d2e0399cf1fe9b06fcd28d522c379e18d7097624", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE3MzkwOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6570#discussion_r447173908", "bodyText": "Yes I should have unticked the unnecessarily changed whitespace assertion, there were just some obvious uglinesses in there and I moved them, sorry", "author": "mikehardy", "createdAt": "2020-06-29T18:36:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2NTU3NA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "42ba7bbb324ceec55937ff63e6943ad12c2c2337", "url": "https://github.com/ankidroid/Anki-Android/commit/42ba7bbb324ceec55937ff63e6943ad12c2c2337", "message": "Parameterize the ContentProviderTest across both schedulers\n\nNow we exercise SchedV2 a bit as well which should help\nNote that it is having problems right now but hopefully\nfollowing commits will fix them", "committedDate": "2020-06-29T18:43:21Z", "type": "commit"}, {"oid": "42ba7bbb324ceec55937ff63e6943ad12c2c2337", "url": "https://github.com/ankidroid/Anki-Android/commit/42ba7bbb324ceec55937ff63e6943ad12c2c2337", "message": "Parameterize the ContentProviderTest across both schedulers\n\nNow we exercise SchedV2 a bit as well which should help\nNote that it is having problems right now but hopefully\nfollowing commits will fix them", "committedDate": "2020-06-29T18:43:21Z", "type": "forcePushed"}]}