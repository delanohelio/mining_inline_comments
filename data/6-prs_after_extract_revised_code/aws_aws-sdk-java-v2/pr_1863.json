{"pr_number": 1863, "pr_title": "Add apache HTTP request stats", "pr_createdAt": "2020-05-27T21:06:33Z", "pr_url": "https://github.com/aws/aws-sdk-java-v2/pull/1863", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ0NDA3OA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1863#discussion_r431444078", "bodyText": "nit, no final on local variable \ud83d\ude1b", "author": "zoewangg", "createdAt": "2020-05-27T21:10:07Z", "path": "http-clients/apache-client/src/main/java/software/amazon/awssdk/http/apache/ApacheHttpClient.java", "diffHunk": "@@ -206,11 +214,15 @@ private boolean isProxyEnabled(ProxyConfiguration proxyConfiguration) {\n \n     @Override\n     public ExecutableHttpRequest prepareRequest(HttpExecuteRequest request) {\n+        final MetricCollector metricCollector = request.metricCollector().orElseGet(NoOpMetricCollector::create);\n+        metricCollector.reportMetric(HTTP_CLIENT_NAME, clientName());\n         HttpRequestBase apacheRequest = toApacheRequest(request);\n         return new ExecutableHttpRequest() {\n             @Override\n             public HttpExecuteResponse call() throws IOException {\n-                return execute(apacheRequest);\n+                final HttpExecuteResponse executeResponse = execute(apacheRequest);", "originalCommit": "cac6868c4eb2bbe12921122ac54f2883fc2fe00a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ5ODI1Mw==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1863#discussion_r431498253", "bodyText": "Ooops, this was Intellij's fault!", "author": "dagnir", "createdAt": "2020-05-27T23:25:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ0NDA3OA=="}], "type": "inlineReview", "revised_code": {"commit": "69e0b3c38cc87fa68d2dac3764146167f9d1b3be", "chunk": "diff --git a/http-clients/apache-client/src/main/java/software/amazon/awssdk/http/apache/ApacheHttpClient.java b/http-clients/apache-client/src/main/java/software/amazon/awssdk/http/apache/ApacheHttpClient.java\nindex ce65097c37..a36ef49962 100644\n--- a/http-clients/apache-client/src/main/java/software/amazon/awssdk/http/apache/ApacheHttpClient.java\n+++ b/http-clients/apache-client/src/main/java/software/amazon/awssdk/http/apache/ApacheHttpClient.java\n\n@@ -214,13 +214,13 @@ public final class ApacheHttpClient implements SdkHttpClient {\n \n     @Override\n     public ExecutableHttpRequest prepareRequest(HttpExecuteRequest request) {\n-        final MetricCollector metricCollector = request.metricCollector().orElseGet(NoOpMetricCollector::create);\n+        MetricCollector metricCollector = request.metricCollector().orElseGet(NoOpMetricCollector::create);\n         metricCollector.reportMetric(HTTP_CLIENT_NAME, clientName());\n         HttpRequestBase apacheRequest = toApacheRequest(request);\n         return new ExecutableHttpRequest() {\n             @Override\n             public HttpExecuteResponse call() throws IOException {\n-                final HttpExecuteResponse executeResponse = execute(apacheRequest);\n+                HttpExecuteResponse executeResponse = execute(apacheRequest);\n                 collectPoolMetric(metricCollector);\n                 return executeResponse;\n             }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ0NTE0MA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1863#discussion_r431445140", "bodyText": "PENDING_CONNECTION_REQUESTS or PENDING_CONNECTIONS?", "author": "zoewangg", "createdAt": "2020-05-27T21:12:17Z", "path": "http-client-spi/src/main/java/software/amazon/awssdk/http/HttpMetrics.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.http;\n+\n+import software.amazon.awssdk.metrics.MetricCategory;\n+import software.amazon.awssdk.metrics.SdkMetric;\n+\n+/**\n+ * Metrics collected by HTTP clients.\n+ */\n+public final class HttpMetrics {\n+    /**\n+     * The name of the HTTP client.\n+     */\n+    public static final SdkMetric<String> HTTP_CLIENT_NAME = metric(\"HttpClientName\", String.class);\n+\n+    /**\n+     * The maximum number of connections that will be pooled by the HTTP client.\n+     */\n+    public static final SdkMetric<Integer> MAX_CONNECTIONS = metric(\"MaxConnections\", Integer.class);\n+\n+    /**\n+     * The number of idle connections in the connection pool that are ready to serve a request.\n+     */\n+    public static final SdkMetric<Integer> AVAILABLE_CONNECTIONS = metric(\"AvailableConnections\", Integer.class);\n+\n+    /**\n+     * The number of connections from the connection pool that are busy serving requests.\n+     */\n+    public static final SdkMetric<Integer> LEASED_CONNECTIONS = metric(\"LeasedConnections\", Integer.class);\n+\n+    /**\n+     * The number of requests awaiting a free connection from the pool.\n+     */\n+    public static final SdkMetric<Integer> PENDING_REQUESTS = metric(\"PendingRequests\", Integer.class);", "originalCommit": "cac6868c4eb2bbe12921122ac54f2883fc2fe00a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ5ODc2MA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1863#discussion_r431498760", "bodyText": "Yeah I'm not married to these names. Howe about PENDING_CONNECTION_ACQUIRES?", "author": "dagnir", "createdAt": "2020-05-27T23:27:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ0NTE0MA=="}], "type": "inlineReview", "revised_code": {"commit": "69e0b3c38cc87fa68d2dac3764146167f9d1b3be", "chunk": "diff --git a/http-client-spi/src/main/java/software/amazon/awssdk/http/HttpMetrics.java b/http-client-spi/src/main/java/software/amazon/awssdk/http/HttpMetric.java\nsimilarity index 87%\nrename from http-client-spi/src/main/java/software/amazon/awssdk/http/HttpMetrics.java\nrename to http-client-spi/src/main/java/software/amazon/awssdk/http/HttpMetric.java\nindex 7382629a3c..36cdfc6de3 100644\n--- a/http-client-spi/src/main/java/software/amazon/awssdk/http/HttpMetrics.java\n+++ b/http-client-spi/src/main/java/software/amazon/awssdk/http/HttpMetric.java\n\n@@ -15,13 +15,15 @@\n \n package software.amazon.awssdk.http;\n \n+import software.amazon.awssdk.annotations.SdkPublicApi;\n import software.amazon.awssdk.metrics.MetricCategory;\n import software.amazon.awssdk.metrics.SdkMetric;\n \n /**\n  * Metrics collected by HTTP clients.\n  */\n-public final class HttpMetrics {\n+@SdkPublicApi\n+public final class HttpMetric {\n     /**\n      * The name of the HTTP client.\n      */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ0NTI2NA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1863#discussion_r431445264", "bodyText": "Do we need to namespace all sdk metrics?", "author": "zoewangg", "createdAt": "2020-05-27T21:12:32Z", "path": "http-client-spi/src/main/java/software/amazon/awssdk/http/HttpMetrics.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.http;\n+\n+import software.amazon.awssdk.metrics.MetricCategory;\n+import software.amazon.awssdk.metrics.SdkMetric;\n+\n+/**\n+ * Metrics collected by HTTP clients.\n+ */\n+public final class HttpMetrics {\n+    /**\n+     * The name of the HTTP client.\n+     */\n+    public static final SdkMetric<String> HTTP_CLIENT_NAME = metric(\"HttpClientName\", String.class);\n+\n+    /**\n+     * The maximum number of connections that will be pooled by the HTTP client.\n+     */\n+    public static final SdkMetric<Integer> MAX_CONNECTIONS = metric(\"MaxConnections\", Integer.class);", "originalCommit": "cac6868c4eb2bbe12921122ac54f2883fc2fe00a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ5OTM3Nw==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1863#discussion_r431499377", "bodyText": "I think the issue with that is if you want to \"pretty print\" the metrics, or write your own publisher, there's no easy way to just get the metric name", "author": "dagnir", "createdAt": "2020-05-27T23:29:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ0NTI2NA=="}], "type": "inlineReview", "revised_code": {"commit": "69e0b3c38cc87fa68d2dac3764146167f9d1b3be", "chunk": "diff --git a/http-client-spi/src/main/java/software/amazon/awssdk/http/HttpMetrics.java b/http-client-spi/src/main/java/software/amazon/awssdk/http/HttpMetric.java\nsimilarity index 87%\nrename from http-client-spi/src/main/java/software/amazon/awssdk/http/HttpMetrics.java\nrename to http-client-spi/src/main/java/software/amazon/awssdk/http/HttpMetric.java\nindex 7382629a3c..36cdfc6de3 100644\n--- a/http-client-spi/src/main/java/software/amazon/awssdk/http/HttpMetrics.java\n+++ b/http-client-spi/src/main/java/software/amazon/awssdk/http/HttpMetric.java\n\n@@ -15,13 +15,15 @@\n \n package software.amazon.awssdk.http;\n \n+import software.amazon.awssdk.annotations.SdkPublicApi;\n import software.amazon.awssdk.metrics.MetricCategory;\n import software.amazon.awssdk.metrics.SdkMetric;\n \n /**\n  * Metrics collected by HTTP clients.\n  */\n-public final class HttpMetrics {\n+@SdkPublicApi\n+public final class HttpMetric {\n     /**\n      * The name of the HTTP client.\n      */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ2MjUzNw==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1863#discussion_r431462537", "bodyText": "Do we want to differentiate h2 max connection from it? Is it worth creating a new class for all h2 http metrics such as window size, max streams, etc?", "author": "zoewangg", "createdAt": "2020-05-27T21:49:13Z", "path": "http-client-spi/src/main/java/software/amazon/awssdk/http/HttpMetrics.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.http;\n+\n+import software.amazon.awssdk.metrics.MetricCategory;\n+import software.amazon.awssdk.metrics.SdkMetric;\n+\n+/**\n+ * Metrics collected by HTTP clients.\n+ */\n+public final class HttpMetrics {\n+    /**\n+     * The name of the HTTP client.\n+     */\n+    public static final SdkMetric<String> HTTP_CLIENT_NAME = metric(\"HttpClientName\", String.class);\n+\n+    /**\n+     * The maximum number of connections that will be pooled by the HTTP client.\n+     */\n+    public static final SdkMetric<Integer> MAX_CONNECTIONS = metric(\"MaxConnections\", Integer.class);", "originalCommit": "cac6868c4eb2bbe12921122ac54f2883fc2fe00a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ5OTY2MA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1863#discussion_r431499660", "bodyText": "Yeah I think we should create additional metrics for H2 specific things; perhaps per-connection metrics?", "author": "dagnir", "createdAt": "2020-05-27T23:30:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ2MjUzNw=="}], "type": "inlineReview", "revised_code": {"commit": "69e0b3c38cc87fa68d2dac3764146167f9d1b3be", "chunk": "diff --git a/http-client-spi/src/main/java/software/amazon/awssdk/http/HttpMetrics.java b/http-client-spi/src/main/java/software/amazon/awssdk/http/HttpMetric.java\nsimilarity index 87%\nrename from http-client-spi/src/main/java/software/amazon/awssdk/http/HttpMetrics.java\nrename to http-client-spi/src/main/java/software/amazon/awssdk/http/HttpMetric.java\nindex 7382629a3c..36cdfc6de3 100644\n--- a/http-client-spi/src/main/java/software/amazon/awssdk/http/HttpMetrics.java\n+++ b/http-client-spi/src/main/java/software/amazon/awssdk/http/HttpMetric.java\n\n@@ -15,13 +15,15 @@\n \n package software.amazon.awssdk.http;\n \n+import software.amazon.awssdk.annotations.SdkPublicApi;\n import software.amazon.awssdk.metrics.MetricCategory;\n import software.amazon.awssdk.metrics.SdkMetric;\n \n /**\n  * Metrics collected by HTTP clients.\n  */\n-public final class HttpMetrics {\n+@SdkPublicApi\n+public final class HttpMetric {\n     /**\n      * The name of the HTTP client.\n      */\n"}}, {"oid": "69e0b3c38cc87fa68d2dac3764146167f9d1b3be", "url": "https://github.com/aws/aws-sdk-java-v2/commit/69e0b3c38cc87fa68d2dac3764146167f9d1b3be", "message": "Add apache HTTP request stats", "committedDate": "2020-05-28T23:41:30Z", "type": "commit"}, {"oid": "69e0b3c38cc87fa68d2dac3764146167f9d1b3be", "url": "https://github.com/aws/aws-sdk-java-v2/commit/69e0b3c38cc87fa68d2dac3764146167f9d1b3be", "message": "Add apache HTTP request stats", "committedDate": "2020-05-28T23:41:30Z", "type": "forcePushed"}]}