{"pr_number": 1995, "pr_title": "Make STSCredentialsProvider prefetch and stale times configurable", "pr_createdAt": "2020-08-21T03:14:49Z", "pr_url": "https://github.com/aws/aws-sdk-java-v2/pull/1995", "timeline": [{"oid": "420cf6cccf2b6f35612009c9bbb20764d2c716d6", "url": "https://github.com/aws/aws-sdk-java-v2/commit/420cf6cccf2b6f35612009c9bbb20764d2c716d6", "message": "Make STSCredentialsProvider prefetch and stale times configurable", "committedDate": "2020-08-21T02:29:03Z", "type": "forcePushed"}, {"oid": "462e891e39e96406a18dd8896a641e3a21143f76", "url": "https://github.com/aws/aws-sdk-java-v2/commit/462e891e39e96406a18dd8896a641e3a21143f76", "message": "Make STSCredentialsProvider prefetch and stale times configurable", "committedDate": "2020-09-11T17:26:12Z", "type": "forcePushed"}, {"oid": "b6a51b3b2ce330b0eab1cc7745053978348832fe", "url": "https://github.com/aws/aws-sdk-java-v2/commit/b6a51b3b2ce330b0eab1cc7745053978348832fe", "message": "Make STSCredentialsProvider prefetch and stale times configurable", "committedDate": "2020-09-11T19:25:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg2NDY2Ng==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1995#discussion_r488864666", "bodyText": "Small typo here in 'minutes'.", "author": "bmaizels", "createdAt": "2020-09-15T18:05:59Z", "path": "services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java", "diffHunk": "@@ -127,6 +142,30 @@ public B asyncCredentialUpdateEnabled(Boolean asyncCredentialUpdateEnabled) {\n             return (B) this;\n         }\n \n+        /**\n+         * Configure the amount of time, relative to STS token expiration, that a new STS token should be fetched synchronously.\n+         *\n+         * <p>By default, this is 1 minute.</p>\n+         */\n+        @SuppressWarnings(\"unchecked\")\n+        public B staleTime(Duration staleTime) {\n+            this.staleTime = staleTime;\n+            return (B) this;\n+        }\n+\n+        /**\n+         * Configure the amount of time, relative to STS token expiration, that a new STS token should be fetched asynchronously.\n+         * The value only applies if asyncCredentialUpdateEnabled is enabled.\n+         *\n+         * <p>By default, this is 5 minuts.</p>", "originalCommit": "b6a51b3b2ce330b0eab1cc7745053978348832fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkwMjk0NQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1995#discussion_r488902945", "bodyText": "Typo fixed and rebased to pick up changes to CHANGELOG.md", "author": "Helmsdown", "createdAt": "2020-09-15T19:07:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg2NDY2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "a735ba543e1c038e2581b976ce25173f34861867", "chunk": "diff --git a/services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java b/services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java\nindex b4634a1ca8..fa13e74c12 100644\n--- a/services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java\n+++ b/services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java\n\n@@ -157,7 +157,7 @@ abstract class StsCredentialsProvider implements AwsCredentialsProvider, SdkAuto\n          * Configure the amount of time, relative to STS token expiration, that a new STS token should be fetched asynchronously.\n          * The value only applies if asyncCredentialUpdateEnabled is enabled.\n          *\n-         * <p>By default, this is 5 minuts.</p>\n+         * <p>By default, this is 5 minutes.</p>\n          */\n         @SuppressWarnings(\"unchecked\")\n         public B prefetchTime(Duration prefetchTime) {\n"}}, {"oid": "a735ba543e1c038e2581b976ce25173f34861867", "url": "https://github.com/aws/aws-sdk-java-v2/commit/a735ba543e1c038e2581b976ce25173f34861867", "message": "Make STSCredentialsProvider prefetch and stale times configurable", "committedDate": "2020-09-15T19:07:05Z", "type": "forcePushed"}, {"oid": "9931dc82e2a256654600d98c0a8fff0ba232bf9c", "url": "https://github.com/aws/aws-sdk-java-v2/commit/9931dc82e2a256654600d98c0a8fff0ba232bf9c", "message": "Make STSCredentialsProvider prefetch and stale times configurable", "committedDate": "2020-09-15T21:10:50Z", "type": "forcePushed"}, {"oid": "e1e851f999ec0ba8746eed49cdafc6eeec012201", "url": "https://github.com/aws/aws-sdk-java-v2/commit/e1e851f999ec0ba8746eed49cdafc6eeec012201", "message": "Make STSCredentialsProvider prefetch and stale times configurable", "committedDate": "2020-09-15T21:13:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk4MzQ1NA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1995#discussion_r488983454", "bodyText": "Can we change this to: Configure the amount of time, relative to STS token expiration, that the cached credentials are considered stale and should no longer be used. All threads will block until the value is updated.", "author": "bmaizels", "createdAt": "2020-09-15T21:28:30Z", "path": "services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java", "diffHunk": "@@ -127,6 +150,30 @@ public B asyncCredentialUpdateEnabled(Boolean asyncCredentialUpdateEnabled) {\n             return (B) this;\n         }\n \n+        /**\n+         * Configure the amount of time, relative to STS token expiration, that a new STS token should be fetched synchronously.", "originalCommit": "e1e851f999ec0ba8746eed49cdafc6eeec012201", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk4OTA0NQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1995#discussion_r488989045", "bodyText": "Done", "author": "Helmsdown", "createdAt": "2020-09-15T21:38:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk4MzQ1NA=="}], "type": "inlineReview", "revised_code": {"commit": "d1ed98feacef6555680aad8374d34be42f7ec843", "chunk": "diff --git a/services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java b/services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java\nindex 2a4cdaa0db..d18ec35f96 100644\n--- a/services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java\n+++ b/services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java\n\n@@ -151,7 +151,8 @@ abstract class StsCredentialsProvider implements AwsCredentialsProvider, SdkAuto\n         }\n \n         /**\n-         * Configure the amount of time, relative to STS token expiration, that a new STS token should be fetched synchronously.\n+         * Configure the amount of time, relative to STS token expiration, that the cached credentials are considered stale and should no longer be used.\n+         * All threads will block until the value is updated.\n          *\n          * <p>By default, this is 1 minute.</p>\n          */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk4NjUzNg==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1995#discussion_r488986536", "bodyText": "Can we change this to: Configure the amount of time, relative to STS token expiration, that the cached credentials are considered close to stale and should be updated. See {@link #asyncCredentialUpdateEnabled}.", "author": "bmaizels", "createdAt": "2020-09-15T21:35:15Z", "path": "services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java", "diffHunk": "@@ -127,6 +150,30 @@ public B asyncCredentialUpdateEnabled(Boolean asyncCredentialUpdateEnabled) {\n             return (B) this;\n         }\n \n+        /**\n+         * Configure the amount of time, relative to STS token expiration, that a new STS token should be fetched synchronously.\n+         *\n+         * <p>By default, this is 1 minute.</p>\n+         */\n+        @SuppressWarnings(\"unchecked\")\n+        public B staleTime(Duration staleTime) {\n+            this.staleTime = staleTime;\n+            return (B) this;\n+        }\n+\n+        /**\n+         * Configure the amount of time, relative to STS token expiration, that a new STS token should be fetched asynchronously.\n+         * The value only applies if asyncCredentialUpdateEnabled is enabled.", "originalCommit": "e1e851f999ec0ba8746eed49cdafc6eeec012201", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk4OTE2OQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1995#discussion_r488989169", "bodyText": "Done", "author": "Helmsdown", "createdAt": "2020-09-15T21:38:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk4NjUzNg=="}], "type": "inlineReview", "revised_code": {"commit": "d1ed98feacef6555680aad8374d34be42f7ec843", "chunk": "diff --git a/services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java b/services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java\nindex 2a4cdaa0db..d18ec35f96 100644\n--- a/services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java\n+++ b/services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java\n\n@@ -151,7 +151,8 @@ abstract class StsCredentialsProvider implements AwsCredentialsProvider, SdkAuto\n         }\n \n         /**\n-         * Configure the amount of time, relative to STS token expiration, that a new STS token should be fetched synchronously.\n+         * Configure the amount of time, relative to STS token expiration, that the cached credentials are considered stale and should no longer be used.\n+         * All threads will block until the value is updated.\n          *\n          * <p>By default, this is 1 minute.</p>\n          */\n"}}, {"oid": "d1ed98feacef6555680aad8374d34be42f7ec843", "url": "https://github.com/aws/aws-sdk-java-v2/commit/d1ed98feacef6555680aad8374d34be42f7ec843", "message": "Make STSCredentialsProvider prefetch and stale times configurable", "committedDate": "2020-09-15T21:37:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk5NDU2OA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1995#discussion_r488994568", "bodyText": "Can we add javadoc: The amount of time, relative to STS token expiration, that the cached credentials are considered stale and should no longer be used. All threads will block until the value is updated.", "author": "bmaizels", "createdAt": "2020-09-15T21:44:20Z", "path": "services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java", "diffHunk": "@@ -83,6 +96,14 @@ public void close() {\n         sessionCache.close();\n     }\n \n+    public Duration staleTime() {", "originalCommit": "d1ed98feacef6555680aad8374d34be42f7ec843", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTAwMTkyOQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1995#discussion_r489001929", "bodyText": "Done", "author": "Helmsdown", "createdAt": "2020-09-15T21:53:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk5NDU2OA=="}], "type": "inlineReview", "revised_code": {"commit": "720c5bc4af74224b706761983349147ed4a512b3", "chunk": "diff --git a/services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java b/services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java\nindex d18ec35f96..ccb0d26f86 100644\n--- a/services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java\n+++ b/services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java\n\n@@ -96,10 +96,17 @@ abstract class StsCredentialsProvider implements AwsCredentialsProvider, SdkAuto\n         sessionCache.close();\n     }\n \n+    /**\n+     * The amount of time, relative to STS token expiration, that the cached credentials are considered stale and should no longer be used.\n+     * All threads will block until the value is updated.\n+     */\n     public Duration staleTime() {\n         return staleTime;\n     }\n \n+    /**\n+     * The amount of time, relative to STS token expiration, that the cached credentials are considered close to stale and should be updated.\n+     */\n     public Duration prefetchTime() {\n         return prefetchTime;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk5NDg5MQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1995#discussion_r488994891", "bodyText": "Can we add javadoc: The amount of time, relative to STS token expiration, that the cached credentials are considered close to stale and should be updated.", "author": "bmaizels", "createdAt": "2020-09-15T21:44:45Z", "path": "services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java", "diffHunk": "@@ -83,6 +96,14 @@ public void close() {\n         sessionCache.close();\n     }\n \n+    public Duration staleTime() {\n+        return staleTime;\n+    }\n+\n+    public Duration prefetchTime() {", "originalCommit": "d1ed98feacef6555680aad8374d34be42f7ec843", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTAwMTk5OQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1995#discussion_r489001999", "bodyText": "Done", "author": "Helmsdown", "createdAt": "2020-09-15T21:53:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk5NDg5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "720c5bc4af74224b706761983349147ed4a512b3", "chunk": "diff --git a/services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java b/services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java\nindex d18ec35f96..ccb0d26f86 100644\n--- a/services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java\n+++ b/services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java\n\n@@ -96,10 +96,17 @@ abstract class StsCredentialsProvider implements AwsCredentialsProvider, SdkAuto\n         sessionCache.close();\n     }\n \n+    /**\n+     * The amount of time, relative to STS token expiration, that the cached credentials are considered stale and should no longer be used.\n+     * All threads will block until the value is updated.\n+     */\n     public Duration staleTime() {\n         return staleTime;\n     }\n \n+    /**\n+     * The amount of time, relative to STS token expiration, that the cached credentials are considered close to stale and should be updated.\n+     */\n     public Duration prefetchTime() {\n         return prefetchTime;\n     }\n"}}, {"oid": "720c5bc4af74224b706761983349147ed4a512b3", "url": "https://github.com/aws/aws-sdk-java-v2/commit/720c5bc4af74224b706761983349147ed4a512b3", "message": "Make STSCredentialsProvider prefetch and stale times configurable", "committedDate": "2020-09-15T21:52:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTAzMDkwMw==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1995#discussion_r489030903", "bodyText": "Can we change this to : private static final Duration DEFAULT_STALE_TIME = Duration.ofMinutes(1);", "author": "bmaizels", "createdAt": "2020-09-15T22:29:19Z", "path": "services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java", "diffHunk": "@@ -40,6 +42,10 @@\n @ThreadSafe\n @SdkInternalApi\n abstract class StsCredentialsProvider implements AwsCredentialsProvider, SdkAutoCloseable {\n+\n+    private static Duration DEFAULT_STALE_TIME = Duration.ofMinutes(1);", "originalCommit": "720c5bc4af74224b706761983349147ed4a512b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTAzNjM1MA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1995#discussion_r489036350", "bodyText": "No worries. In my head it was final. Pushed", "author": "Helmsdown", "createdAt": "2020-09-15T22:36:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTAzMDkwMw=="}], "type": "inlineReview", "revised_code": {"commit": "59d985a4aa7139cca14dd6789dd8e12457df5f30", "chunk": "diff --git a/services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java b/services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java\nindex ccb0d26f86..01acd2a81d 100644\n--- a/services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java\n+++ b/services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java\n\n@@ -43,8 +43,8 @@ import software.amazon.awssdk.utils.cache.RefreshResult;\n @SdkInternalApi\n abstract class StsCredentialsProvider implements AwsCredentialsProvider, SdkAutoCloseable {\n \n-    private static Duration DEFAULT_STALE_TIME = Duration.ofMinutes(1);\n-    private static Duration DEFAULT_PREFETCH_TIME = Duration.ofMinutes(5);\n+    private static final Duration DEFAULT_STALE_TIME = Duration.ofMinutes(1);\n+    private static final Duration DEFAULT_PREFETCH_TIME = Duration.ofMinutes(5);\n \n     /**\n      * The STS client that should be used for periodically updating the session credentials in the background.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTAzMTE0NQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1995#discussion_r489031145", "bodyText": "Can we change this to: private static final Duration DEFAULT_PREFETCH_TIME = Duration.ofMinutes(5);", "author": "bmaizels", "createdAt": "2020-09-15T22:29:40Z", "path": "services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java", "diffHunk": "@@ -40,6 +42,10 @@\n @ThreadSafe\n @SdkInternalApi\n abstract class StsCredentialsProvider implements AwsCredentialsProvider, SdkAutoCloseable {\n+\n+    private static Duration DEFAULT_STALE_TIME = Duration.ofMinutes(1);\n+    private static Duration DEFAULT_PREFETCH_TIME = Duration.ofMinutes(5);", "originalCommit": "720c5bc4af74224b706761983349147ed4a512b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTAzNjQyOQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1995#discussion_r489036429", "bodyText": "Done", "author": "Helmsdown", "createdAt": "2020-09-15T22:36:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTAzMTE0NQ=="}], "type": "inlineReview", "revised_code": {"commit": "59d985a4aa7139cca14dd6789dd8e12457df5f30", "chunk": "diff --git a/services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java b/services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java\nindex ccb0d26f86..01acd2a81d 100644\n--- a/services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java\n+++ b/services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java\n\n@@ -43,8 +43,8 @@ import software.amazon.awssdk.utils.cache.RefreshResult;\n @SdkInternalApi\n abstract class StsCredentialsProvider implements AwsCredentialsProvider, SdkAutoCloseable {\n \n-    private static Duration DEFAULT_STALE_TIME = Duration.ofMinutes(1);\n-    private static Duration DEFAULT_PREFETCH_TIME = Duration.ofMinutes(5);\n+    private static final Duration DEFAULT_STALE_TIME = Duration.ofMinutes(1);\n+    private static final Duration DEFAULT_PREFETCH_TIME = Duration.ofMinutes(5);\n \n     /**\n      * The STS client that should be used for periodically updating the session credentials in the background.\n"}}, {"oid": "59d985a4aa7139cca14dd6789dd8e12457df5f30", "url": "https://github.com/aws/aws-sdk-java-v2/commit/59d985a4aa7139cca14dd6789dd8e12457df5f30", "message": "Make STSCredentialsProvider prefetch and stale times configurable", "committedDate": "2020-09-15T22:36:10Z", "type": "commit"}, {"oid": "59d985a4aa7139cca14dd6789dd8e12457df5f30", "url": "https://github.com/aws/aws-sdk-java-v2/commit/59d985a4aa7139cca14dd6789dd8e12457df5f30", "message": "Make STSCredentialsProvider prefetch and stale times configurable", "committedDate": "2020-09-15T22:36:10Z", "type": "forcePushed"}]}