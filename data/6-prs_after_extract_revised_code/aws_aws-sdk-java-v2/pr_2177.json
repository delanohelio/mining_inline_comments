{"pr_number": 2177, "pr_title": "Fixing Integration Test failure for cancelledSubscription_doesNotCall\u2026", "pr_createdAt": "2020-12-02T06:27:40Z", "pr_url": "https://github.com/aws/aws-sdk-java-v2/pull/2177", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUxOTc5Ng==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2177#discussion_r534519796", "bodyText": "As discussed offline, we'll remove the terminalMethodsCalled.set(true) from onComplete because with the latest change, onComplete will be invoked. We will also add an assertion to verify onComplete is invoked.\nIn addition, we should add a Thread.sleep(1000) before assertThat(terminalMethodsCalled).isFalse(); because onComplete and complete is called by another thread. Adding the sleep will avoid the race condition.", "author": "zoewangg", "createdAt": "2020-12-02T22:18:55Z", "path": "services/kinesis/src/it/java/software/amazon/awssdk/services/kinesis/SubscribeToShardIntegrationTest.java", "diffHunk": "@@ -162,14 +162,18 @@ public void responseReceived(SubscribeToShardResponse response) {\n                                          @Override\n                                          public void onEventStream(SdkPublisher<SubscribeToShardEventStream> publisher) {\n                                              publisher.limit(3).subscribe(new Subscriber<SubscribeToShardEventStream>() {\n+                                                 private Subscription subscription;\n                                                  @Override\n                                                  public void onSubscribe(Subscription subscription) {\n-                                                     subscription.request(10);\n+                                                     this.subscription = subscription;\n+                                                     subscription.request(1);\n                                                  }\n \n                                                  @Override\n                                                  public void onNext(SubscribeToShardEventStream subscribeToShardEventStream) {\n                                                      events.add(subscribeToShardEventStream);\n+                                                     //Cancel on first event.\n+                                                     subscription.cancel();\n                                                  }\n \n                                                  @Override", "originalCommit": "8992d43718df10fdcdd04675870b70c0547787b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU5ODI2Nw==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2177#discussion_r535598267", "bodyText": "Added new Test case and added new flags completeMethodOfHandlerCalled and completeMethodOfHandlerCalled to avoid confusion.", "author": "joviegas", "createdAt": "2020-12-03T20:52:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUxOTc5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "efdaa1a4ff8db27108ec5727f56f30258aba8804", "chunk": "diff --git a/services/kinesis/src/it/java/software/amazon/awssdk/services/kinesis/SubscribeToShardIntegrationTest.java b/services/kinesis/src/it/java/software/amazon/awssdk/services/kinesis/SubscribeToShardIntegrationTest.java\nindex 28a3726d7c..d3171bf374 100644\n--- a/services/kinesis/src/it/java/software/amazon/awssdk/services/kinesis/SubscribeToShardIntegrationTest.java\n+++ b/services/kinesis/src/it/java/software/amazon/awssdk/services/kinesis/SubscribeToShardIntegrationTest.java\n\n@@ -166,7 +234,7 @@ public class SubscribeToShardIntegrationTest extends AbstractTestCase {\n                                                  @Override\n                                                  public void onSubscribe(Subscription subscription) {\n                                                      this.subscription = subscription;\n-                                                     subscription.request(1);\n+                                                     subscription.request(10);\n                                                  }\n \n                                                  @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM3MjkyNQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2177#discussion_r536372925", "bodyText": "Duplicate line. Do you mean assertThat(onCompleteSubsMethodsCalled).isTrue()?", "author": "zoewangg", "createdAt": "2020-12-04T20:52:41Z", "path": "services/kinesis/src/it/java/software/amazon/awssdk/services/kinesis/SubscribeToShardIntegrationTest.java", "diffHunk": "@@ -146,8 +147,75 @@ public void subscribeToShard_ReceivesAllData() {\n     }\n \n     @Test\n-    public void cancelledSubscription_doesNotCallTerminalMethods() {\n-        AtomicBoolean terminalMethodsCalled = new AtomicBoolean(false);\n+    public void limitedSubscription_callCompleteMethodOfSubs_whenLimitsReached() {\n+        AtomicBoolean onCompleteSubsMethodsCalled = new AtomicBoolean(false);\n+        AtomicBoolean completeMethodOfHandlerCalled = new AtomicBoolean(false);\n+        AtomicBoolean errorOccurred = new AtomicBoolean(false);\n+        List<SubscribeToShardEventStream> events = new ArrayList<>();\n+        asyncClient.subscribeToShard(r -> r.consumerARN(consumerArn)\n+                        .shardId(shardId)\n+                        .startingPosition(s -> s.type(ShardIteratorType.LATEST)),\n+                new SubscribeToShardResponseHandler() {\n+                    @Override\n+                    public void responseReceived(SubscribeToShardResponse response) {\n+                        verifyHttpMetadata(response);\n+                    }\n+\n+                    @Override\n+                    public void onEventStream(SdkPublisher<SubscribeToShardEventStream> publisher) {\n+                        publisher.limit(3).subscribe(new Subscriber<SubscribeToShardEventStream>() {\n+                            private Subscription subscription;\n+                            @Override\n+                            public void onSubscribe(Subscription subscription) {\n+                                this.subscription = subscription;\n+                                subscription.request(10);\n+                            }\n+\n+                            @Override\n+                            public void onNext(SubscribeToShardEventStream subscribeToShardEventStream) {\n+                                events.add(subscribeToShardEventStream);\n+                            }\n+\n+                            @Override\n+                            public void onError(Throwable throwable) {\n+                                errorOccurred.set(true);\n+                            }\n+\n+                            @Override\n+                            public void onComplete() {\n+                                onCompleteSubsMethodsCalled.set(true);\n+                            }\n+                        });\n+                    }\n+\n+                    @Override\n+                    public void exceptionOccurred(Throwable throwable) {\n+                        errorOccurred.set(true);\n+                    }\n+\n+                    @Override\n+                    public void complete() {\n+                        completeMethodOfHandlerCalled.set(true);\n+                    }\n+                }).join();\n+\n+        try {\n+            Thread.sleep(WAIT_TIME_FOR_SUBSCRIPTION_COMPLETION);\n+        } catch (InterruptedException e) {\n+            e.printStackTrace();\n+        }\n+\n+        assertThat(completeMethodOfHandlerCalled).isFalse();\n+        assertThat(completeMethodOfHandlerCalled).isFalse();", "originalCommit": "23c7f3d60c4517b6c356a54d1f5845f3be6007c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM5MzAxOA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2177#discussion_r536393018", "bodyText": "Good Catch !...yeap it should have been assertThat(onCompleteSubsMethodsCalled).isTrue()\nThanks", "author": "joviegas", "createdAt": "2020-12-04T21:35:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM3MjkyNQ=="}], "type": "inlineReview", "revised_code": {"commit": "efdaa1a4ff8db27108ec5727f56f30258aba8804", "chunk": "diff --git a/services/kinesis/src/it/java/software/amazon/awssdk/services/kinesis/SubscribeToShardIntegrationTest.java b/services/kinesis/src/it/java/software/amazon/awssdk/services/kinesis/SubscribeToShardIntegrationTest.java\nindex a568175da3..d3171bf374 100644\n--- a/services/kinesis/src/it/java/software/amazon/awssdk/services/kinesis/SubscribeToShardIntegrationTest.java\n+++ b/services/kinesis/src/it/java/software/amazon/awssdk/services/kinesis/SubscribeToShardIntegrationTest.java\n\n@@ -205,7 +205,7 @@ public class SubscribeToShardIntegrationTest extends AbstractTestCase {\n             e.printStackTrace();\n         }\n \n-        assertThat(completeMethodOfHandlerCalled).isFalse();\n+        assertThat(onCompleteSubsMethodsCalled).isTrue();\n         assertThat(completeMethodOfHandlerCalled).isFalse();\n         assertThat(errorOccurred).isFalse();\n         assertThat(events.size()).isEqualTo(3);\n"}}, {"oid": "efdaa1a4ff8db27108ec5727f56f30258aba8804", "url": "https://github.com/aws/aws-sdk-java-v2/commit/efdaa1a4ff8db27108ec5727f56f30258aba8804", "message": "Fixing Integration Test failure for cancelledSubscription_doesNotCallTerminalMethods", "committedDate": "2020-12-04T21:33:56Z", "type": "commit"}]}