{"pr_number": 1673, "pr_title": "Fix overflow bugs in backoff strategy.", "pr_createdAt": "2020-02-27T22:14:56Z", "pr_url": "https://github.com/aws/aws-sdk-java-v2/pull/1673", "timeline": [{"oid": "0b1606c3b3015d0bd00405c2d7ebe3e3ee53cdae", "url": "https://github.com/aws/aws-sdk-java-v2/commit/0b1606c3b3015d0bd00405c2d7ebe3e3ee53cdae", "message": "Fix overflow bugs in backoff strategy.", "committedDate": "2020-02-28T00:34:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ1OTA5OQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1673#discussion_r385459099", "bodyText": "Javadoc this", "author": "spfink", "createdAt": "2020-02-28T01:09:56Z", "path": "core/sdk-core/src/main/java/software/amazon/awssdk/core/retry/backoff/BackoffStrategy.java", "diffHunk": "@@ -24,6 +24,8 @@\n @FunctionalInterface\n public interface BackoffStrategy {\n \n+    int RETRIES_ATTEMPTED_CEILING = (int) Math.floor(Math.log(Integer.MAX_VALUE) / Math.log(2));", "originalCommit": "0b1606c3b3015d0bd00405c2d7ebe3e3ee53cdae", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3e89194e3f52c358e573c963ab8136c4fa6cb39f", "chunk": "diff --git a/core/sdk-core/src/main/java/software/amazon/awssdk/core/retry/backoff/BackoffStrategy.java b/core/sdk-core/src/main/java/software/amazon/awssdk/core/retry/backoff/BackoffStrategy.java\nindex f99113512c..bdce5c6084 100644\n--- a/core/sdk-core/src/main/java/software/amazon/awssdk/core/retry/backoff/BackoffStrategy.java\n+++ b/core/sdk-core/src/main/java/software/amazon/awssdk/core/retry/backoff/BackoffStrategy.java\n\n@@ -24,6 +24,10 @@ import software.amazon.awssdk.core.retry.RetryPolicyContext;\n @FunctionalInterface\n public interface BackoffStrategy {\n \n+    /**\n+     * Max permitted retry times. To prevent exponentialDelay from overflow, there must be 2 ^ retriesAttempted\n+     * <= 2 ^ 31 - 1, which means retriesAttempted <= 30, so that is the ceil for retriesAttempted.\n+     */\n     int RETRIES_ATTEMPTED_CEILING = (int) Math.floor(Math.log(Integer.MAX_VALUE) / Math.log(2));\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ1OTI0OA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1673#discussion_r385459248", "bodyText": "You should pull in our style template as this is incorrect", "author": "spfink", "createdAt": "2020-02-28T01:10:26Z", "path": "core/sdk-core/src/main/java/software/amazon/awssdk/core/retry/backoff/BackoffStrategy.java", "diffHunk": "@@ -33,21 +35,22 @@\n     Duration computeDelayBeforeNextRetry(RetryPolicyContext context);\n \n     default int calculateExponentialDelay(int retriesAttempted, Duration baseDelay, Duration maxBackoffTime) {\n-        return (int) Math.min((1L << retriesAttempted) * baseDelay.toMillis(), maxBackoffTime.toMillis());\n+        int cappedRetries = Math.min(retriesAttempted, RETRIES_ATTEMPTED_CEILING);\n+        return (int) Math.min(baseDelay.multipliedBy(1L << cappedRetries).toMillis(), maxBackoffTime.toMillis());\n     }\n \n     static BackoffStrategy defaultStrategy() {\n         return FullJitterBackoffStrategy.builder()\n-                                        .baseDelay(SdkDefaultRetrySetting.BASE_DELAY)\n-                                        .maxBackoffTime(SdkDefaultRetrySetting.MAX_BACKOFF)\n-                                        .build();\n+                .baseDelay(SdkDefaultRetrySetting.BASE_DELAY)", "originalCommit": "0b1606c3b3015d0bd00405c2d7ebe3e3ee53cdae", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3e89194e3f52c358e573c963ab8136c4fa6cb39f", "chunk": "diff --git a/core/sdk-core/src/main/java/software/amazon/awssdk/core/retry/backoff/BackoffStrategy.java b/core/sdk-core/src/main/java/software/amazon/awssdk/core/retry/backoff/BackoffStrategy.java\nindex f99113512c..bdce5c6084 100644\n--- a/core/sdk-core/src/main/java/software/amazon/awssdk/core/retry/backoff/BackoffStrategy.java\n+++ b/core/sdk-core/src/main/java/software/amazon/awssdk/core/retry/backoff/BackoffStrategy.java\n\n@@ -41,16 +45,16 @@ public interface BackoffStrategy {\n \n     static BackoffStrategy defaultStrategy() {\n         return FullJitterBackoffStrategy.builder()\n-                .baseDelay(SdkDefaultRetrySetting.BASE_DELAY)\n-                .maxBackoffTime(SdkDefaultRetrySetting.MAX_BACKOFF)\n-                .build();\n+                                        .baseDelay(SdkDefaultRetrySetting.BASE_DELAY)\n+                                        .maxBackoffTime(SdkDefaultRetrySetting.MAX_BACKOFF)\n+                                        .build();\n     }\n \n     static BackoffStrategy defaultThrottlingStrategy() {\n         return EqualJitterBackoffStrategy.builder()\n-                .baseDelay(SdkDefaultRetrySetting.THROTTLED_BASE_DELAY)\n-                .maxBackoffTime(SdkDefaultRetrySetting.MAX_BACKOFF)\n-                .build();\n+                                        .baseDelay(SdkDefaultRetrySetting.THROTTLED_BASE_DELAY)\n+                                        .maxBackoffTime(SdkDefaultRetrySetting.MAX_BACKOFF)\n+                                        .build();\n     }\n \n     static BackoffStrategy none() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ1OTQ0OA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1673#discussion_r385459448", "bodyText": "Take a look at some of our existing tests and rename these to match our pattern", "author": "spfink", "createdAt": "2020-02-28T01:11:05Z", "path": "core/sdk-core/src/test/java/software/amazon/awssdk/core/retry/backoff/EqualJitterBackoffStrategyTest.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.core.retry.backoff;\n+\n+import org.junit.Test;\n+import org.mockito.Mock;\n+import software.amazon.awssdk.core.retry.RetryPolicyContext;\n+\n+import java.time.Duration;\n+import java.util.Random;\n+\n+import static org.hamcrest.Matchers.is;\n+import static org.junit.Assert.*;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+import static org.testng.Assert.assertThrows;\n+\n+public class EqualJitterBackoffStrategyTest {\n+\n+    private static final int RANDOM_RESULT = 12345;\n+    private static final Duration FIVE_DAYS = Duration.ofDays(5);\n+    private static final Duration MAX_DURATION = Duration.ofSeconds(Long.MAX_VALUE);\n+    private static final Duration ONE_SECOND = Duration.ofSeconds(1);\n+    private static final Duration ONE_NANO_SECOND = Duration.ofNanos(1);\n+    private static final int NANO_IN_MILLISECONDS = 1_000_000;\n+    private static final Duration NEGATIVE_ONE_SECOND = Duration.ofSeconds(-1);\n+\n+    @Mock\n+    private Random mockRandom = mock(Random.class);\n+\n+    @Test\n+    public void GIVEN_exponentialDelayAboveCeiling_THEN_return_JitteredCeiling() {", "originalCommit": "0b1606c3b3015d0bd00405c2d7ebe3e3ee53cdae", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3e89194e3f52c358e573c963ab8136c4fa6cb39f", "chunk": "diff --git a/core/sdk-core/src/test/java/software/amazon/awssdk/core/retry/backoff/EqualJitterBackoffStrategyTest.java b/core/sdk-core/src/test/java/software/amazon/awssdk/core/retry/backoff/EqualJitterBackoffStrategyTest.java\nindex bc3925107a..8e5723e140 100644\n--- a/core/sdk-core/src/test/java/software/amazon/awssdk/core/retry/backoff/EqualJitterBackoffStrategyTest.java\n+++ b/core/sdk-core/src/test/java/software/amazon/awssdk/core/retry/backoff/EqualJitterBackoffStrategyTest.java\n\n@@ -42,59 +42,59 @@ public class EqualJitterBackoffStrategyTest {\n     private Random mockRandom = mock(Random.class);\n \n     @Test\n-    public void GIVEN_exponentialDelayAboveCeiling_THEN_return_JitteredCeiling() {\n+    public void exponentialDelayOverflowWithMaxBackoffTest() {\n         test(FIVE_DAYS, MAX_DURATION, 3, Integer.MAX_VALUE);\n     }\n \n     @Test\n-    public void GIVEN_maxBaseDelay_THEN_return_JitteredCeiling() {\n+    public void exponentialDelayOverflowWithMaxBaseDelayTest() {\n         test(MAX_DURATION, MAX_DURATION, 1, Integer.MAX_VALUE);\n     }\n \n     @Test\n-    public void GIVEN_oneSecondMaxBackoff_THEN_return_JitteredOneSecond() {\n+    public void maxBaseDelayShortBackoffTest() {\n         test(MAX_DURATION, ONE_SECOND, 1, (int) ONE_SECOND.toMillis());\n     }\n \n     @Test\n-    public void GIVEN_exponentialDelayBelowCeiling_THEN_return_CorrectJitteredExponentialDelay() {\n+    public void normalConditionTest() {\n         test(ONE_SECOND, MAX_DURATION, 10, (1 << 10) * (int) ONE_SECOND.toMillis());\n     }\n \n     @Test\n-    public void GIVEN_oneNanoSecondMaxBackoff_THEN_return_JitteredZero() {\n+    public void tinyBackoffNormalRetriesTest() {\n         test(MAX_DURATION, ONE_NANO_SECOND, 10, 0);\n     }\n \n     @Test\n-    public void GIVEN_oneNanoSecondBaseDelay_THEN_return_CorrectJitteredExponentialDelay() {\n+    public void tinyBaseDelayNormalRetriesTest() {\n         test(ONE_NANO_SECOND, MAX_DURATION, 30,  (int) (1L << 30) / NANO_IN_MILLISECONDS);\n     }\n \n     @Test\n-    public void GIVEN_tooManyRetries_THEN_return_CorrectResultForCappedRetries() {\n+    public void tinyBaseDelayExtraRetriesTest() {\n         test(ONE_NANO_SECOND, MAX_DURATION, 100,\n                 (int) (1L << 30) / NANO_IN_MILLISECONDS); // RETRIES_ATTEMPTED_CEILING == 30\n     }\n \n     @Test\n-    public void GIVEN_tooManyRetriesWithMaxBaseDelay() {\n+    public void exponentialDelayOverflowWithExtraRetriesTest() {\n         test(MAX_DURATION, MAX_DURATION, 100, Integer.MAX_VALUE);\n     }\n \n     @Test\n-    public void GIVEN_oneNanoSecondExponentialDelay_THEN_returnJitteredZero() {\n+    public void tinyBaseDelayUnderflowTest() {\n         test(ONE_NANO_SECOND, MAX_DURATION, 0, 0);\n     }\n \n     @Test\n-    public void GIVEN_negativeBaseDelay_Then_throw() {\n+    public void negativeBaseDelayTest() {\n         assertThrows(IllegalArgumentException.class, () ->\n                 test(NEGATIVE_ONE_SECOND, MAX_DURATION, 1, 0));\n     }\n \n     @Test\n-    public void GIVEN_negativeMaxBackoff_Then_throw() {\n+    public void negativeBackoffTest() {\n         assertThrows(IllegalArgumentException.class, () ->\n                 test(ONE_SECOND, NEGATIVE_ONE_SECOND, 1, 0));\n     }\n"}}, {"oid": "3e89194e3f52c358e573c963ab8136c4fa6cb39f", "url": "https://github.com/aws/aws-sdk-java-v2/commit/3e89194e3f52c358e573c963ab8136c4fa6cb39f", "message": "Merge branch 'master' of https://github.com/aws/aws-sdk-java-v2 into backoff-overflow-fixing", "committedDate": "2020-02-28T06:26:47Z", "type": "forcePushed"}, {"oid": "0e723e512c60b46b1e7996c85582c699e11122b3", "url": "https://github.com/aws/aws-sdk-java-v2/commit/0e723e512c60b46b1e7996c85582c699e11122b3", "message": "Fix overflow bugs in backoff strategy.", "committedDate": "2020-02-28T06:37:44Z", "type": "forcePushed"}, {"oid": "cc88c19b83b5c21dcae1b545d452b2ed55e6d7dc", "url": "https://github.com/aws/aws-sdk-java-v2/commit/cc88c19b83b5c21dcae1b545d452b2ed55e6d7dc", "message": "Fix overflow bugs in backoff strategy.", "committedDate": "2020-02-29T00:20:18Z", "type": "commit"}, {"oid": "cc88c19b83b5c21dcae1b545d452b2ed55e6d7dc", "url": "https://github.com/aws/aws-sdk-java-v2/commit/cc88c19b83b5c21dcae1b545d452b2ed55e6d7dc", "message": "Fix overflow bugs in backoff strategy.", "committedDate": "2020-02-29T00:20:18Z", "type": "forcePushed"}, {"oid": "ee4a458609ce5eb3220faa331922395c3299c6d7", "url": "https://github.com/aws/aws-sdk-java-v2/commit/ee4a458609ce5eb3220faa331922395c3299c6d7", "message": "Merge branch 'master' into backoff-overflow-fixing", "committedDate": "2020-02-29T00:49:51Z", "type": "commit"}, {"oid": "f5f08dc154c07f196374808be7410f9c00d9be64", "url": "https://github.com/aws/aws-sdk-java-v2/commit/f5f08dc154c07f196374808be7410f9c00d9be64", "message": "Merge branch 'master' into backoff-overflow-fixing", "committedDate": "2020-03-02T19:04:57Z", "type": "commit"}]}