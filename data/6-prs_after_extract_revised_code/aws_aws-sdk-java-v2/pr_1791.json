{"pr_number": 1791, "pr_title": "Various performance improvements.", "pr_createdAt": "2020-04-24T20:54:24Z", "pr_url": "https://github.com/aws/aws-sdk-java-v2/pull/1791", "timeline": [{"oid": "e36c6c3c9a4285d7d6422259b6dd283713c589a8", "url": "https://github.com/aws/aws-sdk-java-v2/commit/e36c6c3c9a4285d7d6422259b6dd283713c589a8", "message": "Various performance improvements.", "committedDate": "2020-04-24T21:15:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg4NDM5Ng==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1791#discussion_r414884396", "bodyText": "NIT: it's easier to read if canonicalizeSigningHeaders is nearer to getCanonicalizedHeaderString and getSignedHeadersString. Found myself scrolling up and down.", "author": "cenedhryn", "createdAt": "2020-04-24T21:52:30Z", "path": "core/auth/src/main/java/software/amazon/awssdk/auth/signer/internal/AbstractAws4Signer.java", "diffHunk": "@@ -191,26 +204,42 @@ protected abstract void processRequestPayload(SdkHttpFullRequest.Builder mutable\n      * generate the canonical request.\n      */\n     private String createCanonicalRequest(SdkHttpFullRequest.Builder request,\n+                                          Map<String, List<String>> canonicalHeaders,\n+                                          String signedHeadersString,\n                                           String contentSha256,\n                                           boolean doubleUrlEncode) {\n-\n         String canonicalRequest = request.method().toString() +\n                                   SignerConstant.LINE_SEPARATOR +\n                                   // This would optionally double url-encode the resource path\n                                   getCanonicalizedResourcePath(request.encodedPath(), doubleUrlEncode) +\n                                   SignerConstant.LINE_SEPARATOR +\n                                   getCanonicalizedQueryString(request.rawQueryParameters()) +\n                                   SignerConstant.LINE_SEPARATOR +\n-                                  getCanonicalizedHeaderString(request.headers()) +\n+                                  getCanonicalizedHeaderString(canonicalHeaders) +\n                                   SignerConstant.LINE_SEPARATOR +\n-                                  getSignedHeadersString(request.headers()) +\n+                                  signedHeadersString +\n                                   SignerConstant.LINE_SEPARATOR +\n                                   contentSha256;\n \n         LOG.trace(() -> \"AWS4 Canonical Request: \" + canonicalRequest);\n         return canonicalRequest;\n     }\n \n+    private Map<String, List<String>> canonicalizeSigningHeaders(Map<String, List<String>> headers) {", "originalCommit": "e36c6c3c9a4285d7d6422259b6dd283713c589a8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDkwMDEzNg==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1791#discussion_r414900136", "bodyText": "Fixed!", "author": "millems", "createdAt": "2020-04-24T22:35:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg4NDM5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "1097bdaa9a866ea34e9679880339205f869ff6c7", "chunk": "diff --git a/core/auth/src/main/java/software/amazon/awssdk/auth/signer/internal/AbstractAws4Signer.java b/core/auth/src/main/java/software/amazon/awssdk/auth/signer/internal/AbstractAws4Signer.java\nindex ea98ce7e4b..0c4632c406 100644\n--- a/core/auth/src/main/java/software/amazon/awssdk/auth/signer/internal/AbstractAws4Signer.java\n+++ b/core/auth/src/main/java/software/amazon/awssdk/auth/signer/internal/AbstractAws4Signer.java\n\n@@ -225,21 +225,6 @@ public abstract class AbstractAws4Signer<T extends Aws4SignerParams, U extends A\n         return canonicalRequest;\n     }\n \n-    private Map<String, List<String>> canonicalizeSigningHeaders(Map<String, List<String>> headers) {\n-        Map<String, List<String>> result = new TreeMap<>();\n-\n-        for (Map.Entry<String, List<String>> header : headers.entrySet()) {\n-            String lowerCaseHeader = lowerCase(header.getKey());\n-            if (LIST_OF_HEADERS_TO_IGNORE_IN_LOWER_CASE.contains(lowerCaseHeader)) {\n-                continue;\n-            }\n-\n-            result.computeIfAbsent(lowerCaseHeader, x -> new ArrayList<>()).addAll(header.getValue());\n-        }\n-\n-        return result;\n-    }\n-\n     /**\n      * Step 2 of the AWS Signature version 4 calculation. Refer to\n      * http://docs.aws\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg5MTYyOA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1791#discussion_r414891628", "bodyText": "Substance over beauty!", "author": "cenedhryn", "createdAt": "2020-04-24T22:11:26Z", "path": "http-client-spi/src/main/java/software/amazon/awssdk/http/DefaultSdkHttpFullRequest.java", "diffHunk": "@@ -172,12 +169,35 @@ public String toString() {\n         private String host;\n         private Integer port;\n         private String path;\n-        private Map<String, List<String>> queryParameters = new LinkedHashMap<>();\n+\n+        private boolean queryParametersAreFromToBuilder;\n+        private Map<String, List<String>> queryParameters;\n+\n         private SdkHttpMethod httpMethod;\n-        private Map<String, List<String>> headers = new LinkedHashMap<>();\n+\n+        private boolean headersAreFromToBuilder;\n+        private Map<String, List<String>> headers;\n+\n         private ContentStreamProvider contentStreamProvider;\n \n         Builder() {\n+            queryParameters = new LinkedHashMap<>();\n+            queryParametersAreFromToBuilder = false;", "originalCommit": "e36c6c3c9a4285d7d6422259b6dd283713c589a8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg5OTU1NA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1791#discussion_r414899554", "bodyText": "Hah, I wrote a class to do this originally, but it just made things harder to read. If we find ourselves doing this a lot we can put it somewhere else...", "author": "millems", "createdAt": "2020-04-24T22:33:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg5MTYyOA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "1097bdaa9a866ea34e9679880339205f869ff6c7", "url": "https://github.com/aws/aws-sdk-java-v2/commit/1097bdaa9a866ea34e9679880339205f869ff6c7", "message": "Various performance improvements.", "committedDate": "2020-04-24T22:34:52Z", "type": "commit"}, {"oid": "1097bdaa9a866ea34e9679880339205f869ff6c7", "url": "https://github.com/aws/aws-sdk-java-v2/commit/1097bdaa9a866ea34e9679880339205f869ff6c7", "message": "Various performance improvements.", "committedDate": "2020-04-24T22:34:52Z", "type": "forcePushed"}]}