{"pr_number": 1692, "pr_title": "Upgrade Netty version to 4.1.46.Final", "pr_createdAt": "2020-03-06T21:37:29Z", "pr_url": "https://github.com/aws/aws-sdk-java-v2/pull/1692", "timeline": [{"oid": "0a416a3743967607e560f74c2e2449fab9bd8003", "url": "https://github.com/aws/aws-sdk-java-v2/commit/0a416a3743967607e560f74c2e2449fab9bd8003", "message": "Upgrade Netty version to 4.1.46.Final", "committedDate": "2020-03-06T21:53:45Z", "type": "forcePushed"}, {"oid": "0dae562898b869ef0fafce40f6dc24b2344cef34", "url": "https://github.com/aws/aws-sdk-java-v2/commit/0dae562898b869ef0fafce40f6dc24b2344cef34", "message": "Merge branch 'master' into netty-upgrade", "committedDate": "2020-03-11T02:49:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTExNzg4Nw==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1692#discussion_r391117887", "bodyText": "Can we delegate instead of copy+paste?", "author": "millems", "createdAt": "2020-03-11T16:54:02Z", "path": "http-clients/netty-nio-client/src/test/java/software/amazon/awssdk/http/nio/netty/fault/GoAwayTest.java", "diffHunk": "@@ -97,6 +97,21 @@ public void goAwayCanCloseAllStreams() throws InterruptedException {\n \n         CountDownLatch allRequestsReceived = new CountDownLatch(2);\n         Supplier<Http2FrameListener> frameListenerSupplier = () -> new TestFrameListener() {\n+            @Override\n+            public void onHeadersRead(ChannelHandlerContext ctx, int streamId, Http2Headers headers, int padding, boolean endStream) {\n+                serverChannels.add(ctx.channel().id().asShortText());\n+\n+                Http2Headers outboundHeaders = new DefaultHttp2Headers()\n+                    .status(\"200\")\n+                    .add(\"content-type\", \"text/plain\")\n+                    .addInt(\"content-length\", 5);\n+\n+                frameWriter().writeHeaders(ctx, streamId, outboundHeaders, 0, false, ctx.newPromise());\n+                ctx.flush();\n+\n+                allRequestsReceived.countDown();\n+            }", "originalCommit": "0dae562898b869ef0fafce40f6dc24b2344cef34", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3705a466554d5058fe20ca41460bf46d61572451", "chunk": "diff --git a/http-clients/netty-nio-client/src/test/java/software/amazon/awssdk/http/nio/netty/fault/GoAwayTest.java b/http-clients/netty-nio-client/src/test/java/software/amazon/awssdk/http/nio/netty/fault/GoAwayTest.java\nindex 8a68a26943..d4ff052666 100644\n--- a/http-clients/netty-nio-client/src/test/java/software/amazon/awssdk/http/nio/netty/fault/GoAwayTest.java\n+++ b/http-clients/netty-nio-client/src/test/java/software/amazon/awssdk/http/nio/netty/fault/GoAwayTest.java\n\n@@ -99,21 +99,15 @@ public class GoAwayTest {\n         Supplier<Http2FrameListener> frameListenerSupplier = () -> new TestFrameListener() {\n             @Override\n             public void onHeadersRead(ChannelHandlerContext ctx, int streamId, Http2Headers headers, int padding, boolean endStream) {\n-                serverChannels.add(ctx.channel().id().asShortText());\n-\n-                Http2Headers outboundHeaders = new DefaultHttp2Headers()\n-                    .status(\"200\")\n-                    .add(\"content-type\", \"text/plain\")\n-                    .addInt(\"content-length\", 5);\n-\n-                frameWriter().writeHeaders(ctx, streamId, outboundHeaders, 0, false, ctx.newPromise());\n-                ctx.flush();\n-\n-                allRequestsReceived.countDown();\n+                onHeadersReadDelegator(ctx, streamId);\n             }\n \n             @Override\n             public void onHeadersRead(ChannelHandlerContext ctx, int streamId, Http2Headers headers, int streamDependency, short weight, boolean exclusive, int padding, boolean endStream) {\n+                onHeadersReadDelegator(ctx, streamId);\n+            }\n+\n+            private void onHeadersReadDelegator(ChannelHandlerContext ctx, int streamId) {\n                 serverChannels.add(ctx.channel().id().asShortText());\n \n                 Http2Headers outboundHeaders = new DefaultHttp2Headers()\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTExODAyOQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1692#discussion_r391118029", "bodyText": "Can we delegate instead of copy+paste?", "author": "millems", "createdAt": "2020-03-11T16:54:17Z", "path": "http-clients/netty-nio-client/src/test/java/software/amazon/awssdk/http/nio/netty/fault/GoAwayTest.java", "diffHunk": "@@ -146,6 +161,12 @@ public void onHeadersRead(ChannelHandlerContext ctx, int streamId, Http2Headers\n     public void execute_goAwayReceived_existingChannelsNotReused() throws InterruptedException {\n         // Frame listener supplier for each connection\n         Supplier<Http2FrameListener> frameListenerSupplier = () -> new TestFrameListener() {\n+            @Override\n+            public void onHeadersRead(ChannelHandlerContext ctx, int streamId, Http2Headers headers, int padding, boolean endStream) {\n+                frameWriter().writeHeaders(ctx, streamId, new DefaultHttp2Headers().add(\"content-length\", \"0\").status(\"204\"), 0, true, ctx.newPromise());\n+                ctx.flush();\n+            }", "originalCommit": "0dae562898b869ef0fafce40f6dc24b2344cef34", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3705a466554d5058fe20ca41460bf46d61572451", "chunk": "diff --git a/http-clients/netty-nio-client/src/test/java/software/amazon/awssdk/http/nio/netty/fault/GoAwayTest.java b/http-clients/netty-nio-client/src/test/java/software/amazon/awssdk/http/nio/netty/fault/GoAwayTest.java\nindex 8a68a26943..d4ff052666 100644\n--- a/http-clients/netty-nio-client/src/test/java/software/amazon/awssdk/http/nio/netty/fault/GoAwayTest.java\n+++ b/http-clients/netty-nio-client/src/test/java/software/amazon/awssdk/http/nio/netty/fault/GoAwayTest.java\n\n@@ -163,12 +157,15 @@ public class GoAwayTest {\n         Supplier<Http2FrameListener> frameListenerSupplier = () -> new TestFrameListener() {\n             @Override\n             public void onHeadersRead(ChannelHandlerContext ctx, int streamId, Http2Headers headers, int padding, boolean endStream) {\n-                frameWriter().writeHeaders(ctx, streamId, new DefaultHttp2Headers().add(\"content-length\", \"0\").status(\"204\"), 0, true, ctx.newPromise());\n-                ctx.flush();\n+                onHeadersReadDelegator(ctx, streamId);\n             }\n \n             @Override\n             public void onHeadersRead(ChannelHandlerContext ctx, int streamId, Http2Headers headers, int streamDependency, short weight, boolean exclusive, int padding, boolean endStream) {\n+                onHeadersReadDelegator(ctx, streamId);\n+            }\n+\n+            private void onHeadersReadDelegator(ChannelHandlerContext ctx, int streamId) {\n                 frameWriter().writeHeaders(ctx, streamId, new DefaultHttp2Headers().add(\"content-length\", \"0\").status(\"204\"), 0, true, ctx.newPromise());\n                 ctx.flush();\n             }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTExODE3NQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1692#discussion_r391118175", "bodyText": "Can we delegate instead of copy+paste?", "author": "millems", "createdAt": "2020-03-11T16:54:29Z", "path": "http-clients/netty-nio-client/src/test/java/software/amazon/awssdk/http/nio/netty/fault/GoAwayTest.java", "diffHunk": "@@ -188,6 +209,27 @@ public void execute_goAwayReceived_lastStreamId_lowerStreamsNotClosed() throws I\n         CountDownLatch allRequestsReceived = new CountDownLatch(2);\n         byte[] getPayload = \"go away!\".getBytes(StandardCharsets.UTF_8);\n         Supplier<Http2FrameListener> frameListenerSupplier = () -> new TestFrameListener() {\n+            @Override\n+            public void onHeadersRead(ChannelHandlerContext ctx, int streamId, Http2Headers headers, int padding, boolean endStream) {\n+                channelToStreams.computeIfAbsent(ctx.channel().id().asShortText(), (k) -> Collections.newSetFromMap(new ConcurrentHashMap<>())).add(streamId);\n+\n+                if (streamId == 3) {\n+                    stream3Received.complete(null);\n+                }\n+\n+                if (streamId < 5) {\n+                    Http2Headers outboundHeaders = new DefaultHttp2Headers()\n+                        .status(\"200\")\n+                        .add(\"content-type\", \"text/plain\")\n+                        .addInt(\"content-length\", getPayload.length);\n+\n+                    frameWriter().writeHeaders(ctx, streamId, outboundHeaders, 0, false, ctx.newPromise());\n+                    ctx.flush();\n+                }\n+\n+                allRequestsReceived.countDown();\n+            }", "originalCommit": "0dae562898b869ef0fafce40f6dc24b2344cef34", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3705a466554d5058fe20ca41460bf46d61572451", "chunk": "diff --git a/http-clients/netty-nio-client/src/test/java/software/amazon/awssdk/http/nio/netty/fault/GoAwayTest.java b/http-clients/netty-nio-client/src/test/java/software/amazon/awssdk/http/nio/netty/fault/GoAwayTest.java\nindex 8a68a26943..d4ff052666 100644\n--- a/http-clients/netty-nio-client/src/test/java/software/amazon/awssdk/http/nio/netty/fault/GoAwayTest.java\n+++ b/http-clients/netty-nio-client/src/test/java/software/amazon/awssdk/http/nio/netty/fault/GoAwayTest.java\n\n@@ -211,27 +208,15 @@ public class GoAwayTest {\n         Supplier<Http2FrameListener> frameListenerSupplier = () -> new TestFrameListener() {\n             @Override\n             public void onHeadersRead(ChannelHandlerContext ctx, int streamId, Http2Headers headers, int padding, boolean endStream) {\n-                channelToStreams.computeIfAbsent(ctx.channel().id().asShortText(), (k) -> Collections.newSetFromMap(new ConcurrentHashMap<>())).add(streamId);\n-\n-                if (streamId == 3) {\n-                    stream3Received.complete(null);\n-                }\n-\n-                if (streamId < 5) {\n-                    Http2Headers outboundHeaders = new DefaultHttp2Headers()\n-                        .status(\"200\")\n-                        .add(\"content-type\", \"text/plain\")\n-                        .addInt(\"content-length\", getPayload.length);\n-\n-                    frameWriter().writeHeaders(ctx, streamId, outboundHeaders, 0, false, ctx.newPromise());\n-                    ctx.flush();\n-                }\n-\n-                allRequestsReceived.countDown();\n+                onHeadersReadDelegator(ctx, streamId);\n             }\n \n             @Override\n             public void onHeadersRead(ChannelHandlerContext ctx, int streamId, Http2Headers headers, int streamDependency, short weight, boolean exclusive, int padding, boolean endStream) {\n+                onHeadersReadDelegator(ctx, streamId);\n+            }\n+\n+            private void onHeadersReadDelegator(ChannelHandlerContext ctx, int streamId) {\n                 channelToStreams.computeIfAbsent(ctx.channel().id().asShortText(), (k) -> Collections.newSetFromMap(new ConcurrentHashMap<>())).add(streamId);\n \n                 if (streamId == 3) {\n"}}, {"oid": "3705a466554d5058fe20ca41460bf46d61572451", "url": "https://github.com/aws/aws-sdk-java-v2/commit/3705a466554d5058fe20ca41460bf46d61572451", "message": "Applied similar fix of Coral team to fix high failure problem", "committedDate": "2020-03-17T17:39:44Z", "type": "forcePushed"}, {"oid": "8681a2cfe9c206370b9a76a3d12ff17ecc79cb95", "url": "https://github.com/aws/aws-sdk-java-v2/commit/8681a2cfe9c206370b9a76a3d12ff17ecc79cb95", "message": "Upgrade Netty version to 4.1.46.Final and applied fix to solve failure problem", "committedDate": "2020-03-17T23:09:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE5NDQwNg==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1692#discussion_r395194406", "bodyText": "Can we add a comment here to explain why we are setting this?\nProbably something like this:\n// Use unpooled allocator to avoid increased heap memory usage from Netty 4.1.43. See https://github.com/netty/netty/issues/9768", "author": "zoewangg", "createdAt": "2020-03-19T17:22:34Z", "path": "http-clients/netty-nio-client/src/main/java/software/amazon/awssdk/http/nio/netty/internal/ChannelPipelineInitializer.java", "diffHunk": "@@ -94,6 +96,8 @@ public void channelCreated(Channel ch) {\n \n             pipeline.addLast(sslHandler);\n             pipeline.addLast(SslCloseCompletionEventHandler.getInstance());\n+", "originalCommit": "d1f335f8141d2e3d0ac1cd56b859898b55744ecd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "23aa2669a29fa0703dbcb803204b0b00dc94acb7", "chunk": "diff --git a/http-clients/netty-nio-client/src/main/java/software/amazon/awssdk/http/nio/netty/internal/ChannelPipelineInitializer.java b/http-clients/netty-nio-client/src/main/java/software/amazon/awssdk/http/nio/netty/internal/ChannelPipelineInitializer.java\nindex 17726e1adf..ba29a9872e 100644\n--- a/http-clients/netty-nio-client/src/main/java/software/amazon/awssdk/http/nio/netty/internal/ChannelPipelineInitializer.java\n+++ b/http-clients/netty-nio-client/src/main/java/software/amazon/awssdk/http/nio/netty/internal/ChannelPipelineInitializer.java\n\n@@ -97,7 +101,11 @@ public final class ChannelPipelineInitializer extends AbstractChannelPoolHandler\n             pipeline.addLast(sslHandler);\n             pipeline.addLast(SslCloseCompletionEventHandler.getInstance());\n \n-            ch.config().setOption(ChannelOption.ALLOCATOR, UnpooledByteBufAllocator.DEFAULT);\n+            // Use unpooled allocator to avoid increased heap memory usage from Netty 4.1.43.\n+            // See https://github.com/netty/netty/issues/9768\n+            if (sslProvider == SslProvider.JDK) {\n+                ch.config().setOption(ChannelOption.ALLOCATOR, UnpooledByteBufAllocator.DEFAULT);\n+            }\n         }\n \n         if (protocol == Protocol.HTTP2) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE5NzkyOQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1692#discussion_r395197929", "bodyText": "Should we only set this for JDK SsLProvider since the issue only affects customers using JDK SSL engine?", "author": "zoewangg", "createdAt": "2020-03-19T17:27:44Z", "path": "http-clients/netty-nio-client/src/main/java/software/amazon/awssdk/http/nio/netty/internal/ChannelPipelineInitializer.java", "diffHunk": "@@ -94,6 +96,8 @@ public void channelCreated(Channel ch) {\n \n             pipeline.addLast(sslHandler);\n             pipeline.addLast(SslCloseCompletionEventHandler.getInstance());\n+\n+            ch.config().setOption(ChannelOption.ALLOCATOR, UnpooledByteBufAllocator.DEFAULT);", "originalCommit": "d1f335f8141d2e3d0ac1cd56b859898b55744ecd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIxNjkyOQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1692#discussion_r395216929", "bodyText": "@dagnir @millems WDUT?", "author": "zoewangg", "createdAt": "2020-03-19T17:57:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE5NzkyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIyNTU0NQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1692#discussion_r395225545", "bodyText": "+1", "author": "dagnir", "createdAt": "2020-03-19T18:12:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE5NzkyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIyNTg5NQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1692#discussion_r395225895", "bodyText": "+1, smallest blast-radius is better. Easier to expand later if it causes problems.", "author": "millems", "createdAt": "2020-03-19T18:12:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE5NzkyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIyNjU5Ng==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1692#discussion_r395226596", "bodyText": "Got it, will do!", "author": "Quanzzzz", "createdAt": "2020-03-19T18:13:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE5NzkyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "23aa2669a29fa0703dbcb803204b0b00dc94acb7", "chunk": "diff --git a/http-clients/netty-nio-client/src/main/java/software/amazon/awssdk/http/nio/netty/internal/ChannelPipelineInitializer.java b/http-clients/netty-nio-client/src/main/java/software/amazon/awssdk/http/nio/netty/internal/ChannelPipelineInitializer.java\nindex 17726e1adf..ba29a9872e 100644\n--- a/http-clients/netty-nio-client/src/main/java/software/amazon/awssdk/http/nio/netty/internal/ChannelPipelineInitializer.java\n+++ b/http-clients/netty-nio-client/src/main/java/software/amazon/awssdk/http/nio/netty/internal/ChannelPipelineInitializer.java\n\n@@ -97,7 +101,11 @@ public final class ChannelPipelineInitializer extends AbstractChannelPoolHandler\n             pipeline.addLast(sslHandler);\n             pipeline.addLast(SslCloseCompletionEventHandler.getInstance());\n \n-            ch.config().setOption(ChannelOption.ALLOCATOR, UnpooledByteBufAllocator.DEFAULT);\n+            // Use unpooled allocator to avoid increased heap memory usage from Netty 4.1.43.\n+            // See https://github.com/netty/netty/issues/9768\n+            if (sslProvider == SslProvider.JDK) {\n+                ch.config().setOption(ChannelOption.ALLOCATOR, UnpooledByteBufAllocator.DEFAULT);\n+            }\n         }\n \n         if (protocol == Protocol.HTTP2) {\n"}}, {"oid": "23aa2669a29fa0703dbcb803204b0b00dc94acb7", "url": "https://github.com/aws/aws-sdk-java-v2/commit/23aa2669a29fa0703dbcb803204b0b00dc94acb7", "message": "Upgrade Netty version to 4.1.46.Final and applied fix to solve failure problem", "committedDate": "2020-03-19T18:35:07Z", "type": "commit"}, {"oid": "23aa2669a29fa0703dbcb803204b0b00dc94acb7", "url": "https://github.com/aws/aws-sdk-java-v2/commit/23aa2669a29fa0703dbcb803204b0b00dc94acb7", "message": "Upgrade Netty version to 4.1.46.Final and applied fix to solve failure problem", "committedDate": "2020-03-19T18:35:07Z", "type": "forcePushed"}, {"oid": "84f890e61140f8052df029f78c971aa6e998dd21", "url": "https://github.com/aws/aws-sdk-java-v2/commit/84f890e61140f8052df029f78c971aa6e998dd21", "message": "Merge branch 'master' into netty-upgrade", "committedDate": "2020-03-19T18:36:34Z", "type": "commit"}, {"oid": "d59325e1e7783567b8f066b966a79c910b91b422", "url": "https://github.com/aws/aws-sdk-java-v2/commit/d59325e1e7783567b8f066b966a79c910b91b422", "message": "Merge branch 'master' into netty-upgrade", "committedDate": "2020-03-20T17:19:02Z", "type": "commit"}, {"oid": "dc68d60cda0dee356f382ea9c78469de810ed29e", "url": "https://github.com/aws/aws-sdk-java-v2/commit/dc68d60cda0dee356f382ea9c78469de810ed29e", "message": "Merge branch 'master' into netty-upgrade", "committedDate": "2020-03-20T19:13:00Z", "type": "commit"}]}