{"pr_number": 7473, "pr_title": "[pulsar-broker] Cleanup already deleted namespace topics", "pr_createdAt": "2020-07-07T23:53:03Z", "pr_url": "https://github.com/apache/pulsar/pull/7473", "timeline": [{"oid": "570132d8f0ecc7c0523769abadb83c2c01be98de", "url": "https://github.com/apache/pulsar/commit/570132d8f0ecc7c0523769abadb83c2c01be98de", "message": "[pulsar-broker] Cleanup already deleted namespace topics", "committedDate": "2020-07-07T20:41:32Z", "type": "commit"}, {"oid": "972ae3e1d179ad491506302a230dddceaa9651f6", "url": "https://github.com/apache/pulsar/commit/972ae3e1d179ad491506302a230dddceaa9651f6", "message": "add error-codes", "committedDate": "2020-07-08T01:12:01Z", "type": "commit"}, {"oid": "972ae3e1d179ad491506302a230dddceaa9651f6", "url": "https://github.com/apache/pulsar/commit/972ae3e1d179ad491506302a230dddceaa9651f6", "message": "add error-codes", "committedDate": "2020-07-08T01:12:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTU4NjQxMg==", "url": "https://github.com/apache/pulsar/pull/7473#discussion_r451586412", "bodyText": "Since we're treating it as a \"success\" case here, another option would be to have the close request to return \"ok\" when closing a non-existing producer. what do you think?", "author": "merlimat", "createdAt": "2020-07-08T14:25:04Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentReplicator.java", "diffHunk": "@@ -760,11 +761,13 @@ private void checkReplicatedSubscriptionMarker(Position position, MessageImpl<?>\n         final CompletableFuture<Void> future = new CompletableFuture<>();\n \n         super.disconnect(failIfHasBacklog).thenRun(() -> {\n-            dispatchRateLimiter.ifPresent(DispatchRateLimiter::close);\n-            future.complete(null);\n+            cleanAfterDisconnect(future);\n         }).exceptionally(ex -> {\n             Throwable t = (ex instanceof CompletionException ? ex.getCause() : ex);\n-            if (t instanceof TopicBusyException == false) {\n+            if (t instanceof AlreadyClosedException) {\n+                cleanAfterDisconnect(future);", "originalCommit": "972ae3e1d179ad491506302a230dddceaa9651f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgxMDI2NA==", "url": "https://github.com/apache/pulsar/pull/7473#discussion_r451810264", "bodyText": "@merlimat Yes, I don't see any issue by returning success on non-existing producer or consumer. I made that change. Can you please review it again.", "author": "rdhabalia", "createdAt": "2020-07-08T20:35:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTU4NjQxMg=="}], "type": "inlineReview", "revised_code": {"commit": "487462bd78c3ef9f988175c561bbd6ecf7b082be", "chunk": "diff --git a/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentReplicator.java b/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentReplicator.java\nindex cff6b2ae20f..6503df3fa3f 100644\n--- a/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentReplicator.java\n+++ b/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentReplicator.java\n\n@@ -761,13 +760,11 @@ public class PersistentReplicator extends AbstractReplicator implements Replicat\n         final CompletableFuture<Void> future = new CompletableFuture<>();\n \n         super.disconnect(failIfHasBacklog).thenRun(() -> {\n-            cleanAfterDisconnect(future);\n+            dispatchRateLimiter.ifPresent(DispatchRateLimiter::close);\n+            future.complete(null);\n         }).exceptionally(ex -> {\n             Throwable t = (ex instanceof CompletionException ? ex.getCause() : ex);\n-            if (t instanceof AlreadyClosedException) {\n-                cleanAfterDisconnect(future);\n-                return null;\n-            } else if (t instanceof TopicBusyException == false) {\n+            if (t instanceof TopicBusyException == false) {\n                 log.error(\"[{}][{} -> {}] Failed to close dispatch rate limiter: {}\", topicName, localCluster,\n                         remoteCluster, ex.getMessage());\n             }\n"}}, {"oid": "487462bd78c3ef9f988175c561bbd6ecf7b082be", "url": "https://github.com/apache/pulsar/commit/487462bd78c3ef9f988175c561bbd6ecf7b082be", "message": "Revert \"add error-codes\"\n\nThis reverts commit 972ae3e1d179ad491506302a230dddceaa9651f6.", "committedDate": "2020-07-08T18:10:48Z", "type": "commit"}, {"oid": "c5dd73a99895d3da7f3a9af431d0265c536f7dd4", "url": "https://github.com/apache/pulsar/commit/c5dd73a99895d3da7f3a9af431d0265c536f7dd4", "message": "Revert \"[pulsar-broker] Cleanup already deleted namespace topics\"\n\nThis reverts commit 570132d8f0ecc7c0523769abadb83c2c01be98de.", "committedDate": "2020-07-08T18:10:52Z", "type": "commit"}, {"oid": "0b257ef4b21f691e8936a384e7ea198761f3bf6c", "url": "https://github.com/apache/pulsar/commit/0b257ef4b21f691e8936a384e7ea198761f3bf6c", "message": "send success if producer is already closed", "committedDate": "2020-07-08T20:34:05Z", "type": "commit"}, {"oid": "22bfe2c59afc915f465b3f7c6b6d40235b42bf50", "url": "https://github.com/apache/pulsar/commit/22bfe2c59afc915f465b3f7c6b6d40235b42bf50", "message": "send success if consumer is already closed", "committedDate": "2020-07-08T20:34:21Z", "type": "commit"}]}