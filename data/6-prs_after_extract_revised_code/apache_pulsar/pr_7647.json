{"pr_number": 7647, "pr_title": "Allow ability to specify retain key ordering in functions", "pr_createdAt": "2020-07-23T18:49:59Z", "pr_url": "https://github.com/apache/pulsar/pull/7647", "timeline": [{"oid": "478a2d1e51974a4ee337345e67ed9e4e2ad947b4", "url": "https://github.com/apache/pulsar/commit/478a2d1e51974a4ee337345e67ed9e4e2ad947b4", "message": "Allow ability to specify retain key ordering in functions", "committedDate": "2020-07-23T18:48:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwMTE0MA==", "url": "https://github.com/apache/pulsar/pull/7647#discussion_r459701140", "bodyText": "We also need to do this in SinkConfigUtils", "author": "jerrypeng", "createdAt": "2020-07-23T20:13:06Z", "path": "pulsar-functions/utils/src/main/java/org/apache/pulsar/functions/utils/FunctionConfigUtils.java", "diffHunk": "@@ -317,9 +319,15 @@ public static FunctionConfig convertFromDetails(FunctionDetails functionDetails)\n         }\n         if (functionDetails.getSource().getSubscriptionType() == Function.SubscriptionType.FAILOVER) {\n             functionConfig.setRetainOrdering(true);\n+            functionConfig.setRetainKeyOrdering(false);\n             functionConfig.setProcessingGuarantees(FunctionConfig.ProcessingGuarantees.EFFECTIVELY_ONCE);\n+        } else if (functionDetails.getSource().getSubscriptionType() == Function.SubscriptionType.KEY_SHARED) {", "originalCommit": "478a2d1e51974a4ee337345e67ed9e4e2ad947b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg2OTgwOA==", "url": "https://github.com/apache/pulsar/pull/7647#discussion_r459869808", "bodyText": "That can be added later.", "author": "srkukarni", "createdAt": "2020-07-24T06:16:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwMTE0MA=="}], "type": "inlineReview", "revised_code": {"commit": "b1b692868685d4a5d10068dfbeb0b2a1b886c40b", "chunk": "diff --git a/pulsar-functions/utils/src/main/java/org/apache/pulsar/functions/utils/FunctionConfigUtils.java b/pulsar-functions/utils/src/main/java/org/apache/pulsar/functions/utils/FunctionConfigUtils.java\nindex e80aad88b41..342ba27a7ae 100644\n--- a/pulsar-functions/utils/src/main/java/org/apache/pulsar/functions/utils/FunctionConfigUtils.java\n+++ b/pulsar-functions/utils/src/main/java/org/apache/pulsar/functions/utils/FunctionConfigUtils.java\n\n@@ -317,19 +326,9 @@ public class FunctionConfigUtils {\n         if (!isEmpty(functionDetails.getSource().getSubscriptionName())) {\n             functionConfig.setSubName(functionDetails.getSource().getSubscriptionName());\n         }\n-        if (functionDetails.getSource().getSubscriptionType() == Function.SubscriptionType.FAILOVER) {\n-            functionConfig.setRetainOrdering(true);\n-            functionConfig.setRetainKeyOrdering(false);\n-            functionConfig.setProcessingGuarantees(FunctionConfig.ProcessingGuarantees.EFFECTIVELY_ONCE);\n-        } else if (functionDetails.getSource().getSubscriptionType() == Function.SubscriptionType.KEY_SHARED) {\n-            functionConfig.setRetainOrdering(false);\n-            functionConfig.setRetainKeyOrdering(true);\n-            functionConfig.setProcessingGuarantees(FunctionConfig.ProcessingGuarantees.ATLEAST_ONCE);\n-        } else {\n-            functionConfig.setRetainOrdering(false);\n-            functionConfig.setRetainKeyOrdering(false);\n-            functionConfig.setProcessingGuarantees(FunctionConfig.ProcessingGuarantees.ATLEAST_ONCE);\n-        }\n+        functionConfig.setRetainOrdering(functionDetails.getRetainOrdering());\n+        functionConfig.setRetainKeyOrdering(functionDetails.getRetainKeyOrdering());\n+\n         functionConfig.setCleanupSubscription(functionDetails.getSource().getCleanupSubscription());\n         functionConfig.setAutoAck(functionDetails.getAutoAck());\n         if (functionDetails.getSource().getTimeoutMs() != 0) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcxMDQxMQ==", "url": "https://github.com/apache/pulsar/pull/7647#discussion_r459710411", "bodyText": "Why are we assuming ATLEAST_ONCE here?  A user can set the processing guarantee to be at most once and still set the retain ordering to be true", "author": "jerrypeng", "createdAt": "2020-07-23T20:31:12Z", "path": "pulsar-functions/utils/src/main/java/org/apache/pulsar/functions/utils/FunctionConfigUtils.java", "diffHunk": "@@ -317,9 +319,15 @@ public static FunctionConfig convertFromDetails(FunctionDetails functionDetails)\n         }\n         if (functionDetails.getSource().getSubscriptionType() == Function.SubscriptionType.FAILOVER) {\n             functionConfig.setRetainOrdering(true);\n+            functionConfig.setRetainKeyOrdering(false);\n             functionConfig.setProcessingGuarantees(FunctionConfig.ProcessingGuarantees.EFFECTIVELY_ONCE);\n+        } else if (functionDetails.getSource().getSubscriptionType() == Function.SubscriptionType.KEY_SHARED) {\n+            functionConfig.setRetainOrdering(false);\n+            functionConfig.setRetainKeyOrdering(true);\n+            functionConfig.setProcessingGuarantees(FunctionConfig.ProcessingGuarantees.ATLEAST_ONCE);", "originalCommit": "478a2d1e51974a4ee337345e67ed9e4e2ad947b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg1NDc4Mw==", "url": "https://github.com/apache/pulsar/pull/7647#discussion_r459854783", "bodyText": "Yes. Even the existing code is broken in that regard. I will fix that", "author": "srkukarni", "createdAt": "2020-07-24T05:11:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcxMDQxMQ=="}], "type": "inlineReview", "revised_code": {"commit": "b1b692868685d4a5d10068dfbeb0b2a1b886c40b", "chunk": "diff --git a/pulsar-functions/utils/src/main/java/org/apache/pulsar/functions/utils/FunctionConfigUtils.java b/pulsar-functions/utils/src/main/java/org/apache/pulsar/functions/utils/FunctionConfigUtils.java\nindex e80aad88b41..342ba27a7ae 100644\n--- a/pulsar-functions/utils/src/main/java/org/apache/pulsar/functions/utils/FunctionConfigUtils.java\n+++ b/pulsar-functions/utils/src/main/java/org/apache/pulsar/functions/utils/FunctionConfigUtils.java\n\n@@ -317,19 +326,9 @@ public class FunctionConfigUtils {\n         if (!isEmpty(functionDetails.getSource().getSubscriptionName())) {\n             functionConfig.setSubName(functionDetails.getSource().getSubscriptionName());\n         }\n-        if (functionDetails.getSource().getSubscriptionType() == Function.SubscriptionType.FAILOVER) {\n-            functionConfig.setRetainOrdering(true);\n-            functionConfig.setRetainKeyOrdering(false);\n-            functionConfig.setProcessingGuarantees(FunctionConfig.ProcessingGuarantees.EFFECTIVELY_ONCE);\n-        } else if (functionDetails.getSource().getSubscriptionType() == Function.SubscriptionType.KEY_SHARED) {\n-            functionConfig.setRetainOrdering(false);\n-            functionConfig.setRetainKeyOrdering(true);\n-            functionConfig.setProcessingGuarantees(FunctionConfig.ProcessingGuarantees.ATLEAST_ONCE);\n-        } else {\n-            functionConfig.setRetainOrdering(false);\n-            functionConfig.setRetainKeyOrdering(false);\n-            functionConfig.setProcessingGuarantees(FunctionConfig.ProcessingGuarantees.ATLEAST_ONCE);\n-        }\n+        functionConfig.setRetainOrdering(functionDetails.getRetainOrdering());\n+        functionConfig.setRetainKeyOrdering(functionDetails.getRetainKeyOrdering());\n+\n         functionConfig.setCleanupSubscription(functionDetails.getSource().getCleanupSubscription());\n         functionConfig.setAutoAck(functionDetails.getAutoAck());\n         if (functionDetails.getSource().getTimeoutMs() != 0) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcxMjUzNA==", "url": "https://github.com/apache/pulsar/pull/7647#discussion_r459712534", "bodyText": "Can we re-organize this giant conditional statement to be more readable?\nif (effectively-once) {\nsubType = Failover\n} else if (retain order) {\nsubType = failover\n} else if (retain key order) {\nsubType = shared_key\n} else {\nsubType = shared\n}", "author": "jerrypeng", "createdAt": "2020-07-23T20:35:07Z", "path": "pulsar-functions/utils/src/main/java/org/apache/pulsar/functions/utils/FunctionConfigUtils.java", "diffHunk": "@@ -142,6 +142,8 @@ public static FunctionDetails convert(FunctionConfig functionConfig, ClassLoader\n         Function.SubscriptionType subType = ((functionConfig.getRetainOrdering() != null && functionConfig.getRetainOrdering())\n                 || FunctionConfig.ProcessingGuarantees.EFFECTIVELY_ONCE.equals(functionConfig.getProcessingGuarantees()))\n                 ? Function.SubscriptionType.FAILOVER\n+                : (functionConfig.getRetainKeyOrdering() != null && functionConfig.getRetainKeyOrdering())", "originalCommit": "478a2d1e51974a4ee337345e67ed9e4e2ad947b4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b1b692868685d4a5d10068dfbeb0b2a1b886c40b", "chunk": "diff --git a/pulsar-functions/utils/src/main/java/org/apache/pulsar/functions/utils/FunctionConfigUtils.java b/pulsar-functions/utils/src/main/java/org/apache/pulsar/functions/utils/FunctionConfigUtils.java\nindex e80aad88b41..342ba27a7ae 100644\n--- a/pulsar-functions/utils/src/main/java/org/apache/pulsar/functions/utils/FunctionConfigUtils.java\n+++ b/pulsar-functions/utils/src/main/java/org/apache/pulsar/functions/utils/FunctionConfigUtils.java\n\n@@ -138,13 +138,16 @@ public class FunctionConfigUtils {\n             });\n         }\n \n-        // Set subscription type based on ordering and EFFECTIVELY_ONCE semantics\n-        Function.SubscriptionType subType = ((functionConfig.getRetainOrdering() != null && functionConfig.getRetainOrdering())\n-                || FunctionConfig.ProcessingGuarantees.EFFECTIVELY_ONCE.equals(functionConfig.getProcessingGuarantees()))\n-                ? Function.SubscriptionType.FAILOVER\n-                : (functionConfig.getRetainKeyOrdering() != null && functionConfig.getRetainKeyOrdering())\n-                ? Function.SubscriptionType.KEY_SHARED\n-                : Function.SubscriptionType.SHARED;\n+        // Set subscription type\n+        Function.SubscriptionType subType;\n+        if ((functionConfig.getRetainOrdering() != null && functionConfig.getRetainOrdering())\n+                || FunctionConfig.ProcessingGuarantees.EFFECTIVELY_ONCE.equals(functionConfig.getProcessingGuarantees())) {\n+            subType = Function.SubscriptionType.FAILOVER;\n+        } else if (functionConfig.getRetainKeyOrdering() != null && functionConfig.getRetainKeyOrdering()) {\n+            subType = Function.SubscriptionType.KEY_SHARED;\n+        } else {\n+            subType = Function.SubscriptionType.SHARED;\n+        }\n         sourceSpecBuilder.setSubscriptionType(subType);\n \n         if (isNotBlank(functionConfig.getSubName())) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcxNTA4NA==", "url": "https://github.com/apache/pulsar/pull/7647#discussion_r459715084", "bodyText": "I would remove this stanza.  We should return an error if the retain order or retain key ordering is set at all", "author": "jerrypeng", "createdAt": "2020-07-23T20:40:10Z", "path": "pulsar-functions/utils/src/main/java/org/apache/pulsar/functions/utils/FunctionConfigUtils.java", "diffHunk": "@@ -639,6 +655,16 @@ private static void doCommonChecks(FunctionConfig functionConfig) {\n         if ((functionConfig.getMaxMessageRetries() == null || functionConfig.getMaxMessageRetries() < 0) && !org.apache.commons.lang3.StringUtils.isEmpty(functionConfig.getDeadLetterTopic())) {\n             throw new IllegalArgumentException(\"Dead Letter Topic specified, however max retries is set to infinity\");\n         }\n+        if (functionConfig.getRetainKeyOrdering() != null\n+                && functionConfig.getRetainKeyOrdering()", "originalCommit": "478a2d1e51974a4ee337345e67ed9e4e2ad947b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcxNTUwMQ==", "url": "https://github.com/apache/pulsar/pull/7647#discussion_r459715501", "bodyText": "Can you also check whether retain ordering is set?", "author": "jerrypeng", "createdAt": "2020-07-23T20:41:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcxNTA4NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcxNjIxOA==", "url": "https://github.com/apache/pulsar/pull/7647#discussion_r459716218", "bodyText": "Can we add some comments here for retainOrdering and retainKeyOrdering so people understand what they do and what the difference between the two is?", "author": "jerrypeng", "createdAt": "2020-07-23T20:42:21Z", "path": "pulsar-common/src/main/java/org/apache/pulsar/common/functions/FunctionConfig.java", "diffHunk": "@@ -87,6 +87,7 @@\n     private String logTopic;\n     private ProcessingGuarantees processingGuarantees;\n     private Boolean retainOrdering;\n+    private Boolean retainKeyOrdering;", "originalCommit": "478a2d1e51974a4ee337345e67ed9e4e2ad947b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcxOTgxMA==", "url": "https://github.com/apache/pulsar/pull/7647#discussion_r459719810", "bodyText": "also need to add this for SinkConfig", "author": "jerrypeng", "createdAt": "2020-07-23T20:49:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcxNjIxOA=="}], "type": "inlineReview", "revised_code": {"commit": "b1b692868685d4a5d10068dfbeb0b2a1b886c40b", "chunk": "diff --git a/pulsar-common/src/main/java/org/apache/pulsar/common/functions/FunctionConfig.java b/pulsar-common/src/main/java/org/apache/pulsar/common/functions/FunctionConfig.java\nindex 09a238a64ac..8c680e8c35f 100644\n--- a/pulsar-common/src/main/java/org/apache/pulsar/common/functions/FunctionConfig.java\n+++ b/pulsar-common/src/main/java/org/apache/pulsar/common/functions/FunctionConfig.java\n\n@@ -86,7 +86,10 @@ public class FunctionConfig {\n     private String outputSerdeClassName;\n     private String logTopic;\n     private ProcessingGuarantees processingGuarantees;\n+    // Do we want function instances to process data in the same order as in the input topics\n+    // This essentially means that every partition of input topic is consumed by only one instance\n     private Boolean retainOrdering;\n+    // Do we want the same function instance to process all data keyed by the input topic's message key\n     private Boolean retainKeyOrdering;\n     private Boolean forwardSourceMessageProperty;\n     private Map<String, Object> userConfig;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcxODY2NA==", "url": "https://github.com/apache/pulsar/pull/7647#discussion_r459718664", "bodyText": "This whole conditional statement doesn't seem right to me.  Why are se setting the processing guarantee by looking at what the subscription is?  We already setting the processing guarantee in a previous line:\nhttps://github.com/apache/pulsar/pull/7647/files#diff-239e167c18ea8591c85432948ab5040aL297", "author": "jerrypeng", "createdAt": "2020-07-23T20:47:17Z", "path": "pulsar-functions/utils/src/main/java/org/apache/pulsar/functions/utils/FunctionConfigUtils.java", "diffHunk": "@@ -317,9 +319,15 @@ public static FunctionConfig convertFromDetails(FunctionDetails functionDetails)\n         }\n         if (functionDetails.getSource().getSubscriptionType() == Function.SubscriptionType.FAILOVER) {", "originalCommit": "478a2d1e51974a4ee337345e67ed9e4e2ad947b4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b1b692868685d4a5d10068dfbeb0b2a1b886c40b", "chunk": "diff --git a/pulsar-functions/utils/src/main/java/org/apache/pulsar/functions/utils/FunctionConfigUtils.java b/pulsar-functions/utils/src/main/java/org/apache/pulsar/functions/utils/FunctionConfigUtils.java\nindex e80aad88b41..342ba27a7ae 100644\n--- a/pulsar-functions/utils/src/main/java/org/apache/pulsar/functions/utils/FunctionConfigUtils.java\n+++ b/pulsar-functions/utils/src/main/java/org/apache/pulsar/functions/utils/FunctionConfigUtils.java\n\n@@ -317,19 +326,9 @@ public class FunctionConfigUtils {\n         if (!isEmpty(functionDetails.getSource().getSubscriptionName())) {\n             functionConfig.setSubName(functionDetails.getSource().getSubscriptionName());\n         }\n-        if (functionDetails.getSource().getSubscriptionType() == Function.SubscriptionType.FAILOVER) {\n-            functionConfig.setRetainOrdering(true);\n-            functionConfig.setRetainKeyOrdering(false);\n-            functionConfig.setProcessingGuarantees(FunctionConfig.ProcessingGuarantees.EFFECTIVELY_ONCE);\n-        } else if (functionDetails.getSource().getSubscriptionType() == Function.SubscriptionType.KEY_SHARED) {\n-            functionConfig.setRetainOrdering(false);\n-            functionConfig.setRetainKeyOrdering(true);\n-            functionConfig.setProcessingGuarantees(FunctionConfig.ProcessingGuarantees.ATLEAST_ONCE);\n-        } else {\n-            functionConfig.setRetainOrdering(false);\n-            functionConfig.setRetainKeyOrdering(false);\n-            functionConfig.setProcessingGuarantees(FunctionConfig.ProcessingGuarantees.ATLEAST_ONCE);\n-        }\n+        functionConfig.setRetainOrdering(functionDetails.getRetainOrdering());\n+        functionConfig.setRetainKeyOrdering(functionDetails.getRetainKeyOrdering());\n+\n         functionConfig.setCleanupSubscription(functionDetails.getSource().getCleanupSubscription());\n         functionConfig.setAutoAck(functionDetails.getAutoAck());\n         if (functionDetails.getSource().getTimeoutMs() != 0) {\n"}}, {"oid": "b1b692868685d4a5d10068dfbeb0b2a1b886c40b", "url": "https://github.com/apache/pulsar/commit/b1b692868685d4a5d10068dfbeb0b2a1b886c40b", "message": "Address comments", "committedDate": "2020-07-24T07:00:32Z", "type": "commit"}, {"oid": "bd2e1ef38fe00b2b8ccd233f7037c5f26ad89f35", "url": "https://github.com/apache/pulsar/commit/bd2e1ef38fe00b2b8ccd233f7037c5f26ad89f35", "message": "Merge branch 'master' into key_shared_function", "committedDate": "2020-07-24T16:30:24Z", "type": "commit"}]}