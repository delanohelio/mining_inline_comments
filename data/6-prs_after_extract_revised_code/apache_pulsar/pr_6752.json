{"pr_number": 6752, "pr_title": "Support different docker images in Kubernetes runtime of Pulsar Functions", "pr_createdAt": "2020-04-17T10:41:18Z", "pr_url": "https://github.com/apache/pulsar/pull/6752", "timeline": [{"oid": "a1fd0da0731ed98149c755b4c02f451468b9b6ce", "url": "https://github.com/apache/pulsar/commit/a1fd0da0731ed98149c755b4c02f451468b9b6ce", "message": "Support different docker images in Kubernetes runtime of Pulsar Functions\n\nSigned-off-by: xiaolong.ran <rxl@apache.org>", "committedDate": "2020-04-17T10:35:31Z", "type": "commit"}, {"oid": "eb892a0023c1dfd5f097e1dedd2eb62d4f1e8046", "url": "https://github.com/apache/pulsar/commit/eb892a0023c1dfd5f097e1dedd2eb62d4f1e8046", "message": "Fix default behavior\n\nSigned-off-by: xiaolong.ran <rxl@apache.org>", "committedDate": "2020-04-17T20:07:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDczODQ5OA==", "url": "https://github.com/apache/pulsar/pull/6752#discussion_r410738498", "bodyText": "This can already be achieved with no code changes by implementing your own https://github.com/apache/pulsar/blob/master/pulsar-functions/runtime/src/main/java/org/apache/pulsar/functions/runtime/kubernetes/KubernetesManifestCustomizer.java\nThis class allows you to do anything to the function spec so you can set whatever image you want.\nIs there another patch coming with this? The kubernetes runtime only supports one docker image right?. So, If I configured a python image I would only be able to run python functions.\nI'm not sure this is the right approach and think the design needs to be thought through more. Maybe a more generic structure like a map. That way you could have images for specific runtime version java8, java11, python3.7, python3.8, etc..\nOr provide another implementation of the KubernetesManifestCustomizer.java that supports images for each runtime (java, python, go, etc..)", "author": "cckellogg", "createdAt": "2020-04-18T19:11:41Z", "path": "pulsar-functions/runtime/src/main/java/org/apache/pulsar/functions/runtime/kubernetes/KubernetesRuntime.java", "diffHunk": "@@ -155,6 +158,9 @@\n                       String pythonDependencyRepository,\n                       String pythonExtraDependencyRepository,\n                       String pulsarDockerImageName,\n+                      String javaFunctionDockerImageName,\n+                      String pythonFunctionDockerImageName,\n+                      String goFunctionDockerImageName,", "originalCommit": "eb892a0023c1dfd5f097e1dedd2eb62d4f1e8046", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDgxMjg2OA==", "url": "https://github.com/apache/pulsar/pull/6752#discussion_r410812868", "bodyText": "Is there another patch coming with this? The kubernetes runtime only supports one docker image right?. So, If I configured a python image I would only be able to run python functions.\n\nYes, this is what I want to achieve. Currently, the default docker image we use is apachepulsar/pulsar-all, but sometimes users only want to use the Python Function, then for Java Function and Go Function, we don\u2019t need to build related dependencies to the image, right?", "author": "wolfstudy", "createdAt": "2020-04-19T04:35:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDczODQ5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDgxNDYwNg==", "url": "https://github.com/apache/pulsar/pull/6752#discussion_r410814606", "bodyText": "This class allows you to do anything to the function spec so you can set whatever image you want.\n\nYou are right, we can use the KubernetesManifestCustomizer interface to config image for different language function. And then? How do we load user-defined implementation classes? The most direct way is to rebuild a new image based on apachepulsar/pulsar-all. Eg:\nFROM apachepulsar/pulsar-all:2.5.0\nCOPY my-custer-jar.jar /pulsar/lib\n...\n\nOr, another option though would be to do the following:\n\nget your jar into a k8s volume\nmount that volume into your function worker pod (say in /pulsar/extraLibs )\nset PULSAR_EXTRA_CLASSPATH=/pulsar/extraLibs\n\nSo, I think this is two problems:\n\nWe allow users to configure image for a specific language function(Eg: Python function)\nFor the user-defined k8s spec, we should consider how to load the user-implemented tar package into the pod.", "author": "wolfstudy", "createdAt": "2020-04-19T04:48:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDczODQ5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTA2MzI2MQ==", "url": "https://github.com/apache/pulsar/pull/6752#discussion_r411063261", "bodyText": "We allow users to configure image for a specific language function(Eg: Python function)\nI agree it would be nice to have images for specific runtimes.\n\nAre users in charge of building their own function images? Or will the project be publishing images for each function runtime?\nIf users are expected to create their own images thing could get tricky because currently the pulsar-admin tool is required for functions to run in kubernetes. It's used to download the function binary (https://github.com/apache/pulsar/blob/master/pulsar-functions/runtime/src/main/java/org/apache/pulsar/functions/runtime/kubernetes/KubernetesRuntime.java#L802). This means every image needs java. Ideally, if you are running python or go functions you should not need a java dependency.\n\nFor the user-defined k8s spec, we should consider how to load the user-implemented tar package into the pod.\n\nIf you are writing custom plugins it usually makes sense to build your own image and you can dump the plugin in the pulsar/lib directory and it will automatically end up on the class path.\nHere are a few possible ways to solve multiple images.\n1 - the current way with a flat config\njavaFunctionDockerImageName\npythonFunctionDockerImageName\ngoFunctionDockerImageName\n\n2 - pass a map of runtime to image\nI like a map since it allows for easier modifications in the future. However, it can be a little more configuration.\nruntime -> {}\njava -> {\n  image: java-image\n}\npython -> {\n  image: python-image\n},\ngo -> {\n  image: go-image\n},\n\n3 - implement a KubernetesManifestCustomizer for multiple images and make that plugin part of the project. The Customizer class is a configuration runtimeCustomizerClassName in the function_worker.yaml. This Customizer can also take configuration.\nOptions 1 and 2 require this code to be updated (\nThis code needs to be updated (https://github.com/apache/pulsar/blob/master/pulsar-functions/runtime/src/main/java/org/apache/pulsar/functions/runtime/kubernetes/KubernetesRuntime.java#L973).\nThoughts?", "author": "cckellogg", "createdAt": "2020-04-20T03:05:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDczODQ5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQ1NDQ1NA==", "url": "https://github.com/apache/pulsar/pull/6752#discussion_r412454454", "bodyText": "@cckellogg I think the idea is to create different instance images for different language runtime. So we can start making the language runtime pluggable.", "author": "sijie", "createdAt": "2020-04-21T20:04:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDczODQ5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzA5NjkyMQ==", "url": "https://github.com/apache/pulsar/pull/6752#discussion_r413096921", "bodyText": "I agree with the concept and idea. I was trying to brainstorm the configuration approach of flat vs a map for the images. Would any other information be needed for specific image? If not then flat is probably ok.", "author": "cckellogg", "createdAt": "2020-04-22T15:44:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDczODQ5OA=="}], "type": "inlineReview", "revised_code": {"commit": "d2634bb2030b66c1b8661d91ded5242224020dac", "chunk": "diff --git a/pulsar-functions/runtime/src/main/java/org/apache/pulsar/functions/runtime/kubernetes/KubernetesRuntime.java b/pulsar-functions/runtime/src/main/java/org/apache/pulsar/functions/runtime/kubernetes/KubernetesRuntime.java\nindex cfc96ec909b..00ce8584420 100644\n--- a/pulsar-functions/runtime/src/main/java/org/apache/pulsar/functions/runtime/kubernetes/KubernetesRuntime.java\n+++ b/pulsar-functions/runtime/src/main/java/org/apache/pulsar/functions/runtime/kubernetes/KubernetesRuntime.java\n\n@@ -158,9 +157,7 @@ public class KubernetesRuntime implements Runtime {\n                       String pythonDependencyRepository,\n                       String pythonExtraDependencyRepository,\n                       String pulsarDockerImageName,\n-                      String javaFunctionDockerImageName,\n-                      String pythonFunctionDockerImageName,\n-                      String goFunctionDockerImageName,\n+                      Map<String, String> functionDockerImages,\n                       String imagePullPolicy,\n                       String pulsarRootDir,\n                       InstanceConfig instanceConfig,\n"}}, {"oid": "7c87c20ee9ed248ded79abc3b07dfd9126f6f48d", "url": "https://github.com/apache/pulsar/commit/7c87c20ee9ed248ded79abc3b07dfd9126f6f48d", "message": "fix comments\n\nSigned-off-by: xiaolong.ran <rxl@apache.org>", "committedDate": "2020-04-19T05:12:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQ1NTYwMg==", "url": "https://github.com/apache/pulsar/pull/6752#discussion_r412455602", "bodyText": "I think the logic here is completely wrong. You should set the correct docker image name based on the language runtime, not based on whether this configuration is set or not.", "author": "sijie", "createdAt": "2020-04-21T20:06:27Z", "path": "pulsar-functions/runtime/src/main/java/org/apache/pulsar/functions/runtime/kubernetes/KubernetesRuntime.java", "diffHunk": "@@ -973,8 +982,19 @@ private V1PodSpec getPodSpec(List<String> instanceCommand, Function.Resources re\n     V1Container getFunctionContainer(List<String> instanceCommand, Function.Resources resource) {\n         final V1Container container = new V1Container().name(PULSARFUNCTIONS_CONTAINER_NAME);\n \n-        // set up the container images\n-        container.setImage(pulsarDockerImageName);\n+        // By default, if we do not use the function image of a specific language, then we will support all languages.\n+        if (javaFunctionDockerImageName == null && pythonFunctionDockerImageName == null && goFunctionDockerImageName == null) {", "originalCommit": "7c87c20ee9ed248ded79abc3b07dfd9126f6f48d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTA1NTczMw==", "url": "https://github.com/apache/pulsar/pull/6752#discussion_r415055733", "bodyText": "I think the logic here is completely wrong.\n\nIn here, my processing idea uses the original pulsarDockerImageName as the default configuration, that is, when we do not set the corresponding image for the function of the specified language, we use the default image.\n\nYou should set the correct docker image name based on the language runtime, not based on whether this configuration is set or not.\n\nDo you mean that we check the image that the user needs to use based on the parameters passed by the user --jar, --python or --go?", "author": "wolfstudy", "createdAt": "2020-04-25T12:45:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQ1NTYwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTExNTYwNg==", "url": "https://github.com/apache/pulsar/pull/6752#discussion_r415115606", "bodyText": "You need to check the runtime of the function and then set the image based on that.\ninstanceConfig.getFunctionDetails().getRuntime()", "author": "cckellogg", "createdAt": "2020-04-25T18:21:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQ1NTYwMg=="}], "type": "inlineReview", "revised_code": {"commit": "05f63912e288bc9d3e8077639f35e16fc308f6f7", "chunk": "diff --git a/pulsar-functions/runtime/src/main/java/org/apache/pulsar/functions/runtime/kubernetes/KubernetesRuntime.java b/pulsar-functions/runtime/src/main/java/org/apache/pulsar/functions/runtime/kubernetes/KubernetesRuntime.java\nindex cfc96ec909b..093f63333e4 100644\n--- a/pulsar-functions/runtime/src/main/java/org/apache/pulsar/functions/runtime/kubernetes/KubernetesRuntime.java\n+++ b/pulsar-functions/runtime/src/main/java/org/apache/pulsar/functions/runtime/kubernetes/KubernetesRuntime.java\n\n@@ -982,19 +982,18 @@ public class KubernetesRuntime implements Runtime {\n     V1Container getFunctionContainer(List<String> instanceCommand, Function.Resources resource) {\n         final V1Container container = new V1Container().name(PULSARFUNCTIONS_CONTAINER_NAME);\n \n-        // By default, if we do not use the function image of a specific language, then we will support all languages.\n-        if (javaFunctionDockerImageName == null && pythonFunctionDockerImageName == null && goFunctionDockerImageName == null) {\n-            container.setImage(pulsarDockerImageName);\n-        }\n-        if (javaFunctionDockerImageName != null){\n+        Function.FunctionDetails.Runtime runtime = instanceConfig.getFunctionDetails().getRuntime();\n+\n+        if (runtime == Function.FunctionDetails.Runtime.JAVA){\n             container.setImage(javaFunctionDockerImageName);\n-        }\n-        if (pythonFunctionDockerImageName != null){\n+        } else if (runtime == Function.FunctionDetails.Runtime.PYTHON){\n             container.setImage(pythonFunctionDockerImageName);\n-        }\n-        if (goFunctionDockerImageName != null){\n+        } else if (runtime == Function.FunctionDetails.Runtime.GO) {\n             container.setImage(goFunctionDockerImageName);\n+        } else {\n+            container.setImage(pulsarDockerImageName);\n         }\n+\n         container.setImagePullPolicy(imagePullPolicy);\n \n         // set up the container command\n"}}, {"oid": "05f63912e288bc9d3e8077639f35e16fc308f6f7", "url": "https://github.com/apache/pulsar/commit/05f63912e288bc9d3e8077639f35e16fc308f6f7", "message": "fix comments\n\nSigned-off-by: xiaolong.ran <rxl@apache.org>", "committedDate": "2020-05-14T03:51:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYyMTEyNw==", "url": "https://github.com/apache/pulsar/pull/6752#discussion_r437621127", "bodyText": "I don't think this is a backwards compatible change.  Existing users would still be using \"pulsarDockerImageName\" and only that config will be set.  \"pulsarDockerImageName\" should still be the default config used for image name and the new configs can override it if set.", "author": "jerrypeng", "createdAt": "2020-06-09T18:06:16Z", "path": "pulsar-functions/runtime/src/main/java/org/apache/pulsar/functions/runtime/kubernetes/KubernetesRuntime.java", "diffHunk": "@@ -973,8 +982,18 @@ private V1PodSpec getPodSpec(List<String> instanceCommand, Function.Resources re\n     V1Container getFunctionContainer(List<String> instanceCommand, Function.Resources resource) {\n         final V1Container container = new V1Container().name(PULSARFUNCTIONS_CONTAINER_NAME);\n \n-        // set up the container images\n-        container.setImage(pulsarDockerImageName);\n+        Function.FunctionDetails.Runtime runtime = instanceConfig.getFunctionDetails().getRuntime();\n+\n+        if (runtime == Function.FunctionDetails.Runtime.JAVA){", "originalCommit": "05f63912e288bc9d3e8077639f35e16fc308f6f7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fcc49de92a42208b31026d20c6e0e88d380335f8", "chunk": "diff --git a/pulsar-functions/runtime/src/main/java/org/apache/pulsar/functions/runtime/kubernetes/KubernetesRuntime.java b/pulsar-functions/runtime/src/main/java/org/apache/pulsar/functions/runtime/kubernetes/KubernetesRuntime.java\nindex 093f63333e4..43e72da090b 100644\n--- a/pulsar-functions/runtime/src/main/java/org/apache/pulsar/functions/runtime/kubernetes/KubernetesRuntime.java\n+++ b/pulsar-functions/runtime/src/main/java/org/apache/pulsar/functions/runtime/kubernetes/KubernetesRuntime.java\n\n@@ -984,14 +984,16 @@ public class KubernetesRuntime implements Runtime {\n \n         Function.FunctionDetails.Runtime runtime = instanceConfig.getFunctionDetails().getRuntime();\n \n-        if (runtime == Function.FunctionDetails.Runtime.JAVA){\n-            container.setImage(javaFunctionDockerImageName);\n-        } else if (runtime == Function.FunctionDetails.Runtime.PYTHON){\n-            container.setImage(pythonFunctionDockerImageName);\n-        } else if (runtime == Function.FunctionDetails.Runtime.GO) {\n-            container.setImage(goFunctionDockerImageName);\n-        } else {\n+        if (pulsarDockerImageName != null) {\n             container.setImage(pulsarDockerImageName);\n+        } else {\n+            if (runtime == Function.FunctionDetails.Runtime.JAVA) {\n+                container.setImage(javaFunctionDockerImageName);\n+            } else if (runtime == Function.FunctionDetails.Runtime.PYTHON) {\n+                container.setImage(pythonFunctionDockerImageName);\n+            } else if (runtime == Function.FunctionDetails.Runtime.GO) {\n+                container.setImage(goFunctionDockerImageName);\n+            }\n         }\n \n         container.setImagePullPolicy(imagePullPolicy);\n"}}, {"oid": "fcc49de92a42208b31026d20c6e0e88d380335f8", "url": "https://github.com/apache/pulsar/commit/fcc49de92a42208b31026d20c6e0e88d380335f8", "message": "fix comments\n\nSigned-off-by: xiaolong.ran <rxl@apache.org>", "committedDate": "2020-06-16T02:31:21Z", "type": "commit"}, {"oid": "a7b4e023c3f0a141ad2800f6a928696bb78b5705", "url": "https://github.com/apache/pulsar/commit/a7b4e023c3f0a141ad2800f6a928696bb78b5705", "message": "Merge branch 'master' into xiaolong/supprot-different-images-for-function", "committedDate": "2020-07-15T09:17:25Z", "type": "commit"}, {"oid": "d2634bb2030b66c1b8661d91ded5242224020dac", "url": "https://github.com/apache/pulsar/commit/d2634bb2030b66c1b8661d91ded5242224020dac", "message": "fix comments\n\nSigned-off-by: xiaolong.ran <rxl@apache.org>", "committedDate": "2020-07-16T01:13:57Z", "type": "commit"}, {"oid": "3972eeb3fe9f9d5424216fd6dd6c00f71c1a44c6", "url": "https://github.com/apache/pulsar/commit/3972eeb3fe9f9d5424216fd6dd6c00f71c1a44c6", "message": "add docs and fix test case\n\nSigned-off-by: xiaolong.ran <rxl@apache.org>", "committedDate": "2020-07-16T01:28:40Z", "type": "commit"}, {"oid": "71dad317f980a05647ab4f470cb6d05a8d2e636f", "url": "https://github.com/apache/pulsar/commit/71dad317f980a05647ab4f470cb6d05a8d2e636f", "message": "fix ci error\n\nSigned-off-by: xiaolong.ran <rxl@apache.org>", "committedDate": "2020-07-17T03:48:40Z", "type": "commit"}, {"oid": "b37fef899642340772358c1ff97cadf0e3e4700f", "url": "https://github.com/apache/pulsar/commit/b37fef899642340772358c1ff97cadf0e3e4700f", "message": "fix ci error\n\nSigned-off-by: xiaolong.ran <rxl@apache.org>", "committedDate": "2020-07-17T06:05:37Z", "type": "commit"}]}