{"pr_number": 7011, "pr_title": "Fix break changes in namespace offload policy and RabbitMQ sink.", "pr_createdAt": "2020-05-21T14:11:07Z", "pr_url": "https://github.com/apache/pulsar/pull/7011", "timeline": [{"oid": "3047d0934bc809bcd918b710a970f555facb7b04", "url": "https://github.com/apache/pulsar/commit/3047d0934bc809bcd918b710a970f555facb7b04", "message": "Fix break changes in namespace offload policy and RabbitMQ sink.", "committedDate": "2020-05-21T14:08:09Z", "type": "commit"}, {"oid": "bb1d9d0720bf8fdc08978b4d471e193ddad25486", "url": "https://github.com/apache/pulsar/commit/bb1d9d0720bf8fdc08978b4d471e193ddad25486", "message": "Build pulsar image for offloader tests.", "committedDate": "2020-05-21T14:41:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODc2MDkwNg==", "url": "https://github.com/apache/pulsar/pull/7011#discussion_r428760906", "bodyText": "This code was there to fallback to defaults in case there is no special offload policy for a given namespace. How is this behavior maintained?", "author": "merlimat", "createdAt": "2020-05-21T16:16:59Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/BrokerService.java", "diffHunk": "@@ -1062,17 +1062,6 @@ public void openLedgerFailed(ManagedLedgerException exception, Object ctx) {\n             managedLedgerConfig.setRetentionSizeInMB(retentionPolicies.getRetentionSizeInMB());\n             managedLedgerConfig.setAutoSkipNonRecoverableData(serviceConfig.isAutoSkipNonRecoverableData());\n             OffloadPolicies offloadPolicies = policies.map(p -> p.offload_policies).orElse(null);\n-\n-            if (offloadPolicies == null) {", "originalCommit": "bb1d9d0720bf8fdc08978b4d471e193ddad25486", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODc4ODk0Nw==", "url": "https://github.com/apache/pulsar/pull/7011#discussion_r428788947", "bodyText": "It's handled by https://github.com/apache/pulsar/blob/master/pulsar-broker/src/main/java/org/apache/pulsar/broker/PulsarService.java#L813", "author": "codelipenghui", "createdAt": "2020-05-21T17:05:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODc2MDkwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg0MDIwNQ==", "url": "https://github.com/apache/pulsar/pull/7011#discussion_r428840205", "bodyText": "Got it. Thanks!", "author": "merlimat", "createdAt": "2020-05-21T18:38:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODc2MDkwNg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "014e6338286a1ea7c56e265090bf2b4c439d3bb3", "url": "https://github.com/apache/pulsar/commit/014e6338286a1ea7c56e265090bf2b4c439d3bb3", "message": "Fix tests.", "committedDate": "2020-05-22T04:46:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA5OTE3Ng==", "url": "https://github.com/apache/pulsar/pull/7011#discussion_r429099176", "bodyText": "Since the purpose it's not obvious, can you add a comment on why we need this?", "author": "merlimat", "createdAt": "2020-05-22T07:57:25Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/PulsarService.java", "diffHunk": "@@ -539,6 +544,25 @@ public Boolean get() {\n         }\n     }\n \n+    private void generatePropertiesForConfigurationIfNeeded() {", "originalCommit": "014e6338286a1ea7c56e265090bf2b4c439d3bb3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTEwOTc4Ng==", "url": "https://github.com/apache/pulsar/pull/7011#discussion_r429109786", "bodyText": "Removed", "author": "codelipenghui", "createdAt": "2020-05-22T08:20:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA5OTE3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "ce30a0a650f5c9c1d26733251de93cac5bd755be", "chunk": "diff --git a/pulsar-broker/src/main/java/org/apache/pulsar/broker/PulsarService.java b/pulsar-broker/src/main/java/org/apache/pulsar/broker/PulsarService.java\nindex 58d211eb713..21a73a0b6bd 100644\n--- a/pulsar-broker/src/main/java/org/apache/pulsar/broker/PulsarService.java\n+++ b/pulsar-broker/src/main/java/org/apache/pulsar/broker/PulsarService.java\n\n@@ -544,25 +539,6 @@ public class PulsarService implements AutoCloseable {\n         }\n     }\n \n-    private void generatePropertiesForConfigurationIfNeeded() {\n-        if (this.getConfiguration().getProperties().size() == 0) {\n-            Properties properties = new Properties();\n-            Field[] fields = ServiceConfiguration.class.getDeclaredFields();\n-            Arrays.stream(fields).forEach(f -> {\n-                try {\n-                    f.setAccessible(true);\n-                    Object value = f.get(this.getConfiguration());\n-                    if (value != null) {\n-                        properties.setProperty(f.getName(), value + \"\");\n-                    }\n-                } catch (IllegalAccessException e) {\n-                    e.printStackTrace();\n-                }\n-            });\n-            this.getConfiguration().setProperties(properties);\n-        }\n-    }\n-\n     protected void startLeaderElectionService() {\n         this.leaderElectionService = new LeaderElectionService(this, new LeaderListener() {\n             @Override\n"}}, {"oid": "ce30a0a650f5c9c1d26733251de93cac5bd755be", "url": "https://github.com/apache/pulsar/commit/ce30a0a650f5c9c1d26733251de93cac5bd755be", "message": "Fix tests.", "committedDate": "2020-05-22T08:19:54Z", "type": "commit"}]}