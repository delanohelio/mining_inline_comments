{"pr_number": 8261, "pr_title": "Support limits the max tenants of the Pulsar cluster", "pr_createdAt": "2020-10-14T10:05:38Z", "pr_url": "https://github.com/apache/pulsar/pull/8261", "timeline": [{"oid": "ab1c64c2d125be5c27930a24db9f81693c0f51f7", "url": "https://github.com/apache/pulsar/commit/ab1c64c2d125be5c27930a24db9f81693c0f51f7", "message": "support max tenants of the Pulsar cluster", "committedDate": "2020-10-14T09:22:07Z", "type": "commit"}, {"oid": "630272f69af2cd26fa9bcd612dd35f95899fec5b", "url": "https://github.com/apache/pulsar/commit/630272f69af2cd26fa9bcd612dd35f95899fec5b", "message": "add unit test", "committedDate": "2020-10-14T10:04:37Z", "type": "commit"}, {"oid": "37c75909d62e472ba5fbe827d19e338b2cef0f5b", "url": "https://github.com/apache/pulsar/commit/37c75909d62e472ba5fbe827d19e338b2cef0f5b", "message": "change comment", "committedDate": "2020-10-14T10:09:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU2MDAzMw==", "url": "https://github.com/apache/pulsar/pull/8261#discussion_r504560033", "bodyText": "So we can have a race and see that this limit is not enforced.\nprobably this is not a big deal (and enforcing it would be very costly) but we should state it clearly at least in the description of this pull request", "author": "eolivelli", "createdAt": "2020-10-14T10:10:00Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/TenantsBase.java", "diffHunk": "@@ -105,6 +105,12 @@ public void createTenant(\n \n         try {\n             NamedEntity.checkName(tenant);\n+            List<String> tenants = globalZk().getChildren(path(POLICIES), false);\n+            int maxTenants = pulsar().getConfiguration().getMaxTenants();\n+            //No locks for precise control", "originalCommit": "630272f69af2cd26fa9bcd612dd35f95899fec5b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ccceecf63bb58dbe101e9ad4ed80d9acd66b3fc2", "chunk": "diff --git a/pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/TenantsBase.java b/pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/TenantsBase.java\nindex b59331156a1..51073101692 100644\n--- a/pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/TenantsBase.java\n+++ b/pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/TenantsBase.java\n\n@@ -107,7 +107,8 @@ public class TenantsBase extends AdminResource {\n             NamedEntity.checkName(tenant);\n             List<String> tenants = globalZk().getChildren(path(POLICIES), false);\n             int maxTenants = pulsar().getConfiguration().getMaxTenants();\n-            //No locks for precise control\n+            //Due to the cost of distributed locks, no locks are added here. \n+            //In a concurrent scenario, the threshold will be exceeded.\n             if (maxTenants > 0 && tenants != null && tenants.size() >= maxTenants) {\n                 throw new RestException(Status.PRECONDITION_FAILED, \"Exceed the maximum number of tenants\");\n             }\n"}}, {"oid": "ccceecf63bb58dbe101e9ad4ed80d9acd66b3fc2", "url": "https://github.com/apache/pulsar/commit/ccceecf63bb58dbe101e9ad4ed80d9acd66b3fc2", "message": " add unit test and comment", "committedDate": "2020-10-14T13:51:15Z", "type": "commit"}, {"oid": "c076f596813750056f2e9c61544552980241be81", "url": "https://github.com/apache/pulsar/commit/c076f596813750056f2e9c61544552980241be81", "message": " add doc", "committedDate": "2020-10-14T13:53:43Z", "type": "commit"}, {"oid": "25b34d68451644a9ede9cd813c3ef3cfcf92b25c", "url": "https://github.com/apache/pulsar/commit/25b34d68451644a9ede9cd813c3ef3cfcf92b25c", "message": "remove unstable unit tests", "committedDate": "2020-10-15T02:21:41Z", "type": "commit"}, {"oid": "a0137f54e6ce70e95327d8b738bc23f324fd0118", "url": "https://github.com/apache/pulsar/commit/a0137f54e6ce70e95327d8b738bc23f324fd0118", "message": "add cleanup", "committedDate": "2020-10-15T07:41:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY1MTg4MQ==", "url": "https://github.com/apache/pulsar/pull/8261#discussion_r505651881", "bodyText": "You shouldn't get the list of tenants from zookeeper first. You should check maxTenants first. If maxTenants is larger than 0, this feature is enabled. Then you get the list of tenants.", "author": "sijie", "createdAt": "2020-10-15T15:49:37Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/TenantsBase.java", "diffHunk": "@@ -105,6 +105,13 @@ public void createTenant(\n \n         try {\n             NamedEntity.checkName(tenant);\n+            List<String> tenants = globalZk().getChildren(path(POLICIES), false);", "originalCommit": "a0137f54e6ce70e95327d8b738bc23f324fd0118", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "356731f9c9d3a6f7f94b8d0125cdcfc3aa1665d7", "chunk": "diff --git a/pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/TenantsBase.java b/pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/TenantsBase.java\nindex 51073101692..bce1e83a4a3 100644\n--- a/pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/TenantsBase.java\n+++ b/pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/TenantsBase.java\n\n@@ -105,12 +105,15 @@ public class TenantsBase extends AdminResource {\n \n         try {\n             NamedEntity.checkName(tenant);\n-            List<String> tenants = globalZk().getChildren(path(POLICIES), false);\n+            \n             int maxTenants = pulsar().getConfiguration().getMaxTenants();\n             //Due to the cost of distributed locks, no locks are added here. \n             //In a concurrent scenario, the threshold will be exceeded.\n-            if (maxTenants > 0 && tenants != null && tenants.size() >= maxTenants) {\n-                throw new RestException(Status.PRECONDITION_FAILED, \"Exceed the maximum number of tenants\");\n+            if (maxTenants > 0) {\n+                List<String> tenants = globalZk().getChildren(path(POLICIES), false);\n+                if (tenants != null && tenants.size() >= maxTenants) {\n+                    throw new RestException(Status.PRECONDITION_FAILED, \"Exceed the maximum number of tenants\");\n+                }\n             }\n             zkCreate(path(POLICIES, tenant), jsonMapper().writeValueAsBytes(config));\n             log.info(\"[{}] Created tenant {}\", clientAppId(), tenant);\n"}}, {"oid": "356731f9c9d3a6f7f94b8d0125cdcfc3aa1665d7", "url": "https://github.com/apache/pulsar/commit/356731f9c9d3a6f7f94b8d0125cdcfc3aa1665d7", "message": "Judge first before reading zk", "committedDate": "2020-10-15T16:02:52Z", "type": "commit"}]}