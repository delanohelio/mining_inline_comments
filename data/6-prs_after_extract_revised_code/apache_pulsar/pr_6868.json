{"pr_number": 6868, "pr_title": "[issue #6765]  Expose definition flags to function ", "pr_createdAt": "2020-05-04T10:23:37Z", "pr_url": "https://github.com/apache/pulsar/pull/6868", "timeline": [{"oid": "53a103cd00940d8384b917ce6f5745346c4940e6", "url": "https://github.com/apache/pulsar/commit/53a103cd00940d8384b917ce6f5745346c4940e6", "message": "Definition flags expose to function", "committedDate": "2020-05-04T08:42:51Z", "type": "commit"}, {"oid": "f29f7e679a8ca78745765152b35f5c8152be866e", "url": "https://github.com/apache/pulsar/commit/f29f7e679a8ca78745765152b35f5c8152be866e", "message": "remove function", "committedDate": "2020-05-04T10:20:31Z", "type": "commit"}, {"oid": "8c7ee88e260f6ea579d27317d80a74c1e6118d60", "url": "https://github.com/apache/pulsar/commit/8c7ee88e260f6ea579d27317d80a74c1e6118d60", "message": "merge properties into SchemaProperties and add the schemaProperties to both SourceSpec and SinkSpec", "committedDate": "2020-05-20T19:04:03Z", "type": "commit"}, {"oid": "891b1411b351c7e1a934831ae40d2c327976ef17", "url": "https://github.com/apache/pulsar/commit/891b1411b351c7e1a934831ae40d2c327976ef17", "message": "Merge branch 'master' into fix\n\n# Conflicts:\n#\tpulsar-functions/utils/src/main/java/org/apache/pulsar/functions/utils/FunctionConfigUtils.java", "committedDate": "2020-05-21T03:18:38Z", "type": "commit"}, {"oid": "41776a1909bea318720e6494fc5bb4dad3dd7a42", "url": "https://github.com/apache/pulsar/commit/41776a1909bea318720e6494fc5bb4dad3dd7a42", "message": "change code style", "committedDate": "2020-05-21T03:42:47Z", "type": "commit"}, {"oid": "c2ef705553b233736a56d3ad93feebe33b7b4086", "url": "https://github.com/apache/pulsar/commit/c2ef705553b233736a56d3ad93feebe33b7b4086", "message": "Merge branch 'master' into fix", "committedDate": "2020-05-25T05:12:33Z", "type": "commit"}, {"oid": "52b2e9a15bb1b098f31154ba4f3ba8c62f158ae2", "url": "https://github.com/apache/pulsar/commit/52b2e9a15bb1b098f31154ba4f3ba8c62f158ae2", "message": "Adapt the default value of protobuf serialization", "committedDate": "2020-05-25T16:11:44Z", "type": "commit"}, {"oid": "1f6f610e5243c02a0a284a79bcf8153466fae273", "url": "https://github.com/apache/pulsar/commit/1f6f610e5243c02a0a284a79bcf8153466fae273", "message": "Merge remote-tracking branch 'apache/master' into fix", "committedDate": "2020-06-04T05:26:39Z", "type": "commit"}, {"oid": "d9022d8421ec0a527c47cac0e126e17667b9031e", "url": "https://github.com/apache/pulsar/commit/d9022d8421ec0a527c47cac0e126e17667b9031e", "message": "Merge remote-tracking branch 'apache/master' into fix", "committedDate": "2020-06-05T00:07:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQxODY1Mg==", "url": "https://github.com/apache/pulsar/pull/6868#discussion_r436418652", "bodyText": "Please use SchemaDefinitionBuilder#withProperties to construct the schema definition and avoid adding this kind of customization code. Also, the schema properties should be passed to other schemas as well.", "author": "sijie", "createdAt": "2020-06-08T00:50:12Z", "path": "pulsar-functions/instance/src/main/java/org/apache/pulsar/functions/source/TopicSchema.java", "diffHunk": "@@ -158,6 +173,20 @@ private static SchemaType getDefaultSchemaType(Class<?> clazz) {\n         }\n     }\n \n+    private static <T> AvroSchema<T> buildAvroSchema(Class<T> clazz, ConsumerConfig conf) {\n+        String jsr310ConversionEnabled = null;\n+        String alwaysAllowNull = null;\n+        if (conf.getSchemaProperties() != null) {", "originalCommit": "d9022d8421ec0a527c47cac0e126e17667b9031e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU3NzAwMA==", "url": "https://github.com/apache/pulsar/pull/6868#discussion_r436577000", "bodyText": "Please use SchemaDefinitionBuilder#withProperties to construct the schema definition and avoid adding this kind of customization code. Also, the schema properties should be passed to other schemas as well.\n\nModify as follows:\n1 Since the map generated by protobuf is immutable, a new Map is added to TopicSchema line 161.\n2 Since the parameters such as JSR310 in SchemaDefinitionBuilder are underlined,the incoming parameters will be converted\n@sijie", "author": "315157973", "createdAt": "2020-06-08T09:45:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQxODY1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "bbc49266fd1257460863e178cfa5f5e903f53406", "chunk": "diff --git a/pulsar-functions/instance/src/main/java/org/apache/pulsar/functions/source/TopicSchema.java b/pulsar-functions/instance/src/main/java/org/apache/pulsar/functions/source/TopicSchema.java\nindex ed84a161eba..ca689d211fc 100644\n--- a/pulsar-functions/instance/src/main/java/org/apache/pulsar/functions/source/TopicSchema.java\n+++ b/pulsar-functions/instance/src/main/java/org/apache/pulsar/functions/source/TopicSchema.java\n\n@@ -173,20 +175,6 @@ public class TopicSchema {\n         }\n     }\n \n-    private static <T> AvroSchema<T> buildAvroSchema(Class<T> clazz, ConsumerConfig conf) {\n-        String jsr310ConversionEnabled = null;\n-        String alwaysAllowNull = null;\n-        if (conf.getSchemaProperties() != null) {\n-            jsr310ConversionEnabled = conf.getSchemaProperties().get(JSR_310_CONVERSION_ENABLED);\n-            alwaysAllowNull = conf.getSchemaProperties().get(ALWAYS_ALLOW_NULL);\n-        }\n-        //\"jsr310ConversionEnabled\" default value is false; \"alwaysAllowNull\" default value is true\n-        return AvroSchema.of(SchemaDefinition.<T>builder().withPojo(clazz)\n-                .withJSR310ConversionEnabled(!StringUtils.isEmpty(jsr310ConversionEnabled) && Boolean.parseBoolean(jsr310ConversionEnabled))\n-                .withAlwaysAllowNull(StringUtils.isEmpty(alwaysAllowNull) || Boolean.parseBoolean(alwaysAllowNull))\n-                .build());\n-    }\n-\n     private static boolean isProtobufClass(Class<?> pojoClazz) {\n         try {\n             Class<?> protobufBaseClass = Class.forName(\"com.google.protobuf.GeneratedMessageV3\");\n"}}, {"oid": "bbc49266fd1257460863e178cfa5f5e903f53406", "url": "https://github.com/apache/pulsar/commit/bbc49266fd1257460863e178cfa5f5e903f53406", "message": "build Schema with SchemaDefinitionBuilder", "committedDate": "2020-06-08T09:44:27Z", "type": "commit"}, {"oid": "338d72c38a9e968140fe960e4c76fc2c220a0cb6", "url": "https://github.com/apache/pulsar/commit/338d72c38a9e968140fe960e4c76fc2c220a0cb6", "message": "Merge remote-tracking branch 'origin/fix' into fix", "committedDate": "2020-06-08T09:46:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg0MzM0MQ==", "url": "https://github.com/apache/pulsar/pull/6868#discussion_r436843341", "bodyText": "Can you explain why do you introduce two new settings without underscores?", "author": "sijie", "createdAt": "2020-06-08T16:38:48Z", "path": "pulsar-client/src/main/java/org/apache/pulsar/client/impl/schema/SchemaDefinitionBuilderImpl.java", "diffHunk": "@@ -35,7 +35,9 @@\n public class SchemaDefinitionBuilderImpl<T> implements SchemaDefinitionBuilder<T> {\n \n     public static final String ALWAYS_ALLOW_NULL = \"__alwaysAllowNull\";\n+    public static final String ALWAYS_ALLOW_NULL_NO_UNDERLINED = \"alwaysAllowNull\";", "originalCommit": "338d72c38a9e968140fe960e4c76fc2c220a0cb6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg0MzkwMA==", "url": "https://github.com/apache/pulsar/pull/6868#discussion_r436843900", "bodyText": "Why can't we use the existing settings?", "author": "sijie", "createdAt": "2020-06-08T16:39:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg0MzM0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzExNTE2MQ==", "url": "https://github.com/apache/pulsar/pull/6868#discussion_r437115161", "bodyText": "Already use existing settings\u3002This may cause some parameters to be underscores, some not\n@sijie", "author": "315157973", "createdAt": "2020-06-09T03:18:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg0MzM0MQ=="}], "type": "inlineReview", "revised_code": {"commit": "ec4f9adaf734e03659596ea1f2c11ed4d20d3b68", "chunk": "diff --git a/pulsar-client/src/main/java/org/apache/pulsar/client/impl/schema/SchemaDefinitionBuilderImpl.java b/pulsar-client/src/main/java/org/apache/pulsar/client/impl/schema/SchemaDefinitionBuilderImpl.java\nindex 34ea910aa40..d929c019d19 100644\n--- a/pulsar-client/src/main/java/org/apache/pulsar/client/impl/schema/SchemaDefinitionBuilderImpl.java\n+++ b/pulsar-client/src/main/java/org/apache/pulsar/client/impl/schema/SchemaDefinitionBuilderImpl.java\n\n@@ -35,9 +35,7 @@ import java.util.Map;\n public class SchemaDefinitionBuilderImpl<T> implements SchemaDefinitionBuilder<T> {\n \n     public static final String ALWAYS_ALLOW_NULL = \"__alwaysAllowNull\";\n-    public static final String ALWAYS_ALLOW_NULL_NO_UNDERLINED = \"alwaysAllowNull\";\n     public static final String JSR310_CONVERSION_ENABLED = \"__jsr310ConversionEnabled\";\n-    public static final String JSR310_CONVERSION_ENABLED_NO_UNDERLINED = \"jsr310ConversionEnabled\";\n \n     /**\n      * the schema definition class\n"}}, {"oid": "ec4f9adaf734e03659596ea1f2c11ed4d20d3b68", "url": "https://github.com/apache/pulsar/commit/ec4f9adaf734e03659596ea1f2c11ed4d20d3b68", "message": "remove param without underscores", "committedDate": "2020-06-09T02:37:43Z", "type": "commit"}, {"oid": "ef619525ae3fbcc8e23323fe4f2f1fa5eec98481", "url": "https://github.com/apache/pulsar/commit/ef619525ae3fbcc8e23323fe4f2f1fa5eec98481", "message": "remove param without underscores", "committedDate": "2020-06-09T03:17:48Z", "type": "commit"}]}