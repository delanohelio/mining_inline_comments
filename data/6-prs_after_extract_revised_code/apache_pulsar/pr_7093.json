{"pr_number": 7093, "pr_title": "Add control of single topic gc in inactive state.", "pr_createdAt": "2020-05-29T06:07:32Z", "pr_url": "https://github.com/apache/pulsar/pull/7093", "timeline": [{"oid": "d8603d75b714b9a3a87bcf37d091d8eb998efb2f", "url": "https://github.com/apache/pulsar/commit/d8603d75b714b9a3a87bcf37d091d8eb998efb2f", "message": "Add control of single topic gc in inactive state.", "committedDate": "2020-05-29T03:30:17Z", "type": "commit"}, {"oid": "6f0fc6a549a8bfbf1ff03aa68b5355149f22cd18", "url": "https://github.com/apache/pulsar/commit/6f0fc6a549a8bfbf1ff03aa68b5355149f22cd18", "message": "use original name of parameter.", "committedDate": "2020-05-29T10:26:22Z", "type": "commit"}, {"oid": "478fb75c18ed95c25acf571988a81c01c2c852b1", "url": "https://github.com/apache/pulsar/commit/478fb75c18ed95c25acf571988a81c01c2c852b1", "message": "add getter and setter.", "committedDate": "2020-05-29T10:28:51Z", "type": "commit"}, {"oid": "9adb53867fee4a13b9ee0843270c3cba6a22b2e3", "url": "https://github.com/apache/pulsar/commit/9adb53867fee4a13b9ee0843270c3cba6a22b2e3", "message": "change notes.", "committedDate": "2020-05-29T10:33:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc4NzE3OQ==", "url": "https://github.com/apache/pulsar/pull/7093#discussion_r432787179", "bodyText": "How is this supposed to be activated?\nInstead, we need a namespace policy, attached to https://pulsar.apache.org/admin-rest-api/?version=2.5.2#operation/setAutoTopicCreation that adds the auto-deletion override configuration, on top of the auto-creation", "author": "merlimat", "createdAt": "2020-05-30T00:01:08Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/AbstractTopic.java", "diffHunk": "@@ -423,5 +428,13 @@ public long getBytesOutCounter() {\n         return getStats(false).bytesOutCounter;\n     }\n \n+    public boolean isBrokerDeleteInactiveTopicsEnabled() {\n+        return brokerDeleteInactiveTopicsEnabled;\n+    }\n+\n+    public void setBrokerDeleteInactiveTopicsEnabled(boolean brokerDeleteInactiveTopicsEnabled) {", "originalCommit": "9adb53867fee4a13b9ee0843270c3cba6a22b2e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjkwMjc4Mw==", "url": "https://github.com/apache/pulsar/pull/7093#discussion_r432902783", "bodyText": "@merlimat This is used by the protocol handlers who want to ensure some topics under the namespace does not delete by the broker. But do not want to change the namespace level policy. Now, we don't have a topic level policy, without this change, we must create a virtual producer or consume.", "author": "codelipenghui", "createdAt": "2020-05-31T02:12:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc4NzE3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "e0dc906f26842b0949b344e03b0f8462d51342de", "chunk": "diff --git a/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/AbstractTopic.java b/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/AbstractTopic.java\nindex 723b806373c..0bf20a34948 100644\n--- a/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/AbstractTopic.java\n+++ b/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/AbstractTopic.java\n\n@@ -428,12 +428,12 @@ public abstract class AbstractTopic implements Topic {\n         return getStats(false).bytesOutCounter;\n     }\n \n-    public boolean isBrokerDeleteInactiveTopicsEnabled() {\n-        return brokerDeleteInactiveTopicsEnabled;\n+    public boolean isDeleteWhileInactive() {\n+        return deleteWhileInactive;\n     }\n \n-    public void setBrokerDeleteInactiveTopicsEnabled(boolean brokerDeleteInactiveTopicsEnabled) {\n-        this.brokerDeleteInactiveTopicsEnabled = brokerDeleteInactiveTopicsEnabled;\n+    public void setDeleteWhileInactive(boolean deleteWhileInactive) {\n+        this.deleteWhileInactive = deleteWhileInactive;\n     }\n \n     private static final Logger log = LoggerFactory.getLogger(AbstractTopic.class);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjkwMjkxMA==", "url": "https://github.com/apache/pulsar/pull/7093#discussion_r432902910", "bodyText": "I think it's better to named deleteWhileInactive.", "author": "codelipenghui", "createdAt": "2020-05-31T02:14:55Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/AbstractTopic.java", "diffHunk": "@@ -63,6 +63,9 @@\n \n     protected volatile boolean isFenced;\n \n+    // When set to false, this inactive topic can not be deleted\n+    protected boolean brokerDeleteInactiveTopicsEnabled;", "originalCommit": "9adb53867fee4a13b9ee0843270c3cba6a22b2e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjkzODU4NA==", "url": "https://github.com/apache/pulsar/pull/7093#discussion_r432938584", "bodyText": "Done.", "author": "zhanghaou", "createdAt": "2020-05-31T11:45:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjkwMjkxMA=="}], "type": "inlineReview", "revised_code": {"commit": "e0dc906f26842b0949b344e03b0f8462d51342de", "chunk": "diff --git a/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/AbstractTopic.java b/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/AbstractTopic.java\nindex 723b806373c..0bf20a34948 100644\n--- a/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/AbstractTopic.java\n+++ b/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/AbstractTopic.java\n\n@@ -64,7 +64,7 @@ public abstract class AbstractTopic implements Topic {\n     protected volatile boolean isFenced;\n \n     // When set to false, this inactive topic can not be deleted\n-    protected boolean brokerDeleteInactiveTopicsEnabled;\n+    protected boolean deleteWhileInactive;\n \n     // Timestamp of when this topic was last seen active\n     protected volatile long lastActive;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjkwMzAxMg==", "url": "https://github.com/apache/pulsar/pull/7093#discussion_r432903012", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (brokerDeleteInactiveTopicsEnabled) {\n          \n          \n            \n                    if (! brokerDeleteInactiveTopicsEnabled) {", "author": "codelipenghui", "createdAt": "2020-05-31T02:17:01Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/nonpersistent/NonPersistentTopic.java", "diffHunk": "@@ -830,6 +830,10 @@ public boolean isActive() {\n \n     @Override\n     public void checkGC(int maxInactiveDurationInSec, InactiveTopicDeleteMode deleteMode) {\n+        if (brokerDeleteInactiveTopicsEnabled) {", "originalCommit": "9adb53867fee4a13b9ee0843270c3cba6a22b2e3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0dc906f26842b0949b344e03b0f8462d51342de", "chunk": "diff --git a/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/nonpersistent/NonPersistentTopic.java b/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/nonpersistent/NonPersistentTopic.java\nindex 2866786dd46..eb8d9d339e0 100644\n--- a/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/nonpersistent/NonPersistentTopic.java\n+++ b/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/nonpersistent/NonPersistentTopic.java\n\n@@ -830,7 +830,7 @@ public class NonPersistentTopic extends AbstractTopic implements Topic {\n \n     @Override\n     public void checkGC(int maxInactiveDurationInSec, InactiveTopicDeleteMode deleteMode) {\n-        if (brokerDeleteInactiveTopicsEnabled) {\n+        if (!deleteWhileInactive) {\n             // This topic is not included in GC\n             return;\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjkwMzAzNQ==", "url": "https://github.com/apache/pulsar/pull/7093#discussion_r432903035", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (brokerDeleteInactiveTopicsEnabled) {\n          \n          \n            \n                    if (!brokerDeleteInactiveTopicsEnabled) {", "author": "codelipenghui", "createdAt": "2020-05-31T02:17:37Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java", "diffHunk": "@@ -1636,6 +1629,10 @@ private boolean hasBacklogs() {\n \n     @Override\n     public void checkGC(int maxInactiveDurationInSec, InactiveTopicDeleteMode deleteMode) {\n+        if (brokerDeleteInactiveTopicsEnabled) {", "originalCommit": "9adb53867fee4a13b9ee0843270c3cba6a22b2e3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0dc906f26842b0949b344e03b0f8462d51342de", "chunk": "diff --git a/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java b/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java\nindex 7dde1caa22d..095443b2848 100644\n--- a/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java\n+++ b/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java\n\n@@ -1629,7 +1629,7 @@ public class PersistentTopic extends AbstractTopic implements Topic, AddEntryCal\n \n     @Override\n     public void checkGC(int maxInactiveDurationInSec, InactiveTopicDeleteMode deleteMode) {\n-        if (brokerDeleteInactiveTopicsEnabled) {\n+        if (!deleteWhileInactive) {\n             // This topic is not included in GC\n             return;\n         }\n"}}, {"oid": "e0dc906f26842b0949b344e03b0f8462d51342de", "url": "https://github.com/apache/pulsar/commit/e0dc906f26842b0949b344e03b0f8462d51342de", "message": "rename to deleteWhileInactive and logic fix.", "committedDate": "2020-05-31T11:44:59Z", "type": "commit"}, {"oid": "1efb772a467c93296dfd82ef21eef673a480ebc7", "url": "https://github.com/apache/pulsar/commit/1efb772a467c93296dfd82ef21eef673a480ebc7", "message": "Merge pull request #2 from apache/master\n\nMerge from Pulsar's master branch.", "committedDate": "2020-06-04T02:14:46Z", "type": "commit"}]}