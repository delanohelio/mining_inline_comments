{"pr_number": 6128, "pr_title": "Fix broker client tls settings error", "pr_createdAt": "2020-01-23T02:15:38Z", "pr_url": "https://github.com/apache/pulsar/pull/6128", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk4ODU1MQ==", "url": "https://github.com/apache/pulsar/pull/6128#discussion_r369988551", "bodyText": "Generally the cacert should be the same. What scenario let you to this problem?", "author": "ivankelly", "createdAt": "2020-01-23T08:42:21Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/PulsarService.java", "diffHunk": "@@ -873,12 +873,16 @@ public synchronized PulsarClient getClient() throws PulsarServerException {\n                 ClientBuilder builder = PulsarClient.builder()\n                     .serviceUrl(this.getConfiguration().isTlsEnabled()\n                                 ? this.brokerServiceUrlTls : this.brokerServiceUrl)\n-                    .enableTls(this.getConfiguration().isTlsEnabled())\n-                    .allowTlsInsecureConnection(this.getConfiguration().isTlsAllowInsecureConnection())\n-                    .tlsTrustCertsFilePath(this.getConfiguration().getTlsCertificateFilePath());\n+                    .enableTls(this.getConfiguration().isTlsEnabled());\n+\n+                if (this.getConfiguration().isBrokerClientTlsEnabled()) {\n+                    builder.allowTlsInsecureConnection(this.getConfiguration().isTlsAllowInsecureConnection());\n+                    builder.tlsTrustCertsFilePath(this.getConfiguration().getBrokerClientTrustCertsFilePath());", "originalCommit": "4f889e5c3e0345ba5effb8139d8d6611cbf89ba7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDYzNjI2Nw==", "url": "https://github.com/apache/pulsar/pull/6128#discussion_r370636267", "bodyText": "This is internal client, and the setting should be brokerClientXXX", "author": "jiazhai", "createdAt": "2020-01-24T13:36:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk4ODU1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY2MTg0NA==", "url": "https://github.com/apache/pulsar/pull/6128#discussion_r370661844", "bodyText": "yes, I get that. I'm just wondering what sort of set up requires a different CA cert for broker client and for the server. The broker client is going to connect to other brokers in the same cluster, which will have the same CA.\nMy concern here is that people will have configured with only the tls certificate path, and not the broker client tls cert path. This change will break their configuration. Given than both paths are likely to be the same, if broker client tls cert path is empty, it should fall back to tls certificate path.", "author": "ivankelly", "createdAt": "2020-01-24T14:30:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk4ODU1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg3OTI1MQ==", "url": "https://github.com/apache/pulsar/pull/6128#discussion_r372879251", "bodyText": "@ivankelly, Thanks. A user meet this issue in their environment. As you mentioned, the content of path for the 2 configs could be the same, but we should provide the ability for user to set it differently. All the auth logic is the same for internal client, in all the admin-client and the replicator-client, it is all set as this change, this is the only place that is not align.", "author": "jiazhai", "createdAt": "2020-01-30T10:49:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk4ODU1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ0MDYxMA==", "url": "https://github.com/apache/pulsar/pull/6128#discussion_r373440610", "bodyText": "Providing the ability to have different values is good. However, current behaviour is that just setting tlsCertificateFilePath is enough for both. This change requires that both values are set, which breaks people using the current behaviour. The correct fix here is to use brokerClientTrustCertsFilePath it is non-empty, otherwise use tlsCertificateFilePath.", "author": "ivankelly", "createdAt": "2020-01-31T11:43:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk4ODU1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgyNjA4NA==", "url": "https://github.com/apache/pulsar/pull/6128#discussion_r373826084", "bodyText": "@ivankelly. thanks. changed following your comments, and merged with latest master", "author": "jiazhai", "createdAt": "2020-02-02T07:43:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk4ODU1MQ=="}], "type": "inlineReview", "revised_code": {"commit": "1c6661062f4942ab2889c7d662db968b7cae29ab", "chunk": "diff --git a/pulsar-broker/src/main/java/org/apache/pulsar/broker/PulsarService.java b/pulsar-broker/src/main/java/org/apache/pulsar/broker/PulsarService.java\nindex d41869a97a5..b1d6d794774 100644\n--- a/pulsar-broker/src/main/java/org/apache/pulsar/broker/PulsarService.java\n+++ b/pulsar-broker/src/main/java/org/apache/pulsar/broker/PulsarService.java\n\n@@ -877,7 +881,10 @@ public class PulsarService implements AutoCloseable {\n \n                 if (this.getConfiguration().isBrokerClientTlsEnabled()) {\n                     builder.allowTlsInsecureConnection(this.getConfiguration().isTlsAllowInsecureConnection());\n-                    builder.tlsTrustCertsFilePath(this.getConfiguration().getBrokerClientTrustCertsFilePath());\n+                    builder.tlsTrustCertsFilePath(\n+                        isNotBlank(this.getConfiguration().getBrokerClientTrustCertsFilePath())\n+                            ? this.getConfiguration().getBrokerClientTrustCertsFilePath()\n+                            : this.getConfiguration().getTlsCertificateFilePath());\n                 }\n \n                 if (isNotBlank(this.getConfiguration().getBrokerClientAuthenticationPlugin())) {\n"}}, {"oid": "1c6661062f4942ab2889c7d662db968b7cae29ab", "url": "https://github.com/apache/pulsar/commit/1c6661062f4942ab2889c7d662db968b7cae29ab", "message": "change following comments", "committedDate": "2020-02-02T07:42:19Z", "type": "forcePushed"}, {"oid": "a90d03a5f91af21f57a7c3141db79409f08449ae", "url": "https://github.com/apache/pulsar/commit/a90d03a5f91af21f57a7c3141db79409f08449ae", "message": "change following comments", "committedDate": "2020-02-12T01:31:13Z", "type": "forcePushed"}, {"oid": "2eb763885763102f30ee690dd4a72d19c7226415", "url": "https://github.com/apache/pulsar/commit/2eb763885763102f30ee690dd4a72d19c7226415", "message": "change following comments", "committedDate": "2020-02-19T06:58:34Z", "type": "forcePushed"}, {"oid": "a72f0be2ff9ca4b4ac68db7cb07a37de1f57254e", "url": "https://github.com/apache/pulsar/commit/a72f0be2ff9ca4b4ac68db7cb07a37de1f57254e", "message": "fix broker client tls settings error", "committedDate": "2020-02-23T08:36:54Z", "type": "commit"}, {"oid": "35866c313bcc35ff3c8bc3d71af01bdd20d15478", "url": "https://github.com/apache/pulsar/commit/35866c313bcc35ff3c8bc3d71af01bdd20d15478", "message": "change following comments", "committedDate": "2020-02-23T08:36:54Z", "type": "commit"}, {"oid": "cf898a3f233e903a6b3f5bb7c51f3e6d75a51f53", "url": "https://github.com/apache/pulsar/commit/cf898a3f233e903a6b3f5bb7c51f3e6d75a51f53", "message": "python-ut: move print before assert", "committedDate": "2020-02-23T08:58:37Z", "type": "commit"}, {"oid": "cf898a3f233e903a6b3f5bb7c51f3e6d75a51f53", "url": "https://github.com/apache/pulsar/commit/cf898a3f233e903a6b3f5bb7c51f3e6d75a51f53", "message": "python-ut: move print before assert", "committedDate": "2020-02-23T08:58:37Z", "type": "forcePushed"}, {"oid": "71e13c3b69922b0b43369035b0caa8322729e956", "url": "https://github.com/apache/pulsar/commit/71e13c3b69922b0b43369035b0caa8322729e956", "message": "change to make backward compat", "committedDate": "2020-02-23T10:52:30Z", "type": "commit"}]}