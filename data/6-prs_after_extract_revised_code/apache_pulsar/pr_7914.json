{"pr_number": 7914, "pr_title": "[ISSUE 7758] Support set Max Producer on topic level.", "pr_createdAt": "2020-08-27T01:17:18Z", "pr_url": "https://github.com/apache/pulsar/pull/7914", "timeline": [{"oid": "45ddc52f5428ec872857035b4825eecd5f517c32", "url": "https://github.com/apache/pulsar/commit/45ddc52f5428ec872857035b4825eecd5f517c32", "message": "[ISSUE 7758] Support set Max Producer on topic level.", "committedDate": "2020-08-27T01:15:19Z", "type": "commit"}, {"oid": "2522a08430dc5ec8fdd0f534038e3183aea4dc8c", "url": "https://github.com/apache/pulsar/commit/2522a08430dc5ec8fdd0f534038e3183aea4dc8c", "message": "Merge pull request #1 from apache/master\n\nmerge", "committedDate": "2020-08-28T02:05:01Z", "type": "commit"}, {"oid": "0a9fc4564896818f476b75cac4d7f1c7a311c279", "url": "https://github.com/apache/pulsar/commit/0a9fc4564896818f476b75cac4d7f1c7a311c279", "message": "Merge branch 'master' into set-max-producer\n\n# Conflicts:\n#\tpulsar-broker/src/main/java/org/apache/pulsar/broker/service/AbstractTopic.java", "committedDate": "2020-08-28T02:09:27Z", "type": "commit"}, {"oid": "a3880bb4ab7d82b4f58efeca351a9ebb1b601147", "url": "https://github.com/apache/pulsar/commit/a3880bb4ab7d82b4f58efeca351a9ebb1b601147", "message": "Merge pull request #2 from apache/master\n\nmerge", "committedDate": "2020-08-31T01:04:34Z", "type": "commit"}, {"oid": "2b5f07578d1dcfe34832c2063b65226847ac25fe", "url": "https://github.com/apache/pulsar/commit/2b5f07578d1dcfe34832c2063b65226847ac25fe", "message": "Merge remote-tracking branch 'origin/master' into set-max-producer\n\n# Conflicts:\n#\tpulsar-broker/src/test/java/org/apache/pulsar/broker/admin/TopicPoliciesDisableTest.java\n#\tpulsar-client-admin/src/main/java/org/apache/pulsar/client/admin/Topics.java\n#\tpulsar-client-admin/src/main/java/org/apache/pulsar/client/admin/internal/TopicsImpl.java\n#\tpulsar-client-tools/src/main/java/org/apache/pulsar/admin/cli/CmdTopics.java", "committedDate": "2020-08-31T01:14:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg2MzkwMA==", "url": "https://github.com/apache/pulsar/pull/7914#discussion_r479863900", "bodyText": "Please return CompletableFuture< Integer > instead of passing in AsyncResponse.", "author": "jianyun8023", "createdAt": "2020-08-31T02:59:27Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "diffHunk": "@@ -2368,6 +2371,53 @@ protected void internalGetPersistence(AsyncResponse asyncResponse){\n         return pulsar().getTopicPoliciesService().updateTopicPoliciesAsync(topicName, topicPolicies.get());\n     }\n \n+    protected void internalGetMaxProducers(AsyncResponse asyncResponse) {\n+        validateAdminAccessForTenant(namespaceName.getTenant());\n+        validatePoliciesReadOnlyAccess();\n+        if (topicName.isGlobal()) {\n+            validateGlobalNamespaceOwnership(namespaceName);\n+        }\n+        checkTopicLevelPolicyEnable();\n+        Optional<Integer> maxProducers = getTopicPolicies(topicName)\n+                .map(TopicPolicies::getMaxProducerPerTopic);\n+        if (!maxProducers.isPresent()) {\n+            asyncResponse.resume(Response.noContent().build());\n+        } else {\n+            asyncResponse.resume(maxProducers.get());\n+        }\n+    }", "originalCommit": "2b5f07578d1dcfe34832c2063b65226847ac25fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg2NDE1MA==", "url": "https://github.com/apache/pulsar/pull/7914#discussion_r479864150", "bodyText": "Or directly return Integer.", "author": "jianyun8023", "createdAt": "2020-08-31T03:00:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg2MzkwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA5ODExMA==", "url": "https://github.com/apache/pulsar/pull/7914#discussion_r482098110", "bodyText": "It seems some methods similar to this also need to modify, can we modify it all?", "author": "zhanghaou", "createdAt": "2020-09-02T14:08:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg2MzkwMA=="}], "type": "inlineReview", "revised_code": {"commit": "13df37f3e29e3c4f1696ed92405940c2405aab85", "chunk": "diff --git a/pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java b/pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java\nindex b6e3e41babb..a25bf37d32e 100644\n--- a/pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java\n+++ b/pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java\n\n@@ -2371,53 +2367,6 @@ public class PersistentTopicsBase extends AdminResource {\n         return pulsar().getTopicPoliciesService().updateTopicPoliciesAsync(topicName, topicPolicies.get());\n     }\n \n-    protected void internalGetMaxProducers(AsyncResponse asyncResponse) {\n-        validateAdminAccessForTenant(namespaceName.getTenant());\n-        validatePoliciesReadOnlyAccess();\n-        if (topicName.isGlobal()) {\n-            validateGlobalNamespaceOwnership(namespaceName);\n-        }\n-        checkTopicLevelPolicyEnable();\n-        Optional<Integer> maxProducers = getTopicPolicies(topicName)\n-                .map(TopicPolicies::getMaxProducerPerTopic);\n-        if (!maxProducers.isPresent()) {\n-            asyncResponse.resume(Response.noContent().build());\n-        } else {\n-            asyncResponse.resume(maxProducers.get());\n-        }\n-    }\n-\n-    protected CompletableFuture<Void> internalSetMaxProducers(Integer maxProducers) {\n-        validateAdminAccessForTenant(namespaceName.getTenant());\n-        validatePoliciesReadOnlyAccess();\n-        if (topicName.isGlobal()) {\n-            validateGlobalNamespaceOwnership(namespaceName);\n-        }\n-        checkTopicLevelPolicyEnable();\n-        if (maxProducers < 0) {\n-            throw new RestException(Status.PRECONDITION_FAILED,\n-                    \"maxProducers must be 0 or more\");\n-        }\n-        TopicPolicies topicPolicies = getTopicPolicies(topicName).orElseGet(TopicPolicies::new);\n-        topicPolicies.setMaxProducerPerTopic(maxProducers);\n-        return pulsar().getTopicPoliciesService().updateTopicPoliciesAsync(topicName, topicPolicies);\n-    }\n-\n-    protected CompletableFuture<Void> internalRemoveMaxProducers() {\n-        validateAdminAccessForTenant(namespaceName.getTenant());\n-        validatePoliciesReadOnlyAccess();\n-        if (topicName.isGlobal()) {\n-            validateGlobalNamespaceOwnership(namespaceName);\n-        }\n-        checkTopicLevelPolicyEnable();\n-        Optional<TopicPolicies> topicPolicies = getTopicPolicies(topicName);\n-        if (!topicPolicies.isPresent()) {\n-            return CompletableFuture.completedFuture(null);\n-        }\n-        topicPolicies.get().setMaxProducerPerTopic(null);\n-        return pulsar().getTopicPoliciesService().updateTopicPoliciesAsync(topicName, topicPolicies.get());\n-    }\n-\n     protected MessageId internalTerminate(boolean authoritative) {\n         if (topicName.isGlobal()) {\n             validateGlobalNamespaceOwnership(namespaceName);\n"}}, {"oid": "13df37f3e29e3c4f1696ed92405940c2405aab85", "url": "https://github.com/apache/pulsar/commit/13df37f3e29e3c4f1696ed92405940c2405aab85", "message": "Merge pull request #3 from apache/master\n\nmerge", "committedDate": "2020-09-03T00:03:30Z", "type": "commit"}, {"oid": "55e92d0020fc1e428422ff01d16127294e373492", "url": "https://github.com/apache/pulsar/commit/55e92d0020fc1e428422ff01d16127294e373492", "message": "Merge remote-tracking branch 'origin/master' into set-max-producer\n\n# Conflicts:\n#\tpulsar-broker/src/test/java/org/apache/pulsar/broker/admin/TopicPoliciesDisableTest.java\n#\tpulsar-client-admin/src/main/java/org/apache/pulsar/client/admin/Topics.java\n#\tpulsar-client-admin/src/main/java/org/apache/pulsar/client/admin/internal/TopicsImpl.java\n#\tpulsar-client-tools/src/main/java/org/apache/pulsar/admin/cli/CmdTopics.java", "committedDate": "2020-09-03T00:09:40Z", "type": "commit"}, {"oid": "37b03da26962c963980cb4ec7319deb5639e5c5d", "url": "https://github.com/apache/pulsar/commit/37b03da26962c963980cb4ec7319deb5639e5c5d", "message": "fix merge error", "committedDate": "2020-09-03T00:35:43Z", "type": "commit"}]}