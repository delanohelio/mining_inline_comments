{"pr_number": 6787, "pr_title": "Using Readers still causes backlog quota to be observed", "pr_createdAt": "2020-04-21T20:02:11Z", "pr_url": "https://github.com/apache/pulsar/pull/6787", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQ1ODUzMg==", "url": "https://github.com/apache/pulsar/pull/6787#discussion_r412458532", "bodyText": "nit: the section below should get indented.", "author": "merlimat", "createdAt": "2020-04-21T20:11:14Z", "path": "managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedCursorContainer.java", "diffHunk": "@@ -124,6 +130,8 @@ public void removeCursor(String name) {\n \n             PositionImpl previousSlowestConsumer = heap.get(0).position;\n \n+            if (item.cursor.isDurable()) {\n+", "originalCommit": "8ce2886d98a3a5bebfcad139cb441cada0118851", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjcxMDMzNg==", "url": "https://github.com/apache/pulsar/pull/6787#discussion_r412710336", "bodyText": "fixed", "author": "jerrypeng", "createdAt": "2020-04-22T06:40:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQ1ODUzMg=="}], "type": "inlineReview", "revised_code": {"commit": "3603a85dac7aa6e92149687cffdb48b879c60c7f", "chunk": "diff --git a/managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedCursorContainer.java b/managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedCursorContainer.java\nindex aafa61fbeb9..db887f0b492 100644\n--- a/managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedCursorContainer.java\n+++ b/managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedCursorContainer.java\n\n@@ -128,24 +131,24 @@ public class ManagedCursorContainer implements Iterable<ManagedCursor> {\n                 return null;\n             }\n \n-            PositionImpl previousSlowestConsumer = heap.get(0).position;\n \n             if (item.cursor.isDurable()) {\n+                PositionImpl previousSlowestConsumer = heap.get(0).position;\n \n-            // When the cursor moves forward, we need to push it toward the\n-            // bottom of the tree and push it up if a reset was done\n+                // When the cursor moves forward, we need to push it toward the\n+                // bottom of the tree and push it up if a reset was done\n \n-            item.position = (PositionImpl) newPosition;\n-            if (item.idx == 0 || getParent(item).position.compareTo(item.position) <= 0) {\n-                siftDown(item);\n-            } else {\n-                siftUp(item);\n-            }\n+                item.position = (PositionImpl) newPosition;\n+                if (item.idx == 0 || getParent(item).position.compareTo(item.position) <= 0) {\n+                    siftDown(item);\n+                } else {\n+                    siftUp(item);\n+                }\n \n-            PositionImpl newSlowestConsumer = heap.get(0).position;\n-                return Pair.of(previousSlowestConsumer, newSlowestConsumer);\n+                PositionImpl newSlowestConsumer = heap.get(0).position;\n+                    return Pair.of(previousSlowestConsumer, newSlowestConsumer);\n             }\n-            return Pair.of(previousSlowestConsumer, previousSlowestConsumer);\n+            return null;\n         } finally {\n             rwLock.unlockWrite(stamp);\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzEzMzEyMw==", "url": "https://github.com/apache/pulsar/pull/6787#discussion_r413133123", "bodyText": "It's becoming a bit confusing now to understand the meaning of hasCursors() and isEmpty(). We should be use a more unambiguous/explicit naming here.\nMy suggestion:\n\nhasCursors() --> isEmtpy() // Since we're talking about a cursors container\nisEmpty() --> hasDurableCursors()\n\n(and fix the reversal of the boolean logic)", "author": "merlimat", "createdAt": "2020-04-22T16:31:27Z", "path": "managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedCursorContainer.java", "diffHunk": "@@ -164,6 +175,22 @@ public ManagedCursor getSlowestReader() {\n         }\n     }\n \n+    public boolean hasCursors() {", "originalCommit": "3d0132221ecc371c1229573a76ad325841f0d92e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3603a85dac7aa6e92149687cffdb48b879c60c7f", "chunk": "diff --git a/managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedCursorContainer.java b/managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedCursorContainer.java\nindex 67f93456524..db887f0b492 100644\n--- a/managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedCursorContainer.java\n+++ b/managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedCursorContainer.java\n\n@@ -175,7 +177,11 @@ public class ManagedCursorContainer implements Iterable<ManagedCursor> {\n         }\n     }\n \n-    public boolean hasCursors() {\n+    /**\n+     *  Check whether there are any cursors\n+     * @return true is there are no cursors and false if there are\n+     */\n+    public boolean isEmpty() {\n         long stamp = rwLock.tryOptimisticRead();\n         boolean isEmpty = cursors.isEmpty();\n         if (!rwLock.validate(stamp)) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzEzMzgzNA==", "url": "https://github.com/apache/pulsar/pull/6787#discussion_r413133834", "bodyText": "Wouldn't the logic be the reverse here? We're checking isEmpty but the method should return true if it's not empty, no?", "author": "merlimat", "createdAt": "2020-04-22T16:32:27Z", "path": "managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedCursorContainer.java", "diffHunk": "@@ -164,6 +175,22 @@ public ManagedCursor getSlowestReader() {\n         }\n     }\n \n+    public boolean hasCursors() {\n+        long stamp = rwLock.tryOptimisticRead();\n+        boolean isEmpty = cursors.isEmpty();\n+        if (!rwLock.validate(stamp)) {\n+            // Fallback to read lock\n+            stamp = rwLock.readLock();\n+            try {\n+                isEmpty = cursors.isEmpty();", "originalCommit": "3d0132221ecc371c1229573a76ad325841f0d92e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE4MDkyNA==", "url": "https://github.com/apache/pulsar/pull/6787#discussion_r413180924", "bodyText": "Ya just used the same logic as \"isEmpty\" but the name of the method hints at a different semantic meaning.", "author": "jerrypeng", "createdAt": "2020-04-22T17:34:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzEzMzgzNA=="}], "type": "inlineReview", "revised_code": {"commit": "3603a85dac7aa6e92149687cffdb48b879c60c7f", "chunk": "diff --git a/managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedCursorContainer.java b/managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedCursorContainer.java\nindex 67f93456524..db887f0b492 100644\n--- a/managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedCursorContainer.java\n+++ b/managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedCursorContainer.java\n\n@@ -175,7 +177,11 @@ public class ManagedCursorContainer implements Iterable<ManagedCursor> {\n         }\n     }\n \n-    public boolean hasCursors() {\n+    /**\n+     *  Check whether there are any cursors\n+     * @return true is there are no cursors and false if there are\n+     */\n+    public boolean isEmpty() {\n         long stamp = rwLock.tryOptimisticRead();\n         boolean isEmpty = cursors.isEmpty();\n         if (!rwLock.validate(stamp)) {\n"}}, {"oid": "3603a85dac7aa6e92149687cffdb48b879c60c7f", "url": "https://github.com/apache/pulsar/commit/3603a85dac7aa6e92149687cffdb48b879c60c7f", "message": "Using Readers still causes backlog quota to be observed", "committedDate": "2020-04-22T18:05:16Z", "type": "forcePushed"}, {"oid": "360044f30097dd26bed71ac16c685b28ecd4ed37", "url": "https://github.com/apache/pulsar/commit/360044f30097dd26bed71ac16c685b28ecd4ed37", "message": "Using Readers still causes backlog quota to be observed", "committedDate": "2020-06-08T05:06:14Z", "type": "commit"}, {"oid": "360044f30097dd26bed71ac16c685b28ecd4ed37", "url": "https://github.com/apache/pulsar/commit/360044f30097dd26bed71ac16c685b28ecd4ed37", "message": "Using Readers still causes backlog quota to be observed", "committedDate": "2020-06-08T05:06:14Z", "type": "forcePushed"}]}