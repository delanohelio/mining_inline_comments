{"pr_number": 8493, "pr_title": "[Transaction] Register transaction metadata before send or ack messages", "pr_createdAt": "2020-11-09T18:12:00Z", "pr_url": "https://github.com/apache/pulsar/pull/8493", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDM2OTMwNQ==", "url": "https://github.com/apache/pulsar/pull/8493#discussion_r520369305", "bodyText": "Should we handle the exception here? If the metadata register failed, we can't send message or ack", "author": "codelipenghui", "createdAt": "2020-11-10T08:19:23Z", "path": "pulsar-client/src/main/java/org/apache/pulsar/client/impl/ConsumerBase.java", "diffHunk": "@@ -473,30 +473,34 @@ public void negativeAcknowledge(Message<?> message) {\n     protected CompletableFuture<Void> doAcknowledgeWithTxn(List<MessageId> messageIdList, AckType ackType,\n                                                            Map<String,Long> properties,\n                                                            TransactionImpl txn) {\n-        CompletableFuture<Void> ackFuture = doAcknowledge(messageIdList, ackType, properties, txn);\n+        CompletableFuture<Void> ackFuture;\n         if (txn != null) {\n-            txn.registerAckedTopic(getTopic(), subscription);\n-            return txn.registerAckOp(ackFuture);\n+            ackFuture = txn.registerAckedTopic(getTopic(), subscription)\n+                    .thenCompose(ignored -> doAcknowledge(messageIdList, ackType, properties, txn));\n+            txn.registerAckOp(ackFuture);", "originalCommit": "5649d3408992d00fec302cb48771fed0494ce89f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "522489bac39a84b9af7391d2b2ea045b8d37567e", "chunk": "diff --git a/pulsar-client/src/main/java/org/apache/pulsar/client/impl/ConsumerBase.java b/pulsar-client/src/main/java/org/apache/pulsar/client/impl/ConsumerBase.java\nindex 99ccdf083c2..b6dfe8c088f 100644\n--- a/pulsar-client/src/main/java/org/apache/pulsar/client/impl/ConsumerBase.java\n+++ b/pulsar-client/src/main/java/org/apache/pulsar/client/impl/ConsumerBase.java\n\n@@ -492,6 +492,10 @@ public abstract class ConsumerBase<T> extends HandlerState implements Consumer<T\n             // it is okay that we register acked topic after sending the acknowledgements. because\n             // the transactional ack will not be visiable for consumers until the transaction is\n             // committed\n+            if (ackType == AckType.Cumulative) {\n+                txn.registerCumulativeAckConsumer((ConsumerImpl<?>) this);\n+            }\n+\n             ackFuture = txn.registerAckedTopic(getTopic(), subscription)\n                     .thenCompose(ignored -> doAcknowledge(messageId, ackType, properties, txn));\n             // register the ackFuture as part of the transaction\n"}}, {"oid": "522489bac39a84b9af7391d2b2ea045b8d37567e", "url": "https://github.com/apache/pulsar/commit/522489bac39a84b9af7391d2b2ea045b8d37567e", "message": "fix test", "committedDate": "2020-11-11T07:42:57Z", "type": "forcePushed"}, {"oid": "a2e7f438477ca3081ad9d05c7eb59d1ad03759fe", "url": "https://github.com/apache/pulsar/commit/a2e7f438477ca3081ad9d05c7eb59d1ad03759fe", "message": "register transaction metadata before send transaction messages", "committedDate": "2020-11-12T03:56:35Z", "type": "commit"}, {"oid": "40e637eceb6d8056521679133b3421c85305e5b4", "url": "https://github.com/apache/pulsar/commit/40e637eceb6d8056521679133b3421c85305e5b4", "message": "register transaction metadata before ack transaction messages", "committedDate": "2020-11-12T03:56:35Z", "type": "commit"}, {"oid": "dd1fc52a5ec65a9cca2186a3d588e11ed9a9d53c", "url": "https://github.com/apache/pulsar/commit/dd1fc52a5ec65a9cca2186a3d588e11ed9a9d53c", "message": "fix test", "committedDate": "2020-11-12T03:56:35Z", "type": "commit"}, {"oid": "dd1fc52a5ec65a9cca2186a3d588e11ed9a9d53c", "url": "https://github.com/apache/pulsar/commit/dd1fc52a5ec65a9cca2186a3d588e11ed9a9d53c", "message": "fix test", "committedDate": "2020-11-12T03:56:35Z", "type": "forcePushed"}, {"oid": "d58182fd7dfa4348e3eececc8e1cc646754ae5e4", "url": "https://github.com/apache/pulsar/commit/d58182fd7dfa4348e3eececc8e1cc646754ae5e4", "message": "fix test", "committedDate": "2020-11-12T15:20:15Z", "type": "commit"}]}