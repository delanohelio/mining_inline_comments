{"pr_number": 7010, "pr_title": "Fix null pointer when getting function instance metrics.", "pr_createdAt": "2020-05-21T06:46:21Z", "pr_url": "https://github.com/apache/pulsar/pull/7010", "timeline": [{"oid": "8cc120c5338c124c1d7428982e8fc975d1086a26", "url": "https://github.com/apache/pulsar/commit/8cc120c5338c124c1d7428982e8fc975d1086a26", "message": "Fix null pointer when getting function instance metrics.", "committedDate": "2020-05-21T06:43:04Z", "type": "commit"}, {"oid": "8828accf43c48c42f229fcb326bc76b9e69c1e37", "url": "https://github.com/apache/pulsar/commit/8828accf43c48c42f229fcb326bc76b9e69c1e37", "message": "Made more functions sync", "committedDate": "2020-05-21T07:20:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODcyODYxNw==", "url": "https://github.com/apache/pulsar/pull/7010#discussion_r428728617", "bodyText": "We should synchronize this method as well?\nAlso line 241 (run() method) accesses the stats variable and the close() method does too. Difference threads access these methods and change the stats variable. It's the same for other variables in this class.", "author": "cckellogg", "createdAt": "2020-05-21T15:29:27Z", "path": "pulsar-functions/instance/src/main/java/org/apache/pulsar/functions/instance/JavaInstanceRunnable.java", "diffHunk": "@@ -801,4 +810,12 @@ public void setupOutput(ContextImpl contextImpl) throws Exception {\n             Thread.currentThread().setContextClassLoader(this.instanceClassLoader);\n         }\n     }\n+\n+    public String getStatsAsString() throws IOException {", "originalCommit": "8828accf43c48c42f229fcb326bc76b9e69c1e37", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODczMjI0Nw==", "url": "https://github.com/apache/pulsar/pull/7010#discussion_r428732247", "bodyText": "yes. Done", "author": "srkukarni", "createdAt": "2020-05-21T15:35:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODcyODYxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODczNzY3NA==", "url": "https://github.com/apache/pulsar/pull/7010#discussion_r428737674", "bodyText": "There is a follow up change coming up that makes stats class threadsafe.", "author": "srkukarni", "createdAt": "2020-05-21T15:43:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODcyODYxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg1MTk2NQ==", "url": "https://github.com/apache/pulsar/pull/7010#discussion_r428851965", "bodyText": "Actually I've made the stats class synchronized to ensure that it becomes threadsafe.\nAlso have moved the setup syncronized, so that it and close won't be able to run together", "author": "srkukarni", "createdAt": "2020-05-21T19:01:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODcyODYxNw=="}], "type": "inlineReview", "revised_code": {"commit": "b0e8c980cfc7e62af19a71c58a1698de5ba2af55", "chunk": "diff --git a/pulsar-functions/instance/src/main/java/org/apache/pulsar/functions/instance/JavaInstanceRunnable.java b/pulsar-functions/instance/src/main/java/org/apache/pulsar/functions/instance/JavaInstanceRunnable.java\nindex db907c9b895..ccb489455cb 100644\n--- a/pulsar-functions/instance/src/main/java/org/apache/pulsar/functions/instance/JavaInstanceRunnable.java\n+++ b/pulsar-functions/instance/src/main/java/org/apache/pulsar/functions/instance/JavaInstanceRunnable.java\n\n@@ -811,7 +811,7 @@ public class JavaInstanceRunnable implements AutoCloseable, Runnable {\n         }\n     }\n \n-    public String getStatsAsString() throws IOException {\n+    synchronized public String getStatsAsString() throws IOException {\n         if (stats != null) {\n             return stats.getStatsAsString();\n         } else {\n"}}, {"oid": "b0e8c980cfc7e62af19a71c58a1698de5ba2af55", "url": "https://github.com/apache/pulsar/commit/b0e8c980cfc7e62af19a71c58a1698de5ba2af55", "message": "Made the remaining public interface synchronized", "committedDate": "2020-05-21T15:34:22Z", "type": "commit"}, {"oid": "1341ad8b529559b2c2021cc57dae5c870b069862", "url": "https://github.com/apache/pulsar/commit/1341ad8b529559b2c2021cc57dae5c870b069862", "message": "Made stats class public method synchronized so they are thread safe.", "committedDate": "2020-05-21T18:53:22Z", "type": "commit"}, {"oid": "5edf17c0ea4ed017ea3ffbc42088e6fb5951b7b5", "url": "https://github.com/apache/pulsar/commit/5edf17c0ea4ed017ea3ffbc42088e6fb5951b7b5", "message": "Made setup synchronized so that it and close won't run together", "committedDate": "2020-05-21T18:58:55Z", "type": "commit"}, {"oid": "bf04dc78f73951c993d289786d166496b17a51f8", "url": "https://github.com/apache/pulsar/commit/bf04dc78f73951c993d289786d166496b17a51f8", "message": "Undo making stats sync until we resolve differences", "committedDate": "2020-05-21T21:00:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkyNDQ5OQ==", "url": "https://github.com/apache/pulsar/pull/7010#discussion_r428924499", "bodyText": "Even though synchronized methods are re-entrant in Java, it still appears a little weird that a synchronized getMetrics() be called inside another synchronized method \"getAndResetMetrics()\".  Maybe have another \"base\" private method that gets called by both that is not synchronized?\nA side note, I think in the future, we might want to define more interfaces for \"modules\" in functions, so that it is more clear on what methods should be exposed.", "author": "jerrypeng", "createdAt": "2020-05-21T21:27:12Z", "path": "pulsar-functions/instance/src/main/java/org/apache/pulsar/functions/instance/JavaInstanceRunnable.java", "diffHunk": "@@ -546,13 +547,17 @@ synchronized public void close() {\n         }\n     }\n \n-    public InstanceCommunication.MetricsData getAndResetMetrics() {\n+    // This method is synchronized because it is using the stats variable\n+    synchronized public InstanceCommunication.MetricsData getAndResetMetrics() {\n         InstanceCommunication.MetricsData metricsData = getMetrics();\n-        stats.reset();\n+        if (stats != null) {\n+            stats.reset();\n+        }\n         return metricsData;\n     }\n \n-    public InstanceCommunication.MetricsData getMetrics() {\n+    // This method is synchronized because it is using the stats and javaInstance variables\n+    synchronized public InstanceCommunication.MetricsData getMetrics() {", "originalCommit": "bf04dc78f73951c993d289786d166496b17a51f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk2ODUwOA==", "url": "https://github.com/apache/pulsar/pull/7010#discussion_r428968508", "bodyText": "Changed it", "author": "srkukarni", "createdAt": "2020-05-21T23:32:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkyNDQ5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "1574f8ee1857a7598f6ecfed4dfd2fd4070c5282", "chunk": "diff --git a/pulsar-functions/instance/src/main/java/org/apache/pulsar/functions/instance/JavaInstanceRunnable.java b/pulsar-functions/instance/src/main/java/org/apache/pulsar/functions/instance/JavaInstanceRunnable.java\nindex 8b2221df8f9..892c7e54fff 100644\n--- a/pulsar-functions/instance/src/main/java/org/apache/pulsar/functions/instance/JavaInstanceRunnable.java\n+++ b/pulsar-functions/instance/src/main/java/org/apache/pulsar/functions/instance/JavaInstanceRunnable.java\n\n@@ -547,17 +547,32 @@ public class JavaInstanceRunnable implements AutoCloseable, Runnable {\n         }\n     }\n \n-    // This method is synchronized because it is using the stats variable\n-    synchronized public InstanceCommunication.MetricsData getAndResetMetrics() {\n-        InstanceCommunication.MetricsData metricsData = getMetrics();\n+    synchronized public String getStatsAsString() throws IOException {\n         if (stats != null) {\n-            stats.reset();\n+            return stats.getStatsAsString();\n+        } else {\n+            return \"\";\n         }\n+    }\n+\n+    // This method is synchronized because it is using the stats variable\n+    synchronized public InstanceCommunication.MetricsData getAndResetMetrics() {\n+        InstanceCommunication.MetricsData metricsData = internalGetMetrics();\n+        internalResetMetrics();\n         return metricsData;\n     }\n \n     // This method is synchronized because it is using the stats and javaInstance variables\n     synchronized public InstanceCommunication.MetricsData getMetrics() {\n+        return internalGetMetrics();\n+    }\n+\n+    // This method is synchronized because it is using the stats and javaInstance variables\n+    synchronized public void resetMetrics() {\n+        internalResetMetrics();\n+    }\n+\n+    private InstanceCommunication.MetricsData internalGetMetrics() {\n         InstanceCommunication.MetricsData.Builder bldr = createMetricsDataBuilder();\n         if (javaInstance != null) {\n             Map<String, Double> userMetrics =  javaInstance.getMetrics();\n"}}, {"oid": "1574f8ee1857a7598f6ecfed4dfd2fd4070c5282", "url": "https://github.com/apache/pulsar/commit/1574f8ee1857a7598f6ecfed4dfd2fd4070c5282", "message": "Incorporated feedback", "committedDate": "2020-05-21T23:31:52Z", "type": "commit"}, {"oid": "ed5108a69be258e8e14ba6ca5fdd390b526b5277", "url": "https://github.com/apache/pulsar/commit/ed5108a69be258e8e14ba6ca5fdd390b526b5277", "message": "Merge branch 'master' into nullptr_exception", "committedDate": "2020-05-22T12:41:41Z", "type": "commit"}]}