{"pr_number": 8284, "pr_title": "Fix Broker enters an infinite loop in ManagedLedgerImpl.asyncReadEntries", "pr_createdAt": "2020-10-17T05:16:43Z", "pr_url": "https://github.com/apache/pulsar/pull/8284", "timeline": [{"oid": "2a8b060e472de06ef202ca352393d068d6192258", "url": "https://github.com/apache/pulsar/commit/2a8b060e472de06ef202ca352393d068d6192258", "message": "Fix Broker enters an infinite loop in ManagedLedgerImpl.asyncReadEntries", "committedDate": "2020-10-17T05:11:38Z", "type": "commit"}, {"oid": "8282ba0748603d3f26e46a9fd261ed97878958c5", "url": "https://github.com/apache/pulsar/commit/8282ba0748603d3f26e46a9fd261ed97878958c5", "message": "format code", "committedDate": "2020-10-17T05:23:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjgyMjA5Mg==", "url": "https://github.com/apache/pulsar/pull/8284#discussion_r506822092", "bodyText": "Looks like it's better to move it to the following if ... else ...\nif (currentLedger == null || ledger.getId() != currentLedger.getId()) {\n       ...\n} else {\n      opReadEntry.updateReadPosition(opReadEntry.readPosition);\n}", "author": "codelipenghui", "createdAt": "2020-10-17T06:11:13Z", "path": "managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedLedgerImpl.java", "diffHunk": "@@ -1618,6 +1616,8 @@ private void internalReadFromLedger(ReadHandle ledger, OpReadEntry opReadEntry)\n                         ledger.getId(), lastEntryInLedger, firstEntry);\n             }\n \n+            opReadEntry.updateReadPosition(opReadEntry.readPosition);", "originalCommit": "8282ba0748603d3f26e46a9fd261ed97878958c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjgyNDY0OQ==", "url": "https://github.com/apache/pulsar/pull/8284#discussion_r506824649", "bodyText": "elegant!", "author": "hangc0276", "createdAt": "2020-10-17T06:17:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjgyMjA5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "7b40a05858d6fcc1d17076d25de723946e608410", "chunk": "diff --git a/managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedLedgerImpl.java b/managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedLedgerImpl.java\nindex 5c3b7386419..d265b2f3d6c 100644\n--- a/managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedLedgerImpl.java\n+++ b/managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedLedgerImpl.java\n\n@@ -1616,8 +1616,6 @@ public class ManagedLedgerImpl implements ManagedLedger, CreateCallback {\n                         ledger.getId(), lastEntryInLedger, firstEntry);\n             }\n \n-            opReadEntry.updateReadPosition(opReadEntry.readPosition);\n-\n             if (currentLedger == null || ledger.getId() != currentLedger.getId()) {\n                 // Cursor was placed past the end of one ledger, move it to the\n                 // beginning of the next ledger\n"}}, {"oid": "7b40a05858d6fcc1d17076d25de723946e608410", "url": "https://github.com/apache/pulsar/commit/7b40a05858d6fcc1d17076d25de723946e608410", "message": "format code", "committedDate": "2020-10-17T06:21:28Z", "type": "commit"}]}