{"pr_number": 8197, "pr_title": "fix pulsar service close exception", "pr_createdAt": "2020-10-04T06:57:56Z", "pr_url": "https://github.com/apache/pulsar/pull/8197", "timeline": [{"oid": "8be26cfc1430e02a6098bca0db83448c7d0bdfb3", "url": "https://github.com/apache/pulsar/commit/8be26cfc1430e02a6098bca0db83448c7d0bdfb3", "message": "fix pulsar service close exception", "committedDate": "2020-10-04T06:40:52Z", "type": "commit"}, {"oid": "43c2280be72f43678e401b7ec5d45d62f9492a64", "url": "https://github.com/apache/pulsar/commit/43c2280be72f43678e401b7ec5d45d62f9492a64", "message": "format code", "committedDate": "2020-10-04T06:57:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTIxODU3Nw==", "url": "https://github.com/apache/pulsar/pull/8197#discussion_r499218577", "bodyText": "In BrokerService we are setting this field to null.\nWe could run into some NPE anyway in the future.\nIt is better to assign the result of getInterceptor to a local variable and then deference it safely, without calling twice this getter", "author": "eolivelli", "createdAt": "2020-10-04T08:13:02Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/ServerCnx.java", "diffHunk": "@@ -215,7 +215,9 @@ public void channelInactive(ChannelHandlerContext ctx) throws Exception {\n         super.channelInactive(ctx);\n         isActive = false;\n         log.info(\"Closed connection from {}\", remoteAddress);\n-        getBrokerService().getInterceptor().onConnectionClosed(this);\n+        if (getBrokerService().getInterceptor() != null) {\n+            getBrokerService().getInterceptor().onConnectionClosed(this);", "originalCommit": "43c2280be72f43678e401b7ec5d45d62f9492a64", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTIyMTcxMA==", "url": "https://github.com/apache/pulsar/pull/8197#discussion_r499221710", "bodyText": "@eolivelli Thanks for your feedback. I will use the a local variable to avoid calling twice of getInterceptor.", "author": "hangc0276", "createdAt": "2020-10-04T08:50:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTIxODU3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "e80cbadf3a4a8016b938d20e63bed0a78576bdfa", "chunk": "diff --git a/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/ServerCnx.java b/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/ServerCnx.java\nindex 6ec7f9953e2..aa72c7aa32b 100644\n--- a/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/ServerCnx.java\n+++ b/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/ServerCnx.java\n\n@@ -215,8 +216,9 @@ public class ServerCnx extends PulsarHandler {\n         super.channelInactive(ctx);\n         isActive = false;\n         log.info(\"Closed connection from {}\", remoteAddress);\n-        if (getBrokerService().getInterceptor() != null) {\n-            getBrokerService().getInterceptor().onConnectionClosed(this);\n+        BrokerInterceptor brokerInterceptor = getBrokerService().getInterceptor();\n+        if (brokerInterceptor != null) {\n+            brokerInterceptor.onConnectionClosed(this);\n         }\n         // Connection is gone, close the producers immediately\n         producers.values().forEach((producerFuture) -> {\n"}}, {"oid": "e80cbadf3a4a8016b938d20e63bed0a78576bdfa", "url": "https://github.com/apache/pulsar/commit/e80cbadf3a4a8016b938d20e63bed0a78576bdfa", "message": "use local variable to avoid calling getInterceptor twice", "committedDate": "2020-10-04T08:52:52Z", "type": "commit"}]}