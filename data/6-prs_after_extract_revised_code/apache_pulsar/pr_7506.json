{"pr_number": 7506, "pr_title": "[Broker] Timeout opening managed ledger operation \u2026", "pr_createdAt": "2020-07-10T19:39:54Z", "pr_url": "https://github.com/apache/pulsar/pull/7506", "timeline": [{"oid": "0790de4d1fa0b01a66ce3c55aaccc867a31b9499", "url": "https://github.com/apache/pulsar/commit/0790de4d1fa0b01a66ce3c55aaccc867a31b9499", "message": "[Broker] Timeout opening managed ledger operation\n\n*Motivation*\n\nCurrently broker has a timeout mechanism on loading topics. However the underlying managed ledger library\ndoesn't provide a timeout mechanism. This will get into a situation that: A TopicLoad operation times out\nafter 30 seconds. But the CompletableFuture of opening a managed ledger is still kept in the cache of managed ledger\nfactory. The completable future will never returns. So any sub-sequent topic lookups will fail because any\nattempts to load a topic will never attempt to re-open a managed ledger.\n\n*Modification*\n\nIntroduce a timeout mechanism in managed ledger factory. If a managed ledger is not open within a given timeout\nperiod, the CompletableFuture will be removed. This allows any sub-sequent attempts to load topics can try to\nopen the managed ledger again.\n\n*Tests*\n\nThis problem can be constantly reproduced in a chaos test in kubernetes by killing k8s worker nodes. It can cause\nproducer stuck forever until the owner broker pod is restarted. The change has been verified in a chaos testing environment.", "committedDate": "2020-07-10T19:15:44Z", "type": "commit"}, {"oid": "298bee79b3ff92037ae69977ca764ab7b2576c4d", "url": "https://github.com/apache/pulsar/commit/298bee79b3ff92037ae69977ca764ab7b2576c4d", "message": "Remove redundant imports", "committedDate": "2020-07-10T19:38:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA2OTI5Nw==", "url": "https://github.com/apache/pulsar/pull/7506#discussion_r453069297", "bodyText": "As opposed to requiring another call to check if the timeout has elapsed, would it make sense to instead use a CompletableFuture with a timeout? Much like we do in the BrokerService, the future created on line 370 could instead be made to have a timeout if it isn't resolved in so many milliseconds with the error handler remove the future from the cache of futures.", "author": "addisonj", "createdAt": "2020-07-10T20:46:14Z", "path": "managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedLedgerFactoryImpl.java", "diffHunk": "@@ -320,18 +335,32 @@ public void asyncOpen(final String name, final ManagedLedgerConfig config, final\n \n         // If the ledger state is bad, remove it from the map.\n         CompletableFuture<ManagedLedgerImpl> existingFuture = ledgers.get(name);\n-        if (existingFuture != null && existingFuture.isDone()) {\n-            try {\n-                ManagedLedgerImpl l = existingFuture.get();\n-                if (l.getState().equals(State.Fenced.toString()) || l.getState().equals(State.Closed.toString())) {\n-                    // Managed ledger is in unusable state. Recreate it.\n-                    log.warn(\"[{}] Attempted to open ledger in {} state. Removing from the map to recreate it\", name,\n+        if (existingFuture != null) {\n+            if (existingFuture.isDone()) {\n+                try {\n+                    ManagedLedgerImpl l = existingFuture.get();\n+                    if (l.getState().equals(State.Fenced.toString()) || l.getState().equals(State.Closed.toString())) {\n+                        // Managed ledger is in unusable state. Recreate it.\n+                        log.warn(\"[{}] Attempted to open ledger in {} state. Removing from the map to recreate it\", name,\n                             l.getState());\n-                    ledgers.remove(name, existingFuture);\n+                        ledgers.remove(name, existingFuture);\n+                    }\n+                } catch (Exception e) {\n+                    // Unable to get the future\n+                    log.warn(\"[{}] Got exception while trying to retrieve ledger\", name, e);\n                 }\n-            } catch (Exception e) {\n-                // Unable to get the future\n-                log.warn(\"[{}] Got exception while trying to retrieve ledger\", name, e);\n+            } else {\n+                PendingInitializeManagedLedger pendingLedger = pendingInitializeLedgers.get(name);", "originalCommit": "298bee79b3ff92037ae69977ca764ab7b2576c4d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzEwNjgxNg==", "url": "https://github.com/apache/pulsar/pull/7506#discussion_r453106816", "bodyText": "We can do that. However, I didn't go down that route because of the following reason:\nwe need to keep the ManageLedger reference and to close it to release resources. Because the initialization involves a long pipeline including opening managed ledger and cursors. The behavior we observed is that the operation is stuck at opening cursors. So if we don't attempt to close the ManagedLedger instance, it can result in resource leaking.\nWith that being said, we need to keep a reference to ManagedLedgerImpl along with the CompletableFuture. Hence I chose the current implementation.\nAnother reason is to allow checking the timestamp proactively. I fixed a couple of issues before that NPE is thrown between creating a Future and registering error handling logic. I would like to have a mechanism in place that can fix any potential bugs by proactively checking if a CompletableFuture timed out.", "author": "sijie", "createdAt": "2020-07-10T22:35:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA2OTI5Nw=="}], "type": "inlineReview", "revised_code": null}]}