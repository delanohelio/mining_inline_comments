{"pr_number": 8995, "pr_title": "remove duplicated broker prometheus metrics type", "pr_createdAt": "2020-12-17T23:48:13Z", "pr_url": "https://github.com/apache/pulsar/pull/8995", "timeline": [{"oid": "869a46e8e5588b2baac77bba49ddc396552e1b52", "url": "https://github.com/apache/pulsar/commit/869a46e8e5588b2baac77bba49ddc396552e1b52", "message": "remove duplicated broker prometheus metrics type", "committedDate": "2020-12-17T23:31:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTY1OTM1Nw==", "url": "https://github.com/apache/pulsar/pull/8995#discussion_r545659357", "bodyText": "I think this block has intention issue.", "author": "sijie", "createdAt": "2020-12-18T08:39:47Z", "path": "pulsar-broker/src/test/java/org/apache/pulsar/broker/stats/PrometheusMetricsTest.java", "diffHunk": "@@ -591,18 +595,63 @@ public void testManagedLedgerStats() throws Exception {\n                 System.out.println(e.getKey() + \": \" + e.getValue())\n         );\n \n+        Map<String, String> typeDefs = new HashMap<String, String>();\n+        Map<String, String> metricNames = new HashMap<String, String>();\n+\n+        Pattern typePattern = Pattern.compile(\"^#\\\\s+TYPE\\\\s+(\\\\w+)\\\\s+(\\\\w+)\");\n+        Pattern metricNamePattern = Pattern.compile(\"^(\\\\w+)\\\\{.+\");\n+\n+\t    Splitter.on(\"\\n\").split(metricsStr).forEach(line -> {", "originalCommit": "869a46e8e5588b2baac77bba49ddc396552e1b52", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTY1OTc0Mw==", "url": "https://github.com/apache/pulsar/pull/8995#discussion_r545659743", "bodyText": "We don't use tabs in the code.", "author": "sijie", "createdAt": "2020-12-18T08:40:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTY1OTM1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg2NTg2OA==", "url": "https://github.com/apache/pulsar/pull/8995#discussion_r545865868", "bodyText": "Removed the tab. The code block is to catch any issues with duplicated definition of metrics TYPE and also ensures the metric name matches the ones defined in the type definition header.", "author": "zzzming", "createdAt": "2020-12-18T14:29:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTY1OTM1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "2e0f2087d5ff5439a37d7e5479b96fc8b61a5be6", "chunk": "diff --git a/pulsar-broker/src/test/java/org/apache/pulsar/broker/stats/PrometheusMetricsTest.java b/pulsar-broker/src/test/java/org/apache/pulsar/broker/stats/PrometheusMetricsTest.java\nindex f1d21892e08..cba6d1e5d19 100644\n--- a/pulsar-broker/src/test/java/org/apache/pulsar/broker/stats/PrometheusMetricsTest.java\n+++ b/pulsar-broker/src/test/java/org/apache/pulsar/broker/stats/PrometheusMetricsTest.java\n\n@@ -601,7 +601,7 @@ public class PrometheusMetricsTest extends BrokerTestBase {\n         Pattern typePattern = Pattern.compile(\"^#\\\\s+TYPE\\\\s+(\\\\w+)\\\\s+(\\\\w+)\");\n         Pattern metricNamePattern = Pattern.compile(\"^(\\\\w+)\\\\{.+\");\n \n-\t    Splitter.on(\"\\n\").split(metricsStr).forEach(line -> {\n+        Splitter.on(\"\\n\").split(metricsStr).forEach(line -> {\n             if (line.isEmpty()) {\n                 return;\n             }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTY2MDY4Mw==", "url": "https://github.com/apache/pulsar/pull/8995#discussion_r545660683", "bodyText": "I am not sure why do we need this line if it will fail before this line.", "author": "sijie", "createdAt": "2020-12-18T08:41:03Z", "path": "pulsar-broker/src/test/java/org/apache/pulsar/broker/stats/PrometheusMetricsTest.java", "diffHunk": "@@ -591,18 +595,63 @@ public void testManagedLedgerStats() throws Exception {\n                 System.out.println(e.getKey() + \": \" + e.getValue())\n         );\n \n+        Map<String, String> typeDefs = new HashMap<String, String>();\n+        Map<String, String> metricNames = new HashMap<String, String>();\n+\n+        Pattern typePattern = Pattern.compile(\"^#\\\\s+TYPE\\\\s+(\\\\w+)\\\\s+(\\\\w+)\");\n+        Pattern metricNamePattern = Pattern.compile(\"^(\\\\w+)\\\\{.+\");\n+\n+\t    Splitter.on(\"\\n\").split(metricsStr).forEach(line -> {\n+            if (line.isEmpty()) {\n+                return;\n+            }\n+            if (line.startsWith(\"#\")) {\n+                // Check for duplicate type definitions\n+                Matcher typeMatcher = typePattern.matcher(line);\n+                checkArgument(typeMatcher.matches());\n+                String metricName = typeMatcher.group(1);\n+                String type = typeMatcher.group(2);\n+\n+                // From https://github.com/prometheus/docs/blob/master/content/docs/instrumenting/exposition_formats.md\n+                // \"Only one TYPE line may exist for a given metric name.\"\n+                if (!typeDefs.containsKey(metricName)) {\n+                    typeDefs.put(metricName, type);\n+                } else {\n+                    fail(\"Duplicate type definition found for TYPE definition \" + metricName);\n+                    System.out.println(metricsStr);", "originalCommit": "869a46e8e5588b2baac77bba49ddc396552e1b52", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg2NDE0Mg==", "url": "https://github.com/apache/pulsar/pull/8995#discussion_r545864142", "bodyText": "removed", "author": "zzzming", "createdAt": "2020-12-18T14:27:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTY2MDY4Mw=="}], "type": "inlineReview", "revised_code": {"commit": "2e0f2087d5ff5439a37d7e5479b96fc8b61a5be6", "chunk": "diff --git a/pulsar-broker/src/test/java/org/apache/pulsar/broker/stats/PrometheusMetricsTest.java b/pulsar-broker/src/test/java/org/apache/pulsar/broker/stats/PrometheusMetricsTest.java\nindex f1d21892e08..cba6d1e5d19 100644\n--- a/pulsar-broker/src/test/java/org/apache/pulsar/broker/stats/PrometheusMetricsTest.java\n+++ b/pulsar-broker/src/test/java/org/apache/pulsar/broker/stats/PrometheusMetricsTest.java\n\n@@ -601,7 +601,7 @@ public class PrometheusMetricsTest extends BrokerTestBase {\n         Pattern typePattern = Pattern.compile(\"^#\\\\s+TYPE\\\\s+(\\\\w+)\\\\s+(\\\\w+)\");\n         Pattern metricNamePattern = Pattern.compile(\"^(\\\\w+)\\\\{.+\");\n \n-\t    Splitter.on(\"\\n\").split(metricsStr).forEach(line -> {\n+        Splitter.on(\"\\n\").split(metricsStr).forEach(line -> {\n             if (line.isEmpty()) {\n                 return;\n             }\n"}}, {"oid": "2e0f2087d5ff5439a37d7e5479b96fc8b61a5be6", "url": "https://github.com/apache/pulsar/commit/2e0f2087d5ff5439a37d7e5479b96fc8b61a5be6", "message": "fix review comments", "committedDate": "2020-12-18T14:26:41Z", "type": "commit"}]}