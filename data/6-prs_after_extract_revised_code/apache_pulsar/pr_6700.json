{"pr_number": 6700, "pr_title": "Improve backlogSize stats in the topic.", "pr_createdAt": "2020-04-09T13:57:57Z", "pr_url": "https://github.com/apache/pulsar/pull/6700", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM3MDk1NA==", "url": "https://github.com/apache/pulsar/pull/6700#discussion_r406370954", "bodyText": "The test should assert here instead of printing. Also make sure it's more robust against race conditions", "author": "merlimat", "createdAt": "2020-04-09T17:44:24Z", "path": "pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/AdminApiTest.java", "diffHunk": "@@ -2424,4 +2424,30 @@ public void testTopicStatsLastExpireTimestampForSubscription() throws PulsarAdmi\n \n         Assert.assertTrue(admin.topics().getStats(topic).subscriptions.values().iterator().next().lastExpireTimestamp > 0L);\n     }\n+\n+    @Test\n+    public void testBacklogSizeShouldBeZeroWhenConsumerAckedAllMessages() throws Exception {\n+        final String topic = \"persistent://prop-xyz/ns1/testBacklogSizeShouldBeZeroWhenConsumerAckedAllMessages\";\n+        Consumer<byte[]> consumer = pulsarClient.newConsumer()\n+                .topic(topic)\n+                .subscriptionName(\"sub-1\")\n+                .subscribe();\n+        Producer<byte[]> producer = pulsarClient.newProducer()\n+                .topic(topic)\n+                .create();\n+\n+        for (int i = 0; i < 33; i++) {\n+            producer.send(new byte[1024 * i * 5]);\n+        }\n+\n+        for (int i = 0; i < 33; i++) {\n+            consumer.acknowledgeCumulative(consumer.receive());\n+        }\n+\n+        // Wait ack send\n+        Thread.sleep(1000);\n+\n+        TopicStats topicStats = admin.topics().getStats(topic);\n+        System.out.println(topicStats.backlogSize);", "originalCommit": "3e2394a7cf6f8094ca3a41cd3bc388adb80336a1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f1427260193f4e27e0279ecaec80c20bd0b12114", "chunk": "diff --git a/pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/AdminApiTest.java b/pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/AdminApiTest.java\nindex cfbe091028f..427a165f15c 100644\n--- a/pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/AdminApiTest.java\n+++ b/pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/AdminApiTest.java\n\n@@ -2436,11 +2436,12 @@ public class AdminApiTest extends MockedPulsarServiceBaseTest {\n                 .topic(topic)\n                 .create();\n \n-        for (int i = 0; i < 33; i++) {\n+        final int messages = 33;\n+        for (int i = 0; i < messages; i++) {\n             producer.send(new byte[1024 * i * 5]);\n         }\n \n-        for (int i = 0; i < 33; i++) {\n+        for (int i = 0; i < messages; i++) {\n             consumer.acknowledgeCumulative(consumer.receive());\n         }\n \n"}}, {"oid": "c0b19a3da536683e6dd054d0ec75689a3058698d", "url": "https://github.com/apache/pulsar/commit/c0b19a3da536683e6dd054d0ec75689a3058698d", "message": "Improve backlogSize stats in the topic.", "committedDate": "2020-04-12T01:30:17Z", "type": "commit"}, {"oid": "f1427260193f4e27e0279ecaec80c20bd0b12114", "url": "https://github.com/apache/pulsar/commit/f1427260193f4e27e0279ecaec80c20bd0b12114", "message": "Fix tests", "committedDate": "2020-04-12T01:30:17Z", "type": "commit"}, {"oid": "f1427260193f4e27e0279ecaec80c20bd0b12114", "url": "https://github.com/apache/pulsar/commit/f1427260193f4e27e0279ecaec80c20bd0b12114", "message": "Fix tests", "committedDate": "2020-04-12T01:30:17Z", "type": "forcePushed"}]}