{"pr_number": 8208, "pr_title": "Use ThreadPoolExecutor instead of EventLoop", "pr_createdAt": "2020-10-06T07:41:02Z", "pr_url": "https://github.com/apache/pulsar/pull/8208", "timeline": [{"oid": "e3bf030cdf96952a48c25ba93af95f9a795061d6", "url": "https://github.com/apache/pulsar/commit/e3bf030cdf96952a48c25ba93af95f9a795061d6", "message": "use ThreadPoolExecutor", "committedDate": "2020-10-06T07:17:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA2OTAzOA==", "url": "https://github.com/apache/pulsar/pull/8208#discussion_r500069038", "bodyText": "we must shutdown this executor, otherwise we are leaking threads", "author": "eolivelli", "createdAt": "2020-10-06T07:42:50Z", "path": "pulsar-client/src/main/java/org/apache/pulsar/client/impl/PulsarClientImpl.java", "diffHunk": "@@ -145,6 +147,8 @@ public PulsarClientImpl(ClientConfigurationData conf, EventLoopGroup eventLoopGr\n         conf.getAuthentication().start();\n         this.cnxPool = cnxPool;\n         externalExecutorProvider = new ExecutorProvider(conf.getNumListenerThreads(), getThreadFactory(\"pulsar-external-listener\"));\n+        ioExecutorService = new ThreadPoolExecutor(conf.getNumIoThreads(), conf.getNumIoThreads(), 0L, TimeUnit.MILLISECONDS,", "originalCommit": "e3bf030cdf96952a48c25ba93af95f9a795061d6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b19536ba52067d72a2378d83fa3eb2a057c72932", "chunk": "diff --git a/pulsar-client/src/main/java/org/apache/pulsar/client/impl/PulsarClientImpl.java b/pulsar-client/src/main/java/org/apache/pulsar/client/impl/PulsarClientImpl.java\nindex 32e66de90ac..3853c3185d6 100644\n--- a/pulsar-client/src/main/java/org/apache/pulsar/client/impl/PulsarClientImpl.java\n+++ b/pulsar-client/src/main/java/org/apache/pulsar/client/impl/PulsarClientImpl.java\n\n@@ -147,8 +147,7 @@ public class PulsarClientImpl implements PulsarClient {\n         conf.getAuthentication().start();\n         this.cnxPool = cnxPool;\n         externalExecutorProvider = new ExecutorProvider(conf.getNumListenerThreads(), getThreadFactory(\"pulsar-external-listener\"));\n-        ioExecutorService = new ThreadPoolExecutor(conf.getNumIoThreads(), conf.getNumIoThreads(), 0L, TimeUnit.MILLISECONDS,\n-                new LinkedBlockingQueue<>(), getThreadFactory(\"pulsar-io-thread\"));\n+        internalExecutorService = new ExecutorProvider(conf.getNumIoThreads(), getThreadFactory(\"pulsar-client-io\"));\n         if (conf.getServiceUrl().startsWith(\"http\")) {\n             lookup = new HttpLookupService(conf, eventLoopGroup);\n         } else {\n"}}, {"oid": "8612e46e11d617bddfe7268d57b5a3b3b9250aa4", "url": "https://github.com/apache/pulsar/commit/8612e46e11d617bddfe7268d57b5a3b3b9250aa4", "message": "add shutdown", "committedDate": "2020-10-06T07:46:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTAyOTc1OA==", "url": "https://github.com/apache/pulsar/pull/8208#discussion_r501029758", "bodyText": "Now we already have threads named pulsar-client-io, so it's better to use a different name for the new threads. And I noticed some internal tasks of the client also uses the externalExecutorProvider for executing the internal task of the Pulsar client. Maybe we can add an internalExecutorService for handing the internal tasks of the client.", "author": "codelipenghui", "createdAt": "2020-10-07T13:51:59Z", "path": "pulsar-client/src/main/java/org/apache/pulsar/client/impl/PulsarClientImpl.java", "diffHunk": "@@ -145,6 +147,8 @@ public PulsarClientImpl(ClientConfigurationData conf, EventLoopGroup eventLoopGr\n         conf.getAuthentication().start();\n         this.cnxPool = cnxPool;\n         externalExecutorProvider = new ExecutorProvider(conf.getNumListenerThreads(), getThreadFactory(\"pulsar-external-listener\"));\n+        ioExecutorService = new ThreadPoolExecutor(conf.getNumIoThreads(), conf.getNumIoThreads(), 0L, TimeUnit.MILLISECONDS,\n+                new LinkedBlockingQueue<>(), getThreadFactory(\"pulsar-io-thread\"));", "originalCommit": "8612e46e11d617bddfe7268d57b5a3b3b9250aa4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b19536ba52067d72a2378d83fa3eb2a057c72932", "chunk": "diff --git a/pulsar-client/src/main/java/org/apache/pulsar/client/impl/PulsarClientImpl.java b/pulsar-client/src/main/java/org/apache/pulsar/client/impl/PulsarClientImpl.java\nindex 88821e12f87..3853c3185d6 100644\n--- a/pulsar-client/src/main/java/org/apache/pulsar/client/impl/PulsarClientImpl.java\n+++ b/pulsar-client/src/main/java/org/apache/pulsar/client/impl/PulsarClientImpl.java\n\n@@ -147,8 +147,7 @@ public class PulsarClientImpl implements PulsarClient {\n         conf.getAuthentication().start();\n         this.cnxPool = cnxPool;\n         externalExecutorProvider = new ExecutorProvider(conf.getNumListenerThreads(), getThreadFactory(\"pulsar-external-listener\"));\n-        ioExecutorService = new ThreadPoolExecutor(conf.getNumIoThreads(), conf.getNumIoThreads(), 0L, TimeUnit.MILLISECONDS,\n-                new LinkedBlockingQueue<>(), getThreadFactory(\"pulsar-io-thread\"));\n+        internalExecutorService = new ExecutorProvider(conf.getNumIoThreads(), getThreadFactory(\"pulsar-client-io\"));\n         if (conf.getServiceUrl().startsWith(\"http\")) {\n             lookup = new HttpLookupService(conf, eventLoopGroup);\n         } else {\n"}}, {"oid": "b19536ba52067d72a2378d83fa3eb2a057c72932", "url": "https://github.com/apache/pulsar/commit/b19536ba52067d72a2378d83fa3eb2a057c72932", "message": "use ExecutorProvider instead", "committedDate": "2020-10-07T16:49:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTcyMDE0NQ==", "url": "https://github.com/apache/pulsar/pull/8208#discussion_r501720145", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    internalExecutorService = new ExecutorProvider(conf.getNumIoThreads(), getThreadFactory(\"pulsar-client-io\"));\n          \n          \n            \n                    internalExecutorService = new ExecutorProvider(conf.getNumIoThreads(), getThreadFactory(\"pulsar-client-internal\"));", "author": "codelipenghui", "createdAt": "2020-10-08T13:28:13Z", "path": "pulsar-client/src/main/java/org/apache/pulsar/client/impl/PulsarClientImpl.java", "diffHunk": "@@ -145,6 +147,7 @@ public PulsarClientImpl(ClientConfigurationData conf, EventLoopGroup eventLoopGr\n         conf.getAuthentication().start();\n         this.cnxPool = cnxPool;\n         externalExecutorProvider = new ExecutorProvider(conf.getNumListenerThreads(), getThreadFactory(\"pulsar-external-listener\"));\n+        internalExecutorService = new ExecutorProvider(conf.getNumIoThreads(), getThreadFactory(\"pulsar-client-io\"));", "originalCommit": "b19536ba52067d72a2378d83fa3eb2a057c72932", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "64daa07e801579c6d83b5fcb0b2a596ba2faf198", "chunk": "diff --git a/pulsar-client/src/main/java/org/apache/pulsar/client/impl/PulsarClientImpl.java b/pulsar-client/src/main/java/org/apache/pulsar/client/impl/PulsarClientImpl.java\nindex 3853c3185d6..64f1ef96de0 100644\n--- a/pulsar-client/src/main/java/org/apache/pulsar/client/impl/PulsarClientImpl.java\n+++ b/pulsar-client/src/main/java/org/apache/pulsar/client/impl/PulsarClientImpl.java\n\n@@ -147,7 +147,7 @@ public class PulsarClientImpl implements PulsarClient {\n         conf.getAuthentication().start();\n         this.cnxPool = cnxPool;\n         externalExecutorProvider = new ExecutorProvider(conf.getNumListenerThreads(), getThreadFactory(\"pulsar-external-listener\"));\n-        internalExecutorService = new ExecutorProvider(conf.getNumIoThreads(), getThreadFactory(\"pulsar-client-io\"));\n+        internalExecutorService = new ExecutorProvider(conf.getNumIoThreads(), getThreadFactory(\"pulsar-client-internal\"));\n         if (conf.getServiceUrl().startsWith(\"http\")) {\n             lookup = new HttpLookupService(conf, eventLoopGroup);\n         } else {\n"}}, {"oid": "64daa07e801579c6d83b5fcb0b2a596ba2faf198", "url": "https://github.com/apache/pulsar/commit/64daa07e801579c6d83b5fcb0b2a596ba2faf198", "message": "Update pulsar-client/src/main/java/org/apache/pulsar/client/impl/PulsarClientImpl.java\n\nCo-authored-by: lipenghui <penghui@apache.org>", "committedDate": "2020-10-11T13:39:50Z", "type": "commit"}, {"oid": "96799c67451f2c8f773844e8d524538bc05f3161", "url": "https://github.com/apache/pulsar/commit/96799c67451f2c8f773844e8d524538bc05f3161", "message": "merge master", "committedDate": "2020-10-12T04:11:09Z", "type": "commit"}]}