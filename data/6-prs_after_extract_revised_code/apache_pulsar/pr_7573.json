{"pr_number": 7573, "pr_title": "Allow null consume in BatchPushSource", "pr_createdAt": "2020-07-17T05:47:36Z", "pr_url": "https://github.com/apache/pulsar/pull/7573", "timeline": [{"oid": "cd7cbe5f12d359c958a5e6611245d1f13d7e093d", "url": "https://github.com/apache/pulsar/commit/cd7cbe5f12d359c958a5e6611245d1f13d7e093d", "message": "Added upgrade notes", "committedDate": "2020-07-07T19:00:43Z", "type": "commit"}, {"oid": "83b4c58c8466a402229de9f1ad4fcdeb4e0b83ef", "url": "https://github.com/apache/pulsar/commit/83b4c58c8466a402229de9f1ad4fcdeb4e0b83ef", "message": "Merge remote-tracking branch 'apache/master'", "committedDate": "2020-07-08T20:35:54Z", "type": "commit"}, {"oid": "a3ba7f344b8056adb759c040f529094f5ca9d67f", "url": "https://github.com/apache/pulsar/commit/a3ba7f344b8056adb759c040f529094f5ca9d67f", "message": "Merge remote-tracking branch 'apache/master'", "committedDate": "2020-07-12T16:17:19Z", "type": "commit"}, {"oid": "89c8048f57e46a0a336d6b59a73aa19fd9bcfe94", "url": "https://github.com/apache/pulsar/commit/89c8048f57e46a0a336d6b59a73aa19fd9bcfe94", "message": "Merge remote-tracking branch 'apache/master'", "committedDate": "2020-07-12T22:43:18Z", "type": "commit"}, {"oid": "b0728460c11e7babb09d47427818bda7092846cd", "url": "https://github.com/apache/pulsar/commit/b0728460c11e7babb09d47427818bda7092846cd", "message": "Merge remote-tracking branch 'apache/master'", "committedDate": "2020-07-13T20:40:54Z", "type": "commit"}, {"oid": "77bb46778d1ef87c5c14694b634ba9d14e945b74", "url": "https://github.com/apache/pulsar/commit/77bb46778d1ef87c5c14694b634ba9d14e945b74", "message": "Merge remote-tracking branch 'apache/master'", "committedDate": "2020-07-13T23:47:34Z", "type": "commit"}, {"oid": "000336c993a9c92871470b5ded18724d94cd41c6", "url": "https://github.com/apache/pulsar/commit/000336c993a9c92871470b5ded18724d94cd41c6", "message": "Merge remote-tracking branch 'apache/master'", "committedDate": "2020-07-14T18:53:11Z", "type": "commit"}, {"oid": "f9231d29d8ec4dc3e4451436ec6f7eaa3aae6cb4", "url": "https://github.com/apache/pulsar/commit/f9231d29d8ec4dc3e4451436ec6f7eaa3aae6cb4", "message": "Merge remote-tracking branch 'apache/master'", "committedDate": "2020-07-15T15:39:38Z", "type": "commit"}, {"oid": "ee44e3ba01e6793331134ac43e7ca636d49a03ab", "url": "https://github.com/apache/pulsar/commit/ee44e3ba01e6793331134ac43e7ca636d49a03ab", "message": "Merge remote-tracking branch 'apache/master'", "committedDate": "2020-07-16T23:33:16Z", "type": "commit"}, {"oid": "4b02b546faad21540133e66b63d9e691561f4c45", "url": "https://github.com/apache/pulsar/commit/4b02b546faad21540133e66b63d9e691561f4c45", "message": "Merge remote-tracking branch 'apache/master'", "committedDate": "2020-07-17T05:44:01Z", "type": "commit"}, {"oid": "b2bd44c422da521454bbb61bfc28c3649c3585af", "url": "https://github.com/apache/pulsar/commit/b2bd44c422da521454bbb61bfc28c3649c3585af", "message": "Allow null message to be passed", "committedDate": "2020-07-17T05:45:20Z", "type": "commit"}, {"oid": "1298d777b911177c3385c66a12c97e3bf310fd75", "url": "https://github.com/apache/pulsar/commit/1298d777b911177c3385c66a12c97e3bf310fd75", "message": "More private impl", "committedDate": "2020-07-17T07:05:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU2MzA4MQ==", "url": "https://github.com/apache/pulsar/pull/7573#discussion_r456563081", "bodyText": "Can we add some comments about how to use this?", "author": "jerrypeng", "createdAt": "2020-07-17T17:00:07Z", "path": "pulsar-io/core/src/main/java/org/apache/pulsar/io/core/BatchPushSource.java", "diffHunk": "@@ -32,6 +30,13 @@\n  */\n public abstract class BatchPushSource<T> implements BatchSource<T> {\n \n+    private static class NullRecord implements Record {", "originalCommit": "1298d777b911177c3385c66a12c97e3bf310fd75", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU2MzMwOQ==", "url": "https://github.com/apache/pulsar/pull/7573#discussion_r456563309", "bodyText": "nvm", "author": "jerrypeng", "createdAt": "2020-07-17T17:00:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU2MzA4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "a9070ef02bb75d5335187b427e271fa6a8bd8a1e", "chunk": "diff --git a/pulsar-io/core/src/main/java/org/apache/pulsar/io/core/BatchPushSource.java b/pulsar-io/core/src/main/java/org/apache/pulsar/io/core/BatchPushSource.java\nindex 0e9e5abf1fb..9f44fd5ba57 100644\n--- a/pulsar-io/core/src/main/java/org/apache/pulsar/io/core/BatchPushSource.java\n+++ b/pulsar-io/core/src/main/java/org/apache/pulsar/io/core/BatchPushSource.java\n\n@@ -39,6 +39,7 @@ public abstract class BatchPushSource<T> implements BatchSource<T> {\n \n     private LinkedBlockingQueue<Record<T>> queue;\n     private static final int DEFAULT_QUEUE_LENGTH = 1000;\n+    private final NullRecord nullRecord = new NullRecord();\n \n     public BatchPushSource() {\n         this.queue = new LinkedBlockingQueue<>(this.getQueueLength());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU2NDMyNA==", "url": "https://github.com/apache/pulsar/pull/7573#discussion_r456564324", "bodyText": "A small optimization: Just declare a final variable and re-use", "author": "jerrypeng", "createdAt": "2020-07-17T17:02:41Z", "path": "pulsar-io/core/src/main/java/org/apache/pulsar/io/core/BatchPushSource.java", "diffHunk": "@@ -41,17 +46,26 @@ public BatchPushSource() {\n \n     @Override\n     public Record<T> readNext() throws Exception {\n-        return queue.take();\n+        Record<T> record = queue.take();\n+        if (record instanceof NullRecord) {\n+            return null;\n+        } else {\n+            return record;\n+        }\n     }\n \n     /**\n      * Send this message to be written to Pulsar.\n-     *\n+     * Pass null if you you are done with this task\n      * @param record next message from source which should be sent to a Pulsar topic\n      */\n     public void consume(Record<T> record) {\n         try {\n-            queue.put(record);\n+            if (record != null) {\n+                queue.put(record);\n+            } else {\n+                queue.put(new NullRecord());", "originalCommit": "1298d777b911177c3385c66a12c97e3bf310fd75", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU4NDc0Nw==", "url": "https://github.com/apache/pulsar/pull/7573#discussion_r456584747", "bodyText": "done", "author": "srkukarni", "createdAt": "2020-07-17T17:44:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU2NDMyNA=="}], "type": "inlineReview", "revised_code": {"commit": "a9070ef02bb75d5335187b427e271fa6a8bd8a1e", "chunk": "diff --git a/pulsar-io/core/src/main/java/org/apache/pulsar/io/core/BatchPushSource.java b/pulsar-io/core/src/main/java/org/apache/pulsar/io/core/BatchPushSource.java\nindex 0e9e5abf1fb..9f44fd5ba57 100644\n--- a/pulsar-io/core/src/main/java/org/apache/pulsar/io/core/BatchPushSource.java\n+++ b/pulsar-io/core/src/main/java/org/apache/pulsar/io/core/BatchPushSource.java\n\n@@ -39,6 +39,7 @@ public abstract class BatchPushSource<T> implements BatchSource<T> {\n \n     private LinkedBlockingQueue<Record<T>> queue;\n     private static final int DEFAULT_QUEUE_LENGTH = 1000;\n+    private final NullRecord nullRecord = new NullRecord();\n \n     public BatchPushSource() {\n         this.queue = new LinkedBlockingQueue<>(this.getQueueLength());\n"}}, {"oid": "e4556970ceab0403c5be09ee4b8c238b383a8559", "url": "https://github.com/apache/pulsar/commit/e4556970ceab0403c5be09ee4b8c238b383a8559", "message": "Fix unittest", "committedDate": "2020-07-17T17:42:01Z", "type": "commit"}, {"oid": "a9070ef02bb75d5335187b427e271fa6a8bd8a1e", "url": "https://github.com/apache/pulsar/commit/a9070ef02bb75d5335187b427e271fa6a8bd8a1e", "message": "Address comments", "committedDate": "2020-07-17T17:43:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYxNjQxNQ==", "url": "https://github.com/apache/pulsar/pull/7573#discussion_r456616415", "bodyText": "Wouldn't it be easier to allow users to place a null value inside their existing Record class and then test for that condition rather than creating a NullRecord class?  e.g.\nprivate static final boolean isNull(Record rec) { return (rec == null) || (rec.getValue() == null); }\nThen you could just call this method instead of using the instanceof NullRecord check", "author": "david-streamlio", "createdAt": "2020-07-17T18:48:53Z", "path": "pulsar-io/core/src/main/java/org/apache/pulsar/io/core/BatchPushSource.java", "diffHunk": "@@ -32,26 +30,43 @@\n  */\n public abstract class BatchPushSource<T> implements BatchSource<T> {\n \n+    private static class NullRecord implements Record {", "originalCommit": "a9070ef02bb75d5335187b427e271fa6a8bd8a1e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYzMDMyOQ==", "url": "https://github.com/apache/pulsar/pull/7573#discussion_r456630329", "bodyText": "The thing is, is a record with a null value the same as returning null?  Can a record have a null value but have other fields e.g. key with valid values", "author": "jerrypeng", "createdAt": "2020-07-17T19:19:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYxNjQxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYzNjU4MA==", "url": "https://github.com/apache/pulsar/pull/7573#discussion_r456636580", "bodyText": "The Null object is currently only inserted if the record passed in is null, so there aren't any fields.", "author": "david-streamlio", "createdAt": "2020-07-17T19:34:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYxNjQxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYzNzc3NQ==", "url": "https://github.com/apache/pulsar/pull/7573#discussion_r456637775", "bodyText": "Letting users to continue to use their own Record types and using a null value inside the record seems like a more intuitive approach to me", "author": "david-streamlio", "createdAt": "2020-07-17T19:37:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYxNjQxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY3NjM5MA==", "url": "https://github.com/apache/pulsar/pull/7573#discussion_r456676390", "bodyText": "That is the approach thats taken here. Users will be using their own record types and when they are done with the task, will do consume(null) to signify the end of the task. The NullRecord is strictly private class as an internal impl detail ofBatchPushSource", "author": "srkukarni", "createdAt": "2020-07-17T21:11:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYxNjQxNQ=="}], "type": "inlineReview", "revised_code": null}]}