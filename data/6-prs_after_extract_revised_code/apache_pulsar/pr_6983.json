{"pr_number": 6983, "pr_title": "Added ability to add annotations to Connector Configs ", "pr_createdAt": "2020-05-19T06:55:41Z", "pr_url": "https://github.com/apache/pulsar/pull/6983", "timeline": [{"oid": "a98022fba2a5bad4c706b20409ae6486689edfd6", "url": "https://github.com/apache/pulsar/commit/a98022fba2a5bad4c706b20409ae6486689edfd6", "message": "Added sourceConfigClass and sinkConfigClass", "committedDate": "2020-05-15T05:50:22Z", "type": "commit"}, {"oid": "d6edf815a07eabf82755fb3b074510e60f79ee87", "url": "https://github.com/apache/pulsar/commit/d6edf815a07eabf82755fb3b074510e60f79ee87", "message": "Add Validator annotation helpers to validate class parameters", "committedDate": "2020-05-15T23:29:18Z", "type": "commit"}, {"oid": "68a21cf08fa96997da1277cfba30eb65c5f62870", "url": "https://github.com/apache/pulsar/commit/68a21cf08fa96997da1277cfba30eb65c5f62870", "message": "Fix build errors", "committedDate": "2020-05-16T00:40:42Z", "type": "commit"}, {"oid": "64001f84f3b1b38a0f56b51366c6dc13207a1dfb", "url": "https://github.com/apache/pulsar/commit/64001f84f3b1b38a0f56b51366c6dc13207a1dfb", "message": "Take feedback into account", "committedDate": "2020-05-16T20:26:30Z", "type": "commit"}, {"oid": "6771904932ad7cfc3016b7c137be2ddd82a82f2f", "url": "https://github.com/apache/pulsar/commit/6771904932ad7cfc3016b7c137be2ddd82a82f2f", "message": "Merge branch 'validators' into connector_annotations", "committedDate": "2020-05-18T16:05:45Z", "type": "commit"}, {"oid": "3dc67273219d927442b179553f14d8f78383cd9e", "url": "https://github.com/apache/pulsar/commit/3dc67273219d927442b179553f14d8f78383cd9e", "message": "Merge branch 'master' into connector_annotations", "committedDate": "2020-05-18T20:53:52Z", "type": "commit"}, {"oid": "6da462336e5698485f31ad4e56639978fbeafd57", "url": "https://github.com/apache/pulsar/commit/6da462336e5698485f31ad4e56639978fbeafd57", "message": "Connected with validation", "committedDate": "2020-05-18T23:18:11Z", "type": "commit"}, {"oid": "e021a89011b259d764227f4d7f4f849dfdc0815c", "url": "https://github.com/apache/pulsar/commit/e021a89011b259d764227f4d7f4f849dfdc0815c", "message": "Fix bugs", "committedDate": "2020-05-19T02:07:59Z", "type": "commit"}, {"oid": "6c9b8665f58f10828d3148facf478eac2a53d75c", "url": "https://github.com/apache/pulsar/commit/6c9b8665f58f10828d3148facf478eac2a53d75c", "message": "Added tests", "committedDate": "2020-05-19T06:45:10Z", "type": "commit"}, {"oid": "2cb0bd2b0170fd28d0c4d6c474cca9c7a29e8bce", "url": "https://github.com/apache/pulsar/commit/2cb0bd2b0170fd28d0c4d6c474cca9c7a29e8bce", "message": "Merge branch 'master' into connector_annotations", "committedDate": "2020-05-19T07:03:14Z", "type": "commit"}, {"oid": "c7642fdf61833fe974e38b2a0652cd7d18c45893", "url": "https://github.com/apache/pulsar/commit/c7642fdf61833fe974e38b2a0652cd7d18c45893", "message": "Merge branch 'master' into connector_annotations", "committedDate": "2020-05-19T22:02:47Z", "type": "commit"}, {"oid": "550f585fcb60571220b2f5ed6b5deb1b06b3edf4", "url": "https://github.com/apache/pulsar/commit/550f585fcb60571220b2f5ed6b5deb1b06b3edf4", "message": "Merge branch 'master' into connector_annotations", "committedDate": "2020-05-20T14:24:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMyNzY5OQ==", "url": "https://github.com/apache/pulsar/pull/6983#discussion_r428327699", "bodyText": "Please use ObjectMapperFactory.getThreadLocal", "author": "jerrypeng", "createdAt": "2020-05-20T21:49:42Z", "path": "pulsar-functions/utils/src/main/java/org/apache/pulsar/functions/utils/SinkConfigUtils.java", "diffHunk": "@@ -580,4 +595,24 @@ public static SinkConfig validateUpdate(SinkConfig existingConfig, SinkConfig ne\n         }\n         return mergedConfig;\n     }\n+\n+    public static void validateConnectorConfig(SinkConfig sinkConfig, ClassLoader classLoader) {\n+        try {\n+            ConnectorDefinition defn = ConnectorUtils.getConnectorDefinition(classLoader);\n+            if (defn.getSinkConfigClass() != null) {\n+                Class configClass = Class.forName(defn.getSinkConfigClass(),  true, classLoader);\n+                ObjectMapper mapper = new ObjectMapper();", "originalCommit": "550f585fcb60571220b2f5ed6b5deb1b06b3edf4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMzODUxMw==", "url": "https://github.com/apache/pulsar/pull/6983#discussion_r428338513", "bodyText": "Changed", "author": "srkukarni", "createdAt": "2020-05-20T22:15:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMyNzY5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "3d60e4fb99d15032c996fd1f01b4eeb6aeb143de", "chunk": "diff --git a/pulsar-functions/utils/src/main/java/org/apache/pulsar/functions/utils/SinkConfigUtils.java b/pulsar-functions/utils/src/main/java/org/apache/pulsar/functions/utils/SinkConfigUtils.java\nindex 88b35692fd9..7bb9f777d4c 100644\n--- a/pulsar-functions/utils/src/main/java/org/apache/pulsar/functions/utils/SinkConfigUtils.java\n+++ b/pulsar-functions/utils/src/main/java/org/apache/pulsar/functions/utils/SinkConfigUtils.java\n\n@@ -601,8 +601,8 @@ public class SinkConfigUtils {\n             ConnectorDefinition defn = ConnectorUtils.getConnectorDefinition(classLoader);\n             if (defn.getSinkConfigClass() != null) {\n                 Class configClass = Class.forName(defn.getSinkConfigClass(),  true, classLoader);\n-                ObjectMapper mapper = new ObjectMapper();\n-                Object configObject = mapper.readValue(new ObjectMapper().writeValueAsString(sinkConfig.getConfigs()), configClass);\n+                Object configObject =\n+                        ObjectMapperFactory.getThreadLocal().convertValue(sinkConfig.getConfigs(), configClass);\n                 if (configObject != null) {\n                     ConfigValidation.validateConfig(configObject);\n                 }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMyODYwOQ==", "url": "https://github.com/apache/pulsar/pull/6983#discussion_r428328609", "bodyText": "You can achieve the same thing by using the following method\nmapper.convertValue(map, MyPojo.class);", "author": "jerrypeng", "createdAt": "2020-05-20T21:51:47Z", "path": "pulsar-functions/utils/src/main/java/org/apache/pulsar/functions/utils/SinkConfigUtils.java", "diffHunk": "@@ -580,4 +595,24 @@ public static SinkConfig validateUpdate(SinkConfig existingConfig, SinkConfig ne\n         }\n         return mergedConfig;\n     }\n+\n+    public static void validateConnectorConfig(SinkConfig sinkConfig, ClassLoader classLoader) {\n+        try {\n+            ConnectorDefinition defn = ConnectorUtils.getConnectorDefinition(classLoader);\n+            if (defn.getSinkConfigClass() != null) {\n+                Class configClass = Class.forName(defn.getSinkConfigClass(),  true, classLoader);\n+                ObjectMapper mapper = new ObjectMapper();\n+                Object configObject = mapper.readValue(new ObjectMapper().writeValueAsString(sinkConfig.getConfigs()), configClass);", "originalCommit": "550f585fcb60571220b2f5ed6b5deb1b06b3edf4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMzODUzMw==", "url": "https://github.com/apache/pulsar/pull/6983#discussion_r428338533", "bodyText": "Changed", "author": "srkukarni", "createdAt": "2020-05-20T22:15:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMyODYwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "3d60e4fb99d15032c996fd1f01b4eeb6aeb143de", "chunk": "diff --git a/pulsar-functions/utils/src/main/java/org/apache/pulsar/functions/utils/SinkConfigUtils.java b/pulsar-functions/utils/src/main/java/org/apache/pulsar/functions/utils/SinkConfigUtils.java\nindex 88b35692fd9..7bb9f777d4c 100644\n--- a/pulsar-functions/utils/src/main/java/org/apache/pulsar/functions/utils/SinkConfigUtils.java\n+++ b/pulsar-functions/utils/src/main/java/org/apache/pulsar/functions/utils/SinkConfigUtils.java\n\n@@ -601,8 +601,8 @@ public class SinkConfigUtils {\n             ConnectorDefinition defn = ConnectorUtils.getConnectorDefinition(classLoader);\n             if (defn.getSinkConfigClass() != null) {\n                 Class configClass = Class.forName(defn.getSinkConfigClass(),  true, classLoader);\n-                ObjectMapper mapper = new ObjectMapper();\n-                Object configObject = mapper.readValue(new ObjectMapper().writeValueAsString(sinkConfig.getConfigs()), configClass);\n+                Object configObject =\n+                        ObjectMapperFactory.getThreadLocal().convertValue(sinkConfig.getConfigs(), configClass);\n                 if (configObject != null) {\n                     ConfigValidation.validateConfig(configObject);\n                 }\n"}}, {"oid": "67d1028b39670955db81f370f75546cdcfaae2ec", "url": "https://github.com/apache/pulsar/commit/67d1028b39670955db81f370f75546cdcfaae2ec", "message": "Fix class name", "committedDate": "2020-05-20T22:05:48Z", "type": "commit"}, {"oid": "3d60e4fb99d15032c996fd1f01b4eeb6aeb143de", "url": "https://github.com/apache/pulsar/commit/3d60e4fb99d15032c996fd1f01b4eeb6aeb143de", "message": "Address feedback", "committedDate": "2020-05-20T22:15:05Z", "type": "commit"}, {"oid": "df544b908445a540c7706584a560bc60d7dedb76", "url": "https://github.com/apache/pulsar/commit/df544b908445a540c7706584a560bc60d7dedb76", "message": "Merge branch 'master' into connector_annotations", "committedDate": "2020-05-22T12:40:52Z", "type": "commit"}]}