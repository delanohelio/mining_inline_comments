{"pr_number": 8946, "pr_title": "make ledger rollover check task internal", "pr_createdAt": "2020-12-14T01:14:24Z", "pr_url": "https://github.com/apache/pulsar/pull/8946", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjA4NTQ5NA==", "url": "https://github.com/apache/pulsar/pull/8946#discussion_r542085494", "bodyText": "I think it would be better to separate the timing task of checking that current ledger is full from scheduleTimeoutTask and put it in the ledger initialize method.", "author": "wuzhanpeng", "createdAt": "2020-12-14T03:22:05Z", "path": "managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedLedgerImpl.java", "diffHunk": "@@ -3300,6 +3305,13 @@ private void scheduleTimeoutTask() {\n                 checkReadTimeout();\n             }), timeoutSec, timeoutSec, TimeUnit.SECONDS);\n         }\n+\n+        if (config.getMaximumRolloverTimeMs() > 0) {", "originalCommit": "c4b411912691e8e9dc54493a01d0df483a810251", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjM3NzA4NA==", "url": "https://github.com/apache/pulsar/pull/8946#discussion_r542377084", "bodyText": "Ok, I move it into individual method.", "author": "hangc0276", "createdAt": "2020-12-14T13:20:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjA4NTQ5NA=="}], "type": "inlineReview", "revised_code": {"commit": "9465d2903dbf458df1f52d62e0428acb6f0e8c2b", "chunk": "diff --git a/managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedLedgerImpl.java b/managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedLedgerImpl.java\nindex 3c6a5e4c27f..ba5358a42db 100644\n--- a/managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedLedgerImpl.java\n+++ b/managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedLedgerImpl.java\n\n@@ -3305,7 +3472,9 @@ public class ManagedLedgerImpl implements ManagedLedger, CreateCallback {\n                 checkReadTimeout();\n             }), timeoutSec, timeoutSec, TimeUnit.SECONDS);\n         }\n+    }\n \n+    private void scheduleRollOverLedgerTask() {\n         if (config.getMaximumRolloverTimeMs() > 0) {\n             long interval = config.getMaximumRolloverTimeMs();\n             this.checkLedgerRollTask = this.scheduledExecutor.scheduleAtFixedRate(safeRun(() -> {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODE5NjY2OQ==", "url": "https://github.com/apache/pulsar/pull/8946#discussion_r548196669", "bodyText": "@hangc0276 we shouldn't remove a method from an interface directly. we should keep the method and mark it as deprecated.", "author": "sijie", "createdAt": "2020-12-23T20:09:56Z", "path": "managed-ledger/src/main/java/org/apache/bookkeeper/mledger/ManagedLedger.java", "diffHunk": "@@ -515,9 +515,4 @@ void asyncSetProperties(Map<String, String> properties, final AsyncCallbacks.Upd\n      * @param promise\n      */\n     void trimConsumedLedgersInBackground(CompletableFuture<?> promise);\n-\n-    /**\n-     * Roll current ledger if it is full\n-     */\n-    void rollCurrentLedgerIfFull();", "originalCommit": "7fce8e3b33b01f07da65fc424b080004756e3890", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODM0MDc4MQ==", "url": "https://github.com/apache/pulsar/pull/8946#discussion_r548340781", "bodyText": "Ok, i move it back.", "author": "hangc0276", "createdAt": "2020-12-24T01:22:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODE5NjY2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "96f7eb2a54385c3dd5e03ebd7e5e4f9b575e6b8b", "chunk": "diff --git a/managed-ledger/src/main/java/org/apache/bookkeeper/mledger/ManagedLedger.java b/managed-ledger/src/main/java/org/apache/bookkeeper/mledger/ManagedLedger.java\nindex 7830a00099a..4f4c226a91e 100644\n--- a/managed-ledger/src/main/java/org/apache/bookkeeper/mledger/ManagedLedger.java\n+++ b/managed-ledger/src/main/java/org/apache/bookkeeper/mledger/ManagedLedger.java\n\n@@ -515,4 +579,20 @@ public interface ManagedLedger {\n      * @param promise\n      */\n     void trimConsumedLedgersInBackground(CompletableFuture<?> promise);\n+\n+    /**\n+     * Roll current ledger if it is full\n+     */\n+    @Deprecated\n+    void rollCurrentLedgerIfFull();\n+\n+    /**\n+     * Find position by sequenceId.\n+     * */\n+    CompletableFuture<Position> asyncFindPosition(com.google.common.base.Predicate<Entry> predicate);\n+\n+    /**\n+     * Get the ManagedLedgerInterceptor for ManagedLedger.\n+     * */\n+    ManagedLedgerInterceptor getManagedLedgerInterceptor();\n }\n"}}, {"oid": "96f7eb2a54385c3dd5e03ebd7e5e4f9b575e6b8b", "url": "https://github.com/apache/pulsar/commit/96f7eb2a54385c3dd5e03ebd7e5e4f9b575e6b8b", "message": "mmake ledger rollover check task internal", "committedDate": "2021-01-07T05:18:43Z", "type": "commit"}, {"oid": "9465d2903dbf458df1f52d62e0428acb6f0e8c2b", "url": "https://github.com/apache/pulsar/commit/9465d2903dbf458df1f52d62e0428acb6f0e8c2b", "message": "move roll over ledger task into individual method.", "committedDate": "2021-01-07T05:18:43Z", "type": "commit"}, {"oid": "facd007dfc6540a981c05a3924381edfd8bca48f", "url": "https://github.com/apache/pulsar/commit/facd007dfc6540a981c05a3924381edfd8bca48f", "message": "mark rollCurrentLedgerIfFull interface as Deprecated", "committedDate": "2021-01-07T05:19:21Z", "type": "commit"}, {"oid": "534326d168f86e98e60ac9c3c1c106235dbd8391", "url": "https://github.com/apache/pulsar/commit/534326d168f86e98e60ac9c3c1c106235dbd8391", "message": "fix run test case failed.", "committedDate": "2021-01-07T05:19:21Z", "type": "commit"}, {"oid": "534326d168f86e98e60ac9c3c1c106235dbd8391", "url": "https://github.com/apache/pulsar/commit/534326d168f86e98e60ac9c3c1c106235dbd8391", "message": "fix run test case failed.", "committedDate": "2021-01-07T05:19:21Z", "type": "forcePushed"}, {"oid": "766e9c69dcb262dd53d8cdc1b85ffe430d59b53b", "url": "https://github.com/apache/pulsar/commit/766e9c69dcb262dd53d8cdc1b85ffe430d59b53b", "message": "fix run test case failed.", "committedDate": "2021-01-07T12:36:13Z", "type": "commit"}, {"oid": "f94c36e311b6215ea4f3eec54e7b00e1cf198890", "url": "https://github.com/apache/pulsar/commit/f94c36e311b6215ea4f3eec54e7b00e1cf198890", "message": "fix run test case failed.", "committedDate": "2021-01-07T12:52:03Z", "type": "commit"}]}