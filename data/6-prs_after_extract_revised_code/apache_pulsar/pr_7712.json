{"pr_number": 7712, "pr_title": "[Issue 7711][pulsar-broker] Use original role instead of proxy role to check permissions", "pr_createdAt": "2020-07-31T15:40:31Z", "pr_url": "https://github.com/apache/pulsar/pull/7712", "timeline": [{"oid": "629f2ed8d76e1a82c00a2a02a8717405877eb58c", "url": "https://github.com/apache/pulsar/commit/629f2ed8d76e1a82c00a2a02a8717405877eb58c", "message": "[Issue 7711][pulsar-broker] Use the original role (if available) instead of the proxy role to check if a client is allowed to consume or produce", "committedDate": "2020-07-31T15:35:35Z", "type": "commit"}, {"oid": "8de141d02f3b6a603d11e9e6ccb6d1afe4638b90", "url": "https://github.com/apache/pulsar/commit/8de141d02f3b6a603d11e9e6ccb6d1afe4638b90", "message": "[Issue 7313] Add the class name for the isBlank method", "committedDate": "2020-07-31T15:55:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkwMDkzMA==", "url": "https://github.com/apache/pulsar/pull/7712#discussion_r463900930", "bodyText": "does lookup also need a change?", "author": "jiazhai", "createdAt": "2020-08-01T01:04:47Z", "path": "pulsar-broker-common/src/main/java/org/apache/pulsar/broker/authorization/PulsarAuthorizationProvider.java", "diffHunk": "@@ -557,9 +557,9 @@ private void validatePoliciesReadOnlyAccess() {\n         switch (operation) {\n             case LOOKUP: isAuthorizedFuture = canLookupAsync(topicName, role, authData);", "originalCommit": "8de141d02f3b6a603d11e9e6ccb6d1afe4638b90", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk4ODIyMA==", "url": "https://github.com/apache/pulsar/pull/7712#discussion_r463988220", "bodyText": "the lookup method was updated", "author": "vzhikserg", "createdAt": "2020-08-01T18:37:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkwMDkzMA=="}], "type": "inlineReview", "revised_code": {"commit": "e653b7021c56fd4ffda42a7b6f2dbc86363996cf", "chunk": "diff --git a/pulsar-broker-common/src/main/java/org/apache/pulsar/broker/authorization/PulsarAuthorizationProvider.java b/pulsar-broker-common/src/main/java/org/apache/pulsar/broker/authorization/PulsarAuthorizationProvider.java\nindex ca4e45c1be9..d7cea441192 100644\n--- a/pulsar-broker-common/src/main/java/org/apache/pulsar/broker/authorization/PulsarAuthorizationProvider.java\n+++ b/pulsar-broker-common/src/main/java/org/apache/pulsar/broker/authorization/PulsarAuthorizationProvider.java\n\n@@ -555,7 +555,7 @@ public class PulsarAuthorizationProvider implements AuthorizationProvider {\n         CompletableFuture<Boolean> isAuthorizedFuture;\n \n         switch (operation) {\n-            case LOOKUP: isAuthorizedFuture = canLookupAsync(topicName, role, authData);\n+            case LOOKUP: isAuthorizedFuture = canLookupAsync(topicName, StringUtils.isBlank(originalRole) ? role : originalRole, authData);\n                 break;\n             case PRODUCE: isAuthorizedFuture = canProduceAsync(topicName, StringUtils.isBlank(originalRole) ? role : originalRole, authData);\n                 break;\n"}}, {"oid": "e653b7021c56fd4ffda42a7b6f2dbc86363996cf", "url": "https://github.com/apache/pulsar/commit/e653b7021c56fd4ffda42a7b6f2dbc86363996cf", "message": "[Issue 7711] Use original role for the lookup action", "committedDate": "2020-08-01T05:37:25Z", "type": "commit"}, {"oid": "9e2935cb9259d71bd0bac0bf013f51a8fd9dcacf", "url": "https://github.com/apache/pulsar/commit/9e2935cb9259d71bd0bac0bf013f51a8fd9dcacf", "message": "Merge branch 'master' into use-original-role-instead-of-proxy-role-where-possible", "committedDate": "2020-08-04T20:51:45Z", "type": "commit"}]}