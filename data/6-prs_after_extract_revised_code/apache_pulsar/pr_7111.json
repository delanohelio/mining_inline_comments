{"pr_number": 7111, "pr_title": "Trigger rollover when meeting maxLedgerRolloverTimeMinutes", "pr_createdAt": "2020-05-30T04:22:42Z", "pr_url": "https://github.com/apache/pulsar/pull/7111", "timeline": [{"oid": "ee2fc2594b064d4cc263c54513c440d547e9c4e0", "url": "https://github.com/apache/pulsar/commit/ee2fc2594b064d4cc263c54513c440d547e9c4e0", "message": "add feature: enable rollover when triggering maxLedgerRolloverTimeMinutes", "committedDate": "2020-05-29T12:08:35Z", "type": "commit"}, {"oid": "b1558940ab2a0ef515845fe78b5de5ba9ce38ad7", "url": "https://github.com/apache/pulsar/commit/b1558940ab2a0ef515845fe78b5de5ba9ce38ad7", "message": "add supplemental test cases", "committedDate": "2020-05-30T03:44:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjgxNjg0MA==", "url": "https://github.com/apache/pulsar/pull/7111#discussion_r432816840", "bodyText": "Why do we need to expose this in the interface, it should be better to keep in implementation details", "author": "merlimat", "createdAt": "2020-05-30T06:49:37Z", "path": "managed-ledger/src/main/java/org/apache/bookkeeper/mledger/ManagedLedger.java", "diffHunk": "@@ -472,4 +472,9 @@ void asyncSetProperties(Map<String, String> properties, final AsyncCallbacks.Set\n      * @param promise\n      */\n     void trimConsumedLedgersInBackground(CompletableFuture<?> promise);\n+\n+    /**\n+     * Roll current ledger if it is full\n+     */\n+    void rollCurrentLedgerIfFull();", "originalCommit": "b1558940ab2a0ef515845fe78b5de5ba9ce38ad7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzAyOTczMw==", "url": "https://github.com/apache/pulsar/pull/7111#discussion_r433029733", "bodyText": "I hope to be able to consult you here for advice, because I am not sure whether doing type casting in the BrokerService is a suitable implementation. Maybe I can modify with:\n((ManagedLedgerImpl) managedLedger).rollCurrentLedgerIfFull();", "author": "wuzhanpeng", "createdAt": "2020-06-01T03:45:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjgxNjg0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM2MDg2Nw==", "url": "https://github.com/apache/pulsar/pull/7111#discussion_r433360867", "bodyText": "I was thinking that this is a managedLedger internal task, for which the BrokerService shouldn't be concerned. For that it would be better to handle in the ManagedLedgerFactoryImpl, to go through all open managed ledger instances and check if a rollover has to be forced.", "author": "merlimat", "createdAt": "2020-06-01T16:52:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjgxNjg0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU4MzkwMQ==", "url": "https://github.com/apache/pulsar/pull/7111#discussion_r433583901", "bodyText": "Now I feel a little confused. If we treat rollover as an internal task, should consumedLedgersMonitor or backlogQuotaChecker be internal tasks as well? Or is my understanding biased?", "author": "wuzhanpeng", "createdAt": "2020-06-02T02:14:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjgxNjg0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY2MjA1Mg==", "url": "https://github.com/apache/pulsar/pull/7111#discussion_r435662052", "bodyText": "@wuzhanpeng I think you can add an issue to track the monitor that outside the managed ledger but should be maintained by managed ledger own.", "author": "codelipenghui", "createdAt": "2020-06-05T02:51:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjgxNjg0MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjgxNjg5Nw==", "url": "https://github.com/apache/pulsar/pull/7111#discussion_r432816897", "bodyText": "We don't need initiate the creation of a ledger at this point. We can stay in LedgerClosed state until a new write comes in.", "author": "merlimat", "createdAt": "2020-05-30T06:50:38Z", "path": "managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedLedgerImpl.java", "diffHunk": "@@ -1391,6 +1392,38 @@ synchronized void ledgerClosed(final LedgerHandle lh) {\n         }\n     }\n \n+    synchronized void createLedgerAfterClosed() {\n+        STATE_UPDATER.set(this, State.CreatingLedger);\n+        this.lastLedgerCreationInitiationTimestamp = System.nanoTime();\n+        mbean.startDataLedgerCreateOp();\n+        asyncCreateLedger(bookKeeper, config, digestType, this, Collections.emptyMap());\n+    }\n+\n+    @Override\n+    public void rollCurrentLedgerIfFull() {\n+        log.info(\"[{}] Start checking if current ledger is full\", name);\n+        if (currentLedgerEntries > 0 && currentLedgerIsFull()) {\n+            STATE_UPDATER.set(this, State.ClosingLedger);\n+            currentLedger.asyncClose(new AsyncCallback.CloseCallback() {\n+                @Override\n+                public void closeComplete(int rc, LedgerHandle lh, Object o) {\n+                    checkArgument(currentLedger.getId() == lh.getId(), \"ledgerId %s doesn't match with acked ledgerId %s\",\n+                            currentLedger.getId(),\n+                            lh.getId());\n+\n+                    if (rc == BKException.Code.OK) {\n+                        log.debug(\"Successfuly closed ledger {}\", lh.getId());\n+                    } else {\n+                        log.warn(\"Error when closing ledger {}. Status={}\", lh.getId(), BKException.getMessage(rc));\n+                    }\n+\n+                    ledgerClosed(lh);\n+                    createLedgerAfterClosed();", "originalCommit": "b1558940ab2a0ef515845fe78b5de5ba9ce38ad7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzAyNTIyOA==", "url": "https://github.com/apache/pulsar/pull/7111#discussion_r433025228", "bodyText": "Yes in current code logic we can stay in closed state until the next entry comes in, however if we choose for waiting, the last created topic ledger will be never removed beacause the trimming stratege will not remove the current ledger. In such scenario, we will maintain a lot of useless data if the topic is no longer being used. Moreover, it may cause disk problem if we keep a lot mount of discarded topics in the cluster.", "author": "wuzhanpeng", "createdAt": "2020-06-01T03:15:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjgxNjg5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY2MzM3OA==", "url": "https://github.com/apache/pulsar/pull/7111#discussion_r435663378", "bodyText": "Ok, I think we can change the current logic. If the current ledger is closed, we can delete it. I'm not sure is there any problems with this change. @merlimat Could you please help check this?", "author": "codelipenghui", "createdAt": "2020-06-05T02:56:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjgxNjg5Nw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjgxNjk1OA==", "url": "https://github.com/apache/pulsar/pull/7111#discussion_r432816958", "bodyText": "This thread is not being stopped. Potentially we could also reuse an existing executor.", "author": "merlimat", "createdAt": "2020-05-30T06:51:46Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/BrokerService.java", "diffHunk": "@@ -277,6 +278,8 @@ public BrokerService(PulsarService pulsar) throws Exception {\n             Executors.newSingleThreadScheduledExecutor(new DefaultThreadFactory(\"pulsar-publish-buffer-monitor\"));\n         this.consumedLedgersMonitor = Executors\n                 .newSingleThreadScheduledExecutor(new DefaultThreadFactory(\"consumed-Ledgers-monitor\"));\n+        this.ledgerFullMonitor =", "originalCommit": "b1558940ab2a0ef515845fe78b5de5ba9ce38ad7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQyMDc0Mw==", "url": "https://github.com/apache/pulsar/pull/7111#discussion_r436420743", "bodyText": "+1 @wuzhanpeng can we re-use an existing executor? Otherwise, we end up creating a lot of executors.", "author": "sijie", "createdAt": "2020-06-08T01:10:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjgxNjk1OA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjgxNjk5MQ==", "url": "https://github.com/apache/pulsar/pull/7111#discussion_r432816991", "bodyText": "the recurring task needs to be cancelled when BrokerService is closed", "author": "merlimat", "createdAt": "2020-05-30T06:52:28Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/BrokerService.java", "diffHunk": "@@ -485,6 +489,12 @@ protected void startConsumedLedgersMonitor() {\n         }\n     }\n \n+    protected void startLedgerFullMonitor() {\n+        int interval = pulsar().getConfiguration().getManagedLedgerMaxLedgerRolloverTimeMinutes();\n+        ledgerFullMonitor.scheduleAtFixedRate(safeRun(this::checkLedgerFull),", "originalCommit": "b1558940ab2a0ef515845fe78b5de5ba9ce38ad7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzEzMTIyMw==", "url": "https://github.com/apache/pulsar/pull/7111#discussion_r433131223", "bodyText": "I newly add a shutdown for the monitor when BrokerService is closed", "author": "wuzhanpeng", "createdAt": "2020-06-01T09:25:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjgxNjk5MQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "33f0615f4e120d92531dc080f725dcc25203fbb7", "url": "https://github.com/apache/pulsar/commit/33f0615f4e120d92531dc080f725dcc25203fbb7", "message": "shutdown monitor when BrokerService is closed", "committedDate": "2020-06-01T03:53:54Z", "type": "commit"}, {"oid": "9d225e4d82bbc1d5bb71eccb8ba11fd1ac7ddc48", "url": "https://github.com/apache/pulsar/commit/9d225e4d82bbc1d5bb71eccb8ba11fd1ac7ddc48", "message": "Merge remote-tracking branch 'apache/master' into feature_rollover_when_triggering_maxLedgerRolloverTimeMinutes", "committedDate": "2020-06-05T02:48:45Z", "type": "commit"}]}