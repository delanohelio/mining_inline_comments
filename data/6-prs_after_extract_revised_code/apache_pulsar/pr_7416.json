{"pr_number": 7416, "pr_title": "Decompression payload if needed in KeyShared subscription", "pr_createdAt": "2020-07-01T12:37:05Z", "pr_url": "https://github.com/apache/pulsar/pull/7416", "timeline": [{"oid": "b7b7696ef87df92467d0f80ece85c6dacf6ef9ab", "url": "https://github.com/apache/pulsar/commit/b7b7696ef87df92467d0f80ece85c6dacf6ef9ab", "message": "Decompression the payload if need for single batch message in KeyShared subscription.", "committedDate": "2020-07-01T12:24:51Z", "type": "commit"}, {"oid": "f853896be924a063ba8b6d5482804d222e0ac8a1", "url": "https://github.com/apache/pulsar/commit/f853896be924a063ba8b6d5482804d222e0ac8a1", "message": "decompression only no key in the metadata", "committedDate": "2020-07-01T12:34:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMzOTcxOQ==", "url": "https://github.com/apache/pulsar/pull/7416#discussion_r448339719", "bodyText": "We should avoid decompressing in the broker in any case. This is very dangerous from a CPU usage point of view.", "author": "merlimat", "createdAt": "2020-07-01T12:49:32Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/AbstractBaseDispatcher.java", "diffHunk": "@@ -153,13 +155,18 @@ public void resetCloseFuture() {\n         PulsarApi.MessageMetadata metadata = Commands.parseMessageMetadata(metadataAndPayload);\n \n         try {\n-            if (metadata.hasNumMessagesInBatch()) {\n+            if (!metadata.hasOrderingKey() && !metadata.hasPartitionKey() && metadata.hasNumMessagesInBatch()) {\n                 // If the message was part of a batch (eg: a batch of 1 message), we need\n                 // to read the key from the first single-message-metadata entry\n+                PulsarApi.CompressionType compressionType = metadata.getCompression();\n+                CompressionCodec codec = CompressionCodecProvider.getCompressionCodec(compressionType);", "originalCommit": "f853896be924a063ba8b6d5482804d222e0ac8a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODM0NDUzNQ==", "url": "https://github.com/apache/pulsar/pull/7416#discussion_r448344535", "bodyText": "I'm not sure how to handle #7107 that fixed. Maybe we can use the first single message key as the batch message key, but this requires all clients catchup.\nSo, I think we can onboard this PR first ensure correctness, and I will create an issue for the clients catchup work.\nAnd I have add check if (!metadata.hasOrderingKey() && !metadata.hasPartitionKey() && metadata.hasNumMessagesInBatch()), if the clients set the key of the batch message to the key of the first message, it can reduce overhead.\nI have test with the KeyBasedBatcher. It already set the batch message key.", "author": "codelipenghui", "createdAt": "2020-07-01T12:58:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMzOTcxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODM1MDY1Mw==", "url": "https://github.com/apache/pulsar/pull/7416#discussion_r448350653", "bodyText": "A better way would be to ensure that producers (in every lang) are attaching the routing key on the message metadata protobuf (at the batch level). That is not compressed so we should always be safe.", "author": "merlimat", "createdAt": "2020-07-01T13:08:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMzOTcxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODM2MzAwNg==", "url": "https://github.com/apache/pulsar/pull/7416#discussion_r448363006", "bodyText": "Make sense, so it's better to revert #7107 and other lang clients should attach the routing key on the message metadata.", "author": "codelipenghui", "createdAt": "2020-07-01T13:28:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMzOTcxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODgzNTAwOA==", "url": "https://github.com/apache/pulsar/pull/7416#discussion_r448835008", "bodyText": "@merlimat I have addressed your comment, please take a look, thanks.", "author": "codelipenghui", "createdAt": "2020-07-02T08:27:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMzOTcxOQ=="}], "type": "inlineReview", "revised_code": {"commit": "cb7439e54640e30203b489c70d1c67c43ed573a9", "chunk": "diff --git a/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/AbstractBaseDispatcher.java b/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/AbstractBaseDispatcher.java\nindex 86663d5a0c6..7cf9793c676 100644\n--- a/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/AbstractBaseDispatcher.java\n+++ b/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/AbstractBaseDispatcher.java\n\n@@ -151,48 +151,16 @@ public abstract class AbstractBaseDispatcher implements Dispatcher {\n     public static final String NONE_KEY = \"NONE_KEY\";\n \n     protected byte[] peekStickyKey(ByteBuf metadataAndPayload) {\n-        int readerIndex = metadataAndPayload.readerIndex();\n+        metadataAndPayload.markReaderIndex();\n         PulsarApi.MessageMetadata metadata = Commands.parseMessageMetadata(metadataAndPayload);\n-\n-        try {\n-            if (!metadata.hasOrderingKey() && !metadata.hasPartitionKey() && metadata.hasNumMessagesInBatch()) {\n-                // If the message was part of a batch (eg: a batch of 1 message), we need\n-                // to read the key from the first single-message-metadata entry\n-                PulsarApi.CompressionType compressionType = metadata.getCompression();\n-                CompressionCodec codec = CompressionCodecProvider.getCompressionCodec(compressionType);\n-                int uncompressedSize = metadata.getUncompressedSize();\n-                ByteBuf uncompressedPayload = codec.decode(metadataAndPayload, uncompressedSize);\n-                PulsarApi.SingleMessageMetadata.Builder singleMessageMetadataBuilder = PulsarApi.SingleMessageMetadata\n-                        .newBuilder();\n-                ByteBuf singleMessagePayload = Commands.deSerializeSingleMessageInBatch(uncompressedPayload,\n-                        singleMessageMetadataBuilder, 0, metadata.getNumMessagesInBatch());\n-                uncompressedPayload.release();\n-                try {\n-                    if (singleMessageMetadataBuilder.hasOrderingKey()) {\n-                        return singleMessageMetadataBuilder.getOrderingKey().toByteArray();\n-                    } else if (singleMessageMetadataBuilder.hasPartitionKey()) {\n-                        return singleMessageMetadataBuilder.getPartitionKey().getBytes();\n-                    }\n-                } finally {\n-                    singleMessagePayload.release();\n-                    singleMessageMetadataBuilder.recycle();\n-                }\n-            } else {\n-                // Message was not part of a batch\n-                if (metadata.hasOrderingKey()) {\n-                    return metadata.getOrderingKey().toByteArray();\n-                } else if (metadata.hasPartitionKey()) {\n-                    return metadata.getPartitionKey().getBytes();\n-                }\n-            }\n-\n-            return NONE_KEY.getBytes();\n-        } catch (IOException e) {\n-            // If we fail to deserialize medata, return null key\n-            return NONE_KEY.getBytes();\n-        } finally {\n-            metadataAndPayload.readerIndex(readerIndex);\n-            metadata.recycle();\n+        metadataAndPayload.resetReaderIndex();\n+        byte[] key = NONE_KEY.getBytes();\n+        if (metadata.hasOrderingKey()) {\n+            return metadata.getOrderingKey().toByteArray();\n+        } else if (metadata.hasPartitionKey()) {\n+            return metadata.getPartitionKey().getBytes();\n         }\n+        metadata.recycle();\n+        return key;\n     }\n }\n"}}, {"oid": "cb7439e54640e30203b489c70d1c67c43ed573a9", "url": "https://github.com/apache/pulsar/commit/cb7439e54640e30203b489c70d1c67c43ed573a9", "message": "Apply comments.", "committedDate": "2020-07-02T08:26:39Z", "type": "commit"}, {"oid": "460731c862bad0cc83717cc5de9847586428611c", "url": "https://github.com/apache/pulsar/commit/460731c862bad0cc83717cc5de9847586428611c", "message": "Fix tests.", "committedDate": "2020-07-13T15:35:36Z", "type": "commit"}]}