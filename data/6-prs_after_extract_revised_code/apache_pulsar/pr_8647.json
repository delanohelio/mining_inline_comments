{"pr_number": 8647, "pr_title": "Use  Awaitility  instead Thread.sleep in InactiveTopicDeleteTest.java", "pr_createdAt": "2020-11-20T13:37:48Z", "pr_url": "https://github.com/apache/pulsar/pull/8647", "timeline": [{"oid": "6cd3d4f946e67f553e7d70fe6cc73327f2b566c6", "url": "https://github.com/apache/pulsar/commit/6cd3d4f946e67f553e7d70fe6cc73327f2b566c6", "message": "Avoid sleep", "committedDate": "2020-11-16T12:16:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc1NzI3MQ==", "url": "https://github.com/apache/pulsar/pull/8647#discussion_r527757271", "bodyText": "It can simplify by untilAssert(), Please check all.", "author": "codelipenghui", "createdAt": "2020-11-20T15:12:38Z", "path": "pulsar-broker/src/test/java/org/apache/pulsar/broker/service/InactiveTopicDeleteTest.java", "diffHunk": "@@ -82,12 +84,14 @@ public void testDeleteWhenNoSubscriptions() throws Exception {\n         consumer.close();\n         producer.close();\n \n-        Thread.sleep(2000);\n+        Awaitility.await().atMost(2, TimeUnit.SECONDS).until(() -> admin.topics().getList(\"prop/ns-abc\")\n+                .contains(topic));\n         Assert.assertTrue(admin.topics().getList(\"prop/ns-abc\")\n             .contains(topic));", "originalCommit": "6cd3d4f946e67f553e7d70fe6cc73327f2b566c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgwOTc1OA==", "url": "https://github.com/apache/pulsar/pull/8647#discussion_r527809758", "bodyText": "Thanks lhotari for the reminder", "author": "315157973", "createdAt": "2020-11-20T16:31:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc1NzI3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "83ea194a969458ee47cefc1dfadedad46d3769c8", "chunk": "diff --git a/pulsar-broker/src/test/java/org/apache/pulsar/broker/service/InactiveTopicDeleteTest.java b/pulsar-broker/src/test/java/org/apache/pulsar/broker/service/InactiveTopicDeleteTest.java\nindex 60879d65cb9..02f8e204980 100644\n--- a/pulsar-broker/src/test/java/org/apache/pulsar/broker/service/InactiveTopicDeleteTest.java\n+++ b/pulsar-broker/src/test/java/org/apache/pulsar/broker/service/InactiveTopicDeleteTest.java\n\n@@ -84,16 +84,12 @@ public class InactiveTopicDeleteTest extends BrokerTestBase {\n         consumer.close();\n         producer.close();\n \n-        Awaitility.await().atMost(2, TimeUnit.SECONDS).until(() -> admin.topics().getList(\"prop/ns-abc\")\n-                .contains(topic));\n-        Assert.assertTrue(admin.topics().getList(\"prop/ns-abc\")\n-            .contains(topic));\n+        Awaitility.await().atMost(2, TimeUnit.SECONDS).untilAsserted(() -> Assert.assertTrue(admin.topics().getList(\"prop/ns-abc\")\n+                .contains(topic)));\n \n         admin.topics().deleteSubscription(topic, \"sub\");\n-        Awaitility.await().atMost(2, TimeUnit.SECONDS).until(() -> !admin.topics().getList(\"prop/ns-abc\")\n-                .contains(topic));\n-        Assert.assertFalse(admin.topics().getList(\"prop/ns-abc\")\n-            .contains(topic));\n+        Awaitility.await().atMost(2, TimeUnit.SECONDS).untilAsserted(() -> Assert.assertFalse(admin.topics().getList(\"prop/ns-abc\")\n+                .contains(topic)));\n     }\n \n     @Test\n"}}, {"oid": "83ea194a969458ee47cefc1dfadedad46d3769c8", "url": "https://github.com/apache/pulsar/commit/83ea194a969458ee47cefc1dfadedad46d3769c8", "message": "fix unit test", "committedDate": "2020-11-20T16:31:48Z", "type": "commit"}, {"oid": "a145c38237e0c0a490889c3fdef03265812988a4", "url": "https://github.com/apache/pulsar/commit/a145c38237e0c0a490889c3fdef03265812988a4", "message": "fix unit test", "committedDate": "2020-11-20T16:43:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODA3NjEwNw==", "url": "https://github.com/apache/pulsar/pull/8647#discussion_r528076107", "bodyText": "This one should also can instead by Awaitility", "author": "codelipenghui", "createdAt": "2020-11-21T05:35:20Z", "path": "pulsar-broker/src/test/java/org/apache/pulsar/broker/service/InactiveTopicDeleteTest.java", "diffHunk": "@@ -538,13 +523,8 @@ public void testDeleteWhenNoSubscriptionsWithTopicLevelPolicies() throws Excepti\n         admin.topics().setInactiveTopicPolicies(topic2, inactiveTopicPolicies);\n \n         //wait for update\n-        for (int i = 0; i < 50; i++) {\n-            if (admin.topics().getInactiveTopicPolicies(topic2) != null) {\n-                break;\n-            }\n-            Thread.sleep(100);\n-        }\n-\n+        Awaitility.await().atMost(5, TimeUnit.SECONDS).until(()\n+                -> admin.topics().getInactiveTopicPolicies(topic2) != null);\n         // topic should still exist\n         Thread.sleep(2000);", "originalCommit": "a145c38237e0c0a490889c3fdef03265812988a4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}