{"pr_number": 7690, "pr_title": "[proxy] Fix deadlock in pulsar proxy", "pr_createdAt": "2020-07-29T11:35:12Z", "pr_url": "https://github.com/apache/pulsar/pull/7690", "timeline": [{"oid": "ed630b9d67474990cf5575ae16edde2bee569742", "url": "https://github.com/apache/pulsar/commit/ed630b9d67474990cf5575ae16edde2bee569742", "message": "Fix deadlock in pulsar proxy", "committedDate": "2020-07-29T11:02:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM5NzM4NQ==", "url": "https://github.com/apache/pulsar/pull/7690#discussion_r462397385", "bodyText": "Do we need a blocking call here? Why can't we just make this method async? So we don't need to introduce another thread.", "author": "sijie", "createdAt": "2020-07-29T15:40:54Z", "path": "pulsar-proxy/src/main/java/org/apache/pulsar/proxy/server/util/ZookeeperCacheLoader.java", "diffHunk": "@@ -78,11 +84,14 @@ public LoadManagerReport deserialize(String key, byte[] content) throws Exceptio\n \n         this.availableBrokersCache = new ZooKeeperChildrenCache(getLocalZkCache(), LOADBALANCE_BROKERS_ROOT);\n         this.availableBrokersCache.registerListener((path, brokerNodes, stat) -> {\n-            try {\n-                updateBrokerList(brokerNodes);\n-            } catch (Exception e) {\n-                log.warn(\"Error updating broker info after broker list changed.\", e);\n-            }\n+            // Run in a separate thread to avoid deadlocks\n+            brokerListUpdater.execute(() -> {\n+                try {\n+                    updateBrokerList(brokerNodes);", "originalCommit": "ed630b9d67474990cf5575ae16edde2bee569742", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjgyNjU0Nw==", "url": "https://github.com/apache/pulsar/pull/7690#discussion_r462826547", "bodyText": "I don't think we need a blocking call here. Made the updateBrokerList() method asynchronous.", "author": "massakam", "createdAt": "2020-07-30T08:13:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM5NzM4NQ=="}], "type": "inlineReview", "revised_code": {"commit": "f2c5475c10882fdadf687ad3322558bb5b8b2742", "chunk": "diff --git a/pulsar-proxy/src/main/java/org/apache/pulsar/proxy/server/util/ZookeeperCacheLoader.java b/pulsar-proxy/src/main/java/org/apache/pulsar/proxy/server/util/ZookeeperCacheLoader.java\nindex 748f4258ef9..b2bdee34c64 100644\n--- a/pulsar-proxy/src/main/java/org/apache/pulsar/proxy/server/util/ZookeeperCacheLoader.java\n+++ b/pulsar-proxy/src/main/java/org/apache/pulsar/proxy/server/util/ZookeeperCacheLoader.java\n\n@@ -84,21 +81,19 @@ public class ZookeeperCacheLoader implements Closeable {\n \n         this.availableBrokersCache = new ZooKeeperChildrenCache(getLocalZkCache(), LOADBALANCE_BROKERS_ROOT);\n         this.availableBrokersCache.registerListener((path, brokerNodes, stat) -> {\n-            // Run in a separate thread to avoid deadlocks\n-            brokerListUpdater.execute(() -> {\n-                try {\n-                    updateBrokerList(brokerNodes);\n-                } catch (Exception e) {\n-                    log.warn(\"Error updating broker info after broker list changed.\", e);\n-                }\n+            updateBrokerList(brokerNodes).thenRun(() -> {\n+                log.info(\"Successfully updated broker info {}\", brokerNodes);\n+            }).exceptionally(ex -> {\n+                log.warn(\"Error updating broker info after broker list changed\", ex);\n+                return null;\n             });\n         });\n \n         // Do initial fetch of brokers list\n         try {\n-            updateBrokerList(availableBrokersCache.get());\n+            updateBrokerList(availableBrokersCache.get()).get(zkOperationTimeoutSeconds, TimeUnit.SECONDS);\n         } catch (NoNodeException nne) { // can happen if no broker started yet\n-            updateBrokerList(Collections.emptySet());\n+            updateBrokerList(Collections.emptySet()).get(zkOperationTimeoutSeconds, TimeUnit.SECONDS);\n         }\n     }\n \n"}}, {"oid": "f2c5475c10882fdadf687ad3322558bb5b8b2742", "url": "https://github.com/apache/pulsar/commit/f2c5475c10882fdadf687ad3322558bb5b8b2742", "message": "Update broker info asynchronously", "committedDate": "2020-07-30T07:55:53Z", "type": "commit"}, {"oid": "361512f30fdb2d003f0b17838c966f4e17f33877", "url": "https://github.com/apache/pulsar/commit/361512f30fdb2d003f0b17838c966f4e17f33877", "message": "Make loadReport Optional", "committedDate": "2020-08-04T12:17:12Z", "type": "commit"}]}