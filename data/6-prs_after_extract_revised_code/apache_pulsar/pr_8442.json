{"pr_number": 8442, "pr_title": "Fix the residual of inactive partitioned-topic cleaning", "pr_createdAt": "2020-11-04T01:15:40Z", "pr_url": "https://github.com/apache/pulsar/pull/8442", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODA3NzgyNw==", "url": "https://github.com/apache/pulsar/pull/8442#discussion_r518077827", "bodyText": "There may be problems with this treatment because the partitions of a partitioned topic also is an independent topic, the partitions distributed to different brokers and each topic may have different producers and consumers(In some cases, the client may only connect a few partitions).\nFor example, if we have 3 partitions but only partition-0 have no producers, the broker will delete the partitioned topic. After that, the new producers or consumers will connect to the topic name which is the same as the partition topic but this is a different topic.\nSo it's better to check if all of the partitions are deleted when deleting a partitioned topic.\nAnd, I think it's better to provide an option for users in the broker.conf. Such as brokerDeleteInactivePartitionedTopicEnabled and keep false as the default value.\nI proposed this because if the partitioned metadata is deleted automatically, the reconnecting client might create partitions again when enabling topic auto-creation. This will cause serious problems because the new clients will connect to non-partitioned topic(partitioned metadata is delete, so the broker will create a non-partitioned topic automatically). This may lead to users use the same topic name but unable to pass data.", "author": "codelipenghui", "createdAt": "2020-11-05T14:09:32Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java", "diffHunk": "@@ -1787,6 +1788,32 @@ public void checkGC() {\n         }\n     }\n \n+    private CompletableFuture<Void> deleteZkNode() {\n+        CompletableFuture<Void> deleteZkNodeFuture = new CompletableFuture<>();\n+        TopicName topicName = TopicName.get(topic);\n+        //Only need to delete the ZK node once\n+        if (topicName.isPartitioned() && topicName.getPartitionIndex() == 0) {", "originalCommit": "e823c6e2afef60d5552d64024b470069dcad5021", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f50a545e93256f57b132ef1ddb0e5d3f1f395da8", "chunk": "diff --git a/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java b/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java\nindex 8df058340f9..4e290799cc4 100644\n--- a/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java\n+++ b/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java\n\n@@ -1784,21 +1794,32 @@ public class PersistentTopic extends AbstractTopic implements Topic, AddEntryCal\n                         }\n                         return null;\n                     });\n-\n         }\n     }\n \n     private CompletableFuture<Void> deleteZkNode() {\n-        CompletableFuture<Void> deleteZkNodeFuture = new CompletableFuture<>();\n         TopicName topicName = TopicName.get(topic);\n-        //Only need to delete the ZK node once\n-        if (topicName.isPartitioned() && topicName.getPartitionIndex() == 0) {\n-            String path = AdminResource.path(AdminResource.PARTITIONED_TOPIC_PATH_ZNODE\n-                    , topicName.getNamespace()\n-                    , topicName.getDomain().value(),\n-                    TopicName.get(topicName.getPartitionedTopicName()).getEncodedLocalName());\n-            getBrokerService().pulsar().getGlobalZkCache().getZooKeeper().delete(path,\n-                    -1, (rc, s, o) -> {\n+        String path = AdminResource.path(AdminResource.PARTITIONED_TOPIC_PATH_ZNODE, topicName.getNamespace()\n+                , topicName.getDomain().value(), TopicName.get(topicName.getPartitionedTopicName()).getEncodedLocalName());\n+        try {\n+            if (topicName.isPartitioned() && !getBrokerService().pulsar().getGlobalZkCache().exists(path)) {\n+                return CompletableFuture.completedFuture(null);\n+            }\n+            // make sure all sub partition were deleted\n+            PartitionedTopicMetadata metadata = getBrokerService()\n+                    .fetchPartitionedTopicMetadataAsync(TopicName.get(topicName.getPartitionedTopicName())).get();\n+            String managedPath = String.format(\"/managed-ledgers/%s/%s\", topicName.getNamespace()\n+                    , topicName.getDomain().value());\n+            Set<String> cache = brokerService.pulsar().getLocalZkCacheService().managedLedgerListCache().get(managedPath);\n+            for (int i = 0; i < metadata.partitions; i++) {\n+                if (cache.contains(topicName.getPartition(i).getEncodedLocalName())) {\n+                    return CompletableFuture.completedFuture(null);\n+                }\n+            }\n+\n+            CompletableFuture<Void> deleteZkNodeFuture = new CompletableFuture<>();\n+            getBrokerService().pulsar().getGlobalZkCache().getZooKeeper().delete(path, -1\n+                    , (rc, s, o) -> {\n                         if (KeeperException.Code.OK.intValue() == rc\n                                 || KeeperException.Code.NONODE.intValue() == rc) {\n                             getBrokerService().pulsar().getGlobalZkCache().invalidate(path);\n"}}, {"oid": "f50a545e93256f57b132ef1ddb0e5d3f1f395da8", "url": "https://github.com/apache/pulsar/commit/f50a545e93256f57b132ef1ddb0e5d3f1f395da8", "message": "fix partitioned topic is not deleted", "committedDate": "2020-11-06T15:53:54Z", "type": "forcePushed"}, {"oid": "cd6542755a2f54c4c3e6a0e42f7ac010deb76128", "url": "https://github.com/apache/pulsar/commit/cd6542755a2f54c4c3e6a0e42f7ac010deb76128", "message": "fix partitioned topic is not deleted", "committedDate": "2020-11-06T16:24:12Z", "type": "forcePushed"}, {"oid": "33d4412dd4f99da810b31fc76c119d70fc0a9483", "url": "https://github.com/apache/pulsar/commit/33d4412dd4f99da810b31fc76c119d70fc0a9483", "message": "fix partitioned topic is not deleted", "committedDate": "2020-11-06T17:59:36Z", "type": "forcePushed"}, {"oid": "dfca90c99450c90564ea235d836260dd2867726a", "url": "https://github.com/apache/pulsar/commit/dfca90c99450c90564ea235d836260dd2867726a", "message": "fix partitioned topic is not deleted", "committedDate": "2020-11-06T18:11:10Z", "type": "commit"}, {"oid": "dfca90c99450c90564ea235d836260dd2867726a", "url": "https://github.com/apache/pulsar/commit/dfca90c99450c90564ea235d836260dd2867726a", "message": "fix partitioned topic is not deleted", "committedDate": "2020-11-06T18:11:10Z", "type": "forcePushed"}, {"oid": "aa1c31024e47bf759135a1938696581520f0e5e0", "url": "https://github.com/apache/pulsar/commit/aa1c31024e47bf759135a1938696581520f0e5e0", "message": "change option", "committedDate": "2020-11-07T03:38:00Z", "type": "commit"}, {"oid": "9f770ec73da36c4c91b3ccdcba390b73811758c5", "url": "https://github.com/apache/pulsar/commit/9f770ec73da36c4c91b3ccdcba390b73811758c5", "message": "change doc", "committedDate": "2020-11-07T04:47:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTUwMTY4Mw==", "url": "https://github.com/apache/pulsar/pull/8442#discussion_r519501683", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private CompletableFuture<Void> deleteZkNode() {\n          \n          \n            \n                private CompletableFuture<Void> tryToDeletePartitionedMetadata() {", "author": "codelipenghui", "createdAt": "2020-11-09T00:35:19Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java", "diffHunk": "@@ -1783,7 +1785,47 @@ public void checkGC() {\n                         }\n                         return null;\n                     });\n+        }\n+    }\n+\n+    private CompletableFuture<Void> deleteZkNode() {", "originalCommit": "9f770ec73da36c4c91b3ccdcba390b73811758c5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "25fb624ebd7855140094522d0dfdd0e85f3a6ef7", "chunk": "diff --git a/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java b/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java\nindex c46f818df59..883984267e4 100644\n--- a/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java\n+++ b/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java\n\n@@ -1788,7 +1788,7 @@ public class PersistentTopic extends AbstractTopic implements Topic, AddEntryCal\n         }\n     }\n \n-    private CompletableFuture<Void> deleteZkNode() {\n+    private CompletableFuture<Void> tryToDeletePartitionedMetadata() {\n         if (TopicName.get(topic).isPartitioned() && !deletePartitionedTopicMetadataWhileInactive()) {\n             return CompletableFuture.completedFuture(null);\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTUwMTc3Mw==", "url": "https://github.com/apache/pulsar/pull/8442#discussion_r519501773", "bodyText": "We should get the partitioned metadata asynchronously", "author": "codelipenghui", "createdAt": "2020-11-09T00:36:03Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java", "diffHunk": "@@ -1783,7 +1785,47 @@ public void checkGC() {\n                         }\n                         return null;\n                     });\n+        }\n+    }\n+\n+    private CompletableFuture<Void> deleteZkNode() {\n+        if (TopicName.get(topic).isPartitioned() && !deletePartitionedTopicMetadataWhileInactive()) {\n+            return CompletableFuture.completedFuture(null);\n+        }\n+        TopicName topicName = TopicName.get(TopicName.get(topic).getPartitionedTopicName());\n+        String path = AdminResource.path(AdminResource.PARTITIONED_TOPIC_PATH_ZNODE, topicName.getNamespace()\n+                , topicName.getDomain().value(), topicName.getEncodedLocalName());\n+        try {\n+            if (topicName.isPartitioned() && !getBrokerService().pulsar().getGlobalZkCache().exists(path)) {\n+                return CompletableFuture.completedFuture(null);\n+            }\n+            // make sure all sub partitions were deleted\n+            PartitionedTopicMetadata metadata = getBrokerService()\n+                    .fetchPartitionedTopicMetadataAsync(TopicName.get(topicName.getPartitionedTopicName())).get();", "originalCommit": "9f770ec73da36c4c91b3ccdcba390b73811758c5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "25fb624ebd7855140094522d0dfdd0e85f3a6ef7", "chunk": "diff --git a/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java b/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java\nindex c46f818df59..883984267e4 100644\n--- a/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java\n+++ b/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java\n\n@@ -1788,7 +1788,7 @@ public class PersistentTopic extends AbstractTopic implements Topic, AddEntryCal\n         }\n     }\n \n-    private CompletableFuture<Void> deleteZkNode() {\n+    private CompletableFuture<Void> tryToDeletePartitionedMetadata() {\n         if (TopicName.get(topic).isPartitioned() && !deletePartitionedTopicMetadataWhileInactive()) {\n             return CompletableFuture.completedFuture(null);\n         }\n"}}, {"oid": "25fb624ebd7855140094522d0dfdd0e85f3a6ef7", "url": "https://github.com/apache/pulsar/commit/25fb624ebd7855140094522d0dfdd0e85f3a6ef7", "message": "Update pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java\n\nCo-authored-by: lipenghui <penghui@apache.org>", "committedDate": "2020-11-09T09:51:11Z", "type": "commit"}, {"oid": "a27e26c91f573ed5a3a1f1eae9a693cc09b603cf", "url": "https://github.com/apache/pulsar/commit/a27e26c91f573ed5a3a1f1eae9a693cc09b603cf", "message": "Asynchronous delete", "committedDate": "2020-11-09T13:04:59Z", "type": "commit"}, {"oid": "a27e26c91f573ed5a3a1f1eae9a693cc09b603cf", "url": "https://github.com/apache/pulsar/commit/a27e26c91f573ed5a3a1f1eae9a693cc09b603cf", "message": "Asynchronous delete", "committedDate": "2020-11-09T13:04:59Z", "type": "forcePushed"}]}