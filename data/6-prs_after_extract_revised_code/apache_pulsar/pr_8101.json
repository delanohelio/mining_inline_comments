{"pr_number": 8101, "pr_title": "[Issue 8093]Fix client lookup hangs when broker restarts", "pr_createdAt": "2020-09-22T05:54:01Z", "pr_url": "https://github.com/apache/pulsar/pull/8101", "timeline": [{"oid": "ccde8f5c7ab59867be8989d18b1e605c91f56b85", "url": "https://github.com/apache/pulsar/commit/ccde8f5c7ab59867be8989d18b1e605c91f56b85", "message": "fixed client hangs in lookup", "committedDate": "2020-09-22T05:28:15Z", "type": "commit"}, {"oid": "fc2cdf08662bbb78cdc9d71892955247487cf936", "url": "https://github.com/apache/pulsar/commit/fc2cdf08662bbb78cdc9d71892955247487cf936", "message": "added apache license", "committedDate": "2020-09-22T05:34:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUyNzIyMQ==", "url": "https://github.com/apache/pulsar/pull/8101#discussion_r492527221", "bodyText": "Thanks for the great contribution, I think it's better to return a retryable exception to the client? So that the client can reconnect later. Does this make sense?", "author": "codelipenghui", "createdAt": "2020-09-22T07:32:04Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/namespace/NamespaceService.java", "diffHunk": "@@ -400,6 +400,11 @@ public boolean registerNamespace(String namespace, boolean ensureOwned) throws P\n     private void searchForCandidateBroker(NamespaceBundle bundle,\n                                           CompletableFuture<Optional<LookupResult>> lookupFuture,\n                                           LookupOptions options) {\n+        if( null == pulsar.getLeaderElectionService() || ! pulsar.getLeaderElectionService().isElected()) {\n+            LOG.warn(\"The leader election has not yet been completed! NamespaceBundle[{}]\", bundle);\n+            lookupFuture.completeExceptionally(new IllegalStateException(\"The leader election has not yet been completed!\"));", "originalCommit": "fc2cdf08662bbb78cdc9d71892955247487cf936", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjYyMTI5MA==", "url": "https://github.com/apache/pulsar/pull/8101#discussion_r492621290", "bodyText": "As discussed with @4onni, this will resultin a client lookup timeout, and the client will relookup later, so it's not a problem here.", "author": "codelipenghui", "createdAt": "2020-09-22T10:11:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUyNzIyMQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "7b77ee1d9a4afaff65856d1fc89753849080c810", "url": "https://github.com/apache/pulsar/commit/7b77ee1d9a4afaff65856d1fc89753849080c810", "message": "Merge remote-tracking branch 'apache/master' into fix-lookup-hangs", "committedDate": "2020-09-23T03:11:29Z", "type": "commit"}, {"oid": "7457eecc2e1538ced1967411bc97e46685f30866", "url": "https://github.com/apache/pulsar/commit/7457eecc2e1538ced1967411bc97e46685f30866", "message": "Merge remote-tracking branch 'apache/master' into fix-lookup-hangs", "committedDate": "2020-09-24T03:18:19Z", "type": "commit"}]}