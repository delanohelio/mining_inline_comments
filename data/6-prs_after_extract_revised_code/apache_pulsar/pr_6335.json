{"pr_number": 6335, "pr_title": "Refactored JCloud Tiered Storage", "pr_createdAt": "2020-02-16T20:55:11Z", "pr_url": "https://github.com/apache/pulsar/pull/6335", "timeline": [{"oid": "f557f27a3bc1b549fc825bfb0ffb4dcca241b3d3", "url": "https://github.com/apache/pulsar/commit/f557f27a3bc1b549fc825bfb0ffb4dcca241b3d3", "message": "Refactored JCloud Tiered Storage", "committedDate": "2020-02-16T20:53:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE3ODk0MQ==", "url": "https://github.com/apache/pulsar/pull/6335#discussion_r407178941", "bodyText": "Currently, the Pulsar support independent offload policy for each namespace, the userMetadata param contains the global offload configs and the offloadPolicies param contains the Namespace level offload configs. If the namespace has its own offload policy, we should use the independent offload policy, otherwise, we should use the global offload policy.\nThe OffloadPolicies has independent config for S3 and GCS, such as s3ManagedLedgerOffloadRegion and gcsManagedLedgerOffloadRegion, follow your way, we could combine them as the region.", "author": "gaoran10", "createdAt": "2020-04-12T10:32:53Z", "path": "tiered-storage/jcloud/src/main/java/org/apache/bookkeeper/mledger/offload/jcloud/JCloudLedgerOffloaderFactory.java", "diffHunk": "@@ -38,13 +40,14 @@ public static JCloudLedgerOffloaderFactory of() {\n \n     @Override\n     public boolean isDriverSupported(String driverName) {\n-        return BlobStoreManagedLedgerOffloader.driverSupported(driverName);\n+        return JCloudBlobStoreProvider.driverSupported(driverName);\n     }\n \n     @Override\n-    public BlobStoreManagedLedgerOffloader create(OffloadPolicies offloadPolicies,\n-                                                  Map<String, String> userMetadata,\n-                                                  OrderedScheduler scheduler) throws IOException  {\n-        return BlobStoreManagedLedgerOffloader.create(offloadPolicies, userMetadata, scheduler);\n+    public BlobStoreManagedLedgerOffloader create(OffloadPolicies offloadPolicies, Map<String, String> userMetadata,\n+            OrderedScheduler scheduler) throws IOException {\n+        \n+        TieredStorageConfiguration config = TieredStorageConfiguration.create(userMetadata);\n+        return BlobStoreManagedLedgerOffloader.create(config, userMetadata, scheduler);", "originalCommit": "f557f27a3bc1b549fc825bfb0ffb4dcca241b3d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUzNzQ0Ng==", "url": "https://github.com/apache/pulsar/pull/6335#discussion_r407537446", "bodyText": "The focus of this PR is to refactor the tiered storage to use JCloud. I feel that we need to keep this PR to just that. I suggest we create an issue for this and assign it to me. I will make the change after this PR has been successfully merged.", "author": "david-streamlio", "createdAt": "2020-04-13T15:26:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE3ODk0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEzMTkyMA==", "url": "https://github.com/apache/pulsar/pull/6335#discussion_r448131920", "bodyText": "Sorry for the late response. If we don't care about the OffloadPolicies config, it will cause the namespace offload policies invalid.", "author": "gaoran10", "createdAt": "2020-07-01T05:58:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE3ODk0MQ=="}], "type": "inlineReview", "revised_code": {"commit": "70f3d25da38904cf5307d0661a3719fd71518a3b", "chunk": "diff --git a/tiered-storage/jcloud/src/main/java/org/apache/bookkeeper/mledger/offload/jcloud/JCloudLedgerOffloaderFactory.java b/tiered-storage/jcloud/src/main/java/org/apache/bookkeeper/mledger/offload/jcloud/JCloudLedgerOffloaderFactory.java\nindex 8e9b6d049c5..bebb5802559 100644\n--- a/tiered-storage/jcloud/src/main/java/org/apache/bookkeeper/mledger/offload/jcloud/JCloudLedgerOffloaderFactory.java\n+++ b/tiered-storage/jcloud/src/main/java/org/apache/bookkeeper/mledger/offload/jcloud/JCloudLedgerOffloaderFactory.java\n\n@@ -47,7 +47,8 @@ public class JCloudLedgerOffloaderFactory implements LedgerOffloaderFactory<Blob\n     public BlobStoreManagedLedgerOffloader create(OffloadPolicies offloadPolicies, Map<String, String> userMetadata,\n             OrderedScheduler scheduler) throws IOException {\n         \n-        TieredStorageConfiguration config = TieredStorageConfiguration.create(userMetadata);\n+        TieredStorageConfiguration config =\n+                TieredStorageConfiguration.create(OffloadPolicies.toProperties(offloadPolicies));\n         return BlobStoreManagedLedgerOffloader.create(config, userMetadata, scheduler);\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE3OTk1Ng==", "url": "https://github.com/apache/pulsar/pull/6335#discussion_r407179956", "bodyText": "Currently, when the LedgerOffloader is generated by the PulsarService, the PulsarService will check the namespace's OffloadPolicies, if the new OffloadPolicies is same as the existing OffloadPolicies, the PulsarService will reuse the existing LedgerOffloader, so we should provide the OffloadPolicies of the LedgerOffloader.", "author": "gaoran10", "createdAt": "2020-04-12T10:42:47Z", "path": "tiered-storage/jcloud/src/main/java/org/apache/bookkeeper/mledger/offload/jcloud/impl/BlobStoreManagedLedgerOffloader.java", "diffHunk": "@@ -589,26 +299,17 @@ BlobStore getReadBlobStore(Map<String, String> offloadDriverMetadata) {\n         return promise;\n     }\n \n-    public interface VersionCheck {\n-        void check(String key, Blob blob) throws IOException;\n-    }\n-\n+    \n     @Override\n     public OffloadPolicies getOffloadPolicies() {\n-        return offloadPolicies;\n+        // TODO Auto-generated method stub\n+        return null;\n     }", "originalCommit": "f557f27a3bc1b549fc825bfb0ffb4dcca241b3d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUzNzUzNQ==", "url": "https://github.com/apache/pulsar/pull/6335#discussion_r407537535", "bodyText": "The focus of this PR is to refactor the tiered storage to use JCloud. I feel that we need to keep this PR to just that. I suggest we create an issue for this and assign it to me. I will make the change after this PR has been successfully merged.", "author": "david-streamlio", "createdAt": "2020-04-13T15:26:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE3OTk1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "70f3d25da38904cf5307d0661a3719fd71518a3b", "chunk": "diff --git a/tiered-storage/jcloud/src/main/java/org/apache/bookkeeper/mledger/offload/jcloud/impl/BlobStoreManagedLedgerOffloader.java b/tiered-storage/jcloud/src/main/java/org/apache/bookkeeper/mledger/offload/jcloud/impl/BlobStoreManagedLedgerOffloader.java\nindex 46d3f45efda..59361da5b28 100644\n--- a/tiered-storage/jcloud/src/main/java/org/apache/bookkeeper/mledger/offload/jcloud/impl/BlobStoreManagedLedgerOffloader.java\n+++ b/tiered-storage/jcloud/src/main/java/org/apache/bookkeeper/mledger/offload/jcloud/impl/BlobStoreManagedLedgerOffloader.java\n\n@@ -303,13 +304,18 @@ public class BlobStoreManagedLedgerOffloader implements LedgerOffloader {\n     @Override\n     public OffloadPolicies getOffloadPolicies() {\n         // TODO Auto-generated method stub\n-        return null;\n+        Properties properties = new Properties();\n+        properties.putAll(config.getConfigProperties());\n+        return OffloadPolicies.create(properties);\n     }\n     \n \n     @Override\n     public void close() {\n-        // TODO Auto-generated method stub\n-        \n+        for (BlobStore readBlobStore : blobStores.values()) {\n+            if (readBlobStore != null) {\n+                readBlobStore.getContext().close();\n+            }\n+        }\n     }\n }\n\\ No newline at end of file\n"}}, {"oid": "fe10712f08a42832224a5f59476a086c7b39a63e", "url": "https://github.com/apache/pulsar/commit/fe10712f08a42832224a5f59476a086c7b39a63e", "message": "Refactored JCloud Tiered Storage", "committedDate": "2020-09-21T16:03:38Z", "type": "commit"}, {"oid": "119e348709adb9023e6e2c8f1e2249c5b92539f8", "url": "https://github.com/apache/pulsar/commit/119e348709adb9023e6e2c8f1e2249c5b92539f8", "message": "Rebased", "committedDate": "2020-09-21T16:04:31Z", "type": "commit"}, {"oid": "11f4c7039321abdc001a1ee585716da83e8ff52b", "url": "https://github.com/apache/pulsar/commit/11f4c7039321abdc001a1ee585716da83e8ff52b", "message": "Added missing import statements", "committedDate": "2020-09-21T16:47:39Z", "type": "commit"}, {"oid": "3dec6557b8a07a9fa628dd99aeb0b0b3b3d2c675", "url": "https://github.com/apache/pulsar/commit/3dec6557b8a07a9fa628dd99aeb0b0b3b3d2c675", "message": "Merge branch 'master' into jcloud-take2", "committedDate": "2020-09-23T03:28:00Z", "type": "commit"}, {"oid": "42fe9ce1ddbf75daeb068daa2144f1aedf6857b1", "url": "https://github.com/apache/pulsar/commit/42fe9ce1ddbf75daeb068daa2144f1aedf6857b1", "message": "Refactored JCloud Tiered Storage", "committedDate": "2020-10-03T16:25:17Z", "type": "commit"}, {"oid": "2f325c5e979e19d91d6f7c74db7820379a4568d7", "url": "https://github.com/apache/pulsar/commit/2f325c5e979e19d91d6f7c74db7820379a4568d7", "message": "Refactored JCloud Tiered Storage", "committedDate": "2020-10-03T16:27:24Z", "type": "commit"}, {"oid": "2058624376e77a65db36f1486de4a9020f936a7b", "url": "https://github.com/apache/pulsar/commit/2058624376e77a65db36f1486de4a9020f936a7b", "message": "Added missing import statements", "committedDate": "2020-10-03T16:27:24Z", "type": "commit"}, {"oid": "624e82dea34bccbe22b59f31615e246284142e34", "url": "https://github.com/apache/pulsar/commit/624e82dea34bccbe22b59f31615e246284142e34", "message": "Fixed merge conflicts", "committedDate": "2020-10-03T16:29:22Z", "type": "commit"}, {"oid": "0091374d4172ff1c52d99e99a31efab1819e2627", "url": "https://github.com/apache/pulsar/commit/0091374d4172ff1c52d99e99a31efab1819e2627", "message": "Refactored JCloud Tiered Storage", "committedDate": "2020-10-11T16:45:23Z", "type": "commit"}, {"oid": "599eeca864ce421339f394da8c54699be47e1440", "url": "https://github.com/apache/pulsar/commit/599eeca864ce421339f394da8c54699be47e1440", "message": "Refactored JCloud Tiered Storage", "committedDate": "2020-10-11T16:45:23Z", "type": "commit"}, {"oid": "77ddd425aaf2389c23ab3a18e4bbdd4fc9e48df5", "url": "https://github.com/apache/pulsar/commit/77ddd425aaf2389c23ab3a18e4bbdd4fc9e48df5", "message": "Added missing import statements", "committedDate": "2020-10-11T16:45:23Z", "type": "commit"}, {"oid": "a3e2e4cc26709b271064172c7e2be26c323810c8", "url": "https://github.com/apache/pulsar/commit/a3e2e4cc26709b271064172c7e2be26c323810c8", "message": "fix test", "committedDate": "2020-10-11T16:45:23Z", "type": "commit"}, {"oid": "f7611e0c9cbe1f55dddaa251a8ce8a6be7edb161", "url": "https://github.com/apache/pulsar/commit/f7611e0c9cbe1f55dddaa251a8ce8a6be7edb161", "message": "add test logs", "committedDate": "2020-10-11T16:45:23Z", "type": "commit"}, {"oid": "92537b2f3d62b04eacf328acc9c63beaa9366cfb", "url": "https://github.com/apache/pulsar/commit/92537b2f3d62b04eacf328acc9c63beaa9366cfb", "message": "fix logs", "committedDate": "2020-10-11T16:45:23Z", "type": "commit"}, {"oid": "578ce220d1bb5300d1d653a36de97fb8411e95a5", "url": "https://github.com/apache/pulsar/commit/578ce220d1bb5300d1d653a36de97fb8411e95a5", "message": "fix test", "committedDate": "2020-10-11T16:45:23Z", "type": "commit"}, {"oid": "b60d65ccba09f53d637505d789130c615a4e7171", "url": "https://github.com/apache/pulsar/commit/b60d65ccba09f53d637505d789130c615a4e7171", "message": "fix", "committedDate": "2020-10-11T16:45:23Z", "type": "commit"}, {"oid": "70f3d25da38904cf5307d0661a3719fd71518a3b", "url": "https://github.com/apache/pulsar/commit/70f3d25da38904cf5307d0661a3719fd71518a3b", "message": "fix", "committedDate": "2020-10-11T16:45:23Z", "type": "commit"}, {"oid": "f6efaefc2bc69c2e49d3b4d1055d45d60fc94261", "url": "https://github.com/apache/pulsar/commit/f6efaefc2bc69c2e49d3b4d1055d45d60fc94261", "message": "fix broker log", "committedDate": "2020-10-11T16:45:23Z", "type": "commit"}, {"oid": "453307cef6177af81d32cfee9dee53d296718610", "url": "https://github.com/apache/pulsar/commit/453307cef6177af81d32cfee9dee53d296718610", "message": "fix configuration", "committedDate": "2020-10-11T16:45:23Z", "type": "commit"}, {"oid": "53fb5a68b67ba80f6757c33a8b01a73391c82609", "url": "https://github.com/apache/pulsar/commit/53fb5a68b67ba80f6757c33a8b01a73391c82609", "message": "fix", "committedDate": "2020-10-11T16:45:23Z", "type": "commit"}, {"oid": "b4e07c0c23c81db1cdd244b5aa318705ccf5e416", "url": "https://github.com/apache/pulsar/commit/b4e07c0c23c81db1cdd244b5aa318705ccf5e416", "message": "fix", "committedDate": "2020-10-11T16:45:23Z", "type": "commit"}, {"oid": "c38acac7ab77afc3d049758e8c6aeb3cbf094949", "url": "https://github.com/apache/pulsar/commit/c38acac7ab77afc3d049758e8c6aeb3cbf094949", "message": "fix", "committedDate": "2020-10-11T16:45:23Z", "type": "commit"}, {"oid": "654b96ea5173e466298e607414539fcee22b7825", "url": "https://github.com/apache/pulsar/commit/654b96ea5173e466298e607414539fcee22b7825", "message": "fix get BlobStore", "committedDate": "2020-10-11T16:45:23Z", "type": "commit"}, {"oid": "0de001c99e8b0ec7f828e07eed181f39fd82d66b", "url": "https://github.com/apache/pulsar/commit/0de001c99e8b0ec7f828e07eed181f39fd82d66b", "message": "repair test presto query tiered storage data", "committedDate": "2020-10-11T16:48:05Z", "type": "commit"}, {"oid": "e28258a4b6904d4edb1f9b7f705a1c26cb488277", "url": "https://github.com/apache/pulsar/commit/e28258a4b6904d4edb1f9b7f705a1c26cb488277", "message": "fix test", "committedDate": "2020-10-11T18:22:08Z", "type": "commit"}, {"oid": "f14ac6413f3927fb28f2ba5ebe70f5c5948842b0", "url": "https://github.com/apache/pulsar/commit/f14ac6413f3927fb28f2ba5ebe70f5c5948842b0", "message": "fix test", "committedDate": "2020-10-12T01:09:03Z", "type": "commit"}, {"oid": "52857fa6a14c30e29a498f727ffa0c3bef345115", "url": "https://github.com/apache/pulsar/commit/52857fa6a14c30e29a498f727ffa0c3bef345115", "message": "fix test TestPrestoQueryTieredStorage", "committedDate": "2020-10-16T03:44:54Z", "type": "commit"}, {"oid": "f0190678b843d5f4ed29be51aa3dea05e7c2d1c0", "url": "https://github.com/apache/pulsar/commit/f0190678b843d5f4ed29be51aa3dea05e7c2d1c0", "message": "fix", "committedDate": "2020-10-16T05:24:17Z", "type": "commit"}, {"oid": "41d44dab10448df6535d45350caae3f30b5041e9", "url": "https://github.com/apache/pulsar/commit/41d44dab10448df6535d45350caae3f30b5041e9", "message": "fix", "committedDate": "2020-10-16T05:28:25Z", "type": "commit"}, {"oid": "2ca1d46bc8330cc2672357f8a040a046372392d7", "url": "https://github.com/apache/pulsar/commit/2ca1d46bc8330cc2672357f8a040a046372392d7", "message": "merge gaoran branch to david jcloud-take2\n\nSigned-off-by: xiaolong.ran <rxl@apache.org>", "committedDate": "2020-10-18T05:58:13Z", "type": "commit"}]}