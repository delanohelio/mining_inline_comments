{"pr_number": 7587, "pr_title": "Use Consume/Produce/Lookup interfaces for specific operations in allowTopicOperation", "pr_createdAt": "2020-07-17T23:12:48Z", "pr_url": "https://github.com/apache/pulsar/pull/7587", "timeline": [{"oid": "cd7cbe5f12d359c958a5e6611245d1f13d7e093d", "url": "https://github.com/apache/pulsar/commit/cd7cbe5f12d359c958a5e6611245d1f13d7e093d", "message": "Added upgrade notes", "committedDate": "2020-07-07T19:00:43Z", "type": "commit"}, {"oid": "83b4c58c8466a402229de9f1ad4fcdeb4e0b83ef", "url": "https://github.com/apache/pulsar/commit/83b4c58c8466a402229de9f1ad4fcdeb4e0b83ef", "message": "Merge remote-tracking branch 'apache/master'", "committedDate": "2020-07-08T20:35:54Z", "type": "commit"}, {"oid": "a3ba7f344b8056adb759c040f529094f5ca9d67f", "url": "https://github.com/apache/pulsar/commit/a3ba7f344b8056adb759c040f529094f5ca9d67f", "message": "Merge remote-tracking branch 'apache/master'", "committedDate": "2020-07-12T16:17:19Z", "type": "commit"}, {"oid": "89c8048f57e46a0a336d6b59a73aa19fd9bcfe94", "url": "https://github.com/apache/pulsar/commit/89c8048f57e46a0a336d6b59a73aa19fd9bcfe94", "message": "Merge remote-tracking branch 'apache/master'", "committedDate": "2020-07-12T22:43:18Z", "type": "commit"}, {"oid": "b0728460c11e7babb09d47427818bda7092846cd", "url": "https://github.com/apache/pulsar/commit/b0728460c11e7babb09d47427818bda7092846cd", "message": "Merge remote-tracking branch 'apache/master'", "committedDate": "2020-07-13T20:40:54Z", "type": "commit"}, {"oid": "77bb46778d1ef87c5c14694b634ba9d14e945b74", "url": "https://github.com/apache/pulsar/commit/77bb46778d1ef87c5c14694b634ba9d14e945b74", "message": "Merge remote-tracking branch 'apache/master'", "committedDate": "2020-07-13T23:47:34Z", "type": "commit"}, {"oid": "000336c993a9c92871470b5ded18724d94cd41c6", "url": "https://github.com/apache/pulsar/commit/000336c993a9c92871470b5ded18724d94cd41c6", "message": "Merge remote-tracking branch 'apache/master'", "committedDate": "2020-07-14T18:53:11Z", "type": "commit"}, {"oid": "f9231d29d8ec4dc3e4451436ec6f7eaa3aae6cb4", "url": "https://github.com/apache/pulsar/commit/f9231d29d8ec4dc3e4451436ec6f7eaa3aae6cb4", "message": "Merge remote-tracking branch 'apache/master'", "committedDate": "2020-07-15T15:39:38Z", "type": "commit"}, {"oid": "ee44e3ba01e6793331134ac43e7ca636d49a03ab", "url": "https://github.com/apache/pulsar/commit/ee44e3ba01e6793331134ac43e7ca636d49a03ab", "message": "Merge remote-tracking branch 'apache/master'", "committedDate": "2020-07-16T23:33:16Z", "type": "commit"}, {"oid": "4b02b546faad21540133e66b63d9e691561f4c45", "url": "https://github.com/apache/pulsar/commit/4b02b546faad21540133e66b63d9e691561f4c45", "message": "Merge remote-tracking branch 'apache/master'", "committedDate": "2020-07-17T05:44:01Z", "type": "commit"}, {"oid": "edb2f412a5c025c43d122cb34762402070850b1d", "url": "https://github.com/apache/pulsar/commit/edb2f412a5c025c43d122cb34762402070850b1d", "message": "Merge remote-tracking branch 'apache/master'", "committedDate": "2020-07-17T21:01:04Z", "type": "commit"}, {"oid": "c2173c64e531e3a783e077f038942c4ec7107b12", "url": "https://github.com/apache/pulsar/commit/c2173c64e531e3a783e077f038942c4ec7107b12", "message": "For the generic allowTopicOperations use Consume/Produce/Lookup interfaces", "committedDate": "2020-07-17T23:09:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjcxMTk3OQ==", "url": "https://github.com/apache/pulsar/pull/7587#discussion_r456711979", "bodyText": "I think it is better to change the default implementation in the AuthorizationProvider interface instead of here.\n    /**\n     * Grant authorization-action permission on a topic to the given client\n     * @param topic\n     * @param originalRole role not overriden by proxy role if request do pass through proxy\n     * @param role originalRole | proxyRole if the request didn't pass through proxy\n     * @param operation\n     * @param authData\n     * @return CompletableFuture<Boolean>\n     */\n    default CompletableFuture<Boolean> allowTopicOperationAsync(TopicName topic, String originalRole, String role,\n                                                             TopicOperation operation,\n                                                             AuthenticationDataSource authData) {\nswitch (operation) {\n                case PRODUCE:\n                    return canProduceAsync(topicName, role, authData);\n                case CONSUME:\n                    return canConsumeAsync(topicName, role, authData, null);\n                case LOOKUP:\n                    return canLookupAsync(topicName, role, authData);\n                default:\n                     return FutureUtil.failedFuture(new IllegalStateException(\"TopicOperation is not supported by the Authorization provider you are using.\"));\n    }", "author": "sijie", "createdAt": "2020-07-17T23:20:12Z", "path": "pulsar-broker-common/src/main/java/org/apache/pulsar/broker/authorization/AuthorizationService.java", "diffHunk": "@@ -486,7 +486,16 @@ public Boolean allowNamespacePolicyOperation(NamespaceName namespaceName, Policy\n         }\n \n         if (provider != null) {\n-            return provider.allowTopicOperationAsync(topicName, originalRole, role, operation, authData);\n+            switch (operation) {\n+                case PRODUCE:\n+                    return canProduceAsync(topicName, role, authData);\n+                case CONSUME:\n+                    return canConsumeAsync(topicName, role, authData, null);\n+                case LOOKUP:\n+                    return canLookupAsync(topicName, role, authData);\n+                default:\n+                    return provider.allowTopicOperationAsync(topicName, originalRole, role, operation, authData);", "originalCommit": "c2173c64e531e3a783e077f038942c4ec7107b12", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjcxNjIwMw==", "url": "https://github.com/apache/pulsar/pull/7587#discussion_r456716203", "bodyText": "@sijie Done. PTAL", "author": "srkukarni", "createdAt": "2020-07-17T23:41:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjcxMTk3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "f72caa29b4e322959be8b02010ea116b6cf8cef1", "chunk": "diff --git a/pulsar-broker-common/src/main/java/org/apache/pulsar/broker/authorization/AuthorizationService.java b/pulsar-broker-common/src/main/java/org/apache/pulsar/broker/authorization/AuthorizationService.java\nindex 92777276290..503fae92384 100644\n--- a/pulsar-broker-common/src/main/java/org/apache/pulsar/broker/authorization/AuthorizationService.java\n+++ b/pulsar-broker-common/src/main/java/org/apache/pulsar/broker/authorization/AuthorizationService.java\n\n@@ -485,17 +485,24 @@ public class AuthorizationService {\n             return CompletableFuture.completedFuture(true);\n         }\n \n+        CompletableFuture<Boolean> isAuthorizedFuture;\n+\n         if (provider != null) {\n             switch (operation) {\n                 case PRODUCE:\n-                    return canProduceAsync(topicName, role, authData);\n+                    isAuthorizedFuture = canProduceAsync(topicName, role, authData);\n+                    break;\n                 case CONSUME:\n-                    return canConsumeAsync(topicName, role, authData, null);\n+                    isAuthorizedFuture = canConsumeAsync(topicName, role, authData, null);\n+                    break;\n                 case LOOKUP:\n-                    return canLookupAsync(topicName, role, authData);\n+                    isAuthorizedFuture = canLookupAsync(topicName, role, authData);\n+                    break;\n                 default:\n-                    return provider.allowTopicOperationAsync(topicName, originalRole, role, operation, authData);\n+                    isAuthorizedFuture = provider.allowTopicOperationAsync(topicName, originalRole, role, operation, authData);\n             }\n+            return provider.isSuperUser(role, authData, conf)\n+                    .thenCombine(isAuthorizedFuture, (isSuperUser, isAuthorized) -> isSuperUser || isAuthorized);\n         }\n \n         return FutureUtil.failedFuture(new IllegalStateException(\"No authorization provider configured for \" +\n"}}, {"oid": "f72caa29b4e322959be8b02010ea116b6cf8cef1", "url": "https://github.com/apache/pulsar/commit/f72caa29b4e322959be8b02010ea116b6cf8cef1", "message": "Simplify PulsarAuthProvider", "committedDate": "2020-07-17T23:24:16Z", "type": "commit"}, {"oid": "1aff0cf25648c183864dab1c44c92b1d989c176e", "url": "https://github.com/apache/pulsar/commit/1aff0cf25648c183864dab1c44c92b1d989c176e", "message": "Address comments", "committedDate": "2020-07-17T23:34:37Z", "type": "commit"}, {"oid": "5e87dedf082d45e272e15c8ae28e2067dc4637da", "url": "https://github.com/apache/pulsar/commit/5e87dedf082d45e272e15c8ae28e2067dc4637da", "message": "revert changes", "committedDate": "2020-07-17T23:40:34Z", "type": "commit"}, {"oid": "60e05d1337dede6ee949cc214db3cb699126d508", "url": "https://github.com/apache/pulsar/commit/60e05d1337dede6ee949cc214db3cb699126d508", "message": "much saner impl for allowTenantOperation as well", "committedDate": "2020-07-19T05:24:12Z", "type": "commit"}, {"oid": "d658b9d5e1bbf1be2062e08689bbfa632b36109f", "url": "https://github.com/apache/pulsar/commit/d658b9d5e1bbf1be2062e08689bbfa632b36109f", "message": "saner default for allow namespace policy", "committedDate": "2020-07-19T06:24:43Z", "type": "commit"}, {"oid": "02344476062115e20a5d09920200eed35a67028e", "url": "https://github.com/apache/pulsar/commit/02344476062115e20a5d09920200eed35a67028e", "message": "internal calls already check auth", "committedDate": "2020-07-19T07:56:45Z", "type": "commit"}, {"oid": "afdcc9287ef0a8f631c4af930b00595c7003deec", "url": "https://github.com/apache/pulsar/commit/afdcc9287ef0a8f631c4af930b00595c7003deec", "message": "For the generic allowTopicOperations use Consume/Produce/Lookup interfaces", "committedDate": "2020-07-21T06:27:35Z", "type": "commit"}, {"oid": "bf7512342714c5d7d21a6a6b295c2c642ffa164f", "url": "https://github.com/apache/pulsar/commit/bf7512342714c5d7d21a6a6b295c2c642ffa164f", "message": "Simplify PulsarAuthProvider", "committedDate": "2020-07-21T06:27:35Z", "type": "commit"}, {"oid": "6fd03029035f69c518e2653e0e3c542843dccdc0", "url": "https://github.com/apache/pulsar/commit/6fd03029035f69c518e2653e0e3c542843dccdc0", "message": "Address comments", "committedDate": "2020-07-21T06:27:35Z", "type": "commit"}, {"oid": "f8aec26623534e2ea4232c77520c789c1565dac8", "url": "https://github.com/apache/pulsar/commit/f8aec26623534e2ea4232c77520c789c1565dac8", "message": "revert changes", "committedDate": "2020-07-21T06:27:35Z", "type": "commit"}, {"oid": "14ef995cd73a2990fab80826212b6711085b209d", "url": "https://github.com/apache/pulsar/commit/14ef995cd73a2990fab80826212b6711085b209d", "message": "much saner impl for allowTenantOperation as well", "committedDate": "2020-07-21T06:27:35Z", "type": "commit"}, {"oid": "1a24601f89cc44f1869ca20f38e30dd9099389cd", "url": "https://github.com/apache/pulsar/commit/1a24601f89cc44f1869ca20f38e30dd9099389cd", "message": "saner default for allow namespace policy", "committedDate": "2020-07-21T06:27:35Z", "type": "commit"}, {"oid": "6170dca1b7a389c931f44e6c6848c2c91350b370", "url": "https://github.com/apache/pulsar/commit/6170dca1b7a389c931f44e6c6848c2c91350b370", "message": "internal calls already check auth", "committedDate": "2020-07-21T06:27:35Z", "type": "commit"}, {"oid": "dc08834d8572af52575862a6477926354e3a41ba", "url": "https://github.com/apache/pulsar/commit/dc08834d8572af52575862a6477926354e3a41ba", "message": "Merge branch 'auth_haul3' of github.com:srkukarni/incubator-pulsar into auth_haul3", "committedDate": "2020-07-21T06:27:45Z", "type": "commit"}, {"oid": "725337c2c67f59de31cb212cf0bce71bc347f438", "url": "https://github.com/apache/pulsar/commit/725337c2c67f59de31cb212cf0bce71bc347f438", "message": "Merge branch 'master' into auth_haul3", "committedDate": "2020-07-23T08:51:20Z", "type": "commit"}, {"oid": "775198b492eaa6d5490c91259f60f4d3b29f9593", "url": "https://github.com/apache/pulsar/commit/775198b492eaa6d5490c91259f60f4d3b29f9593", "message": "Merge branch 'master' into auth_haul3", "committedDate": "2020-07-24T16:29:38Z", "type": "commit"}]}