{"pr_number": 6695, "pr_title": "[issue 6694][AVRO ENCODE] Reset cursor if message encode fails.", "pr_createdAt": "2020-04-08T15:15:40Z", "pr_url": "https://github.com/apache/pulsar/pull/6695", "timeline": [{"oid": "15edbc6567e693a2b150b761f7635eef47f3d769", "url": "https://github.com/apache/pulsar/commit/15edbc6567e693a2b150b761f7635eef47f3d769", "message": "[issue#6694][AVRO ENCODE] Reset cursor if encode fails.", "committedDate": "2020-04-08T15:08:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY4Nzc3Mw==", "url": "https://github.com/apache/pulsar/pull/6695#discussion_r405687773", "bodyText": "If this encoder is already flushed, shall we skip flushing it again?", "author": "sijie", "createdAt": "2020-04-08T17:20:24Z", "path": "pulsar-client/src/main/java/org/apache/pulsar/client/impl/schema/writer/AvroWriter.java", "diffHunk": "@@ -47,6 +47,11 @@ public AvroWriter(Schema schema) {\n         } catch (Exception e) {\n             throw new SchemaSerializationException(e);\n         } finally {\n+            try {\n+                this.encoder.flush();", "originalCommit": "15edbc6567e693a2b150b761f7635eef47f3d769", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE5NzU5MA==", "url": "https://github.com/apache/pulsar/pull/6695#discussion_r407197590", "bodyText": "Hi @sijie  thanks for reviewing this promptly.\nBelow are two easy (or minimal code change) alternate option  I see to skip flushing again. Just cosmetic difference. I prefer 1 by the way.\n1 .\n    public synchronized byte[] write(T message) {\n        byte[] outputBytes = null;\n        try {\n            writer.write(message, this.encoder);\n            outputBytes = this.byteArrayOutputStream.toByteArray();\n        } catch (IOException e) {\n            throw new SchemaSerializationException(e);\n        } finally {\n            try {\n                this.encoder.flush();\n            } catch (IOException ex) {\n                throw new SchemaSerializationException(e);\n            }\n            this.byteArrayOutputStream.reset();\n        }\n        return outputBytes;\n    }\n\nAnd 2.\npublic synchronized byte[] write(T message) {\n    try {\n        writer.write(message, this.encoder);\n        this.encoder.flush();\n        return this.byteArrayOutputStream.toByteArray();\n    } catch (IOException e) {\n        try {\n            this.encoder.flush();\n        } catch (IOException ex) {\n            throw new SchemaSerializationException(e);\n        }\n        throw new SchemaSerializationException(e);\n    } finally {\n        this.byteArrayOutputStream.reset();\n    }\n}\n\n\nRegarding your suggestions on slack:\n\nCan flush throw exception?\n\nYes. Infact any method for the encoder throws an IOException!\n\nIf flush also throws exception, then we might need to know where the exception is thrown and whether do we need to call flush.\n\nFlush is here and I want to call it in case of crash because of this line. I understand i need a reset to be precise but there is no way to throw the contents of the stream and reset the cursor to 0.\n\nAlternatively, we can consider adding a flag for indicating if the flush succeeded or not.\n\nThe success or failure is in effect separated by a null pointer exception here. With that, it is still some sort of a hack to catch a null pointer exception and then update a flag. Also, that would require changing the avro library by the way.\nOn the other hand, to add a flag on the pulsar side in the current class will actually mean updating it in the catch/finally which again means there is not much use to adding a flag.\nPlease let me know if (1) is ok. Happy to know if you have any other suggestion(s).", "author": "shiv4289", "createdAt": "2020-04-12T13:22:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY4Nzc3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI1MjMyNA==", "url": "https://github.com/apache/pulsar/pull/6695#discussion_r407252324", "bodyText": "(1) seems fine to me.", "author": "sijie", "createdAt": "2020-04-12T21:07:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY4Nzc3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "c516a8cae8da80436dc1521d09fb25fc04ac077d", "chunk": "diff --git a/pulsar-client/src/main/java/org/apache/pulsar/client/impl/schema/writer/AvroWriter.java b/pulsar-client/src/main/java/org/apache/pulsar/client/impl/schema/writer/AvroWriter.java\nindex 4637ced5323..92cd75cf309 100644\n--- a/pulsar-client/src/main/java/org/apache/pulsar/client/impl/schema/writer/AvroWriter.java\n+++ b/pulsar-client/src/main/java/org/apache/pulsar/client/impl/schema/writer/AvroWriter.java\n\n@@ -40,19 +40,20 @@ public class AvroWriter<T> implements SchemaWriter<T> {\n \n     @Override\n     public synchronized byte[] write(T message) {\n+        byte[] outputBytes = null;\n         try {\n             writer.write(message, this.encoder);\n-            this.encoder.flush();\n-            return this.byteArrayOutputStream.toByteArray();\n         } catch (Exception e) {\n             throw new SchemaSerializationException(e);\n         } finally {\n             try {\n                 this.encoder.flush();\n-            } catch (IOException e) {\n-                throw new SchemaSerializationException(e);\n+                outputBytes = this.byteArrayOutputStream.toByteArray();\n+            } catch (Exception ex) {\n+                throw new SchemaSerializationException(ex);\n             }\n             this.byteArrayOutputStream.reset();\n         }\n+        return outputBytes;\n     }\n }\n"}}, {"oid": "c516a8cae8da80436dc1521d09fb25fc04ac077d", "url": "https://github.com/apache/pulsar/commit/c516a8cae8da80436dc1521d09fb25fc04ac077d", "message": "Add junit test, skip flush if already done", "committedDate": "2020-04-13T08:11:24Z", "type": "commit"}]}