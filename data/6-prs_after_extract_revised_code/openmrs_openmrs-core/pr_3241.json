{"pr_number": 3241, "pr_title": "TRUNK-5746: Refactor getSimilar to use Lucene for 3 names", "pr_createdAt": "2020-06-11T14:15:00Z", "pr_url": "https://github.com/openmrs/openmrs-core/pull/3241", "timeline": [{"oid": "8a9397475754d0460d11ee7fd286bc265c8ae9ae", "url": "https://github.com/openmrs/openmrs-core/commit/8a9397475754d0460d11ee7fd286bc265c8ae9ae", "message": "TRUNK-5746 - Refactor getSimilar to use Lucene for 3 names", "committedDate": "2020-07-22T21:20:49Z", "type": "forcePushed"}, {"oid": "db4dabeeb73f3f09df7160fdebac24ba7ba76368", "url": "https://github.com/openmrs/openmrs-core/commit/db4dabeeb73f3f09df7160fdebac24ba7ba76368", "message": "TRUNK-5746 - Refactor getSimilar to use Lucene for 3 names", "committedDate": "2020-07-22T21:25:51Z", "type": "forcePushed"}, {"oid": "1e661cfb2ad49ab30f364e994ca238a98872b6d1", "url": "https://github.com/openmrs/openmrs-core/commit/1e661cfb2ad49ab30f364e994ca238a98872b6d1", "message": "TRUNK-5746 - Refactor getSimilar to use Lucene for 3 names", "committedDate": "2020-07-22T21:28:50Z", "type": "forcePushed"}, {"oid": "406a5a36094181617a2a080b16411c06ad0f20ba", "url": "https://github.com/openmrs/openmrs-core/commit/406a5a36094181617a2a080b16411c06ad0f20ba", "message": "TRUNK-5746 - Refactor getSimilar to use Lucene for 3 names", "committedDate": "2020-07-22T21:31:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzc3ODAwNg==", "url": "https://github.com/openmrs/openmrs-core/pull/3241#discussion_r463778006", "bodyText": "It seems to me we should at least run LuceneQuery.escapeQuery() on these parameters. But is there a way we could do this more cleanly, i.e., by passing these as paramters instead of a string replace operation?\nIf not, we should at least have this query stored as a constant string since we really just need to do some replacements right before it's executed.", "author": "ibacher", "createdAt": "2020-07-31T18:56:32Z", "path": "api/src/main/java/org/openmrs/api/db/hibernate/PersonLuceneQuery.java", "diffHunk": "@@ -112,6 +112,28 @@ public PersonLuceneQuery(SessionFactory sessionFactory) {\n \t * @param gender the gender of the person to search  \n \t * @return the LuceneQuery that returns Persons with a soundex representation of the firstName and other defined search criteria\n \t */\n+\tpublic LuceneQuery<PersonName> getSoundexPersonNameSearchOnThreeNames(String n1, String n2, String n3,  Integer birthyear, boolean includeVoided, String gender) {\n+\t\tString threeNameQuery = \"\";\n+\t\tString givenNameMatchCondition = \"(givenNameSoundex:n1^6 OR givenNameSoundex:n2^2 OR givenNameSoundex:n3)\";\n+\t\tString middleNameMatchCondition = \"(middleNameSoundex:n1^2 OR middleNameSoundex:n2^6 OR middleNameSoundex:n3^1)\";\n+\t\tString familyNameMatchCondition = \"(familyNameSoundex:n1^1 OR familyNameSoundex:n2^2 OR familyNameSoundex:n3^6)\";\n+\t\tString familyName2MatchCondition = \"(familyName2Soundex:n1^1 OR familyName2Soundex:n2^2 OR familyName2Soundex:n3^6)\";\n+\t\t\n+\t\tthreeNameQuery = givenNameMatchCondition+ \" OR \" + middleNameMatchCondition + \" OR \" + familyNameMatchCondition + \" OR \" + familyName2MatchCondition;\n+ \t\tthreeNameQuery = \"(\" +  threeNameQuery.replace(\"n1\", n1).replace(\"n2\", n2).replace(\"n3\", n3) + \")\";", "originalCommit": "406a5a36094181617a2a080b16411c06ad0f20ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDEyNjU5MQ==", "url": "https://github.com/openmrs/openmrs-core/pull/3241#discussion_r464126591", "bodyText": "What I could do is to directly replace in the query definition the n1, n2, n3 parameter with the correct value but this would made the code less readable I guess.\nI think I would prefer to make it a constant and then replacing the values.\nCan you elaborate a bit more on what your thoughts are on \"passing these as parameters\"?\nAnyways, the escapeQuery can be added easily. I will probably do that till next Sunday!\nThanks!", "author": "fruether", "createdAt": "2020-08-02T21:40:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzc3ODAwNg=="}], "type": "inlineReview", "revised_code": {"commit": "f755017582ff3757441af981a265804635241793", "chunk": "diff --git a/api/src/main/java/org/openmrs/api/db/hibernate/PersonLuceneQuery.java b/api/src/main/java/org/openmrs/api/db/hibernate/PersonLuceneQuery.java\nindex bc6134c96..b9be8bab6 100644\n--- a/api/src/main/java/org/openmrs/api/db/hibernate/PersonLuceneQuery.java\n+++ b/api/src/main/java/org/openmrs/api/db/hibernate/PersonLuceneQuery.java\n\n@@ -113,15 +118,13 @@ public class PersonLuceneQuery {\n \t * @return the LuceneQuery that returns Persons with a soundex representation of the firstName and other defined search criteria\n \t */\n \tpublic LuceneQuery<PersonName> getSoundexPersonNameSearchOnThreeNames(String n1, String n2, String n3,  Integer birthyear, boolean includeVoided, String gender) {\n-\t\tString threeNameQuery = \"\";\n-\t\tString givenNameMatchCondition = \"(givenNameSoundex:n1^6 OR givenNameSoundex:n2^2 OR givenNameSoundex:n3)\";\n-\t\tString middleNameMatchCondition = \"(middleNameSoundex:n1^2 OR middleNameSoundex:n2^6 OR middleNameSoundex:n3^1)\";\n-\t\tString familyNameMatchCondition = \"(familyNameSoundex:n1^1 OR familyNameSoundex:n2^2 OR familyNameSoundex:n3^6)\";\n-\t\tString familyName2MatchCondition = \"(familyName2Soundex:n1^1 OR familyName2Soundex:n2^2 OR familyName2Soundex:n3^6)\";\n \t\t\n-\t\tthreeNameQuery = givenNameMatchCondition+ \" OR \" + middleNameMatchCondition + \" OR \" + familyNameMatchCondition + \" OR \" + familyName2MatchCondition;\n- \t\tthreeNameQuery = \"(\" +  threeNameQuery.replace(\"n1\", n1).replace(\"n2\", n2).replace(\"n3\", n3) + \")\";\n- \t\t\n+\t\tString threeNameQuery =  THREE_NAME_QUERY.replace(\"n1\", LuceneQuery.escapeQuery(n1))\n+\t\t\t.replace(\"n2\", LuceneQuery.escapeQuery(n2))\n+\t\t\t.replace(\"n3\", LuceneQuery.escapeQuery(n3));\n+\t\t\n+\t\tthreeNameQuery = \"(\" +  threeNameQuery.replace(\"n1\", n1).replace(\"n2\", n2).replace(\"n3\", n3) + \")\";\n+\t\t\n \t\treturn getSoundexPersonNameQuery(threeNameQuery, birthyear, includeVoided, gender);\n \t}\t\t\n \t\t\n"}}, {"oid": "f755017582ff3757441af981a265804635241793", "url": "https://github.com/openmrs/openmrs-core/commit/f755017582ff3757441af981a265804635241793", "message": "TRUNK-5746 - Refactor getSimilar to use Lucene for 3 names", "committedDate": "2020-08-15T15:25:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU5OTQxOA==", "url": "https://github.com/openmrs/openmrs-core/pull/3241#discussion_r485599418", "bodyText": "The calls to replace() here are redundant aren't they? I.e., we already did this substitution above.", "author": "ibacher", "createdAt": "2020-09-09T13:12:09Z", "path": "api/src/main/java/org/openmrs/api/db/hibernate/PersonLuceneQuery.java", "diffHunk": "@@ -112,6 +117,26 @@ public PersonLuceneQuery(SessionFactory sessionFactory) {\n \t * @param gender the gender of the person to search  \n \t * @return the LuceneQuery that returns Persons with a soundex representation of the firstName and other defined search criteria\n \t */\n+\tpublic LuceneQuery<PersonName> getSoundexPersonNameSearchOnThreeNames(String n1, String n2, String n3,  Integer birthyear, boolean includeVoided, String gender) {\n+\t\t\n+\t\tString threeNameQuery =  THREE_NAME_QUERY.replace(\"n1\", LuceneQuery.escapeQuery(n1))\n+\t\t\t.replace(\"n2\", LuceneQuery.escapeQuery(n2))\n+\t\t\t.replace(\"n3\", LuceneQuery.escapeQuery(n3));\n+\t\t\n+\t\tthreeNameQuery = \"(\" +  threeNameQuery.replace(\"n1\", n1).replace(\"n2\", n2).replace(\"n3\", n3) + \")\";", "originalCommit": "f755017582ff3757441af981a265804635241793", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcyNTYyNA==", "url": "https://github.com/openmrs/openmrs-core/pull/3241#discussion_r485725624", "bodyText": "You are right", "author": "fruether", "createdAt": "2020-09-09T16:00:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU5OTQxOA=="}], "type": "inlineReview", "revised_code": {"commit": "4d349ab6acd3f1c04e25594a218096ba0d78af06", "chunk": "diff --git a/api/src/main/java/org/openmrs/api/db/hibernate/PersonLuceneQuery.java b/api/src/main/java/org/openmrs/api/db/hibernate/PersonLuceneQuery.java\nindex b9be8bab6..eeea16e22 100644\n--- a/api/src/main/java/org/openmrs/api/db/hibernate/PersonLuceneQuery.java\n+++ b/api/src/main/java/org/openmrs/api/db/hibernate/PersonLuceneQuery.java\n\n@@ -123,8 +123,6 @@ public class PersonLuceneQuery {\n \t\t\t.replace(\"n2\", LuceneQuery.escapeQuery(n2))\n \t\t\t.replace(\"n3\", LuceneQuery.escapeQuery(n3));\n \t\t\n-\t\tthreeNameQuery = \"(\" +  threeNameQuery.replace(\"n1\", n1).replace(\"n2\", n2).replace(\"n3\", n3) + \")\";\n-\t\t\n \t\treturn getSoundexPersonNameQuery(threeNameQuery, birthyear, includeVoided, gender);\n \t}\t\t\n \t\t\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTYwMTQxNA==", "url": "https://github.com/openmrs/openmrs-core/pull/3241#discussion_r485601414", "bodyText": "Some comments on this function now:\n\nWe seem to have eliminated the need for the result variable at all, so that should probably be removed.\nThe line StringBuilder q = ... should be moved to the final else block, since that's the only place it's necessary.\nEither the final else block should be removed or everything after the end of the final else block should be added into the final else block as that common logic only applies when we continue to support a case for multiple names.", "author": "ibacher", "createdAt": "2020-09-09T13:15:08Z", "path": "api/src/main/java/org/openmrs/api/db/hibernate/HibernatePersonDAO.java", "diffHunk": "@@ -202,23 +226,7 @@ public void setSessionFactory(SessionFactory sessionFactory) {\n \t\t} else if (names.length == 2) {", "originalCommit": "f755017582ff3757441af981a265804635241793", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcyNjExNg==", "url": "https://github.com/openmrs/openmrs-core/pull/3241#discussion_r485726116", "bodyText": "Make sense! I am planing to also refactor the else block. But for nut it should be good to move everything in it!", "author": "fruether", "createdAt": "2020-09-09T16:01:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTYwMTQxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc5NTE3OQ==", "url": "https://github.com/openmrs/openmrs-core/pull/3241#discussion_r485795179", "bodyText": "Fixed all these issues in the new commit!", "author": "fruether", "createdAt": "2020-09-09T17:29:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTYwMTQxNA=="}], "type": "inlineReview", "revised_code": {"commit": "4d349ab6acd3f1c04e25594a218096ba0d78af06", "chunk": "diff --git a/api/src/main/java/org/openmrs/api/db/hibernate/HibernatePersonDAO.java b/api/src/main/java/org/openmrs/api/db/hibernate/HibernatePersonDAO.java\nindex 9c3bc0c98..af7d40214 100644\n--- a/api/src/main/java/org/openmrs/api/db/hibernate/HibernatePersonDAO.java\n+++ b/api/src/main/java/org/openmrs/api/db/hibernate/HibernatePersonDAO.java\n\n@@ -216,10 +214,6 @@ public class HibernatePersonDAO implements PersonDAO {\n \t\tname = name.replaceAll(\"  \", \" \");\n \t\tname = name.replace(\", \", \" \");\n \t\tString[] names = name.split(\" \");\n-\t\tSet<Person> result;\n-\t\t\n-\t\tStringBuilder q = new StringBuilder(\n-\t\t        \"select p from Person p left join p.names as pname where p.personVoided = false and pname.voided = false and \");\n \t\t\n \t\tif (names.length == 1) {\n \t\t\treturn  executeSoundexOnePersonNameQuery(name, birthyear, false, gender);\n"}}, {"oid": "4d349ab6acd3f1c04e25594a218096ba0d78af06", "url": "https://github.com/openmrs/openmrs-core/commit/4d349ab6acd3f1c04e25594a218096ba0d78af06", "message": "TRUNK-5746 - Refactor getSimilar to use Lucene for 3 names", "committedDate": "2020-09-09T17:26:46Z", "type": "forcePushed"}, {"oid": "fda2484b8b244560fdbfcbca4328e6566ecb5646", "url": "https://github.com/openmrs/openmrs-core/commit/fda2484b8b244560fdbfcbca4328e6566ecb5646", "message": "TRUNK-5746 - Refactor getSimilar to use Lucene for 3 names", "committedDate": "2020-09-13T15:14:08Z", "type": "forcePushed"}, {"oid": "d32c9ace466cd916d14c9547418e785bf6952251", "url": "https://github.com/openmrs/openmrs-core/commit/d32c9ace466cd916d14c9547418e785bf6952251", "message": "TRUNK-5746 - Refactor getSimilar to use Lucene for 3 names", "committedDate": "2020-09-27T21:28:46Z", "type": "forcePushed"}, {"oid": "93e61338799277c351e92409a5cc5dd1233e31ee", "url": "https://github.com/openmrs/openmrs-core/commit/93e61338799277c351e92409a5cc5dd1233e31ee", "message": "TRUNK-5746 - Refactor getSimilar to use Lucene for 3 names", "committedDate": "2020-09-27T21:33:42Z", "type": "commit"}, {"oid": "05cf25188dba0c0d3e2e69664f7fbe1230fda032", "url": "https://github.com/openmrs/openmrs-core/commit/05cf25188dba0c0d3e2e69664f7fbe1230fda032", "message": "TRUNK-5746 - Refactor getSimilar to use Lucene for 3 names", "committedDate": "2020-09-27T21:35:07Z", "type": "commit"}, {"oid": "05cf25188dba0c0d3e2e69664f7fbe1230fda032", "url": "https://github.com/openmrs/openmrs-core/commit/05cf25188dba0c0d3e2e69664f7fbe1230fda032", "message": "TRUNK-5746 - Refactor getSimilar to use Lucene for 3 names", "committedDate": "2020-09-27T21:35:07Z", "type": "forcePushed"}]}