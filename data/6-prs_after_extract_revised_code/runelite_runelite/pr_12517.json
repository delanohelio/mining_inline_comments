{"pr_number": 12517, "pr_title": "Fix Nightmare Zone Overload timer and notification", "pr_createdAt": "2020-09-20T15:31:32Z", "pr_url": "https://github.com/runelite/runelite/pull/12517", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc4NjM3Mw==", "url": "https://github.com/runelite/runelite/pull/12517#discussion_r491786373", "bodyText": "This should use the same logic as is used in the nightmare zone plugin. I don't think it's an important distinction in this particular case, but this would give false positive results when in KBD's lair", "author": "Nightfirecat", "createdAt": "2020-09-21T04:14:04Z", "path": "runelite-client/src/main/java/net/runelite/client/plugins/timers/TimersPlugin.java", "diffHunk": "@@ -708,6 +712,11 @@ private boolean isInInferno()\n \t\treturn client.getMapRegions() != null && ArrayUtils.contains(client.getMapRegions(), INFERNO_REGION_ID);\n \t}\n \n+\tprivate boolean isInNightmareZone()\n+\t{\n+\t\treturn client.getMapRegions() != null && ArrayUtils.contains(client.getMapRegions(), NMZ_MAP_REGION_ID);\n+\t}", "originalCommit": "c03155ebaf77d82955cee5afa04984db6e9d3c55", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTgyMjc3OQ==", "url": "https://github.com/runelite/runelite/pull/12517#discussion_r491822779", "bodyText": "Sorry, I forgot about NMZ and KBD using the same region. Fixed in a new commit.", "author": "spatiag", "createdAt": "2020-09-21T06:50:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc4NjM3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "ff8b5191c3e502cc7a2cbfa116c6a2ca0e70d023", "chunk": "diff --git a/runelite-client/src/main/java/net/runelite/client/plugins/timers/TimersPlugin.java b/runelite-client/src/main/java/net/runelite/client/plugins/timers/TimersPlugin.java\nindex 72e83f9f0..d78dac2f5 100644\n--- a/runelite-client/src/main/java/net/runelite/client/plugins/timers/TimersPlugin.java\n+++ b/runelite-client/src/main/java/net/runelite/client/plugins/timers/TimersPlugin.java\n\n@@ -714,7 +724,7 @@ public class TimersPlugin extends Plugin\n \n \tprivate boolean isInNightmareZone()\n \t{\n-\t\treturn client.getMapRegions() != null && ArrayUtils.contains(client.getMapRegions(), NMZ_MAP_REGION_ID);\n+\t\treturn client.getLocalPlayer() != null && client.getLocalPlayer().getWorldLocation().getPlane() > 0 && ArrayUtils.contains(client.getMapRegions(), NMZ_MAP_REGION_ID);\n \t}\n \n \tprivate void createTzhaarTimer()\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc4NjcyNw==", "url": "https://github.com/runelite/runelite/pull/12517#discussion_r491786727", "bodyText": "What purpose does this serve? We can safely call removeGameTimer(OVERLOAD) even if the timer hasn't been added.", "author": "Nightfirecat", "createdAt": "2020-09-21T04:16:19Z", "path": "runelite-client/src/main/java/net/runelite/client/plugins/timers/TimersPlugin.java", "diffHunk": "@@ -143,6 +144,7 @@\n \tprivate int lastAnimation;\n \tprivate boolean loggedInRace;\n \tprivate boolean widgetHiddenChangedOnPvpWorld;\n+\tprivate boolean overloadNMZ;", "originalCommit": "c03155ebaf77d82955cee5afa04984db6e9d3c55", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTgyNDEwNw==", "url": "https://github.com/runelite/runelite/pull/12517#discussion_r491824107", "bodyText": "I added overloadNMZ to mimic how the tzhaarTimer is used and to also limit the number of calls to removeGameTimer(OVERLOAD). I originally had this\nif (!isInNightmareZone())\n{\n\tremoveGameTimer(OVERLOAD);\n}\n\nbut it gets triggered frequently outside NMZ by just walking around and loading in new regions.", "author": "spatiag", "createdAt": "2020-09-21T06:53:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc4NjcyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg5NTQxNQ==", "url": "https://github.com/runelite/runelite/pull/12517#discussion_r499895415", "bodyText": "Is it bad for it to be called when walking around? I don't think that's an issue.", "author": "Nightfirecat", "createdAt": "2020-10-05T21:58:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc4NjcyNw=="}], "type": "inlineReview", "revised_code": {"commit": "0e71c88b4d47d7fb2dcc8a862e0b31830887877a", "chunk": "diff --git a/runelite-client/src/main/java/net/runelite/client/plugins/timers/TimersPlugin.java b/runelite-client/src/main/java/net/runelite/client/plugins/timers/TimersPlugin.java\nindex 72e83f9f0..3cbf489c5 100644\n--- a/runelite-client/src/main/java/net/runelite/client/plugins/timers/TimersPlugin.java\n+++ b/runelite-client/src/main/java/net/runelite/client/plugins/timers/TimersPlugin.java\n\n@@ -144,7 +144,6 @@ public class TimersPlugin extends Plugin\n \tprivate int lastAnimation;\n \tprivate boolean loggedInRace;\n \tprivate boolean widgetHiddenChangedOnPvpWorld;\n-\tprivate boolean overloadNMZ;\n \tprivate ElapsedTimer tzhaarTimer;\n \n \t@Inject\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc4Njk3NQ==", "url": "https://github.com/runelite/runelite/pull/12517#discussion_r491786975", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\tif (overloadNotificationSend)\n          \n          \n            \n            \t\t\t{\n          \n          \n            \n            \t\t\t\toverloadNotificationSend = false;\n          \n          \n            \n            \t\t\t}\n          \n          \n            \n            \t\t\toverloadNotificationSend = false;", "author": "Nightfirecat", "createdAt": "2020-09-21T04:18:08Z", "path": "runelite-client/src/main/java/net/runelite/client/plugins/nightmarezone/NightmareZonePlugin.java", "diffHunk": "@@ -135,6 +135,11 @@ public void onGameTick(GameTick event)\n \t\t\t\tresetPointsPerHour();\n \t\t\t}\n \n+\t\t\tif (overloadNotificationSend)\n+\t\t\t{\n+\t\t\t\toverloadNotificationSend = false;\n+\t\t\t}", "originalCommit": "1258d35688c525fbbc1474683a61eb4271990b2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTgyNTMzOA==", "url": "https://github.com/runelite/runelite/pull/12517#discussion_r491825338", "bodyText": "I was thinking of doing it this way, but decided to imitate how absorptionNotificationSend is handled.\nif (!absorptionNotificationSend)\n{\n\tabsorptionNotificationSend = true;\n}\n\nShould we change that block of code to just absorptionNotificationSend = true along with overloadNotificationSend = false?", "author": "spatiag", "createdAt": "2020-09-21T06:56:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc4Njk3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg5NjAwNg==", "url": "https://github.com/runelite/runelite/pull/12517#discussion_r499896006", "bodyText": "I'm not really sure why it was written as it is, but leave it be. This, however, should not be written the same way since it makes no sense.", "author": "Nightfirecat", "createdAt": "2020-10-05T21:59:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc4Njk3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk2MDkzMQ==", "url": "https://github.com/runelite/runelite/pull/12517#discussion_r506960931", "bodyText": "I've also noticed absorptionNotificationSend = true is missing from startUp()", "author": "Adam-", "createdAt": "2020-10-17T16:42:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc4Njk3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "0e71c88b4d47d7fb2dcc8a862e0b31830887877a", "chunk": "diff --git a/runelite-client/src/main/java/net/runelite/client/plugins/nightmarezone/NightmareZonePlugin.java b/runelite-client/src/main/java/net/runelite/client/plugins/nightmarezone/NightmareZonePlugin.java\nindex a604a1e38..a471f5b24 100644\n--- a/runelite-client/src/main/java/net/runelite/client/plugins/nightmarezone/NightmareZonePlugin.java\n+++ b/runelite-client/src/main/java/net/runelite/client/plugins/nightmarezone/NightmareZonePlugin.java\n\n@@ -135,11 +135,6 @@ public class NightmareZonePlugin extends Plugin\n \t\t\t\tresetPointsPerHour();\n \t\t\t}\n \n-\t\t\tif (overloadNotificationSend)\n-\t\t\t{\n-\t\t\t\toverloadNotificationSend = false;\n-\t\t\t}\n-\n \t\t\treturn;\n \t\t}\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk2MDU5MA==", "url": "https://github.com/runelite/runelite/pull/12517#discussion_r506960590", "bodyText": "The timer removal only has to be in LOADING I think.", "author": "Adam-", "createdAt": "2020-10-17T16:39:37Z", "path": "runelite-client/src/main/java/net/runelite/client/plugins/timers/TimersPlugin.java", "diffHunk": "@@ -800,6 +823,7 @@ public void onGameStateChanged(GameStateChanged gameStateChanged)\n \n \t\t\t\tremoveTzhaarTimer(); // will be readded by the wave message\n \t\t\t\tremoveGameTimer(TELEBLOCK);\n+\t\t\t\tremoveNMZOverloadTimer();", "originalCommit": "f9feabc098f6be30f1cedd0a818dbdf09dabcc35", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ff8b5191c3e502cc7a2cbfa116c6a2ca0e70d023", "chunk": "diff --git a/runelite-client/src/main/java/net/runelite/client/plugins/timers/TimersPlugin.java b/runelite-client/src/main/java/net/runelite/client/plugins/timers/TimersPlugin.java\nindex d5568ae05..d78dac2f5 100644\n--- a/runelite-client/src/main/java/net/runelite/client/plugins/timers/TimersPlugin.java\n+++ b/runelite-client/src/main/java/net/runelite/client/plugins/timers/TimersPlugin.java\n\n@@ -823,7 +824,6 @@ public class TimersPlugin extends Plugin\n \n \t\t\t\tremoveTzhaarTimer(); // will be readded by the wave message\n \t\t\t\tremoveGameTimer(TELEBLOCK);\n-\t\t\t\tremoveNMZOverloadTimer();\n \t\t\t\tbreak;\n \t\t\tcase LOGGED_IN:\n \t\t\t\tloggedInRace = true;\n"}}, {"oid": "ff8b5191c3e502cc7a2cbfa116c6a2ca0e70d023", "url": "https://github.com/runelite/runelite/commit/ff8b5191c3e502cc7a2cbfa116c6a2ca0e70d023", "message": "nightmarezone: Fix false Overload notification", "committedDate": "2020-10-25T00:49:13Z", "type": "forcePushed"}, {"oid": "0e71c88b4d47d7fb2dcc8a862e0b31830887877a", "url": "https://github.com/runelite/runelite/commit/0e71c88b4d47d7fb2dcc8a862e0b31830887877a", "message": "timers: Fix NMZ Overload timer not disappearing\n\nUnlike with the CoX Overloads, the plugin did not check if the player\nwas still in the area for the Nightmare Zone Overloads, causing the\ntimer to not disappear after leaving. The plugin now removes the timer\nif the player has left NMZ and has drunk an Overload potion.", "committedDate": "2020-10-25T00:54:07Z", "type": "commit"}, {"oid": "5e2946024b4fdd831a3e70ed98f583941eeaefae", "url": "https://github.com/runelite/runelite/commit/5e2946024b4fdd831a3e70ed98f583941eeaefae", "message": "nightmarezone: Set absorption notification var on startup", "committedDate": "2020-10-25T00:54:08Z", "type": "commit"}, {"oid": "956eb35c26af23956fc0d0eeff4ff003dd6e79ae", "url": "https://github.com/runelite/runelite/commit/956eb35c26af23956fc0d0eeff4ff003dd6e79ae", "message": "nightmarezone: Fix false Overload notification", "committedDate": "2020-10-25T00:54:08Z", "type": "forcePushed"}, {"oid": "5c9ceb9d175ad1e0db8567517904835eaa9c8658", "url": "https://github.com/runelite/runelite/commit/5c9ceb9d175ad1e0db8567517904835eaa9c8658", "message": "nightmarezone: Clear pending overload notifications outside NMZ", "committedDate": "2020-10-25T01:42:53Z", "type": "commit"}, {"oid": "5c9ceb9d175ad1e0db8567517904835eaa9c8658", "url": "https://github.com/runelite/runelite/commit/5c9ceb9d175ad1e0db8567517904835eaa9c8658", "message": "nightmarezone: Clear pending overload notifications outside NMZ", "committedDate": "2020-10-25T01:42:53Z", "type": "forcePushed"}]}