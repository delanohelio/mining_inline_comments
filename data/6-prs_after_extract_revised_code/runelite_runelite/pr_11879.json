{"pr_number": 11879, "pr_title": "inventory-grid: show grid when viewing bank", "pr_createdAt": "2020-06-11T22:58:15Z", "pr_url": "https://github.com/runelite/runelite/pull/11879", "timeline": [{"oid": "1451957f33b4ef4c2bb20b333e86486145705cc2", "url": "https://github.com/runelite/runelite/commit/1451957f33b4ef4c2bb20b333e86486145705cc2", "message": "inventory-grid: show grid when viewing bank", "committedDate": "2020-06-11T22:58:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk4OTk3OA==", "url": "https://github.com/runelite/runelite/pull/11879#discussion_r450989978", "bodyText": "This will just throw a bunch of npes under normal operation.", "author": "Adam-", "createdAt": "2020-07-07T16:24:26Z", "path": "runelite-client/src/main/java/net/runelite/client/plugins/inventorygrid/InventoryGridOverlay.java", "diffHunk": "@@ -130,6 +151,25 @@ else if (config.showGrid())\n \t\treturn null;\n \t}\n \n+\tprivate int getDraggedIndex(Widget inventoryWidget, Widget draggingWidget)\n+\t{\n+\t\tfor (int i = 0; i < INVENTORY_SIZE; i++)\n+\t\t{\n+\t\t\tif (inventoryWidget.getChild(i) == draggingWidget)", "originalCommit": "1451957f33b4ef4c2bb20b333e86486145705cc2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "575398fc6be217c74892af18a4d270b2a2b8168a", "chunk": "diff --git a/runelite-client/src/main/java/net/runelite/client/plugins/inventorygrid/InventoryGridOverlay.java b/runelite-client/src/main/java/net/runelite/client/plugins/inventorygrid/InventoryGridOverlay.java\nindex bccb2e5a7..d82fbb4e6 100644\n--- a/runelite-client/src/main/java/net/runelite/client/plugins/inventorygrid/InventoryGridOverlay.java\n+++ b/runelite-client/src/main/java/net/runelite/client/plugins/inventorygrid/InventoryGridOverlay.java\n\n@@ -151,19 +153,6 @@ class InventoryGridOverlay extends Overlay\n \t\treturn null;\n \t}\n \n-\tprivate int getDraggedIndex(Widget inventoryWidget, Widget draggingWidget)\n-\t{\n-\t\tfor (int i = 0; i < INVENTORY_SIZE; i++)\n-\t\t{\n-\t\t\tif (inventoryWidget.getChild(i) == draggingWidget)\n-\t\t\t{\n-\t\t\t\treturn i;\n-\t\t\t}\n-\t\t}\n-\n-\t\treturn -1;\n-\t}\n-\n \tprivate WidgetItem getWidgetItem(Widget parentWidget, int idx)\n \t{\n \t\tWidget wi = parentWidget.getChild(idx);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk5MjQ3Mg==", "url": "https://github.com/runelite/runelite/pull/11879#discussion_r450992472", "bodyText": "Widgets are safe to reference compare, not sure why you have removed this here?", "author": "Adam-", "createdAt": "2020-07-07T16:28:28Z", "path": "runelite-client/src/main/java/net/runelite/client/plugins/inventorygrid/InventoryGridOverlay.java", "diffHunk": "@@ -72,10 +72,24 @@ private InventoryGridOverlay(InventoryGridConfig config, Client client, ItemMana\n \t@Override\n \tpublic Dimension render(Graphics2D graphics)\n \t{\n-\t\tfinal Widget if1DraggingWidget = client.getIf1DraggedWidget();\n-\t\tfinal Widget inventoryWidget = client.getWidget(WidgetInfo.INVENTORY);\n+\t\tWidget draggingWidget = client.getIf1DraggedWidget();\n+\t\tfinal int draggedItemIndex;\n+\t\tfinal Widget inventoryWidget;\n+\t\tfinal boolean dynamic = draggingWidget == null;\n \n-\t\tif (if1DraggingWidget == null || if1DraggingWidget != inventoryWidget)\n+\t\tif (dynamic)\n+\t\t{\n+\t\t\tinventoryWidget = client.getWidget(WidgetInfo.BANK_INVENTORY_ITEMS_CONTAINER);\n+\t\t\tdraggingWidget = client.getDraggedWidget();\n+\t\t\tdraggedItemIndex = getDraggedIndex(inventoryWidget, draggingWidget);\n+\t\t}\n+\t\telse\n+\t\t{\n+\t\t\tinventoryWidget = client.getWidget(WidgetInfo.INVENTORY);\n+\t\t\tdraggedItemIndex = client.getIf1DraggedItemIndex();\n+\t\t}\n+\n+\t\tif (draggingWidget == null || inventoryWidget == null || draggingWidget.getId() != inventoryWidget.getId())", "originalCommit": "1451957f33b4ef4c2bb20b333e86486145705cc2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkxNDA1Mw==", "url": "https://github.com/runelite/runelite/pull/11879#discussion_r463914053", "bodyText": "It seems the draggedWidget and inventoryWidget instances are not the same when getting the widget from client.getDraggedWidget()\nlog.info(\"{} {} {} {} {} {}\", dynamic, draggingWidget, inventoryWidget, draggingWidget.getId(), inventoryWidget.getId(), draggingWidget == inventoryWidget);\n\nfalse hd@6e685864 hd@6e685864 9764864 9764864 true\ntrue hd@12ba306b hd@50c028a2 983043 983043 false", "author": "while-loop", "createdAt": "2020-08-01T03:11:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk5MjQ3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkxNjE2Mg==", "url": "https://github.com/runelite/runelite/pull/11879#discussion_r463916162", "bodyText": "Added comment explaining why we're not comparing references.", "author": "while-loop", "createdAt": "2020-08-01T03:33:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk5MjQ3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "575398fc6be217c74892af18a4d270b2a2b8168a", "chunk": "diff --git a/runelite-client/src/main/java/net/runelite/client/plugins/inventorygrid/InventoryGridOverlay.java b/runelite-client/src/main/java/net/runelite/client/plugins/inventorygrid/InventoryGridOverlay.java\nindex bccb2e5a7..d82fbb4e6 100644\n--- a/runelite-client/src/main/java/net/runelite/client/plugins/inventorygrid/InventoryGridOverlay.java\n+++ b/runelite-client/src/main/java/net/runelite/client/plugins/inventorygrid/InventoryGridOverlay.java\n\n@@ -81,7 +83,7 @@ class InventoryGridOverlay extends Overlay\n \t\t{\n \t\t\tinventoryWidget = client.getWidget(WidgetInfo.BANK_INVENTORY_ITEMS_CONTAINER);\n \t\t\tdraggingWidget = client.getDraggedWidget();\n-\t\t\tdraggedItemIndex = getDraggedIndex(inventoryWidget, draggingWidget);\n+\t\t\tdraggedItemIndex = draggingWidget != null ? draggingWidget.getIndex() : -1;\n \t\t}\n \t\telse\n \t\t{\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk5NDAwOA==", "url": "https://github.com/runelite/runelite/pull/11879#discussion_r450994008", "bodyText": "Im pretty sure this is just draggingWidget.getIndex()", "author": "Adam-", "createdAt": "2020-07-07T16:30:52Z", "path": "runelite-client/src/main/java/net/runelite/client/plugins/inventorygrid/InventoryGridOverlay.java", "diffHunk": "@@ -72,10 +72,24 @@ private InventoryGridOverlay(InventoryGridConfig config, Client client, ItemMana\n \t@Override\n \tpublic Dimension render(Graphics2D graphics)\n \t{\n-\t\tfinal Widget if1DraggingWidget = client.getIf1DraggedWidget();\n-\t\tfinal Widget inventoryWidget = client.getWidget(WidgetInfo.INVENTORY);\n+\t\tWidget draggingWidget = client.getIf1DraggedWidget();\n+\t\tfinal int draggedItemIndex;\n+\t\tfinal Widget inventoryWidget;\n+\t\tfinal boolean dynamic = draggingWidget == null;\n \n-\t\tif (if1DraggingWidget == null || if1DraggingWidget != inventoryWidget)\n+\t\tif (dynamic)\n+\t\t{\n+\t\t\tinventoryWidget = client.getWidget(WidgetInfo.BANK_INVENTORY_ITEMS_CONTAINER);\n+\t\t\tdraggingWidget = client.getDraggedWidget();\n+\t\t\tdraggedItemIndex = getDraggedIndex(inventoryWidget, draggingWidget);", "originalCommit": "1451957f33b4ef4c2bb20b333e86486145705cc2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "575398fc6be217c74892af18a4d270b2a2b8168a", "chunk": "diff --git a/runelite-client/src/main/java/net/runelite/client/plugins/inventorygrid/InventoryGridOverlay.java b/runelite-client/src/main/java/net/runelite/client/plugins/inventorygrid/InventoryGridOverlay.java\nindex bccb2e5a7..d82fbb4e6 100644\n--- a/runelite-client/src/main/java/net/runelite/client/plugins/inventorygrid/InventoryGridOverlay.java\n+++ b/runelite-client/src/main/java/net/runelite/client/plugins/inventorygrid/InventoryGridOverlay.java\n\n@@ -81,7 +83,7 @@ class InventoryGridOverlay extends Overlay\n \t\t{\n \t\t\tinventoryWidget = client.getWidget(WidgetInfo.BANK_INVENTORY_ITEMS_CONTAINER);\n \t\t\tdraggingWidget = client.getDraggedWidget();\n-\t\t\tdraggedItemIndex = getDraggedIndex(inventoryWidget, draggingWidget);\n+\t\t\tdraggedItemIndex = draggingWidget != null ? draggingWidget.getIndex() : -1;\n \t\t}\n \t\telse\n \t\t{\n"}}, {"oid": "27bd1329d231247f8d8e66b9159294262b29b027", "url": "https://github.com/runelite/runelite/commit/27bd1329d231247f8d8e66b9159294262b29b027", "message": "inventory-grid: show grid when viewing bank", "committedDate": "2020-08-01T02:51:07Z", "type": "forcePushed"}, {"oid": "575398fc6be217c74892af18a4d270b2a2b8168a", "url": "https://github.com/runelite/runelite/commit/575398fc6be217c74892af18a4d270b2a2b8168a", "message": "inventory-grid: show grid when viewing bank", "committedDate": "2020-08-01T03:11:52Z", "type": "forcePushed"}, {"oid": "ddc450289749f843595a83e91ebfd502d7e4e3d4", "url": "https://github.com/runelite/runelite/commit/ddc450289749f843595a83e91ebfd502d7e4e3d4", "message": "inventory-grid: show grid when viewing bank", "committedDate": "2020-08-01T03:13:48Z", "type": "forcePushed"}, {"oid": "8b4e3e640a97f8b3b233ab69f9e5c3069a12b6eb", "url": "https://github.com/runelite/runelite/commit/8b4e3e640a97f8b3b233ab69f9e5c3069a12b6eb", "message": "inventory-grid: show grid when viewing bank", "committedDate": "2020-08-01T03:14:05Z", "type": "forcePushed"}, {"oid": "77d212e44e23acef9865d90dae7dc1ff01ac4634", "url": "https://github.com/runelite/runelite/commit/77d212e44e23acef9865d90dae7dc1ff01ac4634", "message": "inventory-grid: show grid when viewing bank", "committedDate": "2020-08-01T03:31:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkxNzQzNg==", "url": "https://github.com/runelite/runelite/pull/11879#discussion_r463917436", "bodyText": "private static WidgetItem getWidgetItem(Widget parentWidget, int idx)\n    {\n        if (parentWidget.isIf3())\n        {\n            Widget wi = parentWidget.getChild(idx);\n            return new WidgetItem(wi.getItemId(), wi.getItemQuantity(), -1, wi.getBounds(), parentWidget, null);\n        }\n        else\n        {\n            return parentWidget.getWidgetItem(idx);\n        }\n    }", "author": "Adam-", "createdAt": "2020-08-01T03:50:50Z", "path": "runelite-client/src/main/java/net/runelite/client/plugins/inventorygrid/InventoryGridOverlay.java", "diffHunk": "@@ -130,6 +154,12 @@ else if (config.showGrid())\n \t\treturn null;\n \t}\n \n+\tprivate WidgetItem getWidgetItem(Widget parentWidget, int idx)", "originalCommit": "77d212e44e23acef9865d90dae7dc1ff01ac4634", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cb3ffb4b19951d31d268d4248e26aa9581bce3ea", "chunk": "diff --git a/runelite-client/src/main/java/net/runelite/client/plugins/inventorygrid/InventoryGridOverlay.java b/runelite-client/src/main/java/net/runelite/client/plugins/inventorygrid/InventoryGridOverlay.java\nindex 2ec7f337a..11d973b23 100644\n--- a/runelite-client/src/main/java/net/runelite/client/plugins/inventorygrid/InventoryGridOverlay.java\n+++ b/runelite-client/src/main/java/net/runelite/client/plugins/inventorygrid/InventoryGridOverlay.java\n\n@@ -154,10 +144,17 @@ class InventoryGridOverlay extends Overlay\n \t\treturn null;\n \t}\n \n-\tprivate WidgetItem getWidgetItem(Widget parentWidget, int idx)\n+\tprivate static WidgetItem getWidgetItem(Widget parentWidget, int idx)\n \t{\n-\t\tWidget wi = parentWidget.getChild(idx);\n-\t\treturn new WidgetItem(wi.getItemId(), wi.getItemQuantity(), idx, wi.getBounds(), parentWidget, wi.getBounds());\n+\t\tif (parentWidget.isIf3())\n+\t\t{\n+\t\t\tWidget wi = parentWidget.getChild(idx);\n+\t\t\treturn new WidgetItem(wi.getItemId(), wi.getItemQuantity(), idx, wi.getBounds(), parentWidget, wi.getBounds());\n+\t\t}\n+\t\telse\n+\t\t{\n+\t\t\treturn parentWidget.getWidgetItem(idx);\n+\t\t}\n \t}\n \n \tprivate void drawItem(Graphics2D graphics, Rectangle bounds, WidgetItem item)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkxNzQ0Ng==", "url": "https://github.com/runelite/runelite/pull/11879#discussion_r463917446", "bodyText": "draggingWidget.isIf3() ? draggingWidget.getParent() != inventoryWidget : draggingWidget != inventoryWidget", "author": "Adam-", "createdAt": "2020-08-01T03:51:01Z", "path": "runelite-client/src/main/java/net/runelite/client/plugins/inventorygrid/InventoryGridOverlay.java", "diffHunk": "@@ -72,10 +72,27 @@ private InventoryGridOverlay(InventoryGridConfig config, Client client, ItemMana\n \t@Override\n \tpublic Dimension render(Graphics2D graphics)\n \t{\n-\t\tfinal Widget if1DraggingWidget = client.getIf1DraggedWidget();\n-\t\tfinal Widget inventoryWidget = client.getWidget(WidgetInfo.INVENTORY);\n+\t\tWidget draggingWidget = client.getIf1DraggedWidget();\n+\t\tfinal int draggedItemIndex;\n+\t\tfinal Widget inventoryWidget;\n+\t\tfinal boolean isIf3 = draggingWidget == null;\n \n-\t\tif (if1DraggingWidget == null || if1DraggingWidget != inventoryWidget)\n+\t\tif (isIf3)\n+\t\t{\n+\t\t\tinventoryWidget = client.getWidget(WidgetInfo.BANK_INVENTORY_ITEMS_CONTAINER);\n+\t\t\tdraggingWidget = client.getDraggedWidget();\n+\t\t\tdraggedItemIndex = draggingWidget != null ? draggingWidget.getIndex() : -1;\n+\t\t}\n+\t\telse\n+\t\t{\n+\t\t\tinventoryWidget = client.getWidget(WidgetInfo.INVENTORY);\n+\t\t\tdraggedItemIndex = client.getIf1DraggedItemIndex();\n+\t\t}\n+\n+\t\t// Compare the widgets against their ID and not reference.\n+\t\t// When using `if1` widgets the dragging and inventory widgets instances are the same.\n+\t\t// When using `if3` widgets the widget instances are different, but share the same parent ID.\n+\t\tif (draggingWidget == null || inventoryWidget == null || draggingWidget.getId() != inventoryWidget.getId())", "originalCommit": "77d212e44e23acef9865d90dae7dc1ff01ac4634", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cb3ffb4b19951d31d268d4248e26aa9581bce3ea", "chunk": "diff --git a/runelite-client/src/main/java/net/runelite/client/plugins/inventorygrid/InventoryGridOverlay.java b/runelite-client/src/main/java/net/runelite/client/plugins/inventorygrid/InventoryGridOverlay.java\nindex 2ec7f337a..11d973b23 100644\n--- a/runelite-client/src/main/java/net/runelite/client/plugins/inventorygrid/InventoryGridOverlay.java\n+++ b/runelite-client/src/main/java/net/runelite/client/plugins/inventorygrid/InventoryGridOverlay.java\n\n@@ -89,10 +89,9 @@ class InventoryGridOverlay extends Overlay\n \t\t\tdraggedItemIndex = client.getIf1DraggedItemIndex();\n \t\t}\n \n-\t\t// Compare the widgets against their ID and not reference.\n \t\t// When using `if1` widgets the dragging and inventory widgets instances are the same.\n \t\t// When using `if3` widgets the widget instances are different, but share the same parent ID.\n-\t\tif (draggingWidget == null || inventoryWidget == null || draggingWidget.getId() != inventoryWidget.getId())\n+\t\tif (draggingWidget == null || (draggingWidget.isIf3() ? draggingWidget.getParent() != inventoryWidget : draggingWidget != inventoryWidget))\n \t\t{\n \t\t\tinitialMousePoint = null;\n \t\t\thoverActive = false;\n"}}, {"oid": "cb3ffb4b19951d31d268d4248e26aa9581bce3ea", "url": "https://github.com/runelite/runelite/commit/cb3ffb4b19951d31d268d4248e26aa9581bce3ea", "message": "inventory-grid: show grid when viewing bank", "committedDate": "2020-08-01T04:01:13Z", "type": "forcePushed"}, {"oid": "dd9695b2572ec53a1072ab33ae7014d56000d470", "url": "https://github.com/runelite/runelite/commit/dd9695b2572ec53a1072ab33ae7014d56000d470", "message": "inventory-grid: show grid when viewing bank", "committedDate": "2020-08-01T21:25:55Z", "type": "forcePushed"}, {"oid": "1c8f21dc969067d7a21e4127e4f8b1d3aea00f01", "url": "https://github.com/runelite/runelite/commit/1c8f21dc969067d7a21e4127e4f8b1d3aea00f01", "message": "inventory-grid: show grid when viewing bank\n\nCo-authored-by: while-loop <cvballa3g0@gmail.com>", "committedDate": "2020-08-02T15:48:34Z", "type": "commit"}, {"oid": "1c8f21dc969067d7a21e4127e4f8b1d3aea00f01", "url": "https://github.com/runelite/runelite/commit/1c8f21dc969067d7a21e4127e4f8b1d3aea00f01", "message": "inventory-grid: show grid when viewing bank\n\nCo-authored-by: while-loop <cvballa3g0@gmail.com>", "committedDate": "2020-08-02T15:48:34Z", "type": "forcePushed"}]}