{"pr_number": 11754, "pr_title": "chatfilter: fix colored messages not being collapsed", "pr_createdAt": "2020-05-30T00:10:13Z", "pr_url": "https://github.com/runelite/runelite/pull/11754", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc4OTk4Mg==", "url": "https://github.com/runelite/runelite/pull/11754#discussion_r432789982", "bodyText": "This test appears unrelated to the issue, and also passes on master without any modifications to the plugin.", "author": "Adam-", "createdAt": "2020-05-30T00:20:36Z", "path": "runelite-client/src/test/java/net/runelite/client/plugins/chatfilter/ChatFilterPluginTest.java", "diffHunk": "@@ -382,4 +382,16 @@ public void publicChatFilteredOnDuplicate()\n \n \t\tassertEquals(0, client.getIntStack()[client.getIntStackSize() - 3]);\n \t}\n+\n+\t@Test\n+\tpublic void testDuplicateChatFilterIgnoresColor()", "originalCommit": "28fc67ac377e4ec7b8ce4b6aec19b4cb3fdd5e01", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc5MTQ5MA==", "url": "https://github.com/runelite/runelite/pull/11754#discussion_r432791490", "bodyText": "My bad, published the wrong version.", "author": "Bardiches", "createdAt": "2020-05-30T00:32:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc4OTk4Mg=="}], "type": "inlineReview", "revised_code": {"commit": "5cb3e78638b8fd336a3729bc00af8ddd8089dcac", "chunk": "diff --git a/runelite-client/src/test/java/net/runelite/client/plugins/chatfilter/ChatFilterPluginTest.java b/runelite-client/src/test/java/net/runelite/client/plugins/chatfilter/ChatFilterPluginTest.java\nindex 460ea6694..7d4678678 100644\n--- a/runelite-client/src/test/java/net/runelite/client/plugins/chatfilter/ChatFilterPluginTest.java\n+++ b/runelite-client/src/test/java/net/runelite/client/plugins/chatfilter/ChatFilterPluginTest.java\n\n@@ -387,11 +387,14 @@ public class ChatFilterPluginTest\n \tpublic void testDuplicateChatFilterIgnoresColor()\n \t{\n \t\twhen(chatFilterConfig.collapseGameChat()).thenReturn(true);\n-\t\tchatFilterPlugin.onChatMessage(new ChatMessage(mockMessageNode(1), ChatMessageType.GAMEMESSAGE, null, \"testMessage\", null, 0));\n-\t\tScriptCallbackEvent event = createCallbackEvent(null, \"<col=ffff00>testMessage</col>\", ChatMessageType.GAMEMESSAGE);\n+\t\tchatFilterPlugin.onChatMessage(new ChatMessage(mockMessageNode(4), ChatMessageType.GAMEMESSAGE, null, \"testMessage\", null, 0));\n+\t\tchatFilterPlugin.onChatMessage(new ChatMessage(mockMessageNode(3), ChatMessageType.GAMEMESSAGE, null, \"<col=ffff00>testMessage</col>\", null, 0));\n+\t\tchatFilterPlugin.onChatMessage(new ChatMessage(mockMessageNode(2), ChatMessageType.GAMEMESSAGE, null, \"<col=ffff00>testMessage</col>\", null, 0));\n+\t\tchatFilterPlugin.onChatMessage(new ChatMessage(mockMessageNode(1), ChatMessageType.GAMEMESSAGE, null, \"<col=000000>testMessage</col>\", null, 0));\n+\t\tScriptCallbackEvent event = createCallbackEvent(null, \"<col=000000>testMessage</col>\", ChatMessageType.GAMEMESSAGE);\n \t\tchatFilterPlugin.onScriptCallbackEvent(event);\n \n \t\tassertEquals(1, client.getIntStack()[client.getIntStackSize() - 3]);\n-\t\tassertEquals(\"<col=ffff00>testMessage</col>\", client.getStringStack()[client.getStringStackSize() - 1]);\n+\t\tassertEquals(\"<col=000000>testMessage</col> (4)\", client.getStringStack()[client.getStringStackSize() - 1]);\n \t}\n }\n\\ No newline at end of file\n"}}, {"oid": "5cb3e78638b8fd336a3729bc00af8ddd8089dcac", "url": "https://github.com/runelite/runelite/commit/5cb3e78638b8fd336a3729bc00af8ddd8089dcac", "message": "chatfilter: fix colored messages not being collapsed", "committedDate": "2020-05-30T00:28:41Z", "type": "forcePushed"}, {"oid": "c0d4dc773b62ceeeea4c621997ea0f3ba4005a8a", "url": "https://github.com/runelite/runelite/commit/c0d4dc773b62ceeeea4c621997ea0f3ba4005a8a", "message": "chatfilter: fix colored messages not being collapsed", "committedDate": "2020-05-30T02:56:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjgwNTY5NA==", "url": "https://github.com/runelite/runelite/pull/11754#discussion_r432805694", "bodyText": "Are you sure this is correct? I think message always has to be messageNode.getValue()?", "author": "Adam-", "createdAt": "2020-05-30T03:26:36Z", "path": "runelite-client/src/main/java/net/runelite/client/plugins/chatfilter/ChatFilterPlugin.java", "diffHunk": "@@ -192,7 +192,7 @@ public void onScriptCallbackEvent(ScriptCallbackEvent event)\n \t\t\t: COLLAPSIBLE_MESSAGETYPES.contains(chatMessageType) && config.collapseGameChat();\n \t\tif (!blockMessage && shouldCollapse)\n \t\t{\n-\t\t\tDuplicate duplicateCacheEntry = duplicateChatCache.get(name + \":\" + message);\n+\t\t\tDuplicate duplicateCacheEntry = duplicateChatCache.get(name + \":\" + messageNode.getValue());", "originalCommit": "c0d4dc773b62ceeeea4c621997ea0f3ba4005a8a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjgwOTc1OA==", "url": "https://github.com/runelite/runelite/pull/11754#discussion_r432809758", "bodyText": "Good callout, they're the same, so I changed back to using just message.", "author": "Bardiches", "createdAt": "2020-05-30T04:38:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjgwNTY5NA=="}], "type": "inlineReview", "revised_code": {"commit": "04f257d9b128232b4dd0cbb2a8a60893eb4311e9", "chunk": "diff --git a/runelite-client/src/main/java/net/runelite/client/plugins/chatfilter/ChatFilterPlugin.java b/runelite-client/src/main/java/net/runelite/client/plugins/chatfilter/ChatFilterPlugin.java\nindex b3c6ff11d..094407359 100644\n--- a/runelite-client/src/main/java/net/runelite/client/plugins/chatfilter/ChatFilterPlugin.java\n+++ b/runelite-client/src/main/java/net/runelite/client/plugins/chatfilter/ChatFilterPlugin.java\n\n@@ -192,7 +192,7 @@ public class ChatFilterPlugin extends Plugin\n \t\t\t: COLLAPSIBLE_MESSAGETYPES.contains(chatMessageType) && config.collapseGameChat();\n \t\tif (!blockMessage && shouldCollapse)\n \t\t{\n-\t\t\tDuplicate duplicateCacheEntry = duplicateChatCache.get(name + \":\" + messageNode.getValue());\n+\t\t\tDuplicate duplicateCacheEntry = duplicateChatCache.get(name + \":\" + message);\n \t\t\tif (duplicateCacheEntry != null)\n \t\t\t{\n \t\t\t\tblockMessage = duplicateCacheEntry.messageId != messageId ||\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjgwNTczMA==", "url": "https://github.com/runelite/runelite/pull/11754#discussion_r432805730", "bodyText": "Moving removeFormattingTags is fine, but should be in a separate commit since it is unrelated.", "author": "Adam-", "createdAt": "2020-05-30T03:27:19Z", "path": "runelite-client/src/main/java/net/runelite/client/plugins/emojis/EmojiPlugin.java", "diffHunk": "@@ -201,29 +201,4 @@ String updateMessage(final String message)\n \n \t\treturn Strings.join(messageWords, \" \");\n \t}\n-\n-\t/**\n-\t * Remove tags, except for &lt;lt&gt; and &lt;gt&gt;\n-\t *\n-\t * @return\n-\t */\n-\tprivate static String removeTags(String str)", "originalCommit": "c0d4dc773b62ceeeea4c621997ea0f3ba4005a8a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjgwOTc2Mg==", "url": "https://github.com/runelite/runelite/pull/11754#discussion_r432809762", "bodyText": "Sure, removed.", "author": "Bardiches", "createdAt": "2020-05-30T04:38:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjgwNTczMA=="}], "type": "inlineReview", "revised_code": {"commit": "04f257d9b128232b4dd0cbb2a8a60893eb4311e9", "chunk": "diff --git a/runelite-client/src/main/java/net/runelite/client/plugins/emojis/EmojiPlugin.java b/runelite-client/src/main/java/net/runelite/client/plugins/emojis/EmojiPlugin.java\nindex 7c6d56262..06b97428b 100644\n--- a/runelite-client/src/main/java/net/runelite/client/plugins/emojis/EmojiPlugin.java\n+++ b/runelite-client/src/main/java/net/runelite/client/plugins/emojis/EmojiPlugin.java\n\n@@ -201,4 +201,29 @@ public class EmojiPlugin extends Plugin\n \n \t\treturn Strings.join(messageWords, \" \");\n \t}\n+\n+\t/**\n+\t * Remove tags, except for &lt;lt&gt; and &lt;gt&gt;\n+\t *\n+\t * @return\n+\t */\n+\tprivate static String removeTags(String str)\n+\t{\n+\t\tStringBuffer stringBuffer = new StringBuffer();\n+\t\tMatcher matcher = TAG_REGEXP.matcher(str);\n+\t\twhile (matcher.find())\n+\t\t{\n+\t\t\tmatcher.appendReplacement(stringBuffer, \"\");\n+\t\t\tString match = matcher.group(0);\n+\t\t\tswitch (match)\n+\t\t\t{\n+\t\t\t\tcase \"<lt>\":\n+\t\t\t\tcase \"<gt>\":\n+\t\t\t\t\tstringBuffer.append(match);\n+\t\t\t\t\tbreak;\n+\t\t\t}\n+\t\t}\n+\t\tmatcher.appendTail(stringBuffer);\n+\t\treturn stringBuffer.toString();\n+\t}\n }\n"}}, {"oid": "04f257d9b128232b4dd0cbb2a8a60893eb4311e9", "url": "https://github.com/runelite/runelite/commit/04f257d9b128232b4dd0cbb2a8a60893eb4311e9", "message": "chatfilter: fix formatted messages not being collapsed", "committedDate": "2020-05-30T04:37:05Z", "type": "forcePushed"}, {"oid": "6fc309f02b58fa16503897c2e880a5ada1c33e0b", "url": "https://github.com/runelite/runelite/commit/6fc309f02b58fa16503897c2e880a5ada1c33e0b", "message": "chatfilter: fix formatted messages not being collapsed", "committedDate": "2020-06-14T16:42:25Z", "type": "commit"}, {"oid": "6fc309f02b58fa16503897c2e880a5ada1c33e0b", "url": "https://github.com/runelite/runelite/commit/6fc309f02b58fa16503897c2e880a5ada1c33e0b", "message": "chatfilter: fix formatted messages not being collapsed", "committedDate": "2020-06-14T16:42:25Z", "type": "forcePushed"}]}