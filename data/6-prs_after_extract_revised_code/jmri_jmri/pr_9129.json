{"pr_number": 9129, "pr_title": "LayoutEditor:misc bug fixes", "pr_createdAt": "2020-11-02T18:09:54Z", "pr_url": "https://github.com/JMRI/JMRI/pull/9129", "timeline": [{"oid": "e4959d13c9cd80cd7fc4cab4b1593f4de335b589", "url": "https://github.com/JMRI/JMRI/commit/e4959d13c9cd80cd7fc4cab4b1593f4de335b589", "message": "Misc bugfixes", "committedDate": "2020-11-02T18:06:11Z", "type": "commit"}, {"oid": "b1ef96866c595349d30419fd91bf58d19ed0d35e", "url": "https://github.com/JMRI/JMRI/commit/b1ef96866c595349d30419fd91bf58d19ed0d35e", "message": "Update LayoutEditor.java", "committedDate": "2020-11-02T18:06:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE2OTM1OA==", "url": "https://github.com/JMRI/JMRI/pull/9129#discussion_r516169358", "bodyText": "Could you say a few words about why this is here?  It seems to defeat the purpose of the loop, but perhaps I don't understand what this loop is meant to do.", "author": "bobjacobsen", "createdAt": "2020-11-02T18:19:36Z", "path": "java/src/jmri/jmrit/display/layoutEditor/LayoutEditorAction.java", "diffHunk": "@@ -27,6 +27,8 @@ public void actionPerformed(ActionEvent e) {\n         for (int i = 2; i < 100; i++) {\n             if (InstanceManager.getDefault(EditorManager.class).contains(name)) {\n                 name = \"My Layout \" + i;\n+            } else {", "originalCommit": "b1ef96866c595349d30419fd91bf58d19ed0d35e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE5MTg4Mg==", "url": "https://github.com/JMRI/JMRI/pull/9129#discussion_r516191882", "bodyText": "It's looking for a unique layout name\u2026 If it finds an existing one with the same name then it bumps the name and tries again\u2026 Original code tried all numbers 2 thru 100 (no break). The reality is that it only needs the first one that didn't already exist.", "author": "geowar1", "createdAt": "2020-11-02T19:01:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE2OTM1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjY3MDgzMg==", "url": "https://github.com/JMRI/JMRI/pull/9129#discussion_r516670832", "bodyText": "Thanks!  Got it.  Was confused by contains() instead of equals().", "author": "bobjacobsen", "createdAt": "2020-11-03T13:37:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE2OTM1OA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "49afc3d17d5ce1661dd42374be3dab08a5465232", "url": "https://github.com/JMRI/JMRI/commit/49afc3d17d5ce1661dd42374be3dab08a5465232", "message": "Update MathUtil.java", "committedDate": "2020-11-02T18:21:42Z", "type": "commit"}, {"oid": "022cda044f468d318317b851d0af3f2c484cc479", "url": "https://github.com/JMRI/JMRI/commit/022cda044f468d318317b851d0af3f2c484cc479", "message": "Fix Windows CI test fails\n\nRevert anchor one of two connection Color to yellow.", "committedDate": "2020-11-02T19:20:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjY3NjYwMA==", "url": "https://github.com/JMRI/JMRI/pull/9129#discussion_r516676600", "bodyText": "The infinite loop that @danielb987 saw in CI goes through here.  Line 1909 of TrackSegment view in getCentreSeg does a setCoordsCenter call, which goes through getBounds, which in line 574 calls getCentreSeg again.  Not sure whether the underlying problem is here or in line 1909 (why is a get call setting something?), but this is the new code.", "author": "bobjacobsen", "createdAt": "2020-11-03T13:46:33Z", "path": "java/src/jmri/jmrit/display/layoutEditor/TrackSegmentView.java", "diffHunk": "@@ -564,6 +564,15 @@ public Rectangle2D getBounds() {\n         result = new Rectangle2D.Double(ep1.getX(), ep1.getY(), 0, 0);\n         result.add(ep2);\n \n+        if (isCircle()) {\n+            result.add(getCoordsCenterCircle());\n+        } else if (isBezier()) {\n+            for (int index = 0; index < bezierControlPoints.size(); index++) {\n+                result.add(bezierControlPoints.get(index));\n+            }\n+        }\n+        result.add(getCentreSeg());", "originalCommit": "022cda044f468d318317b851d0af3f2c484cc479", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkyMDk3Mg==", "url": "https://github.com/JMRI/JMRI/pull/9129#discussion_r516920972", "bodyText": "Thanks for the catch/analysis!\nI added a getCentreSeg() call to getBounds() method to add that point to the returned bounds.\nBut (as you said) the getCentreSeg() method uses getBounds() to calculate where the center seg should be\u2026\nSo we can't call getCentreSeg() here\u2026 but since it calls super.setCoordsCenter(\u2026) we can use super.getCoordsCenter to get that point (without re-calculating it) instead. So\u2026 fixed(?)\n;-)", "author": "geowar1", "createdAt": "2020-11-03T19:56:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjY3NjYwMA=="}], "type": "inlineReview", "revised_code": {"commit": "9b7328c6fa73efb1da95e6cd21d8b3572fa9d7c9", "chunk": "diff --git a/java/src/jmri/jmrit/display/layoutEditor/TrackSegmentView.java b/java/src/jmri/jmrit/display/layoutEditor/TrackSegmentView.java\nindex 7ab19cff11..3026296b12 100644\n--- a/java/src/jmri/jmrit/display/layoutEditor/TrackSegmentView.java\n+++ b/java/src/jmri/jmrit/display/layoutEditor/TrackSegmentView.java\n\n@@ -571,7 +571,7 @@ public class TrackSegmentView extends LayoutTrackView {\n                 result.add(bezierControlPoints.get(index));\n             }\n         }\n-        result.add(getCentreSeg());\n+        result.add(getCoordsCenter());\n \n         return result;\n     }\n"}}, {"oid": "9b7328c6fa73efb1da95e6cd21d8b3572fa9d7c9", "url": "https://github.com/JMRI/JMRI/commit/9b7328c6fa73efb1da95e6cd21d8b3572fa9d7c9", "message": "getCentreSeg() ==> getCoordsCenter()\n\ngetCentreSeg used getBounds to calculate where the center seg should be\u2026 So we can't call getCentreSeg here\u2026 but since it also calls setCoordsCenter(\u2026) we can use getCoordsCenter instead. So\u2026 quick fix! ;-)", "committedDate": "2020-11-03T19:42:41Z", "type": "commit"}, {"oid": "d883ed50572cace60bb558915633d1afb80e5c34", "url": "https://github.com/JMRI/JMRI/commit/d883ed50572cace60bb558915633d1afb80e5c34", "message": "Update LayoutEditorComponent.java\n\nDon't centerRectangleOnPoint(r, ls.getCoordsCenter());", "committedDate": "2020-11-03T19:51:12Z", "type": "commit"}, {"oid": "1c20b65bd760946feabb7fa84a418e24d744baef", "url": "https://github.com/JMRI/JMRI/commit/1c20b65bd760946feabb7fa84a418e24d744baef", "message": "getCentreSeg() ==> calcCentreSeg\n\nChanged getCentreSeg() to just return getCoordsCenter()\u2026\nTrackSegmentView.drawEditControls calls calcCentreSeg", "committedDate": "2020-11-03T23:32:36Z", "type": "commit"}, {"oid": "0c37a865586be500798c1d5c76e44006af03ae1d", "url": "https://github.com/JMRI/JMRI/commit/0c37a865586be500798c1d5c76e44006af03ae1d", "message": "Fix TrackSegmentView tests because getBounds() now returns correct rectangle.", "committedDate": "2020-11-04T00:15:09Z", "type": "commit"}, {"oid": "89d612a804d8323455fa85f0d8535b0cad982a55", "url": "https://github.com/JMRI/JMRI/commit/89d612a804d8323455fa85f0d8535b0cad982a55", "message": "Update TrackSegmentViewTest.java", "committedDate": "2020-11-05T03:12:02Z", "type": "commit"}, {"oid": "528b80542ca4023b46175d58fecb97c9e5659cfe", "url": "https://github.com/JMRI/JMRI/commit/528b80542ca4023b46175d58fecb97c9e5659cfe", "message": "Update TrackSegmentViewTest.java", "committedDate": "2020-11-05T03:23:32Z", "type": "commit"}, {"oid": "9186f6a4cf52d56701051437cda0df0d91aa60ea", "url": "https://github.com/JMRI/JMRI/commit/9186f6a4cf52d56701051437cda0df0d91aa60ea", "message": "Fix for getCentreSeg getBounds stack overflow", "committedDate": "2020-11-05T20:54:40Z", "type": "commit"}, {"oid": "4dd53701f8c7db2638d00a17b72272b2b7398fd2", "url": "https://github.com/JMRI/JMRI/commit/4dd53701f8c7db2638d00a17b72272b2b7398fd2", "message": "Fixes for #9145 (NOTE: Webserver LE panel drawing BROKEN in top-of-tree)", "committedDate": "2020-11-13T00:36:11Z", "type": "commit"}, {"oid": "b6ba9a413e0c5734b483f39422327a5169086169", "url": "https://github.com/JMRI/JMRI/commit/b6ba9a413e0c5734b483f39422327a5169086169", "message": "Fix LayoutEditorXML for main/side line track widths\n\nUpdate panel.js to use isDefined/isUndefined functions", "committedDate": "2020-11-13T04:59:56Z", "type": "commit"}, {"oid": "4dca88161dcd1d3081b950bcf364f2c5fb3e20cd", "url": "https://github.com/JMRI/JMRI/commit/4dca88161dcd1d3081b950bcf364f2c5fb3e20cd", "message": "two typo's fixed in panel.js", "committedDate": "2020-11-13T05:06:10Z", "type": "commit"}, {"oid": "e9053dd281905a4bf23e77fb9e9985e6375b59d9", "url": "https://github.com/JMRI/JMRI/commit/e9053dd281905a4bf23e77fb9e9985e6375b59d9", "message": "Update LayoutPanelServlet.java\n\nFixes \"can't draw tracksegment T10: connect2: X0.LEVEL_XING_A undefined errors\".", "committedDate": "2020-11-13T05:48:11Z", "type": "commit"}]}