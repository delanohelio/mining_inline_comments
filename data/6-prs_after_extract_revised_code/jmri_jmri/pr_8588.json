{"pr_number": 8588, "pr_title": "fix: associate a memo with startup action stored within memo prefix", "pr_createdAt": "2020-05-25T15:57:02Z", "pr_url": "https://github.com/JMRI/JMRI/pull/8588", "timeline": [{"oid": "5358f8ae2d7186ddde14ebd66bb739b7e075ef71", "url": "https://github.com/JMRI/JMRI/commit/5358f8ae2d7186ddde14ebd66bb739b7e075ef71", "message": "fix: associate a memo with startup action stored within memo prefix\n\nIf an action that needs a specific connection to act on is stored without a valid identifier for that connection, we should treat is as invalid action; however, there is a special case that needs to be supported for historical reasons--we never made most actions that act on a specific connection do so until #8544; they simply acted on the last connection of a specific type (regardless of the number of connections of a specific type).\n\nFixes #8582\nFixes #8583", "committedDate": "2020-05-25T15:56:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA0NzI2Ng==", "url": "https://github.com/JMRI/JMRI/pull/8588#discussion_r430047266", "bodyText": "Would it make sense to log (at WARN? INFO?) this occurrence so that people trying to solve a downstream problem (i.e. should the Manager not handle it; I'm not sure they will absent tests) get a hit to look back to hear?  (2 places)", "author": "bobjacobsen", "createdAt": "2020-05-25T18:53:22Z", "path": "java/src/apps/configurexml/PerformActionModelXml.java", "diffHunk": "@@ -57,12 +63,36 @@ public boolean load(Element shared, Element perNode) {\n         String className = shared.getAttribute(\"name\").getValue();\n         PerformActionModel model = new PerformActionModel();\n         model.setClassName(className);\n-        for (Element child : shared.getChildren(\"property\")) { // NOI18N\n+        shared.getChildren(\"property\").forEach(child -> { // NOI18N\n+            String value = child.getAttributeValue(\"value\"); // NOI18N\n             if (child.getAttributeValue(\"name\").equals(\"systemPrefix\") // NOI18N\n-                    && child.getAttributeValue(\"value\") != null) { // NOI18N\n-                model.setSystemPrefix(child.getAttributeValue(\"value\")); // NOI18N\n+                    && value != null) {\n+                // handle the situation where the model expects a system prefix\n+                // but was not saved with one in a pre-4.19.7 JMRI instance\n+                // TODO: at some point (June 2022 release?) change entire\n+                // try/catch block to just \"model.setSystemPrefix(value);\"\n+                try {\n+                    Class<?> ac = Class.forName(className);\n+                    if (value.isEmpty() && SystemConnectionAction.class.isAssignableFrom(ac)) {\n+                        SystemConnectionAction<?> a = (SystemConnectionAction<?>) ac.getConstructor().newInstance();\n+                        InstanceManager.getList(SystemConnectionMemo.class)\n+                                .forEach(memo -> a.getSystemConnectionMemoClasses().stream()\n+                                .filter(mc -> memo.getClass().isAssignableFrom(mc))\n+                                .forEach(mc -> model.setSystemPrefix(memo.getSystemPrefix())));\n+                    } else {\n+                        model.setSystemPrefix(value);\n+                    }\n+                } catch (ClassNotFoundException\n+                        | InstantiationException\n+                        | IllegalAccessException\n+                        | IllegalArgumentException\n+                        | InvocationTargetException\n+                        | NoSuchMethodException\n+                        | SecurityException ex) {\n+                    // ignore to allow manager to handle later", "originalCommit": "5358f8ae2d7186ddde14ebd66bb739b7e075ef71", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}