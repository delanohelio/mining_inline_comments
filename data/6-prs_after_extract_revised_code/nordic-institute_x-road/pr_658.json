{"pr_number": 658, "pr_title": "XRDDEV-1271: Avoid GlobalConf update during backup restore", "pr_createdAt": "2020-08-20T07:41:57Z", "pr_url": "https://github.com/nordic-institute/X-Road/pull/658", "timeline": [{"oid": "26183915eb1f83a34953020c9a0b1262001b3410", "url": "https://github.com/nordic-institute/X-Road/commit/26183915eb1f83a34953020c9a0b1262001b3410", "message": "XRDDEV-1271: Avoid GlobalConf update during backup restore\n\n* Refactor RestoreService to publish an restore start/stop event,\n  decoupling it from listeners (GlobalConfChecker, NotificationService).\n* Clean up EvictConnectionsService (no need for a transaction when\n  evicting connections)", "committedDate": "2020-08-20T07:35:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzkxNTQ4NA==", "url": "https://github.com/nordic-institute/X-Road/pull/658#discussion_r473915484", "bodyText": "Maybe a log.debug message would be useful here, and consistent with how clustered setup globalconf skipping works?", "author": "jansu76", "createdAt": "2020-08-20T11:58:44Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/scheduling/GlobalConfChecker.java", "diffHunk": "@@ -82,13 +84,18 @@ public GlobalConfChecker(GlobalConfCheckerHelper globalConfCheckerHelper, Global\n      * @throws Exception\n      */\n     @Scheduled(fixedRate = JOB_REPEAT_INTERVAL_MS, initialDelay = INITIAL_DELAY_MS)\n-    public void updateServerConf() throws Exception {\n+    @Transactional\n+    public void updateServerConf() {\n         // In clustered setup slave nodes may skip globalconf updates\n         if (SLAVE.equals(SystemProperties.getServerNodeType())) {\n             log.debug(\"This is a slave node - skip globalconf updates\");\n             return;\n         }\n \n+        if (restoreInProgress) {\n+            return;", "originalCommit": "26183915eb1f83a34953020c9a0b1262001b3410", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "737fb1770e0c1d099e312e2dc21b28e751aeacdd", "chunk": "diff --git a/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/scheduling/GlobalConfChecker.java b/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/scheduling/GlobalConfChecker.java\nindex 82c2e9c09..e80612442 100644\n--- a/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/scheduling/GlobalConfChecker.java\n+++ b/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/scheduling/GlobalConfChecker.java\n\n@@ -93,6 +93,7 @@ public class GlobalConfChecker {\n         }\n \n         if (restoreInProgress) {\n+            log.debug(\"Backup restore in progress - skipping globalconf update\");\n             return;\n         }\n \n"}}, {"oid": "737fb1770e0c1d099e312e2dc21b28e751aeacdd", "url": "https://github.com/nordic-institute/X-Road/commit/737fb1770e0c1d099e312e2dc21b28e751aeacdd", "message": "XRDDEV-1271: Improve debug logging", "committedDate": "2020-08-20T12:36:14Z", "type": "commit"}]}