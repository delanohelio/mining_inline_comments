{"pr_number": 650, "pr_title": "XRDDEV-1248/XRDDEV-1249", "pr_createdAt": "2020-08-15T12:04:49Z", "pr_url": "https://github.com/nordic-institute/X-Road/pull/650", "timeline": [{"oid": "7a7b96ae31e4ed7257ca6ba67f8ef6209930953a", "url": "https://github.com/nordic-institute/X-Road/commit/7a7b96ae31e4ed7257ca6ba67f8ef6209930953a", "message": "XRDDEV-1248 Update delete key service\n\n- Throw an UnhandledWarningsException if auth key has a registered certificate when it's deleted.\n- Add ignore_warnings URL param to delete key endpoint.\n- Update OpenAPI description.\n- Add unit test.", "committedDate": "2020-08-15T07:28:22Z", "type": "commit"}, {"oid": "8179c302e22c28b30ac9700be6d4d7f7396bea45", "url": "https://github.com/nordic-institute/X-Road/commit/8179c302e22c28b30ac9700be6d4d7f7396bea45", "message": "XRDDEV-1248 Update warning code and localisation string", "committedDate": "2020-08-15T07:41:09Z", "type": "commit"}, {"oid": "5190ad342e08e46a9558d27aaf4c7f72865b162e", "url": "https://github.com/nordic-institute/X-Road/commit/5190ad342e08e46a9558d27aaf4c7f72865b162e", "message": "XRDDEV-1249 Add loading state to the Delete key button", "committedDate": "2020-08-15T07:43:05Z", "type": "commit"}, {"oid": "c4ecfbc94b2e1cc18cbb82c0ccf92f0df5463937", "url": "https://github.com/nordic-institute/X-Road/commit/c4ecfbc94b2e1cc18cbb82c0ccf92f0df5463937", "message": "XRDDEV-1249 Update localisations", "committedDate": "2020-08-15T07:48:11Z", "type": "commit"}, {"oid": "5bb6dc35d736614a33fb28270855c225cacec00b", "url": "https://github.com/nordic-institute/X-Road/commit/5bb6dc35d736614a33fb28270855c225cacec00b", "message": "XRDDEV-1249 Add warning dialog when auth key with registered cert is deleted\n\n- Warning dialog is shown when an auth key with a registered certificate is deleted.\n- Auth cert is unregistered and key + cert deleted if the dialog is approved.\n- Update localisations.", "committedDate": "2020-08-15T12:00:52Z", "type": "commit"}, {"oid": "642e4ccf90e7f5a0fa8b9149bb32ee037b647a38", "url": "https://github.com/nordic-institute/X-Road/commit/642e4ccf90e7f5a0fa8b9149bb32ee037b647a38", "message": "XRDDEV-1248 Refactor delete key method", "committedDate": "2020-08-15T14:24:17Z", "type": "commit"}, {"oid": "9f93c21e05a1c119c4689d3206cbfcededf6261d", "url": "https://github.com/nordic-institute/X-Road/commit/9f93c21e05a1c119c4689d3206cbfcededf6261d", "message": "XRDDEV-1248 Update comments", "committedDate": "2020-08-15T15:13:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYzOTUzMw==", "url": "https://github.com/nordic-institute/X-Road/pull/650#discussion_r473639533", "bodyText": "Swallowing exceptions should almost never be done. Even if UnhandledWarningsException should indeed be impossible, wrapping it as RuntimeException is preferrable, in case there's some weird bug that does cause UnhandledWarningsException, or if someone later changes code so that our current assumptions are not valid anymore. Even if unlikely, I've seen those two things happen, and then it may mean a long bughunt since from outside everything looks like the key delete was successful.\nAdding throw new RuntimeException(e); here also does not have any real downside, in case we are correct and this never happens. Comment is a good one to keep IMO, to explain this to updater.", "author": "jansu76", "createdAt": "2020-08-20T06:19:46Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/KeyService.java", "diffHunk": "@@ -202,15 +206,27 @@ private static String signerFaultCode(String detail) {\n \n     static final String KEY_NOT_FOUND_FAULT_CODE = signerFaultCode(X_KEY_NOT_FOUND);\n \n+    public void deleteKey(String keyId) throws KeyNotFoundException, ActionNotPossibleException,\n+            GlobalConfOutdatedException {\n+        try {\n+            deleteKey(keyId, true);\n+        } catch (UnhandledWarningsException e) {\n+            // Since \"ignoreWarnings = true\", the exception is never thrown", "originalCommit": "9f93c21e05a1c119c4689d3206cbfcededf6261d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg0NzUxNA==", "url": "https://github.com/nordic-institute/X-Road/pull/650#discussion_r473847514", "bodyText": "Good points, RuntimeException is now thrown in case UnhandledWarningsException is catched.", "author": "petkivim", "createdAt": "2020-08-20T10:12:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYzOTUzMw=="}], "type": "inlineReview", "revised_code": {"commit": "867b20c8fa741d6c33c51465aa39e414f413b5af", "chunk": "diff --git a/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/KeyService.java b/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/KeyService.java\nindex 157ad4688..9f1c4ac26 100644\n--- a/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/KeyService.java\n+++ b/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/KeyService.java\n\n@@ -206,17 +206,29 @@ public class KeyService {\n \n     static final String KEY_NOT_FOUND_FAULT_CODE = signerFaultCode(X_KEY_NOT_FOUND);\n \n-    public void deleteKey(String keyId) throws KeyNotFoundException, ActionNotPossibleException,\n+    /**\n+     * Deletes one key, and related CSRs and certificates. If the key is an authentication key with a registered\n+     * certificate, warnings are ignored and certificate is first unregistered, and the key and certificate are\n+     * deleted after that.\n+     * @param keyId\n+     * @throws ActionNotPossibleException if delete was not possible for the key\n+     * @throws KeyNotFoundException if key with given id was not found\n+     * @throws org.niis.xroad.restapi.service.GlobalConfOutdatedException if global conf was outdated\n+     */\n+    public void deleteKeyAndIgnoreWarnings(String keyId) throws KeyNotFoundException, ActionNotPossibleException,\n             GlobalConfOutdatedException {\n         try {\n             deleteKey(keyId, true);\n         } catch (UnhandledWarningsException e) {\n-            // Since \"ignoreWarnings = true\", the exception is never thrown\n+            throw new RuntimeException(e);\n         }\n     }\n \n     /**\n-     * Deletes one key\n+     * Deletes one key, and related CSRs and certificates. If the key is an authentication key with a registered\n+     * certificate and ignoreWarnings = false, an UnhandledWarningsException is thrown and the key is not deleted. If\n+     * ignoreWarnings = true, the authentication certificate is first unregistered, and the key and certificate are\n+     * deleted after that.\n      * @param keyId\n      * @param ignoreWarnings\n      * @throws ActionNotPossibleException if delete was not possible for the key\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzY2MDk1MQ==", "url": "https://github.com/nordic-institute/X-Road/pull/650#discussion_r473660951", "bodyText": "Would be good to add javadocs to old public void deleteKey(String keyId) { so that it explains the ignoreWarnings = true deal. (weird, I thought checkstyle requires javadocs for public methods. It is good practice to have those anyhow)\nMaybe also consider changing old method name to something like deleteKeyAndIgnoreWarnings, or removing it altogether and using deleteKey(keyId, true) instead. Does having a shorthand version, without boolean parameter, make things better or worse? Maybe without it code might be more clear and more explicit about what is the intended action. Well, not sure about that one really.", "author": "jansu76", "createdAt": "2020-08-20T06:48:51Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/KeysApiController.java", "diffHunk": "@@ -225,14 +226,14 @@ private Key getKeyFromService(String keyId) {\n     @Override\n     @PreAuthorize(\"hasAnyAuthority('DELETE_KEY', 'DELETE_AUTH_KEY', 'DELETE_SIGN_KEY')\")\n     @AuditEventMethod(event = DELETE_KEY)\n-    public ResponseEntity<Void> deleteKey(String keyId) {\n+    public ResponseEntity<Void> deleteKey(String keyId, Boolean ignoreWarnings) {", "originalCommit": "9f93c21e05a1c119c4689d3206cbfcededf6261d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg1MjY0Nw==", "url": "https://github.com/nordic-institute/X-Road/pull/650#discussion_r473852647", "bodyText": "Changed the old method name to deleteKeyAndIgnoreWarnings and updated javadocs.", "author": "petkivim", "createdAt": "2020-08-20T10:18:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzY2MDk1MQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "867b20c8fa741d6c33c51465aa39e414f413b5af", "url": "https://github.com/nordic-institute/X-Road/commit/867b20c8fa741d6c33c51465aa39e414f413b5af", "message": "XRDDEV-1248 Update based on review comments", "committedDate": "2020-08-20T10:06:07Z", "type": "commit"}, {"oid": "4ec246a59bdfd25dbbf86edfa35a13a67c40c944", "url": "https://github.com/nordic-institute/X-Road/commit/4ec246a59bdfd25dbbf86edfa35a13a67c40c944", "message": "XRDDEV-1248 Update comments", "committedDate": "2020-08-20T10:08:21Z", "type": "commit"}]}