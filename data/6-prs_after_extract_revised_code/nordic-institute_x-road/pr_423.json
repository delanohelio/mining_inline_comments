{"pr_number": 423, "pr_title": "XRDDEV-826 filter id chars", "pr_createdAt": "2020-03-20T05:42:26Z", "pr_url": "https://github.com/nordic-institute/X-Road/pull/423", "timeline": [{"oid": "93e0788c58526d2998a04c839a8d339f81c8420c", "url": "https://github.com/nordic-institute/X-Road/commit/93e0788c58526d2998a04c839a8d339f81c8420c", "message": "XRDDEV-826 add client id validators", "committedDate": "2020-03-17T16:47:25Z", "type": "commit"}, {"oid": "91447205fae08454fa934259ee3c365f617c91a0", "url": "https://github.com/nordic-institute/X-Road/commit/91447205fae08454fa934259ee3c365f617c91a0", "message": "XRDDEV-826 add client validations to controller, and test them. refactor validation implementation", "committedDate": "2020-03-19T07:21:47Z", "type": "commit"}, {"oid": "1e2d8a0716ccfc97bcab3fe05c6a78ccd93ec352", "url": "https://github.com/nordic-institute/X-Road/commit/1e2d8a0716ccfc97bcab3fe05c6a78ccd93ec352", "message": "XRDDEV-826 add more validations and tests", "committedDate": "2020-03-19T16:04:16Z", "type": "commit"}, {"oid": "4046d43f025a19331c5f23a531695995b2c57211", "url": "https://github.com/nordic-institute/X-Road/commit/4046d43f025a19331c5f23a531695995b2c57211", "message": "XRDDEV-826 better name for SpringFirewallLogic", "committedDate": "2020-03-19T16:06:52Z", "type": "commit"}, {"oid": "2ce321bf7b15f36c7d11d8cb938e04941d0db0fb", "url": "https://github.com/nordic-institute/X-Road/commit/2ce321bf7b15f36c7d11d8cb938e04941d0db0fb", "message": "Merge branch 'develop' into XRDDEV-826-filter-id-chars", "committedDate": "2020-03-19T20:22:31Z", "type": "commit"}, {"oid": "0762cd59e1ea47adcb05aeff7a7c4e5984c1959f", "url": "https://github.com/nordic-institute/X-Road/commit/0762cd59e1ea47adcb05aeff7a7c4e5984c1959f", "message": "XRDDEV-826 fix ClientsApiControllerIntegrationTest, fix small openapi errors", "committedDate": "2020-03-19T20:45:32Z", "type": "commit"}, {"oid": "9a25ba9719d9f325ec535ffa1eb8c7cee7eb1c95", "url": "https://github.com/nordic-institute/X-Road/commit/9a25ba9719d9f325ec535ffa1eb8c7cee7eb1c95", "message": "XRDDEV-826 add WSDL servicecode and version validation, tests, refactor ExceptionTranslator and related", "committedDate": "2020-03-19T22:51:07Z", "type": "commit"}, {"oid": "cefa2e95efc008c15649770adbeea78e23436c46", "url": "https://github.com/nordic-institute/X-Road/commit/cefa2e95efc008c15649770adbeea78e23436c46", "message": "XRDDEV-826 add missing test resource wsdls", "committedDate": "2020-03-19T22:55:02Z", "type": "commit"}, {"oid": "f7d17a2d434a3095597b215c8ef662b18d65683a", "url": "https://github.com/nordic-institute/X-Road/commit/f7d17a2d434a3095597b215c8ef662b18d65683a", "message": "XRDDEV-826 add class missing from version control", "committedDate": "2020-03-20T06:44:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU4NjU0OA==", "url": "https://github.com/nordic-institute/X-Road/pull/423#discussion_r404586548", "bodyText": "These methods could as well be static", "author": "carohauta", "createdAt": "2020-04-07T07:16:08Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/exceptions/ValidationErrorHelper.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/**\n+ * The MIT License\n+ * Copyright (c) 2018 Estonian Information System Authority (RIA),\n+ * Nordic Institute for Interoperability Solutions (NIIS), Population Register Centre (VRK)\n+ * Copyright (c) 2015-2017 Estonian Information System Authority (RIA), Population Register Centre (VRK)\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package org.niis.xroad.restapi.exceptions;\n+\n+import org.niis.xroad.restapi.openapi.model.CodeWithMetadata;\n+import org.springframework.validation.Errors;\n+import org.springframework.web.bind.MethodArgumentNotValidException;\n+\n+import java.util.Collections;\n+\n+/**\n+ * Helper class for transforming Spring validation errors into error dtos.\n+ * Used from {@link ExceptionTranslator} and {@link SpringInternalExceptionHandler}\n+ */\n+public class ValidationErrorHelper {\n+    public static final String VALIDATION_FAILURE_ERROR = \"validation_failure\";\n+\n+    /**\n+     * Create DeviationAware error code & metadata from given org.springframework.validation.Errors.\n+     * Error code = {@link ValidationErrorHelper#VALIDATION_FAILURE_ERROR}, metadata is the\n+     * String representation of {@link Errors}\n+     */\n+    public CodeWithMetadata createError(Errors validationErrors) {", "originalCommit": "f7d17a2d434a3095597b215c8ef662b18d65683a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTU5ODc2Mw==", "url": "https://github.com/nordic-institute/X-Road/pull/423#discussion_r405598763", "bodyText": "True. I avoided statics on purpose, since I have this uneasy feeling with static utility classes. I always fear I might end up needing to mock those in tests, or override the util class behavior. Something about static methods always makes my skin crawl. Too many bad experiences.\nI asked https://gofore.slack.com/archives/CCA0KKAVD/p1586356799085900 to help me find the light.\nThat being said, this feels like a good example of utility methods that a) won't change b) won't need to be mocked c) will only ever need one implementation so if we use static utility classes this is a good fit for them. And we do use static utility classes.\nI will either change this to static util class, or if not that then a Spring singleton bean. Now it's kind of in-between.\nI guess I still hold my opinion that static methods / static utility classes have lots of potential for causing troubles and use of them should be minimized.", "author": "jansu76", "createdAt": "2020-04-08T15:10:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU4NjU0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkxOTUyNQ==", "url": "https://github.com/nordic-institute/X-Road/pull/423#discussion_r407919525", "bodyText": "Based on feedback from the discussion thread, I am now convinced that \"beans always\" is a valid default strategy and static utility classes should be limited to rare cases where you can be certain that you will never need to mock the methods or use inheritance. It is subjective, sure.\nSo I changed this one to a spring bean since I felt I might want to mock these in some test. There's a bit of boilerplate bloat as a result, which is the price for this choice.", "author": "jansu76", "createdAt": "2020-04-14T07:23:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU4NjU0OA=="}], "type": "inlineReview", "revised_code": {"commit": "f6e377adba086b17166c298e1536e4e95e7d3a93", "chunk": "diff --git a/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/exceptions/ValidationErrorHelper.java b/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/exceptions/ValidationErrorHelper.java\nindex d19bd55f6..0b0f6e3d4 100644\n--- a/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/exceptions/ValidationErrorHelper.java\n+++ b/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/exceptions/ValidationErrorHelper.java\n\n@@ -25,6 +25,7 @@\n package org.niis.xroad.restapi.exceptions;\n \n import org.niis.xroad.restapi.openapi.model.CodeWithMetadata;\n+import org.springframework.stereotype.Component;\n import org.springframework.validation.Errors;\n import org.springframework.web.bind.MethodArgumentNotValidException;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYzMjEyMw==", "url": "https://github.com/nordic-institute/X-Road/pull/423#discussion_r404632123", "bodyText": "I think this was talked in the demo couple of weeks ago but thetoString() is probably too much here. I think that the end user is only interested in the field name and the reason why the value was rejected. So maybe just add those (field and codes) to the metadata in a way that the frontend can parse and map them to the corresponding field easily. Something like this maybe (?):\n{\n    \"status\": 400,\n    \"error\": {\n        \"code\": \"validation_failure\",\n        \"metadata\": [\n            \"client.memberCode: NoColons, NoForwardslashes\", \n            \"client.subsystemCode: NoColons\"\n        ]\n    }\n}\nOr there could be a totally different response object when validation failure happens\n{\n    \"status\": 400,\n    \"error\": {\n        \"code\": \"validation_failure\",\n        \"validation_errors\": {\n            \"client.memberCode\": [ \n               \"NoColons\", \n               \"NoForwardslashes\"\n            ], \n            \"client.subsystemCode\": [\n              \"NoColons\"\n            ]\n        }\n    }\n}\nIDK probably needs some brainstorming between frontend and backend devs \ud83e\udd14", "author": "carohauta", "createdAt": "2020-04-07T08:32:00Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/exceptions/ValidationErrorHelper.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/**\n+ * The MIT License\n+ * Copyright (c) 2018 Estonian Information System Authority (RIA),\n+ * Nordic Institute for Interoperability Solutions (NIIS), Population Register Centre (VRK)\n+ * Copyright (c) 2015-2017 Estonian Information System Authority (RIA), Population Register Centre (VRK)\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package org.niis.xroad.restapi.exceptions;\n+\n+import org.niis.xroad.restapi.openapi.model.CodeWithMetadata;\n+import org.springframework.validation.Errors;\n+import org.springframework.web.bind.MethodArgumentNotValidException;\n+\n+import java.util.Collections;\n+\n+/**\n+ * Helper class for transforming Spring validation errors into error dtos.\n+ * Used from {@link ExceptionTranslator} and {@link SpringInternalExceptionHandler}\n+ */\n+public class ValidationErrorHelper {\n+    public static final String VALIDATION_FAILURE_ERROR = \"validation_failure\";\n+\n+    /**\n+     * Create DeviationAware error code & metadata from given org.springframework.validation.Errors.\n+     * Error code = {@link ValidationErrorHelper#VALIDATION_FAILURE_ERROR}, metadata is the\n+     * String representation of {@link Errors}\n+     */\n+    public CodeWithMetadata createError(Errors validationErrors) {\n+        CodeWithMetadata result = new CodeWithMetadata();\n+        result.setCode(VALIDATION_FAILURE_ERROR);\n+        result.setMetadata(Collections.singletonList(validationErrors.toString()));", "originalCommit": "f7d17a2d434a3095597b215c8ef662b18d65683a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTYwMTA0Nw==", "url": "https://github.com/nordic-institute/X-Road/pull/423#discussion_r405601047", "bodyText": "Yes, good suggestions! In this ticket the validation error format is unpolished and proper format will be done in https://jira.niis.org/browse/XRDDEV-1001", "author": "jansu76", "createdAt": "2020-04-08T15:13:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYzMjEyMw=="}], "type": "inlineReview", "revised_code": {"commit": "f6e377adba086b17166c298e1536e4e95e7d3a93", "chunk": "diff --git a/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/exceptions/ValidationErrorHelper.java b/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/exceptions/ValidationErrorHelper.java\nindex d19bd55f6..0b0f6e3d4 100644\n--- a/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/exceptions/ValidationErrorHelper.java\n+++ b/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/exceptions/ValidationErrorHelper.java\n\n@@ -25,6 +25,7 @@\n package org.niis.xroad.restapi.exceptions;\n \n import org.niis.xroad.restapi.openapi.model.CodeWithMetadata;\n+import org.springframework.stereotype.Component;\n import org.springframework.validation.Errors;\n import org.springframework.web.bind.MethodArgumentNotValidException;\n \n"}}, {"oid": "f6e377adba086b17166c298e1536e4e95e7d3a93", "url": "https://github.com/nordic-institute/X-Road/commit/f6e377adba086b17166c298e1536e4e95e7d3a93", "message": "XRDDEV-826 make ValidationErrorHelper a bean", "committedDate": "2020-04-14T07:19:34Z", "type": "commit"}, {"oid": "cc783518fc9a1ee44885adb0c3183d40b2b556a5", "url": "https://github.com/nordic-institute/X-Road/commit/cc783518fc9a1ee44885adb0c3183d40b2b556a5", "message": "Merge branch 'develop' into XRDDEV-826-filter-id-chars\n\nFix Conflicts:\n\tsrc/proxy-ui-api/src/test/java/org/niis/xroad/restapi/service/OrphanRemovalServiceTest.java", "committedDate": "2020-04-14T07:27:19Z", "type": "commit"}, {"oid": "83ff480512b71ac267e3f6562970f791e51caabf", "url": "https://github.com/nordic-institute/X-Road/commit/83ff480512b71ac267e3f6562970f791e51caabf", "message": "XRDDEV-826 remove leftover empty constructor to fix sonar", "committedDate": "2020-04-16T06:20:39Z", "type": "commit"}]}