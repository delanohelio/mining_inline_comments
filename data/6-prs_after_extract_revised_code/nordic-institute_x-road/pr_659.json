{"pr_number": 659, "pr_title": "XRDDEV-1269 Login fail signer bug", "pr_createdAt": "2020-08-20T08:16:56Z", "pr_url": "https://github.com/nordic-institute/X-Road/pull/659", "timeline": [{"oid": "7b0bbada6cd9eb885b76fed530aa56f094c8dae6", "url": "https://github.com/nordic-institute/X-Road/commit/7b0bbada6cd9eb885b76fed530aa56f094c8dae6", "message": "XRDDEV-1269 Fix login failure if signer is unreachable", "committedDate": "2020-08-20T07:56:46Z", "type": "commit"}, {"oid": "ad19d4c6d8d57374e8898863d9528246c8a54041", "url": "https://github.com/nordic-institute/X-Road/commit/ad19d4c6d8d57374e8898863d9528246c8a54041", "message": "Merge branch 'beta-6.24.0' into XRDDEV-1269-login-fail-signer-bug\n\n# Conflicts:\n#\tsrc/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/NotificationService.java\n#\tsrc/proxy-ui-api/src/test/java/org/niis/xroad/restapi/service/NotificationServiceTest.java", "committedDate": "2020-08-20T08:04:33Z", "type": "commit"}, {"oid": "dc0059608a486706d30ed069b6d4958d12185e57", "url": "https://github.com/nordic-institute/X-Road/commit/dc0059608a486706d30ed069b6d4958d12185e57", "message": "XRDDEV-1269 Init soft token unresolved test", "committedDate": "2020-08-20T08:08:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzc5MTQ5MQ==", "url": "https://github.com/nordic-institute/X-Road/pull/659#discussion_r473791491", "bodyText": "This would cause NPE in InitializationService if null, is that intentional?\n    boolean isSoftwareTokenInitialized = tokenService.isSoftwareTokenInitialized();\n\nRather than return Boolean.TRUE, Boolean.FALSE or null, maybe consider returning an enum with 3 values. Or just catch exceptions in upper layer and handle them there. I think it might be more explicit and make it less likely that someone misuses the return value.\nThis seems to come down to the question you asked\n\nshould the getAllTokens method actually throw a checked exception instead of a runtime exception if signer is unresponsive\n\nIf we want to handle the exception properly on upper layers, then the checked exception would help this a lot. I guess the reasoning behind throw new RuntimeException(\"could not list all tokens\") was assumption that no one really wants to do anything else than http 500 when that happens. And now we do.\nSo there's also the possibility of changing signer communication problems into checked exceptions. But not sure if that's in scope of this ticket. Or, just keep those as RuntimeExceptions and fix the NPE by maybe changing the return value to enum?", "author": "jansu76", "createdAt": "2020-08-20T09:04:48Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/TokenService.java", "diffHunk": "@@ -328,12 +328,19 @@ public TokenInfoAndKeyId getTokenAndKeyIdForCertificateHash(String hash) throws\n     }\n \n     /**\n-     * Whether or not a software token exists AND it's status != TokenStatusInfo.NOT_INITIALIZED\n-     * @return\n+     * Whether or not a software token exists AND it's status != TokenStatusInfo.NOT_INITIALIZED.\n+     * If an exception is thrown when querying signer for the tokens, a null status will be returned\n+     * @return true/false/null\n      */\n-    public boolean isSoftwareTokenInitialized() {\n+    public Boolean isSoftwareTokenInitialized() {\n         boolean isSoftwareTokenInitialized = false;\n-        List<TokenInfo> tokens = getAllTokens();\n+        List<TokenInfo> tokens = null;\n+        try {\n+            tokens = getAllTokens();\n+        } catch (Exception e) {\n+            log.error(\"Could not get software token status from signer\", e);\n+            return null;", "originalCommit": "7b0bbada6cd9eb885b76fed530aa56f094c8dae6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDA1MTIyNA==", "url": "https://github.com/nordic-institute/X-Road/pull/659#discussion_r474051224", "bodyText": "Created a new method that returns the state of a token as an enum value in the TokenService. The login now works fine and the init status api returns the SoftwareTokenInitStatus as UNKNOWN.\nThere is still one problem when getting clients from the api while signer is down: the user only gets a { status: 500 } response. This happens because the clients api uses request scoped beans and if creating those beans fails the SignerNotReachableException gets nested in Spring's internal exceptions such as BeanCreationException and BeanInstantiationException. I'll try to include a fix for that in this PR", "author": "carohauta", "createdAt": "2020-08-20T15:01:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzc5MTQ5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYxODg2Ng==", "url": "https://github.com/nordic-institute/X-Road/pull/659#discussion_r474618866", "bodyText": "Added custom exception handling for BeanCreationException here.\nReady for review again.", "author": "carohauta", "createdAt": "2020-08-21T10:40:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzc5MTQ5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "4f9364df05389b8c9ad202df4f229a379c3f03c0", "chunk": "diff --git a/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/TokenService.java b/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/TokenService.java\nindex abeef37f6..95d1d8e84 100644\n--- a/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/TokenService.java\n+++ b/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/TokenService.java\n\n@@ -323,24 +332,18 @@ public class TokenService {\n                 throw e;\n             }\n         } catch (Exception other) {\n-            throw new RuntimeException(\"getTokenAndKeyIdForCertHash failed\", other);\n+            throw new SignerNotReachableException(\"getTokenAndKeyIdForCertHash failed\", other);\n         }\n     }\n \n     /**\n-     * Whether or not a software token exists AND it's status != TokenStatusInfo.NOT_INITIALIZED.\n-     * If an exception is thrown when querying signer for the tokens, a null status will be returned\n-     * @return true/false/null\n+     * Whether or not a software token exists AND it's status != TokenStatusInfo.NOT_INITIALIZED\n+     *\n+     * @return true/false\n      */\n-    public Boolean isSoftwareTokenInitialized() {\n+    public boolean isSoftwareTokenInitialized() {\n         boolean isSoftwareTokenInitialized = false;\n-        List<TokenInfo> tokens = null;\n-        try {\n-            tokens = getAllTokens();\n-        } catch (Exception e) {\n-            log.error(\"Could not get software token status from signer\", e);\n-            return null;\n-        }\n+        List<TokenInfo> tokens = getAllTokens();\n         Optional<TokenInfo> firstSoftwareToken = tokens.stream()\n                 .filter(tokenInfo -> tokenInfo.getId().equals(SOFTWARE_TOKEN_ID))\n                 .findFirst();\n"}}, {"oid": "4f9364df05389b8c9ad202df4f229a379c3f03c0", "url": "https://github.com/nordic-institute/X-Road/commit/4f9364df05389b8c9ad202df4f229a379c3f03c0", "message": "XRDDEV-1269 TokenInitStatus enum instead of boolean", "committedDate": "2020-08-20T14:53:44Z", "type": "commit"}, {"oid": "b5d4dcbdfbc8bf57d4bce794d648ea8fe065c81a", "url": "https://github.com/nordic-institute/X-Road/commit/b5d4dcbdfbc8bf57d4bce794d648ea8fe065c81a", "message": "XRDDEV-1269 Signer not reachable exception propagation\n\n* send a correct error response when a BeanCreationException is actually caused by unresponsive signer", "committedDate": "2020-08-21T06:50:42Z", "type": "commit"}, {"oid": "258fb8c922321d78bfcfeb3c0558c05d9a405efb", "url": "https://github.com/nordic-institute/X-Road/commit/258fb8c922321d78bfcfeb3c0558c05d9a405efb", "message": "Merge branch 'beta-6.24.0' into XRDDEV-1269-login-fail-signer-bug\n\n# Conflicts:\n#\tsrc/proxy-ui-api/frontend/package-lock.json", "committedDate": "2020-08-21T06:55:01Z", "type": "commit"}, {"oid": "a34ce4ee71d1c0e535ad10c698e684ee05176781", "url": "https://github.com/nordic-institute/X-Road/commit/a34ce4ee71d1c0e535ad10c698e684ee05176781", "message": "XRDDEV-1269 Fix failing init tests", "committedDate": "2020-08-21T10:22:28Z", "type": "commit"}, {"oid": "38177d5c1ac45fea62373c6d5311f2552821876b", "url": "https://github.com/nordic-institute/X-Road/commit/38177d5c1ac45fea62373c6d5311f2552821876b", "message": "Merge branch 'beta-6.24.0' into XRDDEV-1269-login-fail-signer-bug", "committedDate": "2020-08-21T10:34:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM1NjkyMg==", "url": "https://github.com/nordic-institute/X-Road/pull/659#discussion_r475356922", "bodyText": "I think it would be good to explain why we do this. What is the special bond between BeanCreationExceptions and SignerNotReachableExceptions? Otherwise some future developer will be confused.", "author": "jansu76", "createdAt": "2020-08-24T05:52:05Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/exceptions/ApplicationExceptionHandler.java", "diffHunk": "@@ -93,4 +99,24 @@\n         log.error(\"exception caught\", e);\n         return exceptionTranslator.toResponseEntity(e, HttpStatus.FORBIDDEN);\n     }\n+\n+    /**\n+     * check for nested SignerNotReachable exception when BeanCreationException is caught", "originalCommit": "38177d5c1ac45fea62373c6d5311f2552821876b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM2ODc3Mw==", "url": "https://github.com/nordic-institute/X-Road/pull/659#discussion_r475368773", "bodyText": "Added better documentation here", "author": "carohauta", "createdAt": "2020-08-24T06:29:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM1NjkyMg=="}], "type": "inlineReview", "revised_code": {"commit": "ba9a0fc0f2c228205a27b93a93f65a6c4bd9d9d0", "chunk": "diff --git a/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/exceptions/ApplicationExceptionHandler.java b/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/exceptions/ApplicationExceptionHandler.java\nindex ab8a62182..6772da082 100644\n--- a/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/exceptions/ApplicationExceptionHandler.java\n+++ b/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/exceptions/ApplicationExceptionHandler.java\n\n@@ -101,7 +102,10 @@ public class ApplicationExceptionHandler {\n     }\n \n     /**\n-     * check for nested SignerNotReachable exception when BeanCreationException is caught\n+     * Check for nested SignerNotReachable exception when BeanCreationException is caught. This is needed because\n+     * we are using request scoped beans (see {@link CurrentSecurityServerConfig}) which can throw\n+     * BeanCreationException in runtime and wrap any causing exception inside therefore hiding the real exception.\n+     * This handler will force the error code of the SignerNotReachable to be propagated to the REST API response.\n      *\n      * @param beanCreationException\n      * @return\n"}}, {"oid": "ba9a0fc0f2c228205a27b93a93f65a6c4bd9d9d0", "url": "https://github.com/nordic-institute/X-Road/commit/ba9a0fc0f2c228205a27b93a93f65a6c4bd9d9d0", "message": "XRDDEV-1269 Better Javadocs", "committedDate": "2020-08-24T06:25:04Z", "type": "commit"}]}