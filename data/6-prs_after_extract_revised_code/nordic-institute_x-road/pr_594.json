{"pr_number": 594, "pr_title": "XRDDEV-1190", "pr_createdAt": "2020-07-14T07:55:35Z", "pr_url": "https://github.com/nordic-institute/X-Road/pull/594", "timeline": [{"oid": "aed91935a9294e1957bf3455863e37efd2ec1c11", "url": "https://github.com/nordic-institute/X-Road/commit/aed91935a9294e1957bf3455863e37efd2ec1c11", "message": "XRDDEV-1190 Fix error code 500 when REST endpoint is updated\n\n- Return error code 409 with metadata when updating endpoint fails because of another endpoint with the same signature already exists.\n- Catch DataIntegrityViolationException on controller layer because the exception is thrown when the transaction commits and therefore, it must be catched outside of the transaction's scope.", "committedDate": "2020-07-14T07:43:27Z", "type": "commit"}, {"oid": "de04bd54e5eda9e12c8380bf78d085eae257f8dc", "url": "https://github.com/nordic-institute/X-Road/commit/de04bd54e5eda9e12c8380bf78d085eae257f8dc", "message": "XRDDEV-1190 Remove a duplicate, unsused file", "committedDate": "2020-07-14T07:50:57Z", "type": "commit"}, {"oid": "327b78b1c181e275488d7af6291339d487df9d41", "url": "https://github.com/nordic-institute/X-Road/commit/327b78b1c181e275488d7af6291339d487df9d41", "message": "XRDDEV-1190 Return status code 400 instead of 409", "committedDate": "2020-07-14T09:03:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDgzNDIwNw==", "url": "https://github.com/nordic-institute/X-Road/pull/594#discussion_r454834207", "bodyText": "Should this maybe be a ConflictException instead of bad request?\nIn any case I think controller should not catch DataIntegrityViolationException here\n\nDataIntegrityViolationException is a low level data access layer concept and ideally controller layer should not be aware of such things https://confluence.niis.org/display/XRDDEV/API+backend+implementation#APIbackendimplementation-Layering\nDataIntegrityViolationException is generic in principle, so we do not know for sure that it was caused by this specific problem \"Endpoint with equivalent service code, ...\". OK, now it is probably 99% sure, but this is a relevant issue when you factor in future changes and nontrivial DB constraints\nit deviates from the conventions used in other controllers - they mostly catch service layer exceptions and map those to controller layer / openapi exceptions. ServicesApiController.addEndpoint handles this by\n\n        } catch (EndpointAlreadyExistsException e) {\n            throw new ConflictException(e);\n\nBut, handling this on service layer is probably not as easy as catch DataIntegrityViolationException -> throw EndpointAlreadyExistsException. I believe constraints only kick in when transaction commits, and this only happens when service call ends, so we can't catch DataIntegrityViolationException in the service method? I believe the constraint needs to be validated in a similar way as in addEndpoint \n  \n    \n      X-Road/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ServiceService.java\n    \n    \n        Lines 227 to 230\n      in\n      df9eef1\n    \n    \n    \n    \n\n        \n          \n           if (client.getEndpoint().stream().anyMatch(existingEp -> existingEp.isEquivalent(endpointType))) { \n        \n\n        \n          \n               throw new EndpointAlreadyExistsException(\"Endpoint with equivalent service code, method and path already \" \n        \n\n        \n          \n                       + \"exists for this client\"); \n        \n\n        \n          \n           } \n        \n    \n  \n\n\nIt has to take into account endpoint ID probably, to distinguish between updated endpoint from the rest of them.\nThis adds some extra work to implement the constraints, which is unfortunate. If the service layer checks were too difficult to implement then some compromises or some generic handlers could be made. But I think in this case it should not be too costly to implement the check and be more consistent with the rest of the app.", "author": "jansu76", "createdAt": "2020-07-15T07:00:01Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/EndpointsApiController.java", "diffHunk": "@@ -137,6 +139,10 @@ public EndpointsApiController(\n             throw new ResourceNotFoundException(NOT_FOUND_ERROR_MSG + \" \" + id);\n         } catch (EndpointService.IllegalGeneratedEndpointUpdateException e) {\n             throw new BadRequestException(\"Updating is not allowed for generated endpoint \" + id);\n+        } catch (DataIntegrityViolationException e) {", "originalCommit": "327b78b1c181e275488d7af6291339d487df9d41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk1MDkzMQ==", "url": "https://github.com/nordic-institute/X-Road/pull/594#discussion_r454950931", "bodyText": "Refactored the PR based on the comments. ConflictException is now thrown instead of BadRequest.", "author": "petkivim", "createdAt": "2020-07-15T10:27:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDgzNDIwNw=="}], "type": "inlineReview", "revised_code": {"commit": "cb95e94beb26db2d48641de628ca9f889442c0cc", "chunk": "diff --git a/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/EndpointsApiController.java b/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/EndpointsApiController.java\nindex 1fda63d5b..901dff491 100644\n--- a/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/EndpointsApiController.java\n+++ b/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/EndpointsApiController.java\n\n@@ -139,10 +138,10 @@ public class EndpointsApiController implements EndpointsApi {\n             throw new ResourceNotFoundException(NOT_FOUND_ERROR_MSG + \" \" + id);\n         } catch (EndpointService.IllegalGeneratedEndpointUpdateException e) {\n             throw new BadRequestException(\"Updating is not allowed for generated endpoint \" + id);\n-        } catch (DataIntegrityViolationException e) {\n-            throw new BadRequestException(\n-                    new EndpointAlreadyExistsException(\"Endpoint with equivalent service code, method and path already \"\n-                    + \"exists for this client\"));\n+        } catch (EndpointAlreadyExistsException e) {\n+            throw new ConflictException(e);\n+        } catch (ClientNotFoundException e) {\n+            throw new ConflictException(\"Client not found for the given endpoint with id: \" + id);\n         }\n \n         return new ResponseEntity<>(ep, HttpStatus.OK);\n"}}, {"oid": "cb95e94beb26db2d48641de628ca9f889442c0cc", "url": "https://github.com/nordic-institute/X-Road/commit/cb95e94beb26db2d48641de628ca9f889442c0cc", "message": "XRDDEV-1190 Refactor based on review comments", "committedDate": "2020-07-15T10:23:22Z", "type": "commit"}]}