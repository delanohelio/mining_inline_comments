{"pr_number": 399, "pr_title": "XRDDEV-861 Register client", "pr_createdAt": "2020-03-02T14:20:16Z", "pr_url": "https://github.com/nordic-institute/X-Road/pull/399", "timeline": [{"oid": "5af9b47978b6e96f4a49760b7f49d7ab9f69bb8a", "url": "https://github.com/nordic-institute/X-Road/commit/5af9b47978b6e96f4a49760b7f49d7ab9f69bb8a", "message": "XRDDEV-861 Register client\n\n* controller and service layer done\n* exception refactoring - sorry about the noise!\n* WIP: tests", "committedDate": "2020-03-02T12:27:35Z", "type": "commit"}, {"oid": "014268241df54b1b5c8177bf7a775842da3a671d", "url": "https://github.com/nordic-institute/X-Road/commit/014268241df54b1b5c8177bf7a775842da3a671d", "message": "XRDDEV-861 Register client // tests", "committedDate": "2020-03-02T13:49:04Z", "type": "commit"}, {"oid": "73d193e39fa81e1892b7507333987709eb24a1d4", "url": "https://github.com/nordic-institute/X-Road/commit/73d193e39fa81e1892b7507333987709eb24a1d4", "message": "XRDDEV-861 Register client // javadov update", "committedDate": "2020-03-02T14:26:40Z", "type": "commit"}, {"oid": "395fe1492a818aa1f1e7489544bf311553c3999c", "url": "https://github.com/nordic-institute/X-Road/commit/395fe1492a818aa1f1e7489544bf311553c3999c", "message": "Merge branch 'develop' into XRDDEV-861-register-client\n\n# Conflicts:\n#\tsrc/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/ClientsApiController.java\n#\tsrc/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ClientService.java\n#\tsrc/proxy-ui-api/src/test/java/org/niis/xroad/restapi/service/ClientServiceIntegrationTest.java", "committedDate": "2020-03-04T13:52:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEyOTc2MA==", "url": "https://github.com/nordic-institute/X-Road/pull/399#discussion_r390129760", "bodyText": "javadoc is not in sync with current interface", "author": "jansu76", "createdAt": "2020-03-10T07:21:34Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ManagementRequestSenderService.java", "diffHunk": "@@ -99,27 +101,32 @@ public Integer sendAuthCertDeletionRequest(byte[] authCert) throws\n         }\n     }\n \n+    /**\n+     * Sends a client register request as a normal X-Road message\n+     * @param securityServer the security server id", "originalCommit": "395fe1492a818aa1f1e7489544bf311553c3999c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM3Mjk4Mw==", "url": "https://github.com/nordic-institute/X-Road/pull/399#discussion_r390372983", "bodyText": "Fixed", "author": "carohauta", "createdAt": "2020-03-10T14:52:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEyOTc2MA=="}], "type": "inlineReview", "revised_code": {"commit": "412132cd91ee5028c178a0fd5b94c0bde24c502e", "chunk": "diff --git a/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ManagementRequestSenderService.java b/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ManagementRequestSenderService.java\nindex 7015908b2..f51ffee95 100644\n--- a/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ManagementRequestSenderService.java\n+++ b/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ManagementRequestSenderService.java\n\n@@ -95,7 +95,7 @@ public class ManagementRequestSenderService {\n             GlobalConfOutdatedException, ManagementRequestSendingFailedException {\n         ManagementRequestSender sender = createManagementRequestSender();\n         try {\n-            return sender.sendAuthCertDeletionRequest(serverConfService.getSecurityServerId(), authCert);\n+            return sender.sendAuthCertDeletionRequest(securityServerOwner.getServerId(), authCert);\n         } catch (Exception e) {\n             throw new ManagementRequestSendingFailedException(e);\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEzMTY5NQ==", "url": "https://github.com/nordic-institute/X-Road/pull/399#discussion_r390131695", "bodyText": "This should probably verify that client can be registered, and ultimately result in http 409 if not?\nIt looks like client can be registered only if status = SAVED. Old implementation either\n\nregisters right after client has been added, and hence has status SAVED \n  \n    \n      X-Road/src/proxy-ui/public/javascripts/clients.js\n    \n    \n        Lines 146 to 187\n      in\n      1957846\n    \n    \n    \n    \n\n        \n          \n           $.post(action(\"client_add\"), params, function(response) { \n        \n\n        \n          \n               oClients.fnReplaceData(response.data.clients); \n        \n\n        \n          \n            \n        \n\n        \n          \n               $(dialog).dialog(\"close\"); \n        \n\n        \n          \n            \n        \n\n        \n          \n               var regParams = { \n        \n\n        \n          \n                   member_class: params.add_member_class, \n        \n\n        \n          \n                   member_code: params.add_member_code, \n        \n\n        \n          \n                   subsystem_code: params.add_subsystem_code \n        \n\n        \n          \n               }; \n        \n\n        \n          \n            \n        \n\n        \n          \n               if (response.data.registered) { \n        \n\n        \n          \n                   return; \n        \n\n        \n          \n               } \n        \n\n        \n          \n            \n        \n\n        \n          \n               var new_subsystem_warning = \"\"; \n        \n\n        \n          \n               if (!response.data.subsystem_registered) { \n        \n\n        \n          \n                   if(regParams.subsystem_code) { \n        \n\n        \n          \n                       new_subsystem_warning = _(\"clients.client_add_dialog.new_subsystem\", { \n        \n\n        \n          \n                           member_name: response.data.member_name || \"\", \n        \n\n        \n          \n                           member_class: regParams.member_class, \n        \n\n        \n          \n                           member_code: regParams.member_code, \n        \n\n        \n          \n                           subsystem_code: regParams.subsystem_code \n        \n\n        \n          \n                       }); \n        \n\n        \n          \n                   } else { \n        \n\n        \n          \n                       new_subsystem_warning = _(\"clients.client_add_dialog.new_member\", { \n        \n\n        \n          \n                           member_name: response.data.member_name || \"\", \n        \n\n        \n          \n                           member_class: regParams.member_class, \n        \n\n        \n          \n                           member_code: regParams.member_code \n        \n\n        \n          \n                       }); \n        \n\n        \n          \n                   } \n        \n\n        \n          \n               } \n        \n\n        \n          \n            \n        \n\n        \n          \n               var confirmParams = { \n        \n\n        \n          \n                   new_subsystem_warning: new_subsystem_warning \n        \n\n        \n          \n               }; \n        \n\n        \n          \n            \n        \n\n        \n          \n               confirm(\"clients.client_add_dialog.send_regreq\", confirmParams, function() { \n        \n\n        \n          \n                   $.post(action(\"client_regreq\"), regParams, function() { \n        \n\n        \n          \n                       refreshClients(); \n        \n\n        \n          \n                   }, \"json\"); \n        \n\n        \n          \n               }); \n        \n    \n  \n\n or\nshows \"register\" button only if status is SAVED \n  \n    \n      X-Road/src/proxy-ui/app/controllers/clients_controller.rb\n    \n    \n        Lines 476 to 477\n      in\n      1957846\n    \n    \n    \n    \n\n        \n          \n           :register_enabled => \n        \n\n        \n          \n             [ClientType::STATUS_SAVED].include?(client.clientStatus), \n        \n    \n  \n\n\n\nThere is no check in Ruby controllers, but adding this check to service layer would be consistent with how e.g. token register is now implemented.", "author": "jansu76", "createdAt": "2020-03-10T07:28:10Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ClientService.java", "diffHunk": "@@ -418,6 +416,23 @@ public ClientType deleteTlsCertificate(ClientId id, String certificateHash)\n         return mergeClientListsDistinctively(globalClients, localClients);\n     }\n \n+    /**\n+     * Registers a client\n+     * @param clientId client to register\n+     * @throws GlobalConfOutdatedException\n+     * @throws ClientNotFoundException\n+     */\n+    public void registerClient(ClientId clientId) throws GlobalConfOutdatedException, ClientNotFoundException {\n+        ClientType client = getLocalClientOrThrowNotFound(clientId); // throws if client doesn't exist\n+        try {\n+            managementRequestSenderService.sendClientRegisterRequest(clientId);\n+            client.setClientStatus(ClientType.STATUS_REGINPROG);", "originalCommit": "395fe1492a818aa1f1e7489544bf311553c3999c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM3MzEwNw==", "url": "https://github.com/nordic-institute/X-Road/pull/399#discussion_r390373107", "bodyText": "Added a check for this", "author": "carohauta", "createdAt": "2020-03-10T14:52:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEzMTY5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "412132cd91ee5028c178a0fd5b94c0bde24c502e", "chunk": "diff --git a/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ClientService.java b/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ClientService.java\nindex 8ad799162..b31c272f6 100644\n--- a/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ClientService.java\n+++ b/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ClientService.java\n\n@@ -421,9 +425,18 @@ public class ClientService {\n      * @param clientId client to register\n      * @throws GlobalConfOutdatedException\n      * @throws ClientNotFoundException\n+     * @throws CannotRegisterOwnerException\n      */\n-    public void registerClient(ClientId clientId) throws GlobalConfOutdatedException, ClientNotFoundException {\n-        ClientType client = getLocalClientOrThrowNotFound(clientId); // throws if client doesn't exist\n+    public void registerClient(ClientId clientId) throws GlobalConfOutdatedException, ClientNotFoundException,\n+            CannotRegisterOwnerException, ActionNotPossibleException {\n+        ClientType client = getLocalClientOrThrowNotFound(clientId);\n+        ClientId ownerId = currentSecurityServerId.getServerId().getOwner();\n+        if (ownerId.equals(client.getIdentifier())) {\n+            throw new CannotRegisterOwnerException();\n+        }\n+        if (!client.getClientStatus().equals(ClientType.STATUS_SAVED)) {\n+            throw new ActionNotPossibleException(\"Only clients with status 'saved' can be registered\");\n+        }\n         try {\n             managementRequestSenderService.sendClientRegisterRequest(clientId);\n             client.setClientStatus(ClientType.STATUS_REGINPROG);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEzMjQwOA==", "url": "https://github.com/nordic-institute/X-Road/pull/399#discussion_r390132408", "bodyText": "Old implementation also has \"cannot register owner\" check that we are missing at the moment: \n  \n    \n      X-Road/src/proxy-ui/app/controllers/clients_controller.rb\n    \n    \n        Lines 234 to 236\n      in\n      1957846\n    \n    \n    \n    \n\n        \n          \n           if client_id == owner_identifier \n        \n\n        \n          \n             raise t('clients.cannot_register_owner') \n        \n\n        \n          \n           end \n        \n    \n  \n\n\nShould we have that? Or was it intentionally left out (for init, maybe?).\nI do not yet have clear vision of how init will eventually work, maybe one option would be to include \"cannot register owner\" check now, and revise that later if needed, when we implement init?", "author": "jansu76", "createdAt": "2020-03-10T07:30:34Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ClientService.java", "diffHunk": "@@ -418,6 +416,23 @@ public ClientType deleteTlsCertificate(ClientId id, String certificateHash)\n         return mergeClientListsDistinctively(globalClients, localClients);\n     }\n \n+    /**\n+     * Registers a client\n+     * @param clientId client to register\n+     * @throws GlobalConfOutdatedException\n+     * @throws ClientNotFoundException\n+     */\n+    public void registerClient(ClientId clientId) throws GlobalConfOutdatedException, ClientNotFoundException {\n+        ClientType client = getLocalClientOrThrowNotFound(clientId); // throws if client doesn't exist\n+        try {\n+            managementRequestSenderService.sendClientRegisterRequest(clientId);\n+            client.setClientStatus(ClientType.STATUS_REGINPROG);\n+            clientRepository.saveOrUpdate(client);", "originalCommit": "395fe1492a818aa1f1e7489544bf311553c3999c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM3Mzg3Mw==", "url": "https://github.com/nordic-institute/X-Road/pull/399#discussion_r390373873", "bodyText": "I added a check for this. It should be changed when implementing the init functionality \u2013 if needed.", "author": "carohauta", "createdAt": "2020-03-10T14:53:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEzMjQwOA=="}], "type": "inlineReview", "revised_code": {"commit": "412132cd91ee5028c178a0fd5b94c0bde24c502e", "chunk": "diff --git a/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ClientService.java b/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ClientService.java\nindex 8ad799162..b31c272f6 100644\n--- a/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ClientService.java\n+++ b/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ClientService.java\n\n@@ -421,9 +425,18 @@ public class ClientService {\n      * @param clientId client to register\n      * @throws GlobalConfOutdatedException\n      * @throws ClientNotFoundException\n+     * @throws CannotRegisterOwnerException\n      */\n-    public void registerClient(ClientId clientId) throws GlobalConfOutdatedException, ClientNotFoundException {\n-        ClientType client = getLocalClientOrThrowNotFound(clientId); // throws if client doesn't exist\n+    public void registerClient(ClientId clientId) throws GlobalConfOutdatedException, ClientNotFoundException,\n+            CannotRegisterOwnerException, ActionNotPossibleException {\n+        ClientType client = getLocalClientOrThrowNotFound(clientId);\n+        ClientId ownerId = currentSecurityServerId.getServerId().getOwner();\n+        if (ownerId.equals(client.getIdentifier())) {\n+            throw new CannotRegisterOwnerException();\n+        }\n+        if (!client.getClientStatus().equals(ClientType.STATUS_SAVED)) {\n+            throw new ActionNotPossibleException(\"Only clients with status 'saved' can be registered\");\n+        }\n         try {\n             managementRequestSenderService.sendClientRegisterRequest(clientId);\n             client.setClientStatus(ClientType.STATUS_REGINPROG);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDE0MTA3Mg==", "url": "https://github.com/nordic-institute/X-Road/pull/399#discussion_r390141072", "bodyText": "According to Sonar this method is not tested. Most of ClientsApiController other methods are tested.\nBut this controller method does not contain anything nontrivial, it is probably correct to not test it. So just a FYI comment.", "author": "jansu76", "createdAt": "2020-03-10T07:55:01Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/ClientsApiController.java", "diffHunk": "@@ -435,4 +432,18 @@ private ClientType getClientType(String encodedId) {\n         Client result = clientConverter.convert(added);\n         return createCreatedResponse(\"/api/clients/{id}\", result, result.getId());\n     }\n+\n+    @Override\n+    @PreAuthorize(\"hasAuthority('SEND_CLIENT_REG_REQ')\")", "originalCommit": "395fe1492a818aa1f1e7489544bf311553c3999c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM3NDE2Mg==", "url": "https://github.com/nordic-institute/X-Road/pull/399#discussion_r390374162", "bodyText": "Added controller tests", "author": "carohauta", "createdAt": "2020-03-10T14:53:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDE0MTA3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "412132cd91ee5028c178a0fd5b94c0bde24c502e", "chunk": "diff --git a/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/ClientsApiController.java b/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/ClientsApiController.java\nindex 44915575a..8c8041c9c 100644\n--- a/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/ClientsApiController.java\n+++ b/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/ClientsApiController.java\n\n@@ -439,10 +440,12 @@ public class ClientsApiController implements ClientsApi {\n         ClientId clientId = clientConverter.convertId(encodedClientId);\n         try {\n             clientService.registerClient(clientId);\n-        } catch (GlobalConfOutdatedException e) {\n+        } catch (GlobalConfOutdatedException | ClientService.CannotRegisterOwnerException e) {\n             throw new BadRequestException(e);\n         } catch (ClientNotFoundException e) {\n             throw new ResourceNotFoundException(e);\n+        } catch (ActionNotPossibleException e) {\n+            throw new ConflictException(e);\n         }\n         return new ResponseEntity<>(HttpStatus.NO_CONTENT);\n     }\n"}}, {"oid": "412132cd91ee5028c178a0fd5b94c0bde24c502e", "url": "https://github.com/nordic-institute/X-Road/commit/412132cd91ee5028c178a0fd5b94c0bde24c502e", "message": "XRDDEV-861 Register client // PR comment fixes 1\n\n* refactor SecurityServerOwner -> CurrentSecurityServerId\n* add verifications to whether or not client can be registered\n* test coverage for controller", "committedDate": "2020-03-10T14:40:48Z", "type": "commit"}, {"oid": "b358e0f30d09a6d2e85b9dfbce484126bc3167af", "url": "https://github.com/nordic-institute/X-Road/commit/b358e0f30d09a6d2e85b9dfbce484126bc3167af", "message": "Merge branch 'develop' into XRDDEV-861-register-client", "committedDate": "2020-03-11T10:07:10Z", "type": "commit"}, {"oid": "550f0fcfbccf2163c5fe092c8a5628865b03d1e4", "url": "https://github.com/nordic-institute/X-Road/commit/550f0fcfbccf2163c5fe092c8a5628865b03d1e4", "message": "Merge branch 'develop' into XRDDEV-861-register-client\n\n# Conflicts:\n#\tsrc/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/ClientsApiController.java\n#\tsrc/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ClientService.java\n#\tsrc/proxy-ui-api/src/test/java/org/niis/xroad/restapi/openapi/ClientsApiControllerIntegrationTest.java", "committedDate": "2020-03-11T11:28:30Z", "type": "commit"}]}