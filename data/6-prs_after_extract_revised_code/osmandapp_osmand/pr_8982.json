{"pr_number": 8982, "pr_title": "Fix #8901", "pr_createdAt": "2020-05-15T17:26:06Z", "pr_url": "https://github.com/osmandapp/OsmAnd/pull/8982", "timeline": [{"oid": "d3ab1445aae5c085114fbe9d11fa9c8fdfef2a01", "url": "https://github.com/osmandapp/OsmAnd/commit/d3ab1445aae5c085114fbe9d11fa9c8fdfef2a01", "message": "Fix #8901", "committedDate": "2020-05-15T17:21:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk1MzYxOA==", "url": "https://github.com/osmandapp/OsmAnd/pull/8982#discussion_r425953618", "bodyText": "Stop bloating MapActivity - move Intent base parsing to separate class", "author": "vshcherb", "createdAt": "2020-05-15T17:43:13Z", "path": "OsmAnd/src/net/osmand/plus/activities/MapActivity.java", "diffHunk": "@@ -1820,6 +1826,46 @@ private boolean parseTileSourceIntent() {\n \t\treturn false;\n \t}\n \n+\tprivate boolean parseOpenGpxIntent() {", "originalCommit": "d3ab1445aae5c085114fbe9d11fa9c8fdfef2a01", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a9e67d2835a39abfe11ac1e0b01dadd57c012fff", "chunk": "diff --git a/OsmAnd/src/net/osmand/plus/activities/MapActivity.java b/OsmAnd/src/net/osmand/plus/activities/MapActivity.java\nindex 8e5e9caff6..d3ac516d81 100644\n--- a/OsmAnd/src/net/osmand/plus/activities/MapActivity.java\n+++ b/OsmAnd/src/net/osmand/plus/activities/MapActivity.java\n\n@@ -1749,123 +1647,6 @@ public class MapActivity extends OsmandActionBarActivity implements DownloadEven\n \t\treturn mapViewTrackingUtilities;\n \t}\n \n-\tprivate boolean parseLaunchIntents() {\n-\t\tboolean applied = parseLocationIntent();\n-\t\tif (!applied) {\n-\t\t\tapplied = parseTileSourceIntent();\n-\t\t}\n-\t\tif (!applied) {\n-\t\t\tapplied = parseOpenGpxIntent();\n-\t\t}\n-\t\treturn applied;\n-\t}\n-\n-\tprivate boolean parseLocationIntent() {\n-\t\tIntent intent = getIntent();\n-\t\tif (intent != null && intent.getData() != null) {\n-\t\t\tUri data = intent.getData();\n-\t\t\tif ((\"http\".equalsIgnoreCase(data.getScheme()) || \"https\".equalsIgnoreCase(data.getScheme())) && data.getHost() != null && data.getHost().contains(\"osmand.net\") &&\n-\t\t\t\t\tdata.getPath() != null && data.getPath().startsWith(\"/go\")) {\n-\t\t\t\tString lat = data.getQueryParameter(\"lat\");\n-\t\t\t\tString lon = data.getQueryParameter(\"lon\");\n-\t\t\t\tString url = data.getQueryParameter(\"url\");\n-\t\t\t\tif (lat != null && lon != null) {\n-\t\t\t\t\ttry {\n-\t\t\t\t\t\tdouble lt = Double.parseDouble(lat);\n-\t\t\t\t\t\tdouble ln = Double.parseDouble(lon);\n-\t\t\t\t\t\tString zoom = data.getQueryParameter(\"z\");\n-\t\t\t\t\t\tint z = settings.getLastKnownMapZoom();\n-\t\t\t\t\t\tif (zoom != null) {\n-\t\t\t\t\t\t\tz = Integer.parseInt(zoom);\n-\t\t\t\t\t\t}\n-\t\t\t\t\t\tsettings.setMapLocationToShow(lt, ln, z, new PointDescription(lt, ln));\n-\t\t\t\t\t} catch (NumberFormatException e) {\n-\t\t\t\t\t\tLOG.error(\"error\", e);\n-\t\t\t\t\t}\n-\t\t\t\t} else if (url != null) {\n-\t\t\t\t\turl = DiscountHelper.parseUrl(app, url);\n-\t\t\t\t\tif (DiscountHelper.validateUrl(app, url)) {\n-\t\t\t\t\t\tDiscountHelper.openUrl(this, url);\n-\t\t\t\t\t}\n-\t\t\t\t}\n-\t\t\t\tsetIntent(null);\n-\t\t\t\treturn true;\n-\t\t\t}\n-\t\t}\n-\t\treturn false;\n-\t}\n-\n-\tprivate boolean parseTileSourceIntent() {\n-\t\tIntent intent = getIntent();\n-\t\tif (intent != null && intent.getData() != null) {\n-\t\t\tUri data = intent.getData();\n-\t\t\tif ((\"http\".equalsIgnoreCase(data.getScheme()) || \"https\".equalsIgnoreCase(data.getScheme())) && data.getHost() != null && data.getHost().contains(\"osmand.net\") &&\n-\t\t\t\t\tdata.getPath() != null && data.getPath().startsWith(\"/add-tile-source\")) {\n-\t\t\t\tMap<String, String> attrs = new HashMap<>();\n-\t\t\t\tfor (String name : data.getQueryParameterNames()) {\n-\t\t\t\t\tString value = data.getQueryParameter(name);\n-\t\t\t\t\tif (value != null) {\n-\t\t\t\t\t\tattrs.put(name, value);\n-\t\t\t\t\t}\n-\t\t\t\t}\n-\t\t\t\tif (!attrs.isEmpty()) {\n-\t\t\t\t\ttry {\n-\t\t\t\t\t\tTileSourceTemplate r = TileSourceManager.createTileSourceTemplate(attrs);\n-\t\t\t\t\t\tif (r != null && settings.installTileSource(r)) {\n-\t\t\t\t\t\t\tToast.makeText(this, getString(R.string.edit_tilesource_successfully, r.getName()),\n-\t\t\t\t\t\t\t\t\tToast.LENGTH_SHORT).show();\n-\t\t\t\t\t\t}\n-\t\t\t\t\t} catch (Exception e) {\n-\t\t\t\t\t\tLOG.error(\"parseAddTileSourceIntent error\", e);\n-\t\t\t\t\t}\n-\t\t\t\t}\n-\t\t\t\tsetIntent(null);\n-\t\t\t\treturn true;\n-\t\t\t}\n-\t\t}\n-\t\treturn false;\n-\t}\n-\n-\tprivate boolean parseOpenGpxIntent() {\n-\t\tIntent intent = getIntent();\n-\t\tif (intent != null && intent.getData() != null) {\n-\t\t\tUri data = intent.getData();\n-\t\t\tif ((\"http\".equalsIgnoreCase(data.getScheme()) || \"https\".equalsIgnoreCase(data.getScheme()))\n-\t\t\t\t\t&& data.getHost() != null && data.getHost().contains(\"osmand.net\")\n-\t\t\t\t\t&& data.getPath() != null && data.getPath().startsWith(\"/open-gpx\")) {\n-\t\t\t\tString url = data.getQueryParameter(\"url\");\n-\t\t\t\tif (Algorithms.isEmpty(url)) {\n-\t\t\t\t\treturn false;\n-\t\t\t\t}\n-\t\t\t\tString name = data.getQueryParameter(\"name\");\n-\t\t\t\tif (Algorithms.isEmpty(name)) {\n-\t\t\t\t\tname = Algorithms.getFileWithoutDirs(url);\n-\t\t\t\t}\n-\t\t\t\tif (!name.endsWith(IndexConstants.GPX_FILE_EXT)) {\n-\t\t\t\t\tname += IndexConstants.GPX_FILE_EXT;\n-\t\t\t\t}\n-\t\t\t\tfinal String fileName = name;\n-\t\t\t\tAndroidNetworkUtils.downloadFileAsync(url, app.getAppPath(IndexConstants.GPX_IMPORT_DIR + fileName),\n-\t\t\t\t\t\tnew CallbackWithObject<String>() {\n-\t\t\t\t\t\t\t@Override\n-\t\t\t\t\t\t\tpublic boolean processResult(String error) {\n-\t\t\t\t\t\t\t\tif (error == null) {\n-\t\t\t\t\t\t\t\t\tString downloaded = app.getString(R.string.shared_string_download_successful);\n-\t\t\t\t\t\t\t\t\tapp.showShortToastMessage(app.getString(R.string.ltr_or_rtl_combine_via_colon, downloaded, fileName));\n-\t\t\t\t\t\t\t\t} else {\n-\t\t\t\t\t\t\t\t\tapp.showShortToastMessage(app.getString(R.string.error_occurred_loading_gpx));\n-\t\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t\t\treturn true;\n-\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t});\n-\n-\t\t\t\tsetIntent(null);\n-\t\t\t\treturn true;\n-\t\t\t}\n-\t\t}\n-\t\treturn false;\n-\t}\n-\n \tpublic MapActivityActions getMapActions() {\n \t\treturn mapActions;\n \t}\n"}}, {"oid": "a9e67d2835a39abfe11ac1e0b01dadd57c012fff", "url": "https://github.com/osmandapp/OsmAnd/commit/a9e67d2835a39abfe11ac1e0b01dadd57c012fff", "message": "Create intentHelper", "committedDate": "2020-05-18T09:37:50Z", "type": "commit"}]}