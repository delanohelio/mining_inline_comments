{"pr_number": 8967, "pr_title": "Fix default color favorites", "pr_createdAt": "2020-05-14T16:16:26Z", "pr_url": "https://github.com/osmandapp/OsmAnd/pull/8967", "timeline": [{"oid": "beb6a1805ff580e7a33a06c047f4a3ee6cfd3533", "url": "https://github.com/osmandapp/OsmAnd/commit/beb6a1805ff580e7a33a06c047f4a3ee6cfd3533", "message": "Fix #8926 Default color of Favorites changed to black", "committedDate": "2020-05-14T16:06:37Z", "type": "commit"}, {"oid": "0e5078dd4b157f7b94fb6ad58473f6af11acecc8", "url": "https://github.com/osmandapp/OsmAnd/commit/0e5078dd4b157f7b94fb6ad58473f6af11acecc8", "message": "Merge branch 'master' into Fix_default_color_favorites\n\n# Conflicts:\n#\tOsmAnd/src/net/osmand/plus/activities/FavoritesTreeFragment.java", "committedDate": "2020-05-14T16:14:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI2OTU2Ng==", "url": "https://github.com/osmandapp/OsmAnd/pull/8967#discussion_r425269566", "bodyText": "Looks bad\nWhy it is not simply prevAppVersion < VERSION_3_7_1", "author": "vshcherb", "createdAt": "2020-05-14T16:25:49Z", "path": "OsmAnd/src/net/osmand/plus/AppInitializer.java", "diffHunk": "@@ -228,8 +228,20 @@ public void onFinish(AppInitializer init) {\n \t\t\t\tapp.getSettings().migratePreferences();\n \t\t\t\tstartPrefs.edit().putInt(VERSION_INSTALLED_NUMBER, VERSION_3_6).commit();\n \t\t\t}\n-\t\t\tif (prevAppVersion < VERSION_3_7) {\n+\t\t\tif (prevAppVersion < VERSION_3_7 || Version.getAppVersion(app).equals(\"3.7.1\")) {", "originalCommit": "0e5078dd4b157f7b94fb6ad58473f6af11acecc8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI3MDY2Nw==", "url": "https://github.com/osmandapp/OsmAnd/pull/8967#discussion_r425270667", "bodyText": "// Make 4 digits version  from now\npublic static final int VERSION_3_7_1 = 3710;", "author": "vshcherb", "createdAt": "2020-05-14T16:26:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI2OTU2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI3MDk3Mw==", "url": "https://github.com/osmandapp/OsmAnd/pull/8967#discussion_r425270973", "bodyText": "Move all migration code to Another class AppVersionUpgradeOnInit", "author": "vshcherb", "createdAt": "2020-05-14T16:27:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI2OTU2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "48fb775f51ad48f6759a22219b6504a24c18890f", "chunk": "diff --git a/OsmAnd/src/net/osmand/plus/AppInitializer.java b/OsmAnd/src/net/osmand/plus/AppInitializer.java\nindex 3321c2864f..0587dce343 100644\n--- a/OsmAnd/src/net/osmand/plus/AppInitializer.java\n+++ b/OsmAnd/src/net/osmand/plus/AppInitializer.java\n\n@@ -192,60 +181,8 @@ public class AppInitializer implements IProgress {\n \t\t\tstartPrefs.edit().putBoolean(FIRST_TIME_APP_RUN, true).commit();\n \t\t\tstartPrefs.edit().putString(VERSION_INSTALLED, Version.getFullVersion(app)).commit();\n \t\t\tstartPrefs.edit().putInt(VERSION_INSTALLED_NUMBER, VERSION_3_5).commit();\n-\t\t} else if (!Version.getFullVersion(app).equals(startPrefs.getString(VERSION_INSTALLED, \"\"))) {\n-\t\t\tprevAppVersion = startPrefs.getInt(VERSION_INSTALLED_NUMBER, 0);\n-\t\t\tif(prevAppVersion < VERSION_2_2) {\n-\t\t\t\tapp.getSettings().SHOW_DASHBOARD_ON_START.set(true);\n-\t\t\t\tapp.getSettings().SHOW_DASHBOARD_ON_MAP_SCREEN.set(true);\n-\t\t\t\tapp.getSettings().SHOW_CARD_TO_CHOOSE_DRAWER.set(true);\n-\t\t\t\tstartPrefs.edit().putInt(VERSION_INSTALLED_NUMBER, VERSION_2_2).commit();\n-\t\t\t}\n-\t\t\tif(prevAppVersion < VERSION_2_3) {\n-\t\t\t\tstartPrefs.edit().putInt(VERSION_INSTALLED_NUMBER, VERSION_2_3).commit();\n-\t\t\t}\n-\t\t\tif (prevAppVersion < VERSION_3_2) {\n-\t\t\t\tapp.getSettings().BILLING_PURCHASE_TOKENS_SENT.set(\"\");\n-\t\t\t\tstartPrefs.edit().putInt(VERSION_INSTALLED_NUMBER, VERSION_3_2).commit();\n-\t\t\t}\n-\t\t\tif (prevAppVersion < VERSION_3_5 || Version.getAppVersion(app).equals(\"3.5.3\")\n-\t\t\t\t\t|| Version.getAppVersion(app).equals(\"3.5.4\")) {\n-\t\t\t\tapp.getSettings().migratePreferences();\n-\t\t\t\taddListener(new AppInitializeListener() {\n-\t\t\t\t\t@Override\n-\t\t\t\t\tpublic void onProgress(AppInitializer init, InitEvents event) {\n-\t\t\t\t\t\tif (event.equals(InitEvents.FAVORITES_INITIALIZED)) {\n-\t\t\t\t\t\t\tapp.getSettings().migrateHomeWorkParkingToFavorites();\n-\t\t\t\t\t\t}\n-\t\t\t\t\t}\n-\n-\t\t\t\t\t@Override\n-\t\t\t\t\tpublic void onFinish(AppInitializer init) {\n-\t\t\t\t\t}\n-\t\t\t\t});\n-\t\t\t\tstartPrefs.edit().putInt(VERSION_INSTALLED_NUMBER, VERSION_3_5).commit();\n-\t\t\t}\n-\t\t\tif (prevAppVersion < VERSION_3_6) {\n-\t\t\t\tapp.getSettings().migratePreferences();\n-\t\t\t\tstartPrefs.edit().putInt(VERSION_INSTALLED_NUMBER, VERSION_3_6).commit();\n-\t\t\t}\n-\t\t\tif (prevAppVersion < VERSION_3_7 || Version.getAppVersion(app).equals(\"3.7.1\")) {\n-\t\t\t\tapp.getSettings().migrateEnumPreferences();\n-\t\t\t\taddListener(new AppInitializeListener() {\n-\t\t\t\t\t@Override\n-\t\t\t\t\tpublic void onProgress(AppInitializer init, InitEvents event) {\n-\t\t\t\t\t\tif (event.equals(InitEvents.FAVORITES_INITIALIZED)) {\n-\t\t\t\t\t\t\tapp.getFavorites().fixBlackBackground();\n-\t\t\t\t\t\t}\n-\t\t\t\t\t}\n-\n-\t\t\t\t\t@Override\n-\t\t\t\t\tpublic void onFinish(AppInitializer init) {\n-\t\t\t\t\t}\n-\t\t\t\t});\n-\t\t\t\tstartPrefs.edit().putInt(VERSION_INSTALLED_NUMBER, VERSION_3_7).commit();\n-\t\t\t}\n-\t\t\tstartPrefs.edit().putString(VERSION_INSTALLED, Version.getFullVersion(app)).commit();\n-\t\t\tappVersionChanged = true;\n+\t\t} else {\n+\t\t\tappVersionUpgrade.upgradeVersion(startPrefs, VERSION_3_7_0_1);\n \t\t}\n \t\tapp.getSettings().SHOW_TRAVEL_UPDATE_CARD.set(true);\n \t\tapp.getSettings().SHOW_TRAVEL_NEEDED_MAPS_CARD.set(true);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI3MTM0Mw==", "url": "https://github.com/osmandapp/OsmAnd/pull/8967#discussion_r425271343", "bodyText": "Is there a ready method for updating all listeners?", "author": "vshcherb", "createdAt": "2020-05-14T16:27:57Z", "path": "OsmAnd/src/net/osmand/plus/FavouritesDbHelper.java", "diffHunk": "@@ -183,6 +183,28 @@ public void run() {\n \t\t});\n \t}\n \n+\tvoid fixBlackBackground() {\n+\t\tflatGroups.clear();\n+\t\tfavoriteGroups.clear();\n+\t\tfor (FavouritePoint fp : cachedFavoritePoints) {\n+\t\t\tif (fp.getColor() == 0xFF000000) {\n+\t\t\t\tfp.setColor(0);\n+\t\t\t}\n+\t\t\tFavoriteGroup group = getOrCreateGroup(fp, 0);\n+\t\t\tgroup.points.add(fp);\n+\t\t}\n+\t\tsortAll();\n+\t\tsaveCurrentPointsIntoFile();\n+\t\tcontext.runInUIThread(new Runnable() {", "originalCommit": "0e5078dd4b157f7b94fb6ad58473f6af11acecc8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "48fb775f51ad48f6759a22219b6504a24c18890f", "chunk": "diff --git a/OsmAnd/src/net/osmand/plus/FavouritesDbHelper.java b/OsmAnd/src/net/osmand/plus/FavouritesDbHelper.java\nindex e94240e86b..42e8a01554 100644\n--- a/OsmAnd/src/net/osmand/plus/FavouritesDbHelper.java\n+++ b/OsmAnd/src/net/osmand/plus/FavouritesDbHelper.java\n\n@@ -173,14 +173,7 @@ public class FavouritesDbHelper {\n \t\t\tsaveCurrentPointsIntoFile();\n \t\t}\n \t\tfavoritesLoaded = true;\n-\t\tcontext.runInUIThread(new Runnable() {\n-\t\t\t@Override\n-\t\t\tpublic void run() {\n-\t\t\t\tfor (FavoritesListener listener : listeners) {\n-\t\t\t\t\tlistener.onFavoritesLoaded();\n-\t\t\t\t}\n-\t\t\t}\n-\t\t});\n+\t\tnotifyListeners();\n \t}\n \n \tvoid fixBlackBackground() {\n"}}, {"oid": "48fb775f51ad48f6759a22219b6504a24c18890f", "url": "https://github.com/osmandapp/OsmAnd/commit/48fb775f51ad48f6759a22219b6504a24c18890f", "message": "Refactoring AppInitializer", "committedDate": "2020-05-15T08:49:54Z", "type": "commit"}, {"oid": "07d0b438070f3f3bab8610aa4eb3ecc9e8443404", "url": "https://github.com/osmandapp/OsmAnd/commit/07d0b438070f3f3bab8610aa4eb3ecc9e8443404", "message": "Refactoring AppInitializer", "committedDate": "2020-05-15T08:50:59Z", "type": "commit"}, {"oid": "082a24a21a0174d261e944ce53730b36cc24c851", "url": "https://github.com/osmandapp/OsmAnd/commit/082a24a21a0174d261e944ce53730b36cc24c851", "message": "Fix upgrade process", "committedDate": "2020-05-15T13:51:54Z", "type": "commit"}, {"oid": "a5f40100c8ca15a49b4c46e02e4f78e3a5feef03", "url": "https://github.com/osmandapp/OsmAnd/commit/a5f40100c8ca15a49b4c46e02e4f78e3a5feef03", "message": "Fix favorites default icon and background", "committedDate": "2020-05-18T08:53:12Z", "type": "commit"}, {"oid": "a8db838530c440317e45f0b28521156ff804f442", "url": "https://github.com/osmandapp/OsmAnd/commit/a8db838530c440317e45f0b28521156ff804f442", "message": "Merge branch 'master' into Fix_default_color_favorites\n\n# Conflicts:\n#\tOsmAnd/src/net/osmand/plus/activities/FavoritesTreeFragment.java", "committedDate": "2020-05-18T09:00:36Z", "type": "commit"}, {"oid": "6479a868405689bc28f877dd09c858c4d10f0534", "url": "https://github.com/osmandapp/OsmAnd/commit/6479a868405689bc28f877dd09c858c4d10f0534", "message": "Fix favorites default icon and background", "committedDate": "2020-05-18T10:08:26Z", "type": "commit"}]}