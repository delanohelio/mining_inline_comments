{"pr_number": 2445, "pr_title": "Add `UnstableApi` annotation and hide some internal classes", "pr_createdAt": "2020-02-03T11:13:22Z", "pr_url": "https://github.com/line/armeria/pull/2445", "timeline": [{"oid": "550fc30852f3d29abb2938149baae8f5a280751e", "url": "https://github.com/line/armeria/commit/550fc30852f3d29abb2938149baae8f5a280751e", "message": "Add `UnstableApi` annotation and hide `DefaultRequestLog`\n\nSee: #2360\n\n- Added the `UnstableApi` annotation to indicate unstable API.\n- Annotated some classes and packages with the `UnstableApi` annotation.", "committedDate": "2020-02-03T11:11:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDA3NTczNQ==", "url": "https://github.com/line/armeria/pull/2445#discussion_r374075735", "bodyText": "nit: 2020. \ud83d\ude06", "author": "minwoox", "createdAt": "2020-02-03T12:29:59Z", "path": "core/src/main/java/com/linecorp/armeria/common/util/UnstableApi.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ * Copyright 2019 LINE Corporation", "originalCommit": "550fc30852f3d29abb2938149baae8f5a280751e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDA5NzIxNw==", "url": "https://github.com/line/armeria/pull/2445#discussion_r374097217", "bodyText": "\ud83e\udd23", "author": "trustin", "createdAt": "2020-02-03T13:21:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDA3NTczNQ=="}], "type": "inlineReview", "revised_code": {"commit": "9fba0501432d3d67a5d2042094cbe5ac3c8e2b9a", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/common/util/UnstableApi.java b/core/src/main/java/com/linecorp/armeria/common/util/UnstableApi.java\nindex 03b61cea95..d228103bf5 100644\n--- a/core/src/main/java/com/linecorp/armeria/common/util/UnstableApi.java\n+++ b/core/src/main/java/com/linecorp/armeria/common/util/UnstableApi.java\n\n@@ -1,5 +1,5 @@\n /*\n- * Copyright 2019 LINE Corporation\n+ * Copyright 2020 LINE Corporation\n  *\n  * LINE Corporation licenses this file to you under the Apache License,\n  * version 2.0 (the \"License\"); you may not use this file except in compliance\n"}}, {"oid": "9fba0501432d3d67a5d2042094cbe5ac3c8e2b9a", "url": "https://github.com/line/armeria/commit/9fba0501432d3d67a5d2042094cbe5ac3c8e2b9a", "message": "Time travel", "committedDate": "2020-02-03T13:21:26Z", "type": "commit"}, {"oid": "4ccadd7c5de0b7a757d6993fb30932b5ccc9f169", "url": "https://github.com/line/armeria/commit/4ccadd7c5de0b7a757d6993fb30932b5ccc9f169", "message": "Merge branch 'master' into unstable_api", "committedDate": "2020-02-03T13:23:40Z", "type": "commit"}, {"oid": "d7842904f37d02242aa9670679039ef1eb9d3ce2", "url": "https://github.com/line/armeria/commit/d7842904f37d02242aa9670679039ef1eb9d3ce2", "message": "Merge branch 'master' into unstable_api", "committedDate": "2020-02-03T13:28:54Z", "type": "commit"}, {"oid": "86bed0f213b3279e1e0fded5ca9a3855e08d9379", "url": "https://github.com/line/armeria/commit/86bed0f213b3279e1e0fded5ca9a3855e08d9379", "message": "Once more unstable API", "committedDate": "2020-02-03T13:46:36Z", "type": "commit"}, {"oid": "0d1ad1a407b560aa1956163f3b490326f39aea66", "url": "https://github.com/line/armeria/commit/0d1ad1a407b560aa1956163f3b490326f39aea66", "message": "Mark intermediary `StreamMessage` implementations as unstable\n\nAlso removed deprecated `onDemand()` calls.", "committedDate": "2020-02-04T02:59:04Z", "type": "commit"}, {"oid": "b5f948b2344fcf0849cce53e572ca3045c9f688b", "url": "https://github.com/line/armeria/commit/b5f948b2344fcf0849cce53e572ca3045c9f688b", "message": "Mark `DefaultStreamMessageDuplicator` as unstable", "committedDate": "2020-02-04T03:15:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ3MjY1Ng==", "url": "https://github.com/line/armeria/pull/2445#discussion_r374472656", "bodyText": "Does this effectively mean we only officially support our official client implementations, and user-created custom ones may potentially have breaking changes? I'm ok with either but we may want to document that explicitly (I lean towards not marking this unstable though it seems pretty well-baked).", "author": "anuraaga", "createdAt": "2020-02-04T04:47:40Z", "path": "core/src/main/java/com/linecorp/armeria/client/ClientFactoryProvider.java", "diffHunk": "@@ -17,10 +17,12 @@\n package com.linecorp.armeria.client;\n \n import com.linecorp.armeria.common.SerializationFormat;\n+import com.linecorp.armeria.common.util.UnstableApi;\n \n /**\n  * Creates a new {@link ClientFactory} dynamically via Java SPI (Service Provider Interface).\n  */\n+@UnstableApi", "originalCommit": "b5f948b2344fcf0849cce53e572ca3045c9f688b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU0ODI2MA==", "url": "https://github.com/line/armeria/pull/2445#discussion_r374548260", "bodyText": "I'm somewhat unsure about the stability of this API although it stayed unchanged for a very long time. For instance, a user may want to build a ClientFactory which is built on top of GrpcClientFactory or THttpClientFactory.", "author": "trustin", "createdAt": "2020-02-04T09:08:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ3MjY1Ng=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ3Mjc2MA==", "url": "https://github.com/line/armeria/pull/2445#discussion_r374472760", "bodyText": "Just want to confirm, I think it's possible to hide some of these completely, is the idea to mark as unstable first and then hide later?", "author": "anuraaga", "createdAt": "2020-02-04T04:48:15Z", "path": "core/src/main/java/com/linecorp/armeria/client/DefaultClientRequestContext.java", "diffHunk": "@@ -67,6 +67,7 @@\n /**\n  * Default {@link ClientRequestContext} implementation.\n  */\n+@UnstableApi", "originalCommit": "b5f948b2344fcf0849cce53e572ca3045c9f688b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU0ODk5Mg==", "url": "https://github.com/line/armeria/pull/2445#discussion_r374548992", "bodyText": "Is is possible to hide this class? Any user who wants to write a custom client implementation will need to use this API.", "author": "trustin", "createdAt": "2020-02-04T09:10:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ3Mjc2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU1ODQ1Mg==", "url": "https://github.com/line/armeria/pull/2445#discussion_r374558452", "bodyText": "If I'm not mistaken, only the constructor is ever needed. So we should be able to hide it by providing a factory in *RequestContext.\nThis class is literally what prompted me to file the issue about over-exposed APIs ;)", "author": "anuraaga", "createdAt": "2020-02-04T09:29:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ3Mjc2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU2Mzc1Ng==", "url": "https://github.com/line/armeria/pull/2445#discussion_r374563756", "bodyText": "I'm not sure if it's a good idea to have a static factory method with such large number of parameters. Perhaps it's better as it is now, i.e. public class annotated with @UnstableApi? It's for advanced users only anyway.", "author": "trustin", "createdAt": "2020-02-04T09:39:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ3Mjc2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDYxNjQxMQ==", "url": "https://github.com/line/armeria/pull/2445#discussion_r374616411", "bodyText": "I think it's still worth it. Though if we can merge the semantics with our current builders maybe even better not sure it's possible.\nThese classes leak a lot of implementation details, including a whole class TimeoutController. I think they're so core that we want to hide them as much as possible.", "author": "anuraaga", "createdAt": "2020-02-04T11:27:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ3Mjc2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDYyNjMwNw==", "url": "https://github.com/line/armeria/pull/2445#discussion_r374626307", "bodyText": "Just realized that setTimeoutController and TimeoutController can be package-private. I think we can hide DefaultClientRequestContext if we do something about DefaultClientRequestContext.init(EndpointGroup). Not sure if it makes sense to move it to ClientRequestContext..", "author": "trustin", "createdAt": "2020-02-04T11:52:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ3Mjc2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDYyOTQ3Nw==", "url": "https://github.com/line/armeria/pull/2445#discussion_r374629477", "bodyText": "Let me keep thinking about how we can solve this. Meanwhile, let me leave this as it is and address it in another PR. At least TimeoutController is now removed from public API.", "author": "trustin", "createdAt": "2020-02-04T12:00:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ3Mjc2MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ3MzA3NA==", "url": "https://github.com/line/armeria/pull/2445#discussion_r374473074", "bodyText": "This is already in internal package", "author": "anuraaga", "createdAt": "2020-02-04T04:49:50Z", "path": "core/src/main/java/com/linecorp/armeria/internal/annotation/AnnotatedDocServicePlugin.java", "diffHunk": "@@ -80,6 +81,7 @@\n /**\n  * A {@link DocServicePlugin} implementation that supports the {@link AnnotatedService}.\n  */\n+@UnstableApi", "originalCommit": "b5f948b2344fcf0849cce53e572ca3045c9f688b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU0OTI0NQ==", "url": "https://github.com/line/armeria/pull/2445#discussion_r374549245", "bodyText": "Oops!", "author": "trustin", "createdAt": "2020-02-04T09:10:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ3MzA3NA=="}], "type": "inlineReview", "revised_code": {"commit": "a02abe8fc58e0cc1fdd42ee738bff3a77ac64ea7", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/internal/annotation/AnnotatedDocServicePlugin.java b/core/src/main/java/com/linecorp/armeria/internal/annotation/AnnotatedDocServicePlugin.java\nindex 699dd2b661..93b45f2398 100644\n--- a/core/src/main/java/com/linecorp/armeria/internal/annotation/AnnotatedDocServicePlugin.java\n+++ b/core/src/main/java/com/linecorp/armeria/internal/annotation/AnnotatedDocServicePlugin.java\n\n@@ -81,7 +80,6 @@ import com.linecorp.armeria.server.docs.TypeSignature;\n /**\n  * A {@link DocServicePlugin} implementation that supports the {@link AnnotatedService}.\n  */\n-@UnstableApi\n public final class AnnotatedDocServicePlugin implements DocServicePlugin {\n \n     @VisibleForTesting\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ3MzI0MQ==", "url": "https://github.com/line/armeria/pull/2445#discussion_r374473241", "bodyText": "Should we add to docs/package-inf.java?", "author": "anuraaga", "createdAt": "2020-02-04T04:50:45Z", "path": "core/src/main/java/com/linecorp/armeria/server/docs/DocServicePlugin.java", "diffHunk": "@@ -24,12 +24,14 @@\n import com.google.common.collect.ImmutableMap;\n import com.google.common.collect.ImmutableSet;\n \n+import com.linecorp.armeria.common.util.UnstableApi;\n import com.linecorp.armeria.server.Service;\n import com.linecorp.armeria.server.ServiceConfig;\n \n /**\n  * Generates the {@link ServiceSpecification}s of the supported {@link Service}s.\n  */\n+@UnstableApi", "originalCommit": "b5f948b2344fcf0849cce53e572ca3045c9f688b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU0OTQxMw==", "url": "https://github.com/line/armeria/pull/2445#discussion_r374549413", "bodyText": "No, because we have DocService there. \ud83d\ude09", "author": "trustin", "createdAt": "2020-02-04T09:11:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ3MzI0MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ3MzUyNQ==", "url": "https://github.com/line/armeria/pull/2445#discussion_r374473525", "bodyText": "Do we also need to add to the classes? (I noticed we did in grpc-protocol)", "author": "anuraaga", "createdAt": "2020-02-04T04:52:16Z", "path": "core/src/main/java/com/linecorp/armeria/unsafe/package-info.java", "diffHunk": "@@ -13,14 +13,14 @@\n  * License for the specific language governing permissions and limitations\n  * under the License.\n  */\n-\n /**\n  * Utilities for working with {@link io.netty.buffer.ByteBuf} in an unsafe way. These can improve performance\n  * when dealing with large buffers but require careful memory management or there will be memory leaks. Only use\n  * these methods if you really know what you're doing.\n  */\n-\n+@UnstableApi", "originalCommit": "b5f948b2344fcf0849cce53e572ca3045c9f688b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU0OTgwMg==", "url": "https://github.com/line/armeria/pull/2445#discussion_r374549802", "bodyText": "I did already.", "author": "trustin", "createdAt": "2020-02-04T09:11:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ3MzUyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU1NjA0OQ==", "url": "https://github.com/line/armeria/pull/2445#discussion_r374556049", "bodyText": "Oops not sure why I missed it before", "author": "anuraaga", "createdAt": "2020-02-04T09:24:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ3MzUyNQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ3MzYyMw==", "url": "https://github.com/line/armeria/pull/2445#discussion_r374473623", "bodyText": "Guess we should move to internal package", "author": "anuraaga", "createdAt": "2020-02-04T04:52:52Z", "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcDocServicePlugin.java", "diffHunk": "@@ -74,6 +75,7 @@\n /**\n  * {@link DocServicePlugin} implementation that supports {@link GrpcService}s.\n  */\n+@UnstableApi\n public final class GrpcDocServicePlugin implements DocServicePlugin {", "originalCommit": "b5f948b2344fcf0849cce53e572ca3045c9f688b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ3MzY4OQ==", "url": "https://github.com/line/armeria/pull/2445#discussion_r374473689", "bodyText": "I wonder if it's ok for SPI implementations to be in internal package I guess so", "author": "anuraaga", "createdAt": "2020-02-04T04:53:17Z", "path": "grpc/src/main/java/com/linecorp/armeria/client/grpc/GrpcClientFactoryProvider.java", "diffHunk": "@@ -18,10 +18,12 @@\n \n import com.linecorp.armeria.client.ClientFactory;\n import com.linecorp.armeria.client.ClientFactoryProvider;\n+import com.linecorp.armeria.common.util.UnstableApi;\n \n /**\n  * {@link ClientFactoryProvider} that creates a {@link GrpcClientFactory}.\n  */\n+@UnstableApi", "originalCommit": "b5f948b2344fcf0849cce53e572ca3045c9f688b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU2MTM3MQ==", "url": "https://github.com/line/armeria/pull/2445#discussion_r374561371", "bodyText": "The internal packages are getting more and more crowded. Let me send a follow-up PR which 1) reorganizes the internal packages to have the same structure with non-internal packages (common, client, server) and 2) move the SPI impls there.", "author": "trustin", "createdAt": "2020-02-04T09:34:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ3MzY4OQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ3Mzc5NA==", "url": "https://github.com/line/armeria/pull/2445#discussion_r374473794", "bodyText": "Is it worth having both UnstableApi and Internal to separate what definitely won't ever be stable?", "author": "anuraaga", "createdAt": "2020-02-04T04:53:51Z", "path": "tomcat/src/main/java/com/linecorp/armeria/server/tomcat/Tomcat90ProtocolHandler.java", "diffHunk": "@@ -28,10 +28,13 @@\n import org.apache.coyote.UpgradeProtocol;\n import org.apache.tomcat.util.net.SSLHostConfig;\n \n+import com.linecorp.armeria.common.util.UnstableApi;\n+\n /**\n  * A {@link ProtocolHandler} for Tomcat 8.5 and above.\n  * Do not use; loaded and instantiated by Tomcat via reflection.\n  */\n+@UnstableApi", "originalCommit": "b5f948b2344fcf0849cce53e572ca3045c9f688b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU1MTc1NQ==", "url": "https://github.com/line/armeria/pull/2445#discussion_r374551755", "bodyText": "I think I can just move this class to the internal package.", "author": "trustin", "createdAt": "2020-02-04T09:16:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ3Mzc5NA=="}], "type": "inlineReview", "revised_code": {"commit": "56f7c847fb6da0b8cb98e57fd72b3a5f1741868d", "chunk": "diff --git a/tomcat/src/main/java/com/linecorp/armeria/server/tomcat/Tomcat90ProtocolHandler.java b/tomcat/src/main/java/com/linecorp/armeria/internal/tomcat/Tomcat90ProtocolHandler.java\nsimilarity index 96%\nrename from tomcat/src/main/java/com/linecorp/armeria/server/tomcat/Tomcat90ProtocolHandler.java\nrename to tomcat/src/main/java/com/linecorp/armeria/internal/tomcat/Tomcat90ProtocolHandler.java\nindex 9e2bd15ce9..0d7f1ecaea 100644\n--- a/tomcat/src/main/java/com/linecorp/armeria/server/tomcat/Tomcat90ProtocolHandler.java\n+++ b/tomcat/src/main/java/com/linecorp/armeria/internal/tomcat/Tomcat90ProtocolHandler.java\n\n@@ -28,13 +28,10 @@ import org.apache.coyote.ProtocolHandler;\n import org.apache.coyote.UpgradeProtocol;\n import org.apache.tomcat.util.net.SSLHostConfig;\n \n-import com.linecorp.armeria.common.util.UnstableApi;\n-\n /**\n  * A {@link ProtocolHandler} for Tomcat 8.5 and above.\n  * Do not use; loaded and instantiated by Tomcat via reflection.\n  */\n-@UnstableApi\n public final class Tomcat90ProtocolHandler implements ProtocolHandler {\n \n     private static final AtomicInteger nextId = new AtomicInteger();\n"}}, {"oid": "c7d214424c51db78c1cc78b7a7b759cb9f4404c3", "url": "https://github.com/line/armeria/commit/c7d214424c51db78c1cc78b7a7b759cb9f4404c3", "message": "Merge branch 'master' into unstable_api", "committedDate": "2020-02-04T09:05:40Z", "type": "commit"}, {"oid": "a02abe8fc58e0cc1fdd42ee738bff3a77ac64ea7", "url": "https://github.com/line/armeria/commit/a02abe8fc58e0cc1fdd42ee738bff3a77ac64ea7", "message": "Remove unnecessary `UnstableApi` annotation in `AnnotatedDocServicePlugin`", "committedDate": "2020-02-04T09:16:16Z", "type": "commit"}, {"oid": "56f7c847fb6da0b8cb98e57fd72b3a5f1741868d", "url": "https://github.com/line/armeria/commit/56f7c847fb6da0b8cb98e57fd72b3a5f1741868d", "message": "Move Tomcat protocol handler and buffers to internal", "committedDate": "2020-02-04T09:19:28Z", "type": "commit"}, {"oid": "4aec1b4c2ed17b41b58fc9d9bda1ca4cc0253d9b", "url": "https://github.com/line/armeria/commit/4aec1b4c2ed17b41b58fc9d9bda1ca4cc0253d9b", "message": "Move another Tomcat internal class", "committedDate": "2020-02-04T09:45:02Z", "type": "commit"}, {"oid": "4e0870ef771fb69bcfce5f00b70055ee85d3abe6", "url": "https://github.com/line/armeria/commit/4e0870ef771fb69bcfce5f00b70055ee85d3abe6", "message": "Hide `TimeoutController` from the public API", "committedDate": "2020-02-04T11:51:03Z", "type": "commit"}]}