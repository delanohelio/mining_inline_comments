{"pr_number": 2888, "pr_title": "Fix flaky test `ArmeriaReactiveWebServerFactoryTest.shouldRunOnSpecif\u2026", "pr_createdAt": "2020-07-08T14:53:53Z", "pr_url": "https://github.com/line/armeria/pull/2888", "timeline": [{"oid": "a76246db137b8c27476098b8476f0c516e3e059e", "url": "https://github.com/line/armeria/commit/a76246db137b8c27476098b8476f0c516e3e059e", "message": "Fix flaky test `ArmeriaReactiveWebServerFactoryTest.shouldRunOnSpecifiedPort()`\n\nMotivation:\nhttps://ci.appveyor.com/project/line/armeria/builds/33975010/job/wuef6f33dpaj0i6t#L2789\n```java\nArmeriaReactiveWebServerFactoryTest > shouldRunOnSpecifiedPort() FAILED\n    org.springframework.boot.web.server.WebServerException: Failed to start ArmeriaWebServer\n        at com.linecorp.armeria.spring.web.ArmeriaWebServer.start(ArmeriaWebServer.java:106)\n        at com.linecorp.armeria.spring.web.reactive.ArmeriaReactiveWebServerFactoryTest.runServer(ArmeriaReactiveWebServerFactoryTest.java:194)\n        at com.linecorp.armeria.spring.web.reactive.ArmeriaReactiveWebServerFactoryTest.runEchoServer(ArmeriaReactiveWebServerFactoryTest.java:187)\n        at com.linecorp.armeria.spring.web.reactive.ArmeriaReactiveWebServerFactoryTest.shouldRunOnSpecifiedPort(ArmeriaReactiveWebServerFactoryTest.java:86)\n        Caused by:\n        io.netty.channel.unix.Errors$NativeIoException: bind(..) failed: Address already in use\n```\n\nThere is a race condition on finding an unsed port.\nThe port seems to be used by another test because of parallel test option.\nIt is hard to make a transaction on finding and using an unused port.\n\nModification:\n\n- Add junit-pioneer as a dependency\n- Use `@RepeatFailedTest(3)` for flaky failed test\n\nResult:\n\nRetry on failed test", "committedDate": "2020-07-08T14:52:31Z", "type": "commit"}, {"oid": "da6d85287d6a79e51905273b2d34ab4526177e47", "url": "https://github.com/line/armeria/commit/da6d85287d6a79e51905273b2d34ab4526177e47", "message": "Address comment from @trustin / Use for-loop", "committedDate": "2020-07-09T06:18:34Z", "type": "commit"}, {"oid": "0aedf5d88db866e9a26158f1bf2591a232be0302", "url": "https://github.com/line/armeria/commit/0aedf5d88db866e9a26158f1bf2591a232be0302", "message": "Clean up", "committedDate": "2020-07-09T06:30:10Z", "type": "commit"}, {"oid": "1f6da6f01031f76bb61d152377a45c55d0df0885", "url": "https://github.com/line/armeria/commit/1f6da6f01031f76bb61d152377a45c55d0df0885", "message": "Fix compile error", "committedDate": "2020-07-09T07:27:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYwMjMyNg==", "url": "https://github.com/line/armeria/pull/2888#discussion_r452602326", "bodyText": "Could you leave a comment on why we try this three times?", "author": "minwoox", "createdAt": "2020-07-10T03:26:06Z", "path": "spring/boot2-webflux-autoconfigure/src/test/java/com/linecorp/armeria/spring/web/reactive/ArmeriaReactiveWebServerFactoryTest.java", "diffHunk": "@@ -80,10 +85,18 @@ private WebClient httpClient(WebServer server) {\n \n     @Test\n     void shouldRunOnSpecifiedPort() {\n-        final ArmeriaReactiveWebServerFactory factory = factory();\n-        final int port = SocketUtils.findAvailableTcpPort();\n-        factory.setPort(port);\n-        runEchoServer(factory, server -> assertThat(server.getPort()).isEqualTo(port));\n+        for (int i = 0; i < 3; i++) {\n+            final ArmeriaReactiveWebServerFactory factory = factory(new DefaultListableBeanFactory());", "originalCommit": "1f6da6f01031f76bb61d152377a45c55d0df0885", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY5NTEzMQ==", "url": "https://github.com/line/armeria/pull/2888#discussion_r452695131", "bodyText": "Yap!", "author": "ikhoon", "createdAt": "2020-07-10T08:18:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYwMjMyNg=="}], "type": "inlineReview", "revised_code": {"commit": "489d51c1d77c750b4a7891d3b9d4ae8759a862a2", "chunk": "diff --git a/spring/boot2-webflux-autoconfigure/src/test/java/com/linecorp/armeria/spring/web/reactive/ArmeriaReactiveWebServerFactoryTest.java b/spring/boot2-webflux-autoconfigure/src/test/java/com/linecorp/armeria/spring/web/reactive/ArmeriaReactiveWebServerFactoryTest.java\nindex 085e765f8a..ecab14ab93 100644\n--- a/spring/boot2-webflux-autoconfigure/src/test/java/com/linecorp/armeria/spring/web/reactive/ArmeriaReactiveWebServerFactoryTest.java\n+++ b/spring/boot2-webflux-autoconfigure/src/test/java/com/linecorp/armeria/spring/web/reactive/ArmeriaReactiveWebServerFactoryTest.java\n\n@@ -85,6 +85,9 @@ class ArmeriaReactiveWebServerFactoryTest {\n \n     @Test\n     void shouldRunOnSpecifiedPort() {\n+        // There is a race condition on finding an unused port.\n+        // The found port seems to be used by another test before using it because of the parallel test option.\n+        // So this test case is tried up to 3 times to avoid flakiness.\n         for (int i = 0; i < 3; i++) {\n             final ArmeriaReactiveWebServerFactory factory = factory(new DefaultListableBeanFactory());\n             final int port = SocketUtils.findAvailableTcpPort();\n"}}, {"oid": "489d51c1d77c750b4a7891d3b9d4ae8759a862a2", "url": "https://github.com/line/armeria/commit/489d51c1d77c750b4a7891d3b9d4ae8759a862a2", "message": "Address comments by @minwoox", "committedDate": "2020-07-10T08:28:40Z", "type": "commit"}]}