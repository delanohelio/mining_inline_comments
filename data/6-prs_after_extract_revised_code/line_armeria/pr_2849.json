{"pr_number": 2849, "pr_title": "Make the build not fail when `defaultUseHttp2Preface=false`", "pr_createdAt": "2020-06-29T05:39:11Z", "pr_url": "https://github.com/line/armeria/pull/2849", "timeline": [{"oid": "b680481ac686ab570755df93f7015c6edd75ab38", "url": "https://github.com/line/armeria/commit/b680481ac686ab570755df93f7015c6edd75ab38", "message": "Use an upgrade request for cleartext HTTP/2 connections\n\nMotivation:\n\nBy default, Armeria client currently sends an HTTP/2 connection preface\nimmediately for a cleartext HTTP/2 connection.\n\n- Although this works for most HTTP servers, it sometimes does not.\n- HTTP/2 RFC recommends sending an `OPTIONS * HTTP/1.1` request with\n  `Upgrade: h2c` header for cleartext HTTP/2 connections.\n\nModifications:\n\n- Disable `Flags.defaultUseHttp2Preface` by default.\n- Fix a bug where `unfinishedResponses` becomes a negative value when\n  `useHttp2Preface` is `false`.\n\nResult:\n\n- Better compatibility with HTTP/1 servers.\n- Faithful to HTTP/2 RFC recommendations\n- Client-side idle connection timeout works as expected when\n  `useHttp2Preface` is `false`.\n- Closes #1891", "committedDate": "2020-06-29T05:41:36Z", "type": "commit"}, {"oid": "b680481ac686ab570755df93f7015c6edd75ab38", "url": "https://github.com/line/armeria/commit/b680481ac686ab570755df93f7015c6edd75ab38", "message": "Use an upgrade request for cleartext HTTP/2 connections\n\nMotivation:\n\nBy default, Armeria client currently sends an HTTP/2 connection preface\nimmediately for a cleartext HTTP/2 connection.\n\n- Although this works for most HTTP servers, it sometimes does not.\n- HTTP/2 RFC recommends sending an `OPTIONS * HTTP/1.1` request with\n  `Upgrade: h2c` header for cleartext HTTP/2 connections.\n\nModifications:\n\n- Disable `Flags.defaultUseHttp2Preface` by default.\n- Fix a bug where `unfinishedResponses` becomes a negative value when\n  `useHttp2Preface` is `false`.\n\nResult:\n\n- Better compatibility with HTTP/1 servers.\n- Faithful to HTTP/2 RFC recommendations\n- Client-side idle connection timeout works as expected when\n  `useHttp2Preface` is `false`.\n- Closes #1891", "committedDate": "2020-06-29T05:41:36Z", "type": "forcePushed"}, {"oid": "e41dc4bef86b946cc00db799a5eeceebf76aae5d", "url": "https://github.com/line/armeria/commit/e41dc4bef86b946cc00db799a5eeceebf76aae5d", "message": "Enable HTTP/2 preface for `BraveClientIntegrationTest`\n\n.. because `MockWebServer` doesn't support upgrade requests.", "committedDate": "2020-06-29T09:49:26Z", "type": "commit"}, {"oid": "e41dc4bef86b946cc00db799a5eeceebf76aae5d", "url": "https://github.com/line/armeria/commit/e41dc4bef86b946cc00db799a5eeceebf76aae5d", "message": "Enable HTTP/2 preface for `BraveClientIntegrationTest`\n\n.. because `MockWebServer` doesn't support upgrade requests.", "committedDate": "2020-06-29T09:49:26Z", "type": "forcePushed"}, {"oid": "2f40c807348e52597b07cb05368c9d399b063ca7", "url": "https://github.com/line/armeria/commit/2f40c807348e52597b07cb05368c9d399b063ca7", "message": "Work around the issues with `com.sun.net.httpserver`", "committedDate": "2020-06-29T11:30:16Z", "type": "commit"}, {"oid": "4f218bf7975993ec5980f1811a28708586dc463d", "url": "https://github.com/line/armeria/commit/4f218bf7975993ec5980f1811a28708586dc463d", "message": "Revert the default value", "committedDate": "2020-06-29T12:49:58Z", "type": "commit"}, {"oid": "4f218bf7975993ec5980f1811a28708586dc463d", "url": "https://github.com/line/armeria/commit/4f218bf7975993ec5980f1811a28708586dc463d", "message": "Revert the default value", "committedDate": "2020-06-29T12:49:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk4NzM1Mg==", "url": "https://github.com/line/armeria/pull/2849#discussion_r446987352", "bodyText": "sends preface?", "author": "minwoox", "createdAt": "2020-06-29T13:51:18Z", "path": "core/src/main/java/com/linecorp/armeria/common/Flags.java", "diffHunk": "@@ -724,7 +744,14 @@ public static int defaultHttp1MaxChunkSize() {\n \n     /**\n      * Returns the default value of the {@link ClientFactoryBuilder#useHttp2Preface(boolean)} option.\n-     * Note that this value has effect only if a user did not specify it.\n+     * If enabled, the HTTP/2 connection preface immediately for a cleartext HTTP/2 connection, reducing", "originalCommit": "4f218bf7975993ec5980f1811a28708586dc463d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM1NDQzMw==", "url": "https://github.com/line/armeria/pull/2849#discussion_r447354433", "bodyText": "Done :-)", "author": "trustin", "createdAt": "2020-06-30T01:31:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk4NzM1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "52be092d6545e75a9a96f3c285dc4c69eccb8c3c", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/common/Flags.java b/core/src/main/java/com/linecorp/armeria/common/Flags.java\nindex e0850c201..be50076c0 100644\n--- a/core/src/main/java/com/linecorp/armeria/common/Flags.java\n+++ b/core/src/main/java/com/linecorp/armeria/common/Flags.java\n\n@@ -744,8 +744,8 @@ public final class Flags {\n \n     /**\n      * Returns the default value of the {@link ClientFactoryBuilder#useHttp2Preface(boolean)} option.\n-     * If enabled, the HTTP/2 connection preface immediately for a cleartext HTTP/2 connection, reducing\n-     * an extra round trip incurred by the {@code OPTIONS * HTTP/1.1} upgrade request.\n+     * If enabled, the HTTP/2 connection preface is sent immediately for a cleartext HTTP/2 connection,\n+     * reducing an extra round trip incurred by the {@code OPTIONS * HTTP/1.1} upgrade request.\n      * If disabled, the {@code OPTIONS * HTTP/1.1} request with {@code \"Upgrade: h2c\"} header is sent for\n      * a cleartext HTTP/2 connection. Consider disabling this flag if your HTTP servers have issues\n      * handling or rejecting the HTTP/2 connection preface without a upgrade request.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk4ODU0Nw==", "url": "https://github.com/line/armeria/pull/2849#discussion_r446988547", "bodyText": "Thanks!", "author": "minwoox", "createdAt": "2020-06-29T13:52:57Z", "path": "eureka/src/test/java/com/linecorp/armeria/client/eureka/ArmeriaEurekaClientTest.java", "diffHunk": "@@ -63,17 +63,32 @@\n \n     @Override\n     protected EurekaHttpClient getEurekaHttpClient(URI serviceURI) {\n-        return new EurekaHttpClientWrapper(WebClient.of(serviceURI));\n+        return new EurekaHttpClientWrapper(WebClient.of(toH1C(serviceURI)));\n     }\n \n     @Override\n     protected EurekaHttpClient getEurekaClientWithBasicAuthentication(String userName, String password) {\n-        final WebClient webClient = WebClient.builder(getHttpServer().getServiceURI())\n+        final WebClient webClient = WebClient.builder(toH1C(getHttpServer().getServiceURI()))\n                                              .auth(BasicToken.of(userName, password))\n                                              .build();\n         return new EurekaHttpClientWrapper(webClient);\n     }\n \n+    private static String toH1C(URI serviceURI) {", "originalCommit": "4f218bf7975993ec5980f1811a28708586dc463d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk5MDMxMQ==", "url": "https://github.com/line/armeria/pull/2849#discussion_r446990311", "bodyText": "Let's move this comment one line down. \ud83d\ude04", "author": "minwoox", "createdAt": "2020-06-29T13:55:27Z", "path": "core/src/main/java/com/linecorp/armeria/client/HttpClientPipelineConfigurator.java", "diffHunk": "@@ -441,6 +441,7 @@ public void onComplete() {}\n             }, ctx.channel().eventLoop());\n \n             // NB: No need to set the response timeout because we have session creation timeout.", "originalCommit": "4f218bf7975993ec5980f1811a28708586dc463d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM1NDQ1OA==", "url": "https://github.com/line/armeria/pull/2849#discussion_r447354458", "bodyText": "and done!", "author": "trustin", "createdAt": "2020-06-30T01:31:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk5MDMxMQ=="}], "type": "inlineReview", "revised_code": {"commit": "611784d30ec576cc59a4988ad8f81857c3b1a044", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/HttpClientPipelineConfigurator.java b/core/src/main/java/com/linecorp/armeria/client/HttpClientPipelineConfigurator.java\nindex deda13a68..e291fb017 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/HttpClientPipelineConfigurator.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/HttpClientPipelineConfigurator.java\n\n@@ -440,8 +440,8 @@ final class HttpClientPipelineConfigurator extends ChannelDuplexHandler {\n                 public void onComplete() {}\n             }, ctx.channel().eventLoop());\n \n-            // NB: No need to set the response timeout because we have session creation timeout.\n             responseDecoder.reserveUnfinishedResponse(Integer.MAX_VALUE);\n+            // NB: No need to set the response timeout because we have session creation timeout.\n             responseDecoder.addResponse(0, res, null, ctx.channel().eventLoop(), /* response timeout */ 0,\n                                         UPGRADE_RESPONSE_MAX_LENGTH);\n             ctx.fireChannelActive();\n"}}, {"oid": "52be092d6545e75a9a96f3c285dc4c69eccb8c3c", "url": "https://github.com/line/armeria/commit/52be092d6545e75a9a96f3c285dc4c69eccb8c3c", "message": "Address the comment from @minwoox", "committedDate": "2020-06-30T01:30:03Z", "type": "commit"}, {"oid": "611784d30ec576cc59a4988ad8f81857c3b1a044", "url": "https://github.com/line/armeria/commit/611784d30ec576cc59a4988ad8f81857c3b1a044", "message": "Address the 2nd comment from @minwoox", "committedDate": "2020-06-30T01:30:37Z", "type": "commit"}, {"oid": "491985a2c6ab3a77c715e639c2c53e6bd753231f", "url": "https://github.com/line/armeria/commit/491985a2c6ab3a77c715e639c2c53e6bd753231f", "message": "Merge branch 'master' into use_upgrade_request", "committedDate": "2020-06-30T01:56:18Z", "type": "commit"}]}