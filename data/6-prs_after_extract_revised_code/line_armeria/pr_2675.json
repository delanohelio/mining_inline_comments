{"pr_number": 2675, "pr_title": "Distinguish initialization and state changes of circuit breaker", "pr_createdAt": "2020-04-23T07:28:25Z", "pr_url": "https://github.com/line/armeria/pull/2675", "timeline": [{"oid": "14c8ca60fd31036605890ebc52bd4339811ad859", "url": "https://github.com/line/armeria/commit/14c8ca60fd31036605890ebc52bd4339811ad859", "message": "Distinguish initialization and state changes of circuit breaker", "committedDate": "2020-04-23T07:19:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzU4MTY4Mw==", "url": "https://github.com/line/armeria/pull/2675#discussion_r413581683", "bodyText": "a -> an", "author": "minwoox", "createdAt": "2020-04-23T07:36:36Z", "path": "core/src/main/java/com/linecorp/armeria/client/circuitbreaker/NonBlockingCircuitBreaker.java", "diffHunk": "@@ -176,6 +176,17 @@ private void logStateTransition(CircuitState circuitState, @Nullable EventCount\n         }\n     }\n \n+    private void notifyInitialized() {\n+        config.listeners().forEach(listener -> {\n+            try {\n+                listener.onInitialized(name());\n+            } catch (Throwable t) {\n+                logger.warn(\"An error occurred when notifying a Initialized event\", t);", "originalCommit": "14c8ca60fd31036605890ebc52bd4339811ad859", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzU5NjkwMw==", "url": "https://github.com/line/armeria/pull/2675#discussion_r413596903", "bodyText": "Fixed \ud83d\ude01", "author": "ghkim3221", "createdAt": "2020-04-23T07:58:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzU4MTY4Mw=="}], "type": "inlineReview", "revised_code": {"commit": "4a01dc51ab121f3466d5a4c6d104a3e6d0b48788", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/circuitbreaker/NonBlockingCircuitBreaker.java b/core/src/main/java/com/linecorp/armeria/client/circuitbreaker/NonBlockingCircuitBreaker.java\nindex 84c2650a70..a9b69a6bad 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/circuitbreaker/NonBlockingCircuitBreaker.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/circuitbreaker/NonBlockingCircuitBreaker.java\n\n@@ -181,7 +181,7 @@ final class NonBlockingCircuitBreaker implements CircuitBreaker {\n             try {\n                 listener.onInitialized(name());\n             } catch (Throwable t) {\n-                logger.warn(\"An error occurred when notifying a Initialized event\", t);\n+                logger.warn(\"An error occurred when notifying an Initialized event\", t);\n             }\n             notifyCountUpdated(listener, EventCount.ZERO);\n         });\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzU4MTc0OQ==", "url": "https://github.com/line/armeria/pull/2675#discussion_r413581749", "bodyText": "Let's add a little description that the state is Closed when this is invoked.", "author": "minwoox", "createdAt": "2020-04-23T07:36:42Z", "path": "core/src/main/java/com/linecorp/armeria/client/circuitbreaker/CircuitBreakerListener.java", "diffHunk": "@@ -21,6 +21,11 @@\n  */\n public interface CircuitBreakerListener {\n \n+    /**\n+     * Invoked when the circuit breaker is initialized.", "originalCommit": "14c8ca60fd31036605890ebc52bd4339811ad859", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzU5NjY0NQ==", "url": "https://github.com/line/armeria/pull/2675#discussion_r413596645", "bodyText": "Added Initial state is always CLOSED. \ud83d\ude01", "author": "ghkim3221", "createdAt": "2020-04-23T07:58:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzU4MTc0OQ=="}], "type": "inlineReview", "revised_code": {"commit": "af46dfdf5de335804f216967571da0da994cba61", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/circuitbreaker/CircuitBreakerListener.java b/core/src/main/java/com/linecorp/armeria/client/circuitbreaker/CircuitBreakerListener.java\nindex b24fb77cea..bad2cd6447 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/circuitbreaker/CircuitBreakerListener.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/circuitbreaker/CircuitBreakerListener.java\n\n@@ -23,6 +23,7 @@ public interface CircuitBreakerListener {\n \n     /**\n      * Invoked when the circuit breaker is initialized.\n+     * Initial state is always CLOSED.\n      */\n     void onInitialized(String circuitBreakerName) throws Exception;\n \n"}}, {"oid": "4e58ceae3865fd97c26d911dffbca0c3dfbf1de1", "url": "https://github.com/line/armeria/commit/4e58ceae3865fd97c26d911dffbca0c3dfbf1de1", "message": "Fix and add test cases", "committedDate": "2020-04-23T07:39:42Z", "type": "commit"}, {"oid": "4a01dc51ab121f3466d5a4c6d104a3e6d0b48788", "url": "https://github.com/line/armeria/commit/4a01dc51ab121f3466d5a4c6d104a3e6d0b48788", "message": "Fix typo", "committedDate": "2020-04-23T07:39:49Z", "type": "commit"}, {"oid": "af46dfdf5de335804f216967571da0da994cba61", "url": "https://github.com/line/armeria/commit/af46dfdf5de335804f216967571da0da994cba61", "message": "Add little description that initial state is always CLOSED", "committedDate": "2020-04-23T07:43:31Z", "type": "commit"}, {"oid": "22f8b985d58f5996cb2c0ea8c88d34d281666c5b", "url": "https://github.com/line/armeria/commit/22f8b985d58f5996cb2c0ea8c88d34d281666c5b", "message": "Add default method", "committedDate": "2020-04-23T08:11:54Z", "type": "commit"}, {"oid": "5c10cd892858c7cd98a2c98f745a87877247bfda", "url": "https://github.com/line/armeria/commit/5c10cd892858c7cd98a2c98f745a87877247bfda", "message": "Revert onInitialized in metrics", "committedDate": "2020-04-23T08:16:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY4NjIzMw==", "url": "https://github.com/line/armeria/pull/2675#discussion_r413686233", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Initial state is always CLOSED.\n          \n          \n            \n                 * The initial state is always {@link CircuitState.CLOSED}.", "author": "ikhoon", "createdAt": "2020-04-23T10:06:25Z", "path": "core/src/main/java/com/linecorp/armeria/client/circuitbreaker/CircuitBreakerListener.java", "diffHunk": "@@ -21,6 +21,14 @@\n  */\n public interface CircuitBreakerListener {\n \n+    /**\n+     * Invoked when the circuit breaker is initialized.\n+     * Initial state is always CLOSED.", "originalCommit": "5c10cd892858c7cd98a2c98f745a87877247bfda", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzc0NTE0Mg==", "url": "https://github.com/line/armeria/pull/2675#discussion_r413745142", "bodyText": "Changed \ud83d\ude01", "author": "ghkim3221", "createdAt": "2020-04-23T11:43:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY4NjIzMw=="}], "type": "inlineReview", "revised_code": {"commit": "63d5f107a61310b164bff3c5933de82ce170246b", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/circuitbreaker/CircuitBreakerListener.java b/core/src/main/java/com/linecorp/armeria/client/circuitbreaker/CircuitBreakerListener.java\nindex 767bd10e80..0c9864090c 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/circuitbreaker/CircuitBreakerListener.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/circuitbreaker/CircuitBreakerListener.java\n\n@@ -23,7 +23,7 @@ public interface CircuitBreakerListener {\n \n     /**\n      * Invoked when the circuit breaker is initialized.\n-     * Initial state is always CLOSED.\n+     * The initial state is always {@link CircuitState.CLOSED}.\n      */\n     default void onInitialized(String circuitBreakerName) throws Exception {\n         onStateChanged(circuitBreakerName, CircuitState.CLOSED);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY4NjQxNw==", "url": "https://github.com/line/armeria/pull/2675#discussion_r413686417", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void onInitialized(String circuitBreakerName) throws Exception { }\n          \n          \n            \n                public void onInitialized(String circuitBreakerName) throws Exception {}", "author": "ikhoon", "createdAt": "2020-04-23T10:06:41Z", "path": "core/src/main/java/com/linecorp/armeria/client/circuitbreaker/CircuitBreakerListenerAdapter.java", "diffHunk": "@@ -22,6 +22,9 @@\n  */\n public class CircuitBreakerListenerAdapter implements CircuitBreakerListener {\n \n+    @Override\n+    public void onInitialized(String circuitBreakerName) throws Exception { }", "originalCommit": "5c10cd892858c7cd98a2c98f745a87877247bfda", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzc0NTI3Ng==", "url": "https://github.com/line/armeria/pull/2675#discussion_r413745276", "bodyText": "Fixed \ud83d\ude01", "author": "ghkim3221", "createdAt": "2020-04-23T11:44:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY4NjQxNw=="}], "type": "inlineReview", "revised_code": {"commit": "63d5f107a61310b164bff3c5933de82ce170246b", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/circuitbreaker/CircuitBreakerListenerAdapter.java b/core/src/main/java/com/linecorp/armeria/client/circuitbreaker/CircuitBreakerListenerAdapter.java\nindex e867711bc0..83caaba81b 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/circuitbreaker/CircuitBreakerListenerAdapter.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/circuitbreaker/CircuitBreakerListenerAdapter.java\n\n@@ -23,7 +23,7 @@ package com.linecorp.armeria.client.circuitbreaker;\n public class CircuitBreakerListenerAdapter implements CircuitBreakerListener {\n \n     @Override\n-    public void onInitialized(String circuitBreakerName) throws Exception { }\n+    public void onInitialized(String circuitBreakerName) throws Exception {}\n \n     @Override\n     public void onStateChanged(String circuitBreakerName, CircuitState state) throws Exception {}\n"}}, {"oid": "63d5f107a61310b164bff3c5933de82ce170246b", "url": "https://github.com/line/armeria/commit/63d5f107a61310b164bff3c5933de82ce170246b", "message": "Apply suggestions", "committedDate": "2020-04-23T11:43:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI2MzAzMw==", "url": "https://github.com/line/armeria/pull/2675#discussion_r414263033", "bodyText": "How about adding CircuitState initialState as the second parameter, so that we can have a different type of circuit, which starts at HALF_OPEN or OPEN?", "author": "trustin", "createdAt": "2020-04-24T03:21:30Z", "path": "core/src/main/java/com/linecorp/armeria/client/circuitbreaker/CircuitBreakerListener.java", "diffHunk": "@@ -21,6 +21,14 @@\n  */\n public interface CircuitBreakerListener {\n \n+    /**\n+     * Invoked when the circuit breaker is initialized.\n+     * The initial state is always {@link CircuitState.CLOSED}.\n+     */\n+    default void onInitialized(String circuitBreakerName) throws Exception {\n+        onStateChanged(circuitBreakerName, CircuitState.CLOSED);\n+    }", "originalCommit": "63d5f107a61310b164bff3c5933de82ce170246b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI2MzIyOQ==", "url": "https://github.com/line/armeria/pull/2675#discussion_r414263229", "bodyText": "Or please let me know if it doesn't make sense, of course. \ud83d\ude04", "author": "trustin", "createdAt": "2020-04-24T03:22:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI2MzAzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQ2NTA1NQ==", "url": "https://github.com/line/armeria/pull/2675#discussion_r415465055", "bodyText": "Yes you right, initialState is more general for other type of circuit.\nThank you. \ud83d\ude01", "author": "ghkim3221", "createdAt": "2020-04-27T02:18:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI2MzAzMw=="}], "type": "inlineReview", "revised_code": {"commit": "7ae4232803d2cc5e1cc80e1a51a40ad9651b0ce5", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/circuitbreaker/CircuitBreakerListener.java b/core/src/main/java/com/linecorp/armeria/client/circuitbreaker/CircuitBreakerListener.java\nindex 0c9864090c..1ff7a3fd62 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/circuitbreaker/CircuitBreakerListener.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/circuitbreaker/CircuitBreakerListener.java\n\n@@ -23,10 +23,9 @@ public interface CircuitBreakerListener {\n \n     /**\n      * Invoked when the circuit breaker is initialized.\n-     * The initial state is always {@link CircuitState.CLOSED}.\n      */\n-    default void onInitialized(String circuitBreakerName) throws Exception {\n-        onStateChanged(circuitBreakerName, CircuitState.CLOSED);\n+    default void onInitialized(String circuitBreakerName, CircuitState initialState) throws Exception {\n+        onStateChanged(circuitBreakerName, initialState);\n     }\n \n     /**\n"}}, {"oid": "7ae4232803d2cc5e1cc80e1a51a40ad9651b0ce5", "url": "https://github.com/line/armeria/commit/7ae4232803d2cc5e1cc80e1a51a40ad9651b0ce5", "message": "Add initialState parameter for generality", "committedDate": "2020-04-27T02:16:43Z", "type": "commit"}]}