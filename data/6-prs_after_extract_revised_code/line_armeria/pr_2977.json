{"pr_number": 2977, "pr_title": "Fix a bug where different tags of WebClient are registered to Prometh\u2026", "pr_createdAt": "2020-08-06T10:10:04Z", "pr_url": "https://github.com/line/armeria/pull/2977", "timeline": [{"oid": "6d865ec5c1911f925af7f8a08f1a1375701bc9da", "url": "https://github.com/line/armeria/commit/6d865ec5c1911f925af7f8a08f1a1375701bc9da", "message": "Fix a bug where different tags of WebClient are registered to Prometheus registry\n\nMotivation:\n\nAfter Armeria introduces serviceName #2780,\nMetricCollecting{Service, Client} is register a service name as a tag if the `RequestLog.serviceName` is not null.\nThe nullable `serviceName` could a problem when a key is registed with different tags.\n\nFor example, a gRPC client that send requests using `com.example.Foo` stub,\nMetricCollectingClient recodes metrics such as `foo_pending_acquisition_duration_seconds`\nwith tags of `http_status`, `method` and `service` whose value is `com.example.Foo`.\nHowever, a WebClient sends requests, it only records the metrics with  `http_status` and `method` tags.\n\nThis could cause problems at Micrometer's Prometheus registry.\n```\nPrometheus requires that all meters with the same name have the same set of tag keys.\nThere is already an existing meter named 'armeria_client_pending_acquisition_duration_seconds' containing tag keys [http_status, method].\nThe meter you are attempting to register has keys [http_status, method, service].\n```\n\nModifications:\n- Add 'none' to the value of `service` tag if `RequestLog.serviceName()` is null.\n\nResult:\n\nA Prometheous registry does not throw an IAE, when you register a metric prefix key to the heterogeneous clients.", "committedDate": "2020-08-06T09:47:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMxMTEwMw==", "url": "https://github.com/line/armeria/pull/2977#discussion_r466311103", "bodyText": "Could use firstNonNull", "author": "trustin", "createdAt": "2020-08-06T10:14:50Z", "path": "core/src/main/java/com/linecorp/armeria/common/metric/MeterIdPrefixFunction.java", "diffHunk": "@@ -105,10 +105,12 @@ private void buildTags(ImmutableList.Builder<Tag> tagListBuilder, RequestOnlyLog\n                     methodName = requestHeaders.method().name();\n                 }\n                 tagListBuilder.add(Tag.of(\"method\", methodName));\n-                final String serviceName = log.serviceName();\n-                if (serviceName != null) {\n-                    tagListBuilder.add(Tag.of(\"service\", serviceName));\n+\n+                String serviceName = log.serviceName();\n+                if (serviceName == null) {\n+                    serviceName = \"none\";\n                 }", "originalCommit": "6d865ec5c1911f925af7f8a08f1a1375701bc9da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMxMjI1OQ==", "url": "https://github.com/line/armeria/pull/2977#discussion_r466312259", "bodyText": "Nice suggestion!", "author": "ikhoon", "createdAt": "2020-08-06T10:17:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMxMTEwMw=="}], "type": "inlineReview", "revised_code": {"commit": "b432b883543b58e04f105a9325d960a48b50f6a9", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/common/metric/MeterIdPrefixFunction.java b/core/src/main/java/com/linecorp/armeria/common/metric/MeterIdPrefixFunction.java\nindex 2548139704..bc2cbb7fe3 100644\n--- a/core/src/main/java/com/linecorp/armeria/common/metric/MeterIdPrefixFunction.java\n+++ b/core/src/main/java/com/linecorp/armeria/common/metric/MeterIdPrefixFunction.java\n\n@@ -106,10 +107,7 @@ public interface MeterIdPrefixFunction {\n                 }\n                 tagListBuilder.add(Tag.of(\"method\", methodName));\n \n-                String serviceName = log.serviceName();\n-                if (serviceName == null) {\n-                    serviceName = \"none\";\n-                }\n+                final String serviceName = firstNonNull(log.serviceName(), \"none\");\n                 tagListBuilder.add(Tag.of(\"service\", serviceName));\n             }\n         };\n"}}, {"oid": "b432b883543b58e04f105a9325d960a48b50f6a9", "url": "https://github.com/line/armeria/commit/b432b883543b58e04f105a9325d960a48b50f6a9", "message": "Address comments by @trustin", "committedDate": "2020-08-06T10:18:17Z", "type": "commit"}, {"oid": "937301e47264a6ec8f4dbd0d01f625da88ed4cea", "url": "https://github.com/line/armeria/commit/937301e47264a6ec8f4dbd0d01f625da88ed4cea", "message": "Remove missed `@Nullable`", "committedDate": "2020-08-06T10:21:08Z", "type": "commit"}, {"oid": "e809183635588aab46b8db458360676adedc6187", "url": "https://github.com/line/armeria/commit/e809183635588aab46b8db458360676adedc6187", "message": "Checkstyle", "committedDate": "2020-08-06T10:44:37Z", "type": "commit"}, {"oid": "afaf0fc8f8407b426491664b30061c329a1a1f56", "url": "https://github.com/line/armeria/commit/afaf0fc8f8407b426491664b30061c329a1a1f56", "message": "Fix broken tests", "committedDate": "2020-08-07T02:22:34Z", "type": "commit"}]}