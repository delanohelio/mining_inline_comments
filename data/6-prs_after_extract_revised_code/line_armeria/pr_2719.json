{"pr_number": 2719, "pr_title": "Support gRPC Scala using ScalaPB", "pr_createdAt": "2020-05-17T14:44:07Z", "pr_url": "https://github.com/line/armeria/pull/2719", "timeline": [{"oid": "a546f575049e458a23d436d25538ce61f96210ba", "url": "https://github.com/line/armeria/commit/a546f575049e458a23d436d25538ce61f96210ba", "message": "Support gRPC Scala using ScalaPB\n\nMotivation:\n\nAs a part of better interop with other JVM languages(#1078),\nit would be nice if Armeria Grpc server and client support [ScalaPB](https://scalapb.github.io/).\n\nNotifications:\n\n- Rename the original `GrpcMessageMashaller` to `GrpcMessageMashallingHandler`.\n- Introduce a new interface `GrpcMessageMashaller`. A user can customize\n `GrpcMessageMashaller` by setting it to GrpcServerBuilder or GrpcClientOptions.\n  I'm not sure this approach is the right direction. \ud83e\uddd0\n- Add ScalaPBMessageMashaller.\n  Note, It is hard to support releasing an artifact with multiple Scala versions in Gradle.\n  Do we need to move this code to Armeria `contrib`?\n\nResult:\n\nYou can now use the gRPC server/client stubs generated by ScalaPB", "committedDate": "2020-05-17T14:49:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNDQxNQ==", "url": "https://github.com/line/armeria/pull/2719#discussion_r426334415", "bodyText": "to the specified -> with the specified", "author": "trustin", "createdAt": "2020-05-18T01:46:53Z", "path": "grpc/src/main/java/com/linecorp/armeria/client/grpc/GrpcClientOptions.java", "diffHunk": "@@ -76,11 +83,27 @@\n     public static final ClientOption<Boolean> UNSAFE_WRAP_RESPONSE_BUFFERS =\n             ClientOption.define(\"GRPC_UNSAFE_WRAP_RESPONSE_BUFFERS\", false);\n \n+    /**\n+     * Sets a {@link GrpcMessageMarshaller} that serialize and deserialize request or response messages\n+     * to and from {@link ByteBuf}. This replaces the built-in {@link GrpcMessageMarshaller} to the specified", "originalCommit": "a546f575049e458a23d436d25538ce61f96210ba", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "122c47ee6d71e8b31422e4aa2e73e897e5136ebd", "chunk": "diff --git a/grpc/src/main/java/com/linecorp/armeria/client/grpc/GrpcClientOptions.java b/grpc/src/main/java/com/linecorp/armeria/client/grpc/GrpcClientOptions.java\nindex 315b1ff421..3d88145d82 100644\n--- a/grpc/src/main/java/com/linecorp/armeria/client/grpc/GrpcClientOptions.java\n+++ b/grpc/src/main/java/com/linecorp/armeria/client/grpc/GrpcClientOptions.java\n\n@@ -84,26 +81,25 @@ public final class GrpcClientOptions {\n             ClientOption.define(\"GRPC_UNSAFE_WRAP_RESPONSE_BUFFERS\", false);\n \n     /**\n-     * Sets a {@link GrpcMessageMarshaller} that serialize and deserialize request or response messages\n-     * to and from {@link ByteBuf}. This replaces the built-in {@link GrpcMessageMarshaller} to the specified\n-     * {@link GrpcMessageMarshaller}.\n+     * Sets a {@link GrpcJsonMarshaller} that serialize and deserialize request or response messages\n+     * to and from JSON depending on {@link SerializationFormat}. This replaces the built-in\n+     * {@link GrpcJsonMarshaller} with the specified {@link GrpcJsonMarshaller}.\n      *\n-     * This is commonly used to optimize code paths for a subclass of {@link Marshaller} or enable to handle\n-     * {@link GrpcSerializationFormats#JSON} and {@link GrpcSerializationFormats#JSON_WEB} formats by\n-     * marshalling a message to and from JSON depending on {@link SerializationFormat}.\n+     * <p>This is commonly used to marshall non-{@link Message} types such as {@code scalapb.GeneratedMessage}\n+     * for Scala and {@code pbandk.Message} for Kotlin.\n      *\n-     * Note that this option is configured, {@link #JSON_MARSHALLER_CUSTOMIZER} option will be ignored.\n+     * <p>Note that {@link #JSON_MARSHALLER_CUSTOMIZER} option will be ignored if this option is set.\n      */\n-    public static final ClientOption<GrpcMessageMarshaller> GRPC_MESSAGE_MARSHALLER =\n-            ClientOption.define(\"GRPC_MESSAGE_MARSHALLER\", NoopGrpcMessageMarshaller.get());\n+    public static final ClientOption<GrpcJsonMarshaller> GRPC_JSON_MARSHALLER =\n+            ClientOption.define(\"GRPC_JSON_MARSHALLER\", NoopJsonMarshaller.get());\n \n     /**\n-     * Sets a {@link Consumer} that can customize the JSON marshaller used when handling JSON payloads in the\n-     * service. This is commonly used to switch from the default of using lowerCamelCase for field names to\n-     * using the field name from the proto definition, by setting\n+     * Sets a {@link Consumer} that can customize the JSON marshaller for {@link Message} used when handling\n+     * JSON payloads in the service. This is commonly used to switch from the default of using lowerCamelCase\n+     * for field names to using the field name from the proto definition, by setting\n      * {@link MessageMarshaller.Builder#preservingProtoFieldNames(boolean)}.\n      *\n-     * Note that a {@link #GRPC_MESSAGE_MARSHALLER} is configured, this option will be ignored.\n+     * <p>Note that this option will be ignored if {@link #GRPC_JSON_MARSHALLER} is set.\n      */\n     public static final ClientOption<Consumer<MessageMarshaller.Builder>> JSON_MARSHALLER_CUSTOMIZER =\n             ClientOption.define(\"GRPC_JSON_MARSHALLER_CUSTOMIZER\", unused -> { /* no-op */ });\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNDU1MA==", "url": "https://github.com/line/armeria/pull/2719#discussion_r426334550", "bodyText": "Note that JSON_MAR... option will be ignored if this option is set.", "author": "trustin", "createdAt": "2020-05-18T01:47:38Z", "path": "grpc/src/main/java/com/linecorp/armeria/client/grpc/GrpcClientOptions.java", "diffHunk": "@@ -76,11 +83,27 @@\n     public static final ClientOption<Boolean> UNSAFE_WRAP_RESPONSE_BUFFERS =\n             ClientOption.define(\"GRPC_UNSAFE_WRAP_RESPONSE_BUFFERS\", false);\n \n+    /**\n+     * Sets a {@link GrpcMessageMarshaller} that serialize and deserialize request or response messages\n+     * to and from {@link ByteBuf}. This replaces the built-in {@link GrpcMessageMarshaller} to the specified\n+     * {@link GrpcMessageMarshaller}.\n+     *\n+     * This is commonly used to optimize code paths for a subclass of {@link Marshaller} or enable to handle\n+     * {@link GrpcSerializationFormats#JSON} and {@link GrpcSerializationFormats#JSON_WEB} formats by\n+     * marshalling a message to and from JSON depending on {@link SerializationFormat}.\n+     *\n+     * Note that this option is configured, {@link #JSON_MARSHALLER_CUSTOMIZER} option will be ignored.", "originalCommit": "a546f575049e458a23d436d25538ce61f96210ba", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "122c47ee6d71e8b31422e4aa2e73e897e5136ebd", "chunk": "diff --git a/grpc/src/main/java/com/linecorp/armeria/client/grpc/GrpcClientOptions.java b/grpc/src/main/java/com/linecorp/armeria/client/grpc/GrpcClientOptions.java\nindex 315b1ff421..3d88145d82 100644\n--- a/grpc/src/main/java/com/linecorp/armeria/client/grpc/GrpcClientOptions.java\n+++ b/grpc/src/main/java/com/linecorp/armeria/client/grpc/GrpcClientOptions.java\n\n@@ -84,26 +81,25 @@ public final class GrpcClientOptions {\n             ClientOption.define(\"GRPC_UNSAFE_WRAP_RESPONSE_BUFFERS\", false);\n \n     /**\n-     * Sets a {@link GrpcMessageMarshaller} that serialize and deserialize request or response messages\n-     * to and from {@link ByteBuf}. This replaces the built-in {@link GrpcMessageMarshaller} to the specified\n-     * {@link GrpcMessageMarshaller}.\n+     * Sets a {@link GrpcJsonMarshaller} that serialize and deserialize request or response messages\n+     * to and from JSON depending on {@link SerializationFormat}. This replaces the built-in\n+     * {@link GrpcJsonMarshaller} with the specified {@link GrpcJsonMarshaller}.\n      *\n-     * This is commonly used to optimize code paths for a subclass of {@link Marshaller} or enable to handle\n-     * {@link GrpcSerializationFormats#JSON} and {@link GrpcSerializationFormats#JSON_WEB} formats by\n-     * marshalling a message to and from JSON depending on {@link SerializationFormat}.\n+     * <p>This is commonly used to marshall non-{@link Message} types such as {@code scalapb.GeneratedMessage}\n+     * for Scala and {@code pbandk.Message} for Kotlin.\n      *\n-     * Note that this option is configured, {@link #JSON_MARSHALLER_CUSTOMIZER} option will be ignored.\n+     * <p>Note that {@link #JSON_MARSHALLER_CUSTOMIZER} option will be ignored if this option is set.\n      */\n-    public static final ClientOption<GrpcMessageMarshaller> GRPC_MESSAGE_MARSHALLER =\n-            ClientOption.define(\"GRPC_MESSAGE_MARSHALLER\", NoopGrpcMessageMarshaller.get());\n+    public static final ClientOption<GrpcJsonMarshaller> GRPC_JSON_MARSHALLER =\n+            ClientOption.define(\"GRPC_JSON_MARSHALLER\", NoopJsonMarshaller.get());\n \n     /**\n-     * Sets a {@link Consumer} that can customize the JSON marshaller used when handling JSON payloads in the\n-     * service. This is commonly used to switch from the default of using lowerCamelCase for field names to\n-     * using the field name from the proto definition, by setting\n+     * Sets a {@link Consumer} that can customize the JSON marshaller for {@link Message} used when handling\n+     * JSON payloads in the service. This is commonly used to switch from the default of using lowerCamelCase\n+     * for field names to using the field name from the proto definition, by setting\n      * {@link MessageMarshaller.Builder#preservingProtoFieldNames(boolean)}.\n      *\n-     * Note that a {@link #GRPC_MESSAGE_MARSHALLER} is configured, this option will be ignored.\n+     * <p>Note that this option will be ignored if {@link #GRPC_JSON_MARSHALLER} is set.\n      */\n     public static final ClientOption<Consumer<MessageMarshaller.Builder>> JSON_MARSHALLER_CUSTOMIZER =\n             ClientOption.define(\"GRPC_JSON_MARSHALLER_CUSTOMIZER\", unused -> { /* no-op */ });\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNDY2Mw==", "url": "https://github.com/line/armeria/pull/2719#discussion_r426334663", "bodyText": "Note that this option will be ignored if GRPC_MESSAGE... is set.", "author": "trustin", "createdAt": "2020-05-18T01:48:15Z", "path": "grpc/src/main/java/com/linecorp/armeria/client/grpc/GrpcClientOptions.java", "diffHunk": "@@ -76,11 +83,27 @@\n     public static final ClientOption<Boolean> UNSAFE_WRAP_RESPONSE_BUFFERS =\n             ClientOption.define(\"GRPC_UNSAFE_WRAP_RESPONSE_BUFFERS\", false);\n \n+    /**\n+     * Sets a {@link GrpcMessageMarshaller} that serialize and deserialize request or response messages\n+     * to and from {@link ByteBuf}. This replaces the built-in {@link GrpcMessageMarshaller} to the specified\n+     * {@link GrpcMessageMarshaller}.\n+     *\n+     * This is commonly used to optimize code paths for a subclass of {@link Marshaller} or enable to handle\n+     * {@link GrpcSerializationFormats#JSON} and {@link GrpcSerializationFormats#JSON_WEB} formats by\n+     * marshalling a message to and from JSON depending on {@link SerializationFormat}.\n+     *\n+     * Note that this option is configured, {@link #JSON_MARSHALLER_CUSTOMIZER} option will be ignored.\n+     */\n+    public static final ClientOption<GrpcMessageMarshaller> GRPC_MESSAGE_MARSHALLER =\n+            ClientOption.define(\"GRPC_MESSAGE_MARSHALLER\", NoopGrpcMessageMarshaller.get());\n+\n     /**\n      * Sets a {@link Consumer} that can customize the JSON marshaller used when handling JSON payloads in the\n      * service. This is commonly used to switch from the default of using lowerCamelCase for field names to\n      * using the field name from the proto definition, by setting\n      * {@link MessageMarshaller.Builder#preservingProtoFieldNames(boolean)}.\n+     *\n+     * Note that a {@link #GRPC_MESSAGE_MARSHALLER} is configured, this option will be ignored.", "originalCommit": "a546f575049e458a23d436d25538ce61f96210ba", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "122c47ee6d71e8b31422e4aa2e73e897e5136ebd", "chunk": "diff --git a/grpc/src/main/java/com/linecorp/armeria/client/grpc/GrpcClientOptions.java b/grpc/src/main/java/com/linecorp/armeria/client/grpc/GrpcClientOptions.java\nindex 315b1ff421..3d88145d82 100644\n--- a/grpc/src/main/java/com/linecorp/armeria/client/grpc/GrpcClientOptions.java\n+++ b/grpc/src/main/java/com/linecorp/armeria/client/grpc/GrpcClientOptions.java\n\n@@ -84,26 +81,25 @@ public final class GrpcClientOptions {\n             ClientOption.define(\"GRPC_UNSAFE_WRAP_RESPONSE_BUFFERS\", false);\n \n     /**\n-     * Sets a {@link GrpcMessageMarshaller} that serialize and deserialize request or response messages\n-     * to and from {@link ByteBuf}. This replaces the built-in {@link GrpcMessageMarshaller} to the specified\n-     * {@link GrpcMessageMarshaller}.\n+     * Sets a {@link GrpcJsonMarshaller} that serialize and deserialize request or response messages\n+     * to and from JSON depending on {@link SerializationFormat}. This replaces the built-in\n+     * {@link GrpcJsonMarshaller} with the specified {@link GrpcJsonMarshaller}.\n      *\n-     * This is commonly used to optimize code paths for a subclass of {@link Marshaller} or enable to handle\n-     * {@link GrpcSerializationFormats#JSON} and {@link GrpcSerializationFormats#JSON_WEB} formats by\n-     * marshalling a message to and from JSON depending on {@link SerializationFormat}.\n+     * <p>This is commonly used to marshall non-{@link Message} types such as {@code scalapb.GeneratedMessage}\n+     * for Scala and {@code pbandk.Message} for Kotlin.\n      *\n-     * Note that this option is configured, {@link #JSON_MARSHALLER_CUSTOMIZER} option will be ignored.\n+     * <p>Note that {@link #JSON_MARSHALLER_CUSTOMIZER} option will be ignored if this option is set.\n      */\n-    public static final ClientOption<GrpcMessageMarshaller> GRPC_MESSAGE_MARSHALLER =\n-            ClientOption.define(\"GRPC_MESSAGE_MARSHALLER\", NoopGrpcMessageMarshaller.get());\n+    public static final ClientOption<GrpcJsonMarshaller> GRPC_JSON_MARSHALLER =\n+            ClientOption.define(\"GRPC_JSON_MARSHALLER\", NoopJsonMarshaller.get());\n \n     /**\n-     * Sets a {@link Consumer} that can customize the JSON marshaller used when handling JSON payloads in the\n-     * service. This is commonly used to switch from the default of using lowerCamelCase for field names to\n-     * using the field name from the proto definition, by setting\n+     * Sets a {@link Consumer} that can customize the JSON marshaller for {@link Message} used when handling\n+     * JSON payloads in the service. This is commonly used to switch from the default of using lowerCamelCase\n+     * for field names to using the field name from the proto definition, by setting\n      * {@link MessageMarshaller.Builder#preservingProtoFieldNames(boolean)}.\n      *\n-     * Note that a {@link #GRPC_MESSAGE_MARSHALLER} is configured, this option will be ignored.\n+     * <p>Note that this option will be ignored if {@link #GRPC_JSON_MARSHALLER} is set.\n      */\n     public static final ClientOption<Consumer<MessageMarshaller.Builder>> JSON_MARSHALLER_CUSTOMIZER =\n             ClientOption.define(\"GRPC_JSON_MARSHALLER_CUSTOMIZER\", unused -> { /* no-op */ });\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNDc2Mw==", "url": "https://github.com/line/armeria/pull/2719#discussion_r426334763", "bodyText": "Maybe better using null instead of NoopGrpcMessageMarshaller?", "author": "trustin", "createdAt": "2020-05-18T01:48:57Z", "path": "grpc/src/main/java/com/linecorp/armeria/internal/client/grpc/ArmeriaChannel.java", "diffHunk": "@@ -62,23 +68,31 @@\n     private final MeterRegistry meterRegistry;\n     private final SessionProtocol sessionProtocol;\n     private final SerializationFormat serializationFormat;\n-    @Nullable\n-    private final MessageMarshaller jsonMarshaller;\n+    private final GrpcMessageMarshaller messageMarshaller;\n     private final String advertisedEncodingsHeader;\n \n     ArmeriaChannel(ClientBuilderParams params,\n                    HttpClient httpClient,\n                    MeterRegistry meterRegistry,\n                    SessionProtocol sessionProtocol,\n                    SerializationFormat serializationFormat,\n+                   GrpcMessageMarshaller messageMarshaller,\n                    @Nullable MessageMarshaller jsonMarshaller) {\n         this.params = params;\n         this.httpClient = httpClient;\n         this.meterRegistry = meterRegistry;\n         this.sessionProtocol = sessionProtocol;\n         this.serializationFormat = serializationFormat;\n-        this.jsonMarshaller = jsonMarshaller;\n-\n+        if (messageMarshaller != NoopGrpcMessageMarshaller.get()) {", "originalCommit": "a546f575049e458a23d436d25538ce61f96210ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzODEyNA==", "url": "https://github.com/line/armeria/pull/2719#discussion_r426338124", "bodyText": "I tried at first, but I realized a ClientOption does not take null as a default value.\n// Will throw NullPointerException\nClientOption.define(\"GRPC_MESSAGE_MARSHALLER\", null);\n\n  \n    \n      armeria/core/src/main/java/com/linecorp/armeria/common/util/AbstractOption.java\n    \n    \n        Lines 113 to 118\n      in\n      56c58ff\n    \n    \n    \n    \n\n        \n          \n           T define(Class<?> type, String name, V defaultValue, \n        \n\n        \n          \n                    Factory<T, U, V> optionFactory, Function<V, V> validator, BiFunction<U, U, U> mergeFunction) { \n        \n\n        \n          \n            \n        \n\n        \n          \n               requireNonNull(type, \"type\"); \n        \n\n        \n          \n               requireNonNull(name, \"name\"); \n        \n\n        \n          \n               requireNonNull(defaultValue, \"defaultValue\"); \n        \n    \n  \n\n\nProbably better to make it accept null?", "author": "ikhoon", "createdAt": "2020-05-18T02:09:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNDc2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM0MDE3NA==", "url": "https://github.com/line/armeria/pull/2719#discussion_r426340174", "bodyText": "That's a good point. If we accept null, we will have to add @Nullable to the getter methods which doesn't sound like a good idea. Let's leave this as it is. \ud83d\ude05", "author": "trustin", "createdAt": "2020-05-18T02:21:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNDc2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM0MjE2MQ==", "url": "https://github.com/line/armeria/pull/2719#discussion_r426342161", "bodyText": "Agreed!", "author": "ikhoon", "createdAt": "2020-05-18T02:32:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNDc2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "122c47ee6d71e8b31422e4aa2e73e897e5136ebd", "chunk": "diff --git a/grpc/src/main/java/com/linecorp/armeria/internal/client/grpc/ArmeriaChannel.java b/grpc/src/main/java/com/linecorp/armeria/internal/client/grpc/ArmeriaChannel.java\nindex 5d92b7ff90..0bf63a68b9 100644\n--- a/grpc/src/main/java/com/linecorp/armeria/internal/client/grpc/ArmeriaChannel.java\n+++ b/grpc/src/main/java/com/linecorp/armeria/internal/client/grpc/ArmeriaChannel.java\n\n@@ -68,7 +61,8 @@ final class ArmeriaChannel extends Channel implements ClientBuilderParams, Unwra\n     private final MeterRegistry meterRegistry;\n     private final SessionProtocol sessionProtocol;\n     private final SerializationFormat serializationFormat;\n-    private final GrpcMessageMarshaller messageMarshaller;\n+    @Nullable\n+    private final GrpcJsonMarshaller jsonMarshaller;\n     private final String advertisedEncodingsHeader;\n \n     ArmeriaChannel(ClientBuilderParams params,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNTIwNw==", "url": "https://github.com/line/armeria/pull/2719#discussion_r426335207", "bodyText": "Prototype or Protobuf?\nfinal?", "author": "trustin", "createdAt": "2020-05-18T01:51:21Z", "path": "grpc/src/main/java/com/linecorp/armeria/internal/common/grpc/PrototypeMessageMarshaller.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.common.grpc;\n+\n+import java.io.IOException;\n+\n+import javax.annotation.Nullable;\n+\n+import org.curioswitch.common.protobuf.json.MessageMarshaller;\n+\n+import com.google.protobuf.CodedInputStream;\n+import com.google.protobuf.CodedOutputStream;\n+import com.google.protobuf.InvalidProtocolBufferException;\n+import com.google.protobuf.Message;\n+import com.google.protobuf.UnsafeByteOperations;\n+\n+import com.linecorp.armeria.common.SerializationFormat;\n+import com.linecorp.armeria.common.grpc.GrpcSerializationFormats;\n+\n+import io.grpc.MethodDescriptor.Marshaller;\n+import io.grpc.MethodDescriptor.PrototypeMarshaller;\n+import io.grpc.Status;\n+import io.netty.buffer.ByteBuf;\n+import io.netty.buffer.ByteBufInputStream;\n+import io.netty.buffer.ByteBufOutputStream;\n+\n+/**\n+ * A {@link GrpcMessageMarshaller} for {@link PrototypeMarshaller} that provides optimized code paths\n+ * for a {@link Message}.\n+ */\n+public class PrototypeMessageMarshaller implements GrpcMessageMarshaller {", "originalCommit": "a546f575049e458a23d436d25538ce61f96210ba", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "122c47ee6d71e8b31422e4aa2e73e897e5136ebd", "chunk": "diff --git a/grpc/src/main/java/com/linecorp/armeria/internal/common/grpc/PrototypeMessageMarshaller.java b/grpc/src/main/java/com/linecorp/armeria/internal/common/grpc/PrototypeMessageMarshaller.java\ndeleted file mode 100644\nindex 0604c5dc3b..0000000000\n--- a/grpc/src/main/java/com/linecorp/armeria/internal/common/grpc/PrototypeMessageMarshaller.java\n+++ /dev/null\n\n@@ -1,152 +0,0 @@\n-/*\n- * Copyright 2020 LINE Corporation\n- *\n- * LINE Corporation licenses this file to you under the Apache License,\n- * version 2.0 (the \"License\"); you may not use this file except in compliance\n- * with the License. You may obtain a copy of the License at:\n- *\n- *   https://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n- * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n- * License for the specific language governing permissions and limitations\n- * under the License.\n- */\n-\n-package com.linecorp.armeria.internal.common.grpc;\n-\n-import java.io.IOException;\n-\n-import javax.annotation.Nullable;\n-\n-import org.curioswitch.common.protobuf.json.MessageMarshaller;\n-\n-import com.google.protobuf.CodedInputStream;\n-import com.google.protobuf.CodedOutputStream;\n-import com.google.protobuf.InvalidProtocolBufferException;\n-import com.google.protobuf.Message;\n-import com.google.protobuf.UnsafeByteOperations;\n-\n-import com.linecorp.armeria.common.SerializationFormat;\n-import com.linecorp.armeria.common.grpc.GrpcSerializationFormats;\n-\n-import io.grpc.MethodDescriptor.Marshaller;\n-import io.grpc.MethodDescriptor.PrototypeMarshaller;\n-import io.grpc.Status;\n-import io.netty.buffer.ByteBuf;\n-import io.netty.buffer.ByteBufInputStream;\n-import io.netty.buffer.ByteBufOutputStream;\n-\n-/**\n- * A {@link GrpcMessageMarshaller} for {@link PrototypeMarshaller} that provides optimized code paths\n- * for a {@link Message}.\n- */\n-public class PrototypeMessageMarshaller implements GrpcMessageMarshaller {\n-\n-    @Nullable\n-    private final MessageMarshaller jsonMarshaller;\n-    private final boolean unsafeWrapDeserializedBuffer;\n-\n-    public PrototypeMessageMarshaller(@Nullable MessageMarshaller jsonMarshaller,\n-                                      boolean unsafeWrapDeserializedBuffer) {\n-        this.jsonMarshaller = jsonMarshaller;\n-        this.unsafeWrapDeserializedBuffer = unsafeWrapDeserializedBuffer;\n-    }\n-\n-    @Override\n-    public boolean isSupportedMarshaller(Marshaller<?> marshaller) {\n-        return marshaller instanceof PrototypeMarshaller;\n-    }\n-\n-    @Override\n-    public int serializedSize(Object message) {\n-        return safeCast(message).getSerializedSize();\n-    }\n-\n-    @Override\n-    public <T> void serializeMessage(Marshaller<T> marshaller, SerializationFormat serializationFormat,\n-                                     T message, ByteBuf out) throws IOException {\n-        final Message msg = safeCast(message);\n-        if (GrpcSerializationFormats.isProto(serializationFormat)) {\n-            final int serializedSize = serializedSize(msg);\n-            boolean success = false;\n-            try {\n-                msg.writeTo(CodedOutputStream.newInstance(out.nioBuffer(0, serializedSize)));\n-                out.writerIndex(serializedSize);\n-                success = true;\n-            } finally {\n-                if (!success) {\n-                    out.release();\n-                }\n-            }\n-        } else if (GrpcSerializationFormats.isJson(serializationFormat)) {\n-            boolean success = false;\n-            try (ByteBufOutputStream os = new ByteBufOutputStream(out)) {\n-                jsonMarshaller.writeValue(msg, os);\n-                success = true;\n-            } finally {\n-                if (!success) {\n-                    out.release();\n-                }\n-            }\n-        } else {\n-            throw new IllegalStateException(\"Unknown serialization format: \" + serializationFormat);\n-        }\n-    }\n-\n-    @Override\n-    public <T> T deserializeMessage(Marshaller<T> marshaller, SerializationFormat serializationFormat,\n-                                    ByteBuf in) throws IOException {\n-        final Message prototype = (Message) ((PrototypeMarshaller<?>) marshaller).getMessagePrototype();\n-        @SuppressWarnings(\"unchecked\")\n-        final T message = (T) deserializeProto(in, prototype, serializationFormat);\n-        return message;\n-    }\n-\n-    private Message deserializeProto(ByteBuf buf, Message prototype,\n-                                     SerializationFormat serializationFormat) throws IOException {\n-        if (GrpcSerializationFormats.isProto(serializationFormat)) {\n-            if (!buf.isReadable()) {\n-                return prototype.getDefaultInstanceForType();\n-            }\n-            final CodedInputStream stream;\n-            if (unsafeWrapDeserializedBuffer) {\n-                stream = UnsafeByteOperations.unsafeWrap(buf.nioBuffer()).newCodedInput();\n-                stream.enableAliasing(true);\n-            } else {\n-                stream = CodedInputStream.newInstance(buf.nioBuffer());\n-            }\n-            try {\n-                final Message msg = prototype.getParserForType().parseFrom(stream);\n-                try {\n-                    stream.checkLastTagWas(0);\n-                } catch (InvalidProtocolBufferException e) {\n-                    e.setUnfinishedMessage(msg);\n-                    throw e;\n-                }\n-                return msg;\n-            } catch (InvalidProtocolBufferException e) {\n-                throw Status.INTERNAL.withDescription(\"Invalid protobuf byte sequence\")\n-                                     .withCause(e).asRuntimeException();\n-            }\n-        }\n-\n-        if (GrpcSerializationFormats.isJson(serializationFormat)) {\n-            final Message.Builder builder = prototype.newBuilderForType();\n-            try (ByteBufInputStream is = new ByteBufInputStream(buf, /* releaseOnClose */ false)) {\n-                jsonMarshaller.mergeValue(is, builder);\n-            }\n-            return builder.build();\n-        }\n-        throw new IllegalStateException(\"Unknown serialization format: \" + serializationFormat);\n-    }\n-\n-    private static Message safeCast(Object message) {\n-        if (!(message instanceof Message)) {\n-            throw new IllegalStateException(\"Unexpected message type: \" + message +\n-                                            \" (expected: \" + Message.class + ')');\n-        }\n-        return (Message) message;\n-    }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNTI2Mw==", "url": "https://github.com/line/armeria/pull/2719#discussion_r426335263", "bodyText": "Revert?", "author": "trustin", "createdAt": "2020-05-18T01:51:43Z", "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/FramedGrpcService.java", "diffHunk": "@@ -129,8 +139,8 @@\n         advertisedEncodingsHeader = String.join(\",\", decompressorRegistry.getAdvertisedMessageEncodings());\n \n         defaultHeaders = supportedSerializationFormats\n-                .stream()\n-                .map(format -> {\n+                                 .stream()\n+                                 .map(format -> {", "originalCommit": "a546f575049e458a23d436d25538ce61f96210ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNjQxNg==", "url": "https://github.com/line/armeria/pull/2719#discussion_r426336416", "bodyText": "Oops...", "author": "ikhoon", "createdAt": "2020-05-18T01:58:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNTI2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "122c47ee6d71e8b31422e4aa2e73e897e5136ebd", "chunk": "diff --git a/grpc/src/main/java/com/linecorp/armeria/server/grpc/FramedGrpcService.java b/grpc/src/main/java/com/linecorp/armeria/server/grpc/FramedGrpcService.java\nindex 83a6f480da..9b93c63f5f 100644\n--- a/grpc/src/main/java/com/linecorp/armeria/server/grpc/FramedGrpcService.java\n+++ b/grpc/src/main/java/com/linecorp/armeria/server/grpc/FramedGrpcService.java\n\n@@ -139,8 +133,8 @@ final class FramedGrpcService extends AbstractHttpService implements GrpcService\n         advertisedEncodingsHeader = String.join(\",\", decompressorRegistry.getAdvertisedMessageEncodings());\n \n         defaultHeaders = supportedSerializationFormats\n-                                 .stream()\n-                                 .map(format -> {\n+                .stream()\n+                .map(format -> {\n                     final ResponseHeadersBuilder builder =\n                             ResponseHeaders\n                                     .builder(HttpStatus.OK)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNTMxNQ==", "url": "https://github.com/line/armeria/pull/2719#discussion_r426335315", "bodyText": "serializes and deserialzes", "author": "trustin", "createdAt": "2020-05-18T01:52:04Z", "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java", "diffHunk": "@@ -261,14 +268,36 @@ public GrpcServiceBuilder unsafeWrapRequestBuffers(boolean unsafeWrapRequestBuff\n         return this;\n     }\n \n+    /**\n+     * Sets a {@link GrpcMessageMarshaller} that serialize and deserialize request or response messages", "originalCommit": "a546f575049e458a23d436d25538ce61f96210ba", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "122c47ee6d71e8b31422e4aa2e73e897e5136ebd", "chunk": "diff --git a/grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java b/grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java\nindex 734647eb5a..fc887d6002 100644\n--- a/grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java\n+++ b/grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java\n\n@@ -269,36 +268,35 @@ public final class GrpcServiceBuilder {\n     }\n \n     /**\n-     * Sets a {@link GrpcMessageMarshaller} that serialize and deserialize request or response messages\n-     * to and from {@link ByteBuf}. This replaces the built-in {@link GrpcMessageMarshaller} to the specified\n-     * {@link GrpcMessageMarshaller}.\n+     * Sets a {@link GrpcJsonMarshaller} that serializes and deserializes request or response messages\n+     * to and from JSON depending on {@link SerializationFormat}. This replaces the built-in\n+     * {@link GrpcJsonMarshaller} with the specified {@link GrpcJsonMarshaller}.\n+     * This is commonly used to marshall non-{@link Message} types such as {@code scalapb.GeneratedMessage} for\n+     * Scala and {@code pbandk.Message} for Kotlin.\n      *\n-     * This is commonly used to optimize code paths for a subclass of {@link Marshaller} or enable to handle\n-     * {@link GrpcSerializationFormats#JSON} and {@link GrpcSerializationFormats#JSON_WEB} formats by\n-     * marshalling a message to and from JSON depending on {@link SerializationFormat}.\n-     *\n-     * Note that a {@link #jsonMarshallerCustomizer(Consumer)} is configured,\n-     * this method will throw an {@link IllegalStateException}.\n+     * <p>Note that this method will throw an {@link IllegalStateException}\n+     * if {@link #jsonMarshallerCustomizer(Consumer)} was set.\n      */\n-    public GrpcServiceBuilder messageMarshaller(GrpcMessageMarshaller messageMarshaller) {\n+    public GrpcServiceBuilder jsonMarshaller(GrpcJsonMarshaller jsonMarshaller) {\n         checkState(!isJsonMarshallerCustomizerSet, \"jsonMarshallerCustomizer has been set already.\");\n-        this.messageMarshaller = requireNonNull(messageMarshaller, \"messageMarshaller\");\n+        this.jsonMarshaller = requireNonNull(jsonMarshaller, \"jsonMarshaller\");\n         return this;\n     }\n \n     /**\n-     * Sets a {@link Consumer} that can customize the JSON marshaller used when handling JSON payloads in the\n-     * service. This is commonly used to switch from the default of using lowerCamelCase for field names to\n-     * using the field name from the proto definition, by setting\n+     * Sets a {@link Consumer} that can customize the JSON marshaller for {@link Message} used when\n+     * handling JSON payloads in the service. This is commonly used to switch from the default of using\n+     * lowerCamelCase for field names to using the field name from the proto definition, by setting\n      * {@link MessageMarshaller.Builder#preservingProtoFieldNames(boolean)}.\n      *\n-     * Note that a {@link #messageMarshaller(GrpcMessageMarshaller)} is configured,\n-     * this method will throw an {@link IllegalStateException}.\n+     * <p>Note that this method will throw an {@link IllegalStateException}\n+     * if {@link #jsonMarshaller(GrpcJsonMarshaller)} was set.\n      */\n     public GrpcServiceBuilder jsonMarshallerCustomizer(\n             Consumer<MessageMarshaller.Builder> jsonMarshallerCustomizer) {\n-        checkState(messageMarshaller == null, \"messageMarshaller has been set already.\");\n+        checkState(jsonMarshaller == null, \"jsonMarshaller has been set already.\");\n         this.jsonMarshallerCustomizer = requireNonNull(jsonMarshallerCustomizer, \"jsonMarshallerCustomizer\");\n+        isJsonMarshallerCustomizerSet = true;\n         return this;\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNTM1Ng==", "url": "https://github.com/line/armeria/pull/2719#discussion_r426335356", "bodyText": "with the specified", "author": "trustin", "createdAt": "2020-05-18T01:52:19Z", "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java", "diffHunk": "@@ -261,14 +268,36 @@ public GrpcServiceBuilder unsafeWrapRequestBuffers(boolean unsafeWrapRequestBuff\n         return this;\n     }\n \n+    /**\n+     * Sets a {@link GrpcMessageMarshaller} that serialize and deserialize request or response messages\n+     * to and from {@link ByteBuf}. This replaces the built-in {@link GrpcMessageMarshaller} to the specified", "originalCommit": "a546f575049e458a23d436d25538ce61f96210ba", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "122c47ee6d71e8b31422e4aa2e73e897e5136ebd", "chunk": "diff --git a/grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java b/grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java\nindex 734647eb5a..fc887d6002 100644\n--- a/grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java\n+++ b/grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java\n\n@@ -269,36 +268,35 @@ public final class GrpcServiceBuilder {\n     }\n \n     /**\n-     * Sets a {@link GrpcMessageMarshaller} that serialize and deserialize request or response messages\n-     * to and from {@link ByteBuf}. This replaces the built-in {@link GrpcMessageMarshaller} to the specified\n-     * {@link GrpcMessageMarshaller}.\n+     * Sets a {@link GrpcJsonMarshaller} that serializes and deserializes request or response messages\n+     * to and from JSON depending on {@link SerializationFormat}. This replaces the built-in\n+     * {@link GrpcJsonMarshaller} with the specified {@link GrpcJsonMarshaller}.\n+     * This is commonly used to marshall non-{@link Message} types such as {@code scalapb.GeneratedMessage} for\n+     * Scala and {@code pbandk.Message} for Kotlin.\n      *\n-     * This is commonly used to optimize code paths for a subclass of {@link Marshaller} or enable to handle\n-     * {@link GrpcSerializationFormats#JSON} and {@link GrpcSerializationFormats#JSON_WEB} formats by\n-     * marshalling a message to and from JSON depending on {@link SerializationFormat}.\n-     *\n-     * Note that a {@link #jsonMarshallerCustomizer(Consumer)} is configured,\n-     * this method will throw an {@link IllegalStateException}.\n+     * <p>Note that this method will throw an {@link IllegalStateException}\n+     * if {@link #jsonMarshallerCustomizer(Consumer)} was set.\n      */\n-    public GrpcServiceBuilder messageMarshaller(GrpcMessageMarshaller messageMarshaller) {\n+    public GrpcServiceBuilder jsonMarshaller(GrpcJsonMarshaller jsonMarshaller) {\n         checkState(!isJsonMarshallerCustomizerSet, \"jsonMarshallerCustomizer has been set already.\");\n-        this.messageMarshaller = requireNonNull(messageMarshaller, \"messageMarshaller\");\n+        this.jsonMarshaller = requireNonNull(jsonMarshaller, \"jsonMarshaller\");\n         return this;\n     }\n \n     /**\n-     * Sets a {@link Consumer} that can customize the JSON marshaller used when handling JSON payloads in the\n-     * service. This is commonly used to switch from the default of using lowerCamelCase for field names to\n-     * using the field name from the proto definition, by setting\n+     * Sets a {@link Consumer} that can customize the JSON marshaller for {@link Message} used when\n+     * handling JSON payloads in the service. This is commonly used to switch from the default of using\n+     * lowerCamelCase for field names to using the field name from the proto definition, by setting\n      * {@link MessageMarshaller.Builder#preservingProtoFieldNames(boolean)}.\n      *\n-     * Note that a {@link #messageMarshaller(GrpcMessageMarshaller)} is configured,\n-     * this method will throw an {@link IllegalStateException}.\n+     * <p>Note that this method will throw an {@link IllegalStateException}\n+     * if {@link #jsonMarshaller(GrpcJsonMarshaller)} was set.\n      */\n     public GrpcServiceBuilder jsonMarshallerCustomizer(\n             Consumer<MessageMarshaller.Builder> jsonMarshallerCustomizer) {\n-        checkState(messageMarshaller == null, \"messageMarshaller has been set already.\");\n+        checkState(jsonMarshaller == null, \"jsonMarshaller has been set already.\");\n         this.jsonMarshallerCustomizer = requireNonNull(jsonMarshallerCustomizer, \"jsonMarshallerCustomizer\");\n+        isJsonMarshallerCustomizerSet = true;\n         return this;\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNTQ0MQ==", "url": "https://github.com/line/armeria/pull/2719#discussion_r426335441", "bodyText": "Note that this method will throw ... if ... is set.", "author": "trustin", "createdAt": "2020-05-18T01:52:47Z", "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java", "diffHunk": "@@ -261,14 +268,36 @@ public GrpcServiceBuilder unsafeWrapRequestBuffers(boolean unsafeWrapRequestBuff\n         return this;\n     }\n \n+    /**\n+     * Sets a {@link GrpcMessageMarshaller} that serialize and deserialize request or response messages\n+     * to and from {@link ByteBuf}. This replaces the built-in {@link GrpcMessageMarshaller} to the specified\n+     * {@link GrpcMessageMarshaller}.\n+     *\n+     * This is commonly used to optimize code paths for a subclass of {@link Marshaller} or enable to handle\n+     * {@link GrpcSerializationFormats#JSON} and {@link GrpcSerializationFormats#JSON_WEB} formats by\n+     * marshalling a message to and from JSON depending on {@link SerializationFormat}.\n+     *\n+     * Note that a {@link #jsonMarshallerCustomizer(Consumer)} is configured,\n+     * this method will throw an {@link IllegalStateException}.", "originalCommit": "a546f575049e458a23d436d25538ce61f96210ba", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "122c47ee6d71e8b31422e4aa2e73e897e5136ebd", "chunk": "diff --git a/grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java b/grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java\nindex 734647eb5a..fc887d6002 100644\n--- a/grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java\n+++ b/grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java\n\n@@ -269,36 +268,35 @@ public final class GrpcServiceBuilder {\n     }\n \n     /**\n-     * Sets a {@link GrpcMessageMarshaller} that serialize and deserialize request or response messages\n-     * to and from {@link ByteBuf}. This replaces the built-in {@link GrpcMessageMarshaller} to the specified\n-     * {@link GrpcMessageMarshaller}.\n+     * Sets a {@link GrpcJsonMarshaller} that serializes and deserializes request or response messages\n+     * to and from JSON depending on {@link SerializationFormat}. This replaces the built-in\n+     * {@link GrpcJsonMarshaller} with the specified {@link GrpcJsonMarshaller}.\n+     * This is commonly used to marshall non-{@link Message} types such as {@code scalapb.GeneratedMessage} for\n+     * Scala and {@code pbandk.Message} for Kotlin.\n      *\n-     * This is commonly used to optimize code paths for a subclass of {@link Marshaller} or enable to handle\n-     * {@link GrpcSerializationFormats#JSON} and {@link GrpcSerializationFormats#JSON_WEB} formats by\n-     * marshalling a message to and from JSON depending on {@link SerializationFormat}.\n-     *\n-     * Note that a {@link #jsonMarshallerCustomizer(Consumer)} is configured,\n-     * this method will throw an {@link IllegalStateException}.\n+     * <p>Note that this method will throw an {@link IllegalStateException}\n+     * if {@link #jsonMarshallerCustomizer(Consumer)} was set.\n      */\n-    public GrpcServiceBuilder messageMarshaller(GrpcMessageMarshaller messageMarshaller) {\n+    public GrpcServiceBuilder jsonMarshaller(GrpcJsonMarshaller jsonMarshaller) {\n         checkState(!isJsonMarshallerCustomizerSet, \"jsonMarshallerCustomizer has been set already.\");\n-        this.messageMarshaller = requireNonNull(messageMarshaller, \"messageMarshaller\");\n+        this.jsonMarshaller = requireNonNull(jsonMarshaller, \"jsonMarshaller\");\n         return this;\n     }\n \n     /**\n-     * Sets a {@link Consumer} that can customize the JSON marshaller used when handling JSON payloads in the\n-     * service. This is commonly used to switch from the default of using lowerCamelCase for field names to\n-     * using the field name from the proto definition, by setting\n+     * Sets a {@link Consumer} that can customize the JSON marshaller for {@link Message} used when\n+     * handling JSON payloads in the service. This is commonly used to switch from the default of using\n+     * lowerCamelCase for field names to using the field name from the proto definition, by setting\n      * {@link MessageMarshaller.Builder#preservingProtoFieldNames(boolean)}.\n      *\n-     * Note that a {@link #messageMarshaller(GrpcMessageMarshaller)} is configured,\n-     * this method will throw an {@link IllegalStateException}.\n+     * <p>Note that this method will throw an {@link IllegalStateException}\n+     * if {@link #jsonMarshaller(GrpcJsonMarshaller)} was set.\n      */\n     public GrpcServiceBuilder jsonMarshallerCustomizer(\n             Consumer<MessageMarshaller.Builder> jsonMarshallerCustomizer) {\n-        checkState(messageMarshaller == null, \"messageMarshaller has been set already.\");\n+        checkState(jsonMarshaller == null, \"jsonMarshaller has been set already.\");\n         this.jsonMarshallerCustomizer = requireNonNull(jsonMarshallerCustomizer, \"jsonMarshallerCustomizer\");\n+        isJsonMarshallerCustomizerSet = true;\n         return this;\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNTQ4NA==", "url": "https://github.com/line/armeria/pull/2719#discussion_r426335484", "bodyText": "Note that this method will ... if ... is set.", "author": "trustin", "createdAt": "2020-05-18T01:53:03Z", "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java", "diffHunk": "@@ -261,14 +268,36 @@ public GrpcServiceBuilder unsafeWrapRequestBuffers(boolean unsafeWrapRequestBuff\n         return this;\n     }\n \n+    /**\n+     * Sets a {@link GrpcMessageMarshaller} that serialize and deserialize request or response messages\n+     * to and from {@link ByteBuf}. This replaces the built-in {@link GrpcMessageMarshaller} to the specified\n+     * {@link GrpcMessageMarshaller}.\n+     *\n+     * This is commonly used to optimize code paths for a subclass of {@link Marshaller} or enable to handle\n+     * {@link GrpcSerializationFormats#JSON} and {@link GrpcSerializationFormats#JSON_WEB} formats by\n+     * marshalling a message to and from JSON depending on {@link SerializationFormat}.\n+     *\n+     * Note that a {@link #jsonMarshallerCustomizer(Consumer)} is configured,\n+     * this method will throw an {@link IllegalStateException}.\n+     */\n+    public GrpcServiceBuilder messageMarshaller(GrpcMessageMarshaller messageMarshaller) {\n+        checkState(!isJsonMarshallerCustomizerSet, \"jsonMarshallerCustomizer has been set already.\");\n+        this.messageMarshaller = requireNonNull(messageMarshaller, \"messageMarshaller\");\n+        return this;\n+    }\n+\n     /**\n      * Sets a {@link Consumer} that can customize the JSON marshaller used when handling JSON payloads in the\n      * service. This is commonly used to switch from the default of using lowerCamelCase for field names to\n      * using the field name from the proto definition, by setting\n      * {@link MessageMarshaller.Builder#preservingProtoFieldNames(boolean)}.\n+     *\n+     * Note that a {@link #messageMarshaller(GrpcMessageMarshaller)} is configured,\n+     * this method will throw an {@link IllegalStateException}.", "originalCommit": "a546f575049e458a23d436d25538ce61f96210ba", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "122c47ee6d71e8b31422e4aa2e73e897e5136ebd", "chunk": "diff --git a/grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java b/grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java\nindex 734647eb5a..fc887d6002 100644\n--- a/grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java\n+++ b/grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java\n\n@@ -269,36 +268,35 @@ public final class GrpcServiceBuilder {\n     }\n \n     /**\n-     * Sets a {@link GrpcMessageMarshaller} that serialize and deserialize request or response messages\n-     * to and from {@link ByteBuf}. This replaces the built-in {@link GrpcMessageMarshaller} to the specified\n-     * {@link GrpcMessageMarshaller}.\n+     * Sets a {@link GrpcJsonMarshaller} that serializes and deserializes request or response messages\n+     * to and from JSON depending on {@link SerializationFormat}. This replaces the built-in\n+     * {@link GrpcJsonMarshaller} with the specified {@link GrpcJsonMarshaller}.\n+     * This is commonly used to marshall non-{@link Message} types such as {@code scalapb.GeneratedMessage} for\n+     * Scala and {@code pbandk.Message} for Kotlin.\n      *\n-     * This is commonly used to optimize code paths for a subclass of {@link Marshaller} or enable to handle\n-     * {@link GrpcSerializationFormats#JSON} and {@link GrpcSerializationFormats#JSON_WEB} formats by\n-     * marshalling a message to and from JSON depending on {@link SerializationFormat}.\n-     *\n-     * Note that a {@link #jsonMarshallerCustomizer(Consumer)} is configured,\n-     * this method will throw an {@link IllegalStateException}.\n+     * <p>Note that this method will throw an {@link IllegalStateException}\n+     * if {@link #jsonMarshallerCustomizer(Consumer)} was set.\n      */\n-    public GrpcServiceBuilder messageMarshaller(GrpcMessageMarshaller messageMarshaller) {\n+    public GrpcServiceBuilder jsonMarshaller(GrpcJsonMarshaller jsonMarshaller) {\n         checkState(!isJsonMarshallerCustomizerSet, \"jsonMarshallerCustomizer has been set already.\");\n-        this.messageMarshaller = requireNonNull(messageMarshaller, \"messageMarshaller\");\n+        this.jsonMarshaller = requireNonNull(jsonMarshaller, \"jsonMarshaller\");\n         return this;\n     }\n \n     /**\n-     * Sets a {@link Consumer} that can customize the JSON marshaller used when handling JSON payloads in the\n-     * service. This is commonly used to switch from the default of using lowerCamelCase for field names to\n-     * using the field name from the proto definition, by setting\n+     * Sets a {@link Consumer} that can customize the JSON marshaller for {@link Message} used when\n+     * handling JSON payloads in the service. This is commonly used to switch from the default of using\n+     * lowerCamelCase for field names to using the field name from the proto definition, by setting\n      * {@link MessageMarshaller.Builder#preservingProtoFieldNames(boolean)}.\n      *\n-     * Note that a {@link #messageMarshaller(GrpcMessageMarshaller)} is configured,\n-     * this method will throw an {@link IllegalStateException}.\n+     * <p>Note that this method will throw an {@link IllegalStateException}\n+     * if {@link #jsonMarshaller(GrpcJsonMarshaller)} was set.\n      */\n     public GrpcServiceBuilder jsonMarshallerCustomizer(\n             Consumer<MessageMarshaller.Builder> jsonMarshallerCustomizer) {\n-        checkState(messageMarshaller == null, \"messageMarshaller has been set already.\");\n+        checkState(jsonMarshaller == null, \"jsonMarshaller has been set already.\");\n         this.jsonMarshallerCustomizer = requireNonNull(jsonMarshallerCustomizer, \"jsonMarshallerCustomizer\");\n+        isJsonMarshallerCustomizerSet = true;\n         return this;\n     }\n \n"}}, {"oid": "122c47ee6d71e8b31422e4aa2e73e897e5136ebd", "url": "https://github.com/line/armeria/commit/122c47ee6d71e8b31422e4aa2e73e897e5136ebd", "message": "Support gRPC Scala using ScalaPB #2719\n\nMotivation:\n\nAs a part of better interop with other JVM languages(#1078),\nit would be nice if Armeria Grpc server and client support [ScalaPB](https://scalapb.github.io/).\n\nModifications:\n\n- Rename the original `GrpcMessageMashaller` to `GrpcMessageMashallingHandler`.\n- Introduce a new interface `GrpcMessageMashaller`. A user can customize\n `GrpcMessageMashaller` by setting it to GrpcServerBuilder or GrpcClientOptions.\n  I'm not sure this approach is a right direction. \ud83e\uddd0\n  Related: #2416\n- Add ScalaPBMessageMashaller.\n  Note, It is hard to support releasing an artifact with multiple Scala versions in Gradle.\n  Do we need to move this code to Armeria `contrib`?\n\nResult:\n\nYou can now use the gRPC server/client stubs generated by ScalaPB", "committedDate": "2020-06-13T13:45:04Z", "type": "commit"}, {"oid": "122c47ee6d71e8b31422e4aa2e73e897e5136ebd", "url": "https://github.com/line/armeria/commit/122c47ee6d71e8b31422e4aa2e73e897e5136ebd", "message": "Support gRPC Scala using ScalaPB #2719\n\nMotivation:\n\nAs a part of better interop with other JVM languages(#1078),\nit would be nice if Armeria Grpc server and client support [ScalaPB](https://scalapb.github.io/).\n\nModifications:\n\n- Rename the original `GrpcMessageMashaller` to `GrpcMessageMashallingHandler`.\n- Introduce a new interface `GrpcMessageMashaller`. A user can customize\n `GrpcMessageMashaller` by setting it to GrpcServerBuilder or GrpcClientOptions.\n  I'm not sure this approach is a right direction. \ud83e\uddd0\n  Related: #2416\n- Add ScalaPBMessageMashaller.\n  Note, It is hard to support releasing an artifact with multiple Scala versions in Gradle.\n  Do we need to move this code to Armeria `contrib`?\n\nResult:\n\nYou can now use the gRPC server/client stubs generated by ScalaPB", "committedDate": "2020-06-13T13:45:04Z", "type": "forcePushed"}, {"oid": "212ff87f0173e7765bef9718115a90ec465610a8", "url": "https://github.com/line/armeria/commit/212ff87f0173e7765bef9718115a90ec465610a8", "message": "Clean up", "committedDate": "2020-06-13T13:52:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgxMzExOA==", "url": "https://github.com/line/armeria/pull/2719#discussion_r440813118", "bodyText": "This makes me think GRPC_JSON_MARSHALLER and JSON_MARSHALLER_CUSTOMIZER are not orthogonal. Should we merge these two options into one, e.g. GRPC_JSON_MARSHALLER_FACTORY (Function<Class<?>, GrpcJsonMarshaller>)? The default value of the new option could be something like:\nclientType -> GrpcJsonMarshaller.of(clientType)\nwhere GrpcJsonMarshaller.of() calls something like new DefaultJsonMarshaller(GrpcJsonUtil.jsonMarshaller(stubMethods(clientType)).\nIf a user wants to customize the marshaller, the user could specify an alternative factory like this:\nclientType -> GrpcJsonMarshaller.builder(clientType)\n                                ...\n                                .build()\nFor ScalaPB and others, it could be _ -> ScalaPBJsonMarshaller().\nWhat do you think, @ikhoon and @anuraaga ?", "author": "trustin", "createdAt": "2020-06-16T12:32:59Z", "path": "grpc/src/main/java/com/linecorp/armeria/internal/client/grpc/GrpcClientFactory.java", "diffHunk": "@@ -95,13 +98,14 @@ public Object newClient(ClientBuilderParams params) {\n \n         final HttpClient httpClient = newHttpClient(params);\n \n-        // TODO(ikhoon): Support gjson with Kotlin coroutine stub once\n-        //               https://github.com/grpc/grpc-kotlin/pull/63 is released\n-        final MessageMarshaller jsonMarshaller =\n-                GrpcSerializationFormats.isJson(serializationFormat) ?\n-                GrpcJsonUtil.jsonMarshaller(\n-                        stubMethods(clientType),\n-                        options.get(GrpcClientOptions.JSON_MARSHALLER_CUSTOMIZER)) : null;\n+        GrpcJsonMarshaller jsonMarshaller = null;\n+        if (GrpcSerializationFormats.isJson(serializationFormat)) {\n+            jsonMarshaller = options.get(GrpcClientOptions.GRPC_JSON_MARSHALLER);\n+            if (jsonMarshaller == NoopJsonMarshaller.get()) {\n+                jsonMarshaller = new DefaultJsonMarshaller(GrpcJsonUtil.jsonMarshaller(\n+                        stubMethods(clientType), options.get(GrpcClientOptions.JSON_MARSHALLER_CUSTOMIZER)));", "originalCommit": "212ff87f0173e7765bef9718115a90ec465610a8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgxOTAxMA==", "url": "https://github.com/line/armeria/pull/2719#discussion_r440819010", "bodyText": "That was my most considering part - JSON marshaller and JSON marshaller customizer. I want to merge the extension points into one.\nGRPC_JSON_MARSHALLER_FACTORY looks good to me. \ud83d\udc4d", "author": "ikhoon", "createdAt": "2020-06-16T12:42:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgxMzExOA=="}], "type": "inlineReview", "revised_code": {"commit": "361e29d19815e6fd9d8abd5b5092c690a91e789d", "chunk": "diff --git a/grpc/src/main/java/com/linecorp/armeria/internal/client/grpc/GrpcClientFactory.java b/grpc/src/main/java/com/linecorp/armeria/internal/client/grpc/GrpcClientFactory.java\nindex fcbeb886fe..3a0d5b2e8a 100644\n--- a/grpc/src/main/java/com/linecorp/armeria/internal/client/grpc/GrpcClientFactory.java\n+++ b/grpc/src/main/java/com/linecorp/armeria/internal/client/grpc/GrpcClientFactory.java\n\n@@ -98,13 +91,12 @@ final class GrpcClientFactory extends DecoratingClientFactory {\n \n         final HttpClient httpClient = newHttpClient(params);\n \n-        GrpcJsonMarshaller jsonMarshaller = null;\n+        final GrpcJsonMarshaller jsonMarshaller;\n         if (GrpcSerializationFormats.isJson(serializationFormat)) {\n-            jsonMarshaller = options.get(GrpcClientOptions.GRPC_JSON_MARSHALLER);\n-            if (jsonMarshaller == NoopJsonMarshaller.get()) {\n-                jsonMarshaller = new DefaultJsonMarshaller(GrpcJsonUtil.jsonMarshaller(\n-                        stubMethods(clientType), options.get(GrpcClientOptions.JSON_MARSHALLER_CUSTOMIZER)));\n-            }\n+            jsonMarshaller = options.get(GrpcClientOptions.GRPC_JSON_MARSHALLER_FACTORY)\n+                                    .apply(getServiceDescriptor(clientType));\n+        } else {\n+            jsonMarshaller = null;\n         }\n \n         final ArmeriaChannel channel = new ArmeriaChannel(\n"}}, {"oid": "dc6fddd35fea5d7140c79dc268e2f94ddb02c789", "url": "https://github.com/line/armeria/commit/dc6fddd35fea5d7140c79dc268e2f94ddb02c789", "message": "Merge branch 'master' into grpc-scala", "committedDate": "2020-06-23T09:00:21Z", "type": "commit"}, {"oid": "361e29d19815e6fd9d8abd5b5092c690a91e789d", "url": "https://github.com/line/armeria/commit/361e29d19815e6fd9d8abd5b5092c690a91e789d", "message": "Address comments by @trustin / Add a fatory and builder of GrpcJsonMashaller", "committedDate": "2020-06-24T07:21:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcwMTMwOA==", "url": "https://github.com/line/armeria/pull/2719#discussion_r444701308", "bodyText": "Is this used?", "author": "anuraaga", "createdAt": "2020-06-24T07:35:31Z", "path": "grpc/src/main/java/com/linecorp/armeria/internal/common/grpc/NoopJsonMarshaller.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.common.grpc;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+\n+import com.linecorp.armeria.common.grpc.GrpcJsonMarshaller;\n+\n+import io.grpc.MethodDescriptor.Marshaller;\n+\n+public final class NoopJsonMarshaller implements GrpcJsonMarshaller {", "originalCommit": "361e29d19815e6fd9d8abd5b5092c690a91e789d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcwNzIyMQ==", "url": "https://github.com/line/armeria/pull/2719#discussion_r444707221", "bodyText": "Oops.. this is cruft. It was removed now.", "author": "ikhoon", "createdAt": "2020-06-24T07:47:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcwMTMwOA=="}], "type": "inlineReview", "revised_code": {"commit": "a9186521c583bbf28258e8cc2dffa204ccbbf5a4", "chunk": "diff --git a/grpc/src/main/java/com/linecorp/armeria/internal/common/grpc/NoopJsonMarshaller.java b/grpc/src/main/java/com/linecorp/armeria/internal/common/grpc/NoopJsonMarshaller.java\ndeleted file mode 100644\nindex a75ef2e532..0000000000\n--- a/grpc/src/main/java/com/linecorp/armeria/internal/common/grpc/NoopJsonMarshaller.java\n+++ /dev/null\n\n@@ -1,44 +0,0 @@\n-/*\n- * Copyright 2020 LINE Corporation\n- *\n- * LINE Corporation licenses this file to you under the Apache License,\n- * version 2.0 (the \"License\"); you may not use this file except in compliance\n- * with the License. You may obtain a copy of the License at:\n- *\n- *   https://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n- * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n- * License for the specific language governing permissions and limitations\n- * under the License.\n- */\n-\n-package com.linecorp.armeria.internal.common.grpc;\n-\n-import java.io.IOException;\n-import java.io.InputStream;\n-import java.io.OutputStream;\n-\n-import com.linecorp.armeria.common.grpc.GrpcJsonMarshaller;\n-\n-import io.grpc.MethodDescriptor.Marshaller;\n-\n-public final class NoopJsonMarshaller implements GrpcJsonMarshaller {\n-\n-    private static final NoopJsonMarshaller INSTANCE = new NoopJsonMarshaller();\n-\n-    public static NoopJsonMarshaller get() {\n-        return INSTANCE;\n-    }\n-\n-    private NoopJsonMarshaller() {}\n-\n-    @Override\n-    public <T> void serializeMessage(Marshaller<T> marshaller, T message, OutputStream os) throws IOException {}\n-\n-    @Override\n-    public <T> T deserializeMessage(Marshaller<T> marshaller, InputStream is) throws IOException {\n-        return null;\n-    }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcwMTQxMA==", "url": "https://github.com/line/armeria/pull/2719#discussion_r444701410", "bodyText": "I don't know if we need this class, but if we do we want to return default instance, not null.", "author": "anuraaga", "createdAt": "2020-06-24T07:35:45Z", "path": "grpc/src/main/java/com/linecorp/armeria/internal/common/grpc/NoopJsonMarshaller.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.common.grpc;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+\n+import com.linecorp.armeria.common.grpc.GrpcJsonMarshaller;\n+\n+import io.grpc.MethodDescriptor.Marshaller;\n+\n+public final class NoopJsonMarshaller implements GrpcJsonMarshaller {\n+\n+    private static final NoopJsonMarshaller INSTANCE = new NoopJsonMarshaller();\n+\n+    public static NoopJsonMarshaller get() {\n+        return INSTANCE;\n+    }\n+\n+    private NoopJsonMarshaller() {}\n+\n+    @Override\n+    public <T> void serializeMessage(Marshaller<T> marshaller, T message, OutputStream os) throws IOException {}\n+\n+    @Override\n+    public <T> T deserializeMessage(Marshaller<T> marshaller, InputStream is) throws IOException {\n+        return null;", "originalCommit": "361e29d19815e6fd9d8abd5b5092c690a91e789d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a9186521c583bbf28258e8cc2dffa204ccbbf5a4", "chunk": "diff --git a/grpc/src/main/java/com/linecorp/armeria/internal/common/grpc/NoopJsonMarshaller.java b/grpc/src/main/java/com/linecorp/armeria/internal/common/grpc/NoopJsonMarshaller.java\ndeleted file mode 100644\nindex a75ef2e532..0000000000\n--- a/grpc/src/main/java/com/linecorp/armeria/internal/common/grpc/NoopJsonMarshaller.java\n+++ /dev/null\n\n@@ -1,44 +0,0 @@\n-/*\n- * Copyright 2020 LINE Corporation\n- *\n- * LINE Corporation licenses this file to you under the Apache License,\n- * version 2.0 (the \"License\"); you may not use this file except in compliance\n- * with the License. You may obtain a copy of the License at:\n- *\n- *   https://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n- * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n- * License for the specific language governing permissions and limitations\n- * under the License.\n- */\n-\n-package com.linecorp.armeria.internal.common.grpc;\n-\n-import java.io.IOException;\n-import java.io.InputStream;\n-import java.io.OutputStream;\n-\n-import com.linecorp.armeria.common.grpc.GrpcJsonMarshaller;\n-\n-import io.grpc.MethodDescriptor.Marshaller;\n-\n-public final class NoopJsonMarshaller implements GrpcJsonMarshaller {\n-\n-    private static final NoopJsonMarshaller INSTANCE = new NoopJsonMarshaller();\n-\n-    public static NoopJsonMarshaller get() {\n-        return INSTANCE;\n-    }\n-\n-    private NoopJsonMarshaller() {}\n-\n-    @Override\n-    public <T> void serializeMessage(Marshaller<T> marshaller, T message, OutputStream os) throws IOException {}\n-\n-    @Override\n-    public <T> T deserializeMessage(Marshaller<T> marshaller, InputStream is) throws IOException {\n-        return null;\n-    }\n-}\n"}}, {"oid": "a9186521c583bbf28258e8cc2dffa204ccbbf5a4", "url": "https://github.com/line/armeria/commit/a9186521c583bbf28258e8cc2dffa204ccbbf5a4", "message": "Clean up", "committedDate": "2020-06-24T07:40:09Z", "type": "commit"}, {"oid": "c7c6c703bc9f8728e39edc41485e1b356a2805be", "url": "https://github.com/line/armeria/commit/c7c6c703bc9f8728e39edc41485e1b356a2805be", "message": "Remove blank", "committedDate": "2020-06-24T07:51:46Z", "type": "commit"}, {"oid": "c2ac49deaff5841ec09139c48aebd4f9a7de8b40", "url": "https://github.com/line/armeria/commit/c2ac49deaff5841ec09139c48aebd4f9a7de8b40", "message": "Update code example in GrpcClientOptions", "committedDate": "2020-06-24T09:02:59Z", "type": "commit"}, {"oid": "1e517a423b3e3b072b8b42f589a4cace4806fbbf", "url": "https://github.com/line/armeria/commit/1e517a423b3e3b072b8b42f589a4cace4806fbbf", "message": "Fix option name", "committedDate": "2020-06-24T09:07:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI3MjkzOA==", "url": "https://github.com/line/armeria/pull/2719#discussion_r445272938", "bodyText": "rnn?", "author": "minwoox", "createdAt": "2020-06-25T02:26:53Z", "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java", "diffHunk": "@@ -264,14 +268,34 @@ public GrpcServiceBuilder unsafeWrapRequestBuffers(boolean unsafeWrapRequestBuff\n     }\n \n     /**\n-     * Sets a {@link Consumer} that can customize the JSON marshaller used when handling JSON payloads in the\n-     * service. This is commonly used to switch from the default of using lowerCamelCase for field names to\n-     * using the field name from the proto definition, by setting\n-     * {@link MessageMarshaller.Builder#preservingProtoFieldNames(boolean)}.\n+     * Sets the factory that creates a {@link GrpcJsonMarshaller} that serializes and deserializes request or\n+     * response messages to and from JSON depending on the {@link SerializationFormat}. The returned\n+     * {@link GrpcJsonMarshaller} from the factory replaces the built-in {@link GrpcJsonMarshaller}.\n+     *\n+     * <p>This is commonly used to:\n+     * <ul>\n+     *   <li>Switch from the default of using lowerCamelCase for field names to using the field name from\n+     *       the proto definition, by setting\n+     *       {@link MessageMarshaller.Builder#preservingProtoFieldNames(boolean)} via\n+     *       {@link GrpcJsonMarshallerBuilder#jsonMarshallerCustomizer(Consumer)}.\n+     *       <pre>{@code\n+     *       GrpcService.builder()\n+     *            .jsonMarshallerFactory(serviceDescriptor -> {\n+     *                return GrpcJsonMarshaller.builder()\n+     *                                         .jsonMarshallerCustomizer(builder -> {\n+     *                                             builder.preservingProtoFieldNames(true);\n+     *                                         })\n+     *                                         .build(serviceDescriptor);\n+     *            })\n+     *            .build();\n+     *       }</pre></li>\n+     *   <li>Set a customer marshaller for non-{@link Message} types such as {@code scalapb.GeneratedMessage}\n+     *       for Scala and {@code pbandk.Message} for Kotlin.</li>\n+     * </ul>\n      */\n-    public GrpcServiceBuilder jsonMarshallerCustomizer(\n-            Consumer<MessageMarshaller.Builder> jsonMarshallerCustomizer) {\n-        this.jsonMarshallerCustomizer = requireNonNull(jsonMarshallerCustomizer, \"jsonMarshallerCustomizer\");\n+    public GrpcServiceBuilder jsonMarshallerFactory(\n+            Function<? super ServiceDescriptor, ? extends GrpcJsonMarshaller> jsonMarshallerFactory) {\n+        this.jsonMarshallerFactory = jsonMarshallerFactory;", "originalCommit": "1e517a423b3e3b072b8b42f589a4cace4806fbbf", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3e076723d130f43133af3d780968a26762e0c8eb", "chunk": "diff --git a/grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java b/grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java\nindex b0774861e0..35dacba962 100644\n--- a/grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java\n+++ b/grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java\n\n@@ -295,7 +295,7 @@ public final class GrpcServiceBuilder {\n      */\n     public GrpcServiceBuilder jsonMarshallerFactory(\n             Function<? super ServiceDescriptor, ? extends GrpcJsonMarshaller> jsonMarshallerFactory) {\n-        this.jsonMarshallerFactory = jsonMarshallerFactory;\n+        this.jsonMarshallerFactory = requireNonNull(jsonMarshallerFactory, \"jsonMarshallerFactory\");\n         return this;\n     }\n \n"}}, {"oid": "3e076723d130f43133af3d780968a26762e0c8eb", "url": "https://github.com/line/armeria/commit/3e076723d130f43133af3d780968a26762e0c8eb", "message": "Address comments by @minwoox", "committedDate": "2020-06-25T04:14:06Z", "type": "commit"}, {"oid": "b9c88f6feb7f9b8d0fb5a604e1d76fbfdbb818c4", "url": "https://github.com/line/armeria/commit/b9c88f6feb7f9b8d0fb5a604e1d76fbfdbb818c4", "message": "Fix indent", "committedDate": "2020-06-25T09:50:46Z", "type": "commit"}]}