{"pr_number": 3107, "pr_title": "Test failure: com.linecorp.armeria.spring.ArmeriaAutoConfigurationWithoutMeterTest", "pr_createdAt": "2020-10-12T13:36:14Z", "pr_url": "https://github.com/line/armeria/pull/3107", "timeline": [{"oid": "6660b0b11bb16a85aed3c7d53b50af5eff07e557", "url": "https://github.com/line/armeria/commit/6660b0b11bb16a85aed3c7d53b50af5eff07e557", "message": "Fix `ArmeriaAutoConfigurationWithoutMeterTest`", "committedDate": "2020-10-12T13:30:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzYzMDU0NQ==", "url": "https://github.com/line/armeria/pull/3107#discussion_r503630545", "bodyText": "Sometimes, it takes time to collect metrics by Micrometer and expose them.\nHow about using Awaitility?\nawait().untilAsserted(() -> {\n\tfinal AggregatedHttpResponse msg = WebClient.of(newUrl(\"h1c\"))\n    ...\n    assertThat(...)\n});", "author": "ikhoon", "createdAt": "2020-10-13T02:26:26Z", "path": "spring/boot2-autoconfigure/src/test/java/com/linecorp/armeria/spring/ArmeriaAutoConfigurationWithoutMeterTest.java", "diffHunk": "@@ -72,16 +68,10 @@ private String newUrl(String scheme) {\n \n     @Test\n     public void test() {\n-        final AggregatedHttpResponse msg = WebClient.of(newUrl(\"h1c\"))\n-                                                    .get(\"/ok\")\n-                                                    .aggregate().join();\n-        assertThat(msg.status()).isEqualTo(HttpStatus.OK);\n-        assertThat(msg.contentUtf8()).isEqualTo(\"ok\");\n-\n         final String metricReport = WebClient.of(newUrl(\"http\"))\n                                              .get(\"/internal/metrics\")\n                                              .aggregate().join()\n                                              .contentUtf8();\n-        assertThat(metricReport).contains(\"# TYPE armeria_server_response_duration_seconds_max gauge\");\n+        assertThat(metricReport).contains(\"# TYPE armeria_server_connections gauge\");", "originalCommit": "6660b0b11bb16a85aed3c7d53b50af5eff07e557", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY1MzcyMg==", "url": "https://github.com/line/armeria/pull/3107#discussion_r503653722", "bodyText": "Fixed \ud83d\ude04", "author": "heowc", "createdAt": "2020-10-13T04:01:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzYzMDU0NQ=="}], "type": "inlineReview", "revised_code": {"commit": "6c614fef2c207e1c8563d1b50bd9f952f0d0d032", "chunk": "diff --git a/spring/boot2-autoconfigure/src/test/java/com/linecorp/armeria/spring/ArmeriaAutoConfigurationWithoutMeterTest.java b/spring/boot2-autoconfigure/src/test/java/com/linecorp/armeria/spring/ArmeriaAutoConfigurationWithoutMeterTest.java\nindex e59465fae9..2abb4f432a 100644\n--- a/spring/boot2-autoconfigure/src/test/java/com/linecorp/armeria/spring/ArmeriaAutoConfigurationWithoutMeterTest.java\n+++ b/spring/boot2-autoconfigure/src/test/java/com/linecorp/armeria/spring/ArmeriaAutoConfigurationWithoutMeterTest.java\n\n@@ -68,10 +69,12 @@ public class ArmeriaAutoConfigurationWithoutMeterTest {\n \n     @Test\n     public void test() {\n-        final String metricReport = WebClient.of(newUrl(\"http\"))\n-                                             .get(\"/internal/metrics\")\n-                                             .aggregate().join()\n-                                             .contentUtf8();\n-        assertThat(metricReport).contains(\"# TYPE armeria_server_connections gauge\");\n+        await().untilAsserted(() -> {\n+            final String metricReport = WebClient.of(newUrl(\"h1c\"))\n+                                                 .get(\"/internal/metrics\")\n+                                                 .aggregate().join()\n+                                                 .contentUtf8();\n+            assertThat(metricReport).contains(\"# TYPE armeria_server_connections gauge\");\n+        });\n     }\n }\n"}}, {"oid": "6c614fef2c207e1c8563d1b50bd9f952f0d0d032", "url": "https://github.com/line/armeria/commit/6c614fef2c207e1c8563d1b50bd9f952f0d0d032", "message": "Address comments by @ikhoon", "committedDate": "2020-10-13T04:00:33Z", "type": "commit"}]}