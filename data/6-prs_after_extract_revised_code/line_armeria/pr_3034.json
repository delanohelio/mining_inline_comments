{"pr_number": 3034, "pr_title": "Use MeterIdPrefixFunction bean when integrated with Spring Boot", "pr_createdAt": "2020-08-29T07:03:08Z", "pr_url": "https://github.com/line/armeria/pull/3034", "timeline": [{"oid": "72a51a518eeea3ef0e861f16a11bb8e17624c9e1", "url": "https://github.com/line/armeria/commit/72a51a518eeea3ef0e861f16a11bb8e17624c9e1", "message": "Use MeterIdPrefixFunction bean when integrated with Spring Boot", "committedDate": "2020-08-29T07:41:21Z", "type": "forcePushed"}, {"oid": "43f97f3e6557ea4bb2aa66997e7c18a58e8a356f", "url": "https://github.com/line/armeria/commit/43f97f3e6557ea4bb2aa66997e7c18a58e8a356f", "message": "Use MeterIdPrefixFunction bean when integrated with Spring Boot", "committedDate": "2020-08-29T09:14:37Z", "type": "forcePushed"}, {"oid": "537e1447ea5fe468dc4356f9cd28e64645f39616", "url": "https://github.com/line/armeria/commit/537e1447ea5fe468dc4356f9cd28e64645f39616", "message": "Use MeterIdPrefixFunction bean when integrated with Spring Boot", "committedDate": "2020-08-31T09:01:04Z", "type": "commit"}, {"oid": "537e1447ea5fe468dc4356f9cd28e64645f39616", "url": "https://github.com/line/armeria/commit/537e1447ea5fe468dc4356f9cd28e64645f39616", "message": "Use MeterIdPrefixFunction bean when integrated with Spring Boot", "committedDate": "2020-08-31T09:01:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDkxOTkxNQ==", "url": "https://github.com/line/armeria/pull/3034#discussion_r480919915", "bodyText": "Could you use a ternary operator(? : ) instead of firstNonNull to avoid creating an extra object?", "author": "ikhoon", "createdAt": "2020-09-01T07:31:03Z", "path": "spring/boot2-webflux-autoconfigure/src/main/java/com/linecorp/armeria/spring/web/reactive/ArmeriaReactiveWebServerFactory.java", "diffHunk": "@@ -259,7 +260,9 @@ private void configureArmeriaService(ServerBuilder sb, DocServiceBuilder docServ\n         configurePorts(sb, settings.getPorts());\n         configureServerWithArmeriaSettings(sb, settings,\n                                            firstNonNull(findBean(MeterRegistry.class), Metrics.globalRegistry),\n-                                           findBeans(HealthChecker.class));\n+                                           findBeans(HealthChecker.class),\n+                                           firstNonNull(findBean(MeterIdPrefixFunction.class),\n+                                                        MeterIdPrefixFunction.ofDefault(\"armeria.server\")));", "originalCommit": "537e1447ea5fe468dc4356f9cd28e64645f39616", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f18c7e151290fd8cec921ad50bdb2ee7dcf42cda", "chunk": "diff --git a/spring/boot2-webflux-autoconfigure/src/main/java/com/linecorp/armeria/spring/web/reactive/ArmeriaReactiveWebServerFactory.java b/spring/boot2-webflux-autoconfigure/src/main/java/com/linecorp/armeria/spring/web/reactive/ArmeriaReactiveWebServerFactory.java\nindex 57d39ac31d..217ddfcc77 100644\n--- a/spring/boot2-webflux-autoconfigure/src/main/java/com/linecorp/armeria/spring/web/reactive/ArmeriaReactiveWebServerFactory.java\n+++ b/spring/boot2-webflux-autoconfigure/src/main/java/com/linecorp/armeria/spring/web/reactive/ArmeriaReactiveWebServerFactory.java\n\n@@ -258,11 +258,12 @@ public class ArmeriaReactiveWebServerFactory extends AbstractReactiveWebServerFa\n     private void configureArmeriaService(ServerBuilder sb, DocServiceBuilder docServiceBuilder,\n                                          ArmeriaSettings settings) {\n         configurePorts(sb, settings.getPorts());\n+        final MeterIdPrefixFunction meterIdPrefixFunction = findBean(MeterIdPrefixFunction.class);\n         configureServerWithArmeriaSettings(sb, settings,\n                                            firstNonNull(findBean(MeterRegistry.class), Metrics.globalRegistry),\n                                            findBeans(HealthChecker.class),\n-                                           firstNonNull(findBean(MeterIdPrefixFunction.class),\n-                                                        MeterIdPrefixFunction.ofDefault(\"armeria.server\")));\n+                                           meterIdPrefixFunction != null ? meterIdPrefixFunction :\n+                                           MeterIdPrefixFunction.ofDefault(\"armeria.server\"));\n         if (settings.getSsl() != null) {\n             configureTls(sb, settings.getSsl());\n         }\n"}}, {"oid": "f18c7e151290fd8cec921ad50bdb2ee7dcf42cda", "url": "https://github.com/line/armeria/commit/f18c7e151290fd8cec921ad50bdb2ee7dcf42cda", "message": "address comments by @ikhoon", "committedDate": "2020-09-01T09:01:47Z", "type": "commit"}, {"oid": "80c521c6dda933700367f79c716da68fe5c953d4", "url": "https://github.com/line/armeria/commit/80c521c6dda933700367f79c716da68fe5c953d4", "message": "fix check style", "committedDate": "2020-09-01T11:04:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDIyMTg3NA==", "url": "https://github.com/line/armeria/pull/3034#discussion_r484221874", "bodyText": "How about using a non-default prefix name, e.g. custom.grpc.server?", "author": "trustin", "createdAt": "2020-09-07T07:04:28Z", "path": "spring/boot2-autoconfigure/src/test/java/com/linecorp/armeria/spring/ArmeriaAutoConfigurationTest.java", "diffHunk": "@@ -151,6 +153,11 @@ public DocServiceConfigurator helloGrpcServiceExamples() {\n                              .exampleHeaders(HelloServiceGrpc.SERVICE_NAME, \"Hello\",\n                                              HttpHeaders.of(\"x-additional-header\", \"headerVal\"));\n         }\n+\n+        @Bean\n+        public MeterIdPrefixFunction myMeterIdPrefixFunction() {\n+            return GrpcMeterIdPrefixFunction.of(\"armeria.server\");", "originalCommit": "80c521c6dda933700367f79c716da68fe5c953d4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "777793420d364d83ad614c16b564ba20fa305dd8", "chunk": "diff --git a/spring/boot2-autoconfigure/src/test/java/com/linecorp/armeria/spring/ArmeriaAutoConfigurationTest.java b/spring/boot2-autoconfigure/src/test/java/com/linecorp/armeria/spring/ArmeriaAutoConfigurationTest.java\nindex fe8038642c..bd3c7b8cee 100644\n--- a/spring/boot2-autoconfigure/src/test/java/com/linecorp/armeria/spring/ArmeriaAutoConfigurationTest.java\n+++ b/spring/boot2-autoconfigure/src/test/java/com/linecorp/armeria/spring/ArmeriaAutoConfigurationTest.java\n\n@@ -156,7 +156,7 @@ public class ArmeriaAutoConfigurationTest {\n \n         @Bean\n         public MeterIdPrefixFunction myMeterIdPrefixFunction() {\n-            return GrpcMeterIdPrefixFunction.of(\"armeria.server\");\n+            return GrpcMeterIdPrefixFunction.of(\"custom.armeria.server\");\n         }\n     }\n \n"}}, {"oid": "777793420d364d83ad614c16b564ba20fa305dd8", "url": "https://github.com/line/armeria/commit/777793420d364d83ad614c16b564ba20fa305dd8", "message": "address comments by @trustin", "committedDate": "2020-09-07T09:36:13Z", "type": "commit"}, {"oid": "730522298b51960c36ae0e6a1eb2a3ce0516a2fa", "url": "https://github.com/line/armeria/commit/730522298b51960c36ae0e6a1eb2a3ce0516a2fa", "message": "fix checkstyle", "committedDate": "2020-09-07T10:03:09Z", "type": "commit"}]}