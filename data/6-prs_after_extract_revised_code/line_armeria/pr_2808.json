{"pr_number": 2808, "pr_title": "Fix flaky test in `ServerMaxConnectionAgeTest.http1MaxConnectionAge`", "pr_createdAt": "2020-06-18T03:56:46Z", "pr_url": "https://github.com/line/armeria/pull/2808", "timeline": [{"oid": "65b66ff5f713f76599742f7bcb597b83f68a38ef", "url": "https://github.com/line/armeria/commit/65b66ff5f713f76599742f7bcb597b83f68a38ef", "message": "Fix flaky test in `ServerMaxConnectionAgeTest.http1MaxConnectionAge`\n\nMotivation:\n\nThere is a flaky test on CI build of Windows.\nhttps://ci.appveyor.com/project/line/armeria/builds/33590131/job/ldyjqjdblci54j2q#L58\n\n```\nServerMaxConnectionAgeTest > [1] protocol=H1C FAILED\n    org.awaitility.core.ConditionTimeoutException: Assertion condition defined as a lambda expression in com.linecorp.armeria.server.ServerMaxConnectionAgeTest that uses com.linecorp.armeria.common.SessionProtocol\n    Expecting:\n      <1845.49376>\n    to be close to:\n      <1000.0>\n    by less than 25% but difference was 84.54937600000001%\n```\n\nModifications:\n\n* Modify the tolerance to between 0.8 seconds to 2 seconds from relative 25%\n\nResult:\n\nLess flaky", "committedDate": "2020-06-18T03:51:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjAwODg3NA==", "url": "https://github.com/line/armeria/pull/2808#discussion_r442008874", "bodyText": "200.0 and 2.0 ?", "author": "trustin", "createdAt": "2020-06-18T07:00:20Z", "path": "core/src/test/java/com/linecorp/armeria/server/ServerMaxConnectionAgeTest.java", "diffHunk": "@@ -159,13 +159,15 @@ public void connectionClosed(SessionProtocol protocol, InetSocketAddress remoteA\n                             \"armeria.server.connections.lifespan.percentile#value{phi=0,protocol=\" +\n                             protocol.uriText() + '}',\n                             value -> {\n-                                assertThat(value * 1000).isCloseTo(MAX_CONNECTION_AGE, withinPercentage(25));\n+                                assertThat(value * 1000)\n+                                        .isBetween(MAX_CONNECTION_AGE - 200D, MAX_CONNECTION_AGE * 2D);", "originalCommit": "65b66ff5f713f76599742f7bcb597b83f68a38ef", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c7c6c6c9da1998123efb7c86d73783f1f6b38ee8", "chunk": "diff --git a/core/src/test/java/com/linecorp/armeria/server/ServerMaxConnectionAgeTest.java b/core/src/test/java/com/linecorp/armeria/server/ServerMaxConnectionAgeTest.java\nindex 2eb8afb8ee..2ca5dd2fb0 100644\n--- a/core/src/test/java/com/linecorp/armeria/server/ServerMaxConnectionAgeTest.java\n+++ b/core/src/test/java/com/linecorp/armeria/server/ServerMaxConnectionAgeTest.java\n\n@@ -160,14 +159,14 @@ class ServerMaxConnectionAgeTest {\n                             protocol.uriText() + '}',\n                             value -> {\n                                 assertThat(value * 1000)\n-                                        .isBetween(MAX_CONNECTION_AGE - 200D, MAX_CONNECTION_AGE * 2D);\n+                                        .isBetween(MAX_CONNECTION_AGE - 200.0, MAX_CONNECTION_AGE + 1000.0);\n                             })\n                     .hasEntrySatisfying(\n                             \"armeria.server.connections.lifespan.percentile#value{phi=1,protocol=\" +\n                             protocol.uriText() + '}',\n                             value -> {\n                                 assertThat(value * 1000)\n-                                        .isBetween(MAX_CONNECTION_AGE - 100D, MAX_CONNECTION_AGE * 2D);\n+                                        .isBetween(MAX_CONNECTION_AGE - 200.0, MAX_CONNECTION_AGE + 1000.0);\n                             })\n                     .hasEntrySatisfying(\n                             \"armeria.server.connections.lifespan#count{protocol=\" + protocol.uriText() + '}',\n"}}, {"oid": "c7c6c6c9da1998123efb7c86d73783f1f6b38ee8", "url": "https://github.com/line/armeria/commit/c7c6c6c9da1998123efb7c86d73783f1f6b38ee8", "message": "Address comments by @trustin, @minwoox", "committedDate": "2020-06-18T07:08:56Z", "type": "commit"}, {"oid": "01c00572cc770f171ecb7402edec774bdc21a7fe", "url": "https://github.com/line/armeria/commit/01c00572cc770f171ecb7402edec774bdc21a7fe", "message": "\ud83e\udd26\u200d\u2642\ufe0f", "committedDate": "2020-06-18T08:01:48Z", "type": "commit"}]}