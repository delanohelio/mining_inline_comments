{"pr_number": 2537, "pr_title": "Fix a bug where `ctx.set*Timeout()` does not schedule a timeout", "pr_createdAt": "2020-02-27T02:32:34Z", "pr_url": "https://github.com/line/armeria/pull/2537", "timeline": [{"oid": "d5132aa3017c14d50c8cbb22bd56018932f8d09f", "url": "https://github.com/line/armeria/commit/d5132aa3017c14d50c8cbb22bd56018932f8d09f", "message": "Fix a bug where a timeout is not updated by `set{Request,Response}Timeout*`\n\nMotivation:\n\nWhen a timeout is not scheduled for a request, a new timeout set by\n`set{Request,Response}Timeout` does not work well.\nSee #2535\n\nModifications:\n\n- Make `set{Request,Response}Timeout` call `set{Request,Reponse}TimeoutAfterMillis`\n  if a timeout is not scheduled yet.\n\nResult:\nThe `set{Request,Response}Timeout*` properly set the new timeout when no timeout is scheduled.", "committedDate": "2020-02-27T02:29:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDk0MDA4NA==", "url": "https://github.com/line/armeria/pull/2537#discussion_r384940084", "bodyText": "responseTimeoutMillis > 0 is always true at this point.", "author": "trustin", "createdAt": "2020-02-27T06:49:54Z", "path": "core/src/main/java/com/linecorp/armeria/client/DefaultClientRequestContext.java", "diffHunk": "@@ -459,6 +459,11 @@ public void setResponseTimeoutMillis(long responseTimeoutMillis) {\n             clearResponseTimeout();\n         }\n \n+        if (this.responseTimeoutMillis == 0 && responseTimeoutMillis > 0) {", "originalCommit": "d5132aa3017c14d50c8cbb22bd56018932f8d09f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDk0MjE2OQ==", "url": "https://github.com/line/armeria/pull/2537#discussion_r384942169", "bodyText": "Oops..", "author": "ikhoon", "createdAt": "2020-02-27T06:57:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDk0MDA4NA=="}], "type": "inlineReview", "revised_code": {"commit": "172aacc90e8154577696d493d2cd013985be2270", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/DefaultClientRequestContext.java b/core/src/main/java/com/linecorp/armeria/client/DefaultClientRequestContext.java\nindex aa619be4ff..1cb198d84c 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/DefaultClientRequestContext.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/DefaultClientRequestContext.java\n\n@@ -457,9 +457,10 @@ public final class DefaultClientRequestContext\n                       \"responseTimeoutMillis: %s (expected: >= 0)\", responseTimeoutMillis);\n         if (responseTimeoutMillis == 0) {\n             clearResponseTimeout();\n+            return;\n         }\n \n-        if (this.responseTimeoutMillis == 0 && responseTimeoutMillis > 0) {\n+        if (this.responseTimeoutMillis == 0) {\n             setResponseTimeoutAfterMillis(responseTimeoutMillis);\n             return;\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDk0MDE0NA==", "url": "https://github.com/line/armeria/pull/2537#discussion_r384940144", "bodyText": "Ditto", "author": "trustin", "createdAt": "2020-02-27T06:50:07Z", "path": "core/src/main/java/com/linecorp/armeria/server/DefaultServiceRequestContext.java", "diffHunk": "@@ -339,6 +339,11 @@ public void setRequestTimeoutMillis(long requestTimeoutMillis) {\n             clearRequestTimeout();\n         }\n \n+        if (this.requestTimeoutMillis == 0 && requestTimeoutMillis > 0) {", "originalCommit": "d5132aa3017c14d50c8cbb22bd56018932f8d09f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "172aacc90e8154577696d493d2cd013985be2270", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/server/DefaultServiceRequestContext.java b/core/src/main/java/com/linecorp/armeria/server/DefaultServiceRequestContext.java\nindex f458438a9f..5216e73be7 100644\n--- a/core/src/main/java/com/linecorp/armeria/server/DefaultServiceRequestContext.java\n+++ b/core/src/main/java/com/linecorp/armeria/server/DefaultServiceRequestContext.java\n\n@@ -337,9 +337,10 @@ public final class DefaultServiceRequestContext\n                       \"requestTimeoutMillis: %s (expected: >= 0)\", requestTimeoutMillis);\n         if (requestTimeoutMillis == 0) {\n             clearRequestTimeout();\n+            return;\n         }\n \n-        if (this.requestTimeoutMillis == 0 && requestTimeoutMillis > 0) {\n+        if (this.requestTimeoutMillis == 0) {\n             setRequestTimeoutAfterMillis(requestTimeoutMillis);\n             return;\n         }\n"}}, {"oid": "172aacc90e8154577696d493d2cd013985be2270", "url": "https://github.com/line/armeria/commit/172aacc90e8154577696d493d2cd013985be2270", "message": "Address comments by @trustin", "committedDate": "2020-02-27T06:54:32Z", "type": "commit"}, {"oid": "9c08370a0e2009c628cb87f382576e31c8cfdfc8", "url": "https://github.com/line/armeria/commit/9c08370a0e2009c628cb87f382576e31c8cfdfc8", "message": "Fix indent", "committedDate": "2020-02-27T06:58:35Z", "type": "commit"}]}