{"pr_number": 2781, "pr_title": "Logback <exports> tag does not work", "pr_createdAt": "2020-06-06T01:32:07Z", "pr_url": "https://github.com/line/armeria/pull/2781", "timeline": [{"oid": "5d72870ea33c30e62aa82b10ace7605ffac6dc37", "url": "https://github.com/line/armeria/commit/5d72870ea33c30e62aa82b10ace7605ffac6dc37", "message": "Fix RequestContextExportingAppender#setExports", "committedDate": "2020-06-06T01:24:30Z", "type": "commit"}, {"oid": "4316a3fcab5f985a8b090a003618e58ac5f263c7", "url": "https://github.com/line/armeria/commit/4316a3fcab5f985a8b090a003618e58ac5f263c7", "message": "Add test for <exports> tag", "committedDate": "2020-06-06T01:53:46Z", "type": "forcePushed"}, {"oid": "04da57d8f484f5c1816b58f8d48222ef955b6a88", "url": "https://github.com/line/armeria/commit/04da57d8f484f5c1816b58f8d48222ef955b6a88", "message": "Add test for <exports> tag", "committedDate": "2020-06-06T01:57:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIyNzcyNg==", "url": "https://github.com/line/armeria/pull/2781#discussion_r436227726", "bodyText": "Not related to this PR, could you add a checkArguments that checks mdfKeys is non-empty?", "author": "ikhoon", "createdAt": "2020-06-06T02:03:04Z", "path": "logback/src/main/java/com/linecorp/armeria/common/logback/RequestContextExportingAppender.java", "diffHunk": "@@ -144,7 +145,7 @@ public void setExport(String mdcKey) {\n      */\n     public void setExports(String mdcKeys) {\n         requireNonNull(mdcKeys, \"mdcKeys\");", "originalCommit": "04da57d8f484f5c1816b58f8d48222ef955b6a88", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIyOTA0Mw==", "url": "https://github.com/line/armeria/pull/2781#discussion_r436229043", "bodyText": "Sure. I added checkArguments.", "author": "okue", "createdAt": "2020-06-06T02:22:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIyNzcyNg=="}], "type": "inlineReview", "revised_code": {"commit": "28bd436e44b4eebd40f93ad8bb4faabdc0481f58", "chunk": "diff --git a/logback/src/main/java/com/linecorp/armeria/common/logback/RequestContextExportingAppender.java b/logback/src/main/java/com/linecorp/armeria/common/logback/RequestContextExportingAppender.java\nindex 5d72c5fd2..8ece7323d 100644\n--- a/logback/src/main/java/com/linecorp/armeria/common/logback/RequestContextExportingAppender.java\n+++ b/logback/src/main/java/com/linecorp/armeria/common/logback/RequestContextExportingAppender.java\n\n@@ -145,6 +147,7 @@ public final class RequestContextExportingAppender\n      */\n     public void setExports(String mdcKeys) {\n         requireNonNull(mdcKeys, \"mdcKeys\");\n+        checkArgument(!mdcKeys.isEmpty(), \"mdcKeys must not be empty\");\n         Arrays.stream(mdcKeys.split(\",\")).map(String::trim).forEach(builder::addKeyPattern);\n     }\n \n"}}, {"oid": "28bd436e44b4eebd40f93ad8bb4faabdc0481f58", "url": "https://github.com/line/armeria/commit/28bd436e44b4eebd40f93ad8bb4faabdc0481f58", "message": "Add test for <exports> tag", "committedDate": "2020-06-06T02:20:07Z", "type": "commit"}, {"oid": "28bd436e44b4eebd40f93ad8bb4faabdc0481f58", "url": "https://github.com/line/armeria/commit/28bd436e44b4eebd40f93ad8bb4faabdc0481f58", "message": "Add test for <exports> tag", "committedDate": "2020-06-06T02:20:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3OTE5Mg==", "url": "https://github.com/line/armeria/pull/2781#discussion_r436279192", "bodyText": "I think we could optimize this when mdcKeys.split(\",\").length == 1.", "author": "ikhoon", "createdAt": "2020-06-06T15:54:39Z", "path": "logback/src/main/java/com/linecorp/armeria/common/logback/RequestContextExportingAppender.java", "diffHunk": "@@ -144,7 +147,8 @@ public void setExport(String mdcKey) {\n      */\n     public void setExports(String mdcKeys) {\n         requireNonNull(mdcKeys, \"mdcKeys\");\n-        builder.addKeyPattern(mdcKeys);\n+        checkArgument(!mdcKeys.isEmpty(), \"mdcKeys must not be empty\");\n+        Arrays.stream(mdcKeys.split(\",\")).map(String::trim).forEach(builder::addKeyPattern);", "originalCommit": "28bd436e44b4eebd40f93ad8bb4faabdc0481f58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMzMzgyMA==", "url": "https://github.com/line/armeria/pull/2781#discussion_r436333820", "bodyText": "setExports looks to be called only once.\nDo we need an optimization?", "author": "okue", "createdAt": "2020-06-07T07:18:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3OTE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQzMTkyOA==", "url": "https://github.com/line/armeria/pull/2781#discussion_r436431928", "bodyText": "That could be called multiple times according to the logback.xml.\nBy the way, it seems overkill. Let's leave it as it is. \ud83d\ude00", "author": "ikhoon", "createdAt": "2020-06-08T02:30:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3OTE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ0MDExNA==", "url": "https://github.com/line/armeria/pull/2781#discussion_r436440114", "bodyText": "Let's use the splitter from Guava so that we don't have to trim again. \ud83d\ude09\nprivate static final Splitter KEY_SPLITTER = Splitter.on(',').trimResults();\n...\nKEY_SPLITTER.split(mdcKeys).forEach(builder::addKeyPattern);", "author": "minwoox", "createdAt": "2020-06-08T03:21:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3OTE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ3Nzk2MQ==", "url": "https://github.com/line/armeria/pull/2781#discussion_r436477961", "bodyText": "Thanks \ud83d\ude4f\nI use it ab8e780", "author": "okue", "createdAt": "2020-06-08T06:22:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3OTE5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "d84c87589a4b206fab02dbc66abe693d8e48c040", "chunk": "diff --git a/logback/src/main/java/com/linecorp/armeria/common/logback/RequestContextExportingAppender.java b/logback/src/main/java/com/linecorp/armeria/common/logback/RequestContextExportingAppender.java\nindex 8ece7323d..7e06e1d4a 100644\n--- a/logback/src/main/java/com/linecorp/armeria/common/logback/RequestContextExportingAppender.java\n+++ b/logback/src/main/java/com/linecorp/armeria/common/logback/RequestContextExportingAppender.java\n\n@@ -147,8 +149,11 @@ public final class RequestContextExportingAppender\n      */\n     public void setExports(String mdcKeys) {\n         requireNonNull(mdcKeys, \"mdcKeys\");\n-        checkArgument(!mdcKeys.isEmpty(), \"mdcKeys must not be empty\");\n-        Arrays.stream(mdcKeys.split(\",\")).map(String::trim).forEach(builder::addKeyPattern);\n+        KEY_SPLITTER.split(mdcKeys)\n+                    .forEach(it -> {\n+                        checkArgument(!it.isEmpty(), \"comma-separated MDC key must not be empty\");\n+                        builder.addKeyPattern(it);\n+                    });\n     }\n \n     private void ensureNotStarted() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ3Nzg0MA==", "url": "https://github.com/line/armeria/pull/2781#discussion_r436477840", "bodyText": "How about checking after splitting?", "author": "trustin", "createdAt": "2020-06-08T06:21:55Z", "path": "logback/src/main/java/com/linecorp/armeria/common/logback/RequestContextExportingAppender.java", "diffHunk": "@@ -144,7 +149,8 @@ public void setExport(String mdcKey) {\n      */\n     public void setExports(String mdcKeys) {\n         requireNonNull(mdcKeys, \"mdcKeys\");\n-        builder.addKeyPattern(mdcKeys);\n+        checkArgument(!mdcKeys.isEmpty(), \"mdcKeys must not be empty\");\n+        KEY_SPLITTER.split(mdcKeys).forEach(builder::addKeyPattern);", "originalCommit": "ab8e780f33aeb5007ff8072232282fb4b0fdea5f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY3ODM5NA==", "url": "https://github.com/line/armeria/pull/2781#discussion_r436678394", "bodyText": "OK \ud83d\ude47", "author": "okue", "createdAt": "2020-06-08T13:04:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ3Nzg0MA=="}], "type": "inlineReview", "revised_code": {"commit": "d84c87589a4b206fab02dbc66abe693d8e48c040", "chunk": "diff --git a/logback/src/main/java/com/linecorp/armeria/common/logback/RequestContextExportingAppender.java b/logback/src/main/java/com/linecorp/armeria/common/logback/RequestContextExportingAppender.java\nindex 90d643166..7e06e1d4a 100644\n--- a/logback/src/main/java/com/linecorp/armeria/common/logback/RequestContextExportingAppender.java\n+++ b/logback/src/main/java/com/linecorp/armeria/common/logback/RequestContextExportingAppender.java\n\n@@ -149,8 +149,11 @@ public final class RequestContextExportingAppender\n      */\n     public void setExports(String mdcKeys) {\n         requireNonNull(mdcKeys, \"mdcKeys\");\n-        checkArgument(!mdcKeys.isEmpty(), \"mdcKeys must not be empty\");\n-        KEY_SPLITTER.split(mdcKeys).forEach(builder::addKeyPattern);\n+        KEY_SPLITTER.split(mdcKeys)\n+                    .forEach(it -> {\n+                        checkArgument(!it.isEmpty(), \"comma-separated MDC key must not be empty\");\n+                        builder.addKeyPattern(it);\n+                    });\n     }\n \n     private void ensureNotStarted() {\n"}}, {"oid": "d84c87589a4b206fab02dbc66abe693d8e48c040", "url": "https://github.com/line/armeria/commit/d84c87589a4b206fab02dbc66abe693d8e48c040", "message": "Improve splitting the comma-separated MDC keys", "committedDate": "2020-06-08T06:31:53Z", "type": "forcePushed"}, {"oid": "cd26ae4e0e1ef050804d6edc30e9b10c090f748a", "url": "https://github.com/line/armeria/commit/cd26ae4e0e1ef050804d6edc30e9b10c090f748a", "message": "Improve splitting the comma-separated MDC keys", "committedDate": "2020-06-08T06:39:33Z", "type": "forcePushed"}, {"oid": "07607bc231cbfb8ee4f368b60a67253e048a343e", "url": "https://github.com/line/armeria/commit/07607bc231cbfb8ee4f368b60a67253e048a343e", "message": "Improve splitting comma-sepalated mdc keys", "committedDate": "2020-06-08T06:41:41Z", "type": "commit"}, {"oid": "07607bc231cbfb8ee4f368b60a67253e048a343e", "url": "https://github.com/line/armeria/commit/07607bc231cbfb8ee4f368b60a67253e048a343e", "message": "Improve splitting comma-sepalated mdc keys", "committedDate": "2020-06-08T06:41:41Z", "type": "forcePushed"}]}