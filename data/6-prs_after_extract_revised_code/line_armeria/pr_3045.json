{"pr_number": 3045, "pr_title": "Fix a bug where Armeria client closes a connection when receiving an HTTP2 stream initiated by server", "pr_createdAt": "2020-09-03T12:13:39Z", "pr_url": "https://github.com/line/armeria/pull/3045", "timeline": [{"oid": "b646b0cc1bd510e440da5a9dfeb795e796bfec63", "url": "https://github.com/line/armeria/commit/b646b0cc1bd510e440da5a9dfeb795e796bfec63", "message": "Fix a bug where Armeria client closes a connection when receiving an HTTP2 stream initiated by server.\n\nMotivation:\n\nArmeria client does not support HTTP2 `PUSH_PROMISE` that initiates a stream from the server.\nArmeria client just ignores `PUSH_PROMISE` frame.\nhttps://github.com/line/armeria/blob/744098d4ed83a65c6668fd863afebae14f5e2a1c/core/src/main/java/com/linecorp/armeria/client/Http2ResponseDecoder.java#L287-L288\nIt is not correct behavior on a recipient that wants to reject `PUSH_PROMISE`.\nFrom the HTTP2 spec, the recipient should return `RST_STREAM` to reject `PUSH_PROMISE`.\n\n> Recipients of PUSH_PROMISE frames can choose to reject promised\n  streams by returning a RST_STREAM referencing the promised stream\n  identifier back to the sender of the PUSH_PROMISE.\n\nA server, which does not receive `RST_STREAM` on `PUSH_PROMISE`, sends HEADERS and DATA using the promised stream ID.\nHowever, Armeria client regards the promised stream ID is an unknown stream and closes the connection.\n\nModifications:\n\n- Send a `RST_STREAM` referencing the promised stream ID when receiving `PUSH_PROMISED`\n\nResult:\n\n- Armeria client rejects `PUSH_PROMISE` frame correctly.", "committedDate": "2020-09-03T12:12:17Z", "type": "commit"}, {"oid": "96f07da4d4c8131da29e956121f3b5384f62de35", "url": "https://github.com/line/armeria/commit/96f07da4d4c8131da29e956121f3b5384f62de35", "message": "Add final", "committedDate": "2020-09-03T12:17:20Z", "type": "commit"}, {"oid": "4f0a24d71bcf0940bd4f837801335a4f37b841de", "url": "https://github.com/line/armeria/commit/4f0a24d71bcf0940bd4f837801335a4f37b841de", "message": "Clean up", "committedDate": "2020-09-04T01:45:34Z", "type": "commit"}, {"oid": "01c13a776f638a9c4e604c6afd439c37c1715442", "url": "https://github.com/line/armeria/commit/01c13a776f638a9c4e604c6afd439c37c1715442", "message": "Checkstyle", "committedDate": "2020-09-07T03:11:07Z", "type": "commit"}, {"oid": "15219b252f19d12a3cf499c3ef6a540ebf36972f", "url": "https://github.com/line/armeria/commit/15219b252f19d12a3cf499c3ef6a540ebf36972f", "message": "Fix flaky test", "committedDate": "2020-09-09T08:23:19Z", "type": "commit"}, {"oid": "2864e58c6628258d1bf75d44844ba0f5a6318d64", "url": "https://github.com/line/armeria/commit/2864e58c6628258d1bf75d44844ba0f5a6318d64", "message": "Address comments by @minwoox", "committedDate": "2020-09-09T11:45:24Z", "type": "commit"}, {"oid": "355dca260f126126b264dee0006239100bf1634f", "url": "https://github.com/line/armeria/commit/355dca260f126126b264dee0006239100bf1634f", "message": "Fix test", "committedDate": "2020-09-09T12:18:59Z", "type": "commit"}, {"oid": "0b7e9f68271acdda9a0daa74b6d201f7118858d5", "url": "https://github.com/line/armeria/commit/0b7e9f68271acdda9a0daa74b6d201f7118858d5", "message": "Fix broken tests", "committedDate": "2020-09-09T15:19:32Z", "type": "commit"}, {"oid": "faf6c6f6495e8e200a55483355c8ecceb9d134e8", "url": "https://github.com/line/armeria/commit/faf6c6f6495e8e200a55483355c8ecceb9d134e8", "message": "Indent", "committedDate": "2020-09-09T15:20:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAxMDY5Ng==", "url": "https://github.com/line/armeria/pull/3045#discussion_r486010696", "bodyText": "I'm a bit confused that these lines are not covered by tests. Is this a bug? \ud83d\ude05", "author": "minwoox", "createdAt": "2020-09-10T01:34:18Z", "path": "core/src/main/java/com/linecorp/armeria/client/Http2ResponseDecoder.java", "diffHunk": "@@ -285,7 +285,10 @@ public void onRstStreamRead(ChannelHandlerContext ctx, int streamId, long errorC\n \n     @Override\n     public void onPushPromiseRead(ChannelHandlerContext ctx, int streamId, int promisedStreamId,\n-                                  Http2Headers headers, int padding) {}\n+                                  Http2Headers headers, int padding) {\n+        encoder.writeRstStream(ctx, promisedStreamId, Http2Error.REFUSED_STREAM.code(), ctx.newPromise());\n+        ctx.flush();\n+    }", "originalCommit": "faf6c6f6495e8e200a55483355c8ecceb9d134e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA1MzcyNQ==", "url": "https://github.com/line/armeria/pull/3045#discussion_r486053725", "bodyText": "We don't need this code anymore because PUSH_PROMISE is disabled by default.\nI left it in case that a certain server does not respect SETTINGS_ENABLE_PUSH disable well, but it would be better to revert these lines.", "author": "ikhoon", "createdAt": "2020-09-10T04:21:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAxMDY5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA1NDIxNw==", "url": "https://github.com/line/armeria/pull/3045#discussion_r486054217", "bodyText": "By the way, the quality of Codecov report is pretty good. \ud83d\ude00", "author": "ikhoon", "createdAt": "2020-09-10T04:23:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAxMDY5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA1NjMxNA==", "url": "https://github.com/line/armeria/pull/3045#discussion_r486056314", "bodyText": "Got it. \ud83d\ude04", "author": "minwoox", "createdAt": "2020-09-10T04:30:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAxMDY5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "824cc6844bfd9a6c115967b7cd8dfb30197db5ca", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/Http2ResponseDecoder.java b/core/src/main/java/com/linecorp/armeria/client/Http2ResponseDecoder.java\nindex cc8c3b6e1c..8e5d14cc48 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/Http2ResponseDecoder.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/Http2ResponseDecoder.java\n\n@@ -285,10 +285,7 @@ final class Http2ResponseDecoder extends HttpResponseDecoder implements Http2Con\n \n     @Override\n     public void onPushPromiseRead(ChannelHandlerContext ctx, int streamId, int promisedStreamId,\n-                                  Http2Headers headers, int padding) {\n-        encoder.writeRstStream(ctx, promisedStreamId, Http2Error.REFUSED_STREAM.code(), ctx.newPromise());\n-        ctx.flush();\n-    }\n+                                  Http2Headers headers, int padding) {}\n \n     @Override\n     public void onPriorityRead(ChannelHandlerContext ctx, int streamId, int streamDependency, short weight,\n"}}, {"oid": "824cc6844bfd9a6c115967b7cd8dfb30197db5ca", "url": "https://github.com/line/armeria/commit/824cc6844bfd9a6c115967b7cd8dfb30197db5ca", "message": "Revert RST_STREAM in onPushPromiseRead", "committedDate": "2020-09-10T04:24:56Z", "type": "commit"}]}