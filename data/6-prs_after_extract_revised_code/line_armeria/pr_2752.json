{"pr_number": 2752, "pr_title": "Introduce ProxyConfigSelector", "pr_createdAt": "2020-05-30T09:12:06Z", "pr_url": "https://github.com/line/armeria/pull/2752", "timeline": [{"oid": "e5e4a90acae10c24c320fa90f1ab87815cd1a055", "url": "https://github.com/line/armeria/commit/e5e4a90acae10c24c320fa90f1ab87815cd1a055", "message": "Introduce selector for proxy", "committedDate": "2020-05-30T09:44:52Z", "type": "commit"}, {"oid": "8286ac527faa0a521dae19dd23a9f372b1523c11", "url": "https://github.com/line/armeria/commit/8286ac527faa0a521dae19dd23a9f372b1523c11", "message": "add basic tests", "committedDate": "2020-05-31T04:26:38Z", "type": "forcePushed"}, {"oid": "6dabdf2a10bbe5215a83f5b9debaa1824717a3bc", "url": "https://github.com/line/armeria/commit/6dabdf2a10bbe5215a83f5b9debaa1824717a3bc", "message": "add basic tests", "committedDate": "2020-05-31T04:37:28Z", "type": "forcePushed"}, {"oid": "2b2aedc110d50f7606649e5d02807b7bdf1c2a69", "url": "https://github.com/line/armeria/commit/2b2aedc110d50f7606649e5d02807b7bdf1c2a69", "message": "add basic tests\n\nrename originalUri to reqUri", "committedDate": "2020-05-31T04:44:37Z", "type": "commit"}, {"oid": "2b2aedc110d50f7606649e5d02807b7bdf1c2a69", "url": "https://github.com/line/armeria/commit/2b2aedc110d50f7606649e5d02807b7bdf1c2a69", "message": "add basic tests\n\nrename originalUri to reqUri", "committedDate": "2020-05-31T04:44:37Z", "type": "forcePushed"}, {"oid": "5fcdc87d25a837525315ba59aa338aaec29601ba", "url": "https://github.com/line/armeria/commit/5fcdc87d25a837525315ba59aa338aaec29601ba", "message": "handle null nonProxyHosts", "committedDate": "2020-05-31T05:11:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjkxMTU2MA==", "url": "https://github.com/line/armeria/pull/2752#discussion_r432911560", "bodyText": "This can be up for debate.\nWhile users may expect DefaultProxySelector will be used out of the box, it's select implementation isn't very efficient (even for DIRECT cases) affecting normal client calls.\nhttps://github.com/openjdk/jdk/blob/6212aea580fd018b9b7edecad9821c8208d2a12e/src/java.base/share/classes/sun/net/spi/DefaultProxySelector.java#L153-L326", "author": "jrhee17", "createdAt": "2020-05-31T05:33:23Z", "path": "core/src/main/java/com/linecorp/armeria/client/ClientFactoryBuilder.java", "diffHunk": "@@ -578,6 +592,10 @@ private ClientFactoryOptions buildOptions() {\n             return ClientFactoryOption.ADDRESS_RESOLVER_GROUP_FACTORY.newValue(addressResolverGroupFactory);\n         });\n \n+        final ProxyConfigSelector selector = WrappingProxyConfigSelector.of(ProxySelector.getDefault());", "originalCommit": "5fcdc87d25a837525315ba59aa338aaec29601ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzAxOTAyMA==", "url": "https://github.com/line/armeria/pull/2752#discussion_r433019020", "bodyText": "That's a good question. It seems like JDK's default selector may not work with Armeria, either, because it doesn't understand schemes like h2c. Let's use DIRECT by default until we have a proper ProxyConfigSelector implementation.", "author": "trustin", "createdAt": "2020-06-01T02:36:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjkxMTU2MA=="}], "type": "inlineReview", "revised_code": {"commit": "eea39f080ce52128a9fcd9e163bca9e4d19963be", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/ClientFactoryBuilder.java b/core/src/main/java/com/linecorp/armeria/client/ClientFactoryBuilder.java\nindex ed6c871b8..bd8b2aead 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/ClientFactoryBuilder.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/ClientFactoryBuilder.java\n\n@@ -592,10 +600,6 @@ public final class ClientFactoryBuilder {\n             return ClientFactoryOption.ADDRESS_RESOLVER_GROUP_FACTORY.newValue(addressResolverGroupFactory);\n         });\n \n-        final ProxyConfigSelector selector = WrappingProxyConfigSelector.of(ProxySelector.getDefault());\n-        options.computeIfAbsent(ClientFactoryOption.PROXY_CONFIG_SELECTOR, k ->\n-                ClientFactoryOption.PROXY_CONFIG_SELECTOR.newValue(selector));\n-\n         final ClientFactoryOptions newOptions = ClientFactoryOptions.of(options.values());\n         final long idleTimeoutMillis = newOptions.idleTimeoutMillis();\n         final long pingIntervalMillis = newOptions.pingIntervalMillis();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzAxNzcyNA==", "url": "https://github.com/line/armeria/pull/2752#discussion_r433017724", "bodyText": "Could we also have an overloaded version that accepts ProxySelector, if WrappingProxyConfigSelector works with any custom ProxySelector implementations?\nHow about renaming this method to proxyConfig()? Because:\n\nIt's shorter.\nIt seems to me that there won't be any conflict between any proxyConfig() methods we may add in the future.", "author": "trustin", "createdAt": "2020-06-01T02:28:20Z", "path": "core/src/main/java/com/linecorp/armeria/client/ClientFactoryBuilder.java", "diffHunk": "@@ -512,7 +516,17 @@ public ClientFactoryBuilder meterRegistry(MeterRegistry meterRegistry) {\n      * The {@link ProxyConfig} which contains proxy related configuration.\n      */\n     public ClientFactoryBuilder proxyConfig(ProxyConfig proxyConfig) {\n-        option(ClientFactoryOption.PROXY_CONFIG, proxyConfig);\n+        requireNonNull(proxyConfig, \"proxyConfig\");\n+        option(ClientFactoryOption.PROXY_CONFIG_SELECTOR, StaticProxyConfigSelector.of(proxyConfig));\n+        return this;\n+    }\n+\n+    /**\n+     * The {@link ProxyConfigSelector} which contains proxy related configuration.\n+     */\n+    public ClientFactoryBuilder proxyConfigSelector(ProxyConfigSelector proxyConfigSelector) {", "originalCommit": "5fcdc87d25a837525315ba59aa338aaec29601ba", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "eea39f080ce52128a9fcd9e163bca9e4d19963be", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/ClientFactoryBuilder.java b/core/src/main/java/com/linecorp/armeria/client/ClientFactoryBuilder.java\nindex ed6c871b8..bd8b2aead 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/ClientFactoryBuilder.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/ClientFactoryBuilder.java\n\n@@ -513,7 +512,7 @@ public final class ClientFactoryBuilder {\n     }\n \n     /**\n-     * The {@link ProxyConfig} which contains proxy related configuration.\n+     * Sets the {@link ProxyConfig} which contains proxy related configuration.\n      */\n     public ClientFactoryBuilder proxyConfig(ProxyConfig proxyConfig) {\n         requireNonNull(proxyConfig, \"proxyConfig\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzAxODIyNA==", "url": "https://github.com/line/armeria/pull/2752#discussion_r433018224", "bodyText": "selector could be created inside this lambda expression to avoid unnecessary instantiation of WrappingProxyConfigSelector.", "author": "trustin", "createdAt": "2020-06-01T02:32:01Z", "path": "core/src/main/java/com/linecorp/armeria/client/ClientFactoryBuilder.java", "diffHunk": "@@ -578,6 +592,10 @@ private ClientFactoryOptions buildOptions() {\n             return ClientFactoryOption.ADDRESS_RESOLVER_GROUP_FACTORY.newValue(addressResolverGroupFactory);\n         });\n \n+        final ProxyConfigSelector selector = WrappingProxyConfigSelector.of(ProxySelector.getDefault());\n+        options.computeIfAbsent(ClientFactoryOption.PROXY_CONFIG_SELECTOR, k ->\n+                ClientFactoryOption.PROXY_CONFIG_SELECTOR.newValue(selector));", "originalCommit": "5fcdc87d25a837525315ba59aa338aaec29601ba", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "eea39f080ce52128a9fcd9e163bca9e4d19963be", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/ClientFactoryBuilder.java b/core/src/main/java/com/linecorp/armeria/client/ClientFactoryBuilder.java\nindex ed6c871b8..bd8b2aead 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/ClientFactoryBuilder.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/ClientFactoryBuilder.java\n\n@@ -592,10 +600,6 @@ public final class ClientFactoryBuilder {\n             return ClientFactoryOption.ADDRESS_RESOLVER_GROUP_FACTORY.newValue(addressResolverGroupFactory);\n         });\n \n-        final ProxyConfigSelector selector = WrappingProxyConfigSelector.of(ProxySelector.getDefault());\n-        options.computeIfAbsent(ClientFactoryOption.PROXY_CONFIG_SELECTOR, k ->\n-                ClientFactoryOption.PROXY_CONFIG_SELECTOR.newValue(selector));\n-\n         final ClientFactoryOptions newOptions = ClientFactoryOptions.of(options.values());\n         final long idleTimeoutMillis = newOptions.idleTimeoutMillis();\n         final long pingIntervalMillis = newOptions.pingIntervalMillis();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzAxOTcyMw==", "url": "https://github.com/line/armeria/pull/2752#discussion_r433019723", "bodyText": "reqUri could come before the promise. (because it looks more organized? promise/future usually comes at the end (or the first) because it's a sort of an output parameter.)", "author": "trustin", "createdAt": "2020-06-01T02:41:12Z", "path": "core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java", "diffHunk": "@@ -373,14 +386,26 @@ private void connect(SessionProtocol desiredProtocol, PoolKey key, ChannelAcquis\n      * A low-level operation that triggers a new connection attempt. Used only by:\n      * <ul>\n      *   <li>{@link #connect(SessionProtocol, PoolKey, ChannelAcquisitionFuture,\n-     *       ClientConnectionTimingsBuilder)} - The pool has been exhausted.</li>\n+     *       ClientConnectionTimingsBuilder, URI)} - The pool has been exhausted.</li>\n      *   <li>{@link HttpSessionHandler} - HTTP/2 upgrade has failed.</li>\n      * </ul>\n      */\n     void connect(SocketAddress remoteAddress, SessionProtocol desiredProtocol,\n-                 Promise<Channel> sessionPromise) {\n+                 Promise<Channel> sessionPromise, URI reqUri) {", "originalCommit": "5fcdc87d25a837525315ba59aa338aaec29601ba", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "eea39f080ce52128a9fcd9e163bca9e4d19963be", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java b/core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java\nindex b0f462795..a1419272c 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java\n\n@@ -386,36 +393,43 @@ final class HttpChannelPool implements AsyncCloseable {\n      * A low-level operation that triggers a new connection attempt. Used only by:\n      * <ul>\n      *   <li>{@link #connect(SessionProtocol, PoolKey, ChannelAcquisitionFuture,\n-     *       ClientConnectionTimingsBuilder, URI)} - The pool has been exhausted.</li>\n+     *       ClientConnectionTimingsBuilder, ProxyContext)} - The pool has been exhausted.</li>\n      *   <li>{@link HttpSessionHandler} - HTTP/2 upgrade has failed.</li>\n      * </ul>\n      */\n     void connect(SocketAddress remoteAddress, SessionProtocol desiredProtocol,\n-                 Promise<Channel> sessionPromise, URI reqUri) {\n+                 ProxyContext proxyContext, Promise<Channel> sessionPromise) {\n \n         final Bootstrap bootstrap = getBootstrap(desiredProtocol);\n-        ProxyConfig proxyConfig;\n-        try {\n-            proxyConfig = proxyConfigSelector.select(reqUri);\n-        } catch (Throwable t) {\n-            logger.warn(\"Failed to select ProxyConfig for <{}> \", reqUri, t);\n-            proxyConfig = ProxyConfig.direct();\n-        }\n \n         final Channel channel = bootstrap.register().channel();\n-        channel.attr(REQUEST_URI_KEY).set(reqUri);\n-        configureProxy(channel, proxyConfig, desiredProtocol);\n+        channel.attr(PROXY_CONTEXT).set(proxyContext);\n+        configureProxy(channel, proxyContext.proxyConfig(), desiredProtocol);\n         final ChannelFuture connectFuture = channel.connect(remoteAddress);\n \n         connectFuture.addListener((ChannelFuture future) -> {\n             if (future.isSuccess()) {\n                 initSession(desiredProtocol, future, sessionPromise);\n             } else {\n+                invokeProxyConnectFailed(proxyContext, future.cause());\n                 sessionPromise.tryFailure(future.cause());\n             }\n         });\n     }\n \n+    void invokeProxyConnectFailed(ProxyContext proxyContext, Throwable cause) {\n+        try {\n+            final ProxyConfig proxyConfig = proxyContext.proxyConfig();\n+            if (proxyConfig.proxyType() != ProxyType.DIRECT) {\n+                final InetSocketAddress proxyAddress = proxyConfig.proxyAddress();\n+                assert proxyAddress != null;\n+                proxyConfigSelector.connectFailed(proxyContext.reqUri(), proxyAddress, cause);\n+            }\n+        } catch (Throwable t) {\n+            logger.warn(\"Exception while invoking proxy connectFailed for <{}> \", proxyContext, t);\n+        }\n+    }\n+\n     private static InetSocketAddress toRemoteAddress(PoolKey key) throws UnknownHostException {\n         final InetAddress inetAddr = InetAddress.getByAddress(\n                 key.host, NetUtil.createByteArrayFromIpAddressString(key.ipAddr));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzAxOTc3MA==", "url": "https://github.com/line/armeria/pull/2752#discussion_r433019770", "bodyText": "; falling back to DIRECT", "author": "trustin", "createdAt": "2020-06-01T02:41:33Z", "path": "core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java", "diffHunk": "@@ -373,14 +386,26 @@ private void connect(SessionProtocol desiredProtocol, PoolKey key, ChannelAcquis\n      * A low-level operation that triggers a new connection attempt. Used only by:\n      * <ul>\n      *   <li>{@link #connect(SessionProtocol, PoolKey, ChannelAcquisitionFuture,\n-     *       ClientConnectionTimingsBuilder)} - The pool has been exhausted.</li>\n+     *       ClientConnectionTimingsBuilder, URI)} - The pool has been exhausted.</li>\n      *   <li>{@link HttpSessionHandler} - HTTP/2 upgrade has failed.</li>\n      * </ul>\n      */\n     void connect(SocketAddress remoteAddress, SessionProtocol desiredProtocol,\n-                 Promise<Channel> sessionPromise) {\n+                 Promise<Channel> sessionPromise, URI reqUri) {\n+\n         final Bootstrap bootstrap = getBootstrap(desiredProtocol);\n-        final ChannelFuture connectFuture = bootstrap.connect(remoteAddress);\n+        ProxyConfig proxyConfig;\n+        try {\n+            proxyConfig = proxyConfigSelector.select(reqUri);\n+        } catch (Throwable t) {\n+            logger.warn(\"Failed to select ProxyConfig for <{}> \", reqUri, t);", "originalCommit": "5fcdc87d25a837525315ba59aa338aaec29601ba", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "eea39f080ce52128a9fcd9e163bca9e4d19963be", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java b/core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java\nindex b0f462795..a1419272c 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java\n\n@@ -386,36 +393,43 @@ final class HttpChannelPool implements AsyncCloseable {\n      * A low-level operation that triggers a new connection attempt. Used only by:\n      * <ul>\n      *   <li>{@link #connect(SessionProtocol, PoolKey, ChannelAcquisitionFuture,\n-     *       ClientConnectionTimingsBuilder, URI)} - The pool has been exhausted.</li>\n+     *       ClientConnectionTimingsBuilder, ProxyContext)} - The pool has been exhausted.</li>\n      *   <li>{@link HttpSessionHandler} - HTTP/2 upgrade has failed.</li>\n      * </ul>\n      */\n     void connect(SocketAddress remoteAddress, SessionProtocol desiredProtocol,\n-                 Promise<Channel> sessionPromise, URI reqUri) {\n+                 ProxyContext proxyContext, Promise<Channel> sessionPromise) {\n \n         final Bootstrap bootstrap = getBootstrap(desiredProtocol);\n-        ProxyConfig proxyConfig;\n-        try {\n-            proxyConfig = proxyConfigSelector.select(reqUri);\n-        } catch (Throwable t) {\n-            logger.warn(\"Failed to select ProxyConfig for <{}> \", reqUri, t);\n-            proxyConfig = ProxyConfig.direct();\n-        }\n \n         final Channel channel = bootstrap.register().channel();\n-        channel.attr(REQUEST_URI_KEY).set(reqUri);\n-        configureProxy(channel, proxyConfig, desiredProtocol);\n+        channel.attr(PROXY_CONTEXT).set(proxyContext);\n+        configureProxy(channel, proxyContext.proxyConfig(), desiredProtocol);\n         final ChannelFuture connectFuture = channel.connect(remoteAddress);\n \n         connectFuture.addListener((ChannelFuture future) -> {\n             if (future.isSuccess()) {\n                 initSession(desiredProtocol, future, sessionPromise);\n             } else {\n+                invokeProxyConnectFailed(proxyContext, future.cause());\n                 sessionPromise.tryFailure(future.cause());\n             }\n         });\n     }\n \n+    void invokeProxyConnectFailed(ProxyContext proxyContext, Throwable cause) {\n+        try {\n+            final ProxyConfig proxyConfig = proxyContext.proxyConfig();\n+            if (proxyConfig.proxyType() != ProxyType.DIRECT) {\n+                final InetSocketAddress proxyAddress = proxyConfig.proxyAddress();\n+                assert proxyAddress != null;\n+                proxyConfigSelector.connectFailed(proxyContext.reqUri(), proxyAddress, cause);\n+            }\n+        } catch (Throwable t) {\n+            logger.warn(\"Exception while invoking proxy connectFailed for <{}> \", proxyContext, t);\n+        }\n+    }\n+\n     private static InetSocketAddress toRemoteAddress(PoolKey key) throws UnknownHostException {\n         final InetAddress inetAddr = InetAddress.getByAddress(\n                 key.host, NetUtil.createByteArrayFromIpAddressString(key.ipAddr));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzAyMDI0MA==", "url": "https://github.com/line/armeria/pull/2752#discussion_r433020240", "bodyText": "Could be hidden from the public API and add a factory method to ProxyConfigSelector.", "author": "trustin", "createdAt": "2020-06-01T02:44:39Z", "path": "core/src/main/java/com/linecorp/armeria/client/proxy/WrappingProxyConfigSelector.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import java.io.IOException;\n+import java.net.InetSocketAddress;\n+import java.net.Proxy;\n+import java.net.ProxySelector;\n+import java.net.SocketAddress;\n+import java.net.URI;\n+import java.util.List;\n+\n+import javax.annotation.Nullable;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * TODO: add javadocs.\n+ */\n+public final class WrappingProxyConfigSelector implements ProxyConfigSelector {", "originalCommit": "5fcdc87d25a837525315ba59aa338aaec29601ba", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "eea39f080ce52128a9fcd9e163bca9e4d19963be", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/proxy/WrappingProxyConfigSelector.java b/core/src/main/java/com/linecorp/armeria/client/proxy/WrappingProxyConfigSelector.java\nindex c5ba0fe1e..0c9f86d69 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/proxy/WrappingProxyConfigSelector.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/proxy/WrappingProxyConfigSelector.java\n\n@@ -30,9 +30,14 @@ import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n /**\n- * TODO: add javadocs.\n+ * A simple class which wraps a {@link ProxySelector}. This class may have some limitations, most notably:\n+\n+ * 1. Some incompatibilities when used with sun's {@code DefaultProxySelector}\n+ *     - some fields like socksProxyVersion aren't used\n+ *     - this class doesn't attempt to resolve scheme format differences.\n+ * 2. Selecting multiple {@link Proxy} isn't supported.\n  */\n-public final class WrappingProxyConfigSelector implements ProxyConfigSelector {\n+final class WrappingProxyConfigSelector implements ProxyConfigSelector {\n     private static final Logger logger = LoggerFactory.getLogger(WrappingProxyConfigSelector.class);\n \n     private static InetSocketAddress resolve(InetSocketAddress inetSocketAddress) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzAyMTE2Nw==", "url": "https://github.com/line/armeria/pull/2752#discussion_r433021167", "bodyText": "How about extracting into a method rather than into a field of function?", "author": "trustin", "createdAt": "2020-06-01T02:50:16Z", "path": "core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java", "diffHunk": "@@ -110,17 +118,17 @@\n \n         final Bootstrap baseBootstrap = clientFactory.newBootstrap();\n         baseBootstrap.group(eventLoop);\n+        sslContextSupplier = desiredProtocol ->\n+                desiredProtocol == SessionProtocol.H1 || desiredProtocol == SessionProtocol.H1C ?\n+                sslCtxHttp1Only : sslCtxHttp1Or2;", "originalCommit": "5fcdc87d25a837525315ba59aa338aaec29601ba", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "eea39f080ce52128a9fcd9e163bca9e4d19963be", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java b/core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java\nindex b0f462795..a1419272c 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java\n\n@@ -115,16 +116,15 @@ final class HttpChannelPool implements AsyncCloseable {\n                 SessionProtocol.H2, SessionProtocol.H2C);\n         allChannels = new IdentityHashMap<>();\n         this.listener = listener;\n+        this.sslCtxHttp1Only = sslCtxHttp1Only;\n+        this.sslCtxHttp1Or2 = sslCtxHttp1Or2;\n \n         final Bootstrap baseBootstrap = clientFactory.newBootstrap();\n         baseBootstrap.group(eventLoop);\n-        sslContextSupplier = desiredProtocol ->\n-                desiredProtocol == SessionProtocol.H1 || desiredProtocol == SessionProtocol.H1C ?\n-                sslCtxHttp1Only : sslCtxHttp1Or2;\n         bootstraps = newEnumMap(\n                 Bootstrap.class,\n                 desiredProtocol -> {\n-                    final SslContext sslCtx = sslContextSupplier.apply(desiredProtocol);\n+                    final SslContext sslCtx = sslContext(desiredProtocol);\n                     final Bootstrap bootstrap = baseBootstrap.clone();\n                     bootstrap.handler(new ChannelInitializer<Channel>() {\n                         @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzAyMTkwMw==", "url": "https://github.com/line/armeria/pull/2752#discussion_r433021903", "bodyText": "How about just storing ProxyConfig, so that we don't need to evaluate the request URI every time we retry a new connection?\nLooks like we have to use ProxyConfig as an additional field of PoolKey?", "author": "trustin", "createdAt": "2020-06-01T02:54:28Z", "path": "core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java", "diffHunk": "@@ -74,6 +77,8 @@\n     private static final Logger logger = LoggerFactory.getLogger(HttpChannelPool.class);\n     private static final Channel[] EMPTY_CHANNELS = new Channel[0];\n \n+    static final AttributeKey<URI> REQUEST_URI_KEY = AttributeKey.valueOf(URI.class, \"REQ_URI\");", "originalCommit": "5fcdc87d25a837525315ba59aa338aaec29601ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMzMDMwNw==", "url": "https://github.com/line/armeria/pull/2752#discussion_r436330307", "bodyText": "we don't need to evaluate the request URI every time we retry a new connection?\n\nIn retrospect, I agree and think it makes more sense to evaluate for every request (not only for each connection attempt)\nThanks for pointing this out \ud83d\udc4d", "author": "jrhee17", "createdAt": "2020-06-07T06:29:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzAyMTkwMw=="}], "type": "inlineReview", "revised_code": {"commit": "eea39f080ce52128a9fcd9e163bca9e4d19963be", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java b/core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java\nindex b0f462795..a1419272c 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java\n\n@@ -76,8 +76,8 @@ final class HttpChannelPool implements AsyncCloseable {\n \n     private static final Logger logger = LoggerFactory.getLogger(HttpChannelPool.class);\n     private static final Channel[] EMPTY_CHANNELS = new Channel[0];\n-\n-    static final AttributeKey<URI> REQUEST_URI_KEY = AttributeKey.valueOf(URI.class, \"REQ_URI\");\n+    static final AttributeKey<ProxyContext> PROXY_CONTEXT =\n+            AttributeKey.valueOf(ProxyContext.class, \"PROXY_CONTEXT\");\n \n     private final EventLoop eventLoop;\n     private final AsyncCloseableSupport closeable = AsyncCloseableSupport.of(this::closeAsync);\n"}}, {"oid": "eea39f080ce52128a9fcd9e163bca9e4d19963be", "url": "https://github.com/line/armeria/commit/eea39f080ce52128a9fcd9e163bca9e4d19963be", "message": "direct as default, select once for each request, handle connect failure", "committedDate": "2020-06-07T06:24:07Z", "type": "commit"}, {"oid": "eea39f080ce52128a9fcd9e163bca9e4d19963be", "url": "https://github.com/line/armeria/commit/eea39f080ce52128a9fcd9e163bca9e4d19963be", "message": "direct as default, select once for each request, handle connect failure", "committedDate": "2020-06-07T06:24:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQzODAzNw==", "url": "https://github.com/line/armeria/pull/2752#discussion_r436438037", "bodyText": "Could be final?", "author": "ikhoon", "createdAt": "2020-06-08T03:08:43Z", "path": "core/src/main/java/com/linecorp/armeria/client/ProxyContext.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client;\n+\n+import java.net.URI;\n+\n+import com.google.common.base.MoreObjects;\n+\n+import com.linecorp.armeria.client.proxy.ProxyConfig;\n+\n+class ProxyContext {", "originalCommit": "eea39f080ce52128a9fcd9e163bca9e4d19963be", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5d1d79a3d1edc831f1cc801039f4bd484a0229b2", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/ProxyContext.java b/core/src/main/java/com/linecorp/armeria/client/ProxyContext.java\nindex 9f14471c5..d0916511b 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/ProxyContext.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/ProxyContext.java\n\n@@ -21,11 +21,20 @@ import java.net.URI;\n import com.google.common.base.MoreObjects;\n \n import com.linecorp.armeria.client.proxy.ProxyConfig;\n+import com.linecorp.armeria.client.proxy.ProxyConfigSelector;\n \n-class ProxyContext {\n+final class ProxyContext {\n     private final ProxyConfig proxyConfig;\n     private final URI reqUri;\n \n+    /**\n+     * Constructor for a value object containing client-side proxy fields.\n+     * These fields are used to determine which connection will be used,\n+     * or how a new connection will be opened.\n+     *\n+     * @param reqUri the original request URI for a proxy. This value is mainly used to invoke callbacks\n+     *               in {@link ProxyConfigSelector} when a new connection is opened.\n+     */\n     ProxyContext(ProxyConfig proxyConfig, URI reqUri) {\n         this.proxyConfig = proxyConfig;\n         this.reqUri = reqUri;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQzOTcwOA==", "url": "https://github.com/line/armeria/pull/2752#discussion_r436439708", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Returns the proxy address. This value is {@code null} only for DIRECT proxies.\n          \n          \n            \n                 * Returns the proxy address. This value is {@code null} only for {@link ProxyType.DIRECT} proxies.", "author": "ikhoon", "createdAt": "2020-06-08T03:19:21Z", "path": "core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfig.java", "diffHunk": "@@ -124,6 +134,12 @@ public static ProxyConfig direct() {\n      */\n     public abstract ProxyType proxyType();\n \n+    /**\n+     * Returns the proxy address. This value is {@code null} only for DIRECT proxies.", "originalCommit": "eea39f080ce52128a9fcd9e163bca9e4d19963be", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5d1d79a3d1edc831f1cc801039f4bd484a0229b2", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfig.java b/core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfig.java\nindex d8d2ecd1b..30a74f50f 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfig.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfig.java\n\n@@ -135,7 +135,7 @@ public abstract class ProxyConfig {\n     public abstract ProxyType proxyType();\n \n     /**\n-     * Returns the proxy address. This value is {@code null} only for DIRECT proxies.\n+     * Returns the proxy address. This value is {@code null} only for {@link ProxyType#DIRECT} proxies.\n      */\n     @Nullable\n     public abstract InetSocketAddress proxyAddress();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ0NDQxNQ==", "url": "https://github.com/line/armeria/pull/2752#discussion_r436444415", "bodyText": "Could be private?", "author": "ikhoon", "createdAt": "2020-06-08T03:47:42Z", "path": "core/src/main/java/com/linecorp/armeria/client/proxy/WrappingProxyConfigSelector.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import java.io.IOException;\n+import java.net.InetSocketAddress;\n+import java.net.Proxy;\n+import java.net.ProxySelector;\n+import java.net.SocketAddress;\n+import java.net.URI;\n+import java.util.List;\n+\n+import javax.annotation.Nullable;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * A simple class which wraps a {@link ProxySelector}. This class may have some limitations, most notably:\n+\n+ * 1. Some incompatibilities when used with sun's {@code DefaultProxySelector}\n+ *     - some fields like socksProxyVersion aren't used\n+ *     - this class doesn't attempt to resolve scheme format differences.\n+ * 2. Selecting multiple {@link Proxy} isn't supported.\n+ */\n+final class WrappingProxyConfigSelector implements ProxyConfigSelector {\n+    private static final Logger logger = LoggerFactory.getLogger(WrappingProxyConfigSelector.class);\n+\n+    private static InetSocketAddress resolve(InetSocketAddress inetSocketAddress) {\n+        if (!inetSocketAddress.isUnresolved()) {\n+            return inetSocketAddress;\n+        }\n+        return new InetSocketAddress(inetSocketAddress.getHostString(), inetSocketAddress.getPort());\n+    }\n+\n+    private static ProxyConfig toProxyConfig(@Nullable Proxy proxy) {\n+        if (proxy == null || proxy.address() == null) {\n+            return ProxyConfig.direct();\n+        }\n+        if (!(proxy.address() instanceof InetSocketAddress)) {\n+            logger.warn(\"Invalid proxy address for <{}>.\", proxy);\n+            return ProxyConfig.direct();\n+        }\n+\n+        final InetSocketAddress proxyAddress = (InetSocketAddress) proxy.address();\n+        switch (proxy.type()) {\n+            case HTTP:\n+                return ProxyConfig.connect(resolve(proxyAddress));\n+            case SOCKS:\n+                // NOTE: we may consider using {@code sun.net.SocksProxy} to determine the socksProxyVersion\n+                return ProxyConfig.socks5(resolve(proxyAddress));\n+            case DIRECT:\n+            default:\n+                return ProxyConfig.direct();\n+        }\n+    }\n+\n+    static WrappingProxyConfigSelector of(ProxySelector proxySelector) {\n+        return new WrappingProxyConfigSelector(proxySelector);\n+    }\n+\n+    final ProxySelector proxySelector;", "originalCommit": "eea39f080ce52128a9fcd9e163bca9e4d19963be", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5d1d79a3d1edc831f1cc801039f4bd484a0229b2", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/proxy/WrappingProxyConfigSelector.java b/core/src/main/java/com/linecorp/armeria/client/proxy/WrappingProxyConfigSelector.java\nindex 0c9f86d69..4446c50fc 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/proxy/WrappingProxyConfigSelector.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/proxy/WrappingProxyConfigSelector.java\n\n@@ -16,6 +16,8 @@\n \n package com.linecorp.armeria.client.proxy;\n \n+import static java.util.Objects.requireNonNull;\n+\n import java.io.IOException;\n import java.net.InetSocketAddress;\n import java.net.Proxy;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ0NTkzNw==", "url": "https://github.com/line/armeria/pull/2752#discussion_r436445937", "bodyText": "Check not-null for the arguments?", "author": "ikhoon", "createdAt": "2020-06-08T03:56:40Z", "path": "core/src/main/java/com/linecorp/armeria/client/proxy/WrappingProxyConfigSelector.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import java.io.IOException;\n+import java.net.InetSocketAddress;\n+import java.net.Proxy;\n+import java.net.ProxySelector;\n+import java.net.SocketAddress;\n+import java.net.URI;\n+import java.util.List;\n+\n+import javax.annotation.Nullable;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * A simple class which wraps a {@link ProxySelector}. This class may have some limitations, most notably:\n+\n+ * 1. Some incompatibilities when used with sun's {@code DefaultProxySelector}\n+ *     - some fields like socksProxyVersion aren't used\n+ *     - this class doesn't attempt to resolve scheme format differences.\n+ * 2. Selecting multiple {@link Proxy} isn't supported.\n+ */\n+final class WrappingProxyConfigSelector implements ProxyConfigSelector {\n+    private static final Logger logger = LoggerFactory.getLogger(WrappingProxyConfigSelector.class);\n+\n+    private static InetSocketAddress resolve(InetSocketAddress inetSocketAddress) {\n+        if (!inetSocketAddress.isUnresolved()) {\n+            return inetSocketAddress;\n+        }\n+        return new InetSocketAddress(inetSocketAddress.getHostString(), inetSocketAddress.getPort());\n+    }\n+\n+    private static ProxyConfig toProxyConfig(@Nullable Proxy proxy) {\n+        if (proxy == null || proxy.address() == null) {\n+            return ProxyConfig.direct();\n+        }\n+        if (!(proxy.address() instanceof InetSocketAddress)) {\n+            logger.warn(\"Invalid proxy address for <{}>.\", proxy);\n+            return ProxyConfig.direct();\n+        }\n+\n+        final InetSocketAddress proxyAddress = (InetSocketAddress) proxy.address();\n+        switch (proxy.type()) {\n+            case HTTP:\n+                return ProxyConfig.connect(resolve(proxyAddress));\n+            case SOCKS:\n+                // NOTE: we may consider using {@code sun.net.SocksProxy} to determine the socksProxyVersion\n+                return ProxyConfig.socks5(resolve(proxyAddress));\n+            case DIRECT:\n+            default:\n+                return ProxyConfig.direct();\n+        }\n+    }\n+\n+    static WrappingProxyConfigSelector of(ProxySelector proxySelector) {\n+        return new WrappingProxyConfigSelector(proxySelector);\n+    }\n+\n+    final ProxySelector proxySelector;\n+\n+    private WrappingProxyConfigSelector(ProxySelector proxySelector) {\n+        this.proxySelector = proxySelector;\n+    }\n+\n+    @Override\n+    public ProxyConfig select(URI uri) {\n+        final List<Proxy> proxies = proxySelector.select(uri);\n+        if (proxies == null || proxies.isEmpty()) {\n+            return ProxyConfig.direct();\n+        }\n+\n+        final Proxy proxy = proxies.get(0);\n+        if (proxies.size() > 1) {\n+            logger.debug(\"Using the first proxy <{}> of <{}>.\", proxy, proxies);\n+        }\n+        return toProxyConfig(proxy);\n+    }\n+\n+    @Override\n+    public void connectFailed(URI uri, SocketAddress sa, Throwable throwable) {", "originalCommit": "eea39f080ce52128a9fcd9e163bca9e4d19963be", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5d1d79a3d1edc831f1cc801039f4bd484a0229b2", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/proxy/WrappingProxyConfigSelector.java b/core/src/main/java/com/linecorp/armeria/client/proxy/WrappingProxyConfigSelector.java\nindex 0c9f86d69..4446c50fc 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/proxy/WrappingProxyConfigSelector.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/proxy/WrappingProxyConfigSelector.java\n\n@@ -16,6 +16,8 @@\n \n package com.linecorp.armeria.client.proxy;\n \n+import static java.util.Objects.requireNonNull;\n+\n import java.io.IOException;\n import java.net.InetSocketAddress;\n import java.net.Proxy;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ0NjAyOQ==", "url": "https://github.com/line/armeria/pull/2752#discussion_r436446029", "bodyText": "Check not-null?", "author": "ikhoon", "createdAt": "2020-06-08T03:57:11Z", "path": "core/src/main/java/com/linecorp/armeria/client/proxy/WrappingProxyConfigSelector.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import java.io.IOException;\n+import java.net.InetSocketAddress;\n+import java.net.Proxy;\n+import java.net.ProxySelector;\n+import java.net.SocketAddress;\n+import java.net.URI;\n+import java.util.List;\n+\n+import javax.annotation.Nullable;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * A simple class which wraps a {@link ProxySelector}. This class may have some limitations, most notably:\n+\n+ * 1. Some incompatibilities when used with sun's {@code DefaultProxySelector}\n+ *     - some fields like socksProxyVersion aren't used\n+ *     - this class doesn't attempt to resolve scheme format differences.\n+ * 2. Selecting multiple {@link Proxy} isn't supported.\n+ */\n+final class WrappingProxyConfigSelector implements ProxyConfigSelector {\n+    private static final Logger logger = LoggerFactory.getLogger(WrappingProxyConfigSelector.class);\n+\n+    private static InetSocketAddress resolve(InetSocketAddress inetSocketAddress) {\n+        if (!inetSocketAddress.isUnresolved()) {\n+            return inetSocketAddress;\n+        }\n+        return new InetSocketAddress(inetSocketAddress.getHostString(), inetSocketAddress.getPort());\n+    }\n+\n+    private static ProxyConfig toProxyConfig(@Nullable Proxy proxy) {\n+        if (proxy == null || proxy.address() == null) {\n+            return ProxyConfig.direct();\n+        }\n+        if (!(proxy.address() instanceof InetSocketAddress)) {\n+            logger.warn(\"Invalid proxy address for <{}>.\", proxy);\n+            return ProxyConfig.direct();\n+        }\n+\n+        final InetSocketAddress proxyAddress = (InetSocketAddress) proxy.address();\n+        switch (proxy.type()) {\n+            case HTTP:\n+                return ProxyConfig.connect(resolve(proxyAddress));\n+            case SOCKS:\n+                // NOTE: we may consider using {@code sun.net.SocksProxy} to determine the socksProxyVersion\n+                return ProxyConfig.socks5(resolve(proxyAddress));\n+            case DIRECT:\n+            default:\n+                return ProxyConfig.direct();\n+        }\n+    }\n+\n+    static WrappingProxyConfigSelector of(ProxySelector proxySelector) {\n+        return new WrappingProxyConfigSelector(proxySelector);\n+    }\n+\n+    final ProxySelector proxySelector;\n+\n+    private WrappingProxyConfigSelector(ProxySelector proxySelector) {\n+        this.proxySelector = proxySelector;\n+    }\n+\n+    @Override\n+    public ProxyConfig select(URI uri) {", "originalCommit": "eea39f080ce52128a9fcd9e163bca9e4d19963be", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5d1d79a3d1edc831f1cc801039f4bd484a0229b2", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/proxy/WrappingProxyConfigSelector.java b/core/src/main/java/com/linecorp/armeria/client/proxy/WrappingProxyConfigSelector.java\nindex 0c9f86d69..4446c50fc 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/proxy/WrappingProxyConfigSelector.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/proxy/WrappingProxyConfigSelector.java\n\n@@ -16,6 +16,8 @@\n \n package com.linecorp.armeria.client.proxy;\n \n+import static java.util.Objects.requireNonNull;\n+\n import java.io.IOException;\n import java.net.InetSocketAddress;\n import java.net.Proxy;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ1Njg2NA==", "url": "https://github.com/line/armeria/pull/2752#discussion_r436456864", "bodyText": "How about making this factory method return a singleton instance for DirectProxyConfig?", "author": "ikhoon", "createdAt": "2020-06-08T04:57:11Z", "path": "core/src/main/java/com/linecorp/armeria/client/proxy/StaticProxyConfigSelector.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.SocketAddress;\n+import java.net.URI;\n+\n+/**\n+ * A {@link ProxyConfigSelector} which selects a static {@link ProxyConfig}\n+ * for all requests.\n+ */\n+public final class StaticProxyConfigSelector implements ProxyConfigSelector {\n+\n+    /**\n+     * Constructs a {@link ProxyConfigSelector} which selects a static {@link ProxyConfig}\n+     * for all requests.\n+     */\n+    public static StaticProxyConfigSelector of(ProxyConfig proxyConfig) {\n+        return new StaticProxyConfigSelector(proxyConfig);", "originalCommit": "eea39f080ce52128a9fcd9e163bca9e4d19963be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA1MDgwNQ==", "url": "https://github.com/line/armeria/pull/2752#discussion_r440050805", "bodyText": "Actually, what I intended was:\npublic static StaticProxyConfigSelector of(ProxyConfig proxyConfig) {\n   if (proxyConfig == ProxyConfig.config()) {\n       return DIRECT;\n   }\n   return new StaticProxyConfigSelector(proxyConfig);\n}\n\nThen we could make DIRECT private. \ud83d\ude04", "author": "ikhoon", "createdAt": "2020-06-15T09:35:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ1Njg2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEzNzk4Mg==", "url": "https://github.com/line/armeria/pull/2752#discussion_r440137982", "bodyText": "that was sloppy of me \ud83d\ude05", "author": "jrhee17", "createdAt": "2020-06-15T12:24:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ1Njg2NA=="}], "type": "inlineReview", "revised_code": {"commit": "5d1d79a3d1edc831f1cc801039f4bd484a0229b2", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/proxy/StaticProxyConfigSelector.java b/core/src/main/java/com/linecorp/armeria/client/proxy/StaticProxyConfigSelector.java\nindex 0c07b17eb..52a0db7e9 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/proxy/StaticProxyConfigSelector.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/proxy/StaticProxyConfigSelector.java\n\n@@ -27,6 +27,8 @@ import java.net.URI;\n  */\n public final class StaticProxyConfigSelector implements ProxyConfigSelector {\n \n+    public static final StaticProxyConfigSelector DIRECT = new StaticProxyConfigSelector(ProxyConfig.direct());\n+\n     /**\n      * Constructs a {@link ProxyConfigSelector} which selects a static {@link ProxyConfig}\n      * for all requests.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ2NTM2MQ==", "url": "https://github.com/line/armeria/pull/2752#discussion_r436465361", "bodyText": "Question: I thought ProxyContext is working as a request-scoped object, not a channel-scoped object. Because ProxyContext contains a request URI. \ud83e\uddd0", "author": "ikhoon", "createdAt": "2020-06-08T05:35:52Z", "path": "core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java", "diffHunk": "@@ -373,24 +393,43 @@ private void connect(SessionProtocol desiredProtocol, PoolKey key, ChannelAcquis\n      * A low-level operation that triggers a new connection attempt. Used only by:\n      * <ul>\n      *   <li>{@link #connect(SessionProtocol, PoolKey, ChannelAcquisitionFuture,\n-     *       ClientConnectionTimingsBuilder)} - The pool has been exhausted.</li>\n+     *       ClientConnectionTimingsBuilder, ProxyContext)} - The pool has been exhausted.</li>\n      *   <li>{@link HttpSessionHandler} - HTTP/2 upgrade has failed.</li>\n      * </ul>\n      */\n     void connect(SocketAddress remoteAddress, SessionProtocol desiredProtocol,\n-                 Promise<Channel> sessionPromise) {\n+                 ProxyContext proxyContext, Promise<Channel> sessionPromise) {\n+\n         final Bootstrap bootstrap = getBootstrap(desiredProtocol);\n-        final ChannelFuture connectFuture = bootstrap.connect(remoteAddress);\n+\n+        final Channel channel = bootstrap.register().channel();\n+        channel.attr(PROXY_CONTEXT).set(proxyContext);", "originalCommit": "eea39f080ce52128a9fcd9e163bca9e4d19963be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ3ODgzMQ==", "url": "https://github.com/line/armeria/pull/2752#discussion_r436478831", "bodyText": "Yeah, ProxyConfig is connection-scoped though.", "author": "trustin", "createdAt": "2020-06-08T06:25:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ2NTM2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTcxNzUwMw==", "url": "https://github.com/line/armeria/pull/2752#discussion_r439717503", "bodyText": "\ud83e\udd14\nI agree the current code  may cause confusion.\n(As @ikhoon pointed out, reqUri is set for each connection indicating the URI used when opening the connection. This uri may have no relation with other requests that may use this connection, potentially leading to bugs or unexpected behavior)\nWe can't avoid using URI since ProxySelector API highly depends on it.\nInstead, I've tried to generify reqUri (by only leaving the host/port) and renamed it to connUri (or connectionUri).\nAdditionally, it seemed like PoolKey contains all related information needed (host, port), so I've modified channel.attr to remember PoolKey instead. (and removed ProxyContext)\nLet me know if this looks better than the previous impl.", "author": "jrhee17", "createdAt": "2020-06-13T07:25:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ2NTM2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEzOTE0Mg==", "url": "https://github.com/line/armeria/pull/2752#discussion_r440139142", "bodyText": "Alternatively, we may also choose to revert back to the previous impl., or explore abandoning compatibility with ProxySelector and see how it looks.", "author": "jrhee17", "createdAt": "2020-06-15T12:27:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ2NTM2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc5OTE4NA==", "url": "https://github.com/line/armeria/pull/2752#discussion_r440799184", "bodyText": "That's a good point, @jrhee17. I'm not sure ProxySelector will ever need to look into anything other than (SessionProtocol, authority (or host and port)). How about this:\n\nMake ProxyConfigSelector require SessionProtocol and Endpoint only.\nWhen calling ProxySelector, create a URI whose path is /, e.g. http://foo.com/", "author": "trustin", "createdAt": "2020-06-16T12:07:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ2NTM2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "d68653e6fef5ad1e639fd7b171203df3a9790d6a", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java b/core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java\nindex a1419272c..a2dc79056 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java\n\n@@ -393,40 +390,40 @@ final class HttpChannelPool implements AsyncCloseable {\n      * A low-level operation that triggers a new connection attempt. Used only by:\n      * <ul>\n      *   <li>{@link #connect(SessionProtocol, PoolKey, ChannelAcquisitionFuture,\n-     *       ClientConnectionTimingsBuilder, ProxyContext)} - The pool has been exhausted.</li>\n+     *       ClientConnectionTimingsBuilder)} - The pool has been exhausted.</li>\n      *   <li>{@link HttpSessionHandler} - HTTP/2 upgrade has failed.</li>\n      * </ul>\n      */\n     void connect(SocketAddress remoteAddress, SessionProtocol desiredProtocol,\n-                 ProxyContext proxyContext, Promise<Channel> sessionPromise) {\n+                 PoolKey poolKey, Promise<Channel> sessionPromise) {\n \n         final Bootstrap bootstrap = getBootstrap(desiredProtocol);\n \n         final Channel channel = bootstrap.register().channel();\n-        channel.attr(PROXY_CONTEXT).set(proxyContext);\n-        configureProxy(channel, proxyContext.proxyConfig(), desiredProtocol);\n+        channel.attr(POOL_KEY).set(poolKey);\n+        configureProxy(channel, poolKey.proxyConfig, desiredProtocol);\n         final ChannelFuture connectFuture = channel.connect(remoteAddress);\n \n         connectFuture.addListener((ChannelFuture future) -> {\n             if (future.isSuccess()) {\n                 initSession(desiredProtocol, future, sessionPromise);\n             } else {\n-                invokeProxyConnectFailed(proxyContext, future.cause());\n+                invokeProxyConnectFailed(poolKey, future.cause());\n                 sessionPromise.tryFailure(future.cause());\n             }\n         });\n     }\n \n-    void invokeProxyConnectFailed(ProxyContext proxyContext, Throwable cause) {\n+    void invokeProxyConnectFailed(PoolKey poolKey, Throwable cause) {\n         try {\n-            final ProxyConfig proxyConfig = proxyContext.proxyConfig();\n+            final ProxyConfig proxyConfig = poolKey.proxyConfig;\n             if (proxyConfig.proxyType() != ProxyType.DIRECT) {\n                 final InetSocketAddress proxyAddress = proxyConfig.proxyAddress();\n                 assert proxyAddress != null;\n-                proxyConfigSelector.connectFailed(proxyContext.reqUri(), proxyAddress, cause);\n+                proxyConfigSelector.connectFailed(poolKey.connUri, proxyAddress, cause);\n             }\n         } catch (Throwable t) {\n-            logger.warn(\"Exception while invoking proxy connectFailed for <{}> \", proxyContext, t);\n+            logger.warn(\"Exception while invoking proxy connectFailed for <{}> \", poolKey, t);\n         }\n     }\n \n"}}, {"oid": "5d1d79a3d1edc831f1cc801039f4bd484a0229b2", "url": "https://github.com/line/armeria/commit/5d1d79a3d1edc831f1cc801039f4bd484a0229b2", "message": "do null checks, prefer final class", "committedDate": "2020-06-13T07:11:11Z", "type": "commit"}, {"oid": "d68653e6fef5ad1e639fd7b171203df3a9790d6a", "url": "https://github.com/line/armeria/commit/d68653e6fef5ad1e639fd7b171203df3a9790d6a", "message": "generify reqUri to conn level, try reusing PoolKey", "committedDate": "2020-06-13T07:40:37Z", "type": "commit"}, {"oid": "d68653e6fef5ad1e639fd7b171203df3a9790d6a", "url": "https://github.com/line/armeria/commit/d68653e6fef5ad1e639fd7b171203df3a9790d6a", "message": "generify reqUri to conn level, try reusing PoolKey", "committedDate": "2020-06-13T07:40:37Z", "type": "forcePushed"}, {"oid": "791c9de25c47f09d601b0124a428867436958653", "url": "https://github.com/line/armeria/commit/791c9de25c47f09d601b0124a428867436958653", "message": "hide singleton instance for direct proxy selector", "committedDate": "2020-06-15T12:23:56Z", "type": "commit"}, {"oid": "643a6659d9c5d649133d496d2c8a4f745ea04948", "url": "https://github.com/line/armeria/commit/643a6659d9c5d649133d496d2c8a4f745ea04948", "message": "Merge branch 'master' of https://github.com/line/armeria into feature/proxy-system-property", "committedDate": "2020-06-17T11:12:09Z", "type": "commit"}, {"oid": "8e4e1ef8ba518e6238d43e8e123ff52ea23dbb26", "url": "https://github.com/line/armeria/commit/8e4e1ef8ba518e6238d43e8e123ff52ea23dbb26", "message": "temporarily force fail for hanging test", "committedDate": "2020-06-17T11:48:04Z", "type": "commit"}, {"oid": "c50615481040d0f1e42386ca91c896ac23378370", "url": "https://github.com/line/armeria/commit/c50615481040d0f1e42386ca91c896ac23378370", "message": "Merge branch 'master' of https://github.com/line/armeria into feature/proxy-system-property", "committedDate": "2020-06-20T04:21:36Z", "type": "commit"}, {"oid": "7532f5d6b46105f4130503895fcb2460113faae1", "url": "https://github.com/line/armeria/commit/7532f5d6b46105f4130503895fcb2460113faae1", "message": "use endpoint for proxyConfigSelector callbacks", "committedDate": "2020-06-20T06:48:50Z", "type": "commit"}, {"oid": "03870f3decc0f34fc44dec988c10c244ade40cdb", "url": "https://github.com/line/armeria/commit/03870f3decc0f34fc44dec988c10c244ade40cdb", "message": "add sessionProtocol to selector callbacks", "committedDate": "2020-06-20T08:16:18Z", "type": "commit"}, {"oid": "de6356d9cab26f6a75c90c57c08fdb573b1b289d", "url": "https://github.com/line/armeria/commit/de6356d9cab26f6a75c90c57c08fdb573b1b289d", "message": "remove test for sun's selector, improve javadocs,", "committedDate": "2020-06-20T09:17:43Z", "type": "commit"}, {"oid": "de6356d9cab26f6a75c90c57c08fdb573b1b289d", "url": "https://github.com/line/armeria/commit/de6356d9cab26f6a75c90c57c08fdb573b1b289d", "message": "remove test for sun's selector, improve javadocs,", "committedDate": "2020-06-20T09:17:43Z", "type": "forcePushed"}, {"oid": "33fac7396309e49c67731fc14e76d19beaaec8b4", "url": "https://github.com/line/armeria/commit/33fac7396309e49c67731fc14e76d19beaaec8b4", "message": "clean up tests and documentation", "committedDate": "2020-06-21T04:11:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzExMzEzMA==", "url": "https://github.com/line/armeria/pull/2752#discussion_r443113130", "bodyText": "I am yet to be convinced this.protocol will always be non-null.\nI'll look into this more, but any feedback is also welcome", "author": "jrhee17", "createdAt": "2020-06-20T08:25:53Z", "path": "core/src/main/java/com/linecorp/armeria/client/HttpSessionHandler.java", "diffHunk": "@@ -427,6 +431,9 @@ public void channelInactive(ChannelHandlerContext ctx) throws Exception {\n     @Override\n     public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {\n         if (cause instanceof ProxyConnectException) {\n+            final PoolKey poolKey = ctx.channel().attr(POOL_KEY).get();\n+            final SessionProtocol protocol = this.protocol != null ? this.protocol : desiredProtocol;", "originalCommit": "03870f3decc0f34fc44dec988c10c244ade40cdb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk0Njc3MQ==", "url": "https://github.com/line/armeria/pull/2752#discussion_r449946771", "bodyText": "I think it's possible.", "author": "trustin", "createdAt": "2020-07-06T01:40:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzExMzEzMA=="}], "type": "inlineReview", "revised_code": {"commit": "38587a2fd0bc0ebec03c90804e142caa87bb6a20", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/HttpSessionHandler.java b/core/src/main/java/com/linecorp/armeria/client/HttpSessionHandler.java\nindex 7b53e98d5..eafd85604 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/HttpSessionHandler.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/HttpSessionHandler.java\n\n@@ -431,7 +418,6 @@ final class HttpSessionHandler extends ChannelDuplexHandler implements HttpSessi\n     @Override\n     public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {\n         if (cause instanceof ProxyConnectException) {\n-            final PoolKey poolKey = ctx.channel().attr(POOL_KEY).get();\n             final SessionProtocol protocol = this.protocol != null ? this.protocol : desiredProtocol;\n             channelPool.invokeProxyConnectFailed(protocol, poolKey, cause);\n             sessionPromise.tryFailure(new UnprocessedRequestException(cause));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI4NTU0MA==", "url": "https://github.com/line/armeria/pull/2752#discussion_r443285540", "bodyText": "This looks a breaking change. Could you add the changes to a PR description?", "author": "ikhoon", "createdAt": "2020-06-22T02:04:29Z", "path": "core/src/main/java/com/linecorp/armeria/client/ClientFactoryOptions.java", "diffHunk": "@@ -260,9 +261,9 @@ public MeterRegistry meterRegistry() {\n     }\n \n     /**\n-     * The {@link ProxyConfig} which contains the proxy configuration.\n+     * The {@link ProxyConfigSelector} which determines the {@link ProxyConfig} to be used.\n      */\n-    public ProxyConfig proxyConfig() {\n-        return get(ClientFactoryOption.PROXY_CONFIG);\n+    public ProxyConfigSelector proxyConfigSelector() {", "originalCommit": "33fac7396309e49c67731fc14e76d19beaaec8b4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI4NTU2Ng==", "url": "https://github.com/line/armeria/pull/2752#discussion_r443285566", "bodyText": "Ditto, This looks a breaking change. Could you add the changes to a PR description?", "author": "ikhoon", "createdAt": "2020-06-22T02:04:42Z", "path": "core/src/main/java/com/linecorp/armeria/client/ClientFactoryOption.java", "diffHunk": "@@ -216,10 +218,10 @@\n             define(\"METER_REGISTRY\", Metrics.globalRegistry);\n \n     /**\n-     * The {@link ProxyConfig} which contains proxy related configuration.\n+     * The {@link ProxyConfigSelector} which determines the {@link ProxyConfig} to be used.\n      */\n-    public static final ClientFactoryOption<ProxyConfig> PROXY_CONFIG =\n-            define(\"PROXY_CONFIG\", ProxyConfig.direct());\n+    public static final ClientFactoryOption<ProxyConfigSelector> PROXY_CONFIG_SELECTOR =", "originalCommit": "33fac7396309e49c67731fc14e76d19beaaec8b4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f13eb963f9fe1f2dd6f97d015d86ce61a848d474", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/ClientFactoryOption.java b/core/src/main/java/com/linecorp/armeria/client/ClientFactoryOption.java\nindex e2ec1886d..fa5060fa7 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/ClientFactoryOption.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/ClientFactoryOption.java\n\n@@ -221,7 +220,7 @@ public final class ClientFactoryOption<T>\n      * The {@link ProxyConfigSelector} which determines the {@link ProxyConfig} to be used.\n      */\n     public static final ClientFactoryOption<ProxyConfigSelector> PROXY_CONFIG_SELECTOR =\n-            define(\"PROXY_CONFIG_SELECTOR\", StaticProxyConfigSelector.of(ProxyConfig.direct()));\n+            define(\"PROXY_CONFIG_SELECTOR\", ProxyConfigSelector.of(ProxyConfig.direct()));\n \n     /**\n      * Returns the all available {@link ClientFactoryOption}s.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMwMTE5OA==", "url": "https://github.com/line/armeria/pull/2752#discussion_r443301198", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Constructs a {@link ProxyConfigSelector} which selects a static {@link ProxyConfig}\n          \n          \n            \n                 * Returns a {@link ProxyConfigSelector} which selects a static {@link ProxyConfig}", "author": "ikhoon", "createdAt": "2020-06-22T03:30:39Z", "path": "core/src/main/java/com/linecorp/armeria/client/proxy/StaticProxyConfigSelector.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.SocketAddress;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.common.SessionProtocol;\n+\n+/**\n+ * A {@link ProxyConfigSelector} which selects a static {@link ProxyConfig}\n+ * for all requests.\n+ */\n+public final class StaticProxyConfigSelector implements ProxyConfigSelector {\n+\n+    private static final StaticProxyConfigSelector DIRECT = new StaticProxyConfigSelector(ProxyConfig.direct());\n+\n+    /**\n+     * Constructs a {@link ProxyConfigSelector} which selects a static {@link ProxyConfig}", "originalCommit": "33fac7396309e49c67731fc14e76d19beaaec8b4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "38587a2fd0bc0ebec03c90804e142caa87bb6a20", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/proxy/StaticProxyConfigSelector.java b/core/src/main/java/com/linecorp/armeria/client/proxy/StaticProxyConfigSelector.java\nindex 3cbc72f04..51c05de62 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/proxy/StaticProxyConfigSelector.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/proxy/StaticProxyConfigSelector.java\n\n@@ -32,7 +32,7 @@ public final class StaticProxyConfigSelector implements ProxyConfigSelector {\n     private static final StaticProxyConfigSelector DIRECT = new StaticProxyConfigSelector(ProxyConfig.direct());\n \n     /**\n-     * Constructs a {@link ProxyConfigSelector} which selects a static {@link ProxyConfig}\n+     * Returns a {@link ProxyConfigSelector} which selects a static {@link ProxyConfig}\n      * for all requests.\n      */\n     public static StaticProxyConfigSelector of(ProxyConfig proxyConfig) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMwMTk4Mw==", "url": "https://github.com/line/armeria/pull/2752#discussion_r443301983", "bodyText": "WrappingProxyConfigSelector is a package-private class.\nDo we need to copy the details?", "author": "ikhoon", "createdAt": "2020-06-22T03:35:09Z", "path": "core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfigSelector.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.ProxySelector;\n+import java.net.SocketAddress;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.common.SessionProtocol;\n+import com.linecorp.armeria.common.util.UnstableApi;\n+\n+/**\n+ * Selects the {@link ProxyConfig} to use when connecting to a network\n+ * resource specified by the {@link SessionProtocol} and {@link Endpoint} parameter.\n+ * This class may be used to dynamically control what proxy configuration\n+ * to use for each request.\n+\n+ * <p>It should be noted that the only guarantee provided is for a single request,\n+ * the {@link Endpoint} called with {@code select} will be equal to the {@link Endpoint}\n+ * called with {@code connectFailed}.</p>\n+ *\n+ * <p>For instance, the invoked {@link SessionProtocol} may change depending on the result of\n+ * protocol negotiation.\n+ * Additionally, we should note the {@link Endpoint} used to construct the request will not\n+ * necessarily be equal to the {@link Endpoint} in either callback method parameter.</p>\n+ */\n+@UnstableApi\n+public interface ProxyConfigSelector {\n+\n+    /**\n+     * Selects the {@link ProxyConfig} to use when connecting to a network\n+     * resource specified by the {@link SessionProtocol} and {@link Endpoint} parameter.\n+     *\n+     * @param protocol the protocol associated with the endpoint\n+     * @param endpoint an endpoint containing the requested host and port\n+     * @return the selected proxy config which should be non-null\n+     */\n+    ProxyConfig select(SessionProtocol protocol, Endpoint endpoint);\n+\n+    /**\n+     * Called to indicate a connection attempt to the specified {@link SessionProtocol}\n+     * and {@link Endpoint} has failed.\n+     *\n+     * @param protocol the protocol associated with the endpoint\n+     * @param endpoint an endpoint containing the requested host and port\n+     * @param sa the remote socket address of the proxy server\n+     * @param throwable the cause of the failure\n+     */\n+    void connectFailed(SessionProtocol protocol, Endpoint endpoint,\n+                       SocketAddress sa, Throwable throwable);\n+\n+    /**\n+     * Provides a way to re-use an existing {@link ProxySelector} with some limitations.\n+     * See {@link WrappingProxyConfigSelector} for more details.", "originalCommit": "33fac7396309e49c67731fc14e76d19beaaec8b4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "38587a2fd0bc0ebec03c90804e142caa87bb6a20", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfigSelector.java b/core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfigSelector.java\nindex eb1138f26..c60ca3fb4 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfigSelector.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfigSelector.java\n\n@@ -18,6 +18,7 @@ package com.linecorp.armeria.client.proxy;\n \n import static java.util.Objects.requireNonNull;\n \n+import java.net.Proxy;\n import java.net.ProxySelector;\n import java.net.SocketAddress;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMwMjIwOA==", "url": "https://github.com/line/armeria/pull/2752#discussion_r443302208", "bodyText": "nit: Could remove This value is?", "author": "ikhoon", "createdAt": "2020-06-22T03:36:21Z", "path": "core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfig.java", "diffHunk": "@@ -124,6 +134,12 @@ public static ProxyConfig direct() {\n      */\n     public abstract ProxyType proxyType();\n \n+    /**\n+     * Returns the proxy address. This value is {@code null} only for {@link ProxyType#DIRECT}.", "originalCommit": "33fac7396309e49c67731fc14e76d19beaaec8b4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "38587a2fd0bc0ebec03c90804e142caa87bb6a20", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfig.java b/core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfig.java\nindex 1a44f6df3..649f76ba1 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfig.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfig.java\n\n@@ -135,7 +135,7 @@ public abstract class ProxyConfig {\n     public abstract ProxyType proxyType();\n \n     /**\n-     * Returns the proxy address. This value is {@code null} only for {@link ProxyType#DIRECT}.\n+     * Returns the proxy address which is {@code null} only for {@link ProxyType#DIRECT}.\n      */\n     @Nullable\n     public abstract InetSocketAddress proxyAddress();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMwMzEzOA==", "url": "https://github.com/line/armeria/pull/2752#discussion_r443303138", "bodyText": "Could be removed now?", "author": "ikhoon", "createdAt": "2020-06-22T03:41:13Z", "path": "core/src/main/java/com/linecorp/armeria/client/proxy/ConnectProxyConfig.java", "diffHunk": "@@ -48,6 +49,7 @@\n     /**\n      * Returns the configured proxy address.\n      */", "originalCommit": "33fac7396309e49c67731fc14e76d19beaaec8b4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "38587a2fd0bc0ebec03c90804e142caa87bb6a20", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/proxy/ConnectProxyConfig.java b/core/src/main/java/com/linecorp/armeria/client/proxy/ConnectProxyConfig.java\nindex 4369aee01..0f2c8ace9 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/proxy/ConnectProxyConfig.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/proxy/ConnectProxyConfig.java\n\n@@ -46,9 +46,6 @@ public final class ConnectProxyConfig extends ProxyConfig {\n         this.useTls = useTls;\n     }\n \n-    /**\n-     * Returns the configured proxy address.\n-     */\n     @Override\n     public InetSocketAddress proxyAddress() {\n         return proxyAddress;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMwNDIxNg==", "url": "https://github.com/line/armeria/pull/2752#discussion_r443304216", "bodyText": "Question: Could we pass the poolKey to the constructor of this class?", "author": "ikhoon", "createdAt": "2020-06-22T03:47:23Z", "path": "core/src/main/java/com/linecorp/armeria/client/HttpSessionHandler.java", "diffHunk": "@@ -131,16 +132,18 @@\n         this.useHttp1Pipelining = useHttp1Pipelining;\n         this.idleTimeoutMillis = idleTimeoutMillis;\n         this.pingIntervalMillis = pingIntervalMillis;\n+        this.desiredProtocol = desiredProtocol;\n+    }\n \n-        switch (proxyConfig.proxyType()) {\n+    private static boolean useProxyConnection(ChannelHandlerContext ctx) {\n+        final PoolKey poolKey = ctx.channel().attr(POOL_KEY).get();", "originalCommit": "33fac7396309e49c67731fc14e76d19beaaec8b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ5MDU4Ng==", "url": "https://github.com/line/armeria/pull/2752#discussion_r446490586", "bodyText": "Good point \ud83d\udc4d  Modified to use poolKey directly for (slightly) better performance", "author": "jrhee17", "createdAt": "2020-06-27T06:09:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMwNDIxNg=="}], "type": "inlineReview", "revised_code": {"commit": "38587a2fd0bc0ebec03c90804e142caa87bb6a20", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/HttpSessionHandler.java b/core/src/main/java/com/linecorp/armeria/client/HttpSessionHandler.java\nindex 7b53e98d5..eafd85604 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/HttpSessionHandler.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/HttpSessionHandler.java\n\n@@ -121,32 +122,19 @@ final class HttpSessionHandler extends ChannelDuplexHandler implements HttpSessi\n \n     HttpSessionHandler(HttpChannelPool channelPool, Channel channel,\n                        Promise<Channel> sessionPromise, ScheduledFuture<?> sessionTimeoutFuture,\n-                       MeterRegistry meterRegistry, boolean useHttp1Pipelining,\n-                       long idleTimeoutMillis, long pingIntervalMillis, SessionProtocol desiredProtocol) {\n+                       MeterRegistry meterRegistry, SessionProtocol desiredProtocol, PoolKey poolKey,\n+                       boolean useHttp1Pipelining, long idleTimeoutMillis, long pingIntervalMillis) {\n         this.channelPool = requireNonNull(channelPool, \"channelPool\");\n         this.channel = requireNonNull(channel, \"channel\");\n         remoteAddress = channel.remoteAddress();\n         this.sessionPromise = requireNonNull(sessionPromise, \"sessionPromise\");\n         this.sessionTimeoutFuture = requireNonNull(sessionTimeoutFuture, \"sessionTimeoutFuture\");\n         this.meterRegistry = meterRegistry;\n+        this.desiredProtocol = desiredProtocol;\n+        this.poolKey = poolKey;\n         this.useHttp1Pipelining = useHttp1Pipelining;\n         this.idleTimeoutMillis = idleTimeoutMillis;\n         this.pingIntervalMillis = pingIntervalMillis;\n-        this.desiredProtocol = desiredProtocol;\n-    }\n-\n-    private static boolean useProxyConnection(ChannelHandlerContext ctx) {\n-        final PoolKey poolKey = ctx.channel().attr(POOL_KEY).get();\n-        switch (poolKey.proxyConfig.proxyType()) {\n-            case DIRECT:\n-                return false;\n-            case SOCKS4:\n-            case SOCKS5:\n-            case CONNECT:\n-                return true;\n-            default:\n-                throw new Error(); // Should never reach here.\n-        }\n     }\n \n     @Override\n"}}, {"oid": "38587a2fd0bc0ebec03c90804e142caa87bb6a20", "url": "https://github.com/line/armeria/commit/38587a2fd0bc0ebec03c90804e142caa87bb6a20", "message": "improve/de-dup javadocs, remove PoolKey from channel attr", "committedDate": "2020-06-27T05:34:38Z", "type": "commit"}, {"oid": "9fdca12183cded4c065be69d2b2e96beac1eaa73", "url": "https://github.com/line/armeria/commit/9fdca12183cded4c065be69d2b2e96beac1eaa73", "message": "Merge branch 'master' of https://github.com/line/armeria into feature/proxy-system-property", "committedDate": "2020-06-27T06:00:26Z", "type": "commit"}, {"oid": "e52bc67c86208f8b55ca3d7b0b38218d4a2bdb2d", "url": "https://github.com/line/armeria/commit/e52bc67c86208f8b55ca3d7b0b38218d4a2bdb2d", "message": "Merge branch 'master' into feature/proxy-system-property", "committedDate": "2020-06-30T08:52:46Z", "type": "commit"}, {"oid": "70c5c8cedd773e6e74efa2806ffc64f57de0d1af", "url": "https://github.com/line/armeria/commit/70c5c8cedd773e6e74efa2806ffc64f57de0d1af", "message": "Checkstyle", "committedDate": "2020-06-30T09:03:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUxMTU4Nw==", "url": "https://github.com/line/armeria/pull/2752#discussion_r447511587", "bodyText": "Use UnprocessedRequestException.of(cause)?\nThat was introduced recently. https://github.com/line/armeria/pull/2836/files#diff-718d120dd1a90039dc7f172f71f2f6bc", "author": "ikhoon", "createdAt": "2020-06-30T08:36:57Z", "path": "core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java", "diffHunk": "@@ -382,27 +394,49 @@ private void connect(SessionProtocol desiredProtocol, PoolKey key, ChannelAcquis\n      * </ul>\n      */\n     void connect(SocketAddress remoteAddress, SessionProtocol desiredProtocol,\n-                 Promise<Channel> sessionPromise) {\n+                 PoolKey poolKey, Promise<Channel> sessionPromise) {\n+\n         final Bootstrap bootstrap = getBootstrap(desiredProtocol);\n-        final ChannelFuture connectFuture = bootstrap.connect(remoteAddress);\n+\n+        final Channel channel = bootstrap.register().channel();\n+        configureProxy(channel, poolKey.proxyConfig, desiredProtocol);\n+        final ChannelFuture connectFuture = channel.connect(remoteAddress);\n \n         connectFuture.addListener((ChannelFuture future) -> {\n             if (future.isSuccess()) {\n-                initSession(desiredProtocol, future, sessionPromise);\n+                initSession(desiredProtocol, poolKey, future, sessionPromise);\n             } else {\n+                invokeProxyConnectFailed(desiredProtocol, poolKey, future.cause());\n                 sessionPromise.tryFailure(future.cause());\n             }\n         });\n     }\n \n+    void invokeProxyConnectFailed(SessionProtocol protocol, PoolKey poolKey, Throwable cause) {\n+        try {\n+            final ProxyConfig proxyConfig = poolKey.proxyConfig;\n+            if (proxyConfig.proxyType() != ProxyType.DIRECT) {\n+                final InetSocketAddress proxyAddress = proxyConfig.proxyAddress();\n+                assert proxyAddress != null;\n+                if (!(cause instanceof UnprocessedRequestException)) {\n+                    cause = new UnprocessedRequestException(cause);\n+                }", "originalCommit": "9fdca12183cded4c065be69d2b2e96beac1eaa73", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f13eb963f9fe1f2dd6f97d015d86ce61a848d474", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java b/core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java\nindex 2a475ed3f..a80ee3d83 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java\n\n@@ -418,14 +418,11 @@ final class HttpChannelPool implements AsyncCloseable {\n             if (proxyConfig.proxyType() != ProxyType.DIRECT) {\n                 final InetSocketAddress proxyAddress = proxyConfig.proxyAddress();\n                 assert proxyAddress != null;\n-                if (!(cause instanceof UnprocessedRequestException)) {\n-                    cause = new UnprocessedRequestException(cause);\n-                }\n                 proxyConfigSelector.connectFailed(protocol, Endpoint.of(poolKey.host, poolKey.port),\n-                                                  proxyAddress, cause);\n+                                                  proxyAddress, UnprocessedRequestException.of(cause));\n             }\n         } catch (Throwable t) {\n-            logger.warn(\"Exception while invoking proxy connectFailed for <{}> \", poolKey, t);\n+            logger.warn(\"Exception while invoking proxy connectFailed for {}\", poolKey, t);\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUxMzg5NQ==", "url": "https://github.com/line/armeria/pull/2752#discussion_r447513895", "bodyText": "Could you revert this? Refer to #2801 (comment) for the reason. \ud83d\ude09", "author": "ikhoon", "createdAt": "2020-06-30T08:40:20Z", "path": "core/src/main/java/com/linecorp/armeria/client/HttpSessionHandler.java", "diffHunk": "@@ -120,30 +122,19 @@\n \n     HttpSessionHandler(HttpChannelPool channelPool, Channel channel,\n                        Promise<Channel> sessionPromise, ScheduledFuture<?> sessionTimeoutFuture,\n-                       MeterRegistry meterRegistry, boolean useHttp1Pipelining,\n-                       long idleTimeoutMillis, long pingIntervalMillis, ProxyConfig proxyConfig) {\n+                       MeterRegistry meterRegistry, SessionProtocol desiredProtocol, PoolKey poolKey,\n+                       boolean useHttp1Pipelining, long idleTimeoutMillis, long pingIntervalMillis) {\n         this.channelPool = requireNonNull(channelPool, \"channelPool\");\n         this.channel = requireNonNull(channel, \"channel\");\n         remoteAddress = channel.remoteAddress();\n         this.sessionPromise = requireNonNull(sessionPromise, \"sessionPromise\");\n         this.sessionTimeoutFuture = requireNonNull(sessionTimeoutFuture, \"sessionTimeoutFuture\");\n         this.meterRegistry = meterRegistry;\n+        this.desiredProtocol = desiredProtocol;\n+        this.poolKey = poolKey;\n         this.useHttp1Pipelining = useHttp1Pipelining;\n         this.idleTimeoutMillis = idleTimeoutMillis;\n         this.pingIntervalMillis = pingIntervalMillis;\n-\n-        switch (proxyConfig.proxyType()) {\n-            case DIRECT:\n-                useProxyConnection = false;\n-                break;\n-            case SOCKS4:\n-            case SOCKS5:\n-            case CONNECT:\n-                useProxyConnection = true;\n-                break;\n-            default:\n-                throw new Error(); // Should never reach here.\n-        }", "originalCommit": "9fdca12183cded4c065be69d2b2e96beac1eaa73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzYwMzMwNw==", "url": "https://github.com/line/armeria/pull/2752#discussion_r447603307", "bodyText": "@ikhoon, it seems like ProxyConfig is not referred here anymore. What do you suggest specifically?", "author": "trustin", "createdAt": "2020-06-30T11:12:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUxMzg5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODI2MzEyNw==", "url": "https://github.com/line/armeria/pull/2752#discussion_r448263127", "bodyText": "I thought ProxyConfig could be accessed by PoolKey. Now, I realized the ProxyConfig.ProxyType is validated for the default case at configureProxy(...).\nYou don't need to revert this. ;-)", "author": "ikhoon", "createdAt": "2020-07-01T10:15:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUxMzg5NQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUyNTg2Ng==", "url": "https://github.com/line/armeria/pull/2752#discussion_r447525866", "bodyText": "nit: Could make this statically DirectProxyConfig{proxyType=DIRECT}.", "author": "ikhoon", "createdAt": "2020-06-30T08:58:29Z", "path": "core/src/main/java/com/linecorp/armeria/client/proxy/DirectProxyConfig.java", "diffHunk": "@@ -33,8 +37,23 @@ public ProxyType proxyType() {\n         return ProxyType.DIRECT;\n     }\n \n+    @Override\n+    public InetSocketAddress proxyAddress() {\n+        return null;\n+    }\n+\n     @Override\n     public String toString() {\n         return MoreObjects.toStringHelper(this).add(\"proxyType\", proxyType()).toString();", "originalCommit": "e52bc67c86208f8b55ca3d7b0b38218d4a2bdb2d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f13eb963f9fe1f2dd6f97d015d86ce61a848d474", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/proxy/DirectProxyConfig.java b/core/src/main/java/com/linecorp/armeria/client/proxy/DirectProxyConfig.java\nindex 61684be20..675040d70 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/proxy/DirectProxyConfig.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/proxy/DirectProxyConfig.java\n\n@@ -42,11 +40,6 @@ public final class DirectProxyConfig extends ProxyConfig {\n         return null;\n     }\n \n-    @Override\n-    public String toString() {\n-        return MoreObjects.toStringHelper(this).add(\"proxyType\", proxyType()).toString();\n-    }\n-\n     @Override\n     public boolean equals(@Nullable Object obj) {\n         return this == obj;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE3MTU2Ng==", "url": "https://github.com/line/armeria/pull/2752#discussion_r448171566", "bodyText": "We don't use <> to indicate the parameter. \ud83d\ude04", "author": "minwoox", "createdAt": "2020-07-01T07:32:19Z", "path": "core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java", "diffHunk": "@@ -382,27 +394,49 @@ private void connect(SessionProtocol desiredProtocol, PoolKey key, ChannelAcquis\n      * </ul>\n      */\n     void connect(SocketAddress remoteAddress, SessionProtocol desiredProtocol,\n-                 Promise<Channel> sessionPromise) {\n+                 PoolKey poolKey, Promise<Channel> sessionPromise) {\n+\n         final Bootstrap bootstrap = getBootstrap(desiredProtocol);\n-        final ChannelFuture connectFuture = bootstrap.connect(remoteAddress);\n+\n+        final Channel channel = bootstrap.register().channel();\n+        configureProxy(channel, poolKey.proxyConfig, desiredProtocol);\n+        final ChannelFuture connectFuture = channel.connect(remoteAddress);\n \n         connectFuture.addListener((ChannelFuture future) -> {\n             if (future.isSuccess()) {\n-                initSession(desiredProtocol, future, sessionPromise);\n+                initSession(desiredProtocol, poolKey, future, sessionPromise);\n             } else {\n+                invokeProxyConnectFailed(desiredProtocol, poolKey, future.cause());\n                 sessionPromise.tryFailure(future.cause());\n             }\n         });\n     }\n \n+    void invokeProxyConnectFailed(SessionProtocol protocol, PoolKey poolKey, Throwable cause) {\n+        try {\n+            final ProxyConfig proxyConfig = poolKey.proxyConfig;\n+            if (proxyConfig.proxyType() != ProxyType.DIRECT) {\n+                final InetSocketAddress proxyAddress = proxyConfig.proxyAddress();\n+                assert proxyAddress != null;\n+                if (!(cause instanceof UnprocessedRequestException)) {\n+                    cause = new UnprocessedRequestException(cause);\n+                }\n+                proxyConfigSelector.connectFailed(protocol, Endpoint.of(poolKey.host, poolKey.port),\n+                                                  proxyAddress, cause);\n+            }\n+        } catch (Throwable t) {\n+            logger.warn(\"Exception while invoking proxy connectFailed for <{}> \", poolKey, t);", "originalCommit": "70c5c8cedd773e6e74efa2806ffc64f57de0d1af", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f13eb963f9fe1f2dd6f97d015d86ce61a848d474", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java b/core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java\nindex 2a475ed3f..a80ee3d83 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java\n\n@@ -418,14 +418,11 @@ final class HttpChannelPool implements AsyncCloseable {\n             if (proxyConfig.proxyType() != ProxyType.DIRECT) {\n                 final InetSocketAddress proxyAddress = proxyConfig.proxyAddress();\n                 assert proxyAddress != null;\n-                if (!(cause instanceof UnprocessedRequestException)) {\n-                    cause = new UnprocessedRequestException(cause);\n-                }\n                 proxyConfigSelector.connectFailed(protocol, Endpoint.of(poolKey.host, poolKey.port),\n-                                                  proxyAddress, cause);\n+                                                  proxyAddress, UnprocessedRequestException.of(cause));\n             }\n         } catch (Throwable t) {\n-            logger.warn(\"Exception while invoking proxy connectFailed for <{}> \", poolKey, t);\n+            logger.warn(\"Exception while invoking proxy connectFailed for {}\", poolKey, t);\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE3Nzg5MQ==", "url": "https://github.com/line/armeria/pull/2752#discussion_r448177891", "bodyText": "Question: Is it okay not to consider H1C and HTTP?", "author": "minwoox", "createdAt": "2020-07-01T07:44:27Z", "path": "core/src/main/java/com/linecorp/armeria/client/proxy/WrappingProxyConfigSelector.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.io.IOException;\n+import java.net.InetSocketAddress;\n+import java.net.Proxy;\n+import java.net.ProxySelector;\n+import java.net.SocketAddress;\n+import java.util.List;\n+\n+import javax.annotation.Nullable;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.common.SessionProtocol;\n+\n+/**\n+ * See {@link ProxyConfigSelector#wrap(ProxySelector)} for more information.\n+ */\n+final class WrappingProxyConfigSelector implements ProxyConfigSelector {\n+    private static final Logger logger = LoggerFactory.getLogger(WrappingProxyConfigSelector.class);\n+\n+    private static InetSocketAddress resolve(InetSocketAddress inetSocketAddress) {\n+        if (!inetSocketAddress.isUnresolved()) {\n+            return inetSocketAddress;\n+        }\n+        return new InetSocketAddress(inetSocketAddress.getHostString(), inetSocketAddress.getPort());\n+    }\n+\n+    private static ProxyConfig toProxyConfig(@Nullable Proxy proxy) {\n+        if (proxy == null || proxy.address() == null) {\n+            return ProxyConfig.direct();\n+        }\n+\n+        final InetSocketAddress proxyAddress = (InetSocketAddress) proxy.address();\n+        switch (proxy.type()) {\n+            case HTTP:\n+                return ProxyConfig.connect(resolve(proxyAddress));\n+            case SOCKS:\n+                // NOTE: we may consider using {@code sun.net.SocksProxy} to determine the socksProxyVersion\n+                return ProxyConfig.socks5(resolve(proxyAddress));\n+            case DIRECT:\n+            default:\n+                return ProxyConfig.direct();\n+        }\n+    }\n+\n+    static WrappingProxyConfigSelector of(ProxySelector proxySelector) {\n+        return new WrappingProxyConfigSelector(proxySelector);\n+    }\n+\n+    private final ProxySelector proxySelector;\n+\n+    private WrappingProxyConfigSelector(ProxySelector proxySelector) {\n+        this.proxySelector = proxySelector;\n+    }\n+\n+    @Override\n+    public ProxyConfig select(SessionProtocol protocol, Endpoint endpoint) {\n+        requireNonNull(protocol, \"protocol\");\n+        requireNonNull(endpoint, \"endpoint\");\n+        final List<Proxy> proxies = proxySelector.select(endpoint.toUri(protocol));", "originalCommit": "70c5c8cedd773e6e74efa2806ffc64f57de0d1af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc0ODU1Mw==", "url": "https://github.com/line/armeria/pull/2752#discussion_r449748553", "bodyText": "not sure I understand \ud83e\udd14\nI would expect H1C, HTTP to behave normally -- is there a specific scenario you had in mind?", "author": "jrhee17", "createdAt": "2020-07-04T07:24:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE3Nzg5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk1MjE5Nw==", "url": "https://github.com/line/armeria/pull/2752#discussion_r449952197", "bodyText": "Ah, I was sort of thinking generalizing the session protocol to H1C or H2C when the protocol is HTTP. But I guess it's possible and it's the job of ProxyConfigSelector so we don't have to worry about it. \ud83d\ude04", "author": "minwoox", "createdAt": "2020-07-06T02:11:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE3Nzg5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "f13eb963f9fe1f2dd6f97d015d86ce61a848d474", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/proxy/WrappingProxyConfigSelector.java b/core/src/main/java/com/linecorp/armeria/client/proxy/WrappingProxyConfigSelector.java\nindex 778d8cb1a..5c41e156d 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/proxy/WrappingProxyConfigSelector.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/proxy/WrappingProxyConfigSelector.java\n\n@@ -23,6 +23,8 @@ import java.net.InetSocketAddress;\n import java.net.Proxy;\n import java.net.ProxySelector;\n import java.net.SocketAddress;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n import java.util.List;\n \n import javax.annotation.Nullable;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE3ODYxOA==", "url": "https://github.com/line/armeria/pull/2752#discussion_r448178618", "bodyText": "Question: Is it okay not to call the default ProxySelector to check? as the doc suggested?\nhttps://docs.oracle.com/javase/8/docs/technotes/guides/net/proxies.html\nOops, forget about this. \ud83d\ude09", "author": "minwoox", "createdAt": "2020-07-01T07:45:56Z", "path": "core/src/main/java/com/linecorp/armeria/client/proxy/WrappingProxyConfigSelector.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.io.IOException;\n+import java.net.InetSocketAddress;\n+import java.net.Proxy;\n+import java.net.ProxySelector;\n+import java.net.SocketAddress;\n+import java.util.List;\n+\n+import javax.annotation.Nullable;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.common.SessionProtocol;\n+\n+/**\n+ * See {@link ProxyConfigSelector#wrap(ProxySelector)} for more information.\n+ */\n+final class WrappingProxyConfigSelector implements ProxyConfigSelector {\n+    private static final Logger logger = LoggerFactory.getLogger(WrappingProxyConfigSelector.class);\n+\n+    private static InetSocketAddress resolve(InetSocketAddress inetSocketAddress) {\n+        if (!inetSocketAddress.isUnresolved()) {\n+            return inetSocketAddress;\n+        }\n+        return new InetSocketAddress(inetSocketAddress.getHostString(), inetSocketAddress.getPort());\n+    }\n+\n+    private static ProxyConfig toProxyConfig(@Nullable Proxy proxy) {\n+        if (proxy == null || proxy.address() == null) {\n+            return ProxyConfig.direct();\n+        }\n+\n+        final InetSocketAddress proxyAddress = (InetSocketAddress) proxy.address();\n+        switch (proxy.type()) {\n+            case HTTP:\n+                return ProxyConfig.connect(resolve(proxyAddress));\n+            case SOCKS:\n+                // NOTE: we may consider using {@code sun.net.SocksProxy} to determine the socksProxyVersion\n+                return ProxyConfig.socks5(resolve(proxyAddress));\n+            case DIRECT:\n+            default:\n+                return ProxyConfig.direct();\n+        }\n+    }\n+\n+    static WrappingProxyConfigSelector of(ProxySelector proxySelector) {\n+        return new WrappingProxyConfigSelector(proxySelector);\n+    }\n+\n+    private final ProxySelector proxySelector;\n+\n+    private WrappingProxyConfigSelector(ProxySelector proxySelector) {\n+        this.proxySelector = proxySelector;\n+    }\n+\n+    @Override\n+    public ProxyConfig select(SessionProtocol protocol, Endpoint endpoint) {\n+        requireNonNull(protocol, \"protocol\");\n+        requireNonNull(endpoint, \"endpoint\");\n+        final List<Proxy> proxies = proxySelector.select(endpoint.toUri(protocol));\n+        if (proxies == null || proxies.isEmpty()) {\n+            return ProxyConfig.direct();", "originalCommit": "70c5c8cedd773e6e74efa2806ffc64f57de0d1af", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f13eb963f9fe1f2dd6f97d015d86ce61a848d474", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/proxy/WrappingProxyConfigSelector.java b/core/src/main/java/com/linecorp/armeria/client/proxy/WrappingProxyConfigSelector.java\nindex 778d8cb1a..5c41e156d 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/proxy/WrappingProxyConfigSelector.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/proxy/WrappingProxyConfigSelector.java\n\n@@ -23,6 +23,8 @@ import java.net.InetSocketAddress;\n import java.net.Proxy;\n import java.net.ProxySelector;\n import java.net.SocketAddress;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n import java.util.List;\n \n import javax.annotation.Nullable;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ0MDc1NA==", "url": "https://github.com/line/armeria/pull/2752#discussion_r449440754", "bodyText": "Could use <ul> and <li> tags\nHow about JDK's default {@link ProxySelector} implementation instead of sun's {@code DefaultProxySelector}?", "author": "trustin", "createdAt": "2020-07-03T08:08:04Z", "path": "core/src/main/java/com/linecorp/armeria/client/ClientFactoryBuilder.java", "diffHunk": "@@ -509,10 +512,34 @@ public ClientFactoryBuilder meterRegistry(MeterRegistry meterRegistry) {\n     }\n \n     /**\n-     * The {@link ProxyConfig} which contains proxy related configuration.\n+     * Sets the {@link ProxyConfig} which contains proxy related configuration.\n      */\n     public ClientFactoryBuilder proxyConfig(ProxyConfig proxyConfig) {\n-        option(ClientFactoryOption.PROXY_CONFIG, proxyConfig);\n+        requireNonNull(proxyConfig, \"proxyConfig\");\n+        option(ClientFactoryOption.PROXY_CONFIG_SELECTOR, StaticProxyConfigSelector.of(proxyConfig));\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the {@link ProxySelector} which determines the {@link ProxyConfig} to be used.\n+     *\n+     * <p>This method makes a best effort to provide compatibility with {@link ProxySelector}.\n+     * Some known limitations include:\n+     * 1) Limited compatibility with sun's {@code DefaultProxySelector}\n+     * 2) Only selecting a single {@link ProxyConfig} is supported</p>", "originalCommit": "70c5c8cedd773e6e74efa2806ffc64f57de0d1af", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f13eb963f9fe1f2dd6f97d015d86ce61a848d474", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/ClientFactoryBuilder.java b/core/src/main/java/com/linecorp/armeria/client/ClientFactoryBuilder.java\nindex f740879f6..0f11ff041 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/ClientFactoryBuilder.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/ClientFactoryBuilder.java\n\n@@ -516,7 +515,7 @@ public final class ClientFactoryBuilder {\n      */\n     public ClientFactoryBuilder proxyConfig(ProxyConfig proxyConfig) {\n         requireNonNull(proxyConfig, \"proxyConfig\");\n-        option(ClientFactoryOption.PROXY_CONFIG_SELECTOR, StaticProxyConfigSelector.of(proxyConfig));\n+        option(ClientFactoryOption.PROXY_CONFIG_SELECTOR, ProxyConfigSelector.of(proxyConfig));\n         return this;\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ2MjU3OQ==", "url": "https://github.com/line/armeria/pull/2752#discussion_r449462579", "bodyText": "Would you mind moving equals and hashCode() so they come before toString()?", "author": "trustin", "createdAt": "2020-07-03T08:52:08Z", "path": "core/src/main/java/com/linecorp/armeria/client/proxy/ConnectProxyConfig.java", "diffHunk": "@@ -91,4 +90,24 @@ public String toString() {\n                           .omitNullValues()\n                           .toString();\n     }\n+\n+    @Override\n+    public boolean equals(@Nullable Object o) {", "originalCommit": "70c5c8cedd773e6e74efa2806ffc64f57de0d1af", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f13eb963f9fe1f2dd6f97d015d86ce61a848d474", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/proxy/ConnectProxyConfig.java b/core/src/main/java/com/linecorp/armeria/client/proxy/ConnectProxyConfig.java\nindex 0f2c8ace9..02cb52a93 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/proxy/ConnectProxyConfig.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/proxy/ConnectProxyConfig.java\n\n@@ -79,18 +79,6 @@ public final class ConnectProxyConfig extends ProxyConfig {\n         return ProxyType.CONNECT;\n     }\n \n-    @Override\n-    public String toString() {\n-        return MoreObjects.toStringHelper(this)\n-                          .add(\"proxyType\", proxyType())\n-                          .add(\"proxyAddress\", proxyAddress())\n-                          .add(\"username\", username())\n-                          .add(\"password\", maskPassword(username(), password()))\n-                          .add(\"useTls\", useTls())\n-                          .omitNullValues()\n-                          .toString();\n-    }\n-\n     @Override\n     public boolean equals(@Nullable Object o) {\n         if (this == o) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ2MjY5OQ==", "url": "https://github.com/line/armeria/pull/2752#discussion_r449462699", "bodyText": "Ditto - Please move up.", "author": "trustin", "createdAt": "2020-07-03T08:52:22Z", "path": "core/src/main/java/com/linecorp/armeria/client/proxy/DirectProxyConfig.java", "diffHunk": "@@ -33,8 +37,23 @@ public ProxyType proxyType() {\n         return ProxyType.DIRECT;\n     }\n \n+    @Override\n+    public InetSocketAddress proxyAddress() {\n+        return null;\n+    }\n+\n     @Override\n     public String toString() {\n         return MoreObjects.toStringHelper(this).add(\"proxyType\", proxyType()).toString();\n     }\n+\n+    @Override\n+    public boolean equals(@Nullable Object obj) {", "originalCommit": "70c5c8cedd773e6e74efa2806ffc64f57de0d1af", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f13eb963f9fe1f2dd6f97d015d86ce61a848d474", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/proxy/DirectProxyConfig.java b/core/src/main/java/com/linecorp/armeria/client/proxy/DirectProxyConfig.java\nindex 61684be20..675040d70 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/proxy/DirectProxyConfig.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/proxy/DirectProxyConfig.java\n\n@@ -42,11 +40,6 @@ public final class DirectProxyConfig extends ProxyConfig {\n         return null;\n     }\n \n-    @Override\n-    public String toString() {\n-        return MoreObjects.toStringHelper(this).add(\"proxyType\", proxyType()).toString();\n-    }\n-\n     @Override\n     public boolean equals(@Nullable Object obj) {\n         return this == obj;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ2Mzc1Mw==", "url": "https://github.com/line/armeria/pull/2752#discussion_r449463753", "bodyText": "{@link #select(...)}", "author": "trustin", "createdAt": "2020-07-03T08:54:20Z", "path": "core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfigSelector.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.Proxy;\n+import java.net.ProxySelector;\n+import java.net.SocketAddress;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.common.SessionProtocol;\n+import com.linecorp.armeria.common.util.UnstableApi;\n+\n+/**\n+ * Selects the {@link ProxyConfig} to use when connecting to a network\n+ * resource specified by the {@link SessionProtocol} and {@link Endpoint} parameter.\n+ * This class may be used to dynamically control what proxy configuration\n+ * to use for each request.\n+\n+ * <p>It should be noted that the only guarantee provided is for a single request,\n+ * the {@link Endpoint} called with {@code select} will be equal to the {@link Endpoint}", "originalCommit": "70c5c8cedd773e6e74efa2806ffc64f57de0d1af", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f13eb963f9fe1f2dd6f97d015d86ce61a848d474", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfigSelector.java b/core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfigSelector.java\nindex c60ca3fb4..bdd033976 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfigSelector.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfigSelector.java\n\n@@ -31,15 +31,16 @@ import com.linecorp.armeria.common.util.UnstableApi;\n  * resource specified by the {@link SessionProtocol} and {@link Endpoint} parameter.\n  * This class may be used to dynamically control what proxy configuration\n  * to use for each request.\n-\n+ *\n  * <p>It should be noted that the only guarantee provided is for a single request,\n- * the {@link Endpoint} called with {@code select} will be equal to the {@link Endpoint}\n- * called with {@code connectFailed}.</p>\n+ * the {@link Endpoint} called with {@link #select(SessionProtocol, Endpoint)} will be equal to\n+ * the {@link Endpoint} called with {@link #connectFailed(SessionProtocol, Endpoint,\n+ * SocketAddress, Throwable)}.\n  *\n- * <p>For instance, the invoked {@link SessionProtocol} may change depending on the result of\n- * protocol negotiation.\n- * Additionally, we should note the {@link Endpoint} used to construct the request will not\n- * necessarily be equal to the {@link Endpoint} in either callback method parameter.</p>\n+ * <p>For instance, the actual {@link SessionProtocol} of the connection may differ from\n+ * the originally requested {@link SessionProtocol} depending on the result of protocol negotiation.\n+ * Similarly, the actual {@link Endpoint} of the request may differ from the originally requested\n+ * {@link Endpoint}.\n  */\n @UnstableApi\n public interface ProxyConfigSelector {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ2Mzg2OQ==", "url": "https://github.com/line/armeria/pull/2752#discussion_r449463869", "bodyText": "{@link #connectFailed(...)}", "author": "trustin", "createdAt": "2020-07-03T08:54:32Z", "path": "core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfigSelector.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.Proxy;\n+import java.net.ProxySelector;\n+import java.net.SocketAddress;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.common.SessionProtocol;\n+import com.linecorp.armeria.common.util.UnstableApi;\n+\n+/**\n+ * Selects the {@link ProxyConfig} to use when connecting to a network\n+ * resource specified by the {@link SessionProtocol} and {@link Endpoint} parameter.\n+ * This class may be used to dynamically control what proxy configuration\n+ * to use for each request.\n+\n+ * <p>It should be noted that the only guarantee provided is for a single request,\n+ * the {@link Endpoint} called with {@code select} will be equal to the {@link Endpoint}\n+ * called with {@code connectFailed}.</p>", "originalCommit": "70c5c8cedd773e6e74efa2806ffc64f57de0d1af", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f13eb963f9fe1f2dd6f97d015d86ce61a848d474", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfigSelector.java b/core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfigSelector.java\nindex c60ca3fb4..bdd033976 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfigSelector.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfigSelector.java\n\n@@ -31,15 +31,16 @@ import com.linecorp.armeria.common.util.UnstableApi;\n  * resource specified by the {@link SessionProtocol} and {@link Endpoint} parameter.\n  * This class may be used to dynamically control what proxy configuration\n  * to use for each request.\n-\n+ *\n  * <p>It should be noted that the only guarantee provided is for a single request,\n- * the {@link Endpoint} called with {@code select} will be equal to the {@link Endpoint}\n- * called with {@code connectFailed}.</p>\n+ * the {@link Endpoint} called with {@link #select(SessionProtocol, Endpoint)} will be equal to\n+ * the {@link Endpoint} called with {@link #connectFailed(SessionProtocol, Endpoint,\n+ * SocketAddress, Throwable)}.\n  *\n- * <p>For instance, the invoked {@link SessionProtocol} may change depending on the result of\n- * protocol negotiation.\n- * Additionally, we should note the {@link Endpoint} used to construct the request will not\n- * necessarily be equal to the {@link Endpoint} in either callback method parameter.</p>\n+ * <p>For instance, the actual {@link SessionProtocol} of the connection may differ from\n+ * the originally requested {@link SessionProtocol} depending on the result of protocol negotiation.\n+ * Similarly, the actual {@link Endpoint} of the request may differ from the originally requested\n+ * {@link Endpoint}.\n  */\n @UnstableApi\n public interface ProxyConfigSelector {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ2NTU3Mg==", "url": "https://github.com/line/armeria/pull/2752#discussion_r449465572", "bodyText": "How about this:\n<p>For instance, the actual {@link SessionProtocol} of the connection may differ from\nthe originally requested {@link SessionProtocol} depending on the result of protocol negotiation.\nSimilarly, the actual {@link Endpoint} of the request may differ from the originally requested\n{@link Endpoint}.\n\nDoes the new paragraph make sense and convey what you were trying to tell?", "author": "trustin", "createdAt": "2020-07-03T08:57:38Z", "path": "core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfigSelector.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.Proxy;\n+import java.net.ProxySelector;\n+import java.net.SocketAddress;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.common.SessionProtocol;\n+import com.linecorp.armeria.common.util.UnstableApi;\n+\n+/**\n+ * Selects the {@link ProxyConfig} to use when connecting to a network\n+ * resource specified by the {@link SessionProtocol} and {@link Endpoint} parameter.\n+ * This class may be used to dynamically control what proxy configuration\n+ * to use for each request.\n+\n+ * <p>It should be noted that the only guarantee provided is for a single request,\n+ * the {@link Endpoint} called with {@code select} will be equal to the {@link Endpoint}\n+ * called with {@code connectFailed}.</p>\n+ *\n+ * <p>For instance, the invoked {@link SessionProtocol} may change depending on the result of\n+ * protocol negotiation.\n+ * Additionally, we should note the {@link Endpoint} used to construct the request will not\n+ * necessarily be equal to the {@link Endpoint} in either callback method parameter.</p>", "originalCommit": "70c5c8cedd773e6e74efa2806ffc64f57de0d1af", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f13eb963f9fe1f2dd6f97d015d86ce61a848d474", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfigSelector.java b/core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfigSelector.java\nindex c60ca3fb4..bdd033976 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfigSelector.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfigSelector.java\n\n@@ -31,15 +31,16 @@ import com.linecorp.armeria.common.util.UnstableApi;\n  * resource specified by the {@link SessionProtocol} and {@link Endpoint} parameter.\n  * This class may be used to dynamically control what proxy configuration\n  * to use for each request.\n-\n+ *\n  * <p>It should be noted that the only guarantee provided is for a single request,\n- * the {@link Endpoint} called with {@code select} will be equal to the {@link Endpoint}\n- * called with {@code connectFailed}.</p>\n+ * the {@link Endpoint} called with {@link #select(SessionProtocol, Endpoint)} will be equal to\n+ * the {@link Endpoint} called with {@link #connectFailed(SessionProtocol, Endpoint,\n+ * SocketAddress, Throwable)}.\n  *\n- * <p>For instance, the invoked {@link SessionProtocol} may change depending on the result of\n- * protocol negotiation.\n- * Additionally, we should note the {@link Endpoint} used to construct the request will not\n- * necessarily be equal to the {@link Endpoint} in either callback method parameter.</p>\n+ * <p>For instance, the actual {@link SessionProtocol} of the connection may differ from\n+ * the originally requested {@link SessionProtocol} depending on the result of protocol negotiation.\n+ * Similarly, the actual {@link Endpoint} of the request may differ from the originally requested\n+ * {@link Endpoint}.\n  */\n @UnstableApi\n public interface ProxyConfigSelector {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ2NjI4MA==", "url": "https://github.com/line/armeria/pull/2752#discussion_r449466280", "bodyText": "Use <ul> and <li>.\nInstead of mentioning 'sun', could say like: JDK's default {@link ProxySelector} implementation", "author": "trustin", "createdAt": "2020-07-03T08:59:02Z", "path": "core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfigSelector.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.Proxy;\n+import java.net.ProxySelector;\n+import java.net.SocketAddress;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.common.SessionProtocol;\n+import com.linecorp.armeria.common.util.UnstableApi;\n+\n+/**\n+ * Selects the {@link ProxyConfig} to use when connecting to a network\n+ * resource specified by the {@link SessionProtocol} and {@link Endpoint} parameter.\n+ * This class may be used to dynamically control what proxy configuration\n+ * to use for each request.\n+\n+ * <p>It should be noted that the only guarantee provided is for a single request,\n+ * the {@link Endpoint} called with {@code select} will be equal to the {@link Endpoint}\n+ * called with {@code connectFailed}.</p>\n+ *\n+ * <p>For instance, the invoked {@link SessionProtocol} may change depending on the result of\n+ * protocol negotiation.\n+ * Additionally, we should note the {@link Endpoint} used to construct the request will not\n+ * necessarily be equal to the {@link Endpoint} in either callback method parameter.</p>\n+ */\n+@UnstableApi\n+public interface ProxyConfigSelector {\n+\n+    /**\n+     * Selects the {@link ProxyConfig} to use when connecting to a network\n+     * resource specified by the {@link SessionProtocol} and {@link Endpoint} parameter.\n+     *\n+     * @param protocol the protocol associated with the endpoint\n+     * @param endpoint an endpoint containing the requested host and port\n+     * @return the selected proxy config which should be non-null\n+     */\n+    ProxyConfig select(SessionProtocol protocol, Endpoint endpoint);\n+\n+    /**\n+     * Called to indicate a connection attempt to the specified {@link SessionProtocol}\n+     * and {@link Endpoint} has failed.\n+     *\n+     * @param protocol the protocol associated with the endpoint\n+     * @param endpoint an endpoint containing the requested host and port\n+     * @param sa the remote socket address of the proxy server\n+     * @param throwable the cause of the failure\n+     */\n+    void connectFailed(SessionProtocol protocol, Endpoint endpoint,\n+                       SocketAddress sa, Throwable throwable);\n+\n+    /**\n+     * Provides a way to re-use an existing {@link ProxySelector} with some limitations:\n+     * 1. Some incompatibilities when used with sun's {@code DefaultProxySelector}", "originalCommit": "70c5c8cedd773e6e74efa2806ffc64f57de0d1af", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f13eb963f9fe1f2dd6f97d015d86ce61a848d474", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfigSelector.java b/core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfigSelector.java\nindex c60ca3fb4..bdd033976 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfigSelector.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfigSelector.java\n\n@@ -31,15 +31,16 @@ import com.linecorp.armeria.common.util.UnstableApi;\n  * resource specified by the {@link SessionProtocol} and {@link Endpoint} parameter.\n  * This class may be used to dynamically control what proxy configuration\n  * to use for each request.\n-\n+ *\n  * <p>It should be noted that the only guarantee provided is for a single request,\n- * the {@link Endpoint} called with {@code select} will be equal to the {@link Endpoint}\n- * called with {@code connectFailed}.</p>\n+ * the {@link Endpoint} called with {@link #select(SessionProtocol, Endpoint)} will be equal to\n+ * the {@link Endpoint} called with {@link #connectFailed(SessionProtocol, Endpoint,\n+ * SocketAddress, Throwable)}.\n  *\n- * <p>For instance, the invoked {@link SessionProtocol} may change depending on the result of\n- * protocol negotiation.\n- * Additionally, we should note the {@link Endpoint} used to construct the request will not\n- * necessarily be equal to the {@link Endpoint} in either callback method parameter.</p>\n+ * <p>For instance, the actual {@link SessionProtocol} of the connection may differ from\n+ * the originally requested {@link SessionProtocol} depending on the result of protocol negotiation.\n+ * Similarly, the actual {@link Endpoint} of the request may differ from the originally requested\n+ * {@link Endpoint}.\n  */\n @UnstableApi\n public interface ProxyConfigSelector {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ2NjM2Mw==", "url": "https://github.com/line/armeria/pull/2752#discussion_r449466363", "bodyText": "Ditto - please move up.", "author": "trustin", "createdAt": "2020-07-03T08:59:13Z", "path": "core/src/main/java/com/linecorp/armeria/client/proxy/Socks4ProxyConfig.java", "diffHunk": "@@ -65,4 +64,22 @@ public String toString() {\n                           .add(\"username\", username())\n                           .toString();\n     }\n+\n+    @Override\n+    public boolean equals(@Nullable Object o) {", "originalCommit": "70c5c8cedd773e6e74efa2806ffc64f57de0d1af", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f13eb963f9fe1f2dd6f97d015d86ce61a848d474", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/proxy/Socks4ProxyConfig.java b/core/src/main/java/com/linecorp/armeria/client/proxy/Socks4ProxyConfig.java\nindex 42a2583f9..64605b00b 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/proxy/Socks4ProxyConfig.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/proxy/Socks4ProxyConfig.java\n\n@@ -56,15 +56,6 @@ public final class Socks4ProxyConfig extends ProxyConfig {\n         return ProxyType.SOCKS4;\n     }\n \n-    @Override\n-    public String toString() {\n-        return MoreObjects.toStringHelper(this)\n-                          .add(\"proxyType\", proxyType())\n-                          .add(\"proxyAddress\", proxyAddress())\n-                          .add(\"username\", username())\n-                          .toString();\n-    }\n-\n     @Override\n     public boolean equals(@Nullable Object o) {\n         if (this == o) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ2NjQ4Mw==", "url": "https://github.com/line/armeria/pull/2752#discussion_r449466483", "bodyText": "Ditto - please move up.", "author": "trustin", "createdAt": "2020-07-03T08:59:25Z", "path": "core/src/main/java/com/linecorp/armeria/client/proxy/Socks5ProxyConfig.java", "diffHunk": "@@ -80,4 +79,23 @@ public String toString() {\n                           .omitNullValues()\n                           .toString();\n     }\n+\n+    @Override\n+    public boolean equals(@Nullable Object o) {", "originalCommit": "70c5c8cedd773e6e74efa2806ffc64f57de0d1af", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f13eb963f9fe1f2dd6f97d015d86ce61a848d474", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/proxy/Socks5ProxyConfig.java b/core/src/main/java/com/linecorp/armeria/client/proxy/Socks5ProxyConfig.java\nindex e92d76826..e673a790c 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/proxy/Socks5ProxyConfig.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/proxy/Socks5ProxyConfig.java\n\n@@ -69,17 +69,6 @@ public final class Socks5ProxyConfig extends ProxyConfig {\n         return ProxyType.SOCKS5;\n     }\n \n-    @Override\n-    public String toString() {\n-        return MoreObjects.toStringHelper(this)\n-                          .add(\"proxyType\", proxyType())\n-                          .add(\"proxyAddress\", proxyAddress())\n-                          .add(\"username\", username())\n-                          .add(\"password\", maskPassword(username(), password()))\n-                          .omitNullValues()\n-                          .toString();\n-    }\n-\n     @Override\n     public boolean equals(@Nullable Object o) {\n         if (this == o) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ2NjY3NA==", "url": "https://github.com/line/armeria/pull/2752#discussion_r449466674", "bodyText": "Could be hidden from the public API?", "author": "trustin", "createdAt": "2020-07-03T08:59:46Z", "path": "core/src/main/java/com/linecorp/armeria/client/proxy/StaticProxyConfigSelector.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.SocketAddress;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.common.SessionProtocol;\n+\n+/**\n+ * A {@link ProxyConfigSelector} which selects a static {@link ProxyConfig}\n+ * for all requests.\n+ */\n+public final class StaticProxyConfigSelector implements ProxyConfigSelector {", "originalCommit": "70c5c8cedd773e6e74efa2806ffc64f57de0d1af", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f13eb963f9fe1f2dd6f97d015d86ce61a848d474", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/proxy/StaticProxyConfigSelector.java b/core/src/main/java/com/linecorp/armeria/client/proxy/StaticProxyConfigSelector.java\nindex 51c05de62..04cc9180c 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/proxy/StaticProxyConfigSelector.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/proxy/StaticProxyConfigSelector.java\n\n@@ -23,19 +23,11 @@ import java.net.SocketAddress;\n import com.linecorp.armeria.client.Endpoint;\n import com.linecorp.armeria.common.SessionProtocol;\n \n-/**\n- * A {@link ProxyConfigSelector} which selects a static {@link ProxyConfig}\n- * for all requests.\n- */\n-public final class StaticProxyConfigSelector implements ProxyConfigSelector {\n+final class StaticProxyConfigSelector implements ProxyConfigSelector {\n \n     private static final StaticProxyConfigSelector DIRECT = new StaticProxyConfigSelector(ProxyConfig.direct());\n \n-    /**\n-     * Returns a {@link ProxyConfigSelector} which selects a static {@link ProxyConfig}\n-     * for all requests.\n-     */\n-    public static StaticProxyConfigSelector of(ProxyConfig proxyConfig) {\n+    static StaticProxyConfigSelector of(ProxyConfig proxyConfig) {\n         if (proxyConfig == ProxyConfig.direct()) {\n             return DIRECT;\n         }\n"}}, {"oid": "25447ac7091f2aa24e36bfe365da189387818e4c", "url": "https://github.com/line/armeria/commit/25447ac7091f2aa24e36bfe365da189387818e4c", "message": "Merge branch 'master' into feature/proxy-system-property", "committedDate": "2020-07-04T05:07:13Z", "type": "commit"}, {"oid": "f13eb963f9fe1f2dd6f97d015d86ce61a848d474", "url": "https://github.com/line/armeria/commit/f13eb963f9fe1f2dd6f97d015d86ce61a848d474", "message": "reformat javadocs, hide staticProxy, remove ser format from URI scheme", "committedDate": "2020-07-04T07:19:24Z", "type": "commit"}, {"oid": "8f7a97c66e761c6396a6c3c6ee68298cc61d08e9", "url": "https://github.com/line/armeria/commit/8f7a97c66e761c6396a6c3c6ee68298cc61d08e9", "message": "clean up unaddressed logging/javadocs format", "committedDate": "2020-07-04T07:48:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgyOTk3OQ==", "url": "https://github.com/line/armeria/pull/2752#discussion_r449829979", "bodyText": "I feel like this change deserves some explanation:\nEndpoint.toUri requires a serialization format (which was always none before introducing this method)\nHowever, serialization format may not necessarily be none. (i.e. tbinary calls with proxy)\nOn the other hand, a session shouldn't necessarily only use a single serialization format, hence I moved away from using Scheme for the callback methods.\nHence, I'd decided to omit SerializationFormat entirely from the uri scheme.", "author": "jrhee17", "createdAt": "2020-07-05T03:36:22Z", "path": "core/src/main/java/com/linecorp/armeria/client/proxy/WrappingProxyConfigSelector.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.io.IOException;\n+import java.net.InetSocketAddress;\n+import java.net.Proxy;\n+import java.net.ProxySelector;\n+import java.net.SocketAddress;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.util.List;\n+\n+import javax.annotation.Nullable;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.common.SessionProtocol;\n+\n+/**\n+ * See {@link ProxyConfigSelector#of(ProxySelector)} for more information.\n+ */\n+final class WrappingProxyConfigSelector implements ProxyConfigSelector {\n+    private static final Logger logger = LoggerFactory.getLogger(WrappingProxyConfigSelector.class);\n+\n+    /**\n+     * Converts {@link SessionProtocol}, {@link Endpoint} to a uri without serialization format.\n+     */\n+    private static URI toUri(SessionProtocol sessionProtocol, Endpoint endpoint) {\n+        try {", "originalCommit": "8f7a97c66e761c6396a6c3c6ee68298cc61d08e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk0NTQyMg==", "url": "https://github.com/line/armeria/pull/2752#discussion_r449945422", "bodyText": "OK!", "author": "trustin", "createdAt": "2020-07-06T01:32:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgyOTk3OQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk0NTI1Mg==", "url": "https://github.com/line/armeria/pull/2752#discussion_r449945252", "bodyText": "re-use -> reuse\nInconsistent indentation. Could you use 2-space indentation for HTML tags?", "author": "trustin", "createdAt": "2020-07-06T01:31:36Z", "path": "core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfigSelector.java", "diffHunk": "@@ -67,16 +68,27 @@ void connectFailed(SessionProtocol protocol, Endpoint endpoint,\n                        SocketAddress sa, Throwable throwable);\n \n     /**\n-     * Provides a way to re-use an existing {@link ProxySelector} with some limitations:\n-     * 1. Some incompatibilities when used with sun's {@code DefaultProxySelector}\n-     *     - Some properties like socksProxyVersion aren't respected\n-     *     - This class doesn't attempt to resolve scheme format differences.\n-     *       For instance, sun's {@code DefaultProxySelector} requires basic scheme formats \"http\", \"https\".\n-     *       However, armeria uses scheme formats including serialization format (\"none+http\", \"tbinary+h1c\").\n-     *       This may be a source of unexpected behavior.\n-     * 2. Selecting multiple {@link Proxy} isn't supported.\n+     * Provides a way to re-use an existing {@link ProxySelector} with some limitations.\n+     * <ul>\n+     *     <li>Incompatibilities when used with JDK's default {@link ProxySelector} implementation:\n+     *       <ul>", "originalCommit": "f13eb963f9fe1f2dd6f97d015d86ce61a848d474", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f375edf8940b63bf54fdd751a19165475092807c", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfigSelector.java b/core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfigSelector.java\nindex bdd033976..204947b6e 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfigSelector.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfigSelector.java\n\n@@ -68,17 +68,17 @@ public interface ProxyConfigSelector {\n                        SocketAddress sa, Throwable throwable);\n \n     /**\n-     * Provides a way to re-use an existing {@link ProxySelector} with some limitations.\n+     * Provides a way to reuse an existing {@link ProxySelector} with some limitations.\n      * <ul>\n-     *     <li>Incompatibilities when used with JDK's default {@link ProxySelector} implementation:\n-     *       <ul>\n-     *         <li>Some properties like socksProxyVersion aren't respected</li>\n-     *         <li>This class doesn't attempt to resolve scheme format differences.\n-     *         However, armeria uses some schemes such as \"h1c\", \"h2\" which aren't supported by JDK's\n-     *         default {@link ProxySelector}. This may be a source of unexpected behavior.</li>\n-     *       </ul>\n-     *     </li>\n-     *     <li>Selecting multiple {@link Proxy} isn't supported</li>\n+     *   <li>Incompatibilities when used with JDK's default {@link ProxySelector} implementation:\n+     *     <ul>\n+     *       <li>Some properties like socksProxyVersion aren't respected</li>\n+     *       <li>This class doesn't attempt to resolve scheme format differences.\n+     *       However, armeria uses some schemes such as \"h1c\", \"h2\" which aren't supported by JDK's\n+     *       default {@link ProxySelector}. This may be a source of unexpected behavior.</li>\n+     *     </ul>\n+     *   </li>\n+     *   <li>Selecting multiple {@link Proxy} isn't supported</li>\n      * </ul>\n      */\n     static ProxyConfigSelector of(ProxySelector proxySelector) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk0NTk5MQ==", "url": "https://github.com/line/armeria/pull/2752#discussion_r449945991", "bodyText": "How about making it clear that it's not fully compatible?\n<p>This method makes a best effort to provide compatibility with .., but it has some limitations.\nSee ...", "author": "trustin", "createdAt": "2020-07-06T01:36:08Z", "path": "core/src/main/java/com/linecorp/armeria/client/ClientFactoryBuilder.java", "diffHunk": "@@ -509,10 +511,32 @@ public ClientFactoryBuilder meterRegistry(MeterRegistry meterRegistry) {\n     }\n \n     /**\n-     * The {@link ProxyConfig} which contains proxy related configuration.\n+     * Sets the {@link ProxyConfig} which contains proxy related configuration.\n      */\n     public ClientFactoryBuilder proxyConfig(ProxyConfig proxyConfig) {\n-        option(ClientFactoryOption.PROXY_CONFIG, proxyConfig);\n+        requireNonNull(proxyConfig, \"proxyConfig\");\n+        option(ClientFactoryOption.PROXY_CONFIG_SELECTOR, ProxyConfigSelector.of(proxyConfig));\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the {@link ProxySelector} which determines the {@link ProxyConfig} to be used.\n+     *\n+     * <p>This method makes a best effort to provide compatibility with {@link ProxySelector}.\n+     * See {@link ProxyConfigSelector#of(ProxySelector)} for more information.", "originalCommit": "8f7a97c66e761c6396a6c3c6ee68298cc61d08e9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f375edf8940b63bf54fdd751a19165475092807c", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/ClientFactoryBuilder.java b/core/src/main/java/com/linecorp/armeria/client/ClientFactoryBuilder.java\nindex 0f11ff041..fa937dfe8 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/ClientFactoryBuilder.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/ClientFactoryBuilder.java\n\n@@ -522,8 +522,8 @@ public final class ClientFactoryBuilder {\n     /**\n      * Sets the {@link ProxySelector} which determines the {@link ProxyConfig} to be used.\n      *\n-     * <p>This method makes a best effort to provide compatibility with {@link ProxySelector}.\n-     * See {@link ProxyConfigSelector#of(ProxySelector)} for more information.\n+     * <p>This method makes a best effort to provide compatibility with {@link ProxySelector},\n+     * but it has some limitations. See {@link ProxyConfigSelector#of(ProxySelector)} for more information.\n      */\n     public ClientFactoryBuilder proxyConfig(ProxySelector proxySelector) {\n         requireNonNull(proxySelector, \"proxySelector\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk0NjM2MQ==", "url": "https://github.com/line/armeria/pull/2752#discussion_r449946361", "bodyText": "\"Exception while invoking {}.connectFailed() for {}\",\nProxyConfigSelector.class.getSimpleName(), poolKey, t", "author": "trustin", "createdAt": "2020-07-06T01:38:11Z", "path": "core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java", "diffHunk": "@@ -382,27 +394,46 @@ private void connect(SessionProtocol desiredProtocol, PoolKey key, ChannelAcquis\n      * </ul>\n      */\n     void connect(SocketAddress remoteAddress, SessionProtocol desiredProtocol,\n-                 Promise<Channel> sessionPromise) {\n+                 PoolKey poolKey, Promise<Channel> sessionPromise) {\n+\n         final Bootstrap bootstrap = getBootstrap(desiredProtocol);\n-        final ChannelFuture connectFuture = bootstrap.connect(remoteAddress);\n+\n+        final Channel channel = bootstrap.register().channel();\n+        configureProxy(channel, poolKey.proxyConfig, desiredProtocol);\n+        final ChannelFuture connectFuture = channel.connect(remoteAddress);\n \n         connectFuture.addListener((ChannelFuture future) -> {\n             if (future.isSuccess()) {\n-                initSession(desiredProtocol, future, sessionPromise);\n+                initSession(desiredProtocol, poolKey, future, sessionPromise);\n             } else {\n+                invokeProxyConnectFailed(desiredProtocol, poolKey, future.cause());\n                 sessionPromise.tryFailure(future.cause());\n             }\n         });\n     }\n \n+    void invokeProxyConnectFailed(SessionProtocol protocol, PoolKey poolKey, Throwable cause) {\n+        try {\n+            final ProxyConfig proxyConfig = poolKey.proxyConfig;\n+            if (proxyConfig.proxyType() != ProxyType.DIRECT) {\n+                final InetSocketAddress proxyAddress = proxyConfig.proxyAddress();\n+                assert proxyAddress != null;\n+                proxyConfigSelector.connectFailed(protocol, Endpoint.of(poolKey.host, poolKey.port),\n+                                                  proxyAddress, UnprocessedRequestException.of(cause));\n+            }\n+        } catch (Throwable t) {\n+            logger.warn(\"Exception while invoking proxy connectFailed for {}\", poolKey, t);", "originalCommit": "8f7a97c66e761c6396a6c3c6ee68298cc61d08e9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f375edf8940b63bf54fdd751a19165475092807c", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java b/core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java\nindex a80ee3d83..0824bef50 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java\n\n@@ -422,7 +422,8 @@ final class HttpChannelPool implements AsyncCloseable {\n                                                   proxyAddress, UnprocessedRequestException.of(cause));\n             }\n         } catch (Throwable t) {\n-            logger.warn(\"Exception while invoking proxy connectFailed for {}\", poolKey, t);\n+            logger.warn(\"Exception while invoking {}.connectFailed() for {}\",\n+                        ProxyConfigSelector.class.getSimpleName(), poolKey, t);\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk0NzAwOQ==", "url": "https://github.com/line/armeria/pull/2752#discussion_r449947009", "bodyText": "OK to leave these methods as they are, but looks redundant.", "author": "trustin", "createdAt": "2020-07-06T01:41:28Z", "path": "core/src/main/java/com/linecorp/armeria/client/proxy/DirectProxyConfig.java", "diffHunk": "@@ -33,8 +35,23 @@ public ProxyType proxyType() {\n         return ProxyType.DIRECT;\n     }\n \n+    @Override\n+    public InetSocketAddress proxyAddress() {\n+        return null;\n+    }\n+\n+    @Override\n+    public boolean equals(@Nullable Object obj) {\n+        return this == obj;\n+    }\n+\n+    @Override\n+    public int hashCode() {\n+        return System.identityHashCode(this);\n+    }", "originalCommit": "8f7a97c66e761c6396a6c3c6ee68298cc61d08e9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f375edf8940b63bf54fdd751a19165475092807c", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/proxy/DirectProxyConfig.java b/core/src/main/java/com/linecorp/armeria/client/proxy/DirectProxyConfig.java\nindex 675040d70..6a1416723 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/proxy/DirectProxyConfig.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/proxy/DirectProxyConfig.java\n\n@@ -40,16 +38,6 @@ public final class DirectProxyConfig extends ProxyConfig {\n         return null;\n     }\n \n-    @Override\n-    public boolean equals(@Nullable Object obj) {\n-        return this == obj;\n-    }\n-\n-    @Override\n-    public int hashCode() {\n-        return System.identityHashCode(this);\n-    }\n-\n     @Override\n     public String toString() {\n         return \"DirectProxyConfig{proxyType=DIRECT}\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk0NzM4Mw==", "url": "https://github.com/line/armeria/pull/2752#discussion_r449947383", "bodyText": "IIRC we don't need this at all. If no port is specified, it automatically adds this for you.", "author": "trustin", "createdAt": "2020-07-06T01:43:47Z", "path": "core/src/test/java/com/linecorp/armeria/client/proxy/ProxyClientIntegrationTest.java", "diffHunk": "@@ -118,7 +131,7 @@\n     static ServerExtension backendServer = new ServerExtension() {\n         @Override\n         protected void configure(ServerBuilder sb) throws Exception {\n-            sb.port(0, SessionProtocol.HTTP);\n+            sb.port(0, HTTP);", "originalCommit": "8f7a97c66e761c6396a6c3c6ee68298cc61d08e9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f375edf8940b63bf54fdd751a19165475092807c", "chunk": "diff --git a/core/src/test/java/com/linecorp/armeria/client/proxy/ProxyClientIntegrationTest.java b/core/src/test/java/com/linecorp/armeria/client/proxy/ProxyClientIntegrationTest.java\nindex ece94689c..9e414993f 100644\n--- a/core/src/test/java/com/linecorp/armeria/client/proxy/ProxyClientIntegrationTest.java\n+++ b/core/src/test/java/com/linecorp/armeria/client/proxy/ProxyClientIntegrationTest.java\n\n@@ -131,7 +131,6 @@ class ProxyClientIntegrationTest {\n     static ServerExtension backendServer = new ServerExtension() {\n         @Override\n         protected void configure(ServerBuilder sb) throws Exception {\n-            sb.port(0, HTTP);\n             sb.service(PROXY_PATH, (ctx, req) -> HttpResponse.of(SUCCESS_RESPONSE));\n         }\n     };\n"}}, {"oid": "f375edf8940b63bf54fdd751a19165475092807c", "url": "https://github.com/line/armeria/commit/f375edf8940b63bf54fdd751a19165475092807c", "message": "clean up javadocs and exception messages", "committedDate": "2020-07-07T10:32:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM0MTYyNA==", "url": "https://github.com/line/armeria/pull/2752#discussion_r451341624", "bodyText": "Question: What happens if sslCtx is applied twice? here and in HttpClientPipelineConfigurator?", "author": "minwoox", "createdAt": "2020-07-08T07:34:54Z", "path": "core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java", "diffHunk": "@@ -139,43 +143,51 @@ protected void initChannel(Channel ch) throws Exception {\n         useHttp1Pipelining = clientFactory.useHttp1Pipelining();\n         idleTimeoutMillis = clientFactory.idleTimeoutMillis();\n         pingIntervalMillis = clientFactory.pingIntervalMillis();\n-        proxyConfig = clientFactory.proxyConfig();\n+        proxyConfigSelector = clientFactory.proxyConfigSelector();\n+    }\n+\n+    private SslContext determineSslContext(SessionProtocol desiredProtocol) {\n+        return desiredProtocol == SessionProtocol.H1 || desiredProtocol == SessionProtocol.H1C ?\n+               sslCtxHttp1Only : sslCtxHttp1Or2;\n     }\n \n-    private void configureProxy(Channel ch, ProxyConfig proxyConfig, SslContext sslCtx) {\n+    private void configureProxy(Channel ch, ProxyConfig proxyConfig, SessionProtocol desiredProtocol) {\n+        if (proxyConfig.proxyType() == ProxyType.DIRECT) {\n+            return;\n+        }\n         final ProxyHandler proxyHandler;\n+        final InetSocketAddress proxyAddress = proxyConfig.proxyAddress();\n+        assert proxyAddress != null;\n         switch (proxyConfig.proxyType()) {\n-            case DIRECT:\n-                return;\n             case SOCKS4:\n                 final Socks4ProxyConfig socks4ProxyConfig = (Socks4ProxyConfig) proxyConfig;\n-                proxyHandler = new Socks4ProxyHandler(socks4ProxyConfig.proxyAddress(),\n-                                                      socks4ProxyConfig.username());\n+                proxyHandler = new Socks4ProxyHandler(proxyAddress, socks4ProxyConfig.username());\n                 break;\n             case SOCKS5:\n                 final Socks5ProxyConfig socks5ProxyConfig = (Socks5ProxyConfig) proxyConfig;\n-                proxyHandler = new Socks5ProxyHandler(\n-                        socks5ProxyConfig.proxyAddress(), socks5ProxyConfig.username(),\n-                        socks5ProxyConfig.password());\n+                proxyHandler = new Socks5ProxyHandler(proxyAddress, socks5ProxyConfig.username(),\n+                                                      socks5ProxyConfig.password());\n                 break;\n             case CONNECT:\n                 final ConnectProxyConfig connectProxyConfig = (ConnectProxyConfig) proxyConfig;\n                 final String username = connectProxyConfig.username();\n                 final String password = connectProxyConfig.password();\n                 if (username == null || password == null) {\n-                    proxyHandler = new HttpProxyHandler(connectProxyConfig.proxyAddress());\n+                    proxyHandler = new HttpProxyHandler(proxyAddress);\n                 } else {\n-                    proxyHandler = new HttpProxyHandler(connectProxyConfig.proxyAddress(), username, password);\n-                }\n-                if (connectProxyConfig.useTls()) {\n-                    ch.pipeline().addLast(sslCtx.newHandler(ch.alloc()));\n+                    proxyHandler = new HttpProxyHandler(proxyAddress, username, password);\n                 }\n                 break;\n             default:\n                 throw new Error(); // Should never reach here.\n         }\n         proxyHandler.setConnectTimeoutMillis(connectTimeoutMillis);\n-        ch.pipeline().addLast(proxyHandler);\n+        ch.pipeline().addFirst(proxyHandler);\n+\n+        if (proxyConfig instanceof ConnectProxyConfig && ((ConnectProxyConfig) proxyConfig).useTls()) {\n+            final SslContext sslCtx = determineSslContext(desiredProtocol);\n+            ch.pipeline().addFirst(sslCtx.newHandler(ch.alloc()));", "originalCommit": "f375edf8940b63bf54fdd751a19165475092807c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQzNTkwNQ==", "url": "https://github.com/line/armeria/pull/2752#discussion_r451435905", "bodyText": "Nothing interesting \ud83d\ude04  just ssl is applied twice.\nLet me add an integration test to make sure this behavior isn't broken in the future though", "author": "jrhee17", "createdAt": "2020-07-08T10:16:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM0MTYyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTU4ODYxMQ==", "url": "https://github.com/line/armeria/pull/2752#discussion_r451588611", "bodyText": "This is embarrassing... but found a bug thanks to your comment \ud83d\udc4d\nLet me handle this issue in a separate PR \ud83d\ude47", "author": "jrhee17", "createdAt": "2020-07-08T14:27:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM0MTYyNA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM0NzAxMw==", "url": "https://github.com/line/armeria/pull/2752#discussion_r451347013", "bodyText": "Let's just return here.\nAnd we should use handleEarlyRequestException() if the proxyConfig is null instead of throwing an NPE.", "author": "minwoox", "createdAt": "2020-07-08T07:44:50Z", "path": "core/src/main/java/com/linecorp/armeria/client/HttpClientDelegate.java", "diffHunk": "@@ -159,6 +165,20 @@ private void acquireConnectionAndExecute(ClientRequestContext ctx, Endpoint endp\n         }\n     }\n \n+    private ProxyConfig selectProxyConfig(SessionProtocol sessionProtocol, String host, int port) {\n+        ProxyConfig proxyConfig;\n+        try {\n+            final Endpoint endpoint = Endpoint.of(host, port);\n+            proxyConfig = factory.proxyConfigSelector().select(sessionProtocol, endpoint);", "originalCommit": "f375edf8940b63bf54fdd751a19165475092807c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM0ODkzMw==", "url": "https://github.com/line/armeria/pull/2752#discussion_r451348933", "bodyText": "Ah, I forgot that the exception is caught by the below line. \ud83d\ude05\nSo I guess it's okay then. \ud83d\ude04", "author": "minwoox", "createdAt": "2020-07-08T07:48:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM0NzAxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQzNTU0Ng==", "url": "https://github.com/line/armeria/pull/2752#discussion_r451435546", "bodyText": "Sorry reviewers\nThis comment actually made me realize the API might be cleaner if we just throw as @minwoox suggested.\nAs a user, I don't think I would want random direct requests.\nLet me work on a quick fix to just fail immediately in a separate revertable commit -- meanwhile any feedback is appreciated", "author": "jrhee17", "createdAt": "2020-07-08T10:15:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM0NzAxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTYxMTg0Ng==", "url": "https://github.com/line/armeria/pull/2752#discussion_r451611846", "bodyText": "Pushed a small commit: f5c687e\nDo let me know if you guys prefer the previous behavior though..", "author": "jrhee17", "createdAt": "2020-07-08T14:58:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM0NzAxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTYzMjY1NQ==", "url": "https://github.com/line/armeria/pull/2752#discussion_r451632655", "bodyText": "Still LGTM", "author": "trustin", "createdAt": "2020-07-08T15:27:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM0NzAxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTkwMzE5Nw==", "url": "https://github.com/line/armeria/pull/2752#discussion_r451903197", "bodyText": "\ud83d\udc4d \ud83d\udc4d", "author": "minwoox", "createdAt": "2020-07-09T00:52:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM0NzAxMw=="}], "type": "inlineReview", "revised_code": {"commit": "f5c687e6187e1920b2d9c136d1dbf166a547e1e4", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/HttpClientDelegate.java b/core/src/main/java/com/linecorp/armeria/client/HttpClientDelegate.java\nindex 660af7ef6..ca58e6a1d 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/HttpClientDelegate.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/HttpClientDelegate.java\n\n@@ -165,20 +176,6 @@ final class HttpClientDelegate implements HttpClient {\n         }\n     }\n \n-    private ProxyConfig selectProxyConfig(SessionProtocol sessionProtocol, String host, int port) {\n-        ProxyConfig proxyConfig;\n-        try {\n-            final Endpoint endpoint = Endpoint.of(host, port);\n-            proxyConfig = factory.proxyConfigSelector().select(sessionProtocol, endpoint);\n-            requireNonNull(proxyConfig, \"proxyConfig\");\n-        } catch (Throwable t) {\n-            logger.warn(\"Failed to select ProxyConfig for {}:{}, falling back to DIRECT\",\n-                        host, port, t);\n-            proxyConfig = ProxyConfig.direct();\n-        }\n-        return proxyConfig;\n-    }\n-\n     private static void logSession(ClientRequestContext ctx, @Nullable PooledChannel pooledChannel,\n                                    @Nullable ClientConnectionTimings connectionTimings) {\n         if (pooledChannel != null) {\n"}}, {"oid": "f5c687e6187e1920b2d9c136d1dbf166a547e1e4", "url": "https://github.com/line/armeria/commit/f5c687e6187e1920b2d9c136d1dbf166a547e1e4", "message": "fail immediately if proxy select throws or is null", "committedDate": "2020-07-08T14:53:17Z", "type": "commit"}, {"oid": "7622d0694a802adb942169fa69fdfda5ec14e85e", "url": "https://github.com/line/armeria/commit/7622d0694a802adb942169fa69fdfda5ec14e85e", "message": "Merge branch 'master' into feature/proxy-system-property", "committedDate": "2020-07-11T05:21:11Z", "type": "commit"}]}