{"pr_number": 2969, "pr_title": "Fix to set content-type correctly for gRPC Trailers-Only", "pr_createdAt": "2020-08-05T03:35:59Z", "pr_url": "https://github.com/line/armeria/pull/2969", "timeline": [{"oid": "b3b810bdf6bff8ac2a75caa26c31bb6b02ae77fc", "url": "https://github.com/line/armeria/commit/b3b810bdf6bff8ac2a75caa26c31bb6b02ae77fc", "message": "Fix to set content-type correctly for gRPC Trailers-Only\nMotivation:\nWe hardcoded the content-type with `application/grpc+proto` when sending gRPC Trailers-Only.\nIt is no harm to set the value because there's no following messages.\nBut I think it's better to set the content-type of the corresponding gRPC request so that a user\ndoesn't get surprised.\n\nModifications:\n- Set the content-type of the corresponding gRPC request to the gRPC Trailers-Only.\n\nResult:\n- gRPC Trailers-Only now has the content-type of the corresponding gRPC request.", "committedDate": "2020-08-05T03:35:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ1NzMzOA==", "url": "https://github.com/line/armeria/pull/2969#discussion_r465457338", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        ServiceRequestContext ctx, HttpHeadersBuilder trailerBuilder, Status status, Metadata metadata) {\n          \n          \n            \n                        ServiceRequestContext ctx, HttpHeadersBuilder trailersBuilder, Status status, Metadata metadata) {", "author": "ikhoon", "createdAt": "2020-08-05T03:57:37Z", "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/ArmeriaServerCall.java", "diffHunk": "@@ -515,22 +517,22 @@ private void setClientStreamClosed() {\n \n     // Returns ResponseHeaders if headersSent == false or HttpHeaders otherwise.\n     static HttpHeaders statusToTrailers(\n-            ServiceRequestContext ctx, Status status, Metadata metadata, boolean headersSent) {\n-        final HttpHeadersBuilder trailers = GrpcTrailersUtil.statusToTrailers(\n-                status.getCode().value(), status.getDescription(), headersSent);\n+            ServiceRequestContext ctx, HttpHeadersBuilder trailerBuilder, Status status, Metadata metadata) {", "originalCommit": "b3b810bdf6bff8ac2a75caa26c31bb6b02ae77fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUxMTg0MQ==", "url": "https://github.com/line/armeria/pull/2969#discussion_r465511841", "bodyText": "Fixed. \ud83d\ude09", "author": "minwoox", "createdAt": "2020-08-05T06:53:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ1NzMzOA=="}], "type": "inlineReview", "revised_code": {"commit": "bd3b0149185a6c033e54a0b29d4ad17c78cd8d31", "chunk": "diff --git a/grpc/src/main/java/com/linecorp/armeria/server/grpc/ArmeriaServerCall.java b/grpc/src/main/java/com/linecorp/armeria/server/grpc/ArmeriaServerCall.java\nindex d4dfdc085..b404503d8 100644\n--- a/grpc/src/main/java/com/linecorp/armeria/server/grpc/ArmeriaServerCall.java\n+++ b/grpc/src/main/java/com/linecorp/armeria/server/grpc/ArmeriaServerCall.java\n\n@@ -517,22 +517,22 @@ final class ArmeriaServerCall<I, O> extends ServerCall<I, O>\n \n     // Returns ResponseHeaders if headersSent == false or HttpHeaders otherwise.\n     static HttpHeaders statusToTrailers(\n-            ServiceRequestContext ctx, HttpHeadersBuilder trailerBuilder, Status status, Metadata metadata) {\n+            ServiceRequestContext ctx, HttpHeadersBuilder trailersBuilder, Status status, Metadata metadata) {\n         GrpcTrailersUtil.addStatusMessageToTrailers(\n-                trailerBuilder, status.getCode().value(), status.getDescription());\n+                trailersBuilder, status.getCode().value(), status.getDescription());\n \n-        MetadataUtil.fillHeaders(metadata, trailerBuilder);\n+        MetadataUtil.fillHeaders(metadata, trailersBuilder);\n \n         if (ctx.config().verboseResponses() && status.getCause() != null) {\n             final ThrowableProto proto = GrpcStatus.serializeThrowable(status.getCause());\n-            trailerBuilder.add(GrpcHeaderNames.ARMERIA_GRPC_THROWABLEPROTO_BIN,\n+            trailersBuilder.add(GrpcHeaderNames.ARMERIA_GRPC_THROWABLEPROTO_BIN,\n                                Base64.getEncoder().encodeToString(proto.toByteArray()));\n         }\n \n         final HttpHeaders additionalTrailers = ctx.additionalResponseTrailers();\n         ctx.mutateAdditionalResponseTrailers(HttpHeadersBuilder::clear);\n-        trailerBuilder.add(additionalTrailers);\n-        return trailerBuilder.build();\n+        trailersBuilder.add(additionalTrailers);\n+        return trailersBuilder.build();\n     }\n \n     HttpStreamReader messageReader() {\n"}}, {"oid": "bd3b0149185a6c033e54a0b29d4ad17c78cd8d31", "url": "https://github.com/line/armeria/commit/bd3b0149185a6c033e54a0b29d4ad17c78cd8d31", "message": "Address the comment by @ikhoon", "committedDate": "2020-08-05T06:32:51Z", "type": "commit"}]}