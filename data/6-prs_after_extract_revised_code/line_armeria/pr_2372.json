{"pr_number": 2372, "pr_title": "Streamline HTTP header/trailer validation and conversion", "pr_createdAt": "2020-01-04T16:53:39Z", "pr_url": "https://github.com/line/armeria/pull/2372", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE3NjM3MQ==", "url": "https://github.com/line/armeria/pull/2372#discussion_r363176371", "bodyText": "These methods can be static?", "author": "trustin", "createdAt": "2020-01-06T06:51:46Z", "path": "benchmarks/src/jmh/java/com/linecorp/armeria/common/HttpRequestHeaderConversionBenchmark.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Copyright 2019 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.common;\n+\n+import org.openjdk.jmh.annotations.Benchmark;\n+import org.openjdk.jmh.annotations.Scope;\n+import org.openjdk.jmh.annotations.Setup;\n+import org.openjdk.jmh.annotations.State;\n+import org.openjdk.jmh.annotations.TearDown;\n+\n+import com.linecorp.armeria.client.ClientRequestContext;\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.server.Server;\n+\n+@State(Scope.Benchmark)\n+public class HttpRequestHeaderConversionBenchmark {\n+\n+    private Server serverWithoutAdditionalHeaders;\n+\n+    private WebClient clientWithAdditionalHeadersHttp1;\n+    private WebClient clientWithAdditionalHeadersHttp2;\n+\n+    @Setup\n+    public void startServer() {\n+        final int port = 8080;\n+\n+        serverWithoutAdditionalHeaders = Server.builder()\n+                                               .http(port)\n+                                               .service(\"/header_conversion\", (ctx, req) -> {\n+                                                   return HttpResponse.of(HttpStatus.OK);\n+                                               })\n+                                               .build();\n+        serverWithoutAdditionalHeaders.start().join();\n+\n+        clientWithAdditionalHeadersHttp1 = WebClient.builder(\"h1c://127.0.0.1:\" + port)\n+                                                    .decorator(((delegate, ctx, req) -> {\n+                                                        addAdditionalHeaders(ctx);\n+                                                        addProhibitedHeaders(ctx);\n+                                                        addCookies(ctx);\n+                                                        return delegate.execute(ctx, req);\n+                                                    })).build();\n+\n+        clientWithAdditionalHeadersHttp2 = WebClient.builder(\"h2c://127.0.0.1:\" + port)\n+                                                    .decorator(((delegate, ctx, req) -> {\n+                                                        addAdditionalHeaders(ctx);\n+                                                        addProhibitedHeaders(ctx);\n+                                                        addCookies(ctx);\n+                                                        return delegate.execute(ctx, req);\n+                                                    })).build();\n+    }\n+\n+    private void addAdditionalHeaders(ClientRequestContext ctx) {\n+        ctx.addAdditionalRequestHeader(\"custom-header-1\", \"my-header-1\");\n+        ctx.addAdditionalRequestHeader(\"custom-header-2\", \"my-header-2\");\n+        ctx.addAdditionalRequestHeader(\"custom-header-3\", \"my-header-3\");\n+        ctx.addAdditionalRequestHeader(\"custom-header-4\", \"my-header-4\");\n+    }\n+\n+    private void addProhibitedHeaders(ClientRequestContext ctx) {\n+        ctx.addAdditionalRequestHeader(HttpHeaderNames.SCHEME, \"https\");\n+        ctx.addAdditionalRequestHeader(HttpHeaderNames.STATUS, \"503\");\n+        ctx.addAdditionalRequestHeader(HttpHeaderNames.METHOD, \"CONNECT\");\n+    }\n+\n+    private void addCookies(ClientRequestContext ctx) {\n+        ctx.addAdditionalRequestHeader(HttpHeaderNames.COOKIE, \"a=b; c=d\");\n+        ctx.addAdditionalRequestHeader(HttpHeaderNames.COOKIE, \"e=f; g=h\");\n+        ctx.addAdditionalRequestHeader(HttpHeaderNames.COOKIE, \"i=j; k=l\");\n+    }", "originalCommit": "c70af23b0433e88930a8360a73f94d646af59309", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5dc7e0ace79fd4942c7ce47ade3cbfccc9e8e919", "chunk": "diff --git a/benchmarks/src/jmh/java/com/linecorp/armeria/common/HttpRequestHeaderConversionBenchmark.java b/benchmarks/src/jmh/java/com/linecorp/armeria/common/HttpRequestHeaderConversionBenchmark.java\nindex eab2f3ae6..b66416874 100644\n--- a/benchmarks/src/jmh/java/com/linecorp/armeria/common/HttpRequestHeaderConversionBenchmark.java\n+++ b/benchmarks/src/jmh/java/com/linecorp/armeria/common/HttpRequestHeaderConversionBenchmark.java\n\n@@ -63,20 +63,20 @@ public class HttpRequestHeaderConversionBenchmark {\n                                                     })).build();\n     }\n \n-    private void addAdditionalHeaders(ClientRequestContext ctx) {\n+    private static void addAdditionalHeaders(ClientRequestContext ctx) {\n         ctx.addAdditionalRequestHeader(\"custom-header-1\", \"my-header-1\");\n         ctx.addAdditionalRequestHeader(\"custom-header-2\", \"my-header-2\");\n         ctx.addAdditionalRequestHeader(\"custom-header-3\", \"my-header-3\");\n         ctx.addAdditionalRequestHeader(\"custom-header-4\", \"my-header-4\");\n     }\n \n-    private void addProhibitedHeaders(ClientRequestContext ctx) {\n+    private static void addProhibitedHeaders(ClientRequestContext ctx) {\n         ctx.addAdditionalRequestHeader(HttpHeaderNames.SCHEME, \"https\");\n         ctx.addAdditionalRequestHeader(HttpHeaderNames.STATUS, \"503\");\n         ctx.addAdditionalRequestHeader(HttpHeaderNames.METHOD, \"CONNECT\");\n     }\n \n-    private void addCookies(ClientRequestContext ctx) {\n+    private static void addCookies(ClientRequestContext ctx) {\n         ctx.addAdditionalRequestHeader(HttpHeaderNames.COOKIE, \"a=b; c=d\");\n         ctx.addAdditionalRequestHeader(HttpHeaderNames.COOKIE, \"e=f; g=h\");\n         ctx.addAdditionalRequestHeader(HttpHeaderNames.COOKIE, \"i=j; k=l\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE3NjQ5NQ==", "url": "https://github.com/line/armeria/pull/2372#discussion_r363176495", "bodyText": "These methods could be static.", "author": "trustin", "createdAt": "2020-01-06T06:52:26Z", "path": "benchmarks/src/jmh/java/com/linecorp/armeria/common/HttpResponseHeaderConversionBenchmark.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*\n+ * Copyright 2019 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.common;\n+\n+import org.openjdk.jmh.annotations.Benchmark;\n+import org.openjdk.jmh.annotations.Scope;\n+import org.openjdk.jmh.annotations.Setup;\n+import org.openjdk.jmh.annotations.State;\n+import org.openjdk.jmh.annotations.TearDown;\n+\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.server.Server;\n+import com.linecorp.armeria.server.ServiceRequestContext;\n+\n+@State(Scope.Benchmark)\n+public class HttpResponseHeaderConversionBenchmark {\n+\n+    private Server serverWithAdditionalHeaders;\n+\n+    private WebClient clientWithoutAdditionalHeadersHttp1;\n+    private WebClient clientWithoutAdditionalHeadersHttp2;\n+\n+    @Setup\n+    public void startServer() {\n+        final int port = 8080;\n+\n+        serverWithAdditionalHeaders = Server.builder()\n+                                            .http(port)\n+                                            .service(\"/header_conversion\", (ctx, req) -> {\n+                           addAdditionalHeaders(ctx);\n+                           addProhibitedHeaders(ctx);\n+                           return HttpResponse.of(HttpStatus.OK);\n+                       })\n+                                            .build();\n+        serverWithAdditionalHeaders.start().join();\n+\n+        clientWithoutAdditionalHeadersHttp1 = WebClient.of(\"h1c://127.0.0.1:\" + port);\n+        clientWithoutAdditionalHeadersHttp2 = WebClient.of(\"h2c://127.0.0.1:\" + port);\n+    }\n+\n+    private void addAdditionalHeaders(ServiceRequestContext ctx) {\n+        ctx.addAdditionalResponseHeader(\"custom-header-1\", \"my-header-1\");\n+        ctx.addAdditionalResponseHeader(\"custom-header-2\", \"my-header-2\");\n+        ctx.addAdditionalResponseHeader(\"custom-header-3\", \"my-header-3\");\n+        ctx.addAdditionalResponseHeader(\"custom-header-4\", \"my-header-4\");\n+\n+        ctx.addAdditionalResponseTrailer(\"custom-trailer-1\", \"my-trailer-1\");\n+        ctx.addAdditionalResponseTrailer(\"custom-trailer-2\", \"my-trailer-2\");\n+        ctx.addAdditionalResponseTrailer(\"custom-trailer-3\", \"my-trailer-3\");\n+        ctx.addAdditionalResponseTrailer(\"custom-trailer-4\", \"my-trailer-4\");\n+    }\n+\n+    private void addProhibitedHeaders(ServiceRequestContext ctx) {\n+        ctx.addAdditionalResponseHeader(HttpHeaderNames.SCHEME, \"https\");\n+        ctx.addAdditionalResponseHeader(HttpHeaderNames.STATUS, \"100\");\n+        ctx.addAdditionalResponseHeader(HttpHeaderNames.METHOD, \"CONNECT\");\n+        ctx.addAdditionalResponseHeader(HttpHeaderNames.PATH, \"/foo\");\n+\n+        ctx.addAdditionalResponseTrailer(HttpHeaderNames.SCHEME, \"https\");\n+        ctx.addAdditionalResponseTrailer(HttpHeaderNames.STATUS, \"100\");\n+        ctx.addAdditionalResponseTrailer(HttpHeaderNames.METHOD, \"CONNECT\");\n+        ctx.addAdditionalResponseTrailer(HttpHeaderNames.PATH, \"/foo\");\n+        ctx.addAdditionalResponseTrailer(HttpHeaderNames.TRANSFER_ENCODING, \"magic\");\n+    }", "originalCommit": "c70af23b0433e88930a8360a73f94d646af59309", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5dc7e0ace79fd4942c7ce47ade3cbfccc9e8e919", "chunk": "diff --git a/benchmarks/src/jmh/java/com/linecorp/armeria/common/HttpResponseHeaderConversionBenchmark.java b/benchmarks/src/jmh/java/com/linecorp/armeria/common/HttpResponseHeaderConversionBenchmark.java\nindex cfb97b05e..7605b6ae9 100644\n--- a/benchmarks/src/jmh/java/com/linecorp/armeria/common/HttpResponseHeaderConversionBenchmark.java\n+++ b/benchmarks/src/jmh/java/com/linecorp/armeria/common/HttpResponseHeaderConversionBenchmark.java\n\n@@ -52,7 +52,7 @@ public class HttpResponseHeaderConversionBenchmark {\n         clientWithoutAdditionalHeadersHttp2 = WebClient.of(\"h2c://127.0.0.1:\" + port);\n     }\n \n-    private void addAdditionalHeaders(ServiceRequestContext ctx) {\n+    private static void addAdditionalHeaders(ServiceRequestContext ctx) {\n         ctx.addAdditionalResponseHeader(\"custom-header-1\", \"my-header-1\");\n         ctx.addAdditionalResponseHeader(\"custom-header-2\", \"my-header-2\");\n         ctx.addAdditionalResponseHeader(\"custom-header-3\", \"my-header-3\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE3ODA3Ng==", "url": "https://github.com/line/armeria/pull/2372#discussion_r363178076", "bodyText": "Could we calculate userAgentHeader and authorityHeader until here (or Http2ObjectEncoder)? By doing so, we could remove userAgentHeader and authorityHeader parameter for many methods.", "author": "trustin", "createdAt": "2020-01-06T07:00:44Z", "path": "core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java", "diffHunk": "@@ -277,26 +309,67 @@ private HttpObject convertClientHeaders(int streamId, HttpHeaders headers, boole\n \n     private void convert(int streamId, HttpHeaders inHeaders,\n                          io.netty.handler.codec.http.HttpHeaders outHeaders, boolean trailer,\n-                         boolean isRequest) throws Http2Exception {\n+                         boolean isRequest, boolean endStream,\n+                         HttpHeaders additionalHeaders, HttpHeaders additionalTrailers,\n+                         boolean enableServerHeader, boolean enableDateHeader,\n+                         @Nullable String authorityHeader, @Nullable String userAgentHeader)\n+            throws Http2Exception {\n \n         ArmeriaHttpUtil.toNettyHttp1(\n-                streamId, inHeaders, outHeaders, HttpVersion.HTTP_1_1, trailer, isRequest);\n+                streamId, inHeaders, additionalHeaders, additionalTrailers, outHeaders,\n+                HttpVersion.HTTP_1_1, trailer, isRequest, endStream);\n \n         outHeaders.remove(ExtensionHeaderNames.STREAM_ID.text());\n+\n         if (server) {\n             outHeaders.remove(ExtensionHeaderNames.SCHEME.text());\n+\n+            if (!trailer) {\n+                if (outHeaders.contains(HttpHeaderNames.CONTENT_LENGTH) &&\n+                    !additionalTrailers.isEmpty()) {\n+                    // We don't apply chunked encoding when the content-length header is set, which would\n+                    // prevent the trailers from being sent so we go ahead and remove content-length to\n+                    // force chunked encoding.\n+                    outHeaders.remove(HttpHeaderNames.CONTENT_LENGTH);\n+                }\n+\n+                if (enableServerHeader && !outHeaders.contains(HttpHeaderNames.SERVER)) {\n+                    outHeaders.add(HttpHeaderNames.SERVER, ArmeriaHttpUtil.SERVER_HEADER);\n+                }\n+\n+                if (enableDateHeader && !outHeaders.contains(HttpHeaderNames.DATE)) {\n+                    outHeaders.add(HttpHeaderNames.DATE, HttpTimestampSupplier.currentTime());\n+                }\n+            }\n         } else {\n             outHeaders.remove(ExtensionHeaderNames.PATH.text());\n+\n+            if (!trailer) {\n+                if (userAgentHeader != null && !outHeaders.contains(HttpHeaderNames.USER_AGENT)) {\n+                    outHeaders.add(HttpHeaderNames.USER_AGENT, userAgentHeader);\n+                }\n+\n+                if (authorityHeader != null && !outHeaders.contains(HttpHeaderNames.HOST)) {\n+                    outHeaders.add(HttpHeaderNames.HOST, authorityHeader);\n+                }", "originalCommit": "c70af23b0433e88930a8360a73f94d646af59309", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAxNTk4NQ==", "url": "https://github.com/line/armeria/pull/2372#discussion_r371015985", "bodyText": "Removed userAgentHeader and authorityHeader", "author": "jyblue", "createdAt": "2020-01-26T17:22:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE3ODA3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "5dc7e0ace79fd4942c7ce47ade3cbfccc9e8e919", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java b/core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java\nindex 7b2ebc379..66dd71a43 100644\n--- a/core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java\n+++ b/core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java\n\n@@ -312,7 +308,7 @@ public final class Http1ObjectEncoder extends HttpObjectEncoder {\n                          boolean isRequest, boolean endStream,\n                          HttpHeaders additionalHeaders, HttpHeaders additionalTrailers,\n                          boolean enableServerHeader, boolean enableDateHeader,\n-                         @Nullable String authorityHeader, @Nullable String userAgentHeader)\n+                         @Nullable SessionProtocol sessionProtocol)\n             throws Http2Exception {\n \n         ArmeriaHttpUtil.toNettyHttp1(\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE3ODM1NQ==", "url": "https://github.com/line/armeria/pull/2372#discussion_r363178355", "bodyText": "This is not correct. It must be either https or http (not h1c, ..)", "author": "trustin", "createdAt": "2020-01-06T07:02:14Z", "path": "core/src/main/java/com/linecorp/armeria/internal/Http2ObjectEncoder.java", "diffHunk": "@@ -70,8 +88,58 @@ protected ChannelFuture doWriteHeaders(int id, int streamId, HttpHeaders headers\n         }\n \n         // Client starts a new stream.\n-        return encoder.writeHeaders(\n-                ctx, streamId, ArmeriaHttpUtil.toNettyHttp2(headers, server), 0, endStream, ctx.newPromise());\n+        return encoder.writeHeaders(ctx, streamId,\n+                                    convert(headers, additionalHeaders, additionalTrailers,\n+                                            false, endStream, isTrailer, enableServerHeader, enableDateHeader,\n+                                            sessionProtocol, authorityHeader, userAgentHeader),\n+                                    0, endStream, ctx.newPromise());\n+    }\n+\n+    private Http2Headers convert(HttpHeaders inputHeaders,\n+                                 HttpHeaders additionalHeaders, HttpHeaders additionalTrailers,\n+                                 boolean server, boolean endStream, boolean isTrailer,\n+                                 boolean enableServerHeader, boolean enableDateHeader,\n+                                 @Nullable SessionProtocol sessionProtocol,\n+                                 @Nullable String authorityHeader,\n+                                 @Nullable String userAgentHeader) {\n+\n+        final Http2Headers outputHeaders = ArmeriaHttpUtil.toNettyHttp2(inputHeaders,\n+                                                                        additionalHeaders, additionalTrailers,\n+                                                                        server, endStream, isTrailer);\n+\n+        if (!isTrailer) {\n+            if (server) {\n+                if (outputHeaders.contains(HttpHeaderNames.CONTENT_LENGTH) &&\n+                    !additionalTrailers.isEmpty()) {\n+                    // We don't apply chunked encoding when the content-length header is set, which would\n+                    // prevent the trailers from being sent so we go ahead and remove content-length to force\n+                    // chunked encoding.\n+                    outputHeaders.remove(HttpHeaderNames.CONTENT_LENGTH);\n+                }\n+\n+                if (enableServerHeader && !outputHeaders.contains(HttpHeaderNames.SERVER)) {\n+                    outputHeaders.add(HttpHeaderNames.SERVER, ArmeriaHttpUtil.SERVER_HEADER);\n+                }\n+\n+                if (enableDateHeader && !outputHeaders.contains(HttpHeaderNames.DATE)) {\n+                    outputHeaders.add(HttpHeaderNames.DATE, HttpTimestampSupplier.currentTime());\n+                }\n+            } else {\n+                if (userAgentHeader != null && !outputHeaders.contains(HttpHeaderNames.USER_AGENT)) {\n+                    outputHeaders.add(HttpHeaderNames.USER_AGENT, userAgentHeader);\n+                }\n+\n+                if (sessionProtocol != null && !outputHeaders.contains(HttpHeaderNames.SCHEME)) {\n+                    outputHeaders.scheme(sessionProtocol.toString());", "originalCommit": "c70af23b0433e88930a8360a73f94d646af59309", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5dc7e0ace79fd4942c7ce47ade3cbfccc9e8e919", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/internal/Http2ObjectEncoder.java b/core/src/main/java/com/linecorp/armeria/internal/Http2ObjectEncoder.java\nindex e291e3f11..4e89a61e8 100644\n--- a/core/src/main/java/com/linecorp/armeria/internal/Http2ObjectEncoder.java\n+++ b/core/src/main/java/com/linecorp/armeria/internal/Http2ObjectEncoder.java\n\n@@ -91,7 +91,7 @@ public final class Http2ObjectEncoder extends HttpObjectEncoder {\n         return encoder.writeHeaders(ctx, streamId,\n                                     convert(headers, additionalHeaders, additionalTrailers,\n                                             false, endStream, isTrailer, enableServerHeader, enableDateHeader,\n-                                            sessionProtocol, authorityHeader, userAgentHeader),\n+                                            sessionProtocol),\n                                     0, endStream, ctx.newPromise());\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE3ODM5Mg==", "url": "https://github.com/line/armeria/pull/2372#discussion_r363178392", "bodyText": "Ditto for userAgentHeader and authorityHeader", "author": "trustin", "createdAt": "2020-01-06T07:02:29Z", "path": "core/src/main/java/com/linecorp/armeria/internal/Http2ObjectEncoder.java", "diffHunk": "@@ -70,8 +88,58 @@ protected ChannelFuture doWriteHeaders(int id, int streamId, HttpHeaders headers\n         }\n \n         // Client starts a new stream.\n-        return encoder.writeHeaders(\n-                ctx, streamId, ArmeriaHttpUtil.toNettyHttp2(headers, server), 0, endStream, ctx.newPromise());\n+        return encoder.writeHeaders(ctx, streamId,\n+                                    convert(headers, additionalHeaders, additionalTrailers,\n+                                            false, endStream, isTrailer, enableServerHeader, enableDateHeader,\n+                                            sessionProtocol, authorityHeader, userAgentHeader),\n+                                    0, endStream, ctx.newPromise());\n+    }\n+\n+    private Http2Headers convert(HttpHeaders inputHeaders,\n+                                 HttpHeaders additionalHeaders, HttpHeaders additionalTrailers,\n+                                 boolean server, boolean endStream, boolean isTrailer,\n+                                 boolean enableServerHeader, boolean enableDateHeader,\n+                                 @Nullable SessionProtocol sessionProtocol,\n+                                 @Nullable String authorityHeader,\n+                                 @Nullable String userAgentHeader) {", "originalCommit": "c70af23b0433e88930a8360a73f94d646af59309", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAxNTk4Nw==", "url": "https://github.com/line/armeria/pull/2372#discussion_r371015987", "bodyText": "Removed userAgentHeader and authorityHeader", "author": "jyblue", "createdAt": "2020-01-26T17:23:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE3ODM5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "5dc7e0ace79fd4942c7ce47ade3cbfccc9e8e919", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/internal/Http2ObjectEncoder.java b/core/src/main/java/com/linecorp/armeria/internal/Http2ObjectEncoder.java\nindex e291e3f11..4e89a61e8 100644\n--- a/core/src/main/java/com/linecorp/armeria/internal/Http2ObjectEncoder.java\n+++ b/core/src/main/java/com/linecorp/armeria/internal/Http2ObjectEncoder.java\n\n@@ -91,7 +91,7 @@ public final class Http2ObjectEncoder extends HttpObjectEncoder {\n         return encoder.writeHeaders(ctx, streamId,\n                                     convert(headers, additionalHeaders, additionalTrailers,\n                                             false, endStream, isTrailer, enableServerHeader, enableDateHeader,\n-                                            sessionProtocol, authorityHeader, userAgentHeader),\n+                                            sessionProtocol),\n                                     0, endStream, ctx.newPromise());\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM4OTYwNg==", "url": "https://github.com/line/armeria/pull/2372#discussion_r368389606", "bodyText": "If made public, should move to the internal package.", "author": "trustin", "createdAt": "2020-01-20T06:47:21Z", "path": "core/src/main/java/com/linecorp/armeria/client/HttpHeaderUtil.java", "diffHunk": "@@ -20,11 +20,14 @@\n \n import io.netty.util.AsciiString;\n \n-final class HttpHeaderUtil {\n+/**\n+ * Provides utility functions for internal use related with HTTP headers.\n+ */\n+public final class HttpHeaderUtil {", "originalCommit": "96e977b73dcb893b93ce885d83d766551dbe5be6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAxNTk5Nw==", "url": "https://github.com/line/armeria/pull/2372#discussion_r371015997", "bodyText": "Moved to internal package.", "author": "jyblue", "createdAt": "2020-01-26T17:23:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM4OTYwNg=="}], "type": "inlineReview", "revised_code": {"commit": "5dc7e0ace79fd4942c7ce47ade3cbfccc9e8e919", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/HttpHeaderUtil.java b/core/src/main/java/com/linecorp/armeria/internal/HttpHeaderUtil.java\nsimilarity index 71%\nrename from core/src/main/java/com/linecorp/armeria/client/HttpHeaderUtil.java\nrename to core/src/main/java/com/linecorp/armeria/internal/HttpHeaderUtil.java\nindex 79a15c185..b231e1af5 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/HttpHeaderUtil.java\n+++ b/core/src/main/java/com/linecorp/armeria/internal/HttpHeaderUtil.java\n\n@@ -14,7 +14,7 @@\n  * under the License.\n  */\n \n-package com.linecorp.armeria.client;\n+package com.linecorp.armeria.internal;\n \n import com.linecorp.armeria.common.util.Version;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM5MDY5Mw==", "url": "https://github.com/line/armeria/pull/2372#discussion_r368390693", "bodyText": "You can also remove the authorityHeader, because it can be derived from firstHeaders, reqCtx.additionalRequestHeaders() and channel.remoteAddress(). Note that HttpObjectEncoder and its subtypes always have a reference to the current channel.", "author": "trustin", "createdAt": "2020-01-20T06:52:19Z", "path": "core/src/main/java/com/linecorp/armeria/client/HttpRequestSubscriber.java", "diffHunk": "@@ -192,11 +191,11 @@ private void writeFirstHeader() {\n         if (request.isEmpty()) {\n             state = State.DONE;\n             write0(firstHeaders, true, true,\n-                   reqCtx.additionalRequestHeaders(), requestSessionProtocol, authorityHeader, userAgentHeader);\n+                   reqCtx.additionalRequestHeaders(), requestSessionProtocol, authorityHeader);", "originalCommit": "96e977b73dcb893b93ce885d83d766551dbe5be6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAxNjAyOQ==", "url": "https://github.com/line/armeria/pull/2372#discussion_r371016029", "bodyText": "Thanks for education \ud83d\ude00", "author": "jyblue", "createdAt": "2020-01-26T17:23:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM5MDY5Mw=="}], "type": "inlineReview", "revised_code": {"commit": "5dc7e0ace79fd4942c7ce47ade3cbfccc9e8e919", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/HttpRequestSubscriber.java b/core/src/main/java/com/linecorp/armeria/client/HttpRequestSubscriber.java\nindex da923dcf9..b021b176d 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/HttpRequestSubscriber.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/HttpRequestSubscriber.java\n\n@@ -191,11 +171,11 @@ final class HttpRequestSubscriber implements Subscriber<HttpObject>, ChannelFutu\n         if (request.isEmpty()) {\n             state = State.DONE;\n             write0(firstHeaders, true, true,\n-                   reqCtx.additionalRequestHeaders(), requestSessionProtocol, authorityHeader);\n+                   reqCtx.additionalRequestHeaders(), requestSessionProtocol);\n         } else {\n             state = State.NEEDS_DATA_OR_TRAILERS;\n             write0(firstHeaders, false, true,\n-                   reqCtx.additionalRequestHeaders(), requestSessionProtocol, authorityHeader);\n+                   reqCtx.additionalRequestHeaders(), requestSessionProtocol);\n         }\n     }\n \n"}}, {"oid": "5dc7e0ace79fd4942c7ce47ade3cbfccc9e8e919", "url": "https://github.com/line/armeria/commit/5dc7e0ace79fd4942c7ce47ade3cbfccc9e8e919", "message": "Fix `SCHEME` header", "committedDate": "2020-01-22T16:51:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTkwNjgxNA==", "url": "https://github.com/line/armeria/pull/2372#discussion_r369906814", "bodyText": ", \"sessionProtocol\" ?", "author": "trustin", "createdAt": "2020-01-23T02:28:01Z", "path": "core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java", "diffHunk": "@@ -133,7 +133,7 @@ protected ChannelFuture doWriteHeaders(int id, int streamId, HttpHeaders headers\n                                                additionalHeaders, additionalTrailers,\n                                                enableServerHeader, enableDateHeader)\n                           : writeClientHeaders(id, streamId, headers, endStream, additionalHeaders,\n-                                               authorityHeader);\n+                                               requireNonNull(sessionProtocol));", "originalCommit": "4f09cb1b4b6d393fd3499241da0da0b2f8cc27cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAxNjA0Mg==", "url": "https://github.com/line/armeria/pull/2372#discussion_r371016042", "bodyText": "Fixed it.", "author": "jyblue", "createdAt": "2020-01-26T17:23:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTkwNjgxNA=="}], "type": "inlineReview", "revised_code": {"commit": "f834bbb05d6381b1dbd94f1a2262a1ab441fb0be", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java b/core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java\nindex 66dd71a43..d88f12807 100644\n--- a/core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java\n+++ b/core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java\n\n@@ -133,7 +133,7 @@ public final class Http1ObjectEncoder extends HttpObjectEncoder {\n                                                additionalHeaders, additionalTrailers,\n                                                enableServerHeader, enableDateHeader)\n                           : writeClientHeaders(id, streamId, headers, endStream, additionalHeaders,\n-                                               requireNonNull(sessionProtocol));\n+                                               sessionProtocol);\n         } catch (Throwable t) {\n             return newFailedFuture(t);\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTkwNzE2MQ==", "url": "https://github.com/line/armeria/pull/2372#discussion_r369907161", "bodyText": "How about splitting this method into four:\n\nconvertClientHeaders() and convertClientTrailers(), which don't require SessionProtocol\nconvertServerHeaders() and convertServerTrailers(), which require non-null SessionProtocol\n\n.. and remove all the ifs?", "author": "trustin", "createdAt": "2020-01-23T02:30:02Z", "path": "core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java", "diffHunk": "@@ -311,7 +308,7 @@ private void convert(int streamId, HttpHeaders inHeaders,\n                          boolean isRequest, boolean endStream,\n                          HttpHeaders additionalHeaders, HttpHeaders additionalTrailers,\n                          boolean enableServerHeader, boolean enableDateHeader,\n-                         @Nullable String authorityHeader)\n+                         @Nullable SessionProtocol sessionProtocol)", "originalCommit": "4f09cb1b4b6d393fd3499241da0da0b2f8cc27cc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a27fa1390d57112ed924c3e1433020753ec9c925", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java b/core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java\nindex 66dd71a43..6f9bf297c 100644\n--- a/core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java\n+++ b/core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java\n\n@@ -303,74 +360,27 @@ public final class Http1ObjectEncoder extends HttpObjectEncoder {\n         return req;\n     }\n \n-    private void convert(int streamId, HttpHeaders inHeaders,\n-                         io.netty.handler.codec.http.HttpHeaders outHeaders, boolean trailer,\n-                         boolean isRequest, boolean endStream,\n-                         HttpHeaders additionalHeaders, HttpHeaders additionalTrailers,\n-                         boolean enableServerHeader, boolean enableDateHeader,\n-                         @Nullable SessionProtocol sessionProtocol)\n-            throws Http2Exception {\n-\n-        ArmeriaHttpUtil.toNettyHttp1(\n-                streamId, inHeaders, additionalHeaders, additionalTrailers, outHeaders,\n-                HttpVersion.HTTP_1_1, trailer, isRequest, endStream);\n-\n-        outHeaders.remove(ExtensionHeaderNames.STREAM_ID.text());\n-\n-        if (server) {\n-            outHeaders.remove(ExtensionHeaderNames.SCHEME.text());\n+    private LastHttpContent convertClientTrailers(\n+            int streamId, HttpHeaders inHeaders, boolean endStream) throws Http2Exception {\n \n-            if (!trailer) {\n-                if (outHeaders.contains(HttpHeaderNames.CONTENT_LENGTH) &&\n-                    !additionalTrailers.isEmpty()) {\n-                    // We don't apply chunked encoding when the content-length header is set, which would\n-                    // prevent the trailers from being sent so we go ahead and remove content-length to\n-                    // force chunked encoding.\n-                    outHeaders.remove(HttpHeaderNames.CONTENT_LENGTH);\n-                }\n+        if (inHeaders.isEmpty()) {\n+            return LastHttpContent.EMPTY_LAST_CONTENT;\n+        }\n \n-                if (enableServerHeader && !outHeaders.contains(HttpHeaderNames.SERVER)) {\n-                    outHeaders.add(HttpHeaderNames.SERVER, ArmeriaHttpUtil.SERVER_HEADER);\n-                }\n+        final LastHttpContent lastContent = new DefaultLastHttpContent(Unpooled.EMPTY_BUFFER, false);\n \n-                if (enableDateHeader && !outHeaders.contains(HttpHeaderNames.DATE)) {\n-                    outHeaders.add(HttpHeaderNames.DATE, HttpTimestampSupplier.currentTime());\n-                }\n-            }\n-        } else {\n-            outHeaders.remove(ExtensionHeaderNames.PATH.text());\n+        ArmeriaHttpUtil.toNettyHttp1(\n+                streamId, inHeaders, HttpHeaders.of(), HttpHeaders.of(), lastContent.trailingHeaders(),\n+                HttpVersion.HTTP_1_1, true, true, endStream);\n \n-            if (!trailer) {\n-                if (!outHeaders.contains(HttpHeaderNames.USER_AGENT)) {\n-                    outHeaders.add(HttpHeaderNames.USER_AGENT, HttpHeaderUtil.USER_AGENT.toString());\n-                }\n+        removeHttpExtensionHeaders(lastContent.trailingHeaders());\n \n-                if (!outHeaders.contains(HttpHeaderNames.HOST)) {\n-                    outHeaders.add(HttpHeaderNames.HOST,\n-                                   ArmeriaHttpUtil.authorityHeader(\n-                                           ((InetSocketAddress) channel().remoteAddress()).getHostName(),\n-                                           ((InetSocketAddress) channel().remoteAddress()).getPort(),\n-                                           sessionProtocol.defaultPort()));\n-                }\n-            }\n-        }\n+        return  lastContent;\n     }\n \n-    private LastHttpContent convertTrailingHeaders(int streamId, HttpHeaders headers,\n-                                                   boolean endStream, HttpHeaders additionalHeaders,\n-                                                   HttpHeaders additionalTrailers,\n-                                                   @Nullable SessionProtocol sessionProtocol,\n-                                                   boolean isRequest) throws Http2Exception {\n-        final LastHttpContent lastContent;\n-        if (headers.isEmpty()) {\n-            lastContent = LastHttpContent.EMPTY_LAST_CONTENT;\n-        } else {\n-            lastContent = new DefaultLastHttpContent(Unpooled.EMPTY_BUFFER, false);\n-            convert(streamId, headers, lastContent.trailingHeaders(), true, isRequest,\n-                    endStream, additionalHeaders, additionalTrailers,\n-                    false, false, sessionProtocol);\n-        }\n-        return lastContent;\n+    private static void removeHttpExtensionHeaders(io.netty.handler.codec.http.HttpHeaders outHeaders) {\n+        outHeaders.remove(ExtensionHeaderNames.STREAM_ID.text());\n+        outHeaders.remove(ExtensionHeaderNames.PATH.text());\n     }\n \n     private static void setTransferEncoding(HttpMessage out) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTkwODYwOA==", "url": "https://github.com/line/armeria/pull/2372#discussion_r369908608", "bodyText": "Ditto - could be split into 4 methods with clear roles.", "author": "trustin", "createdAt": "2020-01-23T02:37:55Z", "path": "core/src/main/java/com/linecorp/armeria/internal/Http2ObjectEncoder.java", "diffHunk": "@@ -90,16 +91,15 @@ protected ChannelFuture doWriteHeaders(int id, int streamId, HttpHeaders headers\n         return encoder.writeHeaders(ctx, streamId,\n                                     convert(headers, additionalHeaders, additionalTrailers,\n                                             false, endStream, isTrailer, enableServerHeader, enableDateHeader,\n-                                            sessionProtocol, authorityHeader),\n+                                            sessionProtocol),\n                                     0, endStream, ctx.newPromise());\n     }\n \n     private Http2Headers convert(HttpHeaders inputHeaders,\n                                  HttpHeaders additionalHeaders, HttpHeaders additionalTrailers,\n                                  boolean server, boolean endStream, boolean isTrailer,\n                                  boolean enableServerHeader, boolean enableDateHeader,\n-                                 @Nullable SessionProtocol sessionProtocol,\n-                                 @Nullable String authorityHeader) {\n+                                 @Nullable SessionProtocol sessionProtocol) {", "originalCommit": "4f09cb1b4b6d393fd3499241da0da0b2f8cc27cc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a27fa1390d57112ed924c3e1433020753ec9c925", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/internal/Http2ObjectEncoder.java b/core/src/main/java/com/linecorp/armeria/internal/Http2ObjectEncoder.java\nindex b877db789..0e35d95d8 100644\n--- a/core/src/main/java/com/linecorp/armeria/internal/Http2ObjectEncoder.java\n+++ b/core/src/main/java/com/linecorp/armeria/internal/Http2ObjectEncoder.java\n\n@@ -87,63 +101,86 @@ public final class Http2ObjectEncoder extends HttpObjectEncoder {\n             return newFailedFuture(ClosedPublisherException.get());\n         }\n \n+        if (!isTrailer) {\n+            convertedHeaders = convertClientHeaders(headers, additionalHeaders, additionalTrailers,\n+                                                    endStream, sessionProtocol);\n+        } else {\n+            convertedHeaders = convertClientTrailers(headers, additionalTrailers, endStream);\n+        }\n+\n         // Client starts a new stream.\n-        return encoder.writeHeaders(ctx, streamId,\n-                                    convert(headers, additionalHeaders, additionalTrailers,\n-                                            false, endStream, isTrailer, enableServerHeader, enableDateHeader,\n-                                            sessionProtocol),\n-                                    0, endStream, ctx.newPromise());\n+        return encoder.writeHeaders(ctx, streamId, convertedHeaders, 0, endStream, ctx.newPromise());\n     }\n \n-    private Http2Headers convert(HttpHeaders inputHeaders,\n-                                 HttpHeaders additionalHeaders, HttpHeaders additionalTrailers,\n-                                 boolean server, boolean endStream, boolean isTrailer,\n-                                 boolean enableServerHeader, boolean enableDateHeader,\n-                                 @Nullable SessionProtocol sessionProtocol) {\n+    private Http2Headers convertServerHeaders(\n+            HttpHeaders inputHeaders, HttpHeaders additionalHeaders, HttpHeaders additionalTrailers,\n+            boolean endStream, boolean enableServerHeader, boolean enableDateHeader) {\n \n         final Http2Headers outputHeaders = ArmeriaHttpUtil.toNettyHttp2(inputHeaders,\n                                                                         additionalHeaders, additionalTrailers,\n-                                                                        server, endStream, isTrailer);\n+                                                                        true, endStream, false);\n+\n+        if (!additionalTrailers.isEmpty() &&\n+            outputHeaders.contains(HttpHeaderNames.CONTENT_LENGTH)) {\n+            // We don't apply chunked encoding when the content-length header is set, which would\n+            // prevent the trailers from being sent so we go ahead and remove content-length to force\n+            // chunked encoding.\n+            outputHeaders.remove(HttpHeaderNames.CONTENT_LENGTH);\n+        }\n \n-        if (!isTrailer) {\n-            if (server) {\n-                if (outputHeaders.contains(HttpHeaderNames.CONTENT_LENGTH) &&\n-                    !additionalTrailers.isEmpty()) {\n-                    // We don't apply chunked encoding when the content-length header is set, which would\n-                    // prevent the trailers from being sent so we go ahead and remove content-length to force\n-                    // chunked encoding.\n-                    outputHeaders.remove(HttpHeaderNames.CONTENT_LENGTH);\n-                }\n+        if (enableServerHeader && !outputHeaders.contains(HttpHeaderNames.SERVER)) {\n+            outputHeaders.add(HttpHeaderNames.SERVER, ArmeriaHttpUtil.SERVER_HEADER);\n+        }\n \n-                if (enableServerHeader && !outputHeaders.contains(HttpHeaderNames.SERVER)) {\n-                    outputHeaders.add(HttpHeaderNames.SERVER, ArmeriaHttpUtil.SERVER_HEADER);\n-                }\n+        if (enableDateHeader && !outputHeaders.contains(HttpHeaderNames.DATE)) {\n+            outputHeaders.add(HttpHeaderNames.DATE, HttpTimestampSupplier.currentTime());\n+        }\n \n-                if (enableDateHeader && !outputHeaders.contains(HttpHeaderNames.DATE)) {\n-                    outputHeaders.add(HttpHeaderNames.DATE, HttpTimestampSupplier.currentTime());\n-                }\n-            } else {\n-                if (!outputHeaders.contains(HttpHeaderNames.USER_AGENT)) {\n-                    outputHeaders.add(HttpHeaderNames.USER_AGENT, HttpHeaderUtil.USER_AGENT.toString());\n-                }\n+        return outputHeaders;\n+    }\n \n-                if (sessionProtocol != null && !outputHeaders.contains(HttpHeaderNames.SCHEME)) {\n-                    outputHeaders.scheme(sessionProtocol.toString());\n-                }\n+    private Http2Headers convertServerTrailers(\n+            HttpHeaders inputHeaders, HttpHeaders additionalTrailers, boolean endStream) {\n+        return ArmeriaHttpUtil.toNettyHttp2(inputHeaders, HttpHeaders.of(), additionalTrailers,\n+                                            true, endStream, true);\n+    }\n \n-                if (sessionProtocol != null && !outputHeaders.contains(HttpHeaderNames.AUTHORITY)) {\n-                    outputHeaders.add(HttpHeaderNames.AUTHORITY,\n-                                      ArmeriaHttpUtil.authorityHeader(\n-                                              ((InetSocketAddress) channel().remoteAddress()).getHostName(),\n-                                              ((InetSocketAddress) channel().remoteAddress()).getPort(),\n-                                              sessionProtocol.defaultPort()));\n-                }\n-            }\n+    private Http2Headers convertClientHeaders(\n+            HttpHeaders inputHeaders, HttpHeaders additionalHeaders, HttpHeaders additionalTrailers,\n+            boolean endStream, SessionProtocol sessionProtocol) {\n+\n+        requireNonNull(sessionProtocol);\n+\n+        final Http2Headers outputHeaders = ArmeriaHttpUtil.toNettyHttp2(inputHeaders,\n+                                                                        additionalHeaders, additionalTrailers,\n+                                                                        false, endStream, false);\n+\n+        if (!outputHeaders.contains(HttpHeaderNames.USER_AGENT)) {\n+            outputHeaders.add(HttpHeaderNames.USER_AGENT, HttpHeaderUtil.USER_AGENT.toString());\n+        }\n+\n+        if (!outputHeaders.contains(HttpHeaderNames.SCHEME)) {\n+            outputHeaders.scheme(sessionProtocol.isTls() ? SessionProtocol.HTTPS.uriText()\n+                                                         : SessionProtocol.HTTP.uriText());\n+        }\n+\n+        if (!outputHeaders.contains(HttpHeaderNames.AUTHORITY)) {\n+            final InetSocketAddress remoteAddress = (InetSocketAddress) channel().remoteAddress();\n+            outputHeaders.add(HttpHeaderNames.AUTHORITY,\n+                              ArmeriaHttpUtil.authorityHeader(\n+                                      remoteAddress.getHostName(), remoteAddress.getPort(),\n+                                      sessionProtocol.defaultPort()));\n         }\n \n         return outputHeaders;\n     }\n \n+    private Http2Headers convertClientTrailers(\n+            HttpHeaders inputHeaders, HttpHeaders additionalTrailers, boolean endStream) {\n+        return ArmeriaHttpUtil.toNettyHttp2(inputHeaders, HttpHeaders.of(), additionalTrailers,\n+                                            false, endStream, true);\n+    }\n+\n     @Override\n     protected ChannelFuture doWriteData(int id, int streamId, HttpData data, boolean endStream) {\n         if (isStreamPresentAndWritable(streamId)) {\n"}}, {"oid": "f834bbb05d6381b1dbd94f1a2262a1ab441fb0be", "url": "https://github.com/line/armeria/commit/f834bbb05d6381b1dbd94f1a2262a1ab441fb0be", "message": "Remove requireNonNull for `sessionProtocol` parameter", "committedDate": "2020-01-26T10:11:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE5ODc4Mw==", "url": "https://github.com/line/armeria/pull/2372#discussion_r372198783", "bodyText": "convertClientHeaders0() could be inlined here because it's used only once.", "author": "trustin", "createdAt": "2020-01-29T05:44:38Z", "path": "core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java", "diffHunk": "@@ -216,31 +239,78 @@ private HttpObject convertServerHeaders(\n         } else {\n             res = new DefaultHttpResponse(HttpVersion.HTTP_1_1, nettyStatus, false);\n             // Perform conversion.\n-            convert(streamId, headers, res.headers(), false, false);\n+            convertServerHeaders0(streamId, headers, res.headers(), endStream,\n+                                  additionalHeaders, additionalTrailers,\n+                                  enableServerHeader, enableDateHeader);\n             setTransferEncoding(res);\n         }\n \n         return res;\n     }\n \n-    private HttpObject convertClientHeaders(int streamId, HttpHeaders headers, boolean endStream)\n-            throws Http2Exception {\n+    private void convertServerHeaders0(\n+            int streamId, HttpHeaders inHeaders,\n+            io.netty.handler.codec.http.HttpHeaders outHeaders, boolean endStream,\n+            HttpHeaders additionalHeaders, HttpHeaders additionalTrailers,\n+            boolean enableServerHeader, boolean enableDateHeader) throws Http2Exception {\n \n-        // Leading headers will always have :method, trailers will never have it.\n-        final String method = headers.get(HttpHeaderNames.METHOD);\n-        if (method == null) {\n-            return convertTrailingHeaders(streamId, headers);\n+        ArmeriaHttpUtil.toNettyHttp1(\n+                streamId, inHeaders, additionalHeaders, additionalTrailers, outHeaders,\n+                HttpVersion.HTTP_1_1, false, false, endStream);\n+\n+        removeHttpExtensionHeaders(outHeaders);\n+\n+        if (outHeaders.contains(HttpHeaderNames.CONTENT_LENGTH) &&\n+            !additionalTrailers.isEmpty()) {\n+            // We don't apply chunked encoding when the content-length header is set, which would\n+            // prevent the trailers from being sent so we go ahead and remove content-length to\n+            // force chunked encoding.\n+            outHeaders.remove(HttpHeaderNames.CONTENT_LENGTH);\n+        }\n+\n+        if (enableServerHeader && !outHeaders.contains(HttpHeaderNames.SERVER)) {\n+            outHeaders.add(HttpHeaderNames.SERVER, ArmeriaHttpUtil.SERVER_HEADER);\n+        }\n+\n+        if (enableDateHeader && !outHeaders.contains(HttpHeaderNames.DATE)) {\n+            outHeaders.add(HttpHeaderNames.DATE, HttpTimestampSupplier.currentTime());\n+        }\n+    }\n+\n+    private LastHttpContent convertServerTrailers(\n+            int streamId, HttpHeaders inHeaders, boolean endStream,\n+            HttpHeaders additionalTrailers) throws Http2Exception {\n+\n+        final LastHttpContent lastContent = getLastHttpContent(inHeaders);\n+\n+        if (inHeaders.isEmpty()) {\n+            return lastContent;\n         }\n \n-        // Convert leading headers.\n+        ArmeriaHttpUtil.toNettyHttp1(\n+                streamId, inHeaders, HttpHeaders.of(), additionalTrailers, lastContent.trailingHeaders(),\n+                HttpVersion.HTTP_1_1, true, false, endStream);\n+\n+        removeHttpExtensionHeaders(lastContent.trailingHeaders());\n+\n+        return lastContent;\n+    }\n+\n+    private HttpObject convertClientHeaders(int streamId, HttpHeaders headers, boolean endStream,\n+                                            HttpHeaders additionalHeaders,\n+                                            SessionProtocol sessionProtocol) throws Http2Exception {\n+        requireNonNull(sessionProtocol);\n+\n+        final String method = headers.get(HttpHeaderNames.METHOD);\n         final String path = headers.get(HttpHeaderNames.PATH);\n         assert path != null;\n         final HttpRequest req = new DefaultHttpRequest(\n                 HttpVersion.HTTP_1_1,\n                 HttpMethod.valueOf(method),\n                 path, false);\n \n-        convert(streamId, headers, req.headers(), false, true);\n+        convertClientHeaders0(streamId, headers, req.headers(), endStream, additionalHeaders,\n+                              sessionProtocol);", "originalCommit": "73262810023e267bc4ae2e8d809c1a4b701ee252", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY1MDI1OQ==", "url": "https://github.com/line/armeria/pull/2372#discussion_r372650259", "bodyText": "Inlined convertClientHeaders0().", "author": "jyblue", "createdAt": "2020-01-29T21:50:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE5ODc4Mw=="}], "type": "inlineReview", "revised_code": {"commit": "a27fa1390d57112ed924c3e1433020753ec9c925", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java b/core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java\nindex 2ee986fb5..6f9bf297c 100644\n--- a/core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java\n+++ b/core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java\n\n@@ -248,7 +248,7 @@ public final class Http1ObjectEncoder extends HttpObjectEncoder {\n         return res;\n     }\n \n-    private void convertServerHeaders0(\n+    private static void convertServerHeaders0(\n             int streamId, HttpHeaders inHeaders,\n             io.netty.handler.codec.http.HttpHeaders outHeaders, boolean endStream,\n             HttpHeaders additionalHeaders, HttpHeaders additionalTrailers,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE5OTc1Mw==", "url": "https://github.com/line/armeria/pull/2372#discussion_r372199753", "bodyText": "What do you think about inlining this method? i.e.\nif (inHeaders.inEmpty()) {\n    return LastHttpContent.EMPTY_LAST_CONTENT;\n}\n\nfinal LastHttpContent lastContent = new DefaultLastHttpContent(...);\n.. which is more readable in my opinion.", "author": "trustin", "createdAt": "2020-01-29T05:49:12Z", "path": "core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java", "diffHunk": "@@ -275,30 +345,59 @@ private HttpObject convertClientHeaders(int streamId, HttpHeaders headers, boole\n         return req;\n     }\n \n-    private void convert(int streamId, HttpHeaders inHeaders,\n-                         io.netty.handler.codec.http.HttpHeaders outHeaders, boolean trailer,\n-                         boolean isRequest) throws Http2Exception {\n+    private void convertClientHeaders0(\n+            int streamId, HttpHeaders inHeaders,\n+            io.netty.handler.codec.http.HttpHeaders outHeaders, boolean endStream,\n+            HttpHeaders additionalHeaders, SessionProtocol sessionProtocol) throws Http2Exception {\n \n         ArmeriaHttpUtil.toNettyHttp1(\n-                streamId, inHeaders, outHeaders, HttpVersion.HTTP_1_1, trailer, isRequest);\n+                streamId, inHeaders, additionalHeaders, HttpHeaders.of(), outHeaders,\n+                HttpVersion.HTTP_1_1, false, true, endStream);\n \n-        outHeaders.remove(ExtensionHeaderNames.STREAM_ID.text());\n-        if (server) {\n-            outHeaders.remove(ExtensionHeaderNames.SCHEME.text());\n-        } else {\n-            outHeaders.remove(ExtensionHeaderNames.PATH.text());\n+        removeHttpExtensionHeaders(outHeaders);\n+\n+        if (!outHeaders.contains(HttpHeaderNames.USER_AGENT)) {\n+            outHeaders.add(HttpHeaderNames.USER_AGENT, HttpHeaderUtil.USER_AGENT.toString());\n+        }\n+\n+        if (!outHeaders.contains(HttpHeaderNames.HOST)) {\n+            outHeaders.add(HttpHeaderNames.HOST,\n+                           ArmeriaHttpUtil.authorityHeader(\n+                                   ((InetSocketAddress) channel().remoteAddress()).getHostName(),\n+                                   ((InetSocketAddress) channel().remoteAddress()).getPort(),\n+                                   sessionProtocol.defaultPort()));\n         }\n     }\n \n-    private LastHttpContent convertTrailingHeaders(int streamId, HttpHeaders headers) throws Http2Exception {\n-        final LastHttpContent lastContent;\n+    private LastHttpContent convertClientTrailers(\n+            int streamId, HttpHeaders inHeaders, boolean endStream) throws Http2Exception {\n+\n+        final LastHttpContent lastContent = getLastHttpContent(inHeaders);\n+\n+        if (inHeaders.isEmpty()) {\n+            return lastContent;\n+        }\n+\n+        ArmeriaHttpUtil.toNettyHttp1(\n+                streamId, inHeaders, HttpHeaders.of(), HttpHeaders.of(), lastContent.trailingHeaders(),\n+                HttpVersion.HTTP_1_1, true, true, endStream);\n+\n+        removeHttpExtensionHeaders(lastContent.trailingHeaders());\n+\n+        return  lastContent;\n+    }\n+\n+    private LastHttpContent getLastHttpContent(HttpHeaders headers) {", "originalCommit": "73262810023e267bc4ae2e8d809c1a4b701ee252", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIxMDQ4OA==", "url": "https://github.com/line/armeria/pull/2372#discussion_r373210488", "bodyText": "Inlined method.\nI was thinking, removing code duplication by this method made poor readability and added more unnecessary codes. But I was not sure. Thanks for education.", "author": "jyblue", "createdAt": "2020-01-30T21:46:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE5OTc1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "a27fa1390d57112ed924c3e1433020753ec9c925", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java b/core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java\nindex 2ee986fb5..6f9bf297c 100644\n--- a/core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java\n+++ b/core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java\n\n@@ -345,39 +360,15 @@ public final class Http1ObjectEncoder extends HttpObjectEncoder {\n         return req;\n     }\n \n-    private void convertClientHeaders0(\n-            int streamId, HttpHeaders inHeaders,\n-            io.netty.handler.codec.http.HttpHeaders outHeaders, boolean endStream,\n-            HttpHeaders additionalHeaders, SessionProtocol sessionProtocol) throws Http2Exception {\n-\n-        ArmeriaHttpUtil.toNettyHttp1(\n-                streamId, inHeaders, additionalHeaders, HttpHeaders.of(), outHeaders,\n-                HttpVersion.HTTP_1_1, false, true, endStream);\n-\n-        removeHttpExtensionHeaders(outHeaders);\n-\n-        if (!outHeaders.contains(HttpHeaderNames.USER_AGENT)) {\n-            outHeaders.add(HttpHeaderNames.USER_AGENT, HttpHeaderUtil.USER_AGENT.toString());\n-        }\n-\n-        if (!outHeaders.contains(HttpHeaderNames.HOST)) {\n-            outHeaders.add(HttpHeaderNames.HOST,\n-                           ArmeriaHttpUtil.authorityHeader(\n-                                   ((InetSocketAddress) channel().remoteAddress()).getHostName(),\n-                                   ((InetSocketAddress) channel().remoteAddress()).getPort(),\n-                                   sessionProtocol.defaultPort()));\n-        }\n-    }\n-\n     private LastHttpContent convertClientTrailers(\n             int streamId, HttpHeaders inHeaders, boolean endStream) throws Http2Exception {\n \n-        final LastHttpContent lastContent = getLastHttpContent(inHeaders);\n-\n         if (inHeaders.isEmpty()) {\n-            return lastContent;\n+            return LastHttpContent.EMPTY_LAST_CONTENT;\n         }\n \n+        final LastHttpContent lastContent = new DefaultLastHttpContent(Unpooled.EMPTY_BUFFER, false);\n+\n         ArmeriaHttpUtil.toNettyHttp1(\n                 streamId, inHeaders, HttpHeaders.of(), HttpHeaders.of(), lastContent.trailingHeaders(),\n                 HttpVersion.HTTP_1_1, true, true, endStream);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIwMjI1NA==", "url": "https://github.com/line/armeria/pull/2372#discussion_r372202254", "bodyText": "This method could be replaced with ArmeriaHttpUtil.authorityHeader()?", "author": "trustin", "createdAt": "2020-01-29T06:01:36Z", "path": "core/src/main/java/com/linecorp/armeria/internal/HttpHeaderUtil.java", "diffHunk": "@@ -14,19 +14,22 @@\n  * under the License.\n  */\n \n-package com.linecorp.armeria.client;\n+package com.linecorp.armeria.internal;\n \n import com.linecorp.armeria.common.util.Version;\n \n import io.netty.util.AsciiString;\n \n-final class HttpHeaderUtil {\n+/**\n+ * Provides utility functions for internal use related with HTTP headers.\n+ */\n+public final class HttpHeaderUtil {\n \n     private static final String CLIENT_ARTIFACT_ID = \"armeria\";\n \n-    static final AsciiString USER_AGENT = AsciiString.cached(createUserAgentName());\n+    public static final AsciiString USER_AGENT = AsciiString.cached(createUserAgentName());\n \n-    static String hostHeader(String host, int port, int defaultPort) {\n+    public static String hostHeader(String host, int port, int defaultPort) {\n         if (port == defaultPort) {\n             return host;\n         }", "originalCommit": "73262810023e267bc4ae2e8d809c1a4b701ee252", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY1MTIzNw==", "url": "https://github.com/line/armeria/pull/2372#discussion_r372651237", "bodyText": "Replaced with ArmeriaHttpUtil.authorityHeader().", "author": "jyblue", "createdAt": "2020-01-29T21:52:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIwMjI1NA=="}], "type": "inlineReview", "revised_code": {"commit": "a27fa1390d57112ed924c3e1433020753ec9c925", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/internal/HttpHeaderUtil.java b/core/src/main/java/com/linecorp/armeria/internal/HttpHeaderUtil.java\nindex b231e1af5..2671e0ff3 100644\n--- a/core/src/main/java/com/linecorp/armeria/internal/HttpHeaderUtil.java\n+++ b/core/src/main/java/com/linecorp/armeria/internal/HttpHeaderUtil.java\n\n@@ -29,14 +29,6 @@ public final class HttpHeaderUtil {\n \n     public static final AsciiString USER_AGENT = AsciiString.cached(createUserAgentName());\n \n-    public static String hostHeader(String host, int port, int defaultPort) {\n-        if (port == defaultPort) {\n-            return host;\n-        }\n-\n-        return host + ':' + port;\n-    }\n-\n     private static String createUserAgentName() {\n         final Version version = Version.get(CLIENT_ARTIFACT_ID, HttpHeaderUtil.class.getClassLoader());\n         return CLIENT_ARTIFACT_ID + '/' + version.artifactVersion();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIxMTg4Mg==", "url": "https://github.com/line/armeria/pull/2372#discussion_r372211882", "bodyText": "inputHeaders.iterator() can return multiple entries with same name, so outputHeaders.remove(name); and inputHeaders.forEachValue() are highly inefficient. How about this:\nSet<AsciiString> removed = ...;\nfor (Entry<AsciiString, String> entry : inputHeaders) {\n    ... continue ...\n\n    if (removed.add(name)) {\n        outputHeaders.remove(name);\n    }\n    outputHeaders.add(name, value);\n}\nI have some more ideas for improving this, but I think it's not part of this PR.", "author": "trustin", "createdAt": "2020-01-29T06:44:14Z", "path": "core/src/main/java/com/linecorp/armeria/internal/ArmeriaHttpUtil.java", "diffHunk": "@@ -801,62 +813,127 @@ private static void addHttp2Scheme(io.netty.handler.codec.http.HttpHeaders in, U\n \n     /**\n      * Converts the specified Armeria HTTP/2 headers into Netty HTTP/2 headers.\n+     *\n+     * @param inputHeaders The HTTP/2 headers to convert.\n+     * @param additionalHeaders The additional headers which will be merged.\n+     * @param additionalTrailers The additional trailers which will be merged.\n+     * @param server    {@code true} if the returned headers will be used in a response message.\n+     *                  {@code false} for request message.\n+     * @param endStream {@code true} if returned headers will end streams.\n+     *                  {@code false} otherwise.\n+     * @param isTrailer {@code true} if returned headers should be treated as trailers.\n+     *                  {@code false} otherwise.\n      */\n-    public static Http2Headers toNettyHttp2(HttpHeaders in, boolean server) {\n-        final Http2Headers out = new DefaultHttp2Headers(false, in.size());\n+    public static Http2Headers toNettyHttp2(HttpHeaders inputHeaders,\n+                                            HttpHeaders additionalHeaders, HttpHeaders additionalTrailers,\n+                                            boolean server, boolean endStream, boolean isTrailer) {\n+        final int headerSizeHint = inputHeaders.size() + additionalHeaders.size() + additionalTrailers.size();\n+        final Http2Headers outputHeaders = new DefaultHttp2Headers(false, headerSizeHint);\n \n-        // Trailers if it does not have :status.\n-        if (server && !in.contains(HttpHeaderNames.STATUS)) {\n-            for (Entry<AsciiString, String> entry : in) {\n-                final AsciiString name = entry.getKey();\n-                final String value = entry.getValue();\n-                if (name.isEmpty() || isTrailerBlacklisted(name)) {\n-                    continue;\n-                }\n-                out.add(name, value);\n-            }\n-        } else {\n-            in.forEach((BiConsumer<AsciiString, String>) out::add);\n-            out.remove(HttpHeaderNames.CONNECTION);\n-            out.remove(HttpHeaderNames.TRANSFER_ENCODING);\n+        mergeHeadersHttp2(inputHeaders, outputHeaders, !server, isTrailer, false);\n+\n+        if (!isTrailer) {\n+            mergeHeadersHttp2(additionalHeaders, outputHeaders, !server, false, true);\n         }\n \n-        if (!out.contains(HttpHeaderNames.COOKIE)) {\n-            return out;\n+        if (server && endStream) {\n+            mergeHeadersHttp2(additionalTrailers, outputHeaders, false, isTrailer, true);\n+        }\n+\n+        outputHeaders.remove(HttpHeaderNames.CONNECTION);\n+        outputHeaders.remove(HttpHeaderNames.TRANSFER_ENCODING);\n+\n+        if (!outputHeaders.contains(HttpHeaderNames.COOKIE)) {\n+            return outputHeaders;\n         }\n \n         // Split up cookies to allow for better compression.\n         // https://tools.ietf.org/html/rfc7540#section-8.1.2.5\n-        final List<CharSequence> cookies = out.getAllAndRemove(HttpHeaderNames.COOKIE);\n+        final List<CharSequence> cookies = outputHeaders.getAllAndRemove(HttpHeaderNames.COOKIE);\n         for (CharSequence c : cookies) {\n-            out.add(HttpHeaderNames.COOKIE, COOKIE_SPLITTER.split(c));\n+            outputHeaders.add(HttpHeaderNames.COOKIE, COOKIE_SPLITTER.split(c));\n         }\n \n-        return out;\n+        return outputHeaders;\n+    }\n+\n+    private static void mergeHeadersHttp2(HttpHeaders inputHeaders, Http2Headers outputHeaders,\n+                                          boolean isRequest, boolean isTrailer, boolean isAdditionalHeaders) {\n+        final Set<AsciiString> additionalHeaderBlackList = isRequest ? ADDITIONAL_REQUEST_HEADER_BLACKLIST\n+                                                                     : ADDITIONAL_RESPONSE_HEADER_BLACKLIST;\n+\n+        for (Entry<AsciiString, String> entry : inputHeaders) {\n+            final AsciiString name = entry.getKey();\n+\n+            if (name.isEmpty()) {\n+                continue;\n+            }\n+\n+            if (isAdditionalHeaders && additionalHeaderBlackList.contains(name)) {\n+                continue;\n+            }\n+\n+            if (isTrailer && isTrailerBlacklisted(name)) {\n+                continue;\n+            }\n+\n+            outputHeaders.remove(name);\n+            inputHeaders.forEachValue(name, newValue -> outputHeaders.add(name, newValue));\n+        }", "originalCommit": "73262810023e267bc4ae2e8d809c1a4b701ee252", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIxMDkyOA==", "url": "https://github.com/line/armeria/pull/2372#discussion_r373210928", "bodyText": "Thanks, I fixed it.", "author": "jyblue", "createdAt": "2020-01-30T21:47:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIxMTg4Mg=="}], "type": "inlineReview", "revised_code": {"commit": "3f101f4bff4fe737a307a54418e445c14a57b69d", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/internal/ArmeriaHttpUtil.java b/core/src/main/java/com/linecorp/armeria/internal/ArmeriaHttpUtil.java\nindex 9ed11e22b..e5f212d41 100644\n--- a/core/src/main/java/com/linecorp/armeria/internal/ArmeriaHttpUtil.java\n+++ b/core/src/main/java/com/linecorp/armeria/internal/ArmeriaHttpUtil.java\n\n@@ -861,14 +862,10 @@ public final class ArmeriaHttpUtil {\n                                           boolean isRequest, boolean isTrailer, boolean isAdditionalHeaders) {\n         final Set<AsciiString> additionalHeaderBlackList = isRequest ? ADDITIONAL_REQUEST_HEADER_BLACKLIST\n                                                                      : ADDITIONAL_RESPONSE_HEADER_BLACKLIST;\n-\n+        final Set<AsciiString> removed = new HashSet<>();\n         for (Entry<AsciiString, String> entry : inputHeaders) {\n             final AsciiString name = entry.getKey();\n-\n-            if (name.isEmpty()) {\n-                continue;\n-            }\n-\n+            final String value = entry.getValue();\n             if (isAdditionalHeaders && additionalHeaderBlackList.contains(name)) {\n                 continue;\n             }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIxMTk4MA==", "url": "https://github.com/line/armeria/pull/2372#discussion_r372211980", "bodyText": "Ditto", "author": "trustin", "createdAt": "2020-01-29T06:44:42Z", "path": "core/src/main/java/com/linecorp/armeria/internal/ArmeriaHttpUtil.java", "diffHunk": "@@ -871,19 +948,24 @@ public static void toNettyHttp1(\n                     continue;\n                 }\n \n+                if (isAdditionalHeader && additionalHeaderBlackList.contains(name)) {\n+                    continue;\n+                }\n+\n                 if (isTrailer && isTrailerBlacklisted(name)) {\n                     continue;\n                 }\n \n-                if (HttpHeaderNames.COOKIE.equals(name)) {\n+                if (isRequest && HttpHeaderNames.COOKIE.equals(name)) {\n                     // combine the cookie values into 1 header entry.\n                     // https://tools.ietf.org/html/rfc7540#section-8.1.2.5\n                     if (cookieJoiner == null) {\n                         cookieJoiner = new StringJoiner(COOKIE_SEPARATOR);\n                     }\n                     COOKIE_SPLITTER.split(value).forEach(cookieJoiner::add);\n                 } else {\n-                    outputHeaders.add(name, value);\n+                    outputHeaders.remove(name);\n+                    inputHeaders.forEachValue(name, newValue -> outputHeaders.add(name, newValue));", "originalCommit": "73262810023e267bc4ae2e8d809c1a4b701ee252", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIxMDcwMw==", "url": "https://github.com/line/armeria/pull/2372#discussion_r373210703", "bodyText": "Thanks, I fixed it.", "author": "jyblue", "createdAt": "2020-01-30T21:46:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIxMTk4MA=="}], "type": "inlineReview", "revised_code": {"commit": "3f101f4bff4fe737a307a54418e445c14a57b69d", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/internal/ArmeriaHttpUtil.java b/core/src/main/java/com/linecorp/armeria/internal/ArmeriaHttpUtil.java\nindex 9ed11e22b..e5f212d41 100644\n--- a/core/src/main/java/com/linecorp/armeria/internal/ArmeriaHttpUtil.java\n+++ b/core/src/main/java/com/linecorp/armeria/internal/ArmeriaHttpUtil.java\n\n@@ -944,7 +944,7 @@ public final class ArmeriaHttpUtil {\n                     continue;\n                 }\n \n-                if (name.isEmpty() || HTTP2_TO_HTTP_HEADER_BLACKLIST.contains(name)) {\n+                if (HTTP2_TO_HTTP_HEADER_BLACKLIST.contains(name)) {\n                     continue;\n                 }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIxMDUyMg==", "url": "https://github.com/line/armeria/pull/2372#discussion_r372210522", "bodyText": "Version.indentity has been removed by #2398. Could you merge the master branch?", "author": "ikhoon", "createdAt": "2020-01-29T06:38:18Z", "path": "core/src/main/java/com/linecorp/armeria/internal/ArmeriaHttpUtil.java", "diffHunk": "@@ -212,6 +214,16 @@ public boolean equals(AsciiString a, AsciiString b) {\n         HTTP_TRAILER_BLACKLIST.add(HttpHeaderNames.TRAILER, EMPTY_STRING);\n     }\n \n+    private static final Set<AsciiString> ADDITIONAL_REQUEST_HEADER_BLACKLIST = ImmutableSet.of(\n+            HttpHeaderNames.SCHEME, HttpHeaderNames.STATUS, HttpHeaderNames.METHOD);\n+\n+    private static final Set<AsciiString> ADDITIONAL_RESPONSE_HEADER_BLACKLIST = ImmutableSet.of(\n+            HttpHeaderNames.SCHEME, HttpHeaderNames.STATUS, HttpHeaderNames.METHOD, HttpHeaderNames.PATH);\n+\n+    public static final String SERVER_HEADER =\n+            \"Armeria/\" + Version.identify(ArmeriaHttpUtil.class.getClassLoader()).get(\"armeria\")", "originalCommit": "73262810023e267bc4ae2e8d809c1a4b701ee252", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0OTY2OQ==", "url": "https://github.com/line/armeria/pull/2372#discussion_r372649669", "bodyText": "Merged \ud83d\ude00", "author": "jyblue", "createdAt": "2020-01-29T21:49:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIxMDUyMg=="}], "type": "inlineReview", "revised_code": {"commit": "7b7e2cc10b2a1a7e5270fad10b469067f3cdd39a", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/internal/ArmeriaHttpUtil.java b/core/src/main/java/com/linecorp/armeria/internal/common/ArmeriaHttpUtil.java\nsimilarity index 80%\nrename from core/src/main/java/com/linecorp/armeria/internal/ArmeriaHttpUtil.java\nrename to core/src/main/java/com/linecorp/armeria/internal/common/ArmeriaHttpUtil.java\nindex 9ed11e22b..33d7797ef 100644\n--- a/core/src/main/java/com/linecorp/armeria/internal/ArmeriaHttpUtil.java\n+++ b/core/src/main/java/com/linecorp/armeria/internal/common/ArmeriaHttpUtil.java\n\n@@ -221,7 +225,7 @@ public final class ArmeriaHttpUtil {\n             HttpHeaderNames.SCHEME, HttpHeaderNames.STATUS, HttpHeaderNames.METHOD, HttpHeaderNames.PATH);\n \n     public static final String SERVER_HEADER =\n-            \"Armeria/\" + Version.identify(ArmeriaHttpUtil.class.getClassLoader()).get(\"armeria\")\n+            \"Armeria/\" + Version.getAll(ArmeriaHttpUtil.class.getClassLoader()).get(\"armeria\")\n                                 .artifactVersion();\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIxNzU4NQ==", "url": "https://github.com/line/armeria/pull/2372#discussion_r372217585", "bodyText": "Could be static?", "author": "ikhoon", "createdAt": "2020-01-29T07:07:51Z", "path": "core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java", "diffHunk": "@@ -180,15 +205,11 @@ private ChannelFuture writeNonInformationalHeaders(int id, HttpObject converted,\n     }\n \n     private HttpObject convertServerHeaders(", "originalCommit": "73262810023e267bc4ae2e8d809c1a4b701ee252", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0ODA0Nw==", "url": "https://github.com/line/armeria/pull/2372#discussion_r372648047", "bodyText": "Fixed it.", "author": "jyblue", "createdAt": "2020-01-29T21:46:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIxNzU4NQ=="}], "type": "inlineReview", "revised_code": {"commit": "a27fa1390d57112ed924c3e1433020753ec9c925", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java b/core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java\nindex 2ee986fb5..6f9bf297c 100644\n--- a/core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java\n+++ b/core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java\n\n@@ -204,7 +204,7 @@ public final class Http1ObjectEncoder extends HttpObjectEncoder {\n         return f;\n     }\n \n-    private HttpObject convertServerHeaders(\n+    private static HttpObject convertServerHeaders(\n             int streamId, HttpHeaders headers, boolean endStream,\n             HttpHeaders additionalHeaders, HttpHeaders additionalTrailers,\n             boolean enableServerHeader, boolean enableDateHeader) throws Http2Exception {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIyMTk0MA==", "url": "https://github.com/line/armeria/pull/2372#discussion_r372221940", "bodyText": "nit: \"https\" -> SessionProtocol.HTTPS.uriText(), \"http\" -> SessionProtocol.HTTP.uriText()", "author": "ikhoon", "createdAt": "2020-01-29T07:18:35Z", "path": "core/src/main/java/com/linecorp/armeria/internal/Http2ObjectEncoder.java", "diffHunk": "@@ -69,9 +101,83 @@ protected ChannelFuture doWriteHeaders(int id, int streamId, HttpHeaders headers\n             return newFailedFuture(ClosedPublisherException.get());\n         }\n \n+        if (!isTrailer) {\n+            convertedHeaders = convertClientHeaders(headers, additionalHeaders, additionalTrailers,\n+                                                    endStream, sessionProtocol);\n+        } else {\n+            convertedHeaders = convertClientTrailers(headers, additionalTrailers, endStream);\n+        }\n+\n         // Client starts a new stream.\n-        return encoder.writeHeaders(\n-                ctx, streamId, ArmeriaHttpUtil.toNettyHttp2(headers, server), 0, endStream, ctx.newPromise());\n+        return encoder.writeHeaders(ctx, streamId, convertedHeaders, 0, endStream, ctx.newPromise());\n+    }\n+\n+    private Http2Headers convertServerHeaders(\n+            HttpHeaders inputHeaders, HttpHeaders additionalHeaders, HttpHeaders additionalTrailers,\n+            boolean endStream, boolean enableServerHeader, boolean enableDateHeader) {\n+\n+        final Http2Headers outputHeaders = ArmeriaHttpUtil.toNettyHttp2(inputHeaders,\n+                                                                        additionalHeaders, additionalTrailers,\n+                                                                        true, endStream, false);\n+\n+        if (outputHeaders.contains(HttpHeaderNames.CONTENT_LENGTH) &&\n+            !additionalTrailers.isEmpty()) {\n+            // We don't apply chunked encoding when the content-length header is set, which would\n+            // prevent the trailers from being sent so we go ahead and remove content-length to force\n+            // chunked encoding.\n+            outputHeaders.remove(HttpHeaderNames.CONTENT_LENGTH);\n+        }\n+\n+        if (enableServerHeader && !outputHeaders.contains(HttpHeaderNames.SERVER)) {\n+            outputHeaders.add(HttpHeaderNames.SERVER, ArmeriaHttpUtil.SERVER_HEADER);\n+        }\n+\n+        if (enableDateHeader && !outputHeaders.contains(HttpHeaderNames.DATE)) {\n+            outputHeaders.add(HttpHeaderNames.DATE, HttpTimestampSupplier.currentTime());\n+        }\n+\n+        return outputHeaders;\n+    }\n+\n+    private Http2Headers convertServerTrailers(\n+            HttpHeaders inputHeaders, HttpHeaders additionalTrailers, boolean endStream) {\n+        return ArmeriaHttpUtil.toNettyHttp2(inputHeaders, HttpHeaders.of(), additionalTrailers,\n+                                            true, endStream, true);\n+    }\n+\n+    private Http2Headers convertClientHeaders(\n+            HttpHeaders inputHeaders, HttpHeaders additionalHeaders, HttpHeaders additionalTrailers,\n+            boolean endStream, SessionProtocol sessionProtocol) {\n+\n+        requireNonNull(sessionProtocol);\n+\n+        final Http2Headers outputHeaders = ArmeriaHttpUtil.toNettyHttp2(inputHeaders,\n+                                                                        additionalHeaders, additionalTrailers,\n+                                                                        false, endStream, false);\n+\n+        if (!outputHeaders.contains(HttpHeaderNames.USER_AGENT)) {\n+            outputHeaders.add(HttpHeaderNames.USER_AGENT, HttpHeaderUtil.USER_AGENT.toString());\n+        }\n+\n+        if (!outputHeaders.contains(HttpHeaderNames.SCHEME)) {\n+            outputHeaders.scheme(sessionProtocol.isTls() ? \"https\" : \"http\");", "originalCommit": "73262810023e267bc4ae2e8d809c1a4b701ee252", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0ODMxMQ==", "url": "https://github.com/line/armeria/pull/2372#discussion_r372648311", "bodyText": "Thank you, fixed it.", "author": "jyblue", "createdAt": "2020-01-29T21:46:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIyMTk0MA=="}], "type": "inlineReview", "revised_code": {"commit": "a27fa1390d57112ed924c3e1433020753ec9c925", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/internal/Http2ObjectEncoder.java b/core/src/main/java/com/linecorp/armeria/internal/Http2ObjectEncoder.java\nindex 84572ffa9..0e35d95d8 100644\n--- a/core/src/main/java/com/linecorp/armeria/internal/Http2ObjectEncoder.java\n+++ b/core/src/main/java/com/linecorp/armeria/internal/Http2ObjectEncoder.java\n\n@@ -120,8 +120,8 @@ public final class Http2ObjectEncoder extends HttpObjectEncoder {\n                                                                         additionalHeaders, additionalTrailers,\n                                                                         true, endStream, false);\n \n-        if (outputHeaders.contains(HttpHeaderNames.CONTENT_LENGTH) &&\n-            !additionalTrailers.isEmpty()) {\n+        if (!additionalTrailers.isEmpty() &&\n+            outputHeaders.contains(HttpHeaderNames.CONTENT_LENGTH)) {\n             // We don't apply chunked encoding when the content-length header is set, which would\n             // prevent the trailers from being sent so we go ahead and remove content-length to force\n             // chunked encoding.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIyMjE0MQ==", "url": "https://github.com/line/armeria/pull/2372#discussion_r372222141", "bodyText": "We don't need requireNonNull in a private method. By the way, SessionProtocol seems nullable because the caller(doWriteHeaders) calls this method with nullable SessionProtocol.", "author": "ikhoon", "createdAt": "2020-01-29T07:19:16Z", "path": "core/src/main/java/com/linecorp/armeria/internal/Http2ObjectEncoder.java", "diffHunk": "@@ -69,9 +101,83 @@ protected ChannelFuture doWriteHeaders(int id, int streamId, HttpHeaders headers\n             return newFailedFuture(ClosedPublisherException.get());\n         }\n \n+        if (!isTrailer) {\n+            convertedHeaders = convertClientHeaders(headers, additionalHeaders, additionalTrailers,\n+                                                    endStream, sessionProtocol);\n+        } else {\n+            convertedHeaders = convertClientTrailers(headers, additionalTrailers, endStream);\n+        }\n+\n         // Client starts a new stream.\n-        return encoder.writeHeaders(\n-                ctx, streamId, ArmeriaHttpUtil.toNettyHttp2(headers, server), 0, endStream, ctx.newPromise());\n+        return encoder.writeHeaders(ctx, streamId, convertedHeaders, 0, endStream, ctx.newPromise());\n+    }\n+\n+    private Http2Headers convertServerHeaders(\n+            HttpHeaders inputHeaders, HttpHeaders additionalHeaders, HttpHeaders additionalTrailers,\n+            boolean endStream, boolean enableServerHeader, boolean enableDateHeader) {\n+\n+        final Http2Headers outputHeaders = ArmeriaHttpUtil.toNettyHttp2(inputHeaders,\n+                                                                        additionalHeaders, additionalTrailers,\n+                                                                        true, endStream, false);\n+\n+        if (outputHeaders.contains(HttpHeaderNames.CONTENT_LENGTH) &&\n+            !additionalTrailers.isEmpty()) {\n+            // We don't apply chunked encoding when the content-length header is set, which would\n+            // prevent the trailers from being sent so we go ahead and remove content-length to force\n+            // chunked encoding.\n+            outputHeaders.remove(HttpHeaderNames.CONTENT_LENGTH);\n+        }\n+\n+        if (enableServerHeader && !outputHeaders.contains(HttpHeaderNames.SERVER)) {\n+            outputHeaders.add(HttpHeaderNames.SERVER, ArmeriaHttpUtil.SERVER_HEADER);\n+        }\n+\n+        if (enableDateHeader && !outputHeaders.contains(HttpHeaderNames.DATE)) {\n+            outputHeaders.add(HttpHeaderNames.DATE, HttpTimestampSupplier.currentTime());\n+        }\n+\n+        return outputHeaders;\n+    }\n+\n+    private Http2Headers convertServerTrailers(\n+            HttpHeaders inputHeaders, HttpHeaders additionalTrailers, boolean endStream) {\n+        return ArmeriaHttpUtil.toNettyHttp2(inputHeaders, HttpHeaders.of(), additionalTrailers,\n+                                            true, endStream, true);\n+    }\n+\n+    private Http2Headers convertClientHeaders(\n+            HttpHeaders inputHeaders, HttpHeaders additionalHeaders, HttpHeaders additionalTrailers,\n+            boolean endStream, SessionProtocol sessionProtocol) {\n+\n+        requireNonNull(sessionProtocol);", "originalCommit": "73262810023e267bc4ae2e8d809c1a4b701ee252", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg1MjQ2Nw==", "url": "https://github.com/line/armeria/pull/2372#discussion_r376852467", "bodyText": "Removed SessionProtocol by setting it when it constructed \ud83d\ude00", "author": "jyblue", "createdAt": "2020-02-10T03:08:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIyMjE0MQ=="}], "type": "inlineReview", "revised_code": {"commit": "a27fa1390d57112ed924c3e1433020753ec9c925", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/internal/Http2ObjectEncoder.java b/core/src/main/java/com/linecorp/armeria/internal/Http2ObjectEncoder.java\nindex 84572ffa9..0e35d95d8 100644\n--- a/core/src/main/java/com/linecorp/armeria/internal/Http2ObjectEncoder.java\n+++ b/core/src/main/java/com/linecorp/armeria/internal/Http2ObjectEncoder.java\n\n@@ -120,8 +120,8 @@ public final class Http2ObjectEncoder extends HttpObjectEncoder {\n                                                                         additionalHeaders, additionalTrailers,\n                                                                         true, endStream, false);\n \n-        if (outputHeaders.contains(HttpHeaderNames.CONTENT_LENGTH) &&\n-            !additionalTrailers.isEmpty()) {\n+        if (!additionalTrailers.isEmpty() &&\n+            outputHeaders.contains(HttpHeaderNames.CONTENT_LENGTH)) {\n             // We don't apply chunked encoding when the content-length header is set, which would\n             // prevent the trailers from being sent so we go ahead and remove content-length to force\n             // chunked encoding.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIyMzg3MA==", "url": "https://github.com/line/armeria/pull/2372#discussion_r372223870", "bodyText": "How about checking !additionalTrailers.isEmpty() first because I think isEmpty is cheaper and most of yours don't set trailers.\nif (!additionalTrailers.isEmpty() && outputHeaders.contains(HttpHeaderNames.CONTENT_LENGTH) {\n  ...\n}", "author": "ikhoon", "createdAt": "2020-01-29T07:25:50Z", "path": "core/src/main/java/com/linecorp/armeria/internal/Http2ObjectEncoder.java", "diffHunk": "@@ -69,9 +101,83 @@ protected ChannelFuture doWriteHeaders(int id, int streamId, HttpHeaders headers\n             return newFailedFuture(ClosedPublisherException.get());\n         }\n \n+        if (!isTrailer) {\n+            convertedHeaders = convertClientHeaders(headers, additionalHeaders, additionalTrailers,\n+                                                    endStream, sessionProtocol);\n+        } else {\n+            convertedHeaders = convertClientTrailers(headers, additionalTrailers, endStream);\n+        }\n+\n         // Client starts a new stream.\n-        return encoder.writeHeaders(\n-                ctx, streamId, ArmeriaHttpUtil.toNettyHttp2(headers, server), 0, endStream, ctx.newPromise());\n+        return encoder.writeHeaders(ctx, streamId, convertedHeaders, 0, endStream, ctx.newPromise());\n+    }\n+\n+    private Http2Headers convertServerHeaders(\n+            HttpHeaders inputHeaders, HttpHeaders additionalHeaders, HttpHeaders additionalTrailers,\n+            boolean endStream, boolean enableServerHeader, boolean enableDateHeader) {\n+\n+        final Http2Headers outputHeaders = ArmeriaHttpUtil.toNettyHttp2(inputHeaders,\n+                                                                        additionalHeaders, additionalTrailers,\n+                                                                        true, endStream, false);\n+\n+        if (outputHeaders.contains(HttpHeaderNames.CONTENT_LENGTH) &&\n+            !additionalTrailers.isEmpty()) {", "originalCommit": "73262810023e267bc4ae2e8d809c1a4b701ee252", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0OTE3Ng==", "url": "https://github.com/line/armeria/pull/2372#discussion_r372649176", "bodyText": "Fixed it. Thanks for education.", "author": "jyblue", "createdAt": "2020-01-29T21:48:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIyMzg3MA=="}], "type": "inlineReview", "revised_code": {"commit": "a27fa1390d57112ed924c3e1433020753ec9c925", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/internal/Http2ObjectEncoder.java b/core/src/main/java/com/linecorp/armeria/internal/Http2ObjectEncoder.java\nindex 84572ffa9..0e35d95d8 100644\n--- a/core/src/main/java/com/linecorp/armeria/internal/Http2ObjectEncoder.java\n+++ b/core/src/main/java/com/linecorp/armeria/internal/Http2ObjectEncoder.java\n\n@@ -120,8 +120,8 @@ public final class Http2ObjectEncoder extends HttpObjectEncoder {\n                                                                         additionalHeaders, additionalTrailers,\n                                                                         true, endStream, false);\n \n-        if (outputHeaders.contains(HttpHeaderNames.CONTENT_LENGTH) &&\n-            !additionalTrailers.isEmpty()) {\n+        if (!additionalTrailers.isEmpty() &&\n+            outputHeaders.contains(HttpHeaderNames.CONTENT_LENGTH)) {\n             // We don't apply chunked encoding when the content-length header is set, which would\n             // prevent the trailers from being sent so we go ahead and remove content-length to force\n             // chunked encoding.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIyNzQzMA==", "url": "https://github.com/line/armeria/pull/2372#discussion_r372227430", "bodyText": "nit: Remove this blank line?", "author": "ikhoon", "createdAt": "2020-01-29T07:38:06Z", "path": "core/src/main/java/com/linecorp/armeria/internal/ArmeriaHttpUtil.java", "diffHunk": "@@ -997,5 +1075,21 @@ public static boolean isTrailerBlacklisted(AsciiString name) {\n         }\n     }\n \n+    /**\n+     * Returns a authority header value of specified host and port.\n+     */\n+    public static String authorityHeader(String host, int port, int defaultPort) {\n+", "originalCommit": "73262810023e267bc4ae2e8d809c1a4b701ee252", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0ODgxNA==", "url": "https://github.com/line/armeria/pull/2372#discussion_r372648814", "bodyText": "Removed.", "author": "jyblue", "createdAt": "2020-01-29T21:47:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIyNzQzMA=="}], "type": "inlineReview", "revised_code": {"commit": "a27fa1390d57112ed924c3e1433020753ec9c925", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/internal/ArmeriaHttpUtil.java b/core/src/main/java/com/linecorp/armeria/internal/ArmeriaHttpUtil.java\nindex 9ed11e22b..c65f699d7 100644\n--- a/core/src/main/java/com/linecorp/armeria/internal/ArmeriaHttpUtil.java\n+++ b/core/src/main/java/com/linecorp/armeria/internal/ArmeriaHttpUtil.java\n\n@@ -1079,7 +1079,6 @@ public final class ArmeriaHttpUtil {\n      * Returns a authority header value of specified host and port.\n      */\n     public static String authorityHeader(String host, int port, int defaultPort) {\n-\n         if (port == defaultPort) {\n             return host;\n         } else {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIzMzA2OA==", "url": "https://github.com/line/armeria/pull/2372#discussion_r372233068", "bodyText": "Ditto, check !additionalTrailers.isEmpty() first", "author": "ikhoon", "createdAt": "2020-01-29T07:55:18Z", "path": "core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java", "diffHunk": "@@ -216,31 +239,78 @@ private HttpObject convertServerHeaders(\n         } else {\n             res = new DefaultHttpResponse(HttpVersion.HTTP_1_1, nettyStatus, false);\n             // Perform conversion.\n-            convert(streamId, headers, res.headers(), false, false);\n+            convertServerHeaders0(streamId, headers, res.headers(), endStream,\n+                                  additionalHeaders, additionalTrailers,\n+                                  enableServerHeader, enableDateHeader);\n             setTransferEncoding(res);\n         }\n \n         return res;\n     }\n \n-    private HttpObject convertClientHeaders(int streamId, HttpHeaders headers, boolean endStream)\n-            throws Http2Exception {\n+    private void convertServerHeaders0(\n+            int streamId, HttpHeaders inHeaders,\n+            io.netty.handler.codec.http.HttpHeaders outHeaders, boolean endStream,\n+            HttpHeaders additionalHeaders, HttpHeaders additionalTrailers,\n+            boolean enableServerHeader, boolean enableDateHeader) throws Http2Exception {\n \n-        // Leading headers will always have :method, trailers will never have it.\n-        final String method = headers.get(HttpHeaderNames.METHOD);\n-        if (method == null) {\n-            return convertTrailingHeaders(streamId, headers);\n+        ArmeriaHttpUtil.toNettyHttp1(\n+                streamId, inHeaders, additionalHeaders, additionalTrailers, outHeaders,\n+                HttpVersion.HTTP_1_1, false, false, endStream);\n+\n+        removeHttpExtensionHeaders(outHeaders);\n+\n+        if (outHeaders.contains(HttpHeaderNames.CONTENT_LENGTH) &&\n+            !additionalTrailers.isEmpty()) {", "originalCommit": "73262810023e267bc4ae2e8d809c1a4b701ee252", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0OTI2Ng==", "url": "https://github.com/line/armeria/pull/2372#discussion_r372649266", "bodyText": "Fixed it.", "author": "jyblue", "createdAt": "2020-01-29T21:48:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIzMzA2OA=="}], "type": "inlineReview", "revised_code": {"commit": "a27fa1390d57112ed924c3e1433020753ec9c925", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java b/core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java\nindex 2ee986fb5..6f9bf297c 100644\n--- a/core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java\n+++ b/core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java\n\n@@ -248,7 +248,7 @@ public final class Http1ObjectEncoder extends HttpObjectEncoder {\n         return res;\n     }\n \n-    private void convertServerHeaders0(\n+    private static void convertServerHeaders0(\n             int streamId, HttpHeaders inHeaders,\n             io.netty.handler.codec.http.HttpHeaders outHeaders, boolean endStream,\n             HttpHeaders additionalHeaders, HttpHeaders additionalTrailers,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIzMzc5MA==", "url": "https://github.com/line/armeria/pull/2372#discussion_r372233790", "bodyText": "Introduce a local variable for (InetSocketAddress) channel().remoteAddress()?", "author": "ikhoon", "createdAt": "2020-01-29T07:57:41Z", "path": "core/src/main/java/com/linecorp/armeria/internal/Http2ObjectEncoder.java", "diffHunk": "@@ -69,9 +101,83 @@ protected ChannelFuture doWriteHeaders(int id, int streamId, HttpHeaders headers\n             return newFailedFuture(ClosedPublisherException.get());\n         }\n \n+        if (!isTrailer) {\n+            convertedHeaders = convertClientHeaders(headers, additionalHeaders, additionalTrailers,\n+                                                    endStream, sessionProtocol);\n+        } else {\n+            convertedHeaders = convertClientTrailers(headers, additionalTrailers, endStream);\n+        }\n+\n         // Client starts a new stream.\n-        return encoder.writeHeaders(\n-                ctx, streamId, ArmeriaHttpUtil.toNettyHttp2(headers, server), 0, endStream, ctx.newPromise());\n+        return encoder.writeHeaders(ctx, streamId, convertedHeaders, 0, endStream, ctx.newPromise());\n+    }\n+\n+    private Http2Headers convertServerHeaders(\n+            HttpHeaders inputHeaders, HttpHeaders additionalHeaders, HttpHeaders additionalTrailers,\n+            boolean endStream, boolean enableServerHeader, boolean enableDateHeader) {\n+\n+        final Http2Headers outputHeaders = ArmeriaHttpUtil.toNettyHttp2(inputHeaders,\n+                                                                        additionalHeaders, additionalTrailers,\n+                                                                        true, endStream, false);\n+\n+        if (outputHeaders.contains(HttpHeaderNames.CONTENT_LENGTH) &&\n+            !additionalTrailers.isEmpty()) {\n+            // We don't apply chunked encoding when the content-length header is set, which would\n+            // prevent the trailers from being sent so we go ahead and remove content-length to force\n+            // chunked encoding.\n+            outputHeaders.remove(HttpHeaderNames.CONTENT_LENGTH);\n+        }\n+\n+        if (enableServerHeader && !outputHeaders.contains(HttpHeaderNames.SERVER)) {\n+            outputHeaders.add(HttpHeaderNames.SERVER, ArmeriaHttpUtil.SERVER_HEADER);\n+        }\n+\n+        if (enableDateHeader && !outputHeaders.contains(HttpHeaderNames.DATE)) {\n+            outputHeaders.add(HttpHeaderNames.DATE, HttpTimestampSupplier.currentTime());\n+        }\n+\n+        return outputHeaders;\n+    }\n+\n+    private Http2Headers convertServerTrailers(\n+            HttpHeaders inputHeaders, HttpHeaders additionalTrailers, boolean endStream) {\n+        return ArmeriaHttpUtil.toNettyHttp2(inputHeaders, HttpHeaders.of(), additionalTrailers,\n+                                            true, endStream, true);\n+    }\n+\n+    private Http2Headers convertClientHeaders(\n+            HttpHeaders inputHeaders, HttpHeaders additionalHeaders, HttpHeaders additionalTrailers,\n+            boolean endStream, SessionProtocol sessionProtocol) {\n+\n+        requireNonNull(sessionProtocol);\n+\n+        final Http2Headers outputHeaders = ArmeriaHttpUtil.toNettyHttp2(inputHeaders,\n+                                                                        additionalHeaders, additionalTrailers,\n+                                                                        false, endStream, false);\n+\n+        if (!outputHeaders.contains(HttpHeaderNames.USER_AGENT)) {\n+            outputHeaders.add(HttpHeaderNames.USER_AGENT, HttpHeaderUtil.USER_AGENT.toString());\n+        }\n+\n+        if (!outputHeaders.contains(HttpHeaderNames.SCHEME)) {\n+            outputHeaders.scheme(sessionProtocol.isTls() ? \"https\" : \"http\");\n+        }\n+\n+        if (!outputHeaders.contains(HttpHeaderNames.AUTHORITY)) {\n+            outputHeaders.add(HttpHeaderNames.AUTHORITY,\n+                              ArmeriaHttpUtil.authorityHeader(\n+                                      ((InetSocketAddress) channel().remoteAddress()).getHostName(),\n+                                      ((InetSocketAddress) channel().remoteAddress()).getPort(),", "originalCommit": "73262810023e267bc4ae2e8d809c1a4b701ee252", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0OTM5MA==", "url": "https://github.com/line/armeria/pull/2372#discussion_r372649390", "bodyText": "Fixed it.", "author": "jyblue", "createdAt": "2020-01-29T21:48:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIzMzc5MA=="}], "type": "inlineReview", "revised_code": {"commit": "a27fa1390d57112ed924c3e1433020753ec9c925", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/internal/Http2ObjectEncoder.java b/core/src/main/java/com/linecorp/armeria/internal/Http2ObjectEncoder.java\nindex 84572ffa9..0e35d95d8 100644\n--- a/core/src/main/java/com/linecorp/armeria/internal/Http2ObjectEncoder.java\n+++ b/core/src/main/java/com/linecorp/armeria/internal/Http2ObjectEncoder.java\n\n@@ -120,8 +120,8 @@ public final class Http2ObjectEncoder extends HttpObjectEncoder {\n                                                                         additionalHeaders, additionalTrailers,\n                                                                         true, endStream, false);\n \n-        if (outputHeaders.contains(HttpHeaderNames.CONTENT_LENGTH) &&\n-            !additionalTrailers.isEmpty()) {\n+        if (!additionalTrailers.isEmpty() &&\n+            outputHeaders.contains(HttpHeaderNames.CONTENT_LENGTH)) {\n             // We don't apply chunked encoding when the content-length header is set, which would\n             // prevent the trailers from being sent so we go ahead and remove content-length to force\n             // chunked encoding.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI2NDAzMQ==", "url": "https://github.com/line/armeria/pull/2372#discussion_r372264031", "bodyText": "nit: false, false, null are hard to understand. \ud83d\ude05 Add comment to null and false value for readability?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            HttpHeaders.of(), HttpHeaders.of(), false, false, null);\n          \n          \n            \n                            HttpHeaders.of(), HttpHeaders.of(), false /* enableServerHeader */, false /* enableDateHeader */, null /* sessionProtocol */);", "author": "ikhoon", "createdAt": "2020-01-29T09:12:39Z", "path": "core/src/main/java/com/linecorp/armeria/server/HttpServerHandler.java", "diffHunk": "@@ -539,7 +540,8 @@ private ChannelFuture respond(ServiceRequestContext reqCtx, boolean addKeepAlive\n \n         final ResponseHeaders immutableResHeaders = resHeaders.build();\n         ChannelFuture future = responseEncoder.writeHeaders(\n-                req.id(), req.streamId(), immutableResHeaders, !hasContent);\n+                req.id(), req.streamId(), immutableResHeaders, !hasContent,\n+                HttpHeaders.of(), HttpHeaders.of(), false, false, null);", "originalCommit": "73262810023e267bc4ae2e8d809c1a4b701ee252", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIxMTEyNA==", "url": "https://github.com/line/armeria/pull/2372#discussion_r373211124", "bodyText": "Thanks, I fixed it.", "author": "jyblue", "createdAt": "2020-01-30T21:47:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI2NDAzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "a27fa1390d57112ed924c3e1433020753ec9c925", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/server/HttpServerHandler.java b/core/src/main/java/com/linecorp/armeria/server/HttpServerHandler.java\nindex 4837366ee..542d5a377 100644\n--- a/core/src/main/java/com/linecorp/armeria/server/HttpServerHandler.java\n+++ b/core/src/main/java/com/linecorp/armeria/server/HttpServerHandler.java\n\n@@ -541,7 +541,8 @@ final class HttpServerHandler extends ChannelInboundHandlerAdapter implements Ht\n         final ResponseHeaders immutableResHeaders = resHeaders.build();\n         ChannelFuture future = responseEncoder.writeHeaders(\n                 req.id(), req.streamId(), immutableResHeaders, !hasContent,\n-                HttpHeaders.of(), HttpHeaders.of(), false, false, null);\n+                HttpHeaders.of(), HttpHeaders.of(),\n+                false /* enableServerHeader */, false /* enableDateHeader */, null /* sessionProtocol */);\n         logBuilder.responseHeaders(immutableResHeaders);\n         if (hasContent) {\n             logBuilder.increaseResponseLength(resContent);\n"}}, {"oid": "a27fa1390d57112ed924c3e1433020753ec9c925", "url": "https://github.com/line/armeria/commit/a27fa1390d57112ed924c3e1433020753ec9c925", "message": "Add comments", "committedDate": "2020-01-29T21:41:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI4OTgxNg==", "url": "https://github.com/line/armeria/pull/2372#discussion_r373289816", "bodyText": "IIRC this check can be removed.", "author": "trustin", "createdAt": "2020-01-31T02:20:47Z", "path": "core/src/main/java/com/linecorp/armeria/internal/ArmeriaHttpUtil.java", "diffHunk": "@@ -801,63 +814,131 @@ private static void addHttp2Scheme(io.netty.handler.codec.http.HttpHeaders in, U\n \n     /**\n      * Converts the specified Armeria HTTP/2 headers into Netty HTTP/2 headers.\n+     *\n+     * @param inputHeaders The HTTP/2 headers to convert.\n+     * @param additionalHeaders The additional headers which will be merged.\n+     * @param additionalTrailers The additional trailers which will be merged.\n+     * @param server    {@code true} if the returned headers will be used in a response message.\n+     *                  {@code false} for request message.\n+     * @param endStream {@code true} if returned headers will end streams.\n+     *                  {@code false} otherwise.\n+     * @param isTrailer {@code true} if returned headers should be treated as trailers.\n+     *                  {@code false} otherwise.\n      */\n-    public static Http2Headers toNettyHttp2(HttpHeaders in, boolean server) {\n-        final Http2Headers out = new DefaultHttp2Headers(false, in.size());\n+    public static Http2Headers toNettyHttp2(HttpHeaders inputHeaders,\n+                                            HttpHeaders additionalHeaders, HttpHeaders additionalTrailers,\n+                                            boolean server, boolean endStream, boolean isTrailer) {\n+        final int headerSizeHint = inputHeaders.size() + additionalHeaders.size() + additionalTrailers.size();\n+        final Http2Headers outputHeaders = new DefaultHttp2Headers(false, headerSizeHint);\n \n-        // Trailers if it does not have :status.\n-        if (server && !in.contains(HttpHeaderNames.STATUS)) {\n-            for (Entry<AsciiString, String> entry : in) {\n-                final AsciiString name = entry.getKey();\n-                final String value = entry.getValue();\n-                if (name.isEmpty() || isTrailerBlacklisted(name)) {\n-                    continue;\n-                }\n-                out.add(name, value);\n-            }\n-        } else {\n-            in.forEach((BiConsumer<AsciiString, String>) out::add);\n-            out.remove(HttpHeaderNames.CONNECTION);\n-            out.remove(HttpHeaderNames.TRANSFER_ENCODING);\n+        mergeHeadersHttp2(inputHeaders, outputHeaders, !server, isTrailer, false);\n+\n+        if (!isTrailer) {\n+            mergeHeadersHttp2(additionalHeaders, outputHeaders, !server, false, true);\n         }\n \n-        if (!out.contains(HttpHeaderNames.COOKIE)) {\n-            return out;\n+        if (server && endStream) {\n+            mergeHeadersHttp2(additionalTrailers, outputHeaders, false, isTrailer, true);\n+        }\n+\n+        outputHeaders.remove(HttpHeaderNames.CONNECTION);\n+        outputHeaders.remove(HttpHeaderNames.TRANSFER_ENCODING);\n+\n+        if (!outputHeaders.contains(HttpHeaderNames.COOKIE)) {\n+            return outputHeaders;\n         }\n \n         // Split up cookies to allow for better compression.\n         // https://tools.ietf.org/html/rfc7540#section-8.1.2.5\n-        final List<CharSequence> cookies = out.getAllAndRemove(HttpHeaderNames.COOKIE);\n+        final List<CharSequence> cookies = outputHeaders.getAllAndRemove(HttpHeaderNames.COOKIE);\n         for (CharSequence c : cookies) {\n-            out.add(HttpHeaderNames.COOKIE, COOKIE_SPLITTER.split(c));\n+            outputHeaders.add(HttpHeaderNames.COOKIE, COOKIE_SPLITTER.split(c));\n         }\n \n-        return out;\n+        return outputHeaders;\n+    }\n+\n+    private static void mergeHeadersHttp2(HttpHeaders inputHeaders, Http2Headers outputHeaders,\n+                                          boolean isRequest, boolean isTrailer, boolean isAdditionalHeaders) {\n+        final Set<AsciiString> additionalHeaderBlackList = isRequest ? ADDITIONAL_REQUEST_HEADER_BLACKLIST\n+                                                                     : ADDITIONAL_RESPONSE_HEADER_BLACKLIST;\n+        final Set<AsciiString> removed = new HashSet<>();\n+        for (Entry<AsciiString, String> entry : inputHeaders) {\n+            final AsciiString name = entry.getKey();\n+            final String value = entry.getValue();\n+            if (name.isEmpty()) {\n+                continue;\n+            }", "originalCommit": "20770207e8c9db61e31aae76a26fe631ce997f20", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI5MTg3OA==", "url": "https://github.com/line/armeria/pull/2372#discussion_r373291878", "bodyText": "Pushed a fix to your branch.", "author": "trustin", "createdAt": "2020-01-31T02:32:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI4OTgxNg=="}], "type": "inlineReview", "revised_code": {"commit": "3f101f4bff4fe737a307a54418e445c14a57b69d", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/internal/ArmeriaHttpUtil.java b/core/src/main/java/com/linecorp/armeria/internal/ArmeriaHttpUtil.java\nindex cf7d82b8f..e5f212d41 100644\n--- a/core/src/main/java/com/linecorp/armeria/internal/ArmeriaHttpUtil.java\n+++ b/core/src/main/java/com/linecorp/armeria/internal/ArmeriaHttpUtil.java\n\n@@ -866,10 +866,6 @@ public final class ArmeriaHttpUtil {\n         for (Entry<AsciiString, String> entry : inputHeaders) {\n             final AsciiString name = entry.getKey();\n             final String value = entry.getValue();\n-            if (name.isEmpty()) {\n-                continue;\n-            }\n-\n             if (isAdditionalHeaders && additionalHeaderBlackList.contains(name)) {\n                 continue;\n             }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI4OTk3MA==", "url": "https://github.com/line/armeria/pull/2372#discussion_r373289970", "bodyText": "This name.isEmpty() check can be removed as well.", "author": "trustin", "createdAt": "2020-01-31T02:21:31Z", "path": "core/src/main/java/com/linecorp/armeria/internal/ArmeriaHttpUtil.java", "diffHunk": "@@ -871,18 +952,25 @@ public static void toNettyHttp1(\n                     continue;\n                 }", "originalCommit": "20770207e8c9db61e31aae76a26fe631ce997f20", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI5MTg2Mg==", "url": "https://github.com/line/armeria/pull/2372#discussion_r373291862", "bodyText": "Pushed a fix to your branch.", "author": "trustin", "createdAt": "2020-01-31T02:32:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI4OTk3MA=="}], "type": "inlineReview", "revised_code": {"commit": "3f101f4bff4fe737a307a54418e445c14a57b69d", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/internal/ArmeriaHttpUtil.java b/core/src/main/java/com/linecorp/armeria/internal/ArmeriaHttpUtil.java\nindex cf7d82b8f..e5f212d41 100644\n--- a/core/src/main/java/com/linecorp/armeria/internal/ArmeriaHttpUtil.java\n+++ b/core/src/main/java/com/linecorp/armeria/internal/ArmeriaHttpUtil.java\n\n@@ -948,7 +944,7 @@ public final class ArmeriaHttpUtil {\n                     continue;\n                 }\n \n-                if (name.isEmpty() || HTTP2_TO_HTTP_HEADER_BLACKLIST.contains(name)) {\n+                if (HTTP2_TO_HTTP_HEADER_BLACKLIST.contains(name)) {\n                     continue;\n                 }\n \n"}}, {"oid": "3f101f4bff4fe737a307a54418e445c14a57b69d", "url": "https://github.com/line/armeria/commit/3f101f4bff4fe737a307a54418e445c14a57b69d", "message": "Remove unnecessary `name.isEmpty()` checks", "committedDate": "2020-01-31T12:54:47Z", "type": "forcePushed"}, {"oid": "ccbd58921ed1428c164f8f67e0818803214b90e6", "url": "https://github.com/line/armeria/commit/ccbd58921ed1428c164f8f67e0818803214b90e6", "message": "Fix merge conflict", "committedDate": "2020-01-31T15:31:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc2Mjk5NQ==", "url": "https://github.com/line/armeria/pull/2372#discussion_r373762995", "bodyText": "I think we can set requestSessionProtocol when creating Http*ObjectEncoder.\n\n  \n    \n      armeria/core/src/main/java/com/linecorp/armeria/client/HttpSessionHandler.java\n    \n    \n        Lines 276 to 283\n      in\n      dcc56ab\n    \n    \n    \n    \n\n        \n          \n           final SessionProtocol protocol = (SessionProtocol) evt; \n        \n\n        \n          \n           this.protocol = protocol; \n        \n\n        \n          \n           if (protocol == H1 || protocol == H1C) { \n        \n\n        \n          \n               requestEncoder = new Http1ObjectEncoder(channel, false, protocol.isTls()); \n        \n\n        \n          \n               responseDecoder = ctx.pipeline().get(Http1ResponseDecoder.class); \n        \n\n        \n          \n           } else if (protocol == H2 || protocol == H2C) { \n        \n\n        \n          \n               final Http2ConnectionHandler handler = ctx.pipeline().get(Http2ConnectionHandler.class); \n        \n\n        \n          \n               requestEncoder = new Http2ObjectEncoder(ctx, handler.encoder());", "author": "ikhoon", "createdAt": "2020-02-01T06:55:05Z", "path": "core/src/main/java/com/linecorp/armeria/client/HttpRequestSubscriber.java", "diffHunk": "@@ -181,59 +174,15 @@ private void writeFirstHeader() {\n \n         if (request.isEmpty()) {\n             state = State.DONE;\n-            write0(firstHeaders, true, true);\n+            write0(firstHeaders, true, true,\n+                   reqCtx.additionalRequestHeaders(), requestSessionProtocol);", "originalCommit": "ccbd58921ed1428c164f8f67e0818803214b90e6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "309a438d6933530b98fcdd3ba68d781bce1c3858", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/HttpRequestSubscriber.java b/core/src/main/java/com/linecorp/armeria/client/HttpRequestSubscriber.java\nindex 13e03114e..7b5d0948e 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/HttpRequestSubscriber.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/HttpRequestSubscriber.java\n\n@@ -169,7 +168,6 @@ final class HttpRequestSubscriber implements Subscriber<HttpObject>, ChannelFutu\n \n         final SessionProtocol protocol = session.protocol();\n         assert protocol != null;\n-        logBuilder.startRequest(ch, protocol);\n         logBuilder.requestHeaders(firstHeaders);\n \n         if (request.isEmpty()) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc2MzM4Ng==", "url": "https://github.com/line/armeria/pull/2372#discussion_r373763386", "bodyText": "enableServerHeader, enableDateHeader is immutable after building Server.\nHow about setting these flags when creating Http*ObjectEncoder?\nIt would be cleaner to get these immutable flags from class fields than method passing.", "author": "ikhoon", "createdAt": "2020-02-01T07:05:42Z", "path": "core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java", "diffHunk": "@@ -116,31 +120,43 @@ protected Channel channel() {\n     }\n \n     @Override\n-    protected ChannelFuture doWriteHeaders(int id, int streamId, HttpHeaders headers, boolean endStream) {\n+    protected ChannelFuture doWriteHeaders(int id, int streamId, HttpHeaders headers, boolean endStream,\n+                                           HttpHeaders additionalHeaders, HttpHeaders additionalTrailers,\n+                                           boolean enableServerHeader, boolean enableDateHeader,", "originalCommit": "ccbd58921ed1428c164f8f67e0818803214b90e6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "309a438d6933530b98fcdd3ba68d781bce1c3858", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java b/core/src/main/java/com/linecorp/armeria/internal/common/Http1ObjectEncoder.java\nsimilarity index 97%\nrename from core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java\nrename to core/src/main/java/com/linecorp/armeria/internal/common/Http1ObjectEncoder.java\nindex 6f9bf297c..054583e8d 100644\n--- a/core/src/main/java/com/linecorp/armeria/internal/Http1ObjectEncoder.java\n+++ b/core/src/main/java/com/linecorp/armeria/internal/common/Http1ObjectEncoder.java\n\n@@ -124,7 +126,7 @@ public final class Http1ObjectEncoder extends HttpObjectEncoder {\n                                            HttpHeaders additionalHeaders, HttpHeaders additionalTrailers,\n                                            boolean enableServerHeader, boolean enableDateHeader,\n                                            @Nullable SessionProtocol sessionProtocol) {\n-        if (id >= minClosedId) {\n+        if (!isWritable(id)) {\n             return newClosedSessionFuture();\n         }\n \n"}}, {"oid": "309a438d6933530b98fcdd3ba68d781bce1c3858", "url": "https://github.com/line/armeria/commit/309a438d6933530b98fcdd3ba68d781bce1c3858", "message": "Make some methods static", "committedDate": "2020-02-08T00:23:09Z", "type": "forcePushed"}, {"oid": "b4b283b256532e2a20c3fa0d85159767b522cc57", "url": "https://github.com/line/armeria/commit/b4b283b256532e2a20c3fa0d85159767b522cc57", "message": "Clean up", "committedDate": "2020-02-12T18:56:48Z", "type": "forcePushed"}, {"oid": "8c25a0e3c608c41a66e84bd436f926ba5fa41554", "url": "https://github.com/line/armeria/commit/8c25a0e3c608c41a66e84bd436f926ba5fa41554", "message": "WIP", "committedDate": "2020-02-23T10:01:28Z", "type": "forcePushed"}, {"oid": "3e66cee7f8b88efc518911e3b1e4a0aca8d19904", "url": "https://github.com/line/armeria/commit/3e66cee7f8b88efc518911e3b1e4a0aca8d19904", "message": "WIP", "committedDate": "2020-02-24T22:33:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDIzODE4NQ==", "url": "https://github.com/line/armeria/pull/2372#discussion_r384238185", "bodyText": "Could be final with package-private?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                protected ChannelFuture writeNonInformationalHeaders(int id, HttpObject converted, boolean endStream) {\n          \n          \n            \n                final ChannelFuture writeNonInformationalHeaders(int id, HttpObject converted, boolean endStream) {", "author": "ikhoon", "createdAt": "2020-02-26T02:06:14Z", "path": "core/src/main/java/com/linecorp/armeria/internal/common/Http1ObjectEncoder.java", "diffHunk": "@@ -104,65 +89,17 @@\n      */\n     private final IntObjectMap<PendingWrites> pendingWritesMap = new IntObjectHashMap<>();\n \n-    public Http1ObjectEncoder(Channel ch, boolean server, boolean isTls) {\n+    protected Http1ObjectEncoder(Channel ch, SessionProtocol protocol) {\n         this.ch = requireNonNull(ch, \"ch\");\n-        this.server = server;\n-        this.isTls = isTls;\n+        this.protocol = requireNonNull(protocol, \"protocol\");\n     }\n \n     @Override\n     protected Channel channel() {\n         return ch;\n     }\n \n-    @Override\n-    protected ChannelFuture doWriteHeaders(int id, int streamId, HttpHeaders headers, boolean endStream) {\n-        if (!isWritable(id)) {\n-            return newClosedSessionFuture();\n-        }\n-\n-        try {\n-            return server ? writeServerHeaders(id, streamId, headers, endStream)\n-                          : writeClientHeaders(id, streamId, headers, endStream);\n-        } catch (Throwable t) {\n-            return newFailedFuture(t);\n-        }\n-    }\n-\n-    private ChannelFuture writeServerHeaders(\n-            int id, int streamId, HttpHeaders headers, boolean endStream) throws Http2Exception {\n-\n-        final HttpObject converted = convertServerHeaders(streamId, headers, endStream);\n-        final String status = headers.get(HttpHeaderNames.STATUS);\n-        if (status == null) {\n-            // Trailers\n-            final ChannelFuture f = write(id, converted, endStream);\n-            ch.flush();\n-            return f;\n-        }\n-\n-        if (!status.isEmpty() && status.charAt(0) == '1') {\n-            // Informational status headers.\n-            final ChannelFuture f = write(id, converted, false);\n-            if (endStream) {\n-                // Can't end a stream with informational status in HTTP/1.\n-                f.addListener(ChannelFutureListener.CLOSE);\n-            }\n-            ch.flush();\n-            return f;\n-        }\n-\n-        // Non-informational status headers.\n-        return writeNonInformationalHeaders(id, converted, endStream);\n-    }\n-\n-    private ChannelFuture writeClientHeaders(\n-            int id, int streamId, HttpHeaders headers, boolean endStream) throws Http2Exception {\n-\n-        return writeNonInformationalHeaders(id, convertClientHeaders(streamId, headers, endStream), endStream);\n-    }\n-\n-    private ChannelFuture writeNonInformationalHeaders(int id, HttpObject converted, boolean endStream) {\n+    protected ChannelFuture writeNonInformationalHeaders(int id, HttpObject converted, boolean endStream) {", "originalCommit": "dcb40799eef7e1c605950c26f329a9e050826258", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAyODcwNw==", "url": "https://github.com/line/armeria/pull/2372#discussion_r386028707", "bodyText": "I revert this to move ServerHttp1ObjectEncoder to armeria.internal.server package and ClientHttp1ObjectEncoder to armeria.internal.client.", "author": "jyblue", "createdAt": "2020-02-29T13:33:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDIzODE4NQ=="}], "type": "inlineReview", "revised_code": {"commit": "39edd429593ac1a12fdf95c897223dd7e0455788", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/internal/common/Http1ObjectEncoder.java b/core/src/main/java/com/linecorp/armeria/internal/common/Http1ObjectEncoder.java\nindex 348bbe492..7cc3c31b2 100644\n--- a/core/src/main/java/com/linecorp/armeria/internal/common/Http1ObjectEncoder.java\n+++ b/core/src/main/java/com/linecorp/armeria/internal/common/Http1ObjectEncoder.java\n\n@@ -95,12 +95,12 @@ public abstract class Http1ObjectEncoder extends HttpObjectEncoder {\n     }\n \n     @Override\n-    protected Channel channel() {\n+    protected final Channel channel() {\n         return ch;\n     }\n \n-    protected ChannelFuture writeNonInformationalHeaders(int id, HttpObject converted, boolean endStream) {\n-\n+    protected final ChannelFuture writeNonInformationalHeaders(int id, HttpObject converted,\n+                                                               boolean endStream) {\n         ChannelFuture f;\n         if (converted instanceof LastHttpContent) {\n             assert endStream;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDIzOTY5Ng==", "url": "https://github.com/line/armeria/pull/2372#discussion_r384239696", "bodyText": "Remove remoteAdress field of class? It seems not to use anymore.", "author": "ikhoon", "createdAt": "2020-02-26T02:12:22Z", "path": "core/src/main/java/com/linecorp/armeria/client/HttpRequestSubscriber.java", "diffHunk": "@@ -172,65 +163,19 @@ private void writeFirstHeader() {\n             return;\n         }\n \n-        final RequestHeaders firstHeaders = autoFillHeaders();\n+        final RequestHeaders firstHeaders = request.headers();\n \n         final SessionProtocol protocol = session.protocol();\n         assert protocol != null;\n         logBuilder.requestHeaders(firstHeaders);\n \n         if (request.isEmpty()) {\n             state = State.DONE;\n-            write0(firstHeaders, true, true);\n+            write0(firstHeaders, true, true, reqCtx.additionalRequestHeaders());\n         } else {\n             state = State.NEEDS_DATA_OR_TRAILERS;\n-            write0(firstHeaders, false, true);\n-        }\n-    }\n-\n-    private RequestHeaders autoFillHeaders() {\n-        final RequestHeaders oldHeaders = request.headers();\n-        final RequestHeadersBuilder newHeaders = oldHeaders.toBuilder();\n-\n-        final HttpHeaders additionalHeaders = reqCtx.additionalRequestHeaders();\n-        if (!additionalHeaders.isEmpty()) {\n-            for (AsciiString name : additionalHeaders.names()) {\n-                if (!ADDITIONAL_HEADER_BLACKLIST.contains(name)) {\n-                    newHeaders.remove(name);\n-                    additionalHeaders.forEachValue(name, value -> newHeaders.add(name, value));\n-                }\n-            }\n-        }\n-\n-        if (!newHeaders.contains(HttpHeaderNames.USER_AGENT)) {\n-            newHeaders.add(HttpHeaderNames.USER_AGENT, HttpHeaderUtil.USER_AGENT.toString());\n+            write0(firstHeaders, false, true, reqCtx.additionalRequestHeaders());\n         }\n-\n-        // :scheme and :authority are auto-filled in the beginning of decorator chain,\n-        // but a decorator might have removed them, so we check again.\n-        final SessionProtocol sessionProtocol = reqCtx.sessionProtocol();\n-        if (newHeaders.scheme() == null) {\n-            newHeaders.scheme(sessionProtocol);\n-        }\n-\n-        if (newHeaders.authority() == null) {\n-            final String hostname = remoteAddress.getHostName();", "originalCommit": "dcb40799eef7e1c605950c26f329a9e050826258", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc4MTE3Ng==", "url": "https://github.com/line/armeria/pull/2372#discussion_r384781176", "bodyText": "Removed. I also removed `HttpSessionHandler.removeAddress' too.", "author": "jyblue", "createdAt": "2020-02-26T21:36:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDIzOTY5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "de3ea3c0e525c6621d715d1d4221b455e020ca06", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/HttpRequestSubscriber.java b/core/src/main/java/com/linecorp/armeria/client/HttpRequestSubscriber.java\nindex 78294af91..684f01987 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/HttpRequestSubscriber.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/HttpRequestSubscriber.java\n\n@@ -171,11 +167,18 @@ final class HttpRequestSubscriber implements Subscriber<HttpObject>, ChannelFutu\n \n         if (request.isEmpty()) {\n             state = State.DONE;\n-            write0(firstHeaders, true, true, reqCtx.additionalRequestHeaders());\n         } else {\n             state = State.NEEDS_DATA_OR_TRAILERS;\n-            write0(firstHeaders, false, true, reqCtx.additionalRequestHeaders());\n         }\n+\n+        if (isStreamOrSessionClosed()) {\n+            return;\n+        }\n+\n+        final ChannelFuture future = encoder.writeHeaders(id, streamId(), firstHeaders, request.isEmpty(),\n+                                                          reqCtx.additionalRequestHeaders(), HttpHeaders.of());\n+        future.addListener(this);\n+        ch.flush();\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDI0MTQ1NQ==", "url": "https://github.com/line/armeria/pull/2372#discussion_r384241455", "bodyText": "nit: I'm not strong here, but could simplify a little. \ud83d\ude00\nif (request.isEmpty()) {\n    state = State.DONE;\n} else {\n    state = State.NEEDS_DATA_OR_TRAILERS;\n}\nwrite0(firstHeaders, request.isEmpty(), true, reqCtx.additionalRequestHeaders());", "author": "ikhoon", "createdAt": "2020-02-26T02:19:26Z", "path": "core/src/main/java/com/linecorp/armeria/client/HttpRequestSubscriber.java", "diffHunk": "@@ -172,65 +163,19 @@ private void writeFirstHeader() {\n             return;\n         }\n \n-        final RequestHeaders firstHeaders = autoFillHeaders();\n+        final RequestHeaders firstHeaders = request.headers();\n \n         final SessionProtocol protocol = session.protocol();\n         assert protocol != null;\n         logBuilder.requestHeaders(firstHeaders);\n \n         if (request.isEmpty()) {\n             state = State.DONE;\n-            write0(firstHeaders, true, true);\n+            write0(firstHeaders, true, true, reqCtx.additionalRequestHeaders());\n         } else {\n             state = State.NEEDS_DATA_OR_TRAILERS;\n-            write0(firstHeaders, false, true);\n-        }\n-    }\n-\n-    private RequestHeaders autoFillHeaders() {\n-        final RequestHeaders oldHeaders = request.headers();\n-        final RequestHeadersBuilder newHeaders = oldHeaders.toBuilder();\n-\n-        final HttpHeaders additionalHeaders = reqCtx.additionalRequestHeaders();\n-        if (!additionalHeaders.isEmpty()) {\n-            for (AsciiString name : additionalHeaders.names()) {\n-                if (!ADDITIONAL_HEADER_BLACKLIST.contains(name)) {\n-                    newHeaders.remove(name);\n-                    additionalHeaders.forEachValue(name, value -> newHeaders.add(name, value));\n-                }\n-            }\n-        }\n-\n-        if (!newHeaders.contains(HttpHeaderNames.USER_AGENT)) {\n-            newHeaders.add(HttpHeaderNames.USER_AGENT, HttpHeaderUtil.USER_AGENT.toString());\n+            write0(firstHeaders, false, true, reqCtx.additionalRequestHeaders());", "originalCommit": "dcb40799eef7e1c605950c26f329a9e050826258", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc4MDIyOQ==", "url": "https://github.com/line/armeria/pull/2372#discussion_r384780229", "bodyText": "Fixed it.", "author": "jyblue", "createdAt": "2020-02-26T21:34:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDI0MTQ1NQ=="}], "type": "inlineReview", "revised_code": {"commit": "de3ea3c0e525c6621d715d1d4221b455e020ca06", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/HttpRequestSubscriber.java b/core/src/main/java/com/linecorp/armeria/client/HttpRequestSubscriber.java\nindex 78294af91..684f01987 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/HttpRequestSubscriber.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/HttpRequestSubscriber.java\n\n@@ -171,11 +167,18 @@ final class HttpRequestSubscriber implements Subscriber<HttpObject>, ChannelFutu\n \n         if (request.isEmpty()) {\n             state = State.DONE;\n-            write0(firstHeaders, true, true, reqCtx.additionalRequestHeaders());\n         } else {\n             state = State.NEEDS_DATA_OR_TRAILERS;\n-            write0(firstHeaders, false, true, reqCtx.additionalRequestHeaders());\n         }\n+\n+        if (isStreamOrSessionClosed()) {\n+            return;\n+        }\n+\n+        final ChannelFuture future = encoder.writeHeaders(id, streamId(), firstHeaders, request.isEmpty(),\n+                                                          reqCtx.additionalRequestHeaders(), HttpHeaders.of());\n+        future.addListener(this);\n+        ch.flush();\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDI0OTA1NA==", "url": "https://github.com/line/armeria/pull/2372#discussion_r384249054", "bodyText": "How about reviving writeHeaders(int id, int streamId, HttpHeaders headers, boolean endStream) and offering two versions of writerHeaders?\nBecause 1) we don't need to merge HTTP headers if there's no additional headers or tailers so it makes our code easy to optimize the performance. And 2) don't have to pass empty headers here(https://github.com/line/armeria/pull/2372/files#diff-f4134a31b2a8d080bf8fa97afccc2880R240)\n// for empty additional headers and tailers.\npublic final ChannelFuture writeHeaders(int id, int streamId, HttpHeaders headers, boolean endStream) { \n    // skip merging logic, directly convert to Netty headers\n    ... \n}\npublic final ChannelFuture writeHeaders(int id, int streamId, HttpHeaders headers, boolean endStream, HttpHeaders additionalHeaders, HttpHeaders additionalTrailers) {\n\tif (addtionalHeaders.isEmpty() && additionalTrailers.isEmpty()) {\n\t\treturn writeHeaders(id, streamId, headers);\n    }\n    ... \n}", "author": "ikhoon", "createdAt": "2020-02-26T02:51:05Z", "path": "core/src/main/java/com/linecorp/armeria/internal/common/HttpObjectEncoder.java", "diffHunk": "@@ -45,19 +45,21 @@ protected EventLoop eventLoop() {\n     /**\n      * Writes an {@link HttpHeaders}.\n      */\n-    public final ChannelFuture writeHeaders(int id, int streamId, HttpHeaders headers, boolean endStream) {\n-\n+    public final ChannelFuture writeHeaders(int id, int streamId, HttpHeaders headers, boolean endStream,\n+                                            HttpHeaders additionalHeaders, HttpHeaders additionalTrailers) {", "originalCommit": "dcb40799eef7e1c605950c26f329a9e050826258", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc5ODcxNg==", "url": "https://github.com/line/armeria/pull/2372#discussion_r384798716", "bodyText": "Yes, I think it's good idea. I will update this soon \ud83d\ude00", "author": "jyblue", "createdAt": "2020-02-26T22:11:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDI0OTA1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDk0MDg0Nw==", "url": "https://github.com/line/armeria/pull/2372#discussion_r384940847", "bodyText": "It seems weird to me that this writeHeaders method has both additionalHeaders and additionalTrailers which cannot be used at the same time.\nHow about splitting writeHeaders to writeHeaders and writeTrailers?", "author": "minwoox", "createdAt": "2020-02-27T06:52:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDI0OTA1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAyNTk3Nw==", "url": "https://github.com/line/armeria/pull/2372#discussion_r386025977", "bodyText": "I think additionalHeaders and additionalTrailers can be used at the same time when request headers end with additional trailers. (Do I understand correctly? \ud83e\udd14 )\nIt seems that it may happens here now.\n\n  \n    \n      armeria/core/src/main/java/com/linecorp/armeria/server/HttpResponseSubscriber.java\n    \n    \n         Line 174\n      in\n      48f4132\n    \n    \n    \n    \n\n        \n          \n           fillAdditionalTrailers(newHeaders, additionalTrailers); \n        \n    \n  \n\n\nDo you think we need all possible overrides for this method?\npublic final ChannelFuture writeHeaders(int id, int streamId, HttpHeaders headers, boolean endStream)\npublic final ChannelFuture writeHeaders(int id, int streamId, HttpHeaders headers, boolean endStream, HttpHeaders additionalHeaders)\npublic final ChannelFuture writeTrailers(int id, int streamId, HttpHeaders headers, boolean endStream, HttpHeaders additionalTrailers)\npublic final ChannelFuture writeHeaders(int id, int streamId, HttpHeaders headers, boolean endStream, HttpHeaders additionalHeaders, HttpHeaders additionalTrailers)", "author": "jyblue", "createdAt": "2020-02-29T12:44:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDI0OTA1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAyNjU3NA==", "url": "https://github.com/line/armeria/pull/2372#discussion_r388026574", "bodyText": "It seems that it may happens here now.\n\nI think it's a bug so I fixed it. \ud83d\ude04\n#2544\nAfter this is merged, I think we can split the method to writeHeaders and writeTrailers. Sorry about the bug. \ud83d\ude09", "author": "minwoox", "createdAt": "2020-03-05T01:10:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDI0OTA1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA4NjMxMg==", "url": "https://github.com/line/armeria/pull/2372#discussion_r390086312", "bodyText": "#2544 has been fixed. @jyblue, could you rebase and squash into a single commit, since the history is getting pretty large?", "author": "trustin", "createdAt": "2020-03-10T04:12:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDI0OTA1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYzNTU2Mw==", "url": "https://github.com/line/armeria/pull/2372#discussion_r390635563", "bodyText": "I squashed and rebase commit. I will also split writeHeaders methods soon. \ud83d\ude47\u200d\u2642\ufe0f", "author": "jyblue", "createdAt": "2020-03-10T21:58:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDI0OTA1NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDI1MzAzOA==", "url": "https://github.com/line/armeria/pull/2372#discussion_r384253038", "bodyText": "Could Move these to under if condition?\nif (isStreamPresentAndWritable(streamId)) {\n    final boolean isTrailer = !headers.contains(HttpHeaderNames.STATUS);\n    final Http2Headers convertedHeaders;", "author": "ikhoon", "createdAt": "2020-02-26T03:08:51Z", "path": "core/src/main/java/com/linecorp/armeria/internal/common/ServerHttp2ObjectEncoder.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.common;\n+\n+import com.linecorp.armeria.common.HttpHeaderNames;\n+import com.linecorp.armeria.common.HttpHeaders;\n+import com.linecorp.armeria.common.stream.ClosedStreamException;\n+import com.linecorp.armeria.internal.common.util.HttpTimestampSupplier;\n+\n+import io.netty.channel.ChannelFuture;\n+import io.netty.channel.ChannelHandlerContext;\n+import io.netty.handler.codec.http2.Http2ConnectionEncoder;\n+import io.netty.handler.codec.http2.Http2Headers;\n+\n+public final class ServerHttp2ObjectEncoder extends Http2ObjectEncoder {\n+    private final boolean enableServerHeader;\n+    private final boolean enableDateHeader;\n+\n+    public ServerHttp2ObjectEncoder(ChannelHandlerContext ctx, Http2ConnectionEncoder encoder,\n+                                       boolean enableServerHeader, boolean enableDateHeader) {\n+        super(ctx, encoder);\n+        this.enableServerHeader = enableServerHeader;\n+        this.enableDateHeader = enableDateHeader;\n+    }\n+\n+    @Override\n+    protected ChannelFuture doWriteHeaders(int id, int streamId, HttpHeaders headers, boolean endStream,\n+                                           HttpHeaders additionalHeaders, HttpHeaders additionalTrailers) {\n+        final boolean isTrailer = !headers.contains(HttpHeaderNames.STATUS);\n+        final Http2Headers convertedHeaders;", "originalCommit": "dcb40799eef7e1c605950c26f329a9e050826258", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc4MDAzMw==", "url": "https://github.com/line/armeria/pull/2372#discussion_r384780033", "bodyText": "Fixed it.", "author": "jyblue", "createdAt": "2020-02-26T21:34:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDI1MzAzOA=="}], "type": "inlineReview", "revised_code": {"commit": "de3ea3c0e525c6621d715d1d4221b455e020ca06", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/internal/common/ServerHttp2ObjectEncoder.java b/core/src/main/java/com/linecorp/armeria/internal/server/ServerHttp2ObjectEncoder.java\nsimilarity index 93%\nrename from core/src/main/java/com/linecorp/armeria/internal/common/ServerHttp2ObjectEncoder.java\nrename to core/src/main/java/com/linecorp/armeria/internal/server/ServerHttp2ObjectEncoder.java\nindex a5dfc6c79..044fbec51 100644\n--- a/core/src/main/java/com/linecorp/armeria/internal/common/ServerHttp2ObjectEncoder.java\n+++ b/core/src/main/java/com/linecorp/armeria/internal/server/ServerHttp2ObjectEncoder.java\n\n@@ -14,11 +14,13 @@\n  * under the License.\n  */\n \n-package com.linecorp.armeria.internal.common;\n+package com.linecorp.armeria.internal.server;\n \n import com.linecorp.armeria.common.HttpHeaderNames;\n import com.linecorp.armeria.common.HttpHeaders;\n import com.linecorp.armeria.common.stream.ClosedStreamException;\n+import com.linecorp.armeria.internal.common.ArmeriaHttpUtil;\n+import com.linecorp.armeria.internal.common.Http2ObjectEncoder;\n import com.linecorp.armeria.internal.common.util.HttpTimestampSupplier;\n \n import io.netty.channel.ChannelFuture;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzODA2OQ==", "url": "https://github.com/line/armeria/pull/2372#discussion_r384938069", "bodyText": "Time flies! \ud83d\ude09", "author": "trustin", "createdAt": "2020-02-27T06:42:04Z", "path": "benchmarks/src/jmh/java/com/linecorp/armeria/common/HttpRequestHeaderConversionBenchmark.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Copyright 2019 LINE Corporation", "originalCommit": "59e88e87c0c81fed094a8e6154e6c148bc27f598", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM5MjI3Ng==", "url": "https://github.com/line/armeria/pull/2372#discussion_r385392276", "bodyText": "Should I update all modified files or just newly created one? \ud83e\udd14", "author": "jyblue", "createdAt": "2020-02-27T21:51:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzODA2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ2MDQwNA==", "url": "https://github.com/line/armeria/pull/2372#discussion_r385460404", "bodyText": "newly created one. \ud83d\ude04", "author": "minwoox", "createdAt": "2020-02-28T01:14:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzODA2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk0OTkyNQ==", "url": "https://github.com/line/armeria/pull/2372#discussion_r385949925", "bodyText": "Thank you, fixed it.", "author": "jyblue", "createdAt": "2020-02-28T22:23:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzODA2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "de3ea3c0e525c6621d715d1d4221b455e020ca06", "chunk": "diff --git a/benchmarks/src/jmh/java/com/linecorp/armeria/common/HttpRequestHeaderConversionBenchmark.java b/benchmarks/src/jmh/java/com/linecorp/armeria/common/HttpRequestHeaderConversionBenchmark.java\nindex b66416874..9a893c3a5 100644\n--- a/benchmarks/src/jmh/java/com/linecorp/armeria/common/HttpRequestHeaderConversionBenchmark.java\n+++ b/benchmarks/src/jmh/java/com/linecorp/armeria/common/HttpRequestHeaderConversionBenchmark.java\n\n@@ -1,5 +1,5 @@\n /*\n- * Copyright 2019 LINE Corporation\n+ * Copyright 2020 LINE Corporation\n  *\n  * LINE Corporation licenses this file to you under the Apache License,\n  * version 2.0 (the \"License\"); you may not use this file except in compliance\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzODM0Mw==", "url": "https://github.com/line/armeria/pull/2372#discussion_r384938343", "bodyText": "Could we move this to armeria.internal.client?", "author": "trustin", "createdAt": "2020-02-27T06:43:04Z", "path": "core/src/main/java/com/linecorp/armeria/internal/HttpHeaderUtil.java", "diffHunk": "@@ -14,25 +14,20 @@\n  * under the License.\n  */\n \n-package com.linecorp.armeria.client;\n+package com.linecorp.armeria.internal;", "originalCommit": "59e88e87c0c81fed094a8e6154e6c148bc27f598", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk1MDIzOQ==", "url": "https://github.com/line/armeria/pull/2372#discussion_r385950239", "bodyText": "Moved to armeria.internal.client package.", "author": "jyblue", "createdAt": "2020-02-28T22:23:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzODM0Mw=="}], "type": "inlineReview", "revised_code": {"commit": "de3ea3c0e525c6621d715d1d4221b455e020ca06", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/internal/HttpHeaderUtil.java b/core/src/main/java/com/linecorp/armeria/internal/client/HttpHeaderUtil.java\nsimilarity index 96%\nrename from core/src/main/java/com/linecorp/armeria/internal/HttpHeaderUtil.java\nrename to core/src/main/java/com/linecorp/armeria/internal/client/HttpHeaderUtil.java\nindex 2671e0ff3..8927fac0d 100644\n--- a/core/src/main/java/com/linecorp/armeria/internal/HttpHeaderUtil.java\n+++ b/core/src/main/java/com/linecorp/armeria/internal/client/HttpHeaderUtil.java\n\n@@ -14,7 +14,7 @@\n  * under the License.\n  */\n \n-package com.linecorp.armeria.internal;\n+package com.linecorp.armeria.internal.client;\n \n import com.linecorp.armeria.common.util.Version;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzODg2Mg==", "url": "https://github.com/line/armeria/pull/2372#discussion_r384938862", "bodyText": "How about using add() instead of shortcut methods for better performance?", "author": "trustin", "createdAt": "2020-02-27T06:45:02Z", "path": "core/src/main/java/com/linecorp/armeria/internal/common/ClientHttp2ObjectEncoder.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.common;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.InetSocketAddress;\n+\n+import com.linecorp.armeria.common.HttpHeaderNames;\n+import com.linecorp.armeria.common.HttpHeaders;\n+import com.linecorp.armeria.common.SessionProtocol;\n+import com.linecorp.armeria.common.stream.ClosedStreamException;\n+import com.linecorp.armeria.internal.HttpHeaderUtil;\n+\n+import io.netty.channel.ChannelFuture;\n+import io.netty.channel.ChannelHandlerContext;\n+import io.netty.handler.codec.http2.Http2Connection;\n+import io.netty.handler.codec.http2.Http2ConnectionEncoder;\n+import io.netty.handler.codec.http2.Http2Headers;\n+\n+public final class ClientHttp2ObjectEncoder extends Http2ObjectEncoder {\n+    private final SessionProtocol protocol;\n+\n+    public ClientHttp2ObjectEncoder(ChannelHandlerContext ctx, Http2ConnectionEncoder encoder,\n+                                       SessionProtocol protocol) {\n+        super(ctx, encoder);\n+        this.protocol = requireNonNull(protocol, \"protocol\");\n+    }\n+\n+    @Override\n+    protected ChannelFuture doWriteHeaders(int id, int streamId, HttpHeaders headers, boolean endStream,\n+                                           HttpHeaders additionalHeaders, HttpHeaders additionalTrailers) {\n+        final Http2Connection conn = encoder().connection();\n+        final boolean isTrailer = !headers.contains(HttpHeaderNames.METHOD);\n+        final Http2Headers convertedHeaders;\n+\n+        if (isStreamPresentAndWritable(streamId)) {\n+            if (!isTrailer) {\n+                convertedHeaders = convertHeaders(headers, additionalHeaders, additionalTrailers);\n+            } else {\n+                convertedHeaders = convertTrailers(headers, additionalTrailers);\n+            }\n+            // Writing to an existing stream.\n+            return encoder().writeHeaders(ctx(), streamId, convertedHeaders, 0, endStream,\n+                                          ctx().newPromise());\n+        }\n+\n+        if (conn.local().mayHaveCreatedStream(streamId)) {\n+            // Stream has been closed.\n+            return newFailedFuture(ClosedStreamException.get());\n+        }\n+\n+        if (!isTrailer) {\n+            convertedHeaders = convertHeaders(headers, additionalHeaders, additionalTrailers);\n+        } else {\n+            convertedHeaders = convertTrailers(headers, additionalTrailers);\n+        }\n+\n+        // Client starts a new stream.\n+        return encoder().writeHeaders(ctx(), streamId, convertedHeaders, 0, endStream,\n+                                      ctx().newPromise());\n+    }\n+\n+    private Http2Headers convertHeaders(\n+            HttpHeaders inputHeaders, HttpHeaders additionalHeaders, HttpHeaders additionalTrailers) {\n+        final Http2Headers outputHeaders =\n+                ArmeriaHttpUtil.toNettyHttp2Client(inputHeaders, additionalHeaders, additionalTrailers, false);\n+\n+        if (!outputHeaders.contains(HttpHeaderNames.USER_AGENT)) {\n+            outputHeaders.add(HttpHeaderNames.USER_AGENT, HttpHeaderUtil.USER_AGENT.toString());\n+        }\n+\n+        if (!outputHeaders.contains(HttpHeaderNames.SCHEME)) {\n+            outputHeaders.scheme(protocol.isTls() ? SessionProtocol.HTTPS.uriText()", "originalCommit": "59e88e87c0c81fed094a8e6154e6c148bc27f598", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk1MDAzMQ==", "url": "https://github.com/line/armeria/pull/2372#discussion_r385950031", "bodyText": "Fixed it \ud83d\udc4d", "author": "jyblue", "createdAt": "2020-02-28T22:23:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzODg2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "de3ea3c0e525c6621d715d1d4221b455e020ca06", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/internal/common/ClientHttp2ObjectEncoder.java b/core/src/main/java/com/linecorp/armeria/internal/client/ClientHttp2ObjectEncoder.java\nsimilarity index 91%\nrename from core/src/main/java/com/linecorp/armeria/internal/common/ClientHttp2ObjectEncoder.java\nrename to core/src/main/java/com/linecorp/armeria/internal/client/ClientHttp2ObjectEncoder.java\nindex 65d7bcabe..3fde983fd 100644\n--- a/core/src/main/java/com/linecorp/armeria/internal/common/ClientHttp2ObjectEncoder.java\n+++ b/core/src/main/java/com/linecorp/armeria/internal/client/ClientHttp2ObjectEncoder.java\n\n@@ -14,7 +14,7 @@\n  * under the License.\n  */\n \n-package com.linecorp.armeria.internal.common;\n+package com.linecorp.armeria.internal.client;\n \n import static java.util.Objects.requireNonNull;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzOTIzNg==", "url": "https://github.com/line/armeria/pull/2372#discussion_r384939236", "bodyText": "Could be armeria.internal.server", "author": "trustin", "createdAt": "2020-02-27T06:46:24Z", "path": "core/src/main/java/com/linecorp/armeria/internal/common/ServerHttp1ObjectEncoder.java", "diffHunk": "@@ -0,0 +1,184 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.common;", "originalCommit": "59e88e87c0c81fed094a8e6154e6c148bc27f598", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk1MDY4OQ==", "url": "https://github.com/line/armeria/pull/2372#discussion_r385950689", "bodyText": "Moved ServerHttp1ObjectEncoder, ServerHttp2ObjectEncoder to armeria.internal.server package.\nAnd also moved ClientHttp1ObjectEncoder, ClientHttp2ObjectEncoder to armeria.internal.client.", "author": "jyblue", "createdAt": "2020-02-28T22:25:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzOTIzNg=="}], "type": "inlineReview", "revised_code": {"commit": "de3ea3c0e525c6621d715d1d4221b455e020ca06", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/internal/common/ServerHttp1ObjectEncoder.java b/core/src/main/java/com/linecorp/armeria/internal/server/ServerHttp1ObjectEncoder.java\nsimilarity index 97%\nrename from core/src/main/java/com/linecorp/armeria/internal/common/ServerHttp1ObjectEncoder.java\nrename to core/src/main/java/com/linecorp/armeria/internal/server/ServerHttp1ObjectEncoder.java\nindex df9c49bd1..c1530bce5 100644\n--- a/core/src/main/java/com/linecorp/armeria/internal/common/ServerHttp1ObjectEncoder.java\n+++ b/core/src/main/java/com/linecorp/armeria/internal/server/ServerHttp1ObjectEncoder.java\n\n@@ -14,13 +14,15 @@\n  * under the License.\n  */\n \n-package com.linecorp.armeria.internal.common;\n+package com.linecorp.armeria.internal.server;\n \n import com.linecorp.armeria.common.HttpHeaderNames;\n import com.linecorp.armeria.common.HttpHeaders;\n import com.linecorp.armeria.common.HttpStatus;\n import com.linecorp.armeria.common.HttpStatusClass;\n import com.linecorp.armeria.common.SessionProtocol;\n+import com.linecorp.armeria.internal.common.ArmeriaHttpUtil;\n+import com.linecorp.armeria.internal.common.Http1ObjectEncoder;\n import com.linecorp.armeria.internal.common.util.HttpTimestampSupplier;\n \n import io.netty.buffer.Unpooled;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzOTMxMg==", "url": "https://github.com/line/armeria/pull/2372#discussion_r384939312", "bodyText": "Ditto", "author": "trustin", "createdAt": "2020-02-27T06:46:39Z", "path": "core/src/main/java/com/linecorp/armeria/internal/common/ServerHttp2ObjectEncoder.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.common;", "originalCommit": "59e88e87c0c81fed094a8e6154e6c148bc27f598", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "de3ea3c0e525c6621d715d1d4221b455e020ca06", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/internal/common/ServerHttp2ObjectEncoder.java b/core/src/main/java/com/linecorp/armeria/internal/server/ServerHttp2ObjectEncoder.java\nsimilarity index 96%\nrename from core/src/main/java/com/linecorp/armeria/internal/common/ServerHttp2ObjectEncoder.java\nrename to core/src/main/java/com/linecorp/armeria/internal/server/ServerHttp2ObjectEncoder.java\nindex a2200a8b8..044fbec51 100644\n--- a/core/src/main/java/com/linecorp/armeria/internal/common/ServerHttp2ObjectEncoder.java\n+++ b/core/src/main/java/com/linecorp/armeria/internal/server/ServerHttp2ObjectEncoder.java\n\n@@ -14,11 +14,13 @@\n  * under the License.\n  */\n \n-package com.linecorp.armeria.internal.common;\n+package com.linecorp.armeria.internal.server;\n \n import com.linecorp.armeria.common.HttpHeaderNames;\n import com.linecorp.armeria.common.HttpHeaders;\n import com.linecorp.armeria.common.stream.ClosedStreamException;\n+import com.linecorp.armeria.internal.common.ArmeriaHttpUtil;\n+import com.linecorp.armeria.internal.common.Http2ObjectEncoder;\n import com.linecorp.armeria.internal.common.util.HttpTimestampSupplier;\n \n import io.netty.channel.ChannelFuture;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDk0MjA2OA==", "url": "https://github.com/line/armeria/pull/2372#discussion_r384942068", "bodyText": "It seems weird to me that the write0 is called with HttpData and trailers(even though it's empty.)\nHow about just inlining write0 method? We can extract the common part to another method then. \ud83e\udd14", "author": "minwoox", "createdAt": "2020-02-27T06:56:50Z", "path": "core/src/main/java/com/linecorp/armeria/client/HttpRequestSubscriber.java", "diffHunk": "@@ -292,10 +232,10 @@ private void write(HttpObject o, boolean endOfStream, boolean flush) {\n             state = State.DONE;\n         }\n \n-        write0(o, endOfStream, flush);\n+        write0(o, endOfStream, flush, HttpHeaders.of());", "originalCommit": "59e88e87c0c81fed094a8e6154e6c148bc27f598", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAyNjE1Ng==", "url": "https://github.com/line/armeria/pull/2372#discussion_r386026156", "bodyText": "I inlined write0() and extracted some common lines to another method. PTAL.", "author": "jyblue", "createdAt": "2020-02-29T12:47:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDk0MjA2OA=="}], "type": "inlineReview", "revised_code": {"commit": "de3ea3c0e525c6621d715d1d4221b455e020ca06", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/HttpRequestSubscriber.java b/core/src/main/java/com/linecorp/armeria/client/HttpRequestSubscriber.java\nindex 717d891d5..684f01987 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/HttpRequestSubscriber.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/HttpRequestSubscriber.java\n\n@@ -232,10 +240,23 @@ final class HttpRequestSubscriber implements Subscriber<HttpObject>, ChannelFutu\n             state = State.DONE;\n         }\n \n-        write0(o, endOfStream, flush, HttpHeaders.of());\n+        if (isStreamOrSessionClosed()) {\n+            return;\n+        }\n+\n+        final ChannelFuture future;\n+        if (o instanceof HttpHeaders) {\n+            future = encoder.writeHeaders(id, streamId(), (HttpHeaders) o, endOfStream,\n+                                          HttpHeaders.of(), HttpHeaders.of());\n+        } else {\n+            future = encoder.writeData(id, streamId(), (HttpData) o, endOfStream);\n+        }\n+\n+        future.addListener(this);\n+        ch.flush();\n     }\n \n-    private void write0(HttpObject o, boolean endOfStream, boolean flush, HttpHeaders additionalHeaders) {\n+    private boolean isStreamOrSessionClosed() {\n         // Make sure that a stream exists before writing data if first bytes were transferred.\n         // The following situation may cause the data to be written to a closed stream.\n         // 1. A connection that has pending outbound buffers receives GOAWAY frame.\n"}}, {"oid": "de3ea3c0e525c6621d715d1d4221b455e020ca06", "url": "https://github.com/line/armeria/commit/de3ea3c0e525c6621d715d1d4221b455e020ca06", "message": "Inline `HttpRequestSubscriber.write0()`", "committedDate": "2020-02-28T22:16:21Z", "type": "forcePushed"}, {"oid": "d13565c88bd382876ad62fb24d1fada977338188", "url": "https://github.com/line/armeria/commit/d13565c88bd382876ad62fb24d1fada977338188", "message": "Inline `HttpRequestSubscriber.write0()`", "committedDate": "2020-02-28T22:21:11Z", "type": "forcePushed"}, {"oid": "7b7e2cc10b2a1a7e5270fad10b469067f3cdd39a", "url": "https://github.com/line/armeria/commit/7b7e2cc10b2a1a7e5270fad10b469067f3cdd39a", "message": "Split more methods", "committedDate": "2020-02-29T13:22:48Z", "type": "forcePushed"}, {"oid": "8958c66695a451c930feb5e71a59f3c506a72dee", "url": "https://github.com/line/armeria/commit/8958c66695a451c930feb5e71a59f3c506a72dee", "message": "Split more methods", "committedDate": "2020-02-29T13:38:24Z", "type": "forcePushed"}, {"oid": "5e5f53d43e07c5ba0559b944c89ab10548e22a86", "url": "https://github.com/line/armeria/commit/5e5f53d43e07c5ba0559b944c89ab10548e22a86", "message": "Split more methods", "committedDate": "2020-02-29T15:12:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMyMDc2Mw==", "url": "https://github.com/line/armeria/pull/2372#discussion_r388320763", "bodyText": "Please make all protected methods in this class final if possible.", "author": "trustin", "createdAt": "2020-03-05T14:18:17Z", "path": "core/src/main/java/com/linecorp/armeria/internal/common/Http1ObjectEncoder.java", "diffHunk": "@@ -38,30 +35,19 @@\n import io.netty.channel.ChannelFuture;\n import io.netty.channel.ChannelFutureListener;\n import io.netty.channel.ChannelPromise;\n-import io.netty.handler.codec.http.DefaultFullHttpResponse;\n import io.netty.handler.codec.http.DefaultHttpContent;\n-import io.netty.handler.codec.http.DefaultHttpRequest;\n-import io.netty.handler.codec.http.DefaultHttpResponse;\n import io.netty.handler.codec.http.DefaultLastHttpContent;\n import io.netty.handler.codec.http.HttpContent;\n-import io.netty.handler.codec.http.HttpHeaderValues;\n-import io.netty.handler.codec.http.HttpMessage;\n-import io.netty.handler.codec.http.HttpMethod;\n+import io.netty.handler.codec.http.HttpHeaders;\n import io.netty.handler.codec.http.HttpObject;\n-import io.netty.handler.codec.http.HttpRequest;\n-import io.netty.handler.codec.http.HttpResponse;\n-import io.netty.handler.codec.http.HttpResponseStatus;\n-import io.netty.handler.codec.http.HttpUtil;\n-import io.netty.handler.codec.http.HttpVersion;\n import io.netty.handler.codec.http.LastHttpContent;\n import io.netty.handler.codec.http2.Http2Error;\n-import io.netty.handler.codec.http2.Http2Exception;\n import io.netty.handler.codec.http2.HttpConversionUtil.ExtensionHeaderNames;\n import io.netty.util.ReferenceCountUtil;\n import io.netty.util.collection.IntObjectHashMap;\n import io.netty.util.collection.IntObjectMap;\n \n-public final class Http1ObjectEncoder extends HttpObjectEncoder {\n+public abstract class Http1ObjectEncoder extends HttpObjectEncoder {", "originalCommit": "edad787c4db66b736258527dcb2605601b30b8ae", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMyMTA1Ng==", "url": "https://github.com/line/armeria/pull/2372#discussion_r388321056", "bodyText": "Please make all protected methods in this class final if possible.", "author": "trustin", "createdAt": "2020-03-05T14:18:45Z", "path": "core/src/main/java/com/linecorp/armeria/internal/common/Http2ObjectEncoder.java", "diffHunk": "@@ -19,25 +19,22 @@\n import static java.util.Objects.requireNonNull;\n \n import com.linecorp.armeria.common.HttpData;\n-import com.linecorp.armeria.common.HttpHeaders;\n import com.linecorp.armeria.common.stream.ClosedStreamException;\n \n import io.netty.buffer.Unpooled;\n import io.netty.channel.Channel;\n import io.netty.channel.ChannelFuture;\n import io.netty.channel.ChannelHandlerContext;\n-import io.netty.handler.codec.http2.Http2Connection;\n import io.netty.handler.codec.http2.Http2ConnectionEncoder;\n import io.netty.handler.codec.http2.Http2Error;\n import io.netty.handler.codec.http2.Http2Stream;\n import io.netty.util.ReferenceCountUtil;\n \n-public final class Http2ObjectEncoder extends HttpObjectEncoder {\n-\n+public abstract class Http2ObjectEncoder extends HttpObjectEncoder {", "originalCommit": "edad787c4db66b736258527dcb2605601b30b8ae", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "39edd429593ac1a12fdf95c897223dd7e0455788", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/internal/common/Http2ObjectEncoder.java b/core/src/main/java/com/linecorp/armeria/internal/common/Http2ObjectEncoder.java\nindex 66e107906..a2e509d19 100644\n--- a/core/src/main/java/com/linecorp/armeria/internal/common/Http2ObjectEncoder.java\n+++ b/core/src/main/java/com/linecorp/armeria/internal/common/Http2ObjectEncoder.java\n\n@@ -40,12 +40,12 @@ public abstract class Http2ObjectEncoder extends HttpObjectEncoder {\n     }\n \n     @Override\n-    protected Channel channel() {\n+    protected final Channel channel() {\n         return ctx.channel();\n     }\n \n     @Override\n-    protected ChannelFuture doWriteData(int id, int streamId, HttpData data, boolean endStream) {\n+    protected final ChannelFuture doWriteData(int id, int streamId, HttpData data, boolean endStream) {\n         if (isStreamPresentAndWritable(streamId)) {\n             // Write to an existing stream.\n             return encoder.writeData(ctx, streamId, toByteBuf(data), 0, endStream, ctx.newPromise());\n"}}, {"oid": "39edd429593ac1a12fdf95c897223dd7e0455788", "url": "https://github.com/line/armeria/commit/39edd429593ac1a12fdf95c897223dd7e0455788", "message": "WIP", "committedDate": "2020-03-08T20:18:34Z", "type": "forcePushed"}, {"oid": "3136f3185cd7bd0321308b0db8262e15e710224a", "url": "https://github.com/line/armeria/commit/3136f3185cd7bd0321308b0db8262e15e710224a", "message": "Streamline HTTP header/trailer validation and conversion\n\nMotivation:\n* Related #2096\n\nModifications:\n* Move and merge response header conversion process\nfrom `HttpResponseSubscriber`\nto `ArmeriaHttpUtil.toNettyHttp1()/ArmeriaHttpUtil.toNettyHttp2()`\n* Move and merge request header conversion process\nfrom `HttpRequestSubscriber`\nto `ArmeriaHttpUtil.toNettyHttp1()/ArmeriaHttpUtil.toNettyHttp2()`\n* Add parameters to `HttpObjectEncoder.writeHeaders()`\n`HttpHeaders additionalHeaders`,`HttpHeaders additionalTrailers`,\n`boolean enableServerHeader`,`boolean enableDateHeader`,\n`@Nullable SessionProtocol sessionProtocol`,\n`@Nullable String authorityHeader`, `@Nullable String userAgentHeader`\n\nResult:\n* Better HTTP header validation/conversion performance", "committedDate": "2020-03-10T21:52:50Z", "type": "forcePushed"}, {"oid": "e1d05976115ac412a9cd2cfd0b6df43ad943c0c7", "url": "https://github.com/line/armeria/commit/e1d05976115ac412a9cd2cfd0b6df43ad943c0c7", "message": "Streamline HTTP header/trailer validation and conversion\n\nMotivation:\n\nCurrently, user-provided HTTP headers and trailers are consumer by\n`HttpRequestSubscriber` and `HttpResponseSubscriber`. The following is\nthe basic header/trailer validation and conversion process:\n\n1. `Http*Subscriber` merges the `Request/ResponseHeaders` and\n   `ctx.additional*Headers()` while excluding some prohibited headers.\n2. `Http*Subscriber` passs the merged headers to `HttpObjectEncoder`.\n3. `HttpObjectEncoder` converts the merged headers while excluding some\n   more prohibited headers, using `ArmeriaHttpUtil`.\n\n(Pretty much same for trailers)\n\nInstead, we could streamline and optimize this process like the following:\n\n1. `Http*Subscriber` passes `Request/ResponseHeaders` and\n   `ctx.additional*Headers()`, without any validation or exclusion.\n2. `HttpObjectEncoder` converts the given headers while excluding\n   prohibited headers and merging `Request/ResponseHeaders` and\n   `ctx.additional*Headers()`.\n\nThis way, we could reduce the number of unnecessary instantiation of\nimmutable headers and their builders.\n\nModifications:\n\n- Move and merge response header conversion process from\n  `HttpResponseSubscriber` to `ArmeriaHttpUtil.toNettyHttp1/2()`\n- Move and merge request header conversion process from\n  `HttpRequestSubscriber` to `ArmeriaHttpUtil.toNettyHttp1/2()`\n- Add parameters to `HttpObjectEncoder.writeHeaders()`:\n  - `HttpHeaders additionalHeaders`\n  - `HttpHeaders additionalTrailers`\n- Split `Http1ObjectEncoder` into:\n  - `ServerHttp1ObjectEncoder`\n  - `ClientHttp1ObjectEncoder`\n- Split `Http2ObjectEncoder` into:\n  - `ServerHttp2ObjectEncoder`\n  - `ClientHttp2ObjectEncoder`\n- Split `ArmeriaHttpUtil.toNettyHttp1()` into:\n  - `toNettyHttp1ServerHeader()`\n  - `toNettyHttp1ServerTrailer()`\n  - `toNettyHttp1ClientHeader()`\n  - `toNettyHttp1ClientTrailer()`\n- Split `ArmeriaHttpUtil.toNettyHttp2()` into:\n  - `toNettyHttp2ServerHeader()`\n  - `toNettyHttp2ServerTrailer()`\n  - `toNettyHttp2ClientHeader()`\n  - `toNettyHttp2ClientTrailer()`\n\nResult:\n\n- Better HTTP header validation/conversion performance\n- Fixes #2096", "committedDate": "2020-03-17T07:12:24Z", "type": "commit"}, {"oid": "e1d05976115ac412a9cd2cfd0b6df43ad943c0c7", "url": "https://github.com/line/armeria/commit/e1d05976115ac412a9cd2cfd0b6df43ad943c0c7", "message": "Streamline HTTP header/trailer validation and conversion\n\nMotivation:\n\nCurrently, user-provided HTTP headers and trailers are consumer by\n`HttpRequestSubscriber` and `HttpResponseSubscriber`. The following is\nthe basic header/trailer validation and conversion process:\n\n1. `Http*Subscriber` merges the `Request/ResponseHeaders` and\n   `ctx.additional*Headers()` while excluding some prohibited headers.\n2. `Http*Subscriber` passs the merged headers to `HttpObjectEncoder`.\n3. `HttpObjectEncoder` converts the merged headers while excluding some\n   more prohibited headers, using `ArmeriaHttpUtil`.\n\n(Pretty much same for trailers)\n\nInstead, we could streamline and optimize this process like the following:\n\n1. `Http*Subscriber` passes `Request/ResponseHeaders` and\n   `ctx.additional*Headers()`, without any validation or exclusion.\n2. `HttpObjectEncoder` converts the given headers while excluding\n   prohibited headers and merging `Request/ResponseHeaders` and\n   `ctx.additional*Headers()`.\n\nThis way, we could reduce the number of unnecessary instantiation of\nimmutable headers and their builders.\n\nModifications:\n\n- Move and merge response header conversion process from\n  `HttpResponseSubscriber` to `ArmeriaHttpUtil.toNettyHttp1/2()`\n- Move and merge request header conversion process from\n  `HttpRequestSubscriber` to `ArmeriaHttpUtil.toNettyHttp1/2()`\n- Add parameters to `HttpObjectEncoder.writeHeaders()`:\n  - `HttpHeaders additionalHeaders`\n  - `HttpHeaders additionalTrailers`\n- Split `Http1ObjectEncoder` into:\n  - `ServerHttp1ObjectEncoder`\n  - `ClientHttp1ObjectEncoder`\n- Split `Http2ObjectEncoder` into:\n  - `ServerHttp2ObjectEncoder`\n  - `ClientHttp2ObjectEncoder`\n- Split `ArmeriaHttpUtil.toNettyHttp1()` into:\n  - `toNettyHttp1ServerHeader()`\n  - `toNettyHttp1ServerTrailer()`\n  - `toNettyHttp1ClientHeader()`\n  - `toNettyHttp1ClientTrailer()`\n- Split `ArmeriaHttpUtil.toNettyHttp2()` into:\n  - `toNettyHttp2ServerHeader()`\n  - `toNettyHttp2ServerTrailer()`\n  - `toNettyHttp2ClientHeader()`\n  - `toNettyHttp2ClientTrailer()`\n\nResult:\n\n- Better HTTP header validation/conversion performance\n- Fixes #2096", "committedDate": "2020-03-17T07:12:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ2MTgyNw==", "url": "https://github.com/line/armeria/pull/2372#discussion_r391461827", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return  lastContent;\n          \n          \n            \n                    return lastContent;", "author": "ikhoon", "createdAt": "2020-03-12T08:24:18Z", "path": "core/src/main/java/com/linecorp/armeria/internal/client/ClientHttp1ObjectEncoder.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.client;\n+\n+import java.net.InetSocketAddress;\n+\n+import com.linecorp.armeria.common.HttpHeaderNames;\n+import com.linecorp.armeria.common.HttpHeaders;\n+import com.linecorp.armeria.common.SessionProtocol;\n+import com.linecorp.armeria.internal.common.ArmeriaHttpUtil;\n+import com.linecorp.armeria.internal.common.Http1ObjectEncoder;\n+\n+import io.netty.buffer.Unpooled;\n+import io.netty.channel.Channel;\n+import io.netty.channel.ChannelFuture;\n+import io.netty.handler.codec.http.DefaultHttpRequest;\n+import io.netty.handler.codec.http.DefaultLastHttpContent;\n+import io.netty.handler.codec.http.HttpHeaderValues;\n+import io.netty.handler.codec.http.HttpMethod;\n+import io.netty.handler.codec.http.HttpObject;\n+import io.netty.handler.codec.http.HttpRequest;\n+import io.netty.handler.codec.http.HttpUtil;\n+import io.netty.handler.codec.http.HttpVersion;\n+import io.netty.handler.codec.http.LastHttpContent;\n+import io.netty.handler.codec.http2.Http2Exception;\n+\n+public final class ClientHttp1ObjectEncoder extends Http1ObjectEncoder {\n+    public ClientHttp1ObjectEncoder(Channel ch, SessionProtocol protocol) {\n+        super(ch, protocol);\n+    }\n+\n+    @Override\n+    protected ChannelFuture doWriteHeaders(int id, int streamId, HttpHeaders headers, boolean endStream,\n+                                           HttpHeaders additionalHeaders, HttpHeaders additionalTrailers) {\n+        if (!isWritable(id)) {\n+            return newClosedSessionFuture();\n+        }\n+\n+        try {\n+            final HttpObject converted;\n+            final String method = headers.get(HttpHeaderNames.METHOD);\n+            if (method == null) {\n+                converted = convertTrailers(streamId, headers);\n+            } else {\n+                converted = convertHeaders(streamId, headers, endStream, additionalHeaders);\n+            }\n+            return writeNonInformationalHeaders(id, converted, endStream);\n+        } catch (Throwable t) {\n+            return newFailedFuture(t);\n+        }\n+    }\n+\n+    private static LastHttpContent convertTrailers(int streamId, HttpHeaders inHeaders) throws Http2Exception {\n+        if (inHeaders.isEmpty()) {\n+            return LastHttpContent.EMPTY_LAST_CONTENT;\n+        }\n+        final LastHttpContent lastContent = new DefaultLastHttpContent(Unpooled.EMPTY_BUFFER, false);\n+\n+        ArmeriaHttpUtil.toNettyHttp1ClientTrailer(streamId, inHeaders, lastContent.trailingHeaders());\n+\n+        removeHttpExtensionHeaders(lastContent.trailingHeaders());\n+        return  lastContent;", "originalCommit": "3136f3185cd7bd0321308b0db8262e15e710224a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d67229d0647fd658b3c946763f5a5819b87b76cd", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/internal/client/ClientHttp1ObjectEncoder.java b/core/src/main/java/com/linecorp/armeria/internal/client/ClientHttp1ObjectEncoder.java\nindex add3efb18..c2ad1984e 100644\n--- a/core/src/main/java/com/linecorp/armeria/internal/client/ClientHttp1ObjectEncoder.java\n+++ b/core/src/main/java/com/linecorp/armeria/internal/client/ClientHttp1ObjectEncoder.java\n\n@@ -73,7 +73,7 @@ public final class ClientHttp1ObjectEncoder extends Http1ObjectEncoder {\n         ArmeriaHttpUtil.toNettyHttp1ClientTrailer(streamId, inHeaders, lastContent.trailingHeaders());\n \n         removeHttpExtensionHeaders(lastContent.trailingHeaders());\n-        return  lastContent;\n+        return lastContent;\n     }\n \n     private HttpObject convertHeaders(int streamId, HttpHeaders headers, boolean endStream,\n"}}, {"oid": "d67229d0647fd658b3c946763f5a5819b87b76cd", "url": "https://github.com/line/armeria/commit/d67229d0647fd658b3c946763f5a5819b87b76cd", "message": "Update core/src/main/java/com/linecorp/armeria/internal/client/ClientHttp1ObjectEncoder.java\n\nCo-Authored-By: Ikhun Um <ih.pert@gmail.com>", "committedDate": "2020-03-17T09:07:54Z", "type": "commit"}]}