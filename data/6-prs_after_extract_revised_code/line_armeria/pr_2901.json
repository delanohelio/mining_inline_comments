{"pr_number": 2901, "pr_title": "Add more information to `ProtocolViolationException`", "pr_createdAt": "2020-07-16T06:31:39Z", "pr_url": "https://github.com/line/armeria/pull/2901", "timeline": [{"oid": "75c2a088066c5b61ef6d48948ded6198324e8ed6", "url": "https://github.com/line/armeria/commit/75c2a088066c5b61ef6d48948ded6198324e8ed6", "message": "Add more information to `ProtocolViolationException`\nRelated #2900\nIt's hard to distinguish where the response is from when many Armeria Clients are used.\nIf we add the remoteAddress to the exceptin message, we can easily notify it.", "committedDate": "2020-07-16T06:26:18Z", "type": "commit"}, {"oid": "c160a9955cf787609582ad182b2f05fecbfe9cec", "url": "https://github.com/line/armeria/commit/c160a9955cf787609582ad182b2f05fecbfe9cec", "message": "Address the comment by @trustin", "committedDate": "2020-07-16T06:42:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY3NjYxNg==", "url": "https://github.com/line/armeria/pull/2901#discussion_r455676616", "bodyText": "How about adding lastPingReqId only if lastPingReqId is not equal to -1", "author": "ikhoon", "createdAt": "2020-07-16T10:10:05Z", "path": "core/src/main/java/com/linecorp/armeria/client/Http1ResponseDecoder.java", "diffHunk": "@@ -251,7 +251,8 @@ public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception\n     private void failWithUnexpectedMessageType(ChannelHandlerContext ctx, Object msg, Class<?> expected) {\n         fail(ctx, new ProtocolViolationException(\n                 \"unexpected message type: \" + msg.getClass().getName() +\n-                \" (expected: \" + expected.getName() + ')'));\n+                \" (expected: \" + expected.getName() + \", channel: \" + ctx.channel() +\n+                \", resId: \" + resId + \", lastPingReqId: \" + lastPingReqId + ')'));", "originalCommit": "c160a9955cf787609582ad182b2f05fecbfe9cec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzA3MDQxMg==", "url": "https://github.com/line/armeria/pull/2901#discussion_r457070412", "bodyText": "Fixed. \ud83d\ude09", "author": "minwoox", "createdAt": "2020-07-20T05:41:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY3NjYxNg=="}], "type": "inlineReview", "revised_code": {"commit": "df77d46d28ecd389ba037e12cb87f23a8129b5a1", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/Http1ResponseDecoder.java b/core/src/main/java/com/linecorp/armeria/client/Http1ResponseDecoder.java\nindex 7a9a24df7..a3fdb3074 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/Http1ResponseDecoder.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/Http1ResponseDecoder.java\n\n@@ -249,10 +250,16 @@ final class Http1ResponseDecoder extends HttpResponseDecoder implements ChannelI\n     }\n \n     private void failWithUnexpectedMessageType(ChannelHandlerContext ctx, Object msg, Class<?> expected) {\n-        fail(ctx, new ProtocolViolationException(\n-                \"unexpected message type: \" + msg.getClass().getName() +\n-                \" (expected: \" + expected.getName() + \", channel: \" + ctx.channel() +\n-                \", resId: \" + resId + \", lastPingReqId: \" + lastPingReqId + ')'));\n+        final StringBuilder buf = TemporaryThreadLocals.get().stringBuilder();\n+        buf.append(\"unexpected message type: \" + msg.getClass().getName() +\n+                   \" (expected: \" + expected.getName() + \", channel: \" + ctx.channel() +\n+                   \", resId: \" + resId);\n+        if (lastPingReqId == -1) {\n+            buf.append(')');\n+        } else {\n+            buf.append(\", lastPingReqId: \" + lastPingReqId + ')');\n+        }\n+        fail(ctx, new ProtocolViolationException(buf.toString()));\n     }\n \n     private void fail(ChannelHandlerContext ctx, Throwable cause) {\n"}}, {"oid": "df77d46d28ecd389ba037e12cb87f23a8129b5a1", "url": "https://github.com/line/armeria/commit/df77d46d28ecd389ba037e12cb87f23a8129b5a1", "message": "Address the comment by @ikhoon", "committedDate": "2020-07-20T05:41:31Z", "type": "commit"}]}