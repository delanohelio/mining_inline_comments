{"pr_number": 3003, "pr_title": "Abide by Reactive Streams spec 3.6 in FixedStreamMessage", "pr_createdAt": "2020-08-19T03:45:20Z", "pr_url": "https://github.com/line/armeria/pull/3003", "timeline": [{"oid": "67d3a0c3bd44ed20b04872980efdab70d1ca2b08", "url": "https://github.com/line/armeria/commit/67d3a0c3bd44ed20b04872980efdab70d1ca2b08", "message": "Abide by Reactive Streams spec 3.6 in FixedStreamMessage\n\nMotivation:\n\nAfter a Subscription has been cancelled, `Subscription.request(n)` should be NOPs.\nhttps://github.com/reactive-streams/reactive-streams-jvm#3.6\n\nHowever `OneElementFixedStreamMessage` throws `AssertionError` by the following condition.\nhttps://github.com/line/armeria/blob/744098d4ed83a65c6668fd863afebae14f5e2a1c/core/src/main/java/com/linecorp/armeria/common/stream/OneElementFixedStreamMessage.java#L69\n\nModifications:\n\n- Ignore additional `Subscripiton.request(n)` signals\n  when the stream has been cancelled already in FixedStreamMessage.\n\nResult:\n\n- `OneElementFixedStreamMessage` does not throw `AssertionError` anymore\n  when receiving `Subscription.request(n)` signal.", "committedDate": "2020-08-19T03:30:14Z", "type": "commit"}, {"oid": "c95c0970d7289aafbf167208c532c4e4ebad6fb0", "url": "https://github.com/line/armeria/commit/c95c0970d7289aafbf167208c532c4e4ebad6fb0", "message": "Add guard", "committedDate": "2020-08-19T03:46:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjczMzE2Ng==", "url": "https://github.com/line/armeria/pull/3003#discussion_r472733166", "bodyText": "Is this necessary? Can we just check if closeEvent is null?", "author": "trustin", "createdAt": "2020-08-19T05:56:41Z", "path": "core/src/main/java/com/linecorp/armeria/common/stream/FixedStreamMessage.java", "diffHunk": "@@ -50,6 +50,7 @@\n     private volatile CloseEvent closeEvent;\n \n     private int requested;\n+    private volatile boolean cancelled;", "originalCommit": "c95c0970d7289aafbf167208c532c4e4ebad6fb0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjc3MTQ5Ng==", "url": "https://github.com/line/armeria/pull/3003#discussion_r472771496", "bodyText": "I tried it for the first time.\nThe closeEvent is set to null while cleanup(...). Is it better not to set null if the closeEvent is CANCELLED_CLOSE? \ud83e\udd14\n\n  \n    \n      armeria/core/src/main/java/com/linecorp/armeria/common/stream/FixedStreamMessage.java\n    \n    \n        Lines 64 to 66\n      in\n      c95c097\n    \n    \n    \n    \n\n        \n          \n           final void cleanup(SubscriptionImpl subscription) { \n        \n\n        \n          \n               final CloseEvent closeEvent = this.closeEvent; \n        \n\n        \n          \n               this.closeEvent = null;", "author": "ikhoon", "createdAt": "2020-08-19T06:49:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjczMzE2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "24e944ad49bf73573f9d89298d39424bf8d5914e", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/common/stream/FixedStreamMessage.java b/core/src/main/java/com/linecorp/armeria/common/stream/FixedStreamMessage.java\nindex 40efeaa653..8195a9f592 100644\n--- a/core/src/main/java/com/linecorp/armeria/common/stream/FixedStreamMessage.java\n+++ b/core/src/main/java/com/linecorp/armeria/common/stream/FixedStreamMessage.java\n\n@@ -50,7 +50,6 @@ abstract class FixedStreamMessage<T> extends AbstractStreamMessage<T> {\n     private volatile CloseEvent closeEvent;\n \n     private int requested;\n-    private volatile boolean cancelled;\n \n     abstract void cleanupObjects();\n \n"}}, {"oid": "24e944ad49bf73573f9d89298d39424bf8d5914e", "url": "https://github.com/line/armeria/commit/24e944ad49bf73573f9d89298d39424bf8d5914e", "message": "Use closeEvent instead", "committedDate": "2020-08-19T12:19:52Z", "type": "commit"}, {"oid": "1183b59e3720817501877590ef885a88627419d4", "url": "https://github.com/line/armeria/commit/1183b59e3720817501877590ef885a88627419d4", "message": "Clean up", "committedDate": "2020-08-19T12:30:40Z", "type": "commit"}, {"oid": "aea2d432f759c6ea0f768d060dcc4e539782cd07", "url": "https://github.com/line/armeria/commit/aea2d432f759c6ea0f768d060dcc4e539782cd07", "message": "Remove null check in cleanup", "committedDate": "2020-08-19T12:46:45Z", "type": "commit"}]}