{"pr_number": 3202, "pr_title": "Use `ClassValue` for the map whose key is `Class`", "pr_createdAt": "2020-11-27T14:42:34Z", "pr_url": "https://github.com/line/armeria/pull/3202", "timeline": [{"oid": "f533655058435086a2d92a170fee6e283e494920", "url": "https://github.com/line/armeria/commit/f533655058435086a2d92a170fee6e283e494920", "message": "Use weakKeys for the map whose key is a `Class`\nClose #3138", "committedDate": "2020-11-27T14:41:55Z", "type": "commit"}, {"oid": "93a702e02b1f57474aaea503de3a3a118a7ba669", "url": "https://github.com/line/armeria/commit/93a702e02b1f57474aaea503de3a3a118a7ba669", "message": "Reorder static fields", "committedDate": "2020-11-27T14:45:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTgyMzA2NA==", "url": "https://github.com/line/armeria/pull/3202#discussion_r531823064", "bodyText": "By the way maybe for a separate PR but I recently learned of ClassValue\nhttps://docs.oracle.com/javase/7/docs/api/java/lang/ClassValue.html\nIt's like a map from class to value, but handled natively by Java with optimal performance.", "author": "anuraaga", "createdAt": "2020-11-28T02:20:01Z", "path": "core/src/main/java/com/linecorp/armeria/internal/server/annotation/AnnotatedServiceFactory.java", "diffHunk": "@@ -136,7 +136,7 @@\n     /**\n      * An instance map for reusing converters, exception handlers and decorators.\n      */\n-    private static final ConcurrentMap<Class<?>, Object> instanceCache = new ConcurrentHashMap<>();\n+    private static final ConcurrentMap<Class<?>, Object> instanceCache = new MapMaker().weakKeys().makeMap();", "originalCommit": "93a702e02b1f57474aaea503de3a3a118a7ba669", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTkxMDEwMg==", "url": "https://github.com/line/armeria/pull/3202#discussion_r531910102", "bodyText": "Thanks! I have not known that class. \ud83d\ude04", "author": "minwoox", "createdAt": "2020-11-28T05:49:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTgyMzA2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTkxMzYyMg==", "url": "https://github.com/line/armeria/pull/3202#discussion_r531913622", "bodyText": "Here's an example :) https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/c6eee706604a9edf35758d90dc974e4ee82a0f0a/instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/decorator/BaseDecorator.java#L25", "author": "anuraaga", "createdAt": "2020-11-28T05:54:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTgyMzA2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA0MzA1MA==", "url": "https://github.com/line/armeria/pull/3202#discussion_r532043050", "bodyText": "Fixed. \ud83d\ude09", "author": "minwoox", "createdAt": "2020-11-28T13:57:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTgyMzA2NA=="}], "type": "inlineReview", "revised_code": {"commit": "8b55428a6eae46f7143eab23026f13a0f66651c1", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/internal/server/annotation/AnnotatedServiceFactory.java b/core/src/main/java/com/linecorp/armeria/internal/server/annotation/AnnotatedServiceFactory.java\nindex 3b44ccebe..a52a7dc99 100644\n--- a/core/src/main/java/com/linecorp/armeria/internal/server/annotation/AnnotatedServiceFactory.java\n+++ b/core/src/main/java/com/linecorp/armeria/internal/server/annotation/AnnotatedServiceFactory.java\n\n@@ -136,7 +134,17 @@ public final class AnnotatedServiceFactory {\n     /**\n      * An instance map for reusing converters, exception handlers and decorators.\n      */\n-    private static final ConcurrentMap<Class<?>, Object> instanceCache = new MapMaker().weakKeys().makeMap();\n+    private static final ClassValue<Object> instanceCache = new ClassValue<Object>() {\n+        @Override\n+        protected Object computeValue(Class<?> type) {\n+            try {\n+                return getInstance0(type);\n+            } catch (Exception e) {\n+                throw new IllegalStateException(\"A class must have an accessible default constructor: \" +\n+                                                type.getName(), e);\n+            }\n+        }\n+    };\n \n     /**\n      * A default {@link ExceptionHandlerFunction}.\n"}}, {"oid": "8b55428a6eae46f7143eab23026f13a0f66651c1", "url": "https://github.com/line/armeria/commit/8b55428a6eae46f7143eab23026f13a0f66651c1", "message": "Use ClassValue", "committedDate": "2020-11-28T13:51:33Z", "type": "commit"}]}