{"pr_number": 2735, "pr_title": "Fix a bug where ArmeriaHttpUtil throws NPE when failing to read versi\u2026", "pr_createdAt": "2020-05-21T06:54:14Z", "pr_url": "https://github.com/line/armeria/pull/2735", "timeline": [{"oid": "3d50f544d2a3dabfa2910fe9122f750347bfc6ae", "url": "https://github.com/line/armeria/commit/3d50f544d2a3dabfa2910fe9122f750347bfc6ae", "message": "Fix a bug where ArmeriaHttpUtil throws NPE when failing to read version.properties\n\nMotivation:\nThe order of dependency of Armeria artifact,\n`META-INF/com.linecorp.armeria.versions.properties` is removed by Maven shade plugin.\nIf fails to read the file, `Version.getAll(loader).get(\"armeria\")` will return null.\nSee #2731 for more information.\n\nModifications:\n\n- Use Version.get(\"armeria\") which returns a dummy object that contains 'unknown' version\n  if fails to read `version.properties`\n\nResult:\nWorkaround for #2731\nArmeriaHttpUtil does not throws NullPointerException any more.\n\nTODO: We need a workaround or guide to keep versions.properties with Maven shade plugin.", "committedDate": "2020-05-21T06:56:04Z", "type": "commit"}, {"oid": "3d50f544d2a3dabfa2910fe9122f750347bfc6ae", "url": "https://github.com/line/armeria/commit/3d50f544d2a3dabfa2910fe9122f750347bfc6ae", "message": "Fix a bug where ArmeriaHttpUtil throws NPE when failing to read version.properties\n\nMotivation:\nThe order of dependency of Armeria artifact,\n`META-INF/com.linecorp.armeria.versions.properties` is removed by Maven shade plugin.\nIf fails to read the file, `Version.getAll(loader).get(\"armeria\")` will return null.\nSee #2731 for more information.\n\nModifications:\n\n- Use Version.get(\"armeria\") which returns a dummy object that contains 'unknown' version\n  if fails to read `version.properties`\n\nResult:\nWorkaround for #2731\nArmeriaHttpUtil does not throws NullPointerException any more.\n\nTODO: We need a workaround or guide to keep versions.properties with Maven shade plugin.", "committedDate": "2020-05-21T06:56:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ4NjE2OA==", "url": "https://github.com/line/armeria/pull/2735#discussion_r428486168", "bodyText": "How about using some regular expression to check the version number format?", "author": "trustin", "createdAt": "2020-05-21T07:16:16Z", "path": "core/src/test/java/com/linecorp/armeria/internal/common/ArmeriaHttpUtilTest.java", "diffHunk": "@@ -500,6 +501,11 @@ void isAbsoluteUri() {\n         bad.forEach(path -> assertThat(ArmeriaHttpUtil.isAbsoluteUri(path)).isFalse());\n     }\n \n+    @Test\n+    void serverHeader() {\n+        assertThat(ArmeriaHttpUtil.SERVER_HEADER).contains(\"Armeria/\");", "originalCommit": "3d50f544d2a3dabfa2910fe9122f750347bfc6ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ4NzUzNQ==", "url": "https://github.com/line/armeria/pull/2735#discussion_r428487535", "bodyText": "Yeap, that sounds good.", "author": "ikhoon", "createdAt": "2020-05-21T07:19:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ4NjE2OA=="}], "type": "inlineReview", "revised_code": {"commit": "019b7402cf6424a7b42a6297d1d41627e5353ed4", "chunk": "diff --git a/core/src/test/java/com/linecorp/armeria/internal/common/ArmeriaHttpUtilTest.java b/core/src/test/java/com/linecorp/armeria/internal/common/ArmeriaHttpUtilTest.java\nindex 111c05e3d1..9b1f0eb259 100644\n--- a/core/src/test/java/com/linecorp/armeria/internal/common/ArmeriaHttpUtilTest.java\n+++ b/core/src/test/java/com/linecorp/armeria/internal/common/ArmeriaHttpUtilTest.java\n\n@@ -503,7 +503,10 @@ class ArmeriaHttpUtilTest {\n \n     @Test\n     void serverHeader() {\n-        assertThat(ArmeriaHttpUtil.SERVER_HEADER).contains(\"Armeria/\");\n+        final String pattern = \"Armeria/(\\\\d+).(\\\\d+).(\\\\d+)(-SNAPSHOT)?\";\n+        assertThat(\"Armeria/1.0.0\").containsPattern(pattern);\n+        assertThat(\"Armeria/1.0.0-SNAPSHOT\").containsPattern(pattern);\n+        assertThat(ArmeriaHttpUtil.SERVER_HEADER).containsPattern(pattern);\n     }\n \n     private static ServerConfig serverConfig() {\n"}}, {"oid": "019b7402cf6424a7b42a6297d1d41627e5353ed4", "url": "https://github.com/line/armeria/commit/019b7402cf6424a7b42a6297d1d41627e5353ed4", "message": "Add regex pattern for testing version", "committedDate": "2020-05-21T07:27:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ5MTYyNA==", "url": "https://github.com/line/armeria/pull/2735#discussion_r428491624", "bodyText": "1.0.0 is coming soon. \ud83d\ude0e", "author": "ikhoon", "createdAt": "2020-05-21T07:30:07Z", "path": "core/src/test/java/com/linecorp/armeria/internal/common/ArmeriaHttpUtilTest.java", "diffHunk": "@@ -500,6 +501,14 @@ void isAbsoluteUri() {\n         bad.forEach(path -> assertThat(ArmeriaHttpUtil.isAbsoluteUri(path)).isFalse());\n     }\n \n+    @Test\n+    void serverHeader() {\n+        final String pattern = \"Armeria/(\\\\d+).(\\\\d+).(\\\\d+)(-SNAPSHOT)?\";\n+        assertThat(\"Armeria/1.0.0\").containsPattern(pattern);", "originalCommit": "019b7402cf6424a7b42a6297d1d41627e5353ed4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}