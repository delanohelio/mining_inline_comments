{"pr_number": 3236, "pr_title": "Refresh endpoints when the weight is changed in `HealthCheckedEndpointGroup`", "pr_createdAt": "2020-12-18T08:56:27Z", "pr_url": "https://github.com/line/armeria/pull/3236", "timeline": [{"oid": "2e719a8b6d9b59994b1b7f64d3d65193a625fdb3", "url": "https://github.com/line/armeria/commit/2e719a8b6d9b59994b1b7f64d3d65193a625fdb3", "message": "Refresh endpoints when the weight is changed in `HealthCheckedEndpointGroup`\nMotivation:\nShould reflect the change of endpoints in `HealthCheckedEndpointGroup` even when the weight of an endpoint is changed.\n\nModification:\n- Refresh endpoints in `HealthCheckedEndpointGroup` when the weight of an endpoint is changed.\n\nResult:\n- The endpoints of `HealthCheckedEndpointGroup` are updated when the weight of an endpoint is changed.", "committedDate": "2020-12-18T08:50:49Z", "type": "commit"}, {"oid": "f736e2ae715ed59d9dbaa9e23539aac6d90a4345", "url": "https://github.com/line/armeria/commit/f736e2ae715ed59d9dbaa9e23539aac6d90a4345", "message": "Add more test", "committedDate": "2020-12-18T09:06:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzAzNDQ4MQ==", "url": "https://github.com/line/armeria/pull/3236#discussion_r547034481", "bodyText": "How about checking first that the endpoints are the same?\nfinal boolean isSameEndpoints = contexts.size() == newSelectedEndpoints.size() &&\n                                contexts.keySet().containsAll(newSelectedEndpoints);", "author": "ikhoon", "createdAt": "2020-12-22T02:38:34Z", "path": "core/src/main/java/com/linecorp/armeria/client/endpoint/healthcheck/HealthCheckedEndpointGroup.java", "diffHunk": "@@ -173,26 +174,34 @@ private void refreshContexts() {\n         try {\n             synchronized (contexts) {\n                 final List<Endpoint> newSelectedEndpoints = healthCheckStrategy.getSelectedEndpoints();\n+                final Set<Endpoint> newSelectedEndpointsSet = new HashSet<>(newSelectedEndpoints);", "originalCommit": "f736e2ae715ed59d9dbaa9e23539aac6d90a4345", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzAzNTIzNQ==", "url": "https://github.com/line/armeria/pull/3236#discussion_r547035235", "bodyText": "What happens newSelectedEndpoints has more endpoints?", "author": "minwoox", "createdAt": "2020-12-22T02:41:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzAzNDQ4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzAzNzYwMQ==", "url": "https://github.com/line/armeria/pull/3236#discussion_r547037601", "bodyText": "If the problem happens only when weights are changed, I thought we can use the original logic if they are different. For example:\nfinal boolean isSameEndpoints = contexts.size() == newSelectedEndpoints.size() &&\n                                contexts.keySet().containsAll(newSelectedEndpoints);\nif (isSameEndpoints) {\n    refreshEndpoints();\n    return;\n}\n\n// same as before\nMaybe there is something I missed. \ud83e\udd2a", "author": "ikhoon", "createdAt": "2020-12-22T02:50:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzAzNDQ4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzAzODgzOA==", "url": "https://github.com/line/armeria/pull/3236#discussion_r547038838", "bodyText": "If newSelectedEndpoints has more endpoints than current endpoints we should add the newly added endpoints.\nSo we should do this as well:\nnewSelectedEndpoints.containsAll(contexts.keySet())\nwhich iterates another for loop.\nMost of the time, the endpoints will be changed so I think it's useless to check if just the weight is changed.\nWe will be going to notice that anyway. \ud83d\ude04", "author": "minwoox", "createdAt": "2020-12-22T02:55:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzAzNDQ4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA1MjA3Mg==", "url": "https://github.com/line/armeria/pull/3236#discussion_r547052072", "bodyText": "newSelectedEndpoints.containsAll(contexts.keySet())\n\nQuestion: Is this not covered by checking their sizes?\nAnyway, this is not a big deal. Let keep it as it is.", "author": "ikhoon", "createdAt": "2020-12-22T03:50:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzAzNDQ4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA1OTE0OA==", "url": "https://github.com/line/armeria/pull/3236#discussion_r547059148", "bodyText": "Question: Is this not covered by checking their sizes?\n\nOh, I missed that point. \ud83d\ude05\n\nLet keep it as it is.\n\nYeah, let's keep it as it is.", "author": "minwoox", "createdAt": "2020-12-22T04:18:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzAzNDQ4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "19de976cc780f2ecaadfea892d72e6e2d3cee57e", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/endpoint/healthcheck/HealthCheckedEndpointGroup.java b/core/src/main/java/com/linecorp/armeria/client/endpoint/healthcheck/HealthCheckedEndpointGroup.java\nindex e41cce902..4e3dddb6a 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/endpoint/healthcheck/HealthCheckedEndpointGroup.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/endpoint/healthcheck/HealthCheckedEndpointGroup.java\n\n@@ -173,15 +173,15 @@ public final class HealthCheckedEndpointGroup extends DynamicEndpointGroup {\n         isRefreshingContexts.set(Boolean.TRUE);\n         try {\n             synchronized (contexts) {\n-                final List<Endpoint> newSelectedEndpoints = healthCheckStrategy.getSelectedEndpoints();\n-                final Set<Endpoint> newSelectedEndpointsSet = new HashSet<>(newSelectedEndpoints);\n+                final Set<Endpoint> newSelectedEndpoints =\n+                        new HashSet<>(healthCheckStrategy.getSelectedEndpoints());\n \n                 boolean removed = false;\n                 // Stop the health checkers whose endpoints disappeared and destroy their contexts.\n                 for (final Iterator<Map.Entry<Endpoint, DefaultHealthCheckerContext>> i =\n                      contexts.entrySet().iterator(); i.hasNext();) {\n                     final Map.Entry<Endpoint, DefaultHealthCheckerContext> e = i.next();\n-                    if (newSelectedEndpointsSet.remove(e.getKey())) {\n+                    if (newSelectedEndpoints.remove(e.getKey())) {\n                         // Not a removed endpoint.\n                         continue;\n                     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA1MjQ4OQ==", "url": "https://github.com/line/armeria/pull/3236#discussion_r547052489", "bodyText": "Could remove this original local variable to prohibit unwanted access?\nfinal Set<Endpoint> newSelectedEndpoints = new HashSet<>(healthCheckStrategy.getSelectedEndpoints());", "author": "ikhoon", "createdAt": "2020-12-22T03:52:13Z", "path": "core/src/main/java/com/linecorp/armeria/client/endpoint/healthcheck/HealthCheckedEndpointGroup.java", "diffHunk": "@@ -173,26 +174,34 @@ private void refreshContexts() {\n         try {\n             synchronized (contexts) {\n                 final List<Endpoint> newSelectedEndpoints = healthCheckStrategy.getSelectedEndpoints();\n+                final Set<Endpoint> newSelectedEndpointsSet = new HashSet<>(newSelectedEndpoints);", "originalCommit": "f736e2ae715ed59d9dbaa9e23539aac6d90a4345", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA1OTIyMg==", "url": "https://github.com/line/armeria/pull/3236#discussion_r547059222", "bodyText": "That's a good suggestion.", "author": "minwoox", "createdAt": "2020-12-22T04:19:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA1MjQ4OQ=="}], "type": "inlineReview", "revised_code": {"commit": "19de976cc780f2ecaadfea892d72e6e2d3cee57e", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/endpoint/healthcheck/HealthCheckedEndpointGroup.java b/core/src/main/java/com/linecorp/armeria/client/endpoint/healthcheck/HealthCheckedEndpointGroup.java\nindex e41cce902..4e3dddb6a 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/endpoint/healthcheck/HealthCheckedEndpointGroup.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/endpoint/healthcheck/HealthCheckedEndpointGroup.java\n\n@@ -173,15 +173,15 @@ public final class HealthCheckedEndpointGroup extends DynamicEndpointGroup {\n         isRefreshingContexts.set(Boolean.TRUE);\n         try {\n             synchronized (contexts) {\n-                final List<Endpoint> newSelectedEndpoints = healthCheckStrategy.getSelectedEndpoints();\n-                final Set<Endpoint> newSelectedEndpointsSet = new HashSet<>(newSelectedEndpoints);\n+                final Set<Endpoint> newSelectedEndpoints =\n+                        new HashSet<>(healthCheckStrategy.getSelectedEndpoints());\n \n                 boolean removed = false;\n                 // Stop the health checkers whose endpoints disappeared and destroy their contexts.\n                 for (final Iterator<Map.Entry<Endpoint, DefaultHealthCheckerContext>> i =\n                      contexts.entrySet().iterator(); i.hasNext();) {\n                     final Map.Entry<Endpoint, DefaultHealthCheckerContext> e = i.next();\n-                    if (newSelectedEndpointsSet.remove(e.getKey())) {\n+                    if (newSelectedEndpoints.remove(e.getKey())) {\n                         // Not a removed endpoint.\n                         continue;\n                     }\n"}}, {"oid": "19de976cc780f2ecaadfea892d72e6e2d3cee57e", "url": "https://github.com/line/armeria/commit/19de976cc780f2ecaadfea892d72e6e2d3cee57e", "message": "Address the comment by @ikhoon", "committedDate": "2020-12-22T04:20:40Z", "type": "commit"}, {"oid": "818e8789d882239798ee6c84b227f8acc5374302", "url": "https://github.com/line/armeria/commit/818e8789d882239798ee6c84b227f8acc5374302", "message": "Fix comparator", "committedDate": "2020-12-24T05:22:26Z", "type": "commit"}, {"oid": "3cf06e041a67c49cb864d7e47576d7b212991ced", "url": "https://github.com/line/armeria/commit/3cf06e041a67c49cb864d7e47576d7b212991ced", "message": "Fix", "committedDate": "2020-12-24T12:54:50Z", "type": "commit"}]}