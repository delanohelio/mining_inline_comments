{"pr_number": 3251, "pr_title": "Fix a bug where NPE is raised when retrying a gRPC request", "pr_createdAt": "2020-12-29T03:22:12Z", "pr_url": "https://github.com/line/armeria/pull/3251", "timeline": [{"oid": "09a51dfef00aa6bb71c88856e30edecfc96db430", "url": "https://github.com/line/armeria/commit/09a51dfef00aa6bb71c88856e30edecfc96db430", "message": "Fix a bug where NPE is raised when retrying a gRPC request\nMotivation:\nWhen creating a derived context, we check whether the `RpcRequest` is `null` or not\nif `ctx.rpcRequest()` is not `null` in the consturctor of `DefaultClientRequestContext`.\n```\nprivate DefaultClientRequestContext(...) {\n    if (ctx.rpcRequest() != null) {\n        assert rpcRequest != null;\n    }\n    ...\n}\n```\nHowever, the assertion can be false.\nThe `rpcRequest` of the derived context is set later after the derived context is created so we don't know the timing.\nAlso, we call:\n```java\nctx.logBuilder().defer(RequestLogProperty.REQUEST_CONTENT,\n                       RequestLogProperty.RESPONSE_CONTENT);\n```\nthat guarantees the `rpcRequest` of the derived context is set later when the request content of the parent context is set.\nSo we can completely remove the assertion.\n\nModification:\n- Remove the assertion in `DefaultClientRequestContext`.\n\nResult:\n- Close #3248\n- You will no longer see NPE when retrying a aRPC request.", "committedDate": "2020-12-29T03:03:15Z", "type": "commit"}, {"oid": "e727a5cf2bb9a146b8ee03b032fd6ec00b871959", "url": "https://github.com/line/armeria/commit/e727a5cf2bb9a146b8ee03b032fd6ec00b871959", "message": "Add license", "committedDate": "2020-12-29T03:24:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU1NDEyNw==", "url": "https://github.com/line/armeria/pull/3251#discussion_r549554127", "bodyText": "These just changed to use thenAccept instead of thenApply.", "author": "minwoox", "createdAt": "2020-12-29T03:23:09Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/AbstractRetryingClient.java", "diffHunk": "@@ -276,45 +276,39 @@ protected static ClientRequestContext newDerivedContext(ClientRequestContext ctx\n         if (parentLog.isAvailable(RequestLogProperty.NAME)) {\n             final String serviceName = partial.serviceName();\n             final String name = partial.name();\n-            if (name != null) {\n-                if (serviceName != null) {\n-                    logBuilder.name(serviceName, name);\n-                } else {\n-                    logBuilder.name(name);\n-                }\n+            if (serviceName != null) {\n+                logBuilder.name(serviceName, name);\n+            } else {\n+                logBuilder.name(name);\n             }\n         }\n \n         final RequestLogBuilder parentLogBuilder = ctx.logBuilder();\n         if (parentLogBuilder.isDeferred(RequestLogProperty.REQUEST_CONTENT)) {\n             logBuilder.defer(RequestLogProperty.REQUEST_CONTENT);\n         }\n-        parentLog.whenAvailable(RequestLogProperty.REQUEST_CONTENT).thenApply(requestLog -> {\n-            logBuilder.requestContent(requestLog.requestContent(), requestLog.rawRequestContent());\n-            return null;\n-        });\n+        parentLog.whenAvailable(RequestLogProperty.REQUEST_CONTENT)\n+                 .thenAccept(requestLog -> logBuilder.requestContent(", "originalCommit": "09a51dfef00aa6bb71c88856e30edecfc96db430", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU1NDMwMQ==", "url": "https://github.com/line/armeria/pull/3251#discussion_r549554301", "bodyText": "This is not a bug.\nBut it does not break anything and I think it's better to call after calling updateRpcRequest .", "author": "minwoox", "createdAt": "2020-12-29T03:24:12Z", "path": "core/src/main/java/com/linecorp/armeria/common/logging/DefaultRequestLog.java", "diffHunk": "@@ -908,11 +909,10 @@ public void requestContent(@Nullable Object requestContent, @Nullable Object raw\n \n         this.requestContent = requestContent;\n         this.rawRequestContent = rawRequestContent;\n-        updateFlags(RequestLogProperty.REQUEST_CONTENT);\n-\n         if (requestContent instanceof RpcRequest && ctx.rpcRequest() == null) {\n             ctx.updateRpcRequest((RpcRequest) requestContent);\n         }\n+        updateFlags(RequestLogProperty.REQUEST_CONTENT);", "originalCommit": "09a51dfef00aa6bb71c88856e30edecfc96db430", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU2MTQ2Mw==", "url": "https://github.com/line/armeria/pull/3251#discussion_r549561463", "bodyText": "\ud83d\udc4d", "author": "ikhoon", "createdAt": "2020-12-29T04:12:47Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/AbstractRetryingClient.java", "diffHunk": "@@ -276,45 +276,39 @@ protected static ClientRequestContext newDerivedContext(ClientRequestContext ctx\n         if (parentLog.isAvailable(RequestLogProperty.NAME)) {\n             final String serviceName = partial.serviceName();\n             final String name = partial.name();\n-            if (name != null) {\n-                if (serviceName != null) {\n-                    logBuilder.name(serviceName, name);\n-                } else {\n-                    logBuilder.name(name);\n-                }\n+            if (serviceName != null) {\n+                logBuilder.name(serviceName, name);\n+            } else {\n+                logBuilder.name(name);", "originalCommit": "e727a5cf2bb9a146b8ee03b032fd6ec00b871959", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU5NDc5NQ==", "url": "https://github.com/line/armeria/pull/3251#discussion_r549594795", "bodyText": "How about adding some comment about why we don't check nullness of rpcReq here unlike req?", "author": "trustin", "createdAt": "2020-12-29T07:12:34Z", "path": "core/src/main/java/com/linecorp/armeria/client/DefaultClientRequestContext.java", "diffHunk": "@@ -357,9 +357,6 @@ private DefaultClientRequestContext(DefaultClientRequestContext ctx,\n         if (ctx.request() != null) {\n             requireNonNull(req, \"req\");\n         }\n-        if (ctx.rpcRequest() != null) {\n-            requireNonNull(rpcReq, \"rpcReq\");\n-        }", "originalCommit": "e727a5cf2bb9a146b8ee03b032fd6ec00b871959", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY4NTQ5Mw==", "url": "https://github.com/line/armeria/pull/3251#discussion_r549685493", "bodyText": "Added. \ud83d\ude04", "author": "minwoox", "createdAt": "2020-12-29T12:25:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU5NDc5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY5MDc1MQ==", "url": "https://github.com/line/armeria/pull/3251#discussion_r549690751", "bodyText": "And please add a link to the related github issue and PR? \ud83d\ude09", "author": "trustin", "createdAt": "2020-12-29T12:44:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU5NDc5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY5Nzg5OQ==", "url": "https://github.com/line/armeria/pull/3251#discussion_r549697899", "bodyText": "Added again. \ud83d\ude04", "author": "minwoox", "createdAt": "2020-12-29T13:07:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU5NDc5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "4f78b6ff692305ac453184417f41d161b954f9a6", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/DefaultClientRequestContext.java b/core/src/main/java/com/linecorp/armeria/client/DefaultClientRequestContext.java\nindex 310574d0e8..36e0e1e70d 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/DefaultClientRequestContext.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/DefaultClientRequestContext.java\n\n@@ -357,6 +357,9 @@ public final class DefaultClientRequestContext\n         if (ctx.request() != null) {\n             requireNonNull(req, \"req\");\n         }\n+        // The rpcReq can be null when ctx.rpcRequest() is not null because there's a chance that\n+        // the rpcRequest is set between the time we call ctx.rpcRequest() to create this context and now.\n+        // So we don't check the nullness of rpcRequest unlike request.\n \n         eventLoop = ctx.eventLoop().withoutContext();\n         options = ctx.options();\n"}}, {"oid": "4f78b6ff692305ac453184417f41d161b954f9a6", "url": "https://github.com/line/armeria/commit/4f78b6ff692305ac453184417f41d161b954f9a6", "message": "Add comment", "committedDate": "2020-12-29T12:25:23Z", "type": "commit"}, {"oid": "90776d43ba9ee48560e2ce1140e79a27ed53ca1b", "url": "https://github.com/line/armeria/commit/90776d43ba9ee48560e2ce1140e79a27ed53ca1b", "message": "Add links", "committedDate": "2020-12-29T13:06:41Z", "type": "commit"}]}