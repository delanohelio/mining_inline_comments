{"pr_number": 3252, "pr_title": "Fix flaky test in TomcatServiceDestroyedConnectorTest", "pr_createdAt": "2020-12-29T03:32:49Z", "pr_url": "https://github.com/line/armeria/pull/3252", "timeline": [{"oid": "9576aad93b00370da4d45279382912dc88a37762", "url": "https://github.com/line/armeria/commit/9576aad93b00370da4d45279382912dc88a37762", "message": "Fix flaky test in TomcatServiceDestroyedConnectorTest", "committedDate": "2020-12-29T03:31:12Z", "type": "commit"}, {"oid": "d4dca880ead66d516051cb1a076d20b817ed382a", "url": "https://github.com/line/armeria/commit/d4dca880ead66d516051cb1a076d20b817ed382a", "message": "Repeat test", "committedDate": "2020-12-29T03:35:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU1ODYwNA==", "url": "https://github.com/line/armeria/pull/3252#discussion_r549558604", "bodyText": "Revert \ud83d\ude04", "author": "trustin", "createdAt": "2020-12-29T03:53:45Z", "path": "tomcat9/src/test/java/com/linecorp/armeria/server/tomcat/TomcatServiceDestroyedConnectorTest.java", "diffHunk": "@@ -46,16 +47,21 @@ protected void configure(ServerBuilder sb) throws Exception {\n             tomcatWithWebApp.start();\n             sb.serviceUnder(\"/api/\", TomcatService.of(tomcatWithWebApp.getConnector()));\n         }\n+\n+        @Override\n+        protected boolean runForEachTest() {\n+            return true;\n+        }\n     };\n \n-    @Test\n+    @RepeatedTest(100)", "originalCommit": "d4dca880ead66d516051cb1a076d20b817ed382a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU1OTQzMw==", "url": "https://github.com/line/armeria/pull/3252#discussion_r549559433", "bodyText": "Ah, I'm testing to check if it happens again. \ud83d\ude04", "author": "minwoox", "createdAt": "2020-12-29T03:58:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU1ODYwNA=="}], "type": "inlineReview", "revised_code": {"commit": "a01f1543afb5c0be774a73703de4cbf731da6fe0", "chunk": "diff --git a/tomcat9/src/test/java/com/linecorp/armeria/server/tomcat/TomcatServiceDestroyedConnectorTest.java b/tomcat9/src/test/java/com/linecorp/armeria/server/tomcat/TomcatServiceDestroyedConnectorTest.java\nindex 8c325ed02..526db1d6d 100644\n--- a/tomcat9/src/test/java/com/linecorp/armeria/server/tomcat/TomcatServiceDestroyedConnectorTest.java\n+++ b/tomcat9/src/test/java/com/linecorp/armeria/server/tomcat/TomcatServiceDestroyedConnectorTest.java\n\n@@ -47,21 +45,14 @@ class TomcatServiceDestroyedConnectorTest {\n             tomcatWithWebApp.start();\n             sb.serviceUnder(\"/api/\", TomcatService.of(tomcatWithWebApp.getConnector()));\n         }\n-\n-        @Override\n-        protected boolean runForEachTest() {\n-            return true;\n-        }\n     };\n \n-    @RepeatedTest(100)\n+    @Test\n     void serviceUnavailableAfterConnectorIsDestroyed() throws LifecycleException {\n         final WebClient client = WebClient.of(server.httpUri());\n         assertThat(client.get(\"/api/\").aggregate().join().status()).isSameAs(HttpStatus.OK);\n         tomcatWithWebApp.stop();\n         tomcatWithWebApp.getConnector().destroy();\n-        // Use await because it can take time to destroy the connector.\n-        await().untilAsserted(() -> assertThat(client.get(\"/api/\").aggregate().join().status())\n-                .isSameAs(HttpStatus.SERVICE_UNAVAILABLE));\n+        assertThat(client.get(\"/api/\").aggregate().join().status()).isSameAs(HttpStatus.SERVICE_UNAVAILABLE);\n     }\n }\n"}}, {"oid": "f491602060aa552a040380dbde2afc89a0475c1a", "url": "https://github.com/line/armeria/commit/f491602060aa552a040380dbde2afc89a0475c1a", "message": "Fix checkstyle", "committedDate": "2020-12-29T03:59:00Z", "type": "commit"}, {"oid": "a01f1543afb5c0be774a73703de4cbf731da6fe0", "url": "https://github.com/line/armeria/commit/a01f1543afb5c0be774a73703de4cbf731da6fe0", "message": "Fix available", "committedDate": "2020-12-29T05:12:58Z", "type": "commit"}]}