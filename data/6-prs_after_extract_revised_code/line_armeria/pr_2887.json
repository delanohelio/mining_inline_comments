{"pr_number": 2887, "pr_title": "Successful events for proxy ssl should be ignored", "pr_createdAt": "2020-07-08T14:19:14Z", "pr_url": "https://github.com/line/armeria/pull/2887", "timeline": [{"oid": "ae3a308968e68594a442f7b0815e32147985bf77", "url": "https://github.com/line/armeria/commit/ae3a308968e68594a442f7b0815e32147985bf77", "message": "Successful events for proxxy ssl should be ignored", "committedDate": "2020-07-08T14:11:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTYyNTQ0OA==", "url": "https://github.com/line/armeria/pull/2887#discussion_r451625448", "bodyText": "How about adding more detail to this comment, like when this can happen?", "author": "trustin", "createdAt": "2020-07-08T15:17:36Z", "path": "core/src/main/java/com/linecorp/armeria/client/HttpClientPipelineConfigurator.java", "diffHunk": "@@ -195,6 +195,11 @@ public void userEventTriggered(ChannelHandlerContext ctx, Object evt) throws Exc\n                     return;\n                 }\n \n+                if (!sslHandler.handshakeFuture().isDone()) {\n+                    // Ignore successful handshake events for other SslHandlers in the pipeline.", "originalCommit": "ae3a308968e68594a442f7b0815e32147985bf77", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1a9b27c0d69c0bd02506a747b899799413e157de", "chunk": "diff --git a/core/src/main/java/com/linecorp/armeria/client/HttpClientPipelineConfigurator.java b/core/src/main/java/com/linecorp/armeria/client/HttpClientPipelineConfigurator.java\nindex 656608ce9..cb90f66ad 100644\n--- a/core/src/main/java/com/linecorp/armeria/client/HttpClientPipelineConfigurator.java\n+++ b/core/src/main/java/com/linecorp/armeria/client/HttpClientPipelineConfigurator.java\n\n@@ -197,6 +197,9 @@ final class HttpClientPipelineConfigurator extends ChannelDuplexHandler {\n \n                 if (!sslHandler.handshakeFuture().isDone()) {\n                     // Ignore successful handshake events for other SslHandlers in the pipeline.\n+                    // This can happen when a client connects with ssl to an encrypted proxy server,\n+                    // and then to an encrypted backend. Without this check, clients may incorrectly\n+                    // conclude protocol negotiation and start a new session.\n                     return;\n                 }\n \n"}}, {"oid": "1a9b27c0d69c0bd02506a747b899799413e157de", "url": "https://github.com/line/armeria/commit/1a9b27c0d69c0bd02506a747b899799413e157de", "message": "add more explanation on why we need to check handshakeFuture", "committedDate": "2020-07-08T15:50:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTkzMTY1MQ==", "url": "https://github.com/line/armeria/pull/2887#discussion_r451931651", "bodyText": "How about testHttpToHttpsEndpoint? so that people get easily noticed the differences with the test below.\nOr I think we can just combine these two tests into one.", "author": "minwoox", "createdAt": "2020-07-09T02:41:57Z", "path": "core/src/test/java/com/linecorp/armeria/client/proxy/ProxyClientIntegrationTest.java", "diffHunk": "@@ -331,12 +336,32 @@ void testHttpProxyPrefaceFailure() throws Exception {\n         clientFactory.close();\n     }\n \n-    @Test\n-    void testHttpsProxyBasicCase() throws Exception {\n+    @ParameterizedTest\n+    @EnumSource(value = SessionProtocol.class, mode = Mode.INCLUDE, names = {\"H1C\", \"H2C\", \"HTTP\"})\n+    void testHttpsProxyBasicCase(SessionProtocol protocol) throws Exception {", "originalCommit": "1a9b27c0d69c0bd02506a747b899799413e157de", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2f032ed4ff07c60a509501f84ad76f52db1b2ab1", "chunk": "diff --git a/core/src/test/java/com/linecorp/armeria/client/proxy/ProxyClientIntegrationTest.java b/core/src/test/java/com/linecorp/armeria/client/proxy/ProxyClientIntegrationTest.java\nindex 7fc67468b..58a8bb8d1 100644\n--- a/core/src/test/java/com/linecorp/armeria/client/proxy/ProxyClientIntegrationTest.java\n+++ b/core/src/test/java/com/linecorp/armeria/client/proxy/ProxyClientIntegrationTest.java\n\n@@ -337,31 +339,12 @@ class ProxyClientIntegrationTest {\n     }\n \n     @ParameterizedTest\n-    @EnumSource(value = SessionProtocol.class, mode = Mode.INCLUDE, names = {\"H1C\", \"H2C\", \"HTTP\"})\n-    void testHttpsProxyBasicCase(SessionProtocol protocol) throws Exception {\n+    @MethodSource(\"sessionAndEndpointProvider\")\n+    void testHttpsProxy(SessionProtocol protocol, Endpoint endpoint) throws Exception {\n         final ClientFactory clientFactory =\n                 ClientFactory.builder().tlsNoVerify().proxyConfig(\n                         ProxyConfig.connect(httpsProxyServer.address(), true)).build();\n-        final WebClient webClient = WebClient.builder(protocol, backendServer.httpEndpoint())\n-                                             .factory(clientFactory)\n-                                             .decorator(LoggingClient.newDecorator())\n-                                             .build();\n-        final CompletableFuture<AggregatedHttpResponse> responseFuture =\n-                webClient.get(PROXY_PATH).aggregate();\n-        final AggregatedHttpResponse response = responseFuture.join();\n-        assertThat(response.status()).isEqualTo(OK);\n-        assertThat(response.contentUtf8()).isEqualTo(SUCCESS_RESPONSE);\n-        assertThat(numSuccessfulProxyRequests).isEqualTo(1);\n-        clientFactory.close();\n-    }\n-\n-    @ParameterizedTest\n-    @EnumSource(value = SessionProtocol.class, mode = Mode.INCLUDE, names = {\"H1\", \"H2\", \"HTTPS\"})\n-    void testHttpsToHttpsEndpoint(SessionProtocol protocol) throws Exception {\n-        final ClientFactory clientFactory =\n-                ClientFactory.builder().tlsNoVerify().proxyConfig(\n-                        ProxyConfig.connect(httpsProxyServer.address(), true)).build();\n-        final WebClient webClient = WebClient.builder(protocol, backendServer.httpsEndpoint())\n+        final WebClient webClient = WebClient.builder(protocol, endpoint)\n                                              .factory(clientFactory)\n                                              .decorator(LoggingClient.newDecorator())\n                                              .build();\n"}}, {"oid": "2f032ed4ff07c60a509501f84ad76f52db1b2ab1", "url": "https://github.com/line/armeria/commit/2f032ed4ff07c60a509501f84ad76f52db1b2ab1", "message": "combine tests for https proxy", "committedDate": "2020-07-09T13:08:06Z", "type": "commit"}]}