{"pr_number": 2506, "pr_title": "Replace craft preview transaction list with a single entry.", "pr_createdAt": "2020-02-15T20:58:50Z", "pr_url": "https://github.com/SpongePowered/Sponge/pull/2506", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg4NDAyNg==", "url": "https://github.com/SpongePowered/Sponge/pull/2506#discussion_r382884026", "bodyText": "(nitpick) final this value please.", "author": "gabizou", "createdAt": "2020-02-22T04:04:43Z", "path": "src/main/java/org/spongepowered/common/event/tracking/phase/packet/drag/DragInventoryStopState.java", "diffHunk": "@@ -64,13 +65,13 @@ public static void unwindCraftPreview(InventoryPacketContext context) {\n \n         Inventory craftInv = ((Inventory) player.openContainer).query(QueryOperationTypes.INVENTORY_TYPE.of(CraftingInventory.class));\n         if (craftInv instanceof CraftingInventory) {\n-            List<SlotTransaction> previewTransactions = ((ContainerBridge) player.openContainer).bridge$getPreviewTransactions();\n-            if (!previewTransactions.isEmpty()) {\n+            SlotTransaction previewTransaction = ((ContainerBridge) player.openContainer).bridge$getPreviewTransaction();", "originalCommit": "de04873cc8e81a9279cece915a2343c9bbc98a08", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0f417cfd86180a51c995021d6a499ae7e57b1463", "chunk": "diff --git a/src/main/java/org/spongepowered/common/event/tracking/phase/packet/drag/DragInventoryStopState.java b/src/main/java/org/spongepowered/common/event/tracking/phase/packet/drag/DragInventoryStopState.java\nindex 78154f9e5..3afce28de 100644\n--- a/src/main/java/org/spongepowered/common/event/tracking/phase/packet/drag/DragInventoryStopState.java\n+++ b/src/main/java/org/spongepowered/common/event/tracking/phase/packet/drag/DragInventoryStopState.java\n\n@@ -65,7 +65,7 @@ public static void unwindCraftPreview(InventoryPacketContext context) {\n \n         Inventory craftInv = ((Inventory) player.openContainer).query(QueryOperationTypes.INVENTORY_TYPE.of(CraftingInventory.class));\n         if (craftInv instanceof CraftingInventory) {\n-            SlotTransaction previewTransaction = ((ContainerBridge) player.openContainer).bridge$getPreviewTransaction();\n+            final SlotTransaction previewTransaction = ((ContainerBridge) player.openContainer).bridge$getPreviewTransaction();\n             if (previewTransaction != null) {\n                 CraftingRecipe recipe = SpongeCraftingRecipeRegistry\n                         .getInstance().findMatchingRecipe(((CraftingInventory) craftInv).getCraftingGrid(), ((World) player.world)).orElse(null);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg4NDA2NA==", "url": "https://github.com/SpongePowered/Sponge/pull/2506#discussion_r382884064", "bodyText": "(nitpick) final this variable please", "author": "gabizou", "createdAt": "2020-02-22T04:05:33Z", "path": "src/main/java/org/spongepowered/common/event/tracking/phase/packet/inventory/PlaceRecipePacketState.java", "diffHunk": "@@ -79,15 +80,14 @@ public void unwind(final InventoryPacketContext context) {\n             return;\n         }\n \n-        final List<SlotTransaction> previewTransactions = ((ContainerBridge) player.openContainer).bridge$getPreviewTransactions();\n-        if (previewTransactions.isEmpty()) {\n+        SlotTransaction previewTransaction = ((ContainerBridge) player.openContainer).bridge$getPreviewTransaction();", "originalCommit": "de04873cc8e81a9279cece915a2343c9bbc98a08", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0f417cfd86180a51c995021d6a499ae7e57b1463", "chunk": "diff --git a/src/main/java/org/spongepowered/common/event/tracking/phase/packet/inventory/PlaceRecipePacketState.java b/src/main/java/org/spongepowered/common/event/tracking/phase/packet/inventory/PlaceRecipePacketState.java\nindex 5006dd28b..4f9d29f64 100644\n--- a/src/main/java/org/spongepowered/common/event/tracking/phase/packet/inventory/PlaceRecipePacketState.java\n+++ b/src/main/java/org/spongepowered/common/event/tracking/phase/packet/inventory/PlaceRecipePacketState.java\n\n@@ -80,7 +80,7 @@ public void unwind(final InventoryPacketContext context) {\n             return;\n         }\n \n-        SlotTransaction previewTransaction = ((ContainerBridge) player.openContainer).bridge$getPreviewTransaction();\n+        final SlotTransaction previewTransaction = ((ContainerBridge) player.openContainer).bridge$getPreviewTransaction();\n         if (previewTransaction == null) {\n             final CraftingOutput slot = ((CraftingInventory) craftInv).getResult();\n             previewTransaction = new SlotTransaction(slot, ItemStackSnapshot.NONE, ItemStackUtil.snapshotOf(slot.peek().orElse(ItemStack.empty())));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg4NDE0Nw==", "url": "https://github.com/SpongePowered/Sponge/pull/2506#discussion_r382884147", "bodyText": "Could this be configurable?", "author": "gabizou", "createdAt": "2020-02-22T04:06:45Z", "path": "src/main/java/org/spongepowered/common/mixin/core/inventory/ContainerMixin.java", "diffHunk": "@@ -431,26 +424,35 @@ private void beforeSlotChangedCraftingGrid(final InventoryCraftResult output, fi\n         final ItemStackSnapshot repl = ItemStackUtil.snapshotOf(output.getStackInSlot(index));\n \n         final SlotAdapter slot = this.impl$getAdapters().get(index);\n-        this.impl$capturedCraftPreviewTransactions.add(new SlotTransaction(slot, orig, repl));\n+        if (this.impl$capturedCraftPreviewTransaction == null) {\n+            this.impl$capturedCraftPreviewTransaction = new SlotTransaction(slot, orig, repl);\n+        } else if (this.impl$capturedCraftPreviewTransaction.getSlot().equals(slot)\n+                && this.impl$capturedCraftPreviewTransaction.getFinal().equals(orig)) {\n+            this.impl$capturedCraftPreviewTransaction = new SlotTransaction(slot, this.impl$capturedCraftPreviewTransaction.getOriginal(), repl);\n+        } else {\n+            SlotTransaction replace = new SlotTransaction(slot, orig, repl);\n+            SpongeImpl.getLogger().warn(\"Could not merge craft preview transactions - some events may break (original {}, replace {})\",", "originalCommit": "de04873cc8e81a9279cece915a2343c9bbc98a08", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0f417cfd86180a51c995021d6a499ae7e57b1463", "chunk": "diff --git a/src/main/java/org/spongepowered/common/mixin/core/inventory/ContainerMixin.java b/src/main/java/org/spongepowered/common/mixin/core/inventory/ContainerMixin.java\nindex 8d87d0aad..005302db7 100644\n--- a/src/main/java/org/spongepowered/common/mixin/core/inventory/ContainerMixin.java\n+++ b/src/main/java/org/spongepowered/common/mixin/core/inventory/ContainerMixin.java\n\n@@ -431,8 +432,16 @@ private void beforeSlotChangedCraftingGrid(final InventoryCraftResult output, fi\n             this.impl$capturedCraftPreviewTransaction = new SlotTransaction(slot, this.impl$capturedCraftPreviewTransaction.getOriginal(), repl);\n         } else {\n             SlotTransaction replace = new SlotTransaction(slot, orig, repl);\n-            SpongeImpl.getLogger().warn(\"Could not merge craft preview transactions - some events may break (original {}, replace {})\",\n-                    this.impl$capturedCraftPreviewTransaction, replace);\n+            ContainerMixin.impl$numTransactionErrorsLogged++;\n+            int maxLogs = SpongeImpl.getGlobalConfigAdapter().getConfig().getLogging().logTransactionMergeFailure();\n+            if (maxLogs <= 0 || ContainerMixin.impl$numTransactionErrorsLogged <= maxLogs) {\n+                SpongeImpl.getLogger().warn(\"Could not merge craft preview transactions - some events may break (original {}, replace {})\",\n+                        this.impl$capturedCraftPreviewTransaction, replace);\n+                if (ContainerMixin.impl$numTransactionErrorsLogged == maxLogs) {\n+                    SpongeImpl.getLogger().warn(\"Further warnings about this will be suppressed. Change transaction-merge-fail in global.conf to \"\n+                            + \"show more.\");\n+                }\n+            }\n             this.impl$capturedCraftPreviewTransaction = replace;\n         }\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg4NDE3NQ==", "url": "https://github.com/SpongePowered/Sponge/pull/2506#discussion_r382884175", "bodyText": "(nitpick) final this variable please", "author": "gabizou", "createdAt": "2020-02-22T04:07:25Z", "path": "src/main/java/org/spongepowered/common/mixin/core/inventory/SlotCraftingMixin.java", "diffHunk": "@@ -174,23 +175,21 @@ private void afterTake(final EntityPlayer thePlayer, final ItemStack stack, fina\n         ((ContainerBridge) container).bridge$setFirePreview(true);\n         this.impl$craftedStack = null;\n \n-        final List<SlotTransaction> previewTransactions = ((ContainerBridge) container).bridge$getPreviewTransactions();\n+        SlotTransaction previewTransaction = ((ContainerBridge) container).bridge$getPreviewTransaction();", "originalCommit": "de04873cc8e81a9279cece915a2343c9bbc98a08", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0f417cfd86180a51c995021d6a499ae7e57b1463", "chunk": "diff --git a/src/main/java/org/spongepowered/common/mixin/core/inventory/SlotCraftingMixin.java b/src/main/java/org/spongepowered/common/mixin/core/inventory/SlotCraftingMixin.java\nindex 3f67e1326..057be436a 100644\n--- a/src/main/java/org/spongepowered/common/mixin/core/inventory/SlotCraftingMixin.java\n+++ b/src/main/java/org/spongepowered/common/mixin/core/inventory/SlotCraftingMixin.java\n\n@@ -175,7 +175,7 @@ private void afterTake(final EntityPlayer thePlayer, final ItemStack stack, fina\n         ((ContainerBridge) container).bridge$setFirePreview(true);\n         this.impl$craftedStack = null;\n \n-        SlotTransaction previewTransaction = ((ContainerBridge) container).bridge$getPreviewTransaction();\n+        final SlotTransaction previewTransaction = ((ContainerBridge) container).bridge$getPreviewTransaction();\n         if (this.craftMatrix.isEmpty()) {\n             return; // CraftMatrix is empty and/or no transaction present. Do not fire Preview.\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE4Njc3Mg==", "url": "https://github.com/SpongePowered/Sponge/pull/2506#discussion_r383186772", "bodyText": "I know @gabizou said \"could this be configurable?\" and attached it to the log line, but I'm not sure this is what he meant - I think we should always be reporting a failure to the log.\nWas the meaning that this entire behaviour on failure should be configurable - as in, original vs replacement?", "author": "dualspiral", "createdAt": "2020-02-24T10:32:40Z", "path": "src/main/java/org/spongepowered/common/config/category/LoggingCategory.java", "diffHunk": "@@ -179,6 +181,10 @@ public void setLogEntitySpeedRemoval(boolean flag) {\n         this.logEntitySpeedRemoval = flag;\n     }\n \n+    public boolean logTransactionMergeFailure() {", "originalCommit": "0526f87d3e8cbf53306d41e4bd550fbb1f3a9d41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA5MzIzOA==", "url": "https://github.com/SpongePowered/Sponge/pull/2506#discussion_r390093238", "bodyText": "Well this and whether silencing after X number of failed/merged transactions happens.", "author": "gabizou", "createdAt": "2020-03-10T04:46:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE4Njc3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njg0OTc3Ng==", "url": "https://github.com/SpongePowered/Sponge/pull/2506#discussion_r396849776", "bodyText": "I can understand the configuration to \"silence after X messages\", but why would the behavior of the failure need to be configurable? I can't imagine a server owner changing that.", "author": "JBYoshi", "createdAt": "2020-03-24T01:12:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE4Njc3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "0f417cfd86180a51c995021d6a499ae7e57b1463", "chunk": "diff --git a/src/main/java/org/spongepowered/common/config/category/LoggingCategory.java b/src/main/java/org/spongepowered/common/config/category/LoggingCategory.java\nindex 418fd1568..c8db53a27 100644\n--- a/src/main/java/org/spongepowered/common/config/category/LoggingCategory.java\n+++ b/src/main/java/org/spongepowered/common/config/category/LoggingCategory.java\n\n@@ -181,7 +182,7 @@ public void setLogEntitySpeedRemoval(boolean flag) {\n         this.logEntitySpeedRemoval = flag;\n     }\n \n-    public boolean logTransactionMergeFailure() {\n+    public int logTransactionMergeFailure() {\n         return this.logTransactionMergeFailure;\n     }\n \n"}}, {"oid": "0f417cfd86180a51c995021d6a499ae7e57b1463", "url": "https://github.com/SpongePowered/Sponge/commit/0f417cfd86180a51c995021d6a499ae7e57b1463", "message": "Make the number of log messages configurable.", "committedDate": "2020-03-24T01:18:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg2MDI2Ng==", "url": "https://github.com/SpongePowered/Sponge/pull/2506#discussion_r437860266", "bodyText": "Should this comment be multi-lined to roughly 100 characters?", "author": "gabizou", "createdAt": "2020-06-10T04:57:56Z", "path": "src/main/java/org/spongepowered/common/config/category/LoggingCategory.java", "diffHunk": "@@ -64,6 +64,9 @@\n     private boolean logEntityCollisionChecks = false;\n     @Setting(value = \"entity-speed-removal\", comment = \"Whether to log entity removals due to speed\")\n     private boolean logEntitySpeedRemoval = false;\n+    @Setting(value = \"transaction-merge-fail\", comment = \"Log when two conflicting changes are merged into one. (This number specifies the maximum \"\n+            + \"number of messages to log. Set to 0 to show all messages.)\")", "originalCommit": "0f417cfd86180a51c995021d6a499ae7e57b1463", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bdcae79551695b85118d269dbd3ac38fb1b1932a", "chunk": "diff --git a/src/main/java/org/spongepowered/common/config/category/LoggingCategory.java b/src/main/java/org/spongepowered/common/config/category/LoggingCategory.java\nindex c8db53a27..e9fb6d285 100644\n--- a/src/main/java/org/spongepowered/common/config/category/LoggingCategory.java\n+++ b/src/main/java/org/spongepowered/common/config/category/LoggingCategory.java\n\n@@ -52,11 +53,15 @@\n     private boolean entityDespawnLogging = false;\n     @Setting(value = \"entity-death\", comment = \"Log when living entities are destroyed\")\n     private boolean entityDeathLogging = false;\n-    @Setting(value = \"exploit-sign-command-updates\", comment = \"Log when server receives exploited packet to update a sign containing commands from player with no permission.\")\n+    @Setting(value = \"exploit-sign-command-updates\", comment = \"\"\n+            + \"Log when server receives exploited packet to update a sign containing commands\\n\"\n+            + \"from player with no permission.\")\n     public boolean logExploitSignCommandUpdates = false;\n-    @Setting(value = \"exploit-itemstack-name-overflow\", comment = \"Log when server receives exploited packet with itemstack name exceeding string limit.\")\n+    @Setting(value = \"exploit-itemstack-name-overflow\",\n+            comment = \"Log when server receives exploited packet with itemstack name exceeding string limit.\")\n     public boolean logExploitItemStackNameOverflow = false;\n-    @Setting(value = \"exploit-respawn-invisibility\", comment = \"Log when player attempts to respawn invisible to surrounding players.\")\n+    @Setting(value = \"exploit-respawn-invisibility\",\n+            comment = \"Log when player attempts to respawn invisible to surrounding players.\")\n     public boolean logExploitRespawnInvisibility = false;\n     @Setting(value = \"log-stacktraces\", comment = \"Add stack traces to dev logging\")\n     private boolean logWithStackTraces = false;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg2MDgxNw==", "url": "https://github.com/SpongePowered/Sponge/pull/2506#discussion_r437860817", "bodyText": "Are you doing the correct equality check here? Or are you aiming to just allow instance equality checking the ItemStackSnapshot?", "author": "gabizou", "createdAt": "2020-06-10T05:00:08Z", "path": "src/main/java/org/spongepowered/common/mixin/core/inventory/ContainerMixin.java", "diffHunk": "@@ -431,26 +425,43 @@ private void beforeSlotChangedCraftingGrid(final InventoryCraftResult output, fi\n         final ItemStackSnapshot repl = ItemStackUtil.snapshotOf(output.getStackInSlot(index));\n \n         final SlotAdapter slot = this.impl$getAdapters().get(index);\n-        this.impl$capturedCraftPreviewTransactions.add(new SlotTransaction(slot, orig, repl));\n+        if (this.impl$capturedCraftPreviewTransaction == null) {\n+            this.impl$capturedCraftPreviewTransaction = new SlotTransaction(slot, orig, repl);\n+        } else if (this.impl$capturedCraftPreviewTransaction.getSlot().equals(slot)\n+                && this.impl$capturedCraftPreviewTransaction.getFinal().equals(orig)) {", "originalCommit": "0f417cfd86180a51c995021d6a499ae7e57b1463", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcwODA4Ng==", "url": "https://github.com/SpongePowered/Sponge/pull/2506#discussion_r446708086", "bodyText": "It has to be equals() - orig is created fresh each time the method is called.", "author": "JBYoshi", "createdAt": "2020-06-28T22:49:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg2MDgxNw=="}], "type": "inlineReview", "revised_code": {"commit": "bdcae79551695b85118d269dbd3ac38fb1b1932a", "chunk": "diff --git a/src/main/java/org/spongepowered/common/mixin/core/inventory/ContainerMixin.java b/src/main/java/org/spongepowered/common/mixin/core/inventory/ContainerMixin.java\nindex 005302db7..8a8d4d2fa 100644\n--- a/src/main/java/org/spongepowered/common/mixin/core/inventory/ContainerMixin.java\n+++ b/src/main/java/org/spongepowered/common/mixin/core/inventory/ContainerMixin.java\n\n@@ -432,16 +434,8 @@ private void beforeSlotChangedCraftingGrid(final InventoryCraftResult output, fi\n             this.impl$capturedCraftPreviewTransaction = new SlotTransaction(slot, this.impl$capturedCraftPreviewTransaction.getOriginal(), repl);\n         } else {\n             SlotTransaction replace = new SlotTransaction(slot, orig, repl);\n-            ContainerMixin.impl$numTransactionErrorsLogged++;\n-            int maxLogs = SpongeImpl.getGlobalConfigAdapter().getConfig().getLogging().logTransactionMergeFailure();\n-            if (maxLogs <= 0 || ContainerMixin.impl$numTransactionErrorsLogged <= maxLogs) {\n-                SpongeImpl.getLogger().warn(\"Could not merge craft preview transactions - some events may break (original {}, replace {})\",\n-                        this.impl$capturedCraftPreviewTransaction, replace);\n-                if (ContainerMixin.impl$numTransactionErrorsLogged == maxLogs) {\n-                    SpongeImpl.getLogger().warn(\"Further warnings about this will be suppressed. Change transaction-merge-fail in global.conf to \"\n-                            + \"show more.\");\n-                }\n-            }\n+            SpongeImpl.getLogger().warn(\"Could not merge craft preview transactions - some events may break (original {}, replace {})\",\n+                    this.impl$capturedCraftPreviewTransaction, replace);\n             this.impl$capturedCraftPreviewTransaction = replace;\n         }\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg2MDkyNw==", "url": "https://github.com/SpongePowered/Sponge/pull/2506#discussion_r437860927", "bodyText": "Off the top of my head, do SlotAdapters implement equals?", "author": "gabizou", "createdAt": "2020-06-10T05:00:35Z", "path": "src/main/java/org/spongepowered/common/mixin/core/inventory/ContainerMixin.java", "diffHunk": "@@ -431,26 +425,43 @@ private void beforeSlotChangedCraftingGrid(final InventoryCraftResult output, fi\n         final ItemStackSnapshot repl = ItemStackUtil.snapshotOf(output.getStackInSlot(index));\n \n         final SlotAdapter slot = this.impl$getAdapters().get(index);\n-        this.impl$capturedCraftPreviewTransactions.add(new SlotTransaction(slot, orig, repl));\n+        if (this.impl$capturedCraftPreviewTransaction == null) {\n+            this.impl$capturedCraftPreviewTransaction = new SlotTransaction(slot, orig, repl);\n+        } else if (this.impl$capturedCraftPreviewTransaction.getSlot().equals(slot)", "originalCommit": "0f417cfd86180a51c995021d6a499ae7e57b1463", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcwODI4MA==", "url": "https://github.com/SpongePowered/Sponge/pull/2506#discussion_r446708280", "bodyText": "Not currently. It seems to be an easy implementation - it just requires checking the underlying inventory and the index - so I'll do that.", "author": "JBYoshi", "createdAt": "2020-06-28T22:51:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg2MDkyNw=="}], "type": "inlineReview", "revised_code": {"commit": "bdcae79551695b85118d269dbd3ac38fb1b1932a", "chunk": "diff --git a/src/main/java/org/spongepowered/common/mixin/core/inventory/ContainerMixin.java b/src/main/java/org/spongepowered/common/mixin/core/inventory/ContainerMixin.java\nindex 005302db7..8a8d4d2fa 100644\n--- a/src/main/java/org/spongepowered/common/mixin/core/inventory/ContainerMixin.java\n+++ b/src/main/java/org/spongepowered/common/mixin/core/inventory/ContainerMixin.java\n\n@@ -432,16 +434,8 @@ private void beforeSlotChangedCraftingGrid(final InventoryCraftResult output, fi\n             this.impl$capturedCraftPreviewTransaction = new SlotTransaction(slot, this.impl$capturedCraftPreviewTransaction.getOriginal(), repl);\n         } else {\n             SlotTransaction replace = new SlotTransaction(slot, orig, repl);\n-            ContainerMixin.impl$numTransactionErrorsLogged++;\n-            int maxLogs = SpongeImpl.getGlobalConfigAdapter().getConfig().getLogging().logTransactionMergeFailure();\n-            if (maxLogs <= 0 || ContainerMixin.impl$numTransactionErrorsLogged <= maxLogs) {\n-                SpongeImpl.getLogger().warn(\"Could not merge craft preview transactions - some events may break (original {}, replace {})\",\n-                        this.impl$capturedCraftPreviewTransaction, replace);\n-                if (ContainerMixin.impl$numTransactionErrorsLogged == maxLogs) {\n-                    SpongeImpl.getLogger().warn(\"Further warnings about this will be suppressed. Change transaction-merge-fail in global.conf to \"\n-                            + \"show more.\");\n-                }\n-            }\n+            SpongeImpl.getLogger().warn(\"Could not merge craft preview transactions - some events may break (original {}, replace {})\",\n+                    this.impl$capturedCraftPreviewTransaction, replace);\n             this.impl$capturedCraftPreviewTransaction = replace;\n         }\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg2MTA1Mg==", "url": "https://github.com/SpongePowered/Sponge/pull/2506#discussion_r437861052", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        SlotTransaction replace = new SlotTransaction(slot, orig, repl);\n          \n          \n            \n                        final SlotTransaction replace = new SlotTransaction(slot, orig, repl);", "author": "gabizou", "createdAt": "2020-06-10T05:01:01Z", "path": "src/main/java/org/spongepowered/common/mixin/core/inventory/ContainerMixin.java", "diffHunk": "@@ -431,26 +425,43 @@ private void beforeSlotChangedCraftingGrid(final InventoryCraftResult output, fi\n         final ItemStackSnapshot repl = ItemStackUtil.snapshotOf(output.getStackInSlot(index));\n \n         final SlotAdapter slot = this.impl$getAdapters().get(index);\n-        this.impl$capturedCraftPreviewTransactions.add(new SlotTransaction(slot, orig, repl));\n+        if (this.impl$capturedCraftPreviewTransaction == null) {\n+            this.impl$capturedCraftPreviewTransaction = new SlotTransaction(slot, orig, repl);\n+        } else if (this.impl$capturedCraftPreviewTransaction.getSlot().equals(slot)\n+                && this.impl$capturedCraftPreviewTransaction.getFinal().equals(orig)) {\n+            this.impl$capturedCraftPreviewTransaction = new SlotTransaction(slot, this.impl$capturedCraftPreviewTransaction.getOriginal(), repl);\n+        } else {\n+            SlotTransaction replace = new SlotTransaction(slot, orig, repl);", "originalCommit": "0f417cfd86180a51c995021d6a499ae7e57b1463", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bdcae79551695b85118d269dbd3ac38fb1b1932a", "chunk": "diff --git a/src/main/java/org/spongepowered/common/mixin/core/inventory/ContainerMixin.java b/src/main/java/org/spongepowered/common/mixin/core/inventory/ContainerMixin.java\nindex 005302db7..8a8d4d2fa 100644\n--- a/src/main/java/org/spongepowered/common/mixin/core/inventory/ContainerMixin.java\n+++ b/src/main/java/org/spongepowered/common/mixin/core/inventory/ContainerMixin.java\n\n@@ -432,16 +434,8 @@ private void beforeSlotChangedCraftingGrid(final InventoryCraftResult output, fi\n             this.impl$capturedCraftPreviewTransaction = new SlotTransaction(slot, this.impl$capturedCraftPreviewTransaction.getOriginal(), repl);\n         } else {\n             SlotTransaction replace = new SlotTransaction(slot, orig, repl);\n-            ContainerMixin.impl$numTransactionErrorsLogged++;\n-            int maxLogs = SpongeImpl.getGlobalConfigAdapter().getConfig().getLogging().logTransactionMergeFailure();\n-            if (maxLogs <= 0 || ContainerMixin.impl$numTransactionErrorsLogged <= maxLogs) {\n-                SpongeImpl.getLogger().warn(\"Could not merge craft preview transactions - some events may break (original {}, replace {})\",\n-                        this.impl$capturedCraftPreviewTransaction, replace);\n-                if (ContainerMixin.impl$numTransactionErrorsLogged == maxLogs) {\n-                    SpongeImpl.getLogger().warn(\"Further warnings about this will be suppressed. Change transaction-merge-fail in global.conf to \"\n-                            + \"show more.\");\n-                }\n-            }\n+            SpongeImpl.getLogger().warn(\"Could not merge craft preview transactions - some events may break (original {}, replace {})\",\n+                    this.impl$capturedCraftPreviewTransaction, replace);\n             this.impl$capturedCraftPreviewTransaction = replace;\n         }\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg2MTQwOQ==", "url": "https://github.com/SpongePowered/Sponge/pull/2506#discussion_r437861409", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        int maxLogs = SpongeImpl.getGlobalConfigAdapter().getConfig().getLogging().logTransactionMergeFailure();\n          \n          \n            \n                        final int maxLogs = SpongeImpl.getGlobalConfigAdapter().getConfig().getLogging().logTransactionMergeFailure();", "author": "gabizou", "createdAt": "2020-06-10T05:02:36Z", "path": "src/main/java/org/spongepowered/common/mixin/core/inventory/ContainerMixin.java", "diffHunk": "@@ -431,26 +425,43 @@ private void beforeSlotChangedCraftingGrid(final InventoryCraftResult output, fi\n         final ItemStackSnapshot repl = ItemStackUtil.snapshotOf(output.getStackInSlot(index));\n \n         final SlotAdapter slot = this.impl$getAdapters().get(index);\n-        this.impl$capturedCraftPreviewTransactions.add(new SlotTransaction(slot, orig, repl));\n+        if (this.impl$capturedCraftPreviewTransaction == null) {\n+            this.impl$capturedCraftPreviewTransaction = new SlotTransaction(slot, orig, repl);\n+        } else if (this.impl$capturedCraftPreviewTransaction.getSlot().equals(slot)\n+                && this.impl$capturedCraftPreviewTransaction.getFinal().equals(orig)) {\n+            this.impl$capturedCraftPreviewTransaction = new SlotTransaction(slot, this.impl$capturedCraftPreviewTransaction.getOriginal(), repl);\n+        } else {\n+            SlotTransaction replace = new SlotTransaction(slot, orig, repl);\n+            ContainerMixin.impl$numTransactionErrorsLogged++;\n+            int maxLogs = SpongeImpl.getGlobalConfigAdapter().getConfig().getLogging().logTransactionMergeFailure();", "originalCommit": "0f417cfd86180a51c995021d6a499ae7e57b1463", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bdcae79551695b85118d269dbd3ac38fb1b1932a", "chunk": "diff --git a/src/main/java/org/spongepowered/common/mixin/core/inventory/ContainerMixin.java b/src/main/java/org/spongepowered/common/mixin/core/inventory/ContainerMixin.java\nindex 005302db7..8a8d4d2fa 100644\n--- a/src/main/java/org/spongepowered/common/mixin/core/inventory/ContainerMixin.java\n+++ b/src/main/java/org/spongepowered/common/mixin/core/inventory/ContainerMixin.java\n\n@@ -432,16 +434,8 @@ private void beforeSlotChangedCraftingGrid(final InventoryCraftResult output, fi\n             this.impl$capturedCraftPreviewTransaction = new SlotTransaction(slot, this.impl$capturedCraftPreviewTransaction.getOriginal(), repl);\n         } else {\n             SlotTransaction replace = new SlotTransaction(slot, orig, repl);\n-            ContainerMixin.impl$numTransactionErrorsLogged++;\n-            int maxLogs = SpongeImpl.getGlobalConfigAdapter().getConfig().getLogging().logTransactionMergeFailure();\n-            if (maxLogs <= 0 || ContainerMixin.impl$numTransactionErrorsLogged <= maxLogs) {\n-                SpongeImpl.getLogger().warn(\"Could not merge craft preview transactions - some events may break (original {}, replace {})\",\n-                        this.impl$capturedCraftPreviewTransaction, replace);\n-                if (ContainerMixin.impl$numTransactionErrorsLogged == maxLogs) {\n-                    SpongeImpl.getLogger().warn(\"Further warnings about this will be suppressed. Change transaction-merge-fail in global.conf to \"\n-                            + \"show more.\");\n-                }\n-            }\n+            SpongeImpl.getLogger().warn(\"Could not merge craft preview transactions - some events may break (original {}, replace {})\",\n+                    this.impl$capturedCraftPreviewTransaction, replace);\n             this.impl$capturedCraftPreviewTransaction = replace;\n         }\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg2MTg1Mg==", "url": "https://github.com/SpongePowered/Sponge/pull/2506#discussion_r437861852", "bodyText": "Static fields should be in their own body imo. Make it well aware they are static.", "author": "gabizou", "createdAt": "2020-06-10T05:04:21Z", "path": "src/main/java/org/spongepowered/common/mixin/core/inventory/ContainerMixin.java", "diffHunk": "@@ -119,7 +120,8 @@\n     //private boolean postPreCraftEvent = true; // used to prevent multiple craft events to fire when setting multiple slots simultaneously\n     private List<SlotTransaction> impl$capturedSlotTransactions = new ArrayList<>();\n     private List<SlotTransaction> impl$capturedCraftShiftTransactions = new ArrayList<>();\n-    private List<SlotTransaction> impl$capturedCraftPreviewTransactions = new ArrayList<>();\n+    @Nullable private SlotTransaction impl$capturedCraftPreviewTransaction;\n+    private static int impl$numTransactionErrorsLogged = 0;", "originalCommit": "0f417cfd86180a51c995021d6a499ae7e57b1463", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bdcae79551695b85118d269dbd3ac38fb1b1932a", "chunk": "diff --git a/src/main/java/org/spongepowered/common/mixin/core/inventory/ContainerMixin.java b/src/main/java/org/spongepowered/common/mixin/core/inventory/ContainerMixin.java\nindex 005302db7..8a8d4d2fa 100644\n--- a/src/main/java/org/spongepowered/common/mixin/core/inventory/ContainerMixin.java\n+++ b/src/main/java/org/spongepowered/common/mixin/core/inventory/ContainerMixin.java\n\n@@ -119,11 +121,11 @@\n     private boolean impl$shiftCraft = false;\n     //private boolean postPreCraftEvent = true; // used to prevent multiple craft events to fire when setting multiple slots simultaneously\n     private List<SlotTransaction> impl$capturedSlotTransactions = new ArrayList<>();\n+    private List<SlotTransaction> impl$capturedCurrentCraftShiftTransactions = new ArrayList<>();\n     private List<SlotTransaction> impl$capturedCraftShiftTransactions = new ArrayList<>();\n     @Nullable private SlotTransaction impl$capturedCraftPreviewTransaction;\n-    private static int impl$numTransactionErrorsLogged = 0;\n     private boolean impl$isLensInitialized;\n-    @Nullable private Map<Integer, SlotAdapter> impl$adapters;\n+    @Nullable private Int2ObjectMap<SlotAdapter> impl$adapters;\n     @Nullable private InventoryArchetype impl$archetype;\n     @Nullable private Carrier impl$carrier;\n     @Nullable Predicate<EntityPlayer> impl$canInteractWithPredicate;\n"}}, {"oid": "bdcae79551695b85118d269dbd3ac38fb1b1932a", "url": "https://github.com/SpongePowered/Sponge/commit/bdcae79551695b85118d269dbd3ac38fb1b1932a", "message": "Replace craft preview transaction list with a single entry.\n\nFixes #2505.", "committedDate": "2020-06-28T22:57:54Z", "type": "commit"}, {"oid": "7914452b0ccad466e34890876820a4723996cd2d", "url": "https://github.com/SpongePowered/Sponge/commit/7914452b0ccad466e34890876820a4723996cd2d", "message": "Logging and final variables", "committedDate": "2020-06-28T22:59:05Z", "type": "commit"}, {"oid": "baa9a08bbd13889630939526105d9405e2ff00bf", "url": "https://github.com/SpongePowered/Sponge/commit/baa9a08bbd13889630939526105d9405e2ff00bf", "message": "Make the number of log messages configurable.", "committedDate": "2020-06-28T22:59:26Z", "type": "commit"}, {"oid": "a334460ade447f3b23b4c1ace7cf3aaa470df591", "url": "https://github.com/SpongePowered/Sponge/commit/a334460ade447f3b23b4c1ace7cf3aaa470df591", "message": "More fixes for @gabizou.", "committedDate": "2020-06-28T22:59:27Z", "type": "commit"}, {"oid": "a334460ade447f3b23b4c1ace7cf3aaa470df591", "url": "https://github.com/SpongePowered/Sponge/commit/a334460ade447f3b23b4c1ace7cf3aaa470df591", "message": "More fixes for @gabizou.", "committedDate": "2020-06-28T22:59:27Z", "type": "forcePushed"}]}