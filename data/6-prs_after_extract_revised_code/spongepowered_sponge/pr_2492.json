{"pr_number": 2492, "pr_title": "Fix ClassCastException in ValueProcessorDelegate#offerToStore() method", "pr_createdAt": "2020-01-27T22:23:30Z", "pr_url": "https://github.com/SpongePowered/Sponge/pull/2492", "timeline": [{"oid": "e3ee4b44cf08888082199e1f7770c11b1d31e311", "url": "https://github.com/SpongePowered/Sponge/commit/e3ee4b44cf08888082199e1f7770c11b1d31e311", "message": "Fix ClassCastException in ValueProcessorDelegate#offerToStore() method", "committedDate": "2020-01-27T21:55:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgwODI5Nw==", "url": "https://github.com/SpongePowered/Sponge/pull/2492#discussion_r374808297", "bodyText": "Leaving aside the argument of what getApiValueFromContainer should be returning for the moment, if we go ahead with this way, this should be an ImmutableValue. If you have an ImmutableValue, it'll will be converted to a Value then back to an ImmutableValue again for no particular reason. Minimise conversions please.", "author": "dualspiral", "createdAt": "2020-02-04T17:16:40Z", "path": "src/main/java/org/spongepowered/common/data/util/ValueProcessorDelegate.java", "diffHunk": "@@ -109,11 +110,17 @@ public DataTransactionResult offerToStore(ValueContainer<?> container, E value)\n         }\n         for (ValueProcessor<E, V> processor : this.processors) {\n             if (processor.supports(container)) {\n-                final Optional<V> optional = processor.getApiValueFromContainer(container);\n-                if (optional.isPresent()) {\n-                    V mutable = optional.get();\n-                    ((Value<E>) mutable).set(value);\n-                    return DataTransactionResult.failResult(((Value<E>) mutable).asImmutable());\n+                final Optional<V> currentValueOptional = processor.getApiValueFromContainer(container);\n+                if (currentValueOptional.isPresent()) {\n+                    V currentValue = currentValueOptional.get();\n+                    Value<E> rejectedValue;", "originalCommit": "e3ee4b44cf08888082199e1f7770c11b1d31e311", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk1MTg4NA==", "url": "https://github.com/SpongePowered/Sponge/pull/2492#discussion_r374951884", "bodyText": "I hope I understand you correctly. I made some changes in the next commit.", "author": "Lignium", "createdAt": "2020-02-04T22:10:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgwODI5Nw=="}], "type": "inlineReview", "revised_code": {"commit": "344c9f5f8e11b7ec60aba82c866fb9f4fcad2816", "chunk": "diff --git a/src/main/java/org/spongepowered/common/data/util/ValueProcessorDelegate.java b/src/main/java/org/spongepowered/common/data/util/ValueProcessorDelegate.java\nindex 9c529c0c0..e84600ccf 100644\n--- a/src/main/java/org/spongepowered/common/data/util/ValueProcessorDelegate.java\n+++ b/src/main/java/org/spongepowered/common/data/util/ValueProcessorDelegate.java\n\n@@ -113,14 +114,16 @@ public DataTransactionResult offerToStore(ValueContainer<?> container, E value)\n                 final Optional<V> currentValueOptional = processor.getApiValueFromContainer(container);\n                 if (currentValueOptional.isPresent()) {\n                     V currentValue = currentValueOptional.get();\n-                    Value<E> rejectedValue;\n+                    ImmutableValue<?> rejectedValue;\n                     if (currentValue instanceof Value<?>) {\n-                        rejectedValue = (Value<E>) currentValue;\n+                        Value<E> mutableCurrentValue = (Value<E>) currentValue;\n+                        mutableCurrentValue.set(value);\n+                        rejectedValue = mutableCurrentValue.asImmutable();\n                     } else {\n-                        rejectedValue = ((ImmutableValue<E>) currentValue).asMutable();\n+                        ImmutableValue<E> immutableCurrentValue = (ImmutableValue<E>) currentValue;\n+                        rejectedValue = immutableCurrentValue.with(value);\n                     }\n-                    rejectedValue.set(value);\n-                    return DataTransactionResult.failResult(rejectedValue.asImmutable());\n+                    return DataTransactionResult.failResult(rejectedValue);\n                 }\n             }\n         }\n"}}, {"oid": "344c9f5f8e11b7ec60aba82c866fb9f4fcad2816", "url": "https://github.com/SpongePowered/Sponge/commit/344c9f5f8e11b7ec60aba82c866fb9f4fcad2816", "message": "Minimize conversions", "committedDate": "2020-02-05T22:50:27Z", "type": "commit"}, {"oid": "344c9f5f8e11b7ec60aba82c866fb9f4fcad2816", "url": "https://github.com/SpongePowered/Sponge/commit/344c9f5f8e11b7ec60aba82c866fb9f4fcad2816", "message": "Minimize conversions", "committedDate": "2020-02-05T22:50:27Z", "type": "forcePushed"}]}