{"pr_number": 2569, "pr_title": "Use Identity/Reference based collection where possible", "pr_createdAt": "2020-04-15T11:18:31Z", "pr_url": "https://github.com/SpongePowered/Sponge/pull/2569", "timeline": [{"oid": "8b2d5b87a3acf796beece586b911a105b801f3b6", "url": "https://github.com/SpongePowered/Sponge/commit/8b2d5b87a3acf796beece586b911a105b801f3b6", "message": "Cleanup old guava import", "committedDate": "2020-05-11T22:17:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE4NTIxMg==", "url": "https://github.com/SpongePowered/Sponge/pull/2569#discussion_r423185212", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import com.google.common.collect.Sets;", "author": "gabizou", "createdAt": "2020-05-11T17:01:29Z", "path": "src/main/java/org/spongepowered/common/event/tracking/phase/packet/inventory/BasicInventoryPacketState.java", "diffHunk": "@@ -24,6 +24,8 @@\n  */\n package org.spongepowered.common.event.tracking.phase.packet.inventory;\n \n+import com.google.common.collect.Sets;", "originalCommit": "ef59a6300ca1d51ae50623e69d3897b925b43c5d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8b2d5b87a3acf796beece586b911a105b801f3b6", "chunk": "diff --git a/src/main/java/org/spongepowered/common/event/tracking/phase/packet/inventory/BasicInventoryPacketState.java b/src/main/java/org/spongepowered/common/event/tracking/phase/packet/inventory/BasicInventoryPacketState.java\nindex e60d2e4f9..fbda544a0 100644\n--- a/src/main/java/org/spongepowered/common/event/tracking/phase/packet/inventory/BasicInventoryPacketState.java\n+++ b/src/main/java/org/spongepowered/common/event/tracking/phase/packet/inventory/BasicInventoryPacketState.java\n\n@@ -24,7 +24,6 @@\n  */\n package org.spongepowered.common.event.tracking.phase.packet.inventory;\n \n-import com.google.common.collect.Sets;\n import it.unimi.dsi.fastutil.objects.ReferenceOpenHashSet;\n import net.minecraft.entity.player.EntityPlayerMP;\n import net.minecraft.network.Packet;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE4NTM4Mw==", "url": "https://github.com/SpongePowered/Sponge/pull/2569#discussion_r423185383", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import com.google.common.collect.Sets;", "author": "gabizou", "createdAt": "2020-05-11T17:01:48Z", "path": "src/main/java/org/spongepowered/common/item/inventory/archetype/SpongeInventoryArchetypeBuilder.java", "diffHunk": "@@ -24,6 +24,8 @@\n  */\n package org.spongepowered.common.item.inventory.archetype;\n \n+import com.google.common.collect.Sets;", "originalCommit": "ef59a6300ca1d51ae50623e69d3897b925b43c5d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8b2d5b87a3acf796beece586b911a105b801f3b6", "chunk": "diff --git a/src/main/java/org/spongepowered/common/item/inventory/archetype/SpongeInventoryArchetypeBuilder.java b/src/main/java/org/spongepowered/common/item/inventory/archetype/SpongeInventoryArchetypeBuilder.java\nindex 5959dc738..72f55f403 100644\n--- a/src/main/java/org/spongepowered/common/item/inventory/archetype/SpongeInventoryArchetypeBuilder.java\n+++ b/src/main/java/org/spongepowered/common/item/inventory/archetype/SpongeInventoryArchetypeBuilder.java\n\n@@ -24,7 +24,6 @@\n  */\n package org.spongepowered.common.item.inventory.archetype;\n \n-import com.google.common.collect.Sets;\n import it.unimi.dsi.fastutil.objects.ReferenceOpenHashSet;\n import org.spongepowered.api.event.item.inventory.InteractInventoryEvent;\n import org.spongepowered.api.item.inventory.InventoryArchetype;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE4NTcwMA==", "url": "https://github.com/SpongePowered/Sponge/pull/2569#discussion_r423185700", "bodyText": "Isn't this going to be changing to a different type of map?", "author": "gabizou", "createdAt": "2020-05-11T17:02:18Z", "path": "src/main/java/org/spongepowered/common/item/inventory/lens/impl/ReusableLens.java", "diffHunk": "@@ -65,7 +66,7 @@ private ReusableLens(SlotProvider slots, Function<SlotProvider, T> lensProvider)\n     public static <T extends Lens> ReusableLens<T> getLens(Class<T> lensType, InventoryAdapter adapter,\n             Supplier<SlotProvider> slots, Function<SlotProvider, T> lens) {\n         Map<Class<? extends Lens>, Int2ObjectMap<ReusableLens>>", "originalCommit": "ef59a6300ca1d51ae50623e69d3897b925b43c5d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYyNTY2Mg==", "url": "https://github.com/SpongePowered/Sponge/pull/2569#discussion_r424625662", "bodyText": "IdentityHashMap implements Map. The declaration is fine, I'm changing the value here\nhttps://github.com/SpongePowered/SpongeCommon/pull/2569/files#diff-79c49477a2574946c4d8b9f22e05e208R68", "author": "ImMorpheus", "createdAt": "2020-05-13T17:55:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE4NTcwMA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ5OTI3MQ==", "url": "https://github.com/SpongePowered/Sponge/pull/2569#discussion_r423499271", "bodyText": "this is a moot set to even bother using. It's a temp registry that gets dropped as soon as the game has finished loading.", "author": "gabizou", "createdAt": "2020-05-12T06:49:01Z", "path": "src/main/java/org/spongepowered/common/data/property/SpongePropertyRegistry.java", "diffHunk": "@@ -104,7 +105,7 @@ public void completeRegistration() {\n     public Collection<Property<?, ?>> getPropertiesFor(final PropertyHolder holder) {\n         final ImmutableList.Builder<Property<?, ?>> builder = ImmutableList.builder();\n         if (this.tempRegistry != null) { // Still doing registrations\n-            final Set<Class<? extends Property<?, ?>>> used = new HashSet<>();\n+            final Set<Class<? extends Property<?, ?>>> used = new ReferenceOpenHashSet<>();", "originalCommit": "8b2d5b87a3acf796beece586b911a105b801f3b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg5NzAyMw==", "url": "https://github.com/SpongePowered/Sponge/pull/2569#discussion_r428897023", "bodyText": "Reverted with other temporary maps.", "author": "ImMorpheus", "createdAt": "2020-05-21T20:30:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ5OTI3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "71d652bce465ca98e3d748b21c14393d3c795ae5", "chunk": "diff --git a/src/main/java/org/spongepowered/common/data/property/SpongePropertyRegistry.java b/src/main/java/org/spongepowered/common/data/property/SpongePropertyRegistry.java\nindex a853577e7..01f303ea2 100644\n--- a/src/main/java/org/spongepowered/common/data/property/SpongePropertyRegistry.java\n+++ b/src/main/java/org/spongepowered/common/data/property/SpongePropertyRegistry.java\n\n@@ -105,7 +104,7 @@ public void completeRegistration() {\n     public Collection<Property<?, ?>> getPropertiesFor(final PropertyHolder holder) {\n         final ImmutableList.Builder<Property<?, ?>> builder = ImmutableList.builder();\n         if (this.tempRegistry != null) { // Still doing registrations\n-            final Set<Class<? extends Property<?, ?>>> used = new ReferenceOpenHashSet<>();\n+            final Set<Class<? extends Property<?, ?>>> used = new HashSet<>();\n             for (final Map.Entry<Class<? extends Property<?, ?>>, PropertyStoreDelegate<?>> entry : this.tempRegistry.delegateMap.entrySet()) {\n                 used.add(entry.getKey());\n                 entry.getValue().getFor(holder).ifPresent(builder::add);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg3ODkyOA==", "url": "https://github.com/SpongePowered/Sponge/pull/2569#discussion_r424878928", "bodyText": "Damn, this must've been here for ages.....", "author": "gabizou", "createdAt": "2020-05-14T05:28:45Z", "path": "src/main/java/org/spongepowered/common/data/util/DataUtil.java", "diffHunk": "@@ -580,10 +581,9 @@ public static void readCustomData(final NBTTagCompound compound, final DataHolde\n                 // Re-attempt to deserialize custom data\n                 final SerializedDataTransaction transaction = deserializeManipulatorList(builder.build());\n                 final List<DataManipulator<?, ?>> manipulators = transaction.deserializedManipulators;\n-                final List<Class<? extends DataManipulator<?, ?>>> classesLoaded = new ArrayList<>();\n+                final Set<Class<? extends DataManipulator<?, ?>>> classesLoaded = new ReferenceOpenHashSet<>();\n                 for (final DataManipulator<?, ?> manipulator : manipulators) {\n-                    if (!classesLoaded.contains(manipulator.getClass())) {\n-                        classesLoaded.add((Class<? extends DataManipulator<?, ?>>) manipulator.getClass());\n+                    if (classesLoaded.add((Class<? extends DataManipulator<?, ?>>) manipulator.getClass())) {", "originalCommit": "8b2d5b87a3acf796beece586b911a105b801f3b6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "af8bd36f8772347578ca33edd10df168d4202d85", "chunk": "diff --git a/src/main/java/org/spongepowered/common/data/util/DataUtil.java b/src/main/java/org/spongepowered/common/data/util/DataUtil.java\nindex 177927a2c..575037a92 100644\n--- a/src/main/java/org/spongepowered/common/data/util/DataUtil.java\n+++ b/src/main/java/org/spongepowered/common/data/util/DataUtil.java\n\n@@ -581,7 +581,7 @@ public static void readCustomData(final NBTTagCompound compound, final DataHolde\n                 // Re-attempt to deserialize custom data\n                 final SerializedDataTransaction transaction = deserializeManipulatorList(builder.build());\n                 final List<DataManipulator<?, ?>> manipulators = transaction.deserializedManipulators;\n-                final Set<Class<? extends DataManipulator<?, ?>>> classesLoaded = new ReferenceOpenHashSet<>();\n+                final Set<Class<? extends DataManipulator<?, ?>>> classesLoaded = Sets.newIdentityHashSet();\n                 for (final DataManipulator<?, ?> manipulator : manipulators) {\n                     if (classesLoaded.add((Class<? extends DataManipulator<?, ?>>) manipulator.getClass())) {\n                         // If for any reason a failed data was not deserialized, but\n"}}, {"oid": "71d652bce465ca98e3d748b21c14393d3c795ae5", "url": "https://github.com/SpongePowered/Sponge/commit/71d652bce465ca98e3d748b21c14393d3c795ae5", "message": "Revert a few identity maps to hashmaps", "committedDate": "2020-05-21T20:39:58Z", "type": "forcePushed"}, {"oid": "af8bd36f8772347578ca33edd10df168d4202d85", "url": "https://github.com/SpongePowered/Sponge/commit/af8bd36f8772347578ca33edd10df168d4202d85", "message": "Use Identity/Reference based collection where possible", "committedDate": "2020-05-21T20:39:52Z", "type": "commit"}, {"oid": "2a91ef10021d40ac73635a2bcd7babc31e5e9287", "url": "https://github.com/SpongePowered/Sponge/commit/2a91ef10021d40ac73635a2bcd7babc31e5e9287", "message": "Replace guava collection with fastutil", "committedDate": "2020-05-21T20:39:57Z", "type": "commit"}, {"oid": "7bf0d0b8f478697003b63a97dfff168a46b23d82", "url": "https://github.com/SpongePowered/Sponge/commit/7bf0d0b8f478697003b63a97dfff168a46b23d82", "message": "Missed a few maps with class keys", "committedDate": "2020-05-21T20:39:57Z", "type": "commit"}, {"oid": "c5fc7223d8ee49bfc9bd675d80d0f3e4380de73f", "url": "https://github.com/SpongePowered/Sponge/commit/c5fc7223d8ee49bfc9bd675d80d0f3e4380de73f", "message": "Add maps with Keys keys", "committedDate": "2020-05-21T20:39:57Z", "type": "commit"}, {"oid": "1b25f3c2ad0fe20175373736498dcaf5c9c07f62", "url": "https://github.com/SpongePowered/Sponge/commit/1b25f3c2ad0fe20175373736498dcaf5c9c07f62", "message": "Use an EnumMap/Set when the key type is an enum", "committedDate": "2020-05-21T20:39:58Z", "type": "commit"}, {"oid": "393de7372e0a2f7314e11e4cfc6f2a58fc97eb19", "url": "https://github.com/SpongePowered/Sponge/commit/393de7372e0a2f7314e11e4cfc6f2a58fc97eb19", "message": "Missed a few maps with primitive types", "committedDate": "2020-05-21T20:39:58Z", "type": "commit"}, {"oid": "1b699ccaaf85f126410008b22ab1e184f77dd37d", "url": "https://github.com/SpongePowered/Sponge/commit/1b699ccaaf85f126410008b22ab1e184f77dd37d", "message": "Cleanup old guava import", "committedDate": "2020-05-21T20:39:58Z", "type": "commit"}, {"oid": "4fa4cc7668984fad0b2aa2973c7b2eb2036a1bc9", "url": "https://github.com/SpongePowered/Sponge/commit/4fa4cc7668984fad0b2aa2973c7b2eb2036a1bc9", "message": "Registrymodules are singletons", "committedDate": "2020-05-21T20:39:58Z", "type": "commit"}, {"oid": "2da16ca322c6e9f97ac7b57632612c3084d1f4bf", "url": "https://github.com/SpongePowered/Sponge/commit/2da16ca322c6e9f97ac7b57632612c3084d1f4bf", "message": "Missed an EnumMap", "committedDate": "2020-05-21T20:39:58Z", "type": "commit"}, {"oid": "f6d8997f1345ff90a4381fe39481d084268ef5a6", "url": "https://github.com/SpongePowered/Sponge/commit/f6d8997f1345ff90a4381fe39481d084268ef5a6", "message": "Another Map with enum keys", "committedDate": "2020-05-21T20:39:58Z", "type": "commit"}, {"oid": "64690556d2788bc48bd59e8604dd13c3234b3522", "url": "https://github.com/SpongePowered/Sponge/commit/64690556d2788bc48bd59e8604dd13c3234b3522", "message": "Classloaders and event handlers don't follow the equals contract", "committedDate": "2020-05-21T20:39:58Z", "type": "commit"}, {"oid": "2618f36edb46745d8e5bf447f5a3746e435d0ebe", "url": "https://github.com/SpongePowered/Sponge/commit/2618f36edb46745d8e5bf447f5a3746e435d0ebe", "message": "Avoid int boxing and reduce map lookups", "committedDate": "2020-05-21T20:39:58Z", "type": "commit"}, {"oid": "71d652bce465ca98e3d748b21c14393d3c795ae5", "url": "https://github.com/SpongePowered/Sponge/commit/71d652bce465ca98e3d748b21c14393d3c795ae5", "message": "Revert a few identity maps to hashmaps", "committedDate": "2020-05-21T20:39:58Z", "type": "commit"}]}