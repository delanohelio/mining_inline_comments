{"pr_number": 2611, "pr_title": "Reduce iterations in TileEntities activation", "pr_createdAt": "2020-05-17T11:36:15Z", "pr_url": "https://github.com/SpongePowered/Sponge/pull/2611", "timeline": [{"oid": "f82986d007ae9789a242e3161a7d94af2d96da1e", "url": "https://github.com/SpongePowered/Sponge/commit/f82986d007ae9789a242e3161a7d94af2d96da1e", "message": "Reduce iterations in TileEntities activation", "committedDate": "2020-05-17T11:36:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc1OTkzMw==", "url": "https://github.com/SpongePowered/Sponge/pull/2611#discussion_r426759933", "bodyText": "While we're looking at performance, I wonder if we should also look at making this dependent on distance squared. I realise that it makes some difference to getting bbActivationRange and Math.round() - but the activation range would then be Math.pow(bbActivationRange - 0.5, 2) due to the current rounding, and such rounding would not be required.", "author": "dualspiral", "createdAt": "2020-05-18T16:43:17Z", "path": "src/main/java/org/spongepowered/common/mixin/plugin/tileentityactivation/TileEntityActivation.java", "diffHunk": "@@ -177,9 +176,13 @@ private static void activateChunkTileEntities(final EntityPlayer player, final C\n                 }\n \n                 final int bbActivationRange = ((ActivationCapability) tileEntity).activation$getActivationRange();\n-                final int blockDistance = Math.round(tilePos.distance(playerPos));\n-                if (blockDistance <= bbActivationRange) {\n-                    ((ActivationCapability) tileEntity).activation$setActivatedTick(currentTick);\n+                for (EntityPlayerMP player : players) {\n+                    final Vector3i playerPos = VecHelper.toVector3i(player.getPosition());\n+                    final int blockDistance = Math.round(tilePos.distance(playerPos));", "originalCommit": "f82986d007ae9789a242e3161a7d94af2d96da1e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg0OTE4MA==", "url": "https://github.com/SpongePowered/Sponge/pull/2611#discussion_r426849180", "bodyText": "Good point.\nI've switched to Vector3i#distanceSquared (which returns an int, so there's no need for rounding).", "author": "ImMorpheus", "createdAt": "2020-05-18T19:32:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc1OTkzMw=="}], "type": "inlineReview", "revised_code": {"commit": "4e6f21debc90d280c299b88fe15918d456248e26", "chunk": "diff --git a/src/main/java/org/spongepowered/common/mixin/plugin/tileentityactivation/TileEntityActivation.java b/src/main/java/org/spongepowered/common/mixin/plugin/tileentityactivation/TileEntityActivation.java\nindex 1a921ba5a..d15cead5b 100644\n--- a/src/main/java/org/spongepowered/common/mixin/plugin/tileentityactivation/TileEntityActivation.java\n+++ b/src/main/java/org/spongepowered/common/mixin/plugin/tileentityactivation/TileEntityActivation.java\n\n@@ -175,10 +175,11 @@ private static void activateChunkTileEntities(final List<EntityPlayerMP> players\n                     spongeTileEntity.activation$requiresActivationCacheRefresh(false);\n                 }\n \n-                final int bbActivationRange = ((ActivationCapability) tileEntity).activation$getActivationRange();\n+                final int activationRange = ((ActivationCapability) tileEntity).activation$getActivationRange();\n+                final int bbActivationRange = (int) Math.pow(activationRange, 2);\n                 for (EntityPlayerMP player : players) {\n                     final Vector3i playerPos = VecHelper.toVector3i(player.getPosition());\n-                    final int blockDistance = Math.round(tilePos.distance(playerPos));\n+                    final int blockDistance = tilePos.distanceSquared(playerPos);\n                     if (blockDistance <= bbActivationRange) {\n                         ((ActivationCapability) tileEntity).activation$setActivatedTick(currentTick);\n                         break;\n"}}, {"oid": "4e6f21debc90d280c299b88fe15918d456248e26", "url": "https://github.com/SpongePowered/Sponge/commit/4e6f21debc90d280c299b88fe15918d456248e26", "message": "Avoid square root call", "committedDate": "2020-05-18T19:32:30Z", "type": "commit"}, {"oid": "c0fee00e80eef190f09d72818833ea9d60990108", "url": "https://github.com/SpongePowered/Sponge/commit/c0fee00e80eef190f09d72818833ea9d60990108", "message": "Do not overuse methods", "committedDate": "2020-05-20T18:36:06Z", "type": "commit"}]}