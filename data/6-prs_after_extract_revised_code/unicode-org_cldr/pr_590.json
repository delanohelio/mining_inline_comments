{"pr_number": 590, "pr_title": "CLDR-13616 Monitor Forum Participation", "pr_createdAt": "2020-07-29T02:44:02Z", "pr_url": "https://github.com/unicode-org/cldr/pull/590", "timeline": [{"oid": "136522be8dcac045554b614afb5373f6c6075d14", "url": "https://github.com/unicode-org/cldr/commit/136522be8dcac045554b614afb5373f6c6075d14", "message": "CLDR-13616 Monitor Forum Participation\n\n-New column: Needing action\n\n-Since slower now, use ajax and show Loading... message\n\n-New special: forum_participation\n\n-New special/forum_participation.js and CldrStForumParticipation.js\n\n-For server, use SurveyAjax instead of SurveyMain; serve json, build table on client\n\n-Skip asterisk (*) if present in the set of locales, as for organization Gaeilge\n\n-More unit testing", "committedDate": "2020-07-29T02:30:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAyNzgzMg==", "url": "https://github.com/unicode-org/cldr/pull/590#discussion_r462027832", "bodyText": "Ideally these would be ? params. But ok", "author": "srl295", "createdAt": "2020-07-29T04:15:47Z", "path": "tools/cldr-apps/src/org/unicode/cldr/web/SurveyForumParticipation.java", "diffHunk": "@@ -138,6 +132,133 @@ private int queryForumDb(Cell cell, String loc) throws SQLException {\n         return count;\n     }\n \n+    /**\n+     * \"Forum: Needing action (Requests and Discussions my organization has not responded to)\"\n+     *\n+     * \"Needs action\" means:\n+     *    - (Open request from other org AND (my org haven\u2019t agreed or declined))\n+     *    - OR (open discuss-only thread AND the last poster is not in my org)\n+     *\n+     * Compare JavaScript \"passIfNeedingAction\". Different on server since not \"I\" but \"We\" = \"anybody in my org\".\n+     *\n+     * @param conn\n+     * @param loc\n+     * @return the count\n+     * @throws SQLException\n+     *\n+     * TODO: make this faster; it's slow\n+     */\n+    private int queryForumDbAct(String loc) throws SQLException {\n+        PreparedStatement ps = null;\n+        Integer count = -1;\n+        try {\n+            ps = prepareForumActQuery(loc);\n+            ResultSet rs = ps.executeQuery();\n+            count = 0;\n+            while (rs.next()) {\n+                int forumId = rs.getInt(1);\n+                int postType =rs.getInt(2);\n+                /*\n+                 * For Discuss: look at the LAST reply in the thread, and skip the item if our org was its poster\n+                 * For Request: look at each reply in the thread, and skip the item if our org agreed or declined\n+                 */\n+                if (postType == typeDiscuss) {\n+                    if (!ourOrgPostedLast(forumId)) {\n+                        ++count;\n+                    }\n+                } else { // Request\n+                    if (!ourOrgAgreedOrDeclined(forumId)) {\n+                        ++count;\n+                    }\n+                }\n+            }\n+        } finally {\n+            DBUtils.close(ps);\n+        }\n+        return count;\n+    }\n+\n+    private PreparedStatement prepareForumActQuery(String loc) throws SQLException {\n+        String sql = \"SELECT \" + forumTable + \".id, \" +  forumTable + \".type\"\n+            + \" FROM \" + forumTable\n+            + \" JOIN \" + userTable\n+            + \" ON \" + forumTable + \".poster=\" + userTable + \".id\"\n+            + \" WHERE \" + forumTable + \".parent=-1\"\n+            + \" AND \" + forumTable + \".open=true\"\n+            + \" AND \" + forumTable + \".loc=?\"\n+            + \" AND (\" + forumTable + \".type=?\"\n+            + \" OR NOT \" + userTable + \".org=?)\";\n+\n+        PreparedStatement ps = DBUtils.prepareForwardReadOnly(conn, sql);\n+        ps.setString(1, loc);\n+        ps.setInt(2, typeDiscuss);\n+        ps.setString(3, org);\n+        return ps;\n+    }\n+\n+    /**\n+     * Does the poster who made the last post in this thread belong to this org?\n+     *\n+     * @param conn the Connection\n+     * @param forumRootId the id of the root (initial) forum post of the thread\n+     * @return true or false\n+     * @throws SQLException\n+     */\n+    private boolean ourOrgPostedLast(int forumRootId) throws SQLException {\n+        boolean result = false;\n+        PreparedStatement ps = null;\n+        String sql = \"SELECT \" + userTable + \".org \"\n+            + \" FROM \" + forumTable", "originalCommit": "136522be8dcac045554b614afb5373f6c6075d14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM0NTc5NA==", "url": "https://github.com/unicode-org/cldr/pull/590#discussion_r462345794", "bodyText": "I'm not sure what benefit that would have. The table names don't vary for these queries. Would there be a performance benefit in spite of that?", "author": "btangmu", "createdAt": "2020-07-29T14:32:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAyNzgzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM4Njk1OQ==", "url": "https://github.com/unicode-org/cldr/pull/590#discussion_r462386959", "bodyText": "@btangmu sorry, correct these are table names, not parameters.", "author": "srl295", "createdAt": "2020-07-29T15:26:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAyNzgzMg=="}], "type": "inlineReview", "revised_code": null}]}