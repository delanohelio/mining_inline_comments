{"pr_number": 877, "pr_title": "CLDR-14251 Modernize: eliminate ajax_status.jsp", "pr_createdAt": "2020-12-09T22:17:30Z", "pr_url": "https://github.com/unicode-org/cldr/pull/877", "timeline": [{"oid": "c7ed3bff8eefb01a3ed0bc0c1a70232688d4e9e2", "url": "https://github.com/unicode-org/cldr/commit/c7ed3bff8eefb01a3ed0bc0c1a70232688d4e9e2", "message": "CLDR-14251 Modernize: eliminate ajax_status.jsp\n\n-Move most of ajax_status.jsp to SurveyAjax.includeJavaScript, converting jsp to java\n\n-New CldrStatus.js to encapsulate data like surveyRunningStamp on front end with getters/setters\n\n-TEMPORARY SurveyAjax.includeEvilJavaScript for items not yet handled by CldrStatus.js\n\n-Extend statusJSON to include contextPath\n\n-Remove unused front-end variables surveyCurrentLocaleStamp, surveyCurrentLocaleStampId, etc.\n\n-Remove dead code; clean up\n\n-Remove two ancient .DS_Store files that should never have been added to git\n\n-Comments", "committedDate": "2020-12-09T22:16:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTc2NzI0Nw==", "url": "https://github.com/unicode-org/cldr/pull/877#discussion_r539767247", "bodyText": "Oops WHAT_GETROW is accidentally duplicated here. It's harmless but I'll remove it in the next PR.", "author": "btangmu", "createdAt": "2020-12-10T01:10:33Z", "path": "tools/cldr-apps/src/main/java/org/unicode/cldr/web/SurveyAjax.java", "diffHunk": "@@ -3185,47 +3173,177 @@ public String getValue() {\n      * @param request the HttpServletRequest\n      * @param out the Writer\n      * @throws IOException\n-     *\n-     * Some code was moved here from js_include.jsp\n-     * Reference: https://unicode-org.atlassian.net/browse/CLDR-13585\n-     *\n-     * Called from ajax_status.jsp\n+     * @throws JSONException\n      */\n-    public static void includeJavaScript(HttpServletRequest request, Writer out) throws IOException {\n-        /*\n-         * TODO: investigate putting \"defer\" after \"script\"; may cause page to appear\n-         * to load faster, though order of loading jquery, dojo may be problematic...\n-         */\n-        out.write(\"<script src='//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js'></script>\\n\");\n+    public static void includeJavaScript(HttpServletRequest request, Writer out) throws IOException, JSONException {\n+        includeEvilJavaScript(request, out);\n+        includeDojoJavaScript(out);\n+        includeJqueryJavaScript(out);\n+        includeCldrJavaScript(request, out);\n+    }\n+\n+    private static void includeEvilJavaScript(HttpServletRequest request, Writer out) throws IOException, JSONException {\n+        out.write(\"<script>\\n\");\n \n         /*\n-         * TODO: figure out what we're using jquery-ui for.\n-         * If we don't use it, don't include it.\n-         * If we don't include jquery-ui we get \"TypeError: p.easing[this.easing] is not a function\"\n+         * All these JavaScript var declarations unfortunately append to the window (global) object!\n+         * This is very temporary, mostly moved here from old ajax_status.jsp\n+         * TODO: Modernize! deliver data to the client as json; and store\n+         * it in our own JavaScript object(s) (like CldrStatus.js), not the window.\n+         * We should treat surveyCurrentSpecial, etc., like surveyCurrentId, etc.\n          */\n+        out.write(\"var surveyCurrentSpecial = null;\\n\");\n+\n+        String surveyCurrentLocale = request.getParameter(SurveyMain.QUERY_LOCALE);\n+\n+        // locale can have either - or _\n+        surveyCurrentLocale = (surveyCurrentLocale == null) ? null : surveyCurrentLocale.replace(\"-\", \"_\");\n+        String surveyCurrentLocaleName = \"\";\n+        if (surveyCurrentLocale != null) {\n+            CLDRLocale aloc = CLDRLocale.getInstance(surveyCurrentLocale);\n+            surveyCurrentLocaleName = aloc.getDisplayName();\n+        }\n+        String surveyCurrentSection = request.getParameter(SurveyMain.QUERY_SECTION);\n+        if (surveyCurrentSection == null) {\n+            surveyCurrentSection = \"\";\n+        }\n+        if (surveyCurrentLocale != null && surveyCurrentLocale.length() > 0) {\n+            out.write(\"var surveyCurrentLocale = '\" + surveyCurrentLocale + \"';\\n\");\n+            out.write(\"var surveyCurrentLocaleName = '\" + surveyCurrentLocaleName + \"';\\n\");\n+            out.write(\"var surveyCurrentSection = '\" + surveyCurrentSection + \"';\\n\");\n+        } else {\n+            out.write(\"var surveyCurrentLocale = null;\\n\");\n+            out.write(\"var surveyCurrentLocaleName = null;\\n\");\n+            out.write(\"var surveyCurrentSection  = '';\\n\");\n+        }\n+\n+        out.write(\"var surveyTransHintLocale = '\" + SurveyMain.TRANS_HINT_LOCALE.getBaseName() + \"';\\n\");\n+        out.write(\"var surveyVersion = '\" + SurveyMain.getNewVersion() + \"';\\n\");\n+        out.write(\"var surveyLastVoteVersion = '\" + SurveyMain.getLastVoteVersion() + \"';\\n\");\n+        out.write(\"var surveyOfficial = '\" + !SurveyMain.isUnofficial() + \"';\\n\");\n+        out.write(\"var BUG_URL_BASE = '\" + SurveyMain.BUG_URL_BASE + \"';\\n\");\n+        out.write(\"var surveyBeta = '\" + SurveyMain.isPhaseBeta() + \"';\\n\");\n+\n+        String sessid = request.getParameter(\"s\");\n+        if (sessid == null) {\n+            HttpSession hsession = request.getSession(false);\n+            if (hsession != null) {\n+                sessid = hsession.getId();\n+            }\n+        }\n+\n+        CookieSession mySession = null;\n+        UserRegistry.User myUser = null;\n+        if (sessid != null) {\n+            mySession = CookieSession.retrieveWithoutTouch(sessid);\n+        }\n+        if (mySession == null) {\n+            sessid = null;\n+        } else {\n+            sessid = mySession.id;\n+            myUser = mySession.user;\n+        }\n+        if (sessid != null) {\n+            out.write(\"var surveySessionId = '\" + sessid + \"';\\n\");\n+        } else {\n+            out.write(\"var surveySessionId = null;\\n\");\n+        }\n+        SurveyMain curSurveyMain = null;\n+        curSurveyMain = SurveyMain.getInstance(request);\n+\n+        WebContext subCtx = (WebContext) request.getAttribute(\"WebContext\"); // from v.jsp\n+        if (subCtx != null && subCtx.session.user != null) {\n+            myUser = subCtx.session.user;\n+        }\n+\n+        if (myUser != null) {\n+            out.write(\"var surveyUser = '\" + myUser.toJSONString() + \"';\\n\");\n+            out.write(\"var userEmail = '\" + myUser.email + \"';\\n\");\n+            out.write(\"var userPWD = '\" + myUser.password + \"';\\n\");\n+            out.write(\"var userID = '\" + myUser.id + \"';\\n\");\n+            out.write(\"var organizationName = '\" + myUser.getOrganization().getDisplayName() + \"';\\n\");\n+            out.write(\"var org = '\" + myUser.org + \"';\\n\");\n+            out.write(\"var surveyUserPerms = {\\n\");\n+            out.write(\"  userExist: (surveyUser != null),\\n\");\n+            out.write(\"  userCanImportOldVotes: \" + myUser.canImportOldVotes() + \",\\n\");\n+            out.write(\"  userCanUseVettingSummary: \" + UserRegistry.userCanUseVettingSummary(myUser) + \",\\n\");\n+            out.write(\"  userCanMonitorForum: \" + UserRegistry.userCanMonitorForum(myUser) + \",\\n\");\n+            out.write(\"  userIsTC: \" + UserRegistry.userIsTC(myUser) + \",\\n\");\n+            boolean userIsVetter = !UserRegistry.userIsTC(myUser) && UserRegistry.userIsVetter(myUser);\n+            out.write(\"  userIsVetter: \" + userIsVetter + \",\\n\");\n+            out.write(\"  userIsLocked: \" + UserRegistry.userIsLocked(myUser) + \",\\n\");\n+            out.write(\"  hasDataSource: \" + curSurveyMain.dbUtils.hasDataSource() + \",\\n\");\n+            out.write(\"};\\n\");\n+\n+            out.write(\"var surveyUserURL = {\\n\");\n+            out.write(\"  myAccountSetting: 'survey?do=listu',\\n\");\n+            out.write(\"  disableMyAccount: \\\"lock.jsp?email='+userEmail\\\"+userEmail,\\n\");\n+            out.write(\"  recentActivity: \\\"myvotes.jsp?user=\\\"+userID+\\\"&s=\\\"+surveySessionId,\\n\");\n+            out.write(\"  xmlUpload: \\\"upload.jsp?a=/cldr-apps/survey&s=\\\"+surveySessionId,\\n\");\n+            out.write(\"  manageUser: \\\"survey?do=list\\\",\\n\");\n+            out.write(\"  flag: \\\"tc-flagged.jsp?s=\\\"+surveySessionId,\\n\");\n+            out.write(\"  about: \\\"about.jsp\\\",\\n\");\n+            out.write(\"  browse: \\\"browse.jsp\\\",\\n\");\n+            out.write(\"};\\n\");\n+\n+            if (UserRegistry.userIsAdmin(myUser)) {\n+                out.write(\"surveyUserURL.adminPanel = 'survey?dump=\" + SurveyMain.vap + \"';\\n\");\n+            }\n+        } else {\n+            // User session not present. Set a few things so that we don't fail.\n+            out.write(\"var surveyUser = null;\\n\");\n+            out.write(\"var surveyUserURL = {};\\n\");\n+            out.write(\"var surveyUser = null;\\n\");\n+            out.write(\"var organizationName = null;\\n\");\n+            out.write(\"var org = null;\\n\");\n+            out.write(\"var surveyUserPerms = {userExist: false,};\\n\");\n+        }\n+        out.write(\"var warnIcon = \\\"\" + WebContext.iconHtml(request, \"warn\", \"Test Warning\") + \"\\\";\\n\");\n+        out.write(\"var stopIcon = \\\"\" + WebContext.iconHtml(request, \"stop\", \"Test Error\") + \"\\\";\\n\");\n+        out.write(\"var WHAT_GETROW = '\" + SurveyAjax.WHAT_GETROW + \"';\\n\");\n+        out.write(\"var WHAT_SUBMIT = '\" + SurveyAjax.WHAT_SUBMIT + \"';\\n\");\n+        out.write(\"var TARGET_DOCS = '\" + WebContext.TARGET_DOCS + \"';\\n\");\n+        out.write(\"var TRANS_HINT_LOCALE = '\" + SurveyMain.TRANS_HINT_LOCALE + \"';\\n\");\n+        out.write(\"var TRANS_HINT_LANGUAGE_NAME = '\" + SurveyMain.TRANS_HINT_LANGUAGE_NAME + \"';\\n\");\n+        out.write(\"var WHAT_GETROW = '\" + SurveyAjax.WHAT_GETROW + \"';\\n\");", "originalCommit": "c7ed3bff8eefb01a3ed0bc0c1a70232688d4e9e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjczNzYyMg==", "url": "https://github.com/unicode-org/cldr/pull/877#discussion_r542737622", "bodyText": "it's somewhat temporary anyway\u2026\u00a0", "author": "srl295", "createdAt": "2020-12-14T20:20:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTc2NzI0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjc0MTA4OA==", "url": "https://github.com/unicode-org/cldr/pull/877#discussion_r542741088", "bodyText": "these WHAT_ things shouldn't need to be communicated to the client\u2026\u00a0hard coded would be fine. But no reason to change it now.", "author": "srl295", "createdAt": "2020-12-14T20:23:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTc2NzI0Nw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjczOTEzNQ==", "url": "https://github.com/unicode-org/cldr/pull/877#discussion_r542739135", "bodyText": "I wonder if these r instances should be hoisted up, since they are almost always used.  BUt, not really important.", "author": "srl295", "createdAt": "2020-12-14T20:21:30Z", "path": "tools/cldr-apps/src/main/java/org/unicode/cldr/web/SurveyAjax.java", "diffHunk": "@@ -384,14 +384,14 @@ private void processRequest(HttpServletRequest request, HttpServletResponse resp\n                 addGeneralStats(r);\n                 send(r, out);\n             } else if (what.equals(WHAT_FLAGGED)) {\n-                JSONWriter r = newJSONStatus(sm);\n+                JSONWriter r = newJSONStatus(request, sm);", "originalCommit": "c7ed3bff8eefb01a3ed0bc0c1a70232688d4e9e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjc1NjM5MA==", "url": "https://github.com/unicode-org/cldr/pull/877#discussion_r542756390", "bodyText": "I agree it's too much duplication. processRequest is over 700 lines, so nontrivial to refactor. When we do, good idea to consolidate calls to newJSONStatus", "author": "btangmu", "createdAt": "2020-12-14T20:38:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjczOTEzNQ=="}], "type": "inlineReview", "revised_code": null}]}