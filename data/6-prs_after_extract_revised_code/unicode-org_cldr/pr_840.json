{"pr_number": 840, "pr_title": "CLDR-14284 TestAttributeValues check for duplicates in space-separated attributes", "pr_createdAt": "2020-11-11T23:59:15Z", "pr_url": "https://github.com/unicode-org/cldr/pull/840", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTcxNTkwOQ==", "url": "https://github.com/unicode-org/cldr/pull/840#discussion_r521715909", "bodyText": "This does print an error and stop the test. There may be a more graceful way to fail.", "author": "srl295", "createdAt": "2020-11-12T00:01:26Z", "path": "tools/cldr-code/src/test/java/org/unicode/cldr/unittest/TestAttributeValues.java", "diffHunk": "@@ -261,6 +262,14 @@ public void checkElement(String element, Attributes atts) {\n         }\n \n         private void checkAttribute(String element, String attribute, String attrValue) {\n+            if(LdmlConvertRules.isSplittableAttr(element, attribute)) {\n+                final Set<String> asSet = new HashSet<>();\n+                SPACE_SPLITTER.splitToList(attrValue).forEach(v -> {\n+                    if(asSet.add(v) == false) {\n+                        throw new IllegalArgumentException(\"in <\" + element+ \" \" + attribute + \"=\u2026, value \" + v + \" appears twice.\");", "originalCommit": "b380bf509baf44e96981d4047eeb1f2535edee8a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8696f2d481212fa5db621833e9fbad7f71fc27dc", "chunk": "diff --git a/tools/cldr-code/src/test/java/org/unicode/cldr/unittest/TestAttributeValues.java b/tools/cldr-code/src/test/java/org/unicode/cldr/unittest/TestAttributeValues.java\nindex 5c24a692e2..ab07899166 100644\n--- a/tools/cldr-code/src/test/java/org/unicode/cldr/unittest/TestAttributeValues.java\n+++ b/tools/cldr-code/src/test/java/org/unicode/cldr/unittest/TestAttributeValues.java\n\n@@ -262,14 +261,6 @@ public class TestAttributeValues extends TestFmwk {\n         }\n \n         private void checkAttribute(String element, String attribute, String attrValue) {\n-            if(LdmlConvertRules.isSplittableAttr(element, attribute)) {\n-                final Set<String> asSet = new HashSet<>();\n-                SPACE_SPLITTER.splitToList(attrValue).forEach(v -> {\n-                    if(asSet.add(v) == false) {\n-                        throw new IllegalArgumentException(\"in <\" + element+ \" \" + attribute + \"=\u2026, value \" + v + \" appears twice.\");\n-                    }\n-                });\n-            }\n             // skip cases we know we don't need to test\n             if (!needsTesting.containsEntry(element, attribute)) {\n                 return;\n"}}, {"oid": "8696f2d481212fa5db621833e9fbad7f71fc27dc", "url": "https://github.com/unicode-org/cldr/commit/8696f2d481212fa5db621833e9fbad7f71fc27dc", "message": "CLDR-14284 TestAttributeValues check for duplicates in space-separated attributes\n\n- also removed a comment on a previously-duplicate grammaticalFeatures element\nthat was fixed with CLDR-13730", "committedDate": "2020-11-18T22:13:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA1Nzk5MQ==", "url": "https://github.com/unicode-org/cldr/pull/840#discussion_r529057991", "bodyText": "Looks good. Should add quick unit test.\nAlso, can be pithier. Split to list, then create set from it. If the sizes are not the same, fail.", "author": "macchiati", "createdAt": "2020-11-23T23:16:15Z", "path": "tools/cldr-code/src/main/java/org/unicode/cldr/util/MatchValue.java", "diffHunk": "@@ -616,7 +631,14 @@ public static SetMatchValue of(String key) {\n \n         @Override\n         public  boolean is(String items) {\n-            return and(subtest,SPACE_SPLITTER.split(items));\n+            Iterable<String> splitItems = SPACE_SPLITTER.split(items);", "originalCommit": "8696f2d481212fa5db621833e9fbad7f71fc27dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA1OTA4Ng==", "url": "https://github.com/unicode-org/cldr/pull/840#discussion_r529059086", "bodyText": "Should add quick unit test.\n\nTestAttributeValues already hits this, and is verified to fail on the \"\u2026\u00a0fil fil \u2026\" case for grammatical features.\n\nAlso, can be pithier\u2026\u00a0If the sizes are not the same, fail\n\ngood point, will fix", "author": "srl295", "createdAt": "2020-11-23T23:19:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA1Nzk5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "cac1511ad85596b719e9b66f812097646ea4c11d", "chunk": "diff --git a/tools/cldr-code/src/main/java/org/unicode/cldr/util/MatchValue.java b/tools/cldr-code/src/main/java/org/unicode/cldr/util/MatchValue.java\nindex d0e0938e6c..e62e2069d6 100644\n--- a/tools/cldr-code/src/main/java/org/unicode/cldr/util/MatchValue.java\n+++ b/tools/cldr-code/src/main/java/org/unicode/cldr/util/MatchValue.java\n\n@@ -631,12 +631,9 @@ public abstract class MatchValue implements Predicate<String> {\n \n         @Override\n         public  boolean is(String items) {\n-            Iterable<String> splitItems = SPACE_SPLITTER.split(items);\n-            final Set<String> asSet = new HashSet<>();\n-            for(final String item : splitItems) {\n-                if(!asSet.add(item)) {\n-                    throw new IllegalArgumentException(\"duplicate: \" + item);\n-                }\n+            List<String> splitItems = SPACE_SPLITTER.splitToList(items);\n+            if( (new HashSet<String>(splitItems)).size() != splitItems.size() ) {\n+                throw new IllegalArgumentException(\"Set contains duplicates: \" + items);\n             }\n             return and(subtest, splitItems);\n         }\n"}}, {"oid": "cac1511ad85596b719e9b66f812097646ea4c11d", "url": "https://github.com/unicode-org/cldr/commit/cac1511ad85596b719e9b66f812097646ea4c11d", "message": "CLDR-14284 TestAttributeValues check for duplicates in space-separated attributes\n\n- also removed a comment on a previously-duplicate grammaticalFeatures element\nthat was fixed with CLDR-13730\n- also removed a line of dead code in MatchValue.java", "committedDate": "2020-11-23T23:27:04Z", "type": "commit"}, {"oid": "cac1511ad85596b719e9b66f812097646ea4c11d", "url": "https://github.com/unicode-org/cldr/commit/cac1511ad85596b719e9b66f812097646ea4c11d", "message": "CLDR-14284 TestAttributeValues check for duplicates in space-separated attributes\n\n- also removed a comment on a previously-duplicate grammaticalFeatures element\nthat was fixed with CLDR-13730\n- also removed a line of dead code in MatchValue.java", "committedDate": "2020-11-23T23:27:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA2Mjg4Mg==", "url": "https://github.com/unicode-org/cldr/pull/840#discussion_r529062882", "bodyText": "just a line of dead code, no side effect", "author": "srl295", "createdAt": "2020-11-23T23:28:52Z", "path": "tools/cldr-code/src/main/java/org/unicode/cldr/util/MatchValue.java", "diffHunk": "@@ -640,7 +659,6 @@ public String getName() {\n         }\n \n         public static OrMatchValue of(String key) {\n-            IntFunction<MatchValue[]> generator = null;", "originalCommit": "cac1511ad85596b719e9b66f812097646ea4c11d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}