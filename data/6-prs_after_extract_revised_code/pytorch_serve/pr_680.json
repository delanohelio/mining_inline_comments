{"pr_number": 680, "pr_title": "Gpu usage info and pid of workers in model description API", "pr_createdAt": "2020-09-10T13:49:37Z", "pr_url": "https://github.com/pytorch/serve/pull/680", "timeline": [{"oid": "27e4f1da2ba56444cdeeecf2235486e915f3334c", "url": "https://github.com/pytorch/serve/commit/27e4f1da2ba56444cdeeecf2235486e915f3334c", "message": "Merge pull request #1 from pytorch/master\n\nMerging the current changes", "committedDate": "2020-08-14T09:56:19Z", "type": "commit"}, {"oid": "992fbfcaa63532d5e9982cee4ba6f3b9fbab83a7", "url": "https://github.com/pytorch/serve/commit/992fbfcaa63532d5e9982cee4ba6f3b9fbab83a7", "message": "Added environment header in Sanity & Regression test suite", "committedDate": "2020-08-14T10:10:57Z", "type": "commit"}, {"oid": "34ca16898ee8499de550c3b7c51fd5c6ea7691bf", "url": "https://github.com/pytorch/serve/commit/34ca16898ee8499de550c3b7c51fd5c6ea7691bf", "message": "Added collect_env.py python script", "committedDate": "2020-08-14T10:11:56Z", "type": "commit"}, {"oid": "56db69965148bf808474ba0ade2dea98e4423c67", "url": "https://github.com/pytorch/serve/commit/56db69965148bf808474ba0ade2dea98e4423c67", "message": "Undo few unwanted changes", "committedDate": "2020-09-03T14:57:26Z", "type": "commit"}, {"oid": "daea5794cee2f178fd1894b21b09ed3ff1508ad8", "url": "https://github.com/pytorch/serve/commit/daea5794cee2f178fd1894b21b09ed3ff1508ad8", "message": "Added cuda memory usage info and pid of workers in model description API", "committedDate": "2020-09-07T07:57:42Z", "type": "commit"}, {"oid": "2fcedcac389cea5d71bb9ff6e8c75d4eba429062", "url": "https://github.com/pytorch/serve/commit/2fcedcac389cea5d71bb9ff6e8c75d4eba429062", "message": "Modified WorkerThread.java file", "committedDate": "2020-09-07T11:54:05Z", "type": "commit"}, {"oid": "963f26c890cd3f853c2d662a03e7ec41be56e65b", "url": "https://github.com/pytorch/serve/commit/963f26c890cd3f853c2d662a03e7ec41be56e65b", "message": ".", "committedDate": "2020-09-07T13:26:01Z", "type": "commit"}, {"oid": "ef892d7d852d015eda92c73fa6d52ed9a5d47f4a", "url": "https://github.com/pytorch/serve/commit/ef892d7d852d015eda92c73fa6d52ed9a5d47f4a", "message": ".", "committedDate": "2020-09-07T13:39:29Z", "type": "commit"}, {"oid": "6fa04efd60420b1c9687944ac132671e3d03a720", "url": "https://github.com/pytorch/serve/commit/6fa04efd60420b1c9687944ac132671e3d03a720", "message": ".", "committedDate": "2020-09-07T14:21:25Z", "type": "commit"}, {"oid": "7027ae9fd3b4808855eb3262dcf42faf9e40c237", "url": "https://github.com/pytorch/serve/commit/7027ae9fd3b4808855eb3262dcf42faf9e40c237", "message": "..", "committedDate": "2020-09-07T14:27:15Z", "type": "commit"}, {"oid": "44bcd6dfd60fb18ee5e36e6cef1b9f5a3ea0a8b3", "url": "https://github.com/pytorch/serve/commit/44bcd6dfd60fb18ee5e36e6cef1b9f5a3ea0a8b3", "message": "Updated WorkerThread.java file", "committedDate": "2020-09-07T14:34:45Z", "type": "commit"}, {"oid": "7b4e4f7fadb2cc8c4ec5b94420629166395724ac", "url": "https://github.com/pytorch/serve/commit/7b4e4f7fadb2cc8c4ec5b94420629166395724ac", "message": "Show gpuUsage specific to gpu-id on which the model is loaded", "committedDate": "2020-09-10T12:48:56Z", "type": "commit"}, {"oid": "dc3e3631ce3d5626495b24eafe5dc03c37d6c200", "url": "https://github.com/pytorch/serve/commit/dc3e3631ce3d5626495b24eafe5dc03c37d6c200", "message": "Deleted cuda_script.py file", "committedDate": "2020-09-10T13:10:32Z", "type": "commit"}, {"oid": "2a5e0c13dee440943a1da7c32d86e6d872832d68", "url": "https://github.com/pytorch/serve/commit/2a5e0c13dee440943a1da7c32d86e6d872832d68", "message": "Fixed sanity failed log : Array brackets at illegal position.", "committedDate": "2020-09-10T13:59:53Z", "type": "commit"}, {"oid": "1b113aa4513b926e08e121e6cc5dc4fab24cc1aa", "url": "https://github.com/pytorch/serve/commit/1b113aa4513b926e08e121e6cc5dc4fab24cc1aa", "message": " Fixed sanity failed log : Array brackets at illegal position.", "committedDate": "2020-09-10T14:02:27Z", "type": "commit"}, {"oid": "34072d25a11457c848ee646d4de135379a0fbe9d", "url": "https://github.com/pytorch/serve/commit/34072d25a11457c848ee646d4de135379a0fbe9d", "message": "Merge pull request #2 from pytorch/master\n\nMerging changes from origin repo", "committedDate": "2020-09-10T14:23:21Z", "type": "commit"}, {"oid": "be5246ceb6fe5947891247bedff7411d98e3858c", "url": "https://github.com/pytorch/serve/commit/be5246ceb6fe5947891247bedff7411d98e3858c", "message": "Updated WorkerThread.java file to handle Cannot run program nvidia-smi error", "committedDate": "2020-09-11T06:01:04Z", "type": "commit"}, {"oid": "78c8bf7665dafdee9d744e2a29e7ab9461fc5377", "url": "https://github.com/pytorch/serve/commit/78c8bf7665dafdee9d744e2a29e7ab9461fc5377", "message": "Merge branch 'issue_597' of https://github.com/AshwinChafale/serve into issue_597", "committedDate": "2020-09-11T06:01:48Z", "type": "commit"}, {"oid": "f4559837050a82f1ada86fa0120b5bf3d1480a99", "url": "https://github.com/pytorch/serve/commit/f4559837050a82f1ada86fa0120b5bf3d1480a99", "message": "Corrected PWD violations", "committedDate": "2020-09-14T16:32:09Z", "type": "commit"}, {"oid": "32905235f9577c97fedfdfe84d45bdad14e6d424", "url": "https://github.com/pytorch/serve/commit/32905235f9577c97fedfdfe84d45bdad14e6d424", "message": "Updated WorkerThread.java file", "committedDate": "2020-09-14T16:42:08Z", "type": "commit"}, {"oid": "9bda0ec8fd8aa681dcbd1c81f3f83cdc1e0035fa", "url": "https://github.com/pytorch/serve/commit/9bda0ec8fd8aa681dcbd1c81f3f83cdc1e0035fa", "message": "Merge branch 'master' into issue_597", "committedDate": "2020-09-15T04:26:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk3Njk0NA==", "url": "https://github.com/pytorch/serve/pull/680#discussion_r496976944", "bodyText": "NIT: This seems to be nvidia specific. Can you investigate if we can do this in a more generic way using some opengl java library?", "author": "maaquib", "createdAt": "2020-09-29T19:13:28Z", "path": "frontend/server/src/main/java/org/pytorch/serve/wlm/WorkerThread.java", "diffHunk": "@@ -76,6 +80,47 @@ public WorkerState getState() {\n         return state;\n     }\n \n+    public String getGpuUsage() {\n+        Process process;\n+        StringBuffer gpuUsage = new StringBuffer();\n+        if (gpuId >= 0) {\n+            try {\n+                process =\n+                        Runtime.getRuntime()\n+                                .exec(\n+                                        \"nvidia-smi -i \"", "originalCommit": "9bda0ec8fd8aa681dcbd1c81f3f83cdc1e0035fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM5MjcwMw==", "url": "https://github.com/pytorch/serve/pull/680#discussion_r504392703", "bodyText": "@maaquib: Agreed, we should use a more generic approach. However, we are currently supporting NVIDIA-CUDA only. I will add a TODO for this.", "author": "harshbafna", "createdAt": "2020-10-14T04:22:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk3Njk0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDYyNTU0MA==", "url": "https://github.com/pytorch/serve/pull/680#discussion_r504625540", "bodyText": "Done.", "author": "harshbafna", "createdAt": "2020-10-14T12:11:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk3Njk0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA3Nzg5Mw==", "url": "https://github.com/pytorch/serve/pull/680#discussion_r508077893", "bodyText": "@harshbafna Instead of just a TODO can you also add an issue to the backlog", "author": "maaquib", "createdAt": "2020-10-19T21:38:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk3Njk0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM1NzI2NA==", "url": "https://github.com/pytorch/serve/pull/680#discussion_r508357264", "bodyText": "Done. Created #740.", "author": "harshbafna", "createdAt": "2020-10-20T09:40:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk3Njk0NA=="}], "type": "inlineReview", "revised_code": {"commit": "5c6b55a1ec27037dea6e609352cd4341341d56d8", "chunk": "diff --git a/frontend/server/src/main/java/org/pytorch/serve/wlm/WorkerThread.java b/frontend/server/src/main/java/org/pytorch/serve/wlm/WorkerThread.java\nindex 89f194ae..6c7d3f66 100644\n--- a/frontend/server/src/main/java/org/pytorch/serve/wlm/WorkerThread.java\n+++ b/frontend/server/src/main/java/org/pytorch/serve/wlm/WorkerThread.java\n\n@@ -91,6 +91,11 @@ public class WorkerThread implements Runnable {\n                                         \"nvidia-smi -i \"\n                                                 + gpuId\n                                                 + \" --query-gpu=utilization.gpu,utilization.memory,memory.used --format=csv\");\n+                process.waitFor();\n+                int exitCode = process.exitValue();\n+                if (exitCode != 0) {\n+                    // Log error message from process.getErrorStream() and return\n+                }\n                 InputStream stdout = process.getInputStream();\n                 BufferedReader reader =\n                         new BufferedReader(new InputStreamReader(stdout, StandardCharsets.UTF_8));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk4MDc1OA==", "url": "https://github.com/pytorch/serve/pull/680#discussion_r496980758", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            InputStream stdout = process.getInputStream();\n          \n          \n            \n                            process.waitFor();\n          \n          \n            \n                            int exitCode = process.exitValue();\n          \n          \n            \n                            if (exitCode != 0) {\n          \n          \n            \n                                // Log error message from process.getErrorStream() and return\n          \n          \n            \n                            }\n          \n          \n            \n                            InputStream stdout = process.getInputStream();", "author": "maaquib", "createdAt": "2020-09-29T19:17:52Z", "path": "frontend/server/src/main/java/org/pytorch/serve/wlm/WorkerThread.java", "diffHunk": "@@ -76,6 +80,47 @@ public WorkerState getState() {\n         return state;\n     }\n \n+    public String getGpuUsage() {\n+        Process process;\n+        StringBuffer gpuUsage = new StringBuffer();\n+        if (gpuId >= 0) {\n+            try {\n+                process =\n+                        Runtime.getRuntime()\n+                                .exec(\n+                                        \"nvidia-smi -i \"\n+                                                + gpuId\n+                                                + \" --query-gpu=utilization.gpu,utilization.memory,memory.used --format=csv\");\n+                InputStream stdout = process.getInputStream();", "originalCommit": "9bda0ec8fd8aa681dcbd1c81f3f83cdc1e0035fa", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5c6b55a1ec27037dea6e609352cd4341341d56d8", "chunk": "diff --git a/frontend/server/src/main/java/org/pytorch/serve/wlm/WorkerThread.java b/frontend/server/src/main/java/org/pytorch/serve/wlm/WorkerThread.java\nindex 89f194ae..6c7d3f66 100644\n--- a/frontend/server/src/main/java/org/pytorch/serve/wlm/WorkerThread.java\n+++ b/frontend/server/src/main/java/org/pytorch/serve/wlm/WorkerThread.java\n\n@@ -91,6 +91,11 @@ public class WorkerThread implements Runnable {\n                                         \"nvidia-smi -i \"\n                                                 + gpuId\n                                                 + \" --query-gpu=utilization.gpu,utilization.memory,memory.used --format=csv\");\n+                process.waitFor();\n+                int exitCode = process.exitValue();\n+                if (exitCode != 0) {\n+                    // Log error message from process.getErrorStream() and return\n+                }\n                 InputStream stdout = process.getInputStream();\n                 BufferedReader reader =\n                         new BufferedReader(new InputStreamReader(stdout, StandardCharsets.UTF_8));\n"}}, {"oid": "23a2a740a3465d13526d5a2ce564f3863257127a", "url": "https://github.com/pytorch/serve/commit/23a2a740a3465d13526d5a2ce564f3863257127a", "message": "Merge branch 'master' into issue_597", "committedDate": "2020-09-29T19:19:50Z", "type": "commit"}, {"oid": "5c6b55a1ec27037dea6e609352cd4341341d56d8", "url": "https://github.com/pytorch/serve/commit/5c6b55a1ec27037dea6e609352cd4341341d56d8", "message": "Update frontend/server/src/main/java/org/pytorch/serve/wlm/WorkerThread.java\n\nCo-authored-by: Aaqib <maaquib@gmail.com>", "committedDate": "2020-09-30T11:36:35Z", "type": "commit"}, {"oid": "a03dfe5a53b88f806745df116a5b6bc405a49818", "url": "https://github.com/pytorch/serve/commit/a03dfe5a53b88f806745df116a5b6bc405a49818", "message": "Updated server/src/main/java/org/pytorch/serve/wlm/WorkerThread.java", "committedDate": "2020-09-30T12:01:31Z", "type": "commit"}, {"oid": "9408b31fe158889648cef5f4f360dd6e7ea3137b", "url": "https://github.com/pytorch/serve/commit/9408b31fe158889648cef5f4f360dd6e7ea3137b", "message": "Merge branch 'master' into issue_597", "committedDate": "2020-10-14T09:01:12Z", "type": "commit"}, {"oid": "90a4900abe985769d2786f668b3978c3d154fe70", "url": "https://github.com/pytorch/serve/commit/90a4900abe985769d2786f668b3978c3d154fe70", "message": "added todo", "committedDate": "2020-10-14T12:10:06Z", "type": "commit"}, {"oid": "07a03314aca24b71deb7ef2f287733da9f0c30d4", "url": "https://github.com/pytorch/serve/commit/07a03314aca24b71deb7ef2f287733da9f0c30d4", "message": "fixed java formatting", "committedDate": "2020-10-14T12:20:14Z", "type": "commit"}, {"oid": "22a5c58b8302ece3cef827056927e779537e7adf", "url": "https://github.com/pytorch/serve/commit/22a5c58b8302ece3cef827056927e779537e7adf", "message": "Merge branch 'master' into issue_597", "committedDate": "2020-10-21T17:28:49Z", "type": "commit"}]}