{"pr_number": 172, "pr_title": "Updated exception handling for worker threads shutdown.", "pr_createdAt": "2020-04-09T10:53:50Z", "pr_url": "https://github.com/pytorch/serve/pull/172", "timeline": [{"oid": "407e2d81f892434e11359277001a92a94a72ad5e", "url": "https://github.com/pytorch/serve/commit/407e2d81f892434e11359277001a92a94a72ad5e", "message": "updated code to now log errors only in case when exception is not genreated by unregister api call", "committedDate": "2020-04-09T09:59:41Z", "type": "commit"}, {"oid": "708929833d70bd78f7a3c8b7174b067320528bf1", "url": "https://github.com/pytorch/serve/commit/708929833d70bd78f7a3c8b7174b067320528bf1", "message": "java formatting", "committedDate": "2020-04-09T11:03:06Z", "type": "commit"}, {"oid": "7fd2241998a19eea2a3d9b0dd7ecf2c0ae3c6f58", "url": "https://github.com/pytorch/serve/commit/7fd2241998a19eea2a3d9b0dd7ecf2c0ae3c6f58", "message": "Merge branch 'master' into issue_155", "committedDate": "2020-04-24T08:37:11Z", "type": "commit"}, {"oid": "2fc6be017c4050504d93b11a8470233c5e710b1b", "url": "https://github.com/pytorch/serve/commit/2fc6be017c4050504d93b11a8470233c5e710b1b", "message": "fixed illigalstateexception", "committedDate": "2020-04-28T07:41:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIzODg4Mw==", "url": "https://github.com/pytorch/serve/pull/172#discussion_r418238883", "bodyText": "nice", "author": "mycpuorg", "createdAt": "2020-04-30T19:27:32Z", "path": "frontend/server/src/main/java/org/pytorch/serve/wlm/Model.java", "diffHunk": "@@ -172,7 +172,9 @@ public void pollBatch(String threadId, long waitTime, Map<String, Job> jobsRepo)\n             }\n             logger.trace(\"sending jobs, size: {}\", jobsRepo.size());\n         } finally {\n-            lock.unlock();\n+            if (lock.isHeldByCurrentThread()) {", "originalCommit": "2fc6be017c4050504d93b11a8470233c5e710b1b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI0Mjg1MQ==", "url": "https://github.com/pytorch/serve/pull/172#discussion_r418242851", "bodyText": "you mentioned this in the commit text but can you explain a bit more? I just want to make sure there are no race conditions hidden here", "author": "mycpuorg", "createdAt": "2020-04-30T19:35:35Z", "path": "frontend/server/src/main/java/org/pytorch/serve/wlm/WorkerThread.java", "diffHunk": "@@ -174,7 +175,11 @@ public void run() {\n             logger.error(\"Out of memory error when creating workers\", oom);\n             status = HttpResponseStatus.INSUFFICIENT_STORAGE;\n         } catch (Throwable t) {\n-            logger.warn(\"Backend worker thread exception.\", t);\n+            if (state == WorkerState.WORKER_SCALED_DOWN || state == WorkerState.WORKER_STOPPED) {", "originalCommit": "2fc6be017c4050504d93b11a8470233c5e710b1b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU5MzUzMQ==", "url": "https://github.com/pytorch/serve/pull/172#discussion_r418593531", "bodyText": "This change is not required anymore after the lock related handling done in Model.java. Removed this condition.", "author": "harshbafna", "createdAt": "2020-05-01T15:31:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI0Mjg1MQ=="}], "type": "inlineReview", "revised_code": {"commit": "1416573984874315f3ff243c66768e02c4bfc994", "chunk": "diff --git a/frontend/server/src/main/java/org/pytorch/serve/wlm/WorkerThread.java b/frontend/server/src/main/java/org/pytorch/serve/wlm/WorkerThread.java\nindex 13bc570a..0d343646 100644\n--- a/frontend/server/src/main/java/org/pytorch/serve/wlm/WorkerThread.java\n+++ b/frontend/server/src/main/java/org/pytorch/serve/wlm/WorkerThread.java\n\n@@ -175,11 +175,7 @@ public class WorkerThread implements Runnable {\n             logger.error(\"Out of memory error when creating workers\", oom);\n             status = HttpResponseStatus.INSUFFICIENT_STORAGE;\n         } catch (Throwable t) {\n-            if (state == WorkerState.WORKER_SCALED_DOWN || state == WorkerState.WORKER_STOPPED) {\n-                logger.debug(\"Shutting down the thread .. Scaling down.\");\n-            } else {\n-                logger.warn(\"Backend worker thread exception.\", t);\n-            }\n+            logger.warn(\"Backend worker thread exception.\", t);\n         } finally {\n             // WorkerThread is running in thread pool, the thread will be assigned to next\n             // Runnable once this worker is finished. If currentThread keep holding the reference\n"}}, {"oid": "cfa804dec91c95771bc3dd9e1b0f7f9bf7df1a4a", "url": "https://github.com/pytorch/serve/commit/cfa804dec91c95771bc3dd9e1b0f7f9bf7df1a4a", "message": "Merge branch 'staging_0_1_1' into issue_155", "committedDate": "2020-05-01T05:29:47Z", "type": "commit"}, {"oid": "1416573984874315f3ff243c66768e02c4bfc994", "url": "https://github.com/pytorch/serve/commit/1416573984874315f3ff243c66768e02c4bfc994", "message": "removed the unrequired handling for illegal monitor state exception", "committedDate": "2020-05-01T15:30:41Z", "type": "commit"}, {"oid": "f0ebc868cfb6ae644a3a717a5c45ee3d41247599", "url": "https://github.com/pytorch/serve/commit/f0ebc868cfb6ae644a3a717a5c45ee3d41247599", "message": "Merge branch 'staging_0_1_1' into issue_155", "committedDate": "2020-05-02T00:47:22Z", "type": "commit"}, {"oid": "ef8793e2463b0d71a9d636bca16a776edd87fdf1", "url": "https://github.com/pytorch/serve/commit/ef8793e2463b0d71a9d636bca16a776edd87fdf1", "message": "Merge branch 'staging_0_1_1' into issue_155", "committedDate": "2020-05-02T01:08:05Z", "type": "commit"}]}