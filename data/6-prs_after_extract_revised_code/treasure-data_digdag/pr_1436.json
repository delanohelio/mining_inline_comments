{"pr_number": 1436, "pr_title": "WM-867: Introduce retrying logic on curl commands on temporary network outage and/or S3 errors", "pr_createdAt": "2020-07-10T14:50:57Z", "pr_url": "https://github.com/treasure-data/digdag/pull/1436", "timeline": [{"oid": "265902110ddc044e4b41f5fbc59eaec4c0d532cf", "url": "https://github.com/treasure-data/digdag/commit/265902110ddc044e4b41f5fbc59eaec4c0d532cf", "message": "Introduce retrying on temporary network outage and/or S3 errors", "committedDate": "2020-07-10T14:39:58Z", "type": "commit"}, {"oid": "42f762054d33efd40b6f10cf85a801458c823ad3", "url": "https://github.com/treasure-data/digdag/commit/42f762054d33efd40b6f10cf85a801458c823ad3", "message": "Fixed a comment", "committedDate": "2020-07-10T15:15:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzEzOTU4MA==", "url": "https://github.com/treasure-data/digdag/pull/1436#discussion_r457139580", "bodyText": "isn't --fail option unnecessary? digdag server maintainer and workflow user are different. basically the server maintainer doesn't want to include error message details like S3 file path or pre-signed URL to the user.\nwhat do you think we could extract the retry count as parameters? because that's depending on the use case. probably some cases, server maintainer don't want to give up the retry because the script command succeeds but the workflow task fails.", "author": "muga", "createdAt": "2020-07-20T07:43:18Z", "path": "digdag-standards/src/main/java/io/digdag/standards/command/EcsCommandExecutor.java", "diffHunk": "@@ -659,7 +661,9 @@ protected void setEcsContainerOverrideCommand(\n             bashArguments.add(s(\"popd\"));\n         }\n         bashArguments.add(s(\"tar -zcf %s  --exclude %s --exclude %s .digdag/tmp/\", outputProjectArchivePathName, relativeProjectArchivePath.toString(), outputProjectArchivePathName));\n-        bashArguments.add(s(\"curl -s -X PUT -T %s -L \\\"%s\\\"\", outputProjectArchivePathName, outputProjectArchiveDirectUploadUrl));\n+        // retry by exponential backoff 1+2+4+8+16+32+64=127 seconds\n+        // Note that it's intended to curl exit 0 on http errors since it's only for LogWatch logging\n+        bashArguments.add(s(\"curl --retry 7 --retry-connrefused -s -X PUT -T %s -L \\\"%s\\\"\", outputProjectArchivePathName, outputProjectArchiveDirectUploadUrl));", "originalCommit": "42f762054d33efd40b6f10cf85a801458c823ad3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzE3MjMyNg==", "url": "https://github.com/treasure-data/digdag/pull/1436#discussion_r457172326", "bodyText": "@muga\n\nisn't --fail option unnecessary?  the server maintainer doesn't want to include error message details like S3 file path or pre-signed URL to the user.\n\nGood point.\n-fail command is originally introduced for 1) retrying by Digdag operator level and for 2) better failure analysis.\nWithout -fail, the curl command exit 0 for http transient errors and the following tar command fails. Then, relativeProjectArchivePath leaks.\ntar -zxf notfound\ntar: Error opening archive: Failed to open 'notfound'\n\nSince -s (--silent) option is specified in curl commands, no error message is going to be shown when exit 22 happens. So, no s3 path leak with --fail option.\nSo, I think--fail is preferred.\n\nwhat do you think we could extract the retry count as parameters?\n\nI think it's not required because miss configuration (e.g., infinite retry) can make digdag server unstable.\nOnly configurable by system administrator (who runs digdag server) is preferred.", "author": "myui", "createdAt": "2020-07-20T08:28:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzEzOTU4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY3MzA3Nw==", "url": "https://github.com/treasure-data/digdag/pull/1436#discussion_r457673077", "bodyText": "Only configurable by system administrator (who runs digdag server) is preferred.\n\nyes, so the retry count needs to be extracted and parameterized as config param. otherwise it's not easy for the system administrator (meant digdag server maintainer in my wording) to configure it.", "author": "muga", "createdAt": "2020-07-20T20:29:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzEzOTU4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzkxNTY5NQ==", "url": "https://github.com/treasure-data/digdag/pull/1436#discussion_r457915695", "bodyText": "@muga\nIntroduced agent.command_executor.ecs.retry_task_scripts_downloads and agent.command_executor.ecs.retry_task_output_uploads.\n--retry 0 makes curl do no retries. See man.", "author": "myui", "createdAt": "2020-07-21T08:10:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzEzOTU4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI4NDM0Mw==", "url": "https://github.com/treasure-data/digdag/pull/1436#discussion_r458284343", "bodyText": "nice, thanks! I missed one more thing for 1st one.\n\nSo, I think--fail is preferred.\n\nagree. please add --fail option.", "author": "muga", "createdAt": "2020-07-21T17:55:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzEzOTU4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ4ODUyOQ==", "url": "https://github.com/treasure-data/digdag/pull/1436#discussion_r458488529", "bodyText": "Added agent.command_executor.ecs.disable_curl_fail_opt=true .", "author": "myui", "createdAt": "2020-07-22T01:57:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzEzOTU4MA=="}], "type": "inlineReview", "revised_code": {"commit": "cd531ca5e0e50c9a46ac7bea1bd4610baf713b50", "chunk": "diff --git a/digdag-standards/src/main/java/io/digdag/standards/command/EcsCommandExecutor.java b/digdag-standards/src/main/java/io/digdag/standards/command/EcsCommandExecutor.java\nindex 830526fc9b..331d75164b 100644\n--- a/digdag-standards/src/main/java/io/digdag/standards/command/EcsCommandExecutor.java\n+++ b/digdag-standards/src/main/java/io/digdag/standards/command/EcsCommandExecutor.java\n\n@@ -661,9 +669,9 @@ public class EcsCommandExecutor\n             bashArguments.add(s(\"popd\"));\n         }\n         bashArguments.add(s(\"tar -zcf %s  --exclude %s --exclude %s .digdag/tmp/\", outputProjectArchivePathName, relativeProjectArchivePath.toString(), outputProjectArchivePathName));\n-        // retry by exponential backoff 1+2+4+8+16+32+64=127 seconds\n+        // retry by exponential backoff 1+2+4+8+16+32+64=127 seconds by the default\n         // Note that it's intended to curl exit 0 on http errors since it's only for LogWatch logging\n-        bashArguments.add(s(\"curl --retry 7 --retry-connrefused -s -X PUT -T %s -L \\\"%s\\\"\", outputProjectArchivePathName, outputProjectArchiveDirectUploadUrl));\n+        bashArguments.add(s(\"curl --retry %d --retry-connrefused -s -X PUT -T %s -L \\\"%s\\\"\", retryUploads, outputProjectArchivePathName, outputProjectArchiveDirectUploadUrl));\n         bashArguments.add(s(\"echo \\\"%s\\\"\", ECS_END_OF_TASK_LOG_MARK));\n         bashArguments.add(s(\"exit $exit_code\"));\n \n"}}, {"oid": "cd531ca5e0e50c9a46ac7bea1bd4610baf713b50", "url": "https://github.com/treasure-data/digdag/commit/cd531ca5e0e50c9a46ac7bea1bd4610baf713b50", "message": "Add a system config to control times curl retrying", "committedDate": "2020-07-21T08:07:58Z", "type": "commit"}, {"oid": "b80a8a8ec4e2a48210778d0e0cc16fe002da658d", "url": "https://github.com/treasure-data/digdag/commit/b80a8a8ec4e2a48210778d0e0cc16fe002da658d", "message": "Added a system config to control curl fail option", "committedDate": "2020-07-22T01:51:19Z", "type": "commit"}, {"oid": "8531cc9e4223ea6339297474059555ce7c55852f", "url": "https://github.com/treasure-data/digdag/commit/8531cc9e4223ea6339297474059555ce7c55852f", "message": "Fixed disable_curl_fail_opt option handling", "committedDate": "2020-07-22T01:56:45Z", "type": "commit"}, {"oid": "8531cc9e4223ea6339297474059555ce7c55852f", "url": "https://github.com/treasure-data/digdag/commit/8531cc9e4223ea6339297474059555ce7c55852f", "message": "Fixed disable_curl_fail_opt option handling", "committedDate": "2020-07-22T01:56:45Z", "type": "forcePushed"}, {"oid": "d07e4bbcdfe34e04982b4bad0998d36753f3dc77", "url": "https://github.com/treasure-data/digdag/commit/d07e4bbcdfe34e04982b4bad0998d36753f3dc77", "message": "Fixed to apply curl --fail option handling only for uploading outputs", "committedDate": "2020-07-22T05:41:36Z", "type": "commit"}, {"oid": "846f6212fe76d3e9dcc56753f564a82eb767212c", "url": "https://github.com/treasure-data/digdag/commit/846f6212fe76d3e9dcc56753f564a82eb767212c", "message": "Fixed config key name", "committedDate": "2020-07-22T06:00:44Z", "type": "commit"}]}