{"pr_number": 1446, "pr_title": "Update filter conditions on AttemptResource", "pr_createdAt": "2020-08-20T05:38:37Z", "pr_url": "https://github.com/treasure-data/digdag/pull/1446", "timeline": [{"oid": "9080b74264b51f717cfb135256eeadd2045a981a", "url": "https://github.com/treasure-data/digdag/commit/9080b74264b51f717cfb135256eeadd2045a981a", "message": "Update filters to not exclude tasks that contain ParentID", "committedDate": "2020-08-20T05:26:23Z", "type": "commit"}, {"oid": "f323de82d8aaf8c682cc4e9bbaeee6223cb45659", "url": "https://github.com/treasure-data/digdag/commit/f323de82d8aaf8c682cc4e9bbaeee6223cb45659", "message": "Add test case for resuming successful attempts", "committedDate": "2020-08-20T05:28:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYzOTQ2NA==", "url": "https://github.com/treasure-data/digdag/pull/1446#discussion_r473639464", "bodyText": "Just in case, you want to add the task which has no parent in successTasks, right ?", "author": "yoyama", "createdAt": "2020-08-20T06:19:39Z", "path": "digdag-server/src/main/java/io/digdag/server/rs/AttemptResource.java", "diffHunk": "@@ -315,7 +315,7 @@ public Response startAttempt(RestSessionAttemptRequest request)\n                 // If a group error has occurred,\n                 // exclude the group's child/dynamically generated tasks from successTasks\n                 // even if they are in SUCCESS state\n-                .filter(task -> task.getParentId().isPresent() && !groupRetryErrorTaskIds.contains(task.getParentId().get()))\n+                .filter(task -> !groupRetryErrorTaskIds.contains(task.getParentId().orNull()))", "originalCommit": "f323de82d8aaf8c682cc4e9bbaeee6223cb45659", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzY0NzA5OA==", "url": "https://github.com/treasure-data/digdag/pull/1446#discussion_r473647098", "bodyText": "@yoyama Yes, you're right.", "author": "szyn", "createdAt": "2020-08-20T06:30:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYzOTQ2NA=="}], "type": "inlineReview", "revised_code": {"commit": "4b25b60808d3fd73e8f066f11114c0d5c67c38e2", "chunk": "diff --git a/digdag-server/src/main/java/io/digdag/server/rs/AttemptResource.java b/digdag-server/src/main/java/io/digdag/server/rs/AttemptResource.java\nindex 0562af157b..ccddb88f87 100644\n--- a/digdag-server/src/main/java/io/digdag/server/rs/AttemptResource.java\n+++ b/digdag-server/src/main/java/io/digdag/server/rs/AttemptResource.java\n\n@@ -315,15 +316,15 @@ public class AttemptResource\n                 // If a group error has occurred,\n                 // exclude the group's child/dynamically generated tasks from successTasks\n                 // even if they are in SUCCESS state\n-                .filter(task -> !groupRetryErrorTaskIds.contains(task.getParentId().orNull()))\n                 .filter(task -> !task.getFullName().contains(\"^sub\"))\n                 .filter(task -> task.getState() == TaskStateCode.SUCCESS)\n-                .map(task -> {\n+                .filter(task -> {\n                     if (!task.getParentId().isPresent()) {\n                         throw new IllegalArgumentException(\"Resuming successfully completed attempts is not supported\");\n                     }\n-                    return task.getId();\n+                    return !groupRetryErrorTaskIds.contains(task.getParentId().get());\n                 })\n+                .map(StoredTask::getId)\n                 .collect(Collectors.toList());\n \n         return ImmutableList.copyOf(successTasks);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzY0NTY3Mw==", "url": "https://github.com/treasure-data/digdag/pull/1446#discussion_r473645673", "bodyText": "NullPointerException - if the specified element is null and this list does not permit null elements (optional)\n\nhttps://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/List.html#contains(java.lang.Object)\nWhether this method throws NullPointerException depends on the actual class's behavior and it may be a bit naive implementation. How about moving this filter right before map below? Like\n                .filter(task -> !task.getFullName().contains(\"^sub\"))\n                .filter(task -> task.getState() == TaskStateCode.SUCCESS)\n                .filter(task -> \n                    if (!task.getParentId().isPresent()) {\n                        throw new IllegalArgumentException(\"Resuming successfully completed attempts is not supported\");\n                    }\n                    !groupRetryErrorTaskIds.contains(task.getParentId().get())\n                )\n                .map(StoredTask::getId)\n                      :", "author": "komamitsu", "createdAt": "2020-08-20T06:28:03Z", "path": "digdag-server/src/main/java/io/digdag/server/rs/AttemptResource.java", "diffHunk": "@@ -315,7 +315,7 @@ public Response startAttempt(RestSessionAttemptRequest request)\n                 // If a group error has occurred,\n                 // exclude the group's child/dynamically generated tasks from successTasks\n                 // even if they are in SUCCESS state\n-                .filter(task -> task.getParentId().isPresent() && !groupRetryErrorTaskIds.contains(task.getParentId().get()))\n+                .filter(task -> !groupRetryErrorTaskIds.contains(task.getParentId().orNull()))", "originalCommit": "f323de82d8aaf8c682cc4e9bbaeee6223cb45659", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzY2MjA3OA==", "url": "https://github.com/treasure-data/digdag/pull/1446#discussion_r473662078", "bodyText": "Thank you for sharing that. I agree with you, and it sounds pretty good!\nI moved this filter based on your review: 4b25b60", "author": "szyn", "createdAt": "2020-08-20T06:50:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzY0NTY3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzY5NTg4OA==", "url": "https://github.com/treasure-data/digdag/pull/1446#discussion_r473695888", "bodyText": "\ud83d\udc4d", "author": "komamitsu", "createdAt": "2020-08-20T07:32:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzY0NTY3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "4b25b60808d3fd73e8f066f11114c0d5c67c38e2", "chunk": "diff --git a/digdag-server/src/main/java/io/digdag/server/rs/AttemptResource.java b/digdag-server/src/main/java/io/digdag/server/rs/AttemptResource.java\nindex 0562af157b..ccddb88f87 100644\n--- a/digdag-server/src/main/java/io/digdag/server/rs/AttemptResource.java\n+++ b/digdag-server/src/main/java/io/digdag/server/rs/AttemptResource.java\n\n@@ -315,15 +316,15 @@ public class AttemptResource\n                 // If a group error has occurred,\n                 // exclude the group's child/dynamically generated tasks from successTasks\n                 // even if they are in SUCCESS state\n-                .filter(task -> !groupRetryErrorTaskIds.contains(task.getParentId().orNull()))\n                 .filter(task -> !task.getFullName().contains(\"^sub\"))\n                 .filter(task -> task.getState() == TaskStateCode.SUCCESS)\n-                .map(task -> {\n+                .filter(task -> {\n                     if (!task.getParentId().isPresent()) {\n                         throw new IllegalArgumentException(\"Resuming successfully completed attempts is not supported\");\n                     }\n-                    return task.getId();\n+                    return !groupRetryErrorTaskIds.contains(task.getParentId().get());\n                 })\n+                .map(StoredTask::getId)\n                 .collect(Collectors.toList());\n \n         return ImmutableList.copyOf(successTasks);\n"}}, {"oid": "4b25b60808d3fd73e8f066f11114c0d5c67c38e2", "url": "https://github.com/treasure-data/digdag/commit/4b25b60808d3fd73e8f066f11114c0d5c67c38e2", "message": "Update filter based on reviews", "committedDate": "2020-08-20T06:43:43Z", "type": "commit"}]}