{"pr_number": 2495, "pr_title": "bugfix:  fix the NPE and reduce the request when lockkey is null", "pr_createdAt": "2020-04-01T09:43:13Z", "pr_url": "https://github.com/seata/seata/pull/2495", "timeline": [{"oid": "fd478945011261f628ba3df23629a19f0ecf94bb", "url": "https://github.com/seata/seata/commit/fd478945011261f628ba3df23629a19f0ecf94bb", "message": "fix:fix the NPE,and reduce once db request when lockkey is null", "committedDate": "2020-04-01T09:38:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc2MzYwMQ==", "url": "https://github.com/seata/seata/pull/2495#discussion_r402763601", "bodyText": "Is it more appropriate to put logic with lockkey as empty in the checkLock method?", "author": "slievrly", "createdAt": "2020-04-03T06:33:50Z", "path": "rm-datasource/src/main/java/io/seata/rm/datasource/ConnectionProxy.java", "diffHunk": "@@ -198,8 +200,10 @@ private void doCommit() throws SQLException {\n     }\n \n     private void processLocalCommitWithGlobalLocks() throws SQLException {\n-\n-        checkLock(context.buildLockKeys());\n+        Set<String> lockKeys = context.getLockKeysBuffer();\n+        if (CollectionUtils.isNotEmpty(lockKeys)) {", "originalCommit": "fd478945011261f628ba3df23629a19f0ecf94bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc2NDc0OQ==", "url": "https://github.com/seata/seata/pull/2495#discussion_r402764749", "bodyText": "ok,i will change", "author": "lightClouds917", "createdAt": "2020-04-03T06:37:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc2MzYwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ5OTYyOA==", "url": "https://github.com/seata/seata/pull/2495#discussion_r405499628", "bodyText": "the master code", "author": "hermitcai", "createdAt": "2020-04-08T12:51:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc2MzYwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "6eb6e0fd081aa4e538f379af66b88de2a090350b", "chunk": "diff --git a/rm-datasource/src/main/java/io/seata/rm/datasource/ConnectionProxy.java b/rm-datasource/src/main/java/io/seata/rm/datasource/ConnectionProxy.java\nindex 7eb4383278..3dafa65786 100644\n--- a/rm-datasource/src/main/java/io/seata/rm/datasource/ConnectionProxy.java\n+++ b/rm-datasource/src/main/java/io/seata/rm/datasource/ConnectionProxy.java\n\n@@ -200,10 +201,7 @@ public class ConnectionProxy extends AbstractConnectionProxy {\n     }\n \n     private void processLocalCommitWithGlobalLocks() throws SQLException {\n-        Set<String> lockKeys = context.getLockKeysBuffer();\n-        if (CollectionUtils.isNotEmpty(lockKeys)) {\n-            checkLock(context.buildLockKeys());\n-        }\n+        checkLock(context.buildLockKeys());\n         try {\n             targetConnection.commit();\n         } catch (Throwable ex) {\n"}}, {"oid": "4cc0dac5402f356b25dff64baf3fe961f6c5fcaa", "url": "https://github.com/seata/seata/commit/4cc0dac5402f356b25dff64baf3fe961f6c5fcaa", "message": "Merge branch 'develop' of github.com:seata/seata into fix_lockkey_is_null", "committedDate": "2020-04-03T08:02:03Z", "type": "commit"}, {"oid": "6eb6e0fd081aa4e538f379af66b88de2a090350b", "url": "https://github.com/seata/seata/commit/6eb6e0fd081aa4e538f379af66b88de2a090350b", "message": "optimize:optimize the code", "committedDate": "2020-04-03T08:43:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ2ODM1Mw==", "url": "https://github.com/seata/seata/pull/2495#discussion_r403468353", "bodyText": "Incorrect", "author": "zjinlei", "createdAt": "2020-04-04T13:08:22Z", "path": "server/src/main/java/io/seata/server/lock/AbstractLockManager.java", "diffHunk": "@@ -153,6 +153,9 @@ protected Locker getLocker() {\n                                             Long branchID) {\n         List<RowLock> locks = new ArrayList<RowLock>();\n \n+        if (StringUtils.isEmpty(lockKey)) {\n+            return null;\n+        }", "originalCommit": "6eb6e0fd081aa4e538f379af66b88de2a090350b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDUyODU3Mw==", "url": "https://github.com/seata/seata/pull/2495#discussion_r404528573", "bodyText": "check  isLockable method.", "author": "slievrly", "createdAt": "2020-04-07T04:31:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ2ODM1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "d1fccadaf1dcacd637520ffb547881db144bff89", "chunk": "diff --git a/server/src/main/java/io/seata/server/lock/AbstractLockManager.java b/server/src/main/java/io/seata/server/lock/AbstractLockManager.java\nindex 6eb09e87ac..87f890ff66 100644\n--- a/server/src/main/java/io/seata/server/lock/AbstractLockManager.java\n+++ b/server/src/main/java/io/seata/server/lock/AbstractLockManager.java\n\n@@ -153,8 +153,8 @@ public abstract class AbstractLockManager implements LockManager {\n                                             Long branchID) {\n         List<RowLock> locks = new ArrayList<RowLock>();\n \n-        if (StringUtils.isEmpty(lockKey)) {\n-            return null;\n+        if (StringUtils.isBlank(lockKey)) {\n+            return locks;\n         }\n         String[] tableGroupedLockKeys = lockKey.split(\";\");\n         for (String tableGroupedLockKey : tableGroupedLockKeys) {\n"}}, {"oid": "da7dbd260704a5146974c63ef9dd75b9d2f575a5", "url": "https://github.com/seata/seata/commit/da7dbd260704a5146974c63ef9dd75b9d2f575a5", "message": "Merge branch 'develop' of github.com:seata/seata into fix_lockkey_is_null", "committedDate": "2020-04-07T03:27:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY3Mjg5OA==", "url": "https://github.com/seata/seata/pull/2495#discussion_r404672898", "bodyText": "That s ok. And I think can remove the code\nif (StringUtils.isNullOrEmpty(lockKey)) {\n            // no lock\n            return true;\n}\n\nat\nacquireLock(BranchSession branchSession)", "author": "l81893521", "createdAt": "2020-04-07T09:36:29Z", "path": "server/src/main/java/io/seata/server/lock/AbstractLockManager.java", "diffHunk": "@@ -153,6 +153,9 @@ protected Locker getLocker() {\n                                             Long branchID) {\n         List<RowLock> locks = new ArrayList<RowLock>();\n \n+        if (StringUtils.isEmpty(lockKey)) {", "originalCommit": "da7dbd260704a5146974c63ef9dd75b9d2f575a5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d1fccadaf1dcacd637520ffb547881db144bff89", "chunk": "diff --git a/server/src/main/java/io/seata/server/lock/AbstractLockManager.java b/server/src/main/java/io/seata/server/lock/AbstractLockManager.java\nindex 6eb09e87ac..87f890ff66 100644\n--- a/server/src/main/java/io/seata/server/lock/AbstractLockManager.java\n+++ b/server/src/main/java/io/seata/server/lock/AbstractLockManager.java\n\n@@ -153,8 +153,8 @@ public abstract class AbstractLockManager implements LockManager {\n                                             Long branchID) {\n         List<RowLock> locks = new ArrayList<RowLock>();\n \n-        if (StringUtils.isEmpty(lockKey)) {\n-            return null;\n+        if (StringUtils.isBlank(lockKey)) {\n+            return locks;\n         }\n         String[] tableGroupedLockKeys = lockKey.split(\";\");\n         for (String tableGroupedLockKey : tableGroupedLockKeys) {\n"}}, {"oid": "d1fccadaf1dcacd637520ffb547881db144bff89", "url": "https://github.com/seata/seata/commit/d1fccadaf1dcacd637520ffb547881db144bff89", "message": "add:add the NPE", "committedDate": "2020-04-08T01:39:24Z", "type": "commit"}, {"oid": "edfd9b36b4fabc8374a4e6c2480526bec6f5a4c0", "url": "https://github.com/seata/seata/commit/edfd9b36b4fabc8374a4e6c2480526bec6f5a4c0", "message": "add:add the NPE", "committedDate": "2020-04-08T01:53:31Z", "type": "commit"}, {"oid": "7c4b11c22fb9f13a91c19d7e1484de3219444d01", "url": "https://github.com/seata/seata/commit/7c4b11c22fb9f13a91c19d7e1484de3219444d01", "message": "remove:remove the NPE", "committedDate": "2020-04-08T02:01:25Z", "type": "commit"}, {"oid": "bab34915c1920088ce6e9711099f1b4818a52ce5", "url": "https://github.com/seata/seata/commit/bab34915c1920088ce6e9711099f1b4818a52ce5", "message": "Merge branch 'develop' into fix_lockkey_is_null", "committedDate": "2020-04-08T04:06:47Z", "type": "commit"}]}