{"pr_number": 3309, "pr_title": "bugfix: Saga statemachine definition json cannot enable jackson parser, and when no choice matched in choice state will throw NPE", "pr_createdAt": "2020-11-26T08:10:14Z", "pr_url": "https://github.com/seata/seata/pull/3309", "timeline": [{"oid": "c89d63da5e95779cd137b0016174a31f2f7b6357", "url": "https://github.com/seata/seata/commit/c89d63da5e95779cd137b0016174a31f2f7b6357", "message": "fix saga statemachine json cannot enable jackson parser", "committedDate": "2020-11-26T03:28:27Z", "type": "commit"}, {"oid": "f37447074792128b827880887ac3c7f8123dbb5f", "url": "https://github.com/seata/seata/commit/f37447074792128b827880887ac3c7f8123dbb5f", "message": "fix saga when no choice matched throw NPE bug", "committedDate": "2020-11-26T07:29:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg2MTQxMw==", "url": "https://github.com/seata/seata/pull/3309#discussion_r530861413", "bodyText": "Useless code?", "author": "wangliang181230", "createdAt": "2020-11-26T08:47:43Z", "path": "test/src/test/java/io/seata/saga/engine/db/StateMachineDBTests.java", "diffHunk": "@@ -107,6 +107,26 @@ public void testSimpleStateMachineWithChoice() {\n         System.out.println(\"====== cost :\" + cost);\n     }\n \n+    @Test\n+    public void testSimpleStateMachineWithChoiceNoDefault() {\n+\n+        long start = System.currentTimeMillis();\n+\n+        Map<String, Object> paramMap = new HashMap<>();\n+        paramMap.put(\"a\", 3);\n+\n+        String stateMachineName = \"simpleChoiceNoDefaultTestStateMachine\";\n+\n+        try {\n+            stateMachineEngine.start(stateMachineName, null, paramMap);\n+        } catch (EngineExecutionException e) {\n+            e.printStackTrace(System.out);\n+            Assertions.assertNotNull(e);", "originalCommit": "f37447074792128b827880887ac3c7f8123dbb5f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg2NTE4NA==", "url": "https://github.com/seata/seata/pull/3309#discussion_r530865184", "bodyText": "No, this unit test is expected to throw an exception", "author": "long187", "createdAt": "2020-11-26T08:53:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg2MTQxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg2NjI4Ng==", "url": "https://github.com/seata/seata/pull/3309#discussion_r530866286", "bodyText": "I mean this line of the code\uff1aAssertions.assertNotNull(e);", "author": "wangliang181230", "createdAt": "2020-11-26T08:55:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg2MTQxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk2OTU3Mg==", "url": "https://github.com/seata/seata/pull/3309#discussion_r530969572", "bodyText": "fixed", "author": "long187", "createdAt": "2020-11-26T11:40:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg2MTQxMw=="}], "type": "inlineReview", "revised_code": {"commit": "371d5c9ce48ebb6400ca7b32eee7c2d44242b2ec", "chunk": "diff --git a/test/src/test/java/io/seata/saga/engine/db/StateMachineDBTests.java b/test/src/test/java/io/seata/saga/engine/db/StateMachineDBTests.java\nindex 281374e49..402147bf9 100644\n--- a/test/src/test/java/io/seata/saga/engine/db/StateMachineDBTests.java\n+++ b/test/src/test/java/io/seata/saga/engine/db/StateMachineDBTests.java\n\n@@ -120,8 +121,9 @@ public class StateMachineDBTests extends AbstractServerTest {\n         try {\n             stateMachineEngine.start(stateMachineName, null, paramMap);\n         } catch (EngineExecutionException e) {\n-            e.printStackTrace(System.out);\n             Assertions.assertNotNull(e);\n+            Assertions.assertTrue(FrameworkErrorCode.StateMachineNoChoiceMatched.equals(e.getErrcode()));\n+            e.printStackTrace(System.out);\n         }\n         long cost = System.currentTimeMillis() - start;\n         System.out.println(\"====== cost :\" + cost);\n"}}, {"oid": "6a6bf6a072ef6c7cffdfdc99d71845a92bca7fd6", "url": "https://github.com/seata/seata/commit/6a6bf6a072ef6c7cffdfdc99d71845a92bca7fd6", "message": "Merge branch 'develop' into fix_saga_somebug", "committedDate": "2020-11-26T10:46:37Z", "type": "commit"}, {"oid": "371d5c9ce48ebb6400ca7b32eee7c2d44242b2ec", "url": "https://github.com/seata/seata/commit/371d5c9ce48ebb6400ca7b32eee7c2d44242b2ec", "message": "fix saga when no choice matched throw NPE bug testcase", "committedDate": "2020-11-26T11:38:09Z", "type": "commit"}, {"oid": "e4e35bbbe571eff4513d9d63c1ccbe3d4b8361a6", "url": "https://github.com/seata/seata/commit/e4e35bbbe571eff4513d9d63c1ccbe3d4b8361a6", "message": "Merge branch 'fix_saga_somebug' of https://github.com/long187/seata into fix_saga_somebug", "committedDate": "2020-11-26T11:38:22Z", "type": "commit"}, {"oid": "60ebe16a43333412acb53bc1a2fd2c158c1900fe", "url": "https://github.com/seata/seata/commit/60ebe16a43333412acb53bc1a2fd2c158c1900fe", "message": "fix saga when no choice matched throw NPE bug testcase", "committedDate": "2020-11-26T11:40:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjE4MjA2Nw==", "url": "https://github.com/seata/seata/pull/3309#discussion_r532182067", "bodyText": "\u6784\u9020\u65b9\u6cd5\u662f\u4e0d\u662f\u5e94\u8be5\u653e\u5230\u5b57\u6bb5\u5b9a\u4e49\u540e\u9762\uff1f", "author": "caohdgege", "createdAt": "2020-11-29T09:32:57Z", "path": "saga/seata-saga-statelang/src/main/java/io/seata/saga/statelang/parser/impl/StateMachineParserImpl.java", "diffHunk": "@@ -42,6 +42,12 @@\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(StateMachineParserImpl.class);\n \n+    public StateMachineParserImpl(String jsonParserName) {", "originalCommit": "60ebe16a43333412acb53bc1a2fd2c158c1900fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMyNTA4Mg==", "url": "https://github.com/seata/seata/pull/3309#discussion_r532325082", "bodyText": "fixed", "author": "long187", "createdAt": "2020-11-30T03:08:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjE4MjA2Nw=="}], "type": "inlineReview", "revised_code": {"commit": "c3d28bc2278721d90c520564181f9ca67f283175", "chunk": "diff --git a/saga/seata-saga-statelang/src/main/java/io/seata/saga/statelang/parser/impl/StateMachineParserImpl.java b/saga/seata-saga-statelang/src/main/java/io/seata/saga/statelang/parser/impl/StateMachineParserImpl.java\nindex 5754213bc..b548bb9af 100644\n--- a/saga/seata-saga-statelang/src/main/java/io/seata/saga/statelang/parser/impl/StateMachineParserImpl.java\n+++ b/saga/seata-saga-statelang/src/main/java/io/seata/saga/statelang/parser/impl/StateMachineParserImpl.java\n\n@@ -42,14 +42,14 @@ public class StateMachineParserImpl implements StateMachineParser {\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(StateMachineParserImpl.class);\n \n+    private String jsonParserName = DomainConstants.DEFAULT_JSON_PARSER;\n+\n     public StateMachineParserImpl(String jsonParserName) {\n         if (StringUtils.isNotBlank(jsonParserName)) {\n             this.jsonParserName = jsonParserName;\n         }\n     }\n \n-    private String jsonParserName = DomainConstants.DEFAULT_JSON_PARSER;\n-\n     @Override\n     public StateMachine parse(String json) {\n \n"}}, {"oid": "c3d28bc2278721d90c520564181f9ca67f283175", "url": "https://github.com/seata/seata/commit/c3d28bc2278721d90c520564181f9ca67f283175", "message": "Move the StateMachineParserImpl constructor to the back of the property", "committedDate": "2020-11-30T03:07:33Z", "type": "commit"}, {"oid": "55a9609f61dc9be6cb2c405962b63ce425dfbd90", "url": "https://github.com/seata/seata/commit/55a9609f61dc9be6cb2c405962b63ce425dfbd90", "message": "skipAndForward method add arg replaceParams", "committedDate": "2020-12-01T09:40:04Z", "type": "commit"}]}