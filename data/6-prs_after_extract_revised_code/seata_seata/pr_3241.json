{"pr_number": 3241, "pr_title": "bugfix: forbidden use order by or limit in multi sql", "pr_createdAt": "2020-10-29T16:57:01Z", "pr_url": "https://github.com/seata/seata/pull/3241", "timeline": [{"oid": "3361a3cc260e2bd1fec9915f1e6560cbfcaa2e36", "url": "https://github.com/seata/seata/commit/3361a3cc260e2bd1fec9915f1e6560cbfcaa2e36", "message": "bugfix: should throws ex if multi sql contains order by or limit", "committedDate": "2020-10-29T16:41:42Z", "type": "commit"}, {"oid": "c48314a678593329d6e7ccde5d698b08ffa47ca1", "url": "https://github.com/seata/seata/commit/c48314a678593329d6e7ccde5d698b08ffa47ca1", "message": "bugfix: add test case", "committedDate": "2020-10-29T16:47:20Z", "type": "commit"}, {"oid": "2a0c8750d827e8d4192369915e84a583a56d2eda", "url": "https://github.com/seata/seata/commit/2a0c8750d827e8d4192369915e84a583a56d2eda", "message": "fix: ci err", "committedDate": "2020-10-29T16:49:15Z", "type": "commit"}, {"oid": "e7f70246e79e163e053df2bc670b519a67abdef9", "url": "https://github.com/seata/seata/commit/e7f70246e79e163e053df2bc670b519a67abdef9", "message": "fix: ci err", "committedDate": "2020-10-29T16:50:17Z", "type": "commit"}, {"oid": "ef1ae6ed19ebf966ef147e572061ae460c885724", "url": "https://github.com/seata/seata/commit/ef1ae6ed19ebf966ef147e572061ae460c885724", "message": "test case", "committedDate": "2020-10-29T16:55:00Z", "type": "commit"}, {"oid": "bfd44cce2761e93249bb734e08102398d833c3a9", "url": "https://github.com/seata/seata/commit/bfd44cce2761e93249bb734e08102398d833c3a9", "message": "Merge branch 'develop' into bugfix-1030", "committedDate": "2020-11-01T16:31:45Z", "type": "commit"}, {"oid": "d87f8e10b66c5d4007c975c894a738fb0f10ca2b", "url": "https://github.com/seata/seata/commit/d87f8e10b66c5d4007c975c894a738fb0f10ca2b", "message": "Merge branch 'develop' into bugfix-1030", "committedDate": "2020-11-06T06:49:45Z", "type": "commit"}, {"oid": "33242f2953002c15baa4d70908f1563aaf46206f", "url": "https://github.com/seata/seata/commit/33242f2953002c15baa4d70908f1563aaf46206f", "message": "fix: ci ex", "committedDate": "2020-11-07T03:30:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzg4MzQxMw==", "url": "https://github.com/seata/seata/pull/3241#discussion_r523883413", "bodyText": "NotSupportYetException ?", "author": "jsbxyyx", "createdAt": "2020-11-16T03:37:14Z", "path": "rm-datasource/src/main/java/io/seata/rm/datasource/exec/MultiDeleteExecutor.java", "diffHunk": "@@ -55,6 +57,15 @@ protected TableRecords beforeImage() throws SQLException {\n         for (SQLRecognizer recognizer : sqlRecognizers) {\n             sqlRecognizer = recognizer;\n             SQLDeleteRecognizer visitor = (SQLDeleteRecognizer) recognizer;\n+\n+            ParametersHolder parametersHolder = statementProxy instanceof ParametersHolder ? (ParametersHolder)statementProxy : null;\n+            if (StringUtils.isNotBlank(visitor.getLimit(parametersHolder, paramAppenderList))) {\n+                throw new ShouldNeverHappenException(\"Multi delete SQL should not contains limit condition !\");", "originalCommit": "33242f2953002c15baa4d70908f1563aaf46206f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM0MTMwMQ==", "url": "https://github.com/seata/seata/pull/3241#discussion_r524341301", "bodyText": "\u597d\u50cfNotSupportYetException \u662f\u66f4\u51c6\u786e\u4e00\u70b9\uff0cmessage\u987a\u4fbf\u6539\u4e00\u4e0b\u53ef\u80fd\u4f1a\u597d\u4e00\u70b9\nMulti delete SQL with limit condition is not support yet !\n\u8fd9\u6837OK\uff1f", "author": "caohdgege", "createdAt": "2020-11-16T15:13:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzg4MzQxMw=="}], "type": "inlineReview", "revised_code": {"commit": "860b6c9e9a88310e054ecf9cb91305d2558fe06d", "chunk": "diff --git a/rm-datasource/src/main/java/io/seata/rm/datasource/exec/MultiDeleteExecutor.java b/rm-datasource/src/main/java/io/seata/rm/datasource/exec/MultiDeleteExecutor.java\nindex 9dd016ec..5eb2418b 100644\n--- a/rm-datasource/src/main/java/io/seata/rm/datasource/exec/MultiDeleteExecutor.java\n+++ b/rm-datasource/src/main/java/io/seata/rm/datasource/exec/MultiDeleteExecutor.java\n\n@@ -60,10 +60,10 @@ public class MultiDeleteExecutor<T, S extends Statement> extends AbstractDMLBase\n \n             ParametersHolder parametersHolder = statementProxy instanceof ParametersHolder ? (ParametersHolder)statementProxy : null;\n             if (StringUtils.isNotBlank(visitor.getLimit(parametersHolder, paramAppenderList))) {\n-                throw new ShouldNeverHappenException(\"Multi delete SQL should not contains limit condition !\");\n+                throw new NotSupportYetException(\"Multi delete SQL with limit condition is not support yet !\");\n             }\n             if (StringUtils.isNotBlank(visitor.getOrderBy())) {\n-                throw new ShouldNeverHappenException(\"Multi delete SQL should not contains order by condition !\");\n+                throw new NotSupportYetException(\"Multi delete SQL with orderBy condition is not support yet !\");\n             }\n \n             String whereConditionStr = buildWhereCondition(visitor, paramAppenderList);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzg4MzQxOA==", "url": "https://github.com/seata/seata/pull/3241#discussion_r523883418", "bodyText": "NotSupportYetException ?", "author": "jsbxyyx", "createdAt": "2020-11-16T03:37:16Z", "path": "rm-datasource/src/main/java/io/seata/rm/datasource/exec/MultiDeleteExecutor.java", "diffHunk": "@@ -55,6 +57,15 @@ protected TableRecords beforeImage() throws SQLException {\n         for (SQLRecognizer recognizer : sqlRecognizers) {\n             sqlRecognizer = recognizer;\n             SQLDeleteRecognizer visitor = (SQLDeleteRecognizer) recognizer;\n+\n+            ParametersHolder parametersHolder = statementProxy instanceof ParametersHolder ? (ParametersHolder)statementProxy : null;\n+            if (StringUtils.isNotBlank(visitor.getLimit(parametersHolder, paramAppenderList))) {\n+                throw new ShouldNeverHappenException(\"Multi delete SQL should not contains limit condition !\");\n+            }\n+            if (StringUtils.isNotBlank(visitor.getOrderBy())) {\n+                throw new ShouldNeverHappenException(\"Multi delete SQL should not contains order by condition !\");", "originalCommit": "33242f2953002c15baa4d70908f1563aaf46206f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "860b6c9e9a88310e054ecf9cb91305d2558fe06d", "chunk": "diff --git a/rm-datasource/src/main/java/io/seata/rm/datasource/exec/MultiDeleteExecutor.java b/rm-datasource/src/main/java/io/seata/rm/datasource/exec/MultiDeleteExecutor.java\nindex 9dd016ec..5eb2418b 100644\n--- a/rm-datasource/src/main/java/io/seata/rm/datasource/exec/MultiDeleteExecutor.java\n+++ b/rm-datasource/src/main/java/io/seata/rm/datasource/exec/MultiDeleteExecutor.java\n\n@@ -60,10 +60,10 @@ public class MultiDeleteExecutor<T, S extends Statement> extends AbstractDMLBase\n \n             ParametersHolder parametersHolder = statementProxy instanceof ParametersHolder ? (ParametersHolder)statementProxy : null;\n             if (StringUtils.isNotBlank(visitor.getLimit(parametersHolder, paramAppenderList))) {\n-                throw new ShouldNeverHappenException(\"Multi delete SQL should not contains limit condition !\");\n+                throw new NotSupportYetException(\"Multi delete SQL with limit condition is not support yet !\");\n             }\n             if (StringUtils.isNotBlank(visitor.getOrderBy())) {\n-                throw new ShouldNeverHappenException(\"Multi delete SQL should not contains order by condition !\");\n+                throw new NotSupportYetException(\"Multi delete SQL with orderBy condition is not support yet !\");\n             }\n \n             String whereConditionStr = buildWhereCondition(visitor, paramAppenderList);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzg4MzQ0MQ==", "url": "https://github.com/seata/seata/pull/3241#discussion_r523883441", "bodyText": "NotSupportYetException ?", "author": "jsbxyyx", "createdAt": "2020-11-16T03:37:21Z", "path": "rm-datasource/src/main/java/io/seata/rm/datasource/exec/MultiUpdateExecutor.java", "diffHunk": "@@ -79,6 +81,15 @@ protected TableRecords beforeImage() throws SQLException {\n         for (SQLRecognizer recognizer : sqlRecognizers) {\n             sqlRecognizer = recognizer;\n             SQLUpdateRecognizer sqlUpdateRecognizer = (SQLUpdateRecognizer) recognizer;\n+\n+            ParametersHolder parametersHolder = statementProxy instanceof ParametersHolder ? (ParametersHolder)statementProxy : null;\n+            if (StringUtils.isNotBlank(sqlUpdateRecognizer.getLimit(parametersHolder, paramAppenderList))) {\n+                throw new ShouldNeverHappenException(\"Multi update SQL should not contains limit condition !\");\n+            }\n+            if (StringUtils.isNotBlank(sqlUpdateRecognizer.getOrderBy())) {\n+                throw new ShouldNeverHappenException(\"Multi update SQL should not contains order by condition !\");", "originalCommit": "33242f2953002c15baa4d70908f1563aaf46206f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "860b6c9e9a88310e054ecf9cb91305d2558fe06d", "chunk": "diff --git a/rm-datasource/src/main/java/io/seata/rm/datasource/exec/MultiUpdateExecutor.java b/rm-datasource/src/main/java/io/seata/rm/datasource/exec/MultiUpdateExecutor.java\nindex 2ccfc781..9efab31f 100644\n--- a/rm-datasource/src/main/java/io/seata/rm/datasource/exec/MultiUpdateExecutor.java\n+++ b/rm-datasource/src/main/java/io/seata/rm/datasource/exec/MultiUpdateExecutor.java\n\n@@ -84,10 +84,10 @@ public class MultiUpdateExecutor<T, S extends Statement> extends AbstractDMLBase\n \n             ParametersHolder parametersHolder = statementProxy instanceof ParametersHolder ? (ParametersHolder)statementProxy : null;\n             if (StringUtils.isNotBlank(sqlUpdateRecognizer.getLimit(parametersHolder, paramAppenderList))) {\n-                throw new ShouldNeverHappenException(\"Multi update SQL should not contains limit condition !\");\n+                throw new NotSupportYetException(\"Multi update SQL with limit condition is not support yet !\");\n             }\n             if (StringUtils.isNotBlank(sqlUpdateRecognizer.getOrderBy())) {\n-                throw new ShouldNeverHappenException(\"Multi update SQL should not contains order by condition !\");\n+                throw new NotSupportYetException(\"Multi update SQL with orderBy condition is not support yet !\");\n             }\n \n             List<String> updateColumns = sqlUpdateRecognizer.getUpdateColumns();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzg4MzQ1Nw==", "url": "https://github.com/seata/seata/pull/3241#discussion_r523883457", "bodyText": "NotSupportYetException ?", "author": "jsbxyyx", "createdAt": "2020-11-16T03:37:24Z", "path": "rm-datasource/src/main/java/io/seata/rm/datasource/exec/MultiUpdateExecutor.java", "diffHunk": "@@ -79,6 +81,15 @@ protected TableRecords beforeImage() throws SQLException {\n         for (SQLRecognizer recognizer : sqlRecognizers) {\n             sqlRecognizer = recognizer;\n             SQLUpdateRecognizer sqlUpdateRecognizer = (SQLUpdateRecognizer) recognizer;\n+\n+            ParametersHolder parametersHolder = statementProxy instanceof ParametersHolder ? (ParametersHolder)statementProxy : null;\n+            if (StringUtils.isNotBlank(sqlUpdateRecognizer.getLimit(parametersHolder, paramAppenderList))) {\n+                throw new ShouldNeverHappenException(\"Multi update SQL should not contains limit condition !\");", "originalCommit": "33242f2953002c15baa4d70908f1563aaf46206f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "860b6c9e9a88310e054ecf9cb91305d2558fe06d", "chunk": "diff --git a/rm-datasource/src/main/java/io/seata/rm/datasource/exec/MultiUpdateExecutor.java b/rm-datasource/src/main/java/io/seata/rm/datasource/exec/MultiUpdateExecutor.java\nindex 2ccfc781..9efab31f 100644\n--- a/rm-datasource/src/main/java/io/seata/rm/datasource/exec/MultiUpdateExecutor.java\n+++ b/rm-datasource/src/main/java/io/seata/rm/datasource/exec/MultiUpdateExecutor.java\n\n@@ -84,10 +84,10 @@ public class MultiUpdateExecutor<T, S extends Statement> extends AbstractDMLBase\n \n             ParametersHolder parametersHolder = statementProxy instanceof ParametersHolder ? (ParametersHolder)statementProxy : null;\n             if (StringUtils.isNotBlank(sqlUpdateRecognizer.getLimit(parametersHolder, paramAppenderList))) {\n-                throw new ShouldNeverHappenException(\"Multi update SQL should not contains limit condition !\");\n+                throw new NotSupportYetException(\"Multi update SQL with limit condition is not support yet !\");\n             }\n             if (StringUtils.isNotBlank(sqlUpdateRecognizer.getOrderBy())) {\n-                throw new ShouldNeverHappenException(\"Multi update SQL should not contains order by condition !\");\n+                throw new NotSupportYetException(\"Multi update SQL with orderBy condition is not support yet !\");\n             }\n \n             List<String> updateColumns = sqlUpdateRecognizer.getUpdateColumns();\n"}}, {"oid": "23e43cdf2150a773ef567a7aad1b616781b39e4a", "url": "https://github.com/seata/seata/commit/23e43cdf2150a773ef567a7aad1b616781b39e4a", "message": "Merge branch 'develop' into bugfix-1030", "committedDate": "2020-11-16T03:38:02Z", "type": "commit"}, {"oid": "860b6c9e9a88310e054ecf9cb91305d2558fe06d", "url": "https://github.com/seata/seata/commit/860b6c9e9a88310e054ecf9cb91305d2558fe06d", "message": "ShouldNeverHappenException -> NotSupportYetException", "committedDate": "2020-11-19T16:09:57Z", "type": "commit"}, {"oid": "860b6c9e9a88310e054ecf9cb91305d2558fe06d", "url": "https://github.com/seata/seata/commit/860b6c9e9a88310e054ecf9cb91305d2558fe06d", "message": "ShouldNeverHappenException -> NotSupportYetException", "committedDate": "2020-11-19T16:09:57Z", "type": "forcePushed"}, {"oid": "bd9fe7c2035ffda986c069abd10ee289e06772a7", "url": "https://github.com/seata/seata/commit/bd9fe7c2035ffda986c069abd10ee289e06772a7", "message": "ShouldNeverHappenException -> NotSupportYetException", "committedDate": "2020-11-19T16:12:21Z", "type": "commit"}, {"oid": "82fabf8ba80ab714cdb0415a99c14cbc99c958af", "url": "https://github.com/seata/seata/commit/82fabf8ba80ab714cdb0415a99c14cbc99c958af", "message": "Merge branch 'github-develop' into bugfix-1030", "committedDate": "2020-12-24T06:24:11Z", "type": "commit"}, {"oid": "3908125d4cfa114172ad6c2851e599df518265a3", "url": "https://github.com/seata/seata/commit/3908125d4cfa114172ad6c2851e599df518265a3", "message": "add change info && rm `max-parallel` of ci", "committedDate": "2020-12-24T06:36:33Z", "type": "commit"}]}