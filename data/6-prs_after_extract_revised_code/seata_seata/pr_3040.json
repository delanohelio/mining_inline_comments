{"pr_number": 3040, "pr_title": "bugfix: fix repeated commit when autocommit is false", "pr_createdAt": "2020-08-18T09:54:18Z", "pr_url": "https://github.com/seata/seata/pull/3040", "timeline": [{"oid": "7a49324180ba0e49ac09595c4b124f7c4627dfe4", "url": "https://github.com/seata/seata/commit/7a49324180ba0e49ac09595c4b124f7c4627dfe4", "message": "bugfix: repeated registration", "committedDate": "2020-08-18T09:52:48Z", "type": "commit"}, {"oid": "22492ecd0219b97d84929179b75e273996d1dfa7", "url": "https://github.com/seata/seata/commit/22492ecd0219b97d84929179b75e273996d1dfa7", "message": "Merge branch 'develop' into 0818", "committedDate": "2020-08-18T10:31:52Z", "type": "commit"}, {"oid": "6c84d49f64438c9ff761e0864522d618751554fe", "url": "https://github.com/seata/seata/commit/6c84d49f64438c9ff761e0864522d618751554fe", "message": "optimize code", "committedDate": "2020-08-18T12:37:42Z", "type": "commit"}, {"oid": "0c414efb46726f9eec8d7c55f73123d6d70044fd", "url": "https://github.com/seata/seata/commit/0c414efb46726f9eec8d7c55f73123d6d70044fd", "message": "Merge branch 'develop' into 0818", "committedDate": "2020-08-19T03:25:25Z", "type": "commit"}, {"oid": "0ae49c028f27180eed0b9406e9de0c67cc54596c", "url": "https://github.com/seata/seata/commit/0ae49c028f27180eed0b9406e9de0c67cc54596c", "message": "Merge branch 'develop' into 0818", "committedDate": "2020-08-28T03:23:04Z", "type": "commit"}, {"oid": "e712420e77bbdaef31321b305be0e6222884e1c7", "url": "https://github.com/seata/seata/commit/e712420e77bbdaef31321b305be0e6222884e1c7", "message": "Merge branch 'develop' into 0818", "committedDate": "2020-09-04T04:07:02Z", "type": "commit"}, {"oid": "1992cb9a497fa9d5006b5536782a2c242ed8e3f1", "url": "https://github.com/seata/seata/commit/1992cb9a497fa9d5006b5536782a2c242ed8e3f1", "message": "Merge branch 'develop' into 0818", "committedDate": "2020-09-16T01:35:04Z", "type": "commit"}, {"oid": "da8a953b9a69b8437ea6f293cbc83d5820e70172", "url": "https://github.com/seata/seata/commit/da8a953b9a69b8437ea6f293cbc83d5820e70172", "message": "Merge branch 'develop' into 0818", "committedDate": "2020-09-23T13:53:43Z", "type": "commit"}, {"oid": "29a6c2387eb66504b0138c8f6dfc3cd88c5e0b82", "url": "https://github.com/seata/seata/commit/29a6c2387eb66504b0138c8f6dfc3cd88c5e0b82", "message": "Merge branch 'develop' into 0818", "committedDate": "2020-10-02T17:28:11Z", "type": "commit"}, {"oid": "9f73fcb2da53ead0d8bce47f131ce4dfea3eca5d", "url": "https://github.com/seata/seata/commit/9f73fcb2da53ead0d8bce47f131ce4dfea3eca5d", "message": "Merge branch 'develop' into 0818", "committedDate": "2020-10-10T08:38:03Z", "type": "commit"}, {"oid": "dbc301748b07b25c60ad23991441ee8d75130564", "url": "https://github.com/seata/seata/commit/dbc301748b07b25c60ad23991441ee8d75130564", "message": "Merge branch 'develop' into 0818", "committedDate": "2020-10-12T13:24:38Z", "type": "commit"}, {"oid": "5fdca37bad995b0d8d9c9e4f484ec7a3432edbb4", "url": "https://github.com/seata/seata/commit/5fdca37bad995b0d8d9c9e4f484ec7a3432edbb4", "message": "optimize code", "committedDate": "2020-10-15T14:25:22Z", "type": "commit"}, {"oid": "0c52921df2d7af8268d57a7c3adaefb24cfbe695", "url": "https://github.com/seata/seata/commit/0c52921df2d7af8268d57a7c3adaefb24cfbe695", "message": "Merge branch 'develop' into 0818", "committedDate": "2020-10-15T14:26:19Z", "type": "commit"}, {"oid": "2893630711634cd98bd2a0cb269d61b887b7e99a", "url": "https://github.com/seata/seata/commit/2893630711634cd98bd2a0cb269d61b887b7e99a", "message": "Merge branch 'develop' into 0818", "committedDate": "2020-10-16T03:10:07Z", "type": "commit"}, {"oid": "2fc42f6bca3a241374a0490db0effc4f6efde9ae", "url": "https://github.com/seata/seata/commit/2fc42f6bca3a241374a0490db0effc4f6efde9ae", "message": "Merge branch 'develop' into 0818", "committedDate": "2020-10-16T10:32:41Z", "type": "commit"}, {"oid": "366c68a788c89066edb00401256619072e715c1e", "url": "https://github.com/seata/seata/commit/366c68a788c89066edb00401256619072e715c1e", "message": "optimize code", "committedDate": "2020-10-16T12:46:19Z", "type": "commit"}, {"oid": "2c86f4d2f82a1f393b4d6c2e84e9ee4a486f7b4d", "url": "https://github.com/seata/seata/commit/2c86f4d2f82a1f393b4d6c2e84e9ee4a486f7b4d", "message": "Merge branch 'develop' into 0818", "committedDate": "2020-10-17T14:17:37Z", "type": "commit"}, {"oid": "8ffb5bd56be79605bbd110bf85203aa49c76d315", "url": "https://github.com/seata/seata/commit/8ffb5bd56be79605bbd110bf85203aa49c76d315", "message": "Merge branch 'develop' into 0818", "committedDate": "2020-10-19T10:12:07Z", "type": "commit"}, {"oid": "bc199fe5a095c2bb5592beb0be1dc7ed24aa13e7", "url": "https://github.com/seata/seata/commit/bc199fe5a095c2bb5592beb0be1dc7ed24aa13e7", "message": "Merge branch 'develop' into 0818", "committedDate": "2020-10-20T06:01:15Z", "type": "commit"}, {"oid": "a14a850a7885b3cc341f71ea733b1bd5aa99b35e", "url": "https://github.com/seata/seata/commit/a14a850a7885b3cc341f71ea733b1bd5aa99b35e", "message": "Merge branch 'develop' into 0818", "committedDate": "2020-10-21T02:29:07Z", "type": "commit"}, {"oid": "76b4844a2a546b694b844fe1e7cde492dde46b58", "url": "https://github.com/seata/seata/commit/76b4844a2a546b694b844fe1e7cde492dde46b58", "message": "Merge branch 'develop' into 0818", "committedDate": "2020-10-21T08:27:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTA5OTM2MA==", "url": "https://github.com/seata/seata/pull/3040#discussion_r509099360", "bodyText": "why throw exx ? the connection will  remain unavailable?", "author": "slievrly", "createdAt": "2020-10-21T08:45:09Z", "path": "rm-datasource/src/main/java/io/seata/rm/datasource/ConnectionProxy.java", "diffHunk": "@@ -251,6 +259,9 @@ public void rollback() throws SQLException {\n \n     @Override\n     public void setAutoCommit(boolean autoCommit) throws SQLException {\n+        if (exception != null) {\n+            throw exception;", "originalCommit": "76b4844a2a546b694b844fe1e7cde492dde46b58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTEwMTcyMw==", "url": "https://github.com/seata/seata/pull/3040#discussion_r509101723", "bodyText": "execution should not continue because an exception has already been made", "author": "a364176773", "createdAt": "2020-10-21T08:48:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTA5OTM2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDE3Mzc0NA==", "url": "https://github.com/seata/seata/pull/3040#discussion_r510173744", "bodyText": "agree with @slievrly", "author": "caohdgege", "createdAt": "2020-10-22T13:45:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTA5OTM2MA=="}], "type": "inlineReview", "revised_code": {"commit": "90d65eb57f9d131d17d4dac7d29ede014a743aa7", "chunk": "diff --git a/rm-datasource/src/main/java/io/seata/rm/datasource/ConnectionProxy.java b/rm-datasource/src/main/java/io/seata/rm/datasource/ConnectionProxy.java\nindex 890ff470..bde1bd18 100644\n--- a/rm-datasource/src/main/java/io/seata/rm/datasource/ConnectionProxy.java\n+++ b/rm-datasource/src/main/java/io/seata/rm/datasource/ConnectionProxy.java\n\n@@ -260,6 +260,7 @@ public class ConnectionProxy extends AbstractConnectionProxy {\n     @Override\n     public void setAutoCommit(boolean autoCommit) throws SQLException {\n         if (exception != null) {\n+            rollback();\n             throw exception;\n         }\n         if (autoCommit && !getAutoCommit()) {\n"}}, {"oid": "90d65eb57f9d131d17d4dac7d29ede014a743aa7", "url": "https://github.com/seata/seata/commit/90d65eb57f9d131d17d4dac7d29ede014a743aa7", "message": "bug fix", "committedDate": "2020-10-21T09:29:56Z", "type": "commit"}, {"oid": "042b58e71202325d1a30146177bf8015630bbb3c", "url": "https://github.com/seata/seata/commit/042b58e71202325d1a30146177bf8015630bbb3c", "message": "bug fix", "committedDate": "2020-10-21T09:33:43Z", "type": "commit"}, {"oid": "af8c4127a5497e3efe34d8edac3ecad02b4a4c3c", "url": "https://github.com/seata/seata/commit/af8c4127a5497e3efe34d8edac3ecad02b4a4c3c", "message": "Merge branch 'develop' into 0818", "committedDate": "2020-10-22T05:46:20Z", "type": "commit"}, {"oid": "19ff6c7a10d5cc6560d96928a17795829d4eeb12", "url": "https://github.com/seata/seata/commit/19ff6c7a10d5cc6560d96928a17795829d4eeb12", "message": "Merge branch 'develop' into 0818", "committedDate": "2020-10-22T08:48:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEzNzUzMQ==", "url": "https://github.com/seata/seata/pull/3040#discussion_r510137531", "bodyText": "\u8fd9\u91cc\u76f4\u63a5\u8c03\u7528context.reset\u4f1a\u4e0d\u4f1a\u597d\u4e00\u70b9\uff1f\n\u56e0\u4e3a\u8fd9\u4e2a\u5f02\u5e38\u6781\u6709\u53ef\u80fd\u5df2\u7ecf\u88ab\u8c03\u7528\u65b9\u6d88\u8d39\u6389\u4e86\u7684\u3002\u5e76\u4e14\u4f7f\u7528reset\u7684\u8bdd\uff0ctargetConnection\u7684autocommit\u662f\u4f20\u5165\u7684\u503c\uff1b\u5982\u679c\u76f4\u63a5\u629b\u5f02\u5e38\u7684\u8bdd\uff0c\u90a3\u5c31\u662f\u539f\u503c\u4e86\u3002\u671f\u5f85\u503c\u5e94\u8be5\u662f\u4f20\u5165\u7684\u503c\u7684\u3002", "author": "caohdgege", "createdAt": "2020-10-22T12:55:42Z", "path": "rm-datasource/src/main/java/io/seata/rm/datasource/ConnectionProxy.java", "diffHunk": "@@ -251,6 +262,11 @@ public void rollback() throws SQLException {\n \n     @Override\n     public void setAutoCommit(boolean autoCommit) throws SQLException {\n+        if (exception != null) {\n+            SQLException e = exception;\n+            rollback();\n+            throw e;", "originalCommit": "19ff6c7a10d5cc6560d96928a17795829d4eeb12", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "65102a374ae213db21e23ebc44eafa06d1f69412", "chunk": "diff --git a/rm-datasource/src/main/java/io/seata/rm/datasource/ConnectionProxy.java b/rm-datasource/src/main/java/io/seata/rm/datasource/ConnectionProxy.java\nindex 429f25b7..2e766823 100644\n--- a/rm-datasource/src/main/java/io/seata/rm/datasource/ConnectionProxy.java\n+++ b/rm-datasource/src/main/java/io/seata/rm/datasource/ConnectionProxy.java\n\n@@ -262,10 +258,10 @@ public class ConnectionProxy extends AbstractConnectionProxy {\n \n     @Override\n     public void setAutoCommit(boolean autoCommit) throws SQLException {\n+        SQLException exception = context.getException();\n         if (exception != null) {\n-            SQLException e = exception;\n-            rollback();\n-            throw e;\n+            context.reset();\n+            throw exception;\n         }\n         if (autoCommit && !getAutoCommit()) {\n             // change autocommit from false to true, we should commit() first according to JDBC spec.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEzNzU3Mw==", "url": "https://github.com/seata/seata/pull/3040#discussion_r510137573", "bodyText": "\u8fd9\u4e2a\u653e\u5728ConnectionContext\u91cc\u9762\u4f1a\u4e0d\u4f1a\u597d\u4e00\u70b9\uff1f", "author": "caohdgege", "createdAt": "2020-10-22T12:55:46Z", "path": "rm-datasource/src/main/java/io/seata/rm/datasource/ConnectionProxy.java", "diffHunk": "@@ -57,6 +57,8 @@\n \n     private final static LockRetryPolicy LOCK_RETRY_POLICY = new LockRetryPolicy();\n \n+    private SQLException exception;", "originalCommit": "19ff6c7a10d5cc6560d96928a17795829d4eeb12", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "65102a374ae213db21e23ebc44eafa06d1f69412", "chunk": "diff --git a/rm-datasource/src/main/java/io/seata/rm/datasource/ConnectionProxy.java b/rm-datasource/src/main/java/io/seata/rm/datasource/ConnectionProxy.java\nindex 429f25b7..2e766823 100644\n--- a/rm-datasource/src/main/java/io/seata/rm/datasource/ConnectionProxy.java\n+++ b/rm-datasource/src/main/java/io/seata/rm/datasource/ConnectionProxy.java\n\n@@ -57,8 +57,6 @@ public class ConnectionProxy extends AbstractConnectionProxy {\n \n     private final static LockRetryPolicy LOCK_RETRY_POLICY = new LockRetryPolicy();\n \n-    private SQLException exception;\n-\n     /**\n      * Instantiates a new Connection proxy.\n      *\n"}}, {"oid": "65102a374ae213db21e23ebc44eafa06d1f69412", "url": "https://github.com/seata/seata/commit/65102a374ae213db21e23ebc44eafa06d1f69412", "message": "optimize code", "committedDate": "2020-10-22T13:37:57Z", "type": "commit"}, {"oid": "b93a5ba1b1761997b0d61b800285df5469b5d1cb", "url": "https://github.com/seata/seata/commit/b93a5ba1b1761997b0d61b800285df5469b5d1cb", "message": "optimize code", "committedDate": "2020-10-22T14:30:25Z", "type": "commit"}, {"oid": "f64d12e9d5e33d23ab91b34812aaacca0a16f46b", "url": "https://github.com/seata/seata/commit/f64d12e9d5e33d23ab91b34812aaacca0a16f46b", "message": "optimize code", "committedDate": "2020-10-22T14:57:49Z", "type": "commit"}, {"oid": "8d8981819e0b05122eaeae1db254c1a9141adca2", "url": "https://github.com/seata/seata/commit/8d8981819e0b05122eaeae1db254c1a9141adca2", "message": "Merge branch 'develop' into 0818", "committedDate": "2020-10-22T16:25:39Z", "type": "commit"}, {"oid": "ab07c1d9328c8141771bca522ca23a3b0db95d5e", "url": "https://github.com/seata/seata/commit/ab07c1d9328c8141771bca522ca23a3b0db95d5e", "message": "Merge branch 'develop' into 0818", "committedDate": "2020-10-23T05:57:06Z", "type": "commit"}, {"oid": "391a89ea4be828ec4c86c68b045b248f3d3d781c", "url": "https://github.com/seata/seata/commit/391a89ea4be828ec4c86c68b045b248f3d3d781c", "message": "bug fix", "committedDate": "2020-10-23T06:15:20Z", "type": "commit"}, {"oid": "64e80c68aec3f399e09cbb662f61ff553b12f0ac", "url": "https://github.com/seata/seata/commit/64e80c68aec3f399e09cbb662f61ff553b12f0ac", "message": "optimize code", "committedDate": "2020-10-25T05:59:28Z", "type": "commit"}, {"oid": "4324a10c676ef99dc3e325415dab2d0b74b58283", "url": "https://github.com/seata/seata/commit/4324a10c676ef99dc3e325415dab2d0b74b58283", "message": "optimize code", "committedDate": "2020-10-25T06:15:32Z", "type": "commit"}, {"oid": "11bf89dfd161c129af245e606c00d281bfe7a1d0", "url": "https://github.com/seata/seata/commit/11bf89dfd161c129af245e606c00d281bfe7a1d0", "message": "Merge branch 'develop' into 0818", "committedDate": "2020-10-25T06:18:24Z", "type": "commit"}, {"oid": "f4d5f8d4d3e90a461b39803ef86b2858537c3a1d", "url": "https://github.com/seata/seata/commit/f4d5f8d4d3e90a461b39803ef86b2858537c3a1d", "message": "bugfix", "committedDate": "2020-10-26T09:27:40Z", "type": "commit"}, {"oid": "0735d63b99690993ae47e89cd86552b240fc0afc", "url": "https://github.com/seata/seata/commit/0735d63b99690993ae47e89cd86552b240fc0afc", "message": "Merge branch 'develop' into 0818", "committedDate": "2020-10-26T10:10:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg1Mjc1Mg==", "url": "https://github.com/seata/seata/pull/3040#discussion_r511852752", "bodyText": "if(autocommit=false) {\n    rollback();\n}\n\nWhat kind of problem of this line solved ?", "author": "l81893521", "createdAt": "2020-10-26T10:19:39Z", "path": "rm-datasource/src/main/java/io/seata/rm/datasource/ConnectionProxy.java", "diffHunk": "@@ -185,6 +185,9 @@ public void commit() throws SQLException {\n                 return null;\n             });\n         } catch (SQLException e) {\n+            if (targetConnection != null && !getAutoCommit()) {\n+                rollback();", "originalCommit": "0735d63b99690993ae47e89cd86552b240fc0afc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg1NDI5NA==", "url": "https://github.com/seata/seata/pull/3040#discussion_r511854294", "bodyText": "this connection is reset on rollback to prevent duplicate registration and connection unavailability issues", "author": "a364176773", "createdAt": "2020-10-26T10:22:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg1Mjc1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg2MTg3Nw==", "url": "https://github.com/seata/seata/pull/3040#discussion_r511861877", "bodyText": "How about under this situation\nset autocommit = 0;\nstart transaction;\n//success\ninsert into account values (xxxx);\nsavepoint step1;\n//lock conflict\ninsert into order values(xxxxx);\nrollback to step1;", "author": "l81893521", "createdAt": "2020-10-26T10:34:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg1Mjc1Mg=="}], "type": "inlineReview", "revised_code": null}]}