{"pr_number": 2372, "pr_title": "optimize: refactor lock store sql with SPI", "pr_createdAt": "2020-03-07T13:31:59Z", "pr_url": "https://github.com/seata/seata/pull/2372", "timeline": [{"oid": "c38b85cb4cf043907d93ac811577e7aa50c5d5a2", "url": "https://github.com/seata/seata/commit/c38b85cb4cf043907d93ac811577e7aa50c5d5a2", "message": "Optimize: refactor lock store sql with spi.", "committedDate": "2020-03-07T13:25:44Z", "type": "commit"}, {"oid": "2755445e8bcc2ac4f122802794f8c5ee79c54503", "url": "https://github.com/seata/seata/commit/2755445e8bcc2ac4f122802794f8c5ee79c54503", "message": "Optimize: refactor lock store sql with spi.", "committedDate": "2020-03-07T13:28:44Z", "type": "commit"}, {"oid": "f1512a075f06d2d65723ef75b893df06f7afbf8e", "url": "https://github.com/seata/seata/commit/f1512a075f06d2d65723ef75b893df06f7afbf8e", "message": "Optimize: refactor lock store sql with spi.", "committedDate": "2020-03-07T13:31:03Z", "type": "commit"}, {"oid": "d3859d5368810796d732e31d5cc1e9928f3c5863", "url": "https://github.com/seata/seata/commit/d3859d5368810796d732e31d5cc1e9928f3c5863", "message": "fix: h2 spi name.", "committedDate": "2020-03-07T13:36:52Z", "type": "commit"}, {"oid": "7171f39953f62496165b43a0c473c0b11f1fa623", "url": "https://github.com/seata/seata/commit/7171f39953f62496165b43a0c473c0b11f1fa623", "message": "Merge branch 'develop' into refactor_lock_store_sql_with_spi", "committedDate": "2020-03-07T13:40:42Z", "type": "commit"}, {"oid": "8d3ab523b91341e83c335a6d403677ad29483f55", "url": "https://github.com/seata/seata/commit/8d3ab523b91341e83c335a6d403677ad29483f55", "message": "add sql dir.", "committedDate": "2020-03-07T14:03:29Z", "type": "commit"}, {"oid": "c98e317d0a543ae18059ef4d602412af92b830fe", "url": "https://github.com/seata/seata/commit/c98e317d0a543ae18059ef4d602412af92b830fe", "message": "restore import", "committedDate": "2020-03-07T14:39:05Z", "type": "commit"}, {"oid": "d050b9b1af78bbd473db7bfd70cb6c45e04670d3", "url": "https://github.com/seata/seata/commit/d050b9b1af78bbd473db7bfd70cb6c45e04670d3", "message": "bugfix: getLogStoreSql.", "committedDate": "2020-03-08T08:15:32Z", "type": "commit"}, {"oid": "e8922180b854b4da4f86584132baaa23a914b060", "url": "https://github.com/seata/seata/commit/e8922180b854b4da4f86584132baaa23a914b060", "message": "Merge remote-tracking branch 'origin/refactor_lock_store_sql_with_spi' into refactor_lock_store_sql_with_spi", "committedDate": "2020-03-08T08:15:53Z", "type": "commit"}, {"oid": "0c81b2ad8ea40bee6c7dc2c96f1f96a0d649f01a", "url": "https://github.com/seata/seata/commit/0c81b2ad8ea40bee6c7dc2c96f1f96a0d649f01a", "message": "bugfix: rename lock store plugin.", "committedDate": "2020-03-08T10:19:07Z", "type": "commit"}, {"oid": "430d66d7b5e52d69b72bb6442386f59d750d4584", "url": "https://github.com/seata/seata/commit/430d66d7b5e52d69b72bb6442386f59d750d4584", "message": "Optimize: Should not support multiple database, Can be changed to a single.", "committedDate": "2020-03-10T12:42:34Z", "type": "commit"}, {"oid": "f55937ff14e425c93726bc173a5e316b8e6d54e3", "url": "https://github.com/seata/seata/commit/f55937ff14e425c93726bc173a5e316b8e6d54e3", "message": "LOCK_STORE_SQL_MAP", "committedDate": "2020-03-18T07:56:45Z", "type": "commit"}, {"oid": "2f5940a0536948d82ceb9b9ff3037051b9123dd7", "url": "https://github.com/seata/seata/commit/2f5940a0536948d82ceb9b9ff3037051b9123dd7", "message": "add the Lock Store Sql Factory Test", "committedDate": "2020-03-18T12:53:50Z", "type": "commit"}, {"oid": "09ab9103af97387924ea13fa876f330190c7ade6", "url": "https://github.com/seata/seata/commit/09ab9103af97387924ea13fa876f330190c7ade6", "message": "Merge branch 'develop' into refactor_lock_store_sql_with_spi\n\n# Conflicts:\n#\tserver/src/main/java/io/seata/server/storage/db/lock/LockStoreDataBaseDAO.java\n#\tserver/src/main/java/io/seata/server/storage/db/lock/LockStoreSqls.java", "committedDate": "2020-03-22T07:59:10Z", "type": "commit"}, {"oid": "3871f6d253d286714362256ff08640dca1ca1cb1", "url": "https://github.com/seata/seata/commit/3871f6d253d286714362256ff08640dca1ca1cb1", "message": "resolve the code conflict.", "committedDate": "2020-03-22T08:59:13Z", "type": "commit"}, {"oid": "00b8586bbb714cc9b6a056e0b7f59d6d817526f1", "url": "https://github.com/seata/seata/commit/00b8586bbb714cc9b6a056e0b7f59d6d817526f1", "message": "Merge branch 'develop' into refactor_lock_store_sql_with_spi", "committedDate": "2020-03-29T02:36:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYzMTI1Nw==", "url": "https://github.com/seata/seata/pull/2372#discussion_r400631257", "bodyText": "notice the space", "author": "slievrly", "createdAt": "2020-03-31T04:07:46Z", "path": "core/src/main/java/io/seata/core/store/db/sql/lock/MysqlLockStoreSql.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ *  Copyright 1999-2019 Seata.io Group.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package io.seata.core.store.db.sql.lock;\n+\n+import io.seata.common.loader.LoadLevel;\n+\n+/**\n+ * the database lock store mysql sql\n+ *\n+ * @author zhangchenghui.dev@gmail.com\n+ * @since 1.2.0\n+ */\n+@LoadLevel(name = \"mysql\")\n+public class MysqlLockStoreSql extends AbstractLockStoreSql {\n+\n+    /**\n+     * The constant INSERT_LOCK_SQL_MYSQL.\n+     */\n+    private static final String INSERT_LOCK_SQL_MYSQL = \"insert into \" + LOCK_TABLE_PLACE_HOLD + \"(\" + ALL_COLUMNS + \")\" +\n+        \"values (?, ?, ?, ?, ?, ?, ?, now(), now())\";", "originalCommit": "00b8586bbb714cc9b6a056e0b7f59d6d817526f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY1MjQ4Mg==", "url": "https://github.com/seata/seata/pull/2372#discussion_r400652482", "bodyText": "done.", "author": "objcoding", "createdAt": "2020-03-31T05:30:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYzMTI1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "2c1f175ad279fdc49a7688dc2af75142a4b9d852", "chunk": "diff --git a/core/src/main/java/io/seata/core/store/db/sql/lock/MysqlLockStoreSql.java b/core/src/main/java/io/seata/core/store/db/sql/lock/MysqlLockStoreSql.java\nindex 6a7c32e13..fc7f26837 100644\n--- a/core/src/main/java/io/seata/core/store/db/sql/lock/MysqlLockStoreSql.java\n+++ b/core/src/main/java/io/seata/core/store/db/sql/lock/MysqlLockStoreSql.java\n\n@@ -29,8 +29,8 @@ public class MysqlLockStoreSql extends AbstractLockStoreSql {\n     /**\n      * The constant INSERT_LOCK_SQL_MYSQL.\n      */\n-    private static final String INSERT_LOCK_SQL_MYSQL = \"insert into \" + LOCK_TABLE_PLACE_HOLD + \"(\" + ALL_COLUMNS + \")\" +\n-        \"values (?, ?, ?, ?, ?, ?, ?, now(), now())\";\n+    private static final String INSERT_LOCK_SQL_MYSQL = \"insert into \" + LOCK_TABLE_PLACE_HOLD + \"(\" + ALL_COLUMNS + \")\"\n+        + \"values (?, ?, ?, ?, ?, ?, ?, now(), now())\";\n \n     @Override\n     public String getInsertLockSQL(String lockTable) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYzMTM2OQ==", "url": "https://github.com/seata/seata/pull/2372#discussion_r400631369", "bodyText": "notice the space", "author": "slievrly", "createdAt": "2020-03-31T04:08:12Z", "path": "core/src/main/java/io/seata/core/store/db/sql/lock/OceanbaseLockStoreSql.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ *  Copyright 1999-2019 Seata.io Group.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package io.seata.core.store.db.sql.lock;\n+\n+import io.seata.common.loader.LoadLevel;\n+\n+/**\n+ * the database lock store oceanbase sql\n+ *\n+ * @author zhangchenghui.dev@gmail.com\n+ * @since 1.2.0\n+ */\n+@LoadLevel(name = \"oceanbase\")\n+public class OceanbaseLockStoreSql extends AbstractLockStoreSql {\n+\n+    /**\n+     * The constant INSERT_LOCK_SQL_OCEANBASE.\n+     */\n+    private static final String INSERT_LOCK_SQL_OCEANBASE = \"insert into \" + LOCK_TABLE_PLACE_HOLD + \"(\" + ALL_COLUMNS + \")\" +\n+        \"values (?, ?, ?, ?, ?, ?, ?, now(), now())\";", "originalCommit": "00b8586bbb714cc9b6a056e0b7f59d6d817526f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY1MjUwOQ==", "url": "https://github.com/seata/seata/pull/2372#discussion_r400652509", "bodyText": "done.", "author": "objcoding", "createdAt": "2020-03-31T05:30:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYzMTM2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "2c1f175ad279fdc49a7688dc2af75142a4b9d852", "chunk": "diff --git a/core/src/main/java/io/seata/core/store/db/sql/lock/OceanbaseLockStoreSql.java b/core/src/main/java/io/seata/core/store/db/sql/lock/OceanbaseLockStoreSql.java\nindex 65740adf7..d98a1f54e 100644\n--- a/core/src/main/java/io/seata/core/store/db/sql/lock/OceanbaseLockStoreSql.java\n+++ b/core/src/main/java/io/seata/core/store/db/sql/lock/OceanbaseLockStoreSql.java\n\n@@ -29,8 +29,8 @@ public class OceanbaseLockStoreSql extends AbstractLockStoreSql {\n     /**\n      * The constant INSERT_LOCK_SQL_OCEANBASE.\n      */\n-    private static final String INSERT_LOCK_SQL_OCEANBASE = \"insert into \" + LOCK_TABLE_PLACE_HOLD + \"(\" + ALL_COLUMNS + \")\" +\n-        \"values (?, ?, ?, ?, ?, ?, ?, now(), now())\";\n+    private static final String INSERT_LOCK_SQL_OCEANBASE = \"insert into \" + LOCK_TABLE_PLACE_HOLD + \"(\" + ALL_COLUMNS + \")\"\n+        + \"values (?, ?, ?, ?, ?, ?, ?, now(), now())\";\n \n     @Override\n     public String getInsertLockSQL(String lockTable) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYzMTQxMg==", "url": "https://github.com/seata/seata/pull/2372#discussion_r400631412", "bodyText": "notice the space", "author": "slievrly", "createdAt": "2020-03-31T04:08:27Z", "path": "core/src/main/java/io/seata/core/store/db/sql/lock/OracleLockStoreSql.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+ *  Copyright 1999-2019 Seata.io Group.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package io.seata.core.store.db.sql.lock;\n+\n+import io.seata.common.loader.LoadLevel;\n+\n+/**\n+ * the database lock store oracle sql\n+ *\n+ * @author zhangchenghui.dev@gmail.com\n+ * @since 1.2.0\n+ */\n+@LoadLevel(name = \"oracle\")\n+public class OracleLockStoreSql extends AbstractLockStoreSql {\n+\n+    /**\n+     * The constant INSERT_LOCK_SQL_ORACLE.\n+     */\n+    private static final String INSERT_LOCK_SQL_ORACLE = \"insert into \" + LOCK_TABLE_PLACE_HOLD + \"(\" + ALL_COLUMNS + \")\"\n+        +\n+        \"values (?, ?, ?, ?, ?, ?, ?, sysdate, sysdate)\";", "originalCommit": "00b8586bbb714cc9b6a056e0b7f59d6d817526f1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "018e9d4019f48ac15ecc08d355e1016a43550043", "chunk": "diff --git a/core/src/main/java/io/seata/core/store/db/sql/lock/OracleLockStoreSql.java b/core/src/main/java/io/seata/core/store/db/sql/lock/OracleLockStoreSql.java\nindex 98ba37af1..9d9a1e1fb 100644\n--- a/core/src/main/java/io/seata/core/store/db/sql/lock/OracleLockStoreSql.java\n+++ b/core/src/main/java/io/seata/core/store/db/sql/lock/OracleLockStoreSql.java\n\n@@ -30,8 +30,7 @@ public class OracleLockStoreSql extends AbstractLockStoreSql {\n      * The constant INSERT_LOCK_SQL_ORACLE.\n      */\n     private static final String INSERT_LOCK_SQL_ORACLE = \"insert into \" + LOCK_TABLE_PLACE_HOLD + \"(\" + ALL_COLUMNS + \")\"\n-        +\n-        \"values (?, ?, ?, ?, ?, ?, ?, sysdate, sysdate)\";\n+        + \"values (?, ?, ?, ?, ?, ?, ?, sysdate, sysdate)\";\n \n     @Override\n     public String getInsertLockSQL(String lockTable) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYzMTUzNQ==", "url": "https://github.com/seata/seata/pull/2372#discussion_r400631535", "bodyText": "notice the space", "author": "slievrly", "createdAt": "2020-03-31T04:08:50Z", "path": "core/src/main/java/io/seata/core/store/db/sql/lock/PostgresqlLockStoreSql.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+ *  Copyright 1999-2019 Seata.io Group.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package io.seata.core.store.db.sql.lock;\n+\n+import io.seata.common.loader.LoadLevel;\n+\n+/**\n+ * the database lock store postgre sql\n+ *\n+ * @author zhangchenghui.dev@gmail.com\n+ * @since 1.2.0\n+ */\n+@LoadLevel(name = \"postgresql\")\n+public class PostgresqlLockStoreSql extends AbstractLockStoreSql {\n+\n+    /**\n+     * The constant INSERT_LOCK_SQL_POSTGRESQL.\n+     */\n+    private static final String INSERT_LOCK_SQL_POSTGRESQL = \"insert into \" + LOCK_TABLE_PLACE_HOLD + \"(\" + ALL_COLUMNS + \")\"\n+        +\n+        \"values (?, ?, ?, ?, ?, ?, ?, now(), now())\";", "originalCommit": "00b8586bbb714cc9b6a056e0b7f59d6d817526f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY1Mjg3OA==", "url": "https://github.com/seata/seata/pull/2372#discussion_r400652878", "bodyText": "done.", "author": "objcoding", "createdAt": "2020-03-31T05:31:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYzMTUzNQ=="}], "type": "inlineReview", "revised_code": {"commit": "018e9d4019f48ac15ecc08d355e1016a43550043", "chunk": "diff --git a/core/src/main/java/io/seata/core/store/db/sql/lock/PostgresqlLockStoreSql.java b/core/src/main/java/io/seata/core/store/db/sql/lock/PostgresqlLockStoreSql.java\nindex ba8a5f1a0..becbd750b 100644\n--- a/core/src/main/java/io/seata/core/store/db/sql/lock/PostgresqlLockStoreSql.java\n+++ b/core/src/main/java/io/seata/core/store/db/sql/lock/PostgresqlLockStoreSql.java\n\n@@ -30,8 +30,7 @@ public class PostgresqlLockStoreSql extends AbstractLockStoreSql {\n      * The constant INSERT_LOCK_SQL_POSTGRESQL.\n      */\n     private static final String INSERT_LOCK_SQL_POSTGRESQL = \"insert into \" + LOCK_TABLE_PLACE_HOLD + \"(\" + ALL_COLUMNS + \")\"\n-        +\n-        \"values (?, ?, ?, ?, ?, ?, ?, now(), now())\";\n+        + \"values (?, ?, ?, ?, ?, ?, ?, now(), now())\";\n \n     @Override\n     public String getInsertLockSQL(String lockTable) {\n"}}, {"oid": "018e9d4019f48ac15ecc08d355e1016a43550043", "url": "https://github.com/seata/seata/commit/018e9d4019f48ac15ecc08d355e1016a43550043", "message": "fix insert space", "committedDate": "2020-03-31T05:29:22Z", "type": "commit"}, {"oid": "ee5e08bb04a02508c475b813989b15a90f7ddfd4", "url": "https://github.com/seata/seata/commit/ee5e08bb04a02508c475b813989b15a90f7ddfd4", "message": "Merge remote-tracking branch 'origin/refactor_lock_store_sql_with_spi' into refactor_lock_store_sql_with_spi", "committedDate": "2020-03-31T05:29:33Z", "type": "commit"}, {"oid": "2c1f175ad279fdc49a7688dc2af75142a4b9d852", "url": "https://github.com/seata/seata/commit/2c1f175ad279fdc49a7688dc2af75142a4b9d852", "message": "fix insert space", "committedDate": "2020-03-31T05:31:17Z", "type": "commit"}, {"oid": "4f8d424fd04621c2658129234e46309480cb251c", "url": "https://github.com/seata/seata/commit/4f8d424fd04621c2658129234e46309480cb251c", "message": "Merge branch 'develop' into refactor_lock_store_sql_with_spi", "committedDate": "2020-03-31T08:51:48Z", "type": "commit"}, {"oid": "d689db8b09a0c22d64e8113fda485fb19fcafa3e", "url": "https://github.com/seata/seata/commit/d689db8b09a0c22d64e8113fda485fb19fcafa3e", "message": "fix insert space", "committedDate": "2020-03-31T10:13:45Z", "type": "commit"}, {"oid": "1842dcc388dba52b823b2fc75ee12f394ff12d9e", "url": "https://github.com/seata/seata/commit/1842dcc388dba52b823b2fc75ee12f394ff12d9e", "message": "Merge remote-tracking branch 'origin/refactor_lock_store_sql_with_spi' into refactor_lock_store_sql_with_spi", "committedDate": "2020-03-31T10:14:16Z", "type": "commit"}, {"oid": "ef5cc30c72f936ac2afc690a941f4e7f9776110a", "url": "https://github.com/seata/seata/commit/ef5cc30c72f936ac2afc690a941f4e7f9776110a", "message": "Merge branch 'develop' into refactor_lock_store_sql_with_spi", "committedDate": "2020-04-01T03:21:01Z", "type": "commit"}]}