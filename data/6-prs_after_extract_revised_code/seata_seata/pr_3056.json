{"pr_number": 3056, "pr_title": "bugfix:  fixed a bug that after branch deletion, there are still remaining branch lock", "pr_createdAt": "2020-08-24T07:39:54Z", "pr_url": "https://github.com/seata/seata/pull/3056", "timeline": [{"oid": "e9e72550fdf5946b055d5b089178bf329966ee6b", "url": "https://github.com/seata/seata/commit/e9e72550fdf5946b055d5b089178bf329966ee6b", "message": "release 0.5.1", "committedDate": "2019-04-30T08:44:14Z", "type": "commit"}, {"oid": "f017c6b875c304f75fe34be37f9d4cf75e2f45f4", "url": "https://github.com/seata/seata/commit/f017c6b875c304f75fe34be37f9d4cf75e2f45f4", "message": "release 0.5.2\n\nrelease 0.5.2", "committedDate": "2019-05-17T10:12:34Z", "type": "commit"}, {"oid": "7ca3332d67c2f0d43ce7d854e6bbb04e48bcae8b", "url": "https://github.com/seata/seata/commit/7ca3332d67c2f0d43ce7d854e6bbb04e48bcae8b", "message": "Release 0.6.0 (#1106)", "committedDate": "2019-05-24T09:47:44Z", "type": "commit"}, {"oid": "dc088cb9551d58acdf343f66166985e8fa8712fd", "url": "https://github.com/seata/seata/commit/dc088cb9551d58acdf343f66166985e8fa8712fd", "message": "Revert \"Release 0.6.0 (#1106)\" (#1107)", "committedDate": "2019-05-27T02:27:47Z", "type": "commit"}, {"oid": "da96029455843dfd8ace1c085e8a170f05ad659a", "url": "https://github.com/seata/seata/commit/da96029455843dfd8ace1c085e8a170f05ad659a", "message": "re-merging 0.6.0", "committedDate": "2019-05-27T02:40:28Z", "type": "commit"}, {"oid": "ca567ef724cc53ef624a42718997853fbdddae54", "url": "https://github.com/seata/seata/commit/ca567ef724cc53ef624a42718997853fbdddae54", "message": "Release 0.6.1\n\nRelease 0.6.1", "committedDate": "2019-05-31T07:33:13Z", "type": "commit"}, {"oid": "1b90f935a27a928a8a75e8c11a4687235f1507d9", "url": "https://github.com/seata/seata/commit/1b90f935a27a928a8a75e8c11a4687235f1507d9", "message": "release 0.7.0", "committedDate": "2019-07-12T07:12:02Z", "type": "commit"}, {"oid": "39e4d892ada776f35c78528c85e773dd6ac8f5f1", "url": "https://github.com/seata/seata/commit/39e4d892ada776f35c78528c85e773dd6ac8f5f1", "message": "release 0.7.1\n\nrelease 0.7.1", "committedDate": "2019-07-15T12:01:04Z", "type": "commit"}, {"oid": "09456818ecd6644439366647021b683516225cb3", "url": "https://github.com/seata/seata/commit/09456818ecd6644439366647021b683516225cb3", "message": "release 0.8.0\n\nrelease 0.8.0", "committedDate": "2019-08-16T08:13:03Z", "type": "commit"}, {"oid": "9ffa29044209f04c222eab5445c8b01ea6295522", "url": "https://github.com/seata/seata/commit/9ffa29044209f04c222eab5445c8b01ea6295522", "message": "release  0.8.1", "committedDate": "2019-09-18T09:39:19Z", "type": "commit"}, {"oid": "a174ed5594d405ba26706c355327ac0ac8017b27", "url": "https://github.com/seata/seata/commit/a174ed5594d405ba26706c355327ac0ac8017b27", "message": "release 0.9.0", "committedDate": "2019-10-16T05:38:49Z", "type": "commit"}, {"oid": "5bdbc44e524263a47aa51a1a2a648b120456ee5b", "url": "https://github.com/seata/seata/commit/5bdbc44e524263a47aa51a1a2a648b120456ee5b", "message": "[release] release 1.0.0\n\n[release] release 1.0.0", "committedDate": "2019-12-20T16:59:09Z", "type": "commit"}, {"oid": "f990a575328504ef4dece32a93383f1debc0d7f2", "url": "https://github.com/seata/seata/commit/f990a575328504ef4dece32a93383f1debc0d7f2", "message": "release: release 1.1.0", "committedDate": "2020-02-19T15:13:24Z", "type": "commit"}, {"oid": "04d0568c0e89fd77c5a8c22a9d39025a0be41051", "url": "https://github.com/seata/seata/commit/04d0568c0e89fd77c5a8c22a9d39025a0be41051", "message": "Merge pull request #2582 from seata/1.2.0\n\nrelease 1.2.0", "committedDate": "2020-04-21T04:40:55Z", "type": "commit"}, {"oid": "2e2a4247a82e76d51a56485b46c0d948a0c1ea13", "url": "https://github.com/seata/seata/commit/2e2a4247a82e76d51a56485b46c0d948a0c1ea13", "message": "release: release 1.3.0", "committedDate": "2020-07-15T16:28:39Z", "type": "commit"}, {"oid": "943c526110c2f049f962ebe4e60bdbc25595839d", "url": "https://github.com/seata/seata/commit/943c526110c2f049f962ebe4e60bdbc25595839d", "message": "fix issue #2976", "committedDate": "2020-08-24T07:13:49Z", "type": "commit"}, {"oid": "0dde7e372ba90b9974328eea2b13e539fafb6a40", "url": "https://github.com/seata/seata/commit/0dde7e372ba90b9974328eea2b13e539fafb6a40", "message": "Merge branch 'develop' into dev", "committedDate": "2020-08-24T08:09:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQzNzk5Ng==", "url": "https://github.com/seata/seata/pull/3056#discussion_r475437996", "bodyText": "If it is false, please throw exception, otherwise the problem will still exist.", "author": "wangliang181230", "createdAt": "2020-08-24T08:51:04Z", "path": "server/src/main/java/io/seata/server/session/GlobalSession.java", "diffHunk": "@@ -246,10 +246,10 @@ public void addBranch(BranchSession branchSession) throws TransactionException {\n \n     @Override\n     public void removeBranch(BranchSession branchSession) throws TransactionException {\n+        branchSession.unlock();", "originalCommit": "0dde7e372ba90b9974328eea2b13e539fafb6a40", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cec429486bed78d7737713c12efeec304f73774e", "chunk": "diff --git a/server/src/main/java/io/seata/server/session/GlobalSession.java b/server/src/main/java/io/seata/server/session/GlobalSession.java\nindex 7733e9bd7..7366a21b1 100644\n--- a/server/src/main/java/io/seata/server/session/GlobalSession.java\n+++ b/server/src/main/java/io/seata/server/session/GlobalSession.java\n\n@@ -246,7 +246,9 @@ public class GlobalSession implements SessionLifecycle, SessionStorable {\n \n     @Override\n     public void removeBranch(BranchSession branchSession) throws TransactionException {\n-        branchSession.unlock();\n+        if (!branchSession.unlock()) {\n+            throw new RuntimeException(\"Unlock branch lock failed!\");\n+        }\n         for (SessionLifecycleListener lifecycleListener : lifecycleListeners) {\n             lifecycleListener.onRemoveBranch(this, branchSession);\n         }\n"}}, {"oid": "cec429486bed78d7737713c12efeec304f73774e", "url": "https://github.com/seata/seata/commit/cec429486bed78d7737713c12efeec304f73774e", "message": "deal with the unlock failed", "committedDate": "2020-08-24T09:25:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ3OTU4Mg==", "url": "https://github.com/seata/seata/pull/3056#discussion_r475479582", "bodyText": "throw TransactionException, not RuntimeException, otherwise, some forEach will break.", "author": "wangliang181230", "createdAt": "2020-08-24T09:49:15Z", "path": "server/src/main/java/io/seata/server/session/GlobalSession.java", "diffHunk": "@@ -246,10 +246,12 @@ public void addBranch(BranchSession branchSession) throws TransactionException {\n \n     @Override\n     public void removeBranch(BranchSession branchSession) throws TransactionException {\n+        if (!branchSession.unlock()) {\n+            throw new RuntimeException(\"Unlock branch lock failed!\");", "originalCommit": "cec429486bed78d7737713c12efeec304f73774e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ4MTI5NQ==", "url": "https://github.com/seata/seata/pull/3056#discussion_r475481295", "bodyText": "done", "author": "li469791221", "createdAt": "2020-08-24T09:52:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ3OTU4Mg=="}], "type": "inlineReview", "revised_code": {"commit": "b417d35e8a41007bbf262b541bd2d008d966e9e6", "chunk": "diff --git a/server/src/main/java/io/seata/server/session/GlobalSession.java b/server/src/main/java/io/seata/server/session/GlobalSession.java\nindex 7366a21b1..30911fd15 100644\n--- a/server/src/main/java/io/seata/server/session/GlobalSession.java\n+++ b/server/src/main/java/io/seata/server/session/GlobalSession.java\n\n@@ -247,7 +247,7 @@ public class GlobalSession implements SessionLifecycle, SessionStorable {\n     @Override\n     public void removeBranch(BranchSession branchSession) throws TransactionException {\n         if (!branchSession.unlock()) {\n-            throw new RuntimeException(\"Unlock branch lock failed!\");\n+            throw new TransactionException(\"Unlock branch lock failed!\");\n         }\n         for (SessionLifecycleListener lifecycleListener : lifecycleListeners) {\n             lifecycleListener.onRemoveBranch(this, branchSession);\n"}}, {"oid": "b417d35e8a41007bbf262b541bd2d008d966e9e6", "url": "https://github.com/seata/seata/commit/b417d35e8a41007bbf262b541bd2d008d966e9e6", "message": "throw TransactionException", "committedDate": "2020-08-24T09:51:11Z", "type": "commit"}]}