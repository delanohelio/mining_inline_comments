{"pr_number": 3303, "pr_title": "feature:Support to obtain multiple configurations through a single dataid in Nacos", "pr_createdAt": "2020-11-24T04:22:50Z", "pr_url": "https://github.com/seata/seata/pull/3303", "timeline": [{"oid": "98456a68f245fed40a48062359576b1bb835a535", "url": "https://github.com/seata/seata/commit/98456a68f245fed40a48062359576b1bb835a535", "message": "\u6dfb\u52a0\u4ecenacos\u5355\u4e00dataId\u83b7\u53d6\u591a\u6761\u914d\u7f6e\u529f\u80fd\uff0cregistry.conf\u6587\u4ef6\u6dfb\u52a0config.nacos.dataId\u5c5e\u6027\u7528\u4e8e\u6307\u5b9anacos\u4e2d\u7684dataId", "committedDate": "2020-04-09T09:18:48Z", "type": "commit"}, {"oid": "9b5083e413dfb2c2f078207714a2b0c131211414", "url": "https://github.com/seata/seata/commit/9b5083e413dfb2c2f078207714a2b0c131211414", "message": "Merge branch 'develop' into develop", "committedDate": "2020-04-09T09:38:16Z", "type": "commit"}, {"oid": "7898c09047ebe5b2b81554a00cc578eeada975a0", "url": "https://github.com/seata/seata/commit/7898c09047ebe5b2b81554a00cc578eeada975a0", "message": "Merge branch 'develop' into develop", "committedDate": "2020-04-10T02:48:55Z", "type": "commit"}, {"oid": "449fe1f20a2c18588de0eddae3beb8b138b2c7b7", "url": "https://github.com/seata/seata/commit/449fe1f20a2c18588de0eddae3beb8b138b2c7b7", "message": "Merge branch 'develop' into develop", "committedDate": "2020-04-20T06:33:44Z", "type": "commit"}, {"oid": "0838750d0f103ab6c968af6452f8fb535904350e", "url": "https://github.com/seata/seata/commit/0838750d0f103ab6c968af6452f8fb535904350e", "message": "\u6dfb\u52a0\u4ecenacos\u5355\u4e00dataId\u83b7\u53d6\u591a\u6761\u914d\u7f6e\u529f\u80fd\uff0cregistry.conf\u6587\u4ef6\u6dfb\u52a0config.nacos.dataId\u5c5e\u6027\u7528\u4e8e\u6307\u5b9anacos\u4e2d\u7684dataId", "committedDate": "2020-11-20T07:40:26Z", "type": "commit"}, {"oid": "5fc4f8f5828e19e10f74e511658d0cdeede345da", "url": "https://github.com/seata/seata/commit/5fc4f8f5828e19e10f74e511658d0cdeede345da", "message": "Merge remote-tracking branch 'origin/develop' into develop\n\n# Conflicts:\n#\tconfig/seata-config-nacos/src/main/java/io/seata/config/nacos/NacosConfiguration.java", "committedDate": "2020-11-20T07:47:48Z", "type": "commit"}, {"oid": "824657f72283586b369861a1b55c5831e58aac43", "url": "https://github.com/seata/seata/commit/824657f72283586b369861a1b55c5831e58aac43", "message": "\u9002\u914d\u65b0\u7684\u914d\u7f6e\u65b9\u5f0f\u7684\u76d1\u542c\u5668\u529f\u80fd\uff0c\u5b9e\u73b0\u52a8\u6001\u914d\u7f6e", "committedDate": "2020-11-24T03:47:29Z", "type": "commit"}, {"oid": "ca1e1caa9e9529957d6c0ad7f21ec41a6d450e7e", "url": "https://github.com/seata/seata/commit/ca1e1caa9e9529957d6c0ad7f21ec41a6d450e7e", "message": "Merge branch 'develop' into develop", "committedDate": "2020-11-24T09:08:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTMyOTU4OA==", "url": "https://github.com/seata/seata/pull/3303#discussion_r529329588", "bodyText": "should it be kept configService.removeConfig(dataId, getNacosGroup());\uff1f", "author": "a364176773", "createdAt": "2020-11-24T09:16:43Z", "path": "config/seata-config-nacos/src/main/java/io/seata/config/nacos/NacosConfiguration.java", "diffHunk": "@@ -129,7 +143,8 @@ public boolean putConfigIfAbsent(String dataId, String content, long timeoutMill\n     public boolean removeConfig(String dataId, long timeoutMills) {\n         boolean result = false;\n         try {\n-            result = configService.removeConfig(dataId, getNacosGroup());\n+            seataConfig.remove(dataId);\n+            result = configService.publishConfig(getNacosDataId(), getNacosGroup(), getSeataConfigStr());", "originalCommit": "ca1e1caa9e9529957d6c0ad7f21ec41a6d450e7e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTMzOTE2Mg==", "url": "https://github.com/seata/seata/pull/3303#discussion_r529339162", "bodyText": "\u6211\u8c03\u7684\u4e0d\u662fremove\u65b9\u6cd5\uff0c\u662fpublishConfig\u65b9\u6cd5\uff0c\u662f\u628a\u5220\u9664\u7684\u914d\u7f6e\u540c\u6b65\u5230nacos\u4e0a\uff0c\u540e\u9762\u7684getSeataConfigStr()\u662f\u83b7\u53d6\u6240\u6709\u914d\u7f6e\u5b57\u7b26\u4e32\u7684\u65b9\u6cd5\u3002", "author": "Rubbernecker", "createdAt": "2020-11-24T09:24:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTMyOTU4OA=="}], "type": "inlineReview", "revised_code": {"commit": "d6e00cef37129662b5d617cef46b40005caea94e", "chunk": "diff --git a/config/seata-config-nacos/src/main/java/io/seata/config/nacos/NacosConfiguration.java b/config/seata-config-nacos/src/main/java/io/seata/config/nacos/NacosConfiguration.java\nindex 3eefdd162..c544810f2 100644\n--- a/config/seata-config-nacos/src/main/java/io/seata/config/nacos/NacosConfiguration.java\n+++ b/config/seata-config-nacos/src/main/java/io/seata/config/nacos/NacosConfiguration.java\n\n@@ -143,8 +150,12 @@ public class NacosConfiguration extends AbstractConfiguration {\n     public boolean removeConfig(String dataId, long timeoutMills) {\n         boolean result = false;\n         try {\n-            seataConfig.remove(dataId);\n-            result = configService.publishConfig(getNacosDataId(), getNacosGroup(), getSeataConfigStr());\n+            if (!seataConfig.isEmpty()) {\n+                seataConfig.remove(dataId);\n+                result = configService.publishConfig(getNacosDataId(), getNacosGroup(), getSeataConfigStr());\n+            } else {\n+                result = configService.removeConfig(dataId, getNacosGroup());\n+            }\n         } catch (NacosException exx) {\n             LOGGER.error(exx.getErrMsg());\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTMyOTk0Mg==", "url": "https://github.com/seata/seata/pull/3303#discussion_r529329942", "bodyText": "should it be kept configService.publishConfig(dataId, getNacosGroup(), content);\uff1f", "author": "a364176773", "createdAt": "2020-11-24T09:17:00Z", "path": "config/seata-config-nacos/src/main/java/io/seata/config/nacos/NacosConfiguration.java", "diffHunk": "@@ -101,19 +108,26 @@ public String getLatestConfig(String dataId, String defaultValue, long timeoutMi\n         if (value != null) {\n             return value;\n         }\n-        try {\n-            value = configService.getConfig(dataId, getNacosGroup(), timeoutMills);\n-        } catch (NacosException exx) {\n-            LOGGER.error(exx.getErrMsg());\n+\n+        value = seataConfig.getProperty(dataId);\n+\n+        if (null == value) {\n+            try {\n+                value = configService.getConfig(dataId, getNacosGroup(), timeoutMills);\n+            } catch (NacosException exx) {\n+                LOGGER.error(exx.getErrMsg());\n+            }\n         }\n+\n         return value == null ? defaultValue : value;\n     }\n \n     @Override\n     public boolean putConfig(String dataId, String content, long timeoutMills) {\n         boolean result = false;\n         try {\n-            result = configService.publishConfig(dataId, getNacosGroup(), content);\n+            seataConfig.setProperty(dataId, content);\n+            result = configService.publishConfig(getNacosDataId(), getNacosGroup(), getSeataConfigStr());", "originalCommit": "ca1e1caa9e9529957d6c0ad7f21ec41a6d450e7e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTMzOTM2Mw==", "url": "https://github.com/seata/seata/pull/3303#discussion_r529339363", "bodyText": "\u540c\u4e0a", "author": "Rubbernecker", "createdAt": "2020-11-24T09:24:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTMyOTk0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "d6e00cef37129662b5d617cef46b40005caea94e", "chunk": "diff --git a/config/seata-config-nacos/src/main/java/io/seata/config/nacos/NacosConfiguration.java b/config/seata-config-nacos/src/main/java/io/seata/config/nacos/NacosConfiguration.java\nindex 3eefdd162..c544810f2 100644\n--- a/config/seata-config-nacos/src/main/java/io/seata/config/nacos/NacosConfiguration.java\n+++ b/config/seata-config-nacos/src/main/java/io/seata/config/nacos/NacosConfiguration.java\n\n@@ -126,8 +129,12 @@ public class NacosConfiguration extends AbstractConfiguration {\n     public boolean putConfig(String dataId, String content, long timeoutMills) {\n         boolean result = false;\n         try {\n-            seataConfig.setProperty(dataId, content);\n-            result = configService.publishConfig(getNacosDataId(), getNacosGroup(), getSeataConfigStr());\n+            if (!seataConfig.isEmpty()) {\n+                seataConfig.setProperty(dataId, content);\n+                result = configService.publishConfig(getNacosDataId(), getNacosGroup(), getSeataConfigStr());\n+            } else {\n+                result = configService.publishConfig(dataId, getNacosGroup(), content);\n+            }\n         } catch (NacosException exx) {\n             LOGGER.error(exx.getErrMsg());\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTMzMTM1Ng==", "url": "https://github.com/seata/seata/pull/3303#discussion_r529331356", "bodyText": "It's a singleton", "author": "a364176773", "createdAt": "2020-11-24T09:18:10Z", "path": "config/seata-config-nacos/src/main/java/io/seata/config/nacos/NacosConfiguration.java", "diffHunk": "@@ -63,8 +68,9 @@\n     private static final Configuration FILE_CONFIG = ConfigurationFactory.CURRENT_FILE_INSTANCE;\n     private static volatile ConfigService configService;\n     private static final int MAP_INITIAL_CAPACITY = 8;\n-    private ConcurrentMap<String, ConcurrentMap<ConfigurationChangeListener, NacosListener>> configListenersMap\n-        = new ConcurrentHashMap<>(MAP_INITIAL_CAPACITY);\n+    private static ConcurrentMap<String, ConcurrentMap<ConfigurationChangeListener, NacosListener>> configListenersMap", "originalCommit": "ca1e1caa9e9529957d6c0ad7f21ec41a6d450e7e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTM0MzUzNA==", "url": "https://github.com/seata/seata/pull/3303#discussion_r529343534", "bodyText": "\u8fd9\u662f\u4e3a\u4e86\u8ba9\u4e0b\u9762\u7684\u76d1\u542c\u5668\u7684\u5185\u90e8\u7c7b\u8c03\u7528\uff0c\u4e0d\u7136\u4f20\u503c\u592a\u9ebb\u70e6\u4e86", "author": "Rubbernecker", "createdAt": "2020-11-24T09:27:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTMzMTM1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQ3OTk3OA==", "url": "https://github.com/seata/seata/pull/3303#discussion_r529479978", "bodyText": "\u90a3\u5c31static final \u4fee\u9970\u4e00\u4e0b", "author": "a364176773", "createdAt": "2020-11-24T11:38:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTMzMTM1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA3MjAwNg==", "url": "https://github.com/seata/seata/pull/3303#discussion_r530072006", "bodyText": "\u6539\u597d\u4e86", "author": "Rubbernecker", "createdAt": "2020-11-25T02:42:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTMzMTM1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "bad38c0dc00ad5b9879e3a107bb7a6ea2aa3f7f4", "chunk": "diff --git a/config/seata-config-nacos/src/main/java/io/seata/config/nacos/NacosConfiguration.java b/config/seata-config-nacos/src/main/java/io/seata/config/nacos/NacosConfiguration.java\nindex 3eefdd162..5534032e1 100644\n--- a/config/seata-config-nacos/src/main/java/io/seata/config/nacos/NacosConfiguration.java\n+++ b/config/seata-config-nacos/src/main/java/io/seata/config/nacos/NacosConfiguration.java\n\n@@ -68,9 +68,9 @@ public class NacosConfiguration extends AbstractConfiguration {\n     private static final Configuration FILE_CONFIG = ConfigurationFactory.CURRENT_FILE_INSTANCE;\n     private static volatile ConfigService configService;\n     private static final int MAP_INITIAL_CAPACITY = 8;\n-    private static ConcurrentMap<String, ConcurrentMap<ConfigurationChangeListener, NacosListener>> configListenersMap\n+    private static final ConcurrentMap<String, ConcurrentMap<ConfigurationChangeListener, NacosListener>> CONFIG_LISTENERS_MAP\n             = new ConcurrentHashMap<>(MAP_INITIAL_CAPACITY);\n-    private static Properties seataConfig;\n+    private static volatile Properties seataConfig;\n \n     /**\n      * Get instance of NacosConfiguration\n"}}, {"oid": "07e52d22e28c2af4837a3b7c134ec1a69d85b30f", "url": "https://github.com/seata/seata/commit/07e52d22e28c2af4837a3b7c134ec1a69d85b30f", "message": "checkout\u89c4\u8303", "committedDate": "2020-11-24T09:36:23Z", "type": "commit"}, {"oid": "f1469db3b7be5cedaadb4f6eca84ec2d9dcc1032", "url": "https://github.com/seata/seata/commit/f1469db3b7be5cedaadb4f6eca84ec2d9dcc1032", "message": "Merge remote-tracking branch 'origin/develop' into develop", "committedDate": "2020-11-24T09:36:42Z", "type": "commit"}, {"oid": "bad38c0dc00ad5b9879e3a107bb7a6ea2aa3f7f4", "url": "https://github.com/seata/seata/commit/bad38c0dc00ad5b9879e3a107bb7a6ea2aa3f7f4", "message": "\u4fee\u6539\u4fee\u9970\u7b26", "committedDate": "2020-11-25T02:39:32Z", "type": "commit"}, {"oid": "27b09beabc02d9d2fe25893f1213c1aef7e3794e", "url": "https://github.com/seata/seata/commit/27b09beabc02d9d2fe25893f1213c1aef7e3794e", "message": "\u6dfb\u52a0\u8bfb\u914d\u7f6e\u65f6\u7684\u7f16\u7801\u8bbe\u7f6e\u4ee5\u53ca\u89e3\u51b3\u6d41\u5173\u95ed\u95ee\u9898", "committedDate": "2020-11-25T07:52:23Z", "type": "commit"}, {"oid": "d6e00cef37129662b5d617cef46b40005caea94e", "url": "https://github.com/seata/seata/commit/d6e00cef37129662b5d617cef46b40005caea94e", "message": "\u6dfb\u52a0put\u548cremove\u65b9\u6cd5\u7684\u65e7\u7248\u672c\u517c\u5bb9", "committedDate": "2020-11-25T09:27:09Z", "type": "commit"}, {"oid": "1e71b84907a60208272e924eb6e4cc70fa9ea87a", "url": "https://github.com/seata/seata/commit/1e71b84907a60208272e924eb6e4cc70fa9ea87a", "message": "Merge branch 'develop' into develop", "committedDate": "2020-11-25T10:43:21Z", "type": "commit"}, {"oid": "de1347fde01beea5d21413ceccc75720a21723df", "url": "https://github.com/seata/seata/commit/de1347fde01beea5d21413ceccc75720a21723df", "message": "\u6dfb\u52a0consul\u65b0\u914d\u7f6e\u65b9\u5f0f", "committedDate": "2020-11-27T02:24:58Z", "type": "commit"}, {"oid": "5a27310648ae2b9e2d2e9530a15c68f2b94b8161", "url": "https://github.com/seata/seata/commit/5a27310648ae2b9e2d2e9530a15c68f2b94b8161", "message": "Merge branch 'develop' into nacosConfig", "committedDate": "2020-11-27T06:38:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY1NzkwNg==", "url": "https://github.com/seata/seata/pull/3303#discussion_r532657906", "bodyText": "dataId=\"seataServer.properties\"", "author": "a364176773", "createdAt": "2020-11-30T14:56:57Z", "path": "seata-spring-boot-starter/src/main/java/io/seata/spring/boot/autoconfigure/properties/config/ConfigNacosProperties.java", "diffHunk": "@@ -31,6 +31,7 @@\n     private String group = \"SEATA_GROUP\";\n     private String username = \"\";\n     private String password = \"\";\n+    private String dataId = \"\";", "originalCommit": "1e71b84907a60208272e924eb6e4cc70fa9ea87a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY2MTY0OA==", "url": "https://github.com/seata/seata/pull/3303#discussion_r532661648", "bodyText": "\u5df2\u7ecf\u52a0\u5230\u540e\u9762\u63d0\u7684pr\u4e0a\u4e86", "author": "Rubbernecker", "createdAt": "2020-11-30T15:01:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY1NzkwNg=="}], "type": "inlineReview", "revised_code": {"commit": "763479c81dc141c458ad516aad294f13ca004b3a", "chunk": "diff --git a/seata-spring-boot-starter/src/main/java/io/seata/spring/boot/autoconfigure/properties/config/ConfigNacosProperties.java b/seata-spring-boot-starter/src/main/java/io/seata/spring/boot/autoconfigure/properties/config/ConfigNacosProperties.java\nindex d68afb1e2..2d75286cf 100644\n--- a/seata-spring-boot-starter/src/main/java/io/seata/spring/boot/autoconfigure/properties/config/ConfigNacosProperties.java\n+++ b/seata-spring-boot-starter/src/main/java/io/seata/spring/boot/autoconfigure/properties/config/ConfigNacosProperties.java\n\n@@ -31,7 +31,7 @@ public class ConfigNacosProperties {\n     private String group = \"SEATA_GROUP\";\n     private String username = \"\";\n     private String password = \"\";\n-    private String dataId = \"\";\n+    private String dataId = \"seata.properties\";\n \n     public String getServerAddr() {\n         return serverAddr;\n"}}, {"oid": "763479c81dc141c458ad516aad294f13ca004b3a", "url": "https://github.com/seata/seata/commit/763479c81dc141c458ad516aad294f13ca004b3a", "message": "\u6dfb\u52a0dataId\u9ed8\u8ba4\u503c", "committedDate": "2020-12-10T06:23:08Z", "type": "commit"}, {"oid": "b37003fadc0f7e640f5aa9485f7774ea0d9c0b26", "url": "https://github.com/seata/seata/commit/b37003fadc0f7e640f5aa9485f7774ea0d9c0b26", "message": "Merge remote-tracking branch 'origin/develop' into develop", "committedDate": "2020-12-10T06:23:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODQ5MTcwNQ==", "url": "https://github.com/seata/seata/pull/3303#discussion_r548491705", "bodyText": "Can you keep it same?\nseata.properties\n\nor\nseataServer.properties", "author": "l81893521", "createdAt": "2020-12-24T10:54:04Z", "path": "seata-spring-boot-starter/src/main/java/io/seata/spring/boot/autoconfigure/properties/config/ConfigNacosProperties.java", "diffHunk": "@@ -31,6 +31,7 @@\n     private String group = \"SEATA_GROUP\";\n     private String username = \"\";\n     private String password = \"\";\n+    private String dataId = \"seata.properties\";", "originalCommit": "b37003fadc0f7e640f5aa9485f7774ea0d9c0b26", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODQ5MjcxNQ==", "url": "https://github.com/seata/seata/pull/3303#discussion_r548492715", "bodyText": "\u9ed8\u8ba4\u503c\u90fd\u662fseata.properties", "author": "Rubbernecker", "createdAt": "2020-12-24T10:57:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODQ5MTcwNQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "9e7f2c7669a094e1715a79b39bc7344f83cebab4", "url": "https://github.com/seata/seata/commit/9e7f2c7669a094e1715a79b39bc7344f83cebab4", "message": "Merge pull request #2 from seata/develop\n\n\u5408\u5e76\u6700\u65b0\u4ee3\u7801", "committedDate": "2020-12-25T03:30:47Z", "type": "commit"}, {"oid": "4a38ec4a44f4e1b24049dcab17496a57a3b3d2f3", "url": "https://github.com/seata/seata/commit/4a38ec4a44f4e1b24049dcab17496a57a3b3d2f3", "message": "\u6dfb\u52a0\u4fee\u6539\u4fe1\u606f", "committedDate": "2020-12-25T03:34:57Z", "type": "commit"}, {"oid": "cbda27b2e629b875411e12d50bb105abafb24629", "url": "https://github.com/seata/seata/commit/cbda27b2e629b875411e12d50bb105abafb24629", "message": "Merge branch 'nacosConfig' into develop", "committedDate": "2020-12-25T03:45:08Z", "type": "commit"}, {"oid": "f080e86b9b9e164390897aaefc55a90980128a10", "url": "https://github.com/seata/seata/commit/f080e86b9b9e164390897aaefc55a90980128a10", "message": "\u56de\u9000consul\u4fee\u6539", "committedDate": "2020-12-25T03:57:48Z", "type": "commit"}, {"oid": "03d9274de911c8dda2960cce57b04b5cdcfdead9", "url": "https://github.com/seata/seata/commit/03d9274de911c8dda2960cce57b04b5cdcfdead9", "message": "\u56de\u9000consul\u4fee\u6539", "committedDate": "2020-12-25T04:32:16Z", "type": "commit"}, {"oid": "134feb0463c2f41c8454548b7304648c76d2ac7b", "url": "https://github.com/seata/seata/commit/134feb0463c2f41c8454548b7304648c76d2ac7b", "message": "\u6dfb\u52a0\u4fee\u6539\u4fe1\u606f", "committedDate": "2020-12-25T04:40:06Z", "type": "commit"}]}