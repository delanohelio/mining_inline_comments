{"pr_number": 3076, "pr_title": "feature: Check lock in TC when use @GlobalLock", "pr_createdAt": "2020-09-01T07:03:38Z", "pr_url": "https://github.com/seata/seata/pull/3076", "timeline": [{"oid": "d9c608e0d5e6644b5f9a3bad0fedcc6248fe56f4", "url": "https://github.com/seata/seata/commit/d9c608e0d5e6644b5f9a3bad0fedcc6248fe56f4", "message": "optimize: 1. check global lock when use @GlobalLock Independently.\n2. Check global lock retry when conflict.", "committedDate": "2020-09-01T06:14:39Z", "type": "commit"}, {"oid": "a9c129d4797550f6b956f7edcdf77b8f1a69e853", "url": "https://github.com/seata/seata/commit/a9c129d4797550f6b956f7edcdf77b8f1a69e853", "message": "optimize code", "committedDate": "2020-09-01T07:28:34Z", "type": "commit"}, {"oid": "6c2212d89efcfc9757df3a2b4b47f0b0f6b4e475", "url": "https://github.com/seata/seata/commit/6c2212d89efcfc9757df3a2b4b47f0b0f6b4e475", "message": "Merge branch 'develop' into feature-check-lock-GlobalLock", "committedDate": "2020-09-01T09:18:35Z", "type": "commit"}, {"oid": "d57d1b6860e55e38ce10592c2b63047600201118", "url": "https://github.com/seata/seata/commit/d57d1b6860e55e38ce10592c2b63047600201118", "message": "Merge branch 'develop' into feature-check-lock-GlobalLock", "committedDate": "2020-09-03T13:05:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjI0MDEzMA==", "url": "https://github.com/seata/seata/pull/3076#discussion_r486240130", "bodyText": "it's not consistent with the previous meaning", "author": "slievrly", "createdAt": "2020-09-10T10:43:00Z", "path": "rm-datasource/src/main/java/io/seata/rm/datasource/exec/SelectForUpdateExecutor.java", "diffHunk": "@@ -113,7 +111,13 @@ public T doExecute(Object... args) throws Throwable {\n                     } else {\n                         conn.rollback();\n                     }\n-                    lockRetryController.sleep(lce);\n+\n+                    // retry hear only when the config is true\n+                    if (LockRetryPolicy.isLockRetryPolicyBranchRollbackOnConflict()) {", "originalCommit": "d57d1b6860e55e38ce10592c2b63047600201118", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ4MTIwNg==", "url": "https://github.com/seata/seata/pull/3076#discussion_r487481206", "bodyText": "change", "author": "caohdgege", "createdAt": "2020-09-13T04:52:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjI0MDEzMA=="}], "type": "inlineReview", "revised_code": {"commit": "485ca9c2f3d8f0ea48a907f4e1a7db711f2d8ef3", "chunk": "diff --git a/rm-datasource/src/main/java/io/seata/rm/datasource/exec/SelectForUpdateExecutor.java b/rm-datasource/src/main/java/io/seata/rm/datasource/exec/SelectForUpdateExecutor.java\nindex f16085af4e..ea5ec9307c 100644\n--- a/rm-datasource/src/main/java/io/seata/rm/datasource/exec/SelectForUpdateExecutor.java\n+++ b/rm-datasource/src/main/java/io/seata/rm/datasource/exec/SelectForUpdateExecutor.java\n\n@@ -111,13 +111,8 @@ public class SelectForUpdateExecutor<T, S extends Statement> extends BaseTransac\n                     } else {\n                         conn.rollback();\n                     }\n-\n-                    // retry hear only when the config is true\n-                    if (LockRetryPolicy.isLockRetryPolicyBranchRollbackOnConflict()) {\n-                        lockRetryController.sleep(lce);\n-                    } else {\n-                        throw new LockWaitTimeoutException(\"Global lock wait timeout\", lce);\n-                    }\n+                    // trigger retry\n+                    lockRetryController.sleep(lce);\n                 }\n             }\n         } finally {\n"}}, {"oid": "485ca9c2f3d8f0ea48a907f4e1a7db711f2d8ef3", "url": "https://github.com/seata/seata/commit/485ca9c2f3d8f0ea48a907f4e1a7db711f2d8ef3", "message": "retry", "committedDate": "2020-09-13T04:13:06Z", "type": "commit"}, {"oid": "8ced5038437960b45f03886daa6c39d21c78fca9", "url": "https://github.com/seata/seata/commit/8ced5038437960b45f03886daa6c39d21c78fca9", "message": "Merge remote-tracking branch 'origin/feature-check-lock-GlobalLock' into feature-check-lock-GlobalLock", "committedDate": "2020-09-13T04:50:13Z", "type": "commit"}, {"oid": "c8b149fd01fab76b1b3ae57fa2ca0681caeb7fbc", "url": "https://github.com/seata/seata/commit/c8b149fd01fab76b1b3ae57fa2ca0681caeb7fbc", "message": "Merge branch 'develop' into feature-check-lock-GlobalLock", "committedDate": "2020-09-14T15:19:48Z", "type": "commit"}, {"oid": "d2e17a7509a32bcf5fb49fa04ed4c5784a0a2a9d", "url": "https://github.com/seata/seata/commit/d2e17a7509a32bcf5fb49fa04ed4c5784a0a2a9d", "message": "Merge branch 'develop' into feature-check-lock-GlobalLock", "committedDate": "2020-09-18T10:13:51Z", "type": "commit"}, {"oid": "c4afe444ddd9aa2b5d73d5bb0298589f549dbdc4", "url": "https://github.com/seata/seata/commit/c4afe444ddd9aa2b5d73d5bb0298589f549dbdc4", "message": "Merge branch 'develop' into feature-check-lock-GlobalLock", "committedDate": "2020-09-28T09:33:58Z", "type": "commit"}, {"oid": "793bb2b7e6ac54905bace1b771ccfdd36a649ab2", "url": "https://github.com/seata/seata/commit/793bb2b7e6ac54905bace1b771ccfdd36a649ab2", "message": "Merge branch 'develop' into feature-check-lock-GlobalLock\n\n# Conflicts:\n#\trm-datasource/src/main/java/io/seata/rm/datasource/exec/AbstractDMLBaseExecutor.java", "committedDate": "2020-10-13T14:00:55Z", "type": "commit"}, {"oid": "b4af642fc46ec84554556b8e6e3c295d926eb7a2", "url": "https://github.com/seata/seata/commit/b4af642fc46ec84554556b8e6e3c295d926eb7a2", "message": "solve the conflict and modify code", "committedDate": "2020-10-13T14:02:43Z", "type": "commit"}, {"oid": "5ca5ef6e420b81e96f5de7bfa8f19dc99e60be2d", "url": "https://github.com/seata/seata/commit/5ca5ef6e420b81e96f5de7bfa8f19dc99e60be2d", "message": "Merge remote-tracking branch 'origin/feature-check-lock-GlobalLock' into feature-check-lock-GlobalLock", "committedDate": "2020-10-13T14:03:32Z", "type": "commit"}, {"oid": "b6a42c92049253845d8da056c8e3c288bd6b0e23", "url": "https://github.com/seata/seata/commit/b6a42c92049253845d8da056c8e3c288bd6b0e23", "message": "Merge branch 'develop' into feature-check-lock-GlobalLock", "committedDate": "2020-10-21T06:39:01Z", "type": "commit"}, {"oid": "9508ede9d1fb954ecd2267019e6f548fff0d4f7f", "url": "https://github.com/seata/seata/commit/9508ede9d1fb954ecd2267019e6f548fff0d4f7f", "message": "Merge branch 'develop' into feature-check-lock-GlobalLock", "committedDate": "2020-10-22T09:25:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTM4MjEwMg==", "url": "https://github.com/seata/seata/pull/3076#discussion_r511382102", "bodyText": "Is it better to comment the code like \"Do the same thing under either @GlobalTransactional or @GlobalLock, that only check the global lock here.\" or something else more accurate? There is nothing about \u201ckey appending\u201d in the new code block, so the comment could be a little puzzling.", "author": "ggndnn", "createdAt": "2020-10-24T10:23:37Z", "path": "rm-datasource/src/main/java/io/seata/rm/datasource/exec/SelectForUpdateExecutor.java", "diffHunk": "@@ -96,13 +96,11 @@ public T doExecute(Object... args) throws Throwable {\n                         break;\n                     }\n \n-                    if (RootContext.inGlobalTransaction()) {\n-                        //do as usual\n+                    if (RootContext.inGlobalTransaction() || RootContext.requireGlobalLock()) {\n+                        // do as usual\n+                        // in @GlobalLock env, don't need to append key eithor,\n+                        // but check lock hear, do the same thing as @GlobalTransactional env", "originalCommit": "9508ede9d1fb954ecd2267019e6f548fff0d4f7f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "da7a75f1ec39e7758626b6c6bed603be40b8af12", "chunk": "diff --git a/rm-datasource/src/main/java/io/seata/rm/datasource/exec/SelectForUpdateExecutor.java b/rm-datasource/src/main/java/io/seata/rm/datasource/exec/SelectForUpdateExecutor.java\nindex 8db6879c77..844fc42970 100644\n--- a/rm-datasource/src/main/java/io/seata/rm/datasource/exec/SelectForUpdateExecutor.java\n+++ b/rm-datasource/src/main/java/io/seata/rm/datasource/exec/SelectForUpdateExecutor.java\n\n@@ -97,9 +97,8 @@ public class SelectForUpdateExecutor<T, S extends Statement> extends BaseTransac\n                     }\n \n                     if (RootContext.inGlobalTransaction() || RootContext.requireGlobalLock()) {\n-                        // do as usual\n-                        // in @GlobalLock env, don't need to append key eithor,\n-                        // but check lock hear, do the same thing as @GlobalTransactional env\n+                        // Do the same thing under either @GlobalTransactional or @GlobalLock, \n+                        // that only check the global lock here.\n                         statementProxy.getConnectionProxy().checkLock(lockKeys);\n                     } else {\n                         throw new RuntimeException(\"Unknown situation!\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTM4Mjk5OQ==", "url": "https://github.com/seata/seata/pull/3076#discussion_r511382999", "bodyText": "What's this line deleting for? Is it necessary?", "author": "ggndnn", "createdAt": "2020-10-24T10:25:47Z", "path": "rm-datasource/src/main/java/io/seata/rm/datasource/exec/BaseTransactionalExecutor.java", "diffHunk": "@@ -407,5 +407,4 @@ protected TableRecords buildTableRecords(Map<String, List<Object>> pkValuesMap)\n     protected String getDbType() {\n         return statementProxy.getConnectionProxy().getDbType();\n     }\n-", "originalCommit": "9508ede9d1fb954ecd2267019e6f548fff0d4f7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQxMDc1OQ==", "url": "https://github.com/seata/seata/pull/3076#discussion_r511410759", "bodyText": "\u7a7a\u767d\u884c\uff0c\u5e94\u8be5\u662f\u4e4b\u524d\u505a\u4ee3\u7801\u53d8\u66f4\u7684\u65f6\u5019\u4e0d\u5c0f\u5fc3\u5220\u7684", "author": "caohdgege", "createdAt": "2020-10-24T11:36:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTM4Mjk5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ2NjI0NA==", "url": "https://github.com/seata/seata/pull/3076#discussion_r511466244", "bodyText": "Can you revert this modification?", "author": "ggndnn", "createdAt": "2020-10-24T14:07:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTM4Mjk5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ3ODMyMw==", "url": "https://github.com/seata/seata/pull/3076#discussion_r511478323", "bodyText": "ok", "author": "caohdgege", "createdAt": "2020-10-24T14:58:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTM4Mjk5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "7c7ae29c85eb90b63007c7f1e09ff664a29fffa3", "chunk": "diff --git a/rm-datasource/src/main/java/io/seata/rm/datasource/exec/BaseTransactionalExecutor.java b/rm-datasource/src/main/java/io/seata/rm/datasource/exec/BaseTransactionalExecutor.java\nindex ad9c992cba..ef22dd584f 100644\n--- a/rm-datasource/src/main/java/io/seata/rm/datasource/exec/BaseTransactionalExecutor.java\n+++ b/rm-datasource/src/main/java/io/seata/rm/datasource/exec/BaseTransactionalExecutor.java\n\n@@ -407,4 +407,5 @@ public abstract class BaseTransactionalExecutor<T, S extends Statement> implemen\n     protected String getDbType() {\n         return statementProxy.getConnectionProxy().getDbType();\n     }\n+\n }\n"}}, {"oid": "da7a75f1ec39e7758626b6c6bed603be40b8af12", "url": "https://github.com/seata/seata/commit/da7a75f1ec39e7758626b6c6bed603be40b8af12", "message": "modify note", "committedDate": "2020-10-24T11:25:58Z", "type": "commit"}, {"oid": "1dac24dfb28f19442847c3d776fa9c3d6a440175", "url": "https://github.com/seata/seata/commit/1dac24dfb28f19442847c3d776fa9c3d6a440175", "message": "optimize: notes", "committedDate": "2020-10-24T11:32:00Z", "type": "commit"}, {"oid": "7c7ae29c85eb90b63007c7f1e09ff664a29fffa3", "url": "https://github.com/seata/seata/commit/7c7ae29c85eb90b63007c7f1e09ff664a29fffa3", "message": "add empty line", "committedDate": "2020-10-24T14:57:30Z", "type": "commit"}, {"oid": "698488e1913f3ba727a2826a68a1b21c9f2cf591", "url": "https://github.com/seata/seata/commit/698488e1913f3ba727a2826a68a1b21c9f2cf591", "message": "Merge branch 'develop' into feature-check-lock-GlobalLock", "committedDate": "2020-10-25T03:00:04Z", "type": "commit"}]}