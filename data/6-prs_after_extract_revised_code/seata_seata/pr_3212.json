{"pr_number": 3212, "pr_title": "optimize: optimize recognize sql in limit and order by ", "pr_createdAt": "2020-10-22T10:31:53Z", "pr_url": "https://github.com/seata/seata/pull/3212", "timeline": [{"oid": "b2231f320866d4ae94b297812032472baef875df", "url": "https://github.com/seata/seata/commit/b2231f320866d4ae94b297812032472baef875df", "message": "optimize limit and order by", "committedDate": "2020-10-22T10:24:55Z", "type": "commit"}, {"oid": "03de5ec905e914bf9e8a26347dfaf7e15eb30235", "url": "https://github.com/seata/seata/commit/03de5ec905e914bf9e8a26347dfaf7e15eb30235", "message": "Merge branch 'develop' into optimize_limit_order_by_sql", "committedDate": "2020-10-22T12:47:51Z", "type": "commit"}, {"oid": "38921e340a99936dd80ff602711794f69f5faa09", "url": "https://github.com/seata/seata/commit/38921e340a99936dd80ff602711794f69f5faa09", "message": "remove unused import", "committedDate": "2020-10-23T01:23:02Z", "type": "commit"}, {"oid": "162a35c6729b05bf40a14dc1539ebb9f6114eac8", "url": "https://github.com/seata/seata/commit/162a35c6729b05bf40a14dc1539ebb9f6114eac8", "message": "Merge remote-tracking branch 'me/optimize_limit_order_by_sql' into optimize_limit_order_by_sql", "committedDate": "2020-10-23T01:23:26Z", "type": "commit"}, {"oid": "f2efe77e6fbe8b0bd1e6fb4596f2e0f3a8fffd03", "url": "https://github.com/seata/seata/commit/f2efe77e6fbe8b0bd1e6fb4596f2e0f3a8fffd03", "message": "remove unused import", "committedDate": "2020-10-23T01:26:26Z", "type": "commit"}, {"oid": "3587f4b64ff5971806d4d950b6e382d6810c3e59", "url": "https://github.com/seata/seata/commit/3587f4b64ff5971806d4d950b6e382d6810c3e59", "message": "fix can not execute limit", "committedDate": "2020-10-23T01:38:54Z", "type": "commit"}, {"oid": "0f394fd86279ce8369f964312a9beec6dae7958e", "url": "https://github.com/seata/seata/commit/0f394fd86279ce8369f964312a9beec6dae7958e", "message": "fix ci", "committedDate": "2020-10-23T02:56:48Z", "type": "commit"}, {"oid": "fcc46334165d2e8672db9b98af15b1627a10196e", "url": "https://github.com/seata/seata/commit/fcc46334165d2e8672db9b98af15b1627a10196e", "message": "Merge branch 'develop' into optimize_limit_order_by_sql", "committedDate": "2020-10-23T05:27:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTMzMDYwMQ==", "url": "https://github.com/seata/seata/pull/3212#discussion_r511330601", "bodyText": "\u4e0d\u662f PGOutputVisitor \u5417\uff1f", "author": "caohdgege", "createdAt": "2020-10-24T07:08:24Z", "path": "sqlparser/seata-sqlparser-druid/src/main/java/io/seata/sqlparser/druid/postgresql/BasePostgresqlRecognizer.java", "diffHunk": "@@ -82,4 +85,26 @@ public String getWhereCondition(SQLExpr where) {\n         executeVisit(where, new PGOutputVisitor(sb));\n         return sb.toString();\n     }\n+\n+    protected String getLimitCondition(SQLLimit sqlLimit) {\n+        if (Objects.isNull(sqlLimit)) {\n+            return StringUtils.EMPTY;\n+        }\n+\n+        StringBuilder sb = new StringBuilder();\n+        executeLimit(sqlLimit, new MySqlOutputVisitor(sb));\n+\n+        return sb.toString();\n+    }\n+\n+    protected String getOrderByCondition(SQLOrderBy sqlOrderBy) {\n+        if (Objects.isNull(sqlOrderBy)) {\n+            return StringUtils.EMPTY;\n+        }\n+\n+        StringBuilder sb = new StringBuilder();\n+        executeOrderBy(sqlOrderBy, new MySqlOutputVisitor(sb));", "originalCommit": "fcc46334165d2e8672db9b98af15b1627a10196e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDk0NTM5Mg==", "url": "https://github.com/seata/seata/pull/3212#discussion_r554945392", "bodyText": "fixed", "author": "l81893521", "createdAt": "2021-01-11T10:22:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTMzMDYwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "dc3b60e773346c9e0627783ca0af33ed75d4000a", "chunk": "diff --git a/sqlparser/seata-sqlparser-druid/src/main/java/io/seata/sqlparser/druid/postgresql/BasePostgresqlRecognizer.java b/sqlparser/seata-sqlparser-druid/src/main/java/io/seata/sqlparser/druid/postgresql/BasePostgresqlRecognizer.java\nindex c98b372d31..f8fc8e3a13 100644\n--- a/sqlparser/seata-sqlparser-druid/src/main/java/io/seata/sqlparser/druid/postgresql/BasePostgresqlRecognizer.java\n+++ b/sqlparser/seata-sqlparser-druid/src/main/java/io/seata/sqlparser/druid/postgresql/BasePostgresqlRecognizer.java\n\n@@ -92,19 +92,42 @@ public abstract class BasePostgresqlRecognizer extends BaseRecognizer {\n         }\n \n         StringBuilder sb = new StringBuilder();\n-        executeLimit(sqlLimit, new MySqlOutputVisitor(sb));\n+        executeLimit(sqlLimit, new PGOutputVisitor(sb));\n \n         return sb.toString();\n     }\n \n+    protected String getLimitCondition(SQLLimit sqlLimit, final ParametersHolder parametersHolder,\n+                                       final ArrayList<List<Object>> paramAppenderList) {\n+        if (Objects.isNull(sqlLimit)) {\n+            return StringUtils.EMPTY;\n+        }\n+\n+        StringBuilder sb = new StringBuilder();\n+\n+        executeLimit(sqlLimit, createOutputVisitor(parametersHolder, paramAppenderList, sb));\n+        return sb.toString();\n+    }\n+\n     protected String getOrderByCondition(SQLOrderBy sqlOrderBy) {\n         if (Objects.isNull(sqlOrderBy)) {\n             return StringUtils.EMPTY;\n         }\n \n         StringBuilder sb = new StringBuilder();\n-        executeOrderBy(sqlOrderBy, new MySqlOutputVisitor(sb));\n+        executeOrderBy(sqlOrderBy, new PGOutputVisitor(sb));\n \n         return sb.toString();\n     }\n+\n+    protected String getOrderByCondition(SQLOrderBy sqlOrderBy, final ParametersHolder parametersHolder,\n+                                         final ArrayList<List<Object>> paramAppenderList) {\n+        if (Objects.isNull(sqlOrderBy)) {\n+            return StringUtils.EMPTY;\n+        }\n+\n+        StringBuilder sb = new StringBuilder();\n+        executeOrderBy(sqlOrderBy, createOutputVisitor(parametersHolder, paramAppenderList, sb));\n+        return sb.toString();\n+    }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjY3MjMxMQ==", "url": "https://github.com/seata/seata/pull/3212#discussion_r516672311", "bodyText": "\u8fd9\u91cc\u9700\u8981\u5224\u65ad\u662f\u5426\u5305\u542b\u5360\u4f4d\u7b26\uff0c\u5982\u679c\u6709\u7684\u8bdd\uff0c\u9700\u8981\u628a\u5bf9\u5e94\u7684\u503c\u52a0\u5165\u5230paramAppenderList\u91cc\u9762", "author": "caohdgege", "createdAt": "2020-11-03T13:40:11Z", "path": "sqlparser/seata-sqlparser-druid/src/main/java/io/seata/sqlparser/druid/mysql/MySQLDeleteRecognizer.java", "diffHunk": "@@ -94,13 +96,15 @@ public String getWhereCondition() {\n     }\n \n     @Override\n-    public String getLimit() {\n-        return super.getLimit(ast, getSQLType());\n+    public String getLimitCondition() {\n+        SQLLimit limit = ast.getLimit();\n+        return super.getLimitCondition(limit);", "originalCommit": "fcc46334165d2e8672db9b98af15b1627a10196e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE4MzI4Nw==", "url": "https://github.com/seata/seata/pull/3212#discussion_r547183287", "bodyText": "+1", "author": "a364176773", "createdAt": "2020-12-22T10:02:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjY3MjMxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDk0NTI3NQ==", "url": "https://github.com/seata/seata/pull/3212#discussion_r554945275", "bodyText": "fixed", "author": "l81893521", "createdAt": "2021-01-11T10:22:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjY3MjMxMQ=="}], "type": "inlineReview", "revised_code": {"commit": "dc3b60e773346c9e0627783ca0af33ed75d4000a", "chunk": "diff --git a/sqlparser/seata-sqlparser-druid/src/main/java/io/seata/sqlparser/druid/mysql/MySQLDeleteRecognizer.java b/sqlparser/seata-sqlparser-druid/src/main/java/io/seata/sqlparser/druid/mysql/MySQLDeleteRecognizer.java\nindex a3d19b370e..2905797ab4 100644\n--- a/sqlparser/seata-sqlparser-druid/src/main/java/io/seata/sqlparser/druid/mysql/MySQLDeleteRecognizer.java\n+++ b/sqlparser/seata-sqlparser-druid/src/main/java/io/seata/sqlparser/druid/mysql/MySQLDeleteRecognizer.java\n\n@@ -101,10 +101,22 @@ public class MySQLDeleteRecognizer extends BaseMySQLRecognizer implements SQLDel\n         return super.getLimitCondition(limit);\n     }\n \n+    @Override\n+    public String getLimitCondition(ParametersHolder parametersHolder, ArrayList<List<Object>> paramAppenderList) {\n+        SQLLimit limit = ast.getLimit();\n+        return super.getLimitCondition(limit, parametersHolder, paramAppenderList);\n+    }\n+\n     @Override\n     public String getOrderByCondition() {\n         SQLOrderBy sqlOrderBy = ast.getOrderBy();\n         return super.getOrderByCondition(sqlOrderBy);\n     }\n \n+    @Override\n+    public String getOrderByCondition(ParametersHolder parametersHolder, ArrayList<List<Object>> paramAppenderList) {\n+        SQLOrderBy sqlOrderBy = ast.getOrderBy();\n+        return super.getOrderByCondition(sqlOrderBy, parametersHolder, paramAppenderList);\n+    }\n+\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE4MjQyMQ==", "url": "https://github.com/seata/seata/pull/3212#discussion_r547182421", "bodyText": "\u201c \u201d you can set it to a constant, right?", "author": "a364176773", "createdAt": "2020-12-22T10:00:25Z", "path": "rm-datasource/src/main/java/io/seata/rm/datasource/exec/UpdateExecutor.java", "diffHunk": "@@ -81,13 +81,13 @@ private String buildBeforeImageSQL(TableMeta tableMeta, ArrayList<List<Object>>\n         if (StringUtils.isNotBlank(whereCondition)) {\n             suffix.append(WHERE).append(whereCondition);\n         }\n-        String orderBy = recognizer.getOrderBy();\n+        String orderBy = recognizer.getOrderByCondition();\n         if (StringUtils.isNotBlank(orderBy)) {\n-            suffix.append(orderBy);\n+            suffix.append(\" \").append(orderBy);", "originalCommit": "fcc46334165d2e8672db9b98af15b1627a10196e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c08ce62ce7fe0b1676f087ab5d60de9ec4854746", "chunk": "diff --git a/rm-datasource/src/main/java/io/seata/rm/datasource/exec/UpdateExecutor.java b/rm-datasource/src/main/java/io/seata/rm/datasource/exec/UpdateExecutor.java\nindex 5fd28571f7..d806485b2f 100644\n--- a/rm-datasource/src/main/java/io/seata/rm/datasource/exec/UpdateExecutor.java\n+++ b/rm-datasource/src/main/java/io/seata/rm/datasource/exec/UpdateExecutor.java\n\n@@ -74,7 +74,6 @@ public class UpdateExecutor<T, S extends Statement> extends AbstractDMLBaseExecu\n     private String buildBeforeImageSQL(TableMeta tableMeta, ArrayList<List<Object>> paramAppenderList) {\n         SQLUpdateRecognizer recognizer = (SQLUpdateRecognizer) sqlRecognizer;\n         List<String> updateColumns = recognizer.getUpdateColumns();\n-        assertContainsPKColumnName(updateColumns);\n         StringBuilder prefix = new StringBuilder(\"SELECT \");\n         StringBuilder suffix = new StringBuilder(\" FROM \").append(getFromTableInSQL());\n         String whereCondition = buildWhereCondition(recognizer, paramAppenderList);\n"}}, {"oid": "c08ce62ce7fe0b1676f087ab5d60de9ec4854746", "url": "https://github.com/seata/seata/commit/c08ce62ce7fe0b1676f087ab5d60de9ec4854746", "message": "Merge remote-tracking branch 'origin/develop' into optimize_limit_order_by_sql\n\n# Conflicts:\n#\trm-datasource/src/main/java/io/seata/rm/datasource/exec/DeleteExecutor.java\n#\trm-datasource/src/main/java/io/seata/rm/datasource/exec/UpdateExecutor.java\n#\tsqlparser/seata-sqlparser-core/src/main/java/io/seata/sqlparser/WhereRecognizer.java\n#\tsqlparser/seata-sqlparser-druid/src/main/java/io/seata/sqlparser/druid/mysql/BaseMySQLRecognizer.java\n#\tsqlparser/seata-sqlparser-druid/src/main/java/io/seata/sqlparser/druid/mysql/MySQLDeleteRecognizer.java\n#\tsqlparser/seata-sqlparser-druid/src/main/java/io/seata/sqlparser/druid/mysql/MySQLUpdateRecognizer.java\n#\tsqlparser/seata-sqlparser-druid/src/test/java/io/seata/sqlparser/druid/MySQLDeleteRecognizerTest.java", "committedDate": "2021-01-08T08:05:34Z", "type": "commit"}, {"oid": "dc3b60e773346c9e0627783ca0af33ed75d4000a", "url": "https://github.com/seata/seata/commit/dc3b60e773346c9e0627783ca0af33ed75d4000a", "message": "fix conflict", "committedDate": "2021-01-11T10:13:42Z", "type": "commit"}, {"oid": "fc07962969a44504c8a394a7e52033e083ffccda", "url": "https://github.com/seata/seata/commit/fc07962969a44504c8a394a7e52033e083ffccda", "message": "Merge remote-tracking branch 'me/optimize_limit_order_by_sql' into optimize_limit_order_by_sql", "committedDate": "2021-01-11T10:15:43Z", "type": "commit"}, {"oid": "71a4be42cb540ebce1207a8df6ca72716b0f3fe2", "url": "https://github.com/seata/seata/commit/71a4be42cb540ebce1207a8df6ca72716b0f3fe2", "message": "Merge remote-tracking branch 'origin/develop' into optimize_limit_order_by_sql\n\n# Conflicts:\n#\tchanges/1.5.0.md\n#\tchanges/en-us/1.5.0.md", "committedDate": "2021-01-11T10:19:30Z", "type": "commit"}, {"oid": "dcf65111f08ea953cb2837e47c11a637b7bce7ae", "url": "https://github.com/seata/seata/commit/dcf65111f08ea953cb2837e47c11a637b7bce7ae", "message": "remove unused import", "committedDate": "2021-01-11T10:25:58Z", "type": "commit"}, {"oid": "ae823e780d10f7b296a7f559a745b81cbdafa724", "url": "https://github.com/seata/seata/commit/ae823e780d10f7b296a7f559a745b81cbdafa724", "message": "remove unused import", "committedDate": "2021-01-11T10:44:12Z", "type": "commit"}, {"oid": "7935c58df0a7eff948aedda39495ebd4bac339d3", "url": "https://github.com/seata/seata/commit/7935c58df0a7eff948aedda39495ebd4bac339d3", "message": "update changes", "committedDate": "2021-01-12T06:14:07Z", "type": "commit"}, {"oid": "caa0437384bf9132e50989fdb4475a2005577bb2", "url": "https://github.com/seata/seata/commit/caa0437384bf9132e50989fdb4475a2005577bb2", "message": "update changes", "committedDate": "2021-01-13T03:25:36Z", "type": "commit"}, {"oid": "40c261166e4aa9de20b5293852882c1a61311ea6", "url": "https://github.com/seata/seata/commit/40c261166e4aa9de20b5293852882c1a61311ea6", "message": "Merge remote-tracking branch 'me/optimize_limit_order_by_sql' into optimize_limit_order_by_sql\n\n# Conflicts:\n#\tchanges/1.5.0.md\n#\tchanges/en-us/1.5.0.md", "committedDate": "2021-01-13T03:27:03Z", "type": "commit"}, {"oid": "3988f8082749c57878749c23bbd126ec7876149d", "url": "https://github.com/seata/seata/commit/3988f8082749c57878749c23bbd126ec7876149d", "message": "update changes", "committedDate": "2021-01-14T06:51:23Z", "type": "commit"}, {"oid": "ab728f4a7f48d808979ea63a8e80bccc50778ab9", "url": "https://github.com/seata/seata/commit/ab728f4a7f48d808979ea63a8e80bccc50778ab9", "message": "Merge remote-tracking branch 'origin/develop' into optimize_limit_order_by_sql\n\n# Conflicts:\n#\tchanges/1.5.0.md\n#\tchanges/en-us/1.5.0.md", "committedDate": "2021-02-06T09:26:34Z", "type": "commit"}, {"oid": "aeba42ffa4c2d02d509560fafe5c5bc32f8f7a3a", "url": "https://github.com/seata/seata/commit/aeba42ffa4c2d02d509560fafe5c5bc32f8f7a3a", "message": "update changes", "committedDate": "2021-02-06T09:34:34Z", "type": "commit"}, {"oid": "98dac0ab2c217a7461665db50d2e921fae83d159", "url": "https://github.com/seata/seata/commit/98dac0ab2c217a7461665db50d2e921fae83d159", "message": "Merge remote-tracking branch 'origin/develop' into optimize_limit_order_by_sql\n\n# Conflicts:\n#\tchanges/en-us/1.5.0.md", "committedDate": "2021-02-20T09:55:03Z", "type": "commit"}, {"oid": "3b5c050442ef9df02a9fbec032ce1b94025db492", "url": "https://github.com/seata/seata/commit/3b5c050442ef9df02a9fbec032ce1b94025db492", "message": "update changes", "committedDate": "2021-02-20T10:06:30Z", "type": "commit"}, {"oid": "b3d14a7f5dddff8c4af9478b5ff5762ba70dadd0", "url": "https://github.com/seata/seata/commit/b3d14a7f5dddff8c4af9478b5ff5762ba70dadd0", "message": "update changes", "committedDate": "2021-02-20T10:07:45Z", "type": "commit"}, {"oid": "be06bc0cef5c9dd5e50dba649e5bfc21321f5ee9", "url": "https://github.com/seata/seata/commit/be06bc0cef5c9dd5e50dba649e5bfc21321f5ee9", "message": "Merge remote-tracking branch 'origin/develop' into optimize_limit_order_by_sql\n\n# Conflicts:\n#\tchanges/1.5.0.md\n#\tchanges/en-us/1.5.0.md", "committedDate": "2021-02-23T10:11:09Z", "type": "commit"}, {"oid": "b0ed17196fe914c7fd087babffe2cca4b9bdbc44", "url": "https://github.com/seata/seata/commit/b0ed17196fe914c7fd087babffe2cca4b9bdbc44", "message": "update changes", "committedDate": "2021-02-23T10:17:33Z", "type": "commit"}, {"oid": "1796df90f3e64efead4daa513b66dd1e07d41d3a", "url": "https://github.com/seata/seata/commit/1796df90f3e64efead4daa513b66dd1e07d41d3a", "message": "Merge remote-tracking branch 'origin/develop' into optimize_limit_order_by_sql", "committedDate": "2021-03-05T02:12:21Z", "type": "commit"}, {"oid": "1f32fd70df8a75e1414e6cfc4328b455fddf3acc", "url": "https://github.com/seata/seata/commit/1f32fd70df8a75e1414e6cfc4328b455fddf3acc", "message": "update changes", "committedDate": "2021-03-05T02:17:13Z", "type": "commit"}, {"oid": "ae1b5c51361e01288113e3f7fbed31e00556abc1", "url": "https://github.com/seata/seata/commit/ae1b5c51361e01288113e3f7fbed31e00556abc1", "message": "Merge remote-tracking branch 'origin/develop' into optimize_limit_order_by_sql\n\n# Conflicts:\n#\tchanges/1.5.0.md\n#\tchanges/en-us/1.5.0.md", "committedDate": "2021-03-06T02:26:40Z", "type": "commit"}, {"oid": "d9ee646a6714edee023b590781cde14c90a43d16", "url": "https://github.com/seata/seata/commit/d9ee646a6714edee023b590781cde14c90a43d16", "message": "Merge remote-tracking branch 'origin/develop' into optimize_limit_order_by_sql\n\n# Conflicts:\n#\tchanges/1.5.0.md\n#\tchanges/en-us/1.5.0.md\n#\tsqlparser/seata-sqlparser-core/src/main/java/io/seata/sqlparser/WhereRecognizer.java\n#\tsqlparser/seata-sqlparser-druid/src/main/java/io/seata/sqlparser/druid/BaseRecognizer.java", "committedDate": "2021-07-23T10:52:01Z", "type": "commit"}, {"oid": "e5a8465e0f5a3d0bdc6e123a8a773aea06f43366", "url": "https://github.com/seata/seata/commit/e5a8465e0f5a3d0bdc6e123a8a773aea06f43366", "message": "upgrade changes.md", "committedDate": "2021-07-23T10:55:33Z", "type": "commit"}, {"oid": "4ee5af0447a41df3745d2971ebbb8ec7877b83b9", "url": "https://github.com/seata/seata/commit/4ee5af0447a41df3745d2971ebbb8ec7877b83b9", "message": "Merge branch 'develop' into optimize_limit_order_by_sql", "committedDate": "2021-08-14T08:05:27Z", "type": "commit"}]}