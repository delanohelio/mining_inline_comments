{"pr_number": 2359, "pr_title": "feature: support propagation.never, propagation.mandatory, transaction suspend and resume api", "pr_createdAt": "2020-03-05T06:59:49Z", "pr_url": "https://github.com/seata/seata/pull/2359", "timeline": [{"oid": "06a2ea5dd1af88430d771714fa72aea5978b7e7c", "url": "https://github.com/seata/seata/commit/06a2ea5dd1af88430d771714fa72aea5978b7e7c", "message": "feature:add propagation about:never,mandatory,and optimize the transationTemplate code", "committedDate": "2020-03-05T06:51:55Z", "type": "commit"}, {"oid": "6099506a0adf1d276cf614424f295a7929281866", "url": "https://github.com/seata/seata/commit/6099506a0adf1d276cf614424f295a7929281866", "message": "feature:add propagation about:never,mandatory,and optimize the transationTemplate code", "committedDate": "2020-03-05T06:53:54Z", "type": "commit"}, {"oid": "1a45d625edd4b708f1a45c5959df831549386dcb", "url": "https://github.com/seata/seata/commit/1a45d625edd4b708f1a45c5959df831549386dcb", "message": "Merge branch 'develop' of github.com:seata/seata into develop", "committedDate": "2020-03-06T02:07:11Z", "type": "commit"}, {"oid": "058a95068d5203fa484a821c1b8d46e4337fe20b", "url": "https://github.com/seata/seata/commit/058a95068d5203fa484a821c1b8d46e4337fe20b", "message": "fix:format the code style", "committedDate": "2020-03-06T02:52:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkyNzY5Ng==", "url": "https://github.com/seata/seata/pull/2359#discussion_r388927696", "bodyText": "StringUtils.isEmpty(RootContext.getXID()) has returned boolean, can use notEmpty", "author": "zjinlei", "createdAt": "2020-03-06T14:19:21Z", "path": "tm/src/main/java/io/seata/tm/api/TransactionalTemplate.java", "diffHunk": "@@ -103,13 +114,43 @@ public Object execute(TransactionalExecutor business) throws Throwable {\n                 cleanUp();\n             }\n         } finally {\n-            if (previousXid != null) {\n-                RootContext.bind(previousXid);\n-            }\n+            resume(suspendedXid);\n         }\n \n     }\n \n+    private boolean existingTransaction() {\n+        return StringUtils.isEmpty(RootContext.getXID()) ? false : true;", "originalCommit": "058a95068d5203fa484a821c1b8d46e4337fe20b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQxMTQyMA==", "url": "https://github.com/seata/seata/pull/2359#discussion_r391411420", "bodyText": "done", "author": "lightClouds917", "createdAt": "2020-03-12T05:42:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkyNzY5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "1453a17542a43ea623802335bf3ab86961ad7674", "chunk": "diff --git a/tm/src/main/java/io/seata/tm/api/TransactionalTemplate.java b/tm/src/main/java/io/seata/tm/api/TransactionalTemplate.java\nindex e72f2a61..4b5e09ca 100644\n--- a/tm/src/main/java/io/seata/tm/api/TransactionalTemplate.java\n+++ b/tm/src/main/java/io/seata/tm/api/TransactionalTemplate.java\n\n@@ -119,10 +120,11 @@ public class TransactionalTemplate {\n \n     }\n \n-    private boolean existingTransaction() {\n-        return StringUtils.isEmpty(RootContext.getXID()) ? false : true;\n+    public boolean existingTransaction() {\n+        return !StringUtils.isEmpty(RootContext.getXID());\n \n     }\n+\n     /**\n      * Suspend the current transaction\n      * @return the transaction xid has suspended\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkyOTg0Mg==", "url": "https://github.com/seata/seata/pull/2359#discussion_r388929842", "bodyText": "StringUtils.isEmpty(RootContext.getXID()) has returned boolean, can use notEmpty", "author": "zjinlei", "createdAt": "2020-03-06T14:23:14Z", "path": "tm/src/main/java/io/seata/tm/api/TransactionalTemplate.java", "diffHunk": "@@ -103,13 +114,43 @@ public Object execute(TransactionalExecutor business) throws Throwable {\n                 cleanUp();\n             }\n         } finally {\n-            if (previousXid != null) {\n-                RootContext.bind(previousXid);\n-            }\n+            resume(suspendedXid);\n         }\n \n     }\n \n+    private boolean existingTransaction() {\n+        return StringUtils.isEmpty(RootContext.getXID()) ? false : true;", "originalCommit": "058a95068d5203fa484a821c1b8d46e4337fe20b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQxMTM3Ng==", "url": "https://github.com/seata/seata/pull/2359#discussion_r391411376", "bodyText": "done", "author": "lightClouds917", "createdAt": "2020-03-12T05:42:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkyOTg0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "1453a17542a43ea623802335bf3ab86961ad7674", "chunk": "diff --git a/tm/src/main/java/io/seata/tm/api/TransactionalTemplate.java b/tm/src/main/java/io/seata/tm/api/TransactionalTemplate.java\nindex e72f2a61..4b5e09ca 100644\n--- a/tm/src/main/java/io/seata/tm/api/TransactionalTemplate.java\n+++ b/tm/src/main/java/io/seata/tm/api/TransactionalTemplate.java\n\n@@ -119,10 +120,11 @@ public class TransactionalTemplate {\n \n     }\n \n-    private boolean existingTransaction() {\n-        return StringUtils.isEmpty(RootContext.getXID()) ? false : true;\n+    public boolean existingTransaction() {\n+        return !StringUtils.isEmpty(RootContext.getXID());\n \n     }\n+\n     /**\n      * Suspend the current transaction\n      * @return the transaction xid has suspended\n"}}, {"oid": "0492e91529185544f489084ba55f2e23eb253879", "url": "https://github.com/seata/seata/commit/0492e91529185544f489084ba55f2e23eb253879", "message": "Merge branch 'develop' of github.com:seata/seata into develop", "committedDate": "2020-03-09T07:38:23Z", "type": "commit"}, {"oid": "7cafe21088a46fb0576648ddc7dfd66f539a6080", "url": "https://github.com/seata/seata/commit/7cafe21088a46fb0576648ddc7dfd66f539a6080", "message": "optimize:replace magic number of date at the UUIDGenerator", "committedDate": "2020-03-10T05:43:33Z", "type": "commit"}, {"oid": "81a90dad302a36ad15b4aa35b7fb3964d7c4c96c", "url": "https://github.com/seata/seata/commit/81a90dad302a36ad15b4aa35b7fb3964d7c4c96c", "message": "Merge branch 'develop' of github.com:seata/seata into develop", "committedDate": "2020-03-10T07:08:34Z", "type": "commit"}, {"oid": "082e84a30d3356f6b6f505439b20af81e26d15ee", "url": "https://github.com/seata/seata/commit/082e84a30d3356f6b6f505439b20af81e26d15ee", "message": "revert:revert the optimize:replace magic number of date at the UUIDGenerator", "committedDate": "2020-03-10T07:12:20Z", "type": "commit"}, {"oid": "08a7ae65bdef1d8d3837e4744cd941779712a189", "url": "https://github.com/seata/seata/commit/08a7ae65bdef1d8d3837e4744cd941779712a189", "message": "Merge branch 'develop' of github.com:seata/seata into develop", "committedDate": "2020-03-11T09:44:50Z", "type": "commit"}, {"oid": "1453a17542a43ea623802335bf3ab86961ad7674", "url": "https://github.com/seata/seata/commit/1453a17542a43ea623802335bf3ab86961ad7674", "message": "optimize:opitmize the code and add test", "committedDate": "2020-03-12T05:30:43Z", "type": "commit"}, {"oid": "a973b977263ecab3abcd5a88da523c3e2fde900e", "url": "https://github.com/seata/seata/commit/a973b977263ecab3abcd5a88da523c3e2fde900e", "message": "optimize:add SuspendResourceHolder to hold the suspend resource", "committedDate": "2020-03-13T04:25:59Z", "type": "commit"}, {"oid": "22b8b072fbf00b66dd776880049a832f2d88180f", "url": "https://github.com/seata/seata/commit/22b8b072fbf00b66dd776880049a832f2d88180f", "message": "Merge branch 'develop' of github.com:seata/seata into develop", "committedDate": "2020-03-13T04:26:29Z", "type": "commit"}, {"oid": "eec785a5d9d6bdb537dcec53e9b5bf31e3e6d9f5", "url": "https://github.com/seata/seata/commit/eec785a5d9d6bdb537dcec53e9b5bf31e3e6d9f5", "message": "optimize:update the exception", "committedDate": "2020-03-13T05:29:38Z", "type": "commit"}, {"oid": "a6fad769ce880ef5c830e131efd8c47f1a4bb827", "url": "https://github.com/seata/seata/commit/a6fad769ce880ef5c830e131efd8c47f1a4bb827", "message": "remove:remove the unuse import", "committedDate": "2020-03-13T05:50:13Z", "type": "commit"}, {"oid": "c2f9b0780a32ecb164c834b4894700ef7cb2a147", "url": "https://github.com/seata/seata/commit/c2f9b0780a32ecb164c834b4894700ef7cb2a147", "message": "fix:fix the branchType", "committedDate": "2020-03-13T07:01:04Z", "type": "commit"}, {"oid": "c90630c02683ac7d130a651e6afbb2c0b6fb53eb", "url": "https://github.com/seata/seata/commit/c90630c02683ac7d130a651e6afbb2c0b6fb53eb", "message": "optimize:remove the branchType", "committedDate": "2020-03-16T05:45:56Z", "type": "commit"}, {"oid": "1d9c7a0307c6de79e02541232bb8f9ed5e12c853", "url": "https://github.com/seata/seata/commit/1d9c7a0307c6de79e02541232bb8f9ed5e12c853", "message": "Merge branch 'develop' of github.com:seata/seata into develop", "committedDate": "2020-03-16T06:09:13Z", "type": "commit"}, {"oid": "529fa462e54a992ec3bf817bf1213fe006729795", "url": "https://github.com/seata/seata/commit/529fa462e54a992ec3bf817bf1213fe006729795", "message": "Merge branch 'develop' into develop", "committedDate": "2020-03-18T05:27:53Z", "type": "commit"}, {"oid": "e537934d44a8ce2f39ea6b37f80a0db31430d220", "url": "https://github.com/seata/seata/commit/e537934d44a8ce2f39ea6b37f80a0db31430d220", "message": "Merge branch 'develop' into develop", "committedDate": "2020-03-20T06:34:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ1ODk1MA==", "url": "https://github.com/seata/seata/pull/2359#discussion_r395458950", "bodyText": "how about print xid here\uff1f", "author": "slievrly", "createdAt": "2020-03-20T06:43:17Z", "path": "tm/src/main/java/io/seata/tm/api/TransactionalTemplate.java", "diffHunk": "@@ -52,29 +53,42 @@ public Object execute(TransactionalExecutor business) throws Throwable {\n         if (txInfo == null) {\n             throw new ShouldNeverHappenException(\"transactionInfo does not exist\");\n         }\n+        // 1.1 get or create a transaction\n+        GlobalTransaction tx = GlobalTransactionContext.getCurrentOrCreate();\n+\n+        // 1.2 Handle the Transaction propatation and the branchType\n         Propagation propagation = txInfo.getPropagation();\n-        String previousXid = null;\n+        SuspendedResourcesHolder suspendedResourcesHolder = null;\n         try {\n             switch (propagation) {\n                 case NOT_SUPPORTED:\n-                    previousXid = RootContext.unbind();\n+                    suspendedResourcesHolder = tx.suspend(true);\n                     return business.execute();\n                 case REQUIRES_NEW:\n-                    previousXid = RootContext.unbind();\n+                    suspendedResourcesHolder = tx.suspend(true);\n                     break;\n                 case SUPPORTS:\n-                    if (StringUtils.isEmpty(RootContext.getXID())) {\n+                    if (!existingTransaction()) {\n                         return business.execute();\n                     }\n                     break;\n                 case REQUIRED:\n                     break;\n+                case NEVER:\n+                    if (existingTransaction()) {\n+                        throw new TransactionException(\"Existing transaction found for transaction marked with propagation 'never'\");", "originalCommit": "e537934d44a8ce2f39ea6b37f80a0db31430d220", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ1OTM4Nw==", "url": "https://github.com/seata/seata/pull/2359#discussion_r395459387", "bodyText": "ok\uff0ci will add now", "author": "lightClouds917", "createdAt": "2020-03-20T06:45:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ1ODk1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ2NDgzNg==", "url": "https://github.com/seata/seata/pull/2359#discussion_r395464836", "bodyText": "finished", "author": "lightClouds917", "createdAt": "2020-03-20T07:07:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ1ODk1MA=="}], "type": "inlineReview", "revised_code": {"commit": "d7c245a40ecf8d48818a590c220b58ed6292321b", "chunk": "diff --git a/tm/src/main/java/io/seata/tm/api/TransactionalTemplate.java b/tm/src/main/java/io/seata/tm/api/TransactionalTemplate.java\nindex 94196b2f..f1bef455 100644\n--- a/tm/src/main/java/io/seata/tm/api/TransactionalTemplate.java\n+++ b/tm/src/main/java/io/seata/tm/api/TransactionalTemplate.java\n\n@@ -76,7 +76,9 @@ public class TransactionalTemplate {\n                     break;\n                 case NEVER:\n                     if (existingTransaction()) {\n-                        throw new TransactionException(\"Existing transaction found for transaction marked with propagation 'never'\");\n+                        throw new TransactionException(\n+                                String.format(\"Existing transaction found for transaction marked with propagation 'never',xid = %s\"\n+                                        ,RootContext.getXID()));\n                     } else {\n                         return business.execute();\n                     }\n"}}, {"oid": "82ea0886a5bc491efb2f026db47acc2cc3b3181c", "url": "https://github.com/seata/seata/commit/82ea0886a5bc491efb2f026db47acc2cc3b3181c", "message": "Merge branch 'develop' of github.com:lightClouds917/seata into develop", "committedDate": "2020-03-20T06:46:17Z", "type": "commit"}, {"oid": "d7c245a40ecf8d48818a590c220b58ed6292321b", "url": "https://github.com/seata/seata/commit/d7c245a40ecf8d48818a590c220b58ed6292321b", "message": "optimize:print xid for never", "committedDate": "2020-03-20T06:55:40Z", "type": "commit"}]}