{"pr_number": 8507, "pr_title": "Fix race condition in embedding tests", "pr_createdAt": "2020-06-05T08:20:47Z", "pr_url": "https://github.com/vaadin/flow/pull/8507", "timeline": [{"oid": "1139cf3ba551eaf4bdeb7019e1b094ce3b559f5f", "url": "https://github.com/vaadin/flow/commit/1139cf3ba551eaf4bdeb7019e1b094ce3b559f5f", "message": "Wait for a shadow root to appear to work around race condition with HTML import polyfill", "committedDate": "2020-06-05T07:58:51Z", "type": "commit"}, {"oid": "27f9895b67e752eeba28e8da10e350adda0f8a8a", "url": "https://github.com/vaadin/flow/commit/27f9895b67e752eeba28e8da10e350adda0f8a8a", "message": "Update chrome driver to 83.0.4103.39 (#8407)", "committedDate": "2020-06-05T08:11:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg0MDQ1Ng==", "url": "https://github.com/vaadin/flow/pull/8507#discussion_r435840456", "bodyText": "x => x.shadowRoot\n\nThat didn't work in IE.\nThough we don't run our tests in IE but still : is it possible to write this somehow cross-browser ?", "author": "denis-anisimov", "createdAt": "2020-06-05T10:43:51Z", "path": "flow-tests/test-embedding/embedding-test-assets/src/test/java/com/vaadin/flow/webcomponent/EmbeddingChromeBrowserTest.java", "diffHunk": "@@ -0,0 +1,19 @@\n+package com.vaadin.flow.webcomponent;\n+\n+import com.vaadin.flow.testutil.ChromeBrowserTest;\n+\n+public abstract class EmbeddingChromeBrowserTest extends ChromeBrowserTest {\n+\n+    @Override\n+    protected void open() {\n+        super.open();\n+\n+        // Wait for at least one shadow root to appear. This is to avoid race\n+        // conditions where the test starts before the shadow root has been\n+        // attached #8329\n+        this.waitUntil((driver) -> Boolean.TRUE\n+                .equals(this.getCommandExecutor().executeScript(\n+                        \"return Array.from(document.getElementsByTagName('*')).some(x => x.shadowRoot !== null)\")));", "originalCommit": "27f9895b67e752eeba28e8da10e350adda0f8a8a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg4Nzk4NQ==", "url": "https://github.com/vaadin/flow/pull/8507#discussion_r435887985", "bodyText": "ES5 compat JS.", "author": "joheriks", "createdAt": "2020-06-05T12:28:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg0MDQ1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg5NTg0MQ==", "url": "https://github.com/vaadin/flow/pull/8507#discussion_r435895841", "bodyText": "No, sorry, I meant x.shadowRoot .\nI don't know actually what's the output of the compiled production client side code.\nBut for the previous releases production code produced a code which worked in browsers which don't support web components at all .\nIn those browsers shadowRoot just don't exist at all.\nE.g. in IE11 (again: I don't know which browsers we support nowadays) TB has a specific code which checks the element directly in the parent and then tries to use shadowRoot.\nAnd IE11 of course doesn't support =>.", "author": "denis-anisimov", "createdAt": "2020-06-05T12:43:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg0MDQ1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTkwNjgyOA==", "url": "https://github.com/vaadin/flow/pull/8507#discussion_r435906828", "bodyText": "I opened the test view in IE8, and the embedded web components just appear as empty tags in the DOM. I don't know if the test is designed to work in IE at all?", "author": "joheriks", "createdAt": "2020-06-05T13:04:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg0MDQ1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTkyMDYyMQ==", "url": "https://github.com/vaadin/flow/pull/8507#discussion_r435920621", "bodyText": "IE 8 ?\nIE 8 is not supported for sure.\nIE 11 : I don't know.\nBut yeah, may be it has no sense to care about this at the moment.", "author": "denis-anisimov", "createdAt": "2020-06-05T13:28:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg0MDQ1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "11ed21f4ba31daf0867221dcf5a5a79f57979069", "chunk": "diff --git a/flow-tests/test-embedding/embedding-test-assets/src/test/java/com/vaadin/flow/webcomponent/EmbeddingChromeBrowserTest.java b/flow-tests/test-embedding/embedding-test-assets/src/test/java/com/vaadin/flow/webcomponent/EmbeddingChromeBrowserTest.java\nindex d8f6ae3420..965088f6b5 100644\n--- a/flow-tests/test-embedding/embedding-test-assets/src/test/java/com/vaadin/flow/webcomponent/EmbeddingChromeBrowserTest.java\n+++ b/flow-tests/test-embedding/embedding-test-assets/src/test/java/com/vaadin/flow/webcomponent/EmbeddingChromeBrowserTest.java\n\n@@ -13,7 +13,7 @@ public abstract class EmbeddingChromeBrowserTest extends ChromeBrowserTest {\n         // attached #8329\n         this.waitUntil((driver) -> Boolean.TRUE\n                 .equals(this.getCommandExecutor().executeScript(\n-                        \"return Array.from(document.getElementsByTagName('*')).some(x => x.shadowRoot !== null)\")));\n+                        \"return Array.prototype.slice.call(document.getElementsByTagName(\\\"*\\\")).some(function (x) { return !!x.shadowRoot })\")));\n     }\n \n }\n"}}, {"oid": "11ed21f4ba31daf0867221dcf5a5a79f57979069", "url": "https://github.com/vaadin/flow/commit/11ed21f4ba31daf0867221dcf5a5a79f57979069", "message": "IE compatible version of JS", "committedDate": "2020-06-05T12:25:49Z", "type": "commit"}]}