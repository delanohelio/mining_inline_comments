{"pr_number": 8529, "pr_title": "Prevent StackOverflowError in Composite.", "pr_createdAt": "2020-06-09T04:50:43Z", "pr_url": "https://github.com/vaadin/flow/pull/8529", "timeline": [{"oid": "26bb1bffe05fd71b84e37efd9296d073cde95cf6", "url": "https://github.com/vaadin/flow/commit/26bb1bffe05fd71b84e37efd9296d073cde95cf6", "message": "Prevent StackOverflowError in Composite.\n\nFixes #5553", "committedDate": "2020-06-09T04:50:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg0MTc3Nw==", "url": "https://github.com/vaadin/flow/pull/8529#discussion_r440841777", "bodyText": "transient?", "author": "joheriks", "createdAt": "2020-06-16T13:18:18Z", "path": "flow-server/src/main/java/com/vaadin/flow/component/Composite.java", "diffHunk": "@@ -50,6 +50,8 @@\n public abstract class Composite<T extends Component> extends Component {\n     private T content;\n \n+    private ThreadLocal<Boolean> contentIsInitializing = new ThreadLocal<>();", "originalCommit": "26bb1bffe05fd71b84e37efd9296d073cde95cf6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI4ODk4MQ==", "url": "https://github.com/vaadin/flow/pull/8529#discussion_r441288981", "bodyText": "good point", "author": "denis-anisimov", "createdAt": "2020-06-17T05:29:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg0MTc3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "cb59b3dd838254a68e190adff3bfeccb5479e5c0", "chunk": "diff --git a/flow-server/src/main/java/com/vaadin/flow/component/Composite.java b/flow-server/src/main/java/com/vaadin/flow/component/Composite.java\nindex e5097b9dfe..a81b2335e0 100644\n--- a/flow-server/src/main/java/com/vaadin/flow/component/Composite.java\n+++ b/flow-server/src/main/java/com/vaadin/flow/component/Composite.java\n\n@@ -50,7 +52,7 @@ import com.vaadin.flow.internal.ReflectTools;\n public abstract class Composite<T extends Component> extends Component {\n     private T content;\n \n-    private ThreadLocal<Boolean> contentIsInitializing = new ThreadLocal<>();\n+    private transient ThreadLocal<Boolean> contentIsInitializing = new ThreadLocal<>();\n \n     /**\n      * Creates a new composite.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg0NTU4OA==", "url": "https://github.com/vaadin/flow/pull/8529#discussion_r440845588", "bodyText": "I would suggest:\nThe content is not yet initialized. \nDetected direct or indirect call to 'getContent' from 'initContent'. \nYou may not call any framework method on a 'Composite' instance before 'initContent' has completed initializing the component .\n\nRationale: The infinite loop symptom is because of our implementation choice, user does not need to be aware since it is prevented by this code. Also the last suggestion to \"Call methods on the content component instead\" may be assuming too much about what the dev is trying to do.", "author": "joheriks", "createdAt": "2020-06-16T13:23:51Z", "path": "flow-server/src/main/java/com/vaadin/flow/component/Composite.java", "diffHunk": "@@ -113,12 +115,27 @@ private static String getExceptionMessage(Type type) {\n      */\n     public T getContent() {\n         if (content == null) {\n-            T newContent = initContent();\n-            if (newContent == null) {\n-                throw new IllegalStateException(\n-                        \"initContent returned null instead of a component\");\n+            try {\n+                if (Boolean.TRUE.equals(contentIsInitializing.get())) {\n+                    throw new IllegalStateException(\n+                            \"The content is not yet initialized. \"\n+                                    + \"Infinite loop detected: you are calling a code inside 'initContent' \"\n+                                    + \"which directly or indirectly is calling 'getContent'/'initContent'. \"\n+                                    + \"You may not call any method on \"\n+                                    + Composite.class.getSimpleName()\n+                                    + \" instance until it initialized (inside 'getContent' or 'initContent'). \"\n+                                    + \"Call methods on the content component instead.\");", "originalCommit": "26bb1bffe05fd71b84e37efd9296d073cde95cf6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cb59b3dd838254a68e190adff3bfeccb5479e5c0", "chunk": "diff --git a/flow-server/src/main/java/com/vaadin/flow/component/Composite.java b/flow-server/src/main/java/com/vaadin/flow/component/Composite.java\nindex e5097b9dfe..a81b2335e0 100644\n--- a/flow-server/src/main/java/com/vaadin/flow/component/Composite.java\n+++ b/flow-server/src/main/java/com/vaadin/flow/component/Composite.java\n\n@@ -119,12 +121,10 @@ public abstract class Composite<T extends Component> extends Component {\n                 if (Boolean.TRUE.equals(contentIsInitializing.get())) {\n                     throw new IllegalStateException(\n                             \"The content is not yet initialized. \"\n-                                    + \"Infinite loop detected: you are calling a code inside 'initContent' \"\n-                                    + \"which directly or indirectly is calling 'getContent'/'initContent'. \"\n-                                    + \"You may not call any method on \"\n+                                    + \"Detected direct or indirect call to 'getContent' from 'initContent'. \"\n+                                    + \"You may not call any framework method on a '\"\n                                     + Composite.class.getSimpleName()\n-                                    + \" instance until it initialized (inside 'getContent' or 'initContent'). \"\n-                                    + \"Call methods on the content component instead.\");\n+                                    + \"' instance before 'initContent' has completed initializing the component.\");\n                 }\n                 contentIsInitializing.set(true);\n                 T newContent = initContent();\n"}}, {"oid": "cb59b3dd838254a68e190adff3bfeccb5479e5c0", "url": "https://github.com/vaadin/flow/commit/cb59b3dd838254a68e190adff3bfeccb5479e5c0", "message": "Correct serializability and exception message", "committedDate": "2020-06-17T05:39:51Z", "type": "commit"}]}