{"pr_number": 8630, "pr_title": "Push history when navigating to route-not-found view", "pr_createdAt": "2020-06-26T10:46:40Z", "pr_url": "https://github.com/vaadin/flow/pull/8630", "timeline": [{"oid": "010c0cfcc1671a174e852ab4d48dc68947d0eb55", "url": "https://github.com/vaadin/flow/commit/010c0cfcc1671a174e852ab4d48dc68947d0eb55", "message": "Push history when navigating to route-not-found view", "committedDate": "2020-06-26T10:45:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjEzNTEyOQ==", "url": "https://github.com/vaadin/flow/pull/8630#discussion_r446135129", "bodyText": "I would suggest combine (event instanceof ErrorNavigationEvent) && isRouterLink in  one if.\nLess nested ifs.", "author": "denis-anisimov", "createdAt": "2020-06-26T11:47:40Z", "path": "flow-server/src/main/java/com/vaadin/flow/router/internal/AbstractNavigationStateRenderer.java", "diffHunk": "@@ -243,11 +244,21 @@ public int handle(NavigationEvent event) {\n     }\n \n     private void pushHistoryStateIfNeeded(NavigationEvent event, UI ui) {\n-        if (event instanceof ErrorNavigationEvent) {\n-            return;\n-        }\n+        boolean isRouterLink = NavigationTrigger.ROUTER_LINK\n+                .equals(event.getTrigger());\n \n-        if (NavigationTrigger.ROUTER_LINK.equals(event.getTrigger())) {\n+        if (event instanceof ErrorNavigationEvent) {\n+            if (isRouterLink) {", "originalCommit": "010c0cfcc1671a174e852ab4d48dc68947d0eb55", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE1ODg4Mw==", "url": "https://github.com/vaadin/flow/pull/8630#discussion_r446158883", "bodyText": "Also the other conditions should not be tested at all if event is of type ErrorNavigationEvent. Simplified the if structure and extracted the logic to another method.", "author": "joheriks", "createdAt": "2020-06-26T12:40:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjEzNTEyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjIwODU1Mg==", "url": "https://github.com/vaadin/flow/pull/8630#discussion_r446208552", "bodyText": "You can combine everything inside the method - java uses short-circuit evaluation if used with && or ||, meaning the right side won't be executed, when left already matched.", "author": "knoobie", "createdAt": "2020-06-26T14:11:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjEzNTEyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "b3f85c65eae8bb4c26affa897ea79967117c0034", "chunk": "diff --git a/flow-server/src/main/java/com/vaadin/flow/router/internal/AbstractNavigationStateRenderer.java b/flow-server/src/main/java/com/vaadin/flow/router/internal/AbstractNavigationStateRenderer.java\nindex cee2982805..6a349643b1 100644\n--- a/flow-server/src/main/java/com/vaadin/flow/router/internal/AbstractNavigationStateRenderer.java\n+++ b/flow-server/src/main/java/com/vaadin/flow/router/internal/AbstractNavigationStateRenderer.java\n\n@@ -248,15 +248,10 @@ public abstract class AbstractNavigationStateRenderer\n                 .equals(event.getTrigger());\n \n         if (event instanceof ErrorNavigationEvent) {\n-            if (isRouterLink) {\n-                ErrorNavigationEvent errorNavigationEvent = (ErrorNavigationEvent) event;\n-                if (errorNavigationEvent.getErrorParameter() != null\n-                        && errorNavigationEvent.getErrorParameter()\n-                                .getCaughtException() instanceof NotFoundException) {\n-                    // Push history in case the exception was due to route not\n-                    // found (#8544)\n-                    pushHistoryState(event);\n-                }\n+            // Push history in case the exception was due to route not\n+            // found (#8544)\n+            if (shouldPushHistoryStateForNavigationError((ErrorNavigationEvent) event)) {\n+                pushHistoryState(event);\n             }\n         } else if (isRouterLink) {\n             /*\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjEzNjc1Nw==", "url": "https://github.com/vaadin/flow/pull/8630#discussion_r446136757", "bodyText": "new line", "author": "denis-anisimov", "createdAt": "2020-06-26T11:51:36Z", "path": "flow-tests/test-root-context/src/test/java/com/vaadin/flow/uitest/ui/BrokenRouterLinkIT.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+ * Copyright 2000-2020 Vaadin Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package com.vaadin.flow.uitest.ui;\n+\n+import org.junit.Assert;\n+import org.junit.Test;\n+import org.openqa.selenium.By;\n+import org.openqa.selenium.WebElement;\n+\n+import com.vaadin.flow.testutil.ChromeBrowserTest;\n+\n+// https://github.com/vaadin/flow/issues/8544\n+public class BrokenRouterLinkIT extends ChromeBrowserTest {\n+\n+    @Test\n+    public void testRouterLink_linkIsBroken_urlIsUpdated() {\n+        open();\n+\n+        WebElement link = findElement(By.id(BrokenRouterLinkView.LINK_ID));\n+\n+        String href = link.getAttribute(\"href\");\n+\n+        link.click();\n+\n+        Assert.assertTrue(getDriver().getCurrentUrl().endsWith(href));\n+\n+    }\n+}", "originalCommit": "010c0cfcc1671a174e852ab4d48dc68947d0eb55", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b3f85c65eae8bb4c26affa897ea79967117c0034", "chunk": "diff --git a/flow-tests/test-root-context/src/test/java/com/vaadin/flow/uitest/ui/BrokenRouterLinkIT.java b/flow-tests/test-root-context/src/test/java/com/vaadin/flow/uitest/ui/BrokenRouterLinkIT.java\nindex ddc132970b..3fbab306f1 100644\n--- a/flow-tests/test-root-context/src/test/java/com/vaadin/flow/uitest/ui/BrokenRouterLinkIT.java\n+++ b/flow-tests/test-root-context/src/test/java/com/vaadin/flow/uitest/ui/BrokenRouterLinkIT.java\n\n@@ -38,4 +38,4 @@ public class BrokenRouterLinkIT extends ChromeBrowserTest {\n         Assert.assertTrue(getDriver().getCurrentUrl().endsWith(href));\n \n     }\n-}\n\\ No newline at end of file\n+}\n"}}, {"oid": "b3f85c65eae8bb4c26affa897ea79967117c0034", "url": "https://github.com/vaadin/flow/commit/b3f85c65eae8bb4c26affa897ea79967117c0034", "message": "Addressed review comments", "committedDate": "2020-06-26T12:38:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU0NjMwMA==", "url": "https://github.com/vaadin/flow/pull/8630#discussion_r446546300", "bodyText": "I think we require javadocs for protected methods.\nI would avoid should  in method names. Not sure whether this is a better name though.", "author": "denis-anisimov", "createdAt": "2020-06-27T17:09:21Z", "path": "flow-server/src/main/java/com/vaadin/flow/router/internal/AbstractNavigationStateRenderer.java", "diffHunk": "@@ -284,6 +290,14 @@ protected boolean shouldPushHistoryState(NavigationEvent event) {\n         return NavigationTrigger.UI_NAVIGATE.equals(event.getTrigger());\n     }\n \n+    protected boolean shouldPushHistoryStateForNavigationError(", "originalCommit": "b3f85c65eae8bb4c26affa897ea79967117c0034", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgwNDc4OQ==", "url": "https://github.com/vaadin/flow/pull/8630#discussion_r446804789", "bodyText": "No need for protected as a matter of fact, made private. Also renamed.", "author": "joheriks", "createdAt": "2020-06-29T06:44:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU0NjMwMA=="}], "type": "inlineReview", "revised_code": {"commit": "60ad00f222db64dc509eb550181246f0b222651e", "chunk": "diff --git a/flow-server/src/main/java/com/vaadin/flow/router/internal/AbstractNavigationStateRenderer.java b/flow-server/src/main/java/com/vaadin/flow/router/internal/AbstractNavigationStateRenderer.java\nindex 6a349643b1..768d426bd3 100644\n--- a/flow-server/src/main/java/com/vaadin/flow/router/internal/AbstractNavigationStateRenderer.java\n+++ b/flow-server/src/main/java/com/vaadin/flow/router/internal/AbstractNavigationStateRenderer.java\n\n@@ -290,7 +291,7 @@ public abstract class AbstractNavigationStateRenderer\n         return NavigationTrigger.UI_NAVIGATE.equals(event.getTrigger());\n     }\n \n-    protected boolean shouldPushHistoryStateForNavigationError(\n+    private boolean isRouterLinkNotFoundNavigationError(\n             ErrorNavigationEvent event) {\n         return NavigationTrigger.ROUTER_LINK.equals(event.getTrigger())\n                 && event.getErrorParameter() != null\n"}}, {"oid": "60ad00f222db64dc509eb550181246f0b222651e", "url": "https://github.com/vaadin/flow/commit/60ad00f222db64dc509eb550181246f0b222651e", "message": "Renamed method and changed to private", "committedDate": "2020-06-29T06:43:45Z", "type": "commit"}]}