{"pr_number": 8662, "pr_title": "Use ItemCount instead of size and RowCount #8651", "pr_createdAt": "2020-06-30T14:22:53Z", "pr_url": "https://github.com/vaadin/flow/pull/8662", "timeline": [{"oid": "129b62c61932c8bb7e0ccdc5564dff38329d400b", "url": "https://github.com/vaadin/flow/commit/129b62c61932c8bb7e0ccdc5564dff38329d400b", "message": "Use ItemCount instead of size and RowCount #8651", "committedDate": "2020-06-30T15:32:30Z", "type": "commit"}, {"oid": "4dafd0a3f85ec24886e1e39a662556ab2ee483d9", "url": "https://github.com/vaadin/flow/commit/4dafd0a3f85ec24886e1e39a662556ab2ee483d9", "message": "HasLazyDataViewTest fix", "committedDate": "2020-06-30T15:42:32Z", "type": "commit"}, {"oid": "4dafd0a3f85ec24886e1e39a662556ab2ee483d9", "url": "https://github.com/vaadin/flow/commit/4dafd0a3f85ec24886e1e39a662556ab2ee483d9", "message": "HasLazyDataViewTest fix", "committedDate": "2020-06-30T15:42:32Z", "type": "forcePushed"}, {"oid": "dff3421e97f889d4b415351ae7a6f3b047f9dec1", "url": "https://github.com/vaadin/flow/commit/dff3421e97f889d4b415351ae7a6f3b047f9dec1", "message": "Check the size via datacommunicator API", "committedDate": "2020-06-30T15:49:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgyNjg0OQ==", "url": "https://github.com/vaadin/flow/pull/8662#discussion_r447826849", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * Event describing the data item count change for a component data set.\n          \n          \n            \n             * Event describing the item count change for a component.", "author": "pleku", "createdAt": "2020-06-30T16:40:28Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/ItemCountChangeEvent.java", "diffHunk": "@@ -19,37 +19,34 @@\n import com.vaadin.flow.component.ComponentEvent;\n \n /**\n- * Event describing the data size change for a component data set.\n- * The SizeChangedEvent will fired from beforeClientResponse so changes done\n- * during the server round trip will only receive one event.\n+ * Event describing the data item count change for a component data set.", "originalCommit": "dff3421e97f889d4b415351ae7a6f3b047f9dec1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIxMjE3OQ==", "url": "https://github.com/vaadin/flow/pull/8662#discussion_r448212179", "bodyText": "done", "author": "mshabarov", "createdAt": "2020-07-01T08:44:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgyNjg0OQ=="}], "type": "inlineReview", "revised_code": {"commit": "44bb49b24765b127cc5d29d48d53191b772f5f7b", "chunk": "diff --git a/flow-data/src/main/java/com/vaadin/flow/data/provider/ItemCountChangeEvent.java b/flow-data/src/main/java/com/vaadin/flow/data/provider/ItemCountChangeEvent.java\nindex 1108bf40c3..a404bed67a 100644\n--- a/flow-data/src/main/java/com/vaadin/flow/data/provider/ItemCountChangeEvent.java\n+++ b/flow-data/src/main/java/com/vaadin/flow/data/provider/ItemCountChangeEvent.java\n\n@@ -19,7 +19,7 @@ import com.vaadin.flow.component.Component;\n import com.vaadin.flow.component.ComponentEvent;\n \n /**\n- * Event describing the data item count change for a component data set.\n+ * Event describing the item count change for a component.\n  * The ItemCountChangedEvent will fired from beforeClientResponse so changes\n  * done during the server round trip will only receive one event.\n  *\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgyOTExNA==", "url": "https://github.com/vaadin/flow/pull/8662#discussion_r447829114", "bodyText": "The ItemCountChangedEvent will fired from beforeClientResponse so changes\n\nI think this means absolutely nothing for majority of the users so should be fixed since you're touching the line", "author": "pleku", "createdAt": "2020-06-30T16:43:49Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/ItemCountChangeEvent.java", "diffHunk": "@@ -19,37 +19,34 @@\n import com.vaadin.flow.component.ComponentEvent;\n \n /**\n- * Event describing the data size change for a component data set.\n- * The SizeChangedEvent will fired from beforeClientResponse so changes done\n- * during the server round trip will only receive one event.\n+ * Event describing the data item count change for a component data set.\n+ * The ItemCountChangedEvent will fired from beforeClientResponse so changes", "originalCommit": "dff3421e97f889d4b415351ae7a6f3b047f9dec1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIxMjI3Ng==", "url": "https://github.com/vaadin/flow/pull/8662#discussion_r448212276", "bodyText": "done", "author": "mshabarov", "createdAt": "2020-07-01T08:44:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgyOTExNA=="}], "type": "inlineReview", "revised_code": {"commit": "44bb49b24765b127cc5d29d48d53191b772f5f7b", "chunk": "diff --git a/flow-data/src/main/java/com/vaadin/flow/data/provider/ItemCountChangeEvent.java b/flow-data/src/main/java/com/vaadin/flow/data/provider/ItemCountChangeEvent.java\nindex 1108bf40c3..a404bed67a 100644\n--- a/flow-data/src/main/java/com/vaadin/flow/data/provider/ItemCountChangeEvent.java\n+++ b/flow-data/src/main/java/com/vaadin/flow/data/provider/ItemCountChangeEvent.java\n\n@@ -19,7 +19,7 @@ import com.vaadin.flow.component.Component;\n import com.vaadin.flow.component.ComponentEvent;\n \n /**\n- * Event describing the data item count change for a component data set.\n+ * Event describing the item count change for a component.\n  * The ItemCountChangedEvent will fired from beforeClientResponse so changes\n  * done during the server round trip will only receive one event.\n  *\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgzMTE2OA==", "url": "https://github.com/vaadin/flow/pull/8662#discussion_r447831168", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * Listener interface for getting updates on data item count changes. The\n          \n          \n            \n             * Listener interface for getting updates on item count changes. The", "author": "pleku", "createdAt": "2020-06-30T16:47:02Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/ItemCountChangeListener.java", "diffHunk": "@@ -18,24 +18,24 @@\n import java.io.Serializable;\n \n /**\n- * Listener interface for getting updates on data set size changes. The\n- * sizeChanged method will be called on beforeClientResponse so changes done\n+ * Listener interface for getting updates on data item count changes. The", "originalCommit": "dff3421e97f889d4b415351ae7a6f3b047f9dec1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIxMjMxMw==", "url": "https://github.com/vaadin/flow/pull/8662#discussion_r448212313", "bodyText": "done", "author": "mshabarov", "createdAt": "2020-07-01T08:45:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgzMTE2OA=="}], "type": "inlineReview", "revised_code": {"commit": "a740e5b8a5bc676a79c1b024bcc7173d43d4d85f", "chunk": "diff --git a/flow-data/src/main/java/com/vaadin/flow/data/provider/ItemCountChangeListener.java b/flow-data/src/main/java/com/vaadin/flow/data/provider/ItemCountChangeListener.java\nindex bba59baae8..345c8e36e7 100644\n--- a/flow-data/src/main/java/com/vaadin/flow/data/provider/ItemCountChangeListener.java\n+++ b/flow-data/src/main/java/com/vaadin/flow/data/provider/ItemCountChangeListener.java\n\n@@ -18,12 +18,24 @@ package com.vaadin.flow.data.provider;\n import java.io.Serializable;\n \n /**\n- * Listener interface for getting updates on data item count changes. The\n- * itemCountChanged method will be called on beforeClientResponse so changes done\n- * during the server round trip will only receive one event.\n+ * Listener interface for getting updates on data item count changes.\n  * <p>\n  * Items count changes are mostly due to filtering of the data, but can also be\n  * sent for changes in the dataset.\n+ * <p>\n+ * The {@link #itemCountChanged(ItemCountChangeEvent)} will be called\n+ * during the \"before client response\"-phase, so changes done during the\n+ * server round trip will only receive one event.\n+ * For example, this code will trigger only one\n+ * {@link #itemCountChanged(ItemCountChangeEvent)} method call, although there\n+ * are two methods called which cause the item count change:\n+ * <pre>\n+ * {@code\n+ * dataView.addItemCountChangeListener(listener);\n+ * dataView.addItem(newItem);\n+ * dataView.setFilter(filter);\n+ * }\n+ * </pre>\n  *\n  * @since\n  */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgzMTQyNQ==", "url": "https://github.com/vaadin/flow/pull/8662#discussion_r447831425", "bodyText": "Again, \"called on beforeClientResponse\" really means nothing to the majority of the users", "author": "pleku", "createdAt": "2020-06-30T16:47:28Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/ItemCountChangeListener.java", "diffHunk": "@@ -18,24 +18,24 @@\n import java.io.Serializable;\n \n /**\n- * Listener interface for getting updates on data set size changes. The\n- * sizeChanged method will be called on beforeClientResponse so changes done\n+ * Listener interface for getting updates on data item count changes. The\n+ * itemCountChanged method will be called on beforeClientResponse so changes done", "originalCommit": "dff3421e97f889d4b415351ae7a6f3b047f9dec1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIxMjM5MQ==", "url": "https://github.com/vaadin/flow/pull/8662#discussion_r448212391", "bodyText": "done", "author": "mshabarov", "createdAt": "2020-07-01T08:45:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgzMTQyNQ=="}], "type": "inlineReview", "revised_code": {"commit": "a740e5b8a5bc676a79c1b024bcc7173d43d4d85f", "chunk": "diff --git a/flow-data/src/main/java/com/vaadin/flow/data/provider/ItemCountChangeListener.java b/flow-data/src/main/java/com/vaadin/flow/data/provider/ItemCountChangeListener.java\nindex bba59baae8..345c8e36e7 100644\n--- a/flow-data/src/main/java/com/vaadin/flow/data/provider/ItemCountChangeListener.java\n+++ b/flow-data/src/main/java/com/vaadin/flow/data/provider/ItemCountChangeListener.java\n\n@@ -18,12 +18,24 @@ package com.vaadin.flow.data.provider;\n import java.io.Serializable;\n \n /**\n- * Listener interface for getting updates on data item count changes. The\n- * itemCountChanged method will be called on beforeClientResponse so changes done\n- * during the server round trip will only receive one event.\n+ * Listener interface for getting updates on data item count changes.\n  * <p>\n  * Items count changes are mostly due to filtering of the data, but can also be\n  * sent for changes in the dataset.\n+ * <p>\n+ * The {@link #itemCountChanged(ItemCountChangeEvent)} will be called\n+ * during the \"before client response\"-phase, so changes done during the\n+ * server round trip will only receive one event.\n+ * For example, this code will trigger only one\n+ * {@link #itemCountChanged(ItemCountChangeEvent)} method call, although there\n+ * are two methods called which cause the item count change:\n+ * <pre>\n+ * {@code\n+ * dataView.addItemCountChangeListener(listener);\n+ * dataView.addItem(newItem);\n+ * dataView.setFilter(filter);\n+ * }\n+ * </pre>\n  *\n  * @since\n  */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgzMTgwMg==", "url": "https://github.com/vaadin/flow/pull/8662#discussion_r447831802", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * (items) in the backend. Use this when it is cheap to get the exact item\n          \n          \n            \n                 * in the backend. Use this when it is cheap to get the exact item", "author": "pleku", "createdAt": "2020-06-30T16:48:04Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/LazyDataView.java", "diffHunk": "@@ -25,7 +25,7 @@\n public interface LazyDataView<T> extends DataView<T> {\n \n     /**\n-     * Sets a callback that the component uses to get the exact rows count\n+     * Sets a callback that the component uses to get the exact item count\n      * (items) in the backend. Use this when it is cheap to get the exact item", "originalCommit": "dff3421e97f889d4b415351ae7a6f3b047f9dec1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIxMjQzOQ==", "url": "https://github.com/vaadin/flow/pull/8662#discussion_r448212439", "bodyText": "done", "author": "mshabarov", "createdAt": "2020-07-01T08:45:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgzMTgwMg=="}], "type": "inlineReview", "revised_code": {"commit": "44bb49b24765b127cc5d29d48d53191b772f5f7b", "chunk": "diff --git a/flow-data/src/main/java/com/vaadin/flow/data/provider/LazyDataView.java b/flow-data/src/main/java/com/vaadin/flow/data/provider/LazyDataView.java\nindex 5e7717c2bd..8e7cc57f87 100644\n--- a/flow-data/src/main/java/com/vaadin/flow/data/provider/LazyDataView.java\n+++ b/flow-data/src/main/java/com/vaadin/flow/data/provider/LazyDataView.java\n\n@@ -26,7 +26,7 @@ public interface LazyDataView<T> extends DataView<T> {\n \n     /**\n      * Sets a callback that the component uses to get the exact item count\n-     * (items) in the backend. Use this when it is cheap to get the exact item\n+     * in the backend. Use this when it is cheap to get the exact item\n      * count and it is desired that the user sees the \"full scrollbar size\".\n      * <p>\n      * The given callback will be queried for the count instead of the data\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgzMzUzNg==", "url": "https://github.com/vaadin/flow/pull/8662#discussion_r447833536", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Get the full data item count with filters if any set. As the item count\n          \n          \n            \n                 * Get the full item count with filters if any set. As the item count", "author": "pleku", "createdAt": "2020-06-30T16:50:49Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/ListDataView.java", "diffHunk": "@@ -34,6 +35,17 @@\n  */\n public interface ListDataView<T, V extends ListDataView<T, ?>>\n         extends DataView<T> {\n+    /**\n+     * Get the full data item count with filters if any set. As the item count", "originalCommit": "dff3421e97f889d4b415351ae7a6f3b047f9dec1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIxMjUxMQ==", "url": "https://github.com/vaadin/flow/pull/8662#discussion_r448212511", "bodyText": "done", "author": "mshabarov", "createdAt": "2020-07-01T08:45:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgzMzUzNg=="}], "type": "inlineReview", "revised_code": {"commit": "44bb49b24765b127cc5d29d48d53191b772f5f7b", "chunk": "diff --git a/flow-data/src/main/java/com/vaadin/flow/data/provider/ListDataView.java b/flow-data/src/main/java/com/vaadin/flow/data/provider/ListDataView.java\nindex d7fd61b17f..cc43757246 100644\n--- a/flow-data/src/main/java/com/vaadin/flow/data/provider/ListDataView.java\n+++ b/flow-data/src/main/java/com/vaadin/flow/data/provider/ListDataView.java\n\n@@ -36,12 +36,12 @@ import java.util.Optional;\n public interface ListDataView<T, V extends ListDataView<T, ?>>\n         extends DataView<T> {\n     /**\n-     * Get the full data item count with filters if any set. As the item count\n+     * Get the full item count with filters if any set. As the item count\n      * might change at any point, it is recommended to add a listener with the\n      * {@link #addItemCountChangeListener(ComponentEventListener)} method\n-     * instead to get notified when the data item count has changed.\n+     * instead to get notified when the item count has changed.\n      *\n-     * @return filtered data item count\n+     * @return filtered item count\n      * @see #addItemCountChangeListener(ComponentEventListener)\n      */\n     int getItemCount();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgzNDgyNA==", "url": "https://github.com/vaadin/flow/pull/8662#discussion_r447834824", "bodyText": "This will need fixing in #8655 as I supposed it now works by accident since the filters go to the data provider", "author": "pleku", "createdAt": "2020-06-30T16:52:47Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/AbstractListDataView.java", "diffHunk": "@@ -67,6 +67,11 @@ public AbstractListDataView(\n         super(dataProviderSupplier, component);\n     }\n \n+    @Override\n+    public int getItemCount() {\n+        return getDataProvider().size(new Query<>());", "originalCommit": "dff3421e97f889d4b415351ae7a6f3b047f9dec1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgzNjI0NA==", "url": "https://github.com/vaadin/flow/pull/8662#discussion_r447836244", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Add an item count change listener that is fired when the data item\n          \n          \n            \n                 * Add an item count change listener that is fired when the item", "author": "pleku", "createdAt": "2020-06-30T16:55:00Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/DataView.java", "diffHunk": "@@ -78,19 +67,19 @@\n     boolean contains(T item);\n \n     /**\n-     * Add a size change listener that is fired when the data set size changes.\n-     * This can happen for instance when filtering the data set.\n+     * Add an item count change listener that is fired when the data item", "originalCommit": "dff3421e97f889d4b415351ae7a6f3b047f9dec1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIxNDM3Mw==", "url": "https://github.com/vaadin/flow/pull/8662#discussion_r448214373", "bodyText": "done", "author": "mshabarov", "createdAt": "2020-07-01T08:48:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgzNjI0NA=="}], "type": "inlineReview", "revised_code": {"commit": "44bb49b24765b127cc5d29d48d53191b772f5f7b", "chunk": "diff --git a/flow-data/src/main/java/com/vaadin/flow/data/provider/DataView.java b/flow-data/src/main/java/com/vaadin/flow/data/provider/DataView.java\nindex d731b9c4cc..d2aa5d5eea 100644\n--- a/flow-data/src/main/java/com/vaadin/flow/data/provider/DataView.java\n+++ b/flow-data/src/main/java/com/vaadin/flow/data/provider/DataView.java\n\n@@ -67,7 +67,7 @@ public interface DataView<T> extends Serializable {\n     boolean contains(T item);\n \n     /**\n-     * Add an item count change listener that is fired when the data item\n+     * Add an item count change listener that is fired when the item\n      * count changes. This can happen for instance when filtering the data set.\n      * <p>\n      * Item count change listener is bound to the component and will be\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgzODg1Ng==", "url": "https://github.com/vaadin/flow/pull/8662#discussion_r447838856", "bodyText": "You should refactor this instead to use ItemCountChangeListener to verify the correct size", "author": "pleku", "createdAt": "2020-06-30T16:58:56Z", "path": "flow-data/src/test/java/com/vaadin/flow/data/provider/AbstractLazyDataViewTest.java", "diffHunk": "@@ -160,57 +160,6 @@ public void contains_itemsNotFetched_canCheckForItemWithBeforeClientResponse() {\n                 capturedContains.get());\n     }\n \n-    @Test\n-    public void size_withDefinedSize() {", "originalCommit": "dff3421e97f889d4b415351ae7a6f3b047f9dec1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIxNDY5Ng==", "url": "https://github.com/vaadin/flow/pull/8662#discussion_r448214696", "bodyText": "done", "author": "mshabarov", "createdAt": "2020-07-01T08:49:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgzODg1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "44bb49b24765b127cc5d29d48d53191b772f5f7b", "chunk": "diff --git a/flow-data/src/test/java/com/vaadin/flow/data/provider/AbstractLazyDataViewTest.java b/flow-data/src/test/java/com/vaadin/flow/data/provider/AbstractLazyDataViewTest.java\nindex f8fd0010bf..98e9f78207 100644\n--- a/flow-data/src/test/java/com/vaadin/flow/data/provider/AbstractLazyDataViewTest.java\n+++ b/flow-data/src/test/java/com/vaadin/flow/data/provider/AbstractLazyDataViewTest.java\n\n@@ -160,6 +160,73 @@ public class AbstractLazyDataViewTest {\n                 capturedContains.get());\n     }\n \n+    @Test\n+    public void itemCount_definedItemCount() {\n+        final AtomicInteger itemCount = new AtomicInteger(0);\n+        dataView.addItemCountChangeListener(\n+                event -> itemCount.set(event.getItemCount()));\n+        dataCommunicator.setRequestedRange(0, 50);\n+\n+        Assert.assertEquals(\"Invalid item count reported\", 0, itemCount.get());\n+\n+        fakeClientCommunication();\n+\n+        Assert.assertEquals(\"Invalid item count reported\", 3, itemCount.get());\n+\n+        dataView.setItemCountCallback(query -> 2);\n+\n+        fakeClientCommunication();\n+\n+        Assert.assertEquals(\"Invalid item count reported\", 2, itemCount.get());\n+    }\n+\n+    @Test\n+    public void itemCount_undefinedItemCount() {\n+        final AtomicInteger itemCount = new AtomicInteger(0);\n+        dataView.addItemCountChangeListener(\n+                event -> itemCount.set(event.getItemCount()));\n+        dataCommunicator.setRequestedRange(0, 50);\n+        dataView.setItemCountUnknown();\n+\n+        Assert.assertEquals(\"Invalid item count reported\", 0, itemCount.get());\n+\n+        fakeClientCommunication();\n+\n+        Assert.assertEquals(\"Invalid item count reported\", 3, itemCount.get());\n+\n+        dataView.setItemCountEstimate(500);\n+\n+        // since the size was \"locked\", there is no estimate\n+        Assert.assertEquals(\"Invalid item count reported\", 3, itemCount.get());\n+\n+        fakeClientCommunication();\n+\n+        Assert.assertEquals(\"Invalid item count reported\", 3, itemCount.get());\n+\n+        // setting new data provider triggers new size from data provider\n+        dataCommunicator.setDataProvider(DataProvider.fromCallbacks(query -> {\n+            query.getOffset();\n+            return Stream.generate(String::new).limit(query.getLimit());\n+        }, query -> 2), null);\n+\n+        Assert.assertEquals(\"Invalid item count reported\", 3,\n+                itemCount.get());\n+\n+        fakeClientCommunication();\n+\n+        Assert.assertEquals(\"Invalid item count reported\", 2,\n+                itemCount.get());\n+\n+        dataView.setItemCountEstimate(300);\n+\n+        Assert.assertEquals(\"Invalid item count reported\", 2, itemCount.get());\n+\n+        fakeClientCommunication();\n+\n+        Assert.assertEquals(\"Invalid item count reported\", 300,\n+                itemCount.get());\n+    }\n+\n     @Test\n     public void getItems_withDefinedSize() {\n         dataCommunicator.setRequestedRange(0, 50);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgzODkxNw==", "url": "https://github.com/vaadin/flow/pull/8662#discussion_r447838917", "bodyText": "You should refactor this instead to use ItemCountChangeListener to verify the correct size", "author": "pleku", "createdAt": "2020-06-30T16:59:01Z", "path": "flow-data/src/test/java/com/vaadin/flow/data/provider/AbstractLazyDataViewTest.java", "diffHunk": "@@ -160,57 +160,6 @@ public void contains_itemsNotFetched_canCheckForItemWithBeforeClientResponse() {\n                 capturedContains.get());\n     }\n \n-    @Test\n-    public void size_withDefinedSize() {\n-        dataCommunicator.setRequestedRange(0, 50);\n-        Assert.assertEquals(\"Invalid size reported\", 3, dataView.getSize());\n-\n-        dataView.setRowCountCallback(query -> 5);\n-\n-        Assert.assertEquals(\"Invalid size reported\", 5, dataView.getSize());\n-    }\n-\n-    @Test\n-    public void size_withUndefinedSize() {", "originalCommit": "dff3421e97f889d4b415351ae7a6f3b047f9dec1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIxNDc2MA==", "url": "https://github.com/vaadin/flow/pull/8662#discussion_r448214760", "bodyText": "done", "author": "mshabarov", "createdAt": "2020-07-01T08:49:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgzODkxNw=="}], "type": "inlineReview", "revised_code": {"commit": "44bb49b24765b127cc5d29d48d53191b772f5f7b", "chunk": "diff --git a/flow-data/src/test/java/com/vaadin/flow/data/provider/AbstractLazyDataViewTest.java b/flow-data/src/test/java/com/vaadin/flow/data/provider/AbstractLazyDataViewTest.java\nindex f8fd0010bf..98e9f78207 100644\n--- a/flow-data/src/test/java/com/vaadin/flow/data/provider/AbstractLazyDataViewTest.java\n+++ b/flow-data/src/test/java/com/vaadin/flow/data/provider/AbstractLazyDataViewTest.java\n\n@@ -160,6 +160,73 @@ public class AbstractLazyDataViewTest {\n                 capturedContains.get());\n     }\n \n+    @Test\n+    public void itemCount_definedItemCount() {\n+        final AtomicInteger itemCount = new AtomicInteger(0);\n+        dataView.addItemCountChangeListener(\n+                event -> itemCount.set(event.getItemCount()));\n+        dataCommunicator.setRequestedRange(0, 50);\n+\n+        Assert.assertEquals(\"Invalid item count reported\", 0, itemCount.get());\n+\n+        fakeClientCommunication();\n+\n+        Assert.assertEquals(\"Invalid item count reported\", 3, itemCount.get());\n+\n+        dataView.setItemCountCallback(query -> 2);\n+\n+        fakeClientCommunication();\n+\n+        Assert.assertEquals(\"Invalid item count reported\", 2, itemCount.get());\n+    }\n+\n+    @Test\n+    public void itemCount_undefinedItemCount() {\n+        final AtomicInteger itemCount = new AtomicInteger(0);\n+        dataView.addItemCountChangeListener(\n+                event -> itemCount.set(event.getItemCount()));\n+        dataCommunicator.setRequestedRange(0, 50);\n+        dataView.setItemCountUnknown();\n+\n+        Assert.assertEquals(\"Invalid item count reported\", 0, itemCount.get());\n+\n+        fakeClientCommunication();\n+\n+        Assert.assertEquals(\"Invalid item count reported\", 3, itemCount.get());\n+\n+        dataView.setItemCountEstimate(500);\n+\n+        // since the size was \"locked\", there is no estimate\n+        Assert.assertEquals(\"Invalid item count reported\", 3, itemCount.get());\n+\n+        fakeClientCommunication();\n+\n+        Assert.assertEquals(\"Invalid item count reported\", 3, itemCount.get());\n+\n+        // setting new data provider triggers new size from data provider\n+        dataCommunicator.setDataProvider(DataProvider.fromCallbacks(query -> {\n+            query.getOffset();\n+            return Stream.generate(String::new).limit(query.getLimit());\n+        }, query -> 2), null);\n+\n+        Assert.assertEquals(\"Invalid item count reported\", 3,\n+                itemCount.get());\n+\n+        fakeClientCommunication();\n+\n+        Assert.assertEquals(\"Invalid item count reported\", 2,\n+                itemCount.get());\n+\n+        dataView.setItemCountEstimate(300);\n+\n+        Assert.assertEquals(\"Invalid item count reported\", 2, itemCount.get());\n+\n+        fakeClientCommunication();\n+\n+        Assert.assertEquals(\"Invalid item count reported\", 300,\n+                itemCount.get());\n+    }\n+\n     @Test\n     public void getItems_withDefinedSize() {\n         dataCommunicator.setRequestedRange(0, 50);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg0MzA2MQ==", "url": "https://github.com/vaadin/flow/pull/8662#discussion_r447843061", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void setSizeCallback_itemCountEstimatesWereSet_overridesItemCountEstimates() {\n          \n          \n            \n                public void setCountCallback_itemCountEstimatesWereSet_overridesItemCountEstimates() {", "author": "pleku", "createdAt": "2020-06-30T17:05:23Z", "path": "flow-data/src/test/java/com/vaadin/flow/data/provider/DataCommunicatorTest.java", "diffHunk": "@@ -393,23 +393,23 @@ public void setSizeCallback_null_throws() {\n     }\n \n     @Test\n-    public void setSizeCallback_rowCountEstimatesWereSet_overridesRowCountEstimates() {\n+    public void setSizeCallback_itemCountEstimatesWereSet_overridesItemCountEstimates() {", "originalCommit": "dff3421e97f889d4b415351ae7a6f3b047f9dec1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIxNDgxNA==", "url": "https://github.com/vaadin/flow/pull/8662#discussion_r448214814", "bodyText": "done", "author": "mshabarov", "createdAt": "2020-07-01T08:49:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg0MzA2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "44bb49b24765b127cc5d29d48d53191b772f5f7b", "chunk": "diff --git a/flow-data/src/test/java/com/vaadin/flow/data/provider/DataCommunicatorTest.java b/flow-data/src/test/java/com/vaadin/flow/data/provider/DataCommunicatorTest.java\nindex b80170ff2c..d733d9fdaf 100644\n--- a/flow-data/src/test/java/com/vaadin/flow/data/provider/DataCommunicatorTest.java\n+++ b/flow-data/src/test/java/com/vaadin/flow/data/provider/DataCommunicatorTest.java\n\n@@ -393,7 +393,7 @@ public class DataCommunicatorTest {\n     }\n \n     @Test\n-    public void setSizeCallback_itemCountEstimatesWereSet_overridesItemCountEstimates() {\n+    public void setCountCallback_itemCountEstimatesWereSet_overridesItemCountEstimates() {\n         AbstractDataProvider<Item, Object> dataProvider = createDataProvider(\n                 5000);\n         dataProvider = Mockito.spy(dataProvider);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg0NDM3NA==", "url": "https://github.com/vaadin/flow/pull/8662#discussion_r447844374", "bodyText": "Tests names in this class could refer to CountEstimate too instead of sizeEstimate", "author": "pleku", "createdAt": "2020-06-30T17:07:00Z", "path": "flow-data/src/test/java/com/vaadin/flow/data/provider/DataCommunicatorTest.java", "diffHunk": "@@ -438,7 +438,7 @@ public void setInitialSizeEstimate_usedInitiallyThenDiscarded() {\n         dataCommunicator.setDataProvider(dataProvider, null);", "originalCommit": "dff3421e97f889d4b415351ae7a6f3b047f9dec1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIxNDg2NQ==", "url": "https://github.com/vaadin/flow/pull/8662#discussion_r448214865", "bodyText": "done", "author": "mshabarov", "createdAt": "2020-07-01T08:49:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg0NDM3NA=="}], "type": "inlineReview", "revised_code": {"commit": "44bb49b24765b127cc5d29d48d53191b772f5f7b", "chunk": "diff --git a/flow-data/src/test/java/com/vaadin/flow/data/provider/DataCommunicatorTest.java b/flow-data/src/test/java/com/vaadin/flow/data/provider/DataCommunicatorTest.java\nindex b80170ff2c..d733d9fdaf 100644\n--- a/flow-data/src/test/java/com/vaadin/flow/data/provider/DataCommunicatorTest.java\n+++ b/flow-data/src/test/java/com/vaadin/flow/data/provider/DataCommunicatorTest.java\n\n@@ -427,25 +427,25 @@ public class DataCommunicatorTest {\n         Assert.assertTrue(\"SizeCallback not called\",\n                 sizeCallbackCall.getAndSet(false));\n         Assert.assertEquals(\"Size not used\", exactSize,\n-                dataCommunicator.getDataSize());\n+                dataCommunicator.getItemCount());\n     }\n \n     @Test\n-    public void setInitialSizeEstimate_usedInitiallyThenDiscarded() {\n+    public void setInitialCountEstimate_usedInitiallyThenDiscarded() {\n         AbstractDataProvider<Item, Object> dataProvider = createDataProvider(\n                 250);\n         dataProvider = Mockito.spy(dataProvider);\n         dataCommunicator.setDataProvider(dataProvider, null);\n \n-        final int initialSizeEstimate = 100;\n-        dataCommunicator.setItemCountEstimate(initialSizeEstimate);\n+        final int initialCountEstimate = 100;\n+        dataCommunicator.setItemCountEstimate(initialCountEstimate);\n         dataCommunicator.setRequestedRange(0, 50);\n         Assert.assertFalse(dataCommunicator.isDefinedSize());\n \n         fakeClientCommunication();\n \n         Assert.assertEquals(\"initial size estimate not used\",\n-                initialSizeEstimate, dataCommunicator.getDataSize());\n+                initialCountEstimate, dataCommunicator.getItemCount());\n         Mockito.verify(dataProvider, Mockito.times(0)).size(Mockito.any());\n         Mockito.verify(dataProvider, Mockito.times(1)).fetch(Mockito.any());\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg0NTQxMA==", "url": "https://github.com/vaadin/flow/pull/8662#discussion_r447845410", "bodyText": "I would rename this method now too", "author": "pleku", "createdAt": "2020-06-30T17:08:33Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/DataCommunicator.java", "diffHunk": "@@ -782,21 +782,21 @@ private void flush() {\n     }\n \n     /**\n-     * Fire a size change event if the last event was fired for a different size\n-     * from the last sent one.\n+     * Fire a item count change event if the last event was fired for a\n+     * different size from the last sent one.\n      *\n-     * @param dataSize\n-     *            data size to send\n+     * @param itemCount\n+     *            data item count to send\n      */\n-    private void fireSizeEvent(int dataSize) {\n-        if (lastSent != dataSize) {\n+    private void fireSizeEvent(int itemCount) {", "originalCommit": "dff3421e97f889d4b415351ae7a6f3b047f9dec1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIxNDkxMQ==", "url": "https://github.com/vaadin/flow/pull/8662#discussion_r448214911", "bodyText": "done", "author": "mshabarov", "createdAt": "2020-07-01T08:49:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg0NTQxMA=="}], "type": "inlineReview", "revised_code": {"commit": "44bb49b24765b127cc5d29d48d53191b772f5f7b", "chunk": "diff --git a/flow-data/src/main/java/com/vaadin/flow/data/provider/DataCommunicator.java b/flow-data/src/main/java/com/vaadin/flow/data/provider/DataCommunicator.java\nindex fa3db5aef5..301f023f20 100644\n--- a/flow-data/src/main/java/com/vaadin/flow/data/provider/DataCommunicator.java\n+++ b/flow-data/src/main/java/com/vaadin/flow/data/provider/DataCommunicator.java\n\n@@ -778,17 +777,17 @@ public class DataCommunicator<T> implements Serializable {\n         // Phase 4: unregister passivated and updated items\n         unregisterPassivatedKeys();\n \n-        fireSizeEvent(assumedSize);\n+        fireItemCountEvent(assumedSize);\n     }\n \n     /**\n-     * Fire a item count change event if the last event was fired for a\n-     * different size from the last sent one.\n+     * Fire an item count change event if the last event was fired for a\n+     * different count from the last sent one.\n      *\n      * @param itemCount\n-     *            data item count to send\n+     *            item count to send\n      */\n-    private void fireSizeEvent(int itemCount) {\n+    private void fireItemCountEvent(int itemCount) {\n         if (lastSent != itemCount) {\n             final Optional<Component> component = Element.get(stateNode)\n                     .getComponent();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg0NTcxMQ==", "url": "https://github.com/vaadin/flow/pull/8662#discussion_r447845711", "bodyText": "The getDataSize method should be renamed too", "author": "pleku", "createdAt": "2020-06-30T17:09:07Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/DataCommunicator.java", "diffHunk": "@@ -397,79 +397,79 @@ public void setCountCallback(\n     }\n \n     /**\n-     * Sets the row count estimate to use and switches component to undefined\n+     * Sets the item count estimate to use and switches component to undefined\n      * size. Any previously set count callback is cleared. The new estimate is\n      * applied if the actual count has not been discovered and if the estimate\n      * is greater than the number of requested items. Otherwise it is not\n      * applied until there has been a reset.\n      * <p>\n-     * <em>NOTE:</em> setting row count estimate that is less than two pages\n+     * <em>NOTE:</em> setting item count estimate that is less than two pages\n      * (set with {@link #setPageSize(int)}) can cause extra requests initially\n      * or after a reset.\n      * \n-     * @param rowCountEstimate\n-     *            the row count estimate to be used\n+     * @param itemCountEstimate\n+     *            the item count estimate to be used\n      */\n-    public void setRowCountEstimate(int rowCountEstimate) {\n-        if (rowCountEstimate < 1) {\n+    public void setItemCountEstimate(int itemCountEstimate) {\n+        if (itemCountEstimate < 1) {\n             throw new IllegalArgumentException(\n-                    \"Given row count estimate cannot be less than 1.\");\n+                    \"Given item count estimate cannot be less than 1.\");\n         }\n-        this.rowCountEstimate = rowCountEstimate;\n+        this.itemCountEstimate = itemCountEstimate;\n         this.countCallback = null;\n         definedSize = false;\n         if (!skipSizeCheckUntilReset\n-                && requestedRange.getEnd() < rowCountEstimate) {\n+                && requestedRange.getEnd() < itemCountEstimate) {\n             sizeReset = true;\n             requestFlush();\n         }\n     }\n ", "originalCommit": "dff3421e97f889d4b415351ae7a6f3b047f9dec1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIxNDk3NQ==", "url": "https://github.com/vaadin/flow/pull/8662#discussion_r448214975", "bodyText": "done", "author": "mshabarov", "createdAt": "2020-07-01T08:49:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg0NTcxMQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "44bb49b24765b127cc5d29d48d53191b772f5f7b", "url": "https://github.com/vaadin/flow/commit/44bb49b24765b127cc5d29d48d53191b772f5f7b", "message": "Fix naming and refactor the tests", "committedDate": "2020-07-01T08:14:01Z", "type": "commit"}, {"oid": "a740e5b8a5bc676a79c1b024bcc7173d43d4d85f", "url": "https://github.com/vaadin/flow/commit/a740e5b8a5bc676a79c1b024bcc7173d43d4d85f", "message": "Improve item count change event javadoc", "committedDate": "2020-07-01T08:43:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIyNDE1OQ==", "url": "https://github.com/vaadin/flow/pull/8662#discussion_r448224159", "bodyText": "Complete the task associated to this TODO comment.", "author": "vaadin-bot", "createdAt": "2020-07-01T09:05:29Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/DataCommunicator.java", "diffHunk": "@@ -284,12 +284,12 @@ public void confirmUpdate(int updateId) {\n     }\n \n     /**\n-     * This is the latest DataProvider size informed to the client or fetched\n-     * from the DataProvider if client data has not been sent.\n+     * This is the latest DataProvider item count informed to the client or\n+     * fetched from the DataProvider if client data has not been sent.\n      *\n-     * @return size of available data\n+     * @return count of available items\n      */\n-    public int getDataSize() {\n+    public int getItemCount() {\n         if (isDefinedSize()\n                 && (resendEntireRange || assumeEmptyClient || sizeReset)) {\n             // TODO it could be possible to cache the value returned here", "originalCommit": "a740e5b8a5bc676a79c1b024bcc7173d43d4d85f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}