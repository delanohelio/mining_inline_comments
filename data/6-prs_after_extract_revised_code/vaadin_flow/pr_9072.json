{"pr_number": 9072, "pr_title": "fix: fail access check when no csrf token in session", "pr_createdAt": "2020-09-28T23:05:15Z", "pr_url": "https://github.com/vaadin/flow/pull/9072", "timeline": [{"oid": "3e972df0feeb89a18314333384ec54807352d244", "url": "https://github.com/vaadin/flow/commit/3e972df0feeb89a18314333384ec54807352d244", "message": "fix: fail access check when no csrf token in session", "committedDate": "2020-09-28T23:04:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY4OTQ1MQ==", "url": "https://github.com/vaadin/flow/pull/9072#discussion_r496689451", "bodyText": "This fails requests with a token header when there is no session. Any reasons behind it?\nIMO it would read more logical if in case of empty session we return early before checking the header:\nHttpSession session = request.getSession(false);\nif (session == null) {\n  return false;\n}\n\nString csrfToken = (String) request.getSession();\nreturn csrfToken == null || !csrfToken.equals(request.getHeader(\"X-CSRF-Token\"));", "author": "platosha", "createdAt": "2020-09-29T12:50:16Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/connect/auth/VaadinConnectAccessChecker.java", "diffHunk": "@@ -138,9 +139,14 @@ private boolean requestForbidden(HttpServletRequest request) {\n         if (!xsrfProtectionEnabled) {\n             return false;\n         }\n-        String csrfToken = (String) request.getSession()\n-                .getAttribute(VaadinService.getCsrfTokenAttributeName());\n-        return csrfToken != null && !csrfToken.equals(request.getHeader(\"X-CSRF-Token\"));\n+        HttpSession session = request.getSession(false);\n+        String csrfTokenInHeader = request.getHeader(\"X-CSRF-Token\");\n+        if (session == null) {\n+            return csrfTokenInHeader != null;", "originalCommit": "3e972df0feeb89a18314333384ec54807352d244", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY5NjIxNw==", "url": "https://github.com/vaadin/flow/pull/9072#discussion_r496696217", "bodyText": "This fails requests with a token header when there is no session. Any reasons behind it?\n\nIsn't this exactly the case that the session has expired, and a cached request is being submitted (with an outdated csrf token)?\nit could be fine when there is no csrf token in the request header, e.g. using curl.", "author": "haijian-vaadin", "createdAt": "2020-09-29T13:00:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY4OTQ1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzI4ODYyMQ==", "url": "https://github.com/vaadin/flow/pull/9072#discussion_r497288621", "bodyText": "If the session has expired, it should fail elsewhere in isLoggedIn kind of check.", "author": "platosha", "createdAt": "2020-09-30T07:11:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY4OTQ1MQ=="}], "type": "inlineReview", "revised_code": {"commit": "6ea0699ddfba2f08b1a15690a516546c5c0cf2a0", "chunk": "diff --git a/flow-server/src/main/java/com/vaadin/flow/server/connect/auth/VaadinConnectAccessChecker.java b/flow-server/src/main/java/com/vaadin/flow/server/connect/auth/VaadinConnectAccessChecker.java\nindex d91c18470a..38b1f01ca3 100644\n--- a/flow-server/src/main/java/com/vaadin/flow/server/connect/auth/VaadinConnectAccessChecker.java\n+++ b/flow-server/src/main/java/com/vaadin/flow/server/connect/auth/VaadinConnectAccessChecker.java\n\n@@ -139,14 +139,14 @@ public class VaadinConnectAccessChecker {\n         if (!xsrfProtectionEnabled) {\n             return false;\n         }\n+\n         HttpSession session = request.getSession(false);\n-        String csrfTokenInHeader = request.getHeader(\"X-CSRF-Token\");\n         if (session == null) {\n-            return csrfTokenInHeader != null;\n-        } else {\n-            String csrfTokenInSession = (String) session.getAttribute(VaadinService.getCsrfTokenAttributeName());\n-            return csrfTokenInSession == null || !csrfTokenInSession.equals(csrfTokenInHeader);\n+            return false;\n         }\n+\n+        String csrfTokenInSession = (String) session.getAttribute(VaadinService.getCsrfTokenAttributeName());\n+        return csrfTokenInSession == null || !csrfTokenInSession.equals(request.getHeader(\"X-CSRF-Token\"));\n     }\n \n     private boolean entityForbidden(AnnotatedElement entity,\n"}}, {"oid": "6ea0699ddfba2f08b1a15690a516546c5c0cf2a0", "url": "https://github.com/vaadin/flow/commit/6ea0699ddfba2f08b1a15690a516546c5c0cf2a0", "message": "apply code review suggestion", "committedDate": "2020-09-30T11:51:11Z", "type": "commit"}]}