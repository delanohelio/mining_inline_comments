{"pr_number": 9729, "pr_title": "fix: lookup for all available Executor services instead of only one", "pr_createdAt": "2020-12-30T06:48:54Z", "pr_url": "https://github.com/vaadin/flow/pull/9729", "timeline": [{"oid": "34e92aa4f4c02e165476dbb6cac1e8912dd33458", "url": "https://github.com/vaadin/flow/commit/34e92aa4f4c02e165476dbb6cac1e8912dd33458", "message": "fix: lookup for all available Executor services instead of only one", "committedDate": "2020-12-30T06:48:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTk5NTc4NQ==", "url": "https://github.com/vaadin/flow/pull/9729#discussion_r549995785", "bodyText": "A \"NullPointerException\" could be thrown; \"lookup\" is nullable here.", "author": "vaadin-bot", "createdAt": "2020-12-30T07:42:31Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/startup/DevModeInitializer.java", "diffHunk": "@@ -359,7 +359,8 @@ public static void initDevModeHandler(Set<Class<?>> classes,\n                 .withHomeNodeExecRequired(useHomeNodeExec).build();\n \n         // Check whether executor is provided by the caller (framework)\n-        Executor service = lookup.lookup(Executor.class);\n+        Executor service = lookup.lookupAll(Executor.class).stream().findFirst()", "originalCommit": "34e92aa4f4c02e165476dbb6cac1e8912dd33458", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d055705479fc0c633eb7679117ad17ec77a17c8d", "chunk": "diff --git a/flow-server/src/main/java/com/vaadin/flow/server/startup/DevModeInitializer.java b/flow-server/src/main/java/com/vaadin/flow/server/startup/DevModeInitializer.java\nindex e470215131..a554c7a155 100644\n--- a/flow-server/src/main/java/com/vaadin/flow/server/startup/DevModeInitializer.java\n+++ b/flow-server/src/main/java/com/vaadin/flow/server/startup/DevModeInitializer.java\n\n@@ -358,7 +358,12 @@ public class DevModeInitializer\n                 .withEmbeddableWebComponents(true).enablePnpm(enablePnpm)\n                 .withHomeNodeExecRequired(useHomeNodeExec).build();\n \n-        // Check whether executor is provided by the caller (framework)\n+        /*\n+         * Check whether executor is provided by the caller (framework). It\n+         * doesn't matter which Executor to use: any is fine. The main reason to\n+         * use managed executor is to stop the execution when the framework\n+         * stops.\n+         */\n         Executor service = lookup.lookupAll(Executor.class).stream().findFirst()\n                 .orElse(null);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDAyNDcyOA==", "url": "https://github.com/vaadin/flow/pull/9729#discussion_r550024728", "bodyText": "Even if all executors are looked up, only any first one is used. So, what is the meaning of using lookupAll in place of lookup?\nIt's totally clear when it used as below:\nCollection<InstantiatorFactory> factories = lookup.lookupAll(InstantiatorFactory.class);\nfor (InstantiatorFactory factory : factories) { ... }\nI propose to add some explanatory comment.", "author": "mshabarov", "createdAt": "2020-12-30T08:21:32Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/DevModeHandler.java", "diffHunk": "@@ -149,7 +149,8 @@ private DevModeHandler(Lookup lookup, int runningPort, File npmFolder,\n         devServerPortFile = getDevServerPortFile(npmFolder);\n \n         // Check whether executor is provided by the caller (framework)\n-        Executor service = lookup.lookup(Executor.class);\n+        Executor service = lookup.lookupAll(Executor.class).stream().findFirst()", "originalCommit": "34e92aa4f4c02e165476dbb6cac1e8912dd33458", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDAzNTA3Mg==", "url": "https://github.com/vaadin/flow/pull/9729#discussion_r550035072", "bodyText": "done", "author": "denis-anisimov", "createdAt": "2020-12-30T08:35:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDAyNDcyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDA0MDA2OQ==", "url": "https://github.com/vaadin/flow/pull/9729#discussion_r550040069", "bodyText": "Okay, as far as I understand the contract of Lookup is that lookup is supposed to return only one service impl. Thus, if we are expect there might be several executors here, then it makes sense.", "author": "mshabarov", "createdAt": "2020-12-30T08:41:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDAyNDcyOA=="}], "type": "inlineReview", "revised_code": {"commit": "d055705479fc0c633eb7679117ad17ec77a17c8d", "chunk": "diff --git a/flow-server/src/main/java/com/vaadin/flow/server/DevModeHandler.java b/flow-server/src/main/java/com/vaadin/flow/server/DevModeHandler.java\nindex 376a863c29..c90171e040 100644\n--- a/flow-server/src/main/java/com/vaadin/flow/server/DevModeHandler.java\n+++ b/flow-server/src/main/java/com/vaadin/flow/server/DevModeHandler.java\n\n@@ -148,7 +148,12 @@ public final class DevModeHandler implements RequestHandler {\n         reuseDevServer = config.reuseDevServer();\n         devServerPortFile = getDevServerPortFile(npmFolder);\n \n-        // Check whether executor is provided by the caller (framework)\n+        /*\n+         * Check whether executor is provided by the caller (framework). It\n+         * doesn't matter which Executor to use: any is fine. The main reason to\n+         * use managed executor is to stop the execution when the framework\n+         * stops.\n+         */\n         Executor service = lookup.lookupAll(Executor.class).stream().findFirst()\n                 .orElse(null);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDAyNjI5NQ==", "url": "https://github.com/vaadin/flow/pull/9729#discussion_r550026295", "bodyText": "Is that change for further features/bugfixes? Does it require to be covered by unit test, or it anyway will be covered in other PRs?", "author": "mshabarov", "createdAt": "2020-12-30T08:23:35Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/DevModeHandler.java", "diffHunk": "@@ -149,7 +149,8 @@ private DevModeHandler(Lookup lookup, int runningPort, File npmFolder,\n         devServerPortFile = getDevServerPortFile(npmFolder);\n \n         // Check whether executor is provided by the caller (framework)\n-        Executor service = lookup.lookup(Executor.class);\n+        Executor service = lookup.lookupAll(Executor.class).stream().findFirst()\n+                .orElse(null);", "originalCommit": "34e92aa4f4c02e165476dbb6cac1e8912dd33458", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDAzMjA0MA==", "url": "https://github.com/vaadin/flow/pull/9729#discussion_r550032040", "bodyText": "Since there is no unit test for lookup.lookup  there is no \"replacement\" for it.\nAll DevModeHandler  functionality is too hard to test: the design is very bad.\nI'm not going to add any unit tests here.", "author": "denis-anisimov", "createdAt": "2020-12-30T08:31:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDAyNjI5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "d055705479fc0c633eb7679117ad17ec77a17c8d", "chunk": "diff --git a/flow-server/src/main/java/com/vaadin/flow/server/DevModeHandler.java b/flow-server/src/main/java/com/vaadin/flow/server/DevModeHandler.java\nindex 376a863c29..c90171e040 100644\n--- a/flow-server/src/main/java/com/vaadin/flow/server/DevModeHandler.java\n+++ b/flow-server/src/main/java/com/vaadin/flow/server/DevModeHandler.java\n\n@@ -148,7 +148,12 @@ public final class DevModeHandler implements RequestHandler {\n         reuseDevServer = config.reuseDevServer();\n         devServerPortFile = getDevServerPortFile(npmFolder);\n \n-        // Check whether executor is provided by the caller (framework)\n+        /*\n+         * Check whether executor is provided by the caller (framework). It\n+         * doesn't matter which Executor to use: any is fine. The main reason to\n+         * use managed executor is to stop the execution when the framework\n+         * stops.\n+         */\n         Executor service = lookup.lookupAll(Executor.class).stream().findFirst()\n                 .orElse(null);\n \n"}}, {"oid": "d055705479fc0c633eb7679117ad17ec77a17c8d", "url": "https://github.com/vaadin/flow/commit/d055705479fc0c633eb7679117ad17ec77a17c8d", "message": "fix: add comment", "committedDate": "2020-12-30T08:34:17Z", "type": "commit"}]}