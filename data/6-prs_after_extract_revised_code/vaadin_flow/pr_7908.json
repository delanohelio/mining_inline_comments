{"pr_number": 7908, "pr_title": "Show a notification in the UI after live reload happened (#7820)", "pr_createdAt": "2020-03-26T17:19:10Z", "pr_url": "https://github.com/vaadin/flow/pull/7908", "timeline": [{"oid": "c35204735f00ec49c1715a81c622a9d24eb241ef", "url": "https://github.com/vaadin/flow/commit/c35204735f00ec49c1715a81c622a9d24eb241ef", "message": "Implement notification methods", "committedDate": "2020-03-26T16:41:40Z", "type": "commit"}, {"oid": "93147e3b7c2f6862bb2601972531d6bb43b3907e", "url": "https://github.com/vaadin/flow/commit/93147e3b7c2f6862bb2601972531d6bb43b3907e", "message": "Fix disable not working\n\nFix disable not working because of assertion error when the notification is never rendered", "committedDate": "2020-03-26T17:07:03Z", "type": "commit"}, {"oid": "5030b0d05521ea12cc4a882805053a363aaf7f00", "url": "https://github.com/vaadin/flow/commit/5030b0d05521ea12cc4a882805053a363aaf7f00", "message": "Change timestamp message and leading zeroes\n\nChange timestamp message to explicitly say that the time presented is the time of the last automatic reload.\nCreate method buildStringWith2LeadingZeroes() in order to present the reload timestamp in a standard fashion.", "committedDate": "2020-03-26T23:32:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk1Njc0MA==", "url": "https://github.com/vaadin/flow/pull/7908#discussion_r398956740", "bodyText": "Remove this use of \"getMinutes\"; it is deprecated.", "author": "vaadin-bot", "createdAt": "2020-03-26T23:44:42Z", "path": "flow-client/src/main/java/com/vaadin/client/LiveReload.java", "diffHunk": "@@ -187,6 +195,40 @@ private Element getOrCreateIndicator() {\n         return reloadIndicator;\n     }\n \n+    private Element getOrCreateReloadNotification() {\n+        Element reloadNotificationElement = Browser.getDocument()\n+                .getElementById(\"vaadin-live-reload-notification\");\n+        if (reloadNotificationElement == null) {\n+            reloadNotificationElement = Browser.getDocument()\n+                    .createElement(\"div\");\n+            reloadNotificationElement.setId(\"vaadin-live-reload-notification\");\n+            Element message = Browser.getDocument().createElement(\"span\");\n+            message.setId(\"vaadin-live-reload-timestamp\");\n+            message.setInnerText(LAST_RELOAD_TEXT + getLastReloadInStorage());\n+            reloadNotificationElement.appendChild(message);\n+            Element liveReloadOverlay = Browser.getDocument()\n+                    .getElementById(\"vaadin-live-reload-overlay\");\n+            liveReloadOverlay.appendChild(reloadNotificationElement);\n+        } else {\n+            Element message = Browser.getDocument()\n+                    .getElementById(\"vaadin-live-reload-timestamp\");\n+            message.setInnerText(LAST_RELOAD_TEXT + getLastReloadInStorage());\n+        }\n+        return reloadNotificationElement;\n+    }\n+\n+    private void saveLastReloadInStorage(Date date) {\n+\n+        StorageUtil.setSessionItem(LAST_RELOAD_KEY_IN_STORAGE,\n+                buildStringWith2LeadingZeroes(date.getHours()) + \":\"\n+                        + buildStringWith2LeadingZeroes(date.getMinutes()) + \":\"", "originalCommit": "5030b0d05521ea12cc4a882805053a363aaf7f00", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "469b690a5ec879239103e4b52e0ea66f144501dd", "chunk": "diff --git a/flow-client/src/main/java/com/vaadin/client/LiveReload.java b/flow-client/src/main/java/com/vaadin/client/LiveReload.java\nindex e2324d60f9..88ff178aeb 100644\n--- a/flow-client/src/main/java/com/vaadin/client/LiveReload.java\n+++ b/flow-client/src/main/java/com/vaadin/client/LiveReload.java\n\n@@ -195,6 +210,13 @@ public class LiveReload {\n         return reloadIndicator;\n     }\n \n+    private void handleOnBodyFocusEvent(Event evt) {\n+        if (lastReloadNotification != null && !lastReloadNotification\n+                .isHidden()) {\n+            lastReloadNotification.setHidden(true);\n+        }\n+    }\n+\n     private Element getOrCreateReloadNotification() {\n         Element reloadNotificationElement = Browser.getDocument()\n                 .getElementById(\"vaadin-live-reload-notification\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk1Njc0NA==", "url": "https://github.com/vaadin/flow/pull/7908#discussion_r398956744", "bodyText": "Remove this use of \"getSeconds\"; it is deprecated.", "author": "vaadin-bot", "createdAt": "2020-03-26T23:44:42Z", "path": "flow-client/src/main/java/com/vaadin/client/LiveReload.java", "diffHunk": "@@ -187,6 +195,40 @@ private Element getOrCreateIndicator() {\n         return reloadIndicator;\n     }\n \n+    private Element getOrCreateReloadNotification() {\n+        Element reloadNotificationElement = Browser.getDocument()\n+                .getElementById(\"vaadin-live-reload-notification\");\n+        if (reloadNotificationElement == null) {\n+            reloadNotificationElement = Browser.getDocument()\n+                    .createElement(\"div\");\n+            reloadNotificationElement.setId(\"vaadin-live-reload-notification\");\n+            Element message = Browser.getDocument().createElement(\"span\");\n+            message.setId(\"vaadin-live-reload-timestamp\");\n+            message.setInnerText(LAST_RELOAD_TEXT + getLastReloadInStorage());\n+            reloadNotificationElement.appendChild(message);\n+            Element liveReloadOverlay = Browser.getDocument()\n+                    .getElementById(\"vaadin-live-reload-overlay\");\n+            liveReloadOverlay.appendChild(reloadNotificationElement);\n+        } else {\n+            Element message = Browser.getDocument()\n+                    .getElementById(\"vaadin-live-reload-timestamp\");\n+            message.setInnerText(LAST_RELOAD_TEXT + getLastReloadInStorage());\n+        }\n+        return reloadNotificationElement;\n+    }\n+\n+    private void saveLastReloadInStorage(Date date) {\n+\n+        StorageUtil.setSessionItem(LAST_RELOAD_KEY_IN_STORAGE,\n+                buildStringWith2LeadingZeroes(date.getHours()) + \":\"\n+                        + buildStringWith2LeadingZeroes(date.getMinutes()) + \":\"\n+                        + buildStringWith2LeadingZeroes(date.getSeconds()));", "originalCommit": "5030b0d05521ea12cc4a882805053a363aaf7f00", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "469b690a5ec879239103e4b52e0ea66f144501dd", "chunk": "diff --git a/flow-client/src/main/java/com/vaadin/client/LiveReload.java b/flow-client/src/main/java/com/vaadin/client/LiveReload.java\nindex e2324d60f9..88ff178aeb 100644\n--- a/flow-client/src/main/java/com/vaadin/client/LiveReload.java\n+++ b/flow-client/src/main/java/com/vaadin/client/LiveReload.java\n\n@@ -195,6 +210,13 @@ public class LiveReload {\n         return reloadIndicator;\n     }\n \n+    private void handleOnBodyFocusEvent(Event evt) {\n+        if (lastReloadNotification != null && !lastReloadNotification\n+                .isHidden()) {\n+            lastReloadNotification.setHidden(true);\n+        }\n+    }\n+\n     private Element getOrCreateReloadNotification() {\n         Element reloadNotificationElement = Browser.getDocument()\n                 .getElementById(\"vaadin-live-reload-notification\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk1Njc1NA==", "url": "https://github.com/vaadin/flow/pull/7908#discussion_r398956754", "bodyText": "Remove this use of \"getHours\"; it is deprecated.", "author": "vaadin-bot", "createdAt": "2020-03-26T23:44:43Z", "path": "flow-client/src/main/java/com/vaadin/client/LiveReload.java", "diffHunk": "@@ -187,6 +195,40 @@ private Element getOrCreateIndicator() {\n         return reloadIndicator;\n     }\n \n+    private Element getOrCreateReloadNotification() {\n+        Element reloadNotificationElement = Browser.getDocument()\n+                .getElementById(\"vaadin-live-reload-notification\");\n+        if (reloadNotificationElement == null) {\n+            reloadNotificationElement = Browser.getDocument()\n+                    .createElement(\"div\");\n+            reloadNotificationElement.setId(\"vaadin-live-reload-notification\");\n+            Element message = Browser.getDocument().createElement(\"span\");\n+            message.setId(\"vaadin-live-reload-timestamp\");\n+            message.setInnerText(LAST_RELOAD_TEXT + getLastReloadInStorage());\n+            reloadNotificationElement.appendChild(message);\n+            Element liveReloadOverlay = Browser.getDocument()\n+                    .getElementById(\"vaadin-live-reload-overlay\");\n+            liveReloadOverlay.appendChild(reloadNotificationElement);\n+        } else {\n+            Element message = Browser.getDocument()\n+                    .getElementById(\"vaadin-live-reload-timestamp\");\n+            message.setInnerText(LAST_RELOAD_TEXT + getLastReloadInStorage());\n+        }\n+        return reloadNotificationElement;\n+    }\n+\n+    private void saveLastReloadInStorage(Date date) {\n+\n+        StorageUtil.setSessionItem(LAST_RELOAD_KEY_IN_STORAGE,\n+                buildStringWith2LeadingZeroes(date.getHours()) + \":\"", "originalCommit": "5030b0d05521ea12cc4a882805053a363aaf7f00", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "469b690a5ec879239103e4b52e0ea66f144501dd", "chunk": "diff --git a/flow-client/src/main/java/com/vaadin/client/LiveReload.java b/flow-client/src/main/java/com/vaadin/client/LiveReload.java\nindex e2324d60f9..88ff178aeb 100644\n--- a/flow-client/src/main/java/com/vaadin/client/LiveReload.java\n+++ b/flow-client/src/main/java/com/vaadin/client/LiveReload.java\n\n@@ -195,6 +210,13 @@ public class LiveReload {\n         return reloadIndicator;\n     }\n \n+    private void handleOnBodyFocusEvent(Event evt) {\n+        if (lastReloadNotification != null && !lastReloadNotification\n+                .isHidden()) {\n+            lastReloadNotification.setHidden(true);\n+        }\n+    }\n+\n     private Element getOrCreateReloadNotification() {\n         Element reloadNotificationElement = Browser.getDocument()\n                 .getElementById(\"vaadin-live-reload-notification\");\n"}}, {"oid": "469b690a5ec879239103e4b52e0ea66f144501dd", "url": "https://github.com/vaadin/flow/commit/469b690a5ec879239103e4b52e0ea66f144501dd", "message": "Add LiveReload timestamp visible functionality\n\nAdd events and code to show reload timestamp when reloading and hiding it when the focus is on the page body. If the LiveReload overlay is open, then the timestamp should be also visible regardless of focus.", "committedDate": "2020-03-27T00:20:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3MDEyNg==", "url": "https://github.com/vaadin/flow/pull/7908#discussion_r398970126", "bodyText": "Remove this unused method parameter \"evt\".", "author": "vaadin-bot", "createdAt": "2020-03-27T00:29:11Z", "path": "flow-client/src/main/java/com/vaadin/client/LiveReload.java", "diffHunk": "@@ -136,6 +145,20 @@ private void showMessage(String msg) {\n         }\n     }\n \n+    private void handleOnIconClickEvent(Event evt) {", "originalCommit": "469b690a5ec879239103e4b52e0ea66f144501dd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "889ffacf4e77d0e106f4deabea217c30bcd6c911", "chunk": "diff --git a/flow-client/src/main/java/com/vaadin/client/LiveReload.java b/flow-client/src/main/java/com/vaadin/client/LiveReload.java\nindex 88ff178aeb..3714467d26 100644\n--- a/flow-client/src/main/java/com/vaadin/client/LiveReload.java\n+++ b/flow-client/src/main/java/com/vaadin/client/LiveReload.java\n\n@@ -149,7 +149,7 @@ public class LiveReload {\n         Element overlay = Browser.getDocument()\n                 .getElementById(\"vaadin-live-reload-overlay\");\n         overlay.setHidden(!overlay.isHidden());\n-        if (lastReloadNotification != null) {\n+        if (lastReloadNotification == null) {\n             return;\n         }\n         if (!overlay.isHidden()) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3MDEzMA==", "url": "https://github.com/vaadin/flow/pull/7908#discussion_r398970130", "bodyText": "Remove this unused method parameter \"evt\".", "author": "vaadin-bot", "createdAt": "2020-03-27T00:29:12Z", "path": "flow-client/src/main/java/com/vaadin/client/LiveReload.java", "diffHunk": "@@ -187,6 +210,47 @@ private Element getOrCreateIndicator() {\n         return reloadIndicator;\n     }\n \n+    private void handleOnBodyFocusEvent(Event evt) {", "originalCommit": "469b690a5ec879239103e4b52e0ea66f144501dd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2fc128131bfb248d3440df74ec27418c4b87a00f", "chunk": "diff --git a/flow-client/src/main/java/com/vaadin/client/LiveReload.java b/flow-client/src/main/java/com/vaadin/client/LiveReload.java\nindex 88ff178aeb..97329e11b5 100644\n--- a/flow-client/src/main/java/com/vaadin/client/LiveReload.java\n+++ b/flow-client/src/main/java/com/vaadin/client/LiveReload.java\n\n@@ -230,7 +230,7 @@ public class LiveReload {\n             reloadNotificationElement.appendChild(message);\n             indicator.appendChild(reloadNotificationElement);\n             Browser.getDocument().getBody()\n-                    .setOnfocus(this::handleOnBodyFocusEvent);\n+                    .setOnclick(this::handleOnBodyFocusEvent);\n         } else {\n             Element message = Browser.getDocument()\n                     .getElementById(\"vaadin-live-reload-timestamp\");\n"}}, {"oid": "889ffacf4e77d0e106f4deabea217c30bcd6c911", "url": "https://github.com/vaadin/flow/commit/889ffacf4e77d0e106f4deabea217c30bcd6c911", "message": "quickfix wrong logical operator", "committedDate": "2020-03-27T00:32:41Z", "type": "commit"}, {"oid": "5b0dbea7637ac5af61c0b55442b460b47001412b", "url": "https://github.com/vaadin/flow/commit/5b0dbea7637ac5af61c0b55442b460b47001412b", "message": "Test Live Reload Notification fuctionality\n\nThis is broken. Should be fixed.", "committedDate": "2020-03-30T07:39:12Z", "type": "commit"}, {"oid": "00a454af0acc8e583d531e689ee7fd7369864dac", "url": "https://github.com/vaadin/flow/commit/00a454af0acc8e583d531e689ee7fd7369864dac", "message": "Added live reload button to test view", "committedDate": "2020-03-31T07:33:19Z", "type": "commit"}, {"oid": "2fc128131bfb248d3440df74ec27418c4b87a00f", "url": "https://github.com/vaadin/flow/commit/2fc128131bfb248d3440df74ec27418c4b87a00f", "message": "Change LiveReload and IT tests\n\nHide LiveReload notification on click instead of on focus\nCorrect wrong checks on IT tests\nImplement trigger button click and wait for page render", "committedDate": "2020-03-31T08:49:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDkyMDkyNw==", "url": "https://github.com/vaadin/flow/pull/7908#discussion_r400920927", "bodyText": "Consider simplifying if-else clause this way:\nlastReloadNotification.setHidden(\noverlay.isHidden());", "author": "mshabarov", "createdAt": "2020-03-31T13:39:25Z", "path": "flow-client/src/main/java/com/vaadin/client/LiveReload.java", "diffHunk": "@@ -136,6 +145,20 @@ private void showMessage(String msg) {\n         }\n     }\n \n+    private void handleOnIconClickEvent(Event evt) {\n+        Element overlay = Browser.getDocument()\n+                .getElementById(\"vaadin-live-reload-overlay\");\n+        overlay.setHidden(!overlay.isHidden());\n+        if (lastReloadNotification == null) {\n+            return;\n+        }\n+        if (!overlay.isHidden()) {", "originalCommit": "2fc128131bfb248d3440df74ec27418c4b87a00f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}