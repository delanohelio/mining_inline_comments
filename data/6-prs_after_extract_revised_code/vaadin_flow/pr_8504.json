{"pr_number": 8504, "pr_title": "Always send and update innerHTML property value", "pr_createdAt": "2020-06-05T05:39:36Z", "pr_url": "https://github.com/vaadin/flow/pull/8504", "timeline": [{"oid": "456bf05acfc14d091cf9388dc494d0e74dadb742", "url": "https://github.com/vaadin/flow/commit/456bf05acfc14d091cf9388dc494d0e74dadb742", "message": "Run collect changes logic for features whose changes are not responded\n\n- In inactive state changes for features which are \"not important\" are\nnot sent to the client side.\n- But internal logic which updates the feature is still invoked which\nmakes change tracker collect undesired changes in case of update.\n- On the other hand the collection logic for such features doesn't do\nanything which kind of break the contract.\n- To be able to avoid broken contract the changes should be collected\nfor all features\n- For \"important\" features the collector should be applied as is.\n- For other feature the collector should be no-op.\n\n\nFixes #8235", "committedDate": "2020-06-05T08:16:06Z", "type": "commit"}, {"oid": "95d68e8bd9b8bf75ddc90b521a51c69a2609c260", "url": "https://github.com/vaadin/flow/commit/95d68e8bd9b8bf75ddc90b521a51c69a2609c260", "message": "Always send and apply update for innerHTML property\n\nFixes #8235", "committedDate": "2020-06-05T08:16:07Z", "type": "commit"}, {"oid": "8a497ebe5950bc641c31dc9594ed60c3e15200d6", "url": "https://github.com/vaadin/flow/commit/8a497ebe5950bc641c31dc9594ed60c3e15200d6", "message": "Add unit test for put change producing in ElementPropertyMap", "committedDate": "2020-06-05T08:16:07Z", "type": "commit"}, {"oid": "cc8c9df569526ec13e041a35ea97ceb7877b90a8", "url": "https://github.com/vaadin/flow/commit/cc8c9df569526ec13e041a35ea97ceb7877b90a8", "message": "Add unit test for \"internal API\" \"producePutChange\"", "committedDate": "2020-06-05T08:16:07Z", "type": "commit"}, {"oid": "17107632f54119e3dac7f9a342aef80f408217a6", "url": "https://github.com/vaadin/flow/commit/17107632f54119e3dac7f9a342aef80f408217a6", "message": "Add accidentially removed code back", "committedDate": "2020-06-05T08:16:08Z", "type": "commit"}, {"oid": "ce424de3a3950a466e512c089edeef31ae994c86", "url": "https://github.com/vaadin/flow/commit/ce424de3a3950a466e512c089edeef31ae994c86", "message": "temp", "committedDate": "2020-06-05T08:16:08Z", "type": "forcePushed"}, {"oid": "84f944193841ce1c47ca23362d6c5f4f679945c2", "url": "https://github.com/vaadin/flow/commit/84f944193841ce1c47ca23362d6c5f4f679945c2", "message": "Update values in the map even if the value is the same for specific\nproperties", "committedDate": "2020-06-05T09:22:26Z", "type": "commit"}, {"oid": "84f944193841ce1c47ca23362d6c5f4f679945c2", "url": "https://github.com/vaadin/flow/commit/84f944193841ce1c47ca23362d6c5f4f679945c2", "message": "Update values in the map even if the value is the same for specific\nproperties", "committedDate": "2020-06-05T09:22:26Z", "type": "forcePushed"}, {"oid": "3941c8afc60429af6dcd9f22ab60247f5e4e0e78", "url": "https://github.com/vaadin/flow/commit/3941c8afc60429af6dcd9f22ab60247f5e4e0e78", "message": "Add GWT unit tests", "committedDate": "2020-06-05T09:40:21Z", "type": "commit"}, {"oid": "3d20d44c071e134f8c7ffffc10f28ccf829470ee", "url": "https://github.com/vaadin/flow/commit/3d20d44c071e134f8c7ffffc10f28ccf829470ee", "message": "Add IT for the fix.", "committedDate": "2020-06-05T09:46:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQxNDczNA==", "url": "https://github.com/vaadin/flow/pull/8504#discussion_r437414734", "bodyText": "Could simplify the code removing the inner if. For instance:\nelse if (containsNow && producePutChange(key, containedEarlier, value)) {\n    Object currentValue = values.get(key);\n    // New or changed value\n    collector.accept(new MapPutChange(this, key, currentValue));\n    hasChanges = true;\n}", "author": "joheriks", "createdAt": "2020-06-09T13:26:06Z", "path": "flow-server/src/main/java/com/vaadin/flow/internal/nodefeature/NodeMap.java", "diffHunk": "@@ -421,7 +421,7 @@ public void collectChanges(Consumer<NodeChange> collector) {\n                 hasChanges = true;\n             } else if (containsNow) {", "originalCommit": "95d68e8bd9b8bf75ddc90b521a51c69a2609c260", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzk4NDY4OQ==", "url": "https://github.com/vaadin/flow/pull/8504#discussion_r437984689", "bodyText": "Done", "author": "denis-anisimov", "createdAt": "2020-06-10T09:22:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQxNDczNA=="}], "type": "inlineReview", "revised_code": {"commit": "7ade2301a4925540fa4d269495d253b3388dac28", "chunk": "diff --git a/flow-server/src/main/java/com/vaadin/flow/internal/nodefeature/NodeMap.java b/flow-server/src/main/java/com/vaadin/flow/internal/nodefeature/NodeMap.java\nindex 974e29feb4..06be7444b0 100644\n--- a/flow-server/src/main/java/com/vaadin/flow/internal/nodefeature/NodeMap.java\n+++ b/flow-server/src/main/java/com/vaadin/flow/internal/nodefeature/NodeMap.java\n\n@@ -419,13 +419,12 @@ public abstract class NodeMap extends NodeFeature {\n             if (containedEarlier && !containsNow) {\n                 collector.accept(new MapRemoveChange(this, key));\n                 hasChanges = true;\n-            } else if (containsNow) {\n+            } else if (containsNow\n+                    && producePutChange(key, containedEarlier, value)) {\n                 Object currentValue = values.get(key);\n-                if (producePutChange(key, containedEarlier, value)) {\n-                    // New or changed value\n-                    collector.accept(new MapPutChange(this, key, currentValue));\n-                    hasChanges = true;\n-                }\n+                // New or changed value\n+                collector.accept(new MapPutChange(this, key, currentValue));\n+                hasChanges = true;\n             }\n         }\n         if (!isPopulated) {\n"}}, {"oid": "7ade2301a4925540fa4d269495d253b3388dac28", "url": "https://github.com/vaadin/flow/commit/7ade2301a4925540fa4d269495d253b3388dac28", "message": "Improve the code", "committedDate": "2020-06-10T09:22:27Z", "type": "commit"}]}