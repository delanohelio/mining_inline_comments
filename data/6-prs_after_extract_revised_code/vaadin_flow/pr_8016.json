{"pr_number": 8016, "pr_title": "[Security Fix]Use Vaadin's own ObjectMapper instead of the one from Spring", "pr_createdAt": "2020-04-07T14:10:21Z", "pr_url": "https://github.com/vaadin/flow/pull/8016", "timeline": [{"oid": "4fa09257f228e98c451ede8e1959db7177d8c988", "url": "https://github.com/vaadin/flow/commit/4fa09257f228e98c451ede8e1959db7177d8c988", "message": "Use Vaadin's own Objectmapper instead of the one from Spring", "committedDate": "2020-04-07T14:08:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg1NTc2NA==", "url": "https://github.com/vaadin/flow/pull/8016#discussion_r404855764", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                ObjectMapper objectMapper(ApplicationContext context) {\n          \n          \n            \n                public ObjectMapper vaadinEndpointMapper(ApplicationContext context) {\n          \n      \n    \n    \n  \n\nChange method name to reflect the Bean that's going to be created.\nOptional/Personal opinion: I would wrap the ObjectMapper in an object VaadinConnectMapper#getObjectMapper and return VaadinConnectMapper here as Bean, so it's easy to differentiate between the normal ObjectMapper and the Object Vaadin is using internally.", "author": "knoobie", "createdAt": "2020-04-07T14:31:26Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/connect/VaadinConnectControllerConfiguration.java", "diffHunk": "@@ -137,4 +146,30 @@ public VaadinConnectAccessChecker accessChecker() {\n     public ExplicitNullableTypeChecker typeChecker() {\n         return new ExplicitNullableTypeChecker();\n     }\n+\n+    /**\n+     * Registers a {@link ObjectMapper} bean instance.\n+     *\n+     * @return the object mapper for endpoint.\n+     */\n+    @Bean\n+    @Qualifier(VAADIN_ENDPOINT_MAPPER_BEAN_QUALIFIER)\n+    ObjectMapper objectMapper(ApplicationContext context) {", "originalCommit": "4fa09257f228e98c451ede8e1959db7177d8c988", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "78dcf87b7cc52e1cbf5078ef9a6d1758b280f1dd", "chunk": "diff --git a/flow-server/src/main/java/com/vaadin/flow/server/connect/VaadinConnectControllerConfiguration.java b/flow-server/src/main/java/com/vaadin/flow/server/connect/VaadinConnectControllerConfiguration.java\nindex 9ace1295f5..af663bd15a 100644\n--- a/flow-server/src/main/java/com/vaadin/flow/server/connect/VaadinConnectControllerConfiguration.java\n+++ b/flow-server/src/main/java/com/vaadin/flow/server/connect/VaadinConnectControllerConfiguration.java\n\n@@ -154,22 +154,14 @@ public class VaadinConnectControllerConfiguration {\n      */\n     @Bean\n     @Qualifier(VAADIN_ENDPOINT_MAPPER_BEAN_QUALIFIER)\n-    ObjectMapper objectMapper(ApplicationContext context) {\n-        try {\n-            ObjectMapper objectMapper = new ObjectMapper();\n-            JacksonProperties jacksonProperties = context\n-                    .getBean(JacksonProperties.class);\n-            if (jacksonProperties.getVisibility().isEmpty()) {\n-                objectMapper.setVisibility(PropertyAccessor.ALL,\n-                        JsonAutoDetect.Visibility.ANY);\n-            }\n-            return objectMapper;\n-        } catch (Exception e) {\n-            throw new IllegalStateException(String.format(\n-                    \"Auto configured jackson object mapper is not found.\"\n-                            + \"Please define your own object mapper with '@Qualifier(%s)' or \"\n-                            + \"make sure that the auto configured jackson object mapper is available.\",\n-                    VAADIN_ENDPOINT_MAPPER_BEAN_QUALIFIER), e);\n+    ObjectMapper vaadinEndpointMapper(ApplicationContext context) {\n+        ObjectMapper objectMapper = new ObjectMapper();\n+        JacksonProperties jacksonProperties = context\n+                .getBean(JacksonProperties.class);\n+        if (jacksonProperties.getVisibility().isEmpty()) {\n+            objectMapper.setVisibility(PropertyAccessor.ALL,\n+                    JsonAutoDetect.Visibility.ANY);\n         }\n+        return objectMapper;\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg1NjA2Mg==", "url": "https://github.com/vaadin/flow/pull/8016#discussion_r404856062", "bodyText": "The whole try/catch could be removed?", "author": "knoobie", "createdAt": "2020-04-07T14:31:50Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/connect/VaadinConnectControllerConfiguration.java", "diffHunk": "@@ -137,4 +146,30 @@ public VaadinConnectAccessChecker accessChecker() {\n     public ExplicitNullableTypeChecker typeChecker() {\n         return new ExplicitNullableTypeChecker();\n     }\n+\n+    /**\n+     * Registers a {@link ObjectMapper} bean instance.\n+     *\n+     * @return the object mapper for endpoint.\n+     */\n+    @Bean\n+    @Qualifier(VAADIN_ENDPOINT_MAPPER_BEAN_QUALIFIER)\n+    ObjectMapper objectMapper(ApplicationContext context) {\n+        try {\n+            ObjectMapper objectMapper = new ObjectMapper();\n+            JacksonProperties jacksonProperties = context\n+                    .getBean(JacksonProperties.class);\n+            if (jacksonProperties.getVisibility().isEmpty()) {\n+                objectMapper.setVisibility(PropertyAccessor.ALL,\n+                        JsonAutoDetect.Visibility.ANY);\n+            }\n+            return objectMapper;\n+        } catch (Exception e) {\n+            throw new IllegalStateException(String.format(", "originalCommit": "4fa09257f228e98c451ede8e1959db7177d8c988", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "78dcf87b7cc52e1cbf5078ef9a6d1758b280f1dd", "chunk": "diff --git a/flow-server/src/main/java/com/vaadin/flow/server/connect/VaadinConnectControllerConfiguration.java b/flow-server/src/main/java/com/vaadin/flow/server/connect/VaadinConnectControllerConfiguration.java\nindex 9ace1295f5..af663bd15a 100644\n--- a/flow-server/src/main/java/com/vaadin/flow/server/connect/VaadinConnectControllerConfiguration.java\n+++ b/flow-server/src/main/java/com/vaadin/flow/server/connect/VaadinConnectControllerConfiguration.java\n\n@@ -154,22 +154,14 @@ public class VaadinConnectControllerConfiguration {\n      */\n     @Bean\n     @Qualifier(VAADIN_ENDPOINT_MAPPER_BEAN_QUALIFIER)\n-    ObjectMapper objectMapper(ApplicationContext context) {\n-        try {\n-            ObjectMapper objectMapper = new ObjectMapper();\n-            JacksonProperties jacksonProperties = context\n-                    .getBean(JacksonProperties.class);\n-            if (jacksonProperties.getVisibility().isEmpty()) {\n-                objectMapper.setVisibility(PropertyAccessor.ALL,\n-                        JsonAutoDetect.Visibility.ANY);\n-            }\n-            return objectMapper;\n-        } catch (Exception e) {\n-            throw new IllegalStateException(String.format(\n-                    \"Auto configured jackson object mapper is not found.\"\n-                            + \"Please define your own object mapper with '@Qualifier(%s)' or \"\n-                            + \"make sure that the auto configured jackson object mapper is available.\",\n-                    VAADIN_ENDPOINT_MAPPER_BEAN_QUALIFIER), e);\n+    ObjectMapper vaadinEndpointMapper(ApplicationContext context) {\n+        ObjectMapper objectMapper = new ObjectMapper();\n+        JacksonProperties jacksonProperties = context\n+                .getBean(JacksonProperties.class);\n+        if (jacksonProperties.getVisibility().isEmpty()) {\n+            objectMapper.setVisibility(PropertyAccessor.ALL,\n+                    JsonAutoDetect.Visibility.ANY);\n         }\n+        return objectMapper;\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg1NzIwOQ==", "url": "https://github.com/vaadin/flow/pull/8016#discussion_r404857209", "bodyText": "Autowired could be removed - every instance in the constructor is autowired.\nThis has to be updated, if my comment from above is accepted.", "author": "knoobie", "createdAt": "2020-04-07T14:33:28Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/connect/VaadinConnectController.java", "diffHunk": "@@ -136,15 +133,13 @@\n      *            The servlet context for the controller.\n      */\n     public VaadinConnectController(\n-            @Autowired(required = false) @Qualifier(VAADIN_ENDPOINT_MAPPER_BEAN_QUALIFIER) ObjectMapper vaadinEndpointMapper,\n+            @Autowired @Qualifier(VAADIN_ENDPOINT_MAPPER_BEAN_QUALIFIER) ObjectMapper vaadinEndpointMapper,", "originalCommit": "4fa09257f228e98c451ede8e1959db7177d8c988", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "78dcf87b7cc52e1cbf5078ef9a6d1758b280f1dd", "chunk": "diff --git a/flow-server/src/main/java/com/vaadin/flow/server/connect/VaadinConnectController.java b/flow-server/src/main/java/com/vaadin/flow/server/connect/VaadinConnectController.java\nindex 02e2527987..83930c6799 100644\n--- a/flow-server/src/main/java/com/vaadin/flow/server/connect/VaadinConnectController.java\n+++ b/flow-server/src/main/java/com/vaadin/flow/server/connect/VaadinConnectController.java\n\n@@ -133,7 +133,7 @@ public class VaadinConnectController {\n      *            The servlet context for the controller.\n      */\n     public VaadinConnectController(\n-            @Autowired @Qualifier(VAADIN_ENDPOINT_MAPPER_BEAN_QUALIFIER) ObjectMapper vaadinEndpointMapper,\n+            @Qualifier(VAADIN_ENDPOINT_MAPPER_BEAN_QUALIFIER) ObjectMapper vaadinEndpointMapper,\n             VaadinConnectAccessChecker accessChecker,\n             EndpointNameChecker endpointNameChecker,\n             ExplicitNullableTypeChecker explicitNullableTypeChecker,\n"}}, {"oid": "78dcf87b7cc52e1cbf5078ef9a6d1758b280f1dd", "url": "https://github.com/vaadin/flow/commit/78dcf87b7cc52e1cbf5078ef9a6d1758b280f1dd", "message": "fix connect controller tests", "committedDate": "2020-04-07T19:06:28Z", "type": "commit"}, {"oid": "52048910c9872d63925d6afeb1e9fffe2494e4bd", "url": "https://github.com/vaadin/flow/commit/52048910c9872d63925d6afeb1e9fffe2494e4bd", "message": "fix sonar issue", "committedDate": "2020-04-07T19:25:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTEzNzcwNQ==", "url": "https://github.com/vaadin/flow/pull/8016#discussion_r405137705", "bodyText": "Was thinking about this.. is this the right way to test it? I didn't have to time to look into VaadinConnect, so I'm not sure if this could break any existing usecases you wanted to handle.\nWhat I would expect from the test:\n\nAsking the ApplicationContext for two beans (normal ObjectMapper and the qualified ObjectMapper)\nNormal ObjectMapper should have all configuration provided by the user\nQualified ObjectMapper should have all configuration Vaadin needs to work\nBoth ObjectMapper serialize the same object.. depending on the configuration of the normal ObjectMapper both serialized strings should not look the same. (for example one could use Getter and the other properties for Serialization)\n\nOr am I missing something?", "author": "knoobie", "createdAt": "2020-04-07T21:57:23Z", "path": "flow-server/src/test/java/com/vaadin/flow/server/connect/VaadinConnectControllerConfigurationTest.java", "diffHunk": "@@ -0,0 +1,70 @@\n+package com.vaadin.flow.server.connect;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.fail;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.times;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+import java.util.Collections;\n+\n+import com.fasterxml.jackson.annotation.JsonAutoDetect;\n+import com.fasterxml.jackson.annotation.PropertyAccessor;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+\n+import org.junit.Test;\n+import org.springframework.boot.autoconfigure.jackson.JacksonProperties;\n+import org.springframework.context.ApplicationContext;\n+\n+public class VaadinConnectControllerConfigurationTest {\n+\n+    @Test\n+    public void should_NotOverrideVisibility_When_JacksonPropertiesProvideVisibility() {\n+        ApplicationContext contextMock = mock(ApplicationContext.class);\n+        VaadinEndpointProperties endpointPropertiesMock = mock(VaadinEndpointProperties.class);\n+        VaadinConnectControllerConfiguration configuration = new VaadinConnectControllerConfiguration(endpointPropertiesMock);\n+        \n+        JacksonProperties mockJacksonProperties = mock(JacksonProperties.class);\n+        when(contextMock.getBean(JacksonProperties.class))\n+                .thenReturn(mockJacksonProperties);\n+        when(mockJacksonProperties.getVisibility())\n+                .thenReturn(Collections.singletonMap(PropertyAccessor.ALL,\n+                        JsonAutoDetect.Visibility.PUBLIC_ONLY));\n+\n+        ObjectMapper objectMapper = configuration.vaadinEndpointMapper(contextMock);\n+\n+        verify(contextMock, times(1)).getBean(JacksonProperties.class);\n+\n+        try{\n+                String result = objectMapper.writeValueAsString(new Entity());\n+                assertEquals(\"{\\\"name\\\":\\\"Bond\\\"}\", result);", "originalCommit": "52048910c9872d63925d6afeb1e9fffe2494e4bd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "61d13fe5d7fde94df2acfc0bb3c03aa2aef4a31c", "chunk": "diff --git a/flow-server/src/test/java/com/vaadin/flow/server/connect/VaadinConnectControllerConfigurationTest.java b/flow-server/src/test/java/com/vaadin/flow/server/connect/VaadinConnectControllerConfigurationTest.java\nindex 0bd66a5063..90b8052d7b 100644\n--- a/flow-server/src/test/java/com/vaadin/flow/server/connect/VaadinConnectControllerConfigurationTest.java\n+++ b/flow-server/src/test/java/com/vaadin/flow/server/connect/VaadinConnectControllerConfigurationTest.java\n\n@@ -24,7 +24,7 @@ public class VaadinConnectControllerConfigurationTest {\n         ApplicationContext contextMock = mock(ApplicationContext.class);\n         VaadinEndpointProperties endpointPropertiesMock = mock(VaadinEndpointProperties.class);\n         VaadinConnectControllerConfiguration configuration = new VaadinConnectControllerConfiguration(endpointPropertiesMock);\n-        \n+\n         JacksonProperties mockJacksonProperties = mock(JacksonProperties.class);\n         when(contextMock.getBean(JacksonProperties.class))\n                 .thenReturn(mockJacksonProperties);\n"}}, {"oid": "498aa4588791acfc3f9d53f44a99b4489758f604", "url": "https://github.com/vaadin/flow/commit/498aa4588791acfc3f9d53f44a99b4489758f604", "message": "align modifier with other methods", "committedDate": "2020-04-08T06:05:18Z", "type": "commit"}, {"oid": "69da40162bab24c9f5cfca5a7ee1947599f75667", "url": "https://github.com/vaadin/flow/commit/69da40162bab24c9f5cfca5a7ee1947599f75667", "message": "fix sonar issues", "committedDate": "2020-04-08T07:00:57Z", "type": "commit"}, {"oid": "61d13fe5d7fde94df2acfc0bb3c03aa2aef4a31c", "url": "https://github.com/vaadin/flow/commit/61d13fe5d7fde94df2acfc0bb3c03aa2aef4a31c", "message": "fix formmating", "committedDate": "2020-04-08T08:55:42Z", "type": "commit"}, {"oid": "ecd77971152f992504a6bf87f9cc50385a8bb439", "url": "https://github.com/vaadin/flow/commit/ecd77971152f992504a6bf87f9cc50385a8bb439", "message": "fix formatting", "committedDate": "2020-04-08T08:58:49Z", "type": "commit"}, {"oid": "061a1f9dffd939910364a237db67c52f2fe0dff7", "url": "https://github.com/vaadin/flow/commit/061a1f9dffd939910364a237db67c52f2fe0dff7", "message": "Merge branch 'master' into haijian/fix-security-issue", "committedDate": "2020-04-08T09:41:01Z", "type": "commit"}]}