{"pr_number": 8125, "pr_title": "Push browser history state after postponed navigation proceeds", "pr_createdAt": "2020-04-21T21:42:43Z", "pr_url": "https://github.com/vaadin/flow/pull/8125", "timeline": [{"oid": "10af6d371812b30a543877de6e9216321e2b9598", "url": "https://github.com/vaadin/flow/commit/10af6d371812b30a543877de6e9216321e2b9598", "message": "* Push browser history state after navigation is certain because in case\nof postpone the url in the address bar is changed too early and the\nnavigation process might not proceed\n* Remove adding to history state from RouterLinkHandler as the\nserver-side does the same job at the correct time", "committedDate": "2020-04-21T21:33:52Z", "type": "commit"}, {"oid": "5e7da542a1d0e14023892cfe9f6f596cab8eb870", "url": "https://github.com/vaadin/flow/commit/5e7da542a1d0e14023892cfe9f6f596cab8eb870", "message": "Merge remote-tracking branch 'origin/2.1' into 2.1", "committedDate": "2020-04-21T21:34:09Z", "type": "commit"}, {"oid": "7c3a59e21bcf72f13926275d50001231055f01f2", "url": "https://github.com/vaadin/flow/commit/7c3a59e21bcf72f13926275d50001231055f01f2", "message": "Push the browser history state in ApplicationRunnerServlet.Router in\ntest-root-ui-context as it's not done in RouterLinkHandler anymore", "committedDate": "2020-04-22T15:52:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDMxODM5NQ==", "url": "https://github.com/vaadin/flow/pull/8125#discussion_r414318395", "bodyText": "In InternalRedirectHandler there's a replaceState. I think that should be replaced by pushState as well.", "author": "bogdanudrescu", "createdAt": "2020-04-24T06:07:41Z", "path": "flow-server/src/main/java/com/vaadin/flow/router/internal/AbstractNavigationStateRenderer.java", "diffHunk": "@@ -180,6 +180,16 @@ public int handle(NavigationEvent event) {\n             }\n         }\n \n+        if (!ui.getInternals().hasLastHandledLocation()\n+                || !event.getLocation().getPathWithQueryParameters()\n+                .equals(ui.getInternals().getLastHandledLocation()\n+                        .getPathWithQueryParameters())) {\n+            // Enable navigating back\n+            ui.getPage().getHistory().pushState(null, event.getLocation());", "originalCommit": "7c3a59e21bcf72f13926275d50001231055f01f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk4MzM1MQ==", "url": "https://github.com/vaadin/flow/pull/8125#discussion_r416983351", "bodyText": "I don't know the exact purpose of replaceState there. But, router.navigate is called after that and it will lead to pushState. So, I think the replacement is not necessary.", "author": "mehdi-vaadin", "createdAt": "2020-04-28T23:25:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDMxODM5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "2844153e7baeed07fd1cb62d78ba7631fee5b2db", "chunk": "diff --git a/flow-server/src/main/java/com/vaadin/flow/router/internal/AbstractNavigationStateRenderer.java b/flow-server/src/main/java/com/vaadin/flow/router/internal/AbstractNavigationStateRenderer.java\nindex 8a05d38510..1ebffdd6de 100644\n--- a/flow-server/src/main/java/com/vaadin/flow/router/internal/AbstractNavigationStateRenderer.java\n+++ b/flow-server/src/main/java/com/vaadin/flow/router/internal/AbstractNavigationStateRenderer.java\n\n@@ -180,21 +179,11 @@ public abstract class AbstractNavigationStateRenderer\n             }\n         }\n \n-        if (!ui.getInternals().hasLastHandledLocation()\n-                || !event.getLocation().getPathWithQueryParameters()\n-                .equals(ui.getInternals().getLastHandledLocation()\n-                        .getPathWithQueryParameters())) {\n-            // Enable navigating back\n-            ui.getPage().getHistory().pushState(null, event.getLocation());\n-\n-            ui.getInternals().setLastHandledNavigation(event.getLocation());\n-        }\n-\n         final ArrayList<HasElement> chain;\n \n         if (isPreserveOnRefreshTarget(routeTargetType, routeLayoutTypes)) {\n-            final Optional<ArrayList<HasElement>> maybeChain =\n-                    createOrRehandlePreserveOnRefreshComponent(event);\n+            final Optional<ArrayList<HasElement>> maybeChain = createOrRehandlePreserveOnRefreshComponent(\n+                    event);\n             if (!maybeChain.isPresent()) {\n                 return HttpServletResponse.SC_OK;\n             } else {\n"}}, {"oid": "2844153e7baeed07fd1cb62d78ba7631fee5b2db", "url": "https://github.com/vaadin/flow/commit/2844153e7baeed07fd1cb62d78ba7631fee5b2db", "message": "Call ScrollPositionHandler.afterNavigation after the navigation is done\nin server-side for RouterLinks", "committedDate": "2020-04-29T00:26:17Z", "type": "commit"}, {"oid": "e2779255410383dee435cebe9166defddd933809", "url": "https://github.com/vaadin/flow/commit/e2779255410383dee435cebe9166defddd933809", "message": "* Fix RouterTest\n* Pass the navigation state to ErrorNavigationEvent", "committedDate": "2020-04-29T01:26:31Z", "type": "commit"}, {"oid": "c788979f8c8ad74fff4c10c442bc1ff23c0eae82", "url": "https://github.com/vaadin/flow/commit/c788979f8c8ad74fff4c10c442bc1ff23c0eae82", "message": "Revert changes in flow-client/pom.xml", "committedDate": "2020-04-29T06:17:55Z", "type": "commit"}, {"oid": "e618c37fb35bcaf81609b3d7629a6ee8936f7fcd", "url": "https://github.com/vaadin/flow/commit/e618c37fb35bcaf81609b3d7629a6ee8936f7fcd", "message": "* Fix RouterSessionExpirationIT failure\n* Fix sonar issues", "committedDate": "2020-04-29T08:30:08Z", "type": "commit"}, {"oid": "92fe2fcd8e039faa98adba6439c7e6da90519cbf", "url": "https://github.com/vaadin/flow/commit/92fe2fcd8e039faa98adba6439c7e6da90519cbf", "message": "Add tests for the case when there is a gap between postpone and proceed", "committedDate": "2020-04-29T10:18:59Z", "type": "commit"}, {"oid": "b115c2eb2624bf08012799efaabf5b061df5f305", "url": "https://github.com/vaadin/flow/commit/b115c2eb2624bf08012799efaabf5b061df5f305", "message": "Fix RouterLinksIT", "committedDate": "2020-04-29T10:30:52Z", "type": "commit"}, {"oid": "13baac0bf32e581b734556a612abf8c7548e5c31", "url": "https://github.com/vaadin/flow/commit/13baac0bf32e581b734556a612abf8c7548e5c31", "message": "Address review comments", "committedDate": "2020-04-30T12:55:50Z", "type": "commit"}, {"oid": "0d198e269faf40343de1f6a2fd55f343a1708eb0", "url": "https://github.com/vaadin/flow/commit/0d198e269faf40343de1f6a2fd55f343a1708eb0", "message": "Prevent pushing history state if\nRouter::navigate(UI, Location, NavigationTrigger) is called", "committedDate": "2020-04-30T13:52:43Z", "type": "commit"}, {"oid": "0a97723e6f7fc124b50a2853c28ac493f07206cd", "url": "https://github.com/vaadin/flow/commit/0a97723e6f7fc124b50a2853c28ac493f07206cd", "message": "Add tests to NavigationStateRendererTest", "committedDate": "2020-05-04T06:37:12Z", "type": "commit"}, {"oid": "c7393d6c6ae23c1e1e204b22e89464acc8aa99a1", "url": "https://github.com/vaadin/flow/commit/c7393d6c6ae23c1e1e204b22e89464acc8aa99a1", "message": "* Add UI_NAVIGATE to NavigationTrigger enum to distinguish navigations\ntriggered from UI.navigate\n* Apply more changes after review", "committedDate": "2020-05-05T04:35:56Z", "type": "commit"}, {"oid": "9675152309d8cfeb6ddfcea40bb336be2e55949c", "url": "https://github.com/vaadin/flow/commit/9675152309d8cfeb6ddfcea40bb336be2e55949c", "message": "Remove unused imports", "committedDate": "2020-05-05T08:06:53Z", "type": "commit"}, {"oid": "ae41e6581a60adeec18802216f697e94aaf97432", "url": "https://github.com/vaadin/flow/commit/ae41e6581a60adeec18802216f697e94aaf97432", "message": "Apply changes after review", "committedDate": "2020-05-05T14:51:12Z", "type": "commit"}]}