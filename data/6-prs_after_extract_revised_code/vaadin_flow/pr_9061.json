{"pr_number": 9061, "pr_title": "Restructure dev mode handler logic to avoid starting webpack twice", "pr_createdAt": "2020-09-24T08:05:06Z", "pr_url": "https://github.com/vaadin/flow/pull/9061", "timeline": [{"oid": "aa34ba3398b40860656881a85723d9b6642ba8cb", "url": "https://github.com/vaadin/flow/commit/aa34ba3398b40860656881a85723d9b6642ba8cb", "message": "Restructure dev mode handler logic to avoid starting webpack twice\n\nFixes #8981", "committedDate": "2020-09-24T08:04:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE1MjYxMA==", "url": "https://github.com/vaadin/flow/pull/9061#discussion_r494152610", "bodyText": "Remove this use of \"Thread.sleep()\".", "author": "vaadin-bot", "createdAt": "2020-09-24T08:58:38Z", "path": "flow-server/src/test/java/com/vaadin/flow/server/DevModeHandlerTest.java", "diffHunk": "@@ -477,6 +481,80 @@ public void serveDevModeRequest_prepareTasksThrows_serveDevModeReturnsFalseAndDo\n         Assert.assertFalse(handler.serveDevModeRequest(request, response));\n     }\n \n+    @Test\n+    public void start_twoTimes_onlyOneHandlerInstanceIsCreated() {\n+        MockDeploymentConfiguration configuration = Mockito\n+                .spy(MockDeploymentConfiguration.class);\n+        DevModeHandler handler = DevModeHandler.start(0, configuration,\n+                npmFolder, CompletableFuture.completedFuture(null));\n+        handler.join();\n+\n+        // This is how new server handler instantiation checked:\n+        Mockito.verify(configuration).reuseDevServer();\n+\n+        // \"start\" one more time: there should not be another instance of dev\n+        // mode handler created\n+        DevModeHandler anotherHandler = DevModeHandler.start(0, configuration,\n+                npmFolder, CompletableFuture.completedFuture(null));\n+        anotherHandler.join();\n+\n+        // The handler instances are the same but there should be no attempt to\n+        // create another instance (which won't be stored anywhere), see below\n+        Assert.assertSame(handler, anotherHandler);\n+\n+        // No more \"reuseDevServer\" calls are done: see above, it has been\n+        // already called one time\n+        Mockito.verify(configuration).reuseDevServer();\n+    }\n+\n+    @Test\n+    public void start_twoInstances_secondInstanceUsesAnotherPort()\n+            throws Exception {\n+\n+        // start the first instance\n+        DevModeHandler handler = DevModeHandler.start(0, configuration,\n+                npmFolder, CompletableFuture.completedFuture(null));\n+\n+        // remove the \"singleton\" instance to be able to start another one\n+        removeDevModeHandlerInstance();\n+\n+        // since the timeout is quite big the server port still should be\n+        // available and the second instance should try to reuse it\n+\n+        DevModeHandler.start(0, configuration, npmFolder,\n+                CompletableFuture.completedFuture(null));\n+\n+        // make checks only if webpack has not yet completed\n+\n+        DevModeHandler anotherHandler = DevModeHandler.start(0, configuration,\n+                npmFolder, CompletableFuture.completedFuture(null));\n+\n+        while (handler.getPort() == 0) {\n+            Thread.sleep(100);", "originalCommit": "aa34ba3398b40860656881a85723d9b6642ba8cb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE1MjYyMw==", "url": "https://github.com/vaadin/flow/pull/9061#discussion_r494152623", "bodyText": "Remove this unused private \"checkPort\" method.", "author": "vaadin-bot", "createdAt": "2020-09-24T08:58:39Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/DevModeHandler.java", "diffHunk": "@@ -523,22 +522,45 @@ private void saveRunningDevServerPort() {\n         }\n     }\n \n-    private void doStartDevModeServer(DeploymentConfiguration config,\n-            File npmFolder) throws ExecutionFailedException {\n+    private boolean checkPort() {", "originalCommit": "aa34ba3398b40860656881a85723d9b6642ba8cb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDgxNTE4Ng==", "url": "https://github.com/vaadin/flow/pull/9061#discussion_r494815186", "bodyText": "Minor: Perhaps rename to doStartWebpack for consistency.", "author": "joheriks", "createdAt": "2020-09-25T07:59:24Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/DevModeHandler.java", "diffHunk": "@@ -550,7 +572,21 @@ private void doStartDevModeServer(DeploymentConfiguration config,\n \n         // Look for a free port\n         port = getFreePort();\n+        // save the port immediately before start a webpack server, see #8981\n+        saveRunningDevServerPort();\n+        boolean success = false;\n+\n+        try {\n+            success = doStartWebPack(config, webPackFiles, start);\n+        } finally {\n+            if (!success) {\n+                removeRunningDevServerPort();\n+            }\n+        }\n+    }\n \n+    private boolean doStartWebPack(DeploymentConfiguration config,", "originalCommit": "aa34ba3398b40860656881a85723d9b6642ba8cb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c0a5d8475b3697054c57e24b2c74806da15aa5ac", "chunk": "diff --git a/flow-server/src/main/java/com/vaadin/flow/server/DevModeHandler.java b/flow-server/src/main/java/com/vaadin/flow/server/DevModeHandler.java\nindex 19d6a2a0c5..dd6d64609d 100644\n--- a/flow-server/src/main/java/com/vaadin/flow/server/DevModeHandler.java\n+++ b/flow-server/src/main/java/com/vaadin/flow/server/DevModeHandler.java\n\n@@ -577,7 +577,7 @@ public final class DevModeHandler implements RequestHandler {\n         boolean success = false;\n \n         try {\n-            success = doStartWebPack(config, webPackFiles, start);\n+            success = doStartWebpack(config, webPackFiles, start);\n         } finally {\n             if (!success) {\n                 removeRunningDevServerPort();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDg0OTcyNA==", "url": "https://github.com/vaadin/flow/pull/9061#discussion_r494849724", "bodyText": "Minor: Because of the added null check (I assume to avoid calling createInstance in not null case as there is no lazy compareAndSet available), could the inner code be simplified to atomicHandler.set(...)", "author": "joheriks", "createdAt": "2020-09-25T09:01:32Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/DevModeHandler.java", "diffHunk": "@@ -188,8 +191,10 @@ public static DevModeHandler start(int runningPort,\n                 || !configuration.enableDevServer()) {\n             return null;\n         }\n-        atomicHandler.compareAndSet(null,\n-                createInstance(runningPort, configuration, npmFolder, waitFor));\n+        if (atomicHandler.get() == null) {\n+            atomicHandler.compareAndSet(null, createInstance(runningPort,", "originalCommit": "aa34ba3398b40860656881a85723d9b6642ba8cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDg1NjQxOA==", "url": "https://github.com/vaadin/flow/pull/9061#discussion_r494856418", "bodyText": "No, it can't be.\nThat's the point of thread safety.\nThe whole idea of using AtomicReference is to update the value safely and avoid extra action.\nIf two threads comes here then both threads may pass atomicHandler.get() == null  check.\nThen one thread may set it first and another thread will also create a new instance and set it but it should be rejected sine there is already one.\nThe added check will work in many cases to avoid even createInstance   call . But in the worst case it will be called anyway twice (or even more).\nThe changes which I made inside DevModeHandler  logic allows to avoid side effects in this case.\nBut atomicHandler.get() == null  check already will work in most cases so there will be no even need to create another instance.\nSo in short : the added check is not necessary (and should not be necessary) . But it allows to avoid extra actions in many cases even though it's not a booletproof solution.", "author": "denis-anisimov", "createdAt": "2020-09-25T09:13:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDg0OTcyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDg2MjI2Ng==", "url": "https://github.com/vaadin/flow/pull/9061#discussion_r494862266", "bodyText": "Ok. I was under the impression that the AtomicReference is there to have thread safe access between calls to DevModeHandler::start and DevModeHandler::stop. Is there at all a possibility to have two simultaneous threads entering DevModeHandler::start? As there's only one thread for dev server.\nAnyway, this is fine and yes probably safer.", "author": "joheriks", "createdAt": "2020-09-25T09:24:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDg0OTcyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDg2NDMzNA==", "url": "https://github.com/vaadin/flow/pull/9061#discussion_r494864334", "bodyText": "Theoretically this method can be invoked from two different threads.\nPractically: I don't know. This is not my code. So I don't know all the details behind decision to make it thread safe.\nBut this way it's thread safe without side effects.", "author": "denis-anisimov", "createdAt": "2020-09-25T09:27:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDg0OTcyNA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "c0a5d8475b3697054c57e24b2c74806da15aa5ac", "url": "https://github.com/vaadin/flow/commit/c0a5d8475b3697054c57e24b2c74806da15aa5ac", "message": "Rename method", "committedDate": "2020-09-25T09:15:06Z", "type": "commit"}]}