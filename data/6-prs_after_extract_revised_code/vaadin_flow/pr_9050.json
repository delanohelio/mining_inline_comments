{"pr_number": 9050, "pr_title": "Clear routes.", "pr_createdAt": "2020-09-22T09:23:47Z", "pr_url": "https://github.com/vaadin/flow/pull/9050", "timeline": [{"oid": "bcdb9ea0f0ae9599ca350082b9d9c980c5061b84", "url": "https://github.com/vaadin/flow/commit/bcdb9ea0f0ae9599ca350082b9d9c980c5061b84", "message": "Clear routes.", "committedDate": "2020-09-22T09:26:04Z", "type": "commit"}, {"oid": "bcdb9ea0f0ae9599ca350082b9d9c980c5061b84", "url": "https://github.com/vaadin/flow/commit/bcdb9ea0f0ae9599ca350082b9d9c980c5061b84", "message": "Clear routes.", "committedDate": "2020-09-22T09:26:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjYzNDUxOA==", "url": "https://github.com/vaadin/flow/pull/9050#discussion_r492634518", "bodyText": "Failing should be due to route not registered yet as the exception is thrown for non unique route registration.\nAlso what does this actually test as the assert routes check that the route has been registered?\nI would remove this part as it doesn't bring anything that is expected.", "author": "caalador", "createdAt": "2020-09-22T10:37:36Z", "path": "flow-server/src/test/java/com/vaadin/flow/router/internal/ConfigureRoutesTest.java", "diffHunk": "@@ -62,6 +62,56 @@ public void mutableConfiguration_canSetTargetRoute() {\n                 \"\", mutable.getTemplate(BaseTarget.class));\n     }\n \n+    @Test\n+    public void mutableConfiguration_clearRoutes() {\n+        ConfigureRoutes mutable = new ConfigureRoutes();\n+\n+        assertSetRoutes(mutable);\n+\n+        try {\n+            mutable.setRoute(\"\", BaseTarget.class);\n+            Assert.fail(\"Route is already registered\");", "originalCommit": "bcdb9ea0f0ae9599ca350082b9d9c980c5061b84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzIzODA5OQ==", "url": "https://github.com/vaadin/flow/pull/9050#discussion_r493238099", "bodyText": "We can remove this of course. I'd like though to keep it because that exception was somehow causing the bug itself, and the purpose of having it in the test is to make sure that the exception is raised for a duplicate route while after clear it doesn't. I can put this details in the code.", "author": "bogdanudrescu", "createdAt": "2020-09-23T06:53:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjYzNDUxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI0MTE4Ng==", "url": "https://github.com/vaadin/flow/pull/9050#discussion_r493241186", "bodyText": "I've added the details in the code. Let me know please if you agree with this.", "author": "bogdanudrescu", "createdAt": "2020-09-23T06:59:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjYzNDUxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI0NDQ3OQ==", "url": "https://github.com/vaadin/flow/pull/9050#discussion_r493244479", "bodyText": "I would rather have these as their own tests e.g. duplicateRootPathRegistration_throwsException and duplicateParameterPathRegistration_throwsException. as then it's clear what is the expected outcome and having a test fail makes it clear. now it would seem that clearing routed doesn't work even if this wouldn't be the case.", "author": "caalador", "createdAt": "2020-09-23T07:05:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjYzNDUxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI1MzI3MA==", "url": "https://github.com/vaadin/flow/pull/9050#discussion_r493253270", "bodyText": "Done. Thank you!", "author": "bogdanudrescu", "createdAt": "2020-09-23T07:22:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjYzNDUxOA=="}], "type": "inlineReview", "revised_code": {"commit": "91019339be2bc6c4f75e6221b4b94384db6d9f9f", "chunk": "diff --git a/flow-server/src/test/java/com/vaadin/flow/router/internal/ConfigureRoutesTest.java b/flow-server/src/test/java/com/vaadin/flow/router/internal/ConfigureRoutesTest.java\nindex deddb1ae37..6539923174 100644\n--- a/flow-server/src/test/java/com/vaadin/flow/router/internal/ConfigureRoutesTest.java\n+++ b/flow-server/src/test/java/com/vaadin/flow/router/internal/ConfigureRoutesTest.java\n\n@@ -62,12 +62,19 @@ public class ConfigureRoutesTest {\n                 \"\", mutable.getTemplate(BaseTarget.class));\n     }\n \n-    @Test\n+    @Test // #8433\n     public void mutableConfiguration_clearRoutes() {\n         ConfigureRoutes mutable = new ConfigureRoutes();\n \n         assertSetRoutes(mutable);\n \n+        // Bug 8433 was caused by an InvalidRouteConfigurationException raised\n+        // as a result of the RouteModel not being cleared on\n+        // ConfigureRoutes.clear(), thus perceiving reloaded routes as duplicate.\n+        //\n+        // Here we make sure that for a duplicate route the exception is raised,\n+        // while after invoking clear(), it shouldn't be raised again when\n+        // adding the same routes.\n         try {\n             mutable.setRoute(\"\", BaseTarget.class);\n             Assert.fail(\"Route is already registered\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjYzNjgxMw==", "url": "https://github.com/vaadin/flow/pull/9050#discussion_r492636813", "bodyText": "Also remove this set as it doesn't bring anything that is not tested in assertSetRoutes.", "author": "caalador", "createdAt": "2020-09-22T10:42:26Z", "path": "flow-server/src/test/java/com/vaadin/flow/router/internal/ConfigureRoutesTest.java", "diffHunk": "@@ -62,6 +62,56 @@ public void mutableConfiguration_canSetTargetRoute() {\n                 \"\", mutable.getTemplate(BaseTarget.class));\n     }\n \n+    @Test\n+    public void mutableConfiguration_clearRoutes() {\n+        ConfigureRoutes mutable = new ConfigureRoutes();\n+\n+        assertSetRoutes(mutable);\n+\n+        try {\n+            mutable.setRoute(\"\", BaseTarget.class);\n+            Assert.fail(\"Route is already registered\");\n+        } catch (InvalidRouteConfigurationException e) {\n+        }\n+\n+        try {\n+            mutable.setRoute(\":param\", ParamTarget.class);\n+            Assert.fail(\"Route is already registered\");", "originalCommit": "bcdb9ea0f0ae9599ca350082b9d9c980c5061b84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzIzODE2Mw==", "url": "https://github.com/vaadin/flow/pull/9050#discussion_r493238163", "bodyText": "Same as above.", "author": "bogdanudrescu", "createdAt": "2020-09-23T06:53:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjYzNjgxMw=="}], "type": "inlineReview", "revised_code": {"commit": "91019339be2bc6c4f75e6221b4b94384db6d9f9f", "chunk": "diff --git a/flow-server/src/test/java/com/vaadin/flow/router/internal/ConfigureRoutesTest.java b/flow-server/src/test/java/com/vaadin/flow/router/internal/ConfigureRoutesTest.java\nindex deddb1ae37..6539923174 100644\n--- a/flow-server/src/test/java/com/vaadin/flow/router/internal/ConfigureRoutesTest.java\n+++ b/flow-server/src/test/java/com/vaadin/flow/router/internal/ConfigureRoutesTest.java\n\n@@ -62,12 +62,19 @@ public class ConfigureRoutesTest {\n                 \"\", mutable.getTemplate(BaseTarget.class));\n     }\n \n-    @Test\n+    @Test // #8433\n     public void mutableConfiguration_clearRoutes() {\n         ConfigureRoutes mutable = new ConfigureRoutes();\n \n         assertSetRoutes(mutable);\n \n+        // Bug 8433 was caused by an InvalidRouteConfigurationException raised\n+        // as a result of the RouteModel not being cleared on\n+        // ConfigureRoutes.clear(), thus perceiving reloaded routes as duplicate.\n+        //\n+        // Here we make sure that for a duplicate route the exception is raised,\n+        // while after invoking clear(), it shouldn't be raised again when\n+        // adding the same routes.\n         try {\n             mutable.setRoute(\"\", BaseTarget.class);\n             Assert.fail(\"Route is already registered\");\n"}}, {"oid": "91019339be2bc6c4f75e6221b4b94384db6d9f9f", "url": "https://github.com/vaadin/flow/commit/91019339be2bc6c4f75e6221b4b94384db6d9f9f", "message": "Document exception test.", "committedDate": "2020-09-23T06:58:02Z", "type": "commit"}, {"oid": "6727442d37fb636e8cfd6a516c7442cc29f41730", "url": "https://github.com/vaadin/flow/commit/6727442d37fb636e8cfd6a516c7442cc29f41730", "message": "Fix comments", "committedDate": "2020-09-23T07:21:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI1ODYwMA==", "url": "https://github.com/vaadin/flow/pull/9050#discussion_r493258600", "bodyText": "Instead of the try catch you a better choice would be to add as a common parameter\n    @Rule\n    public ExpectedException exception = ExpectedException.none();\n\nand in the tests expecting exception have:\n        exceptionRule.expect(InvalidRouteConfigurationException.class);\n        exceptionRule.reportMissingExceptionWithMessage(\"Duplicate routes shouldn't be accepted.\");", "author": "caalador", "createdAt": "2020-09-23T07:31:15Z", "path": "flow-server/src/test/java/com/vaadin/flow/router/internal/ConfigureRoutesTest.java", "diffHunk": "@@ -62,6 +62,70 @@ public void mutableConfiguration_canSetTargetRoute() {\n                 \"\", mutable.getTemplate(BaseTarget.class));\n     }\n \n+    @Test\n+    public void mutableConfigurationClear_removesRegisteredRoutes() {\n+        ConfigureRoutes mutable = new ConfigureRoutes();\n+\n+        assertSetRoutes(mutable);\n+\n+        mutable.clear();\n+\n+        Assert.assertFalse(mutable.hasRouteTarget(BaseTarget.class));\n+        Assert.assertFalse(mutable.hasRouteTarget(ParamTarget.class));\n+\n+        Assert.assertNull(\n+                mutable.getNavigationRouteTarget(\"\").getRouteTarget());\n+        Assert.assertNull(\n+                mutable.getNavigationRouteTarget(\"123\").getRouteTarget());\n+\n+        assertSetRoutes(mutable);\n+    }\n+\n+    @Test\n+    public void mutableConfigurationClear_preservesErrorRoute() {\n+        ConfigureRoutes mutable = new ConfigureRoutes();\n+\n+        mutable.setErrorRoute(IndexOutOfBoundsException.class, BaseError.class);\n+\n+        mutable.clear();\n+\n+        Assert.assertEquals(\"ErrorRoute shouldn't be cleared.\",\n+                BaseError.class, mutable.getExceptionHandlerByClass(\n+                        IndexOutOfBoundsException.class));\n+    }\n+\n+    @Test\n+    public void duplicateRootPathRegistration_throwsException() {\n+        ConfigureRoutes mutable = new ConfigureRoutes();\n+\n+        mutable.setRoute(\"\", BaseTarget.class);\n+        Assert.assertTrue(mutable.hasRouteTarget(BaseTarget.class));\n+        Assert.assertEquals(BaseTarget.class, mutable\n+                .getNavigationRouteTarget(\"\").getRouteTarget().getTarget());\n+\n+        try {\n+            mutable.setRoute(\"\", BaseTarget.class);\n+            Assert.fail(\"Base route is already registered\");\n+        } catch (InvalidRouteConfigurationException e) {\n+        }\n+    }\n+\n+    @Test\n+    public void duplicateParameterPathRegistration_throwsException() {\n+        ConfigureRoutes mutable = new ConfigureRoutes();\n+\n+        mutable.setRoute(\":param\", ParamTarget.class);\n+        Assert.assertTrue(mutable.hasRouteTarget(ParamTarget.class));\n+        Assert.assertEquals(ParamTarget.class, mutable\n+                .getNavigationRouteTarget(\"123\").getRouteTarget().getTarget());\n+\n+        try {\n+            mutable.setRoute(\":param\", ParamTarget.class);", "originalCommit": "6727442d37fb636e8cfd6a516c7442cc29f41730", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI2NDQ1Mg==", "url": "https://github.com/vaadin/flow/pull/9050#discussion_r493264452", "bodyText": "But if doing this, how can we test on what line it was thrown from? Isn't this an expectation over the whole method just like @Test(expected = InvalidRouteConfigurationException.class)?", "author": "bogdanudrescu", "createdAt": "2020-09-23T07:40:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI1ODYwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI3MjA4NQ==", "url": "https://github.com/vaadin/flow/pull/9050#discussion_r493272085", "bodyText": "exceptionRule gives more possibilities than the expected, for instance the message that should be found\nexceptionRule.expectMessage(\"Navigation targets must have unique routes, found navigation targets 'ParamTarget' and 'ParamTarget' with the same route.\"); which would be good to check perhaps to see it fails for the correct version.\nAlso the cause can be checked with exceptionRule.expectCause(CoreMatchers.isA(TheCauseClassWeWouldExpect.class))\nAlso shouldn't the correct exception be AmbiguousRouteConfigurationException and not InvalidRouteConfiguratioException?", "author": "caalador", "createdAt": "2020-09-23T07:52:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI1ODYwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI4ODYyOQ==", "url": "https://github.com/vaadin/flow/pull/9050#discussion_r493288629", "bodyText": "Thank you. Please see if it's OK.", "author": "bogdanudrescu", "createdAt": "2020-09-23T08:09:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI1ODYwMA=="}], "type": "inlineReview", "revised_code": {"commit": "b8daa002d5280b3e171cb28641461c0f01d79994", "chunk": "diff --git a/flow-server/src/test/java/com/vaadin/flow/router/internal/ConfigureRoutesTest.java b/flow-server/src/test/java/com/vaadin/flow/router/internal/ConfigureRoutesTest.java\nindex 9ceb07c4bf..fcc766ebcc 100644\n--- a/flow-server/src/test/java/com/vaadin/flow/router/internal/ConfigureRoutesTest.java\n+++ b/flow-server/src/test/java/com/vaadin/flow/router/internal/ConfigureRoutesTest.java\n\n@@ -103,11 +108,12 @@ public class ConfigureRoutesTest {\n         Assert.assertEquals(BaseTarget.class, mutable\n                 .getNavigationRouteTarget(\"\").getRouteTarget().getTarget());\n \n-        try {\n-            mutable.setRoute(\"\", BaseTarget.class);\n-            Assert.fail(\"Base route is already registered\");\n-        } catch (InvalidRouteConfigurationException e) {\n-        }\n+        exceptionRule.expect(AmbiguousRouteConfigurationException.class);\n+        exceptionRule.reportMissingExceptionWithMessage(\n+                \"Duplicate routes shouldn't be accepted.\");\n+        exceptionRule.expectMessage(\n+                \"Navigation targets must have unique routes, found navigation targets 'com.vaadin.flow.router.internal.ConfigureRoutesTest$BaseTarget' and 'com.vaadin.flow.router.internal.ConfigureRoutesTest$BaseTarget' with the same route.\");\n+        mutable.setRoute(\"\", BaseTarget.class);\n     }\n \n     @Test\n"}}, {"oid": "b8daa002d5280b3e171cb28641461c0f01d79994", "url": "https://github.com/vaadin/flow/commit/b8daa002d5280b3e171cb28641461c0f01d79994", "message": "Fix comments", "committedDate": "2020-09-23T08:08:15Z", "type": "commit"}]}