{"pr_number": 9014, "pr_title": "merge master to offline", "pr_createdAt": "2020-09-15T19:25:59Z", "pr_url": "https://github.com/vaadin/flow/pull/9014", "timeline": [{"oid": "15e46158985568320cb25e6f6dfacb72a45cb241", "url": "https://github.com/vaadin/flow/commit/15e46158985568320cb25e6f6dfacb72a45cb241", "message": "Don't use the deprecated method (#8938)\n\nStop using the method that was deprecated in 1.11.1\r\n\r\nCloses #8929", "committedDate": "2020-09-03T13:56:34Z", "type": "commit"}, {"oid": "4a194485ee9bc62bd7d80e697482d47e3dbad651", "url": "https://github.com/vaadin/flow/commit/4a194485ee9bc62bd7d80e697482d47e3dbad651", "message": "fix: fetch real type for generic typed parameter (#8939)", "committedDate": "2020-09-04T13:46:44Z", "type": "commit"}, {"oid": "15ac978ccbec962c86288a2899b31895c93e0045", "url": "https://github.com/vaadin/flow/commit/15ac978ccbec962c86288a2899b31895c93e0045", "message": "Fixes from backporting frontend live-reload into master (#8937)", "committedDate": "2020-09-08T06:42:57Z", "type": "commit"}, {"oid": "3a87e6146fadc5b10910e14b6af6f95c79f4f9e5", "url": "https://github.com/vaadin/flow/commit/3a87e6146fadc5b10910e14b6af6f95c79f4f9e5", "message": "Make the CustomInMemoryDataProvider implement listeners handling (#8961)", "committedDate": "2020-09-08T07:44:28Z", "type": "commit"}, {"oid": "af11c30bd7b21a5a35ed7343331cc25c48c845b3", "url": "https://github.com/vaadin/flow/commit/af11c30bd7b21a5a35ed7343331cc25c48c845b3", "message": "Read attribute value from template (#8957)\n\nRead static attributes values for @Id mapped elements\r\n\r\nFixes #3735", "committedDate": "2020-09-08T08:37:37Z", "type": "commit"}, {"oid": "3fc997fadc7a9fed921b4aa0d8d57aeab73c2ed5", "url": "https://github.com/vaadin/flow/commit/3fc997fadc7a9fed921b4aa0d8d57aeab73c2ed5", "message": "Always consume the stdout stream from (p)npm and log at debug level (#7325) (#8980)\n\n(cherry picked from commit 816a09474f2a3d105de00e4eb81960f7932dc0c3)\r\n\r\n# Conflicts:\r\n#\tflow-server/src/main/java/com/vaadin/flow/server/frontend/TaskRunNpmInstall.java\r\n\r\nCo-authored-by: Johannes Eriksson <joheriks@vaadin.com>", "committedDate": "2020-09-09T07:20:43Z", "type": "commit"}, {"oid": "0bb5f12f266a33b3f1b9720a044d3b2bffa6c11d", "url": "https://github.com/vaadin/flow/commit/0bb5f12f266a33b3f1b9720a044d3b2bffa6c11d", "message": "Upgrade auto-installed Node to latest LTS and suppress some `npm install` errors (#8956)\n\nUpgrade installed node to latest LTS and set `scripts-prepend-node-artifact` to ensure same node is used to run npm and package install scripts\r\n\r\nRelated to #8741", "committedDate": "2020-09-09T08:22:59Z", "type": "commit"}, {"oid": "5a9b02d2a48492d6e7ecb2f6dc6bc0a82a6a97df", "url": "https://github.com/vaadin/flow/commit/5a9b02d2a48492d6e7ecb2f6dc6bc0a82a6a97df", "message": "Fix typo in variable DEAULT_FLOW_RESOURCES_FOLDER (#8897)\n\nReplace DEAULT_FLOW_RESOURCES_FOLDER with DEFAULT_FLOW_RESOURCES_FOLDER, but keep the old variable as deprecated.", "committedDate": "2020-09-09T19:42:12Z", "type": "commit"}, {"oid": "14c82be4647fdf66502c444700e5061a2b833280", "url": "https://github.com/vaadin/flow/commit/14c82be4647fdf66502c444700e5061a2b833280", "message": "Support for disabling Win-specific tests in CI (#8986)", "committedDate": "2020-09-10T06:18:34Z", "type": "commit"}, {"oid": "9b8409f90db89063c5c25c548f73bbd9b872b39f", "url": "https://github.com/vaadin/flow/commit/9b8409f90db89063c5c25c548f73bbd9b872b39f", "message": "Do not force installation of compatible pnpm version when system property `vaadin.ignoreVersionChecks` is set (#8971)\n\nSkip all version checks when ignoreVersionChecks flag is set\r\n\r\nUse found pnpm even if version outside of range when `ignoreVersionChecks=true`.", "committedDate": "2020-09-10T08:18:07Z", "type": "commit"}, {"oid": "4dc256e8951fd66eb2f05f734587fcb3998bc472", "url": "https://github.com/vaadin/flow/commit/4dc256e8951fd66eb2f05f734587fcb3998bc472", "message": "Cache original index.html Document in production mode (#8998)\n\n* Cache original index.html Document in production mode\r\n\r\n* Make IndexHtmlHolder serializable", "committedDate": "2020-09-10T12:52:21Z", "type": "commit"}, {"oid": "a177b6462afb2fbf3b65ff61124ba087f5fec166", "url": "https://github.com/vaadin/flow/commit/a177b6462afb2fbf3b65ff61124ba087f5fec166", "message": "Show webpack error on live reload of frontend resources (#8990)\n\nIdentify recompile using webpack console output instead of using a separate comm channel.\r\nThis ensures that webpack errors in `DevModeHandler` are synced when the live reload occurs.", "committedDate": "2020-09-10T16:47:51Z", "type": "commit"}, {"oid": "f6231b035fd593f3b2bec4798bd9f08ebfb8ea89", "url": "https://github.com/vaadin/flow/commit/f6231b035fd593f3b2bec4798bd9f08ebfb8ea89", "message": "fix: surround 404 check with spaces (#8997)\n\n`checkLogsForErrors` checks if the message contains `404`, \r\nbut it will match if the sequence is part of a number.", "committedDate": "2020-09-11T04:01:35Z", "type": "commit"}, {"oid": "721758d52e7bdc02e846a89764ffdf2b90e75388", "url": "https://github.com/vaadin/flow/commit/721758d52e7bdc02e846a89764ffdf2b90e75388", "message": "Implement lit template parser for limited template formats which extends LitTemplate element (#8979)\n\nImplement lit template parser for limited template formats which extends LitTemplate element \r\n\r\nFixes #8966", "committedDate": "2020-09-11T10:17:38Z", "type": "commit"}, {"oid": "ff84fba172058351fc43458f8594ca9400201f86", "url": "https://github.com/vaadin/flow/commit/ff84fba172058351fc43458f8594ca9400201f86", "message": "Use JS rather than CSS file for testing Webpack live reload, (#9003)", "committedDate": "2020-09-11T12:38:38Z", "type": "commit"}, {"oid": "ab017106a85c5cc54cec2a780bdf803a1db432fa", "url": "https://github.com/vaadin/flow/commit/ab017106a85c5cc54cec2a780bdf803a1db432fa", "message": "Fixed: flow-server now closes resources properly when parsing java classes (#9002)\n\nAs the ClassReader(InputStream) constructor doesn't close the input stream itself, the stream is then left hanging. This is a problem with the Gradle Plugin since the input stream is left hanging in the Gradle Daemon, which can stay around for hours. \r\n\r\nThis could be a possible cause for vaadin/vaadin-gradle-plugin#81", "committedDate": "2020-09-11T13:09:30Z", "type": "commit"}, {"oid": "66fe870c37d5350cebc4bc120a29079ae3201b2c", "url": "https://github.com/vaadin/flow/commit/66fe870c37d5350cebc4bc120a29079ae3201b2c", "message": "Read template attributes as properties (#8988)\n\nRead template attributes as properties\r\n\r\nFixes #8974", "committedDate": "2020-09-14T08:17:10Z", "type": "commit"}, {"oid": "8fba4e1e257f2c79ed7b7744fe0f5403a02f49f2", "url": "https://github.com/vaadin/flow/commit/8fba4e1e257f2c79ed7b7744fe0f5403a02f49f2", "message": "Set enable state based on template element attribute (#9007)\n\nSet element disabled if template has disabled property\r\nFixes #8973", "committedDate": "2020-09-15T11:57:05Z", "type": "commit"}, {"oid": "8f998e067224b1525d069a1ee78e040d937ae3e9", "url": "https://github.com/vaadin/flow/commit/8f998e067224b1525d069a1ee78e040d937ae3e9", "message": "Merge branch 'master' into haijian/merge-master-to-offline", "committedDate": "2020-09-15T19:24:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk3NzUzNg==", "url": "https://github.com/vaadin/flow/pull/9014#discussion_r488977536", "bodyText": "Refactor this method to reduce its Cognitive Complexity from 17 to the 15 allowed.", "author": "vaadin-bot", "createdAt": "2020-09-15T21:15:26Z", "path": "flow-server/src/main/java/com/vaadin/flow/component/littemplate/LitTemplateParserImpl.java", "diffHunk": "@@ -0,0 +1,254 @@\n+/*\n+ * Copyright 2000-2020 Vaadin Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package com.vaadin.flow.component.littemplate;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Locale;\n+import java.util.concurrent.locks.ReentrantLock;\n+import java.util.stream.Collectors;\n+\n+import org.jsoup.UncheckedIOException;\n+import org.jsoup.nodes.Element;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.vaadin.flow.component.dependency.JsModule;\n+import com.vaadin.flow.component.polymertemplate.BundleParser;\n+import com.vaadin.flow.function.DeploymentConfiguration;\n+import com.vaadin.flow.internal.AnnotationReader;\n+import com.vaadin.flow.internal.Pair;\n+import com.vaadin.flow.server.DependencyFilter;\n+import com.vaadin.flow.server.VaadinService;\n+import com.vaadin.flow.server.frontend.FrontendUtils;\n+import com.vaadin.flow.shared.ui.Dependency;\n+import com.vaadin.flow.shared.ui.LoadMode;\n+\n+import elemental.json.JsonObject;\n+\n+/**\n+ * Lit template parser implementation.\n+ * <p>\n+ * The implementation scans all JsModule annotations for the given template\n+ * class and tries to find the one that contains template definition using the\n+ * tag name.\n+ * <p>\n+ * The class is Singleton. Use {@link LitTemplateParserImpl#getInstance()} to\n+ * get its instance.\n+ *\n+ *\n+ * @author Vaadin Ltd\n+ * @since\n+ *\n+ * @see BundleParser\n+ */\n+class LitTemplateParserImpl implements LitTemplateParser {\n+\n+    private static final LitTemplateParser INSTANCE = new LitTemplateParserImpl();\n+\n+    private final HashMap<String, String> cache = new HashMap<>();\n+    private final ReentrantLock templateSourceslock = new ReentrantLock();\n+    private JsonObject jsonStats;\n+\n+    /**\n+     * The default constructor. Protected in order to prevent direct\n+     * instantiation, but not private in order to allow mocking/overrides for\n+     * testing purposes.\n+     */\n+    protected LitTemplateParserImpl() {\n+    }\n+\n+    static LitTemplateParser getInstance() {\n+        return INSTANCE;\n+    }\n+\n+    @Override\n+    public TemplateData getTemplateContent(Class<? extends LitTemplate> clazz,", "originalCommit": "8f998e067224b1525d069a1ee78e040d937ae3e9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk3NzU0Mg==", "url": "https://github.com/vaadin/flow/pull/9014#discussion_r488977542", "bodyText": "Reduce the total number of break and continue statements in this loop to use at most one.", "author": "vaadin-bot", "createdAt": "2020-09-15T21:15:27Z", "path": "flow-server/src/main/java/com/vaadin/flow/component/littemplate/LitTemplateParserImpl.java", "diffHunk": "@@ -0,0 +1,254 @@\n+/*\n+ * Copyright 2000-2020 Vaadin Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package com.vaadin.flow.component.littemplate;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Locale;\n+import java.util.concurrent.locks.ReentrantLock;\n+import java.util.stream.Collectors;\n+\n+import org.jsoup.UncheckedIOException;\n+import org.jsoup.nodes.Element;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.vaadin.flow.component.dependency.JsModule;\n+import com.vaadin.flow.component.polymertemplate.BundleParser;\n+import com.vaadin.flow.function.DeploymentConfiguration;\n+import com.vaadin.flow.internal.AnnotationReader;\n+import com.vaadin.flow.internal.Pair;\n+import com.vaadin.flow.server.DependencyFilter;\n+import com.vaadin.flow.server.VaadinService;\n+import com.vaadin.flow.server.frontend.FrontendUtils;\n+import com.vaadin.flow.shared.ui.Dependency;\n+import com.vaadin.flow.shared.ui.LoadMode;\n+\n+import elemental.json.JsonObject;\n+\n+/**\n+ * Lit template parser implementation.\n+ * <p>\n+ * The implementation scans all JsModule annotations for the given template\n+ * class and tries to find the one that contains template definition using the\n+ * tag name.\n+ * <p>\n+ * The class is Singleton. Use {@link LitTemplateParserImpl#getInstance()} to\n+ * get its instance.\n+ *\n+ *\n+ * @author Vaadin Ltd\n+ * @since\n+ *\n+ * @see BundleParser\n+ */\n+class LitTemplateParserImpl implements LitTemplateParser {\n+\n+    private static final LitTemplateParser INSTANCE = new LitTemplateParserImpl();\n+\n+    private final HashMap<String, String> cache = new HashMap<>();\n+    private final ReentrantLock templateSourceslock = new ReentrantLock();\n+    private JsonObject jsonStats;\n+\n+    /**\n+     * The default constructor. Protected in order to prevent direct\n+     * instantiation, but not private in order to allow mocking/overrides for\n+     * testing purposes.\n+     */\n+    protected LitTemplateParserImpl() {\n+    }\n+\n+    static LitTemplateParser getInstance() {\n+        return INSTANCE;\n+    }\n+\n+    @Override\n+    public TemplateData getTemplateContent(Class<? extends LitTemplate> clazz,\n+            String tag, VaadinService service) {\n+\n+        List<Dependency> dependencies = AnnotationReader\n+                .getAnnotationsFor(clazz, JsModule.class).stream()\n+                .map(jsModule -> new Dependency(Dependency.Type.JS_MODULE,\n+                        jsModule.value(), LoadMode.EAGER)) // load mode doesn't\n+                                                           // matter here\n+                .collect(Collectors.toList());\n+\n+        for (DependencyFilter filter : service.getDependencyFilters()) {\n+            dependencies = filter.filter(new ArrayList<>(dependencies),\n+                    service);\n+        }\n+\n+        Pair<Dependency, String> chosenDep = null;\n+\n+        for (Dependency dependency : dependencies) {", "originalCommit": "8f998e067224b1525d069a1ee78e040d937ae3e9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk3NzU1MQ==", "url": "https://github.com/vaadin/flow/pull/9014#discussion_r488977551", "bodyText": "Make \"parser\" transient or serializable.", "author": "vaadin-bot", "createdAt": "2020-09-15T21:15:28Z", "path": "flow-server/src/main/java/com/vaadin/flow/component/littemplate/LitTemplateDataAnalyzer.java", "diffHunk": "@@ -17,29 +17,51 @@\n \n import java.io.Serializable;\n import java.util.Collections;\n+import java.util.Optional;\n \n+import org.jsoup.nodes.Element;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.vaadin.flow.component.Tag;\n+import com.vaadin.flow.component.littemplate.LitTemplateParser.TemplateData;\n import com.vaadin.flow.component.polymertemplate.IdCollector;\n import com.vaadin.flow.component.polymertemplate.TemplateDataAnalyzer.ParserData;\n+import com.vaadin.flow.internal.AnnotationReader;\n+import com.vaadin.flow.server.VaadinService;\n \n /**\n  * Template data analyzer which produces immutable data required for template\n  * initializer using provided template class and a parser.\n  *\n  * @author Vaadin Ltd\n+ * @since\n  *\n  */\n class LitTemplateDataAnalyzer implements Serializable {\n \n     private final Class<? extends LitTemplate> templateClass;\n+    private final LitTemplateParser parser;", "originalCommit": "8f998e067224b1525d069a1ee78e040d937ae3e9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk3NzU1OQ==", "url": "https://github.com/vaadin/flow/pull/9014#discussion_r488977559", "bodyText": "Remove this use of \"DEAULT_FLOW_RESOURCES_FOLDER\"; it is deprecated.", "author": "vaadin-bot", "createdAt": "2020-09-15T21:15:29Z", "path": "flow-server/src/main/java/com/vaadin/flow/component/polymertemplate/BundleParser.java", "diffHunk": "@@ -256,8 +324,8 @@ private static String getSourceFromObject(JsonObject module,\n             // using ./ as the actual path contains\n             // \"node_modules/@vaadin/flow-frontend/\" instead of \"./\"\n             // \"target/flow-frontend/\" instead of \"./\"\n-            if (name.contains(FLOW_NPM_PACKAGE_NAME) ||\n-                    name.contains(DEAULT_FLOW_RESOURCES_FOLDER)) {\n+            if (name.contains(FLOW_NPM_PACKAGE_NAME)\n+                    || name.contains(DEAULT_FLOW_RESOURCES_FOLDER)) {", "originalCommit": "8f998e067224b1525d069a1ee78e040d937ae3e9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk3NzU2OA==", "url": "https://github.com/vaadin/flow/pull/9014#discussion_r488977568", "bodyText": "Do not forget to remove this deprecated code someday.", "author": "vaadin-bot", "createdAt": "2020-09-15T21:15:30Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/frontend/FrontendUtils.java", "diffHunk": "@@ -129,9 +129,20 @@\n      * Default folder for copying front-end resources present in the classpath\n      * jars.\n      */\n-    public static final String DEAULT_FLOW_RESOURCES_FOLDER = TARGET\n+    public static final String DEFAULT_FLOW_RESOURCES_FOLDER = TARGET\n             + \"flow-frontend\";\n \n+    /**\n+     * Default folder for copying front-end resources present in the classpath\n+     * jars.\n+     * @deprecated This is deprecated due to a typo.\n+     *             Use DEFAULT_FLOW_RESOURCES_FOLDER instead.\n+     * @see #DEFAULT_FLOW_RESOURCES_FOLDER\n+     */\n+    @Deprecated\n+    public static final String DEAULT_FLOW_RESOURCES_FOLDER =", "originalCommit": "8f998e067224b1525d069a1ee78e040d937ae3e9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk3NzU3NQ==", "url": "https://github.com/vaadin/flow/pull/9014#discussion_r488977575", "bodyText": "Call \"tagName.isPresent()\" before accessing the value.", "author": "vaadin-bot", "createdAt": "2020-09-15T21:15:31Z", "path": "flow-server/src/main/java/com/vaadin/flow/component/polymertemplate/IdCollector.java", "diffHunk": "@@ -121,19 +126,21 @@ private void collectedInjectedId(Field field,\n      * @return <code>false</code> if the mapping did not pass validation,\n      *         <code>true</code> otherwise\n      */\n-    private boolean addTagName(String id, Field field) {\n+    private boolean collectElementData(String id, Field field) {\n         idByField.put(field, id);\n         if (templateRoot != null) {\n             // The template is available for parsing so check up front if the id\n             // exists\n-            Optional<String> tagName = Optional\n-                    .ofNullable(templateRoot.getElementById(id))\n+            Optional<Element> element = Optional\n+                    .ofNullable(templateRoot.getElementById(id));\n+            Optional<String> tagName = element\n                     .map(org.jsoup.nodes.Element::tagName);\n-            if (tagName.isPresent()) {\n+            if (element.isPresent()) {\n                 tagById.put(id, tagName.get());", "originalCommit": "8f998e067224b1525d069a1ee78e040d937ae3e9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}