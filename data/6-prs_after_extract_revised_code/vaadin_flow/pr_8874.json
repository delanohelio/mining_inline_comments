{"pr_number": 8874, "pr_title": "Filter type support in Data View interfaces", "pr_createdAt": "2020-08-20T17:21:49Z", "pr_url": "https://github.com/vaadin/flow/pull/8874", "timeline": [{"oid": "1534369e322617eb91896865834c643885197f3e", "url": "https://github.com/vaadin/flow/commit/1534369e322617eb91896865834c643885197f3e", "message": "Filter type support in Data View interfaces", "committedDate": "2020-08-20T17:08:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQzNDY5Ng==", "url": "https://github.com/vaadin/flow/pull/8874#discussion_r474434696", "bodyText": "\"...into a predicate applied to the data provider\"", "author": "pleku", "createdAt": "2020-08-21T06:30:11Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/HasDataView.java", "diffHunk": "@@ -30,35 +35,89 @@\n  *            DataView type\n  * @since\n  */\n-public interface HasDataView<T, V extends DataView<T>> extends Serializable {\n+public interface HasDataView<T, F, V extends DataView<T>> extends Serializable {\n \n     /**\n      * Set a generic data provider for the component to use and returns the base\n      * {@link DataView} that provides API to get information on the items.\n      * <p>\n-     * This method should be used only when the data provider type\n-     * is not either {@link ListDataProvider} or {@link BackEndDataProvider}.\n+     * This method should be used only when the data provider type is not either\n+     * {@link ListDataProvider} or {@link BackEndDataProvider}.\n      *\n      * @param dataProvider\n-     *            DataProvider instance to use\n+     *            DataProvider instance to use, not <code>null</code>\n      * @return DataView providing information on the data\n      */\n-    V setItems(DataProvider<T, ?> dataProvider);\n+    V setItems(DataProvider<T, F> dataProvider);\n \n     /**\n-     * Sets an in-memory data provider for the component to use.\n+     * Sets an in-memory data provider for the component to use, taking into\n+     * account both in-memory filtering from data provider and component\n+     * specific internal filter.\n+     * <p>\n+     * Component's filter is transformed into a predicate through the given\n+     * filter combiner. Example of filter combiner which produces the\n+     * Person's name predicate:\n+     * {@code (String nameFilter) -> person -> person.getName().equalsIgnoreCase\n+     * (nameFilter);}\n      * <p>\n      * Note! Using a {@link ListDataProvider} instead of a\n      * {@link InMemoryDataProvider} is recommended to get access to\n      * {@link ListDataView} API by using\n      * {@link HasListDataView#setItems(ListDataProvider)}.\n      *\n      * @param dataProvider\n-     *            InMemoryDataProvider to use\n+     *            InMemoryDataProvider to use, not <code>null</code>\n+     * @param filterConverter a function which converts a component's\n+     *                        internal filter into a predicate to be\n+     *                        applied to the all items of data provider", "originalCommit": "1534369e322617eb91896865834c643885197f3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYxMTM4NQ==", "url": "https://github.com/vaadin/flow/pull/8874#discussion_r474611385", "bodyText": "As for now this method looks as a candidate for being only in ComboBox, it will be fixed in ComboBox accordingly.", "author": "mshabarov", "createdAt": "2020-08-21T10:23:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQzNDY5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "22a8cb0f337f6a483685d5b4744edaeea0064225", "chunk": "diff --git a/flow-data/src/main/java/com/vaadin/flow/data/provider/HasDataView.java b/flow-data/src/main/java/com/vaadin/flow/data/provider/HasDataView.java\nindex 3280abd6af..b33603aa9f 100644\n--- a/flow-data/src/main/java/com/vaadin/flow/data/provider/HasDataView.java\n+++ b/flow-data/src/main/java/com/vaadin/flow/data/provider/HasDataView.java\n\n@@ -31,6 +26,8 @@ import com.vaadin.flow.function.SerializablePredicate;\n  *\n  * @param <T>\n  *            data type\n+ * @param <F>\n+ *            filter type\n  * @param <V>\n  *            DataView type\n  * @since\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQzNzk3NA==", "url": "https://github.com/vaadin/flow/pull/8874#discussion_r474437974", "bodyText": "I don't know if the filtering here is that important, since the setItems(DataProvider) neither mentions anything about it.\nMaybe it would be OK to clarify in a later sentence that if the component has inbuilt filtering, then it the other method with filter converter should be used instead.", "author": "pleku", "createdAt": "2020-08-21T06:39:09Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/HasDataView.java", "diffHunk": "@@ -30,35 +35,89 @@\n  *            DataView type\n  * @since\n  */\n-public interface HasDataView<T, V extends DataView<T>> extends Serializable {\n+public interface HasDataView<T, F, V extends DataView<T>> extends Serializable {\n \n     /**\n      * Set a generic data provider for the component to use and returns the base\n      * {@link DataView} that provides API to get information on the items.\n      * <p>\n-     * This method should be used only when the data provider type\n-     * is not either {@link ListDataProvider} or {@link BackEndDataProvider}.\n+     * This method should be used only when the data provider type is not either\n+     * {@link ListDataProvider} or {@link BackEndDataProvider}.\n      *\n      * @param dataProvider\n-     *            DataProvider instance to use\n+     *            DataProvider instance to use, not <code>null</code>\n      * @return DataView providing information on the data\n      */\n-    V setItems(DataProvider<T, ?> dataProvider);\n+    V setItems(DataProvider<T, F> dataProvider);\n \n     /**\n-     * Sets an in-memory data provider for the component to use.\n+     * Sets an in-memory data provider for the component to use, taking into\n+     * account both in-memory filtering from data provider and component\n+     * specific internal filter.\n+     * <p>\n+     * Component's filter is transformed into a predicate through the given\n+     * filter combiner. Example of filter combiner which produces the\n+     * Person's name predicate:\n+     * {@code (String nameFilter) -> person -> person.getName().equalsIgnoreCase\n+     * (nameFilter);}\n      * <p>\n      * Note! Using a {@link ListDataProvider} instead of a\n      * {@link InMemoryDataProvider} is recommended to get access to\n      * {@link ListDataView} API by using\n      * {@link HasListDataView#setItems(ListDataProvider)}.\n      *\n      * @param dataProvider\n-     *            InMemoryDataProvider to use\n+     *            InMemoryDataProvider to use, not <code>null</code>\n+     * @param filterConverter a function which converts a component's\n+     *                        internal filter into a predicate to be\n+     *                        applied to the all items of data provider\n      * @return DataView providing information on the data\n+     *\n+     * @see #setItems(InMemoryDataProvider)\n+     */\n+    default V setItems(InMemoryDataProvider<T> dataProvider,\n+            SerializableFunction<F, SerializablePredicate<T>> filterConverter) {\n+        Objects.requireNonNull(filterConverter,\n+                \"FilterConverter cannot be null\");\n+        DataProvider<T, F> convertedDataProvider = dataProvider\n+                .withConvertedFilter(filter -> Optional\n+                        .ofNullable(dataProvider.getFilter())\n+                        .orElse(item -> true)\n+                        .and(item -> filterConverter.apply(filter).test(item)));\n+        return setItems(convertedDataProvider);\n+    }\n+\n+    /**\n+     * Sets an in-memory data provider for the component to use, taking into\n+     * account only in-memory filtering from data provider.", "originalCommit": "1534369e322617eb91896865834c643885197f3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYxMzAyOQ==", "url": "https://github.com/vaadin/flow/pull/8874#discussion_r474613029", "bodyText": "It will be mentioned in combobox that using \"no converter\" method overload throws, and ask to use the \"with converter\" method overload.", "author": "mshabarov", "createdAt": "2020-08-21T10:26:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQzNzk3NA=="}], "type": "inlineReview", "revised_code": {"commit": "22a8cb0f337f6a483685d5b4744edaeea0064225", "chunk": "diff --git a/flow-data/src/main/java/com/vaadin/flow/data/provider/HasDataView.java b/flow-data/src/main/java/com/vaadin/flow/data/provider/HasDataView.java\nindex 3280abd6af..b33603aa9f 100644\n--- a/flow-data/src/main/java/com/vaadin/flow/data/provider/HasDataView.java\n+++ b/flow-data/src/main/java/com/vaadin/flow/data/provider/HasDataView.java\n\n@@ -31,6 +26,8 @@ import com.vaadin.flow.function.SerializablePredicate;\n  *\n  * @param <T>\n  *            data type\n+ * @param <F>\n+ *            filter type\n  * @param <V>\n  *            DataView type\n  * @since\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQzOTExOQ==", "url": "https://github.com/vaadin/flow/pull/8874#discussion_r474439119", "bodyText": "Since ComboBox is still the only component with inbuilt filtering, it might be OK even still to just force the components to implement this method always (not have default implementation at all) and then make CB throw in the implementation, and point to the method with the filter converter instead, which would only be in CB.\nI cannot say at the moment which is better or worse option.", "author": "pleku", "createdAt": "2020-08-21T06:42:27Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/HasDataView.java", "diffHunk": "@@ -30,35 +35,89 @@\n  *            DataView type\n  * @since\n  */\n-public interface HasDataView<T, V extends DataView<T>> extends Serializable {\n+public interface HasDataView<T, F, V extends DataView<T>> extends Serializable {\n \n     /**\n      * Set a generic data provider for the component to use and returns the base\n      * {@link DataView} that provides API to get information on the items.\n      * <p>\n-     * This method should be used only when the data provider type\n-     * is not either {@link ListDataProvider} or {@link BackEndDataProvider}.\n+     * This method should be used only when the data provider type is not either\n+     * {@link ListDataProvider} or {@link BackEndDataProvider}.\n      *\n      * @param dataProvider\n-     *            DataProvider instance to use\n+     *            DataProvider instance to use, not <code>null</code>\n      * @return DataView providing information on the data\n      */\n-    V setItems(DataProvider<T, ?> dataProvider);\n+    V setItems(DataProvider<T, F> dataProvider);\n \n     /**\n-     * Sets an in-memory data provider for the component to use.\n+     * Sets an in-memory data provider for the component to use, taking into\n+     * account both in-memory filtering from data provider and component\n+     * specific internal filter.\n+     * <p>\n+     * Component's filter is transformed into a predicate through the given\n+     * filter combiner. Example of filter combiner which produces the\n+     * Person's name predicate:\n+     * {@code (String nameFilter) -> person -> person.getName().equalsIgnoreCase\n+     * (nameFilter);}\n      * <p>\n      * Note! Using a {@link ListDataProvider} instead of a\n      * {@link InMemoryDataProvider} is recommended to get access to\n      * {@link ListDataView} API by using\n      * {@link HasListDataView#setItems(ListDataProvider)}.\n      *\n      * @param dataProvider\n-     *            InMemoryDataProvider to use\n+     *            InMemoryDataProvider to use, not <code>null</code>\n+     * @param filterConverter a function which converts a component's\n+     *                        internal filter into a predicate to be\n+     *                        applied to the all items of data provider\n      * @return DataView providing information on the data\n+     *\n+     * @see #setItems(InMemoryDataProvider)\n+     */\n+    default V setItems(InMemoryDataProvider<T> dataProvider,\n+            SerializableFunction<F, SerializablePredicate<T>> filterConverter) {\n+        Objects.requireNonNull(filterConverter,\n+                \"FilterConverter cannot be null\");\n+        DataProvider<T, F> convertedDataProvider = dataProvider\n+                .withConvertedFilter(filter -> Optional\n+                        .ofNullable(dataProvider.getFilter())\n+                        .orElse(item -> true)\n+                        .and(item -> filterConverter.apply(filter).test(item)));\n+        return setItems(convertedDataProvider);\n+    }\n+\n+    /**\n+     * Sets an in-memory data provider for the component to use, taking into\n+     * account only in-memory filtering from data provider.\n+     * <p>\n+     * This methods ignores the component specific filter, even if it's included\n+     * into the query object. If you want to take it into account, please use\n+     * {@link #setItems(InMemoryDataProvider, SerializableFunction)}.\n+     * <p>\n+     * Note! Using a {@link ListDataProvider} instead of a\n+     * {@link InMemoryDataProvider} is recommended to get access to\n+     * {@link ListDataView} API by using\n+     * {@link HasListDataView#setItems(ListDataProvider)}.\n+     *\n+     * @param dataProvider\n+     *            InMemoryDataProvider to use, not <code>null</code>\n+     * @return DataView providing information on the data\n+     *\n+     * @see #setItems(InMemoryDataProvider, SerializableFunction)\n      */\n+    // TODO: probably we should just remove this methods, because it has a\n+    //  significant drawback: it ignores the component's filter quietly, even\n+    //  though it described in javadoc, so the developer can easily make a\n+    //  mistake here.", "originalCommit": "1534369e322617eb91896865834c643885197f3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYxNjE4MQ==", "url": "https://github.com/vaadin/flow/pull/8874#discussion_r474616181", "bodyText": "Alright, I like this idea, because: 1. The implementation in custom components/addons might be not only in delegating to setItems(DataProvider<T, F> dataProvider) 2. Component's author will be responsible for handling the input data provider in implementation and he will decide whether ignore the filter or not.", "author": "mshabarov", "createdAt": "2020-08-21T10:33:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQzOTExOQ=="}], "type": "inlineReview", "revised_code": {"commit": "22a8cb0f337f6a483685d5b4744edaeea0064225", "chunk": "diff --git a/flow-data/src/main/java/com/vaadin/flow/data/provider/HasDataView.java b/flow-data/src/main/java/com/vaadin/flow/data/provider/HasDataView.java\nindex 3280abd6af..b33603aa9f 100644\n--- a/flow-data/src/main/java/com/vaadin/flow/data/provider/HasDataView.java\n+++ b/flow-data/src/main/java/com/vaadin/flow/data/provider/HasDataView.java\n\n@@ -31,6 +26,8 @@ import com.vaadin.flow.function.SerializablePredicate;\n  *\n  * @param <T>\n  *            data type\n+ * @param <F>\n+ *            filter type\n  * @param <V>\n  *            DataView type\n  * @since\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQzOTE0MQ==", "url": "https://github.com/vaadin/flow/pull/8874#discussion_r474439141", "bodyText": "Would be better to start why one should use this method instead of explaining how it works:\n\"Sets an in-memory data provider to use with a component that has internal filtering, like {@code ComboBox}. For components without inbuilt filtering use ...... instead.\"", "author": "pleku", "createdAt": "2020-08-21T06:42:30Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/HasDataView.java", "diffHunk": "@@ -30,35 +35,89 @@\n  *            DataView type\n  * @since\n  */\n-public interface HasDataView<T, V extends DataView<T>> extends Serializable {\n+public interface HasDataView<T, F, V extends DataView<T>> extends Serializable {\n \n     /**\n      * Set a generic data provider for the component to use and returns the base\n      * {@link DataView} that provides API to get information on the items.\n      * <p>\n-     * This method should be used only when the data provider type\n-     * is not either {@link ListDataProvider} or {@link BackEndDataProvider}.\n+     * This method should be used only when the data provider type is not either\n+     * {@link ListDataProvider} or {@link BackEndDataProvider}.\n      *\n      * @param dataProvider\n-     *            DataProvider instance to use\n+     *            DataProvider instance to use, not <code>null</code>\n      * @return DataView providing information on the data\n      */\n-    V setItems(DataProvider<T, ?> dataProvider);\n+    V setItems(DataProvider<T, F> dataProvider);\n \n     /**\n-     * Sets an in-memory data provider for the component to use.\n+     * Sets an in-memory data provider for the component to use, taking into\n+     * account both in-memory filtering from data provider and component\n+     * specific internal filter.", "originalCommit": "1534369e322617eb91896865834c643885197f3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYxNjM2MA==", "url": "https://github.com/vaadin/flow/pull/8874#discussion_r474616360", "bodyText": "Will be done on ComboBox side", "author": "mshabarov", "createdAt": "2020-08-21T10:34:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQzOTE0MQ=="}], "type": "inlineReview", "revised_code": {"commit": "22a8cb0f337f6a483685d5b4744edaeea0064225", "chunk": "diff --git a/flow-data/src/main/java/com/vaadin/flow/data/provider/HasDataView.java b/flow-data/src/main/java/com/vaadin/flow/data/provider/HasDataView.java\nindex 3280abd6af..b33603aa9f 100644\n--- a/flow-data/src/main/java/com/vaadin/flow/data/provider/HasDataView.java\n+++ b/flow-data/src/main/java/com/vaadin/flow/data/provider/HasDataView.java\n\n@@ -31,6 +26,8 @@ import com.vaadin.flow.function.SerializablePredicate;\n  *\n  * @param <T>\n  *            data type\n+ * @param <F>\n+ *            filter type\n  * @param <V>\n  *            DataView type\n  * @since\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQzOTkzMw==", "url": "https://github.com/vaadin/flow/pull/8874#discussion_r474439933", "bodyText": "Since filter is basically optional, I would maybe mention that one last as \"...and an optional filter\"", "author": "pleku", "createdAt": "2020-08-21T06:44:42Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/HasLazyDataView.java", "diffHunk": "@@ -45,12 +48,11 @@\n      *\n      * @param fetchCallback\n      *            function that returns a stream of items from the backend based\n-     *            on the offset and limit provided by the query object\n+     *            on the filter, offset and limit provided by the query object", "originalCommit": "1534369e322617eb91896865834c643885197f3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYxNjQwMw==", "url": "https://github.com/vaadin/flow/pull/8874#discussion_r474616403", "bodyText": "Done", "author": "mshabarov", "createdAt": "2020-08-21T10:34:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQzOTkzMw=="}], "type": "inlineReview", "revised_code": {"commit": "22a8cb0f337f6a483685d5b4744edaeea0064225", "chunk": "diff --git a/flow-data/src/main/java/com/vaadin/flow/data/provider/HasLazyDataView.java b/flow-data/src/main/java/com/vaadin/flow/data/provider/HasLazyDataView.java\nindex 87eab1fa6f..46277b963e 100644\n--- a/flow-data/src/main/java/com/vaadin/flow/data/provider/HasLazyDataView.java\n+++ b/flow-data/src/main/java/com/vaadin/flow/data/provider/HasLazyDataView.java\n\n@@ -48,7 +50,8 @@ public interface HasLazyDataView<T, F, V extends LazyDataView<T>>\n      *\n      * @param fetchCallback\n      *            function that returns a stream of items from the backend based\n-     *            on the filter, offset and limit provided by the query object\n+     *            on the offset, limit and an optional filter provided by the\n+     *            query object\n      * @return LazyDataView instance for further configuration\n      */\n     default V setItems(CallbackDataProvider.FetchCallback<T, F> fetchCallback) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ2NjY1OA==", "url": "https://github.com/vaadin/flow/pull/8874#discussion_r474466658", "bodyText": "I would move filter to be last since it is not valid for components which don't provide a filter.\nMaybe even better to leave it out completely (keep it as it was) and add\n\"Usage example without component provided filter:\"", "author": "pleku", "createdAt": "2020-08-21T07:26:16Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/HasLazyDataView.java", "diffHunk": "@@ -24,19 +24,22 @@\n  *\n  * @param <T>\n  *            item type\n+ * @param <F>\n+ *            filter type\n  * @param <V>\n  *            DataView type\n  * @since\n  */\n-public interface HasLazyDataView<T, V extends LazyDataView<T>>\n+public interface HasLazyDataView<T, F, V extends LazyDataView<T>>\n         extends Serializable {\n \n     /**\n      * Supply items lazily with a callback from a backend. The component will\n      * automatically fetch more items and adjust its size until the backend runs\n      * out of items. Usage example:\n      * <p>\n-     * {@code component.setItems(query -> orderService.getOrders(query.getOffset(), query.getLimit());}\n+     * {@code component.setItems(query -> orderService.getOrders(\n+     *                  query.getFilter, query.getOffset(), query.getLimit());}", "originalCommit": "1534369e322617eb91896865834c643885197f3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYxNjQ0NA==", "url": "https://github.com/vaadin/flow/pull/8874#discussion_r474616444", "bodyText": "Done", "author": "mshabarov", "createdAt": "2020-08-21T10:34:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ2NjY1OA=="}], "type": "inlineReview", "revised_code": {"commit": "22a8cb0f337f6a483685d5b4744edaeea0064225", "chunk": "diff --git a/flow-data/src/main/java/com/vaadin/flow/data/provider/HasLazyDataView.java b/flow-data/src/main/java/com/vaadin/flow/data/provider/HasLazyDataView.java\nindex 87eab1fa6f..46277b963e 100644\n--- a/flow-data/src/main/java/com/vaadin/flow/data/provider/HasLazyDataView.java\n+++ b/flow-data/src/main/java/com/vaadin/flow/data/provider/HasLazyDataView.java\n\n@@ -36,10 +36,12 @@ public interface HasLazyDataView<T, F, V extends LazyDataView<T>>\n     /**\n      * Supply items lazily with a callback from a backend. The component will\n      * automatically fetch more items and adjust its size until the backend runs\n-     * out of items. Usage example:\n+     * out of items. Usage example without component provided filter:\n      * <p>\n-     * {@code component.setItems(query -> orderService.getOrders(\n-     *                  query.getFilter, query.getOffset(), query.getLimit());}\n+     * {@code component.setItems(query -> orderService.getOrders(query.getOffset(), query.getLimit());}\n+     * <p>\n+     * If the component supports filtering, it can be fetched with\n+     * query.getFilter().\n      * <p>\n      * The returned data view object can be used for further configuration, or\n      * later on fetched with {@link #getLazyDataView()}. For using in-memory\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ2Nzg0OQ==", "url": "https://github.com/vaadin/flow/pull/8874#discussion_r474467849", "bodyText": "Again, maybe for simplicity the filter could be kept out of this and then another comment could follow the example stating that \"If the component supports filtering, it can be fetched with query.getFilter().\"", "author": "pleku", "createdAt": "2020-08-21T07:27:47Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/HasLazyDataView.java", "diffHunk": "@@ -68,14 +70,15 @@ default V setItems(\n \n     /**\n      * Supply items lazily with callbacks: the first one fetches the items based\n-     * on offset and limit, the second provides the exact count of items in the\n-     * backend. Use this in case getting the count is cheap and the user\n+     * on filter, offset and limit, the second provides the exact count of items\n+     * in the backend. Use this in case getting the count is cheap and the user\n      * benefits from the component showing immediately the exact size. Usage\n      * example:\n      * <p>\n      * {@code component.setItems(\n-     *                    query -> orderService.getOrders(query.getOffset, query.getLimit()),\n-     *                    query -> orderService.getSize());}\n+     *                    query -> orderService.getOrders(query.getFilter,\n+     *                              query.getOffset, query.getLimit()),\n+     *                    query -> orderService.getSize(query.getFilter));}", "originalCommit": "1534369e322617eb91896865834c643885197f3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYxNjQ3NA==", "url": "https://github.com/vaadin/flow/pull/8874#discussion_r474616474", "bodyText": "Done", "author": "mshabarov", "createdAt": "2020-08-21T10:34:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ2Nzg0OQ=="}], "type": "inlineReview", "revised_code": {"commit": "22a8cb0f337f6a483685d5b4744edaeea0064225", "chunk": "diff --git a/flow-data/src/main/java/com/vaadin/flow/data/provider/HasLazyDataView.java b/flow-data/src/main/java/com/vaadin/flow/data/provider/HasLazyDataView.java\nindex 87eab1fa6f..46277b963e 100644\n--- a/flow-data/src/main/java/com/vaadin/flow/data/provider/HasLazyDataView.java\n+++ b/flow-data/src/main/java/com/vaadin/flow/data/provider/HasLazyDataView.java\n\n@@ -70,15 +73,17 @@ public interface HasLazyDataView<T, F, V extends LazyDataView<T>>\n \n     /**\n      * Supply items lazily with callbacks: the first one fetches the items based\n-     * on filter, offset and limit, the second provides the exact count of items\n-     * in the backend. Use this in case getting the count is cheap and the user\n-     * benefits from the component showing immediately the exact size. Usage\n-     * example:\n+     * on offset, limit and an optional filter, the second provides the exact\n+     * count of items in the backend. Use this in case getting the count is\n+     * cheap and the user benefits from the component showing immediately the\n+     * exact size. Usage example without component provided filter:\n      * <p>\n      * {@code component.setItems(\n-     *                    query -> orderService.getOrders(query.getFilter,\n-     *                              query.getOffset, query.getLimit()),\n-     *                    query -> orderService.getSize(query.getFilter));}\n+     *                    query -> orderService.getOrders(query.getOffset, query.getLimit()),\n+     *                    query -> orderService.getSize());}\n+     * <p>\n+     * If the component supports filtering, it can be fetched with\n+     * query.getFilter().\n      * <p>\n      * The returned data view object can be used for further configuration, or\n      * later on fetched with {@link #getLazyDataView()}. For using in-memory\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ2ODA2Mg==", "url": "https://github.com/vaadin/flow/pull/8874#discussion_r474468062", "bodyText": "Missing () x 2", "author": "pleku", "createdAt": "2020-08-21T07:28:04Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/HasLazyDataView.java", "diffHunk": "@@ -68,14 +70,15 @@ default V setItems(\n \n     /**\n      * Supply items lazily with callbacks: the first one fetches the items based\n-     * on offset and limit, the second provides the exact count of items in the\n-     * backend. Use this in case getting the count is cheap and the user\n+     * on filter, offset and limit, the second provides the exact count of items\n+     * in the backend. Use this in case getting the count is cheap and the user\n      * benefits from the component showing immediately the exact size. Usage\n      * example:\n      * <p>\n      * {@code component.setItems(\n-     *                    query -> orderService.getOrders(query.getOffset, query.getLimit()),\n-     *                    query -> orderService.getSize());}\n+     *                    query -> orderService.getOrders(query.getFilter,\n+     *                              query.getOffset, query.getLimit()),", "originalCommit": "1534369e322617eb91896865834c643885197f3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYxNjY5Mg==", "url": "https://github.com/vaadin/flow/pull/8874#discussion_r474616692", "bodyText": "Obsolete, because getFilter has been removed from example. Done", "author": "mshabarov", "createdAt": "2020-08-21T10:34:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ2ODA2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "22a8cb0f337f6a483685d5b4744edaeea0064225", "chunk": "diff --git a/flow-data/src/main/java/com/vaadin/flow/data/provider/HasLazyDataView.java b/flow-data/src/main/java/com/vaadin/flow/data/provider/HasLazyDataView.java\nindex 87eab1fa6f..46277b963e 100644\n--- a/flow-data/src/main/java/com/vaadin/flow/data/provider/HasLazyDataView.java\n+++ b/flow-data/src/main/java/com/vaadin/flow/data/provider/HasLazyDataView.java\n\n@@ -70,15 +73,17 @@ public interface HasLazyDataView<T, F, V extends LazyDataView<T>>\n \n     /**\n      * Supply items lazily with callbacks: the first one fetches the items based\n-     * on filter, offset and limit, the second provides the exact count of items\n-     * in the backend. Use this in case getting the count is cheap and the user\n-     * benefits from the component showing immediately the exact size. Usage\n-     * example:\n+     * on offset, limit and an optional filter, the second provides the exact\n+     * count of items in the backend. Use this in case getting the count is\n+     * cheap and the user benefits from the component showing immediately the\n+     * exact size. Usage example without component provided filter:\n      * <p>\n      * {@code component.setItems(\n-     *                    query -> orderService.getOrders(query.getFilter,\n-     *                              query.getOffset, query.getLimit()),\n-     *                    query -> orderService.getSize(query.getFilter));}\n+     *                    query -> orderService.getOrders(query.getOffset, query.getLimit()),\n+     *                    query -> orderService.getSize());}\n+     * <p>\n+     * If the component supports filtering, it can be fetched with\n+     * query.getFilter().\n      * <p>\n      * The returned data view object can be used for further configuration, or\n      * later on fetched with {@link #getLazyDataView()}. For using in-memory\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ3MTQ5MA==", "url": "https://github.com/vaadin/flow/pull/8874#discussion_r474471490", "bodyText": "Why is this needed as a property instead of just keeping the buildQuery method abstract ? Is it going to change on the fly ?", "author": "pleku", "createdAt": "2020-08-21T07:31:50Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/AbstractDataView.java", "diffHunk": "@@ -37,6 +38,7 @@\n     protected static final String NULL_IDENTIFIER_ERROR_MESSAGE = \"Identity provider should not return null\";\n \n     protected SerializableSupplier<? extends DataProvider<T, ?>> dataProviderSupplier;\n+    protected SerializableBiFunction<Integer, Integer, Query<T, ?>> querySupplier;", "originalCommit": "1534369e322617eb91896865834c643885197f3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ5Nzc1OQ==", "url": "https://github.com/vaadin/flow/pull/8874#discussion_r474497759", "bodyText": "I would also keep expectations clearer by having this as an abstract method only.", "author": "caalador", "createdAt": "2020-08-21T08:02:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ3MTQ5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYxMDEwMw==", "url": "https://github.com/vaadin/flow/pull/8874#discussion_r474610103", "bodyText": "I did it so initially, but there is an obstacle:\nThe goal of this method is to provide a query with component's actual filtering and sorting filled up. Making this method abstract means we will have to create a anonymous class just to put the values there:\npublic ComboBoxDataView<T> getGenericDataView() {\n   return new AbstractDataView(dataCommunicator, this) {\n       @Override\n       public Query buildQuery(int offset, int limit) {\n            return new Query(offset, limit, sortOrder, inMemorySorting, lastFilter);\n       }\n   }\n}\n\nI don't want go this way, but create a regular class implementation instead.\nSorry, I might be wrong, but it needs a link to component's filter and sorting anyway, through the supplier, or through component's public method.", "author": "mshabarov", "createdAt": "2020-08-21T10:20:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ3MTQ5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYxNzI0NQ==", "url": "https://github.com/vaadin/flow/pull/8874#discussion_r474617245", "bodyText": "Ok. I think if combo box is the only component that needs this type of callback, then it can have a data view implementation which get those from the component when it constructs the data view for itself. For other purposes, this feels a bit of an antipattern that makes everything else overly complex. That is at least my feeling.", "author": "pleku", "createdAt": "2020-08-21T10:36:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ3MTQ5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYyMDcyMw==", "url": "https://github.com/vaadin/flow/pull/8874#discussion_r474620723", "bodyText": "Hmm, then I could just revert my changes and just include this kind of supplier in ComboBoxDataView and ComboBoxListDataView only. It would be much simpler, thanks!", "author": "mshabarov", "createdAt": "2020-08-21T10:44:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ3MTQ5MA=="}], "type": "inlineReview", "revised_code": {"commit": "22a8cb0f337f6a483685d5b4744edaeea0064225", "chunk": "diff --git a/flow-data/src/main/java/com/vaadin/flow/data/provider/AbstractDataView.java b/flow-data/src/main/java/com/vaadin/flow/data/provider/AbstractDataView.java\nindex 572f549279..68e809e38b 100644\n--- a/flow-data/src/main/java/com/vaadin/flow/data/provider/AbstractDataView.java\n+++ b/flow-data/src/main/java/com/vaadin/flow/data/provider/AbstractDataView.java\n\n@@ -38,7 +38,6 @@ public abstract class AbstractDataView<T> implements DataView<T> {\n     protected static final String NULL_IDENTIFIER_ERROR_MESSAGE = \"Identity provider should not return null\";\n \n     protected SerializableSupplier<? extends DataProvider<T, ?>> dataProviderSupplier;\n-    protected SerializableBiFunction<Integer, Integer, Query<T, ?>> querySupplier;\n     protected Component component;\n \n     /**\n"}}, {"oid": "22a8cb0f337f6a483685d5b4744edaeea0064225", "url": "https://github.com/vaadin/flow/commit/22a8cb0f337f6a483685d5b4744edaeea0064225", "message": "Remove default implementations from HasDataView and move query supplier to combobox", "committedDate": "2020-08-21T11:26:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDY3MTIyNA==", "url": "https://github.com/vaadin/flow/pull/8874#discussion_r474671224", "bodyText": "Just noting here that both Grid and ComboBox need to have the getItems() method overridden for DataView and ListDataView due to sorting (grid) and filtering (cb). LazyDataView is safe because it uses data communicator", "author": "pleku", "createdAt": "2020-08-21T12:41:03Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/AbstractListDataView.java", "diffHunk": "@@ -61,9 +61,8 @@\n      */\n     public AbstractListDataView(\n             SerializableSupplier<? extends DataProvider<T, ?>> dataProviderSupplier,\n-            SerializableBiFunction<Integer, Integer, Query<T, ?>> querySupplier,\n             Component component) {\n-        super(dataProviderSupplier, querySupplier, component);\n+        super(dataProviderSupplier, component);\n     }\n \n     @Override", "originalCommit": "22a8cb0f337f6a483685d5b4744edaeea0064225", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDczNTg4OQ==", "url": "https://github.com/vaadin/flow/pull/8874#discussion_r474735889", "bodyText": "Yes, GridDataView and GridListDataView already override getItems and delegate to  dataCommunicator.buildQuery(0, Integer.MAX_VALUE), will check and do the same for CB", "author": "mshabarov", "createdAt": "2020-08-21T14:31:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDY3MTIyNA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "9bf7cc118f30fd9c32ca516b5b8b6ab9e31becca", "url": "https://github.com/vaadin/flow/commit/9bf7cc118f30fd9c32ca516b5b8b6ab9e31becca", "message": "Move setItemCountCallback to Grid and ComboBox", "committedDate": "2020-08-21T14:07:42Z", "type": "commit"}, {"oid": "78f444f0767c388e8d378794e9e4c28c0d8e751f", "url": "https://github.com/vaadin/flow/commit/78f444f0767c388e8d378794e9e4c28c0d8e751f", "message": "Remove Unused import", "committedDate": "2020-08-21T14:32:52Z", "type": "commit"}]}