{"pr_number": 892, "pr_title": "fix(e2e): Fix timing issue in provisioning e2e tests", "pr_createdAt": "2020-08-12T23:21:33Z", "pr_url": "https://github.com/Azure/azure-iot-sdk-java/pull/892", "timeline": [{"oid": "c5eeb15cb746d7b50657d4e01beb7f7ce3b8deb0", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/c5eeb15cb746d7b50657d4e01beb7f7ce3b8deb0", "message": "fix(e2e): Fix timing issue in provisioning e2e tests\n\nThere is some propagation delay between when a device is provisioned to a hub and when it is queryable. This commit refactors the test to just query for the device until it can be found, rather than just query once and hope the device was ready to be queried.", "committedDate": "2020-08-12T23:21:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYxMzA3MQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/892#discussion_r469613071", "bodyText": "Doesn't this add delay of more than 4 minutes our tests where we keep querying to see if device is provisioned?", "author": "bikamani", "createdAt": "2020-08-13T00:02:37Z", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/provisioning/setup/ProvisioningCommon.java", "diffHunk": "@@ -448,11 +449,25 @@ private void assertProvisionedDeviceWorks(String iothubUri, String deviceId) thr\n         }\n     }\n \n-    protected void assertProvisionedDeviceCapabilitiesAreExpected(DeviceCapabilities expectedDeviceCapabilities, String provisionedHubConnectionString) throws IOException, IotHubException\n-    {\n+    protected void assertProvisionedDeviceCapabilitiesAreExpected(DeviceCapabilities expectedDeviceCapabilities, String provisionedHubConnectionString) throws IOException, IotHubException, InterruptedException {\n         DeviceTwin deviceTwin = DeviceTwin.createFromConnectionString(provisionedHubConnectionString);\n-        Query query = deviceTwin.queryTwin(\"SELECT * FROM devices WHERE deviceId = '\" + testInstance.provisionedDeviceId +\"'\");\n-        assertTrue(CorrelationDetailsLoggingAssert.buildExceptionMessageDpsIndividualOrGroup(\"Provisioned device \" + testInstance.provisionedDeviceId + \"not found in expected hub\", getHostName(provisioningServiceConnectionString), testInstance.groupId, testInstance.registrationId), deviceTwin.hasNextDeviceTwin(query));\n+\n+        boolean deviceFoundInCorrectHub = false;\n+        Query query = null;\n+        long startTime = System.currentTimeMillis();\n+        while (!deviceFoundInCorrectHub)", "originalCommit": "c5eeb15cb746d7b50657d4e01beb7f7ce3b8deb0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYxNDE3Mg==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/892#discussion_r469614172", "bodyText": "Only if the device never becomes queryable in this hub, which should never happen", "author": "timtay-microsoft", "createdAt": "2020-08-13T00:05:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYxMzA3MQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "412c50608b75c71825764f556734dc85d8017b83", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/412c50608b75c71825764f556734dc85d8017b83", "message": "Merge branch 'master' into timtay/provisioningFix", "committedDate": "2020-08-13T00:31:17Z", "type": "commit"}, {"oid": "35d142a2b0de4f8421955f5bfc66a631b0dde27b", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/35d142a2b0de4f8421955f5bfc66a631b0dde27b", "message": "Merge branch 'master' into timtay/provisioningFix", "committedDate": "2020-08-13T01:54:50Z", "type": "commit"}]}