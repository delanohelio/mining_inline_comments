{"pr_number": 1001, "pr_title": "feat(security-provider): Add helper function to compute derived symmetric keys, add samples", "pr_createdAt": "2020-11-18T20:17:46Z", "pr_url": "https://github.com/Azure/azure-iot-sdk-java/pull/1001", "timeline": [{"oid": "9cf0d9afbda9fa69015ae7044abbdc0e332e5070", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/9cf0d9afbda9fa69015ae7044abbdc0e332e5070", "message": "feat(security-provider): Add helper function to compute derived symmetric keys, add samples\n\nSymmetric key authentication works a bit differently for individual enrollments and enrollment groups. For enrollment groups, users are expected to compute a derived key for each device provisioned under that group. Previously, we didn't expose a function to do that, or have documentation to explain that users have to do it.\n\nThis commit splits the symmetric key provisioning samples into individual and group samples so that we can better show the differences in how these flows work. It also exposes a helper function for computing this derived key for convenience.", "committedDate": "2020-11-18T20:17:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM5Mjg2MQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/1001#discussion_r526392861", "bodyText": "We had this helper function in test code, but it would fit nicely as a helper function in our security provider class itself.", "author": "timtay-microsoft", "createdAt": "2020-11-18T20:18:20Z", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/provisioning/setup/ProvisioningCommon.java", "diffHunk": "@@ -606,13 +604,4 @@ private void createTestIndividualEnrollment(Attestation attestation, AllocationP\n         testInstance.individualEnrollment.setInitialTwin(twinState);\n         testInstance.individualEnrollment = testInstance.provisioningServiceClient.createOrUpdateIndividualEnrollment(testInstance.individualEnrollment);\n     }\n-\n-    public static byte[] ComputeDerivedSymmetricKey(String masterKey, String registrationId) throws InvalidKeyException, NoSuchAlgorithmException", "originalCommit": "9cf0d9afbda9fa69015ae7044abbdc0e332e5070", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "e89d95b0c540607f94dfde5b63893f055c1598c0", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/e89d95b0c540607f94dfde5b63893f055c1598c0", "message": "fixup", "committedDate": "2020-11-18T20:19:21Z", "type": "commit"}, {"oid": "d7daff7d42509edb24ff30774018411ac151b069", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/d7daff7d42509edb24ff30774018411ac151b069", "message": "fixup", "committedDate": "2020-11-18T20:25:44Z", "type": "commit"}, {"oid": "2548a0a035fa58deeb6c7a42db3724e15277df77", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/2548a0a035fa58deeb6c7a42db3724e15277df77", "message": "fixup", "committedDate": "2020-11-18T20:26:11Z", "type": "commit"}, {"oid": "107748472105a88bd496ff3c72c95c2fc0e7c8bb", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/107748472105a88bd496ff3c72c95c2fc0e7c8bb", "message": "fixup", "committedDate": "2020-11-18T20:31:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM5ODkyMQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/1001#discussion_r526398921", "bodyText": "nit: maybe rename this to be \"SYMMETRIC_KEY_ENROLLMENT_GROUP\"?", "author": "abhipsaMisra", "createdAt": "2020-11-18T20:27:06Z", "path": "provisioning/provisioning-samples/provisioning-symmetrickey-group-sample/src/main/java/samples/com/microsoft/azure/sdk/iot/ProvisioningSymmetricKeyEnrollmentGroupSample.java", "diffHunk": "@@ -0,0 +1,170 @@\n+/*\n+ *\n+ *  Copyright (c) Microsoft. All rights reserved.\n+ *  Licensed under the MIT license. See LICENSE file in the project root for full license information.\n+ *\n+ */\n+\n+package samples.com.microsoft.azure.sdk.iot;\n+\n+import com.microsoft.azure.sdk.iot.device.*;\n+import com.microsoft.azure.sdk.iot.provisioning.device.*;\n+import com.microsoft.azure.sdk.iot.provisioning.device.internal.exceptions.ProvisioningDeviceClientException;\n+import com.microsoft.azure.sdk.iot.provisioning.security.SecurityProviderSymmetricKey;\n+\n+import java.io.IOException;\n+import java.util.Scanner;\n+\n+/**\n+ * Symmetric Key authenticated enrollment group sample\n+ */\n+public class ProvisioningSymmetricKeyEnrollmentGroupSample\n+{\n+    // The scope Id of your DPS instance. This value can be retrieved from the Azure Portal\n+    private static final String SCOPE_ID = \"[Your scope ID here]\";\n+\n+    // Typically \"global.azure-devices-provisioning.net\"\n+    private static final String GLOBAL_ENDPOINT = \"[Your Provisioning Service Global Endpoint here]\";\n+\n+    // The symmetric key of the enrollment group. Unlike with individual enrollments, this key cannot be used directly when provisioning a device.\n+    // Instead, this sample will demonstrate how to derive the symmetric key for your particular device within the enrollment group.\n+    private static final String SYMMETRIC_KEY = \"[Enter your Symmetric Key here]\";", "originalCommit": "e89d95b0c540607f94dfde5b63893f055c1598c0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "107748472105a88bd496ff3c72c95c2fc0e7c8bb", "chunk": "diff --git a/provisioning/provisioning-samples/provisioning-symmetrickey-group-sample/src/main/java/samples/com/microsoft/azure/sdk/iot/ProvisioningSymmetricKeyEnrollmentGroupSample.java b/provisioning/provisioning-samples/provisioning-symmetrickey-group-sample/src/main/java/samples/com/microsoft/azure/sdk/iot/ProvisioningSymmetricKeyEnrollmentGroupSample.java\nindex cc22b6bf2..01a2d824f 100644\n--- a/provisioning/provisioning-samples/provisioning-symmetrickey-group-sample/src/main/java/samples/com/microsoft/azure/sdk/iot/ProvisioningSymmetricKeyEnrollmentGroupSample.java\n+++ b/provisioning/provisioning-samples/provisioning-symmetrickey-group-sample/src/main/java/samples/com/microsoft/azure/sdk/iot/ProvisioningSymmetricKeyEnrollmentGroupSample.java\n\n@@ -13,6 +13,7 @@ import com.microsoft.azure.sdk.iot.provisioning.device.internal.exceptions.Provi\n import com.microsoft.azure.sdk.iot.provisioning.security.SecurityProviderSymmetricKey;\n \n import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n import java.util.Scanner;\n \n /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM5OTk3MQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/1001#discussion_r526399971", "bodyText": "good to know \ud83d\udc4d", "author": "abhipsaMisra", "createdAt": "2020-11-18T20:29:01Z", "path": "provisioning/provisioning-samples/provisioning-symmetrickey-group-sample/src/main/java/samples/com/microsoft/azure/sdk/iot/ProvisioningSymmetricKeyEnrollmentGroupSample.java", "diffHunk": "@@ -0,0 +1,171 @@\n+/*\n+ *\n+ *  Copyright (c) Microsoft. All rights reserved.\n+ *  Licensed under the MIT license. See LICENSE file in the project root for full license information.\n+ *\n+ */\n+\n+package samples.com.microsoft.azure.sdk.iot;\n+\n+import com.microsoft.azure.sdk.iot.device.*;\n+import com.microsoft.azure.sdk.iot.provisioning.device.*;\n+import com.microsoft.azure.sdk.iot.provisioning.device.internal.exceptions.ProvisioningDeviceClientException;\n+import com.microsoft.azure.sdk.iot.provisioning.security.SecurityProviderSymmetricKey;\n+\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.Scanner;\n+\n+/**\n+ * Symmetric Key authenticated enrollment group sample\n+ */\n+public class ProvisioningSymmetricKeyEnrollmentGroupSample\n+{\n+    // The scope Id of your DPS instance. This value can be retrieved from the Azure Portal\n+    private static final String SCOPE_ID = \"[Your scope ID here]\";\n+\n+    // Typically \"global.azure-devices-provisioning.net\"\n+    private static final String GLOBAL_ENDPOINT = \"[Your Provisioning Service Global Endpoint here]\";\n+\n+    // The symmetric key of the enrollment group. Unlike with individual enrollments, this key cannot be used directly when provisioning a device.\n+    // Instead, this sample will demonstrate how to derive the symmetric key for your particular device within the enrollment group.\n+    private static final String SYMMETRIC_KEY = \"[Enter your Symmetric Key here]\";\n+\n+    // The Id to assign to this device when it is provisioned to an IoT Hub. This value is arbitrary outside of some\n+    // character limitations. For sample purposes, this value is filled in for you, but it may be changed.\n+    private static final String PROVISIONED_DEVICE_ID = \"myProvisionedDevice\";\n+\n+    // Uncomment one line to choose which protocol you'd like to use\n+    private static final ProvisioningDeviceClientTransportProtocol PROVISIONING_DEVICE_CLIENT_TRANSPORT_PROTOCOL = ProvisioningDeviceClientTransportProtocol.HTTPS;\n+    //private static final ProvisioningDeviceClientTransportProtocol PROVISIONING_DEVICE_CLIENT_TRANSPORT_PROTOCOL = ProvisioningDeviceClientTransportProtocol.MQTT;\n+    //private static final ProvisioningDeviceClientTransportProtocol PROVISIONING_DEVICE_CLIENT_TRANSPORT_PROTOCOL = ProvisioningDeviceClientTransportProtocol.MQTT_WS;\n+    //private static final ProvisioningDeviceClientTransportProtocol PROVISIONING_DEVICE_CLIENT_TRANSPORT_PROTOCOL = ProvisioningDeviceClientTransportProtocol.AMQPS;\n+    //private static final ProvisioningDeviceClientTransportProtocol PROVISIONING_DEVICE_CLIENT_TRANSPORT_PROTOCOL = ProvisioningDeviceClientTransportProtocol.AMQPS_WS;\n+\n+    private static final int MAX_TIME_TO_WAIT_FOR_REGISTRATION = 10000; // in milliseconds\n+\n+    static class ProvisioningStatus\n+    {\n+        ProvisioningDeviceClientRegistrationResult provisioningDeviceClientRegistrationInfoClient = new ProvisioningDeviceClientRegistrationResult();\n+        Exception exception;\n+    }\n+\n+    static class ProvisioningDeviceClientRegistrationCallbackImpl implements ProvisioningDeviceClientRegistrationCallback\n+    {\n+        @Override\n+        public void run(ProvisioningDeviceClientRegistrationResult provisioningDeviceClientRegistrationResult, Exception exception, Object context)\n+        {\n+            if (context instanceof ProvisioningStatus)\n+            {\n+                ProvisioningStatus status = (ProvisioningStatus) context;\n+                status.provisioningDeviceClientRegistrationInfoClient = provisioningDeviceClientRegistrationResult;\n+                status.exception = exception;\n+            }\n+            else\n+            {\n+                System.out.println(\"Received unknown context\");\n+            }\n+        }\n+    }\n+\n+    private static class IotHubEventCallbackImpl implements IotHubEventCallback\n+    {\n+        @Override\n+        public void execute(IotHubStatusCode responseStatus, Object callbackContext)\n+        {\n+            System.out.println(\"Message received! Response status: \" + responseStatus);\n+        }\n+    }\n+\n+    public static void main(String[] args) throws Exception\n+    {\n+        System.out.println(\"Starting...\");\n+        System.out.println(\"Beginning setup.\");\n+        SecurityProviderSymmetricKey securityClientSymmetricKey = null;\n+        Scanner scanner = new Scanner(System.in);\n+        DeviceClient deviceClient = null;\n+\n+        // Since enrollment groups can be used to provision more than one device, the service requires you to derive the\n+        // symmetric key for your device to provision based on the symmetric key of the enrollment group, and the desired\n+        // device Id of the device you are provisioning\n+\n+        // For the sake of security, you shouldn't save keys into String variables as that places them in heap memory. For the sake\n+        // of simplicity within this sample, though, we will save it as a string. Typically this key would be loaded as byte[] so that\n+        // it can be removed from stack memory.", "originalCommit": "2548a0a035fa58deeb6c7a42db3724e15277df77", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0898b5f7c6277175da5b939e39b3555f84eb06d7", "chunk": "diff --git a/provisioning/provisioning-samples/provisioning-symmetrickey-group-sample/src/main/java/samples/com/microsoft/azure/sdk/iot/ProvisioningSymmetricKeyEnrollmentGroupSample.java b/provisioning/provisioning-samples/provisioning-symmetrickey-group-sample/src/main/java/samples/com/microsoft/azure/sdk/iot/ProvisioningSymmetricKeyEnrollmentGroupSample.java\nindex 01a2d824f..d8881a3d1 100644\n--- a/provisioning/provisioning-samples/provisioning-symmetrickey-group-sample/src/main/java/samples/com/microsoft/azure/sdk/iot/ProvisioningSymmetricKeyEnrollmentGroupSample.java\n+++ b/provisioning/provisioning-samples/provisioning-symmetrickey-group-sample/src/main/java/samples/com/microsoft/azure/sdk/iot/ProvisioningSymmetricKeyEnrollmentGroupSample.java\n\n@@ -29,7 +29,7 @@ public class ProvisioningSymmetricKeyEnrollmentGroupSample\n \n     // The symmetric key of the enrollment group. Unlike with individual enrollments, this key cannot be used directly when provisioning a device.\n     // Instead, this sample will demonstrate how to derive the symmetric key for your particular device within the enrollment group.\n-    private static final String SYMMETRIC_KEY = \"[Enter your Symmetric Key here]\";\n+    private static final String ENROLLMENT_GROUP_SYMMETRIC_KEY = \"[Enter your Symmetric Key here]\";\n \n     // The Id to assign to this device when it is provisioned to an IoT Hub. This value is arbitrary outside of some\n     // character limitations. For sample purposes, this value is filled in for you, but it may be changed.\n"}}, {"oid": "0898b5f7c6277175da5b939e39b3555f84eb06d7", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/0898b5f7c6277175da5b939e39b3555f84eb06d7", "message": "fixup", "committedDate": "2020-11-18T20:36:00Z", "type": "commit"}, {"oid": "d58fdc010a45f62b4e01f6f815699e3f4697c4a9", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/d58fdc010a45f62b4e01f6f815699e3f4697c4a9", "message": "fixup", "committedDate": "2020-11-18T21:32:32Z", "type": "commit"}]}