{"pr_number": 1019, "pr_title": "fix(iot-dev): Fix issue where unregistering a multiplexed device that isn't registered loops infinitely", "pr_createdAt": "2020-12-08T19:01:15Z", "pr_url": "https://github.com/Azure/azure-iot-sdk-java/pull/1019", "timeline": [{"oid": "3d9e2cebb13848d306612388f69270979d86ec5a", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/3d9e2cebb13848d306612388f69270979d86ec5a", "message": "fix(iot-dev): Fix issue where unregistering a multiplexed device that isn't registered loops infinitely", "committedDate": "2020-12-08T19:00:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODcyOTg5Ng==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/1019#discussion_r538729896", "bodyText": "The issue here was that this code forgot to add this config to the set of \"successfully\" unregistered configs so that the end of the function could remove it from the queue of configs to unregister. It can't be removed at this point since that would be a concurrent modification exception since this function loops over that queue.", "author": "timtay-microsoft", "createdAt": "2020-12-08T19:03:21Z", "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java", "diffHunk": "@@ -952,41 +952,41 @@ private void checkForNewlyUnregisteredMultiplexedClientsToStop()\n             {\n                 log.trace(\"Removing session handler for device {}\", amqpsSessionHandler.getDeviceId());\n                 this.sessionHandlers.remove(amqpsSessionHandler);\n-            }\n-            else\n-            {\n-                log.warn(\"Attempted to remove device session for device {} from multiplexed connection, but device was not currently registered.\", configToUnregister.getDeviceId());\n-                return;", "originalCommit": "3d9e2cebb13848d306612388f69270979d86ec5a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a3e5e9b76b0a89a521e484c0c7b56066b2a4876e", "chunk": "diff --git a/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java b/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java\nindex 3b667eae6..d013098ce 100644\n--- a/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java\n+++ b/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java\n\n@@ -986,6 +986,7 @@ public final class AmqpsIotHubConnection extends BaseHandler implements IotHubTr\n             {\n                 log.warn(\"Attempted to remove device session for device {} from multiplexed connection, but device was not currently registered.\", configToUnregister.getDeviceId());\n                 configsUnregisteredSuccessfully.add(configToUnregister);\n+                configToUnregister = configsToUnregisterIterator.hasNext() ? configsToUnregisterIterator.next() : null;\n             }\n         }\n \n"}}, {"oid": "a3e5e9b76b0a89a521e484c0c7b56066b2a4876e", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/a3e5e9b76b0a89a521e484c0c7b56066b2a4876e", "message": "fixup", "committedDate": "2020-12-08T19:12:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc0MDUxMg==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/1019#discussion_r538740512", "bodyText": "this line and the one after happen regardless what the code flow is. Maybe move outside the if/else.", "author": "barustum", "createdAt": "2020-12-08T19:19:42Z", "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java", "diffHunk": "@@ -952,41 +952,42 @@ private void checkForNewlyUnregisteredMultiplexedClientsToStop()\n             {\n                 log.trace(\"Removing session handler for device {}\", amqpsSessionHandler.getDeviceId());\n                 this.sessionHandlers.remove(amqpsSessionHandler);\n-            }\n-            else\n-            {\n-                log.warn(\"Attempted to remove device session for device {} from multiplexed connection, but device was not currently registered.\", configToUnregister.getDeviceId());\n-                return;\n-            }\n \n-            // Need to find the sas token renewal handler that is tied to this device\n-            AmqpsSasTokenRenewalHandler sasTokenRenewalHandlerToRemove = null;\n-            for (AmqpsSasTokenRenewalHandler existingSasTokenRenewalHandler : this.sasTokenRenewalHandlers)\n-            {\n-                if (existingSasTokenRenewalHandler.amqpsSessionHandler.getDeviceId().equals(configToUnregister.getDeviceId()))\n+                // Need to find the sas token renewal handler that is tied to this device\n+                AmqpsSasTokenRenewalHandler sasTokenRenewalHandlerToRemove = null;\n+                for (AmqpsSasTokenRenewalHandler existingSasTokenRenewalHandler : this.sasTokenRenewalHandlers)\n                 {\n-                    sasTokenRenewalHandlerToRemove = existingSasTokenRenewalHandler;\n+                    if (existingSasTokenRenewalHandler.amqpsSessionHandler.getDeviceId().equals(configToUnregister.getDeviceId()))\n+                    {\n+                        sasTokenRenewalHandlerToRemove = existingSasTokenRenewalHandler;\n \n-                    // Stop the sas token renewal handler from sending any more authentication messages on behalf of this device\n-                    log.trace(\"Closing sas token renewal handler for device {}\", configToUnregister.getDeviceId());\n-                    sasTokenRenewalHandlerToRemove.close();\n-                    break;\n+                        // Stop the sas token renewal handler from sending any more authentication messages on behalf of this device\n+                        log.trace(\"Closing sas token renewal handler for device {}\", configToUnregister.getDeviceId());\n+                        sasTokenRenewalHandlerToRemove.close();\n+                        break;\n+                    }\n                 }\n-            }\n \n-            if (sasTokenRenewalHandlerToRemove != null)\n-            {\n-                this.sasTokenRenewalHandlers.remove(sasTokenRenewalHandlerToRemove);\n-            }\n+                if (sasTokenRenewalHandlerToRemove != null)\n+                {\n+                    this.sasTokenRenewalHandlers.remove(sasTokenRenewalHandlerToRemove);\n+                }\n \n-            this.reconnectionsScheduled.remove(configToUnregister.getDeviceId());\n+                this.reconnectionsScheduled.remove(configToUnregister.getDeviceId());\n \n-            log.debug(\"Closing device session for multiplexed device {}\", configToUnregister.getDeviceId());\n-            amqpsSessionHandler.closeSession();\n+                log.debug(\"Closing device session for multiplexed device {}\", configToUnregister.getDeviceId());\n+                amqpsSessionHandler.closeSession();\n \n-            configsUnregisteredSuccessfully.add(configToUnregister);\n+                configsUnregisteredSuccessfully.add(configToUnregister);\n \n-            configToUnregister = configsToUnregisterIterator.hasNext() ? configsToUnregisterIterator.next() : null;\n+                configToUnregister = configsToUnregisterIterator.hasNext() ? configsToUnregisterIterator.next() : null;\n+            }\n+            else\n+            {\n+                log.warn(\"Attempted to remove device session for device {} from multiplexed connection, but device was not currently registered.\", configToUnregister.getDeviceId());\n+                configsUnregisteredSuccessfully.add(configToUnregister);", "originalCommit": "a3e5e9b76b0a89a521e484c0c7b56066b2a4876e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc0MzcxMQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/1019#discussion_r538743711", "bodyText": "Good catch, will do!", "author": "timtay-microsoft", "createdAt": "2020-12-08T19:24:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc0MDUxMg=="}], "type": "inlineReview", "revised_code": {"commit": "e2e1d53e1635c0ddfb4ce950450ab76998070a32", "chunk": "diff --git a/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java b/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java\nindex d013098ce..c394aae52 100644\n--- a/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java\n+++ b/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java\n\n@@ -977,17 +977,15 @@ public final class AmqpsIotHubConnection extends BaseHandler implements IotHubTr\n \n                 log.debug(\"Closing device session for multiplexed device {}\", configToUnregister.getDeviceId());\n                 amqpsSessionHandler.closeSession();\n-\n-                configsUnregisteredSuccessfully.add(configToUnregister);\n-\n-                configToUnregister = configsToUnregisterIterator.hasNext() ? configsToUnregisterIterator.next() : null;\n             }\n             else\n             {\n                 log.warn(\"Attempted to remove device session for device {} from multiplexed connection, but device was not currently registered.\", configToUnregister.getDeviceId());\n-                configsUnregisteredSuccessfully.add(configToUnregister);\n-                configToUnregister = configsToUnregisterIterator.hasNext() ? configsToUnregisterIterator.next() : null;\n             }\n+\n+            configsUnregisteredSuccessfully.add(configToUnregister);\n+            configToUnregister = configsToUnregisterIterator.hasNext() ? configsToUnregisterIterator.next() : null;\n+\n         }\n \n         this.multiplexingClientsToUnregister.removeAll(configsUnregisteredSuccessfully);\n"}}, {"oid": "e2e1d53e1635c0ddfb4ce950450ab76998070a32", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/e2e1d53e1635c0ddfb4ce950450ab76998070a32", "message": "fixup", "committedDate": "2020-12-08T19:24:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc0NjU0MQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/1019#discussion_r538746541", "bodyText": "extra space before closing brace", "author": "barustum", "createdAt": "2020-12-08T19:28:59Z", "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java", "diffHunk": "@@ -952,41 +952,40 @@ private void checkForNewlyUnregisteredMultiplexedClientsToStop()\n             {\n                 log.trace(\"Removing session handler for device {}\", amqpsSessionHandler.getDeviceId());\n                 this.sessionHandlers.remove(amqpsSessionHandler);\n-            }\n-            else\n-            {\n-                log.warn(\"Attempted to remove device session for device {} from multiplexed connection, but device was not currently registered.\", configToUnregister.getDeviceId());\n-                return;\n-            }\n \n-            // Need to find the sas token renewal handler that is tied to this device\n-            AmqpsSasTokenRenewalHandler sasTokenRenewalHandlerToRemove = null;\n-            for (AmqpsSasTokenRenewalHandler existingSasTokenRenewalHandler : this.sasTokenRenewalHandlers)\n-            {\n-                if (existingSasTokenRenewalHandler.amqpsSessionHandler.getDeviceId().equals(configToUnregister.getDeviceId()))\n+                // Need to find the sas token renewal handler that is tied to this device\n+                AmqpsSasTokenRenewalHandler sasTokenRenewalHandlerToRemove = null;\n+                for (AmqpsSasTokenRenewalHandler existingSasTokenRenewalHandler : this.sasTokenRenewalHandlers)\n                 {\n-                    sasTokenRenewalHandlerToRemove = existingSasTokenRenewalHandler;\n+                    if (existingSasTokenRenewalHandler.amqpsSessionHandler.getDeviceId().equals(configToUnregister.getDeviceId()))\n+                    {\n+                        sasTokenRenewalHandlerToRemove = existingSasTokenRenewalHandler;\n \n-                    // Stop the sas token renewal handler from sending any more authentication messages on behalf of this device\n-                    log.trace(\"Closing sas token renewal handler for device {}\", configToUnregister.getDeviceId());\n-                    sasTokenRenewalHandlerToRemove.close();\n-                    break;\n+                        // Stop the sas token renewal handler from sending any more authentication messages on behalf of this device\n+                        log.trace(\"Closing sas token renewal handler for device {}\", configToUnregister.getDeviceId());\n+                        sasTokenRenewalHandlerToRemove.close();\n+                        break;\n+                    }\n                 }\n-            }\n \n-            if (sasTokenRenewalHandlerToRemove != null)\n-            {\n-                this.sasTokenRenewalHandlers.remove(sasTokenRenewalHandlerToRemove);\n-            }\n+                if (sasTokenRenewalHandlerToRemove != null)\n+                {\n+                    this.sasTokenRenewalHandlers.remove(sasTokenRenewalHandlerToRemove);\n+                }\n \n-            this.reconnectionsScheduled.remove(configToUnregister.getDeviceId());\n+                this.reconnectionsScheduled.remove(configToUnregister.getDeviceId());\n \n-            log.debug(\"Closing device session for multiplexed device {}\", configToUnregister.getDeviceId());\n-            amqpsSessionHandler.closeSession();\n+                log.debug(\"Closing device session for multiplexed device {}\", configToUnregister.getDeviceId());\n+                amqpsSessionHandler.closeSession();\n+            }\n+            else\n+            {\n+                log.warn(\"Attempted to remove device session for device {} from multiplexed connection, but device was not currently registered.\", configToUnregister.getDeviceId());\n+            }\n \n             configsUnregisteredSuccessfully.add(configToUnregister);\n-\n             configToUnregister = configsToUnregisterIterator.hasNext() ? configsToUnregisterIterator.next() : null;\n+", "originalCommit": "e2e1d53e1635c0ddfb4ce950450ab76998070a32", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "563ae1cd60c760ba716b3d6046a63b35757c7f97", "chunk": "diff --git a/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java b/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java\nindex c394aae52..48035800e 100644\n--- a/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java\n+++ b/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java\n\n@@ -947,8 +947,12 @@ public final class AmqpsIotHubConnection extends BaseHandler implements IotHubTr\n                 }\n             }\n \n-            // If a device session currently exists for this device identity, then remove it\n-            if (amqpsSessionHandler != null)\n+            // If a device session doesn't currently exist for this device identity\n+            if (amqpsSessionHandler == null)\n+            {\n+                log.warn(\"Attempted to remove device session for device {} from multiplexed connection, but device was not currently registered.\", configToUnregister.getDeviceId());\n+            }\n+            else\n             {\n                 log.trace(\"Removing session handler for device {}\", amqpsSessionHandler.getDeviceId());\n                 this.sessionHandlers.remove(amqpsSessionHandler);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc0ODQzNg==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/1019#discussion_r538748436", "bodyText": "consider handling the error/smaller case first, so both blocks appear closer to the if condition. Otherwise, by the time a reader gets down here they've lost the context of what else means.", "author": "drwill-ms", "createdAt": "2020-12-08T19:31:56Z", "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java", "diffHunk": "@@ -952,41 +952,40 @@ private void checkForNewlyUnregisteredMultiplexedClientsToStop()\n             {\n                 log.trace(\"Removing session handler for device {}\", amqpsSessionHandler.getDeviceId());\n                 this.sessionHandlers.remove(amqpsSessionHandler);\n-            }\n-            else\n-            {\n-                log.warn(\"Attempted to remove device session for device {} from multiplexed connection, but device was not currently registered.\", configToUnregister.getDeviceId());\n-                return;\n-            }\n \n-            // Need to find the sas token renewal handler that is tied to this device\n-            AmqpsSasTokenRenewalHandler sasTokenRenewalHandlerToRemove = null;\n-            for (AmqpsSasTokenRenewalHandler existingSasTokenRenewalHandler : this.sasTokenRenewalHandlers)\n-            {\n-                if (existingSasTokenRenewalHandler.amqpsSessionHandler.getDeviceId().equals(configToUnregister.getDeviceId()))\n+                // Need to find the sas token renewal handler that is tied to this device\n+                AmqpsSasTokenRenewalHandler sasTokenRenewalHandlerToRemove = null;\n+                for (AmqpsSasTokenRenewalHandler existingSasTokenRenewalHandler : this.sasTokenRenewalHandlers)\n                 {\n-                    sasTokenRenewalHandlerToRemove = existingSasTokenRenewalHandler;\n+                    if (existingSasTokenRenewalHandler.amqpsSessionHandler.getDeviceId().equals(configToUnregister.getDeviceId()))\n+                    {\n+                        sasTokenRenewalHandlerToRemove = existingSasTokenRenewalHandler;\n \n-                    // Stop the sas token renewal handler from sending any more authentication messages on behalf of this device\n-                    log.trace(\"Closing sas token renewal handler for device {}\", configToUnregister.getDeviceId());\n-                    sasTokenRenewalHandlerToRemove.close();\n-                    break;\n+                        // Stop the sas token renewal handler from sending any more authentication messages on behalf of this device\n+                        log.trace(\"Closing sas token renewal handler for device {}\", configToUnregister.getDeviceId());\n+                        sasTokenRenewalHandlerToRemove.close();\n+                        break;\n+                    }\n                 }\n-            }\n \n-            if (sasTokenRenewalHandlerToRemove != null)\n-            {\n-                this.sasTokenRenewalHandlers.remove(sasTokenRenewalHandlerToRemove);\n-            }\n+                if (sasTokenRenewalHandlerToRemove != null)\n+                {\n+                    this.sasTokenRenewalHandlers.remove(sasTokenRenewalHandlerToRemove);\n+                }\n \n-            this.reconnectionsScheduled.remove(configToUnregister.getDeviceId());\n+                this.reconnectionsScheduled.remove(configToUnregister.getDeviceId());\n \n-            log.debug(\"Closing device session for multiplexed device {}\", configToUnregister.getDeviceId());\n-            amqpsSessionHandler.closeSession();\n+                log.debug(\"Closing device session for multiplexed device {}\", configToUnregister.getDeviceId());\n+                amqpsSessionHandler.closeSession();\n+            }\n+            else", "originalCommit": "e2e1d53e1635c0ddfb4ce950450ab76998070a32", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "563ae1cd60c760ba716b3d6046a63b35757c7f97", "chunk": "diff --git a/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java b/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java\nindex c394aae52..48035800e 100644\n--- a/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java\n+++ b/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java\n\n@@ -947,8 +947,12 @@ public final class AmqpsIotHubConnection extends BaseHandler implements IotHubTr\n                 }\n             }\n \n-            // If a device session currently exists for this device identity, then remove it\n-            if (amqpsSessionHandler != null)\n+            // If a device session doesn't currently exist for this device identity\n+            if (amqpsSessionHandler == null)\n+            {\n+                log.warn(\"Attempted to remove device session for device {} from multiplexed connection, but device was not currently registered.\", configToUnregister.getDeviceId());\n+            }\n+            else\n             {\n                 log.trace(\"Removing session handler for device {}\", amqpsSessionHandler.getDeviceId());\n                 this.sessionHandlers.remove(amqpsSessionHandler);\n"}}, {"oid": "563ae1cd60c760ba716b3d6046a63b35757c7f97", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/563ae1cd60c760ba716b3d6046a63b35757c7f97", "message": "fixup", "committedDate": "2020-12-08T19:37:44Z", "type": "commit"}]}