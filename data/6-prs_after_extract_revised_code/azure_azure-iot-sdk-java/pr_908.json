{"pr_number": 908, "pr_title": "feat(device-client): Add configuration for amqp authentication and device session timeouts", "pr_createdAt": "2020-09-04T21:11:54Z", "pr_url": "https://github.com/Azure/azure-iot-sdk-java/pull/908", "timeline": [{"oid": "b69d0ef4390be0d3997e69f4127860d148203e2e", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/b69d0ef4390be0d3997e69f4127860d148203e2e", "message": "feat(device-client): Add configuration for amqp authentication and device session timeouts", "committedDate": "2020-09-08T16:58:48Z", "type": "forcePushed"}, {"oid": "58d0fa6294680ad13f092cac70d785791594149b", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/58d0fa6294680ad13f092cac70d785791594149b", "message": "feat(device-client): Add configuration for amqp authentication and device session timeouts", "committedDate": "2020-09-11T23:06:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzMyNzgzOA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/908#discussion_r487327838", "bodyText": "This seemed like the best to validate that the correct exception is thrown. The exception type itself can be thrown for various reasons but we want to ensure it is thrown from the correct part of code.", "author": "vinagesh", "createdAt": "2020-09-11T23:09:53Z", "path": "device/iot-device-client/src/test/java/tests/unit/com/microsoft/azure/sdk/iot/device/DeviceClientTest.java", "diffHunk": "@@ -1988,6 +1988,364 @@ public void setCertificateAuthorityThrowsIfOpenTransportClient()\n \n     }\n \n+    @Test\n+    public void setAmqpOpenAuthenticationSessionTimeout()\n+    {\n+        //arrange\n+        final int timeoutInSeconds = 10;\n+        DeviceClient client = Deencapsulation.newInstance(DeviceClient.class);\n+        Deencapsulation.setField(client, \"config\", mockConfig);\n+\n+        new NonStrictExpectations()\n+        {\n+            {\n+                mockConfig.getProtocol();\n+                result = IotHubClientProtocol.AMQPS;\n+\n+                mockConfig.getAuthenticationType();\n+                result = DeviceClientConfig.AuthType.SAS_TOKEN;\n+            }\n+        };\n+\n+        //act\n+        client.setOption(\"SetAmqpOpenAuthenticationSessionTimeout\", timeoutInSeconds);\n+\n+        //assert\n+        new Verifications() {\n+            {\n+                Deencapsulation.invoke(mockConfig, \"setAmqpOpenAuthenticationSessionTimeout\", timeoutInSeconds);\n+                times = 1;\n+            }\n+        };\n+    }\n+\n+    @Test\n+    public void setAmqpWsOpenAuthenticationSessionTimeout()\n+    {\n+        //arrange\n+        final int timeoutInSeconds = 10;\n+        DeviceClient client = Deencapsulation.newInstance(DeviceClient.class);\n+        Deencapsulation.setField(client, \"config\", mockConfig);\n+\n+        new NonStrictExpectations()\n+        {\n+            {\n+                mockConfig.getProtocol();\n+                result = IotHubClientProtocol.AMQPS_WS;\n+\n+                mockConfig.getAuthenticationType();\n+                result = DeviceClientConfig.AuthType.SAS_TOKEN;\n+            }\n+        };\n+\n+        //act\n+        client.setOption(\"SetAmqpOpenAuthenticationSessionTimeout\", timeoutInSeconds);\n+\n+        //assert\n+        new Verifications() {\n+            {\n+                Deencapsulation.invoke(mockConfig, \"setAmqpOpenAuthenticationSessionTimeout\", timeoutInSeconds);\n+                times = 1;\n+            }\n+        };\n+    }\n+\n+    @Test\n+    public void setNullAmqpWsOpenAuthenticationSessionTimeoutThrows()\n+    {\n+        //arrange\n+        DeviceClient client = Deencapsulation.newInstance(DeviceClient.class);\n+        Deencapsulation.setField(client, \"config\", mockConfig);\n+\n+        try {\n+            //act\n+            client.setOption(\"setAmqpOpenAuthenticationSessionTimeout\", null);\n+        } catch (IllegalArgumentException expected) {", "originalCommit": "58d0fa6294680ad13f092cac70d785791594149b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "881eb730a5396324eaf36c7cb49ad94f66eb5381", "chunk": "diff --git a/device/iot-device-client/src/test/java/tests/unit/com/microsoft/azure/sdk/iot/device/DeviceClientTest.java b/device/iot-device-client/src/test/java/tests/unit/com/microsoft/azure/sdk/iot/device/DeviceClientTest.java\nindex e3823398b..a8079085c 100644\n--- a/device/iot-device-client/src/test/java/tests/unit/com/microsoft/azure/sdk/iot/device/DeviceClientTest.java\n+++ b/device/iot-device-client/src/test/java/tests/unit/com/microsoft/azure/sdk/iot/device/DeviceClientTest.java\n\n@@ -2062,7 +2062,7 @@ public class DeviceClientTest\n             client.setOption(\"setAmqpOpenAuthenticationSessionTimeout\", null);\n         } catch (IllegalArgumentException expected) {\n             //assert\n-            assertEquals(\"optionValue is null\", expected.getMessage());\n+            assertEquals(\"value is null\", expected.getMessage());\n         }\n     }\n \n"}}, {"oid": "4ed0c3de435484e61ed67764459a413879a0762e", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/4ed0c3de435484e61ed67764459a413879a0762e", "message": "feat(device-client): Add configuration for amqp authentication and device session timeouts", "committedDate": "2020-09-11T23:29:47Z", "type": "forcePushed"}, {"oid": "c651662c6ebc78c7497797c1375866fe131a7d1c", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/c651662c6ebc78c7497797c1375866fe131a7d1c", "message": "feat(device-client): Add configuration for amqp authentication and device session timeouts", "committedDate": "2020-09-18T17:02:46Z", "type": "forcePushed"}, {"oid": "304bc6a5257d2e52711f7b0ae357e3e70bc5ca26", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/304bc6a5257d2e52711f7b0ae357e3e70bc5ca26", "message": "feat(device-client): Add configuration for amqp authentication and device session timeouts", "committedDate": "2020-10-07T17:15:13Z", "type": "forcePushed"}, {"oid": "91f243b6b48eaba691f895825cd3efd9e76e1ced", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/91f243b6b48eaba691f895825cd3efd9e76e1ced", "message": "changed timeout units", "committedDate": "2020-10-07T23:42:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM3MTg0Mg==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/908#discussion_r501371842", "bodyText": "Include a postfix of \"_SECONDS\" to these two constants to really drive home that they are in terms of seconds", "author": "timtay-microsoft", "createdAt": "2020-10-07T23:45:39Z", "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/DeviceClientConfig.java", "diffHunk": "@@ -31,6 +31,9 @@\n     private static final int DEFAULT_HTTPS_READ_TIMEOUT_MILLIS = 240000;\n     private static final int DEFAULT_HTTPS_CONNECT_TIMEOUT_MILLIS = 0; //no connect timeout\n \n+    private static final int DEFAULT_AMQP_OPEN_AUTHENTICATION_SESSION_TIMEOUT = 20; // 20 second timeout\n+    private static final int DEFAULT_AMQP_OPEN_DEVICE_SESSIONS_TIMEOUT = 60; // 60 second timeout", "originalCommit": "91f243b6b48eaba691f895825cd3efd9e76e1ced", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM3MjUwMA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/908#discussion_r501372500", "bodyText": "good idea. The name was too long so I was on the fence but it would be better.", "author": "vinagesh", "createdAt": "2020-10-07T23:47:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM3MTg0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "31ad7f7b750b1e6c4958ba142845e2008be23c99", "chunk": "diff --git a/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/DeviceClientConfig.java b/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/DeviceClientConfig.java\nindex 2824db008..f58bad65c 100644\n--- a/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/DeviceClientConfig.java\n+++ b/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/DeviceClientConfig.java\n\n@@ -31,8 +31,8 @@ public final class DeviceClientConfig\n     private static final int DEFAULT_HTTPS_READ_TIMEOUT_MILLIS = 240000;\n     private static final int DEFAULT_HTTPS_CONNECT_TIMEOUT_MILLIS = 0; //no connect timeout\n \n-    private static final int DEFAULT_AMQP_OPEN_AUTHENTICATION_SESSION_TIMEOUT = 20; // 20 second timeout\n-    private static final int DEFAULT_AMQP_OPEN_DEVICE_SESSIONS_TIMEOUT = 60; // 60 second timeout\n+    private static final int DEFAULT_AMQP_OPEN_AUTHENTICATION_SESSION_TIMEOUT_IN_SECONDS = 20; // 20 second timeout\n+    private static final int DEFAULT_AMQP_OPEN_DEVICE_SESSIONS_TIMEOUT_IN_SECONDS = 60; // 60 second timeout\n \n     /** The default value for messageLockTimeoutSecs. */\n     private static final int DEFAULT_MESSAGE_LOCK_TIMEOUT_SECS = 180;\n"}}, {"oid": "31ad7f7b750b1e6c4958ba142845e2008be23c99", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/31ad7f7b750b1e6c4958ba142845e2008be23c99", "message": "changed timeout units", "committedDate": "2020-10-07T23:51:20Z", "type": "forcePushed"}, {"oid": "1b8d91d2524992f45835d93ab78de7f0f46a0b1a", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/1b8d91d2524992f45835d93ab78de7f0f46a0b1a", "message": "feat(device-client): Add configuration for amqp authentication and device session timeouts", "committedDate": "2020-10-07T23:52:25Z", "type": "commit"}, {"oid": "d67c4b4765e07b658d67bc25d75ab155d75df388", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/d67c4b4765e07b658d67bc25d75ab155d75df388", "message": "changed timeout units", "committedDate": "2020-10-07T23:52:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg3OTI4Mw==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/908#discussion_r501879283", "bodyText": "should it match the parameter name of \"value\"?", "author": "drwill-ms", "createdAt": "2020-10-08T17:10:11Z", "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/DeviceClient.java", "diffHunk": "@@ -725,7 +735,7 @@ public void setOption(String optionName, Object value) throws IllegalArgumentExc\n         else if (value == null)\n         {\n             // Codes_SRS_DEVICECLIENT_12_026: [The function shall trow IllegalArgumentException if the value is null.]\n-            throw new IllegalArgumentException(\"optionName is null\");\n+            throw new IllegalArgumentException(\"optionValue is null\");", "originalCommit": "d67c4b4765e07b658d67bc25d75ab155d75df388", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg4MDQwMw==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/908#discussion_r501880403", "bodyText": "I think it makes sense. the setOption has optionName and value and not optionValue.", "author": "vinagesh", "createdAt": "2020-10-08T17:11:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg3OTI4Mw=="}], "type": "inlineReview", "revised_code": {"commit": "c0c23a57c69d3bfb027def4dbb303d6469fc3bdc", "chunk": "diff --git a/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/DeviceClient.java b/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/DeviceClient.java\nindex 6ef2b28bb..c703e1a69 100644\n--- a/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/DeviceClient.java\n+++ b/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/DeviceClient.java\n\n@@ -735,7 +735,7 @@ public final class DeviceClient extends InternalClient implements Closeable\n         else if (value == null)\n         {\n             // Codes_SRS_DEVICECLIENT_12_026: [The function shall trow IllegalArgumentException if the value is null.]\n-            throw new IllegalArgumentException(\"optionValue is null\");\n+            throw new IllegalArgumentException(\"value is null\");\n         }\n \n         switch (optionName)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg3OTQwNg==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/908#discussion_r501879406", "bodyText": "extra newline", "author": "drwill-ms", "createdAt": "2020-10-08T17:10:23Z", "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/DeviceClient.java", "diffHunk": "@@ -803,6 +813,17 @@ else if (value == null)\n                     return;\n                 }\n             }\n+            case SET_AMQP_OPEN_AUTHENTICATION_SESSION_TIMEOUT:\n+            {\n+                setOption_SetAmqpOpenAuthenticationSessionTimeout(value);\n+                return;\n+", "originalCommit": "d67c4b4765e07b658d67bc25d75ab155d75df388", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c0c23a57c69d3bfb027def4dbb303d6469fc3bdc", "chunk": "diff --git a/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/DeviceClient.java b/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/DeviceClient.java\nindex 6ef2b28bb..c703e1a69 100644\n--- a/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/DeviceClient.java\n+++ b/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/DeviceClient.java\n\n@@ -817,7 +817,6 @@ public final class DeviceClient extends InternalClient implements Closeable\n             {\n                 setOption_SetAmqpOpenAuthenticationSessionTimeout(value);\n                 return;\n-\n             }\n             case SET_AMQP_OPEN_DEVICE_SESSIONS_TIMEOUT:\n             {\n"}}, {"oid": "c0c23a57c69d3bfb027def4dbb303d6469fc3bdc", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/c0c23a57c69d3bfb027def4dbb303d6469fc3bdc", "message": "changed timeout units", "committedDate": "2020-10-08T17:13:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg4MTcwOQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/908#discussion_r501881709", "bodyText": "FYI - The units have been changed but not the default. Instead of 20000 as default, the value is 20 now. The end result is 20 seconds either way. Along with this default, we now allow customers to specify a custom value.", "author": "vinagesh", "createdAt": "2020-10-08T17:14:14Z", "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java", "diffHunk": "@@ -132,7 +130,7 @@ public void open(Queue<DeviceClientConfig> deviceClientConfigs) throws Transport\n                 this.openAsync();\n \n                 log.trace(\"Waiting for authentication links to open...\");\n-                boolean authenticationSessionOpenTimedOut = !this.authenticationSessionOpenedLatch.await(MAX_WAIT_TO_OPEN_AUTHENTICATION_SESSION, TimeUnit.MILLISECONDS);\n+                boolean authenticationSessionOpenTimedOut = !this.authenticationSessionOpenedLatch.await(this.deviceClientConfig.getAmqpOpenAuthenticationSessionTimeout(), TimeUnit.SECONDS);", "originalCommit": "c0c23a57c69d3bfb027def4dbb303d6469fc3bdc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg4MjIyNA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/908#discussion_r501882224", "bodyText": "Defaults for the timeouts", "author": "vinagesh", "createdAt": "2020-10-08T17:15:06Z", "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/DeviceClientConfig.java", "diffHunk": "@@ -31,6 +31,9 @@\n     private static final int DEFAULT_HTTPS_READ_TIMEOUT_MILLIS = 240000;\n     private static final int DEFAULT_HTTPS_CONNECT_TIMEOUT_MILLIS = 0; //no connect timeout\n \n+    private static final int DEFAULT_AMQP_OPEN_AUTHENTICATION_SESSION_TIMEOUT_IN_SECONDS = 20; // 20 second timeout", "originalCommit": "c0c23a57c69d3bfb027def4dbb303d6469fc3bdc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c494eb2f254573812a592cb29ac679aab4e487bc", "chunk": "diff --git a/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/DeviceClientConfig.java b/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/DeviceClientConfig.java\nindex f58bad65c..94f3f2a6a 100644\n--- a/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/DeviceClientConfig.java\n+++ b/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/DeviceClientConfig.java\n\n@@ -31,8 +31,8 @@ public final class DeviceClientConfig\n     private static final int DEFAULT_HTTPS_READ_TIMEOUT_MILLIS = 240000;\n     private static final int DEFAULT_HTTPS_CONNECT_TIMEOUT_MILLIS = 0; //no connect timeout\n \n-    private static final int DEFAULT_AMQP_OPEN_AUTHENTICATION_SESSION_TIMEOUT_IN_SECONDS = 20; // 20 second timeout\n-    private static final int DEFAULT_AMQP_OPEN_DEVICE_SESSIONS_TIMEOUT_IN_SECONDS = 60; // 60 second timeout\n+    private static final int DEFAULT_AMQP_OPEN_AUTHENTICATION_SESSION_TIMEOUT_IN_SECONDS = 20;\n+    private static final int DEFAULT_AMQP_OPEN_DEVICE_SESSIONS_TIMEOUT_IN_SECONDS = 60;\n \n     /** The default value for messageLockTimeoutSecs. */\n     private static final int DEFAULT_MESSAGE_LOCK_TIMEOUT_SECS = 180;\n"}}, {"oid": "c494eb2f254573812a592cb29ac679aab4e487bc", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/c494eb2f254573812a592cb29ac679aab4e487bc", "message": "changed timeout units", "committedDate": "2020-10-08T17:16:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg4Mzk3Nw==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/908#discussion_r501883977", "bodyText": "Defaults for the timeouts", "author": "vinagesh", "createdAt": "2020-10-08T17:17:55Z", "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/DeviceClientConfig.java", "diffHunk": "@@ -31,6 +31,9 @@\n     private static final int DEFAULT_HTTPS_READ_TIMEOUT_MILLIS = 240000;\n     private static final int DEFAULT_HTTPS_CONNECT_TIMEOUT_MILLIS = 0; //no connect timeout\n \n+    private static final int DEFAULT_AMQP_OPEN_AUTHENTICATION_SESSION_TIMEOUT_IN_SECONDS = 20;", "originalCommit": "c494eb2f254573812a592cb29ac679aab4e487bc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "100c23302e08260634bae5fd9af9a17bec5b6e19", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/100c23302e08260634bae5fd9af9a17bec5b6e19", "message": "changed timeout units", "committedDate": "2020-10-08T17:30:59Z", "type": "forcePushed"}, {"oid": "881eb730a5396324eaf36c7cb49ad94f66eb5381", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/881eb730a5396324eaf36c7cb49ad94f66eb5381", "message": "changed timeout units", "committedDate": "2020-10-08T19:12:19Z", "type": "commit"}, {"oid": "881eb730a5396324eaf36c7cb49ad94f66eb5381", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/881eb730a5396324eaf36c7cb49ad94f66eb5381", "message": "changed timeout units", "committedDate": "2020-10-08T19:12:19Z", "type": "forcePushed"}, {"oid": "efe999a958eef9cec6c4e5e07fffe67c4141645e", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/efe999a958eef9cec6c4e5e07fffe67c4141645e", "message": "Fixing module client timeout", "committedDate": "2020-10-12T18:13:24Z", "type": "commit"}]}