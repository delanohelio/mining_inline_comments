{"pr_number": 813, "pr_title": "refactor(iot-dev): Deprecate the client constructors that don't take SSLContext for x509 authentication", "pr_createdAt": "2020-06-17T19:07:34Z", "pr_url": "https://github.com/Azure/azure-iot-sdk-java/pull/813", "timeline": [{"oid": "631dcf903a3d6fdc5bb7540512a909038d013ca5", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/631dcf903a3d6fdc5bb7540512a909038d013ca5", "message": "refactor(iot-dev): Deprecate the client constructors that don't take SSLContext for x509 authentication\n\nRefactor our x509 sample to use the non-deprecated constructor, and demonstrate how to remove the bouncycastle dependency when you aren't using the deprecated constructor", "committedDate": "2020-06-17T19:01:36Z", "type": "commit"}, {"oid": "836fed8aabae6615f8b1942e6a7c4ac28089fc78", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/836fed8aabae6615f8b1942e6a7c4ac28089fc78", "message": "to squash", "committedDate": "2020-06-17T19:24:32Z", "type": "commit"}, {"oid": "7a62c78dd3077adf65a6998c35c0fb40d04ee7c0", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/7a62c78dd3077adf65a6998c35c0fb40d04ee7c0", "message": "to squash", "committedDate": "2020-06-17T19:25:35Z", "type": "commit"}, {"oid": "8dcc2676c508bf6d893e86ff0078c1dcf7738259", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/8dcc2676c508bf6d893e86ff0078c1dcf7738259", "message": "squash", "committedDate": "2020-06-17T19:27:10Z", "type": "commit"}, {"oid": "63f236fd002a077d0ce510f4a0ee42f190c2f5d5", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/63f236fd002a077d0ce510f4a0ee42f190c2f5d5", "message": "squash", "committedDate": "2020-06-17T19:28:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4NTYzOA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/813#discussion_r441785638", "bodyText": "is the use-case here - devices that don't have the root certificates (digicert, baltimore etc) installed on their device, but need to trust those certs?", "author": "abhipsaMisra", "createdAt": "2020-06-17T19:33:21Z", "path": "device/iot-device-samples/send-event-x509/src/main/java/samples/com/microsoft/azure/sdk/iot/SSLContextBuilder.java", "diffHunk": "@@ -0,0 +1,246 @@\n+/*\n+ *  Copyright (c) Microsoft. All rights reserved.\n+ *  Licensed under the MIT license. See LICENSE file in the project root for full license information.\n+ */\n+\n+package samples.com.microsoft.azure.sdk.iot;\n+\n+import org.apache.commons.codec.binary.Base64;\n+\n+import javax.net.ssl.KeyManagerFactory;\n+import javax.net.ssl.SSLContext;\n+import javax.net.ssl.TrustManagerFactory;\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.security.*;\n+import java.security.cert.Certificate;\n+import java.security.cert.CertificateException;\n+import java.security.cert.CertificateFactory;\n+import java.security.cert.X509Certificate;\n+import java.security.interfaces.RSAPrivateKey;\n+import java.security.spec.PKCS8EncodedKeySpec;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.UUID;\n+\n+/**\n+ * Helper class that demonstrates how to build an SSLContext for x509 authentication from your public and private certificates,\n+ * or how to build an SSLContext for SAS authentication from the default IoT Hub public certificates", "originalCommit": "8dcc2676c508bf6d893e86ff0078c1dcf7738259", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc5MjA5OQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/813#discussion_r441792099", "bodyText": "For SAS based auth? Yes. Users of this SDK always have to have their SSLContext trust iothub's certs. This isn't something that the JVM just picks up from the physical device's certificate store", "author": "timtay-microsoft", "createdAt": "2020-06-17T19:46:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4NTYzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc5MjQ4OA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/813#discussion_r441792488", "bodyText": "For x509 auth, you would need to load the iothub public cert, your device's public cert, and your device's private key when building the SSLContext", "author": "timtay-microsoft", "createdAt": "2020-06-17T19:46:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4NTYzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc5NDgyNw==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/813#discussion_r441794827", "bodyText": "Users of this SDK always have to have their SSLContext trust iothub's certs. This isn't something that the JVM just picks up from the physical device's certificate store\n\nSo this is something mandatory that needs to be passed by the users, and set by the SDK for every single TLS negotiation that the SDK will execute. In that case, why isn't SSLContext a mandatory argument?", "author": "abhipsaMisra", "createdAt": "2020-06-17T19:50:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4NTYzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgzNTEwMg==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/813#discussion_r441835102", "bodyText": "It's mandatory for establishing a connection to Iot hub, regardless of if it is x509 or SAS authentication. For SAS cases, the SDK can just build the SSLContext for the user which makes it optional at the constructor level", "author": "timtay-microsoft", "createdAt": "2020-06-17T21:07:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4NTYzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgzOTM3OQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/813#discussion_r441839379", "bodyText": "ok, so for sas based authentication, what is the use-case for the customer wanting to pass this SSLContext to the SDK?", "author": "abhipsaMisra", "createdAt": "2020-06-17T21:16:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4NTYzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg0NzQ0OA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/813#discussion_r441847448", "bodyText": "Perhaps they have some gateway set up between the SDK and IoT Hub and they need to trust more machines than just the iothub. Or perhaps they need to configure the TLS handshake to use a different version or something. I don't know of any customer's making use of these options, but they are there for general flexibility", "author": "timtay-microsoft", "createdAt": "2020-06-17T21:34:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4NTYzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg2MTg2NA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/813#discussion_r441861864", "bodyText": "Makes sense. I would add the note in comments for ClientOptions.SSLConext that the SDK will automatically create an SSL context to trust IoT hub certs, and if they pass in their custom SSLContext instance, they need to make sure to add IoT Hub's certificate info in there.", "author": "abhipsaMisra", "createdAt": "2020-06-17T22:09:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4NTYzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg2MjU1MA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/813#discussion_r441862550", "bodyText": "So now a different question - the certs info that I see below in the sample, are these the public key info? How does the actual negotiation take place if the JVM cannot look up private key info in my device's certificate store/ I don't have the private key info for these certs?", "author": "abhipsaMisra", "createdAt": "2020-06-17T22:11:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4NTYzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg3NDA3OQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/813#discussion_r441874079", "bodyText": "Good idea. I'll add a note to that effect in the javadoc for the clientOptions.sslContext", "author": "timtay-microsoft", "createdAt": "2020-06-17T22:45:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4NTYzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg3NDgyMg==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/813#discussion_r441874822", "bodyText": "The certs in the sample code's SSLContextBuilder class are indeed IoT Hub's public certificates. All SSLcontexts used must trust those certs to communicate with IoT Hub.\nThe user has to load their certs into the SSLContext from file or from string. Once that instance of SSLContext has the iothub public cert, their device's private key, and their device's public cert, then the SSL handshake will work for x509 auth.", "author": "timtay-microsoft", "createdAt": "2020-06-17T22:48:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4NTYzOA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "ea78c795c401d9440bdc862b60be3fa0e711445f", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/ea78c795c401d9440bdc862b60be3fa0e711445f", "message": "to squash", "committedDate": "2020-06-17T22:48:10Z", "type": "commit"}, {"oid": "116255e8046f9ac0d17b6f0111dfe05f81719943", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/116255e8046f9ac0d17b6f0111dfe05f81719943", "message": "Merge branch 'master' into timtay/SSLContext", "committedDate": "2020-06-18T01:17:11Z", "type": "commit"}, {"oid": "dc0b1c1990a9afa5544211ab85e9d31d2817f0e0", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/dc0b1c1990a9afa5544211ab85e9d31d2817f0e0", "message": "fix", "committedDate": "2020-06-18T01:24:08Z", "type": "commit"}]}