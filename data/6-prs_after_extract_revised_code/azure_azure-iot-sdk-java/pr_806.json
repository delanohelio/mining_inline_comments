{"pr_number": 806, "pr_title": "fix(e2e): Fix multithreaded test not waiting for threads to finish correctly", "pr_createdAt": "2020-06-11T22:27:00Z", "pr_url": "https://github.com/Azure/azure-iot-sdk-java/pull/806", "timeline": [{"oid": "234d841a8e6f1c2916efe5f9c357a6a0ec6a8e23", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/234d841a8e6f1c2916efe5f9c357a6a0ec6a8e23", "message": "fix(e2e): Fix multithreaded test not waiting for threads to finish correctly\n\nIt always waited the full 3 minutes becuase the countdown latch didn't work right. No need for a countdown latch though since we can just wait for all the threads to finish before checking if each send succeeded", "committedDate": "2020-06-11T22:25:59Z", "type": "commit"}, {"oid": "e6ddb0eb0d1bfc68a2663124c6044994184c7d43", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/e6ddb0eb0d1bfc68a2663124c6044994184c7d43", "message": "Merge branch 'master' into timtay/transporClientTest", "committedDate": "2020-06-11T22:34:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTExMTg3Mg==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/806#discussion_r439111872", "bodyText": "Nothing like TimeSpan in Java?", "author": "drwill-ms", "createdAt": "2020-06-11T22:47:15Z", "path": "iot-e2e-tests/common/src/main/java/com/microsoft/azure/sdk/iot/common/tests/iothub/TransportClientTests.java", "diffHunk": "@@ -50,8 +47,8 @@\n     private static final int NUM_MESSAGES_PER_CONNECTION = 3;\n \n     private static final long RETRY_MILLISECONDS = 100; //.1 seconds\n-    private static final long SEND_TIMEOUT_MILLISECONDS = 5 * 60 * 1000; // 5 minutes\n-    private static final long RECEIVE_MESSAGE_TIMEOUT = 5 * 60 * 1000; // 5 minutes\n+    private static final long SEND_TIMEOUT_MILLISECONDS = 20 * 1000; // 20 seconds", "originalCommit": "e6ddb0eb0d1bfc68a2663124c6044994184c7d43", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTExODI4Nw==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/806#discussion_r439118287", "bodyText": "Not that I'm familiar with, no. Operations like .await are always just in milliseconds (long or int)", "author": "timtay-microsoft", "createdAt": "2020-06-11T23:07:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTExMTg3Mg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTExNTY5NA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/806#discussion_r439115694", "bodyText": "\ud83d\udc4d", "author": "prmathur-microsoft", "createdAt": "2020-06-11T22:59:21Z", "path": "iot-e2e-tests/common/src/main/java/com/microsoft/azure/sdk/iot/common/tests/iothub/TransportClientTests.java", "diffHunk": "@@ -251,20 +248,21 @@ public void receiveMessagesIncludingProperties() throws Exception\n     }\n \n     @Test\n-    public void sendMessagesMultithreaded() throws InterruptedException, URISyntaxException, IOException\n+    public void sendMessagesMultithreaded() throws InterruptedException, IOException\n     {\n-        CountDownLatch cdl = new CountDownLatch(testInstance.clientArrayList.size());\n-\n         testInstance.transportClient.open();\n+        Thread[] threads = new Thread[testInstance.clientArrayList.size()];\n \n         for (int i = 0; i < testInstance.clientArrayList.size(); i++)\n         {\n-            new Thread(\n-                    new MultiplexRunnable(\n-                            testInstance.devicesList[i], testInstance.clientArrayList.get(i), NUM_MESSAGES_PER_CONNECTION, NUM_KEYS_PER_MESSAGE, SEND_TIMEOUT_MILLISECONDS, cdl, testInstance.succeed))\n-                    .start();\n+            threads[i] = new Thread(new MultiplexRunnable(testInstance.devicesList[i], testInstance.clientArrayList.get(i), testInstance.succeed));\n+            threads[i].start();\n+        }\n+\n+        for (int i = 0; i < testInstance.clientArrayList.size(); i++)\n+        {\n+            threads[i].join(SEND_TIMEOUT_MILLISECONDS);", "originalCommit": "234d841a8e6f1c2916efe5f9c357a6a0ec6a8e23", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "a1ab42115d2d75b4dc68492d6380c6fac8bd0dc3", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/a1ab42115d2d75b4dc68492d6380c6fac8bd0dc3", "message": "Merge branch 'master' into timtay/transporClientTest", "committedDate": "2020-06-11T23:47:17Z", "type": "commit"}]}