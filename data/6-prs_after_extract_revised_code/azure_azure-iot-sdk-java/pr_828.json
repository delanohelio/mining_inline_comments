{"pr_number": 828, "pr_title": "Run TPM tests in serial", "pr_createdAt": "2020-06-26T22:19:54Z", "pr_url": "https://github.com/Azure/azure-iot-sdk-java/pull/828", "timeline": [{"oid": "9f9d0509d8f620e221ab281fe3aa647eb234e8e4", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/9f9d0509d8f620e221ab281fe3aa647eb234e8e4", "message": "refactor(e2e): Prevent exceptions during tear down from failing twin e2e tests", "committedDate": "2020-06-26T21:52:48Z", "type": "commit"}, {"oid": "e58a3d6c76af310b82f9c11297d12afaea5bf722", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/e58a3d6c76af310b82f9c11297d12afaea5bf722", "message": "fix(e2e): Fix tpm provisioning tests not being run in serial\n\nThese tests need exclusive access to the TPM, so they cannot run in parallel", "committedDate": "2020-06-26T22:18:07Z", "type": "commit"}, {"oid": "c2feef4a129bd8ea805c158a2dc3f71ec4c42ccb", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/c2feef4a129bd8ea805c158a2dc3f71ec4c42ccb", "message": "squash", "committedDate": "2020-06-26T22:21:31Z", "type": "commit"}, {"oid": "2d50d2cdfc7c0dcbfacd62dfbb26ca5712549f5a", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/2d50d2cdfc7c0dcbfacd62dfbb26ca5712549f5a", "message": "squash", "committedDate": "2020-06-26T22:23:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQzNzk4MA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/828#discussion_r446437980", "bodyText": "why does it throw in those flaky instances? doesn't that indicate a problem? doesn't swallowing that exception mean we are ignoring a potential issue?", "author": "azabbasi", "createdAt": "2020-06-26T22:31:42Z", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/iothub/setup/DeviceTwinCommon.java", "diffHunk": "@@ -394,7 +394,14 @@ public void tearDownTwin(DeviceState deviceState) throws IOException\n         }\n         if (internalClient != null)\n         {\n-            internalClient.closeNow();\n+            try\n+            {\n+                internalClient.closeNow();\n+            }\n+            catch (IOException e)\n+            {\n+                // Ignore, the test isn't about being able to close the client", "originalCommit": "2d50d2cdfc7c0dcbfacd62dfbb26ca5712549f5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQzODI2Ng==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/828#discussion_r446438266", "bodyText": "We have tests where closing the client is part of the code under test, but this isn't one of them", "author": "timtay-microsoft", "createdAt": "2020-06-26T22:32:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQzNzk4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ0NjY2OQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/828#discussion_r446446669", "bodyText": "that doesn't explain why it throws here though", "author": "azabbasi", "createdAt": "2020-06-26T23:08:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQzNzk4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ0OTM5MQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/828#discussion_r446449391", "bodyText": "I can take this out for now. I'm more interested in the TPM changes anyways", "author": "timtay-microsoft", "createdAt": "2020-06-26T23:21:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQzNzk4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ0OTUyNw==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/828#discussion_r446449527", "bodyText": "I was under the impression that we generally don't fail a test if the cleanup fails, but this may be worth more discussion", "author": "timtay-microsoft", "createdAt": "2020-06-26T23:22:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQzNzk4MA=="}], "type": "inlineReview", "revised_code": {"commit": "933065ecd6361913fe4326310af2aaaa8c84b293", "chunk": "diff --git a/iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/iothub/setup/DeviceTwinCommon.java b/iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/iothub/setup/DeviceTwinCommon.java\nindex e1cf8c67c..a4859ea3e 100644\n--- a/iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/iothub/setup/DeviceTwinCommon.java\n+++ b/iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/iothub/setup/DeviceTwinCommon.java\n\n@@ -394,14 +394,7 @@ public class DeviceTwinCommon extends IntegrationTest\n         }\n         if (internalClient != null)\n         {\n-            try\n-            {\n-                internalClient.closeNow();\n-            }\n-            catch (IOException e)\n-            {\n-                // Ignore, the test isn't about being able to close the client\n-            }\n+            internalClient.closeNow();\n             internalClient = null;\n         }\n     }\n"}}, {"oid": "c54d4beb0e47afd330f5bc07c1d3197d567f69ae", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/c54d4beb0e47afd330f5bc07c1d3197d567f69ae", "message": "squash", "committedDate": "2020-06-26T22:35:11Z", "type": "commit"}, {"oid": "18ac5575b30db53496cc80b0b319042de842e215", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/18ac5575b30db53496cc80b0b319042de842e215", "message": "squash", "committedDate": "2020-06-26T22:50:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ0MzM4MQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/828#discussion_r446443381", "bodyText": "did you forget to remove this?", "author": "bikamani", "createdAt": "2020-06-26T22:53:55Z", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/provisioning/setup/ProvisioningCommon.java", "diffHunk": "@@ -141,17 +141,29 @@ public static Collection inputsCommon(AttestationType attestationType)\n         }\n         else if (attestationType == AttestationType.TPM)\n         {\n-            return Arrays.asList(\n-                    new Object[][]\n-                            {\n-                                    {ProvisioningDeviceClientTransportProtocol.HTTPS, attestationType},\n-                                    {ProvisioningDeviceClientTransportProtocol.AMQPS, attestationType},\n-                                    {ProvisioningDeviceClientTransportProtocol.AMQPS_WS, attestationType}\n-\n-                                    //MQTT/MQTT_WS does not support tpm attestation\n-                                    //{ProvisioningDeviceClientTransportProtocol.MQTT, attestationType},\n-                                    //{ProvisioningDeviceClientTransportProtocol.MQTT_WS, attestationType},\n-                            });\n+            if (!isPullRequest)\n+            {\n+                //TODO TPM tests are flakey, so only run them for CI and nightly builds", "originalCommit": "18ac5575b30db53496cc80b0b319042de842e215", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ0MzkwNA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/828#discussion_r446443904", "bodyText": "No, this is more of an explanation of why we don't run these tests for pull request builds", "author": "timtay-microsoft", "createdAt": "2020-06-26T22:56:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ0MzM4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ0Mzk4OA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/828#discussion_r446443988", "bodyText": "The TODO is just me being optimistic that we will eventually fix these tests to not be flakey", "author": "timtay-microsoft", "createdAt": "2020-06-26T22:56:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ0MzM4MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ0Mzk2NA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/828#discussion_r446443964", "bodyText": "So was this not referenced earlier?", "author": "bikamani", "createdAt": "2020-06-26T22:56:17Z", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/provisioning/setup/ProvisioningCommon.java", "diffHunk": "@@ -141,17 +141,29 @@ public static Collection inputsCommon(AttestationType attestationType)\n         }\n         else if (attestationType == AttestationType.TPM)\n         {\n-            return Arrays.asList(\n-                    new Object[][]\n-                            {\n-                                    {ProvisioningDeviceClientTransportProtocol.HTTPS, attestationType},\n-                                    {ProvisioningDeviceClientTransportProtocol.AMQPS, attestationType},\n-                                    {ProvisioningDeviceClientTransportProtocol.AMQPS_WS, attestationType}\n-\n-                                    //MQTT/MQTT_WS does not support tpm attestation\n-                                    //{ProvisioningDeviceClientTransportProtocol.MQTT, attestationType},\n-                                    //{ProvisioningDeviceClientTransportProtocol.MQTT_WS, attestationType},\n-                            });\n+            if (!isPullRequest)\n+            {\n+                //TODO TPM tests are flakey, so only run them for CI and nightly builds\n+                return Arrays.asList(\n+                        new Object[][]\n+                                {\n+                                        {ProvisioningDeviceClientTransportProtocol.HTTPS, attestationType},", "originalCommit": "18ac5575b30db53496cc80b0b319042de842e215", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ0NDQyMQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/828#discussion_r446444421", "bodyText": "The TPM tests were being run previously. They were just returned as inputs above alongside x509 and symmetric key. This PR just splits the TPM tests into their own class so they can be run in serial while still running the x509 and symmetric key tests in parallel", "author": "timtay-microsoft", "createdAt": "2020-06-26T22:58:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ0Mzk2NA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "933065ecd6361913fe4326310af2aaaa8c84b293", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/933065ecd6361913fe4326310af2aaaa8c84b293", "message": "Revert \"refactor(e2e): Prevent exceptions during tear down from failing twin e2e tests\"\n\nThis reverts commit 9f9d0509d8f620e221ab281fe3aa647eb234e8e4.", "committedDate": "2020-06-26T23:21:34Z", "type": "commit"}]}