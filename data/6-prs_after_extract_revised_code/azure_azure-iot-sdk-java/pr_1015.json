{"pr_number": 1015, "pr_title": "fix(iot-dev): Fix cleanup logic in AMQP layer when interrupted during open", "pr_createdAt": "2020-12-07T20:14:18Z", "pr_url": "https://github.com/Azure/azure-iot-sdk-java/pull/1015", "timeline": [{"oid": "0dd37367195fc23b85d1e959ebb89a90389620aa", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/0dd37367195fc23b85d1e959ebb89a90389620aa", "message": "fix(iot-dev): Fix cleanup logic in AMQP layer when interrupted during open\n\nexception should be retryable, and the catch block should close the reactor and shut down the executor service, not just shut down the executor service. Close() covers this well so a call to it from this catch block works well", "committedDate": "2020-12-07T20:14:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgxMTU5NA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/1015#discussion_r537811594", "bodyText": "I am assuming we only want to clean up on close?", "author": "barustum", "createdAt": "2020-12-07T20:31:18Z", "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java", "diffHunk": "@@ -158,8 +158,10 @@ public void open(Queue<DeviceClientConfig> deviceClientConfigs) throws Transport\n             }\n             catch (InterruptedException e)\n             {\n-                executorServicesCleanup();", "originalCommit": "0dd37367195fc23b85d1e959ebb89a90389620aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgzNDI1MA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/1015#discussion_r537834250", "bodyText": "The close method already calls executorServicesCleanup, so I'm just delaying it until after the reactor has stopped", "author": "timtay-microsoft", "createdAt": "2020-12-07T21:09:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgxMTU5NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg2Nzc1Nw==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/1015#discussion_r537867757", "bodyText": "A proton reactor!? Sounds powerful and dangerous.", "author": "drwill-ms", "createdAt": "2020-12-07T22:05:06Z", "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java", "diffHunk": "@@ -181,6 +183,7 @@ public void close() throws TransportException\n         }\n         catch (InterruptedException e)\n         {\n+            this.executorServicesCleanup();\n             throw new TransportException(\"Interrupted while closing proton reactor\", e);", "originalCommit": "0dd37367195fc23b85d1e959ebb89a90389620aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg3NzMxMg==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/1015#discussion_r537877312", "bodyText": "It's like we are nuclear physicists or something!", "author": "timtay-microsoft", "createdAt": "2020-12-07T22:21:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg2Nzc1Nw=="}], "type": "inlineReview", "revised_code": null}]}