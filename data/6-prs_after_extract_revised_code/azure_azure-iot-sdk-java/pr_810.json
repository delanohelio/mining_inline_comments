{"pr_number": 810, "pr_title": "E2E Test categorization", "pr_createdAt": "2020-06-16T16:44:56Z", "pr_url": "https://github.com/Azure/azure-iot-sdk-java/pull/810", "timeline": [{"oid": "2ee16485f16f65b55447ae68b49a24e76416b0f5", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/2ee16485f16f65b55447ae68b49a24e76416b0f5", "message": "labeling work so far", "committedDate": "2020-06-16T16:45:42Z", "type": "forcePushed"}, {"oid": "4df6c35dd81bd650c3ff6a1b39849819c86ec309", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/4df6c35dd81bd650c3ff6a1b39849819c86ec309", "message": "Refactor(e2e): Run Android tests on Azure Devops emulators instead of AppCenter\n\nConsolidating all th Android runners that used to be divided into ___DeviceAndroidRunner and ___ModuleAndroidRunner into just ___AndroidRunner.", "committedDate": "2020-06-16T19:03:12Z", "type": "commit"}, {"oid": "c4267ce121c05824ad65f21af9f49d11e12eb8cf", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/c4267ce121c05824ad65f21af9f49d11e12eb8cf", "message": "refactor(e2e): Add test categories and label all tests", "committedDate": "2020-06-16T19:09:30Z", "type": "forcePushed"}, {"oid": "9846025701a1d7df9d47724a4b36ee59178438eb", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/9846025701a1d7df9d47724a4b36ee59178438eb", "message": "refactor(e2e): Add test categories and label all tests", "committedDate": "2020-06-16T22:01:05Z", "type": "commit"}, {"oid": "2fe5101bd840c5805217b24458c3770a91fa3b90", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/2fe5101bd840c5805217b24458c3770a91fa3b90", "message": "Merge branch 'master' of https://github.com/Azure/azure-iot-sdk-java into timtay/testLabeling", "committedDate": "2020-06-16T22:04:32Z", "type": "commit"}, {"oid": "2fe5101bd840c5805217b24458c3770a91fa3b90", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/2fe5101bd840c5805217b24458c3770a91fa3b90", "message": "Merge branch 'master' of https://github.com/Azure/azure-iot-sdk-java into timtay/testLabeling", "committedDate": "2020-06-16T22:04:32Z", "type": "forcePushed"}, {"oid": "6dd288f0a9ba1d7b6d4ab7a7c9450e2222c0cac9", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/6dd288f0a9ba1d7b6d4ab7a7c9450e2222c0cac9", "message": "to squash", "committedDate": "2020-06-16T22:16:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE4ODgwNg==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/810#discussion_r441188806", "bodyText": "The concept of this rule still exists, but I renamed it and refactored it to match the other tags", "author": "timtay-microsoft", "createdAt": "2020-06-16T23:01:42Z", "path": "iot-e2e-tests/common/src/main/java/com/microsoft/azure/sdk/iot/common/helpers/BasicTierOnlyRule.java", "diffHunk": "@@ -1,16 +0,0 @@\n-/*\n- *  Copyright (c) Microsoft. All rights reserved.\n- *  Licensed under the MIT license. See LICENSE file in the project root for full license information.\n- */\n-\n-package com.microsoft.azure.sdk.iot.common.helpers;\n-\n-public class BasicTierOnlyRule implements ConditionalIgnoreRule.IgnoreCondition\n-{\n-\n-    @Override", "originalCommit": "6dd288f0a9ba1d7b6d4ab7a7c9450e2222c0cac9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcxMzY1OA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/810#discussion_r441713658", "bodyText": "This method is called prior to running any test method, and can be used to determine if the test should be run or skipped at runtime", "author": "timtay-microsoft", "createdAt": "2020-06-17T17:34:49Z", "path": "iot-e2e-tests/common/src/main/java/com/microsoft/azure/sdk/iot/common/helpers/rules/BasicTierHubOnlyTestRule.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package com.microsoft.azure.sdk.iot.common.helpers.rules;\n+\n+import com.microsoft.azure.sdk.iot.common.helpers.IntegrationTest;\n+import com.microsoft.azure.sdk.iot.common.helpers.annotations.BasicTierHubOnlyTest;\n+import com.microsoft.azure.sdk.iot.common.helpers.annotations.IotHubTest;\n+import org.junit.Assume;\n+import org.junit.rules.TestRule;\n+import org.junit.runner.Description;\n+import org.junit.runners.model.Statement;\n+\n+public class BasicTierHubOnlyTestRule implements TestRule\n+{\n+    @Override\n+    public Statement apply(Statement base, Description description) {\n+        return new IgnorableStatement(base, description);\n+    }\n+\n+    private class IgnorableStatement extends Statement {\n+\n+        private final Statement base;\n+        private final Description description;\n+\n+        public IgnorableStatement(Statement base, Description description) {\n+            this.base = base;\n+            this.description = description;\n+        }\n+\n+        @Override\n+        public void evaluate() throws Throwable {", "originalCommit": "6dd288f0a9ba1d7b6d4ab7a7c9450e2222c0cac9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcxNDAxNA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/810#discussion_r441714014", "bodyText": "If the test method or its class is tagged with this annotation, then check if this test run is against a basic tier hub or not", "author": "timtay-microsoft", "createdAt": "2020-06-17T17:35:24Z", "path": "iot-e2e-tests/common/src/main/java/com/microsoft/azure/sdk/iot/common/helpers/rules/BasicTierHubOnlyTestRule.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package com.microsoft.azure.sdk.iot.common.helpers.rules;\n+\n+import com.microsoft.azure.sdk.iot.common.helpers.IntegrationTest;\n+import com.microsoft.azure.sdk.iot.common.helpers.annotations.BasicTierHubOnlyTest;\n+import com.microsoft.azure.sdk.iot.common.helpers.annotations.IotHubTest;\n+import org.junit.Assume;\n+import org.junit.rules.TestRule;\n+import org.junit.runner.Description;\n+import org.junit.runners.model.Statement;\n+\n+public class BasicTierHubOnlyTestRule implements TestRule\n+{\n+    @Override\n+    public Statement apply(Statement base, Description description) {\n+        return new IgnorableStatement(base, description);\n+    }\n+\n+    private class IgnorableStatement extends Statement {\n+\n+        private final Statement base;\n+        private final Description description;\n+\n+        public IgnorableStatement(Statement base, Description description) {\n+            this.base = base;\n+            this.description = description;\n+        }\n+\n+        @Override\n+        public void evaluate() throws Throwable {\n+            BasicTierHubOnlyTest annotation = description.getAnnotation(BasicTierHubOnlyTest.class);\n+            BasicTierHubOnlyTest classAnnotation = description.getTestClass().getAnnotation(BasicTierHubOnlyTest.class);\n+            if (annotation != null || classAnnotation != null)", "originalCommit": "6dd288f0a9ba1d7b6d4ab7a7c9450e2222c0cac9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcxNDU1OQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/810#discussion_r441714559", "bodyText": "assumeTrue is not the same as assertTrue. AssumeTrue will return a status code equivalent to \"Ignored\" while assertTrue would return a status code equivalent to \"Failed\"", "author": "timtay-microsoft", "createdAt": "2020-06-17T17:36:21Z", "path": "iot-e2e-tests/common/src/main/java/com/microsoft/azure/sdk/iot/common/helpers/rules/BasicTierHubOnlyTestRule.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package com.microsoft.azure.sdk.iot.common.helpers.rules;\n+\n+import com.microsoft.azure.sdk.iot.common.helpers.IntegrationTest;\n+import com.microsoft.azure.sdk.iot.common.helpers.annotations.BasicTierHubOnlyTest;\n+import com.microsoft.azure.sdk.iot.common.helpers.annotations.IotHubTest;\n+import org.junit.Assume;\n+import org.junit.rules.TestRule;\n+import org.junit.runner.Description;\n+import org.junit.runners.model.Statement;\n+\n+public class BasicTierHubOnlyTestRule implements TestRule\n+{\n+    @Override\n+    public Statement apply(Statement base, Description description) {\n+        return new IgnorableStatement(base, description);\n+    }\n+\n+    private class IgnorableStatement extends Statement {\n+\n+        private final Statement base;\n+        private final Description description;\n+\n+        public IgnorableStatement(Statement base, Description description) {\n+            this.base = base;\n+            this.description = description;\n+        }\n+\n+        @Override\n+        public void evaluate() throws Throwable {\n+            BasicTierHubOnlyTest annotation = description.getAnnotation(BasicTierHubOnlyTest.class);\n+            BasicTierHubOnlyTest classAnnotation = description.getTestClass().getAnnotation(BasicTierHubOnlyTest.class);\n+            if (annotation != null || classAnnotation != null)\n+            {\n+                Assume.assumeTrue(\"Test is ignored\", IntegrationTest.isBasicTierHub);", "originalCommit": "6dd288f0a9ba1d7b6d4ab7a7c9450e2222c0cac9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcxNDczNw==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/810#discussion_r441714737", "bodyText": "Or to simplify it even further, the test won't run if any assumptions are violated", "author": "timtay-microsoft", "createdAt": "2020-06-17T17:36:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcxNDU1OQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcxNTIwMw==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/810#discussion_r441715203", "bodyText": "This will call into all the other rules to see if the test method or its class are tagged with other annotations that could determine if the test should run or not.", "author": "timtay-microsoft", "createdAt": "2020-06-17T17:37:24Z", "path": "iot-e2e-tests/common/src/main/java/com/microsoft/azure/sdk/iot/common/helpers/rules/BasicTierHubOnlyTestRule.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package com.microsoft.azure.sdk.iot.common.helpers.rules;\n+\n+import com.microsoft.azure.sdk.iot.common.helpers.IntegrationTest;\n+import com.microsoft.azure.sdk.iot.common.helpers.annotations.BasicTierHubOnlyTest;\n+import com.microsoft.azure.sdk.iot.common.helpers.annotations.IotHubTest;\n+import org.junit.Assume;\n+import org.junit.rules.TestRule;\n+import org.junit.runner.Description;\n+import org.junit.runners.model.Statement;\n+\n+public class BasicTierHubOnlyTestRule implements TestRule\n+{\n+    @Override\n+    public Statement apply(Statement base, Description description) {\n+        return new IgnorableStatement(base, description);\n+    }\n+\n+    private class IgnorableStatement extends Statement {\n+\n+        private final Statement base;\n+        private final Description description;\n+\n+        public IgnorableStatement(Statement base, Description description) {\n+            this.base = base;\n+            this.description = description;\n+        }\n+\n+        @Override\n+        public void evaluate() throws Throwable {\n+            BasicTierHubOnlyTest annotation = description.getAnnotation(BasicTierHubOnlyTest.class);\n+            BasicTierHubOnlyTest classAnnotation = description.getTestClass().getAnnotation(BasicTierHubOnlyTest.class);\n+            if (annotation != null || classAnnotation != null)\n+            {\n+                Assume.assumeTrue(\"Test is ignored\", IntegrationTest.isBasicTierHub);\n+            }\n+\n+            base.evaluate();", "originalCommit": "6dd288f0a9ba1d7b6d4ab7a7c9450e2222c0cac9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcxNTk1NA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/810#discussion_r441715954", "bodyText": "No special rules for DPS tests to be defined here, but the DeviceProvisioningServiceTestRule class will check to see if a method/class is tagged with this annotation and run/skip the test accordingly", "author": "timtay-microsoft", "createdAt": "2020-06-17T17:38:40Z", "path": "iot-e2e-tests/common/src/main/java/com/microsoft/azure/sdk/iot/common/helpers/annotations/DeviceProvisioningServiceTest.java", "diffHunk": "@@ -0,0 +1,14 @@\n+package com.microsoft.azure.sdk.iot.common.helpers.annotations;\n+\n+import java.lang.annotation.*;\n+\n+/**\n+ * Tests that use the Device Provisioning Service\n+ */\n+@Retention(RetentionPolicy.RUNTIME)\n+@Target({ElementType.TYPE, ElementType.METHOD})\n+@Inherited\n+public @interface DeviceProvisioningServiceTest\n+{\n+", "originalCommit": "6dd288f0a9ba1d7b6d4ab7a7c9450e2222c0cac9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcxNjM1OA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/810#discussion_r441716358", "bodyText": "Same for all these other annotations (other than ContinuousIntegrationTest which has a timeout as an additional rule)", "author": "timtay-microsoft", "createdAt": "2020-06-17T17:39:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcxNTk1NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcxNjczMA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/810#discussion_r441716730", "bodyText": "It's a long timeout, but only because we have a token renewal test that takes at least 10 minutes, and often runs for 16 minutes.", "author": "timtay-microsoft", "createdAt": "2020-06-17T17:40:04Z", "path": "iot-e2e-tests/common/src/main/java/com/microsoft/azure/sdk/iot/common/helpers/annotations/ContinuousIntegrationTest.java", "diffHunk": "@@ -0,0 +1,21 @@\n+package com.microsoft.azure.sdk.iot.common.helpers.annotations;\n+\n+import org.junit.Rule;\n+import org.junit.rules.Timeout;\n+\n+import java.lang.annotation.*;\n+\n+/**\n+ * Tests with this annotation will only be run during nightly or continuous integration builds. Typically these tests\n+ * run longer than most tests, cover niche scenarios, or test failure case scenarios that are atypical for users.\n+ */\n+@Retention(RetentionPolicy.RUNTIME)\n+@Target({ElementType.TYPE, ElementType.METHOD})\n+@Inherited\n+public @interface ContinuousIntegrationTest {\n+    int E2E_TEST_TIMEOUT_MS = 17 * 60 * 1000;\n+\n+    // Each CI test must finish in under 17 minutes\n+    @Rule", "originalCommit": "6dd288f0a9ba1d7b6d4ab7a7c9450e2222c0cac9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b24066e7a1229aba09bfd55d3320dc6d20da5260", "chunk": "diff --git a/iot-e2e-tests/common/src/main/java/com/microsoft/azure/sdk/iot/common/helpers/annotations/ContinuousIntegrationTest.java b/iot-e2e-tests/common/src/main/java/com/microsoft/azure/sdk/iot/common/helpers/annotations/ContinuousIntegrationTest.java\nindex 17a64d940..e6cfcb4ed 100644\n--- a/iot-e2e-tests/common/src/main/java/com/microsoft/azure/sdk/iot/common/helpers/annotations/ContinuousIntegrationTest.java\n+++ b/iot-e2e-tests/common/src/main/java/com/microsoft/azure/sdk/iot/common/helpers/annotations/ContinuousIntegrationTest.java\n\n@@ -1,8 +1,5 @@\n package com.microsoft.azure.sdk.iot.common.helpers.annotations;\n \n-import org.junit.Rule;\n-import org.junit.rules.Timeout;\n-\n import java.lang.annotation.*;\n \n /**\n"}}, {"oid": "b24066e7a1229aba09bfd55d3320dc6d20da5260", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/b24066e7a1229aba09bfd55d3320dc6d20da5260", "message": "fix timeout\n\nThere is no way to associate a test timeout to a certain annotation (like the CI test annoation), but you can lower the integration test timeout to 5 minutes and have the one test that is expected to exceed that limit set its own time limit of 17 minutes", "committedDate": "2020-06-17T18:27:48Z", "type": "commit"}, {"oid": "e272d5a22b01d8f547cf77ccdd1e2dcd46b02ec1", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/e272d5a22b01d8f547cf77ccdd1e2dcd46b02ec1", "message": "small reorganization of test groups, and changes to test classifications", "committedDate": "2020-06-17T19:41:05Z", "type": "commit"}, {"oid": "b0fea453ce00034e8b672fe0b768f4bb00700d4f", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/b0fea453ce00034e8b672fe0b768f4bb00700d4f", "message": "Merge branch 'master' into timtay/testLabeling", "committedDate": "2020-06-17T19:41:23Z", "type": "commit"}, {"oid": "5b8b3887a31488c7340e4073a72c4507cd7478e6", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/5b8b3887a31488c7340e4073a72c4507cd7478e6", "message": "disabling a flakey unit test", "committedDate": "2020-06-17T19:58:41Z", "type": "commit"}, {"oid": "c7c015db53d5e5497b73e81388da3871b12e50e6", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/c7c015db53d5e5497b73e81388da3871b12e50e6", "message": "speed up mvn install time", "committedDate": "2020-06-17T21:12:07Z", "type": "commit"}, {"oid": "d6498280d203ca8509da2b3f964cee792f2c84e7", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/d6498280d203ca8509da2b3f964cee792f2c84e7", "message": "Labeling tpm tests as flakey", "committedDate": "2020-06-17T22:32:25Z", "type": "commit"}, {"oid": "dd1d93b2525a9b7b1634ccfc906669bda3063b7b", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/dd1d93b2525a9b7b1634ccfc906669bda3063b7b", "message": "labeling file upload tests as flakey", "committedDate": "2020-06-17T23:42:56Z", "type": "commit"}]}