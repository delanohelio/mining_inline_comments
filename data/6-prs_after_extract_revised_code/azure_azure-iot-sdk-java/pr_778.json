{"pr_number": 778, "pr_title": "fix(iot-dev): Fix issue where amqp layer didn't recognize an ack to a subscription message that it sent", "pr_createdAt": "2020-05-13T19:48:27Z", "pr_url": "https://github.com/Azure/azure-iot-sdk-java/pull/778", "timeline": [{"oid": "2bc666a2ec610a0ae2f832c07a45c39edddc3008", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/2bc666a2ec610a0ae2f832c07a45c39edddc3008", "message": "fix(iot-dev): Fix issue where amqp layer didn't recognize a subscription message that it sent", "committedDate": "2020-05-13T19:45:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY5MDYzMw==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/778#discussion_r424690633", "bodyText": "Without the above changes, this ack handling logic would fall to the else block and log an error", "author": "timtay-microsoft", "createdAt": "2020-05-13T19:49:05Z", "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java", "diffHunk": "@@ -688,6 +689,11 @@ else if (remoteState instanceof Modified || remoteState instanceof Released || r\n                             this.listener.onMessageSent(inProgressMessages.remove(deliveryTag), transportException);\n                         }\n                     }\n+                    else if (this.inProgressSubscriptionMessages.containsKey(deliveryTag))\n+                    {\n+                        SubscriptionType subscriptionType = this.inProgressSubscriptionMessages.remove(deliveryTag);\n+                        log.debug(\"Successfully re-sent amqp subscription message of type {}\", subscriptionType);\n+                    }\n                     else", "originalCommit": "2bc666a2ec610a0ae2f832c07a45c39edddc3008", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDcyNTY5OQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/778#discussion_r424725699", "bodyText": "Why does the log say: \"re-sent amqp subscription message\"?\nI thought what we do here is -> if we receive an ack from service for the subscription message, we remove it from our internal queue, so as to not resend it. Is that not correct?", "author": "abhipsaMisra", "createdAt": "2020-05-13T20:55:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY5MDYzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1OTc1OQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/778#discussion_r424759759", "bodyText": "@timtay-microsoft : A question \u270b", "author": "abhipsaMisra", "createdAt": "2020-05-13T22:09:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY5MDYzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc4Mzg3MQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/778#discussion_r424783871", "bodyText": "This log statement gets executed when we receive an ack for an outstanding subscription message that we sent. It does get removed from the queue of outstanding messages as a result. The only odd thing about this subscription message is that it is sent at the session level. That's why this new queue needed to be added for messages like it", "author": "timtay-microsoft", "createdAt": "2020-05-13T23:16:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY5MDYzMw=="}], "type": "inlineReview", "revised_code": {"commit": "152bbe2c168a51800f49dc967329769ef9876ac9", "chunk": "diff --git a/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java b/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java\nindex dbbb42ec0..7d58cbcf1 100644\n--- a/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java\n+++ b/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java\n\n@@ -692,7 +692,7 @@ public final class AmqpsIotHubConnection extends ErrorLoggingBaseHandler impleme\n                     else if (this.inProgressSubscriptionMessages.containsKey(deliveryTag))\n                     {\n                         SubscriptionType subscriptionType = this.inProgressSubscriptionMessages.remove(deliveryTag);\n-                        log.debug(\"Successfully re-sent amqp subscription message of type {}\", subscriptionType);\n+                        log.debug(\"Successfully sent amqp subscription message of type {}\", subscriptionType);\n                     }\n                     else\n                     {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY5MTY0NQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/778#discussion_r424691645", "bodyText": "This new map will track outstanding subscription messages. I couldn't re-use the inProgressMessages map because there is no transport agnostic message to add to that map since we are creating the amqp message directly. Plus, messages in that map are expected to have a matching message in the IotHubTransport layer, which isn't the case for this special amqp-specific subscription message", "author": "timtay-microsoft", "createdAt": "2020-05-13T19:50:51Z", "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java", "diffHunk": "@@ -66,6 +66,7 @@\n     private final static int MAX_MESSAGE_PAYLOAD_SIZE = 256*1024; //max IoT Hub message size is 256 kb, so amqp websocket layer should buffer at least that much space\n     private final Boolean useWebSockets;\n     private final Map<Integer, com.microsoft.azure.sdk.iot.device.Message> inProgressMessages = new ConcurrentHashMap<>();\n+    private final Map<Integer, SubscriptionType> inProgressSubscriptionMessages = new ConcurrentHashMap<>();", "originalCommit": "2bc666a2ec610a0ae2f832c07a45c39edddc3008", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY5MTk2Mw==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/778#discussion_r424691963", "bodyText": "This is orthogonal to the actual PR, but this log message had one too many spots for parameters, so I got rid of it", "author": "timtay-microsoft", "createdAt": "2020-05-13T19:51:28Z", "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsDeviceOperations.java", "diffHunk": "@@ -394,7 +394,7 @@ protected boolean onLinkRemoteOpen(String linkName)\n         if (linkName.equals(this.getSenderLinkTag()))\n         {\n             this.amqpsSendLinkState = AmqpsDeviceOperationLinkState.OPENED;\n-            this.log.debug(\"{} sender link with link correlation id {} was successfully opened {}\", getLinkInstanceType(), this.linkCorrelationId);\n+            this.log.debug(\"{} sender link with link correlation id {} was successfully opened\", getLinkInstanceType(), this.linkCorrelationId);", "originalCommit": "2bc666a2ec610a0ae2f832c07a45c39edddc3008", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDcwNzQ3Mg==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/778#discussion_r424707472", "bodyText": "Update constructor comments to reflect new parameter.", "author": "barustum", "createdAt": "2020-05-13T20:20:18Z", "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsSessionDeviceOperation.java", "diffHunk": "@@ -29,14 +29,16 @@\n \n     private List<UUID> cbsCorrelationIdList = Collections.synchronizedList(new ArrayList<UUID>());\n \n+    private SubscriptionMessageRequestSentCallback subscriptionMessageRequestSentCallback;\n+\n     /**\n      * Create logical device entity to handle all operation.\n      *\n      * @param deviceClientConfig the configuration of teh device.\n      * @param amqpsDeviceAuthentication the authentication object associated with the device.", "originalCommit": "2bc666a2ec610a0ae2f832c07a45c39edddc3008", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDcwOTYxNA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/778#discussion_r424709614", "bodyText": "Good catch", "author": "timtay-microsoft", "createdAt": "2020-05-13T20:24:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDcwNzQ3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "5c70e7f7ab97f6bb11aae59522ad4b9dee7ea653", "chunk": "diff --git a/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsSessionDeviceOperation.java b/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsSessionDeviceOperation.java\nindex 5a479c0ef..9986cc05e 100644\n--- a/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsSessionDeviceOperation.java\n+++ b/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsSessionDeviceOperation.java\n\n@@ -36,6 +36,7 @@ public class AmqpsSessionDeviceOperation\n      *\n      * @param deviceClientConfig the configuration of teh device.\n      * @param amqpsDeviceAuthentication the authentication object associated with the device.\n+     * @param subscriptionMessageRequestSentCallback the callback to fire each time a subscription message is sent\n      * @throws IllegalArgumentException if deviceClientConfig or amqpsDeviceAuthentication is null\n      */\n     public AmqpsSessionDeviceOperation(final DeviceClientConfig deviceClientConfig, AmqpsDeviceAuthentication amqpsDeviceAuthentication, SubscriptionMessageRequestSentCallback subscriptionMessageRequestSentCallback) throws IllegalArgumentException\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDcwNzUyNQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/778#discussion_r424707525", "bodyText": "subscriptionType instead of deviceOperationType?", "author": "azabbasi", "createdAt": "2020-05-13T20:20:23Z", "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/SubscriptionMessageRequestSentCallback.java", "diffHunk": "@@ -0,0 +1,13 @@\n+package com.microsoft.azure.sdk.iot.device.transport.amqps;\n+\n+import com.microsoft.azure.sdk.iot.device.DeviceTwin.DeviceOperations;\n+\n+public interface SubscriptionMessageRequestSentCallback\n+{\n+    void onSubscriptionMessageSent(int deliveryTag, SubscriptionType deviceOperationType);", "originalCommit": "2bc666a2ec610a0ae2f832c07a45c39edddc3008", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDcwOTY3OA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/778#discussion_r424709678", "bodyText": "Good catch", "author": "timtay-microsoft", "createdAt": "2020-05-13T20:24:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDcwNzUyNQ=="}], "type": "inlineReview", "revised_code": {"commit": "5c70e7f7ab97f6bb11aae59522ad4b9dee7ea653", "chunk": "diff --git a/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/SubscriptionMessageRequestSentCallback.java b/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/SubscriptionMessageRequestSentCallback.java\nindex 51cfef9a9..11ca6b3e9 100644\n--- a/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/SubscriptionMessageRequestSentCallback.java\n+++ b/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/SubscriptionMessageRequestSentCallback.java\n\n@@ -4,7 +4,7 @@ import com.microsoft.azure.sdk.iot.device.DeviceTwin.DeviceOperations;\n \n public interface SubscriptionMessageRequestSentCallback\n {\n-    void onSubscriptionMessageSent(int deliveryTag, SubscriptionType deviceOperationType);\n+    void onSubscriptionMessageSent(int deliveryTag, SubscriptionType subscriptionType);\n \n     enum SubscriptionType\n     {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDcwODUwMQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/778#discussion_r424708501", "bodyText": "Update comment header to include new parameter", "author": "barustum", "createdAt": "2020-05-13T20:22:18Z", "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsSessionManager.java", "diffHunk": "@@ -24,14 +24,15 @@\n \n     private AmqpsDeviceAuthentication amqpsDeviceAuthentication;\n     private ArrayList<AmqpsSessionDeviceOperation> amqpsDeviceSessionList = new ArrayList<>();\n+    private SubscriptionMessageRequestSentCallback subscriptionMessageRequestSentCallback;\n \n     /**\n      * Constructor that takes a device configuration.\n      *\n      * @param deviceClientConfig the device configuration to use for \n      *                           session management.\n      */", "originalCommit": "2bc666a2ec610a0ae2f832c07a45c39edddc3008", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5c70e7f7ab97f6bb11aae59522ad4b9dee7ea653", "chunk": "diff --git a/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsSessionManager.java b/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsSessionManager.java\nindex f7867d64c..8ed4a578a 100644\n--- a/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsSessionManager.java\n+++ b/device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsSessionManager.java\n\n@@ -31,6 +31,7 @@ public class AmqpsSessionManager\n      *\n      * @param deviceClientConfig the device configuration to use for \n      *                           session management.\n+     * @param subscriptionMessageRequestSentCallback the callback to fire each time a subscription message is sent\n      */\n     public AmqpsSessionManager(DeviceClientConfig deviceClientConfig, SubscriptionMessageRequestSentCallback subscriptionMessageRequestSentCallback)\n     {\n"}}, {"oid": "5c70e7f7ab97f6bb11aae59522ad4b9dee7ea653", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/5c70e7f7ab97f6bb11aae59522ad4b9dee7ea653", "message": "cr comments", "committedDate": "2020-05-13T20:25:46Z", "type": "commit"}, {"oid": "152bbe2c168a51800f49dc967329769ef9876ac9", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/152bbe2c168a51800f49dc967329769ef9876ac9", "message": "squash", "committedDate": "2020-05-13T23:36:38Z", "type": "commit"}]}