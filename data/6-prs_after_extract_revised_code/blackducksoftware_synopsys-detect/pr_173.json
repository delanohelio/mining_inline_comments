{"pr_number": 173, "pr_title": "feat(go): GoMod extractor now retrieves and applies replacement data \u2026", "pr_createdAt": "2020-05-26T16:26:28Z", "pr_url": "https://github.com/blackducksoftware/synopsys-detect/pull/173", "timeline": [{"oid": "079d4a6cfd2b130b6de24bbad229b9a3e6c8cafb", "url": "https://github.com/blackducksoftware/synopsys-detect/commit/079d4a6cfd2b130b6de24bbad229b9a3e6c8cafb", "message": "feat(go): GoMod extractor now retrieves and applies replacement data (IDETECT-1966)", "committedDate": "2020-05-26T16:22:40Z", "type": "commit"}, {"oid": "dcc0d87a3fd2dd30cb044391dac2000098171cb2", "url": "https://github.com/blackducksoftware/synopsys-detect/commit/dcc0d87a3fd2dd30cb044391dac2000098171cb2", "message": "fix: Removing debug statement", "committedDate": "2020-06-12T18:55:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE5NTg5OA==", "url": "https://github.com/blackducksoftware/synopsys-detect/pull/173#discussion_r431195898", "bodyText": "I would change one of the versions in the list output. Then assert on that version so that we know the replacement is working.", "author": "JakeMathews", "createdAt": "2020-05-27T14:48:30Z", "path": "detectable/src/test/java/com/synopsys/integration/detectable/detectables/go/functional/GoModDetectableTest.java", "diffHunk": "@@ -33,6 +33,24 @@ protected void setup() throws IOException {\n         );\n         addExecutableOutput(goListOutput, \"go\", \"list\", \"-m\");\n \n+        ExecutableOutput goListUJsonOutput = createStandardOutput(\n+            \"{\",\n+            \"\\t\\\"Path\\\": \\\"github.com/codegangsta/negroni\\\",\",\n+            \"\\t\\\"Version\\\": \\\"v1.0.0\\\"\",\n+            \"}\",\n+            \"\",\n+            \"{\",\n+            \"\\t\\\"Path\\\": \\\"github.com/sirupsen/logrus\\\",\",\n+            \"\\t\\\"Version\\\": \\\"v1.1.1\\\"\",\n+            \"}\",\n+            \"\",\n+            \"{\",\n+            \"\\t\\\"Path\\\": \\\"github.com/davecgh/go-spew\\\",\",\n+            \"\\t\\\"Version\\\": \\\"v1.1.1\\\"\",\n+            \"}\"\n+        );\n+        addExecutableOutput(goListUJsonOutput, \"go\", \"list\", \"-m\", \"-u\", \"-json\", \"all\");\n+", "originalCommit": "079d4a6cfd2b130b6de24bbad229b9a3e6c8cafb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3d6f9c7cc11ea036db97de4037f82199c1ae3832", "chunk": "diff --git a/detectable/src/test/java/com/synopsys/integration/detectable/detectables/go/functional/GoModDetectableTest.java b/detectable/src/test/java/com/synopsys/integration/detectable/detectables/go/functional/GoModDetectableTest.java\nindex 0d6945a8a..b9120da0c 100644\n--- a/detectable/src/test/java/com/synopsys/integration/detectable/detectables/go/functional/GoModDetectableTest.java\n+++ b/detectable/src/test/java/com/synopsys/integration/detectable/detectables/go/functional/GoModDetectableTest.java\n\n@@ -41,7 +41,11 @@ public class GoModDetectableTest extends DetectableFunctionalTest {\n             \"\",\n             \"{\",\n             \"\\t\\\"Path\\\": \\\"github.com/sirupsen/logrus\\\",\",\n-            \"\\t\\\"Version\\\": \\\"v1.1.1\\\"\",\n+            \"\\t\\\"Version\\\": \\\"v1.1.1\\\",\",\n+            \"\\t\\\"Replace\\\": {\",\n+            \"\\t\\t\\\"Path\\\": \\\"github.com/sirupsen/logrus\\\",\",\n+            \"\\t\\t\\\"Version\\\": \\\"v2.0.0\\\"\",\n+            \"\\t}\",\n             \"}\",\n             \"\",\n             \"{\",\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM1ODM2OQ==", "url": "https://github.com/blackducksoftware/synopsys-detect/pull/173#discussion_r440358369", "bodyText": "Have you considered using a POJO here?", "author": "JakeMathews", "createdAt": "2020-06-15T18:14:46Z", "path": "detectable/src/main/java/com/synopsys/integration/detectable/detectables/go/gomod/GoModCliExtractor.java", "diffHunk": "@@ -61,4 +72,45 @@ public Extraction extract(final File directory, final File goExe) {\n             throw new DetectableException(failureMessage + output.getReturnCode());\n         }\n     }\n+\n+    private List<String> modGraphOutputWithReplacements(File directory, File goExe, List<String> listUJsonOutput) throws ExecutableRunnerException, DetectableException {\n+        final List<String> modGraphOutput = execute(directory, goExe, \"Querying for the go mod graph failed:\", \"mod\", \"graph\");\n+        String jsonString = convertOutputToJsonString(listUJsonOutput);\n+        JsonObject json = gson.fromJson(jsonString, JsonObject.class);\n+\n+        for (final JsonElement jsonElement : json.getAsJsonArray(PATHS)) {\n+            JsonObject jsonObject = jsonElement.getAsJsonObject();\n+            JsonObject replace = jsonObject.getAsJsonObject(\"Replace\");\n+            if (replace != null) {\n+                String path = jsonObject.get(\"Path\").getAsString();\n+                String originalVersion = jsonObject.get(\"Version\").getAsString();\n+                String replaceVersion = replace.get(\"Version\").getAsString();\n+                replacementData.put(String.format(\"%s@%s\", path, originalVersion), String.format(\"%s@%s\", path, replaceVersion));\n+            }\n+        }", "originalCommit": "dcc0d87a3fd2dd30cb044391dac2000098171cb2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "28736e7af75e9ddc839efef437ce47f15bd4d952", "chunk": "diff --git a/detectable/src/main/java/com/synopsys/integration/detectable/detectables/go/gomod/GoModCliExtractor.java b/detectable/src/main/java/com/synopsys/integration/detectable/detectables/go/gomod/GoModCliExtractor.java\nindex 8c78829ec..b84a1ada1 100644\n--- a/detectable/src/main/java/com/synopsys/integration/detectable/detectables/go/gomod/GoModCliExtractor.java\n+++ b/detectable/src/main/java/com/synopsys/integration/detectable/detectables/go/gomod/GoModCliExtractor.java\n\n@@ -76,15 +78,15 @@ public class GoModCliExtractor {\n     private List<String> modGraphOutputWithReplacements(File directory, File goExe, List<String> listUJsonOutput) throws ExecutableRunnerException, DetectableException {\n         final List<String> modGraphOutput = execute(directory, goExe, \"Querying for the go mod graph failed:\", \"mod\", \"graph\");\n         String jsonString = convertOutputToJsonString(listUJsonOutput);\n-        JsonObject json = gson.fromJson(jsonString, JsonObject.class);\n+        JsonArray json = gson.fromJson(jsonString, JsonArray.class);\n \n-        for (final JsonElement jsonElement : json.getAsJsonArray(PATHS)) {\n-            JsonObject jsonObject = jsonElement.getAsJsonObject();\n-            JsonObject replace = jsonObject.getAsJsonObject(\"Replace\");\n+        for (final JsonElement jsonElement : json) {\n+            GoListUJsonData data = gson.fromJson(jsonElement, GoListUJsonData.class);\n+            ReplaceData replace = data.getReplace();\n             if (replace != null) {\n-                String path = jsonObject.get(\"Path\").getAsString();\n-                String originalVersion = jsonObject.get(\"Version\").getAsString();\n-                String replaceVersion = replace.get(\"Version\").getAsString();\n+                String path = data.getPath();\n+                String originalVersion = data.getVersion();\n+                String replaceVersion = replace.getVersion();\n                 replacementData.put(String.format(\"%s@%s\", path, originalVersion), String.format(\"%s@%s\", path, replaceVersion));\n             }\n         }\n"}}, {"oid": "d9c7792a799e6e4622126158c22f038872e061f1", "url": "https://github.com/blackducksoftware/synopsys-detect/commit/d9c7792a799e6e4622126158c22f038872e061f1", "message": "feat(go): added battery test for go mod", "committedDate": "2020-06-15T19:10:48Z", "type": "commit"}, {"oid": "3d6f9c7cc11ea036db97de4037f82199c1ae3832", "url": "https://github.com/blackducksoftware/synopsys-detect/commit/3d6f9c7cc11ea036db97de4037f82199c1ae3832", "message": "feat: Edited go list -u -json input to test replacement functionality", "committedDate": "2020-06-15T19:25:57Z", "type": "commit"}, {"oid": "28736e7af75e9ddc839efef437ce47f15bd4d952", "url": "https://github.com/blackducksoftware/synopsys-detect/commit/28736e7af75e9ddc839efef437ce47f15bd4d952", "message": "feat: Use POJO instead of generic JsonElement", "committedDate": "2020-06-15T19:42:15Z", "type": "commit"}, {"oid": "e59b0043c8d9a86f8aad362fcf6552206df6b2c0", "url": "https://github.com/blackducksoftware/synopsys-detect/commit/e59b0043c8d9a86f8aad362fcf6552206df6b2c0", "message": "feat: Use TypeToken to avoid iterating over JsonArray", "committedDate": "2020-06-15T19:48:53Z", "type": "commit"}, {"oid": "5b209e17d180d27012331125f45745187d3fba26", "url": "https://github.com/blackducksoftware/synopsys-detect/commit/5b209e17d180d27012331125f45745187d3fba26", "message": "Merge branch 'master' into goModReplace", "committedDate": "2020-06-15T19:59:02Z", "type": "commit"}, {"oid": "9d254d3256029b86f527b2c5dfa69b33492f0bf9", "url": "https://github.com/blackducksoftware/synopsys-detect/commit/9d254d3256029b86f527b2c5dfa69b33492f0bf9", "message": "feat: Added release note", "committedDate": "2020-06-15T20:04:13Z", "type": "commit"}]}