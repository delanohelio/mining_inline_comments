{"pr_number": 8778, "pr_title": "Fix subscription loading by policy name rest api", "pr_createdAt": "2020-06-18T09:28:44Z", "pr_url": "https://github.com/wso2/carbon-apimgt/pull/8778", "timeline": [{"oid": "2f99cbf3543ccf145bd574f5817d4e0a53bd6b23", "url": "https://github.com/wso2/carbon-apimgt/commit/2f99cbf3543ccf145bd574f5817d4e0a53bd6b23", "message": "Fix subscription loading by policy name rest api", "committedDate": "2020-06-18T09:26:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA5NTg0OQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8778#discussion_r442095849", "bodyText": "Formatting issue", "author": "mushthaq33", "createdAt": "2020-06-18T09:31:09Z", "path": "components/apimgt/org.wso2.carbon.apimgt.keymgt/src/main/java/org/wso2/carbon/apimgt/keymgt/handlers/AbstractKeyValidationHandler.java", "diffHunk": "@@ -252,8 +254,26 @@ private APIKeyValidationInfoDTO validateSubscriptionDetails(APIKeyValidationInfo\n \n                                 ApplicationPolicy appPolicy = datastore.getApplicationPolicyByName(app.getPolicy(),\n                                         tenantId);\n+                                if(appPolicy == null) {", "originalCommit": "2f99cbf3543ccf145bd574f5817d4e0a53bd6b23", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA5NzMyOQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8778#discussion_r442097329", "bodyText": "done", "author": "chamilaadhi", "createdAt": "2020-06-18T09:33:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA5NTg0OQ=="}], "type": "inlineReview", "revised_code": {"commit": "7476d267ba23ce830bdea3b13bfcfaa8f2f45a0d", "chunk": "diff --git a/components/apimgt/org.wso2.carbon.apimgt.keymgt/src/main/java/org/wso2/carbon/apimgt/keymgt/handlers/AbstractKeyValidationHandler.java b/components/apimgt/org.wso2.carbon.apimgt.keymgt/src/main/java/org/wso2/carbon/apimgt/keymgt/handlers/AbstractKeyValidationHandler.java\nindex fc0a780fd50..a0d4572a405 100644\n--- a/components/apimgt/org.wso2.carbon.apimgt.keymgt/src/main/java/org/wso2/carbon/apimgt/keymgt/handlers/AbstractKeyValidationHandler.java\n+++ b/components/apimgt/org.wso2.carbon.apimgt.keymgt/src/main/java/org/wso2/carbon/apimgt/keymgt/handlers/AbstractKeyValidationHandler.java\n\n@@ -254,7 +254,7 @@ public abstract class AbstractKeyValidationHandler implements KeyValidationHandl\n \n                                 ApplicationPolicy appPolicy = datastore.getApplicationPolicyByName(app.getPolicy(),\n                                         tenantId);\n-                                if(appPolicy == null) {\n+                                if (appPolicy == null) {\n                                     try {\n                                         appPolicy = new SubscriptionDataLoaderImpl()\n                                                 .getApplicationPolicy(app.getPolicy(), apiTenantDomain);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA5NTkzMA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8778#discussion_r442095930", "bodyText": "Formatting issue", "author": "mushthaq33", "createdAt": "2020-06-18T09:31:19Z", "path": "components/apimgt/org.wso2.carbon.apimgt.keymgt/src/main/java/org/wso2/carbon/apimgt/keymgt/handlers/AbstractKeyValidationHandler.java", "diffHunk": "@@ -252,8 +254,26 @@ private APIKeyValidationInfoDTO validateSubscriptionDetails(APIKeyValidationInfo\n \n                                 ApplicationPolicy appPolicy = datastore.getApplicationPolicyByName(app.getPolicy(),\n                                         tenantId);\n+                                if(appPolicy == null) {\n+                                    try {\n+                                        appPolicy = new SubscriptionDataLoaderImpl()\n+                                                .getApplicationPolicy(app.getPolicy(), apiTenantDomain);\n+                                        datastore.addOrUpdateApplicationPolicy(appPolicy);\n+                                    } catch (DataLoadingException e) {\n+                                        log.error(\"Error while loading ApplicationPolicy\");\n+                                    }\n+                                }\n                                 SubscriptionPolicy subPolicy = datastore.getSubscriptionPolicyByName(sub.getPolicyId(),\n                                         tenantId);\n+                                if(subPolicy == null) {", "originalCommit": "2f99cbf3543ccf145bd574f5817d4e0a53bd6b23", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA5NzIyOQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8778#discussion_r442097229", "bodyText": "done", "author": "chamilaadhi", "createdAt": "2020-06-18T09:33:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA5NTkzMA=="}], "type": "inlineReview", "revised_code": {"commit": "7476d267ba23ce830bdea3b13bfcfaa8f2f45a0d", "chunk": "diff --git a/components/apimgt/org.wso2.carbon.apimgt.keymgt/src/main/java/org/wso2/carbon/apimgt/keymgt/handlers/AbstractKeyValidationHandler.java b/components/apimgt/org.wso2.carbon.apimgt.keymgt/src/main/java/org/wso2/carbon/apimgt/keymgt/handlers/AbstractKeyValidationHandler.java\nindex fc0a780fd50..a0d4572a405 100644\n--- a/components/apimgt/org.wso2.carbon.apimgt.keymgt/src/main/java/org/wso2/carbon/apimgt/keymgt/handlers/AbstractKeyValidationHandler.java\n+++ b/components/apimgt/org.wso2.carbon.apimgt.keymgt/src/main/java/org/wso2/carbon/apimgt/keymgt/handlers/AbstractKeyValidationHandler.java\n\n@@ -254,7 +254,7 @@ public abstract class AbstractKeyValidationHandler implements KeyValidationHandl\n \n                                 ApplicationPolicy appPolicy = datastore.getApplicationPolicyByName(app.getPolicy(),\n                                         tenantId);\n-                                if(appPolicy == null) {\n+                                if (appPolicy == null) {\n                                     try {\n                                         appPolicy = new SubscriptionDataLoaderImpl()\n                                                 .getApplicationPolicy(app.getPolicy(), apiTenantDomain);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA5NjE3Mg==", "url": "https://github.com/wso2/carbon-apimgt/pull/8778#discussion_r442096172", "bodyText": "Formatting issue", "author": "mushthaq33", "createdAt": "2020-06-18T09:31:45Z", "path": "components/apimgt/org.wso2.carbon.apimgt.keymgt/src/main/java/org/wso2/carbon/apimgt/keymgt/service/APIKeyValidationService.java", "diffHunk": "@@ -344,6 +347,19 @@ public APIKeyValidationInfoDTO validateKey(String context, String version, Strin\n             if (storeImpl.isApiPoliciesInitialized()) {\r\n                 log.debug(\"SubscriptionDataStore Initialized. Reading API Policies from SubscriptionDataStore\");\r\n                 apiPolicy = store.getApiPolicyByName(urlMapping.getThrottlingPolicy(), apiTenantId);\r\n+                if(apiPolicy == null) {\r", "originalCommit": "2f99cbf3543ccf145bd574f5817d4e0a53bd6b23", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA5NzI3OQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8778#discussion_r442097279", "bodyText": "done", "author": "chamilaadhi", "createdAt": "2020-06-18T09:33:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA5NjE3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "7476d267ba23ce830bdea3b13bfcfaa8f2f45a0d", "chunk": "diff --git a/components/apimgt/org.wso2.carbon.apimgt.keymgt/src/main/java/org/wso2/carbon/apimgt/keymgt/service/APIKeyValidationService.java b/components/apimgt/org.wso2.carbon.apimgt.keymgt/src/main/java/org/wso2/carbon/apimgt/keymgt/service/APIKeyValidationService.java\nindex 7df48dd3401..6dfbbf02fda 100644\n--- a/components/apimgt/org.wso2.carbon.apimgt.keymgt/src/main/java/org/wso2/carbon/apimgt/keymgt/service/APIKeyValidationService.java\n+++ b/components/apimgt/org.wso2.carbon.apimgt.keymgt/src/main/java/org/wso2/carbon/apimgt/keymgt/service/APIKeyValidationService.java\n\n@@ -347,7 +347,7 @@ public class APIKeyValidationService extends AbstractAdmin {\n             if (storeImpl.isApiPoliciesInitialized()) {\n                 log.debug(\"SubscriptionDataStore Initialized. Reading API Policies from SubscriptionDataStore\");\n                 apiPolicy = store.getApiPolicyByName(urlMapping.getThrottlingPolicy(), apiTenantId);\n-                if(apiPolicy == null) {\n+                if (apiPolicy == null) {\n                     //could be null for situations where invoke before map is updated\n                     log.debug(\"API Policies not found in the SubscriptionDataStore. Retrieving from the Rest API\");\n                     apiPolicy = new SubscriptionDataLoaderImpl().getAPIPolicy(urlMapping.getThrottlingPolicy(),\n"}}, {"oid": "7476d267ba23ce830bdea3b13bfcfaa8f2f45a0d", "url": "https://github.com/wso2/carbon-apimgt/commit/7476d267ba23ce830bdea3b13bfcfaa8f2f45a0d", "message": "Fix formatting issues", "committedDate": "2020-06-18T09:33:11Z", "type": "commit"}]}