{"pr_number": 8283, "pr_title": "Fix https://github.com/wso2/product-apim/issues/7523", "pr_createdAt": "2020-03-02T10:12:21Z", "pr_url": "https://github.com/wso2/carbon-apimgt/pull/8283", "timeline": [{"oid": "2d45c6f73f2df99df022119fa70328da42e58bee", "url": "https://github.com/wso2/carbon-apimgt/commit/2d45c6f73f2df99df022119fa70328da42e58bee", "message": "Merge branch 'master' of https://github.com/wso2/carbon-apimgt into master-scopeIssuer", "committedDate": "2020-02-27T06:20:19Z", "type": "commit"}, {"oid": "b76ea27415572e99eb85949bae2a496128881d82", "url": "https://github.com/wso2/carbon-apimgt/commit/b76ea27415572e99eb85949bae2a496128881d82", "message": "get monetization usage record", "committedDate": "2020-03-02T07:30:20Z", "type": "commit"}, {"oid": "e4aa491fdb9856778db37734adb820d13d20d937", "url": "https://github.com/wso2/carbon-apimgt/commit/e4aa491fdb9856778db37734adb820d13d20d937", "message": "fix constant", "committedDate": "2020-03-02T10:03:27Z", "type": "commit"}, {"oid": "5848af5112c579fc3d5b6bedcf1c2871e2c829b4", "url": "https://github.com/wso2/carbon-apimgt/commit/5848af5112c579fc3d5b6bedcf1c2871e2c829b4", "message": "Merge branch 'master' of https://github.com/wso2/carbon-apimgt into master-scopeIssuer", "committedDate": "2020-03-02T10:07:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkwNDIwNw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8283#discussion_r386904207", "bodyText": "JsonObject can be null", "author": "tharindu1st", "createdAt": "2020-03-03T09:47:50Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java", "diffHunk": "@@ -9158,6 +9158,55 @@ public static JSONObject executeQueryOnStreamProcessor(String appName, String qu\n \n     }\n \n+    /**\n+     * Implemented to get the API usage count for monetization.\n+     *\n+     * @param from : the start timestamp of the query.\n+     * @param to   : the end timestamp of the query.\n+     * @return JSON Object.\n+     */\n+    public static JSONObject getUsageCountForMonetization(long from, long to)\n+            throws APIManagementException {\n+\n+        JSONObject jsonObject = null;\n+        String granularity = null;\n+        APIManagerConfiguration configuration = ServiceReferenceHolder.getInstance().getAPIManagerConfigurationService()\n+                .getAPIManagerConfiguration();\n+        granularity = configuration.getFirstProperty(\n+                APIConstants.Monetization.USAGE_PUBLISHER_GRANULARITY);\n+        if (StringUtils.isEmpty(granularity)) {\n+            //set the default granularity to days, if it is not set in configuration\n+            granularity = APIConstants.Monetization.USAGE_PUBLISH_DEFAULT_GRANULARITY;\n+        }\n+        StringBuilder query = new StringBuilder(\n+                \"from \" + APIConstants.Monetization.MONETIZATION_USAGE_RECORD_AGG\n+                        + \" within \" + from\n+                        + \"L, \" + to + \"L per '\" + granularity\n+                        + \"' select \"\n+                        + APIConstants.Analytics.API_NAME + \", \"\n+                        + APIConstants.Analytics.API_VERSION + \", \"\n+                        + APIConstants.Analytics.API_CREATOR + \", \"\n+                        + APIConstants.Analytics.API_CREATOR_TENANT_DOMAIN + \", \"\n+                        + APIConstants.Analytics.APPLICATION_ID + \", \"\n+                        + \"sum (requestCount) as requestCount \"\n+                        + \"group by \"\n+                        + APIConstants.Analytics.API_NAME + \", \"\n+                        + APIConstants.Analytics.API_VERSION + \", \"\n+                        + APIConstants.Analytics.API_CREATOR + \", \"\n+                        + APIConstants.Analytics.API_CREATOR_TENANT_DOMAIN + \", \"\n+                        + APIConstants.Analytics.APPLICATION_ID\n+        );\n+        try {\n+            jsonObject = APIUtil.executeQueryOnStreamProcessor(\n+                    APIConstants.Monetization.MONETIZATION_USAGE_RECORD_APP,\n+                    query.toString());\n+        } catch (APIManagementException ex) {\n+            String msg = \"Unable to Retrieve monetization usage records\";\n+            handleException(msg, ex);\n+        }\n+        return jsonObject;", "originalCommit": "5848af5112c579fc3d5b6bedcf1c2871e2c829b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzAyMTc1Ng==", "url": "https://github.com/wso2/carbon-apimgt/pull/8283#discussion_r387021756", "bodyText": "fixed in a129c3e", "author": "shilmyhasan", "createdAt": "2020-03-03T13:36:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkwNDIwNw=="}], "type": "inlineReview", "revised_code": {"commit": "a129c3ec166bfd118842b18f7cbadb695d40f206", "chunk": "diff --git a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java\nindex cb7d4db54c9..f9a4755cad4 100644\n--- a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java\n+++ b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java\n\n@@ -9200,6 +9200,9 @@ public final class APIUtil {\n             jsonObject = APIUtil.executeQueryOnStreamProcessor(\n                     APIConstants.Monetization.MONETIZATION_USAGE_RECORD_APP,\n                     query.toString());\n+            if(jsonObject == null){\n+                jsonObject = new JSONObject();\n+            }\n         } catch (APIManagementException ex) {\n             String msg = \"Unable to Retrieve monetization usage records\";\n             handleException(msg, ex);\n"}}, {"oid": "a129c3ec166bfd118842b18f7cbadb695d40f206", "url": "https://github.com/wso2/carbon-apimgt/commit/a129c3ec166bfd118842b18f7cbadb695d40f206", "message": "create empty jsonobject", "committedDate": "2020-03-03T13:34:26Z", "type": "commit"}]}