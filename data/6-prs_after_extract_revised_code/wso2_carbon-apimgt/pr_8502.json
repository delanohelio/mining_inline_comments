{"pr_number": 8502, "pr_title": "Add UpdateEndpointRegistryEntry and DeleteEndpointRegistryEntry resources", "pr_createdAt": "2020-05-13T12:58:54Z", "pr_url": "https://github.com/wso2/carbon-apimgt/pull/8502", "timeline": [{"oid": "f3a455666cb21e26c4065d1452e45a02c239ebff", "url": "https://github.com/wso2/carbon-apimgt/commit/f3a455666cb21e26c4065d1452e45a02c239ebff", "message": "Add updateRegistryEntry resource", "committedDate": "2020-05-13T12:53:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ1MjkwNg==", "url": "https://github.com/wso2/carbon-apimgt/pull/8502#discussion_r424452906", "bodyText": "can any null pointers occur here when we don't upload a file?", "author": "fazlan-nazeem", "createdAt": "2020-05-13T13:49:41Z", "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.endpoint.registry/src/main/java/org/wso2/carbon/apimgt/rest/api/endpoint/registry/impl/RegistriesApiServiceImpl.java", "diffHunk": "@@ -254,13 +254,68 @@ public Response getRegistryEntryByUuid(String registryId, String entryId, Messag\n     @Override\n     public Response updateRegistryEntry(String registryId, String entryId, RegistryEntryDTO registryEntry, InputStream\n             definitionFileInputStream, Attachment definitionFileDetail, MessageContext messageContext) {\n+        String tenantDomain = RestApiUtil.getLoggedInUserTenantDomain();\n+        String user = RestApiUtil.getLoggedInUsername();\n+        EndpointRegistry registryProvider = new EndpointRegistryImpl();\n+        EndpointRegistryEntry updatedEntry = null;\n+\n+        try {\n+            EndpointRegistryInfo endpointRegistry =\n+                    registryProvider.getEndpointRegistryByUUID(registryId, tenantDomain);\n+            if (endpointRegistry == null) {\n+                RestApiUtil.handleResourceNotFoundError(\"Endpoint registry with the id: \" + registryId +\n+                        \" is not found\", log);\n+            }\n+            EndpointRegistryEntry endpointRegistryEntry =\n+                    registryProvider.getEndpointRegistryEntryByUUID(registryId, entryId);\n+            if (endpointRegistryEntry == null) {\n+                RestApiUtil.handleResourceNotFoundError(\"Endpoint registry entry with the id: \" + entryId +\n+                        \" is not found\", log);\n+            }\n \n-        return Response.ok().entity(registryEntry).build();\n+            ResourceFile definitionFile = new ResourceFile(definitionFileInputStream, definitionFileDetail", "originalCommit": "7e3fd6e7b5f9ba3703da20917802cbe063f53834", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ2MjU2Nw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8502#discussion_r424462567", "bodyText": "yeah it occurs. I will fix it. If there is no file attached, still we should update the other details right?", "author": "ChamodDamitha", "createdAt": "2020-05-13T14:02:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ1MjkwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ3MTcyMg==", "url": "https://github.com/wso2/carbon-apimgt/pull/8502#discussion_r424471722", "bodyText": "yeah, let's keep the existing blob in the DB as it is and update the rest in that case.", "author": "fazlan-nazeem", "createdAt": "2020-05-13T14:14:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ1MjkwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ3MzA0MQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8502#discussion_r424473041", "bodyText": "we should also think of the use case where the user wants to remove the blob from the DB and update. in that sense, we should set an empty blob if no file is attached.", "author": "fazlan-nazeem", "createdAt": "2020-05-13T14:16:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ1MjkwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ3Mzk2MA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8502#discussion_r424473960", "bodyText": "since there would be no way to achieve the above if we don't update the blob, let's go ahead and set an empty blob if no file is attached. wdyt", "author": "fazlan-nazeem", "createdAt": "2020-05-13T14:17:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ1MjkwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDUyNzg1NA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8502#discussion_r424527854", "bodyText": "Fixed", "author": "ChamodDamitha", "createdAt": "2020-05-13T15:27:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ1MjkwNg=="}], "type": "inlineReview", "revised_code": {"commit": "e5051f7e1b455e07f7bccfda06af9c3c29a35693", "chunk": "diff --git a/components/apimgt/org.wso2.carbon.apimgt.rest.api.endpoint.registry/src/main/java/org/wso2/carbon/apimgt/rest/api/endpoint/registry/impl/RegistriesApiServiceImpl.java b/components/apimgt/org.wso2.carbon.apimgt.rest.api.endpoint.registry/src/main/java/org/wso2/carbon/apimgt/rest/api/endpoint/registry/impl/RegistriesApiServiceImpl.java\nindex eb7e7de189c..786db97f1fb 100644\n--- a/components/apimgt/org.wso2.carbon.apimgt.rest.api.endpoint.registry/src/main/java/org/wso2/carbon/apimgt/rest/api/endpoint/registry/impl/RegistriesApiServiceImpl.java\n+++ b/components/apimgt/org.wso2.carbon.apimgt.rest.api.endpoint.registry/src/main/java/org/wso2/carbon/apimgt/rest/api/endpoint/registry/impl/RegistriesApiServiceImpl.java\n\n@@ -272,9 +277,13 @@ public class RegistriesApiServiceImpl implements RegistriesApiService {\n                 RestApiUtil.handleResourceNotFoundError(\"Endpoint registry entry with the id: \" + entryId +\n                         \" is not found\", log);\n             }\n-\n-            ResourceFile definitionFile = new ResourceFile(definitionFileInputStream, definitionFileDetail\n-                    .getContentType().getType());\n+            ResourceFile definitionFile;\n+            if (definitionFileInputStream == null || definitionFileDetail == null) {\n+                definitionFile = new ResourceFile(null, null);\n+            } else {\n+                definitionFile = new ResourceFile(definitionFileInputStream, definitionFileDetail\n+                        .getContentType().getType());\n+            }\n             EndpointRegistryEntry entryToUpdate = EndpointRegistryMappingUtils.fromDTOToRegistryEntry(registryEntry,\n                     entryId, definitionFile, endpointRegistry.getRegistryId());\n             registryProvider.updateEndpointRegistryEntry(entryToUpdate);\n"}}, {"oid": "e5051f7e1b455e07f7bccfda06af9c3c29a35693", "url": "https://github.com/wso2/carbon-apimgt/commit/e5051f7e1b455e07f7bccfda06af9c3c29a35693", "message": "Add deleteEndpointRegistryEntry resource", "committedDate": "2020-05-13T15:26:18Z", "type": "commit"}, {"oid": "e5051f7e1b455e07f7bccfda06af9c3c29a35693", "url": "https://github.com/wso2/carbon-apimgt/commit/e5051f7e1b455e07f7bccfda06af9c3c29a35693", "message": "Add deleteEndpointRegistryEntry resource", "committedDate": "2020-05-13T15:26:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU5NzY3OA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8502#discussion_r457597678", "bodyText": "shouldn't we catch the exception in executeUpdate and rollback the connection explicitly.\nSee https://stackoverflow.com/questions/3160756/in-jdbc-when-autocommit-is-false-and-no-explicit-savepoints-have-been-set-is-i", "author": "dushaniw", "createdAt": "2020-07-20T18:08:19Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/ApiMgtDAO.java", "diffHunk": "@@ -15012,6 +15012,53 @@ public String addEndpointRegistryEntry(EndpointRegistryEntry registryEntry) thro\n         return uuid;\n     }\n \n+    /**\n+     * Updates Registry Entry\n+     *\n+     * @param registryEntry EndpointRegistryEntry\n+     * @throws APIManagementException if failed to update EndpointRegistryEntry\n+     */\n+    public void updateEndpointRegistryEntry(EndpointRegistryEntry registryEntry) throws APIManagementException {\n+        String query = SQLConstants.UPDATE_ENDPOINT_REGISTRY_ENTRY_SQL;\n+        try (Connection connection = APIMgtDBUtil.getConnection();\n+             PreparedStatement ps = connection.prepareStatement(query)) {\n+            connection.setAutoCommit(false);\n+            ps.setString(1, registryEntry.getName());\n+            ps.setString(2, registryEntry.getServiceURL());\n+            ps.setString(3, registryEntry.getDefinitionType());\n+            ps.setString(4, registryEntry.getDefinitionURL());\n+            ps.setString(5, registryEntry.getMetaData());\n+            ps.setString(6, registryEntry.getServiceType());\n+            ps.setBlob(7, registryEntry.getEndpointDefinition().getContent());\n+            ps.setString(8, registryEntry.getEntryId());\n+            ps.executeUpdate();", "originalCommit": "e5051f7e1b455e07f7bccfda06af9c3c29a35693", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODk1MjI2NQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8502#discussion_r478952265", "bodyText": "Fixed in https://github.com/wso2-enterprise/service-catalog/pull/73", "author": "ChamodDamitha", "createdAt": "2020-08-28T08:41:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU5NzY3OA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU5ODM2OQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8502#discussion_r457598369", "bodyText": "same here, IMO we should rollback the connection if statement.execute fails", "author": "dushaniw", "createdAt": "2020-07-20T18:09:27Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/ApiMgtDAO.java", "diffHunk": "@@ -15012,6 +15012,53 @@ public String addEndpointRegistryEntry(EndpointRegistryEntry registryEntry) thro\n         return uuid;\n     }\n \n+    /**\n+     * Updates Registry Entry\n+     *\n+     * @param registryEntry EndpointRegistryEntry\n+     * @throws APIManagementException if failed to update EndpointRegistryEntry\n+     */\n+    public void updateEndpointRegistryEntry(EndpointRegistryEntry registryEntry) throws APIManagementException {\n+        String query = SQLConstants.UPDATE_ENDPOINT_REGISTRY_ENTRY_SQL;\n+        try (Connection connection = APIMgtDBUtil.getConnection();\n+             PreparedStatement ps = connection.prepareStatement(query)) {\n+            connection.setAutoCommit(false);\n+            ps.setString(1, registryEntry.getName());\n+            ps.setString(2, registryEntry.getServiceURL());\n+            ps.setString(3, registryEntry.getDefinitionType());\n+            ps.setString(4, registryEntry.getDefinitionURL());\n+            ps.setString(5, registryEntry.getMetaData());\n+            ps.setString(6, registryEntry.getServiceType());\n+            ps.setBlob(7, registryEntry.getEndpointDefinition().getContent());\n+            ps.setString(8, registryEntry.getEntryId());\n+            ps.executeUpdate();\n+            connection.commit();\n+        } catch (SQLException e) {\n+            handleException(\"Error while updating endpoint registry entry with id: \" + registryEntry.getEntryId(), e);\n+        }\n+    }\n+\n+    /**\n+     * Deletes an Endpoint Registry Entry\n+     *\n+     * @param entryId Registry Entry Identifier(UUID)\n+     * @throws APIManagementException if failed to delete the Endpoint Registry Entry\n+     */\n+    public void deleteEndpointRegistryEntry(String entryId) throws APIManagementException {\n+        String query = SQLConstants.DELETE_ENDPOINT_REGISTRY_ENTRY_SQL;\n+\n+        try (Connection connection = APIMgtDBUtil.getConnection();\n+             PreparedStatement statement = connection.prepareStatement(query)\n+        ) {\n+            connection.setAutoCommit(false);\n+            statement.setString(1, entryId);\n+            statement.execute();", "originalCommit": "e5051f7e1b455e07f7bccfda06af9c3c29a35693", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODk1MjM1Nw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8502#discussion_r478952357", "bodyText": "Fixed in https://github.com/wso2-enterprise/service-catalog/pull/73", "author": "ChamodDamitha", "createdAt": "2020-08-28T08:41:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU5ODM2OQ=="}], "type": "inlineReview", "revised_code": null}]}