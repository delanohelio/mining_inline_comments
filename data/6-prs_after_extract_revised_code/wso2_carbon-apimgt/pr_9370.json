{"pr_number": 9370, "pr_title": "Add original role to the role mapping list in tenant.conf", "pr_createdAt": "2020-11-08T20:23:43Z", "pr_url": "https://github.com/wso2/carbon-apimgt/pull/9370", "timeline": [{"oid": "b7926645cdf4755b788e93520e9f95626642b2c0", "url": "https://github.com/wso2/carbon-apimgt/commit/b7926645cdf4755b788e93520e9f95626642b2c0", "message": "add original role to role mapping list", "committedDate": "2020-11-08T20:16:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0MTk0Nw==", "url": "https://github.com/wso2/carbon-apimgt/pull/9370#discussion_r521841947", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                isOriginalRoleAlreadyInroles = true;\n          \n          \n            \n                                isOriginalRoleAlreadyInRoles = true;", "author": "malinthaprasan", "createdAt": "2020-11-12T05:07:07Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java", "diffHunk": "@@ -11614,6 +11614,25 @@ public static void updateTenantConfRoleAliasMapping(JSONObject newRoleMappingJso\n         } catch (UserStoreException e) {\n             APIUtil.handleException(\"Couldn't read tenant configuration from User Store\", e);\n         }\n+\n+        //append original role to the role mapping list\n+        Set<Map.Entry<String, JsonElement>> roleMappingEntries = newRoleMappingJson.entrySet();\n+        for (Map.Entry<String, JsonElement> entry: roleMappingEntries) {\n+            List<String> currentRoles = Arrays.asList(String.valueOf(entry.getValue()).split(\",\"));\n+            boolean isOriginalRoleAlreadyInroles = false;\n+            for (String role: currentRoles) {\n+                if (role.equals(entry.getKey())) {\n+                    isOriginalRoleAlreadyInroles = true;", "originalCommit": "7238b8ba1e6b8581d28ed32cbd37b8523546546a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "45da7a834c22cf782f471911aa5fe917c9fd2e7f", "chunk": "diff --git a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java\nindex 59c946e9eff..eaa20598528 100644\n--- a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java\n+++ b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java\n\n@@ -11622,7 +11622,7 @@ public final class APIUtil {\n             boolean isOriginalRoleAlreadyInroles = false;\n             for (String role: currentRoles) {\n                 if (role.equals(entry.getKey())) {\n-                    isOriginalRoleAlreadyInroles = true;\n+                    isOriginalRoleAlreadyInRoles = true;\n                     break;\n                 }\n             }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0MTk4Mg==", "url": "https://github.com/wso2/carbon-apimgt/pull/9370#discussion_r521841982", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (!isOriginalRoleAlreadyInroles) {\n          \n          \n            \n                        if (!isOriginalRoleAlreadyInRoles) {", "author": "malinthaprasan", "createdAt": "2020-11-12T05:07:18Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java", "diffHunk": "@@ -11614,6 +11614,25 @@ public static void updateTenantConfRoleAliasMapping(JSONObject newRoleMappingJso\n         } catch (UserStoreException e) {\n             APIUtil.handleException(\"Couldn't read tenant configuration from User Store\", e);\n         }\n+\n+        //append original role to the role mapping list\n+        Set<Map.Entry<String, JsonElement>> roleMappingEntries = newRoleMappingJson.entrySet();\n+        for (Map.Entry<String, JsonElement> entry: roleMappingEntries) {\n+            List<String> currentRoles = Arrays.asList(String.valueOf(entry.getValue()).split(\",\"));\n+            boolean isOriginalRoleAlreadyInroles = false;\n+            for (String role: currentRoles) {\n+                if (role.equals(entry.getKey())) {\n+                    isOriginalRoleAlreadyInroles = true;\n+                    break;\n+                }\n+            }\n+\n+            if (!isOriginalRoleAlreadyInroles) {", "originalCommit": "7238b8ba1e6b8581d28ed32cbd37b8523546546a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "45da7a834c22cf782f471911aa5fe917c9fd2e7f", "chunk": "diff --git a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java\nindex 59c946e9eff..eaa20598528 100644\n--- a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java\n+++ b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java\n\n@@ -11622,7 +11622,7 @@ public final class APIUtil {\n             boolean isOriginalRoleAlreadyInroles = false;\n             for (String role: currentRoles) {\n                 if (role.equals(entry.getKey())) {\n-                    isOriginalRoleAlreadyInroles = true;\n+                    isOriginalRoleAlreadyInRoles = true;\n                     break;\n                 }\n             }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg1MDk1NQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/9370#discussion_r521850955", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        boolean isOriginalRoleAlreadyInroles = false;\n          \n          \n            \n                        boolean isOriginalRoleAlreadyInRoles = false;", "author": "malinthaprasan", "createdAt": "2020-11-12T05:36:43Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java", "diffHunk": "@@ -11614,6 +11614,25 @@ public static void updateTenantConfRoleAliasMapping(JSONObject newRoleMappingJso\n         } catch (UserStoreException e) {\n             APIUtil.handleException(\"Couldn't read tenant configuration from User Store\", e);\n         }\n+\n+        //append original role to the role mapping list\n+        Set<Map.Entry<String, JsonElement>> roleMappingEntries = newRoleMappingJson.entrySet();\n+        for (Map.Entry<String, JsonElement> entry: roleMappingEntries) {\n+            List<String> currentRoles = Arrays.asList(String.valueOf(entry.getValue()).split(\",\"));\n+            boolean isOriginalRoleAlreadyInroles = false;", "originalCommit": "bb8af196a77c4fd333cffda945154da09380f42a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "862800cb864c581200b6760705ca39a8389a9c4e", "chunk": "diff --git a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java\nindex 01c7a95c7d9..59c946e9eff 100644\n--- a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java\n+++ b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java\n\n@@ -11622,12 +11622,12 @@ public final class APIUtil {\n             boolean isOriginalRoleAlreadyInroles = false;\n             for (String role: currentRoles) {\n                 if (role.equals(entry.getKey())) {\n-                    isOriginalRoleAlreadyInRoles = true;\n+                    isOriginalRoleAlreadyInroles = true;\n                     break;\n                 }\n             }\n \n-            if (!isOriginalRoleAlreadyInRoles) {\n+            if (!isOriginalRoleAlreadyInroles) {\n                 String newRoles = entry.getKey() + \",\" + entry.getValue();\n                 newRoleMappingJson.replace(entry.getKey(), entry.getValue(), newRoles);\n             }\n"}}, {"oid": "862800cb864c581200b6760705ca39a8389a9c4e", "url": "https://github.com/wso2/carbon-apimgt/commit/862800cb864c581200b6760705ca39a8389a9c4e", "message": "change variaable case", "committedDate": "2020-11-18T04:53:00Z", "type": "commit"}, {"oid": "45da7a834c22cf782f471911aa5fe917c9fd2e7f", "url": "https://github.com/wso2/carbon-apimgt/commit/45da7a834c22cf782f471911aa5fe917c9fd2e7f", "message": "Update components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java\n\nCo-authored-by: Malintha Amarasinghe <malintha.prasan@gmail.com>", "committedDate": "2020-11-18T04:53:13Z", "type": "commit"}, {"oid": "dcea49d00fd6af18e51f829ad5b3a2c9c920cc5f", "url": "https://github.com/wso2/carbon-apimgt/commit/dcea49d00fd6af18e51f829ad5b3a2c9c920cc5f", "message": "Update components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java\n\nCo-authored-by: Malintha Amarasinghe <malintha.prasan@gmail.com>", "committedDate": "2020-11-18T04:53:37Z", "type": "commit"}, {"oid": "e9988c2858f986fc7b501a70d0fc3c87d971c4c1", "url": "https://github.com/wso2/carbon-apimgt/commit/e9988c2858f986fc7b501a70d0fc3c87d971c4c1", "message": "Update components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java\n\nCo-authored-by: Malintha Amarasinghe <malintha.prasan@gmail.com>", "committedDate": "2020-11-18T04:53:51Z", "type": "commit"}, {"oid": "e9988c2858f986fc7b501a70d0fc3c87d971c4c1", "url": "https://github.com/wso2/carbon-apimgt/commit/e9988c2858f986fc7b501a70d0fc3c87d971c4c1", "message": "Update components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java\n\nCo-authored-by: Malintha Amarasinghe <malintha.prasan@gmail.com>", "committedDate": "2020-11-18T04:53:51Z", "type": "forcePushed"}, {"oid": "072b4f56812174cdd5bb57a831350f741162e9bb", "url": "https://github.com/wso2/carbon-apimgt/commit/072b4f56812174cdd5bb57a831350f741162e9bb", "message": "Merge branch 'master' into fix-role-mapping", "committedDate": "2020-11-18T05:08:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjU3ODU3MA==", "url": "https://github.com/wso2/carbon-apimgt/pull/9370#discussion_r566578570", "bodyText": "Shall we remove this extra line?", "author": "kavishkafernando", "createdAt": "2021-01-29T04:53:54Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java", "diffHunk": "@@ -11752,6 +11771,7 @@ public static boolean isCrossTenantSubscriptionsEnabled() {\n         return false;\n     }\n \n+", "originalCommit": "072b4f56812174cdd5bb57a831350f741162e9bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTUwNDM4MA==", "url": "https://github.com/wso2/carbon-apimgt/pull/9370#discussion_r569504380", "bodyText": "Fixed in 3e4283c", "author": "chashikajw", "createdAt": "2021-02-03T15:24:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjU3ODU3MA=="}], "type": "inlineReview", "revised_code": null}]}