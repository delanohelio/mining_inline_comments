{"pr_number": 8338, "pr_title": "Changed recommendations and Tenant config Cache", "pr_createdAt": "2020-03-11T12:45:53Z", "pr_url": "https://github.com/wso2/carbon-apimgt/pull/8338", "timeline": [{"oid": "713323171bd99afab13c50f2c73bb553b32193fe", "url": "https://github.com/wso2/carbon-apimgt/commit/713323171bd99afab13c50f2c73bb553b32193fe", "message": "Changed recommendations and Tenant config Cache\n\nPreviously when getting the both cached, a method in APIUtil was used.\nCache creation and get cache were written in same method and this might\nlead to several issues as errors in expiry times. With this change, cache\nis created separately at server start and tenant creation.\n\nSigned-off-by: Lakshitha Gunasekara <lakshitha.gunasekara@gmail.com>", "committedDate": "2020-03-11T10:33:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk1MjI0Ng==", "url": "https://github.com/wso2/carbon-apimgt/pull/8338#discussion_r390952246", "bodyText": "make new method to abstract apiutil.getTenantConfig", "author": "tharindu1st", "createdAt": "2020-03-11T13:00:21Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIConsumerImpl.java", "diffHunk": "@@ -5777,12 +5778,8 @@ public boolean isRecommendationEnabled(String tenantDomain) {\n                 return true;\n             } else {\n                 try {\n-                    org.json.JSONObject tenantConfig = null;\n-                    Cache tenantConfigCache = APIUtil.getCache(\n-                            APIConstants.API_MANAGER_CACHE_MANAGER,\n-                            APIConstants.TENANT_CONFIG_CACHE_NAME,\n-                            APIConstants.TENANT_CONFIG_CACHE_MODIFIED_EXPIRY,\n-                            APIConstants.TENANT_CONFIG_CACHE_ACCESS_EXPIRY);\n+                    org.json.JSONObject tenantConfig;\n+                    Cache tenantConfigCache = CacheProvider.getTenantConfigCache();", "originalCommit": "713323171bd99afab13c50f2c73bb553b32193fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE5MDA2Ng==", "url": "https://github.com/wso2/carbon-apimgt/pull/8338#discussion_r391190066", "bodyText": "Fixed", "author": "1akshitha", "createdAt": "2020-03-11T18:49:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk1MjI0Ng=="}], "type": "inlineReview", "revised_code": {"commit": "02012f810088365630142057860d0a697e632d26", "chunk": "diff --git a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIConsumerImpl.java b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIConsumerImpl.java\nindex 8044ca6255a..93513cdada4 100644\n--- a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIConsumerImpl.java\n+++ b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIConsumerImpl.java\n\n@@ -5772,33 +5772,7 @@ public class APIConsumerImpl extends AbstractAPIManager implements APIConsumer {\n      */\n \n     public boolean isRecommendationEnabled(String tenantDomain) {\n-\n-        if (recommendationEnvironment != null) {\n-            if (recommendationEnvironment.isApplyForAllTenants()) {\n-                return true;\n-            } else {\n-                try {\n-                    org.json.JSONObject tenantConfig;\n-                    Cache tenantConfigCache = CacheProvider.getTenantConfigCache();\n-                    String cacheName = tenantDomain + \"_\" + APIConstants.TENANT_CONFIG_CACHE_NAME;\n-                    if (tenantConfigCache.containsKey(cacheName)) {\n-                        tenantConfig = (org.json.JSONObject) tenantConfigCache.get(cacheName);\n-                    } else {\n-                        String content = apimRegistryService\n-                                .getConfigRegistryResourceContent(tenantDomain, APIConstants.API_TENANT_CONF_LOCATION);\n-                        tenantConfig = new org.json.JSONObject(content);\n-                        tenantConfigCache.put(cacheName, tenantConfig);\n-                    }\n-                    if (tenantConfig.has(APIConstants.API_TENANT_CONF_ENABLE_RECOMMENDATION_KEY)) {\n-                        Object value = tenantConfig.get(APIConstants.API_TENANT_CONF_ENABLE_RECOMMENDATION_KEY);\n-                        return Boolean.parseBoolean(value.toString());\n-                    }\n-                } catch (UserStoreException | RegistryException e) {\n-                    log.error(\"Error occurred when getting API tenant config from registry\", e);\n-                }\n-            }\n-        }\n-        return false;\n+        return APIUtil.isRecommendationEnabled(tenantDomain);\n     }\n \n     public String getRequestedTenant() {\n"}}, {"oid": "02012f810088365630142057860d0a697e632d26", "url": "https://github.com/wso2/carbon-apimgt/commit/02012f810088365630142057860d0a697e632d26", "message": "Introduce a cache to getTenantconfig method", "committedDate": "2020-03-11T16:48:44Z", "type": "commit"}, {"oid": "5b5181a3e421b6ce5db3fdeec271ce9b46bcb1fe", "url": "https://github.com/wso2/carbon-apimgt/commit/5b5181a3e421b6ce5db3fdeec271ce9b46bcb1fe", "message": "minor fix", "committedDate": "2020-03-11T18:48:31Z", "type": "commit"}]}