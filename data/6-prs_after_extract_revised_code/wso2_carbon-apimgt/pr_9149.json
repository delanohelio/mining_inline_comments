{"pr_number": 9149, "pr_title": "Map and inject Mgw throttling Extensions To Default extensions when importing an API definition", "pr_createdAt": "2020-08-07T07:32:55Z", "pr_url": "https://github.com/wso2/carbon-apimgt/pull/9149", "timeline": [{"oid": "b4d88b19c1ccc478ade304bb302a6026ba62fb00", "url": "https://github.com/wso2/carbon-apimgt/commit/b4d88b19c1ccc478ade304bb302a6026ba62fb00", "message": "Support mutual ssl mandatory option with vendor extensions", "committedDate": "2020-08-06T22:52:05Z", "type": "commit"}, {"oid": "2498dd4b615305a1103a08602e8e086a18d15826", "url": "https://github.com/wso2/carbon-apimgt/commit/2498dd4b615305a1103a08602e8e086a18d15826", "message": "Map and inject Mgw Throttling Extensions To Default extensions", "committedDate": "2020-08-06T22:52:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkxMzY1OQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/9149#discussion_r466913659", "bodyText": "Shall we move this to \n  \n    \n      carbon-apimgt/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OASParserUtil.java\n    \n    \n        Lines 1325 to 1329\n      in\n      62dbf8e\n    \n    \n    \n    \n\n        \n          \n           public static String preProcess(String swaggerContent) throws APIManagementException { \n        \n\n        \n          \n               //Load required properties from swagger to the API \n        \n\n        \n          \n               APIDefinition apiDefinition = getOASParser(swaggerContent); \n        \n\n        \n          \n               return apiDefinition.processOtherSchemeScopes(swaggerContent); \n        \n\n        \n          \n           }", "author": "malinthaprasan", "createdAt": "2020-08-07T08:58:04Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS2Parser.java", "diffHunk": "@@ -1276,6 +1276,7 @@ private boolean isDefaultGiven(String swaggerContent) throws APIManagementExcept\n     public String processOtherSchemeScopes(String swaggerContent) throws APIManagementException {\n         if (!isDefaultGiven(swaggerContent)) {\n             Swagger swagger = getSwagger(swaggerContent);\n+            swagger = injectMgwThrottlingExtensionsToDefault(swagger);", "originalCommit": "2498dd4b615305a1103a08602e8e086a18d15826", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ffc073eefb5915ac13e81dd0f05a272103e3cd7b", "chunk": "diff --git a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS2Parser.java b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS2Parser.java\nindex bd113b7299c..84b7dbddb77 100644\n--- a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS2Parser.java\n+++ b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS2Parser.java\n\n@@ -1276,7 +1276,6 @@ public class OAS2Parser extends APIDefinition {\n     public String processOtherSchemeScopes(String swaggerContent) throws APIManagementException {\n         if (!isDefaultGiven(swaggerContent)) {\n             Swagger swagger = getSwagger(swaggerContent);\n-            swagger = injectMgwThrottlingExtensionsToDefault(swagger);\n             swagger = processLegacyScopes(swagger);\n             swagger = injectOtherScopesToDefaultScheme(swagger);\n             swagger = injectOtherResourceScopesToDefaultScheme(swagger);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkxMzc5MA==", "url": "https://github.com/wso2/carbon-apimgt/pull/9149#discussion_r466913790", "bodyText": "make it an interface method of API definition and implement it here.\nSo you can call it from preProcess method above", "author": "malinthaprasan", "createdAt": "2020-08-07T08:58:19Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS2Parser.java", "diffHunk": "@@ -1284,6 +1285,36 @@ public String processOtherSchemeScopes(String swaggerContent) throws APIManageme\n         return swaggerContent;\n     }\n \n+    /**\n+     * This method returns swagger definition which replaced X-WSO2-throttling-tier extension comes from\n+     * mgw with X-throttling-tier extensions in swagger file(Swagger version 2)\n+     *\n+     * @param swagger Swagger\n+     * @return Swagger\n+     * @throws APIManagementException\n+     */\n+    private Swagger injectMgwThrottlingExtensionsToDefault(Swagger swagger) throws APIManagementException {", "originalCommit": "2498dd4b615305a1103a08602e8e086a18d15826", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ffc073eefb5915ac13e81dd0f05a272103e3cd7b", "chunk": "diff --git a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS2Parser.java b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS2Parser.java\nindex bd113b7299c..84b7dbddb77 100644\n--- a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS2Parser.java\n+++ b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS2Parser.java\n\n@@ -1289,11 +1288,13 @@ public class OAS2Parser extends APIDefinition {\n      * This method returns swagger definition which replaced X-WSO2-throttling-tier extension comes from\n      * mgw with X-throttling-tier extensions in swagger file(Swagger version 2)\n      *\n-     * @param swagger Swagger\n-     * @return Swagger\n+     * @param swaggerContent String\n+     * @return String\n      * @throws APIManagementException\n      */\n-    private Swagger injectMgwThrottlingExtensionsToDefault(Swagger swagger) throws APIManagementException {\n+    @Override\n+    public String injectMgwThrottlingExtensionsToDefault(String swaggerContent) throws APIManagementException {\n+        Swagger swagger = getSwagger(swaggerContent);\n         Map<String, Path> paths = swagger.getPaths();\n         for (String pathKey : paths.keySet()) {\n             Map<HttpMethod, Operation> operationsMap = paths.get(pathKey).getOperationMap();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkxMzg5NA==", "url": "https://github.com/wso2/carbon-apimgt/pull/9149#discussion_r466913894", "bodyText": "same here", "author": "malinthaprasan", "createdAt": "2020-08-07T08:58:31Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS3Parser.java", "diffHunk": "@@ -1344,6 +1347,7 @@ private boolean isDefaultGiven(String swaggerContent) throws APIManagementExcept\n     @Override\n     public String processOtherSchemeScopes(String swaggerContent) throws APIManagementException {\n         OpenAPI openAPI = getOpenAPI(swaggerContent);\n+        openAPI = injectMgwThrottlingExtensionsToDefault(openAPI);", "originalCommit": "2498dd4b615305a1103a08602e8e086a18d15826", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ffc073eefb5915ac13e81dd0f05a272103e3cd7b", "chunk": "diff --git a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS3Parser.java b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS3Parser.java\nindex 0cddcb73a59..0e808c2d48c 100644\n--- a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS3Parser.java\n+++ b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS3Parser.java\n\n@@ -1347,7 +1347,6 @@ public class OAS3Parser extends APIDefinition {\n     @Override\n     public String processOtherSchemeScopes(String swaggerContent) throws APIManagementException {\n         OpenAPI openAPI = getOpenAPI(swaggerContent);\n-        openAPI = injectMgwThrottlingExtensionsToDefault(openAPI);\n         Set<Scope> legacyScopes = getScopesFromExtensions(openAPI);\n \n         //In case default scheme already exists we check whether the legacy x-wso2-scopes are there in the default scheme\n"}}, {"oid": "ffc073eefb5915ac13e81dd0f05a272103e3cd7b", "url": "https://github.com/wso2/carbon-apimgt/commit/ffc073eefb5915ac13e81dd0f05a272103e3cd7b", "message": "Adding suggestions", "committedDate": "2020-08-07T09:44:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njk0NjEwOQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/9149#discussion_r466946109", "bodyText": "Do we need these 3 lines?", "author": "malinthaprasan", "createdAt": "2020-08-07T10:03:34Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS2Parser.java", "diffHunk": "@@ -1284,6 +1284,38 @@ public String processOtherSchemeScopes(String swaggerContent) throws APIManageme\n         return swaggerContent;\n     }\n \n+    /**\n+     * This method returns swagger definition which replaced X-WSO2-throttling-tier extension comes from\n+     * mgw with X-throttling-tier extensions in swagger file(Swagger version 2)\n+     *\n+     * @param swaggerContent String\n+     * @return String\n+     * @throws APIManagementException\n+     */\n+    @Override\n+    public String injectMgwThrottlingExtensionsToDefault(String swaggerContent) throws APIManagementException {\n+        Swagger swagger = getSwagger(swaggerContent);\n+        Map<String, Path> paths = swagger.getPaths();\n+        for (String pathKey : paths.keySet()) {\n+            Map<HttpMethod, Operation> operationsMap = paths.get(pathKey).getOperationMap();\n+            for (Map.Entry<HttpMethod, Operation> entry : operationsMap.entrySet()) {\n+                Operation operation = entry.getValue();\n+                Map<String, Object> extensions = operation.getVendorExtensions();\n+                if (extensions.containsKey(APIConstants.X_WSO2_THROTTLING_TIER)) {\n+                    Object tier = extensions.get(APIConstants.X_WSO2_THROTTLING_TIER);\n+                    extensions.remove(APIConstants.X_WSO2_THROTTLING_TIER);\n+                    extensions.put(APIConstants.SWAGGER_X_THROTTLING_TIER, tier);\n+                }\n+                operation.setVendorExtensions(extensions);\n+                entry.setValue(operation);\n+                operationsMap.put(entry.getKey(), operation);", "originalCommit": "ffc073eefb5915ac13e81dd0f05a272103e3cd7b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7745658f173c640098add6907c5d8f6404084586", "chunk": "diff --git a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS2Parser.java b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS2Parser.java\nindex 84b7dbddb77..452808e6886 100644\n--- a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS2Parser.java\n+++ b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS2Parser.java\n\n@@ -1301,18 +1301,13 @@ public class OAS2Parser extends APIDefinition {\n             for (Map.Entry<HttpMethod, Operation> entry : operationsMap.entrySet()) {\n                 Operation operation = entry.getValue();\n                 Map<String, Object> extensions = operation.getVendorExtensions();\n-                if (extensions.containsKey(APIConstants.X_WSO2_THROTTLING_TIER)) {\n+                if (extensions != null && extensions.containsKey(APIConstants.X_WSO2_THROTTLING_TIER)) {\n                     Object tier = extensions.get(APIConstants.X_WSO2_THROTTLING_TIER);\n                     extensions.remove(APIConstants.X_WSO2_THROTTLING_TIER);\n                     extensions.put(APIConstants.SWAGGER_X_THROTTLING_TIER, tier);\n                 }\n-                operation.setVendorExtensions(extensions);\n-                entry.setValue(operation);\n-                operationsMap.put(entry.getKey(), operation);\n             }\n-            paths.put(pathKey, paths.get(pathKey));\n         }\n-        swagger.setPaths(paths);\n         return getSwaggerJsonString(swagger);\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njk0NjE3NA==", "url": "https://github.com/wso2/carbon-apimgt/pull/9149#discussion_r466946174", "bodyText": "same here.", "author": "malinthaprasan", "createdAt": "2020-08-07T10:03:45Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS3Parser.java", "diffHunk": "@@ -1378,6 +1381,38 @@ public String processOtherSchemeScopes(String swaggerContent) throws APIManageme\n         return swaggerContent;\n     }\n \n+    /**\n+     * This method returns openAPI definition which replaced X-WSO2-throttling-tier extension comes from\n+     * mgw with X-throttling-tier extensions in openAPI file(openAPI version 3)\n+     *\n+     * @param swaggerContent String\n+     * @return String\n+     * @throws APIManagementException\n+     */\n+    @Override\n+    public String injectMgwThrottlingExtensionsToDefault(String swaggerContent) throws APIManagementException {\n+        OpenAPI openAPI = getOpenAPI(swaggerContent);\n+        Paths paths = openAPI.getPaths();\n+        for (String pathKey : paths.keySet()) {\n+            Map<PathItem.HttpMethod, Operation> operationsMap = paths.get(pathKey).readOperationsMap();\n+            for (Map.Entry<PathItem.HttpMethod, Operation> entry : operationsMap.entrySet()) {\n+                Operation operation = entry.getValue();\n+                Map<String, Object> extensions = operation.getExtensions();\n+                if (extensions.containsKey(APIConstants.X_WSO2_THROTTLING_TIER)) {", "originalCommit": "ffc073eefb5915ac13e81dd0f05a272103e3cd7b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7745658f173c640098add6907c5d8f6404084586", "chunk": "diff --git a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS3Parser.java b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS3Parser.java\nindex 0e808c2d48c..e62ea4e2090 100644\n--- a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS3Parser.java\n+++ b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS3Parser.java\n\n@@ -1398,18 +1398,13 @@ public class OAS3Parser extends APIDefinition {\n             for (Map.Entry<PathItem.HttpMethod, Operation> entry : operationsMap.entrySet()) {\n                 Operation operation = entry.getValue();\n                 Map<String, Object> extensions = operation.getExtensions();\n-                if (extensions.containsKey(APIConstants.X_WSO2_THROTTLING_TIER)) {\n+                if (extensions != null && extensions.containsKey(APIConstants.X_WSO2_THROTTLING_TIER)) {\n                     Object tier = extensions.get(APIConstants.X_WSO2_THROTTLING_TIER);\n                     extensions.remove(APIConstants.X_WSO2_THROTTLING_TIER);\n                     extensions.put(APIConstants.SWAGGER_X_THROTTLING_TIER, tier);\n                 }\n-                operation.setExtensions(extensions);\n-                entry.setValue(operation);\n-                operationsMap.put(entry.getKey(), operation);\n             }\n-            paths.put(pathKey, paths.get(pathKey));\n         }\n-        openAPI.setPaths(paths);\n         return Json.pretty(openAPI);\n     }\n \n"}}, {"oid": "7745658f173c640098add6907c5d8f6404084586", "url": "https://github.com/wso2/carbon-apimgt/commit/7745658f173c640098add6907c5d8f6404084586", "message": "Fixing commented reviews", "committedDate": "2020-08-07T10:48:15Z", "type": "commit"}]}