{"pr_number": 8405, "pr_title": "Add REST API to retrieve subscriber-info", "pr_createdAt": "2020-04-14T09:29:57Z", "pr_url": "https://github.com/wso2/carbon-apimgt/pull/8405", "timeline": [{"oid": "b65ad2efcec6f670ef4ad31a1019f2c8f9a061ce", "url": "https://github.com/wso2/carbon-apimgt/commit/b65ad2efcec6f670ef4ad31a1019f2c8f9a061ce", "message": "Add implementation for retrieving subscriber claims", "committedDate": "2020-04-14T04:45:20Z", "type": "commit"}, {"oid": "11af67c9b4d1b6b12b00e9c8297b3b49add005f8", "url": "https://github.com/wso2/carbon-apimgt/commit/11af67c9b4d1b6b12b00e9c8297b3b49add005f8", "message": "Modified testcases", "committedDate": "2020-04-14T05:01:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODU2NTY5Mw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8405#discussion_r408565693", "bodyText": "We should pass the full username to get the tenant domain correctly.\nPlease test with an email username for a tenant.", "author": "isharac", "createdAt": "2020-04-15T03:54:54Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIProviderImpl.java", "diffHunk": "@@ -2006,6 +2008,51 @@ public void makeAPIKeysForwardCompatible(API api) throws APIManagementException\n         }\n     }\n \n+    /**\n+     * Returns the subscriber name for the given subscription id.\n+     *\n+     * @param subscriptionId The subscription id of the subscriber to be returned\n+     * @return The subscriber or null if the requested subscriber does not exist\n+     * @throws APIManagementException if failed to get Subscriber\n+     */\n+    @Override\n+    public String getSubscriber(String subscriptionId) throws APIManagementException {\n+        return apiMgtDAO.getSubscriberName(subscriptionId);\n+    }\n+\n+    /**\n+     * Returns the claims of subscriber for the given subscriber.\n+     *\n+     * @param subscriber The name of the subscriber to be returned\n+     * @return The looked up claims of the subscriber or null if the requested subscriber does not exist\n+     * @throws APIManagementException if failed to get Subscriber\n+     */\n+    @Override\n+    public List getSubscriberClaims(String subscriber) throws APIManagementException {\n+        String tenantDomain = MultitenantUtils.getTenantDomain(subscriber);", "originalCommit": "11af67c9b4d1b6b12b00e9c8297b3b49add005f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk5OTk5OA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8405#discussion_r409999998", "bodyText": "Will test and update", "author": "vithu30", "createdAt": "2020-04-17T05:28:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODU2NTY5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMxMjQ4NQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8405#discussion_r411312485", "bodyText": "Tested and it works", "author": "vithu30", "createdAt": "2020-04-20T11:46:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODU2NTY5Mw=="}], "type": "inlineReview", "revised_code": {"commit": "5d6562974dd173271ebb1230fb3d76ca2eea6223", "chunk": "diff --git a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIProviderImpl.java b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIProviderImpl.java\nindex 4a0c521d4cf..dfe7d73ffd1 100644\n--- a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIProviderImpl.java\n+++ b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIProviderImpl.java\n\n@@ -2028,10 +2028,10 @@ class APIProviderImpl extends AbstractAPIManager implements APIProvider {\n      * @throws APIManagementException if failed to get Subscriber\n      */\n     @Override\n-    public List getSubscriberClaims(String subscriber) throws APIManagementException {\n+    public Map<String, String> getSubscriberClaims(String subscriber) throws APIManagementException {\n         String tenantDomain = MultitenantUtils.getTenantDomain(subscriber);\n         int tenantId = 0;\n-        List claimList = new ArrayList();\n+        Map<String, String> claimMap = new HashMap<>();\n         try {\n             tenantId = getTenantId(tenantDomain);\n         SortedMap<String, String> subscriberClaims =\n"}}, {"oid": "206caa818442818b4ed0483269925bdd728c2721", "url": "https://github.com/wso2/carbon-apimgt/commit/206caa818442818b4ed0483269925bdd728c2721", "message": "Commit missing auto-gen file changes", "committedDate": "2020-04-20T13:58:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ2NTcwNw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8405#discussion_r411465707", "bodyText": "Can we use try with resources?", "author": "malinthaprasan", "createdAt": "2020-04-20T15:20:34Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/ApiMgtDAO.java", "diffHunk": "@@ -590,6 +590,51 @@ public void addSubscriber(Subscriber subscriber, String groupingId) throws APIMa\n         }\n     }\n \n+    /**\n+     * Get subscriber name using subscription ID\n+     *\n+     * @param subscriptionId\n+     * @return subscriber name\n+     * @throws APIManagementException\n+     */\n+    public String getSubscriberName(String subscriptionId) throws APIManagementException {\n+        int subscriberId = getSubscriberIdBySubscriptionUUID(subscriptionId);\n+        Subscriber subscriber = getSubscriber(subscriberId);\n+        if (subscriber != null) {\n+            return subscriber.getName();\n+        }\n+        return StringUtils.EMPTY;\n+    }\n+\n+    /**\n+     * Get subscriber ID using subscription ID\n+     *\n+     * @param subscriptionId\n+     * @return subscriber ID\n+     * @throws APIManagementException\n+     */\n+    private int getSubscriberIdBySubscriptionUUID(String subscriptionId) throws APIManagementException {\n+        Connection connection = null;\n+        ResultSet rs = null;\n+        PreparedStatement ps = null;\n+        int subscirberId = 0;\n+        try {", "originalCommit": "206caa818442818b4ed0483269925bdd728c2721", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTg2MjgxNg==", "url": "https://github.com/wso2/carbon-apimgt/pull/8405#discussion_r411862816", "bodyText": "Fixed in 4b0356d", "author": "vithu30", "createdAt": "2020-04-21T04:38:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ2NTcwNw=="}], "type": "inlineReview", "revised_code": {"commit": "4b0356dbd07b9e8aaa4f283845c343996467b748", "chunk": "diff --git a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/ApiMgtDAO.java b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/ApiMgtDAO.java\nindex 66952dcf0dd..59e07fd1815 100644\n--- a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/ApiMgtDAO.java\n+++ b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/ApiMgtDAO.java\n\n@@ -614,23 +614,18 @@ public class ApiMgtDAO {\n      * @throws APIManagementException\n      */\n     private int getSubscriberIdBySubscriptionUUID(String subscriptionId) throws APIManagementException {\n-        Connection connection = null;\n-        ResultSet rs = null;\n-        PreparedStatement ps = null;\n         int subscirberId = 0;\n-        try {\n-            connection = APIMgtDBUtil.getConnection();\n-            String query = SQLConstants.GET_SUBSCRIBER_ID_BY_SUBSCRIPTION_UUID_SQL;\n-            ps = connection.prepareStatement(query);\n+        String query = SQLConstants.GET_SUBSCRIBER_ID_BY_SUBSCRIPTION_UUID_SQL;\n+        try (Connection connection = APIMgtDBUtil.getConnection();\n+            PreparedStatement ps = connection.prepareStatement(query)) {\n             ps.setString(1, subscriptionId);\n-            rs = ps.executeQuery();\n-            if (rs.next()) {\n-                subscirberId = rs.getInt(APIConstants.APPLICATION_SUBSCRIBER_ID);\n+            try (ResultSet rs = ps.executeQuery()) {\n+                if (rs.next()) {\n+                    subscirberId = rs.getInt(APIConstants.APPLICATION_SUBSCRIBER_ID);\n+                }\n             }\n         } catch (SQLException e) {\n             handleException(\"Error while retrieving Subscriber ID: \", e);\n-        } finally {\n-            APIMgtDBUtil.closeAllConnections(ps, connection, rs);\n         }\n         return subscirberId;\n     }\n"}}, {"oid": "4b0356dbd07b9e8aaa4f283845c343996467b748", "url": "https://github.com/wso2/carbon-apimgt/commit/4b0356dbd07b9e8aaa4f283845c343996467b748", "message": "Resolve review comments", "committedDate": "2020-04-21T04:09:37Z", "type": "commit"}, {"oid": "5d6562974dd173271ebb1230fb3d76ca2eea6223", "url": "https://github.com/wso2/carbon-apimgt/commit/5d6562974dd173271ebb1230fb3d76ca2eea6223", "message": "Resolve review comments", "committedDate": "2020-04-22T08:27:41Z", "type": "commit"}]}