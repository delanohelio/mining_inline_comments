{"pr_number": 8491, "pr_title": "Add deleteEndpointRegistry resource", "pr_createdAt": "2020-05-12T11:20:22Z", "pr_url": "https://github.com/wso2/carbon-apimgt/pull/8491", "timeline": [{"oid": "9ec56847f87e56b3bac72faabfa6d265f98959e8", "url": "https://github.com/wso2/carbon-apimgt/commit/9ec56847f87e56b3bac72faabfa6d265f98959e8", "message": "Add deleteEndpointRegistry resource", "committedDate": "2020-05-12T11:18:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY2NTM2MA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8491#discussion_r423665360", "bodyText": "Shall we do this in the REST API level, so that we can throw the exception from there itself? I felt the readability is a bit reduced when we throw it from here and catch it from the parent and then handle the exception again. Also, this supports the single responsibility principle by only focusing on the delete operation.", "author": "fazlan-nazeem", "createdAt": "2020-05-12T11:38:19Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/EndpointRegistryImpl.java", "diffHunk": "@@ -78,6 +78,21 @@ public EndpointRegistryInfo getEndpointRegistryByUUID(String registryId) throws\n         return apiMgtDAO.getEndpointRegistryByUUID(registryId);\n     }\n \n+    /**\n+     * Deletes an Endpoint Registry\n+     *\n+     * @param registryId Registry Identifier(UUID)\n+     * @throws APIManagementException if failed to delete the Endpoint Registry\n+     */\n+    public void deleteEndpointRegistry(String registryId) throws APIManagementException {\n+        EndpointRegistryInfo endpointRegistryInfo = apiMgtDAO.getEndpointRegistryByUUID(registryId);", "originalCommit": "9ec56847f87e56b3bac72faabfa6d265f98959e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY2NTgyMw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8491#discussion_r423665823", "bodyText": "if you agree with this approach, you may change the same in other places as well.", "author": "fazlan-nazeem", "createdAt": "2020-05-12T11:39:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY2NTM2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzcwODgyMw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8491#discussion_r423708823", "bodyText": "Fixed with the commit dd74437", "author": "ChamodDamitha", "createdAt": "2020-05-12T12:54:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY2NTM2MA=="}], "type": "inlineReview", "revised_code": {"commit": "dd7443796a9a205dceb60642d4892d562f9cb057", "chunk": "diff --git a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/EndpointRegistryImpl.java b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/EndpointRegistryImpl.java\nindex 5913abd338a..c9f57a2c998 100644\n--- a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/EndpointRegistryImpl.java\n+++ b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/EndpointRegistryImpl.java\n\n@@ -81,16 +81,12 @@ public class EndpointRegistryImpl implements EndpointRegistry {\n     /**\n      * Deletes an Endpoint Registry\n      *\n-     * @param registryId Registry Identifier(UUID)\n+     * @param registryUUID Registry Identifier(UUID)\n+     * @param registryId Registry Identifier\n      * @throws APIManagementException if failed to delete the Endpoint Registry\n      */\n-    public void deleteEndpointRegistry(String registryId) throws APIManagementException {\n-        EndpointRegistryInfo endpointRegistryInfo = apiMgtDAO.getEndpointRegistryByUUID(registryId);\n-        if (endpointRegistryInfo == null) {\n-            APIUtil.handleResourceNotFoundException(\"Endpoint Registry with id: \" + registryId + \" does not exist\");\n-        } else {\n-            apiMgtDAO.deleteEndpointRegistry(registryId, endpointRegistryInfo.getRegistryId());\n-        }\n+    public void deleteEndpointRegistry(String registryUUID, int registryId) throws APIManagementException {\n+        apiMgtDAO.deleteEndpointRegistry(registryUUID, registryId);\n     }\n \n     /**\n"}}, {"oid": "dd7443796a9a205dceb60642d4892d562f9cb057", "url": "https://github.com/wso2/carbon-apimgt/commit/dd7443796a9a205dceb60642d4892d562f9cb057", "message": "Handle resource not found exception at REST API Level", "committedDate": "2020-05-12T12:20:03Z", "type": "commit"}, {"oid": "a6e1f3813d3d253476c07cf3ae7b5e4900f70600", "url": "https://github.com/wso2/carbon-apimgt/commit/a6e1f3813d3d253476c07cf3ae7b5e4900f70600", "message": "Add cross-tenant restriction for endpoint registry resources", "committedDate": "2020-05-12T12:53:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc0NDA3MA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8491#discussion_r423744070", "bodyText": "We don't need this right? since we have 'delete on cascade' ? deleting the registry should delete the entries automatically.", "author": "fazlan-nazeem", "createdAt": "2020-05-12T13:43:57Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/ApiMgtDAO.java", "diffHunk": "@@ -14789,6 +14792,32 @@ public EndpointRegistryInfo getEndpointRegistryByUUID(String registryId) throws\n         return null;\n     }\n \n+    /**\n+     * Deletes an Endpoint Registry\n+     *\n+     * @param registryUUID Registry Identifier(UUID)\n+     * @param registryId Registry Identifier\n+     * @throws APIManagementException if failed to delete the Endpoint Registry\n+     */\n+    public void deleteEndpointRegistry(String registryUUID, int registryId) throws APIManagementException {\n+        String deleteRegQuery = SQLConstants.DELETE_ENDPOINT_REGISTRY_SQL;\n+        String deleteRegEntryQuery = SQLConstants.DELETE_ENDPOINT_REGISTRY_ENTRY_BY_REGISTRY_ID_SQL;", "originalCommit": "a6e1f3813d3d253476c07cf3ae7b5e4900f70600", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc0NzgyOA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8491#discussion_r423747828", "bodyText": "Ah yes. I ll update it", "author": "ChamodDamitha", "createdAt": "2020-05-12T13:48:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc0NDA3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc1MDMwMA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8491#discussion_r423750300", "bodyText": "Fixed in ff8b5f9", "author": "ChamodDamitha", "createdAt": "2020-05-12T13:51:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc0NDA3MA=="}], "type": "inlineReview", "revised_code": {"commit": "ff8b5f92252c2c3497e900ed0ffdc9071c032be5", "chunk": "diff --git a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/ApiMgtDAO.java b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/ApiMgtDAO.java\nindex 200cbbea729..9f79575d7a8 100644\n--- a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/ApiMgtDAO.java\n+++ b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/ApiMgtDAO.java\n\n@@ -14796,21 +14796,16 @@ public class ApiMgtDAO {\n      * Deletes an Endpoint Registry\n      *\n      * @param registryUUID Registry Identifier(UUID)\n-     * @param registryId Registry Identifier\n      * @throws APIManagementException if failed to delete the Endpoint Registry\n      */\n-    public void deleteEndpointRegistry(String registryUUID, int registryId) throws APIManagementException {\n+    public void deleteEndpointRegistry(String registryUUID) throws APIManagementException {\n         String deleteRegQuery = SQLConstants.DELETE_ENDPOINT_REGISTRY_SQL;\n-        String deleteRegEntryQuery = SQLConstants.DELETE_ENDPOINT_REGISTRY_ENTRY_BY_REGISTRY_ID_SQL;\n \n         try (Connection connection = APIMgtDBUtil.getConnection();\n-             PreparedStatement statementDeleteRegistryEntries = connection.prepareStatement(deleteRegEntryQuery);\n              PreparedStatement statementDeleteRegistry = connection.prepareStatement(deleteRegQuery)\n              ) {\n             connection.setAutoCommit(false);\n-            statementDeleteRegistryEntries.setInt(1, registryId);\n-            statementDeleteRegistryEntries.execute();\n-            statementDeleteRegistry.setInt(1, registryId);\n+            statementDeleteRegistry.setString(1, registryUUID);\n             statementDeleteRegistry.execute();\n             connection.commit();\n         } catch (SQLException e) {\n"}}, {"oid": "ff8b5f92252c2c3497e900ed0ffdc9071c032be5", "url": "https://github.com/wso2/carbon-apimgt/commit/ff8b5f92252c2c3497e900ed0ffdc9071c032be5", "message": "Remove unnecessary endpoint registry entry delete query", "committedDate": "2020-05-12T14:03:29Z", "type": "commit"}, {"oid": "ff8b5f92252c2c3497e900ed0ffdc9071c032be5", "url": "https://github.com/wso2/carbon-apimgt/commit/ff8b5f92252c2c3497e900ed0ffdc9071c032be5", "message": "Remove unnecessary endpoint registry entry delete query", "committedDate": "2020-05-12T14:03:29Z", "type": "forcePushed"}]}