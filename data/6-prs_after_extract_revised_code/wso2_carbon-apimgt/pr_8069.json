{"pr_number": 8069, "pr_title": "Fix caches already existing when initializing issue", "pr_createdAt": "2020-01-09T06:40:08Z", "pr_url": "https://github.com/wso2/carbon-apimgt/pull/8069", "timeline": [{"oid": "f6e25f95dbc2bd8cc9a58fd1fcd5ebf808f7a2f1", "url": "https://github.com/wso2/carbon-apimgt/commit/f6e25f95dbc2bd8cc9a58fd1fcd5ebf808f7a2f1", "message": "Fix caches already existing when initializing issue", "committedDate": "2020-01-09T06:37:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE0MTg4Mg==", "url": "https://github.com/wso2/carbon-apimgt/pull/8069#discussion_r375141882", "bodyText": "Formatting issue", "author": "mushthaq33", "createdAt": "2020-02-05T09:26:34Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java", "diffHunk": "@@ -8202,9 +8202,16 @@ public static String getAnalyticsServerPassword() {\n      * @param accessExp        - Value of the ACCESSED Expiry Type\n      * @return - The cache object\n      */\n-    public static Cache getCache(final String cacheManagerName, final String cacheName, final long modifiedExp,\n+    public synchronized static Cache getCache(final String cacheManagerName, final String cacheName, final long modifiedExp,\n                                  final long accessExp) {\n \n+        Iterable<Cache<?, ?>> availableCaches = Caching.getCacheManager(cacheManagerName).getCaches();\n+        for (Cache cache:availableCaches) {\n+            if(cache.getName().equalsIgnoreCase(getCacheName(cacheName))){", "originalCommit": "f6e25f95dbc2bd8cc9a58fd1fcd5ebf808f7a2f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDgxNDgzOA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8069#discussion_r410814838", "bodyText": "resolved by #8332", "author": "CrowleyRajapakse", "createdAt": "2020-04-19T04:49:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE0MTg4Mg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE0MjAxMQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8069#discussion_r375142011", "bodyText": "Formatting issue", "author": "mushthaq33", "createdAt": "2020-02-05T09:26:47Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java", "diffHunk": "@@ -8202,9 +8202,16 @@ public static String getAnalyticsServerPassword() {\n      * @param accessExp        - Value of the ACCESSED Expiry Type\n      * @return - The cache object\n      */\n-    public static Cache getCache(final String cacheManagerName, final String cacheName, final long modifiedExp,\n+    public synchronized static Cache getCache(final String cacheManagerName, final String cacheName, final long modifiedExp,\n                                  final long accessExp) {\n \n+        Iterable<Cache<?, ?>> availableCaches = Caching.getCacheManager(cacheManagerName).getCaches();\n+        for (Cache cache:availableCaches) {", "originalCommit": "f6e25f95dbc2bd8cc9a58fd1fcd5ebf808f7a2f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDgxNDc1Ng==", "url": "https://github.com/wso2/carbon-apimgt/pull/8069#discussion_r410814756", "bodyText": "resolved by #8332", "author": "CrowleyRajapakse", "createdAt": "2020-04-19T04:48:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE0MjAxMQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY2MjI4Mg==", "url": "https://github.com/wso2/carbon-apimgt/pull/8069#discussion_r375662282", "bodyText": "use braces to improve readability\nreturn (Boolean.parseBoolean(ServerConfiguration.getInstance().getFirstProperty(\"Cache.ForceLocalCache\"))\n&& !cacheName.startsWith(\"$local$.\")) ? \"$local$.\" + cacheName : cacheName;", "author": "isharac", "createdAt": "2020-02-06T06:40:41Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java", "diffHunk": "@@ -8224,6 +8231,11 @@ public static Cache getCache(final String cacheManagerName, final String cacheNa\n         return Caching.getCacheManager(cacheManagerName).getCache(cacheName);\n     }\n \n+    private static String getCacheName(String cacheName) {\n+        return Boolean.parseBoolean(ServerConfiguration.getInstance().getFirstProperty(\"Cache.ForceLocalCache\"))", "originalCommit": "f6e25f95dbc2bd8cc9a58fd1fcd5ebf808f7a2f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDgxNDg2MA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8069#discussion_r410814860", "bodyText": "resolved by #8332", "author": "CrowleyRajapakse", "createdAt": "2020-04-19T04:50:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY2MjI4Mg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY4NzMzMw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8069#discussion_r383687333", "bodyText": "Do we need to synchronize this at the method level? If this method is abundantly used, then having the method synchronized would produce unnecessary contentions. If that's the case can we only wrap the object creation with a sync block?", "author": "jaadds", "createdAt": "2020-02-25T06:51:24Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java", "diffHunk": "@@ -8202,9 +8202,16 @@ public static String getAnalyticsServerPassword() {\n      * @param accessExp        - Value of the ACCESSED Expiry Type\n      * @return - The cache object\n      */\n-    public static Cache getCache(final String cacheManagerName, final String cacheName, final long modifiedExp,\n+    public synchronized static Cache getCache(final String cacheManagerName, final String cacheName, final long modifiedExp,", "originalCommit": "f6e25f95dbc2bd8cc9a58fd1fcd5ebf808f7a2f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA5NTMwNQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8069#discussion_r402095305", "bodyText": "When starting up the server and caches are getting initialised and intermittently some threads try to access the caches simultaneously, so when two thread already inside this method and  trying to create the same cache if not present, then following kind of sample error occurs.\njavax.cache.CacheException: Cache $__local__$.gatewayUsernameCache already exists\nAs per my understanding only in startup time this method get's invoked which creates the relevant caches.", "author": "CrowleyRajapakse", "createdAt": "2020-04-02T07:07:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY4NzMzMw=="}], "type": "inlineReview", "revised_code": null}]}