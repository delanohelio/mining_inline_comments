{"pr_number": 8377, "pr_title": "fix monetization properties replaced during api republish", "pr_createdAt": "2020-03-19T16:14:27Z", "pr_url": "https://github.com/wso2/carbon-apimgt/pull/8377", "timeline": [{"oid": "74c6dcb7cd4252f906deb8336f62ee0adc3362c2", "url": "https://github.com/wso2/carbon-apimgt/commit/74c6dcb7cd4252f906deb8336f62ee0adc3362c2", "message": "fix monetization properties replaced during swagger put issue", "committedDate": "2020-03-19T16:04:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE1ODQ2Mg==", "url": "https://github.com/wso2/carbon-apimgt/pull/8377#discussion_r395158462", "bodyText": "This could result null pointer?", "author": "Krishanx92", "createdAt": "2020-03-19T16:29:59Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIProviderImpl.java", "diffHunk": "@@ -1127,6 +1128,27 @@ public void updateAPI(API api) throws APIManagementException, FaultGatewaysExcep\n \n         Map<String, Map<String, String>> failedGateways = new ConcurrentHashMap<>();\n         API oldApi = getAPI(api.getId());\n+        Gson gson = new Gson();\n+        Map<String, String> oldMonetizationProperties = gson.fromJson(oldApi.getMonetizationProperties().toString(),\n+                HashMap.class);\n+        if (!oldMonetizationProperties.isEmpty()) {", "originalCommit": "74c6dcb7cd4252f906deb8336f62ee0adc3362c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE2ODgwNA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8377#discussion_r395168804", "bodyText": "fixed 276411f", "author": "dushansilva", "createdAt": "2020-03-19T16:44:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE1ODQ2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "276411f69f5e874554378f52f314185bb6bb89d5", "chunk": "diff --git a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIProviderImpl.java b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIProviderImpl.java\nindex f49960321ae..a35edbf2cd6 100644\n--- a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIProviderImpl.java\n+++ b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIProviderImpl.java\n\n@@ -1131,21 +1131,23 @@ class APIProviderImpl extends AbstractAPIManager implements APIProvider {\n         Gson gson = new Gson();\n         Map<String, String> oldMonetizationProperties = gson.fromJson(oldApi.getMonetizationProperties().toString(),\n                 HashMap.class);\n-        if (!oldMonetizationProperties.isEmpty()) {\n+        if (oldMonetizationProperties != null && !oldMonetizationProperties.isEmpty()) {\n             Map<String, String> newMonetizationProperties = gson.fromJson(api.getMonetizationProperties().toString(),\n                     HashMap.class);\n-            for (Map.Entry<String, String> entry : oldMonetizationProperties.entrySet()) {\n-                String newValue = newMonetizationProperties.get(entry.getKey());\n-                if (StringUtils.isAllBlank(newValue)) {\n-                    newMonetizationProperties.put(entry.getKey(), entry.getValue());\n+            if (newMonetizationProperties != null) {\n+                for (Map.Entry<String, String> entry : oldMonetizationProperties.entrySet()) {\n+                    String newValue = newMonetizationProperties.get(entry.getKey());\n+                    if (StringUtils.isAllBlank(newValue)) {\n+                        newMonetizationProperties.put(entry.getKey(), entry.getValue());\n+                    }\n+                }\n+                JSONParser parser = new JSONParser();\n+                try {\n+                    JSONObject jsonObj = (JSONObject) parser.parse(gson.toJson(newMonetizationProperties));\n+                    api.setMonetizationProperties(jsonObj);\n+                } catch (ParseException e) {\n+                    throw new APIManagementException(\"Error when parsing monetization properties \", e);\n                 }\n-            }\n-            JSONParser parser = new JSONParser();\n-            try {\n-                JSONObject jsonObj = (JSONObject) parser.parse(gson.toJson(newMonetizationProperties));\n-                api.setMonetizationProperties(jsonObj);\n-            } catch (ParseException e) {\n-                throw new APIManagementException(\"Error when parsing monetization properties \", e);\n             }\n         }\n \n"}}, {"oid": "276411f69f5e874554378f52f314185bb6bb89d5", "url": "https://github.com/wso2/carbon-apimgt/commit/276411f69f5e874554378f52f314185bb6bb89d5", "message": "fix review comments", "committedDate": "2020-03-19T16:44:07Z", "type": "commit"}]}