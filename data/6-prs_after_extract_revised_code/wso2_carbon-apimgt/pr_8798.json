{"pr_number": 8798, "pr_title": "fix JWT related issues", "pr_createdAt": "2020-06-22T08:09:06Z", "pr_url": "https://github.com/wso2/carbon-apimgt/pull/8798", "timeline": [{"oid": "e617bf95dde51f2fc3a7bd13e3b99f3e26bd1e95", "url": "https://github.com/wso2/carbon-apimgt/commit/e617bf95dde51f2fc3a7bd13e3b99f3e26bd1e95", "message": "fix JWT related issues", "committedDate": "2020-06-22T08:10:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM5MjIwMQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8798#discussion_r443392201", "bodyText": "if an application attribute is updated, we may need to remove and add updatex attribute. To handle that shall we add a remove method as well?", "author": "isharac", "createdAt": "2020-06-22T08:21:12Z", "path": "components/apimgt/org.wso2.carbon.apimgt.api/src/main/java/org/wso2/carbon/apimgt/api/model/subscription/Application.java", "diffHunk": "@@ -101,15 +101,25 @@ public Integer getCacheKey() {\n         return getId();\n     }\n \n-    public Map<String, String> getAttributesMap() {\n+    public Map<String, String> getAttributes() {\n \n-        return attributesMap;\n+        return attributes;\n     }\n \n     public void addAttribute(String name, String value) {\n \n-        if (!this.attributesMap.containsKey(name)) {\n-            this.attributesMap.put(name, value);\n+        if (!this.attributes.containsKey(name)) {", "originalCommit": "e617bf95dde51f2fc3a7bd13e3b99f3e26bd1e95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ4MTM5NA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8798#discussion_r443481394", "bodyText": "no need to done since we remove object and add when updating", "author": "tharindu1st", "createdAt": "2020-06-22T11:03:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM5MjIwMQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM5MjQ4OQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8798#discussion_r443392489", "bodyText": "minor fomatting issues", "author": "isharac", "createdAt": "2020-06-22T08:21:44Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/SubscriptionValidationDAO.java", "diffHunk": "@@ -132,18 +132,20 @@ private void addToApplicationList(List<Application> list, ResultSet resultSet) t\n                 if (application == null) {\n                     application = new Application();\n                     application.setId(appId);\n+                    application.setUuid(resultSet.getString(\"APP_UUID\"));\n                     application.setPolicy(resultSet.getString(\"TIER\"));\n                     application.setSubName(resultSet.getString(\"SUB_NAME\"));\n                     application.setName(resultSet.getString(\"NAME\"));\n                     application.setTokenType(resultSet.getString(\"TOKEN_TYPE\"));\n                     temp.put(appId, application);\n                 }\n+                String attributeName = resultSet.getString(\"ATTRIBUTE_NAME\");\n+                String attributeValue = resultSet.getString(\"ATTRIBUTE_VALUE\");\n+                if (StringUtils.isNotEmpty(attributeName) &&StringUtils.isNotEmpty(attributeValue)){", "originalCommit": "e617bf95dde51f2fc3a7bd13e3b99f3e26bd1e95", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a628d8bbf38c33c1db8b543617af548323227c80", "chunk": "diff --git a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/SubscriptionValidationDAO.java b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/SubscriptionValidationDAO.java\nindex 7341ed1029c..bf3ed060bd1 100644\n--- a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/SubscriptionValidationDAO.java\n+++ b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/SubscriptionValidationDAO.java\n\n@@ -141,7 +141,7 @@ public class SubscriptionValidationDAO {\n                 }\n                 String attributeName = resultSet.getString(\"ATTRIBUTE_NAME\");\n                 String attributeValue = resultSet.getString(\"ATTRIBUTE_VALUE\");\n-                if (StringUtils.isNotEmpty(attributeName) &&StringUtils.isNotEmpty(attributeValue)){\n+                if (StringUtils.isNotEmpty(attributeName) && StringUtils.isNotEmpty(attributeValue)) {\n                     application.addAttribute(attributeName, attributeValue);\n                 }\n                 // todo read from the aplication_group_mapping table and make it a set\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM5NTM4OA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8798#discussion_r443395388", "bodyText": "minor formatting(line breaks)\n`", "author": "isharac", "createdAt": "2020-06-22T08:26:41Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/constants/SubscriptionValidationSQLConstants.java", "diffHunk": "@@ -22,27 +22,37 @@\n \n     public static final String GET_ALL_APPLICATIONS_SQL =\n             \" SELECT \" +\n+                    \"   APP.UUID AS APP_UUID,\" +\n                     \"   APP.APPLICATION_ID AS APP_ID,\" +\n                     \"   APP.APPLICATION_TIER AS TIER,\" +\n                     \"   APP.NAME AS NAME,\" +\n                     \"   APP.TOKEN_TYPE AS TOKEN_TYPE,\" +\n-                    \"   SUB.USER_ID AS SUB_NAME\" +\n+                    \"   SUB.USER_ID AS SUB_NAME,\" +\n+                    \"   ATTRIBUTES.NAME AS ATTRIBUTE_NAME,\" +\n+                    \"   ATTRIBUTES.VALUE AS ATTRIBUTE_VALUE\"+\n                     \" FROM \" +\n-                    \"   AM_APPLICATION AS APP,\" +\n-                    \"   AM_SUBSCRIBER AS SUB\" +\n+                    \"   AM_SUBSCRIBER AS SUB,\" +\n+                    \"   AM_APPLICATION AS APP\" +\n+                    \"   LEFT OUTER JOIN AM_APPLICATION_ATTRIBUTES AS ATTRIBUTES  ON APP.APPLICATION_ID = ATTRIBUTES\" +", "originalCommit": "e617bf95dde51f2fc3a7bd13e3b99f3e26bd1e95", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "aae3890e2acadbfd2b9976f34f74365e171476ba", "chunk": "diff --git a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/constants/SubscriptionValidationSQLConstants.java b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/constants/SubscriptionValidationSQLConstants.java\nindex 2e3eb8f5ec7..4e95618f22e 100644\n--- a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/constants/SubscriptionValidationSQLConstants.java\n+++ b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/constants/SubscriptionValidationSQLConstants.java\n\n@@ -59,6 +59,7 @@ public class SubscriptionValidationSQLConstants {\n \n     public static final String GET_APPLICATION_BY_ID_SQL =\n             \" SELECT \" +\n+                    \"   APP.UUID AS APP_UUID,\" +\n                     \"   APP.APPLICATION_ID AS APP_ID,\" +\n                     \"   APP.NAME AS NAME,\" +\n                     \"   APP.APPLICATION_TIER AS TIER,\" +\n"}}, {"oid": "aae3890e2acadbfd2b9976f34f74365e171476ba", "url": "https://github.com/wso2/carbon-apimgt/commit/aae3890e2acadbfd2b9976f34f74365e171476ba", "message": "fix JWT related issues", "committedDate": "2020-06-22T10:13:44Z", "type": "forcePushed"}, {"oid": "a628d8bbf38c33c1db8b543617af548323227c80", "url": "https://github.com/wso2/carbon-apimgt/commit/a628d8bbf38c33c1db8b543617af548323227c80", "message": "fix JWT related issues", "committedDate": "2020-06-22T11:01:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ4MzA2Ng==", "url": "https://github.com/wso2/carbon-apimgt/pull/8798#discussion_r443483066", "bodyText": "a space required.", "author": "isharac", "createdAt": "2020-06-22T11:07:26Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIConsumerImpl.java", "diffHunk": "@@ -4023,14 +4023,14 @@ public void removeApplication(Application application, String username) throws A\n                 ApplicationEvent applicationEvent = new ApplicationEvent(UUID.randomUUID().toString(),\n                         System.currentTimeMillis(), APIConstants.EventType.APPLICATION_DELETE.name(), tenantId,\n                         tenantDomain, applicationId, application.getName(), application.getTokenType(),\n-                        application.getTier(), application.getGroupId());\n+                        application.getTier(), application.getGroupId(), Collections.EMPTY_MAP);\n                 APIUtil.sendNotification(applicationEvent, APIConstants.NotifierType.APPLICATION.name());\n             }\n         } else {\n             ApplicationEvent applicationEvent = new ApplicationEvent(UUID.randomUUID().toString(),\n                     System.currentTimeMillis(), APIConstants.EventType.APPLICATION_DELETE.name(), tenantId,\n                     tenantDomain, applicationId, application.getName(), application.getTokenType(),\n-                    application.getTier(), application.getGroupId());\n+                    application.getTier(), application.getGroupId(),Collections.EMPTY_MAP);", "originalCommit": "a628d8bbf38c33c1db8b543617af548323227c80", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "86bd5fa5e925652c94ec94c879a0136d6263fd0c", "chunk": "diff --git a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIConsumerImpl.java b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIConsumerImpl.java\nindex b09bdc95560..0c9f397b43a 100644\n--- a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIConsumerImpl.java\n+++ b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIConsumerImpl.java\n\n@@ -4030,7 +4030,7 @@ public class APIConsumerImpl extends AbstractAPIManager implements APIConsumer {\n             ApplicationEvent applicationEvent = new ApplicationEvent(UUID.randomUUID().toString(),\n                     System.currentTimeMillis(), APIConstants.EventType.APPLICATION_DELETE.name(), tenantId,\n                     tenantDomain, applicationId, application.getName(), application.getTokenType(),\n-                    application.getTier(), application.getGroupId(),Collections.EMPTY_MAP);\n+                    application.getTier(), application.getGroupId(), Collections.EMPTY_MAP);\n             APIUtil.sendNotification(applicationEvent, APIConstants.NotifierType.APPLICATION.name());\n         }\n     }\n"}}, {"oid": "86bd5fa5e925652c94ec94c879a0136d6263fd0c", "url": "https://github.com/wso2/carbon-apimgt/commit/86bd5fa5e925652c94ec94c879a0136d6263fd0c", "message": "fix JWT related issues", "committedDate": "2020-06-22T11:08:10Z", "type": "forcePushed"}, {"oid": "07b6edeabd8e22bf48ddf28b7f7b68d70f4d5139", "url": "https://github.com/wso2/carbon-apimgt/commit/07b6edeabd8e22bf48ddf28b7f7b68d70f4d5139", "message": "fix JWT related issues", "committedDate": "2020-06-22T12:15:39Z", "type": "commit"}, {"oid": "07b6edeabd8e22bf48ddf28b7f7b68d70f4d5139", "url": "https://github.com/wso2/carbon-apimgt/commit/07b6edeabd8e22bf48ddf28b7f7b68d70f4d5139", "message": "fix JWT related issues", "committedDate": "2020-06-22T12:15:39Z", "type": "forcePushed"}]}