{"pr_number": 8489, "pr_title": "Add implementation of addRegistryEntry resource", "pr_createdAt": "2020-05-12T07:06:05Z", "pr_url": "https://github.com/wso2/carbon-apimgt/pull/8489", "timeline": [{"oid": "e1a039ddf7a6b9dc073e4214a59f1b7dadbf6ffd", "url": "https://github.com/wso2/carbon-apimgt/commit/e1a039ddf7a6b9dc073e4214a59f1b7dadbf6ffd", "message": "Add initial impl of add registry entry", "committedDate": "2020-05-12T02:46:22Z", "type": "commit"}, {"oid": "aa992591b9f853f141f63c937fd05ade3fa31024", "url": "https://github.com/wso2/carbon-apimgt/commit/aa992591b9f853f141f63c937fd05ade3fa31024", "message": "Fetch GET resources impl", "committedDate": "2020-05-12T02:55:22Z", "type": "commit"}, {"oid": "4fa06ad511c80776ea0b2ef7fffce3732695acf6", "url": "https://github.com/wso2/carbon-apimgt/commit/4fa06ad511c80776ea0b2ef7fffce3732695acf6", "message": "Add impl for POST RegistryEntry", "committedDate": "2020-05-12T07:19:04Z", "type": "commit"}, {"oid": "4fa06ad511c80776ea0b2ef7fffce3732695acf6", "url": "https://github.com/wso2/carbon-apimgt/commit/4fa06ad511c80776ea0b2ef7fffce3732695acf6", "message": "Add impl for POST RegistryEntry", "committedDate": "2020-05-12T07:19:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyNTI0OQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8489#discussion_r423525249", "bodyText": "is there an issue in doing a getEndpointRegistryByUUID instead of introducing a new SQL query to check the existance?", "author": "fazlan-nazeem", "createdAt": "2020-05-12T07:39:40Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/constants/SQLConstants.java", "diffHunk": "@@ -1429,10 +1428,16 @@\n                     \"FROM ENDPOINT_REG_ENTRY AS E, ENDPOINT_REG AS R \" +\n                     \"WHERE E.REG_ID=R.ID AND R.UUID=?\";\n \n+    public static final String ADD_ENDPOINT_REGISTRY_ENTRY_SQL =\n+            \"INSERT INTO ENDPOINT_REG_ENTRY (UUID, ENTRY_NAME, SERVICE_URL, DEFINITION_TYPE, DEFINITION_URL, METADATA,\" +\n+                    \"SERVICE_TYPE, ENDPOINT_DEFINITION, REG_ID) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\";\n \n     public static final String IS_ENDPOINT_REGISTRY_NAME_EXISTS = \"SELECT COUNT(UUID) AS ENDPOINT_REGISTRY_COUNT\" +\n             \" FROM ENDPOINT_REG WHERE LOWER(REG_NAME) = LOWER(?) AND TENANT_ID = ?\";\n \n+    public static final String IS_ENDPOINT_REGISTRY_ENTRY_NAME_EXISTS = \"SELECT COUNT(UUID) AS REGISTRY_ENTRY_COUNT\" +", "originalCommit": "4fa06ad511c80776ea0b2ef7fffce3732695acf6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUzODU2MA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8489#discussion_r423538560", "bodyText": "This query is to check whether the given entry name already exists.", "author": "vithu30", "createdAt": "2020-05-12T08:02:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyNTI0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU0MDg2Ng==", "url": "https://github.com/wso2/carbon-apimgt/pull/8489#discussion_r423540866", "bodyText": "getEndpointRegistryByUUID method cannot be used for this purpose I think. Here, the existence of the entry is checked using its' name not using UUID. Validating the unique constraint of (ENTRY_NAME, REG_ID).", "author": "ChamodDamitha", "createdAt": "2020-05-12T08:06:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyNTI0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU0NTE1MA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8489#discussion_r423545150", "bodyText": "got it.", "author": "fazlan-nazeem", "createdAt": "2020-05-12T08:13:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyNTI0OQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyNTgxNQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8489#discussion_r423525815", "bodyText": "why removed?", "author": "fazlan-nazeem", "createdAt": "2020-05-12T07:40:34Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/ApiMgtDAO.java", "diffHunk": "@@ -14869,8 +14870,6 @@ public EndpointRegistryEntry getEndpointRegistryEntryByUUID(String registryEntry\n                     endpointRegistryEntry.setServiceType(rs.getString(\"SERVICE_TYPE\"));\n                     endpointRegistryEntry.setServiceURL(rs.getString(\"SERVICE_URL\"));\n                     endpointRegistryEntry.setMetaData(rs.getString(\"METADATA\"));\n-                    ResourceFile resourceFile = new ResourceFile(rs.getBinaryStream(\"ENDPOINT_DEFINITION\"),\"\");", "originalCommit": "4fa06ad511c80776ea0b2ef7fffce3732695acf6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUzNjc2OA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8489#discussion_r423536768", "bodyText": "It is added only here, the SQL query does not have ENDPOINT_DEFINITION. We are not retrieving the definitionFile in the SQL query - [1]. Do we need to return the definition file with the method getRegistryEntryByUUID?\n[1] https://github.com/wso2/carbon-apimgt/blob/master/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/constants/SQLConstants.java#L1417", "author": "vithu30", "createdAt": "2020-05-12T07:58:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyNTgxNQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyODczNg==", "url": "https://github.com/wso2/carbon-apimgt/pull/8489#discussion_r423528736", "bodyText": "do we store the content type in the db? do we need it for any purpose?", "author": "fazlan-nazeem", "createdAt": "2020-05-12T07:45:43Z", "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.endpoint.registry/src/main/java/org/wso2/carbon/apimgt/rest/api/endpoint/registry/impl/RegistriesApiServiceImpl.java", "diffHunk": "@@ -126,7 +127,28 @@ public Response addRegistry(RegistryDTO body, MessageContext messageContext) {\n     @Override\n     public Response createRegistryEntry(String registryId, RegistryEntryDTO registryEntry, InputStream\n             definitionFileInputStream, Attachment definitionFileDetail, MessageContext messageContext) {\n-        return Response.ok().entity(registryEntry).build();\n+        EndpointRegistry registryProvider = new EndpointRegistryImpl();\n+        EndpointRegistryEntry createdEntry = null;\n+        try {\n+            EndpointRegistryInfo endpointRegistry = registryProvider.getEndpointRegistryByUUID(registryId);\n+            if (endpointRegistry == null) {\n+                RestApiUtil.handleResourceNotFoundError(\"Endpoint registry with the id: \" + registryId +\n+                        \" is not found\", log);\n+            }\n+            ResourceFile definitionFile = new ResourceFile(definitionFileInputStream, definitionFileDetail", "originalCommit": "4fa06ad511c80776ea0b2ef7fffce3732695acf6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU0MjgxOQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8489#discussion_r423542819", "bodyText": "No, it is not stored. Up to now, we haven't use the content-type field. Added ResourcFile instead of InputStream for definition file, in case it is needed in the future", "author": "vithu30", "createdAt": "2020-05-12T08:09:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyODczNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU0NzgxMQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8489#discussion_r423547811", "bodyText": "does this content-type mean xml, json, yaml etc?", "author": "fazlan-nazeem", "createdAt": "2020-05-12T08:17:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyODczNg=="}], "type": "inlineReview", "revised_code": null}]}