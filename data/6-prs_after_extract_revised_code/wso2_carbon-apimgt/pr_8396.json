{"pr_number": 8396, "pr_title": "Add Google Analytics config reading functionality through a local entry", "pr_createdAt": "2020-04-06T13:04:37Z", "pr_url": "https://github.com/wso2/carbon-apimgt/pull/8396", "timeline": [{"oid": "8966db6188cf10bc61872e75bf4378e9eae780e7", "url": "https://github.com/wso2/carbon-apimgt/commit/8966db6188cf10bc61872e75bf4378e9eae780e7", "message": "Remove registry handler temporarily", "committedDate": "2020-04-09T07:42:46Z", "type": "forcePushed"}, {"oid": "21e3e61ecd45caf5ba950e308dd7212f3edf41c7", "url": "https://github.com/wso2/carbon-apimgt/commit/21e3e61ecd45caf5ba950e308dd7212f3edf41c7", "message": "Add Google Analytics config reading functionality through a local entry", "committedDate": "2020-04-09T09:03:05Z", "type": "commit"}, {"oid": "90a698d8901396f30149603240b7661667ab363e", "url": "https://github.com/wso2/carbon-apimgt/commit/90a698d8901396f30149603240b7661667ab363e", "message": "Remove registry handler temporarily", "committedDate": "2020-04-09T10:00:28Z", "type": "forcePushed"}, {"oid": "d88f6d7932f925f0539ab1924a450dfd926233de", "url": "https://github.com/wso2/carbon-apimgt/commit/d88f6d7932f925f0539ab1924a450dfd926233de", "message": "Remove registry handler temporarily", "committedDate": "2020-04-09T12:49:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMxMjIzNw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8396#discussion_r406312237", "bodyText": "@ChamodDamitha  this contains backward incompatible change shall we fix this with backward compatibility", "author": "tharindu1st", "createdAt": "2020-04-09T16:04:19Z", "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/analytics/APIMgtGoogleAnalyticsTrackingHandler.java", "diffHunk": "@@ -83,40 +80,25 @@ public boolean handleRequest(MessageContext msgCtx) {\n             span = Util.startSpan(APIMgtGatewayConstants.GOOGLE_ANALYTICS_HANDLER, responseLatencySpan, tracer);\n         }\n         try {\n-            if (configKey == null) {", "originalCommit": "d88f6d7932f925f0539ab1924a450dfd926233de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM3Mjc1Mg==", "url": "https://github.com/wso2/carbon-apimgt/pull/8396#discussion_r406372752", "bodyText": "Fixed", "author": "ChamodDamitha", "createdAt": "2020-04-09T17:47:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMxMjIzNw=="}], "type": "inlineReview", "revised_code": {"commit": "3608de762efba53bdaa8986d656fd7e012a79bd1", "chunk": "diff --git a/components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/analytics/APIMgtGoogleAnalyticsTrackingHandler.java b/components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/analytics/APIMgtGoogleAnalyticsTrackingHandler.java\nindex 56805692713..5a36833710b 100644\n--- a/components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/analytics/APIMgtGoogleAnalyticsTrackingHandler.java\n+++ b/components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/analytics/APIMgtGoogleAnalyticsTrackingHandler.java\n\n@@ -80,27 +84,62 @@ public class APIMgtGoogleAnalyticsTrackingHandler extends AbstractHandler {\n             span = Util.startSpan(APIMgtGatewayConstants.GOOGLE_ANALYTICS_HANDLER, responseLatencySpan, tracer);\n         }\n         try {\n-            Entry entry = (Entry) msgCtx.getConfiguration().getLocalRegistry().get(APIConstants.GA_CONF_KEY);\n-            if (entry == null) {\n-                log.warn(\"Cannot find Google Analytics configuration using key: \" + APIConstants.GA_CONF_KEY);\n-                return true;\n+            // Read ga-config local entry\n+            if (config == null) {\n+                Entry localEntry = (Entry) msgCtx.getConfiguration().getLocalRegistry().get(APIConstants.GA_CONF_KEY);\n+                if (localEntry == null) {\n+                    log.warn(\"Cannot find Google Analytics configuration using key: \" + APIConstants.GA_CONF_KEY);\n+                } else {\n+                    Object localEntryValue = localEntry.getValue();\n+                    if (localEntryValue == null || !(localEntryValue instanceof OMElement)) {\n+                        log.warn(\"Unable to load Google Analytics configuration using key: \"\n+                                + APIConstants.GA_CONF_KEY);\n+                        return true;\n+                    }\n+                    config = getGoogleAnalyticsConfig((OMElement) localEntryValue);\n+                }\n             }\n-            Object entryValue = null;\n \n+            // Read ga-config from registry if the local entry is not found\n             if (config == null) {\n-                entryValue = entry.getValue();\n-                if (entryValue == null || !(entryValue instanceof OMElement)) {\n-                    log.warn(\"Unable to load Google Analytics configuration using key: \"\n-                            + APIConstants.GA_CONF_KEY);\n+                if (configKey == null) {\n+                    throw new SynapseException(\"Google Analytics configuration unspecified for the API\");\n+                }\n+\n+                Entry entry = msgCtx.getConfiguration().getEntryDefinition(configKey);\n+                if (entry == null) {\n+                    log.warn(\"Cannot find Google Analytics configuration using key: \" + configKey);\n                     return true;\n                 }\n-                config = getGoogleAnalyticsConfig((OMElement) entryValue);\n-            }\n+                Object entryValue = null;\n+                boolean reCreate = false;\n+\n+                if (entry.isDynamic()) {\n+                    if ((!entry.isCached()) || (entry.isExpired()) || config == null) {\n+                        entryValue = msgCtx.getEntry(this.configKey);\n+                        if (this.version != entry.getVersion()) {\n+                            reCreate = true;\n+                        }\n+                    }\n+                } else if (config == null) {\n+                    entryValue = msgCtx.getEntry(this.configKey);\n+                }\n \n-            if (config == null) {\n-                log.warn(\"Unable to create Google Analytics configuration using key: \" + APIConstants.GA_CONF_KEY);\n-                return true;\n+                if (reCreate || config == null) {\n+                    if (entryValue == null || !(entryValue instanceof OMElement)) {\n+                        log.warn(\"Unable to load Google Analytics configuration using key: \" + configKey);\n+                        return true;\n+                    }\n+                    version = entry.getVersion();\n+                    config = getGoogleAnalyticsConfig((OMElement) entryValue);\n+                }\n+\n+                if (config == null) {\n+                    log.warn(\"Unable to create Google Analytics configuration using key: \" + configKey);\n+                    return true;\n+                }\n             }\n+\n             if (!config.isEnabled()) {\n                 return true;\n             }\n"}}, {"oid": "3608de762efba53bdaa8986d656fd7e012a79bd1", "url": "https://github.com/wso2/carbon-apimgt/commit/3608de762efba53bdaa8986d656fd7e012a79bd1", "message": "Remove registry handler temporarily", "committedDate": "2020-04-09T17:35:56Z", "type": "forcePushed"}, {"oid": "192d0e5ffce5886a637c5d00a35f7f64c8e4f708", "url": "https://github.com/wso2/carbon-apimgt/commit/192d0e5ffce5886a637c5d00a35f7f64c8e4f708", "message": "Remove registry handler temporarily", "committedDate": "2020-04-09T17:45:23Z", "type": "forcePushed"}, {"oid": "34aac577440d80b4fbbb7bec043d39217bde6828", "url": "https://github.com/wso2/carbon-apimgt/commit/34aac577440d80b4fbbb7bec043d39217bde6828", "message": "Remove registry handler temporarily", "committedDate": "2020-04-09T17:50:30Z", "type": "forcePushed"}, {"oid": "383241c5b2e9e7fb0830de8bcaea8c829267d460", "url": "https://github.com/wso2/carbon-apimgt/commit/383241c5b2e9e7fb0830de8bcaea8c829267d460", "message": "Remove registry handler temporarily", "committedDate": "2020-04-10T07:40:53Z", "type": "forcePushed"}, {"oid": "b4a8b6427c2fa548ab37e13159a97fa2b16de703", "url": "https://github.com/wso2/carbon-apimgt/commit/b4a8b6427c2fa548ab37e13159a97fa2b16de703", "message": "Remove registry handler temporarily", "committedDate": "2020-04-15T05:14:57Z", "type": "commit"}, {"oid": "b4a8b6427c2fa548ab37e13159a97fa2b16de703", "url": "https://github.com/wso2/carbon-apimgt/commit/b4a8b6427c2fa548ab37e13159a97fa2b16de703", "message": "Remove registry handler temporarily", "committedDate": "2020-04-15T05:14:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODcwOTkwMw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8396#discussion_r408709903", "bodyText": "shall we rename this method to a more meaningfull one?", "author": "chamilaadhi", "createdAt": "2020-04-15T09:35:40Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java", "diffHunk": "@@ -7192,6 +7192,22 @@ public static JSONObject getTenantRESTAPIScopeRoleMappingsConfig(String tenantDo\n         return restAPIConfigJSON;\n     }\n \n+    public static String getGAConfig(String tenantDomain) throws APIManagementException {", "originalCommit": "b4a8b6427c2fa548ab37e13159a97fa2b16de703", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQwNzc4NQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8396#discussion_r409407785", "bodyText": "Changed", "author": "ChamodDamitha", "createdAt": "2020-04-16T09:18:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODcwOTkwMw=="}], "type": "inlineReview", "revised_code": {"commit": "b438fa386770bab90c990c838bdea1c0e23ab270", "chunk": "diff --git a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java\nindex a0f9742143f..61923c67cd9 100644\n--- a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java\n+++ b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java\n\n@@ -7192,12 +7198,11 @@ public final class APIUtil {\n         return restAPIConfigJSON;\n     }\n \n-    public static String getGAConfig(String tenantDomain) throws APIManagementException {\n+    public static String getGAConfigFromRegistry(String tenantDomain) throws APIManagementException {\n         try {\n             APIMRegistryServiceImpl apimRegistryService = new APIMRegistryServiceImpl();\n-            String content = apimRegistryService.getGovernanceRegistryResourceContent(tenantDomain,\n+            return apimRegistryService.getGovernanceRegistryResourceContent(tenantDomain,\n                     APIConstants.GA_CONFIGURATION_LOCATION);\n-            return content;\n \n         } catch (UserStoreException e) {\n             String msg = \"UserStoreException thrown when loading GA config from registry\";\n"}}, {"oid": "b438fa386770bab90c990c838bdea1c0e23ab270", "url": "https://github.com/wso2/carbon-apimgt/commit/b438fa386770bab90c990c838bdea1c0e23ab270", "message": "Add ga-config local entry update functionality on registry resource update", "committedDate": "2020-04-16T09:33:27Z", "type": "forcePushed"}, {"oid": "ea26265243cb3d2c6c5f3e4cfc943b3c03247770", "url": "https://github.com/wso2/carbon-apimgt/commit/ea26265243cb3d2c6c5f3e4cfc943b3c03247770", "message": "Add ga-config local entry update functionality on registry resource update", "committedDate": "2020-04-16T09:38:29Z", "type": "forcePushed"}, {"oid": "2cd51f7c59e37796351ce175ee15bb98fdfef58e", "url": "https://github.com/wso2/carbon-apimgt/commit/2cd51f7c59e37796351ce175ee15bb98fdfef58e", "message": "Add ga-config local entry update functionality on registry resource update", "committedDate": "2020-04-16T11:12:49Z", "type": "commit"}, {"oid": "2cd51f7c59e37796351ce175ee15bb98fdfef58e", "url": "https://github.com/wso2/carbon-apimgt/commit/2cd51f7c59e37796351ce175ee15bb98fdfef58e", "message": "Add ga-config local entry update functionality on registry resource update", "committedDate": "2020-04-16T11:12:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2NjQ2Ng==", "url": "https://github.com/wso2/carbon-apimgt/pull/8396#discussion_r461066466", "bodyText": "Can we use a constang for \"configKey\" as well, since its used in many places", "author": "shilmyhasan", "createdAt": "2020-07-27T17:53:35Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIProviderImpl.java", "diffHunk": "@@ -2535,7 +2535,7 @@ private APITemplateBuilder getAPITemplateBuilder(API api) throws APIManagementEx\n                     , Collections.<String, String>emptyMap());\n \n             properties = new HashMap<String, String>();\n-            properties.put(\"configKey\", \"gov:\" + APIConstants.GA_CONFIGURATION_LOCATION);\n+            properties.put(\"configKey\", APIConstants.GA_CONF_KEY);", "originalCommit": "2cd51f7c59e37796351ce175ee15bb98fdfef58e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODk0ODU2MQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8396#discussion_r478948561", "bodyText": "Fixed in #9250", "author": "ChamodDamitha", "createdAt": "2020-08-28T08:37:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2NjQ2Ng=="}], "type": "inlineReview", "revised_code": null}]}