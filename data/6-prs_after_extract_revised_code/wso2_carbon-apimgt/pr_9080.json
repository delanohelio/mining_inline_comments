{"pr_number": 9080, "pr_title": "improve caching method", "pr_createdAt": "2020-07-29T10:36:16Z", "pr_url": "https://github.com/wso2/carbon-apimgt/pull/9080", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjIwNjEwNQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/9080#discussion_r462206105", "bodyText": "we don't need this as well right? I think that will be handled in SignedJWT.parse()", "author": "chamilaadhi", "createdAt": "2020-07-29T10:41:25Z", "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/WebsocketInboundHandler.java", "diffHunk": "@@ -259,20 +263,19 @@ private boolean validateOAuthHeader(FullHttpRequest req) throws APISecurityExcep\n \n                 //Initial guess of a JWT token using the presence of a DOT.\n \n-                SignedJWT signedJWT = null;\n+                SignedJWTInfo signedJWTInfo = null;\n                 String keyManager = null;\n                 if (StringUtils.isNotEmpty(apiKey) && apiKey.contains(APIConstants.DOT)) {\n                     try {\n                         // Check if the header part is decoded\n-                        Base64.getUrlDecoder().decode(apiKey.split(\"\\\\.\")[0]);\n                         if (StringUtils.countMatches(apiKey, APIConstants.DOT) != 2) {", "originalCommit": "8c7b0f9e6f6a72d67a29d98c16baa28e95d000d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjIwNjY1MQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/9080#discussion_r462206651", "bodyText": "its already deleted", "author": "tharindu1st", "createdAt": "2020-07-29T10:42:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjIwNjEwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "49d71caf500528ae16361925fc429828d8f70093", "chunk": "diff --git a/components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/WebsocketInboundHandler.java b/components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/WebsocketInboundHandler.java\nindex a1f6fce83b2..fb2bbda6f2e 100644\n--- a/components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/WebsocketInboundHandler.java\n+++ b/components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/WebsocketInboundHandler.java\n\n@@ -275,7 +275,7 @@ public class WebsocketInboundHandler extends ChannelInboundHandlerAdapter {\n                         }\n                         signedJWTInfo = getSignedJwtInfo(apiKey);\n                         keyManager = ServiceReferenceHolder.getInstance().getJwtValidationService()\n-                                .getKeyManagerNameIfJwtValidatorExist(signedJWTInfo.getJwtClaimsSet());\n+                                .getKeyManagerNameIfJwtValidatorExist(signedJWTInfo);\n                         if (StringUtils.isNotEmpty(keyManager)){\n                             isJwtToken = true;\n                         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjIwODk0NQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/9080#discussion_r462208945", "bodyText": "This part should go into SignedJWTInfo. So SignedJWTInfo has a constructor which accepts a string constructor. Inside it the the signedJWT is created. Then while calling to SignedJWTInfo.getClaimSet method, the getClaimSet method of the signedJWT is called and resulting claims are cached at the SignedJWTInfo layer. getClaimSet is not called prematurely but only when it's needed. And the ClaimSet is saved for subsequent calls.", "author": "jaadds", "createdAt": "2020-07-29T10:47:21Z", "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/WebsocketInboundHandler.java", "diffHunk": "@@ -585,4 +588,28 @@ private void removeTokenFromQuery(Map<String, List<String>> parameters) {\n         // remove trailing '?' or '&' from the built string\n         uri = queryBuilder.substring(0, queryBuilder.length() - 1);\n     }\n+    private SignedJWTInfo getSignedJwtInfo(String accessToken) throws ParseException {\n+\n+        String signature = accessToken.split(\"\\\\.\")[2];\n+        SignedJWTInfo signedJWTInfo = new SignedJWTInfo();\n+        Cache gatewaySignedJWTParseCache = CacheProvider.getGatewaySignedJWTParseCache();\n+        if (gatewaySignedJWTParseCache != null) {\n+            Object cachedEntry = gatewaySignedJWTParseCache.get(signature);\n+            if (cachedEntry != null) {\n+                signedJWTInfo = (SignedJWTInfo) cachedEntry;\n+            } else {\n+                SignedJWT signedJWT = SignedJWT.parse(accessToken);\n+                signedJWTInfo.setSignedJWT(signedJWT);", "originalCommit": "8c7b0f9e6f6a72d67a29d98c16baa28e95d000d2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "49d71caf500528ae16361925fc429828d8f70093", "chunk": "diff --git a/components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/WebsocketInboundHandler.java b/components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/WebsocketInboundHandler.java\nindex a1f6fce83b2..fb2bbda6f2e 100644\n--- a/components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/WebsocketInboundHandler.java\n+++ b/components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/WebsocketInboundHandler.java\n\n@@ -588,10 +588,11 @@ public class WebsocketInboundHandler extends ChannelInboundHandlerAdapter {\n         // remove trailing '?' or '&' from the built string\n         uri = queryBuilder.substring(0, queryBuilder.length() - 1);\n     }\n+\n     private SignedJWTInfo getSignedJwtInfo(String accessToken) throws ParseException {\n \n         String signature = accessToken.split(\"\\\\.\")[2];\n-        SignedJWTInfo signedJWTInfo = new SignedJWTInfo();\n+        SignedJWTInfo signedJWTInfo;\n         Cache gatewaySignedJWTParseCache = CacheProvider.getGatewaySignedJWTParseCache();\n         if (gatewaySignedJWTParseCache != null) {\n             Object cachedEntry = gatewaySignedJWTParseCache.get(signature);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjIwOTMzNA==", "url": "https://github.com/wso2/carbon-apimgt/pull/9080#discussion_r462209334", "bodyText": "Repeating block. Better move this to SignedJWTInfo class as mentioned in the previous comment.", "author": "jaadds", "createdAt": "2020-07-29T10:48:13Z", "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/WebsocketInboundHandler.java", "diffHunk": "@@ -585,4 +588,28 @@ private void removeTokenFromQuery(Map<String, List<String>> parameters) {\n         // remove trailing '?' or '&' from the built string\n         uri = queryBuilder.substring(0, queryBuilder.length() - 1);\n     }\n+    private SignedJWTInfo getSignedJwtInfo(String accessToken) throws ParseException {\n+\n+        String signature = accessToken.split(\"\\\\.\")[2];\n+        SignedJWTInfo signedJWTInfo = new SignedJWTInfo();\n+        Cache gatewaySignedJWTParseCache = CacheProvider.getGatewaySignedJWTParseCache();\n+        if (gatewaySignedJWTParseCache != null) {\n+            Object cachedEntry = gatewaySignedJWTParseCache.get(signature);\n+            if (cachedEntry != null) {\n+                signedJWTInfo = (SignedJWTInfo) cachedEntry;\n+            } else {\n+                SignedJWT signedJWT = SignedJWT.parse(accessToken);\n+                signedJWTInfo.setSignedJWT(signedJWT);\n+                signedJWTInfo.setJwtClaimsSet(signedJWT.getJWTClaimsSet());\n+                signedJWTInfo.setToken(accessToken);\n+                gatewaySignedJWTParseCache.put(signature, signedJWTInfo);\n+            }\n+        } else {\n+            SignedJWT signedJWT = SignedJWT.parse(accessToken);\n+            signedJWTInfo.setSignedJWT(signedJWT);", "originalCommit": "8c7b0f9e6f6a72d67a29d98c16baa28e95d000d2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "49d71caf500528ae16361925fc429828d8f70093", "chunk": "diff --git a/components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/WebsocketInboundHandler.java b/components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/WebsocketInboundHandler.java\nindex a1f6fce83b2..fb2bbda6f2e 100644\n--- a/components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/WebsocketInboundHandler.java\n+++ b/components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/WebsocketInboundHandler.java\n\n@@ -588,10 +588,11 @@ public class WebsocketInboundHandler extends ChannelInboundHandlerAdapter {\n         // remove trailing '?' or '&' from the built string\n         uri = queryBuilder.substring(0, queryBuilder.length() - 1);\n     }\n+\n     private SignedJWTInfo getSignedJwtInfo(String accessToken) throws ParseException {\n \n         String signature = accessToken.split(\"\\\\.\")[2];\n-        SignedJWTInfo signedJWTInfo = new SignedJWTInfo();\n+        SignedJWTInfo signedJWTInfo;\n         Cache gatewaySignedJWTParseCache = CacheProvider.getGatewaySignedJWTParseCache();\n         if (gatewaySignedJWTParseCache != null) {\n             Object cachedEntry = gatewaySignedJWTParseCache.get(signature);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjIxNDcyMg==", "url": "https://github.com/wso2/carbon-apimgt/pull/9080#discussion_r462214722", "bodyText": "Change this to check for stored jwtClaimsSet and compute if absent.", "author": "jaadds", "createdAt": "2020-07-29T10:59:21Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/jwt/SignedJWTInfo.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ *  Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ *  WSO2 Inc. licenses this file to you under the Apache License,\n+ *  Version 2.0 (the \"License\"); you may not use this file except\n+ *  in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.apimgt.impl.jwt;\n+\n+import com.nimbusds.jwt.JWTClaimsSet;\n+import com.nimbusds.jwt.SignedJWT;\n+\n+import java.io.Serializable;\n+\n+/**\n+ * JWT internal Representation\n+ */\n+public class SignedJWTInfo implements Serializable {\n+\n+    private String token;\n+    private SignedJWT signedJWT;\n+    private JWTClaimsSet jwtClaimsSet;\n+\n+    public SignedJWT getSignedJWT() {\n+\n+        return signedJWT;\n+    }\n+\n+    public void setSignedJWT(SignedJWT signedJWT) {\n+\n+        this.signedJWT = signedJWT;\n+    }\n+\n+    public JWTClaimsSet getJwtClaimsSet() {", "originalCommit": "8c7b0f9e6f6a72d67a29d98c16baa28e95d000d2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "49d71caf500528ae16361925fc429828d8f70093", "chunk": "diff --git a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/jwt/SignedJWTInfo.java b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/jwt/SignedJWTInfo.java\nindex 523232f62b6..4271112a91e 100644\n--- a/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/jwt/SignedJWTInfo.java\n+++ b/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/jwt/SignedJWTInfo.java\n\n@@ -32,6 +32,17 @@ public class SignedJWTInfo implements Serializable {\n     private SignedJWT signedJWT;\n     private JWTClaimsSet jwtClaimsSet;\n \n+    public SignedJWTInfo(String token, SignedJWT signedJWT, JWTClaimsSet jwtClaimsSet) {\n+\n+        this.token = token;\n+        this.signedJWT = signedJWT;\n+        this.jwtClaimsSet = jwtClaimsSet;\n+    }\n+\n+    public SignedJWTInfo() {\n+\n+    }\n+\n     public SignedJWT getSignedJWT() {\n \n         return signedJWT;\n"}}, {"oid": "49d71caf500528ae16361925fc429828d8f70093", "url": "https://github.com/wso2/carbon-apimgt/commit/49d71caf500528ae16361925fc429828d8f70093", "message": "improve caching method", "committedDate": "2020-07-29T11:36:25Z", "type": "commit"}, {"oid": "49d71caf500528ae16361925fc429828d8f70093", "url": "https://github.com/wso2/carbon-apimgt/commit/49d71caf500528ae16361925fc429828d8f70093", "message": "improve caching method", "committedDate": "2020-07-29T11:36:25Z", "type": "forcePushed"}, {"oid": "5d45daf0610f936e8b57f77ce0e918cf8e4ee7b0", "url": "https://github.com/wso2/carbon-apimgt/commit/5d45daf0610f936e8b57f77ce0e918cf8e4ee7b0", "message": "remove invalid test cases due to caching mechanism", "committedDate": "2020-07-29T11:53:15Z", "type": "commit"}]}