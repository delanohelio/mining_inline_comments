{"pr_number": 8083, "pr_title": "Improve Backend JWT Generation", "pr_createdAt": "2020-01-17T04:55:18Z", "pr_url": "https://github.com/wso2/carbon-apimgt/pull/8083", "timeline": [{"oid": "2261b356e5c396756dd4d0a44b195eda7474e5c3", "url": "https://github.com/wso2/carbon-apimgt/commit/2261b356e5c396756dd4d0a44b195eda7474e5c3", "message": "Fix JWT Generation", "committedDate": "2020-01-17T04:57:57Z", "type": "forcePushed"}, {"oid": "01b05701f25fe1553946fa7fff0e6754c68644dc", "url": "https://github.com/wso2/carbon-apimgt/commit/01b05701f25fe1553946fa7fff0e6754c68644dc", "message": "Fix JWT Generation", "committedDate": "2020-01-17T05:00:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc3NTI5OQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8083#discussion_r367775299", "bodyText": "While this will work in most of the cases, wouldn't it cause a problem when an OSGI module unloads/re-loads? Can we trigger the action of building tracer from setTracingService method on ServiceComponent?", "author": "jaadds", "createdAt": "2020-01-17T05:31:14Z", "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/common/APIMgtLatencySynapseHandler.java", "diffHunk": "@@ -34,14 +34,18 @@\n \n     private TracingTracer tracer;\n \n-    public APIMgtLatencySynapseHandler() {\n-        tracer = ServiceReferenceHolder.getInstance().getTracingService()\n-                .buildTracer(APIMgtGatewayConstants.SERVICE_NAME);\n-    }\n-\n     @Override\n     public boolean handleRequestInFlow(MessageContext messageContext) {\n+\n         if (Util.tracingEnabled()) {\n+            if (tracer == null) {", "originalCommit": "01b05701f25fe1553946fa7fff0e6754c68644dc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cd33e4f296f076cf4550fc18b6c6e1d08ffe7acc", "chunk": "diff --git a/components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/common/APIMgtLatencySynapseHandler.java b/components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/common/APIMgtLatencySynapseHandler.java\nindex 5430d9d2d14..e767fbdca4a 100644\n--- a/components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/common/APIMgtLatencySynapseHandler.java\n+++ b/components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/common/APIMgtLatencySynapseHandler.java\n\n@@ -34,18 +34,14 @@ public class APIMgtLatencySynapseHandler extends AbstractSynapseHandler {\n \n     private TracingTracer tracer;\n \n+    public APIMgtLatencySynapseHandler() {\n+        tracer = ServiceReferenceHolder.getInstance().getTracingService()\n+                .buildTracer(APIMgtGatewayConstants.SERVICE_NAME);\n+    }\n+\n     @Override\n     public boolean handleRequestInFlow(MessageContext messageContext) {\n-\n         if (Util.tracingEnabled()) {\n-            if (tracer == null) {\n-                synchronized (this) {\n-                    if (tracer == null) {\n-                        tracer = ServiceReferenceHolder.getInstance().getTracingService()\n-                                .buildTracer(APIMgtGatewayConstants.SERVICE_NAME);\n-                    }\n-                }\n-            }\n             org.apache.axis2.context.MessageContext axis2MessageContext =\n                     ((Axis2MessageContext) messageContext).getAxis2MessageContext();\n             Map headersMap =\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc4MDk2Ng==", "url": "https://github.com/wso2/carbon-apimgt/pull/8083#discussion_r367780966", "bodyText": "If GatewayTokenCaching is enabled, do we proceed with generating the endUserToken without checking whether it is enabled or not?", "author": "jaadds", "createdAt": "2020-01-17T06:03:00Z", "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/security/jwt/JWTValidator.java", "diffHunk": "@@ -261,6 +282,33 @@ else if (RevokedJWTDataHolder.isJWTTokenSignatureExistsInRevokedMap(tokenSignatu\n                 \"Invalid JWT token. Signature verification failed.\");\n     }\n \n+    private String generateAndRetrieveJWTToken(String tokenSignature, JWTInfoDto jwtInfoDto)\n+            throws APISecurityException {\n+        String endUserToken;\n+        if (isGatewayTokenCacheEnabled) {", "originalCommit": "01b05701f25fe1553946fa7fff0e6754c68644dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzgwNjI3Mg==", "url": "https://github.com/wso2/carbon-apimgt/pull/8083#discussion_r367806272", "bodyText": "@jaadds  at the method usage we check before it.", "author": "tharindu1st", "createdAt": "2020-01-17T07:53:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc4MDk2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "1ae2150a1272dfd6a070bd281683e992a71427fb", "chunk": "diff --git a/components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/security/jwt/JWTValidator.java b/components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/security/jwt/JWTValidator.java\nindex 1e22b7a6e17..b2dd71aa5a7 100644\n--- a/components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/security/jwt/JWTValidator.java\n+++ b/components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/security/jwt/JWTValidator.java\n\n@@ -284,16 +284,25 @@ public class JWTValidator {\n \n     private String generateAndRetrieveJWTToken(String tokenSignature, JWTInfoDto jwtInfoDto)\n             throws APISecurityException {\n-        String endUserToken;\n+\n+        String endUserToken = null;\n+        boolean valid = false;\n         if (isGatewayTokenCacheEnabled) {\n             Object token = getGatewayJWTTokenCache().get(tokenSignature);\n-            if (token != null){\n+            if (token != null) {\n                 endUserToken = (String) token;\n-            }else{\n+                String[] splitToken = ((String) token).split(\"\\\\.\");\n+                JSONObject payload = new JSONObject(new String(Base64.getUrlDecoder().decode(splitToken[1])));\n+                long exp = payload.getLong(\"exp\");\n+                long timestampSkew = OAuthServerConfiguration.getInstance().getTimeStampSkewInSeconds() * 1000;\n+                valid = (exp - System.currentTimeMillis() > timestampSkew);\n+            }\n+            if (StringUtils.isEmpty(endUserToken) || !valid) {\n                 try {\n                     endUserToken = apiMgtGatewayJWTGenerator.generateToken(jwtInfoDto);\n-                    getGatewayJWTTokenCache().put(tokenSignature,endUserToken);\n+                    getGatewayJWTTokenCache().put(tokenSignature, endUserToken);\n                 } catch (APIManagementException e) {\n+                    log.error(\"Error while Generating Backend JWT\", e);\n                     throw new APISecurityException(APISecurityConstants.API_AUTH_GENERAL_ERROR,\n                             APISecurityConstants.API_AUTH_GENERAL_ERROR_MESSAGE, e);\n                 }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc4MTQyNg==", "url": "https://github.com/wso2/carbon-apimgt/pull/8083#discussion_r367781426", "bodyText": "How about giving a specific message indicating that the error occurred while generating the JWT?", "author": "jaadds", "createdAt": "2020-01-17T06:05:37Z", "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/security/jwt/JWTValidator.java", "diffHunk": "@@ -261,6 +282,33 @@ else if (RevokedJWTDataHolder.isJWTTokenSignatureExistsInRevokedMap(tokenSignatu\n                 \"Invalid JWT token. Signature verification failed.\");\n     }\n \n+    private String generateAndRetrieveJWTToken(String tokenSignature, JWTInfoDto jwtInfoDto)\n+            throws APISecurityException {\n+        String endUserToken;\n+        if (isGatewayTokenCacheEnabled) {\n+            Object token = getGatewayJWTTokenCache().get(tokenSignature);\n+            if (token != null){\n+                endUserToken = (String) token;\n+            }else{\n+                try {\n+                    endUserToken = apiMgtGatewayJWTGenerator.generateToken(jwtInfoDto);\n+                    getGatewayJWTTokenCache().put(tokenSignature,endUserToken);\n+                } catch (APIManagementException e) {\n+                    throw new APISecurityException(APISecurityConstants.API_AUTH_GENERAL_ERROR,", "originalCommit": "01b05701f25fe1553946fa7fff0e6754c68644dc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1ae2150a1272dfd6a070bd281683e992a71427fb", "chunk": "diff --git a/components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/security/jwt/JWTValidator.java b/components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/security/jwt/JWTValidator.java\nindex 1e22b7a6e17..b2dd71aa5a7 100644\n--- a/components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/security/jwt/JWTValidator.java\n+++ b/components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/security/jwt/JWTValidator.java\n\n@@ -284,16 +284,25 @@ public class JWTValidator {\n \n     private String generateAndRetrieveJWTToken(String tokenSignature, JWTInfoDto jwtInfoDto)\n             throws APISecurityException {\n-        String endUserToken;\n+\n+        String endUserToken = null;\n+        boolean valid = false;\n         if (isGatewayTokenCacheEnabled) {\n             Object token = getGatewayJWTTokenCache().get(tokenSignature);\n-            if (token != null){\n+            if (token != null) {\n                 endUserToken = (String) token;\n-            }else{\n+                String[] splitToken = ((String) token).split(\"\\\\.\");\n+                JSONObject payload = new JSONObject(new String(Base64.getUrlDecoder().decode(splitToken[1])));\n+                long exp = payload.getLong(\"exp\");\n+                long timestampSkew = OAuthServerConfiguration.getInstance().getTimeStampSkewInSeconds() * 1000;\n+                valid = (exp - System.currentTimeMillis() > timestampSkew);\n+            }\n+            if (StringUtils.isEmpty(endUserToken) || !valid) {\n                 try {\n                     endUserToken = apiMgtGatewayJWTGenerator.generateToken(jwtInfoDto);\n-                    getGatewayJWTTokenCache().put(tokenSignature,endUserToken);\n+                    getGatewayJWTTokenCache().put(tokenSignature, endUserToken);\n                 } catch (APIManagementException e) {\n+                    log.error(\"Error while Generating Backend JWT\", e);\n                     throw new APISecurityException(APISecurityConstants.API_AUTH_GENERAL_ERROR,\n                             APISecurityConstants.API_AUTH_GENERAL_ERROR_MESSAGE, e);\n                 }\n"}}, {"oid": "a5c21e50ad55453f1958adceb12b7dfcf4053da1", "url": "https://github.com/wso2/carbon-apimgt/commit/a5c21e50ad55453f1958adceb12b7dfcf4053da1", "message": "Fix JWT Generation", "committedDate": "2020-01-17T07:57:59Z", "type": "forcePushed"}, {"oid": "1ae2150a1272dfd6a070bd281683e992a71427fb", "url": "https://github.com/wso2/carbon-apimgt/commit/1ae2150a1272dfd6a070bd281683e992a71427fb", "message": "Fix JWT Generation", "committedDate": "2020-01-17T09:43:02Z", "type": "forcePushed"}, {"oid": "b070f3f1fb657f6e9ab81f8cd7bc65c1d2748642", "url": "https://github.com/wso2/carbon-apimgt/commit/b070f3f1fb657f6e9ab81f8cd7bc65c1d2748642", "message": "Fix JWT Generation", "committedDate": "2020-01-17T11:34:26Z", "type": "forcePushed"}, {"oid": "a0fff4aadb380ecebe8eb1050d2803332b3a764a", "url": "https://github.com/wso2/carbon-apimgt/commit/a0fff4aadb380ecebe8eb1050d2803332b3a764a", "message": "Fix JWT Generation", "committedDate": "2020-01-17T11:46:24Z", "type": "forcePushed"}, {"oid": "1880cb3b432892eb8edeba7fd8d33924b6e74c5a", "url": "https://github.com/wso2/carbon-apimgt/commit/1880cb3b432892eb8edeba7fd8d33924b6e74c5a", "message": "Fix JWT Generation", "committedDate": "2020-01-17T13:24:30Z", "type": "forcePushed"}, {"oid": "cd33e4f296f076cf4550fc18b6c6e1d08ffe7acc", "url": "https://github.com/wso2/carbon-apimgt/commit/cd33e4f296f076cf4550fc18b6c6e1d08ffe7acc", "message": "removing backendjwt From Enduser JWT", "committedDate": "2020-01-18T04:25:42Z", "type": "commit"}, {"oid": "cbaca9b48a05efc545d29307f5d78202d5790858", "url": "https://github.com/wso2/carbon-apimgt/commit/cbaca9b48a05efc545d29307f5d78202d5790858", "message": "Fix SynapseHandler Initialization issue on opentracing", "committedDate": "2020-01-18T04:25:42Z", "type": "commit"}, {"oid": "1c1dca1abeefb838aace715351ed74d06736513e", "url": "https://github.com/wso2/carbon-apimgt/commit/1c1dca1abeefb838aace715351ed74d06736513e", "message": "Fix https://github.com/wso2/product-apim/issues/6894 supported langauages", "committedDate": "2020-01-18T04:25:42Z", "type": "commit"}, {"oid": "a9977f91b317b51c4e7f837a399a46e1b4902dcb", "url": "https://github.com/wso2/carbon-apimgt/commit/a9977f91b317b51c4e7f837a399a46e1b4902dcb", "message": "Fix JWT Generation for JWT Tokens", "committedDate": "2020-01-18T04:25:42Z", "type": "commit"}, {"oid": "217a759f503c33e87719c6038294fcb05b6c8325", "url": "https://github.com/wso2/carbon-apimgt/commit/217a759f503c33e87719c6038294fcb05b6c8325", "message": "Fix JWT Generation", "committedDate": "2020-01-18T04:41:30Z", "type": "commit"}, {"oid": "217a759f503c33e87719c6038294fcb05b6c8325", "url": "https://github.com/wso2/carbon-apimgt/commit/217a759f503c33e87719c6038294fcb05b6c8325", "message": "Fix JWT Generation", "committedDate": "2020-01-18T04:41:30Z", "type": "forcePushed"}]}