{"pr_number": 7076, "pr_title": "Fix PostgreSQL authentication NullPointerException", "pr_createdAt": "2020-08-26T05:21:30Z", "pr_url": "https://github.com/apache/shardingsphere/pull/7076", "timeline": [{"oid": "a3fc8cb2934a359ddce694f98806144453c95765", "url": "https://github.com/apache/shardingsphere/commit/a3fc8cb2934a359ddce694f98806144453c95765", "message": "Fix PostgreSQL authentication NPE", "committedDate": "2020-08-26T05:17:41Z", "type": "commit"}, {"oid": "a755806c5ef75a237219da22207f0539d2255477", "url": "https://github.com/apache/shardingsphere/commit/a755806c5ef75a237219da22207f0539d2255477", "message": "Add PostgreSQL unit test cases", "committedDate": "2020-08-27T00:38:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgxMTMxOQ==", "url": "https://github.com/apache/shardingsphere/pull/7076#discussion_r478811319", "bodyText": "Can remove currentAuthResult?", "author": "tuohai666", "createdAt": "2020-08-28T03:32:45Z", "path": "shardingsphere-proxy/shardingsphere-proxy-frontend/shardingsphere-proxy-frontend-postgresql/src/main/java/org/apache/shardingsphere/proxy/frontend/postgresql/auth/PostgreSQLAuthenticationEngine.java", "diffHunk": "@@ -91,7 +91,8 @@ public AuthenticationResult auth(final ChannelHandlerContext context, final Pack\n             }\n             md5Salt = PostgreSQLRandomGenerator.getInstance().generateRandomBytes(4);\n             context.writeAndFlush(new PostgreSQLAuthenticationMD5PasswordPacket(md5Salt));\n-            return AuthenticationResult.continued(username, databaseName);\n+            currentAuthResult = AuthenticationResult.continued(username, databaseName);", "originalCommit": "a755806c5ef75a237219da22207f0539d2255477", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgzMjg5Mw==", "url": "https://github.com/apache/shardingsphere/pull/7076#discussion_r478832893", "bodyText": "Probably not, it's latest code after refactoring.", "author": "sandynz", "createdAt": "2020-08-28T05:07:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgxMTMxOQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgxMTU2OA==", "url": "https://github.com/apache/shardingsphere/pull/7076#discussion_r478811568", "bodyText": "Where this member be called?", "author": "tuohai666", "createdAt": "2020-08-28T03:33:45Z", "path": "shardingsphere-db-protocol/shardingsphere-db-protocol-postgresql/src/main/java/org/apache/shardingsphere/db/protocol/postgresql/packet/handshake/PostgreSQLAuthenticationMD5PasswordPacket.java", "diffHunk": "@@ -29,6 +29,7 @@\n     \n     private static final int AUTH_REQ_MD5 = 5;\n     \n+    @Getter", "originalCommit": "a755806c5ef75a237219da22207f0539d2255477", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgzMTg2MA==", "url": "https://github.com/apache/shardingsphere/pull/7076#discussion_r478831860", "bodyText": "It's called in PostgreSQLAuthenticationEngineTest, since md5Salt is generated random bytes in PostgreSQLAuthenticationEngine, test case will get this md5Salt to calculate md5Digest for login.", "author": "sandynz", "createdAt": "2020-08-28T05:03:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgxMTU2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODg0Mjc3Ng==", "url": "https://github.com/apache/shardingsphere/pull/7076#discussion_r478842776", "bodyText": "Test case will use Java reflection to get it, just like MySQLAuthenticationEngineTest.", "author": "sandynz", "createdAt": "2020-08-28T05:43:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgxMTU2OA=="}], "type": "inlineReview", "revised_code": {"commit": "83a32f5c2f5738c7181c69b544b5ff9ea8ad1f03", "chunk": "diff --git a/shardingsphere-db-protocol/shardingsphere-db-protocol-postgresql/src/main/java/org/apache/shardingsphere/db/protocol/postgresql/packet/handshake/PostgreSQLAuthenticationMD5PasswordPacket.java b/shardingsphere-db-protocol/shardingsphere-db-protocol-postgresql/src/main/java/org/apache/shardingsphere/db/protocol/postgresql/packet/handshake/PostgreSQLAuthenticationMD5PasswordPacket.java\nindex 98187cb7b6..59f0d629f0 100644\n--- a/shardingsphere-db-protocol/shardingsphere-db-protocol-postgresql/src/main/java/org/apache/shardingsphere/db/protocol/postgresql/packet/handshake/PostgreSQLAuthenticationMD5PasswordPacket.java\n+++ b/shardingsphere-db-protocol/shardingsphere-db-protocol-postgresql/src/main/java/org/apache/shardingsphere/db/protocol/postgresql/packet/handshake/PostgreSQLAuthenticationMD5PasswordPacket.java\n\n@@ -29,7 +29,6 @@ public final class PostgreSQLAuthenticationMD5PasswordPacket implements PostgreS\n     \n     private static final int AUTH_REQ_MD5 = 5;\n     \n-    @Getter\n     private final byte[] md5Salt;\n     \n     @Getter\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgxOTExOQ==", "url": "https://github.com/apache/shardingsphere/pull/7076#discussion_r478819119", "bodyText": "why remove private?", "author": "tuohai666", "createdAt": "2020-08-28T04:06:49Z", "path": "shardingsphere-proxy/shardingsphere-proxy-frontend/shardingsphere-proxy-frontend-postgresql/src/main/java/org/apache/shardingsphere/proxy/frontend/postgresql/auth/PostgreSQLAuthenticationHandler.java", "diffHunk": "@@ -66,7 +66,7 @@ public static PostgreSQLLoginResult loginWithMd5Password(final String username,\n         return new PostgreSQLLoginResult(PostgreSQLErrorCode.SUCCESSFUL_COMPLETION, null);\n     }\n     \n-    private static String md5Encode(final String username, final String password, final byte[] md5Salt) {\n+    static String md5Encode(final String username, final String password, final byte[] md5Salt) {", "originalCommit": "a755806c5ef75a237219da22207f0539d2255477", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgzMjU1Mg==", "url": "https://github.com/apache/shardingsphere/pull/7076#discussion_r478832552", "bodyText": "It's called in PostgreSQLAuthenticationEngineTest, since md5Salt is generated random bytes in PostgreSQLAuthenticationEngine, test case will invoke md5Encode to calculate md5Digest for login.", "author": "sandynz", "createdAt": "2020-08-28T05:06:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgxOTExOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODg0Mjg2Ng==", "url": "https://github.com/apache/shardingsphere/pull/7076#discussion_r478842866", "bodyText": "Test case will use Java reflection to get it, just like MySQLAuthenticationEngineTest.", "author": "sandynz", "createdAt": "2020-08-28T05:44:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgxOTExOQ=="}], "type": "inlineReview", "revised_code": {"commit": "83a32f5c2f5738c7181c69b544b5ff9ea8ad1f03", "chunk": "diff --git a/shardingsphere-proxy/shardingsphere-proxy-frontend/shardingsphere-proxy-frontend-postgresql/src/main/java/org/apache/shardingsphere/proxy/frontend/postgresql/auth/PostgreSQLAuthenticationHandler.java b/shardingsphere-proxy/shardingsphere-proxy-frontend/shardingsphere-proxy-frontend-postgresql/src/main/java/org/apache/shardingsphere/proxy/frontend/postgresql/auth/PostgreSQLAuthenticationHandler.java\nindex 4533ad7aec..942d54f35b 100644\n--- a/shardingsphere-proxy/shardingsphere-proxy-frontend/shardingsphere-proxy-frontend-postgresql/src/main/java/org/apache/shardingsphere/proxy/frontend/postgresql/auth/PostgreSQLAuthenticationHandler.java\n+++ b/shardingsphere-proxy/shardingsphere-proxy-frontend/shardingsphere-proxy-frontend-postgresql/src/main/java/org/apache/shardingsphere/proxy/frontend/postgresql/auth/PostgreSQLAuthenticationHandler.java\n\n@@ -66,7 +66,7 @@ public class PostgreSQLAuthenticationHandler {\n         return new PostgreSQLLoginResult(PostgreSQLErrorCode.SUCCESSFUL_COMPLETION, null);\n     }\n     \n-    static String md5Encode(final String username, final String password, final byte[] md5Salt) {\n+    private static String md5Encode(final String username, final String password, final byte[] md5Salt) {\n         String passwordHash = new String(Hex.encodeHex(DigestUtils.md5(password + username), true));\n         MessageDigest messageDigest = DigestUtils.getMd5Digest();\n         messageDigest.update(passwordHash.getBytes());\n"}}, {"oid": "83a32f5c2f5738c7181c69b544b5ff9ea8ad1f03", "url": "https://github.com/apache/shardingsphere/commit/83a32f5c2f5738c7181c69b544b5ff9ea8ad1f03", "message": "Add PostgreSQL unit test cases", "committedDate": "2020-08-28T05:41:03Z", "type": "commit"}, {"oid": "818a77e6a229646f765e8d7e79561641f60b3ac3", "url": "https://github.com/apache/shardingsphere/commit/818a77e6a229646f765e8d7e79561641f60b3ac3", "message": "Merge remote-tracking branch 'apache/master' into pg-auth-npe", "committedDate": "2020-08-28T06:38:32Z", "type": "commit"}, {"oid": "87de00ad1e3256bbbec60f61cba50fe5a1b8a115", "url": "https://github.com/apache/shardingsphere/commit/87de00ad1e3256bbbec60f61cba50fe5a1b8a115", "message": "Update import", "committedDate": "2020-08-28T06:42:54Z", "type": "commit"}]}