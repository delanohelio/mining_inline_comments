{"pr_number": 6187, "pr_title": "Add port to proxy instance", "pr_createdAt": "2020-06-25T17:32:54Z", "pr_url": "https://github.com/apache/shardingsphere/pull/6187", "timeline": [{"oid": "d9f70719f345bd13bda806242adc106334d84e13", "url": "https://github.com/apache/shardingsphere/commit/d9f70719f345bd13bda806242adc106334d84e13", "message": "update instance id to consume port info", "committedDate": "2020-06-25T17:28:55Z", "type": "commit"}, {"oid": "6e330e9183724da01f9ffbe222e45f0718027c4c", "url": "https://github.com/apache/shardingsphere/commit/6e330e9183724da01f9ffbe222e45f0718027c4c", "message": "pass port info to orchestration instance", "committedDate": "2020-06-25T17:30:06Z", "type": "commit"}, {"oid": "f7d44504d368d8f853b16d539e543237f9ddea0a", "url": "https://github.com/apache/shardingsphere/commit/f7d44504d368d8f853b16d539e543237f9ddea0a", "message": "updated TCs", "committedDate": "2020-06-25T17:30:40Z", "type": "commit"}, {"oid": "3881ed6810094cdda5fb0da8a8760ea2148b1177", "url": "https://github.com/apache/shardingsphere/commit/3881ed6810094cdda5fb0da8a8760ea2148b1177", "message": "fix typo", "committedDate": "2020-06-25T18:26:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3NTkxNA==", "url": "https://github.com/apache/shardingsphere/pull/6187#discussion_r446475914", "bodyText": "UUID should be kept", "author": "menghaoranss", "createdAt": "2020-06-27T02:58:09Z", "path": "shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/instance/OrchestrationInstance.java", "diffHunk": "@@ -30,21 +28,30 @@\n public final class OrchestrationInstance {\n     \n     private static final String DELIMITER = \"@\";\n-    \n-    private static final OrchestrationInstance INSTANCE = new OrchestrationInstance();\n+\n+    private static OrchestrationInstance instance;\n     \n     private final String instanceId;\n-    \n-    private OrchestrationInstance() {\n-        instanceId = IpUtils.getIp() + DELIMITER + ManagementFactory.getRuntimeMXBean().getName().split(DELIMITER)[0] + DELIMITER + UUID.randomUUID().toString();\n+\n+    public OrchestrationInstance(final int port) {\n+        instanceId = IpUtils.getIp() + DELIMITER + port;", "originalCommit": "3881ed6810094cdda5fb0da8a8760ea2148b1177", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjUxODIzNw==", "url": "https://github.com/apache/shardingsphere/pull/6187#discussion_r446518237", "bodyText": "I believe instance-ip + port combination generates a unique identifier. Not sure why uuid will still be required?", "author": "swayamraina", "createdAt": "2020-06-27T12:08:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3NTkxNA=="}], "type": "inlineReview", "revised_code": {"commit": "22697e8e4de7ef66a24bdf6764da04d06c6e8226", "chunk": "diff --git a/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/instance/OrchestrationInstance.java b/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/instance/OrchestrationInstance.java\nindex fa3cce326e..adb732af58 100644\n--- a/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/instance/OrchestrationInstance.java\n+++ b/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/instance/OrchestrationInstance.java\n\n@@ -33,21 +35,21 @@ public final class OrchestrationInstance {\n     \n     private final String instanceId;\n \n-    public OrchestrationInstance(final int port) {\n-        instanceId = IpUtils.getIp() + DELIMITER + port;\n+    public OrchestrationInstance(final int identifier) {\n+        instanceId = IpUtils.getIp() + DELIMITER + identifier + DELIMITER + UUID.randomUUID().toString();\n     }\n \n     /**\n      * Get instance.\n      *\n-     * @param   port        port on which the instance is running\n+     * @param   identifier  identifier on which the instance is running\n      * @return  instance    the orchestration instance\n      */\n-    public static OrchestrationInstance getInstance(final int port) {\n+    public static OrchestrationInstance getInstance(final int identifier) {\n         if (null == instance) {\n             synchronized (OrchestrationInstance.class) {\n                 if (null == instance) {\n-                    instance = new OrchestrationInstance(port);\n+                    instance = new OrchestrationInstance(identifier);\n                 }\n             }\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3NjUxMQ==", "url": "https://github.com/apache/shardingsphere/pull/6187#discussion_r446476511", "bodyText": "OrchestrationShardingSphereDataSource is provided for sharding-jdbc, can not specify a fixed port , sharding-jdbc should still retain threadId as the unique identifier of the instance.", "author": "menghaoranss", "createdAt": "2020-06-27T03:05:08Z", "path": "shardingsphere-jdbc/shardingsphere-jdbc-orchestration/src/main/java/org/apache/shardingsphere/driver/orchestration/internal/datasource/OrchestrationShardingSphereDataSource.java", "diffHunk": "@@ -69,7 +69,7 @@\n     private ShardingSphereDataSource dataSource;\n     \n     public OrchestrationShardingSphereDataSource(final OrchestrationConfiguration orchestrationConfig) throws SQLException {\n-        super(new ShardingOrchestrationFacade(orchestrationConfig, Collections.singletonList(DefaultSchema.LOGIC_NAME)));\n+        super(new ShardingOrchestrationFacade(orchestrationConfig, Collections.singletonList(DefaultSchema.LOGIC_NAME), 3307));", "originalCommit": "3881ed6810094cdda5fb0da8a8760ea2148b1177", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjUxODMwOA==", "url": "https://github.com/apache/shardingsphere/pull/6187#discussion_r446518308", "bodyText": "Agreed! This looks to be a mistake at my end", "author": "swayamraina", "createdAt": "2020-06-27T12:09:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3NjUxMQ=="}], "type": "inlineReview", "revised_code": {"commit": "9ccc48c028bd7746b3ae4814fcf13652e8446d87", "chunk": "diff --git a/shardingsphere-jdbc/shardingsphere-jdbc-orchestration/src/main/java/org/apache/shardingsphere/driver/orchestration/internal/datasource/OrchestrationShardingSphereDataSource.java b/shardingsphere-jdbc/shardingsphere-jdbc-orchestration/src/main/java/org/apache/shardingsphere/driver/orchestration/internal/datasource/OrchestrationShardingSphereDataSource.java\nindex 407fdd1d19..bc90bc2103 100644\n--- a/shardingsphere-jdbc/shardingsphere-jdbc-orchestration/src/main/java/org/apache/shardingsphere/driver/orchestration/internal/datasource/OrchestrationShardingSphereDataSource.java\n+++ b/shardingsphere-jdbc/shardingsphere-jdbc-orchestration/src/main/java/org/apache/shardingsphere/driver/orchestration/internal/datasource/OrchestrationShardingSphereDataSource.java\n\n@@ -65,11 +66,14 @@ import java.util.Map;\n  */\n @Getter(AccessLevel.PROTECTED)\n public class OrchestrationShardingSphereDataSource extends AbstractOrchestrationDataSource {\n+\n+    private static final String DELIMITER = \"@\";\n+    private static final int THREAD_ID = Integer.parseInt(ManagementFactory.getRuntimeMXBean().getName().split(DELIMITER)[0]);\n     \n     private ShardingSphereDataSource dataSource;\n     \n     public OrchestrationShardingSphereDataSource(final OrchestrationConfiguration orchestrationConfig) throws SQLException {\n-        super(new ShardingOrchestrationFacade(orchestrationConfig, Collections.singletonList(DefaultSchema.LOGIC_NAME), 3307));\n+        super(new ShardingOrchestrationFacade(orchestrationConfig, Collections.singletonList(DefaultSchema.LOGIC_NAME), THREAD_ID));\n         ConfigCenter configService = getShardingOrchestrationFacade().getConfigCenter();\n         Collection<RuleConfiguration> configurations = configService.loadRuleConfigurations(DefaultSchema.LOGIC_NAME);\n         Preconditions.checkState(!configurations.isEmpty(), \"Missing the sharding rule configuration on registry center\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3NjU3MQ==", "url": "https://github.com/apache/shardingsphere/pull/6187#discussion_r446476571", "bodyText": "Same as above.", "author": "menghaoranss", "createdAt": "2020-06-27T03:05:34Z", "path": "shardingsphere-jdbc/shardingsphere-jdbc-orchestration/src/main/java/org/apache/shardingsphere/driver/orchestration/internal/datasource/OrchestrationShardingSphereDataSource.java", "diffHunk": "@@ -82,7 +82,7 @@ public OrchestrationShardingSphereDataSource(final OrchestrationConfiguration or\n     }\n     \n     public OrchestrationShardingSphereDataSource(final ShardingSphereDataSource shardingSphereDataSource, final OrchestrationConfiguration orchestrationConfig) {\n-        super(new ShardingOrchestrationFacade(orchestrationConfig, Collections.singletonList(DefaultSchema.LOGIC_NAME)));\n+        super(new ShardingOrchestrationFacade(orchestrationConfig, Collections.singletonList(DefaultSchema.LOGIC_NAME), 3307));", "originalCommit": "3881ed6810094cdda5fb0da8a8760ea2148b1177", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjUxODMzMw==", "url": "https://github.com/apache/shardingsphere/pull/6187#discussion_r446518333", "bodyText": "Will fix this", "author": "swayamraina", "createdAt": "2020-06-27T12:09:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3NjU3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "9ccc48c028bd7746b3ae4814fcf13652e8446d87", "chunk": "diff --git a/shardingsphere-jdbc/shardingsphere-jdbc-orchestration/src/main/java/org/apache/shardingsphere/driver/orchestration/internal/datasource/OrchestrationShardingSphereDataSource.java b/shardingsphere-jdbc/shardingsphere-jdbc-orchestration/src/main/java/org/apache/shardingsphere/driver/orchestration/internal/datasource/OrchestrationShardingSphereDataSource.java\nindex 407fdd1d19..bc90bc2103 100644\n--- a/shardingsphere-jdbc/shardingsphere-jdbc-orchestration/src/main/java/org/apache/shardingsphere/driver/orchestration/internal/datasource/OrchestrationShardingSphereDataSource.java\n+++ b/shardingsphere-jdbc/shardingsphere-jdbc-orchestration/src/main/java/org/apache/shardingsphere/driver/orchestration/internal/datasource/OrchestrationShardingSphereDataSource.java\n\n@@ -82,7 +86,7 @@ public class OrchestrationShardingSphereDataSource extends AbstractOrchestration\n     }\n     \n     public OrchestrationShardingSphereDataSource(final ShardingSphereDataSource shardingSphereDataSource, final OrchestrationConfiguration orchestrationConfig) {\n-        super(new ShardingOrchestrationFacade(orchestrationConfig, Collections.singletonList(DefaultSchema.LOGIC_NAME), 3307));\n+        super(new ShardingOrchestrationFacade(orchestrationConfig, Collections.singletonList(DefaultSchema.LOGIC_NAME), THREAD_ID));\n         dataSource = shardingSphereDataSource;\n         initShardingOrchestrationFacade(Collections.singletonMap(DefaultSchema.LOGIC_NAME, DataSourceConverter.getDataSourceConfigurationMap(dataSource.getDataSourceMap())),\n                 getRuleConfigurationMap(), dataSource.getSchemaContexts().getProps().getProps());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3NjU4OA==", "url": "https://github.com/apache/shardingsphere/pull/6187#discussion_r446476588", "bodyText": "Same as above.", "author": "menghaoranss", "createdAt": "2020-06-27T03:05:51Z", "path": "shardingsphere-jdbc/shardingsphere-jdbc-orchestration/src/main/java/org/apache/shardingsphere/driver/orchestration/internal/datasource/OrchestrationShardingSphereDataSource.java", "diffHunk": "@@ -92,7 +92,7 @@ public OrchestrationShardingSphereDataSource(final ShardingSphereDataSource shar\n     }\n     \n     public OrchestrationShardingSphereDataSource(final OrchestrationConfiguration orchestrationConfig, final ClusterConfiguration clusterConfiguration) throws SQLException {\n-        super(new ShardingOrchestrationFacade(orchestrationConfig, Collections.singletonList(DefaultSchema.LOGIC_NAME)));\n+        super(new ShardingOrchestrationFacade(orchestrationConfig, Collections.singletonList(DefaultSchema.LOGIC_NAME), 3307));", "originalCommit": "3881ed6810094cdda5fb0da8a8760ea2148b1177", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9ccc48c028bd7746b3ae4814fcf13652e8446d87", "chunk": "diff --git a/shardingsphere-jdbc/shardingsphere-jdbc-orchestration/src/main/java/org/apache/shardingsphere/driver/orchestration/internal/datasource/OrchestrationShardingSphereDataSource.java b/shardingsphere-jdbc/shardingsphere-jdbc-orchestration/src/main/java/org/apache/shardingsphere/driver/orchestration/internal/datasource/OrchestrationShardingSphereDataSource.java\nindex 407fdd1d19..bc90bc2103 100644\n--- a/shardingsphere-jdbc/shardingsphere-jdbc-orchestration/src/main/java/org/apache/shardingsphere/driver/orchestration/internal/datasource/OrchestrationShardingSphereDataSource.java\n+++ b/shardingsphere-jdbc/shardingsphere-jdbc-orchestration/src/main/java/org/apache/shardingsphere/driver/orchestration/internal/datasource/OrchestrationShardingSphereDataSource.java\n\n@@ -92,7 +96,7 @@ public class OrchestrationShardingSphereDataSource extends AbstractOrchestration\n     }\n     \n     public OrchestrationShardingSphereDataSource(final OrchestrationConfiguration orchestrationConfig, final ClusterConfiguration clusterConfiguration) throws SQLException {\n-        super(new ShardingOrchestrationFacade(orchestrationConfig, Collections.singletonList(DefaultSchema.LOGIC_NAME), 3307));\n+        super(new ShardingOrchestrationFacade(orchestrationConfig, Collections.singletonList(DefaultSchema.LOGIC_NAME), THREAD_ID));\n         ConfigCenter configService = getShardingOrchestrationFacade().getConfigCenter();\n         Collection<RuleConfiguration> configurations = configService.loadRuleConfigurations(DefaultSchema.LOGIC_NAME);\n         Preconditions.checkState(!configurations.isEmpty(), \"Missing the sharding rule configuration on registry center\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3NjU5Ng==", "url": "https://github.com/apache/shardingsphere/pull/6187#discussion_r446476596", "bodyText": "Same as above.", "author": "menghaoranss", "createdAt": "2020-06-27T03:06:04Z", "path": "shardingsphere-jdbc/shardingsphere-jdbc-orchestration/src/main/java/org/apache/shardingsphere/driver/orchestration/internal/datasource/OrchestrationShardingSphereDataSource.java", "diffHunk": "@@ -106,7 +106,7 @@ public OrchestrationShardingSphereDataSource(final OrchestrationConfiguration or\n     \n     public OrchestrationShardingSphereDataSource(final ShardingSphereDataSource shardingSphereDataSource,\n                                                  final OrchestrationConfiguration orchestrationConfig, final ClusterConfiguration clusterConfiguration) {\n-        super(new ShardingOrchestrationFacade(orchestrationConfig, Collections.singletonList(DefaultSchema.LOGIC_NAME)));\n+        super(new ShardingOrchestrationFacade(orchestrationConfig, Collections.singletonList(DefaultSchema.LOGIC_NAME), 3307));", "originalCommit": "3881ed6810094cdda5fb0da8a8760ea2148b1177", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9ccc48c028bd7746b3ae4814fcf13652e8446d87", "chunk": "diff --git a/shardingsphere-jdbc/shardingsphere-jdbc-orchestration/src/main/java/org/apache/shardingsphere/driver/orchestration/internal/datasource/OrchestrationShardingSphereDataSource.java b/shardingsphere-jdbc/shardingsphere-jdbc-orchestration/src/main/java/org/apache/shardingsphere/driver/orchestration/internal/datasource/OrchestrationShardingSphereDataSource.java\nindex 407fdd1d19..bc90bc2103 100644\n--- a/shardingsphere-jdbc/shardingsphere-jdbc-orchestration/src/main/java/org/apache/shardingsphere/driver/orchestration/internal/datasource/OrchestrationShardingSphereDataSource.java\n+++ b/shardingsphere-jdbc/shardingsphere-jdbc-orchestration/src/main/java/org/apache/shardingsphere/driver/orchestration/internal/datasource/OrchestrationShardingSphereDataSource.java\n\n@@ -106,7 +110,7 @@ public class OrchestrationShardingSphereDataSource extends AbstractOrchestration\n     \n     public OrchestrationShardingSphereDataSource(final ShardingSphereDataSource shardingSphereDataSource,\n                                                  final OrchestrationConfiguration orchestrationConfig, final ClusterConfiguration clusterConfiguration) {\n-        super(new ShardingOrchestrationFacade(orchestrationConfig, Collections.singletonList(DefaultSchema.LOGIC_NAME), 3307));\n+        super(new ShardingOrchestrationFacade(orchestrationConfig, Collections.singletonList(DefaultSchema.LOGIC_NAME), THREAD_ID));\n         dataSource = shardingSphereDataSource;\n         initShardingOrchestrationFacade(Collections.singletonMap(DefaultSchema.LOGIC_NAME, DataSourceConverter.getDataSourceConfigurationMap(dataSource.getDataSourceMap())),\n                 getRuleConfigurationMap(), dataSource.getSchemaContexts().getProps().getProps(), clusterConfiguration);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3Njk5Mg==", "url": "https://github.com/apache/shardingsphere/pull/6187#discussion_r446476992", "bodyText": "ShardingOrchestrationFacade is provided to both proxy and sharding-jdbc, may be the variable defined as port is not suitable, It should describe a unique identifier of the orchestration instance, for proxy, it's a port, and for sharding-jdbc, it's a threadId.", "author": "menghaoranss", "createdAt": "2020-06-27T03:10:52Z", "path": "shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-facade/src/main/java/org/apache/shardingsphere/orchestration/core/facade/ShardingOrchestrationFacade.java", "diffHunk": "@@ -81,7 +81,7 @@\n     \n     private final ShardingOrchestrationListenerManager listenerManager;\n     \n-    public ShardingOrchestrationFacade(final OrchestrationConfiguration orchestrationConfig, final Collection<String> shardingSchemaNames) {\n+    public ShardingOrchestrationFacade(final OrchestrationConfiguration orchestrationConfig, final Collection<String> shardingSchemaNames, final int port) {", "originalCommit": "3881ed6810094cdda5fb0da8a8760ea2148b1177", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjUxODUyNw==", "url": "https://github.com/apache/shardingsphere/pull/6187#discussion_r446518527", "bodyText": "Thanks for pointing this out, will update this", "author": "swayamraina", "createdAt": "2020-06-27T12:12:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3Njk5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "8ea50396322bb430604ace28bac419fed3a9b213", "chunk": "diff --git a/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-facade/src/main/java/org/apache/shardingsphere/orchestration/core/facade/ShardingOrchestrationFacade.java b/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-facade/src/main/java/org/apache/shardingsphere/orchestration/core/facade/ShardingOrchestrationFacade.java\nindex 0cd018a15e..40f454b0bc 100644\n--- a/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-facade/src/main/java/org/apache/shardingsphere/orchestration/core/facade/ShardingOrchestrationFacade.java\n+++ b/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-facade/src/main/java/org/apache/shardingsphere/orchestration/core/facade/ShardingOrchestrationFacade.java\n\n@@ -81,7 +81,7 @@ public final class ShardingOrchestrationFacade implements AutoCloseable {\n     \n     private final ShardingOrchestrationListenerManager listenerManager;\n     \n-    public ShardingOrchestrationFacade(final OrchestrationConfiguration orchestrationConfig, final Collection<String> shardingSchemaNames, final int port) {\n+    public ShardingOrchestrationFacade(final OrchestrationConfiguration orchestrationConfig, final Collection<String> shardingSchemaNames, final int identifier) {\n         Optional<String> configCenterName = getInstanceNameByOrchestrationType(orchestrationConfig.getInstanceConfigurationMap(), CenterType.CONFIG_CENTER.getValue());\n         Preconditions.checkArgument(configCenterName.isPresent(), \"Can not find instance configuration with config center orchestration type.\");\n         CenterConfiguration configCenterConfiguration = orchestrationConfig.getInstanceConfigurationMap().get(configCenterName.get());\n"}}, {"oid": "22697e8e4de7ef66a24bdf6764da04d06c6e8226", "url": "https://github.com/apache/shardingsphere/commit/22697e8e4de7ef66a24bdf6764da04d06c6e8226", "message": "add uuid", "committedDate": "2020-06-30T17:03:28Z", "type": "commit"}, {"oid": "8ea50396322bb430604ace28bac419fed3a9b213", "url": "https://github.com/apache/shardingsphere/commit/8ea50396322bb430604ace28bac419fed3a9b213", "message": "use id instead of port", "committedDate": "2020-06-30T17:04:44Z", "type": "commit"}, {"oid": "9ccc48c028bd7746b3ae4814fcf13652e8446d87", "url": "https://github.com/apache/shardingsphere/commit/9ccc48c028bd7746b3ae4814fcf13652e8446d87", "message": "pass thread-id for data-source", "committedDate": "2020-06-30T17:05:34Z", "type": "commit"}, {"oid": "d3160b6814766d0e8a8da2d0ee91d941ef1e7c87", "url": "https://github.com/apache/shardingsphere/commit/d3160b6814766d0e8a8da2d0ee91d941ef1e7c87", "message": "fixed styling", "committedDate": "2020-06-30T19:00:12Z", "type": "commit"}, {"oid": "9adf6aeeeba7afff2f140a175365cc05c5ebcd56", "url": "https://github.com/apache/shardingsphere/commit/9adf6aeeeba7afff2f140a175365cc05c5ebcd56", "message": "resolve conflict", "committedDate": "2020-07-01T03:45:12Z", "type": "commit"}, {"oid": "0dd78e8268602421856810deda836f03f5089393", "url": "https://github.com/apache/shardingsphere/commit/0dd78e8268602421856810deda836f03f5089393", "message": "resolve conflict", "committedDate": "2020-07-01T03:51:41Z", "type": "commit"}, {"oid": "9bd381bfbdab4c4e39b1fde948df23444e6c605d", "url": "https://github.com/apache/shardingsphere/commit/9bd381bfbdab4c4e39b1fde948df23444e6c605d", "message": "resolve conflict", "committedDate": "2020-07-01T03:59:30Z", "type": "commit"}, {"oid": "4b6649f0e6ef7005464155b2766f0ff7bbe53d1c", "url": "https://github.com/apache/shardingsphere/commit/4b6649f0e6ef7005464155b2766f0ff7bbe53d1c", "message": "resolve conflict", "committedDate": "2020-07-01T04:00:56Z", "type": "commit"}, {"oid": "061d91ea3a30eb11b82db7da7a7972883d2ef239", "url": "https://github.com/apache/shardingsphere/commit/061d91ea3a30eb11b82db7da7a7972883d2ef239", "message": "Merge branch 'master' into add-port-to-proxy-instance", "committedDate": "2020-07-01T15:07:05Z", "type": "commit"}, {"oid": "df10436ed059b3b3c7ad84b5e5081a52f3737a17", "url": "https://github.com/apache/shardingsphere/commit/df10436ed059b3b3c7ad84b5e5081a52f3737a17", "message": "remove unused import", "committedDate": "2020-07-01T15:21:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc3Nzc1Mw==", "url": "https://github.com/apache/shardingsphere/pull/6187#discussion_r448777753", "bodyText": "The parameter identifier cannot correctly describe the meaning of orchestration instance unique identification,  my suggestion is instanceId, and i think it's better to define it as String type.", "author": "menghaoranss", "createdAt": "2020-07-02T06:34:30Z", "path": "shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-facade/src/main/java/org/apache/shardingsphere/orchestration/core/facade/ShardingOrchestrationFacade.java", "diffHunk": "@@ -81,7 +81,7 @@\n     \n     private final ShardingOrchestrationListenerManager listenerManager;\n     \n-    public ShardingOrchestrationFacade(final OrchestrationConfiguration orchestrationConfig, final Collection<String> shardingSchemaNames) {\n+    public ShardingOrchestrationFacade(final OrchestrationConfiguration orchestrationConfig, final Collection<String> shardingSchemaNames, final int identifier) {", "originalCommit": "df10436ed059b3b3c7ad84b5e5081a52f3737a17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAwMTgzMQ==", "url": "https://github.com/apache/shardingsphere/pull/6187#discussion_r449001831", "bodyText": "keeping this as instanceId also does not seem to be justified since this is only a part of the actual instanceId.\nShould we keep this as instanceSubId?", "author": "swayamraina", "createdAt": "2020-07-02T13:29:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc3Nzc1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ0MzEzNA==", "url": "https://github.com/apache/shardingsphere/pull/6187#discussion_r449443134", "bodyText": "keeping this as instanceId also does not seem to be justified since this is only a part of the actual instanceId.\nShould we keep this as instanceSubId?\n\nHow about instanceSign or instanceTag, my understanding, this parameter is just a sign or tag of instanceId.", "author": "menghaoranss", "createdAt": "2020-07-03T08:13:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc3Nzc1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ2MjIwMw==", "url": "https://github.com/apache/shardingsphere/pull/6187#discussion_r449462203", "bodyText": "instanceTag sounds good!", "author": "swayamraina", "createdAt": "2020-07-03T08:51:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc3Nzc1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU0MDAyNA==", "url": "https://github.com/apache/shardingsphere/pull/6187#discussion_r449540024", "bodyText": "Looking forward to your submission for optimization.", "author": "menghaoranss", "createdAt": "2020-07-03T11:43:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc3Nzc1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "fb785568953f75c72af1e4203bbe32d6ed0f5a2c", "chunk": "diff --git a/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-facade/src/main/java/org/apache/shardingsphere/orchestration/core/facade/ShardingOrchestrationFacade.java b/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-facade/src/main/java/org/apache/shardingsphere/orchestration/core/facade/ShardingOrchestrationFacade.java\nindex 40f454b0bc..87551b4e26 100644\n--- a/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-facade/src/main/java/org/apache/shardingsphere/orchestration/core/facade/ShardingOrchestrationFacade.java\n+++ b/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-facade/src/main/java/org/apache/shardingsphere/orchestration/core/facade/ShardingOrchestrationFacade.java\n\n@@ -81,7 +81,7 @@ public final class ShardingOrchestrationFacade implements AutoCloseable {\n     \n     private final ShardingOrchestrationListenerManager listenerManager;\n     \n-    public ShardingOrchestrationFacade(final OrchestrationConfiguration orchestrationConfig, final Collection<String> shardingSchemaNames, final int identifier) {\n+    public ShardingOrchestrationFacade(final OrchestrationConfiguration orchestrationConfig, final Collection<String> shardingSchemaNames, final String instanceTag) {\n         Optional<String> configCenterName = getInstanceNameByOrchestrationType(orchestrationConfig.getInstanceConfigurationMap(), CenterType.CONFIG_CENTER.getValue());\n         Preconditions.checkArgument(configCenterName.isPresent(), \"Can not find instance configuration with config center orchestration type.\");\n         CenterConfiguration configCenterConfiguration = orchestrationConfig.getInstanceConfigurationMap().get(configCenterName.get());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc3ODE5Mw==", "url": "https://github.com/apache/shardingsphere/pull/6187#discussion_r448778193", "bodyText": "Same as above.", "author": "menghaoranss", "createdAt": "2020-07-02T06:35:33Z", "path": "shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/RegistryCenter.java", "diffHunk": "@@ -34,11 +34,11 @@\n     private final RegistryCenterRepository repository;\n     \n     private final OrchestrationInstance instance;\n-    \n-    public RegistryCenter(final String name, final RegistryCenterRepository registryCenterRepository) {\n+\n+    public RegistryCenter(final String name, final int port, final RegistryCenterRepository registryCenterRepository) {", "originalCommit": "df10436ed059b3b3c7ad84b5e5081a52f3737a17", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fb785568953f75c72af1e4203bbe32d6ed0f5a2c", "chunk": "diff --git a/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/RegistryCenter.java b/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/RegistryCenter.java\nindex 9bf5cd0c0d..e722f28ac6 100644\n--- a/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/RegistryCenter.java\n+++ b/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/RegistryCenter.java\n\n@@ -35,10 +35,10 @@ public final class RegistryCenter {\n     \n     private final OrchestrationInstance instance;\n \n-    public RegistryCenter(final String name, final int port, final RegistryCenterRepository registryCenterRepository) {\n+    public RegistryCenter(final String name, final String instanceTag, final RegistryCenterRepository registryCenterRepository) {\n         this.node = new RegistryCenterNode(name);\n         this.repository = registryCenterRepository;\n-        this.instance = OrchestrationInstance.getInstance(port);\n+        this.instance = OrchestrationInstance.init(instanceTag);\n     }\n     \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc4Mjg1Mg==", "url": "https://github.com/apache/shardingsphere/pull/6187#discussion_r448782852", "bodyText": "This method is unnecessary.", "author": "menghaoranss", "createdAt": "2020-07-02T06:46:51Z", "path": "shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/instance/OrchestrationInstance.java", "diffHunk": "@@ -29,21 +28,30 @@\n public final class OrchestrationInstance {\n     \n     private static final String DELIMITER = \"@\";\n-    \n-    private static final OrchestrationInstance INSTANCE = new OrchestrationInstance();\n+\n+    private static OrchestrationInstance instance;\n     \n     private final String instanceId;\n-    \n-    private OrchestrationInstance() {\n-        instanceId = IpUtils.getIp() + DELIMITER + ManagementFactory.getRuntimeMXBean().getName().split(DELIMITER)[0] + DELIMITER + UUID.randomUUID().toString();\n+\n+    public OrchestrationInstance(final int identifier) {\n+        instanceId = IpUtils.getIp() + DELIMITER + identifier + DELIMITER + UUID.randomUUID().toString();\n     }\n-    \n+\n     /**\n      * Get instance.\n-     * \n-     * @return instance\n+     *\n+     * @param   identifier  identifier on which the instance is running\n+     * @return  instance    the orchestration instance\n      */\n-    public static OrchestrationInstance getInstance() {\n-        return INSTANCE;\n+    public static OrchestrationInstance getInstance(final int identifier) {", "originalCommit": "df10436ed059b3b3c7ad84b5e5081a52f3737a17", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ee866694f1d3a7acf8393f99d0503aa0331c84cb", "chunk": "diff --git a/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/instance/OrchestrationInstance.java b/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/instance/OrchestrationInstance.java\nindex cc330ab176..40747d5f95 100644\n--- a/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/instance/OrchestrationInstance.java\n+++ b/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/instance/OrchestrationInstance.java\n\n@@ -17,14 +17,12 @@\n \n package org.apache.shardingsphere.orchestration.core.registrycenter.instance;\n \n-import lombok.Getter;\n import java.util.UUID;\n import org.apache.shardingsphere.orchestration.core.common.utils.IpUtils;\n \n /**\n  * Orchestration instance.\n  */\n-@Getter\n public final class OrchestrationInstance {\n     \n     private static final String DELIMITER = \"@\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc4MzQ2OA==", "url": "https://github.com/apache/shardingsphere/pull/6187#discussion_r448783468", "bodyText": "How about add instance = this;", "author": "menghaoranss", "createdAt": "2020-07-02T06:48:10Z", "path": "shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/instance/OrchestrationInstance.java", "diffHunk": "@@ -29,21 +28,30 @@\n public final class OrchestrationInstance {\n     \n     private static final String DELIMITER = \"@\";\n-    \n-    private static final OrchestrationInstance INSTANCE = new OrchestrationInstance();\n+\n+    private static OrchestrationInstance instance;\n     \n     private final String instanceId;\n-    \n-    private OrchestrationInstance() {\n-        instanceId = IpUtils.getIp() + DELIMITER + ManagementFactory.getRuntimeMXBean().getName().split(DELIMITER)[0] + DELIMITER + UUID.randomUUID().toString();\n+\n+    public OrchestrationInstance(final int identifier) {\n+        instanceId = IpUtils.getIp() + DELIMITER + identifier + DELIMITER + UUID.randomUUID().toString();", "originalCommit": "df10436ed059b3b3c7ad84b5e5081a52f3737a17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA2ODA3Nw==", "url": "https://github.com/apache/shardingsphere/pull/6187#discussion_r449068077", "bodyText": "what we really want is a singleton instance with the property accessible everywhere.\nprobably we should keep the constructor as it is and provide a getInstance() method throwing IllegalStateException if instance object is not created\nI do not think making an assignment like instance = this is a good idea.\n@menghaoranss thoughts?", "author": "swayamraina", "createdAt": "2020-07-02T15:04:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc4MzQ2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ0NTg5MA==", "url": "https://github.com/apache/shardingsphere/pull/6187#discussion_r449445890", "bodyText": "what we really want is a singleton instance with the property accessible everywhere.\nprobably we should keep the constructor as it is and provide a getInstance() method throwing IllegalStateException if instance object is not created\nI do not think making an assignment like instance = this is a good idea.\n@menghaoranss thoughts?\n\nAgree with you, may be we can keep the no arguments constructor , and then add a new method to generate instanceId. Generate instanceId when OrchestrationInstance is initialized in RegistryCenter.", "author": "menghaoranss", "createdAt": "2020-07-03T08:18:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc4MzQ2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY3NzY2MA==", "url": "https://github.com/apache/shardingsphere/pull/6187#discussion_r449677660", "bodyText": "@menghaoranss\ni am thinking of keeping the impl like this,\npublic static OrchestrationInstance init(final String instanceTag) {\n        if (null == instance) {\n            synchronized (OrchestrationInstance.class) {\n                if (null == instance) {\n                    instance = new OrchestrationInstance(instanceTag);\n                }\n            }\n        }\n        return instance;\n    }\n\n    public static String getInstanceId() {\n        if (null == instance) {\n            throw new IllegalStateException(\"OrchestrationInstance not initialized!\");\n        }\n        return instance.instanceId;\n    }\n\nbut because of this code InstanceStateChangedListenerTest.setUp() throws the IllegalStateException.\nWill need to refactor the test-case as well.\nShould this be ok? I believe in reality there will be no case when getInstanceId() will be called before setting up of RegistryCenter and its just how TC are written.", "author": "swayamraina", "createdAt": "2020-07-03T18:26:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc4MzQ2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc3MzMyNQ==", "url": "https://github.com/apache/shardingsphere/pull/6187#discussion_r450773325", "bodyText": "I can understand the meaning of your code above, but I think it is too complicated, below is my suggestion:\n@Getter\npublic final class OrchestrationInstance {\n    \n    private static final String DELIMITER = \"@\";\n    \n    private static final OrchestrationInstance INSTANCE = new OrchestrationInstance();\n    \n    private String instanceId;\n    \n    private OrchestrationInstance() {\n    \n    }\n    \n    public void init(final String instanceTag) {\n        instanceId = IpUtils.getIp() + DELIMITER + instanceTag + DELIMITER + UUID.randomUUID().toString();\n    }\n    \n    /**\n     * Get instance.\n     * \n     * @return instance\n     */\n    public static OrchestrationInstance getInstance() {\n        return INSTANCE;\n    }\n}", "author": "menghaoranss", "createdAt": "2020-07-07T10:44:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc4MzQ2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc4Njc3Nw==", "url": "https://github.com/apache/shardingsphere/pull/6187#discussion_r450786777", "bodyText": "@menghaoranss  If we go ahead with this approach, we will risk someone calling getInstance() without ensuring init() was called and then returning an empty string as instanceId.\nMoreover, this makes instanceId mutable i.e. anyone can do OrchestrationInstance.getInstance().init(\"a\") and then OrchestrationInstance.getInstance().init(\"b\")", "author": "swayamraina", "createdAt": "2020-07-07T11:11:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc4MzQ2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM3NzkxMg==", "url": "https://github.com/apache/shardingsphere/pull/6187#discussion_r451377912", "bodyText": "@menghaoranss If we go ahead with this approach, we will risk someone calling getInstance() without ensuring init() was called and then returning an empty string as instanceId.\nMoreover, this makes instanceId mutable i.e. anyone can do OrchestrationInstance.getInstance().init(\"a\") and then OrchestrationInstance.getInstance().init(\"b\")\n\nYes, we must guarantee that OrchestrationInstance only initialize once in the code\uff0cthis is what we need to do.", "author": "menghaoranss", "createdAt": "2020-07-08T08:37:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc4MzQ2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM4MjYyNg==", "url": "https://github.com/apache/shardingsphere/pull/6187#discussion_r451382626", "bodyText": "@menghaoranss If we go ahead with this approach, we will risk someone calling getInstance() without ensuring init() was called and then returning an empty string as instanceId.\nMoreover, this makes instanceId mutable i.e. anyone can do OrchestrationInstance.getInstance().init(\"a\") and then OrchestrationInstance.getInstance().init(\"b\")\n\nCould you perfect this pr?", "author": "menghaoranss", "createdAt": "2020-07-08T08:45:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc4MzQ2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQzMjgzNw==", "url": "https://github.com/apache/shardingsphere/pull/6187#discussion_r451432837", "bodyText": "I have committed new changes, can you please review that.", "author": "swayamraina", "createdAt": "2020-07-08T10:10:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc4MzQ2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTkxNjA2Nw==", "url": "https://github.com/apache/shardingsphere/pull/6187#discussion_r451916067", "bodyText": "I have reviewed your last submission, and the points that we discussed above still need to be optimized.", "author": "menghaoranss", "createdAt": "2020-07-09T01:42:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc4MzQ2OA=="}], "type": "inlineReview", "revised_code": {"commit": "ee866694f1d3a7acf8393f99d0503aa0331c84cb", "chunk": "diff --git a/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/instance/OrchestrationInstance.java b/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/instance/OrchestrationInstance.java\nindex cc330ab176..40747d5f95 100644\n--- a/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/instance/OrchestrationInstance.java\n+++ b/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/instance/OrchestrationInstance.java\n\n@@ -17,14 +17,12 @@\n \n package org.apache.shardingsphere.orchestration.core.registrycenter.instance;\n \n-import lombok.Getter;\n import java.util.UUID;\n import org.apache.shardingsphere.orchestration.core.common.utils.IpUtils;\n \n /**\n  * Orchestration instance.\n  */\n-@Getter\n public final class OrchestrationInstance {\n     \n     private static final String DELIMITER = \"@\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc4MzczNA==", "url": "https://github.com/apache/shardingsphere/pull/6187#discussion_r448783734", "bodyText": "this.instance = new OrchestrationInstance(port);", "author": "menghaoranss", "createdAt": "2020-07-02T06:48:51Z", "path": "shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/RegistryCenter.java", "diffHunk": "@@ -34,11 +34,11 @@\n     private final RegistryCenterRepository repository;\n     \n     private final OrchestrationInstance instance;\n-    \n-    public RegistryCenter(final String name, final RegistryCenterRepository registryCenterRepository) {\n+\n+    public RegistryCenter(final String name, final int port, final RegistryCenterRepository registryCenterRepository) {\n         this.node = new RegistryCenterNode(name);\n         this.repository = registryCenterRepository;\n-        this.instance = OrchestrationInstance.getInstance();\n+        this.instance = OrchestrationInstance.getInstance(port);", "originalCommit": "df10436ed059b3b3c7ad84b5e5081a52f3737a17", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fb785568953f75c72af1e4203bbe32d6ed0f5a2c", "chunk": "diff --git a/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/RegistryCenter.java b/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/RegistryCenter.java\nindex 9bf5cd0c0d..e722f28ac6 100644\n--- a/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/RegistryCenter.java\n+++ b/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/RegistryCenter.java\n\n@@ -35,10 +35,10 @@ public final class RegistryCenter {\n     \n     private final OrchestrationInstance instance;\n \n-    public RegistryCenter(final String name, final int port, final RegistryCenterRepository registryCenterRepository) {\n+    public RegistryCenter(final String name, final String instanceTag, final RegistryCenterRepository registryCenterRepository) {\n         this.node = new RegistryCenterNode(name);\n         this.repository = registryCenterRepository;\n-        this.instance = OrchestrationInstance.getInstance(port);\n+        this.instance = OrchestrationInstance.init(instanceTag);\n     }\n     \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc4NTQ3MQ==", "url": "https://github.com/apache/shardingsphere/pull/6187#discussion_r448785471", "bodyText": "The port is unnecessary.", "author": "menghaoranss", "createdAt": "2020-07-02T06:52:46Z", "path": "shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/listener/InstanceStateChangedListener.java", "diffHunk": "@@ -35,8 +35,8 @@\n  */\n public final class InstanceStateChangedListener extends PostShardingCenterRepositoryEventListener {\n     \n-    public InstanceStateChangedListener(final String name, final RegistryCenterRepository registryCenterRepository) {\n-        super(registryCenterRepository, Collections.singleton(new RegistryCenterNode(name).getInstancesNodeFullPath(OrchestrationInstance.getInstance().getInstanceId())));\n+    public InstanceStateChangedListener(final String name, final int port, final RegistryCenterRepository registryCenterRepository) {", "originalCommit": "df10436ed059b3b3c7ad84b5e5081a52f3737a17", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fb785568953f75c72af1e4203bbe32d6ed0f5a2c", "chunk": "diff --git a/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/listener/InstanceStateChangedListener.java b/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/listener/InstanceStateChangedListener.java\nindex 1cbfc99f09..68f051201b 100644\n--- a/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/listener/InstanceStateChangedListener.java\n+++ b/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/listener/InstanceStateChangedListener.java\n\n@@ -35,8 +35,8 @@ import java.util.Collections;\n  */\n public final class InstanceStateChangedListener extends PostShardingCenterRepositoryEventListener {\n     \n-    public InstanceStateChangedListener(final String name, final int port, final RegistryCenterRepository registryCenterRepository) {\n-        super(registryCenterRepository, Collections.singleton(new RegistryCenterNode(name).getInstancesNodeFullPath(OrchestrationInstance.getInstance(port).getInstanceId())));\n+    public InstanceStateChangedListener(final String name, final RegistryCenterRepository registryCenterRepository) {\n+        super(registryCenterRepository, Collections.singleton(new RegistryCenterNode(name).getInstancesNodeFullPath(OrchestrationInstance.getInstanceId())));\n     }\n     \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc4NTg0Ng==", "url": "https://github.com/apache/shardingsphere/pull/6187#discussion_r448785846", "bodyText": "OrchestrationInstance.getInstance().getInstanceId()", "author": "menghaoranss", "createdAt": "2020-07-02T06:53:39Z", "path": "shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/listener/InstanceStateChangedListener.java", "diffHunk": "@@ -35,8 +35,8 @@\n  */\n public final class InstanceStateChangedListener extends PostShardingCenterRepositoryEventListener {\n     \n-    public InstanceStateChangedListener(final String name, final RegistryCenterRepository registryCenterRepository) {\n-        super(registryCenterRepository, Collections.singleton(new RegistryCenterNode(name).getInstancesNodeFullPath(OrchestrationInstance.getInstance().getInstanceId())));\n+    public InstanceStateChangedListener(final String name, final int port, final RegistryCenterRepository registryCenterRepository) {\n+        super(registryCenterRepository, Collections.singleton(new RegistryCenterNode(name).getInstancesNodeFullPath(OrchestrationInstance.getInstance(port).getInstanceId())));", "originalCommit": "df10436ed059b3b3c7ad84b5e5081a52f3737a17", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fb785568953f75c72af1e4203bbe32d6ed0f5a2c", "chunk": "diff --git a/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/listener/InstanceStateChangedListener.java b/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/listener/InstanceStateChangedListener.java\nindex 1cbfc99f09..68f051201b 100644\n--- a/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/listener/InstanceStateChangedListener.java\n+++ b/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/listener/InstanceStateChangedListener.java\n\n@@ -35,8 +35,8 @@ import java.util.Collections;\n  */\n public final class InstanceStateChangedListener extends PostShardingCenterRepositoryEventListener {\n     \n-    public InstanceStateChangedListener(final String name, final int port, final RegistryCenterRepository registryCenterRepository) {\n-        super(registryCenterRepository, Collections.singleton(new RegistryCenterNode(name).getInstancesNodeFullPath(OrchestrationInstance.getInstance(port).getInstanceId())));\n+    public InstanceStateChangedListener(final String name, final RegistryCenterRepository registryCenterRepository) {\n+        super(registryCenterRepository, Collections.singleton(new RegistryCenterNode(name).getInstancesNodeFullPath(OrchestrationInstance.getInstanceId())));\n     }\n     \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc4NjIzOA==", "url": "https://github.com/apache/shardingsphere/pull/6187#discussion_r448786238", "bodyText": "The port is unnecessary.", "author": "menghaoranss", "createdAt": "2020-07-02T06:54:37Z", "path": "shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/listener/RegistryListenerManager.java", "diffHunk": "@@ -29,8 +29,8 @@\n     \n     private final DataSourceStateChangedListener dataSourceStateChangedListener;\n     \n-    public RegistryListenerManager(final String name, final RegistryCenterRepository registryCenterRepository) {\n-        instanceStateChangedListener = new InstanceStateChangedListener(name, registryCenterRepository);\n+    public RegistryListenerManager(final String name, final int port, final RegistryCenterRepository registryCenterRepository) {", "originalCommit": "df10436ed059b3b3c7ad84b5e5081a52f3737a17", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fb785568953f75c72af1e4203bbe32d6ed0f5a2c", "chunk": "diff --git a/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/listener/RegistryListenerManager.java b/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/listener/RegistryListenerManager.java\nindex 42e3641c7a..d3959938d7 100644\n--- a/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/listener/RegistryListenerManager.java\n+++ b/shardingsphere-control-panel/shardingsphere-orchestration/shardingsphere-orchestration-core/shardingsphere-orchestration-core-registrycenter/src/main/java/org/apache/shardingsphere/orchestration/core/registrycenter/listener/RegistryListenerManager.java\n\n@@ -29,8 +29,8 @@ public final class RegistryListenerManager {\n     \n     private final DataSourceStateChangedListener dataSourceStateChangedListener;\n     \n-    public RegistryListenerManager(final String name, final int port, final RegistryCenterRepository registryCenterRepository) {\n-        instanceStateChangedListener = new InstanceStateChangedListener(name, port, registryCenterRepository);\n+    public RegistryListenerManager(final String name, final RegistryCenterRepository registryCenterRepository) {\n+        instanceStateChangedListener = new InstanceStateChangedListener(name, registryCenterRepository);\n         dataSourceStateChangedListener = new DataSourceStateChangedListener(name, registryCenterRepository);\n     }\n     \n"}}, {"oid": "392bd6fd5221e5b24f7b6e535f751334fade46fd", "url": "https://github.com/apache/shardingsphere/commit/392bd6fd5221e5b24f7b6e535f751334fade46fd", "message": "updated TC", "committedDate": "2020-07-06T08:51:49Z", "type": "commit"}, {"oid": "ee866694f1d3a7acf8393f99d0503aa0331c84cb", "url": "https://github.com/apache/shardingsphere/commit/ee866694f1d3a7acf8393f99d0503aa0331c84cb", "message": "updated implementation", "committedDate": "2020-07-06T08:52:17Z", "type": "commit"}, {"oid": "9920914965fbe3747070fcfac157a035e51f6025", "url": "https://github.com/apache/shardingsphere/commit/9920914965fbe3747070fcfac157a035e51f6025", "message": "make thread-id a string", "committedDate": "2020-07-06T08:53:56Z", "type": "commit"}, {"oid": "fb785568953f75c72af1e4203bbe32d6ed0f5a2c", "url": "https://github.com/apache/shardingsphere/commit/fb785568953f75c72af1e4203bbe32d6ed0f5a2c", "message": "rename to instanceTag", "committedDate": "2020-07-06T08:54:53Z", "type": "commit"}, {"oid": "e072722d828e3d12ed3b5e10fcd5cbc817ff8a36", "url": "https://github.com/apache/shardingsphere/commit/e072722d828e3d12ed3b5e10fcd5cbc817ff8a36", "message": "merge from master", "committedDate": "2020-07-09T10:36:47Z", "type": "commit"}, {"oid": "20b3e1474bf49a9f7d2670e76410e3377c95c55d", "url": "https://github.com/apache/shardingsphere/commit/20b3e1474bf49a9f7d2670e76410e3377c95c55d", "message": "update singleton istance impl", "committedDate": "2020-07-09T10:37:59Z", "type": "commit"}]}