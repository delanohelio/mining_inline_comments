{"pr_number": 6002, "pr_title": "AbstractConnectionAdapter implement Connection#isValid(int) method", "pr_createdAt": "2020-06-11T10:28:44Z", "pr_url": "https://github.com/apache/shardingsphere/pull/6002", "timeline": [{"oid": "6a1660d8b725b25fe19db00a9172e6cc7fa51430", "url": "https://github.com/apache/shardingsphere/commit/6a1660d8b725b25fe19db00a9172e6cc7fa51430", "message": "AbstractConnectionAdapter implement Connection#isValid(int) method", "committedDate": "2020-06-11T10:34:09Z", "type": "forcePushed"}, {"oid": "c191c9571ab5a2e9e6d3f0c0f84c8bb6cd36d851", "url": "https://github.com/apache/shardingsphere/commit/c191c9571ab5a2e9e6d3f0c0f84c8bb6cd36d851", "message": "AbstractConnectionAdapter implement Connection#isValid(int) method", "committedDate": "2020-06-11T11:24:42Z", "type": "commit"}, {"oid": "c191c9571ab5a2e9e6d3f0c0f84c8bb6cd36d851", "url": "https://github.com/apache/shardingsphere/commit/c191c9571ab5a2e9e6d3f0c0f84c8bb6cd36d851", "message": "AbstractConnectionAdapter implement Connection#isValid(int) method", "committedDate": "2020-06-11T11:24:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgxODUyMw==", "url": "https://github.com/apache/shardingsphere/pull/6002#discussion_r438818523", "bodyText": "why true?", "author": "kimmking", "createdAt": "2020-06-11T14:14:16Z", "path": "shardingsphere-jdbc/shardingsphere-jdbc-orchestration/src/main/java/org/apache/shardingsphere/driver/orchestration/internal/circuit/connection/CircuitBreakerConnection.java", "diffHunk": "@@ -127,7 +128,12 @@ public PreparedStatement prepareStatement(final String sql, final int[] columnIn\n     public PreparedStatement prepareStatement(final String sql, final String[] columnNames) {\n         return new CircuitBreakerPreparedStatement();\n     }\n-    \n+\n+    @Override\n+    public boolean isValid(final int timeout) throws SQLException {\n+        return true;", "originalCommit": "c191c9571ab5a2e9e6d3f0c0f84c8bb6cd36d851", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTE4NzA2MQ==", "url": "https://github.com/apache/shardingsphere/pull/6002#discussion_r439187061", "bodyText": "As far as the health check is concerned, the service should still be up when the CircuitBreak  is open, so I think isValid method returns true.", "author": "WEIZIBIN", "createdAt": "2020-06-12T03:26:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgxODUyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIxNDM1NA==", "url": "https://github.com/apache/shardingsphere/pull/6002#discussion_r449214354", "bodyText": "After upgrading spring-boot to version 2.3.1, I also encountered \"new SQLFeatureNotSupportedException(\"isValid\")\".\nspring-boot-actuator will perform database heartbeat detection according to the configuration file.\nIn the \"org.springframework.boot.actuate.jdbc.DataSourceHealthIndicator#doDataSourceHealthCheck\" method, different heartbeats will be detected based on whether the'query' variable in the DataSourceHealthIndicator class has a value.\nIf'query' is not assigned, it will directly call java .sql.Connection#isValid This specific implementation method.\nBecause shardingJDBC does not implement the java.sql.Connection#isValid method, it will directly report the error \"new SQLFeatureNotSupportedException(\"isValid\")\".\nCurrently shardingJDBC does not support the java.sql.Connection#isValid method.\nIn order to solve the above problem, you can inherit the \"DataSourceHealthContributorAutoConfiguration\" method, override the createIndicator method, and set the \"query\" variable in the DataSourceHealthIndicator class, for example, set it to \"select 1\".\nAfter setting the variable \"query\",\nthe doDataSourceHealthCheck method will call the \"org.springframework.jdbc.core.JdbcTemplate#query(java.lang.String, org.springframework.jdbc.core.RowMapper)\" method to complete the database Heartbeat detection.", "author": "DeShun-1024", "createdAt": "2020-07-02T19:04:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgxODUyMw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgxOTEwMA==", "url": "https://github.com/apache/shardingsphere/pull/6002#discussion_r438819100", "bodyText": "is there some cases need return true, such as m-s?", "author": "kimmking", "createdAt": "2020-06-11T14:15:06Z", "path": "shardingsphere-jdbc/shardingsphere-jdbc-core/src/main/java/org/apache/shardingsphere/driver/jdbc/adapter/AbstractConnectionAdapter.java", "diffHunk": "@@ -239,6 +239,16 @@ public final void setTransactionIsolation(final int level) throws SQLException {\n         recordMethodInvocation(Connection.class, \"setTransactionIsolation\", new Class[]{int.class}, new Object[]{level});\n         forceExecuteTemplate.execute(cachedConnections.values(), connection -> connection.setTransactionIsolation(level));\n     }\n+\n+    @Override\n+    public final boolean isValid(final int timeout) throws SQLException {\n+        for (Connection connection : cachedConnections.values()) {\n+            if (!connection.isValid(timeout)) {\n+                return false;", "originalCommit": "c191c9571ab5a2e9e6d3f0c0f84c8bb6cd36d851", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTE4Nzk1MQ==", "url": "https://github.com/apache/shardingsphere/pull/6002#discussion_r439187951", "bodyText": "Do you mean when master is up and slave goes down, it should return true?\nThis seems better, i will try to identify which connections are from the master data source.", "author": "WEIZIBIN", "createdAt": "2020-06-12T03:31:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgxOTEwMA=="}], "type": "inlineReview", "revised_code": null}]}