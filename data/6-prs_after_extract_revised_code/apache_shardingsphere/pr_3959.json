{"pr_number": 3959, "pr_title": "Get ciphertext column as a string", "pr_createdAt": "2020-01-13T14:01:53Z", "pr_url": "https://github.com/apache/shardingsphere/pull/3959", "timeline": [{"oid": "16687819e776f7fc699bb0dcaeaeda81c0b7847d", "url": "https://github.com/apache/shardingsphere/commit/16687819e776f7fc699bb0dcaeaeda81c0b7847d", "message": "Get ciphertext column as a string", "committedDate": "2020-01-13T13:21:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM0ODEyOQ==", "url": "https://github.com/apache/shardingsphere/pull/3959#discussion_r368348129", "bodyText": "Please keep origin indent", "author": "terrymanu", "createdAt": "2020-01-20T02:20:26Z", "path": "encrypt-core/encrypt-core-merge/src/main/java/org/apache/shardingsphere/encrypt/merge/dql/EncryptMergedResult.java", "diffHunk": "@@ -44,15 +44,15 @@\n     public boolean next() throws SQLException {\n         return mergedResult.next();\n     }\n-    \n+", "originalCommit": "16687819e776f7fc699bb0dcaeaeda81c0b7847d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5311b57a830509968b659ad38697be9197d23a18", "chunk": "diff --git a/encrypt-core/encrypt-core-merge/src/main/java/org/apache/shardingsphere/encrypt/merge/dql/EncryptMergedResult.java b/encrypt-core/encrypt-core-merge/src/main/java/org/apache/shardingsphere/encrypt/merge/dql/EncryptMergedResult.java\nindex d4493868ad..de2c3007a2 100644\n--- a/encrypt-core/encrypt-core-merge/src/main/java/org/apache/shardingsphere/encrypt/merge/dql/EncryptMergedResult.java\n+++ b/encrypt-core/encrypt-core-merge/src/main/java/org/apache/shardingsphere/encrypt/merge/dql/EncryptMergedResult.java\n\n@@ -47,8 +47,11 @@ public final class EncryptMergedResult implements MergedResult {\n \n     @Override\n     public Object getValue(final int columnIndex, final Class<?> type) throws SQLException {\n-        Optional<Encryptor> encryptor;\n-        if (!queryWithCipherColumn || !(encryptor = metaData.findEncryptor(columnIndex)).isPresent()) {\n+        if (!queryWithCipherColumn) {\n+            return mergedResult.getValue(columnIndex, type);\n+        }\n+        Optional<Encryptor> encryptor = metaData.findEncryptor(columnIndex);\n+        if (!encryptor.isPresent()) {\n             return mergedResult.getValue(columnIndex, type);\n         }\n         String ciphertext = (String) mergedResult.getValue(columnIndex, String.class);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM0ODM1MQ==", "url": "https://github.com/apache/shardingsphere/pull/3959#discussion_r368348351", "bodyText": "The logic below may better:\n\njudge queryWithCipherColumn or not\n\nif !queryWithCipherColumn, return mergedResult.getValue(columnIndex, type)\nif queryWithCipherColumn,  get value via mergedResult.getValue(columnIndex, String.class)\n\nif value is null, return null\nif value is not null, findEncryptor and return decrypt value", "author": "terrymanu", "createdAt": "2020-01-20T02:22:02Z", "path": "encrypt-core/encrypt-core-merge/src/main/java/org/apache/shardingsphere/encrypt/merge/dql/EncryptMergedResult.java", "diffHunk": "@@ -44,15 +44,15 @@\n     public boolean next() throws SQLException {\n         return mergedResult.next();\n     }\n-    \n+\n     @Override\n     public Object getValue(final int columnIndex, final Class<?> type) throws SQLException {\n-        Object value = mergedResult.getValue(columnIndex, type);\n-        if (null == value || !queryWithCipherColumn) {\n-            return value;\n+        Optional<Encryptor> encryptor;\n+        if (!queryWithCipherColumn || !(encryptor = metaData.findEncryptor(columnIndex)).isPresent()) {\n+            return mergedResult.getValue(columnIndex, type);\n         }\n-        Optional<Encryptor> encryptor = metaData.findEncryptor(columnIndex);\n-        return encryptor.isPresent() ? encryptor.get().decrypt(value.toString()) : value;\n+        String ciphertext = (String) mergedResult.getValue(columnIndex, String.class);\n+        return null == ciphertext ? null : encryptor.get().decrypt(ciphertext);", "originalCommit": "16687819e776f7fc699bb0dcaeaeda81c0b7847d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQ5MjI2OQ==", "url": "https://github.com/apache/shardingsphere/pull/3959#discussion_r368492269", "bodyText": "The encryptor should also judge whether it is null. For example, the id(bigint) is unencrypted and should be executed\nmergedResult.getValue(columnIndex, type)\nOr you mean it's too complicated:\nif (!queryWithCipherColumn || !(encryptor = metaData.findEncryptor(columnIndex)).isPresent())", "author": "longjy", "createdAt": "2020-01-20T11:10:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM0ODM1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUyMjk4Ng==", "url": "https://github.com/apache/shardingsphere/pull/3959#discussion_r368522986", "bodyText": "Yes, it is too complicated", "author": "terrymanu", "createdAt": "2020-01-20T12:29:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM0ODM1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODgwMjEzMg==", "url": "https://github.com/apache/shardingsphere/pull/3959#discussion_r368802132", "bodyText": "Code style fixed", "author": "longjy", "createdAt": "2020-01-21T03:57:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM0ODM1MQ=="}], "type": "inlineReview", "revised_code": {"commit": "5311b57a830509968b659ad38697be9197d23a18", "chunk": "diff --git a/encrypt-core/encrypt-core-merge/src/main/java/org/apache/shardingsphere/encrypt/merge/dql/EncryptMergedResult.java b/encrypt-core/encrypt-core-merge/src/main/java/org/apache/shardingsphere/encrypt/merge/dql/EncryptMergedResult.java\nindex d4493868ad..de2c3007a2 100644\n--- a/encrypt-core/encrypt-core-merge/src/main/java/org/apache/shardingsphere/encrypt/merge/dql/EncryptMergedResult.java\n+++ b/encrypt-core/encrypt-core-merge/src/main/java/org/apache/shardingsphere/encrypt/merge/dql/EncryptMergedResult.java\n\n@@ -47,8 +47,11 @@ public final class EncryptMergedResult implements MergedResult {\n \n     @Override\n     public Object getValue(final int columnIndex, final Class<?> type) throws SQLException {\n-        Optional<Encryptor> encryptor;\n-        if (!queryWithCipherColumn || !(encryptor = metaData.findEncryptor(columnIndex)).isPresent()) {\n+        if (!queryWithCipherColumn) {\n+            return mergedResult.getValue(columnIndex, type);\n+        }\n+        Optional<Encryptor> encryptor = metaData.findEncryptor(columnIndex);\n+        if (!encryptor.isPresent()) {\n             return mergedResult.getValue(columnIndex, type);\n         }\n         String ciphertext = (String) mergedResult.getValue(columnIndex, String.class);\n"}}, {"oid": "5311b57a830509968b659ad38697be9197d23a18", "url": "https://github.com/apache/shardingsphere/commit/5311b57a830509968b659ad38697be9197d23a18", "message": "code style", "committedDate": "2020-01-21T03:47:39Z", "type": "commit"}, {"oid": "2f2c2926f2851c34234ec16626868d375137c281", "url": "https://github.com/apache/shardingsphere/commit/2f2c2926f2851c34234ec16626868d375137c281", "message": "code style", "committedDate": "2020-01-21T03:56:21Z", "type": "commit"}]}