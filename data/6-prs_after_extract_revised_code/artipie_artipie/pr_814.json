{"pr_number": 814, "pr_title": "#797 - Use ConfigFile where RxStorage is used for config files", "pr_createdAt": "2020-12-17T15:02:24Z", "pr_url": "https://github.com/artipie/artipie/pull/814", "timeline": [{"oid": "760cd32b8fbaa77ac9dbfa437acf23cade48ec76", "url": "https://github.com/artipie/artipie/commit/760cd32b8fbaa77ac9dbfa437acf23cade48ec76", "message": "#797 - Use ConfigFile with RxStorage is used", "committedDate": "2020-12-17T15:01:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTYxOTY5MA==", "url": "https://github.com/artipie/artipie/pull/814#discussion_r545619690", "bodyText": "@genryxy converting new ConfigFile(...).valueFrom(...) into Single and later converting this Single into CompletionStage one again seems pointless. I'd suggest to not do it and transform CompletionStage into result using thenApply, thenCompose etc", "author": "olegmoz", "createdAt": "2020-12-18T07:29:42Z", "path": "src/main/java/com/artipie/RepoPermissionsFromStorage.java", "diffHunk": "@@ -177,11 +176,11 @@ public RepoPermissionsFromStorage(final Storage storage) {\n      * @return Completion action with yaml repo section\n      */\n     private CompletionStage<YamlMapping> repo(final Key key) {\n-        return new RxStorageWrapper(this.storage)\n-            .value(key)\n-            .to(new ContentAsYaml())\n-            .map(yaml -> yaml.yamlMapping(RepoPermissionsFromStorage.REPO_SECTION))\n-            .to(SingleInterop.get());\n+        return SingleInterop.fromFuture(\n+            new ConfigFile(key).valueFrom(this.storage)\n+        ).to(new ContentAsYaml())\n+        .map(yaml -> yaml.yamlMapping(RepoPermissionsFromStorage.REPO_SECTION))\n+        .to(SingleInterop.get());", "originalCommit": "760cd32b8fbaa77ac9dbfa437acf23cade48ec76", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bb40ee39fde8387df32510d5b8244b52d959f817", "chunk": "diff --git a/src/main/java/com/artipie/RepoPermissionsFromStorage.java b/src/main/java/com/artipie/RepoPermissionsFromStorage.java\nindex e19e969..ab440f9 100644\n--- a/src/main/java/com/artipie/RepoPermissionsFromStorage.java\n+++ b/src/main/java/com/artipie/RepoPermissionsFromStorage.java\n\n@@ -176,11 +177,14 @@ public final class RepoPermissionsFromStorage implements RepoPermissions {\n      * @return Completion action with yaml repo section\n      */\n     private CompletionStage<YamlMapping> repo(final Key key) {\n-        return SingleInterop.fromFuture(\n-            new ConfigFile(key).valueFrom(this.storage)\n-        ).to(new ContentAsYaml())\n-        .map(yaml -> yaml.yamlMapping(RepoPermissionsFromStorage.REPO_SECTION))\n-        .to(SingleInterop.get());\n+        return new ConfigFile(key).valueFrom(this.storage)\n+            .thenCompose(\n+                pub -> new Concatenation(pub).single()\n+                    .map(buf -> new Remaining(buf).bytes())\n+                    .map(bytes -> new String(bytes, StandardCharsets.US_ASCII))\n+                    .map(cnt -> Yaml.createYamlInput(cnt).readYamlMapping())\n+                    .to(SingleInterop.get())\n+            ).thenApply(yaml -> yaml.yamlMapping(RepoPermissionsFromStorage.REPO_SECTION));\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTYyMjgwNw==", "url": "https://github.com/artipie/artipie/pull/814#discussion_r545622807", "bodyText": "@genryxy same concern here, I'd suggest to transform CompletionStage into result directly without using Single", "author": "olegmoz", "createdAt": "2020-12-18T07:37:48Z", "path": "src/main/java/com/artipie/UsersFromStorageYaml.java", "diffHunk": "@@ -163,14 +163,14 @@ public UsersFromStorageYaml(final Storage storage, final Key key) {\n      *  figure out why, make necessary corrections and use `ContentAs` here.\n      */\n     public CompletionStage<YamlMapping> yaml() {\n-        return new RxStorageWrapper(this.storage)\n-            .value(this.key)\n-            .flatMap(content -> new Concatenation(content).single())\n-            .map(Remaining::new)\n-            .map(Remaining::bytes)\n-            .map(bytes -> Yaml.createYamlInput(new String(bytes, StandardCharsets.US_ASCII)))\n-            .map(YamlInput::readYamlMapping)\n-            .to(SingleInterop.get());\n+        return SingleInterop.fromFuture(\n+            new ConfigFile(this.key).valueFrom(this.storage)\n+        ).flatMap(content -> new Concatenation(content).single())\n+        .map(Remaining::new)\n+        .map(Remaining::bytes)\n+        .map(bytes -> Yaml.createYamlInput(new String(bytes, StandardCharsets.US_ASCII)))\n+        .map(YamlInput::readYamlMapping)\n+        .to(SingleInterop.get());", "originalCommit": "760cd32b8fbaa77ac9dbfa437acf23cade48ec76", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bb40ee39fde8387df32510d5b8244b52d959f817", "chunk": "diff --git a/src/main/java/com/artipie/UsersFromStorageYaml.java b/src/main/java/com/artipie/UsersFromStorageYaml.java\nindex 0c858e7..1260b40 100644\n--- a/src/main/java/com/artipie/UsersFromStorageYaml.java\n+++ b/src/main/java/com/artipie/UsersFromStorageYaml.java\n\n@@ -161,16 +160,20 @@ public final class UsersFromStorageYaml implements Users {\n      * @todo #730:30min When `ContentAs` is used here instead of `Concatenation` and\n      *  `Remaining` ITs get stuck on github actions (this does not happen locally on mac os),\n      *  figure out why, make necessary corrections and use `ContentAs` here.\n+     * @todo #797:30min Extract logic for creating yaml from Content.\n+     *  In this method, `RepoPermissionsFromStorage#repo`, `StorageAliases#find`\n+     *  the code for creating yaml from content is duplicate. It is necessary\n+     *  to extract class to eliminate code duplication.\n      */\n     public CompletionStage<YamlMapping> yaml() {\n-        return SingleInterop.fromFuture(\n-            new ConfigFile(this.key).valueFrom(this.storage)\n-        ).flatMap(content -> new Concatenation(content).single())\n-        .map(Remaining::new)\n-        .map(Remaining::bytes)\n-        .map(bytes -> Yaml.createYamlInput(new String(bytes, StandardCharsets.US_ASCII)))\n-        .map(YamlInput::readYamlMapping)\n-        .to(SingleInterop.get());\n+        return new ConfigFile(this.key).valueFrom(this.storage)\n+            .thenCompose(\n+                pub -> new Concatenation(pub).single()\n+                    .map(buf -> new Remaining(buf).bytes())\n+                    .map(bytes -> new String(bytes, StandardCharsets.US_ASCII))\n+                    .map(cnt -> Yaml.createYamlInput(cnt).readYamlMapping())\n+                    .to(SingleInterop.get())\n+            );\n     }\n \n     /**\n"}}, {"oid": "bb40ee39fde8387df32510d5b8244b52d959f817", "url": "https://github.com/artipie/artipie/commit/bb40ee39fde8387df32510d5b8244b52d959f817", "message": "#797 - Changes by review", "committedDate": "2020-12-18T09:53:41Z", "type": "commit"}, {"oid": "9ceb171c4cfb92e2266c0695b565bf974996992d", "url": "https://github.com/artipie/artipie/commit/9ceb171c4cfb92e2266c0695b565bf974996992d", "message": "#797 - Revert changes", "committedDate": "2020-12-18T10:09:26Z", "type": "commit"}]}