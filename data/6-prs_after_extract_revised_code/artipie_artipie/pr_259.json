{"pr_number": 259, "pr_title": "#231 - Added InMemoryMetrics with counters support", "pr_createdAt": "2020-07-06T12:21:45Z", "pr_url": "https://github.com/artipie/artipie/pull/259", "timeline": [{"oid": "80517163c0b955a1de2b9e5bc0c684d1ce54e8f2", "url": "https://github.com/artipie/artipie/commit/80517163c0b955a1de2b9e5bc0c684d1ce54e8f2", "message": "#231 - Added InMemoryMetrics with counters support", "committedDate": "2020-07-06T13:09:48Z", "type": "forcePushed"}, {"oid": "5999b0493de4bca3626da30659591d17c5f8fb07", "url": "https://github.com/artipie/artipie/commit/5999b0493de4bca3626da30659591d17c5f8fb07", "message": "#231 - Added InMemoryMetrics with counters support", "committedDate": "2020-07-06T18:10:56Z", "type": "forcePushed"}, {"oid": "5999b0493de4bca3626da30659591d17c5f8fb07", "url": "https://github.com/artipie/artipie/commit/5999b0493de4bca3626da30659591d17c5f8fb07", "message": "#231 - Added InMemoryMetrics with counters support", "committedDate": "2020-07-06T18:10:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY5NzM3Mg==", "url": "https://github.com/artipie/artipie/pull/259#discussion_r450697372", "bodyText": "@olegmoz I think that this method should be added to the interface: we can always create another abstractions if later we realize that Map<String, Counter> is not suitable for all Metrics implementations. Same stands for value() methods in Counter and Gauge.\nAlso, not inherited methods in implementations do not seem to be a good practice: it always leads to casting/operating specific implementations instead of the interfaces.", "author": "olenagerasimova", "createdAt": "2020-07-07T08:32:04Z", "path": "src/main/java/com/artipie/metrics/memory/InMemoryMetrics.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * The MIT License (MIT)\n+ *\n+ * Copyright (c) 2020 artipie.com\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included\n+ * in all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ */\n+package com.artipie.metrics.memory;\n+\n+import com.artipie.metrics.Metrics;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentMap;\n+\n+/**\n+ * {@link Metrics} implementation storing data in memory.\n+ *\n+ * @since 0.9\n+ * @todo #231:30min Support gauges in InMemoryMetrics.\n+ *  `InMemoryMetrics.gauge()` method implementation should get or create an `InMemoryGauge` by name\n+ *  and store it. `InMemoryMetrics.counters()` method should be added\n+ *  to create snapshot of existing gauges. Implementations are expected to be similar to counters.\n+ */\n+final class InMemoryMetrics implements Metrics {\n+\n+    /**\n+     * Counters by name.\n+     */\n+    private final ConcurrentMap<String, InMemoryCounter> cnts = new ConcurrentHashMap<>();\n+\n+    @Override\n+    public InMemoryCounter counter(final String name) {\n+        return this.cnts.computeIfAbsent(name, ignored -> new InMemoryCounter());\n+    }\n+\n+    @Override\n+    public InMemoryGauge gauge(final String name) {\n+        throw new UnsupportedOperationException();\n+    }\n+\n+    /**\n+     * Get counters snapshot.\n+     *\n+     * @return Counters snapshot.\n+     */\n+    public Map<String, InMemoryCounter> counters() {", "originalCommit": "5999b0493de4bca3626da30659591d17c5f8fb07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcyMDU1OQ==", "url": "https://github.com/artipie/artipie/pull/259#discussion_r450720559", "bodyText": "@olenagerasimova there was similar concern in PR with interfaces, see #238 . Metrics interface is for reporting metrics and what we are doing with counters and gauges may differ a lot. For the start we are storing them in memory and will print periodically to the log. It will not be the case with other metric aggregators. The fact that we can read counters map is specific for InMemoryMetrics and does not seem to be needed in other implementations I an imagine now.", "author": "olegmoz", "createdAt": "2020-07-07T09:10:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY5NzM3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcyNTQyNg==", "url": "https://github.com/artipie/artipie/pull/259#discussion_r450725426", "bodyText": "@olegmoz ok, thanks for the explanation", "author": "olenagerasimova", "createdAt": "2020-07-07T09:18:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY5NzM3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "35818ff9942ae60e76e5d59cc89e0500265feae5", "chunk": "diff --git a/src/main/java/com/artipie/metrics/memory/InMemoryMetrics.java b/src/main/java/com/artipie/metrics/memory/InMemoryMetrics.java\nindex e4aa39d..dff0c61 100644\n--- a/src/main/java/com/artipie/metrics/memory/InMemoryMetrics.java\n+++ b/src/main/java/com/artipie/metrics/memory/InMemoryMetrics.java\n\n@@ -35,7 +35,7 @@ import java.util.concurrent.ConcurrentMap;\n  * @since 0.9\n  * @todo #231:30min Support gauges in InMemoryMetrics.\n  *  `InMemoryMetrics.gauge()` method implementation should get or create an `InMemoryGauge` by name\n- *  and store it. `InMemoryMetrics.counters()` method should be added\n+ *  and store it. `InMemoryMetrics.gauges()` method should be added\n  *  to create snapshot of existing gauges. Implementations are expected to be similar to counters.\n  */\n final class InMemoryMetrics implements Metrics {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcwNjI3MA==", "url": "https://github.com/artipie/artipie/pull/259#discussion_r450706270", "bodyText": "@olegmoz l'd suggest returning Gauge and Counter instead of theirs implementation", "author": "olenagerasimova", "createdAt": "2020-07-07T08:46:17Z", "path": "src/main/java/com/artipie/metrics/memory/InMemoryMetrics.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * The MIT License (MIT)\n+ *\n+ * Copyright (c) 2020 artipie.com\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included\n+ * in all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ */\n+package com.artipie.metrics.memory;\n+\n+import com.artipie.metrics.Metrics;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentMap;\n+\n+/**\n+ * {@link Metrics} implementation storing data in memory.\n+ *\n+ * @since 0.9\n+ * @todo #231:30min Support gauges in InMemoryMetrics.\n+ *  `InMemoryMetrics.gauge()` method implementation should get or create an `InMemoryGauge` by name\n+ *  and store it. `InMemoryMetrics.counters()` method should be added\n+ *  to create snapshot of existing gauges. Implementations are expected to be similar to counters.\n+ */\n+final class InMemoryMetrics implements Metrics {\n+\n+    /**\n+     * Counters by name.\n+     */\n+    private final ConcurrentMap<String, InMemoryCounter> cnts = new ConcurrentHashMap<>();\n+\n+    @Override\n+    public InMemoryCounter counter(final String name) {\n+        return this.cnts.computeIfAbsent(name, ignored -> new InMemoryCounter());\n+    }\n+\n+    @Override\n+    public InMemoryGauge gauge(final String name) {", "originalCommit": "5999b0493de4bca3626da30659591d17c5f8fb07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcyMTAxNA==", "url": "https://github.com/artipie/artipie/pull/259#discussion_r450721014", "bodyText": "@olenagerasimova that's intended, if we take a counter from InMemoryMetrics then we can read it's value", "author": "olegmoz", "createdAt": "2020-07-07T09:10:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcwNjI3MA=="}], "type": "inlineReview", "revised_code": {"commit": "35818ff9942ae60e76e5d59cc89e0500265feae5", "chunk": "diff --git a/src/main/java/com/artipie/metrics/memory/InMemoryMetrics.java b/src/main/java/com/artipie/metrics/memory/InMemoryMetrics.java\nindex e4aa39d..dff0c61 100644\n--- a/src/main/java/com/artipie/metrics/memory/InMemoryMetrics.java\n+++ b/src/main/java/com/artipie/metrics/memory/InMemoryMetrics.java\n\n@@ -35,7 +35,7 @@ import java.util.concurrent.ConcurrentMap;\n  * @since 0.9\n  * @todo #231:30min Support gauges in InMemoryMetrics.\n  *  `InMemoryMetrics.gauge()` method implementation should get or create an `InMemoryGauge` by name\n- *  and store it. `InMemoryMetrics.counters()` method should be added\n+ *  and store it. `InMemoryMetrics.gauges()` method should be added\n  *  to create snapshot of existing gauges. Implementations are expected to be similar to counters.\n  */\n final class InMemoryMetrics implements Metrics {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcwODI0NQ==", "url": "https://github.com/artipie/artipie/pull/259#discussion_r450708245", "bodyText": "@olegmoz todo does not seem relevant: InMemoryMetrics.counters() is already implemented", "author": "olenagerasimova", "createdAt": "2020-07-07T08:49:33Z", "path": "src/main/java/com/artipie/metrics/memory/InMemoryMetrics.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * The MIT License (MIT)\n+ *\n+ * Copyright (c) 2020 artipie.com\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included\n+ * in all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ */\n+package com.artipie.metrics.memory;\n+\n+import com.artipie.metrics.Metrics;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentMap;\n+\n+/**\n+ * {@link Metrics} implementation storing data in memory.\n+ *\n+ * @since 0.9\n+ * @todo #231:30min Support gauges in InMemoryMetrics.\n+ *  `InMemoryMetrics.gauge()` method implementation should get or create an `InMemoryGauge` by name\n+ *  and store it. `InMemoryMetrics.counters()` method should be added", "originalCommit": "5999b0493de4bca3626da30659591d17c5f8fb07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcyMTQ3NQ==", "url": "https://github.com/artipie/artipie/pull/259#discussion_r450721475", "bodyText": "@olenagerasimova thanks, corrected", "author": "olegmoz", "createdAt": "2020-07-07T09:11:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcwODI0NQ=="}], "type": "inlineReview", "revised_code": {"commit": "35818ff9942ae60e76e5d59cc89e0500265feae5", "chunk": "diff --git a/src/main/java/com/artipie/metrics/memory/InMemoryMetrics.java b/src/main/java/com/artipie/metrics/memory/InMemoryMetrics.java\nindex e4aa39d..dff0c61 100644\n--- a/src/main/java/com/artipie/metrics/memory/InMemoryMetrics.java\n+++ b/src/main/java/com/artipie/metrics/memory/InMemoryMetrics.java\n\n@@ -35,7 +35,7 @@ import java.util.concurrent.ConcurrentMap;\n  * @since 0.9\n  * @todo #231:30min Support gauges in InMemoryMetrics.\n  *  `InMemoryMetrics.gauge()` method implementation should get or create an `InMemoryGauge` by name\n- *  and store it. `InMemoryMetrics.counters()` method should be added\n+ *  and store it. `InMemoryMetrics.gauges()` method should be added\n  *  to create snapshot of existing gauges. Implementations are expected to be similar to counters.\n  */\n final class InMemoryMetrics implements Metrics {\n"}}, {"oid": "63fc87fb4bbdb6fe12429081dacf3f1bd7779ed5", "url": "https://github.com/artipie/artipie/commit/63fc87fb4bbdb6fe12429081dacf3f1bd7779ed5", "message": "Merge branch 'master' into 231-in-memory-metrics", "committedDate": "2020-07-07T09:11:46Z", "type": "commit"}, {"oid": "35818ff9942ae60e76e5d59cc89e0500265feae5", "url": "https://github.com/artipie/artipie/commit/35818ff9942ae60e76e5d59cc89e0500265feae5", "message": "#231 - Changes by review", "committedDate": "2020-07-07T09:15:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDczMzg3NA==", "url": "https://github.com/artipie/artipie/pull/259#discussion_r450733874", "bodyText": "@olegmoz since 0.9", "author": "Vatavuk", "createdAt": "2020-07-07T09:32:36Z", "path": "src/test/java/com/artipie/metrics/memory/InMemoryMetricsTest.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * The MIT License (MIT)\n+ *\n+ * Copyright (c) 2020 artipie.com\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included\n+ * in all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ */\n+package com.artipie.metrics.memory;\n+\n+import org.hamcrest.MatcherAssert;\n+import org.hamcrest.Matchers;\n+import org.hamcrest.collection.IsEmptyCollection;\n+import org.hamcrest.core.IsEqual;\n+import org.hamcrest.core.IsInstanceOf;\n+import org.hamcrest.core.IsNot;\n+import org.junit.jupiter.api.Test;\n+\n+/**\n+ * Tests for {@link InMemoryMetrics}.\n+ *\n+ * @since 0.8", "originalCommit": "35818ff9942ae60e76e5d59cc89e0500265feae5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDczNjQyMw==", "url": "https://github.com/artipie/artipie/pull/259#discussion_r450736423", "bodyText": "@Vatavuk thanks, fixed", "author": "olegmoz", "createdAt": "2020-07-07T09:37:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDczMzg3NA=="}], "type": "inlineReview", "revised_code": {"commit": "f29e986c899f4fbd3c7c6e5122762355cfd5c0c8", "chunk": "diff --git a/src/test/java/com/artipie/metrics/memory/InMemoryMetricsTest.java b/src/test/java/com/artipie/metrics/memory/InMemoryMetricsTest.java\nindex 8b98404..3d43a93 100644\n--- a/src/test/java/com/artipie/metrics/memory/InMemoryMetricsTest.java\n+++ b/src/test/java/com/artipie/metrics/memory/InMemoryMetricsTest.java\n\n@@ -34,7 +34,7 @@ import org.junit.jupiter.api.Test;\n /**\n  * Tests for {@link InMemoryMetrics}.\n  *\n- * @since 0.8\n+ * @since 0.9\n  */\n class InMemoryMetricsTest {\n \n"}}, {"oid": "5016fd37d50224cd207bd67a0d4ebdc95fbea69c", "url": "https://github.com/artipie/artipie/commit/5016fd37d50224cd207bd67a0d4ebdc95fbea69c", "message": "Merge branch 'master' into 231-in-memory-metrics", "committedDate": "2020-07-07T09:35:56Z", "type": "commit"}, {"oid": "f29e986c899f4fbd3c7c6e5122762355cfd5c0c8", "url": "https://github.com/artipie/artipie/commit/f29e986c899f4fbd3c7c6e5122762355cfd5c0c8", "message": "#231 - Changes by review", "committedDate": "2020-07-07T09:39:48Z", "type": "commit"}]}