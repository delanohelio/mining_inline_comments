{"pr_number": 532, "pr_title": "#521 - Auth fix for Docker repositories", "pr_createdAt": "2020-08-31T04:59:29Z", "pr_url": "https://github.com/artipie/artipie/pull/532", "timeline": [{"oid": "3b0fe4b25bcf81abc1965c325e9af49b84d0383b", "url": "https://github.com/artipie/artipie/commit/3b0fe4b25bcf81abc1965c325e9af49b84d0383b", "message": "#521 - Auth fix for Docker repositories", "committedDate": "2020-08-31T05:17:44Z", "type": "forcePushed"}, {"oid": "fd8f149fda2229b395dcba41f8725a406f55a307", "url": "https://github.com/artipie/artipie/commit/fd8f149fda2229b395dcba41f8725a406f55a307", "message": "#521 - Auth fix for Docker repositories", "committedDate": "2020-08-31T05:35:50Z", "type": "forcePushed"}, {"oid": "780d731084229843b33d071eb235e003fd219011", "url": "https://github.com/artipie/artipie/commit/780d731084229843b33d071eb235e003fd219011", "message": "#521 - Auth fix for Docker repositories", "committedDate": "2020-08-31T05:41:13Z", "type": "forcePushed"}, {"oid": "5dd4682ae03204e16f13acde48281f46391631f8", "url": "https://github.com/artipie/artipie/commit/5dd4682ae03204e16f13acde48281f46391631f8", "message": "#521 - Auth fix for Docker repositories", "committedDate": "2020-08-31T06:04:42Z", "type": "commit"}, {"oid": "5dd4682ae03204e16f13acde48281f46391631f8", "url": "https://github.com/artipie/artipie/commit/5dd4682ae03204e16f13acde48281f46391631f8", "message": "#521 - Auth fix for Docker repositories", "committedDate": "2020-08-31T06:04:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDAzNjAxNA==", "url": "https://github.com/artipie/artipie/pull/532#discussion_r480036014", "bodyText": "@olegmoz you can use SliceHasResponse here:\nMatcherAssert.assertThat(\n  new DockerRoutingSlice(...),\n  new SliceHasResponse(\n    new RsHasStatus(status),\n    new RequestLine(...)\n  )\n)", "author": "g4s8", "createdAt": "2020-08-31T10:28:37Z", "path": "src/test/java/com/artipie/http/DockerRoutingSliceTest.java", "diffHunk": "@@ -54,19 +70,37 @@ void ignoresNonDockerRequests() throws Exception {\n         final String path = \"/repo/name\";\n         verify(\n             new DockerRoutingSlice(\n+                new Settings.Fake(),\n                 new AssertSlice(new RqLineHasUri(new RqLineHasUri.HasPath(path)))\n             ),\n             path\n         );\n     }\n \n     @Test\n-    void emptyDockerRequest() throws Exception {\n-        verify(\n-            new DockerRoutingSlice(\n-                new AssertSlice(new RqLineHasUri(new RqLineHasUri.HasPath(\"\")))\n-            ),\n-            \"/v2\"\n+    void emptyDockerRequest() {\n+        final String username = \"alice\";\n+        final String password = \"letmein\";\n+        final Response response = new DockerRoutingSlice(\n+            new SettingsWithAuth(new Authentication.Single(username, password)),\n+            (line, headers, body) -> {\n+                throw new UnsupportedOperationException();\n+            }\n+        ).response(\n+            new RequestLine(RqMethod.GET, \"/v2/\").toString(),\n+            new Headers.From(new Authorization.Basic(username, password)),\n+            Content.EMPTY\n+        );\n+        MatcherAssert.assertThat(", "originalCommit": "5dd4682ae03204e16f13acde48281f46391631f8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ffd01be9fe10a0618af2ee2549daad851e5c0af8", "chunk": "diff --git a/src/test/java/com/artipie/http/DockerRoutingSliceTest.java b/src/test/java/com/artipie/http/DockerRoutingSliceTest.java\nindex 5938150..4b63224 100644\n--- a/src/test/java/com/artipie/http/DockerRoutingSliceTest.java\n+++ b/src/test/java/com/artipie/http/DockerRoutingSliceTest.java\n\n@@ -81,25 +82,25 @@ final class DockerRoutingSliceTest {\n     void emptyDockerRequest() {\n         final String username = \"alice\";\n         final String password = \"letmein\";\n-        final Response response = new DockerRoutingSlice(\n-            new SettingsWithAuth(new Authentication.Single(username, password)),\n-            (line, headers, body) -> {\n-                throw new UnsupportedOperationException();\n-            }\n-        ).response(\n-            new RequestLine(RqMethod.GET, \"/v2/\").toString(),\n-            new Headers.From(new Authorization.Basic(username, password)),\n-            Content.EMPTY\n-        );\n         MatcherAssert.assertThat(\n-            response,\n-            new AllOf<>(\n-                Arrays.asList(\n-                    new RsHasStatus(RsStatus.OK),\n-                    new RsHasHeaders(\n-                        new Headers.From(\"Docker-Distribution-API-Version\", \"registry/2.0\")\n+            new DockerRoutingSlice(\n+                new SettingsWithAuth(new Authentication.Single(username, password)),\n+                (line, headers, body) -> {\n+                    throw new UnsupportedOperationException();\n+                }\n+            ),\n+            new SliceHasResponse(\n+                new AllOf<>(\n+                    Arrays.asList(\n+                        new RsHasStatus(RsStatus.OK),\n+                        new RsHasHeaders(\n+                            new Headers.From(\"Docker-Distribution-API-Version\", \"registry/2.0\")\n+                        )\n                     )\n-                )\n+                ),\n+                new RequestLine(RqMethod.GET, \"/v2/\"),\n+                new Headers.From(new Authorization.Basic(username, password)),\n+                Content.EMPTY\n             )\n         );\n     }\n"}}, {"oid": "ffd01be9fe10a0618af2ee2549daad851e5c0af8", "url": "https://github.com/artipie/artipie/commit/ffd01be9fe10a0618af2ee2549daad851e5c0af8", "message": "#521 - Changes by review", "committedDate": "2020-08-31T10:34:27Z", "type": "commit"}]}