{"pr_number": 198, "pr_title": "Introduce Code Action to Resolve Copybooks GH-197 ", "pr_createdAt": "2020-02-13T18:04:25Z", "pr_url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/198", "timeline": [{"oid": "f3973dfc639809efbf30818c9f7fca84362ec106", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/f3973dfc639809efbf30818c9f7fca84362ec106", "message": "Clean-up MyLanguageServerImpl to set only supported capabilities #23", "committedDate": "2020-02-12T15:49:43Z", "type": "commit"}, {"oid": "53db3fd8584da813fe84e5af69fd55d9b053b495", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/53db3fd8584da813fe84e5af69fd55d9b053b495", "message": "Introduce Code Action to Resolve Copybooks GH-197\nAdd logic to the text document service to collect a list of applicable code actions.\nAdd logic to the workspace service to resolve missing copybooks on the Quick Fix.\nAdd error code to determine the code action command type.\nRegister those capabilities on the server initialization.", "committedDate": "2020-02-14T09:43:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDAzNDczNw==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/198#discussion_r380034737", "bodyText": "It looks like a good candidate for a factory method.", "author": "ishche", "createdAt": "2020-02-17T08:17:47Z", "path": "com.ca.lsp.cobol/lsp-core-cobol-parser/src/test/java/com/ca/lsp/core/cobol/visitor/LevenshteinDistanceTest.java", "diffHunk": "@@ -37,7 +37,7 @@\n \n   @Test\n   public void testDistance() {\n-    errors.add(new SyntaxError(new Position(\"\", 1, 1, 1, 1), null, \"\", 2));\n+    errors.add(new SyntaxError(new Position(\"\", 1, 1, 1, 1), null, \"\", 2, null));", "originalCommit": "53db3fd8584da813fe84e5af69fd55d9b053b495", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA0MjEzMw==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/198#discussion_r380042133", "bodyText": "I have factory method changes in another branch, don't want to have a merge conflict.", "author": "temanbrcom", "createdAt": "2020-02-17T08:35:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDAzNDczNw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA0NzEyMQ==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/198#discussion_r380047121", "bodyText": "Please update the header :*(", "author": "zacanbrcom", "createdAt": "2020-02-17T08:47:13Z", "path": "com.ca.lsp.cobol/lsp-core-cobol-parser/src/main/java/com/ca/lsp/core/cobol/engine/CobolLanguageEngine.java", "diffHunk": "@@ -40,8 +40,7 @@\n \n     CobolPreprocessorImpl preprocessor = new CobolPreprocessorImpl();\n \n-    ResultWithErrors<PreprocessedInput> preProcessedInput =\n-        preprocessor.process(documentUri, text);\n+    ResultWithErrors<PreprocessedInput> preProcessedInput = preprocessor.process(documentUri, text);", "originalCommit": "53db3fd8584da813fe84e5af69fd55d9b053b495", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA0Nzc2Ng==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/198#discussion_r380047766", "bodyText": "I will be more specific, like ''..in the predefined copybook folder\"", "author": "zacanbrcom", "createdAt": "2020-02-17T08:48:36Z", "path": "com.ca.lsp.cobol/lsp-core-cobol-parser/src/main/java/com/ca/lsp/core/cobol/model/ErrorCode.java", "diffHunk": "@@ -0,0 +1,25 @@\n+/*\n+ * Copyright (c) 2020 Broadcom.\n+ * The term \"Broadcom\" refers to Broadcom Inc. and/or its subsidiaries.\n+ *\n+ * This program and the accompanying materials are made\n+ * available under the terms of the Eclipse Public License 2.0\n+ * which is available at https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *    Broadcom, Inc. - initial API and implementation\n+ *\n+ */\n+\n+package com.ca.lsp.core.cobol.model;\n+\n+/**\n+ * This enum represents the error codes that are used to determine some special type of errors. See\n+ * the instance documentation for more details.\n+ */\n+public enum ErrorCode {\n+  /** This copybook does not present in the workspace */", "originalCommit": "53db3fd8584da813fe84e5af69fd55d9b053b495", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA1NzIxNQ==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/198#discussion_r380057215", "bodyText": "The \"predefined\" is too strict here, I would prefer just \"...in the copybook folder\"", "author": "temanbrcom", "createdAt": "2020-02-17T09:07:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA0Nzc2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "453da429e958184a64ea6b262a687a3ab04f7388", "chunk": "diff --git a/com.ca.lsp.cobol/lsp-core-cobol-parser/src/main/java/com/ca/lsp/core/cobol/model/ErrorCode.java b/com.ca.lsp.cobol/lsp-core-cobol-parser/src/main/java/com/ca/lsp/core/cobol/model/ErrorCode.java\nindex 0c563512..1fec12bf 100644\n--- a/com.ca.lsp.cobol/lsp-core-cobol-parser/src/main/java/com/ca/lsp/core/cobol/model/ErrorCode.java\n+++ b/com.ca.lsp.cobol/lsp-core-cobol-parser/src/main/java/com/ca/lsp/core/cobol/model/ErrorCode.java\n\n@@ -20,6 +20,6 @@ package com.ca.lsp.core.cobol.model;\n  * the instance documentation for more details.\n  */\n public enum ErrorCode {\n-  /** This copybook does not present in the workspace */\n+  /** This copybook does not present in the copybook folder */\n   MISSING_COPYBOOK\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA0ODY2MA==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/198#discussion_r380048660", "bodyText": "better use errorCode as name", "author": "zacanbrcom", "createdAt": "2020-02-17T08:50:28Z", "path": "com.ca.lsp.cobol/lsp-core-cobol-parser/src/main/java/com/ca/lsp/core/cobol/model/SyntaxError.java", "diffHunk": "@@ -27,12 +27,15 @@\n   private final List<String> ruleStack;\n   private final String suggestion;\n   private final int severity;\n+  private final ErrorCode code;\n \n+  //Please, don't use static imports for this method: https://github.com/rzwitserloot/lombok/issues/2044\n   @Builder(builderMethodName = \"syntaxError\")\n-  public SyntaxError(Position position, List<String> ruleStack, String suggestion, int severity) {\n+  public SyntaxError(Position position, List<String> ruleStack, String suggestion, int severity, ErrorCode code) {\n     this.position = position;\n     this.ruleStack = ruleStack;\n     this.suggestion = suggestion;\n     this.severity = severity;\n+    this.code = code;", "originalCommit": "53db3fd8584da813fe84e5af69fd55d9b053b495", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fbd6a463586bd51db3ddfdaa4f16d4d2cfe6f3ca", "chunk": "diff --git a/com.ca.lsp.cobol/lsp-core-cobol-parser/src/main/java/com/ca/lsp/core/cobol/model/SyntaxError.java b/com.ca.lsp.cobol/lsp-core-cobol-parser/src/main/java/com/ca/lsp/core/cobol/model/SyntaxError.java\nindex 99c87e63..d1aba45d 100644\n--- a/com.ca.lsp.cobol/lsp-core-cobol-parser/src/main/java/com/ca/lsp/core/cobol/model/SyntaxError.java\n+++ b/com.ca.lsp.cobol/lsp-core-cobol-parser/src/main/java/com/ca/lsp/core/cobol/model/SyntaxError.java\n\n@@ -27,15 +27,21 @@ public class SyntaxError {\n   private final List<String> ruleStack;\n   private final String suggestion;\n   private final int severity;\n-  private final ErrorCode code;\n+  private final ErrorCode errorCode;\n \n-  //Please, don't use static imports for this method: https://github.com/rzwitserloot/lombok/issues/2044\n+  // Please, don't use static imports for this method:\n+  // https://github.com/rzwitserloot/lombok/issues/2044\n   @Builder(builderMethodName = \"syntaxError\")\n-  public SyntaxError(Position position, List<String> ruleStack, String suggestion, int severity, ErrorCode code) {\n+  public SyntaxError(\n+      Position position,\n+      List<String> ruleStack,\n+      String suggestion,\n+      int severity,\n+      ErrorCode errorCode) {\n     this.position = position;\n     this.ruleStack = ruleStack;\n     this.suggestion = suggestion;\n     this.severity = severity;\n-    this.code = code;\n+    this.errorCode = errorCode;\n   }\n }\n"}}, {"oid": "fbd6a463586bd51db3ddfdaa4f16d4d2cfe6f3ca", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/fbd6a463586bd51db3ddfdaa4f16d4d2cfe6f3ca", "message": "Introduce Code Action to Resolve Copybooks GH-197\nAdd logic to the text document service to collect a list of applicable code actions.\nAdd logic to the workspace service to resolve missing copybooks on the Quick Fix.\nAdd error code to determine the code action command type.\nRegister those capabilities on the server initialization.", "committedDate": "2020-02-17T09:46:15Z", "type": "forcePushed"}, {"oid": "453da429e958184a64ea6b262a687a3ab04f7388", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/453da429e958184a64ea6b262a687a3ab04f7388", "message": "Introduce Code Action to Resolve Copybooks GH-197\nAdd logic to the text document service to collect a list of applicable code actions.\nAdd logic to the workspace service to resolve missing copybooks on the Quick Fix.\nAdd error code to determine the code action command type.\nRegister those capabilities on the server initialization.", "committedDate": "2020-02-17T09:50:18Z", "type": "commit"}, {"oid": "453da429e958184a64ea6b262a687a3ab04f7388", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/453da429e958184a64ea6b262a687a3ab04f7388", "message": "Introduce Code Action to Resolve Copybooks GH-197\nAdd logic to the text document service to collect a list of applicable code actions.\nAdd logic to the workspace service to resolve missing copybooks on the Quick Fix.\nAdd error code to determine the code action command type.\nRegister those capabilities on the server initialization.", "committedDate": "2020-02-17T09:50:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA5MTk2NA==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/198#discussion_r380091964", "bodyText": "I didn't get why is required to use JsonPrimitive object, is not used in every definition of ExecuteCommandParams", "author": "zacanbrcom", "createdAt": "2020-02-17T10:13:12Z", "path": "com.ca.lsp.cobol/lsp-service-cobol/src/test/java/com/ca/lsp/cobol/service/WorkspaceServiceTest.java", "diffHunk": "@@ -15,31 +15,113 @@\n  */\n package com.ca.lsp.cobol.service;\n \n+import com.broadcom.lsp.domain.cobol.databus.api.DataBusBroker;\n import com.broadcom.lsp.domain.cobol.databus.impl.DefaultDataBusBroker;\n+import com.broadcom.lsp.domain.cobol.event.model.RequiredCopybookEvent;\n import com.broadcom.lsp.domain.cobol.event.model.RunAnalysisEvent;\n+import com.google.gson.JsonPrimitive;\n import lombok.extern.slf4j.Slf4j;\n import org.eclipse.lsp4j.DidChangeWatchedFilesParams;\n-import org.eclipse.lsp4j.FileChangeType;\n+import org.eclipse.lsp4j.ExecuteCommandParams;\n import org.eclipse.lsp4j.FileEvent;\n import org.junit.Test;\n import org.mockito.ArgumentCaptor;\n \n-import java.util.Collections;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutionException;\n \n-import static junit.framework.TestCase.assertNotNull;\n-import static org.mockito.Mockito.mock;\n-import static org.mockito.Mockito.verify;\n+import static com.ca.lsp.cobol.service.delegates.validations.UseCaseUtils.DOCUMENT_URI;\n+import static com.ca.lsp.core.cobol.model.ErrorCode.MISSING_COPYBOOK;\n+import static java.util.Arrays.asList;\n+import static java.util.Collections.emptyList;\n+import static java.util.Collections.singletonList;\n+import static org.eclipse.lsp4j.FileChangeType.Changed;\n+import static org.junit.Assert.*;\n+import static org.mockito.ArgumentCaptor.forClass;\n+import static org.mockito.Mockito.*;\n \n+/**\n+ * This test checks the entry points of the {@link org.eclipse.lsp4j.services.WorkspaceService}\n+ * implementation.\n+ */\n @Slf4j\n public class WorkspaceServiceTest {\n+\n+  /**\n+   * Test of the workspace/executeCommand entry point. Assert that on a MISSING_COPYBOOK the {@link\n+   * RequiredCopybookEvent} is fired.\n+   */\n+  @Test\n+  public void testExecuteCommand() {\n+    DataBusBroker broker = mock(DataBusBroker.class);\n+    ArgumentCaptor<RequiredCopybookEvent> captor = forClass(RequiredCopybookEvent.class);\n+    String copybookName = \"COPYBOOK\";\n+\n+    CobolWorkspaceService service = new CobolWorkspaceServiceImpl(broker, null);\n+\n+    CompletableFuture<Object> result =\n+        service.executeCommand(\n+            new ExecuteCommandParams(\n+                MISSING_COPYBOOK.name(),\n+                asList(new JsonPrimitive(copybookName), new JsonPrimitive(DOCUMENT_URI))));", "originalCommit": "453da429e958184a64ea6b262a687a3ab04f7388", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzNTE2OQ==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/198#discussion_r380135169", "bodyText": "This ExecuteCommandParams has the List<Object> arguments field, and it uses not java objects, but JSONs, that are represented in java as JsonObject or, in case of strings, as JsonPrimitive", "author": "temanbrcom", "createdAt": "2020-02-17T11:44:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA5MTk2NA=="}], "type": "inlineReview", "revised_code": null}]}