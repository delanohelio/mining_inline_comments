{"pr_number": 3799, "pr_title": "Branch will remove TownyWorlds saving a list of towns.", "pr_createdAt": "2020-03-19T17:24:10Z", "pr_url": "https://github.com/TownyAdvanced/Towny/pull/3799", "timeline": [{"oid": "3336b54483a8dedc9e7648856c154851152b10c1", "url": "https://github.com/TownyAdvanced/Towny/commit/3336b54483a8dedc9e7648856c154851152b10c1", "message": "Branch will remove TownyWorlds saving a list of towns.\n\nTowns have changed from town.getWorld() to town.getHomeblockWorld(),\nwith getWorld() becoming deprecated and returning getHomeblockWorld().\n\nSome instances of town.getWorld() are now correctly using\ntownblock.getWorld() or something similar when it is called for.\n\nStop getHomeblockWorld() from returning null when towns have claimed 0\ntownblocks.\n\nTowny.setWorldFlags() from startup sequence is gone.\n\nSQL now drops old towns columns and saves/loads worlds without towns\nlike flatfile.", "committedDate": "2020-03-19T17:21:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjE0MjkzMA==", "url": "https://github.com/TownyAdvanced/Towny/pull/3799#discussion_r396142930", "bodyText": "Is there a particular reason for this deprecation, It seems more intuitive to use Town.getWorld() as opposed to Town.getHomeBlockWorld(), they also essentially do the same thing.", "author": null, "createdAt": "2020-03-22T21:27:48Z", "path": "src/com/palmergames/bukkit/towny/object/Town.java", "diffHunk": "@@ -1483,4 +1485,13 @@ public boolean pay(double amount, String reason) throws EconomyException {\n \tpublic boolean collect(double amount, String reason) throws EconomyException {\n \t\treturn getAccount().collect(amount, reason);\n \t}\n+\t\n+\t/**\n+\t * @deprecated As of 0.96.0.1, please use {@link Town#getHomeblockWorld()} instead.\n+\t */\n+\t@Deprecated\n+\tpublic TownyWorld getWorld() {\n+\t\treturn getHomeblockWorld();\n+\t}\n+\t", "originalCommit": "3336b54483a8dedc9e7648856c154851152b10c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjE0NjEzNQ==", "url": "https://github.com/TownyAdvanced/Towny/pull/3799#discussion_r396146135", "bodyText": "Because the code that uses it is specifically asking for the HomeBlockWorld.", "author": "LlmDl", "createdAt": "2020-03-22T22:00:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjE0MjkzMA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjE0NDEwMw==", "url": "https://github.com/TownyAdvanced/Towny/pull/3799#discussion_r396144103", "bodyText": "Taking into consideration runtime, you're going through every loaded town for !townyWorld.hasTown(town), one recommendation to solve this problem would be using a HashMap<String, Town> in TownyWorld to store towns as the fetch runtime for this data structure is O(1) which is much faster than .contains() which hasTown()uses", "author": null, "createdAt": "2020-03-22T21:39:53Z", "path": "src/com/palmergames/bukkit/towny/db/TownyFlatFileSource.java", "diffHunk": "@@ -1521,6 +1505,9 @@ public boolean loadTownBlocks() {\n \t\t\t\t\t\ttry {\n \t\t\t\t\t\t\tTown town = getTown(line.trim());\n \t\t\t\t\t\t\ttownBlock.setTown(town);\n+\t\t\t\t\t\t\tTownyWorld townyWorld = townBlock.getWorld();\n+\t\t\t\t\t\t\tif (townyWorld != null && !townyWorld.hasTown(town))\n+\t\t\t\t\t\t\t\ttownyWorld.addTown(town);", "originalCommit": "3336b54483a8dedc9e7648856c154851152b10c1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjE0NDIyNQ==", "url": "https://github.com/TownyAdvanced/Towny/pull/3799#discussion_r396144225", "bodyText": "Same comment as above: runtime inefficiency.", "author": null, "createdAt": "2020-03-22T21:41:08Z", "path": "src/com/palmergames/bukkit/towny/db/TownySQLSource.java", "diffHunk": "@@ -1474,6 +1459,9 @@ public boolean loadTownBlocks() {\n                         try {\n                             Town town = getTown(line.trim());\n                             townBlock.setTown(town);\n+                            TownyWorld townyWorld = townBlock.getWorld();\n+                            if (townyWorld != null && !townyWorld.hasTown(town))\n+                            \ttownyWorld.addTown(town);", "originalCommit": "3336b54483a8dedc9e7648856c154851152b10c1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "693414d1377db1c6cfd05efbfd2b36e10ed9b04e", "url": "https://github.com/TownyAdvanced/Towny/commit/693414d1377db1c6cfd05efbfd2b36e10ed9b04e", "message": "Swap out the List version of towns in TownyWorld for a HashMap, for\nfaster loading of TownBlocks", "committedDate": "2020-03-23T12:28:52Z", "type": "commit"}, {"oid": "6870e97462e1568815164c520bf2faa0fffa27c5", "url": "https://github.com/TownyAdvanced/Towny/commit/6870e97462e1568815164c520bf2faa0fffa27c5", "message": "Remove unneeded loop.", "committedDate": "2020-03-23T12:43:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQxOTI2NA==", "url": "https://github.com/TownyAdvanced/Towny/pull/3799#discussion_r396419264", "bodyText": "This should be simplified to return towns.containsKey(name);", "author": null, "createdAt": "2020-03-23T12:38:48Z", "path": "src/com/palmergames/bukkit/towny/object/TownyWorld.java", "diffHunk": "@@ -70,23 +72,23 @@ public boolean hasTowns() {\n \r\n \tpublic boolean hasTown(String name) {\r\n \r\n-\t\tfor (Town town : towns)\r\n-\t\t\tif (town.getName().equalsIgnoreCase(name))\r\n+\t\tfor (Map.Entry<String, Town> mapElement : towns.entrySet())\r\n+\t\t\tif (mapElement.getKey().equalsIgnoreCase(name))\r\n \t\t\t\treturn true;\r\n \t\treturn false;\r", "originalCommit": "693414d1377db1c6cfd05efbfd2b36e10ed9b04e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6870e97462e1568815164c520bf2faa0fffa27c5", "chunk": "diff --git a/src/com/palmergames/bukkit/towny/object/TownyWorld.java b/src/com/palmergames/bukkit/towny/object/TownyWorld.java\nindex 6e41bb434..362bb846d 100644\n--- a/src/com/palmergames/bukkit/towny/object/TownyWorld.java\n+++ b/src/com/palmergames/bukkit/towny/object/TownyWorld.java\n\n@@ -72,15 +72,12 @@ public class TownyWorld extends TownyObject {\n \n \tpublic boolean hasTown(String name) {\n \n-\t\tfor (Map.Entry<String, Town> mapElement : towns.entrySet())\n-\t\t\tif (mapElement.getKey().equalsIgnoreCase(name))\n-\t\t\t\treturn true;\n-\t\treturn false;\n+\t\treturn towns.containsKey(name);\n \t}\n \n \tpublic boolean hasTown(Town town) {\n \n-\t\treturn towns.containsKey(town.getName());\n+\t\treturn hasTown(town.getName());\n \t}\n \n \tpublic void addTown(Town town) throws AlreadyRegisteredException {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQyMTQ3Nw==", "url": "https://github.com/TownyAdvanced/Towny/pull/3799#discussion_r396421477", "bodyText": "This should be changed to for (Town town : getTowns.values()) as the key in the Map.Entry is never used.", "author": null, "createdAt": "2020-03-23T12:42:33Z", "path": "src/com/palmergames/bukkit/towny/object/TownyWorld.java", "diffHunk": "@@ -645,21 +647,22 @@ public int getMinDistanceFromOtherTowns(Coord key) {\n \tpublic int getMinDistanceFromOtherTowns(Coord key, Town homeTown) {\r\n \r\n \t\tdouble min = Integer.MAX_VALUE;\r\n-\t\tfor (Town town : getTowns())\r\n+\t\tfor (Map.Entry<String, Town> mapElement : getTowns().entrySet()) {\r", "originalCommit": "693414d1377db1c6cfd05efbfd2b36e10ed9b04e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3760c36a00479e872d6443aa70565ad193227635", "chunk": "diff --git a/src/com/palmergames/bukkit/towny/object/TownyWorld.java b/src/com/palmergames/bukkit/towny/object/TownyWorld.java\nindex 6e41bb434..e05646ef9 100644\n--- a/src/com/palmergames/bukkit/towny/object/TownyWorld.java\n+++ b/src/com/palmergames/bukkit/towny/object/TownyWorld.java\n\n@@ -647,8 +643,7 @@ public class TownyWorld extends TownyObject {\n \tpublic int getMinDistanceFromOtherTowns(Coord key, Town homeTown) {\n \n \t\tdouble min = Integer.MAX_VALUE;\n-\t\tfor (Map.Entry<String, Town> mapElement : getTowns().entrySet()) {\n-\t\t\tTown town = mapElement.getValue();\n+\t\tfor (Town town : getTowns().values()) {\n \t\t\ttry {\n \t\t\t\tCoord townCoord = town.getHomeBlock().getCoord();\n \t\t\t\tif (homeTown != null)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQyMTY1MA==", "url": "https://github.com/TownyAdvanced/Towny/pull/3799#discussion_r396421650", "bodyText": "same issue as above", "author": null, "createdAt": "2020-03-23T12:42:54Z", "path": "src/com/palmergames/bukkit/towny/object/TownyWorld.java", "diffHunk": "@@ -684,7 +687,8 @@ public int getMinDistanceFromOtherTownsPlots(Coord key) {\n \tpublic int getMinDistanceFromOtherTownsPlots(Coord key, Town homeTown) {\r\n \r\n \t\tdouble min = Integer.MAX_VALUE;\r\n-\t\tfor (Town town : getTowns())\r\n+\t\tfor (Map.Entry<String, Town> mapElement : getTowns().entrySet()) {\r", "originalCommit": "693414d1377db1c6cfd05efbfd2b36e10ed9b04e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3760c36a00479e872d6443aa70565ad193227635", "chunk": "diff --git a/src/com/palmergames/bukkit/towny/object/TownyWorld.java b/src/com/palmergames/bukkit/towny/object/TownyWorld.java\nindex 6e41bb434..e05646ef9 100644\n--- a/src/com/palmergames/bukkit/towny/object/TownyWorld.java\n+++ b/src/com/palmergames/bukkit/towny/object/TownyWorld.java\n\n@@ -687,8 +682,7 @@ public class TownyWorld extends TownyObject {\n \tpublic int getMinDistanceFromOtherTownsPlots(Coord key, Town homeTown) {\n \n \t\tdouble min = Integer.MAX_VALUE;\n-\t\tfor (Map.Entry<String, Town> mapElement : getTowns().entrySet()) {\n-\t\t\tTown town = mapElement.getValue();\n+\t\tfor (Town town : getTowns().values()) {\n \t\t\ttry {\n \t\t\t\tif (homeTown != null)\n \t\t\t\t\tif (homeTown.getHomeBlock().equals(town.getHomeBlock()))\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQyMTc0MA==", "url": "https://github.com/TownyAdvanced/Towny/pull/3799#discussion_r396421740", "bodyText": "same issue as above", "author": null, "createdAt": "2020-03-23T12:43:04Z", "path": "src/com/palmergames/bukkit/towny/object/TownyWorld.java", "diffHunk": "@@ -715,7 +719,8 @@ public int getMinDistanceFromOtherTownsPlots(Coord key, Town homeTown) {\n \tpublic Town getClosestTownFromCoord(Coord key, Town nearestTown) {\r\n \t\t\r\n \t\tdouble min = Integer.MAX_VALUE;\r\n-\t\tfor (Town town : getTowns()) {\r\n+\t\tfor (Map.Entry<String, Town> mapElement : getTowns().entrySet()) {\r", "originalCommit": "693414d1377db1c6cfd05efbfd2b36e10ed9b04e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3760c36a00479e872d6443aa70565ad193227635", "chunk": "diff --git a/src/com/palmergames/bukkit/towny/object/TownyWorld.java b/src/com/palmergames/bukkit/towny/object/TownyWorld.java\nindex 6e41bb434..e05646ef9 100644\n--- a/src/com/palmergames/bukkit/towny/object/TownyWorld.java\n+++ b/src/com/palmergames/bukkit/towny/object/TownyWorld.java\n\n@@ -719,8 +713,7 @@ public class TownyWorld extends TownyObject {\n \tpublic Town getClosestTownFromCoord(Coord key, Town nearestTown) {\n \t\t\n \t\tdouble min = Integer.MAX_VALUE;\n-\t\tfor (Map.Entry<String, Town> mapElement : getTowns().entrySet()) {\n-\t\t\tTown town = mapElement.getValue();\n+\t\tfor (Town town : getTowns().values()) {\n \t\t\tfor (TownBlock b : town.getTownBlocks()) {\n \t\t\t\tif (!b.getWorld().equals(this)) continue;\n \t\t\t\t\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQyMTg1OQ==", "url": "https://github.com/TownyAdvanced/Towny/pull/3799#discussion_r396421859", "bodyText": "same issue as above", "author": null, "createdAt": "2020-03-23T12:43:17Z", "path": "src/com/palmergames/bukkit/towny/object/TownyWorld.java", "diffHunk": "@@ -740,7 +745,8 @@ public Town getClosestTownFromCoord(Coord key, Town nearestTown) {\n \tpublic Town getClosestTownWithNationFromCoord(Coord key, Town nearestTown) {\r\n \t\t\r\n \t\tdouble min = Integer.MAX_VALUE;\r\n-\t\tfor (Town town : getTowns()) {\r\n+\t\tfor (Map.Entry<String, Town> mapElement : getTowns().entrySet()) {\r", "originalCommit": "693414d1377db1c6cfd05efbfd2b36e10ed9b04e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3760c36a00479e872d6443aa70565ad193227635", "chunk": "diff --git a/src/com/palmergames/bukkit/towny/object/TownyWorld.java b/src/com/palmergames/bukkit/towny/object/TownyWorld.java\nindex 6e41bb434..e05646ef9 100644\n--- a/src/com/palmergames/bukkit/towny/object/TownyWorld.java\n+++ b/src/com/palmergames/bukkit/towny/object/TownyWorld.java\n\n@@ -745,8 +738,7 @@ public class TownyWorld extends TownyObject {\n \tpublic Town getClosestTownWithNationFromCoord(Coord key, Town nearestTown) {\n \t\t\n \t\tdouble min = Integer.MAX_VALUE;\n-\t\tfor (Map.Entry<String, Town> mapElement : getTowns().entrySet()) {\n-\t\t\tTown town = mapElement.getValue();\n+\t\tfor (Town town : getTowns().values()) {\n \t\t\tif (!town.hasNation()) continue;\n \t\t\tfor (TownBlock b : town.getTownBlocks()) {\n \t\t\t\tif (!b.getWorld().equals(this)) continue;\n"}}, {"oid": "3760c36a00479e872d6443aa70565ad193227635", "url": "https://github.com/TownyAdvanced/Towny/commit/3760c36a00479e872d6443aa70565ad193227635", "message": "Fix up for loops.", "committedDate": "2020-03-23T13:57:25Z", "type": "commit"}, {"oid": "3760c36a00479e872d6443aa70565ad193227635", "url": "https://github.com/TownyAdvanced/Towny/commit/3760c36a00479e872d6443aa70565ad193227635", "message": "Fix up for loops.", "committedDate": "2020-03-23T13:57:25Z", "type": "forcePushed"}, {"oid": "180dd78f316df163027ed437c1532295aad366af", "url": "https://github.com/TownyAdvanced/Towny/commit/180dd78f316df163027ed437c1532295aad366af", "message": "Fix pvp disabled worlds still be affected with recent change to\nCombatUtil#preventPVP.", "committedDate": "2020-03-23T21:42:53Z", "type": "commit"}]}