{"pr_number": 4472, "pr_title": "SiegeWar Permission fix up", "pr_createdAt": "2020-11-26T15:36:06Z", "pr_url": "https://github.com/TownyAdvanced/Towny/pull/4472", "timeline": [{"oid": "eda8ed45f6ad774877e6f055e58153cd1449b2dc", "url": "https://github.com/TownyAdvanced/Towny/commit/eda8ed45f6ad774877e6f055e58153cd1449b2dc", "message": "Permission fix up\n\n- Removes nearly all SW changes to Towny's permissions package.\n\n- Creates SiegeWarPermissionUtil\n  - Holds the two methods which may or may not be needed in the end.\n- Creates SiegeWarPermissionNodes enum.\n  - All new SW nodes (except the Town toggle peaceful node which will be\nput into Towny proper.)\n- Removes PermissionSource.has(Resident, Node)\n  - Replaced calls with the correct PermissionSource.has(Player, String)\n- Removed called to PermissionSource.testPermission().\n  - Replaced calls with the correct PermissionSource.has(Player, String)\n- Removed wildcard imports as they were found.", "committedDate": "2020-11-26T16:41:06Z", "type": "commit"}, {"oid": "8ff4c358df50cb3e830c397645ebf322db484380", "url": "https://github.com/TownyAdvanced/Towny/commit/8ff4c358df50cb3e830c397645ebf322db484380", "message": "- Missed wildcard import.", "committedDate": "2020-11-26T16:41:06Z", "type": "commit"}, {"oid": "8ff4c358df50cb3e830c397645ebf322db484380", "url": "https://github.com/TownyAdvanced/Towny/commit/8ff4c358df50cb3e830c397645ebf322db484380", "message": "- Missed wildcard import.", "committedDate": "2020-11-26T16:41:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTExOTQyNQ==", "url": "https://github.com/TownyAdvanced/Towny/pull/4472#discussion_r531119425", "bodyText": "If TownPeacefulnessUtil is going to stay in Towny, shouldn't the associated permission stay under Towny as well?", "author": "docwhomc", "createdAt": "2020-11-26T15:58:54Z", "path": "src/com/palmergames/bukkit/towny/utils/TownPeacefulnessUtil.java", "diffHunk": "@@ -89,7 +97,7 @@ public static void punishPeacefulPlayersInActiveSiegeZones() {\n \t\t\t\t\tcontinue;\n \n \t\t\t\t//Dont apply if player has the immunity perm\n-\t\t\t\tif (TownyUniverse.getInstance().getPermissionSource().testPermission(player, PermissionNodes.TOWNY_SIEGE_WAR_IMMUNE_TO_WAR_NAUSEA.getNode()))\n+\t\t\t\tif (TownyUniverse.getInstance().getPermissionSource().has(player, SiegeWarPermissionNodes.TOWNY_SIEGE_WAR_IMMUNE_TO_WAR_NAUSEA.getNode()))", "originalCommit": "26815aaa2438a81da9d1e4a32d81bfe6582fef74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE2MzUxOA==", "url": "https://github.com/TownyAdvanced/Towny/pull/4472#discussion_r531163518", "bodyText": "I haven't taken a close enough look at the TownPeacefullnessUtil to see what use it will have in the future. For now it is SW exclusive.", "author": "LlmDl", "createdAt": "2020-11-26T17:32:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTExOTQyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE2Njk2OQ==", "url": "https://github.com/TownyAdvanced/Towny/pull/4472#discussion_r531166969", "bodyText": "Since the force push messed up the links, I've recommenced on the new version of the code (here) for reference.", "author": "docwhomc", "createdAt": "2020-11-26T17:41:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTExOTQyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE2NzE5OQ==", "url": "https://github.com/TownyAdvanced/Towny/pull/4472#discussion_r531167199", "bodyText": "I haven't taken a close enough look at the TownPeacefullnessUtil to see what use it will have in the future. For now it is SW exclusive.\n\nFair enough.", "author": "docwhomc", "createdAt": "2020-11-26T17:42:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTExOTQyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE2NzcxNg==", "url": "https://github.com/TownyAdvanced/Towny/pull/4472#discussion_r531167716", "bodyText": "This is a SW node, so the code that uses it will likely end up apart from the TownPeacefullnessUtil (if the util stays in the towny/utils package at all.", "author": "LlmDl", "createdAt": "2020-11-26T17:44:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTExOTQyNQ=="}], "type": "inlineReview", "revised_code": {"commit": "eda8ed45f6ad774877e6f055e58153cd1449b2dc", "chunk": "diff --git a/src/com/palmergames/bukkit/towny/utils/TownPeacefulnessUtil.java b/src/com/palmergames/bukkit/towny/utils/TownPeacefulnessUtil.java\nindex 95feefa1..0be17f1a 100644\n--- a/src/com/palmergames/bukkit/towny/utils/TownPeacefulnessUtil.java\n+++ b/src/com/palmergames/bukkit/towny/utils/TownPeacefulnessUtil.java\n\n@@ -97,7 +93,7 @@ public class TownPeacefulnessUtil {\n \t\t\t\t\tcontinue;\n \n \t\t\t\t//Dont apply if player has the immunity perm\n-\t\t\t\tif (TownyUniverse.getInstance().getPermissionSource().has(player, SiegeWarPermissionNodes.TOWNY_SIEGE_WAR_IMMUNE_TO_WAR_NAUSEA.getNode()))\n+\t\t\t\tif (TownyUniverse.getInstance().getPermissionSource().testPermission(player, SiegeWarPermissionNodes.TOWNY_SIEGE_WAR_IMMUNE_TO_WAR_NAUSEA.getNode()))\n \t\t\t\t\tcontinue;\n \n \t\t\t\t//Don't apply to non-peaceful players\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTEzOTY0Nw==", "url": "https://github.com/TownyAdvanced/Towny/pull/4472#discussion_r531139647", "bodyText": "This call to PermissionSource#has(Player, String) used to be a call to PermissionSource#testPermission(Player, String).", "author": "docwhomc", "createdAt": "2020-11-26T16:38:17Z", "path": "src/com/palmergames/bukkit/towny/command/TownyAdminCommand.java", "diffHunk": "@@ -1527,7 +1528,7 @@ public void adminSet(String[] split) throws TownyException {\n \t\t\t}\r\n \r\n \t\t} else if (split[0].equalsIgnoreCase(\"siegeimmunities\")) {\r\n-\t\t\tif (!townyUniverse.getPermissionSource().testPermission(player, PermissionNodes.TOWNY_COMMAND_TOWNYADMIN_SET_SIEGEIMMUNITIES.getNode(split[0].toLowerCase())))\r\n+\t\t\tif (!townyUniverse.getPermissionSource().has(player, SiegeWarPermissionNodes.TOWNY_COMMAND_TOWNYADMIN_SET_SIEGEIMMUNITIES.getNode(split[0].toLowerCase())))\r", "originalCommit": "26815aaa2438a81da9d1e4a32d81bfe6582fef74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE2MTY1MA==", "url": "https://github.com/TownyAdvanced/Towny/pull/4472#discussion_r531161650", "bodyText": "Resolved by force push from 6cec795 to 8ff4c35.\nSee also comment regarding commit message of eda8ed4 (parent of 8ff4c35) below.", "author": "docwhomc", "createdAt": "2020-11-26T17:27:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTEzOTY0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "eda8ed45f6ad774877e6f055e58153cd1449b2dc", "chunk": "diff --git a/src/com/palmergames/bukkit/towny/command/TownyAdminCommand.java b/src/com/palmergames/bukkit/towny/command/TownyAdminCommand.java\nindex 8dcced02..b90918a9 100644\n--- a/src/com/palmergames/bukkit/towny/command/TownyAdminCommand.java\n+++ b/src/com/palmergames/bukkit/towny/command/TownyAdminCommand.java\n\n@@ -1528,7 +1528,7 @@ public class TownyAdminCommand extends BaseCommand implements CommandExecutor {\n \t\t\t}\n \n \t\t} else if (split[0].equalsIgnoreCase(\"siegeimmunities\")) {\n-\t\t\tif (!townyUniverse.getPermissionSource().has(player, SiegeWarPermissionNodes.TOWNY_COMMAND_TOWNYADMIN_SET_SIEGEIMMUNITIES.getNode(split[0].toLowerCase())))\n+\t\t\tif (!townyUniverse.getPermissionSource().testPermission(player, SiegeWarPermissionNodes.TOWNY_COMMAND_TOWNYADMIN_SET_SIEGEIMMUNITIES.getNode(split[0].toLowerCase())))\n \t\t\t\tthrow new TownyException(Translation.of(\"msg_err_command_disable\"));\n \n \t\t\tif (split.length == 4 && split[1].equalsIgnoreCase(\"town\")) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE1MDE0Nw==", "url": "https://github.com/TownyAdvanced/Towny/pull/4472#discussion_r531150147", "bodyText": "What are these used for?", "author": "docwhomc", "createdAt": "2020-11-26T17:00:52Z", "path": "src/com/palmergames/bukkit/towny/war/siegewar/enums/SiegeWarPermissionNodes.java", "diffHunk": "@@ -0,0 +1,56 @@\n+package com.palmergames.bukkit.towny.war.siegewar.enums;\r\n+\r\n+public enum SiegeWarPermissionNodes {\r\n+\r\n+\tTOWNY_NATION_SIEGE_POINTS(\"towny.nation.siege.points\"),\r\n+\tTOWNY_NATION_SIEGE_LEADERSHIP(\"towny.nation.siege.leadership\"),\r\n+\tTOWNY_NATION_SIEGE_ATTACK(\"towny.nation.siege.attack\"),\r\n+\tTOWNY_NATION_SIEGE_ABANDON(\"towny.nation.siege.abandon\"),\r\n+\tTOWNY_NATION_SIEGE_INVADE(\"towny.nation.siege.invade\"),\r\n+\tTOWNY_NATION_SIEGE_PLUNDER(\"towny.nation.siege.plunder\"),\r\n+\tTOWNY_TOWN_SIEGE_POINTS(\"towny.town.siege.points\"),\r\n+\tTOWNY_TOWN_SIEGE_SURRENDER(\"towny.town.siege.surrender\"),\r\n+\tTOWNY_COMMAND_TOWNYADMIN_SET_SIEGEIMMUNITIES(\"towny.command.townyadmin.set.siegeimmunities\"),\r\n+\t// Siegewar related war sickness immunities\r\n+\tTOWNY_SIEGE_WAR_IMMUNE_TO_WAR_NAUSEA(\"towny.siege.war.immune.to.war.nausea\"),\r\n+\tTOWNY_SIEGE_WAR_IMMUNE_TO_BATTLE_FATIGUE(\"towny.siege.war.immune.to.battle.fatigue\");\r\n+\t\r\n+\tprivate String value;\r\n+\r\n+\t/**\r\n+\t * Constructor\r\n+\t * \r\n+\t * @param permission - Permission.\r\n+\t */\r\n+\tSiegeWarPermissionNodes(String permission) {\r\n+\r\n+\t\tthis.value = permission;\r\n+\t}\r\n+\r\n+\t/**\r\n+\t * Retrieves the permission node\r\n+\t * \r\n+\t * @return The permission node\r\n+\t */\r\n+\tpublic String getNode() {\r\n+\r\n+\t\treturn value;\r\n+\t}\r\n+\r\n+\t/**\r\n+\t * Retrieves the permission node\r\n+\t * replacing the character *\r\n+\t * \r\n+\t * @param replace - String\r\n+\t * @return The permission node\r\n+\t */\r\n+\tpublic String getNode(String replace) {\r\n+\r\n+\t\treturn value.replace(\"*\", replace);\r\n+\t}\r\n+\r\n+\tpublic String getNode(int replace) {\r\n+\r\n+\t\treturn value.replace(\"*\", replace + \"\");\r\n+\t}\r\n+}\r", "originalCommit": "8ff4c358df50cb3e830c397645ebf322db484380", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE2Mzk5Nw==", "url": "https://github.com/TownyAdvanced/Towny/pull/4472#discussion_r531163997", "bodyText": "This is part of PermissionNodes.java which has some uses, but none apply to SW atm.", "author": "LlmDl", "createdAt": "2020-11-26T17:33:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE1MDE0Nw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE2NjE4NA==", "url": "https://github.com/TownyAdvanced/Towny/pull/4472#discussion_r531166184", "bodyText": "If TownPeacefulnessUtil is going to stay in Towny, shouldn't the associated permission stay under Towny as well?\n\n[See previous comment on pre-force push version of code.]", "author": "docwhomc", "createdAt": "2020-11-26T17:39:43Z", "path": "src/com/palmergames/bukkit/towny/utils/TownPeacefulnessUtil.java", "diffHunk": "@@ -89,7 +97,7 @@ public static void punishPeacefulPlayersInActiveSiegeZones() {\n \t\t\t\t\tcontinue;\n \n \t\t\t\t//Dont apply if player has the immunity perm\n-\t\t\t\tif (TownyUniverse.getInstance().getPermissionSource().testPermission(player, PermissionNodes.TOWNY_SIEGE_WAR_IMMUNE_TO_WAR_NAUSEA.getNode()))\n+\t\t\t\tif (TownyUniverse.getInstance().getPermissionSource().testPermission(player, SiegeWarPermissionNodes.TOWNY_SIEGE_WAR_IMMUNE_TO_WAR_NAUSEA.getNode()))", "originalCommit": "8ff4c358df50cb3e830c397645ebf322db484380", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE2Nzg2NA==", "url": "https://github.com/TownyAdvanced/Towny/pull/4472#discussion_r531167864", "bodyText": "#4472 (comment)", "author": "LlmDl", "createdAt": "2020-11-26T17:44:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE2NjE4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE2ODAwOQ==", "url": "https://github.com/TownyAdvanced/Towny/pull/4472#discussion_r531168009", "bodyText": "Resolved in original thread for this change.", "author": "docwhomc", "createdAt": "2020-11-26T17:44:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE2NjE4NA=="}], "type": "inlineReview", "revised_code": null}]}