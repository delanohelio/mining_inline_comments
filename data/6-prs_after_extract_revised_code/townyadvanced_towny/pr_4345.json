{"pr_number": 4345, "pr_title": "Dragon Fireball Damage handling.", "pr_createdAt": "2020-09-28T16:44:58Z", "pr_url": "https://github.com/TownyAdvanced/Towny/pull/4345", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjExMDM5Nw==", "url": "https://github.com/TownyAdvanced/Towny/pull/4345#discussion_r496110397", "bodyText": "I would cancel and do event.getEntity().remove() this way the same checks aren't being done every 5 ticks.", "author": "creatorfromhell", "createdAt": "2020-09-28T17:16:20Z", "path": "src/com/palmergames/bukkit/towny/listeners/TownyEntityListener.java", "diffHunk": "@@ -375,6 +378,39 @@ public void onEntityDamageByEntityEvent(EntityDamageByEntityEvent event) {\n \t\t\t\r\n \t}\r\n \r\n+\t/**\r\n+\t * Handles dragon fireball's cloud damage to players.\r\n+\t * \r\n+\t * @param event AreaEffectCloudApplyEvent\r\n+\t */\r\n+\t@EventHandler(priority = EventPriority.HIGH, ignoreCancelled = true)\r\n+\tpublic void onDragonFireBallCloudDamage(AreaEffectCloudApplyEvent event) {\r\n+\t\tif (!TownyAPI.getInstance().isTownyWorld(event.getEntity().getWorld()))\r\n+\t\t\treturn;\r\n+\t\t\r\n+\t\tif (!event.getEntity().getBasePotionData().getType().equals(PotionType.UNCRAFTABLE))\r\n+\t\t\treturn;\r\n+\r\n+\t\tif (!(event.getEntity().getSource() instanceof Player) || !(event.getEntity().getSource() instanceof DragonFireball))\r\n+\t\t\treturn;\r\n+\r\n+\t\tList<LivingEntity> entities = event.getAffectedEntities();\r\n+\r\n+\t\tTownyWorld townyWorld = null;\r\n+\t\ttry {\r\n+\t\t\ttownyWorld = TownyUniverse.getInstance().getDataSource().getWorld(event.getEntity().getWorld().getName());\r\n+\t\t} catch (NotRegisteredException e) {\r\n+\t\t\t// Failed to fetch a world\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\t\t\r\n+\t\tfor (LivingEntity entity : entities) {\r\n+\t\t\tTownBlock townBlock = TownyAPI.getInstance().getTownBlock(entity.getLocation());\r\n+\t\t\tif (CombatUtil.preventPvP(townyWorld, townBlock)) {\r\n+\t\t\t\tevent.setCancelled(true);\r", "originalCommit": "b6942303fa1c2ef69d023fa57d7465ac4d4d0491", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjEyODM0Nw==", "url": "https://github.com/TownyAdvanced/Towny/pull/4345#discussion_r496128347", "bodyText": "Yeah, not all entities might be immune from the cloud though, some could be in a PVP-enabled area.", "author": "LlmDl", "createdAt": "2020-09-28T17:48:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjExMDM5Nw=="}], "type": "inlineReview", "revised_code": {"commit": "e6cdbec3355ace2f4d345202636a0ba64df66e27", "chunk": "diff --git a/src/com/palmergames/bukkit/towny/listeners/TownyEntityListener.java b/src/com/palmergames/bukkit/towny/listeners/TownyEntityListener.java\nindex b3c4dca7..ae25dabe 100644\n--- a/src/com/palmergames/bukkit/towny/listeners/TownyEntityListener.java\n+++ b/src/com/palmergames/bukkit/towny/listeners/TownyEntityListener.java\n\n@@ -252,130 +262,32 @@ public class TownyEntityListener implements Listener {\n \t\t\t\tif (!TownyAPI.getInstance().getTownBlock(loc).hasResident())\n \t\t\t\t\treturn;\t\n \n-\t\t\t\tPlayer target = (Player)event.getTarget();\n-\t\t\t\tif (!PlayerCacheUtil.getCachePermission(target, loc, Material.DIRT, TownyPermission.ActionType.DESTROY)) {\n-\t\t\t\t\tevent.setCancelled(true);\n-\t\t\t\t}\n+\t\t\t\t//Make decision on whether this is allowed using the PlayerCache and then a cancellable event.\n+\t\t\t\tevent.setCancelled(!TownyActionEventExecutor.canDestroy((Player) event.getTarget(), loc, Material.DIRT));\n \t\t\t}\n \t\t}\n \t}\n \t\n \t/**\n-\t * Prevent explosions from hurting non-living entities in towns.\n-\t * Includes: Armorstands, itemframes, animals, endercrystals, minecarts\n+\t * Prevent explosions from hurting entities.\n \t * \n-\t * Prevent explosions from hurting players if Event War is active and\n-\t * WarzoneBlockPermissions' explosions tag is set to true.\n-\t * \n-\t * @param event - EntityDamageByEntityEvent\n+\t * Doesn't stop damage to vehicles or hanging entities.\n+\t *  \n+\t * @param event - EntityDamageEvent\n \t */\n \t@EventHandler(priority = EventPriority.LOWEST, ignoreCancelled = true)\n-\tpublic void onEntityDamageByEntityEvent(EntityDamageByEntityEvent event) {\n+\tpublic void onEntityTakesExplosionDamage(EntityDamageEvent event) {\n \t\tif (plugin.isError()) {\n \t\t\t\treturn;\n \t\t}\n \t\t\n-\t\tTownyUniverse townyUniverse = TownyUniverse.getInstance();\n-\t\tTownyWorld townyWorld = null;\n-\t\t\n-\t\tEntity entity = event.getEntity();\t\t\n-\t\tString damager = event.getDamager().getType().name();\n-\t\t\n-\t\ttry {\n-\t\t\ttownyWorld = townyUniverse.getDataSource().getWorld(entity.getWorld().getName());\n-\t\t} catch (NotRegisteredException e) {\n-\t\t\te.printStackTrace();\n-\t\t}\n-\t\t\n-\t\t// Event War's WarzoneBlockPermissions explosions: option. Prevents damage from the explosion.  \n-\t\tif (TownyAPI.getInstance().isWarTime() && !WarZoneConfig.isAllowingExplosionsInWarZone() && entity instanceof Player && damager.equals(\"PRIMED_TNT\"))\n-\t\t\tevent.setCancelled(true);\t\t\t\n-\t\t\n-\t\tTownyMessaging.sendDebugMsg(\"EntityDamageByEntityEvent : entity = \" + entity);\n-\t\tTownyMessaging.sendDebugMsg(\"EntityDamageByEntityEvent : damager = \" + damager);\n-\t\t\n-\t\t// Entities requiring special protection.\n-\t\tif (entity instanceof ArmorStand || entity instanceof ItemFrame || entity instanceof EnderCrystal \n-\t\t\t\t|| (TownySettings.getEntityTypes().contains(\"Animals\") && entity instanceof Animals) // Only protect these entities if servers specifically add them to the protections.\n-\t\t\t\t|| (TownySettings.getEntityTypes().contains(\"Villager\") && entity instanceof Villager) // Only protect these entities if servers specifically add them to the protections.\n-\t\t\t\t){\n-\t\t\t\n-\t\t\t// Handle exploding causes of damage.\n-\t\t    if (damager.equals(\"PRIMED_TNT\") || damager.equals(\"MINECART_TNT\") || damager.equals(\"WITHER_SKULL\") || damager.equals(\"FIREBALL\") ||\n-                damager.equals(\"SMALL_FIREBALL\") || damager.equals(\"LARGE_FIREBALL\") || damager.equals(\"WITHER\") || damager.equals(\"CREEPER\") || damager.equals(\"FIREWORK\")) {\n-\t\t\t\t\t\t\t\t\n-\t\t\t\tif (!locationCanExplode(townyWorld, entity.getLocation())) {\n-\t\t\t\t\tevent.setCancelled(true);\n-\t\t\t\t\treturn;\n-\t\t\t\t} else {\n-\t\t\t\t\treturn;\n-\t\t\t\t}\n-\t\t\t}\n-\t\t    \n-\t\t    if (damager.equals(\"LIGHTNING\")) {\n-\t\t    \t// Other than natural causes, as of the introduction of Tridents with the Channeling enchantment,\n-\t\t    \t// lightning can be summoned by anyone at anything. Until we can discern the cause of the lightning\n-\t\t    \t// we will block all damage to the above entities requiring special protection.\n-\t\t    \t// Note 1: Some day we might be able to get the cause of the lightning.\n-\t\t\t\tif (!locationCanExplode(townyWorld, entity.getLocation())) {\n-\t\t\t\t\tevent.setDamage(0);\n-\t\t\t\t\tevent.setCancelled(true);\n-\t\t\t\t\treturn;\n-\t\t\t\t} else {\n-\t\t\t\t\treturn;\n-\t\t\t\t}\n-\t\t    }\n-\n-\t\t    // Handle arrows and projectiles that do not explode.\n-\t\t\tif (event.getDamager() instanceof Projectile) {\n-\t\t\t\t\n-\t\t\t\ttry {\n-\t\t\t\t\ttownyWorld = townyUniverse.getDataSource().getWorld(entity.getWorld().getName());\n-\t\t\t\t} catch (NotRegisteredException e) {\n-\t\t\t\t\te.printStackTrace();\n-\t\t\t\t}\n-\t\t\t\tObject remover = event.getDamager();\n-\t\t\t\tremover = ((Projectile) remover).getShooter();\n-\t\t\t\tif (remover instanceof Monster) {\n-\t\t\t\t\tevent.setCancelled(true);\t\n-\t\t\t\t} else if (remover instanceof Player) {\n-\t\t\t\t\tPlayer player = (Player) remover;\n-\t\t\t\t\tif (TownyAPI.getInstance().isWilderness(entity.getLocation()))\n-\t\t\t\t\t\treturn;\n-\t\t\t\n-\t\t\t\t\t// Get destroy permissions (updates if none exist)\n-\t\t\t\t\t//boolean bDestroy = PlayerCacheUtil.getCachePermission(player, entity.getLocation(), 416, (byte) 0, TownyPermission.ActionType.DESTROY);\n-\t\t\t\t\tboolean bDestroy = PlayerCacheUtil.getCachePermission(player, entity.getLocation(), Material.ARMOR_STAND, TownyPermission.ActionType.DESTROY);\n-\n-\t\t\t\t\t// Allow the removal if we are permitted\n-\t\t\t\t\tif (bDestroy)\n-\t\t\t\t\t\treturn;\n+\t\tif (!TownyAPI.getInstance().isTownyWorld(event.getEntity().getWorld()))\n+\t\t\treturn;\n \n-\t\t\t\t\tevent.setCancelled(true);\n-\t\t\t\t}\n-\t\t\t}\n-\t\t\t\n-\t\t\t// Handle player causes against entities that should be protected.\n-\t\t\tif (event.getDamager() instanceof Player) {\n-\t\t\t\tPlayer player = (Player) event.getDamager();\n-\t\t\t\tboolean bDestroy = false;\n-\t\t\t\tif (entity instanceof EnderCrystal) {\n-\t\t\t\t\t// Test if a player can break a grass block here.\n-\t\t\t\t\tbDestroy = PlayerCacheUtil.getCachePermission(player, entity.getLocation(), Material.GRASS, TownyPermission.ActionType.DESTROY);\n-\t\t\t\t\t// If destroying is allowed then return before we cancel.\n-\t\t\t\t\tif (bDestroy)\n-\t\t\t\t\t\treturn;\n-\t\t\t\t\t// Not able to destroy grass so we cancel event.\n-\t\t\t\t\tevent.setCancelled(true);\n-\t\t\t\t}\n-\t\t\t}\n+\t\tif ((event.getCause() == DamageCause.BLOCK_EXPLOSION || event.getCause() == DamageCause.ENTITY_EXPLOSION || event.getCause() == DamageCause.LIGHTNING) && !TownyActionEventExecutor.canExplosionDamageEntities(event.getEntity().getLocation(), event.getEntity(), event.getCause())) {\n+\t\t\tevent.setDamage(0);\n+\t\t\tevent.setCancelled(true);\n \t\t}\n-\t\t// As of July 25, 2019 there is no way to get shooter of firework via crossbow.\n-\t\t// TODO: Check back here https://hub.spigotmc.org/jira/browse/SPIGOT-5201\n-\t\tif (damager.equals(\"FIREWORK\"))\n-\t\t\tif (!locationCanExplode(townyWorld, entity.getLocation()) || CombatUtil.preventPvP(townyWorld, TownyAPI.getInstance().getTownBlock(entity.getLocation())))\n-\t\t\t\tevent.setCancelled(true);\n-\t\t\t\n \t}\n \n \t/**\n"}}, {"oid": "e6cdbec3355ace2f4d345202636a0ba64df66e27", "url": "https://github.com/TownyAdvanced/Towny/commit/e6cdbec3355ace2f4d345202636a0ba64df66e27", "message": "Dragon Fireball Damage handling.\n\n - Potential solution for #4100.\n - Not ideal.\n - So far I have not found a way to handle Dragon Fireballs better.\n - They fire a ProjectileHitEvent which cannot be cancelled.\n - They generate an AreaEffectCloud which only returns the type\nUNCRAFTABLE.\n - The only way so far is to listen for the AreaEffectCloudApplyEvent\nand if it is UNCRAFTABLE, check the hurt entities one by one using the\nCombatUtil.\n - As this is technically a mob damage, it shouldn't really be\nconsidered PVP (arrows fired by a skeleton from outside of town still\nhurts players with PVP off.)\n - Some people are using slimefun to have dragon pets that end up\nshooting these fireballs...", "committedDate": "2020-11-21T12:12:03Z", "type": "commit"}, {"oid": "8296b64daa11921351509d620b724209a9dfc2f7", "url": "https://github.com/TownyAdvanced/Towny/commit/8296b64daa11921351509d620b724209a9dfc2f7", "message": "Revise check to just remove the AreaEffectCloud when it has spawned in a\nPVP-off area.", "committedDate": "2020-11-21T12:12:03Z", "type": "commit"}, {"oid": "7cca3cb78780aa271cd21898c281c18292d54fcb", "url": "https://github.com/TownyAdvanced/Towny/commit/7cca3cb78780aa271cd21898c281c18292d54fcb", "message": "creatorfromhell's annual contribution.", "committedDate": "2020-11-21T12:12:03Z", "type": "commit"}, {"oid": "7cca3cb78780aa271cd21898c281c18292d54fcb", "url": "https://github.com/TownyAdvanced/Towny/commit/7cca3cb78780aa271cd21898c281c18292d54fcb", "message": "creatorfromhell's annual contribution.", "committedDate": "2020-11-21T12:12:03Z", "type": "forcePushed"}, {"oid": "2a756587181295cc6d3d0d40e4e21bd632355982", "url": "https://github.com/TownyAdvanced/Towny/commit/2a756587181295cc6d3d0d40e4e21bd632355982", "message": "- Remove unused import.", "committedDate": "2020-11-21T12:13:35Z", "type": "commit"}]}