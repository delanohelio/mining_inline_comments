{"pr_number": 3892, "pr_title": "Confirmation System Refactor/Overhaul", "pr_createdAt": "2020-04-08T03:46:50Z", "pr_url": "https://github.com/TownyAdvanced/Towny/pull/3892", "timeline": [{"oid": "61be2bb010e1a0a7913fce21f8094c25fe60fbb2", "url": "https://github.com/TownyAdvanced/Towny/commit/61be2bb010e1a0a7913fce21f8094c25fe60fbb2", "message": "Implement new confirmation system, needs work on console.", "committedDate": "2020-04-07T22:30:26Z", "type": "commit"}, {"oid": "c31eb6b7928379843cf82eabf7c9e11eb55a2434", "url": "https://github.com/TownyAdvanced/Towny/commit/c31eb6b7928379843cf82eabf7c9e11eb55a2434", "message": "Generify confirmation holders and finish implementation.", "committedDate": "2020-04-08T03:18:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI1MzI5OQ==", "url": "https://github.com/TownyAdvanced/Towny/pull/3892#discussion_r405253299", "bodyText": "Why an atomic reference?", "author": "silverwolfg11", "createdAt": "2020-04-08T04:37:11Z", "path": "src/com/palmergames/bukkit/towny/command/TownyAdminCommand.java", "diffHunk": "@@ -1592,18 +1603,62 @@ public void purge(String[] split) {\n \t\t\t} catch (TownyException e) {\r\n \t\t\t\tTownyMessaging.sendErrorMsg(player, e.getMessage());\r\n \t\t\t}\r\n-\t\t\t\r\n-\t\t\tif (resident != null) {\r\n-\t\t\t\ttry {\r\n-\t\t\t\t\tConfirmationHandler.addConfirmation(resident, ConfirmationType.PURGE, days); // It takes the senders town & nation, an admin deleting another town has no confirmation.\r\n-\t\t\t\t\tTownyMessaging.sendConfirmationMessage(player, null, null, null, null);\r\n \r\n-\t\t\t\t} catch (TownyException e) {\r\n-\t\t\t\t\tTownyMessaging.sendErrorMsg(player, e.getMessage());\r\n+\t\t\tResident finalResident = resident;\r\n+\t\t\tString finalDays = days[0];\r\n+\t\t\tTownyUniverse townyUniverse = TownyUniverse.getInstance();\r\n+\t\t\tRunnable purgeHandler = () -> {\r\n+\t\t\t\tPlayer player = TownyAPI.getInstance().getPlayer(finalResident);\r\n+\t\t\t\tif (player == null) {\r\n+\t\t\t\t\ttry {\r\n+\t\t\t\t\t\tthrow new TownyException(\"Player could not be found!\");\r\n+\t\t\t\t\t} catch (TownyException e) {\r\n+\t\t\t\t\t\te.printStackTrace();\r\n+\t\t\t\t\t}\r\n+\t\t\t\t}\r\n+\t\t\t\tif (!townyUniverse.getPermissionSource().testPermission(player, PermissionNodes.TOWNY_COMMAND_TOWNYADMIN_PURGE.getNode())) {\r\n+\t\t\t\t\ttry {\r\n+\t\t\t\t\t\tthrow new TownyException(TownySettings.getLangString(\"msg_err_admin_only\"));\r\n+\t\t\t\t\t} catch (TownyException e) {\r\n+\t\t\t\t\t\tTownyMessaging.sendErrorMsg(player, e.getMessage());\r\n+\t\t\t\t\t}\r\n \t\t\t\t}\r\n+\r\n+\t\t\t\tint numDays;\r\n+\t\t\t\tboolean townless = false;\r\n+\t\t\t\tif (finalDays.startsWith(\"townless\")) {\r\n+\t\t\t\t\ttownless = true;\r\n+\t\t\t\t\tnumDays = Integer.parseInt(finalDays.substring(8));\r\n+\t\t\t\t} else {\r\n+\t\t\t\t\tnumDays = Integer.parseInt(finalDays);\r\n+\t\t\t\t}\r\n+\r\n+\t\t\t\tnew ResidentPurge(plugin, player, TimeTools.getMillis(numDays + \"d\"), townless).start();\r\n+\t\t\t};\r\n+\t\t\t\r\n+\t\t\tif (resident != null) {\r\n+\t\t\t\t\r\n+\t\t\t\tConfirmation confirmation = new Confirmation(player);\r\n+\t\t\t\tconfirmation.setHandler(purgeHandler);\r\n+\t\t\t\tConfirmationHandler.registerConfirmation(confirmation);\r\n+\t\t\t\tTownyMessaging.sendConfirmationMessage(player, null, null, null, null);\r\n \t\t\t}\r\n \t\t} else { // isConsole\r\n-\t\t\tConfirmationHandler.addConfirmation(ConfirmationType.PURGE, days);\r\n+\t\t\tConfirmation confirmation = new Confirmation(sender);\r\n+\r\n+\t\t\tfinal AtomicReference<String>[] finalDays = new AtomicReference[]{new AtomicReference<>(days[0])};\r", "originalCommit": "c31eb6b7928379843cf82eabf7c9e11eb55a2434", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "87542256a165f121c87b5c4b6c93e1ed3da585b7", "chunk": "diff --git a/src/com/palmergames/bukkit/towny/command/TownyAdminCommand.java b/src/com/palmergames/bukkit/towny/command/TownyAdminCommand.java\nindex 9b273a0b5..6461432b1 100644\n--- a/src/com/palmergames/bukkit/towny/command/TownyAdminCommand.java\n+++ b/src/com/palmergames/bukkit/towny/command/TownyAdminCommand.java\n\n@@ -1646,15 +1646,15 @@ public class TownyAdminCommand extends BaseCommand implements CommandExecutor {\n \t\t} else { // isConsole\n \t\t\tConfirmation confirmation = new Confirmation(sender);\n \n-\t\t\tfinal AtomicReference<String>[] finalDays = new AtomicReference[]{new AtomicReference<>(days[0])};\n+\t\t\tfinal String finalDays = days[0];\n \t\t\tconfirmation.setHandler(() -> {\n \t\t\t\tint numDays;\n \t\t\t\tboolean townless = false;\n-\t\t\t\tif (finalDays[0].get().startsWith(\"townless\")) {\n+\t\t\t\tif (finalDays.startsWith(\"townless\")) {\n \t\t\t\t\ttownless = true;\n-\t\t\t\t\tnumDays = Integer.parseInt(finalDays[0].get().substring(8));\n+\t\t\t\t\tnumDays = Integer.parseInt(finalDays.substring(8));\n \t\t\t\t} else {\n-\t\t\t\t\tnumDays = Integer.parseInt(finalDays[0].get());\n+\t\t\t\t\tnumDays = Integer.parseInt(finalDays);\n \t\t\t\t}\n \n \t\t\t\tnew ResidentPurge(plugin, null, TimeTools.getMillis(numDays + \"d\"), townless).start();\n"}}, {"oid": "87542256a165f121c87b5c4b6c93e1ed3da585b7", "url": "https://github.com/TownyAdvanced/Towny/commit/87542256a165f121c87b5c4b6c93e1ed3da585b7", "message": "Fix atomic reference", "committedDate": "2020-04-08T04:51:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ1MjAxMQ==", "url": "https://github.com/TownyAdvanced/Towny/pull/3892#discussion_r405452011", "bodyText": "Can we not reuse the above nation and remainingNation here now?\nAlso finalRemainingNation is basically unused.", "author": "LlmDl", "createdAt": "2020-04-08T11:26:03Z", "path": "src/com/palmergames/bukkit/towny/command/NationCommand.java", "diffHunk": "@@ -1350,7 +1352,20 @@ public void mergeNation(Player player, String name) throws TownyException {\n \t\t\t\tthrow new TownyException(String.format(TownySettings.getLangString(\"msg_err_king_of_that_nation_is_not_online\"), name, king.getName()));\r\n \t\t\t}\r\n \t\t\tTownyMessaging.sendMessage(BukkitTools.getPlayer(king.getName()), String.format(TownySettings.getLangString(\"msg_would_you_merge_your_nation_into_other_nation\"), nation, remainingNation, remainingNation));\r\n-\t\t\tConfirmationHandler.addConfirmation(king, ConfirmationType.NATION_MERGE, remainingNation);\r\n+\t\t\tConfirmation confirmation = new Confirmation(player);\r\n+\t\t\tNation finalRemainingNation = remainingNation;\r\n+\t\t\tconfirmation.setHandler(() -> {\r\n+\t\t\t\ttry {\r\n+\t\t\t\t\tNation succumbingNation = resident.getTown().getNation();\r\n+\t\t\t\t\tNation prevailingNation = finalRemainingNation;\r", "originalCommit": "87542256a165f121c87b5c4b6c93e1ed3da585b7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2ea42dfe6eb37711c3818f206ac1d0099dbf9544", "chunk": "diff --git a/src/com/palmergames/bukkit/towny/command/NationCommand.java b/src/com/palmergames/bukkit/towny/command/NationCommand.java\nindex a146419cb..d2565b64a 100644\n--- a/src/com/palmergames/bukkit/towny/command/NationCommand.java\n+++ b/src/com/palmergames/bukkit/towny/command/NationCommand.java\n\n@@ -1333,33 +1333,31 @@ public class NationCommand extends BaseCommand implements CommandExecutor {\n \tpublic void mergeNation(Player player, String name) throws TownyException {\n \t\t\n \t\tcom.palmergames.bukkit.towny.TownyUniverse universe = com.palmergames.bukkit.towny.TownyUniverse.getInstance();\n-\t\tNation nation = null;\n-\t\tNation remainingNation = null;\n-\t\tResident resident;\n+\t\tNation nation;\n+\t\tNation remainingNation;\n+\t\t\n \t\ttry {\n \t\t\tnation = universe.getDataSource().getNation(name);\n \t\t\tremainingNation = universe.getDataSource().getResident(player.getName()).getTown().getNation();\n-\t\t\tresident = universe.getDataSource().getResident(player.getName());\n \t\t} catch (NotRegisteredException e) {\n \t\t\tthrow new TownyException(String.format(TownySettings.getLangString(\"msg_err_invalid_name\"), name));\n \t\t}\n \t\tif (remainingNation.getName().equalsIgnoreCase(name))\n \t\t\tthrow new TownyException(String.format(TownySettings.getLangString(\"msg_err_invalid_name\"), name));\n \n-\t\tif (nation !=null ) {\n+\t\tif (nation != null) {\n \t\t\tResident king = nation.getKing();\n \t\t\tif (!BukkitTools.isOnline(king.getName())) {\n \t\t\t\tthrow new TownyException(String.format(TownySettings.getLangString(\"msg_err_king_of_that_nation_is_not_online\"), name, king.getName()));\n \t\t\t}\n+\t\t\t\n \t\t\tTownyMessaging.sendMessage(BukkitTools.getPlayer(king.getName()), String.format(TownySettings.getLangString(\"msg_would_you_merge_your_nation_into_other_nation\"), nation, remainingNation, remainingNation));\n \t\t\tConfirmation confirmation = new Confirmation(player);\n-\t\t\tNation finalRemainingNation = remainingNation;\n+\n \t\t\tconfirmation.setHandler(() -> {\n \t\t\t\ttry {\n-\t\t\t\t\tNation succumbingNation = resident.getTown().getNation();\n-\t\t\t\t\tNation prevailingNation = finalRemainingNation;\n-\t\t\t\t\tTownyUniverse.getInstance().getDataSource().mergeNation(succumbingNation, prevailingNation);\n-\t\t\t\t\tTownyMessaging.sendGlobalMessage(String.format(TownySettings.getLangString(\"nation1_has_merged_with_nation2\"), succumbingNation, prevailingNation));\n+\t\t\t\t\tTownyUniverse.getInstance().getDataSource().mergeNation(nation, remainingNation);\n+\t\t\t\t\tTownyMessaging.sendGlobalMessage(String.format(TownySettings.getLangString(\"nation1_has_merged_with_nation2\"), nation, remainingNation));\n \t\t\t\t} catch (TownyException e) {\n \t\t\t\t\tTownyMessaging.sendErrorMsg(player, e.getMessage());\n \t\t\t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ1NTAyNg==", "url": "https://github.com/TownyAdvanced/Towny/pull/3892#discussion_r405455026", "bodyText": "This selection will only be one townblock and needs to be populated with the PlotGroup's townblocks like the group claiming confirmation above.", "author": "LlmDl", "createdAt": "2020-04-08T11:32:09Z", "path": "src/com/palmergames/bukkit/towny/command/PlotCommand.java", "diffHunk": "@@ -400,8 +412,17 @@ public boolean parsePlotCommand(Player player, String[] split) throws TownyExcep\n \t\t\t\t\t\t\t\t\tnew PlotClaim(plugin, player, resident, selection, false, false, false).start();\r\n \t\t\t\t\t\t\t\t\tcontinue;\r\n \t\t\t\t\t\t\t\t}\r\n+\t\t\t\t\t\t\t\t\r\n+\t\t\t\t\t\t\t\t// Create confirmation.\r\n+\t\t\t\t\t\t\t\tConfirmation confirmation = new Confirmation(player);\r\n+\t\t\t\t\t\t\t\tList<WorldCoord> finalSelection = selection;\r", "originalCommit": "87542256a165f121c87b5c4b6c93e1ed3da585b7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2ea42dfe6eb37711c3818f206ac1d0099dbf9544", "chunk": "diff --git a/src/com/palmergames/bukkit/towny/command/PlotCommand.java b/src/com/palmergames/bukkit/towny/command/PlotCommand.java\nindex 01c9231ce..3e7938441 100644\n--- a/src/com/palmergames/bukkit/towny/command/PlotCommand.java\n+++ b/src/com/palmergames/bukkit/towny/command/PlotCommand.java\n\n@@ -413,13 +413,18 @@ public class PlotCommand extends BaseCommand implements CommandExecutor {\n \t\t\t\t\t\t\t\t\tcontinue;\n \t\t\t\t\t\t\t\t}\n \t\t\t\t\t\t\t\t\n+\t\t\t\t\t\t\t\t// Get all the townblocks part of the group.\n+\t\t\t\t\t\t\t\tfinal List<WorldCoord> groupSelection = new ArrayList<>();\n+\t\t\t\t\t\t\t\tblock.getPlotObjectGroup().getTownBlocks().forEach((tb) -> {\n+\t\t\t\t\t\t\t\t\tgroupSelection.add(tb.getWorldCoord());\n+\t\t\t\t\t\t\t\t});\n+\t\t\t\t\t\t\t\t\n \t\t\t\t\t\t\t\t// Create confirmation.\n \t\t\t\t\t\t\t\tConfirmation confirmation = new Confirmation(player);\n-\t\t\t\t\t\t\t\tList<WorldCoord> finalSelection = selection;\n \t\t\t\t\t\t\t\t\n \t\t\t\t\t\t\t\t// Setup handler.\n \t\t\t\t\t\t\t\tconfirmation.setHandler(() -> {\n-\t\t\t\t\t\t\t\t\tnew PlotClaim(Towny.getPlugin(), player, resident, finalSelection, false, false, false).start();\n+\t\t\t\t\t\t\t\t\tnew PlotClaim(Towny.getPlugin(), player, resident, groupSelection, false, false, false).start();\n \t\t\t\t\t\t\t\t});\n \n \t\t\t\t\t\t\t\tConfirmationHandler.registerConfirmation(confirmation);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ2NTM2Mg==", "url": "https://github.com/TownyAdvanced/Towny/pull/3892#discussion_r405465362", "bodyText": "Not sure why you've changed the above days to a String[] to make days[0], to create a new finalDays String to do the same logic below as was used previously.", "author": "LlmDl", "createdAt": "2020-04-08T11:52:04Z", "path": "src/com/palmergames/bukkit/towny/command/TownyAdminCommand.java", "diffHunk": "@@ -1592,18 +1603,62 @@ public void purge(String[] split) {\n \t\t\t} catch (TownyException e) {\r\n \t\t\t\tTownyMessaging.sendErrorMsg(player, e.getMessage());\r\n \t\t\t}\r\n-\t\t\t\r\n-\t\t\tif (resident != null) {\r\n-\t\t\t\ttry {\r\n-\t\t\t\t\tConfirmationHandler.addConfirmation(resident, ConfirmationType.PURGE, days); // It takes the senders town & nation, an admin deleting another town has no confirmation.\r\n-\t\t\t\t\tTownyMessaging.sendConfirmationMessage(player, null, null, null, null);\r\n \r\n-\t\t\t\t} catch (TownyException e) {\r\n-\t\t\t\t\tTownyMessaging.sendErrorMsg(player, e.getMessage());\r\n+\t\t\tResident finalResident = resident;\r\n+\t\t\tString finalDays = days[0];\r", "originalCommit": "87542256a165f121c87b5c4b6c93e1ed3da585b7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2ea42dfe6eb37711c3818f206ac1d0099dbf9544", "chunk": "diff --git a/src/com/palmergames/bukkit/towny/command/TownyAdminCommand.java b/src/com/palmergames/bukkit/towny/command/TownyAdminCommand.java\nindex 6461432b1..881a95892 100644\n--- a/src/com/palmergames/bukkit/towny/command/TownyAdminCommand.java\n+++ b/src/com/palmergames/bukkit/towny/command/TownyAdminCommand.java\n\n@@ -1605,8 +1604,9 @@ public class TownyAdminCommand extends BaseCommand implements CommandExecutor {\n \t\t\t}\n \n \t\t\tResident finalResident = resident;\n-\t\t\tString finalDays = days[0];\n+\t\t\tString finalDays = days;\n \t\t\tTownyUniverse townyUniverse = TownyUniverse.getInstance();\n+\t\t\t\n \t\t\tRunnable purgeHandler = () -> {\n \t\t\t\tPlayer player = TownyAPI.getInstance().getPlayer(finalResident);\n \t\t\t\tif (player == null) {\n"}}, {"oid": "2ea42dfe6eb37711c3818f206ac1d0099dbf9544", "url": "https://github.com/TownyAdvanced/Towny/commit/2ea42dfe6eb37711c3818f206ac1d0099dbf9544", "message": "Fix bugs and code formatting issues.", "committedDate": "2020-04-08T15:17:15Z", "type": "commit"}, {"oid": "8ae03d3ffd9ce8ba8ce0201a8a4f95195ecfd0a6", "url": "https://github.com/TownyAdvanced/Towny/commit/8ae03d3ffd9ce8ba8ce0201a8a4f95195ecfd0a6", "message": "make sure timeout message only shows on an actual timeout.", "committedDate": "2020-04-08T15:29:27Z", "type": "commit"}, {"oid": "64c0b6cac26262a4bb5f4fcc34d0037b2389a6e1", "url": "https://github.com/TownyAdvanced/Towny/commit/64c0b6cac26262a4bb5f4fcc34d0037b2389a6e1", "message": "Confirmations now send confirmations messages automatically.", "committedDate": "2020-04-08T20:22:12Z", "type": "commit"}, {"oid": "cc2ee2aec8df2575161c23052ecb49ebeb9530b6", "url": "https://github.com/TownyAdvanced/Towny/commit/cc2ee2aec8df2575161c23052ecb49ebeb9530b6", "message": "Removed CommandSender from Confirmation\n\nOnly ConfirmationHandler will deal with CommandSender's", "committedDate": "2020-04-08T20:43:38Z", "type": "commit"}, {"oid": "ffe0e3c63345f678f0265b48d67f94107609476c", "url": "https://github.com/TownyAdvanced/Towny/commit/ffe0e3c63345f678f0265b48d67f94107609476c", "message": "Add duration field for Confirmation", "committedDate": "2020-04-08T20:51:40Z", "type": "commit"}, {"oid": "9c7f4c921a297ff0ca682be043893645866b7c16", "url": "https://github.com/TownyAdvanced/Towny/commit/9c7f4c921a297ff0ca682be043893645866b7c16", "message": "fix constructor.", "committedDate": "2020-04-08T20:58:57Z", "type": "commit"}, {"oid": "367f400a72737e86affe98b1850dfb63f8d0d358", "url": "https://github.com/TownyAdvanced/Towny/commit/367f400a72737e86affe98b1850dfb63f8d0d358", "message": "Fix purge command feedback being only seen in console & moved purge\npermission test to pre-confirmation.", "committedDate": "2020-04-08T21:23:32Z", "type": "commit"}, {"oid": "0bd1918c95b5a5a1444cf708f955e52c8cc487b5", "url": "https://github.com/TownyAdvanced/Towny/commit/0bd1918c95b5a5a1444cf708f955e52c8cc487b5", "message": "Fix /t unclaim all showing two confirmations & Fix unwanted refunds.", "committedDate": "2020-04-08T21:56:33Z", "type": "commit"}, {"oid": "3add00e466ec8840a68ea983bdb839d2c6c61356", "url": "https://github.com/TownyAdvanced/Towny/commit/3add00e466ec8840a68ea983bdb839d2c6c61356", "message": "Remove commented out message.", "committedDate": "2020-04-08T21:57:40Z", "type": "commit"}, {"oid": "183abff678014ac7cd71b936462f682b18d4b999", "url": "https://github.com/TownyAdvanced/Towny/commit/183abff678014ac7cd71b936462f682b18d4b999", "message": "- Allow for other plugins to modify the TownPreClaim cancellation\nmessage.\n    - Closes #3814.", "committedDate": "2020-04-09T19:17:18Z", "type": "commit"}, {"oid": "2d9430c92b8e89e4772188ac4fe19236a32e34ab", "url": "https://github.com/TownyAdvanced/Towny/commit/2d9430c92b8e89e4772188ac4fe19236a32e34ab", "message": "Revert \"- Allow for other plugins to modify the TownPreClaim cancellation message.     - Closes #3814.\"\n\nThis reverts commit 183abff678014ac7cd71b936462f682b18d4b999.", "committedDate": "2020-04-09T19:21:55Z", "type": "commit"}, {"oid": "c7505c56913c5f929e2e9e4494a338adb88a4051", "url": "https://github.com/TownyAdvanced/Towny/commit/c7505c56913c5f929e2e9e4494a338adb88a4051", "message": "Fix nation merging confirmation going to the wrong person.", "committedDate": "2020-04-10T11:58:47Z", "type": "commit"}]}