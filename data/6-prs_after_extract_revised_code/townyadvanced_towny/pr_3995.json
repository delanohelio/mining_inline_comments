{"pr_number": 3995, "pr_title": "add a pre plot change type event", "pr_createdAt": "2020-05-10T15:07:27Z", "pr_url": "https://github.com/TownyAdvanced/Towny/pull/3995", "timeline": [{"oid": "e48041c1f6498c46ea16a31c78b9d1ac5b2f5e0c", "url": "https://github.com/TownyAdvanced/Towny/commit/e48041c1f6498c46ea16a31c78b9d1ac5b2f5e0c", "message": "add a pre plot change type event", "committedDate": "2020-05-10T15:03:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjY4NDI3Ng==", "url": "https://github.com/TownyAdvanced/Towny/pull/3995#discussion_r422684276", "bodyText": "The wilds plot type is not actually wilderness. TownBlocks that don't exist at all are wilderness. getOldType() will probably never return null as TownBlocks always have a type, even if it is the default RESIDENTIAL type.", "author": "LlmDl", "createdAt": "2020-05-10T18:51:22Z", "path": "src/com/palmergames/bukkit/towny/event/PlotPreChangeTypeEvent.java", "diffHunk": "@@ -0,0 +1,73 @@\n+package com.palmergames.bukkit.towny.event;\n+\n+import com.palmergames.bukkit.towny.object.TownBlock;\n+import com.palmergames.bukkit.towny.object.TownBlockType;\n+import org.bukkit.Bukkit;\n+import org.bukkit.event.Cancellable;\n+import org.bukkit.event.Event;\n+import org.bukkit.event.HandlerList;\n+\n+public class PlotPreChangeTypeEvent extends Event implements Cancellable {\n+    public static final HandlerList handlers = new HandlerList();\n+    private TownBlockType oldType;\n+    private TownBlockType newType;\n+    private TownBlock townBlock;\n+\tprivate String cancelMessage = \"Sorry this event was cancelled\";\n+\tprivate boolean isCancelled = false;\n+\n+    @Override\n+    public HandlerList getHandlers() {\n+        return handlers;\n+    }\n+\n+    public static HandlerList getHandlerList() {\n+        return handlers;\n+    }\n+\n+    /**\n+\t * Changes a plot's TownBlockType\n+\t * \n+     * @param oldType- Old Type\n+     * @param newType - New Type\n+\t * @param townBlock - Plot to target\n+     */\n+    public PlotPreChangeTypeEvent(TownBlockType oldType, TownBlockType newType, TownBlock townBlock) {\n+    \tsuper(!Bukkit.getServer().isPrimaryThread());\n+        this.newType = newType;\n+        this.oldType = oldType;\n+        this.townBlock = townBlock;\n+    }\n+\n+    public TownBlockType getNewType() {\n+        return newType;\n+    }\n+\n+    public TownBlockType getOldType() {\n+        if (oldType == null) {\n+            return TownBlockType.WILDS; // Considering the further fact we know null is wilderness if there is no old type, it has to have been wilderness.", "originalCommit": "e48041c1f6498c46ea16a31c78b9d1ac5b2f5e0c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjY4NDM1Mw==", "url": "https://github.com/TownyAdvanced/Towny/pull/3995#discussion_r422684353", "bodyText": "This could just return townBlock.getType().", "author": "LlmDl", "createdAt": "2020-05-10T18:52:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjY4NDI3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "65983e57677c39da6b55e9ab453df383f07ee1c7", "chunk": "diff --git a/src/com/palmergames/bukkit/towny/event/PlotPreChangeTypeEvent.java b/src/com/palmergames/bukkit/towny/event/PlotPreChangeTypeEvent.java\nindex 5844c78c..a4367dfc 100644\n--- a/src/com/palmergames/bukkit/towny/event/PlotPreChangeTypeEvent.java\n+++ b/src/com/palmergames/bukkit/towny/event/PlotPreChangeTypeEvent.java\n\n@@ -9,7 +9,6 @@ import org.bukkit.event.HandlerList;\n \n public class PlotPreChangeTypeEvent extends Event implements Cancellable {\n     public static final HandlerList handlers = new HandlerList();\n-    private TownBlockType oldType;\n     private TownBlockType newType;\n     private TownBlock townBlock;\n \tprivate String cancelMessage = \"Sorry this event was cancelled\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjY4NDM2NQ==", "url": "https://github.com/TownyAdvanced/Towny/pull/3995#discussion_r422684365", "bodyText": "You can drop the oldType from this.", "author": "LlmDl", "createdAt": "2020-05-10T18:52:26Z", "path": "src/com/palmergames/bukkit/towny/event/PlotPreChangeTypeEvent.java", "diffHunk": "@@ -0,0 +1,73 @@\n+package com.palmergames.bukkit.towny.event;\n+\n+import com.palmergames.bukkit.towny.object.TownBlock;\n+import com.palmergames.bukkit.towny.object.TownBlockType;\n+import org.bukkit.Bukkit;\n+import org.bukkit.event.Cancellable;\n+import org.bukkit.event.Event;\n+import org.bukkit.event.HandlerList;\n+\n+public class PlotPreChangeTypeEvent extends Event implements Cancellable {\n+    public static final HandlerList handlers = new HandlerList();\n+    private TownBlockType oldType;\n+    private TownBlockType newType;\n+    private TownBlock townBlock;\n+\tprivate String cancelMessage = \"Sorry this event was cancelled\";\n+\tprivate boolean isCancelled = false;\n+\n+    @Override\n+    public HandlerList getHandlers() {\n+        return handlers;\n+    }\n+\n+    public static HandlerList getHandlerList() {\n+        return handlers;\n+    }\n+\n+    /**\n+\t * Changes a plot's TownBlockType\n+\t * \n+     * @param oldType- Old Type\n+     * @param newType - New Type\n+\t * @param townBlock - Plot to target\n+     */\n+    public PlotPreChangeTypeEvent(TownBlockType oldType, TownBlockType newType, TownBlock townBlock) {", "originalCommit": "e48041c1f6498c46ea16a31c78b9d1ac5b2f5e0c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "65983e57677c39da6b55e9ab453df383f07ee1c7", "chunk": "diff --git a/src/com/palmergames/bukkit/towny/event/PlotPreChangeTypeEvent.java b/src/com/palmergames/bukkit/towny/event/PlotPreChangeTypeEvent.java\nindex 5844c78c..a4367dfc 100644\n--- a/src/com/palmergames/bukkit/towny/event/PlotPreChangeTypeEvent.java\n+++ b/src/com/palmergames/bukkit/towny/event/PlotPreChangeTypeEvent.java\n\n@@ -9,7 +9,6 @@ import org.bukkit.event.HandlerList;\n \n public class PlotPreChangeTypeEvent extends Event implements Cancellable {\n     public static final HandlerList handlers = new HandlerList();\n-    private TownBlockType oldType;\n     private TownBlockType newType;\n     private TownBlock townBlock;\n \tprivate String cancelMessage = \"Sorry this event was cancelled\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjY4NDQ2Mw==", "url": "https://github.com/TownyAdvanced/Towny/pull/3995#discussion_r422684463", "bodyText": "Doesn't need oldType, as this can be gotten via the TownBlock in the event.", "author": "LlmDl", "createdAt": "2020-05-10T18:53:00Z", "path": "src/com/palmergames/bukkit/towny/command/PlotCommand.java", "diffHunk": "@@ -701,11 +702,28 @@ public boolean parsePlotCommand(Player player, String[] split) throws TownyExcep\n \t\t\t\t\t\t} \r\n \r\n \t\t\t\t\t\tWorldCoord worldCoord = new WorldCoord(world, Coord.parseCoord(player));\r\n+\t\t\t\t\t\t\r\n+\t\t\t\t\t\ttry {\r\n+\t\t\t\t\t\t\tTownBlock blockAtCoord = worldCoord.getTownBlock();\r\n+\t\t\t\t\t\t\tTownBlockType paramType = TownBlockType.lookup(split[0]);\r\n \r\n-\t\t\t\t\t\tsetPlotType(resident, worldCoord, split[0]);\r\n+\t\t\t\t\t\t\tif (paramType == null)\r\n+\t\t\t\t\t\t\t\tthrow new TownyException(TownySettings.getLangString(\"msg_err_not_block_type\"));\r\n+\t\t\t\t\t\t\t\r\n+\t\t\t\t\t\t\tPlotPreChangeTypeEvent preEvent = new PlotPreChangeTypeEvent(blockAtCoord.getType(), paramType, blockAtCoord);\r", "originalCommit": "e48041c1f6498c46ea16a31c78b9d1ac5b2f5e0c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "65983e57677c39da6b55e9ab453df383f07ee1c7", "chunk": "diff --git a/src/com/palmergames/bukkit/towny/command/PlotCommand.java b/src/com/palmergames/bukkit/towny/command/PlotCommand.java\nindex 92f66b02..6b97062d 100644\n--- a/src/com/palmergames/bukkit/towny/command/PlotCommand.java\n+++ b/src/com/palmergames/bukkit/towny/command/PlotCommand.java\n\n@@ -699,22 +699,19 @@ public class PlotCommand extends BaseCommand implements CommandExecutor {\n \t\t\t\t\t\t\t\t}\n \t\t\t\t\t\t\t\treturn true;\n \t\t\t\t\t\t\t}\n-\t\t\t\t\t\t} \n-\n-\t\t\t\t\t\tWorldCoord worldCoord = new WorldCoord(world, Coord.parseCoord(player));\n+\t\t\t\t\t\t}\n \t\t\t\t\t\t\n \t\t\t\t\t\ttry {\n-\t\t\t\t\t\t\tTownBlock blockAtCoord = worldCoord.getTownBlock();\n-\t\t\t\t\t\t\tTownBlockType paramType = TownBlockType.lookup(split[0]);\n+\t\t\t\t\t\t\tTownBlockType townBlockType = TownBlockType.lookup(split[0]);\n \n-\t\t\t\t\t\t\tif (paramType == null)\n+\t\t\t\t\t\t\tif (townBlockType == null)\n \t\t\t\t\t\t\t\tthrow new TownyException(TownySettings.getLangString(\"msg_err_not_block_type\"));\n \t\t\t\t\t\t\t\n-\t\t\t\t\t\t\tPlotPreChangeTypeEvent preEvent = new PlotPreChangeTypeEvent(blockAtCoord.getType(), paramType, blockAtCoord);\n+\t\t\t\t\t\t\tPlotPreChangeTypeEvent preEvent = new PlotPreChangeTypeEvent(townBlockType, townBlock);\n \t\t\t\t\t\t\tBukkitTools.getPluginManager().callEvent(preEvent);\n \n \t\t\t\t\t\t\tif (!preEvent.isCancelled()) {\n-\t\t\t\t\t\t\t\tsetPlotType(resident, worldCoord, split[0]);\n+\t\t\t\t\t\t\t\tsetPlotType(resident, townBlock.getWorldCoord(), split[0]);\n \t\t\t\t\t\t\t\tplayer.sendMessage(String.format(TownySettings.getLangString(\"msg_plot_set_type\"), split[0]));\n \t\t\t\t\t\t\t} else {\n \t\t\t\t\t\t\t\tplayer.sendMessage(preEvent.getCancelMessage());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjY4NDUyMw==", "url": "https://github.com/TownyAdvanced/Towny/pull/3995#discussion_r422684523", "bodyText": "Please change variables to townBlock and townBlockType, for readability.", "author": "LlmDl", "createdAt": "2020-05-10T18:53:33Z", "path": "src/com/palmergames/bukkit/towny/command/PlotCommand.java", "diffHunk": "@@ -701,11 +702,28 @@ public boolean parsePlotCommand(Player player, String[] split) throws TownyExcep\n \t\t\t\t\t\t} \r\n \r\n \t\t\t\t\t\tWorldCoord worldCoord = new WorldCoord(world, Coord.parseCoord(player));\r\n+\t\t\t\t\t\t\r\n+\t\t\t\t\t\ttry {\r\n+\t\t\t\t\t\t\tTownBlock blockAtCoord = worldCoord.getTownBlock();\r\n+\t\t\t\t\t\t\tTownBlockType paramType = TownBlockType.lookup(split[0]);\r", "originalCommit": "e48041c1f6498c46ea16a31c78b9d1ac5b2f5e0c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "65983e57677c39da6b55e9ab453df383f07ee1c7", "chunk": "diff --git a/src/com/palmergames/bukkit/towny/command/PlotCommand.java b/src/com/palmergames/bukkit/towny/command/PlotCommand.java\nindex 92f66b02..6b97062d 100644\n--- a/src/com/palmergames/bukkit/towny/command/PlotCommand.java\n+++ b/src/com/palmergames/bukkit/towny/command/PlotCommand.java\n\n@@ -699,22 +699,19 @@ public class PlotCommand extends BaseCommand implements CommandExecutor {\n \t\t\t\t\t\t\t\t}\n \t\t\t\t\t\t\t\treturn true;\n \t\t\t\t\t\t\t}\n-\t\t\t\t\t\t} \n-\n-\t\t\t\t\t\tWorldCoord worldCoord = new WorldCoord(world, Coord.parseCoord(player));\n+\t\t\t\t\t\t}\n \t\t\t\t\t\t\n \t\t\t\t\t\ttry {\n-\t\t\t\t\t\t\tTownBlock blockAtCoord = worldCoord.getTownBlock();\n-\t\t\t\t\t\t\tTownBlockType paramType = TownBlockType.lookup(split[0]);\n+\t\t\t\t\t\t\tTownBlockType townBlockType = TownBlockType.lookup(split[0]);\n \n-\t\t\t\t\t\t\tif (paramType == null)\n+\t\t\t\t\t\t\tif (townBlockType == null)\n \t\t\t\t\t\t\t\tthrow new TownyException(TownySettings.getLangString(\"msg_err_not_block_type\"));\n \t\t\t\t\t\t\t\n-\t\t\t\t\t\t\tPlotPreChangeTypeEvent preEvent = new PlotPreChangeTypeEvent(blockAtCoord.getType(), paramType, blockAtCoord);\n+\t\t\t\t\t\t\tPlotPreChangeTypeEvent preEvent = new PlotPreChangeTypeEvent(townBlockType, townBlock);\n \t\t\t\t\t\t\tBukkitTools.getPluginManager().callEvent(preEvent);\n \n \t\t\t\t\t\t\tif (!preEvent.isCancelled()) {\n-\t\t\t\t\t\t\t\tsetPlotType(resident, worldCoord, split[0]);\n+\t\t\t\t\t\t\t\tsetPlotType(resident, townBlock.getWorldCoord(), split[0]);\n \t\t\t\t\t\t\t\tplayer.sendMessage(String.format(TownySettings.getLangString(\"msg_plot_set_type\"), split[0]));\n \t\t\t\t\t\t\t} else {\n \t\t\t\t\t\t\t\tplayer.sendMessage(preEvent.getCancelMessage());\n"}}, {"oid": "65983e57677c39da6b55e9ab453df383f07ee1c7", "url": "https://github.com/TownyAdvanced/Towny/commit/65983e57677c39da6b55e9ab453df383f07ee1c7", "message": "add a plot pre change type event", "committedDate": "2020-05-11T12:11:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzAyODA0OQ==", "url": "https://github.com/TownyAdvanced/Towny/pull/3995#discussion_r423028049", "bodyText": "I missed it before but it's probably a good idea to pass along the resident or player who is changing the plot type, to make the event more usable. After that's done I think this will be ready to go.", "author": "LlmDl", "createdAt": "2020-05-11T13:12:10Z", "path": "src/com/palmergames/bukkit/towny/command/PlotCommand.java", "diffHunk": "@@ -698,14 +699,28 @@ public boolean parsePlotCommand(Player player, String[] split) throws TownyExcep\n \t\t\t\t\t\t\t\t}\r\n \t\t\t\t\t\t\t\treturn true;\r\n \t\t\t\t\t\t\t}\r\n-\t\t\t\t\t\t} \r\n-\r\n-\t\t\t\t\t\tWorldCoord worldCoord = new WorldCoord(world, Coord.parseCoord(player));\r\n+\t\t\t\t\t\t}\r\n+\t\t\t\t\t\t\r\n+\t\t\t\t\t\ttry {\r\n+\t\t\t\t\t\t\tTownBlockType townBlockType = TownBlockType.lookup(split[0]);\r\n \r\n-\t\t\t\t\t\tsetPlotType(resident, worldCoord, split[0]);\r\n+\t\t\t\t\t\t\tif (townBlockType == null)\r\n+\t\t\t\t\t\t\t\tthrow new TownyException(TownySettings.getLangString(\"msg_err_not_block_type\"));\r\n+\t\t\t\t\t\t\t\r\n+\t\t\t\t\t\t\tPlotPreChangeTypeEvent preEvent = new PlotPreChangeTypeEvent(townBlockType, townBlock);\r", "originalCommit": "65983e57677c39da6b55e9ab453df383f07ee1c7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a8fee60e79148ab567d157484a4a961d0c634086", "chunk": "diff --git a/src/com/palmergames/bukkit/towny/command/PlotCommand.java b/src/com/palmergames/bukkit/towny/command/PlotCommand.java\nindex 6b97062d..090f7421 100644\n--- a/src/com/palmergames/bukkit/towny/command/PlotCommand.java\n+++ b/src/com/palmergames/bukkit/towny/command/PlotCommand.java\n\n@@ -707,7 +707,7 @@ public class PlotCommand extends BaseCommand implements CommandExecutor {\n \t\t\t\t\t\t\tif (townBlockType == null)\n \t\t\t\t\t\t\t\tthrow new TownyException(TownySettings.getLangString(\"msg_err_not_block_type\"));\n \t\t\t\t\t\t\t\n-\t\t\t\t\t\t\tPlotPreChangeTypeEvent preEvent = new PlotPreChangeTypeEvent(townBlockType, townBlock);\n+\t\t\t\t\t\t\tPlotPreChangeTypeEvent preEvent = new PlotPreChangeTypeEvent(townBlockType, townBlock, resident);\n \t\t\t\t\t\t\tBukkitTools.getPluginManager().callEvent(preEvent);\n \n \t\t\t\t\t\t\tif (!preEvent.isCancelled()) {\n"}}, {"oid": "f7ce85f6bed0c4bedfdf007d243d5de3b31e1eb1", "url": "https://github.com/TownyAdvanced/Towny/commit/f7ce85f6bed0c4bedfdf007d243d5de3b31e1eb1", "message": "add a plot pre change type event", "committedDate": "2020-05-11T13:40:50Z", "type": "commit"}, {"oid": "a8fee60e79148ab567d157484a4a961d0c634086", "url": "https://github.com/TownyAdvanced/Towny/commit/a8fee60e79148ab567d157484a4a961d0c634086", "message": "add a plot pre change type event", "committedDate": "2020-05-11T13:44:44Z", "type": "commit"}]}