{"pr_number": 4311, "pr_title": "added a maximum price for claiming town blocks", "pr_createdAt": "2020-09-13T11:32:29Z", "pr_url": "https://github.com/TownyAdvanced/Towny/pull/4311", "timeline": [{"oid": "8640f8f80b0ee32fa099583c20e828c605846f76", "url": "https://github.com/TownyAdvanced/Towny/commit/8640f8f80b0ee32fa099583c20e828c605846f76", "message": "added a maximum price for claiming town blocks\n\nI hope this is working. Please forgive me If I\u00b4m doing something wrong...I\u00b4ve never worked with github before", "committedDate": "2020-09-13T11:15:39Z", "type": "commit"}, {"oid": "20a83161a57efde22f073ae00e705797d6c2e707", "url": "https://github.com/TownyAdvanced/Towny/commit/20a83161a57efde22f073ae00e705797d6c2e707", "message": "added a maximum price for claiming town blocks\n\nI hope this is working. Please forgive me If I\u00b4m doing something wrong...I\u00b4ve never worked with github before", "committedDate": "2020-09-13T11:27:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU0NTE1Mg==", "url": "https://github.com/TownyAdvanced/Towny/pull/4311#discussion_r487545152", "bodyText": "Please add a \"\", below the \"-1.0\", line so that the new whitespacing is maintained.", "author": "LlmDl", "createdAt": "2020-09-13T15:48:04Z", "path": "src/com/palmergames/bukkit/config/ConfigNodes.java", "diffHunk": "@@ -1358,6 +1358,10 @@\n \t\t\t\"economy.new_expand.price_claim_townblock_increase\",\r\n \t\t\t\"1.0\",\r\n \t\t\t\"# How much every additionally claimed townblock increases in cost. Set to 1 to deactivate this. 1.3 means +30% to every bonus claim block cost.\"),\r\n+\tECO_MAX_PRICE_CLAIM_TOWNBLOCK(\r\n+\t\t\t\"economy.new_expand.max_price_claim_townblock\",\r\n+\t\t\t\"-1.0\",\r", "originalCommit": "20a83161a57efde22f073ae00e705797d6c2e707", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c26c53c8ec82792b076e7869409fd8d656fcded4", "chunk": "diff --git a/src/com/palmergames/bukkit/config/ConfigNodes.java b/src/com/palmergames/bukkit/config/ConfigNodes.java\nindex a5699638..7ae1b42c 100644\n--- a/src/com/palmergames/bukkit/config/ConfigNodes.java\n+++ b/src/com/palmergames/bukkit/config/ConfigNodes.java\n\n@@ -1360,7 +1360,8 @@ public enum ConfigNodes {\n \t\t\t\"# How much every additionally claimed townblock increases in cost. Set to 1 to deactivate this. 1.3 means +30% to every bonus claim block cost.\"),\n \tECO_MAX_PRICE_CLAIM_TOWNBLOCK(\n \t\t\t\"economy.new_expand.max_price_claim_townblock\",\n-\t\t\t\"-1.0\",\n+\t\t\t\"-1.0\", \n+\t\t\t\"\",\n \t\t\t\"# The maximum price for an additional townblock. No matter how many blocks a town has the price will not be above this. Set to -1 to deactivate this.\"),\n \tECO_PRICE_CLAIM_TOWNBLOCK_REFUND(\n \t\t\t\"economy.new_expand.price_claim_townblock_refund\",\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU0NTU5OA==", "url": "https://github.com/TownyAdvanced/Towny/pull/4311#discussion_r487545598", "bodyText": "If you could fix the spacing so there are spaces before and after the =, !=, ?, : and so forth, that would make this look like the rest of the code.", "author": "LlmDl", "createdAt": "2020-09-13T15:52:16Z", "path": "src/com/palmergames/bukkit/towny/object/Town.java", "diffHunk": "@@ -418,7 +418,9 @@ public double getBonusBlockCost() {\n \t}\n \t\n \tpublic double getTownBlockCost() {\n-\t\treturn (Math.pow(TownySettings.getClaimPriceIncreaseValue(), getTownBlocks().size()) * TownySettings.getClaimPrice());\n+\t\tdouble price=(Math.pow(TownySettings.getClaimPriceIncreaseValue(), getTownBlocks().size()) * TownySettings.getClaimPrice());\n+\t\tdouble maxprice=TownySettings.getMaxClaimPrice();\n+\t\treturn (maxprice!=-1?Math.min(price, maxprice):price);", "originalCommit": "20a83161a57efde22f073ae00e705797d6c2e707", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c26c53c8ec82792b076e7869409fd8d656fcded4", "chunk": "diff --git a/src/com/palmergames/bukkit/towny/object/Town.java b/src/com/palmergames/bukkit/towny/object/Town.java\nindex 3c0c9e52..6b37329e 100644\n--- a/src/com/palmergames/bukkit/towny/object/Town.java\n+++ b/src/com/palmergames/bukkit/towny/object/Town.java\n\n@@ -418,9 +418,9 @@ public class Town extends Government implements TownBlockOwner {\n \t}\n \t\n \tpublic double getTownBlockCost() {\n-\t\tdouble price=(Math.pow(TownySettings.getClaimPriceIncreaseValue(), getTownBlocks().size()) * TownySettings.getClaimPrice());\n-\t\tdouble maxprice=TownySettings.getMaxClaimPrice();\n-\t\treturn (maxprice!=-1?Math.min(price, maxprice):price);\n+\t\tdouble price = (Math.pow(TownySettings.getClaimPriceIncreaseValue(), getTownBlocks().size()) * TownySettings.getClaimPrice());\n+\t\tdouble maxprice = TownySettings.getMaxClaimPrice();\n+\t\treturn (maxprice == -1 ? price : Math.min(price, maxprice));\n \t}\n \n \tpublic double getTownBlockCostN(int inputN) throws TownyException {\n"}}, {"oid": "c26c53c8ec82792b076e7869409fd8d656fcded4", "url": "https://github.com/TownyAdvanced/Towny/commit/c26c53c8ec82792b076e7869409fd8d656fcded4", "message": "added spaces", "committedDate": "2020-09-13T16:04:15Z", "type": "commit"}, {"oid": "412d546e56a4cd11b80dbf696fb1ef97180a5f8f", "url": "https://github.com/TownyAdvanced/Towny/commit/412d546e56a4cd11b80dbf696fb1ef97180a5f8f", "message": "fixed problem in getTownBlockCostN", "committedDate": "2020-09-13T16:37:26Z", "type": "commit"}, {"oid": "bed706196c3d8816b213e15b1e246968d5aa1b76", "url": "https://github.com/TownyAdvanced/Towny/commit/bed706196c3d8816b213e15b1e246968d5aa1b76", "message": "Update Town.java", "committedDate": "2020-09-13T16:40:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU1MDg3OA==", "url": "https://github.com/TownyAdvanced/Towny/pull/4311#discussion_r487550878", "bodyText": "If you could use some { }'s and indent the while I think this will be good to go.", "author": "LlmDl", "createdAt": "2020-09-13T16:43:40Z", "path": "src/com/palmergames/bukkit/towny/object/Town.java", "diffHunk": "@@ -434,6 +434,9 @@ public double getTownBlockCostN(int inputN) throws TownyException {\n \t\tdouble nextprice = getTownBlockCost();\n \t\tint i = 1;\n \t\tdouble cost = nextprice;\n+\t\tif(TownySettings.getMaxClaimPrice() != -1)\n+\t\t\tcost *=  inputN;\n+\t\telse ", "originalCommit": "412d546e56a4cd11b80dbf696fb1ef97180a5f8f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU1MTMzNw==", "url": "https://github.com/TownyAdvanced/Towny/pull/4311#discussion_r487551337", "bodyText": "Nevermind, I see you've changed it around a bit.", "author": "LlmDl", "createdAt": "2020-09-13T16:48:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU1MDg3OA=="}], "type": "inlineReview", "revised_code": {"commit": "7ad75d1799e0a89960b9254e5ed922acb55cacdc", "chunk": "diff --git a/src/com/palmergames/bukkit/towny/object/Town.java b/src/com/palmergames/bukkit/towny/object/Town.java\nindex c601d117..57b04376 100644\n--- a/src/com/palmergames/bukkit/towny/object/Town.java\n+++ b/src/com/palmergames/bukkit/towny/object/Town.java\n\n@@ -434,11 +434,13 @@ public class Town extends Government implements TownBlockOwner {\n \t\tdouble nextprice = getTownBlockCost();\n \t\tint i = 1;\n \t\tdouble cost = nextprice;\n-\t\tif(TownySettings.getMaxClaimPrice() != -1)\n-\t\t\tcost *=  inputN;\n-\t\telse \n+\t\tboolean hasmaxprice = TownySettings.getMaxClaimPrice() != -1;\n+\t\tdouble maxprice = TownySettings.getMaxClaimPrice();\n \t\twhile (i < inputN){\n-\t\t\tnextprice = Math.round(Math.pow(TownySettings.getClaimPriceIncreaseValue() , getTownBlocks().size()+i) * TownySettings.getClaimPrice());\t\t\t\n+\t\t\tif(hasmaxprice && nextprice > maxprice)\n+\t\t\t\tnextprice=maxprice;\n+\t\t\telse\n+\t\t\t\tnextprice = Math.round(Math.pow(TownySettings.getClaimPriceIncreaseValue() , getTownBlocks().size()+i) * TownySettings.getClaimPrice());\n \t\t\tcost += nextprice;\n \t\t\ti++;\n \t\t}\n"}}, {"oid": "7ad75d1799e0a89960b9254e5ed922acb55cacdc", "url": "https://github.com/TownyAdvanced/Towny/commit/7ad75d1799e0a89960b9254e5ed922acb55cacdc", "message": "Update Town.java", "committedDate": "2020-09-13T18:06:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkwMTIxOA==", "url": "https://github.com/TownyAdvanced/Towny/pull/4311#discussion_r488901218", "bodyText": "This change has some logic errors regarding to the max price. Since the conditional is first thing in the loop, that means that the loop will always be checking the previous iteration's value of next price. This provides the opportunity for the previous iteration's nextprice to be above max price and not be adjusted.\nAlso resetting the nextprice to maxprice causes some issues as well because it will fail the conditional since nextprice will be equal to maxprice and not greater than maxprice. That means it will take the else branch and force a recalculation which could be greater than the maxprice.\nThere are quite a few ways to go about fixing this, so it's up to you for whatever approach you want to take. Just make sure to validate that cost will never add a value that is greater than maxprice if it exists.", "author": "silverwolfg11", "createdAt": "2020-09-15T19:04:45Z", "path": "src/com/palmergames/bukkit/towny/object/Town.java", "diffHunk": "@@ -432,8 +434,13 @@ public double getTownBlockCostN(int inputN) throws TownyException {\n \t\tdouble nextprice = getTownBlockCost();\n \t\tint i = 1;\n \t\tdouble cost = nextprice;\n+\t\tboolean hasmaxprice = TownySettings.getMaxClaimPrice() != -1;\n+\t\tdouble maxprice = TownySettings.getMaxClaimPrice();\n \t\twhile (i < inputN){\n-\t\t\tnextprice = Math.round(Math.pow(TownySettings.getClaimPriceIncreaseValue() , getTownBlocks().size()+i) * TownySettings.getClaimPrice());\t\t\t\n+\t\t\tif(hasmaxprice && nextprice > maxprice)\n+\t\t\t\tnextprice=maxprice;\n+\t\t\telse\n+\t\t\t\tnextprice = Math.round(Math.pow(TownySettings.getClaimPriceIncreaseValue() , getTownBlocks().size()+i) * TownySettings.getClaimPrice());", "originalCommit": "7ad75d1799e0a89960b9254e5ed922acb55cacdc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkzOTYxMg==", "url": "https://github.com/TownyAdvanced/Towny/pull/4311#discussion_r488939612", "bodyText": "I think you could:\nnextprice = Math.round(Math.pow(TownySettings.getClaimPriceIncreaseValue() , getTownBlocks().size()+i) * TownySettings.getClaimPrice());\n\nif(hasmaxprice)\n\tnextprice = Math.min(nextprice, maxprice);\n\ncost += nextprice;\ni++;\n\nno?", "author": "LlmDl", "createdAt": "2020-09-15T20:01:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkwMTIxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk0NDg0Ng==", "url": "https://github.com/TownyAdvanced/Towny/pull/4311#discussion_r488944846", "bodyText": "I made it\nnextprice = Math.round(Math.pow(TownySettings.getClaimPriceIncreaseValue() , getTownBlocks().size()+i) * TownySettings.getClaimPrice());\n\t\t\t\n\t\t\tif(hasmaxprice && nextprice > maxprice) {\n\t\t\t\tcost += maxprice * ( inputN - i);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\t\n\t\t\tcost += nextprice;\n\t\t\ti++;\n\nnow so that the loop doesn\u00b4t keep running for no reason", "author": "the-codeboy", "createdAt": "2020-09-15T20:12:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkwMTIxOA=="}], "type": "inlineReview", "revised_code": {"commit": "dd89ca4bf19397578240b215e7e5f5903e351602", "chunk": "diff --git a/src/com/palmergames/bukkit/towny/object/Town.java b/src/com/palmergames/bukkit/towny/object/Town.java\nindex 57b04376..0b7268d7 100644\n--- a/src/com/palmergames/bukkit/towny/object/Town.java\n+++ b/src/com/palmergames/bukkit/towny/object/Town.java\n\n@@ -437,10 +437,11 @@ public class Town extends Government implements TownBlockOwner {\n \t\tboolean hasmaxprice = TownySettings.getMaxClaimPrice() != -1;\n \t\tdouble maxprice = TownySettings.getMaxClaimPrice();\n \t\twhile (i < inputN){\n+\t\t\tnextprice = Math.round(Math.pow(TownySettings.getClaimPriceIncreaseValue() , getTownBlocks().size()+i) * TownySettings.getClaimPrice());\n+\t\t\t\n \t\t\tif(hasmaxprice && nextprice > maxprice)\n \t\t\t\tnextprice=maxprice;\n-\t\t\telse\n-\t\t\t\tnextprice = Math.round(Math.pow(TownySettings.getClaimPriceIncreaseValue() , getTownBlocks().size()+i) * TownySettings.getClaimPrice());\n+\t\t\t\n \t\t\tcost += nextprice;\n \t\t\ti++;\n \t\t}\n"}}, {"oid": "dd89ca4bf19397578240b215e7e5f5903e351602", "url": "https://github.com/TownyAdvanced/Towny/commit/dd89ca4bf19397578240b215e7e5f5903e351602", "message": "Update Town.java", "committedDate": "2020-09-15T20:06:08Z", "type": "commit"}, {"oid": "8f68dd379bfb422fd61caa538676029b81a1004c", "url": "https://github.com/TownyAdvanced/Towny/commit/8f68dd379bfb422fd61caa538676029b81a1004c", "message": "Update Town.java", "committedDate": "2020-09-15T20:09:40Z", "type": "commit"}]}