{"pr_number": 15319, "pr_title": "Pinot streaming connector", "pr_createdAt": "2020-10-16T06:54:27Z", "pr_url": "https://github.com/prestodb/presto/pull/15319", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk5ODk2NQ==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r506998965", "bodyText": "I am curious why is this cached ? What happens if an instance restarts etc and comes up with a different port ? Or atleast should the cache expiry interval be minimized ?", "author": "agrawaldevesh", "createdAt": "2020-10-18T00:25:30Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java", "diffHunk": "@@ -110,6 +116,9 @@ public PinotClusterInfoFetcher(\n         this.brokersForTableCache = CacheBuilder.newBuilder()\n                 .expireAfterWrite(cacheExpiryMs, TimeUnit.MILLISECONDS)\n                 .build((CacheLoader.from(this::getAllBrokersForTable)));\n+        this.instanceConfigCache = CacheBuilder.newBuilder()", "originalCommit": "6cb486b66992b1b46c04c06b602ce996b0b5d71f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg2OTMzMw==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r508869333", "bodyText": "Pinot instance is in general stateful and won't change (much). Restart won't change instance/port etc. Unless user explicitly want to change that, which is really rare.\nAlso cache will be expired based on the configurable time.\nThis cache is to avoid call to pinot controller per request(This is 1 call per split, which means if we have 100 segments and using 1 split per segment, then every query will issue 100 calls to pinot controller for this information)", "author": "xiangfu0", "createdAt": "2020-10-20T22:07:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk5ODk2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ5NjgxMQ==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r510496811", "bodyText": "Hmm. Why ? At the very least, I would expect to be making one call per server to get that server's GRPC port. Why is it per split ? I see that the cache is working in lieu of a batched API at the controller.", "author": "agrawaldevesh", "createdAt": "2020-10-22T22:37:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk5ODk2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE4ODEwNA==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r511188104", "bodyText": "In order to get the grpc port, we need to query pinot controller based on pinot instance name.\nWhen doing segment level query, we issue one query for every split (which contains the pinot server to query and the segments to query). For non-grpc query, the port is part of instance id to be parsed, however this is not true for grpc, we need to query pinot controller for grpc port per pinot instance.\nIn the worst case scenario,  assume one pinot table has 100 segments, then one presto query could be split into one segment per split, which means, we will issue 100 queries to pinot servers which means we also need to make 100 calls to pinot controllers for instance grpc port and maybe most of them are asking for the same information.\nHence I want to cache the grpc port here. The first query will go to pinot controller to fetch instance config then extract the grpc port. This info will be cached for 2 minutes. Then the next call will be issued along with the query.", "author": "xiangfu0", "createdAt": "2020-10-23T22:52:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk5ODk2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTMyMDkxNg==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r511320916", "bodyText": "Sounds good. This awesome explanation deserves in the code comments :-) !", "author": "agrawaldevesh", "createdAt": "2020-10-24T05:02:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk5ODk2NQ=="}], "type": "inlineReview", "revised_code": {"commit": "f72c8797b8b84b70fc60f1334f0a376db02c937d", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java\nindex aeb2a330ff..7ea3f4486c 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java\n\n@@ -102,17 +110,17 @@ public class PinotClusterInfoFetcher\n             JsonCodec<TimeBoundary> timeBoundaryJsonCodec,\n             JsonCodec<Instance> instanceJsonCodec)\n     {\n+        this.pinotConfig = requireNonNull(pinotConfig, \"pinotConfig is null\");\n+        this.pinotMetrics = requireNonNull(pinotMetrics, \"pinotMetrics is null\");\n+        this.httpClient = requireNonNull(httpClient, \"httpClient is null\");\n+        this.tablesJsonCodec = requireNonNull(tablesJsonCodec, \"json codec is null\");\n         this.brokersForTableJsonCodec = requireNonNull(brokersForTableJsonCodec, \"brokers for table json codec is null\");\n         this.routingTablesJsonCodec = requireNonNull(routingTablesJsonCodec, \"routing tables json codec is null\");\n         this.routingTablesV2JsonCodec = requireNonNull(routingTablesV2JsonCodec, \"routing tables v2 json codec is null\");\n         this.timeBoundaryJsonCodec = requireNonNull(timeBoundaryJsonCodec, \"time boundary json codec is null\");\n         this.instanceJsonCodec = requireNonNull(instanceJsonCodec, \"instance json codec is null\");\n-        final long cacheExpiryMs = pinotConfig.getMetadataCacheExpiry().roundTo(TimeUnit.MILLISECONDS);\n-        this.tablesJsonCodec = requireNonNull(tablesJsonCodec, \"json codec is null\");\n \n-        this.pinotConfig = requireNonNull(pinotConfig, \"pinotConfig is null\");\n-        this.pinotMetrics = requireNonNull(pinotMetrics, \"pinotMetrics is null\");\n-        this.httpClient = requireNonNull(httpClient, \"httpClient is null\");\n+        final long cacheExpiryMs = pinotConfig.getMetadataCacheExpiry().roundTo(TimeUnit.MILLISECONDS);\n         this.brokersForTableCache = CacheBuilder.newBuilder()\n                 .expireAfterWrite(cacheExpiryMs, TimeUnit.MILLISECONDS)\n                 .build((CacheLoader.from(this::getAllBrokersForTable)));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk5OTAyMQ==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r506999021", "bodyText": "Perhaps you can also add some color to the PR description about when is it a good idea to use streaming for segment query path ? I would imagine, always if available ?", "author": "agrawaldevesh", "createdAt": "2020-10-18T00:26:24Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotConfig.java", "diffHunk": "@@ -490,4 +495,40 @@ public PinotConfig setPushdownTopNBrokerQueries(boolean pushdownTopNBrokerQuerie\n         this.pushdownTopNBrokerQueries = pushdownTopNBrokerQueries;\n         return this;\n     }\n+\n+    public boolean isUseStreamingForSegmentQueries()\n+    {\n+        return useStreamingForSegmentQueries;\n+    }\n+\n+    @Config(\"pinot.use-streaming-for-segment-queries\")", "originalCommit": "6cb486b66992b1b46c04c06b602ce996b0b5d71f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg3NTQ1MQ==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r508875451", "bodyText": "Yes, we should use it whenever possible.", "author": "xiangfu0", "createdAt": "2020-10-20T22:22:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk5OTAyMQ=="}], "type": "inlineReview", "revised_code": {"commit": "1478bd635b9f974e46b2031f1378a132a3e50d6e", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotConfig.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotConfig.java\nindex e31cf4d085..9a8d90c703 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotConfig.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotConfig.java\n\n@@ -531,4 +532,16 @@ public class PinotConfig\n         this.streamingServerGrpcMaxInboundMessageSize = streamingServerGrpcMaxInboundMessageSize;\n         return this;\n     }\n+\n+    public boolean isUsePlainTextForStreamingServer()\n+    {\n+        return usePlainTextForStreamingServer;\n+    }\n+\n+    @Config(\"pinot.use-plain-text-for-streaming-server\")\n+    public PinotConfig setUsePlainTextForStreamingServer(boolean usePlainTextForStreamingServer)\n+    {\n+        this.usePlainTextForStreamingServer = usePlainTextForStreamingServer;\n+        return this;\n+    }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk5OTEzNw==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r506999137", "bodyText": "Perhaps PinotStreamingSegmentPageSource or PinotSegmentStreamingPageSource ?\n`Coz I think that GRPC is an implementation detail and shouldn't be exposed via the class name.", "author": "agrawaldevesh", "createdAt": "2020-10-18T00:28:07Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPageSourceProvider.java", "diffHunk": "@@ -81,12 +90,22 @@ public ConnectorPageSource createPageSource(\n \n         switch (pinotSplit.getSplitType()) {\n             case SEGMENT:\n-                return new PinotSegmentPageSource(\n+                if (this.pinotConfig.isUseStreamingForSegmentQueries()) {\n+                    return new PinotSegmentPageSourceForGrpc(", "originalCommit": "6cb486b66992b1b46c04c06b602ce996b0b5d71f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTI5NDIyNQ==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r511294225", "bodyText": "done", "author": "xiangfu0", "createdAt": "2020-10-24T03:36:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk5OTEzNw=="}], "type": "inlineReview", "revised_code": {"commit": "1478bd635b9f974e46b2031f1378a132a3e50d6e", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPageSourceProvider.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPageSourceProvider.java\nindex a2c2d789d1..385738d7df 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPageSourceProvider.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPageSourceProvider.java\n\n@@ -91,7 +93,7 @@ public class PinotPageSourceProvider\n         switch (pinotSplit.getSplitType()) {\n             case SEGMENT:\n                 if (this.pinotConfig.isUseStreamingForSegmentQueries()) {\n-                    return new PinotSegmentPageSourceForGrpc(\n+                    return new PinotSegmentStreamingPageSource(\n                         session,\n                         this.pinotConfig,\n                         this.pinotStreamingQueryClient,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk5OTI5Ng==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r506999296", "bodyText": "fetchNextPage ?", "author": "agrawaldevesh", "createdAt": "2020-10-18T00:30:27Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSource.java", "diffHunk": "@@ -172,6 +175,11 @@ public Page getNextPage()\n         }\n         currentDataTable = dataTableList.pop();\n \n+        return fillPage();", "originalCommit": "6cb486b66992b1b46c04c06b602ce996b0b5d71f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTI5NDI2OA==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r511294268", "bodyText": "done.", "author": "xiangfu0", "createdAt": "2020-10-24T03:36:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk5OTI5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "1478bd635b9f974e46b2031f1378a132a3e50d6e", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSource.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSource.java\nindex f25dea4f18..23299e92dd 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSource.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSource.java\n\n@@ -175,10 +175,10 @@ public class PinotSegmentPageSource\n         }\n         currentDataTable = dataTableList.pop();\n \n-        return fillPage();\n+        return fillNextPage();\n     }\n \n-    protected Page fillPage()\n+    protected Page fillNextPage()\n     {\n         // This is the list of handles we came up with when generating the PQL\n         // This could be a superset/permutation of the handles being requested in this scan\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwMDE3OQ==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r507000179", "bodyText": "PinotStreamingSegmentPageSource ?", "author": "agrawaldevesh", "createdAt": "2020-10-18T00:44:11Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponseWrapper;\n+import com.facebook.presto.spi.ConnectorSession;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_DATA_FETCH_EXCEPTION;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_INVALID_PQL_GENERATED;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_UNEXPECTED_RESPONSE;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n+ */\n+\n+public class PinotSegmentPageSourceForGrpc", "originalCommit": "6cb486b66992b1b46c04c06b602ce996b0b5d71f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1478bd635b9f974e46b2031f1378a132a3e50d6e", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\nsimilarity index 77%\nrename from presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java\nrename to presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\nindex d8fd54a64e..31aa1790cc 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\n\n@@ -17,7 +17,7 @@ import com.facebook.presto.common.Page;\n import com.facebook.presto.pinot.grpc.Constants;\n import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n-import com.facebook.presto.pinot.grpc.ServerResponseWrapper;\n+import com.facebook.presto.pinot.grpc.ServerResponse;\n import com.facebook.presto.spi.ConnectorSession;\n import org.apache.pinot.common.utils.DataTable;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwMDIzNw==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r507000237", "bodyText": "I didn't follow why this is not: !serverResponseIterator.hasNext()", "author": "agrawaldevesh", "createdAt": "2020-10-18T00:45:01Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponseWrapper;\n+import com.facebook.presto.spi.ConnectorSession;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_DATA_FETCH_EXCEPTION;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_INVALID_PQL_GENERATED;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_UNEXPECTED_RESPONSE;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n+ */\n+\n+public class PinotSegmentPageSourceForGrpc\n+        extends PinotSegmentPageSource\n+{\n+    private final PinotStreamingQueryClient pinotStreamingQueryClient;\n+    private Iterator<ServerResponseWrapper> serverResponseIterator;\n+    private long completedPositions;\n+\n+    public PinotSegmentPageSourceForGrpc(\n+            ConnectorSession session,\n+            PinotConfig pinotConfig,\n+            PinotStreamingQueryClient pinotStreamingQueryClient,\n+            PinotSplit split,\n+            List<PinotColumnHandle> columnHandles)\n+    {\n+        super(session, pinotConfig, null, split, columnHandles);\n+        this.pinotStreamingQueryClient = requireNonNull(pinotStreamingQueryClient, \"pinotStreamingQueryClient is null\");\n+    }\n+\n+    @Override\n+    public boolean isFinished()\n+    {\n+        return closed;", "originalCommit": "6cb486b66992b1b46c04c06b602ce996b0b5d71f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODkwOTM4MQ==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r508909381", "bodyText": "The streaming iterator will return data first and the last part is the result metadata, similar to the query response.\nHence, we need to check the type of response then set the flag.", "author": "xiangfu0", "createdAt": "2020-10-20T23:57:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwMDIzNw=="}], "type": "inlineReview", "revised_code": {"commit": "1478bd635b9f974e46b2031f1378a132a3e50d6e", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\nsimilarity index 77%\nrename from presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java\nrename to presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\nindex d8fd54a64e..31aa1790cc 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\n\n@@ -17,7 +17,7 @@ import com.facebook.presto.common.Page;\n import com.facebook.presto.pinot.grpc.Constants;\n import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n-import com.facebook.presto.pinot.grpc.ServerResponseWrapper;\n+import com.facebook.presto.pinot.grpc.ServerResponse;\n import com.facebook.presto.spi.ConnectorSession;\n import org.apache.pinot.common.utils.DataTable;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwMDMwMQ==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r507000301", "bodyText": "This is a bit confusing: Because if you inline this, it reads as:\nif (closed) {\n  close();\n  return null;\n}", "author": "agrawaldevesh", "createdAt": "2020-10-18T00:45:40Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponseWrapper;\n+import com.facebook.presto.spi.ConnectorSession;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_DATA_FETCH_EXCEPTION;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_INVALID_PQL_GENERATED;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_UNEXPECTED_RESPONSE;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n+ */\n+\n+public class PinotSegmentPageSourceForGrpc\n+        extends PinotSegmentPageSource\n+{\n+    private final PinotStreamingQueryClient pinotStreamingQueryClient;\n+    private Iterator<ServerResponseWrapper> serverResponseIterator;\n+    private long completedPositions;\n+\n+    public PinotSegmentPageSourceForGrpc(\n+            ConnectorSession session,\n+            PinotConfig pinotConfig,\n+            PinotStreamingQueryClient pinotStreamingQueryClient,\n+            PinotSplit split,\n+            List<PinotColumnHandle> columnHandles)\n+    {\n+        super(session, pinotConfig, null, split, columnHandles);\n+        this.pinotStreamingQueryClient = requireNonNull(pinotStreamingQueryClient, \"pinotStreamingQueryClient is null\");\n+    }\n+\n+    @Override\n+    public boolean isFinished()\n+    {\n+        return closed;\n+    }\n+\n+    /**\n+     * @return constructed page for pinot data.\n+     */\n+    @Override\n+    public Page getNextPage()\n+    {\n+        if (isFinished()) {", "originalCommit": "6cb486b66992b1b46c04c06b602ce996b0b5d71f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODkxMTA1MQ==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r508911051", "bodyText": "right, will simplify this code.", "author": "xiangfu0", "createdAt": "2020-10-21T00:00:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwMDMwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "1478bd635b9f974e46b2031f1378a132a3e50d6e", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\nsimilarity index 77%\nrename from presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java\nrename to presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\nindex d8fd54a64e..31aa1790cc 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\n\n@@ -17,7 +17,7 @@ import com.facebook.presto.common.Page;\n import com.facebook.presto.pinot.grpc.Constants;\n import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n-import com.facebook.presto.pinot.grpc.ServerResponseWrapper;\n+import com.facebook.presto.pinot.grpc.ServerResponse;\n import com.facebook.presto.spi.ConnectorSession;\n import org.apache.pinot.common.utils.DataTable;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwMDQ2NQ==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r507000465", "bodyText": "I think the exception e needs to be chained to the new PinotException and not String.format", "author": "agrawaldevesh", "createdAt": "2020-10-18T00:48:15Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponseWrapper;\n+import com.facebook.presto.spi.ConnectorSession;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_DATA_FETCH_EXCEPTION;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_INVALID_PQL_GENERATED;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_UNEXPECTED_RESPONSE;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n+ */\n+\n+public class PinotSegmentPageSourceForGrpc\n+        extends PinotSegmentPageSource\n+{\n+    private final PinotStreamingQueryClient pinotStreamingQueryClient;\n+    private Iterator<ServerResponseWrapper> serverResponseIterator;\n+    private long completedPositions;\n+\n+    public PinotSegmentPageSourceForGrpc(\n+            ConnectorSession session,\n+            PinotConfig pinotConfig,\n+            PinotStreamingQueryClient pinotStreamingQueryClient,\n+            PinotSplit split,\n+            List<PinotColumnHandle> columnHandles)\n+    {\n+        super(session, pinotConfig, null, split, columnHandles);\n+        this.pinotStreamingQueryClient = requireNonNull(pinotStreamingQueryClient, \"pinotStreamingQueryClient is null\");\n+    }\n+\n+    @Override\n+    public boolean isFinished()\n+    {\n+        return closed;\n+    }\n+\n+    /**\n+     * @return constructed page for pinot data.\n+     */\n+    @Override\n+    public Page getNextPage()\n+    {\n+        if (isFinished()) {\n+            close();\n+            return null;\n+        }\n+        if (serverResponseIterator == null) {\n+            serverResponseIterator = queryPinot(split);\n+        }\n+        ByteBuffer byteBuffer = null;\n+        if (serverResponseIterator.hasNext()) {\n+            long startTimeNanos = System.nanoTime();\n+            ServerResponseWrapper serverResponse = serverResponseIterator.next();\n+            readTimeNanos += System.nanoTime() - startTimeNanos;\n+            switch (serverResponse.getResponseType()) {\n+                case Constants.Response.ResponseType.DATA:\n+                    estimatedMemoryUsageInBytes = serverResponse.getSerializedSize();\n+                    // Store each dataTable which will later be constructed into Pages.\n+                    try {\n+                        byteBuffer = serverResponse.getPayloadReadOnlyByteBuffer();\n+                        DataTable dataTable = serverResponse.getDataTable(byteBuffer);\n+                        checkExceptions(dataTable, split, PinotSessionProperties.isMarkDataFetchExceptionsAsRetriable(session));\n+                        currentDataTable = new PinotSegmentPageSource.PinotDataTableWithSize(dataTable, serverResponse.getSerializedSize());\n+                    }\n+                    catch (IOException e) {\n+                        throw new PinotException(\n+                            PINOT_DATA_FETCH_EXCEPTION,\n+                            split.getSegmentPql(),\n+                            String.format(\"Encountered Pinot exceptions when fetching data table from %s: %s\", split, e));", "originalCommit": "6cb486b66992b1b46c04c06b602ce996b0b5d71f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1478bd635b9f974e46b2031f1378a132a3e50d6e", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\nsimilarity index 77%\nrename from presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java\nrename to presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\nindex d8fd54a64e..31aa1790cc 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\n\n@@ -17,7 +17,7 @@ import com.facebook.presto.common.Page;\n import com.facebook.presto.pinot.grpc.Constants;\n import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n-import com.facebook.presto.pinot.grpc.ServerResponseWrapper;\n+import com.facebook.presto.pinot.grpc.ServerResponse;\n import com.facebook.presto.spi.ConnectorSession;\n import org.apache.pinot.common.utils.DataTable;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwMDY2MA==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r507000660", "bodyText": "When does this case occur ? It seems odd to me to have a global GRPC port defined in the config ... is this an error or does this case happen in certain upgrade situations ?", "author": "agrawaldevesh", "createdAt": "2020-10-18T00:50:53Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponseWrapper;\n+import com.facebook.presto.spi.ConnectorSession;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_DATA_FETCH_EXCEPTION;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_INVALID_PQL_GENERATED;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_UNEXPECTED_RESPONSE;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n+ */\n+\n+public class PinotSegmentPageSourceForGrpc\n+        extends PinotSegmentPageSource\n+{\n+    private final PinotStreamingQueryClient pinotStreamingQueryClient;\n+    private Iterator<ServerResponseWrapper> serverResponseIterator;\n+    private long completedPositions;\n+\n+    public PinotSegmentPageSourceForGrpc(\n+            ConnectorSession session,\n+            PinotConfig pinotConfig,\n+            PinotStreamingQueryClient pinotStreamingQueryClient,\n+            PinotSplit split,\n+            List<PinotColumnHandle> columnHandles)\n+    {\n+        super(session, pinotConfig, null, split, columnHandles);\n+        this.pinotStreamingQueryClient = requireNonNull(pinotStreamingQueryClient, \"pinotStreamingQueryClient is null\");\n+    }\n+\n+    @Override\n+    public boolean isFinished()\n+    {\n+        return closed;\n+    }\n+\n+    /**\n+     * @return constructed page for pinot data.\n+     */\n+    @Override\n+    public Page getNextPage()\n+    {\n+        if (isFinished()) {\n+            close();\n+            return null;\n+        }\n+        if (serverResponseIterator == null) {\n+            serverResponseIterator = queryPinot(split);\n+        }\n+        ByteBuffer byteBuffer = null;\n+        if (serverResponseIterator.hasNext()) {\n+            long startTimeNanos = System.nanoTime();\n+            ServerResponseWrapper serverResponse = serverResponseIterator.next();\n+            readTimeNanos += System.nanoTime() - startTimeNanos;\n+            switch (serverResponse.getResponseType()) {\n+                case Constants.Response.ResponseType.DATA:\n+                    estimatedMemoryUsageInBytes = serverResponse.getSerializedSize();\n+                    // Store each dataTable which will later be constructed into Pages.\n+                    try {\n+                        byteBuffer = serverResponse.getPayloadReadOnlyByteBuffer();\n+                        DataTable dataTable = serverResponse.getDataTable(byteBuffer);\n+                        checkExceptions(dataTable, split, PinotSessionProperties.isMarkDataFetchExceptionsAsRetriable(session));\n+                        currentDataTable = new PinotSegmentPageSource.PinotDataTableWithSize(dataTable, serverResponse.getSerializedSize());\n+                    }\n+                    catch (IOException e) {\n+                        throw new PinotException(\n+                            PINOT_DATA_FETCH_EXCEPTION,\n+                            split.getSegmentPql(),\n+                            String.format(\"Encountered Pinot exceptions when fetching data table from %s: %s\", split, e));\n+                    }\n+                    break;\n+                case Constants.Response.ResponseType.METADATA:\n+                    // The last part of the response is Metadata\n+                    currentDataTable = null;\n+                    serverResponseIterator = null;\n+                    close();\n+                    return null;\n+                default:\n+                    throw new PinotException(\n+                        PINOT_UNEXPECTED_RESPONSE,\n+                        split.getSegmentPql(),\n+                        String.format(\"Encountered Pinot exceptions, unknown response type - %s\", serverResponse.getResponseType()));\n+            }\n+        }\n+        Page page = fillPage();\n+        completedPositions += currentDataTable.getDataTable().getNumberOfRows();\n+        if (byteBuffer != null) {\n+            byteBuffer.clear();\n+        }\n+        return page;\n+    }\n+\n+    private Iterator<ServerResponseWrapper> queryPinot(PinotSplit split)\n+    {\n+        String sql = split.getSegmentPql().orElseThrow(() -> new PinotException(PINOT_INVALID_PQL_GENERATED, Optional.empty(), \"Expected the segment split to contain the pql\"));\n+        String host = split.getSegmentHost().orElseThrow(() -> new PinotException(PINOT_INVALID_PQL_GENERATED, Optional.empty(), \"Expected the segment split to contain the host\"));\n+        String[] hostSplits = host.split(\"_\");\n+        String grpcHost = (hostSplits.length > 1) ? hostSplits[hostSplits.length - 2] : host;\n+        int grpcPort = split.getGrpcPort().isPresent() ? split.getGrpcPort().get() : 0;\n+        // Fallback to default grpc port set by Pinot config.", "originalCommit": "6cb486b66992b1b46c04c06b602ce996b0b5d71f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODkxMjQwOQ==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r508912409", "bodyText": "This is more about system integration and upgrade steps:\nPinot added the gRpcPort field into instance config later than the streaming connector, so this API call may not get the real gRpc port back, hence we need a fallback global gRpc port.\nBasically the logic is that, if we can read the port from instance config, we use it, otherwise go to look at the default gRpc port.", "author": "xiangfu0", "createdAt": "2020-10-21T00:05:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwMDY2MA=="}], "type": "inlineReview", "revised_code": {"commit": "1478bd635b9f974e46b2031f1378a132a3e50d6e", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\nsimilarity index 77%\nrename from presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java\nrename to presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\nindex d8fd54a64e..31aa1790cc 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\n\n@@ -17,7 +17,7 @@ import com.facebook.presto.common.Page;\n import com.facebook.presto.pinot.grpc.Constants;\n import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n-import com.facebook.presto.pinot.grpc.ServerResponseWrapper;\n+import com.facebook.presto.pinot.grpc.ServerResponse;\n import com.facebook.presto.spi.ConnectorSession;\n import org.apache.pinot.common.utils.DataTable;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwMTAyNw==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r507001027", "bodyText": "I didn't follow the need for these changes around the extra arguments to addTime ? Is this required by prestodb/presto-pinot-driver#5 ?", "author": "agrawaldevesh", "createdAt": "2020-10-18T00:56:24Z", "path": "presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/TestPinotColumnMetadata.java", "diffHunk": "@@ -63,7 +63,7 @@ public void testParsePinotSchemaToPinotColumns()\n                 .addMetric(\"floatMetric\", FieldSpec.DataType.FLOAT)\n                 .addMetric(\"doubleMetric\", FieldSpec.DataType.DOUBLE)\n                 .addMetric(\"bytesMetric\", FieldSpec.DataType.BYTES)\n-                .addTime(new TimeGranularitySpec(FieldSpec.DataType.INT, TimeUnit.DAYS, \"daysSinceEpoch\"))\n+                .addTime(new TimeGranularitySpec(FieldSpec.DataType.INT, TimeUnit.DAYS, \"daysSinceEpoch\"), new TimeGranularitySpec(FieldSpec.DataType.INT, TimeUnit.DAYS, \"daysSinceEpoch\"))", "originalCommit": "6cb486b66992b1b46c04c06b602ce996b0b5d71f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODkxMjc2Mg==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r508912762", "bodyText": "We are bumping directly from pinot lib 0.1.0 to 0.5.0 after the upgrade.\nSo the old API is already deprecated and removed.", "author": "xiangfu0", "createdAt": "2020-10-21T00:06:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwMTAyNw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwMTE2MA==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r507001160", "bodyText": "Is this PQL or SQL ? the variable name says SQL, but I think the pinot server only speaks PQL ?", "author": "agrawaldevesh", "createdAt": "2020-10-18T00:58:13Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponseWrapper;\n+import com.facebook.presto.spi.ConnectorSession;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_DATA_FETCH_EXCEPTION;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_INVALID_PQL_GENERATED;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_UNEXPECTED_RESPONSE;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n+ */\n+\n+public class PinotSegmentPageSourceForGrpc\n+        extends PinotSegmentPageSource\n+{\n+    private final PinotStreamingQueryClient pinotStreamingQueryClient;\n+    private Iterator<ServerResponseWrapper> serverResponseIterator;\n+    private long completedPositions;\n+\n+    public PinotSegmentPageSourceForGrpc(\n+            ConnectorSession session,\n+            PinotConfig pinotConfig,\n+            PinotStreamingQueryClient pinotStreamingQueryClient,\n+            PinotSplit split,\n+            List<PinotColumnHandle> columnHandles)\n+    {\n+        super(session, pinotConfig, null, split, columnHandles);\n+        this.pinotStreamingQueryClient = requireNonNull(pinotStreamingQueryClient, \"pinotStreamingQueryClient is null\");\n+    }\n+\n+    @Override\n+    public boolean isFinished()\n+    {\n+        return closed;\n+    }\n+\n+    /**\n+     * @return constructed page for pinot data.\n+     */\n+    @Override\n+    public Page getNextPage()\n+    {\n+        if (isFinished()) {\n+            close();\n+            return null;\n+        }\n+        if (serverResponseIterator == null) {\n+            serverResponseIterator = queryPinot(split);\n+        }\n+        ByteBuffer byteBuffer = null;\n+        if (serverResponseIterator.hasNext()) {\n+            long startTimeNanos = System.nanoTime();\n+            ServerResponseWrapper serverResponse = serverResponseIterator.next();\n+            readTimeNanos += System.nanoTime() - startTimeNanos;\n+            switch (serverResponse.getResponseType()) {\n+                case Constants.Response.ResponseType.DATA:\n+                    estimatedMemoryUsageInBytes = serverResponse.getSerializedSize();\n+                    // Store each dataTable which will later be constructed into Pages.\n+                    try {\n+                        byteBuffer = serverResponse.getPayloadReadOnlyByteBuffer();\n+                        DataTable dataTable = serverResponse.getDataTable(byteBuffer);\n+                        checkExceptions(dataTable, split, PinotSessionProperties.isMarkDataFetchExceptionsAsRetriable(session));\n+                        currentDataTable = new PinotSegmentPageSource.PinotDataTableWithSize(dataTable, serverResponse.getSerializedSize());\n+                    }\n+                    catch (IOException e) {\n+                        throw new PinotException(\n+                            PINOT_DATA_FETCH_EXCEPTION,\n+                            split.getSegmentPql(),\n+                            String.format(\"Encountered Pinot exceptions when fetching data table from %s: %s\", split, e));\n+                    }\n+                    break;\n+                case Constants.Response.ResponseType.METADATA:\n+                    // The last part of the response is Metadata\n+                    currentDataTable = null;\n+                    serverResponseIterator = null;\n+                    close();\n+                    return null;\n+                default:\n+                    throw new PinotException(\n+                        PINOT_UNEXPECTED_RESPONSE,\n+                        split.getSegmentPql(),\n+                        String.format(\"Encountered Pinot exceptions, unknown response type - %s\", serverResponse.getResponseType()));\n+            }\n+        }\n+        Page page = fillPage();\n+        completedPositions += currentDataTable.getDataTable().getNumberOfRows();\n+        if (byteBuffer != null) {\n+            byteBuffer.clear();\n+        }\n+        return page;\n+    }\n+\n+    private Iterator<ServerResponseWrapper> queryPinot(PinotSplit split)\n+    {\n+        String sql = split.getSegmentPql().orElseThrow(() -> new PinotException(PINOT_INVALID_PQL_GENERATED, Optional.empty(), \"Expected the segment split to contain the pql\"));", "originalCommit": "6cb486b66992b1b46c04c06b602ce996b0b5d71f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODkxMjk5Mg==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r508912992", "bodyText": "For segment query, the syntax is the same, and we are using Pinot SQL for query processing.", "author": "xiangfu0", "createdAt": "2020-10-21T00:07:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwMTE2MA=="}], "type": "inlineReview", "revised_code": {"commit": "1478bd635b9f974e46b2031f1378a132a3e50d6e", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\nsimilarity index 77%\nrename from presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java\nrename to presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\nindex d8fd54a64e..31aa1790cc 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\n\n@@ -17,7 +17,7 @@ import com.facebook.presto.common.Page;\n import com.facebook.presto.pinot.grpc.Constants;\n import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n-import com.facebook.presto.pinot.grpc.ServerResponseWrapper;\n+import com.facebook.presto.pinot.grpc.ServerResponse;\n import com.facebook.presto.spi.ConnectorSession;\n import org.apache.pinot.common.utils.DataTable;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwMTE3OA==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r507001178", "bodyText": "PINOT_INVALID_PQL_GENERATED seems like a wrong enum here.", "author": "agrawaldevesh", "createdAt": "2020-10-18T00:58:36Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponseWrapper;\n+import com.facebook.presto.spi.ConnectorSession;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_DATA_FETCH_EXCEPTION;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_INVALID_PQL_GENERATED;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_UNEXPECTED_RESPONSE;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n+ */\n+\n+public class PinotSegmentPageSourceForGrpc\n+        extends PinotSegmentPageSource\n+{\n+    private final PinotStreamingQueryClient pinotStreamingQueryClient;\n+    private Iterator<ServerResponseWrapper> serverResponseIterator;\n+    private long completedPositions;\n+\n+    public PinotSegmentPageSourceForGrpc(\n+            ConnectorSession session,\n+            PinotConfig pinotConfig,\n+            PinotStreamingQueryClient pinotStreamingQueryClient,\n+            PinotSplit split,\n+            List<PinotColumnHandle> columnHandles)\n+    {\n+        super(session, pinotConfig, null, split, columnHandles);\n+        this.pinotStreamingQueryClient = requireNonNull(pinotStreamingQueryClient, \"pinotStreamingQueryClient is null\");\n+    }\n+\n+    @Override\n+    public boolean isFinished()\n+    {\n+        return closed;\n+    }\n+\n+    /**\n+     * @return constructed page for pinot data.\n+     */\n+    @Override\n+    public Page getNextPage()\n+    {\n+        if (isFinished()) {\n+            close();\n+            return null;\n+        }\n+        if (serverResponseIterator == null) {\n+            serverResponseIterator = queryPinot(split);\n+        }\n+        ByteBuffer byteBuffer = null;\n+        if (serverResponseIterator.hasNext()) {\n+            long startTimeNanos = System.nanoTime();\n+            ServerResponseWrapper serverResponse = serverResponseIterator.next();\n+            readTimeNanos += System.nanoTime() - startTimeNanos;\n+            switch (serverResponse.getResponseType()) {\n+                case Constants.Response.ResponseType.DATA:\n+                    estimatedMemoryUsageInBytes = serverResponse.getSerializedSize();\n+                    // Store each dataTable which will later be constructed into Pages.\n+                    try {\n+                        byteBuffer = serverResponse.getPayloadReadOnlyByteBuffer();\n+                        DataTable dataTable = serverResponse.getDataTable(byteBuffer);\n+                        checkExceptions(dataTable, split, PinotSessionProperties.isMarkDataFetchExceptionsAsRetriable(session));\n+                        currentDataTable = new PinotSegmentPageSource.PinotDataTableWithSize(dataTable, serverResponse.getSerializedSize());\n+                    }\n+                    catch (IOException e) {\n+                        throw new PinotException(\n+                            PINOT_DATA_FETCH_EXCEPTION,\n+                            split.getSegmentPql(),\n+                            String.format(\"Encountered Pinot exceptions when fetching data table from %s: %s\", split, e));\n+                    }\n+                    break;\n+                case Constants.Response.ResponseType.METADATA:\n+                    // The last part of the response is Metadata\n+                    currentDataTable = null;\n+                    serverResponseIterator = null;\n+                    close();\n+                    return null;\n+                default:\n+                    throw new PinotException(\n+                        PINOT_UNEXPECTED_RESPONSE,\n+                        split.getSegmentPql(),\n+                        String.format(\"Encountered Pinot exceptions, unknown response type - %s\", serverResponse.getResponseType()));\n+            }\n+        }\n+        Page page = fillPage();\n+        completedPositions += currentDataTable.getDataTable().getNumberOfRows();\n+        if (byteBuffer != null) {\n+            byteBuffer.clear();\n+        }\n+        return page;\n+    }\n+\n+    private Iterator<ServerResponseWrapper> queryPinot(PinotSplit split)\n+    {\n+        String sql = split.getSegmentPql().orElseThrow(() -> new PinotException(PINOT_INVALID_PQL_GENERATED, Optional.empty(), \"Expected the segment split to contain the pql\"));\n+        String host = split.getSegmentHost().orElseThrow(() -> new PinotException(PINOT_INVALID_PQL_GENERATED, Optional.empty(), \"Expected the segment split to contain the host\"));", "originalCommit": "6cb486b66992b1b46c04c06b602ce996b0b5d71f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODkxMzU3OQ==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r508913579", "bodyText": "will update", "author": "xiangfu0", "createdAt": "2020-10-21T00:09:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwMTE3OA=="}], "type": "inlineReview", "revised_code": {"commit": "1478bd635b9f974e46b2031f1378a132a3e50d6e", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\nsimilarity index 77%\nrename from presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java\nrename to presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\nindex d8fd54a64e..31aa1790cc 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\n\n@@ -17,7 +17,7 @@ import com.facebook.presto.common.Page;\n import com.facebook.presto.pinot.grpc.Constants;\n import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n-import com.facebook.presto.pinot.grpc.ServerResponseWrapper;\n+import com.facebook.presto.pinot.grpc.ServerResponse;\n import com.facebook.presto.spi.ConnectorSession;\n import org.apache.pinot.common.utils.DataTable;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwMTM5Ng==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r507001396", "bodyText": "I didn't follow this part: Does the host in the split now contain two hostnames ? The GRPC one and the regular one ? An example of the response returned by the server would be helpful in the code comments.\nCan this stuff be done by the split manager when creating the splits ? Ideally you want the splits to be very definitive about what behavior will happen at execution time.", "author": "agrawaldevesh", "createdAt": "2020-10-18T01:01:35Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponseWrapper;\n+import com.facebook.presto.spi.ConnectorSession;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_DATA_FETCH_EXCEPTION;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_INVALID_PQL_GENERATED;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_UNEXPECTED_RESPONSE;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n+ */\n+\n+public class PinotSegmentPageSourceForGrpc\n+        extends PinotSegmentPageSource\n+{\n+    private final PinotStreamingQueryClient pinotStreamingQueryClient;\n+    private Iterator<ServerResponseWrapper> serverResponseIterator;\n+    private long completedPositions;\n+\n+    public PinotSegmentPageSourceForGrpc(\n+            ConnectorSession session,\n+            PinotConfig pinotConfig,\n+            PinotStreamingQueryClient pinotStreamingQueryClient,\n+            PinotSplit split,\n+            List<PinotColumnHandle> columnHandles)\n+    {\n+        super(session, pinotConfig, null, split, columnHandles);\n+        this.pinotStreamingQueryClient = requireNonNull(pinotStreamingQueryClient, \"pinotStreamingQueryClient is null\");\n+    }\n+\n+    @Override\n+    public boolean isFinished()\n+    {\n+        return closed;\n+    }\n+\n+    /**\n+     * @return constructed page for pinot data.\n+     */\n+    @Override\n+    public Page getNextPage()\n+    {\n+        if (isFinished()) {\n+            close();\n+            return null;\n+        }\n+        if (serverResponseIterator == null) {\n+            serverResponseIterator = queryPinot(split);\n+        }\n+        ByteBuffer byteBuffer = null;\n+        if (serverResponseIterator.hasNext()) {\n+            long startTimeNanos = System.nanoTime();\n+            ServerResponseWrapper serverResponse = serverResponseIterator.next();\n+            readTimeNanos += System.nanoTime() - startTimeNanos;\n+            switch (serverResponse.getResponseType()) {\n+                case Constants.Response.ResponseType.DATA:\n+                    estimatedMemoryUsageInBytes = serverResponse.getSerializedSize();\n+                    // Store each dataTable which will later be constructed into Pages.\n+                    try {\n+                        byteBuffer = serverResponse.getPayloadReadOnlyByteBuffer();\n+                        DataTable dataTable = serverResponse.getDataTable(byteBuffer);\n+                        checkExceptions(dataTable, split, PinotSessionProperties.isMarkDataFetchExceptionsAsRetriable(session));\n+                        currentDataTable = new PinotSegmentPageSource.PinotDataTableWithSize(dataTable, serverResponse.getSerializedSize());\n+                    }\n+                    catch (IOException e) {\n+                        throw new PinotException(\n+                            PINOT_DATA_FETCH_EXCEPTION,\n+                            split.getSegmentPql(),\n+                            String.format(\"Encountered Pinot exceptions when fetching data table from %s: %s\", split, e));\n+                    }\n+                    break;\n+                case Constants.Response.ResponseType.METADATA:\n+                    // The last part of the response is Metadata\n+                    currentDataTable = null;\n+                    serverResponseIterator = null;\n+                    close();\n+                    return null;\n+                default:\n+                    throw new PinotException(\n+                        PINOT_UNEXPECTED_RESPONSE,\n+                        split.getSegmentPql(),\n+                        String.format(\"Encountered Pinot exceptions, unknown response type - %s\", serverResponse.getResponseType()));\n+            }\n+        }\n+        Page page = fillPage();\n+        completedPositions += currentDataTable.getDataTable().getNumberOfRows();\n+        if (byteBuffer != null) {\n+            byteBuffer.clear();\n+        }\n+        return page;\n+    }\n+\n+    private Iterator<ServerResponseWrapper> queryPinot(PinotSplit split)\n+    {\n+        String sql = split.getSegmentPql().orElseThrow(() -> new PinotException(PINOT_INVALID_PQL_GENERATED, Optional.empty(), \"Expected the segment split to contain the pql\"));\n+        String host = split.getSegmentHost().orElseThrow(() -> new PinotException(PINOT_INVALID_PQL_GENERATED, Optional.empty(), \"Expected the segment split to contain the host\"));\n+        String[] hostSplits = host.split(\"_\");\n+        String grpcHost = (hostSplits.length > 1) ? hostSplits[hostSplits.length - 2] : host;", "originalCommit": "6cb486b66992b1b46c04c06b602ce996b0b5d71f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODkxNDI5OA==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r508914298", "bodyText": "pinot server instance is named as Server_${hostname}_${port}, however this port is not gRpc port.\nHence we need to use this instance name to query Pinot controller for the instance config which contains the gRpc port.\nI can embed this logic to split.", "author": "xiangfu0", "createdAt": "2020-10-21T00:11:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwMTM5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "1478bd635b9f974e46b2031f1378a132a3e50d6e", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\nsimilarity index 77%\nrename from presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java\nrename to presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\nindex d8fd54a64e..31aa1790cc 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\n\n@@ -17,7 +17,7 @@ import com.facebook.presto.common.Page;\n import com.facebook.presto.pinot.grpc.Constants;\n import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n-import com.facebook.presto.pinot.grpc.ServerResponseWrapper;\n+import com.facebook.presto.pinot.grpc.ServerResponse;\n import com.facebook.presto.spi.ConnectorSession;\n import org.apache.pinot.common.utils.DataTable;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwMTUyOA==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r507001528", "bodyText": "Same comment as in PinogSegmentPageSourceForGrpc below", "author": "agrawaldevesh", "createdAt": "2020-10-18T01:03:50Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java", "diffHunk": "@@ -486,4 +496,101 @@ public TimeBoundary getTimeBoundaryForTable(String table)\n             throw e;\n         }\n     }\n+\n+    public static class Instance\n+    {\n+        private final String instanceName;\n+        private final String hostName;\n+        private final boolean enabled;\n+        private final int port;\n+        private final int grpcPort;\n+        private final List<String> tags;\n+        private final List<String> pools;\n+\n+        @JsonCreator\n+        public Instance(\n+                @JsonProperty String instanceName,\n+                @JsonProperty String hostName,\n+                @JsonProperty boolean enabled,\n+                @JsonProperty int port,\n+                @JsonProperty int grpcPort,\n+                @JsonProperty List<String> tags,\n+                @JsonProperty List<String> pools)\n+        {\n+            this.instanceName = instanceName;\n+            this.hostName = hostName;\n+            this.enabled = enabled;\n+            this.port = port;\n+            this.grpcPort = grpcPort;\n+            this.tags = tags;\n+            this.pools = pools;\n+        }\n+\n+        public String getInstanceName()\n+        {\n+            return instanceName;\n+        }\n+\n+        public String getHostName()\n+        {\n+            return hostName;\n+        }\n+\n+        public boolean isEnabled()\n+        {\n+            return enabled;\n+        }\n+\n+        public int getPort()\n+        {\n+            return port;\n+        }\n+\n+        public int getGrpcPort()\n+        {\n+            return grpcPort;\n+        }\n+\n+        public List<String> getTags()\n+        {\n+            return tags;\n+        }\n+\n+        public List<String> getPools()\n+        {\n+            return pools;\n+        }\n+    }\n+\n+    public Instance getInstance(String instanceName)\n+    {\n+        try {\n+            String responseBody = sendHttpGetToController(String.format(INSTANCE_API_TEMPLATE, instanceName));\n+            return instanceJsonCodec.fromJson(responseBody);\n+        }\n+        catch (Exception throwable) {\n+            throw new PinotException(PINOT_UNABLE_TO_FIND_INSTANCE, Optional.empty(), \"Error when fetching instance configs for \" + instanceName, throwable);\n+        }\n+    }\n+\n+    public int getGrpcPort(String serverInstance)\n+    {\n+        try {\n+            int grpcPort = instanceConfigCache.get(serverInstance).getGrpcPort();\n+            if (grpcPort <= 0) {", "originalCommit": "6cb486b66992b1b46c04c06b602ce996b0b5d71f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1478bd635b9f974e46b2031f1378a132a3e50d6e", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java\nindex aeb2a330ff..49bc12fa2d 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java\n\n@@ -583,13 +583,13 @@ public class PinotClusterInfoFetcher\n             return grpcPort;\n         }\n         catch (ExecutionException e) {\n-            Throwable throwable = e.getCause();\n-            if (throwable instanceof PinotException) {\n-                throw (PinotException) throwable;\n+            Throwable cause = e.getCause();\n+            if (cause instanceof PinotException) {\n+                throw (PinotException) cause;\n             }\n             else {\n                 throw new PinotException(PINOT_UNABLE_TO_FIND_INSTANCE, Optional.empty(),\n-                    \"Error when getting instance config for \" + serverInstance, throwable);\n+                    \"Error when getting instance config for \" + serverInstance, cause);\n             }\n         }\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwMTYyMw==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r507001623", "bodyText": "nit: Change throwable to cause", "author": "agrawaldevesh", "createdAt": "2020-10-18T01:05:07Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java", "diffHunk": "@@ -486,4 +496,101 @@ public TimeBoundary getTimeBoundaryForTable(String table)\n             throw e;\n         }\n     }\n+\n+    public static class Instance\n+    {\n+        private final String instanceName;\n+        private final String hostName;\n+        private final boolean enabled;\n+        private final int port;\n+        private final int grpcPort;\n+        private final List<String> tags;\n+        private final List<String> pools;\n+\n+        @JsonCreator\n+        public Instance(\n+                @JsonProperty String instanceName,\n+                @JsonProperty String hostName,\n+                @JsonProperty boolean enabled,\n+                @JsonProperty int port,\n+                @JsonProperty int grpcPort,\n+                @JsonProperty List<String> tags,\n+                @JsonProperty List<String> pools)\n+        {\n+            this.instanceName = instanceName;\n+            this.hostName = hostName;\n+            this.enabled = enabled;\n+            this.port = port;\n+            this.grpcPort = grpcPort;\n+            this.tags = tags;\n+            this.pools = pools;\n+        }\n+\n+        public String getInstanceName()\n+        {\n+            return instanceName;\n+        }\n+\n+        public String getHostName()\n+        {\n+            return hostName;\n+        }\n+\n+        public boolean isEnabled()\n+        {\n+            return enabled;\n+        }\n+\n+        public int getPort()\n+        {\n+            return port;\n+        }\n+\n+        public int getGrpcPort()\n+        {\n+            return grpcPort;\n+        }\n+\n+        public List<String> getTags()\n+        {\n+            return tags;\n+        }\n+\n+        public List<String> getPools()\n+        {\n+            return pools;\n+        }\n+    }\n+\n+    public Instance getInstance(String instanceName)\n+    {\n+        try {\n+            String responseBody = sendHttpGetToController(String.format(INSTANCE_API_TEMPLATE, instanceName));\n+            return instanceJsonCodec.fromJson(responseBody);\n+        }\n+        catch (Exception throwable) {\n+            throw new PinotException(PINOT_UNABLE_TO_FIND_INSTANCE, Optional.empty(), \"Error when fetching instance configs for \" + instanceName, throwable);\n+        }\n+    }\n+\n+    public int getGrpcPort(String serverInstance)\n+    {\n+        try {\n+            int grpcPort = instanceConfigCache.get(serverInstance).getGrpcPort();\n+            if (grpcPort <= 0) {\n+                grpcPort = pinotConfig.getServerGrpcPort();\n+            }\n+            return grpcPort;\n+        }\n+        catch (ExecutionException e) {\n+            Throwable throwable = e.getCause();", "originalCommit": "6cb486b66992b1b46c04c06b602ce996b0b5d71f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1478bd635b9f974e46b2031f1378a132a3e50d6e", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java\nindex aeb2a330ff..49bc12fa2d 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java\n\n@@ -583,13 +583,13 @@ public class PinotClusterInfoFetcher\n             return grpcPort;\n         }\n         catch (ExecutionException e) {\n-            Throwable throwable = e.getCause();\n-            if (throwable instanceof PinotException) {\n-                throw (PinotException) throwable;\n+            Throwable cause = e.getCause();\n+            if (cause instanceof PinotException) {\n+                throw (PinotException) cause;\n             }\n             else {\n                 throw new PinotException(PINOT_UNABLE_TO_FIND_INSTANCE, Optional.empty(),\n-                    \"Error when getting instance config for \" + serverInstance, throwable);\n+                    \"Error when getting instance config for \" + serverInstance, cause);\n             }\n         }\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwMTk4Mw==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r507001983", "bodyText": "If I am reading this line correctly, it means that we will always be using the GRPC mode if the server supports it. Is that intentional ? If so, what does the PinotConfig.isUseStreamingForSegmentQueries imply ?\nPerhaps don't provide the GRPC port if !isUseStreamingForSegmentQueries ?", "author": "agrawaldevesh", "createdAt": "2020-10-18T01:10:18Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSplitManager.java", "diffHunk": "@@ -123,11 +123,16 @@ protected void generateSegmentSplits(\n                 // segments is already shuffled\n                 Iterables.partition(segments, numSegmentsInThisSplit).forEach(\n                         segmentsForThisSplit -> splits.add(\n-                                createSegmentSplit(connectorId, pql, expectedColumnHandles, segmentsForThisSplit, host)));\n+                                createSegmentSplit(connectorId, pql, expectedColumnHandles, segmentsForThisSplit, host, getGrpcPort(host))));", "originalCommit": "6cb486b66992b1b46c04c06b602ce996b0b5d71f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODkxNzgzNQ==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r508917835", "bodyText": "So we will always set grpc port into a pinot split.\nThen in PinotPageSourceProvider, we will decide which SegmentPageSource to use based on the config PinotConfig.isUseStreamingForSegmentQueries.", "author": "xiangfu0", "createdAt": "2020-10-21T00:24:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwMTk4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUwMTI5MQ==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r510501291", "bodyText": "Got it.\nI think we should initialize the global GPRC port to be -1 then ... just to make sure we don't by mistake talk to port 8090 even when PinotConfig.isUseStreamingForSegmentQueries = false", "author": "agrawaldevesh", "createdAt": "2020-10-22T22:50:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwMTk4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE2ODc2OA==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r511168768", "bodyText": "make sense, will update the logic to check grpc port > 0 in PinotPageSourceProvider for picking segment page source", "author": "xiangfu0", "createdAt": "2020-10-23T21:44:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwMTk4Mw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "1478bd635b9f974e46b2031f1378a132a3e50d6e", "url": "https://github.com/prestodb/presto/commit/1478bd635b9f974e46b2031f1378a132a3e50d6e", "message": "Support Pinot Streaming connector for Segment query", "committedDate": "2020-10-21T00:39:11Z", "type": "forcePushed"}, {"oid": "fb8bb690e7246b33c675e51b27aebfd2a9e3cd2b", "url": "https://github.com/prestodb/presto/commit/fb8bb690e7246b33c675e51b27aebfd2a9e3cd2b", "message": "Support Pinot Streaming connector for Segment query", "committedDate": "2020-10-21T01:17:20Z", "type": "forcePushed"}, {"oid": "e3790b42bed22467c5646f9f6b57e27fb6de028e", "url": "https://github.com/prestodb/presto/commit/e3790b42bed22467c5646f9f6b57e27fb6de028e", "message": "Support Pinot Streaming connector for Segment query", "committedDate": "2020-10-21T05:33:50Z", "type": "forcePushed"}, {"oid": "7114de3793f7870777de068d4aba36b99fdb7810", "url": "https://github.com/prestodb/presto/commit/7114de3793f7870777de068d4aba36b99fdb7810", "message": "Support Pinot Streaming connector for Segment query", "committedDate": "2020-10-22T21:53:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ5NzQ3Nw==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r510497477", "bodyText": "Can you push this logic of choosing the global rpc port to when the instance config cache is populated ? Either the controller provides you the rpc port, or you choose the global one. I feel it belongs better at \"population\" time than at \"read time\".", "author": "agrawaldevesh", "createdAt": "2020-10-22T22:39:15Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java", "diffHunk": "@@ -486,4 +496,101 @@ public TimeBoundary getTimeBoundaryForTable(String table)\n             throw e;\n         }\n     }\n+\n+    public static class Instance\n+    {\n+        private final String instanceName;\n+        private final String hostName;\n+        private final boolean enabled;\n+        private final int port;\n+        private final int grpcPort;\n+        private final List<String> tags;\n+        private final List<String> pools;\n+\n+        @JsonCreator\n+        public Instance(\n+                @JsonProperty String instanceName,\n+                @JsonProperty String hostName,\n+                @JsonProperty boolean enabled,\n+                @JsonProperty int port,\n+                @JsonProperty int grpcPort,\n+                @JsonProperty List<String> tags,\n+                @JsonProperty List<String> pools)\n+        {\n+            this.instanceName = instanceName;\n+            this.hostName = hostName;\n+            this.enabled = enabled;\n+            this.port = port;\n+            this.grpcPort = grpcPort;\n+            this.tags = tags;\n+            this.pools = pools;\n+        }\n+\n+        public String getInstanceName()\n+        {\n+            return instanceName;\n+        }\n+\n+        public String getHostName()\n+        {\n+            return hostName;\n+        }\n+\n+        public boolean isEnabled()\n+        {\n+            return enabled;\n+        }\n+\n+        public int getPort()\n+        {\n+            return port;\n+        }\n+\n+        public int getGrpcPort()\n+        {\n+            return grpcPort;\n+        }\n+\n+        public List<String> getTags()\n+        {\n+            return tags;\n+        }\n+\n+        public List<String> getPools()\n+        {\n+            return pools;\n+        }\n+    }\n+\n+    public Instance getInstance(String instanceName)\n+    {\n+        try {\n+            String responseBody = sendHttpGetToController(String.format(INSTANCE_API_TEMPLATE, instanceName));\n+            return instanceJsonCodec.fromJson(responseBody);\n+        }\n+        catch (Exception throwable) {\n+            throw new PinotException(PINOT_UNABLE_TO_FIND_INSTANCE, Optional.empty(), \"Error when fetching instance configs for \" + instanceName, throwable);\n+        }\n+    }\n+\n+    public int getGrpcPort(String serverInstance)\n+    {\n+        try {\n+            int grpcPort = instanceConfigCache.get(serverInstance).getGrpcPort();", "originalCommit": "7114de3793f7870777de068d4aba36b99fdb7810", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE4OTAwOA==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r511189008", "bodyText": "make sense, moved this logic into PinotConnection.getGrpcPort(String serverInstance) to apply the pinot configs.\nFor PinotClusterInfoFetcher, we just honor the real value fetched from Pinot cluster.", "author": "xiangfu0", "createdAt": "2020-10-23T22:56:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ5NzQ3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "73c38b078b56dca67081fbb4b00950859ca0d30f", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java\nindex 49bc12fa2d..8cd552b173 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java\n\n@@ -573,14 +573,13 @@ public class PinotClusterInfoFetcher\n         }\n     }\n \n+    // Fetch grpc port based on below policy:\n+    //   1. Extract grpc port from Pinot instance config\n+    //   2. If gRpc port < 0 then return fallback server grpc port setting by config: `pinot.server-grpc-port`.\n     public int getGrpcPort(String serverInstance)\n     {\n         try {\n-            int grpcPort = instanceConfigCache.get(serverInstance).getGrpcPort();\n-            if (grpcPort <= 0) {\n-                grpcPort = pinotConfig.getServerGrpcPort();\n-            }\n-            return grpcPort;\n+            return instanceConfigCache.get(serverInstance).getGrpcPort();\n         }\n         catch (ExecutionException e) {\n             Throwable cause = e.getCause();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ5ODE4MA==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r510498180", "bodyText": "Please add a comment here, that this is only used as a fallback if the controller does not provide a per server grpc port (if a pinot version older than XX) is running.\nAlso, should the default be something like -1 ... to denote that an RPC port fall back is not set ? I think 8090 encodes some pinot information here that ideally belongs in some config file.", "author": "agrawaldevesh", "createdAt": "2020-10-22T22:41:22Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotConfig.java", "diffHunk": "@@ -86,6 +87,11 @@\n \n     // Requires Pinot version >= 0.4.0.\n     private boolean usePinotSqlForBrokerQueries = true;\n+    // Requires Pinot version >= 0.5.0.\n+    private boolean useStreamingForSegmentQueries;\n+    private boolean usePlainTextForStreamingServer = true;\n+    private int serverGrpcPort = 8090;", "originalCommit": "7114de3793f7870777de068d4aba36b99fdb7810", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE4OTkzOA==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r511189938", "bodyText": "True, will just put -1 here, which means unless been set, this tis not used.", "author": "xiangfu0", "createdAt": "2020-10-23T23:00:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ5ODE4MA=="}], "type": "inlineReview", "revised_code": {"commit": "73c38b078b56dca67081fbb4b00950859ca0d30f", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotConfig.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotConfig.java\nindex 69cfec3fca..cad25e15c4 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotConfig.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotConfig.java\n\n@@ -87,10 +87,10 @@ public class PinotConfig\n \n     // Requires Pinot version >= 0.4.0.\n     private boolean usePinotSqlForBrokerQueries = true;\n-    // Requires Pinot version >= 0.5.0.\n+    // Requires Pinot version >= 0.6.0.\n     private boolean useStreamingForSegmentQueries;\n-    private boolean usePlainTextForStreamingServer = true;\n-    private int serverGrpcPort = 8090;\n+    // ServerGrpcPort is used as the fallback grpc port if not fetched from Pinot cluster.\n+    private int serverGrpcPort = -1;\n     private int streamingServerGrpcMaxInboundMessageSize = DEFAULT_STREAMING_SERVER_GRPC_MAX_INBOUND_MESSAGE_SIZE;\n \n     private int numSegmentsPerSplit = 1;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ5ODg2Nw==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r510498867", "bodyText": "converted into pages ?\nor deconstructed into pages ?", "author": "agrawaldevesh", "createdAt": "2020-10-22T22:43:35Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponse;\n+import com.facebook.presto.spi.ConnectorSession;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_DATA_FETCH_EXCEPTION;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_INVALID_SEGMENT_QUERY_GENERATED;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_UNEXPECTED_RESPONSE;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n+ */\n+\n+public class PinotSegmentStreamingPageSource\n+        extends PinotSegmentPageSource\n+{\n+    private final PinotStreamingQueryClient pinotStreamingQueryClient;\n+    private Iterator<ServerResponse> serverResponseIterator;\n+    private long completedPositions;\n+\n+    public PinotSegmentStreamingPageSource(\n+            ConnectorSession session,\n+            PinotConfig pinotConfig,\n+            PinotStreamingQueryClient pinotStreamingQueryClient,\n+            PinotSplit split,\n+            List<PinotColumnHandle> columnHandles)\n+    {\n+        super(session, pinotConfig, null, split, columnHandles);\n+        this.pinotStreamingQueryClient = requireNonNull(pinotStreamingQueryClient, \"pinotStreamingQueryClient is null\");\n+    }\n+\n+    @Override\n+    public boolean isFinished()\n+    {\n+        return closed;\n+    }\n+\n+    /**\n+     * @return constructed page for pinot data.\n+     */\n+    @Override\n+    public Page getNextPage()\n+    {\n+        if (closed) {\n+            return null;\n+        }\n+        if (serverResponseIterator == null) {\n+            serverResponseIterator = queryPinot(split);\n+        }\n+        ByteBuffer byteBuffer = null;\n+        if (serverResponseIterator.hasNext()) {\n+            long startTimeNanos = System.nanoTime();\n+            ServerResponse serverResponse = serverResponseIterator.next();\n+            readTimeNanos += System.nanoTime() - startTimeNanos;\n+            switch (serverResponse.getResponseType()) {\n+                case Constants.Response.ResponseType.DATA:\n+                    estimatedMemoryUsageInBytes = serverResponse.getSerializedSize();\n+                    // Store each dataTable which will later be constructed into Pages.", "originalCommit": "7114de3793f7870777de068d4aba36b99fdb7810", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "73c38b078b56dca67081fbb4b00950859ca0d30f", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\nindex 31aa1790cc..a93ca8c967 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\n\n@@ -73,46 +73,51 @@ public class PinotSegmentStreamingPageSource\n             serverResponseIterator = queryPinot(split);\n         }\n         ByteBuffer byteBuffer = null;\n-        if (serverResponseIterator.hasNext()) {\n-            long startTimeNanos = System.nanoTime();\n-            ServerResponse serverResponse = serverResponseIterator.next();\n-            readTimeNanos += System.nanoTime() - startTimeNanos;\n-            switch (serverResponse.getResponseType()) {\n-                case Constants.Response.ResponseType.DATA:\n-                    estimatedMemoryUsageInBytes = serverResponse.getSerializedSize();\n-                    // Store each dataTable which will later be constructed into Pages.\n-                    try {\n-                        byteBuffer = serverResponse.getPayloadReadOnlyByteBuffer();\n-                        DataTable dataTable = serverResponse.getDataTable(byteBuffer);\n-                        checkExceptions(dataTable, split, PinotSessionProperties.isMarkDataFetchExceptionsAsRetriable(session));\n-                        currentDataTable = new PinotSegmentPageSource.PinotDataTableWithSize(dataTable, serverResponse.getSerializedSize());\n-                    }\n-                    catch (IOException e) {\n-                        throw new PinotException(\n-                            PINOT_DATA_FETCH_EXCEPTION,\n-                            split.getSegmentPinotQuery(),\n-                            String.format(\"Encountered Pinot exceptions when fetching data table from Split: < %s >\", split), e);\n-                    }\n-                    break;\n-                case Constants.Response.ResponseType.METADATA:\n-                    // The last part of the response is Metadata\n-                    currentDataTable = null;\n-                    serverResponseIterator = null;\n-                    close();\n-                    return null;\n-                default:\n-                    throw new PinotException(\n-                        PINOT_UNEXPECTED_RESPONSE,\n-                        split.getSegmentPinotQuery(),\n-                        String.format(\"Encountered Pinot exceptions, unknown response type - %s\", serverResponse.getResponseType()));\n+        try {\n+            // Pinot gRPC server response iterator returns:\n+            //   - n data trucks;\n+            //   - 1 metadata of the query results.\n+            // So we need to check ResponseType of each ServerResponse.\n+            if (serverResponseIterator.hasNext()) {\n+                long startTimeNanos = System.nanoTime();\n+                ServerResponse serverResponse = serverResponseIterator.next();\n+                readTimeNanos += System.nanoTime() - startTimeNanos;\n+                switch (serverResponse.getResponseType()) {\n+                    case Constants.Response.ResponseType.DATA:\n+                        estimatedMemoryUsageInBytes = serverResponse.getSerializedSize();\n+                        // Store each dataTable which will later be constructed into Pages.\n+                        try {\n+                            byteBuffer = serverResponse.getPayloadReadOnlyByteBuffer();\n+                            DataTable dataTable = serverResponse.getDataTable(byteBuffer);\n+                            checkExceptions(dataTable, split, PinotSessionProperties.isMarkDataFetchExceptionsAsRetriable(session));\n+                            currentDataTable = new PinotSegmentPageSource.PinotDataTableWithSize(dataTable,\n+                                serverResponse.getSerializedSize());\n+                        }\n+                        catch (IOException e) {\n+                            throw new PinotException(PINOT_DATA_FETCH_EXCEPTION, split.getSegmentPinotQuery(), String.format(\"Encountered Pinot exceptions when fetching data table from Split: < %s >\",\n+                                split), e);\n+                        }\n+                        break;\n+                    case Constants.Response.ResponseType.METADATA:\n+                        // The last part of the response is Metadata\n+                        currentDataTable = null;\n+                        serverResponseIterator = null;\n+                        close();\n+                        return null;\n+                    default:\n+                        throw new PinotException(PINOT_UNEXPECTED_RESPONSE, split.getSegmentPinotQuery(),\n+                            String.format(\"Encountered Pinot exceptions, unknown response type - %s\", serverResponse.getResponseType()));\n+                }\n             }\n+            Page page = fillNextPage();\n+            completedPositions += currentDataTable.getDataTable().getNumberOfRows();\n+            return page;\n         }\n-        Page page = fillNextPage();\n-        completedPositions += currentDataTable.getDataTable().getNumberOfRows();\n-        if (byteBuffer != null) {\n-            byteBuffer.clear();\n+        finally {\n+            if (byteBuffer != null) {\n+                byteBuffer.clear();\n+            }\n         }\n-        return page;\n     }\n \n     private Iterator<ServerResponse> queryPinot(PinotSplit split)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ5OTEzNw==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r510499137", "bodyText": "Can you add a small comment here that we expect to see a sequence of Data followed by Metadata ?", "author": "agrawaldevesh", "createdAt": "2020-10-22T22:44:26Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponse;\n+import com.facebook.presto.spi.ConnectorSession;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_DATA_FETCH_EXCEPTION;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_INVALID_SEGMENT_QUERY_GENERATED;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_UNEXPECTED_RESPONSE;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n+ */\n+\n+public class PinotSegmentStreamingPageSource\n+        extends PinotSegmentPageSource\n+{\n+    private final PinotStreamingQueryClient pinotStreamingQueryClient;\n+    private Iterator<ServerResponse> serverResponseIterator;\n+    private long completedPositions;\n+\n+    public PinotSegmentStreamingPageSource(\n+            ConnectorSession session,\n+            PinotConfig pinotConfig,\n+            PinotStreamingQueryClient pinotStreamingQueryClient,\n+            PinotSplit split,\n+            List<PinotColumnHandle> columnHandles)\n+    {\n+        super(session, pinotConfig, null, split, columnHandles);\n+        this.pinotStreamingQueryClient = requireNonNull(pinotStreamingQueryClient, \"pinotStreamingQueryClient is null\");\n+    }\n+\n+    @Override\n+    public boolean isFinished()\n+    {\n+        return closed;\n+    }\n+\n+    /**\n+     * @return constructed page for pinot data.\n+     */\n+    @Override\n+    public Page getNextPage()\n+    {\n+        if (closed) {\n+            return null;\n+        }\n+        if (serverResponseIterator == null) {\n+            serverResponseIterator = queryPinot(split);\n+        }\n+        ByteBuffer byteBuffer = null;\n+        if (serverResponseIterator.hasNext()) {", "originalCommit": "7114de3793f7870777de068d4aba36b99fdb7810", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE5MzU1Ng==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r511193556", "bodyText": "will do", "author": "xiangfu0", "createdAt": "2020-10-23T23:16:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ5OTEzNw=="}], "type": "inlineReview", "revised_code": {"commit": "73c38b078b56dca67081fbb4b00950859ca0d30f", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\nindex 31aa1790cc..a93ca8c967 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\n\n@@ -73,46 +73,51 @@ public class PinotSegmentStreamingPageSource\n             serverResponseIterator = queryPinot(split);\n         }\n         ByteBuffer byteBuffer = null;\n-        if (serverResponseIterator.hasNext()) {\n-            long startTimeNanos = System.nanoTime();\n-            ServerResponse serverResponse = serverResponseIterator.next();\n-            readTimeNanos += System.nanoTime() - startTimeNanos;\n-            switch (serverResponse.getResponseType()) {\n-                case Constants.Response.ResponseType.DATA:\n-                    estimatedMemoryUsageInBytes = serverResponse.getSerializedSize();\n-                    // Store each dataTable which will later be constructed into Pages.\n-                    try {\n-                        byteBuffer = serverResponse.getPayloadReadOnlyByteBuffer();\n-                        DataTable dataTable = serverResponse.getDataTable(byteBuffer);\n-                        checkExceptions(dataTable, split, PinotSessionProperties.isMarkDataFetchExceptionsAsRetriable(session));\n-                        currentDataTable = new PinotSegmentPageSource.PinotDataTableWithSize(dataTable, serverResponse.getSerializedSize());\n-                    }\n-                    catch (IOException e) {\n-                        throw new PinotException(\n-                            PINOT_DATA_FETCH_EXCEPTION,\n-                            split.getSegmentPinotQuery(),\n-                            String.format(\"Encountered Pinot exceptions when fetching data table from Split: < %s >\", split), e);\n-                    }\n-                    break;\n-                case Constants.Response.ResponseType.METADATA:\n-                    // The last part of the response is Metadata\n-                    currentDataTable = null;\n-                    serverResponseIterator = null;\n-                    close();\n-                    return null;\n-                default:\n-                    throw new PinotException(\n-                        PINOT_UNEXPECTED_RESPONSE,\n-                        split.getSegmentPinotQuery(),\n-                        String.format(\"Encountered Pinot exceptions, unknown response type - %s\", serverResponse.getResponseType()));\n+        try {\n+            // Pinot gRPC server response iterator returns:\n+            //   - n data trucks;\n+            //   - 1 metadata of the query results.\n+            // So we need to check ResponseType of each ServerResponse.\n+            if (serverResponseIterator.hasNext()) {\n+                long startTimeNanos = System.nanoTime();\n+                ServerResponse serverResponse = serverResponseIterator.next();\n+                readTimeNanos += System.nanoTime() - startTimeNanos;\n+                switch (serverResponse.getResponseType()) {\n+                    case Constants.Response.ResponseType.DATA:\n+                        estimatedMemoryUsageInBytes = serverResponse.getSerializedSize();\n+                        // Store each dataTable which will later be constructed into Pages.\n+                        try {\n+                            byteBuffer = serverResponse.getPayloadReadOnlyByteBuffer();\n+                            DataTable dataTable = serverResponse.getDataTable(byteBuffer);\n+                            checkExceptions(dataTable, split, PinotSessionProperties.isMarkDataFetchExceptionsAsRetriable(session));\n+                            currentDataTable = new PinotSegmentPageSource.PinotDataTableWithSize(dataTable,\n+                                serverResponse.getSerializedSize());\n+                        }\n+                        catch (IOException e) {\n+                            throw new PinotException(PINOT_DATA_FETCH_EXCEPTION, split.getSegmentPinotQuery(), String.format(\"Encountered Pinot exceptions when fetching data table from Split: < %s >\",\n+                                split), e);\n+                        }\n+                        break;\n+                    case Constants.Response.ResponseType.METADATA:\n+                        // The last part of the response is Metadata\n+                        currentDataTable = null;\n+                        serverResponseIterator = null;\n+                        close();\n+                        return null;\n+                    default:\n+                        throw new PinotException(PINOT_UNEXPECTED_RESPONSE, split.getSegmentPinotQuery(),\n+                            String.format(\"Encountered Pinot exceptions, unknown response type - %s\", serverResponse.getResponseType()));\n+                }\n             }\n+            Page page = fillNextPage();\n+            completedPositions += currentDataTable.getDataTable().getNumberOfRows();\n+            return page;\n         }\n-        Page page = fillNextPage();\n-        completedPositions += currentDataTable.getDataTable().getNumberOfRows();\n-        if (byteBuffer != null) {\n-            byteBuffer.clear();\n+        finally {\n+            if (byteBuffer != null) {\n+                byteBuffer.clear();\n+            }\n         }\n-        return page;\n     }\n \n     private Iterator<ServerResponse> queryPinot(PinotSplit split)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ5OTc1NA==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r510499754", "bodyText": "Will anything be leaked if we throw here ? I am not sure if the byte buffer is native or on heap ? Should we free the byteBuffer after this loop using a try-finally ?", "author": "agrawaldevesh", "createdAt": "2020-10-22T22:46:17Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponse;\n+import com.facebook.presto.spi.ConnectorSession;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_DATA_FETCH_EXCEPTION;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_INVALID_SEGMENT_QUERY_GENERATED;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_UNEXPECTED_RESPONSE;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n+ */\n+\n+public class PinotSegmentStreamingPageSource\n+        extends PinotSegmentPageSource\n+{\n+    private final PinotStreamingQueryClient pinotStreamingQueryClient;\n+    private Iterator<ServerResponse> serverResponseIterator;\n+    private long completedPositions;\n+\n+    public PinotSegmentStreamingPageSource(\n+            ConnectorSession session,\n+            PinotConfig pinotConfig,\n+            PinotStreamingQueryClient pinotStreamingQueryClient,\n+            PinotSplit split,\n+            List<PinotColumnHandle> columnHandles)\n+    {\n+        super(session, pinotConfig, null, split, columnHandles);\n+        this.pinotStreamingQueryClient = requireNonNull(pinotStreamingQueryClient, \"pinotStreamingQueryClient is null\");\n+    }\n+\n+    @Override\n+    public boolean isFinished()\n+    {\n+        return closed;\n+    }\n+\n+    /**\n+     * @return constructed page for pinot data.\n+     */\n+    @Override\n+    public Page getNextPage()\n+    {\n+        if (closed) {\n+            return null;\n+        }\n+        if (serverResponseIterator == null) {\n+            serverResponseIterator = queryPinot(split);\n+        }\n+        ByteBuffer byteBuffer = null;\n+        if (serverResponseIterator.hasNext()) {\n+            long startTimeNanos = System.nanoTime();\n+            ServerResponse serverResponse = serverResponseIterator.next();\n+            readTimeNanos += System.nanoTime() - startTimeNanos;\n+            switch (serverResponse.getResponseType()) {\n+                case Constants.Response.ResponseType.DATA:\n+                    estimatedMemoryUsageInBytes = serverResponse.getSerializedSize();\n+                    // Store each dataTable which will later be constructed into Pages.\n+                    try {\n+                        byteBuffer = serverResponse.getPayloadReadOnlyByteBuffer();\n+                        DataTable dataTable = serverResponse.getDataTable(byteBuffer);\n+                        checkExceptions(dataTable, split, PinotSessionProperties.isMarkDataFetchExceptionsAsRetriable(session));\n+                        currentDataTable = new PinotSegmentPageSource.PinotDataTableWithSize(dataTable, serverResponse.getSerializedSize());\n+                    }\n+                    catch (IOException e) {\n+                        throw new PinotException(", "originalCommit": "7114de3793f7870777de068d4aba36b99fdb7810", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE5MzU0Mw==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r511193543", "bodyText": "good catch, I will wrapper with try- finally", "author": "xiangfu0", "createdAt": "2020-10-23T23:16:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ5OTc1NA=="}], "type": "inlineReview", "revised_code": {"commit": "73c38b078b56dca67081fbb4b00950859ca0d30f", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\nindex 31aa1790cc..a93ca8c967 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\n\n@@ -73,46 +73,51 @@ public class PinotSegmentStreamingPageSource\n             serverResponseIterator = queryPinot(split);\n         }\n         ByteBuffer byteBuffer = null;\n-        if (serverResponseIterator.hasNext()) {\n-            long startTimeNanos = System.nanoTime();\n-            ServerResponse serverResponse = serverResponseIterator.next();\n-            readTimeNanos += System.nanoTime() - startTimeNanos;\n-            switch (serverResponse.getResponseType()) {\n-                case Constants.Response.ResponseType.DATA:\n-                    estimatedMemoryUsageInBytes = serverResponse.getSerializedSize();\n-                    // Store each dataTable which will later be constructed into Pages.\n-                    try {\n-                        byteBuffer = serverResponse.getPayloadReadOnlyByteBuffer();\n-                        DataTable dataTable = serverResponse.getDataTable(byteBuffer);\n-                        checkExceptions(dataTable, split, PinotSessionProperties.isMarkDataFetchExceptionsAsRetriable(session));\n-                        currentDataTable = new PinotSegmentPageSource.PinotDataTableWithSize(dataTable, serverResponse.getSerializedSize());\n-                    }\n-                    catch (IOException e) {\n-                        throw new PinotException(\n-                            PINOT_DATA_FETCH_EXCEPTION,\n-                            split.getSegmentPinotQuery(),\n-                            String.format(\"Encountered Pinot exceptions when fetching data table from Split: < %s >\", split), e);\n-                    }\n-                    break;\n-                case Constants.Response.ResponseType.METADATA:\n-                    // The last part of the response is Metadata\n-                    currentDataTable = null;\n-                    serverResponseIterator = null;\n-                    close();\n-                    return null;\n-                default:\n-                    throw new PinotException(\n-                        PINOT_UNEXPECTED_RESPONSE,\n-                        split.getSegmentPinotQuery(),\n-                        String.format(\"Encountered Pinot exceptions, unknown response type - %s\", serverResponse.getResponseType()));\n+        try {\n+            // Pinot gRPC server response iterator returns:\n+            //   - n data trucks;\n+            //   - 1 metadata of the query results.\n+            // So we need to check ResponseType of each ServerResponse.\n+            if (serverResponseIterator.hasNext()) {\n+                long startTimeNanos = System.nanoTime();\n+                ServerResponse serverResponse = serverResponseIterator.next();\n+                readTimeNanos += System.nanoTime() - startTimeNanos;\n+                switch (serverResponse.getResponseType()) {\n+                    case Constants.Response.ResponseType.DATA:\n+                        estimatedMemoryUsageInBytes = serverResponse.getSerializedSize();\n+                        // Store each dataTable which will later be constructed into Pages.\n+                        try {\n+                            byteBuffer = serverResponse.getPayloadReadOnlyByteBuffer();\n+                            DataTable dataTable = serverResponse.getDataTable(byteBuffer);\n+                            checkExceptions(dataTable, split, PinotSessionProperties.isMarkDataFetchExceptionsAsRetriable(session));\n+                            currentDataTable = new PinotSegmentPageSource.PinotDataTableWithSize(dataTable,\n+                                serverResponse.getSerializedSize());\n+                        }\n+                        catch (IOException e) {\n+                            throw new PinotException(PINOT_DATA_FETCH_EXCEPTION, split.getSegmentPinotQuery(), String.format(\"Encountered Pinot exceptions when fetching data table from Split: < %s >\",\n+                                split), e);\n+                        }\n+                        break;\n+                    case Constants.Response.ResponseType.METADATA:\n+                        // The last part of the response is Metadata\n+                        currentDataTable = null;\n+                        serverResponseIterator = null;\n+                        close();\n+                        return null;\n+                    default:\n+                        throw new PinotException(PINOT_UNEXPECTED_RESPONSE, split.getSegmentPinotQuery(),\n+                            String.format(\"Encountered Pinot exceptions, unknown response type - %s\", serverResponse.getResponseType()));\n+                }\n             }\n+            Page page = fillNextPage();\n+            completedPositions += currentDataTable.getDataTable().getNumberOfRows();\n+            return page;\n         }\n-        Page page = fillNextPage();\n-        completedPositions += currentDataTable.getDataTable().getNumberOfRows();\n-        if (byteBuffer != null) {\n-            byteBuffer.clear();\n+        finally {\n+            if (byteBuffer != null) {\n+                byteBuffer.clear();\n+            }\n         }\n-        return page;\n     }\n \n     private Iterator<ServerResponse> queryPinot(PinotSplit split)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ5OTk5Ng==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r510499996", "bodyText": "Is getGrpcPort guaranteed to be valid ... > 0 ?", "author": "agrawaldevesh", "createdAt": "2020-10-22T22:47:01Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponse;\n+import com.facebook.presto.spi.ConnectorSession;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_DATA_FETCH_EXCEPTION;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_INVALID_SEGMENT_QUERY_GENERATED;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_UNEXPECTED_RESPONSE;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n+ */\n+\n+public class PinotSegmentStreamingPageSource\n+        extends PinotSegmentPageSource\n+{\n+    private final PinotStreamingQueryClient pinotStreamingQueryClient;\n+    private Iterator<ServerResponse> serverResponseIterator;\n+    private long completedPositions;\n+\n+    public PinotSegmentStreamingPageSource(\n+            ConnectorSession session,\n+            PinotConfig pinotConfig,\n+            PinotStreamingQueryClient pinotStreamingQueryClient,\n+            PinotSplit split,\n+            List<PinotColumnHandle> columnHandles)\n+    {\n+        super(session, pinotConfig, null, split, columnHandles);\n+        this.pinotStreamingQueryClient = requireNonNull(pinotStreamingQueryClient, \"pinotStreamingQueryClient is null\");\n+    }\n+\n+    @Override\n+    public boolean isFinished()\n+    {\n+        return closed;\n+    }\n+\n+    /**\n+     * @return constructed page for pinot data.\n+     */\n+    @Override\n+    public Page getNextPage()\n+    {\n+        if (closed) {\n+            return null;\n+        }\n+        if (serverResponseIterator == null) {\n+            serverResponseIterator = queryPinot(split);\n+        }\n+        ByteBuffer byteBuffer = null;\n+        if (serverResponseIterator.hasNext()) {\n+            long startTimeNanos = System.nanoTime();\n+            ServerResponse serverResponse = serverResponseIterator.next();\n+            readTimeNanos += System.nanoTime() - startTimeNanos;\n+            switch (serverResponse.getResponseType()) {\n+                case Constants.Response.ResponseType.DATA:\n+                    estimatedMemoryUsageInBytes = serverResponse.getSerializedSize();\n+                    // Store each dataTable which will later be constructed into Pages.\n+                    try {\n+                        byteBuffer = serverResponse.getPayloadReadOnlyByteBuffer();\n+                        DataTable dataTable = serverResponse.getDataTable(byteBuffer);\n+                        checkExceptions(dataTable, split, PinotSessionProperties.isMarkDataFetchExceptionsAsRetriable(session));\n+                        currentDataTable = new PinotSegmentPageSource.PinotDataTableWithSize(dataTable, serverResponse.getSerializedSize());\n+                    }\n+                    catch (IOException e) {\n+                        throw new PinotException(\n+                            PINOT_DATA_FETCH_EXCEPTION,\n+                            split.getSegmentPinotQuery(),\n+                            String.format(\"Encountered Pinot exceptions when fetching data table from Split: < %s >\", split), e);\n+                    }\n+                    break;\n+                case Constants.Response.ResponseType.METADATA:\n+                    // The last part of the response is Metadata\n+                    currentDataTable = null;\n+                    serverResponseIterator = null;\n+                    close();\n+                    return null;\n+                default:\n+                    throw new PinotException(\n+                        PINOT_UNEXPECTED_RESPONSE,\n+                        split.getSegmentPinotQuery(),\n+                        String.format(\"Encountered Pinot exceptions, unknown response type - %s\", serverResponse.getResponseType()));\n+            }\n+        }\n+        Page page = fillNextPage();\n+        completedPositions += currentDataTable.getDataTable().getNumberOfRows();\n+        if (byteBuffer != null) {\n+            byteBuffer.clear();\n+        }\n+        return page;\n+    }\n+\n+    private Iterator<ServerResponse> queryPinot(PinotSplit split)\n+    {\n+        String sql = split.getSegmentPinotQuery().orElseThrow(() -> new PinotException(PINOT_INVALID_SEGMENT_QUERY_GENERATED, Optional.empty(), \"Expected the segment split to contain the pinot query\"));\n+        String grpcHost = split.getGrpcHost().orElseThrow(() -> new PinotException(PINOT_INVALID_SEGMENT_QUERY_GENERATED, Optional.empty(), \"Expected the segment split to contain the grpc host\"));", "originalCommit": "7114de3793f7870777de068d4aba36b99fdb7810", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE5NjM0NQ==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r511196345", "bodyText": "yes, if grpc port is < 0 then we will go to PinotSegmentPageSource instead of PinotSegmentStreamingPageSource", "author": "xiangfu0", "createdAt": "2020-10-23T23:29:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ5OTk5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE5NjQxMA==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r511196410", "bodyText": "Still, it's good to add a check here just in case.", "author": "xiangfu0", "createdAt": "2020-10-23T23:30:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ5OTk5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "73c38b078b56dca67081fbb4b00950859ca0d30f", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\nindex 31aa1790cc..a93ca8c967 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\n\n@@ -73,46 +73,51 @@ public class PinotSegmentStreamingPageSource\n             serverResponseIterator = queryPinot(split);\n         }\n         ByteBuffer byteBuffer = null;\n-        if (serverResponseIterator.hasNext()) {\n-            long startTimeNanos = System.nanoTime();\n-            ServerResponse serverResponse = serverResponseIterator.next();\n-            readTimeNanos += System.nanoTime() - startTimeNanos;\n-            switch (serverResponse.getResponseType()) {\n-                case Constants.Response.ResponseType.DATA:\n-                    estimatedMemoryUsageInBytes = serverResponse.getSerializedSize();\n-                    // Store each dataTable which will later be constructed into Pages.\n-                    try {\n-                        byteBuffer = serverResponse.getPayloadReadOnlyByteBuffer();\n-                        DataTable dataTable = serverResponse.getDataTable(byteBuffer);\n-                        checkExceptions(dataTable, split, PinotSessionProperties.isMarkDataFetchExceptionsAsRetriable(session));\n-                        currentDataTable = new PinotSegmentPageSource.PinotDataTableWithSize(dataTable, serverResponse.getSerializedSize());\n-                    }\n-                    catch (IOException e) {\n-                        throw new PinotException(\n-                            PINOT_DATA_FETCH_EXCEPTION,\n-                            split.getSegmentPinotQuery(),\n-                            String.format(\"Encountered Pinot exceptions when fetching data table from Split: < %s >\", split), e);\n-                    }\n-                    break;\n-                case Constants.Response.ResponseType.METADATA:\n-                    // The last part of the response is Metadata\n-                    currentDataTable = null;\n-                    serverResponseIterator = null;\n-                    close();\n-                    return null;\n-                default:\n-                    throw new PinotException(\n-                        PINOT_UNEXPECTED_RESPONSE,\n-                        split.getSegmentPinotQuery(),\n-                        String.format(\"Encountered Pinot exceptions, unknown response type - %s\", serverResponse.getResponseType()));\n+        try {\n+            // Pinot gRPC server response iterator returns:\n+            //   - n data trucks;\n+            //   - 1 metadata of the query results.\n+            // So we need to check ResponseType of each ServerResponse.\n+            if (serverResponseIterator.hasNext()) {\n+                long startTimeNanos = System.nanoTime();\n+                ServerResponse serverResponse = serverResponseIterator.next();\n+                readTimeNanos += System.nanoTime() - startTimeNanos;\n+                switch (serverResponse.getResponseType()) {\n+                    case Constants.Response.ResponseType.DATA:\n+                        estimatedMemoryUsageInBytes = serverResponse.getSerializedSize();\n+                        // Store each dataTable which will later be constructed into Pages.\n+                        try {\n+                            byteBuffer = serverResponse.getPayloadReadOnlyByteBuffer();\n+                            DataTable dataTable = serverResponse.getDataTable(byteBuffer);\n+                            checkExceptions(dataTable, split, PinotSessionProperties.isMarkDataFetchExceptionsAsRetriable(session));\n+                            currentDataTable = new PinotSegmentPageSource.PinotDataTableWithSize(dataTable,\n+                                serverResponse.getSerializedSize());\n+                        }\n+                        catch (IOException e) {\n+                            throw new PinotException(PINOT_DATA_FETCH_EXCEPTION, split.getSegmentPinotQuery(), String.format(\"Encountered Pinot exceptions when fetching data table from Split: < %s >\",\n+                                split), e);\n+                        }\n+                        break;\n+                    case Constants.Response.ResponseType.METADATA:\n+                        // The last part of the response is Metadata\n+                        currentDataTable = null;\n+                        serverResponseIterator = null;\n+                        close();\n+                        return null;\n+                    default:\n+                        throw new PinotException(PINOT_UNEXPECTED_RESPONSE, split.getSegmentPinotQuery(),\n+                            String.format(\"Encountered Pinot exceptions, unknown response type - %s\", serverResponse.getResponseType()));\n+                }\n             }\n+            Page page = fillNextPage();\n+            completedPositions += currentDataTable.getDataTable().getNumberOfRows();\n+            return page;\n         }\n-        Page page = fillNextPage();\n-        completedPositions += currentDataTable.getDataTable().getNumberOfRows();\n-        if (byteBuffer != null) {\n-            byteBuffer.clear();\n+        finally {\n+            if (byteBuffer != null) {\n+                byteBuffer.clear();\n+            }\n         }\n-        return page;\n     }\n \n     private Iterator<ServerResponse> queryPinot(PinotSplit split)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUwMDg3Mw==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r510500873", "bodyText": "Can you add a comment explaining this logic here. Should the GRPC host be saved as an immutable field in the split, instead of recomputing here ?\nCan you use Optional.map instead of the if condition below ...", "author": "agrawaldevesh", "createdAt": "2020-10-22T22:49:30Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSplit.java", "diffHunk": "@@ -133,14 +138,29 @@ public SplitType getSplitType()\n         return segments;\n     }\n \n+    public Optional<String> getGrpcHost()\n+    {", "originalCommit": "7114de3793f7870777de068d4aba36b99fdb7810", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE5NzQ1NQ==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r511197455", "bodyText": "This method is only called once, so I think it's fine to set the logic here.", "author": "xiangfu0", "createdAt": "2020-10-23T23:35:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUwMDg3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "73c38b078b56dca67081fbb4b00950859ca0d30f", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSplit.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSplit.java\nindex 567581ee06..a2d46adcf1 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSplit.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSplit.java\n\n@@ -138,6 +138,8 @@ public class PinotSplit\n         return segments;\n     }\n \n+    // Extract grpc host name from the segmentHost.\n+    // Usually segmentHost is in the format of `Server_127.0.0.1_8090`, so the hostname can be parsed from it, or will just use the entire string for that.\n     public Optional<String> getGrpcHost()\n     {\n         if (segmentHost.isPresent()) {\n"}}, {"oid": "73c38b078b56dca67081fbb4b00950859ca0d30f", "url": "https://github.com/prestodb/presto/commit/73c38b078b56dca67081fbb4b00950859ca0d30f", "message": "Support Pinot Streaming connector for Segment query", "committedDate": "2020-10-23T23:43:59Z", "type": "forcePushed"}, {"oid": "3b4198abd41b16dfea38c8199ec23d313102031d", "url": "https://github.com/prestodb/presto/commit/3b4198abd41b16dfea38c8199ec23d313102031d", "message": "Support Pinot Streaming connector for Segment query", "committedDate": "2020-10-24T03:24:55Z", "type": "forcePushed"}, {"oid": "ab821abc728c11cb3ebbb8128f25750a73bd4017", "url": "https://github.com/prestodb/presto/commit/ab821abc728c11cb3ebbb8128f25750a73bd4017", "message": "Support Pinot Streaming connector for Segment query", "committedDate": "2020-10-24T05:08:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTMyMTI0NQ==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r511321245", "bodyText": "When will this exception be hit ? My understanding is that when the controller does not have the per instance grpc port, it will simply return -1 for that and we will go through the regular if condition on line 119. I don't know whether we should fall back in case of an exception. Are you thinking of cases like where the controller is down or such ?\nCan we catch a more specific exception ?", "author": "agrawaldevesh", "createdAt": "2020-10-24T05:06:18Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotConnection.java", "diffHunk": "@@ -110,4 +110,19 @@ public TimeBoundary getTimeBoundary(String tableName)\n     {\n         return pinotClusterInfoFetcher.getTimeBoundaryForTable(tableName);\n     }\n+\n+    public int getGrpcPort(String serverInstance)\n+    {\n+        int grpcPort;\n+        try {\n+            grpcPort = pinotClusterInfoFetcher.getGrpcPort(serverInstance);\n+            if (grpcPort <= 0) {\n+                grpcPort = pinotConfig.getServerGrpcPort();\n+            }\n+        }\n+        catch (Exception e) {\n+            grpcPort = pinotConfig.getServerGrpcPort();", "originalCommit": "3b4198abd41b16dfea38c8199ec23d313102031d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTMyMjU5MQ==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r511322591", "bodyText": "The only thing I can think of is that the pinot controller is unavailable so the http call will fail.", "author": "xiangfu0", "createdAt": "2020-10-24T05:21:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTMyMTI0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ5MzA1Nw==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r511493057", "bodyText": "I could be wrong, but I think that the rest of the code is also susceptible to failing when the controller fails. So it may be okay to just propagate the exception, since it is not like you are adding a new vulnerability.\nWhere is the Pinot Server's GRPC port specified in the Pinot configuration (ie on the Pinot cluster side): If there too, the port is fixed (how does that work for k8s then, which does not like fixed ports), then I can see why having a fall back port specified in the pinot config makes sense.\nI don't have a strong feeling here, and I am totally fine with having this config. It just seems weird to me to use some pre-configured port value when we couldn't get the real thing :-). Either way the query will fail.", "author": "agrawaldevesh", "createdAt": "2020-10-24T17:08:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTMyMTI0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTUwMjkzNA==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r511502934", "bodyText": "It's a fixed port that user can specify in pinot server config, then it will be stored in Zookeeper and pinot controller provides API to retrieve it.\nThis is the zk record:", "author": "xiangfu0", "createdAt": "2020-10-24T18:56:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTMyMTI0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTUwNjY5Mw==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r511506693", "bodyText": "It's a fixed port that user can specify in pinot server config, then it will be stored in Zookeeper and pinot controller provides API to retrieve it.\nThis is the zk record:\n\n\nI rethink this one, if in case of controller is down, we don't need to handle the case, then it' ok to remove this config.", "author": "xiangfu0", "createdAt": "2020-10-24T19:35:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTMyMTI0NQ=="}], "type": "inlineReview", "revised_code": {"commit": "8e702c2df403c51024596c8b23be7264d6c43a6c", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotConnection.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotConnection.java\nindex e5899814d5..d702e1ac47 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotConnection.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotConnection.java\n\n@@ -120,7 +120,8 @@ public class PinotConnection\n                 grpcPort = pinotConfig.getServerGrpcPort();\n             }\n         }\n-        catch (Exception e) {\n+        catch (PinotException e) {\n+            // If not able to read grpc port from Pinot controller.\n             grpcPort = pinotConfig.getServerGrpcPort();\n         }\n         return grpcPort;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTMyMTMzNw==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r511321337", "bodyText": "nit: pinotSplit.getGrpcPort().orElse(-1) > 0", "author": "agrawaldevesh", "createdAt": "2020-10-24T05:07:26Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPageSourceProvider.java", "diffHunk": "@@ -81,12 +86,24 @@ public ConnectorPageSource createPageSource(\n \n         switch (pinotSplit.getSplitType()) {\n             case SEGMENT:\n-                return new PinotSegmentPageSource(\n+                if (this.pinotConfig.isUseStreamingForSegmentQueries() &&\n+                        pinotSplit.getGrpcPort().isPresent() &&\n+                        pinotSplit.getGrpcPort().get() > 0) {", "originalCommit": "3b4198abd41b16dfea38c8199ec23d313102031d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5d506fab6dedb37ee09ff1846ca6c9548e055192", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPageSourceProvider.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPageSourceProvider.java\nindex ba66b8a79a..7d6457a251 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPageSourceProvider.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPageSourceProvider.java\n\n@@ -87,8 +87,7 @@ public class PinotPageSourceProvider\n         switch (pinotSplit.getSplitType()) {\n             case SEGMENT:\n                 if (this.pinotConfig.isUseStreamingForSegmentQueries() &&\n-                        pinotSplit.getGrpcPort().isPresent() &&\n-                        pinotSplit.getGrpcPort().get() > 0) {\n+                        pinotSplit.getGrpcPort().orElse(-1) > 0) {\n                     return new PinotSegmentStreamingPageSource(\n                         session,\n                         this.pinotConfig,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTMyMTQ4OA==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r511321488", "bodyText": "nit: What's a truck ?", "author": "agrawaldevesh", "createdAt": "2020-10-24T05:09:31Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java", "diffHunk": "@@ -0,0 +1,143 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponse;\n+import com.facebook.presto.spi.ConnectorSession;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_DATA_FETCH_EXCEPTION;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_INVALID_SEGMENT_QUERY_GENERATED;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_UNEXPECTED_RESPONSE;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n+ */\n+\n+public class PinotSegmentStreamingPageSource\n+        extends PinotSegmentPageSource\n+{\n+    private final PinotStreamingQueryClient pinotStreamingQueryClient;\n+    private Iterator<ServerResponse> serverResponseIterator;\n+    private long completedPositions;\n+\n+    public PinotSegmentStreamingPageSource(\n+            ConnectorSession session,\n+            PinotConfig pinotConfig,\n+            PinotStreamingQueryClient pinotStreamingQueryClient,\n+            PinotSplit split,\n+            List<PinotColumnHandle> columnHandles)\n+    {\n+        super(session, pinotConfig, null, split, columnHandles);\n+        this.pinotStreamingQueryClient = requireNonNull(pinotStreamingQueryClient, \"pinotStreamingQueryClient is null\");\n+    }\n+\n+    @Override\n+    public boolean isFinished()\n+    {\n+        return closed;\n+    }\n+\n+    /**\n+     * @return constructed page for pinot data.\n+     */\n+    @Override\n+    public Page getNextPage()\n+    {\n+        if (closed) {\n+            return null;\n+        }\n+        if (serverResponseIterator == null) {\n+            serverResponseIterator = queryPinot(split);\n+        }\n+        ByteBuffer byteBuffer = null;\n+        try {\n+            // Pinot gRPC server response iterator returns:\n+            //   - n data trucks;", "originalCommit": "ab821abc728c11cb3ebbb8128f25750a73bd4017", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5d506fab6dedb37ee09ff1846ca6c9548e055192", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\nindex a93ca8c967..e34d3c024a 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\n\n@@ -75,7 +75,7 @@ public class PinotSegmentStreamingPageSource\n         ByteBuffer byteBuffer = null;\n         try {\n             // Pinot gRPC server response iterator returns:\n-            //   - n data trucks;\n+            //   - n data blocks based on inbound message size;\n             //   - 1 metadata of the query results.\n             // So we need to check ResponseType of each ServerResponse.\n             if (serverResponseIterator.hasNext()) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTMyMTc0Ng==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r511321746", "bodyText": "nit: More descriptive name than i", "author": "agrawaldevesh", "createdAt": "2020-10-24T05:12:29Z", "path": "presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/TestPinotStreamingSegmentPageSource.java", "diffHunk": "@@ -0,0 +1,229 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.block.VariableWidthBlock;\n+import com.facebook.presto.common.type.ArrayType;\n+import com.facebook.presto.common.type.IntegerType;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.common.type.VariableWidthType;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponse;\n+import com.facebook.presto.spi.ConnectorSession;\n+import com.facebook.presto.testing.TestingConnectorSession;\n+import com.facebook.presto.testing.assertions.Assert;\n+import com.google.common.collect.ImmutableList;\n+import org.apache.pinot.common.proto.Server;\n+import org.apache.pinot.common.utils.DataSchema;\n+import org.apache.pinot.common.utils.DataTable;\n+import org.testng.annotations.Test;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.stream.IntStream;\n+\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static java.util.Objects.requireNonNull;\n+\n+public class TestPinotStreamingSegmentPageSource\n+        extends TestPinotSegmentPageSource\n+{\n+    private static final class MockServerResponse\n+            extends ServerResponse\n+    {\n+        private DataTable dataTable;\n+\n+        public MockServerResponse(Server.ServerResponse serverResponse)\n+        {\n+            super(serverResponse);\n+        }\n+\n+        public MockServerResponse(DataTable dataTable)\n+        {\n+            super(null);\n+            this.dataTable = dataTable;\n+        }\n+\n+        public String getResponseType()\n+        {\n+            return Constants.Response.ResponseType.DATA;\n+        }\n+\n+        public int getSerializedSize()\n+        {\n+            return 0;\n+        }\n+\n+        public ByteBuffer getPayloadReadOnlyByteBuffer()\n+        {\n+            try {\n+                return ByteBuffer.wrap(dataTable.toBytes());\n+            }\n+            catch (IOException e) {\n+                throw new RuntimeException(e);\n+            }\n+        }\n+\n+        public DataTable getDataTable(ByteBuffer byteBuffer) throws IOException\n+        {\n+            return SimpleDataTable.fromBytes(byteBuffer);\n+        }\n+    }\n+\n+    private static final class MockPinotStreamingQueryClient\n+            extends PinotStreamingQueryClient\n+    {\n+        private final ImmutableList<DataTable> dataTables;\n+\n+        MockPinotStreamingQueryClient(PinotStreamingQueryClient.Config pinotConfig, List<DataTable> dataTables)\n+        {\n+            super(pinotConfig);\n+            this.dataTables = ImmutableList.copyOf(dataTables);\n+        }\n+\n+        @Override\n+        public Iterator<ServerResponse> submit(String host, int port, GrpcRequestBuilder requestBuilder)\n+        {\n+            return new Iterator<ServerResponse>()\n+            {\n+                int i;", "originalCommit": "ab821abc728c11cb3ebbb8128f25750a73bd4017", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5d506fab6dedb37ee09ff1846ca6c9548e055192", "chunk": "diff --git a/presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/TestPinotStreamingSegmentPageSource.java b/presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/TestPinotStreamingSegmentPageSource.java\ndeleted file mode 100644\nindex f5d0576837..0000000000\n--- a/presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/TestPinotStreamingSegmentPageSource.java\n+++ /dev/null\n\n@@ -1,229 +0,0 @@\n-/*\n- * Licensed under the Apache License, Version 2.0 (the \"License\");\n- * you may not use this file except in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- *     http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-package com.facebook.presto.pinot;\n-\n-import com.facebook.presto.common.Page;\n-import com.facebook.presto.common.block.Block;\n-import com.facebook.presto.common.block.VariableWidthBlock;\n-import com.facebook.presto.common.type.ArrayType;\n-import com.facebook.presto.common.type.IntegerType;\n-import com.facebook.presto.common.type.Type;\n-import com.facebook.presto.common.type.VariableWidthType;\n-import com.facebook.presto.pinot.grpc.Constants;\n-import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n-import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n-import com.facebook.presto.pinot.grpc.ServerResponse;\n-import com.facebook.presto.spi.ConnectorSession;\n-import com.facebook.presto.testing.TestingConnectorSession;\n-import com.facebook.presto.testing.assertions.Assert;\n-import com.google.common.collect.ImmutableList;\n-import org.apache.pinot.common.proto.Server;\n-import org.apache.pinot.common.utils.DataSchema;\n-import org.apache.pinot.common.utils.DataTable;\n-import org.testng.annotations.Test;\n-\n-import java.io.IOException;\n-import java.nio.ByteBuffer;\n-import java.util.Iterator;\n-import java.util.List;\n-import java.util.Optional;\n-import java.util.stream.IntStream;\n-\n-import static com.google.common.collect.ImmutableList.toImmutableList;\n-import static java.util.Objects.requireNonNull;\n-\n-public class TestPinotStreamingSegmentPageSource\n-        extends TestPinotSegmentPageSource\n-{\n-    private static final class MockServerResponse\n-            extends ServerResponse\n-    {\n-        private DataTable dataTable;\n-\n-        public MockServerResponse(Server.ServerResponse serverResponse)\n-        {\n-            super(serverResponse);\n-        }\n-\n-        public MockServerResponse(DataTable dataTable)\n-        {\n-            super(null);\n-            this.dataTable = dataTable;\n-        }\n-\n-        public String getResponseType()\n-        {\n-            return Constants.Response.ResponseType.DATA;\n-        }\n-\n-        public int getSerializedSize()\n-        {\n-            return 0;\n-        }\n-\n-        public ByteBuffer getPayloadReadOnlyByteBuffer()\n-        {\n-            try {\n-                return ByteBuffer.wrap(dataTable.toBytes());\n-            }\n-            catch (IOException e) {\n-                throw new RuntimeException(e);\n-            }\n-        }\n-\n-        public DataTable getDataTable(ByteBuffer byteBuffer) throws IOException\n-        {\n-            return SimpleDataTable.fromBytes(byteBuffer);\n-        }\n-    }\n-\n-    private static final class MockPinotStreamingQueryClient\n-            extends PinotStreamingQueryClient\n-    {\n-        private final ImmutableList<DataTable> dataTables;\n-\n-        MockPinotStreamingQueryClient(PinotStreamingQueryClient.Config pinotConfig, List<DataTable> dataTables)\n-        {\n-            super(pinotConfig);\n-            this.dataTables = ImmutableList.copyOf(dataTables);\n-        }\n-\n-        @Override\n-        public Iterator<ServerResponse> submit(String host, int port, GrpcRequestBuilder requestBuilder)\n-        {\n-            return new Iterator<ServerResponse>()\n-            {\n-                int i;\n-\n-                @Override\n-                public boolean hasNext()\n-                {\n-                    return i < dataTables.size();\n-                }\n-\n-                @Override\n-                public ServerResponse next()\n-                {\n-                    return new MockServerResponse(dataTables.get(i++));\n-                }\n-            };\n-        }\n-    }\n-\n-    @Test\n-    public void testPrunedColumns()\n-    {\n-        PinotSessionProperties pinotSessionProperties = new PinotSessionProperties(pinotConfig);\n-        ConnectorSession session = new TestingConnectorSession(pinotSessionProperties.getSessionProperties());\n-        List<DataTable> dataTables = IntStream.range(0, 3).mapToObj(i -> createDataTableWithAllTypes()).collect(toImmutableList());\n-        MockPinotStreamingQueryClient mockPinotQueryClient = new MockPinotStreamingQueryClient(new PinotStreamingQueryClient.Config(pinotConfig.getStreamingServerGrpcMaxInboundMessageSize(), true), dataTables);\n-        List<PinotColumnHandle> expectedColumnHandles = createPinotColumnHandlesWithAllTypes();\n-        PinotSplit mockPinotSplit = new PinotSplit(pinotConnectorId.toString(), PinotSplit.SplitType.SEGMENT, expectedColumnHandles, Optional.empty(), Optional.of(\"blah\"), ImmutableList.of(\"seg\"), Optional.of(\"host\"), Optional.of(8090));\n-\n-        ImmutableList.Builder<Integer> columnsSurvivingBuilder = ImmutableList.builder();\n-        for (int i = expectedColumnHandles.size() - 1; i >= 0; i--) {\n-            if (i % 2 == 0) {\n-                columnsSurvivingBuilder.add(i);\n-            }\n-        }\n-        List<Integer> columnsSurviving = columnsSurvivingBuilder.build();\n-        List<PinotColumnHandle> handlesSurviving = columnsSurviving.stream().map(expectedColumnHandles::get).collect(toImmutableList());\n-        PinotSegmentPageSource pinotSegmentPageSource = new PinotSegmentStreamingPageSource(session, pinotConfig, mockPinotQueryClient, mockPinotSplit, handlesSurviving);\n-\n-        for (int i = 0; i < dataTables.size(); ++i) {\n-            Page page = requireNonNull(pinotSegmentPageSource.getNextPage(), \"Expected a valid page\");\n-            Assert.assertEquals(page.getChannelCount(), columnsSurviving.size());\n-            for (int j = 0; j < columnsSurviving.size(); ++j) {\n-                Block block = page.getBlock(j);\n-                int originalColumnIndex = columnsSurviving.get(j);\n-                Type type = PinotColumnUtils.getPrestoTypeFromPinotType(getFieldSpec(\"dontcare\", ALL_TYPES.get(originalColumnIndex)), false, false);\n-                long maxHashCode = Long.MIN_VALUE;\n-                for (int k = 0; k < NUM_ROWS; k++) {\n-                    maxHashCode = Math.max(type.hash(block, k), maxHashCode);\n-                }\n-                Assert.assertTrue(maxHashCode != 0, \"Not all column values can have hash code 0\");\n-            }\n-        }\n-    }\n-\n-    @Test\n-    public void testAllDataTypes()\n-    {\n-        PinotSessionProperties pinotSessionProperties = new PinotSessionProperties(pinotConfig);\n-        ConnectorSession session = new TestingConnectorSession(pinotSessionProperties.getSessionProperties());\n-        List<DataTable> dataTables = IntStream.range(0, 3).mapToObj(i -> createDataTableWithAllTypes()).collect(toImmutableList());\n-        MockPinotStreamingQueryClient mockPinotQueryClient = new MockPinotStreamingQueryClient(new PinotStreamingQueryClient.Config(pinotConfig.getStreamingServerGrpcMaxInboundMessageSize(), true), dataTables);\n-        List<PinotColumnHandle> pinotColumnHandles = createPinotColumnHandlesWithAllTypes();\n-        PinotSplit mockPinotSplit = new PinotSplit(pinotConnectorId.toString(), PinotSplit.SplitType.SEGMENT, pinotColumnHandles, Optional.empty(), Optional.of(\"blah\"), ImmutableList.of(\"seg\"), Optional.of(\"host\"), Optional.of(8090));\n-        PinotSegmentPageSource pinotSegmentPageSource = new PinotSegmentStreamingPageSource(session, pinotConfig, mockPinotQueryClient, mockPinotSplit, pinotColumnHandles);\n-\n-        for (int i = 0; i < dataTables.size(); ++i) {\n-            Page page = requireNonNull(pinotSegmentPageSource.getNextPage(), \"Expected a valid page\");\n-            for (int j = 0; j < ALL_TYPES.size(); ++j) {\n-                Block block = page.getBlock(j);\n-                Type type = PinotColumnUtils.getPrestoTypeFromPinotType(getFieldSpec(\"dontcare\", ALL_TYPES.get(j)), false, false);\n-                long maxHashCode = Long.MIN_VALUE;\n-                for (int k = 0; k < NUM_ROWS; ++k) {\n-                    maxHashCode = Math.max(type.hash(block, k), maxHashCode);\n-                }\n-                Assert.assertTrue(maxHashCode != 0, \"Not all column values can have hash code 0\");\n-            }\n-        }\n-    }\n-\n-    @Test\n-    public void testMultivaluedType()\n-    {\n-        String[] columnNames = {\"col1\", \"col2\"};\n-        DataSchema.ColumnDataType[] columnDataTypes = {DataSchema.ColumnDataType.INT_ARRAY, DataSchema.ColumnDataType.STRING_ARRAY};\n-        DataSchema dataSchema = new DataSchema(columnNames, columnDataTypes);\n-        SimpleDataTable dataTable = new SimpleDataTable(1, dataSchema);\n-\n-        int numRows = 1;\n-        String[] stringArray = {\"stringVal1\", \"stringVal2\"};\n-        int[] intArray = {10, 34, 67};\n-        dataTable.set(0, 0, intArray);\n-        dataTable.set(0, 1, stringArray);\n-\n-        PinotSessionProperties pinotSessionProperties = new PinotSessionProperties(pinotConfig);\n-        ConnectorSession session = new TestingConnectorSession(pinotSessionProperties.getSessionProperties());\n-        MockPinotStreamingQueryClient mockPinotQueryClient = new MockPinotStreamingQueryClient(new PinotStreamingQueryClient.Config(pinotConfig.getStreamingServerGrpcMaxInboundMessageSize(), true), ImmutableList.of(dataTable));\n-\n-        List<PinotColumnHandle> pinotColumnHandles = ImmutableList.of(\n-                new PinotColumnHandle(columnNames[0], PinotColumnUtils.getPrestoTypeFromPinotType(getFieldSpec(columnNames[0], columnDataTypes[0]), false, false), PinotColumnHandle.PinotColumnType.REGULAR),\n-                new PinotColumnHandle(columnNames[1], PinotColumnUtils.getPrestoTypeFromPinotType(getFieldSpec(columnNames[1], columnDataTypes[1]), false, false), PinotColumnHandle.PinotColumnType.REGULAR));\n-        PinotSplit mockPinotSplit = new PinotSplit(pinotConnectorId.toString(), PinotSplit.SplitType.SEGMENT, pinotColumnHandles, Optional.empty(), Optional.of(\"blah\"), ImmutableList.of(\"seg\"), Optional.of(\"host\"), Optional.of(8090));\n-        PinotSegmentPageSource pinotSegmentPageSource = new PinotSegmentStreamingPageSource(session, pinotConfig, mockPinotQueryClient, mockPinotSplit, pinotColumnHandles);\n-\n-        Page page = requireNonNull(pinotSegmentPageSource.getNextPage(), \"Expected a valid page\");\n-\n-        for (int i = 0; i < columnDataTypes.length; i++) {\n-            Block block = page.getBlock(i);\n-            Type type = PinotColumnUtils.getPrestoTypeFromPinotType(getFieldSpec(columnNames[i], columnDataTypes[i]), false, false);\n-            Assert.assertTrue(type instanceof ArrayType, \"presto type should be array\");\n-            if (((ArrayType) type).getElementType() instanceof IntegerType) {\n-                Assert.assertTrue(block.getBlock(0).getInt(0) == 10, \"Array element not matching\");\n-                Assert.assertTrue(block.getBlock(0).getInt(1) == 34, \"Array element not matching\");\n-                Assert.assertTrue(block.getBlock(0).getInt(2) == 67, \"Array element not matching\");\n-            }\n-            else if (((ArrayType) type).getElementType() instanceof VariableWidthType) {\n-                Type type1 = ((ArrayType) type).getElementType();\n-                Assert.assertTrue(block.getBlock(0) instanceof VariableWidthBlock);\n-                VariableWidthBlock variableWidthBlock = (VariableWidthBlock) block.getBlock(0);\n-                Assert.assertTrue(\"stringVal1\".equals(new String(variableWidthBlock.getSlice(0, 0, variableWidthBlock.getSliceLength(0)).getBytes())), \"Array element not matching\");\n-                Assert.assertTrue(\"stringVal2\".equals(new String(variableWidthBlock.getSlice(1, 0, variableWidthBlock.getSliceLength(1)).getBytes())), \"Array element not matching\");\n-            }\n-        }\n-    }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTMyMTg0OA==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r511321848", "bodyText": "sigh, so much test code duplication :-(", "author": "agrawaldevesh", "createdAt": "2020-10-24T05:14:16Z", "path": "presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/TestPinotStreamingSegmentPageSource.java", "diffHunk": "@@ -0,0 +1,229 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.block.VariableWidthBlock;\n+import com.facebook.presto.common.type.ArrayType;\n+import com.facebook.presto.common.type.IntegerType;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.common.type.VariableWidthType;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponse;\n+import com.facebook.presto.spi.ConnectorSession;\n+import com.facebook.presto.testing.TestingConnectorSession;\n+import com.facebook.presto.testing.assertions.Assert;\n+import com.google.common.collect.ImmutableList;\n+import org.apache.pinot.common.proto.Server;\n+import org.apache.pinot.common.utils.DataSchema;\n+import org.apache.pinot.common.utils.DataTable;\n+import org.testng.annotations.Test;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.stream.IntStream;\n+\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static java.util.Objects.requireNonNull;\n+\n+public class TestPinotStreamingSegmentPageSource\n+        extends TestPinotSegmentPageSource\n+{\n+    private static final class MockServerResponse\n+            extends ServerResponse\n+    {\n+        private DataTable dataTable;\n+\n+        public MockServerResponse(Server.ServerResponse serverResponse)\n+        {\n+            super(serverResponse);\n+        }\n+\n+        public MockServerResponse(DataTable dataTable)\n+        {\n+            super(null);\n+            this.dataTable = dataTable;\n+        }\n+\n+        public String getResponseType()\n+        {\n+            return Constants.Response.ResponseType.DATA;\n+        }\n+\n+        public int getSerializedSize()\n+        {\n+            return 0;\n+        }\n+\n+        public ByteBuffer getPayloadReadOnlyByteBuffer()\n+        {\n+            try {\n+                return ByteBuffer.wrap(dataTable.toBytes());\n+            }\n+            catch (IOException e) {\n+                throw new RuntimeException(e);\n+            }\n+        }\n+\n+        public DataTable getDataTable(ByteBuffer byteBuffer) throws IOException\n+        {\n+            return SimpleDataTable.fromBytes(byteBuffer);\n+        }\n+    }\n+\n+    private static final class MockPinotStreamingQueryClient\n+            extends PinotStreamingQueryClient\n+    {\n+        private final ImmutableList<DataTable> dataTables;\n+\n+        MockPinotStreamingQueryClient(PinotStreamingQueryClient.Config pinotConfig, List<DataTable> dataTables)\n+        {\n+            super(pinotConfig);\n+            this.dataTables = ImmutableList.copyOf(dataTables);\n+        }\n+\n+        @Override\n+        public Iterator<ServerResponse> submit(String host, int port, GrpcRequestBuilder requestBuilder)\n+        {\n+            return new Iterator<ServerResponse>()\n+            {\n+                int i;\n+\n+                @Override\n+                public boolean hasNext()\n+                {\n+                    return i < dataTables.size();\n+                }\n+\n+                @Override\n+                public ServerResponse next()\n+                {\n+                    return new MockServerResponse(dataTables.get(i++));\n+                }\n+            };\n+        }\n+    }\n+\n+    @Test", "originalCommit": "ab821abc728c11cb3ebbb8128f25750a73bd4017", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTMyNDI4OA==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r511324288", "bodyText": "I will clean this up.", "author": "xiangfu0", "createdAt": "2020-10-24T05:45:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTMyMTg0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTMyNzU4OQ==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r511327589", "bodyText": "Done", "author": "xiangfu0", "createdAt": "2020-10-24T06:28:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTMyMTg0OA=="}], "type": "inlineReview", "revised_code": {"commit": "5d506fab6dedb37ee09ff1846ca6c9548e055192", "chunk": "diff --git a/presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/TestPinotStreamingSegmentPageSource.java b/presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/TestPinotStreamingSegmentPageSource.java\ndeleted file mode 100644\nindex f5d0576837..0000000000\n--- a/presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/TestPinotStreamingSegmentPageSource.java\n+++ /dev/null\n\n@@ -1,229 +0,0 @@\n-/*\n- * Licensed under the Apache License, Version 2.0 (the \"License\");\n- * you may not use this file except in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- *     http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-package com.facebook.presto.pinot;\n-\n-import com.facebook.presto.common.Page;\n-import com.facebook.presto.common.block.Block;\n-import com.facebook.presto.common.block.VariableWidthBlock;\n-import com.facebook.presto.common.type.ArrayType;\n-import com.facebook.presto.common.type.IntegerType;\n-import com.facebook.presto.common.type.Type;\n-import com.facebook.presto.common.type.VariableWidthType;\n-import com.facebook.presto.pinot.grpc.Constants;\n-import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n-import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n-import com.facebook.presto.pinot.grpc.ServerResponse;\n-import com.facebook.presto.spi.ConnectorSession;\n-import com.facebook.presto.testing.TestingConnectorSession;\n-import com.facebook.presto.testing.assertions.Assert;\n-import com.google.common.collect.ImmutableList;\n-import org.apache.pinot.common.proto.Server;\n-import org.apache.pinot.common.utils.DataSchema;\n-import org.apache.pinot.common.utils.DataTable;\n-import org.testng.annotations.Test;\n-\n-import java.io.IOException;\n-import java.nio.ByteBuffer;\n-import java.util.Iterator;\n-import java.util.List;\n-import java.util.Optional;\n-import java.util.stream.IntStream;\n-\n-import static com.google.common.collect.ImmutableList.toImmutableList;\n-import static java.util.Objects.requireNonNull;\n-\n-public class TestPinotStreamingSegmentPageSource\n-        extends TestPinotSegmentPageSource\n-{\n-    private static final class MockServerResponse\n-            extends ServerResponse\n-    {\n-        private DataTable dataTable;\n-\n-        public MockServerResponse(Server.ServerResponse serverResponse)\n-        {\n-            super(serverResponse);\n-        }\n-\n-        public MockServerResponse(DataTable dataTable)\n-        {\n-            super(null);\n-            this.dataTable = dataTable;\n-        }\n-\n-        public String getResponseType()\n-        {\n-            return Constants.Response.ResponseType.DATA;\n-        }\n-\n-        public int getSerializedSize()\n-        {\n-            return 0;\n-        }\n-\n-        public ByteBuffer getPayloadReadOnlyByteBuffer()\n-        {\n-            try {\n-                return ByteBuffer.wrap(dataTable.toBytes());\n-            }\n-            catch (IOException e) {\n-                throw new RuntimeException(e);\n-            }\n-        }\n-\n-        public DataTable getDataTable(ByteBuffer byteBuffer) throws IOException\n-        {\n-            return SimpleDataTable.fromBytes(byteBuffer);\n-        }\n-    }\n-\n-    private static final class MockPinotStreamingQueryClient\n-            extends PinotStreamingQueryClient\n-    {\n-        private final ImmutableList<DataTable> dataTables;\n-\n-        MockPinotStreamingQueryClient(PinotStreamingQueryClient.Config pinotConfig, List<DataTable> dataTables)\n-        {\n-            super(pinotConfig);\n-            this.dataTables = ImmutableList.copyOf(dataTables);\n-        }\n-\n-        @Override\n-        public Iterator<ServerResponse> submit(String host, int port, GrpcRequestBuilder requestBuilder)\n-        {\n-            return new Iterator<ServerResponse>()\n-            {\n-                int i;\n-\n-                @Override\n-                public boolean hasNext()\n-                {\n-                    return i < dataTables.size();\n-                }\n-\n-                @Override\n-                public ServerResponse next()\n-                {\n-                    return new MockServerResponse(dataTables.get(i++));\n-                }\n-            };\n-        }\n-    }\n-\n-    @Test\n-    public void testPrunedColumns()\n-    {\n-        PinotSessionProperties pinotSessionProperties = new PinotSessionProperties(pinotConfig);\n-        ConnectorSession session = new TestingConnectorSession(pinotSessionProperties.getSessionProperties());\n-        List<DataTable> dataTables = IntStream.range(0, 3).mapToObj(i -> createDataTableWithAllTypes()).collect(toImmutableList());\n-        MockPinotStreamingQueryClient mockPinotQueryClient = new MockPinotStreamingQueryClient(new PinotStreamingQueryClient.Config(pinotConfig.getStreamingServerGrpcMaxInboundMessageSize(), true), dataTables);\n-        List<PinotColumnHandle> expectedColumnHandles = createPinotColumnHandlesWithAllTypes();\n-        PinotSplit mockPinotSplit = new PinotSplit(pinotConnectorId.toString(), PinotSplit.SplitType.SEGMENT, expectedColumnHandles, Optional.empty(), Optional.of(\"blah\"), ImmutableList.of(\"seg\"), Optional.of(\"host\"), Optional.of(8090));\n-\n-        ImmutableList.Builder<Integer> columnsSurvivingBuilder = ImmutableList.builder();\n-        for (int i = expectedColumnHandles.size() - 1; i >= 0; i--) {\n-            if (i % 2 == 0) {\n-                columnsSurvivingBuilder.add(i);\n-            }\n-        }\n-        List<Integer> columnsSurviving = columnsSurvivingBuilder.build();\n-        List<PinotColumnHandle> handlesSurviving = columnsSurviving.stream().map(expectedColumnHandles::get).collect(toImmutableList());\n-        PinotSegmentPageSource pinotSegmentPageSource = new PinotSegmentStreamingPageSource(session, pinotConfig, mockPinotQueryClient, mockPinotSplit, handlesSurviving);\n-\n-        for (int i = 0; i < dataTables.size(); ++i) {\n-            Page page = requireNonNull(pinotSegmentPageSource.getNextPage(), \"Expected a valid page\");\n-            Assert.assertEquals(page.getChannelCount(), columnsSurviving.size());\n-            for (int j = 0; j < columnsSurviving.size(); ++j) {\n-                Block block = page.getBlock(j);\n-                int originalColumnIndex = columnsSurviving.get(j);\n-                Type type = PinotColumnUtils.getPrestoTypeFromPinotType(getFieldSpec(\"dontcare\", ALL_TYPES.get(originalColumnIndex)), false, false);\n-                long maxHashCode = Long.MIN_VALUE;\n-                for (int k = 0; k < NUM_ROWS; k++) {\n-                    maxHashCode = Math.max(type.hash(block, k), maxHashCode);\n-                }\n-                Assert.assertTrue(maxHashCode != 0, \"Not all column values can have hash code 0\");\n-            }\n-        }\n-    }\n-\n-    @Test\n-    public void testAllDataTypes()\n-    {\n-        PinotSessionProperties pinotSessionProperties = new PinotSessionProperties(pinotConfig);\n-        ConnectorSession session = new TestingConnectorSession(pinotSessionProperties.getSessionProperties());\n-        List<DataTable> dataTables = IntStream.range(0, 3).mapToObj(i -> createDataTableWithAllTypes()).collect(toImmutableList());\n-        MockPinotStreamingQueryClient mockPinotQueryClient = new MockPinotStreamingQueryClient(new PinotStreamingQueryClient.Config(pinotConfig.getStreamingServerGrpcMaxInboundMessageSize(), true), dataTables);\n-        List<PinotColumnHandle> pinotColumnHandles = createPinotColumnHandlesWithAllTypes();\n-        PinotSplit mockPinotSplit = new PinotSplit(pinotConnectorId.toString(), PinotSplit.SplitType.SEGMENT, pinotColumnHandles, Optional.empty(), Optional.of(\"blah\"), ImmutableList.of(\"seg\"), Optional.of(\"host\"), Optional.of(8090));\n-        PinotSegmentPageSource pinotSegmentPageSource = new PinotSegmentStreamingPageSource(session, pinotConfig, mockPinotQueryClient, mockPinotSplit, pinotColumnHandles);\n-\n-        for (int i = 0; i < dataTables.size(); ++i) {\n-            Page page = requireNonNull(pinotSegmentPageSource.getNextPage(), \"Expected a valid page\");\n-            for (int j = 0; j < ALL_TYPES.size(); ++j) {\n-                Block block = page.getBlock(j);\n-                Type type = PinotColumnUtils.getPrestoTypeFromPinotType(getFieldSpec(\"dontcare\", ALL_TYPES.get(j)), false, false);\n-                long maxHashCode = Long.MIN_VALUE;\n-                for (int k = 0; k < NUM_ROWS; ++k) {\n-                    maxHashCode = Math.max(type.hash(block, k), maxHashCode);\n-                }\n-                Assert.assertTrue(maxHashCode != 0, \"Not all column values can have hash code 0\");\n-            }\n-        }\n-    }\n-\n-    @Test\n-    public void testMultivaluedType()\n-    {\n-        String[] columnNames = {\"col1\", \"col2\"};\n-        DataSchema.ColumnDataType[] columnDataTypes = {DataSchema.ColumnDataType.INT_ARRAY, DataSchema.ColumnDataType.STRING_ARRAY};\n-        DataSchema dataSchema = new DataSchema(columnNames, columnDataTypes);\n-        SimpleDataTable dataTable = new SimpleDataTable(1, dataSchema);\n-\n-        int numRows = 1;\n-        String[] stringArray = {\"stringVal1\", \"stringVal2\"};\n-        int[] intArray = {10, 34, 67};\n-        dataTable.set(0, 0, intArray);\n-        dataTable.set(0, 1, stringArray);\n-\n-        PinotSessionProperties pinotSessionProperties = new PinotSessionProperties(pinotConfig);\n-        ConnectorSession session = new TestingConnectorSession(pinotSessionProperties.getSessionProperties());\n-        MockPinotStreamingQueryClient mockPinotQueryClient = new MockPinotStreamingQueryClient(new PinotStreamingQueryClient.Config(pinotConfig.getStreamingServerGrpcMaxInboundMessageSize(), true), ImmutableList.of(dataTable));\n-\n-        List<PinotColumnHandle> pinotColumnHandles = ImmutableList.of(\n-                new PinotColumnHandle(columnNames[0], PinotColumnUtils.getPrestoTypeFromPinotType(getFieldSpec(columnNames[0], columnDataTypes[0]), false, false), PinotColumnHandle.PinotColumnType.REGULAR),\n-                new PinotColumnHandle(columnNames[1], PinotColumnUtils.getPrestoTypeFromPinotType(getFieldSpec(columnNames[1], columnDataTypes[1]), false, false), PinotColumnHandle.PinotColumnType.REGULAR));\n-        PinotSplit mockPinotSplit = new PinotSplit(pinotConnectorId.toString(), PinotSplit.SplitType.SEGMENT, pinotColumnHandles, Optional.empty(), Optional.of(\"blah\"), ImmutableList.of(\"seg\"), Optional.of(\"host\"), Optional.of(8090));\n-        PinotSegmentPageSource pinotSegmentPageSource = new PinotSegmentStreamingPageSource(session, pinotConfig, mockPinotQueryClient, mockPinotSplit, pinotColumnHandles);\n-\n-        Page page = requireNonNull(pinotSegmentPageSource.getNextPage(), \"Expected a valid page\");\n-\n-        for (int i = 0; i < columnDataTypes.length; i++) {\n-            Block block = page.getBlock(i);\n-            Type type = PinotColumnUtils.getPrestoTypeFromPinotType(getFieldSpec(columnNames[i], columnDataTypes[i]), false, false);\n-            Assert.assertTrue(type instanceof ArrayType, \"presto type should be array\");\n-            if (((ArrayType) type).getElementType() instanceof IntegerType) {\n-                Assert.assertTrue(block.getBlock(0).getInt(0) == 10, \"Array element not matching\");\n-                Assert.assertTrue(block.getBlock(0).getInt(1) == 34, \"Array element not matching\");\n-                Assert.assertTrue(block.getBlock(0).getInt(2) == 67, \"Array element not matching\");\n-            }\n-            else if (((ArrayType) type).getElementType() instanceof VariableWidthType) {\n-                Type type1 = ((ArrayType) type).getElementType();\n-                Assert.assertTrue(block.getBlock(0) instanceof VariableWidthBlock);\n-                VariableWidthBlock variableWidthBlock = (VariableWidthBlock) block.getBlock(0);\n-                Assert.assertTrue(\"stringVal1\".equals(new String(variableWidthBlock.getSlice(0, 0, variableWidthBlock.getSliceLength(0)).getBytes())), \"Array element not matching\");\n-                Assert.assertTrue(\"stringVal2\".equals(new String(variableWidthBlock.getSlice(1, 0, variableWidthBlock.getSliceLength(1)).getBytes())), \"Array element not matching\");\n-            }\n-        }\n-    }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTMyMjAwNg==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r511322006", "bodyText": "Should we also check that the splits return a valid GRPC host ?", "author": "agrawaldevesh", "createdAt": "2020-10-24T05:15:06Z", "path": "presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/TestPinotSplitManager.java", "diffHunk": "@@ -125,10 +125,13 @@ private void assertSplits(List<PinotSplit> splits, int numSplitsExpected, PinotS\n     private void assertSegmentSplitWellFormed(PinotSplit split, boolean expectFilter)", "originalCommit": "ab821abc728c11cb3ebbb8128f25750a73bd4017", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTMyNDQwOQ==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r511324409", "bodyText": "The only check I can think is length > 0", "author": "xiangfu0", "createdAt": "2020-10-24T05:47:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTMyMjAwNg=="}], "type": "inlineReview", "revised_code": {"commit": "5d506fab6dedb37ee09ff1846ca6c9548e055192", "chunk": "diff --git a/presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/TestPinotSplitManager.java b/presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/TestPinotSplitManager.java\nindex 56887f608e..17210bf9d1 100644\n--- a/presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/TestPinotSplitManager.java\n+++ b/presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/TestPinotSplitManager.java\n\n@@ -128,6 +128,8 @@ public class TestPinotSplitManager\n         assertTrue(split.getSegmentPinotQuery().isPresent());\n         assertTrue(split.getSegmentHost().isPresent());\n         assertTrue(split.getGrpcHost().isPresent());\n+        assertTrue(split.getGrpcHost().get().length() > 0);\n+        assertEquals(split.getGrpcHost().get(), split.getSegmentHost().get());\n         assertTrue(split.getGrpcPort().isPresent());\n         assertEquals(split.getGrpcPort().get().intValue(), MockPinotClusterInfoFetcher.DEFAULT_GRPC_PORT);\n         assertFalse(split.getSegments().isEmpty());\n"}}, {"oid": "5d506fab6dedb37ee09ff1846ca6c9548e055192", "url": "https://github.com/prestodb/presto/commit/5d506fab6dedb37ee09ff1846ca6c9548e055192", "message": "Support Pinot Streaming connector for Segment query", "committedDate": "2020-10-24T06:03:07Z", "type": "forcePushed"}, {"oid": "a007c6a85f21747f774b1c6560dc98096dde7345", "url": "https://github.com/prestodb/presto/commit/a007c6a85f21747f774b1c6560dc98096dde7345", "message": "Support Pinot Streaming connector for Segment query\n\nPinot recently added support of gRpc based streaming query endpoint at Pinot server level, which allows user to pull data in a streaming fashion. (apache/incubator-pinot#5599, apache/incubator-pinot#6027 )\n\nThis is extremely good for the use cases which requires large data scan and try to retrieve a lot of data from Pinot.\n\nComparing to the non-streaming way, Presto segment level query requires pinot server to process the query on the entire data segment and all the results have to be in memory and serialized then send back to client. In the streaming fashion, client side can specify a block size and only call next to fetch the given size of results to process then call next to fetch the next block. Pinot server side only advance and process the data processing when client calls next. In this way, Pinot server side cpu and memory pressure is much less.", "committedDate": "2020-10-24T06:23:51Z", "type": "forcePushed"}, {"oid": "8e702c2df403c51024596c8b23be7264d6c43a6c", "url": "https://github.com/prestodb/presto/commit/8e702c2df403c51024596c8b23be7264d6c43a6c", "message": "Support Pinot Streaming connector for Segment query\n\nPinot recently added support of gRpc based streaming query endpoint at Pinot server level, which allows user to pull data in a streaming fashion. (apache/incubator-pinot#5599, apache/incubator-pinot#6027 )\n\nThis is extremely good for the use cases which requires large data scan and try to retrieve a lot of data from Pinot.\n\nComparing to the non-streaming way, Presto segment level query requires pinot server to process the query on the entire data segment and all the results have to be in memory and serialized then send back to client. In the streaming fashion, client side can specify a block size and only call next to fetch the given size of results to process then call next to fetch the next block. Pinot server side only advance and process the data processing when client calls next. In this way, Pinot server side cpu and memory pressure is much less.", "committedDate": "2020-10-24T06:35:26Z", "type": "forcePushed"}, {"oid": "3a2b32fbd40552b512e0120e749cd9872702c06d", "url": "https://github.com/prestodb/presto/commit/3a2b32fbd40552b512e0120e749cd9872702c06d", "message": "Support Pinot Streaming connector for Segment query\n\nPinot recently added support of gRpc based streaming query endpoint at Pinot server level, which allows user to pull data in a streaming fashion. (apache/incubator-pinot#5599, apache/incubator-pinot#6027 )\n\nThis is extremely good for the use cases which requires large data scan and try to retrieve a lot of data from Pinot.\n\nComparing to the non-streaming way, Presto segment level query requires pinot server to process the query on the entire data segment and all the results have to be in memory and serialized then send back to client. In the streaming fashion, client side can specify a block size and only call next to fetch the given size of results to process then call next to fetch the next block. Pinot server side only advance and process the data processing when client calls next. In this way, Pinot server side cpu and memory pressure is much less.", "committedDate": "2020-10-24T08:28:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ5MzE4OQ==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r511493189", "bodyText": "nit: Extra newline ?", "author": "agrawaldevesh", "createdAt": "2020-10-24T17:09:23Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java", "diffHunk": "@@ -0,0 +1,143 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponse;\n+import com.facebook.presto.spi.ConnectorSession;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_DATA_FETCH_EXCEPTION;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_INVALID_SEGMENT_QUERY_GENERATED;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_UNEXPECTED_RESPONSE;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n+ */\n+", "originalCommit": "3a2b32fbd40552b512e0120e749cd9872702c06d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5c832b73c735381e71e68f66e355cf78060e048d", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\nindex e34d3c024a..f8a9365a38 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\n\n@@ -35,7 +35,6 @@ import static java.util.Objects.requireNonNull;\n /**\n  * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n  */\n-\n public class PinotSegmentStreamingPageSource\n         extends PinotSegmentPageSource\n {\n"}}, {"oid": "5c832b73c735381e71e68f66e355cf78060e048d", "url": "https://github.com/prestodb/presto/commit/5c832b73c735381e71e68f66e355cf78060e048d", "message": "Support Pinot Streaming connector for Segment query\n\nPinot recently added support of gRpc based streaming query endpoint at Pinot server level, which allows user to pull data in a streaming fashion. (apache/incubator-pinot#5599, apache/incubator-pinot#6027 )\n\nThis is extremely good for the use cases which requires large data scan and try to retrieve a lot of data from Pinot.\n\nComparing to the non-streaming way, Presto segment level query requires pinot server to process the query on the entire data segment and all the results have to be in memory and serialized then send back to client. In the streaming fashion, client side can specify a block size and only call next to fetch the given size of results to process then call next to fetch the next block. Pinot server side only advance and process the data processing when client calls next. In this way, Pinot server side cpu and memory pressure is much less.", "committedDate": "2020-10-24T18:37:14Z", "type": "forcePushed"}, {"oid": "e2740568a46aade69e8eafec4097abf74d42e530", "url": "https://github.com/prestodb/presto/commit/e2740568a46aade69e8eafec4097abf74d42e530", "message": "Support Pinot Streaming connector for Segment query\n\nPinot recently added support of gRpc based streaming query endpoint at Pinot server level, which allows user to pull data in a streaming fashion. (apache/incubator-pinot#5599, apache/incubator-pinot#6027 )\n\nThis is extremely good for the use cases which requires large data scan and try to retrieve a lot of data from Pinot.\n\nComparing to the non-streaming way, Presto segment level query requires pinot server to process the query on the entire data segment and all the results have to be in memory and serialized then send back to client. In the streaming fashion, client side can specify a block size and only call next to fetch the given size of results to process then call next to fetch the next block. Pinot server side only advance and process the data processing when client calls next. In this way, Pinot server side cpu and memory pressure is much less.", "committedDate": "2020-10-24T19:38:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTUxMzczNw==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r511513737", "bodyText": "This is a stale comment now.", "author": "agrawaldevesh", "createdAt": "2020-10-24T20:59:12Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java", "diffHunk": "@@ -486,4 +504,100 @@ public TimeBoundary getTimeBoundaryForTable(String table)\n             throw e;\n         }\n     }\n+\n+    public static class Instance\n+    {\n+        private final String instanceName;\n+        private final String hostName;\n+        private final boolean enabled;\n+        private final int port;\n+        private final int grpcPort;\n+        private final List<String> tags;\n+        private final List<String> pools;\n+\n+        @JsonCreator\n+        public Instance(\n+                @JsonProperty String instanceName,\n+                @JsonProperty String hostName,\n+                @JsonProperty boolean enabled,\n+                @JsonProperty int port,\n+                @JsonProperty int grpcPort,\n+                @JsonProperty List<String> tags,\n+                @JsonProperty List<String> pools)\n+        {\n+            this.instanceName = instanceName;\n+            this.hostName = hostName;\n+            this.enabled = enabled;\n+            this.port = port;\n+            this.grpcPort = grpcPort;\n+            this.tags = tags;\n+            this.pools = pools;\n+        }\n+\n+        public String getInstanceName()\n+        {\n+            return instanceName;\n+        }\n+\n+        public String getHostName()\n+        {\n+            return hostName;\n+        }\n+\n+        public boolean isEnabled()\n+        {\n+            return enabled;\n+        }\n+\n+        public int getPort()\n+        {\n+            return port;\n+        }\n+\n+        public int getGrpcPort()\n+        {\n+            return grpcPort;\n+        }\n+\n+        public List<String> getTags()\n+        {\n+            return tags;\n+        }\n+\n+        public List<String> getPools()\n+        {\n+            return pools;\n+        }\n+    }\n+\n+    public Instance getInstance(String instanceName)\n+    {\n+        try {\n+            String responseBody = sendHttpGetToController(String.format(INSTANCE_API_TEMPLATE, instanceName));\n+            return instanceJsonCodec.fromJson(responseBody);\n+        }\n+        catch (Exception throwable) {\n+            throw new PinotException(PINOT_UNABLE_TO_FIND_INSTANCE, Optional.empty(), \"Error when fetching instance configs for \" + instanceName, throwable);\n+        }\n+    }\n+\n+    // Fetch grpc port based on below policy:\n+    //   1. Extract grpc port from Pinot instance config\n+    //   2. If gRpc port < 0 then return fallback server grpc port setting by config: `pinot.server-grpc-port`.", "originalCommit": "e2740568a46aade69e8eafec4097abf74d42e530", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bd152cb1d424358fe7db9e1c92747138e83f9361", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java\nindex 42d058fb7f..3661e3d951 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java\n\n@@ -581,9 +581,7 @@ public class PinotClusterInfoFetcher\n         }\n     }\n \n-    // Fetch grpc port based on below policy:\n-    //   1. Extract grpc port from Pinot instance config\n-    //   2. If gRpc port < 0 then return fallback server grpc port setting by config: `pinot.server-grpc-port`.\n+    // Fetch grpc port from Pinot instance config.\n     public int getGrpcPort(String serverInstance)\n     {\n         try {\n"}}, {"oid": "bd152cb1d424358fe7db9e1c92747138e83f9361", "url": "https://github.com/prestodb/presto/commit/bd152cb1d424358fe7db9e1c92747138e83f9361", "message": "Support Pinot Streaming connector for Segment query\n\nPinot recently added support of gRpc based streaming query endpoint at Pinot server level, which allows user to pull data in a streaming fashion. (apache/incubator-pinot#5599, apache/incubator-pinot#6027 )\n\nThis is extremely good for the use cases which requires large data scan and try to retrieve a lot of data from Pinot.\n\nComparing to the non-streaming way, Presto segment level query requires pinot server to process the query on the entire data segment and all the results have to be in memory and serialized then send back to client. In the streaming fashion, client side can specify a block size and only call next to fetch the given size of results to process then call next to fetch the next block. Pinot server side only advance and process the data processing when client calls next. In this way, Pinot server side cpu and memory pressure is much less.", "committedDate": "2020-10-24T22:44:55Z", "type": "forcePushed"}, {"oid": "2bff425cf680a314456e8d69c68c2eb69472c3f1", "url": "https://github.com/prestodb/presto/commit/2bff425cf680a314456e8d69c68c2eb69472c3f1", "message": "Support Pinot Streaming connector for Segment query\n\nPinot recently added support of gRpc based streaming query endpoint at Pinot server level, which allows user to pull data in a streaming fashion. (apache/incubator-pinot#5599, apache/incubator-pinot#6027 )\n\nThis is extremely good for the use cases which requires large data scan and try to retrieve a lot of data from Pinot.\n\nComparing to the non-streaming way, Presto segment level query requires pinot server to process the query on the entire data segment and all the results have to be in memory and serialized then send back to client. In the streaming fashion, client side can specify a block size and only call next to fetch the given size of results to process then call next to fetch the next block. Pinot server side only advance and process the data processing when client calls next. In this way, Pinot server side cpu and memory pressure is much less.", "committedDate": "2020-10-28T21:11:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc0NTUwOQ==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r515745509", "bodyText": "one param per line", "author": "highker", "createdAt": "2020-11-02T05:23:20Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java", "diffHunk": "@@ -486,4 +504,98 @@ public TimeBoundary getTimeBoundaryForTable(String table)\n             throw e;\n         }\n     }\n+\n+    public static class Instance\n+    {\n+        private final String instanceName;\n+        private final String hostName;\n+        private final boolean enabled;\n+        private final int port;\n+        private final int grpcPort;\n+        private final List<String> tags;\n+        private final List<String> pools;\n+\n+        @JsonCreator\n+        public Instance(\n+                @JsonProperty String instanceName,\n+                @JsonProperty String hostName,\n+                @JsonProperty boolean enabled,\n+                @JsonProperty int port,\n+                @JsonProperty int grpcPort,\n+                @JsonProperty List<String> tags,\n+                @JsonProperty List<String> pools)\n+        {\n+            this.instanceName = instanceName;\n+            this.hostName = hostName;\n+            this.enabled = enabled;\n+            this.port = port;\n+            this.grpcPort = grpcPort;\n+            this.tags = tags;\n+            this.pools = pools;\n+        }\n+\n+        public String getInstanceName()\n+        {\n+            return instanceName;\n+        }\n+\n+        public String getHostName()\n+        {\n+            return hostName;\n+        }\n+\n+        public boolean isEnabled()\n+        {\n+            return enabled;\n+        }\n+\n+        public int getPort()\n+        {\n+            return port;\n+        }\n+\n+        public int getGrpcPort()\n+        {\n+            return grpcPort;\n+        }\n+\n+        public List<String> getTags()\n+        {\n+            return tags;\n+        }\n+\n+        public List<String> getPools()\n+        {\n+            return pools;\n+        }\n+    }\n+\n+    public Instance getInstance(String instanceName)\n+    {\n+        try {\n+            String responseBody = sendHttpGetToController(String.format(INSTANCE_API_TEMPLATE, instanceName));\n+            return instanceJsonCodec.fromJson(responseBody);\n+        }\n+        catch (Exception throwable) {\n+            throw new PinotException(PINOT_UNABLE_TO_FIND_INSTANCE, Optional.empty(), \"Error when fetching instance configs for \" + instanceName, throwable);\n+        }\n+    }\n+\n+    // Fetch grpc port from Pinot instance config.\n+    public int getGrpcPort(String serverInstance)\n+    {\n+        try {\n+            return instanceConfigCache.get(serverInstance).getGrpcPort();\n+        }\n+        catch (ExecutionException e) {\n+            Throwable cause = e.getCause();\n+            if (cause instanceof PinotException) {\n+                throw (PinotException) cause;\n+            }\n+            else {\n+                throw new PinotException(PINOT_UNABLE_TO_FIND_INSTANCE, Optional.empty(),\n+                    \"Error when getting instance config for \" + serverInstance, cause);", "originalCommit": "2bff425cf680a314456e8d69c68c2eb69472c3f1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f72c8797b8b84b70fc60f1334f0a376db02c937d", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java\nindex 3661e3d951..7ea3f4486c 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java\n\n@@ -534,36 +534,43 @@ public class PinotClusterInfoFetcher\n             this.pools = pools;\n         }\n \n+        @JsonProperty\n         public String getInstanceName()\n         {\n             return instanceName;\n         }\n \n+        @JsonProperty\n         public String getHostName()\n         {\n             return hostName;\n         }\n \n+        @JsonProperty\n         public boolean isEnabled()\n         {\n             return enabled;\n         }\n \n+        @JsonProperty\n         public int getPort()\n         {\n             return port;\n         }\n \n+        @JsonProperty\n         public int getGrpcPort()\n         {\n             return grpcPort;\n         }\n \n+        @JsonProperty\n         public List<String> getTags()\n         {\n             return tags;\n         }\n \n+        @JsonProperty\n         public List<String> getPools()\n         {\n             return pools;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc0NTUyMg==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r515745522", "bodyText": "remove else", "author": "highker", "createdAt": "2020-11-02T05:23:25Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java", "diffHunk": "@@ -486,4 +504,98 @@ public TimeBoundary getTimeBoundaryForTable(String table)\n             throw e;\n         }\n     }\n+\n+    public static class Instance\n+    {\n+        private final String instanceName;\n+        private final String hostName;\n+        private final boolean enabled;\n+        private final int port;\n+        private final int grpcPort;\n+        private final List<String> tags;\n+        private final List<String> pools;\n+\n+        @JsonCreator\n+        public Instance(\n+                @JsonProperty String instanceName,\n+                @JsonProperty String hostName,\n+                @JsonProperty boolean enabled,\n+                @JsonProperty int port,\n+                @JsonProperty int grpcPort,\n+                @JsonProperty List<String> tags,\n+                @JsonProperty List<String> pools)\n+        {\n+            this.instanceName = instanceName;\n+            this.hostName = hostName;\n+            this.enabled = enabled;\n+            this.port = port;\n+            this.grpcPort = grpcPort;\n+            this.tags = tags;\n+            this.pools = pools;\n+        }\n+\n+        public String getInstanceName()\n+        {\n+            return instanceName;\n+        }\n+\n+        public String getHostName()\n+        {\n+            return hostName;\n+        }\n+\n+        public boolean isEnabled()\n+        {\n+            return enabled;\n+        }\n+\n+        public int getPort()\n+        {\n+            return port;\n+        }\n+\n+        public int getGrpcPort()\n+        {\n+            return grpcPort;\n+        }\n+\n+        public List<String> getTags()\n+        {\n+            return tags;\n+        }\n+\n+        public List<String> getPools()\n+        {\n+            return pools;\n+        }\n+    }\n+\n+    public Instance getInstance(String instanceName)\n+    {\n+        try {\n+            String responseBody = sendHttpGetToController(String.format(INSTANCE_API_TEMPLATE, instanceName));\n+            return instanceJsonCodec.fromJson(responseBody);\n+        }\n+        catch (Exception throwable) {\n+            throw new PinotException(PINOT_UNABLE_TO_FIND_INSTANCE, Optional.empty(), \"Error when fetching instance configs for \" + instanceName, throwable);\n+        }\n+    }\n+\n+    // Fetch grpc port from Pinot instance config.\n+    public int getGrpcPort(String serverInstance)\n+    {\n+        try {\n+            return instanceConfigCache.get(serverInstance).getGrpcPort();\n+        }\n+        catch (ExecutionException e) {\n+            Throwable cause = e.getCause();\n+            if (cause instanceof PinotException) {\n+                throw (PinotException) cause;\n+            }\n+            else {", "originalCommit": "2bff425cf680a314456e8d69c68c2eb69472c3f1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f72c8797b8b84b70fc60f1334f0a376db02c937d", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java\nindex 3661e3d951..7ea3f4486c 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java\n\n@@ -534,36 +534,43 @@ public class PinotClusterInfoFetcher\n             this.pools = pools;\n         }\n \n+        @JsonProperty\n         public String getInstanceName()\n         {\n             return instanceName;\n         }\n \n+        @JsonProperty\n         public String getHostName()\n         {\n             return hostName;\n         }\n \n+        @JsonProperty\n         public boolean isEnabled()\n         {\n             return enabled;\n         }\n \n+        @JsonProperty\n         public int getPort()\n         {\n             return port;\n         }\n \n+        @JsonProperty\n         public int getGrpcPort()\n         {\n             return grpcPort;\n         }\n \n+        @JsonProperty\n         public List<String> getTags()\n         {\n             return tags;\n         }\n \n+        @JsonProperty\n         public List<String> getPools()\n         {\n             return pools;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc0NTgzMQ==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r515745831", "bodyText": "Is this class json serializable? If it is, let's annotate each getter with @JsonProperty.", "author": "highker", "createdAt": "2020-11-02T05:24:40Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java", "diffHunk": "@@ -486,4 +504,98 @@ public TimeBoundary getTimeBoundaryForTable(String table)\n             throw e;\n         }\n     }\n+\n+    public static class Instance\n+    {\n+        private final String instanceName;\n+        private final String hostName;\n+        private final boolean enabled;\n+        private final int port;\n+        private final int grpcPort;\n+        private final List<String> tags;\n+        private final List<String> pools;\n+\n+        @JsonCreator\n+        public Instance(\n+                @JsonProperty String instanceName,\n+                @JsonProperty String hostName,\n+                @JsonProperty boolean enabled,\n+                @JsonProperty int port,\n+                @JsonProperty int grpcPort,\n+                @JsonProperty List<String> tags,\n+                @JsonProperty List<String> pools)\n+        {\n+            this.instanceName = instanceName;\n+            this.hostName = hostName;\n+            this.enabled = enabled;\n+            this.port = port;\n+            this.grpcPort = grpcPort;\n+            this.tags = tags;\n+            this.pools = pools;\n+        }\n+\n+        public String getInstanceName()", "originalCommit": "2bff425cf680a314456e8d69c68c2eb69472c3f1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f72c8797b8b84b70fc60f1334f0a376db02c937d", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java\nindex 3661e3d951..7ea3f4486c 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java\n\n@@ -534,36 +534,43 @@ public class PinotClusterInfoFetcher\n             this.pools = pools;\n         }\n \n+        @JsonProperty\n         public String getInstanceName()\n         {\n             return instanceName;\n         }\n \n+        @JsonProperty\n         public String getHostName()\n         {\n             return hostName;\n         }\n \n+        @JsonProperty\n         public boolean isEnabled()\n         {\n             return enabled;\n         }\n \n+        @JsonProperty\n         public int getPort()\n         {\n             return port;\n         }\n \n+        @JsonProperty\n         public int getGrpcPort()\n         {\n             return grpcPort;\n         }\n \n+        @JsonProperty\n         public List<String> getTags()\n         {\n             return tags;\n         }\n \n+        @JsonProperty\n         public List<String> getPools()\n         {\n             return pools;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc0NjA5Nw==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r515746097", "bodyText": "put this to the end to be the same order as the ones on stack and constructor parameters.", "author": "highker", "createdAt": "2020-11-02T05:25:40Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java", "diffHunk": "@@ -95,12 +107,14 @@ public PinotClusterInfoFetcher(\n             JsonCodec<BrokersForTable> brokersForTableJsonCodec,\n             JsonCodec<RoutingTables> routingTablesJsonCodec,\n             JsonCodec<RoutingTablesV2> routingTablesV2JsonCodec,\n-            JsonCodec<TimeBoundary> timeBoundaryJsonCodec)\n+            JsonCodec<TimeBoundary> timeBoundaryJsonCodec,\n+            JsonCodec<Instance> instanceJsonCodec)\n     {\n         this.brokersForTableJsonCodec = requireNonNull(brokersForTableJsonCodec, \"brokers for table json codec is null\");\n         this.routingTablesJsonCodec = requireNonNull(routingTablesJsonCodec, \"routing tables json codec is null\");\n         this.routingTablesV2JsonCodec = requireNonNull(routingTablesV2JsonCodec, \"routing tables v2 json codec is null\");\n         this.timeBoundaryJsonCodec = requireNonNull(timeBoundaryJsonCodec, \"time boundary json codec is null\");\n+        this.instanceJsonCodec = requireNonNull(instanceJsonCodec, \"instance json codec is null\");", "originalCommit": "2bff425cf680a314456e8d69c68c2eb69472c3f1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f72c8797b8b84b70fc60f1334f0a376db02c937d", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java\nindex 3661e3d951..7ea3f4486c 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java\n\n@@ -110,17 +110,17 @@ public class PinotClusterInfoFetcher\n             JsonCodec<TimeBoundary> timeBoundaryJsonCodec,\n             JsonCodec<Instance> instanceJsonCodec)\n     {\n+        this.pinotConfig = requireNonNull(pinotConfig, \"pinotConfig is null\");\n+        this.pinotMetrics = requireNonNull(pinotMetrics, \"pinotMetrics is null\");\n+        this.httpClient = requireNonNull(httpClient, \"httpClient is null\");\n+        this.tablesJsonCodec = requireNonNull(tablesJsonCodec, \"json codec is null\");\n         this.brokersForTableJsonCodec = requireNonNull(brokersForTableJsonCodec, \"brokers for table json codec is null\");\n         this.routingTablesJsonCodec = requireNonNull(routingTablesJsonCodec, \"routing tables json codec is null\");\n         this.routingTablesV2JsonCodec = requireNonNull(routingTablesV2JsonCodec, \"routing tables v2 json codec is null\");\n         this.timeBoundaryJsonCodec = requireNonNull(timeBoundaryJsonCodec, \"time boundary json codec is null\");\n         this.instanceJsonCodec = requireNonNull(instanceJsonCodec, \"instance json codec is null\");\n-        final long cacheExpiryMs = pinotConfig.getMetadataCacheExpiry().roundTo(TimeUnit.MILLISECONDS);\n-        this.tablesJsonCodec = requireNonNull(tablesJsonCodec, \"json codec is null\");\n \n-        this.pinotConfig = requireNonNull(pinotConfig, \"pinotConfig is null\");\n-        this.pinotMetrics = requireNonNull(pinotMetrics, \"pinotMetrics is null\");\n-        this.httpClient = requireNonNull(httpClient, \"httpClient is null\");\n+        final long cacheExpiryMs = pinotConfig.getMetadataCacheExpiry().roundTo(TimeUnit.MILLISECONDS);\n         this.brokersForTableCache = CacheBuilder.newBuilder()\n                 .expireAfterWrite(cacheExpiryMs, TimeUnit.MILLISECONDS)\n                 .build((CacheLoader.from(this::getAllBrokersForTable)));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc0NjM2Ng==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r515746366", "bodyText": "private\nwe should keep DataType static imported rather than having FieldSpec.DataType here", "author": "highker", "createdAt": "2020-11-02T05:26:58Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotColumnUtils.java", "diffHunk": "@@ -112,7 +111,7 @@ public static Type getPrestoTypeFromPinotType(FieldSpec field, boolean inferDate\n         return new ArrayType(getPrestoTypeFromPinotType(field.getDataType()));\n     }\n \n-    public static Type getPrestoTypeFromPinotType(DataType dataType)\n+    public static Type getPrestoTypeFromPinotType(FieldSpec.DataType dataType)", "originalCommit": "2bff425cf680a314456e8d69c68c2eb69472c3f1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f72c8797b8b84b70fc60f1334f0a376db02c937d", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotColumnUtils.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotColumnUtils.java\nindex cf6cbebba6..b378ed2288 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotColumnUtils.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotColumnUtils.java\n\n@@ -111,7 +112,7 @@ public class PinotColumnUtils\n         return new ArrayType(getPrestoTypeFromPinotType(field.getDataType()));\n     }\n \n-    public static Type getPrestoTypeFromPinotType(FieldSpec.DataType dataType)\n+    private static Type getPrestoTypeFromPinotType(DataType dataType)\n     {\n         switch (dataType) {\n             case BOOLEAN:\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc0Njc0Mg==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r515746742", "bodyText": "_SIZE -> _BYTES\nEither 128 * 1024 * 1024 -> new DataSize(128, MEGABYTE).toBytes() or just make the type to be DataSize. We support DataSize from config", "author": "highker", "createdAt": "2020-11-02T05:28:46Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotConfig.java", "diffHunk": "@@ -38,6 +38,7 @@\n     public static final int DEFAULT_MIN_CONNECTIONS_PER_SERVER = 10;\n     public static final int DEFAULT_THREAD_POOL_SIZE = 30;\n     public static final int DEFAULT_NON_AGGREGATE_LIMIT_FOR_BROKER_QUERIES = 25_000;\n+    public static final int DEFAULT_STREAMING_SERVER_GRPC_MAX_INBOUND_MESSAGE_SIZE = 128 * 1024 * 1024;", "originalCommit": "2bff425cf680a314456e8d69c68c2eb69472c3f1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f72c8797b8b84b70fc60f1334f0a376db02c937d", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotConfig.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotConfig.java\nindex eda3d23172..3ea44ad2b0 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotConfig.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotConfig.java\n\n@@ -38,7 +40,7 @@ public class PinotConfig\n     public static final int DEFAULT_MIN_CONNECTIONS_PER_SERVER = 10;\n     public static final int DEFAULT_THREAD_POOL_SIZE = 30;\n     public static final int DEFAULT_NON_AGGREGATE_LIMIT_FOR_BROKER_QUERIES = 25_000;\n-    public static final int DEFAULT_STREAMING_SERVER_GRPC_MAX_INBOUND_MESSAGE_SIZE = 128 * 1024 * 1024;\n+    public static final int DEFAULT_STREAMING_SERVER_GRPC_MAX_INBOUND_MESSAGE_BYTES = (int) new DataSize(128, MEGABYTE).toBytes();\n \n     // There is a perf penalty of having a large topN since the structures are allocated to this size\n     // So size this judiciously\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc0NzE0Mg==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r515747142", "bodyText": "this seems to be unused", "author": "highker", "createdAt": "2020-11-02T05:30:27Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotErrorCode.java", "diffHunk": "@@ -37,6 +37,9 @@\n     PINOT_INVALID_CONFIGURATION(10, INTERNAL_ERROR),\n     PINOT_DATA_FETCH_EXCEPTION(11, EXTERNAL, true),\n     PINOT_REQUEST_GENERATOR_FAILURE(12, INTERNAL_ERROR),\n+    PINOT_UNABLE_TO_FIND_INSTANCE(13, EXTERNAL),\n+    PINOT_GRPC_EXCEPTION(14, EXTERNAL),", "originalCommit": "2bff425cf680a314456e8d69c68c2eb69472c3f1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f72c8797b8b84b70fc60f1334f0a376db02c937d", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotErrorCode.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotErrorCode.java\nindex c85efafc27..a27902ecdb 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotErrorCode.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotErrorCode.java\n\n@@ -38,8 +38,7 @@ public enum PinotErrorCode\n     PINOT_DATA_FETCH_EXCEPTION(11, EXTERNAL, true),\n     PINOT_REQUEST_GENERATOR_FAILURE(12, INTERNAL_ERROR),\n     PINOT_UNABLE_TO_FIND_INSTANCE(13, EXTERNAL),\n-    PINOT_GRPC_EXCEPTION(14, EXTERNAL),\n-    PINOT_INVALID_SEGMENT_QUERY_GENERATED(15, INTERNAL_ERROR),\n+    PINOT_INVALID_SEGMENT_QUERY_GENERATED(14, INTERNAL_ERROR),\n     PINOT_PUSH_DOWN_QUERY_NOT_PRESENT(20, USER_ERROR),\n     PINOT_UNCLASSIFIED_ERROR(100, EXTERNAL);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc0NzM2MA==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r515747360", "bodyText": "remove else", "author": "highker", "createdAt": "2020-11-02T05:31:26Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPageSourceProvider.java", "diffHunk": "@@ -81,12 +86,23 @@ public ConnectorPageSource createPageSource(\n \n         switch (pinotSplit.getSplitType()) {\n             case SEGMENT:\n-                return new PinotSegmentPageSource(\n+                if (this.pinotConfig.isUseStreamingForSegmentQueries() &&\n+                        pinotSplit.getGrpcPort().orElse(-1) > 0) {\n+                    return new PinotSegmentStreamingPageSource(\n+                        session,\n+                        this.pinotConfig,\n+                        this.pinotStreamingQueryClient,\n+                        pinotSplit,\n+                        handles);\n+                }\n+                else {", "originalCommit": "2bff425cf680a314456e8d69c68c2eb69472c3f1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f72c8797b8b84b70fc60f1334f0a376db02c937d", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPageSourceProvider.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPageSourceProvider.java\nindex 7d6457a251..bea903cfe5 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPageSourceProvider.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPageSourceProvider.java\n\n@@ -86,28 +86,25 @@ public class PinotPageSourceProvider\n \n         switch (pinotSplit.getSplitType()) {\n             case SEGMENT:\n-                if (this.pinotConfig.isUseStreamingForSegmentQueries() &&\n-                        pinotSplit.getGrpcPort().orElse(-1) > 0) {\n+                if (pinotConfig.isUseStreamingForSegmentQueries() && pinotSplit.getGrpcPort().orElse(-1) > 0) {\n                     return new PinotSegmentStreamingPageSource(\n                         session,\n-                        this.pinotConfig,\n-                        this.pinotStreamingQueryClient,\n-                        pinotSplit,\n-                        handles);\n-                }\n-                else {\n-                    return new PinotSegmentPageSource(\n-                        session,\n-                        this.pinotConfig,\n-                        this.pinotQueryClient,\n+                        pinotConfig,\n+                        pinotStreamingQueryClient,\n                         pinotSplit,\n                         handles);\n                 }\n+                return new PinotSegmentPageSource(\n+                    session,\n+                    pinotConfig,\n+                    pinotQueryClient,\n+                    pinotSplit,\n+                    handles);\n             case BROKER:\n                 switch (pinotSplit.getBrokerPinotQuery().get().getFormat()) {\n                     case SQL:\n                         return new PinotBrokerPageSourceSql(\n-                            this.pinotConfig,\n+                            pinotConfig,\n                             session,\n                             pinotSplit.getBrokerPinotQuery().get(),\n                             handles,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc0NzQ2MQ==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r515747461", "bodyText": "remove this\nput these two conditions into one line", "author": "highker", "createdAt": "2020-11-02T05:31:49Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPageSourceProvider.java", "diffHunk": "@@ -81,12 +86,23 @@ public ConnectorPageSource createPageSource(\n \n         switch (pinotSplit.getSplitType()) {\n             case SEGMENT:\n-                return new PinotSegmentPageSource(\n+                if (this.pinotConfig.isUseStreamingForSegmentQueries() &&\n+                        pinotSplit.getGrpcPort().orElse(-1) > 0) {", "originalCommit": "2bff425cf680a314456e8d69c68c2eb69472c3f1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f72c8797b8b84b70fc60f1334f0a376db02c937d", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPageSourceProvider.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPageSourceProvider.java\nindex 7d6457a251..bea903cfe5 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPageSourceProvider.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPageSourceProvider.java\n\n@@ -86,28 +86,25 @@ public class PinotPageSourceProvider\n \n         switch (pinotSplit.getSplitType()) {\n             case SEGMENT:\n-                if (this.pinotConfig.isUseStreamingForSegmentQueries() &&\n-                        pinotSplit.getGrpcPort().orElse(-1) > 0) {\n+                if (pinotConfig.isUseStreamingForSegmentQueries() && pinotSplit.getGrpcPort().orElse(-1) > 0) {\n                     return new PinotSegmentStreamingPageSource(\n                         session,\n-                        this.pinotConfig,\n-                        this.pinotStreamingQueryClient,\n-                        pinotSplit,\n-                        handles);\n-                }\n-                else {\n-                    return new PinotSegmentPageSource(\n-                        session,\n-                        this.pinotConfig,\n-                        this.pinotQueryClient,\n+                        pinotConfig,\n+                        pinotStreamingQueryClient,\n                         pinotSplit,\n                         handles);\n                 }\n+                return new PinotSegmentPageSource(\n+                    session,\n+                    pinotConfig,\n+                    pinotQueryClient,\n+                    pinotSplit,\n+                    handles);\n             case BROKER:\n                 switch (pinotSplit.getBrokerPinotQuery().get().getFormat()) {\n                     case SQL:\n                         return new PinotBrokerPageSourceSql(\n-                            this.pinotConfig,\n+                            pinotConfig,\n                             session,\n                             pinotSplit.getBrokerPinotQuery().get(),\n                             handles,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc0NzU5NQ==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r515747595", "bodyText": "make this final", "author": "highker", "createdAt": "2020-11-02T05:32:23Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSource.java", "diffHunk": "@@ -64,20 +62,20 @@\n             ErrorCode.PINOT_INSUFFICIENT_SERVER_RESPONSE, PINOT_INSUFFICIENT_SERVER_RESPONSE,\n             ErrorCode.PINOT_INVALID_PQL_GENERATED, PINOT_INVALID_PQL_GENERATED);\n \n-    private final List<PinotColumnHandle> columnHandles;\n-    private final List<Type> columnTypes;\n-    private final PinotConfig pinotConfig;\n-    private final PinotSplit split;\n+    protected final List<PinotColumnHandle> columnHandles;\n+    protected final List<Type> columnTypes;\n+    protected final PinotConfig pinotConfig;\n+    protected final PinotSplit split;\n     private final PinotScatterGatherQueryClient pinotQueryClient;\n-    private final ConnectorSession session;\n+    protected final ConnectorSession session;\n \n     // dataTableList stores the dataTable returned from each server. Each dataTable is constructed to a Page, and then destroyed to save memory.\n     private LinkedList<PinotDataTableWithSize> dataTableList = new LinkedList<>();", "originalCommit": "2bff425cf680a314456e8d69c68c2eb69472c3f1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f72c8797b8b84b70fc60f1334f0a376db02c937d", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSource.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSource.java\nindex ecb1871190..8aea5bdb85 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSource.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSource.java\n\n@@ -70,7 +70,7 @@ public class PinotSegmentPageSource\n     protected final ConnectorSession session;\n \n     // dataTableList stores the dataTable returned from each server. Each dataTable is constructed to a Page, and then destroyed to save memory.\n-    private LinkedList<PinotDataTableWithSize> dataTableList = new LinkedList<>();\n+    private final LinkedList<PinotDataTableWithSize> dataTableList = new LinkedList<>();\n     protected long completedBytes;\n     protected long readTimeNanos;\n     protected long estimatedMemoryUsageInBytes;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc0ODExNA==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r515748114", "bodyText": "break a line after this", "author": "highker", "createdAt": "2020-11-02T05:34:42Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponse;\n+import com.facebook.presto.spi.ConnectorSession;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_DATA_FETCH_EXCEPTION;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_INVALID_SEGMENT_QUERY_GENERATED;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_UNEXPECTED_RESPONSE;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n+ */\n+public class PinotSegmentStreamingPageSource\n+        extends PinotSegmentPageSource\n+{\n+    private final PinotStreamingQueryClient pinotStreamingQueryClient;\n+    private Iterator<ServerResponse> serverResponseIterator;\n+    private long completedPositions;\n+\n+    public PinotSegmentStreamingPageSource(\n+            ConnectorSession session,\n+            PinotConfig pinotConfig,\n+            PinotStreamingQueryClient pinotStreamingQueryClient,\n+            PinotSplit split,\n+            List<PinotColumnHandle> columnHandles)\n+    {\n+        super(session, pinotConfig, null, split, columnHandles);\n+        this.pinotStreamingQueryClient = requireNonNull(pinotStreamingQueryClient, \"pinotStreamingQueryClient is null\");\n+    }\n+\n+    @Override\n+    public boolean isFinished()\n+    {\n+        return closed;\n+    }\n+\n+    /**\n+     * @return constructed page for pinot data.\n+     */\n+    @Override\n+    public Page getNextPage()\n+    {\n+        if (closed) {\n+            return null;\n+        }", "originalCommit": "2bff425cf680a314456e8d69c68c2eb69472c3f1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f72c8797b8b84b70fc60f1334f0a376db02c937d", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\nindex f8a9365a38..37058793f0 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\n\n@@ -68,6 +68,7 @@ public class PinotSegmentStreamingPageSource\n         if (closed) {\n             return null;\n         }\n+\n         if (serverResponseIterator == null) {\n             serverResponseIterator = queryPinot(split);\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc0ODI1MQ==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r515748251", "bodyText": "one param per line", "author": "highker", "createdAt": "2020-11-02T05:35:11Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponse;\n+import com.facebook.presto.spi.ConnectorSession;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_DATA_FETCH_EXCEPTION;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_INVALID_SEGMENT_QUERY_GENERATED;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_UNEXPECTED_RESPONSE;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n+ */\n+public class PinotSegmentStreamingPageSource\n+        extends PinotSegmentPageSource\n+{\n+    private final PinotStreamingQueryClient pinotStreamingQueryClient;\n+    private Iterator<ServerResponse> serverResponseIterator;\n+    private long completedPositions;\n+\n+    public PinotSegmentStreamingPageSource(\n+            ConnectorSession session,\n+            PinotConfig pinotConfig,\n+            PinotStreamingQueryClient pinotStreamingQueryClient,\n+            PinotSplit split,\n+            List<PinotColumnHandle> columnHandles)\n+    {\n+        super(session, pinotConfig, null, split, columnHandles);\n+        this.pinotStreamingQueryClient = requireNonNull(pinotStreamingQueryClient, \"pinotStreamingQueryClient is null\");\n+    }\n+\n+    @Override\n+    public boolean isFinished()\n+    {\n+        return closed;\n+    }\n+\n+    /**\n+     * @return constructed page for pinot data.\n+     */\n+    @Override\n+    public Page getNextPage()\n+    {\n+        if (closed) {\n+            return null;\n+        }\n+        if (serverResponseIterator == null) {\n+            serverResponseIterator = queryPinot(split);\n+        }\n+        ByteBuffer byteBuffer = null;\n+        try {\n+            // Pinot gRPC server response iterator returns:\n+            //   - n data blocks based on inbound message size;\n+            //   - 1 metadata of the query results.\n+            // So we need to check ResponseType of each ServerResponse.\n+            if (serverResponseIterator.hasNext()) {\n+                long startTimeNanos = System.nanoTime();\n+                ServerResponse serverResponse = serverResponseIterator.next();\n+                readTimeNanos += System.nanoTime() - startTimeNanos;\n+                switch (serverResponse.getResponseType()) {\n+                    case Constants.Response.ResponseType.DATA:\n+                        estimatedMemoryUsageInBytes = serverResponse.getSerializedSize();\n+                        // Store each dataTable which will later be constructed into Pages.\n+                        try {\n+                            byteBuffer = serverResponse.getPayloadReadOnlyByteBuffer();\n+                            DataTable dataTable = serverResponse.getDataTable(byteBuffer);\n+                            checkExceptions(dataTable, split, PinotSessionProperties.isMarkDataFetchExceptionsAsRetriable(session));\n+                            currentDataTable = new PinotSegmentPageSource.PinotDataTableWithSize(dataTable,\n+                                serverResponse.getSerializedSize());", "originalCommit": "2bff425cf680a314456e8d69c68c2eb69472c3f1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f72c8797b8b84b70fc60f1334f0a376db02c937d", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\nindex f8a9365a38..37058793f0 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\n\n@@ -68,6 +68,7 @@ public class PinotSegmentStreamingPageSource\n         if (closed) {\n             return null;\n         }\n+\n         if (serverResponseIterator == null) {\n             serverResponseIterator = queryPinot(split);\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc0ODMwMg==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r515748302", "bodyText": "one param per line", "author": "highker", "createdAt": "2020-11-02T05:35:25Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponse;\n+import com.facebook.presto.spi.ConnectorSession;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_DATA_FETCH_EXCEPTION;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_INVALID_SEGMENT_QUERY_GENERATED;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_UNEXPECTED_RESPONSE;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n+ */\n+public class PinotSegmentStreamingPageSource\n+        extends PinotSegmentPageSource\n+{\n+    private final PinotStreamingQueryClient pinotStreamingQueryClient;\n+    private Iterator<ServerResponse> serverResponseIterator;\n+    private long completedPositions;\n+\n+    public PinotSegmentStreamingPageSource(\n+            ConnectorSession session,\n+            PinotConfig pinotConfig,\n+            PinotStreamingQueryClient pinotStreamingQueryClient,\n+            PinotSplit split,\n+            List<PinotColumnHandle> columnHandles)\n+    {\n+        super(session, pinotConfig, null, split, columnHandles);\n+        this.pinotStreamingQueryClient = requireNonNull(pinotStreamingQueryClient, \"pinotStreamingQueryClient is null\");\n+    }\n+\n+    @Override\n+    public boolean isFinished()\n+    {\n+        return closed;\n+    }\n+\n+    /**\n+     * @return constructed page for pinot data.\n+     */\n+    @Override\n+    public Page getNextPage()\n+    {\n+        if (closed) {\n+            return null;\n+        }\n+        if (serverResponseIterator == null) {\n+            serverResponseIterator = queryPinot(split);\n+        }\n+        ByteBuffer byteBuffer = null;\n+        try {\n+            // Pinot gRPC server response iterator returns:\n+            //   - n data blocks based on inbound message size;\n+            //   - 1 metadata of the query results.\n+            // So we need to check ResponseType of each ServerResponse.\n+            if (serverResponseIterator.hasNext()) {\n+                long startTimeNanos = System.nanoTime();\n+                ServerResponse serverResponse = serverResponseIterator.next();\n+                readTimeNanos += System.nanoTime() - startTimeNanos;\n+                switch (serverResponse.getResponseType()) {\n+                    case Constants.Response.ResponseType.DATA:\n+                        estimatedMemoryUsageInBytes = serverResponse.getSerializedSize();\n+                        // Store each dataTable which will later be constructed into Pages.\n+                        try {\n+                            byteBuffer = serverResponse.getPayloadReadOnlyByteBuffer();\n+                            DataTable dataTable = serverResponse.getDataTable(byteBuffer);\n+                            checkExceptions(dataTable, split, PinotSessionProperties.isMarkDataFetchExceptionsAsRetriable(session));\n+                            currentDataTable = new PinotSegmentPageSource.PinotDataTableWithSize(dataTable,\n+                                serverResponse.getSerializedSize());\n+                        }\n+                        catch (IOException e) {\n+                            throw new PinotException(PINOT_DATA_FETCH_EXCEPTION, split.getSegmentPinotQuery(), String.format(\"Encountered Pinot exceptions when fetching data table from Split: < %s >\",\n+                                split), e);", "originalCommit": "2bff425cf680a314456e8d69c68c2eb69472c3f1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f72c8797b8b84b70fc60f1334f0a376db02c937d", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\nindex f8a9365a38..37058793f0 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\n\n@@ -68,6 +68,7 @@ public class PinotSegmentStreamingPageSource\n         if (closed) {\n             return null;\n         }\n+\n         if (serverResponseIterator == null) {\n             serverResponseIterator = queryPinot(split);\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc0ODQxNw==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r515748417", "bodyText": "one param per line", "author": "highker", "createdAt": "2020-11-02T05:36:00Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponse;\n+import com.facebook.presto.spi.ConnectorSession;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_DATA_FETCH_EXCEPTION;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_INVALID_SEGMENT_QUERY_GENERATED;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_UNEXPECTED_RESPONSE;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n+ */\n+public class PinotSegmentStreamingPageSource\n+        extends PinotSegmentPageSource\n+{\n+    private final PinotStreamingQueryClient pinotStreamingQueryClient;\n+    private Iterator<ServerResponse> serverResponseIterator;\n+    private long completedPositions;\n+\n+    public PinotSegmentStreamingPageSource(\n+            ConnectorSession session,\n+            PinotConfig pinotConfig,\n+            PinotStreamingQueryClient pinotStreamingQueryClient,\n+            PinotSplit split,\n+            List<PinotColumnHandle> columnHandles)\n+    {\n+        super(session, pinotConfig, null, split, columnHandles);\n+        this.pinotStreamingQueryClient = requireNonNull(pinotStreamingQueryClient, \"pinotStreamingQueryClient is null\");\n+    }\n+\n+    @Override\n+    public boolean isFinished()\n+    {\n+        return closed;\n+    }\n+\n+    /**\n+     * @return constructed page for pinot data.\n+     */\n+    @Override\n+    public Page getNextPage()\n+    {\n+        if (closed) {\n+            return null;\n+        }\n+        if (serverResponseIterator == null) {\n+            serverResponseIterator = queryPinot(split);\n+        }\n+        ByteBuffer byteBuffer = null;\n+        try {\n+            // Pinot gRPC server response iterator returns:\n+            //   - n data blocks based on inbound message size;\n+            //   - 1 metadata of the query results.\n+            // So we need to check ResponseType of each ServerResponse.\n+            if (serverResponseIterator.hasNext()) {\n+                long startTimeNanos = System.nanoTime();\n+                ServerResponse serverResponse = serverResponseIterator.next();\n+                readTimeNanos += System.nanoTime() - startTimeNanos;\n+                switch (serverResponse.getResponseType()) {\n+                    case Constants.Response.ResponseType.DATA:\n+                        estimatedMemoryUsageInBytes = serverResponse.getSerializedSize();\n+                        // Store each dataTable which will later be constructed into Pages.\n+                        try {\n+                            byteBuffer = serverResponse.getPayloadReadOnlyByteBuffer();\n+                            DataTable dataTable = serverResponse.getDataTable(byteBuffer);\n+                            checkExceptions(dataTable, split, PinotSessionProperties.isMarkDataFetchExceptionsAsRetriable(session));\n+                            currentDataTable = new PinotSegmentPageSource.PinotDataTableWithSize(dataTable,\n+                                serverResponse.getSerializedSize());\n+                        }\n+                        catch (IOException e) {\n+                            throw new PinotException(PINOT_DATA_FETCH_EXCEPTION, split.getSegmentPinotQuery(), String.format(\"Encountered Pinot exceptions when fetching data table from Split: < %s >\",\n+                                split), e);\n+                        }\n+                        break;\n+                    case Constants.Response.ResponseType.METADATA:\n+                        // The last part of the response is Metadata\n+                        currentDataTable = null;\n+                        serverResponseIterator = null;\n+                        close();\n+                        return null;\n+                    default:\n+                        throw new PinotException(PINOT_UNEXPECTED_RESPONSE, split.getSegmentPinotQuery(),\n+                            String.format(\"Encountered Pinot exceptions, unknown response type - %s\", serverResponse.getResponseType()));", "originalCommit": "2bff425cf680a314456e8d69c68c2eb69472c3f1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f72c8797b8b84b70fc60f1334f0a376db02c937d", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\nindex f8a9365a38..37058793f0 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\n\n@@ -68,6 +68,7 @@ public class PinotSegmentStreamingPageSource\n         if (closed) {\n             return null;\n         }\n+\n         if (serverResponseIterator == null) {\n             serverResponseIterator = queryPinot(split);\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc0ODk2Mg==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r515748962", "bodyText": "miss a throw", "author": "highker", "createdAt": "2020-11-02T05:38:28Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponse;\n+import com.facebook.presto.spi.ConnectorSession;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_DATA_FETCH_EXCEPTION;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_INVALID_SEGMENT_QUERY_GENERATED;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_UNEXPECTED_RESPONSE;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n+ */\n+public class PinotSegmentStreamingPageSource\n+        extends PinotSegmentPageSource\n+{\n+    private final PinotStreamingQueryClient pinotStreamingQueryClient;\n+    private Iterator<ServerResponse> serverResponseIterator;\n+    private long completedPositions;\n+\n+    public PinotSegmentStreamingPageSource(\n+            ConnectorSession session,\n+            PinotConfig pinotConfig,\n+            PinotStreamingQueryClient pinotStreamingQueryClient,\n+            PinotSplit split,\n+            List<PinotColumnHandle> columnHandles)\n+    {\n+        super(session, pinotConfig, null, split, columnHandles);\n+        this.pinotStreamingQueryClient = requireNonNull(pinotStreamingQueryClient, \"pinotStreamingQueryClient is null\");\n+    }\n+\n+    @Override\n+    public boolean isFinished()\n+    {\n+        return closed;\n+    }\n+\n+    /**\n+     * @return constructed page for pinot data.\n+     */\n+    @Override\n+    public Page getNextPage()\n+    {\n+        if (closed) {\n+            return null;\n+        }\n+        if (serverResponseIterator == null) {\n+            serverResponseIterator = queryPinot(split);\n+        }\n+        ByteBuffer byteBuffer = null;\n+        try {\n+            // Pinot gRPC server response iterator returns:\n+            //   - n data blocks based on inbound message size;\n+            //   - 1 metadata of the query results.\n+            // So we need to check ResponseType of each ServerResponse.\n+            if (serverResponseIterator.hasNext()) {\n+                long startTimeNanos = System.nanoTime();\n+                ServerResponse serverResponse = serverResponseIterator.next();\n+                readTimeNanos += System.nanoTime() - startTimeNanos;\n+                switch (serverResponse.getResponseType()) {\n+                    case Constants.Response.ResponseType.DATA:\n+                        estimatedMemoryUsageInBytes = serverResponse.getSerializedSize();\n+                        // Store each dataTable which will later be constructed into Pages.\n+                        try {\n+                            byteBuffer = serverResponse.getPayloadReadOnlyByteBuffer();\n+                            DataTable dataTable = serverResponse.getDataTable(byteBuffer);\n+                            checkExceptions(dataTable, split, PinotSessionProperties.isMarkDataFetchExceptionsAsRetriable(session));\n+                            currentDataTable = new PinotSegmentPageSource.PinotDataTableWithSize(dataTable,\n+                                serverResponse.getSerializedSize());\n+                        }\n+                        catch (IOException e) {\n+                            throw new PinotException(PINOT_DATA_FETCH_EXCEPTION, split.getSegmentPinotQuery(), String.format(\"Encountered Pinot exceptions when fetching data table from Split: < %s >\",\n+                                split), e);\n+                        }\n+                        break;\n+                    case Constants.Response.ResponseType.METADATA:\n+                        // The last part of the response is Metadata\n+                        currentDataTable = null;\n+                        serverResponseIterator = null;\n+                        close();\n+                        return null;\n+                    default:\n+                        throw new PinotException(PINOT_UNEXPECTED_RESPONSE, split.getSegmentPinotQuery(),\n+                            String.format(\"Encountered Pinot exceptions, unknown response type - %s\", serverResponse.getResponseType()));\n+                }\n+            }\n+            Page page = fillNextPage();\n+            completedPositions += currentDataTable.getDataTable().getNumberOfRows();\n+            return page;\n+        }\n+        finally {\n+            if (byteBuffer != null) {\n+                byteBuffer.clear();\n+            }\n+        }\n+    }\n+\n+    private Iterator<ServerResponse> queryPinot(PinotSplit split)\n+    {\n+        String sql = split.getSegmentPinotQuery().orElseThrow(() -> new PinotException(PINOT_INVALID_SEGMENT_QUERY_GENERATED, Optional.empty(), \"Expected the segment split to contain the pinot query\"));\n+        String grpcHost = split.getGrpcHost().orElseThrow(() -> new PinotException(PINOT_INVALID_SEGMENT_QUERY_GENERATED, Optional.empty(), \"Expected the segment split to contain the grpc host\"));\n+        int grpcPort = split.getGrpcPort().orElseThrow(() -> new PinotException(PINOT_INVALID_SEGMENT_QUERY_GENERATED, Optional.empty(), \"Expected the segment split to contain the grpc port\"));\n+        if (grpcPort <= 0) {\n+            new PinotException(PINOT_INVALID_SEGMENT_QUERY_GENERATED, Optional.empty(), \"Expected the grpc port > 0 always\");", "originalCommit": "2bff425cf680a314456e8d69c68c2eb69472c3f1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f72c8797b8b84b70fc60f1334f0a376db02c937d", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\nindex f8a9365a38..37058793f0 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java\n\n@@ -68,6 +68,7 @@ public class PinotSegmentStreamingPageSource\n         if (closed) {\n             return null;\n         }\n+\n         if (serverResponseIterator == null) {\n             serverResponseIterator = queryPinot(split);\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc0OTQ4NA==", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r515749484", "bodyText": "directly return new Pinot...", "author": "highker", "createdAt": "2020-11-02T05:40:26Z", "path": "presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/TestPinotSegmentStreamingPageSource.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponse;\n+import com.facebook.presto.spi.ConnectorSession;\n+import com.google.common.collect.ImmutableList;\n+import org.apache.pinot.common.proto.Server;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.MockPinotClusterInfoFetcher.DEFAULT_GRPC_PORT;\n+\n+public class TestPinotSegmentStreamingPageSource\n+        extends TestPinotSegmentPageSource\n+{\n+    private static final class MockServerResponse\n+            extends ServerResponse\n+    {\n+        private DataTable dataTable;\n+\n+        public MockServerResponse(Server.ServerResponse serverResponse)\n+        {\n+            super(serverResponse);\n+        }\n+\n+        public MockServerResponse(DataTable dataTable)\n+        {\n+            super(null);\n+            this.dataTable = dataTable;\n+        }\n+\n+        public String getResponseType()\n+        {\n+            return Constants.Response.ResponseType.DATA;\n+        }\n+\n+        public int getSerializedSize()\n+        {\n+            return 0;\n+        }\n+\n+        public ByteBuffer getPayloadReadOnlyByteBuffer()\n+        {\n+            try {\n+                return ByteBuffer.wrap(dataTable.toBytes());\n+            }\n+            catch (IOException e) {\n+                throw new RuntimeException(e);\n+            }\n+        }\n+\n+        public DataTable getDataTable(ByteBuffer byteBuffer) throws IOException\n+        {\n+            return SimpleDataTable.fromBytes(byteBuffer);\n+        }\n+    }\n+\n+    private static final class MockPinotStreamingQueryClient\n+            extends PinotStreamingQueryClient\n+    {\n+        private final ImmutableList<DataTable> dataTables;\n+\n+        MockPinotStreamingQueryClient(PinotStreamingQueryClient.Config pinotConfig, List<DataTable> dataTables)\n+        {\n+            super(pinotConfig);\n+            this.dataTables = ImmutableList.copyOf(dataTables);\n+        }\n+\n+        @Override\n+        public Iterator<ServerResponse> submit(String host, int port, GrpcRequestBuilder requestBuilder)\n+        {\n+            return new Iterator<ServerResponse>()\n+            {\n+                int index;\n+\n+                @Override\n+                public boolean hasNext()\n+                {\n+                    return index < dataTables.size();\n+                }\n+\n+                @Override\n+                public ServerResponse next()\n+                {\n+                    return new MockServerResponse(dataTables.get(index++));\n+                }\n+            };\n+        }\n+    }\n+\n+    @Override\n+    PinotSegmentPageSource getPinotSegmentPageSource(\n+            ConnectorSession session,\n+            List<DataTable> dataTables,\n+            PinotSplit mockPinotSplit,\n+            List<PinotColumnHandle> handlesSurviving)\n+    {\n+        MockPinotStreamingQueryClient mockPinotQueryClient = new MockPinotStreamingQueryClient(new PinotStreamingQueryClient.Config(pinotConfig.getStreamingServerGrpcMaxInboundMessageSize(), true), dataTables);\n+        PinotSegmentPageSource pinotSegmentPageSource = new PinotSegmentStreamingPageSource(session, pinotConfig, mockPinotQueryClient, mockPinotSplit, handlesSurviving);\n+        return pinotSegmentPageSource;", "originalCommit": "2bff425cf680a314456e8d69c68c2eb69472c3f1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f72c8797b8b84b70fc60f1334f0a376db02c937d", "chunk": "diff --git a/presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/TestPinotSegmentStreamingPageSource.java b/presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/TestPinotSegmentStreamingPageSource.java\nindex b854b74cea..f51f011b48 100644\n--- a/presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/TestPinotSegmentStreamingPageSource.java\n+++ b/presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/TestPinotSegmentStreamingPageSource.java\n\n@@ -115,9 +115,8 @@ public class TestPinotSegmentStreamingPageSource\n             PinotSplit mockPinotSplit,\n             List<PinotColumnHandle> handlesSurviving)\n     {\n-        MockPinotStreamingQueryClient mockPinotQueryClient = new MockPinotStreamingQueryClient(new PinotStreamingQueryClient.Config(pinotConfig.getStreamingServerGrpcMaxInboundMessageSize(), true), dataTables);\n-        PinotSegmentPageSource pinotSegmentPageSource = new PinotSegmentStreamingPageSource(session, pinotConfig, mockPinotQueryClient, mockPinotSplit, handlesSurviving);\n-        return pinotSegmentPageSource;\n+        MockPinotStreamingQueryClient mockPinotQueryClient = new MockPinotStreamingQueryClient(new PinotStreamingQueryClient.Config(pinotConfig.getStreamingServerGrpcMaxInboundMessageBytes(), true), dataTables);\n+        return new PinotSegmentStreamingPageSource(session, pinotConfig, mockPinotQueryClient, mockPinotSplit, handlesSurviving);\n     }\n \n     @Override\n"}}, {"oid": "f72c8797b8b84b70fc60f1334f0a376db02c937d", "url": "https://github.com/prestodb/presto/commit/f72c8797b8b84b70fc60f1334f0a376db02c937d", "message": "Support Pinot Streaming connector for Segment query\n\nPinot recently added support of gRpc based streaming query endpoint at Pinot server level, which allows user to pull data in a streaming fashion. (apache/incubator-pinot#5599, apache/incubator-pinot#6027 )\n\nThis is extremely good for the use cases which requires large data scan and try to retrieve a lot of data from Pinot.\n\nComparing to the non-streaming way, Presto segment level query requires pinot server to process the query on the entire data segment and all the results have to be in memory and serialized then send back to client. In the streaming fashion, client side can specify a block size and only call next to fetch the given size of results to process then call next to fetch the next block. Pinot server side only advance and process the data processing when client calls next. In this way, Pinot server side cpu and memory pressure is much less.", "committedDate": "2020-11-02T20:27:47Z", "type": "forcePushed"}, {"oid": "6e0c1e081863bb06937a9c712793bae7dbd6cce4", "url": "https://github.com/prestodb/presto/commit/6e0c1e081863bb06937a9c712793bae7dbd6cce4", "message": "Support Pinot Streaming connector for Segment query\n\nPinot recently added support of gRpc based streaming query endpoint at Pinot server level, which allows user to pull data in a streaming fashion. (apache/incubator-pinot#5599, apache/incubator-pinot#6027 )\n\nThis is extremely good for the use cases which requires large data scan and try to retrieve a lot of data from Pinot.\n\nComparing to the non-streaming way, Presto segment level query requires pinot server to process the query on the entire data segment and all the results have to be in memory and serialized then send back to client. In the streaming fashion, client side can specify a block size and only call next to fetch the given size of results to process then call next to fetch the next block. Pinot server side only advance and process the data processing when client calls next. In this way, Pinot server side cpu and memory pressure is much less.", "committedDate": "2020-11-02T22:02:03Z", "type": "commit"}, {"oid": "6e0c1e081863bb06937a9c712793bae7dbd6cce4", "url": "https://github.com/prestodb/presto/commit/6e0c1e081863bb06937a9c712793bae7dbd6cce4", "message": "Support Pinot Streaming connector for Segment query\n\nPinot recently added support of gRpc based streaming query endpoint at Pinot server level, which allows user to pull data in a streaming fashion. (apache/incubator-pinot#5599, apache/incubator-pinot#6027 )\n\nThis is extremely good for the use cases which requires large data scan and try to retrieve a lot of data from Pinot.\n\nComparing to the non-streaming way, Presto segment level query requires pinot server to process the query on the entire data segment and all the results have to be in memory and serialized then send back to client. In the streaming fashion, client side can specify a block size and only call next to fetch the given size of results to process then call next to fetch the next block. Pinot server side only advance and process the data processing when client calls next. In this way, Pinot server side cpu and memory pressure is much less.", "committedDate": "2020-11-02T22:02:03Z", "type": "forcePushed"}]}