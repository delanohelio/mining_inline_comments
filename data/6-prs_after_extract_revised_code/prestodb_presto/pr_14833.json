{"pr_number": 14833, "pr_title": "Fetch results eagerly from coordinator", "pr_createdAt": "2020-07-13T05:30:07Z", "pr_url": "https://github.com/prestodb/presto/pull/14833", "timeline": [{"oid": "cbbf7038320405af3259974445de69e54c06db73", "url": "https://github.com/prestodb/presto/commit/cbbf7038320405af3259974445de69e54c06db73", "message": "Updates", "committedDate": "2020-07-15T23:28:23Z", "type": "forcePushed"}, {"oid": "2a65cde31bde4248f99658bb5b2fced626f473c0", "url": "https://github.com/prestodb/presto/commit/2a65cde31bde4248f99658bb5b2fced626f473c0", "message": "Do not verify that a coordinator is chosen", "committedDate": "2020-07-22T21:51:58Z", "type": "forcePushed"}, {"oid": "61ad2c49d6cc7f086de99a13829d5b775e534417", "url": "https://github.com/prestodb/presto/commit/61ad2c49d6cc7f086de99a13829d5b775e534417", "message": "Add ability to begin fetching results eaerly from coordinator\n\nBefore, the query results would only begin to be fetched once the client was\nredirected to the executing query endpoint.  This introduces latency and may\nnot be acceptable for very low latency use cases.", "committedDate": "2020-07-23T05:23:02Z", "type": "forcePushed"}, {"oid": "741b1b8411fb4a7b83b741244e670a6ca2ee3c25", "url": "https://github.com/prestodb/presto/commit/741b1b8411fb4a7b83b741244e670a6ca2ee3c25", "message": "Add ability to begin fetching results eaerly from coordinator\n\nBefore, the query results would only begin to be fetched once the client was\nredirected to the executing query endpoint.  This introduces latency and may\nnot be acceptable for very low latency use cases.", "committedDate": "2020-07-23T17:29:36Z", "type": "forcePushed"}, {"oid": "1d839e8b99e5674a6018ae6b4635abc37eb22ba3", "url": "https://github.com/prestodb/presto/commit/1d839e8b99e5674a6018ae6b4635abc37eb22ba3", "message": "Add ability to begin fetching results eaerly from coordinator\n\nBefore, the query results would only begin to be fetched once the client was\nredirected to the executing query endpoint.  This introduces latency and may\nnot be acceptable for very low latency use cases.", "committedDate": "2020-07-23T17:31:44Z", "type": "forcePushed"}, {"oid": "3ff1bc9feb28dc0dc0e1a24c1e48bf88095dbca5", "url": "https://github.com/prestodb/presto/commit/3ff1bc9feb28dc0dc0e1a24c1e48bf88095dbca5", "message": "Add ability to begin fetching results eaerly from coordinator\n\nBefore, the query results would only begin to be fetched once the client was\nredirected to the executing query endpoint.  This introduces latency and may\nnot be acceptable for very low latency use cases.", "committedDate": "2020-07-23T17:37:59Z", "type": "forcePushed"}, {"oid": "4a63333008eca530528db293fe0a7af1d170ab6e", "url": "https://github.com/prestodb/presto/commit/4a63333008eca530528db293fe0a7af1d170ab6e", "message": "Begin fetching results eaerly from coordinator\n\nBefore, the query results would only begin to be fetched once the client was\nredirected to the executing query endpoint.  This introduces latency and may\nnot be acceptable for very low latency use cases.", "committedDate": "2020-07-23T17:39:39Z", "type": "forcePushed"}, {"oid": "cc23bd2e44d5776e4e505d38a2fff7f21f4abf43", "url": "https://github.com/prestodb/presto/commit/cc23bd2e44d5776e4e505d38a2fff7f21f4abf43", "message": "Fetch results eaerly from coordinator\n\nBefore, the query results would only begin to be fetched once the client was\nredirected to the executing query endpoint.  This introduces latency and may\nnot be acceptable for very low latency use cases.", "committedDate": "2020-07-23T17:40:14Z", "type": "forcePushed"}, {"oid": "9c781ab6361b91f88093e114e8b97f13b4e6a930", "url": "https://github.com/prestodb/presto/commit/9c781ab6361b91f88093e114e8b97f13b4e6a930", "message": "Fetch results eagerly from coordinator\n\nBefore, the query results would only begin to be fetched once the client was\nredirected to the executing query endpoint.  This introduces latency and may\nnot be acceptable for very low latency use cases.", "committedDate": "2020-07-23T17:41:27Z", "type": "forcePushed"}, {"oid": "581ff863cc2af0a2156ad4aa8be0bbc84d36ad40", "url": "https://github.com/prestodb/presto/commit/581ff863cc2af0a2156ad4aa8be0bbc84d36ad40", "message": "Fetch results eagerly from coordinator\n\nBefore, the query results would only begin to be fetched once the client was\nredirected to the executing query endpoint.  This introduces latency and may\nnot be acceptable for very low latency use cases.", "committedDate": "2020-07-23T17:44:14Z", "type": "forcePushed"}, {"oid": "6633980955893f6108eab6b98cf2f1e821edf215", "url": "https://github.com/prestodb/presto/commit/6633980955893f6108eab6b98cf2f1e821edf215", "message": "Fetch results eagerly from coordinator\n\nBefore, the query results would only begin to be fetched once the client was\nredirected to the executing query endpoint.  This introduces latency and may\nnot be acceptable for very low latency use cases.", "committedDate": "2020-07-23T17:46:53Z", "type": "forcePushed"}, {"oid": "47a34d776355161adbb36aed04bfacf237e15a0e", "url": "https://github.com/prestodb/presto/commit/47a34d776355161adbb36aed04bfacf237e15a0e", "message": "Fetch results eagerly from coordinator\n\nBefore, the query results would only begin to be fetched once the client was\nredirected to the executing query endpoint.  This introduces latency and may\nnot be acceptable for very low latency use cases.", "committedDate": "2020-07-23T19:14:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgwODY0Mw==", "url": "https://github.com/prestodb/presto/pull/14833#discussion_r459808643", "bodyText": "Do we need abstraction if there is only one implementation?", "author": "highker", "createdAt": "2020-07-24T01:10:47Z", "path": "presto-main/src/main/java/com/facebook/presto/server/protocol/QueryProvider.java", "diffHunk": "@@ -0,0 +1,23 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.server.protocol;\n+\n+import com.facebook.presto.spi.QueryId;\n+\n+public interface QueryProvider", "originalCommit": "47a34d776355161adbb36aed04bfacf237e15a0e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg1MTAyNg==", "url": "https://github.com/prestodb/presto/pull/14833#discussion_r459851026", "bodyText": "It will be used later, but I'll remove it since there's no immediate need for it now.", "author": "tdcmeehan", "createdAt": "2020-07-24T04:52:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgwODY0Mw=="}], "type": "inlineReview", "revised_code": {"commit": "e4993d25d14cd92e5548b6100ce9e1847d97f42c", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/server/protocol/QueryProvider.java b/presto-main/src/main/java/com/facebook/presto/server/protocol/QueryProvider.java\ndeleted file mode 100644\nindex ea2279411f..0000000000\n--- a/presto-main/src/main/java/com/facebook/presto/server/protocol/QueryProvider.java\n+++ /dev/null\n\n@@ -1,23 +0,0 @@\n-/*\n- * Licensed under the Apache License, Version 2.0 (the \"License\");\n- * you may not use this file except in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- *     http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-package com.facebook.presto.server.protocol;\n-\n-import com.facebook.presto.spi.QueryId;\n-\n-public interface QueryProvider\n-{\n-    Query getQuery(QueryId queryId, String slug);\n-\n-    void cancel(QueryId queryId, String slug);\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgwODc1MA==", "url": "https://github.com/prestodb/presto/pull/14833#discussion_r459808750", "bodyText": "Many consts here seem to be unused.", "author": "highker", "createdAt": "2020-07-24T01:11:12Z", "path": "presto-main/src/main/java/com/facebook/presto/server/protocol/LocalQueryProvider.java", "diffHunk": "@@ -0,0 +1,186 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.server.protocol;\n+\n+import com.facebook.airlift.concurrent.BoundedExecutor;\n+import com.facebook.airlift.log.Logger;\n+import com.facebook.presto.Session;\n+import com.facebook.presto.common.block.BlockEncodingSerde;\n+import com.facebook.presto.execution.QueryManager;\n+import com.facebook.presto.memory.context.SimpleLocalMemoryContext;\n+import com.facebook.presto.operator.ExchangeClient;\n+import com.facebook.presto.operator.ExchangeClientSupplier;\n+import com.facebook.presto.server.ForStatementResource;\n+import com.facebook.presto.spi.QueryId;\n+import com.google.common.collect.Ordering;\n+import io.airlift.units.DataSize;\n+import io.airlift.units.Duration;\n+\n+import javax.annotation.PostConstruct;\n+import javax.annotation.PreDestroy;\n+import javax.inject.Inject;\n+import javax.ws.rs.WebApplicationException;\n+import javax.ws.rs.core.Response;\n+import javax.ws.rs.core.Response.Status;\n+\n+import java.util.Map.Entry;\n+import java.util.NoSuchElementException;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentMap;\n+import java.util.concurrent.ScheduledExecutorService;\n+\n+import static com.facebook.airlift.concurrent.Threads.threadsNamed;\n+import static com.facebook.presto.memory.context.AggregatedMemoryContext.newSimpleAggregatedMemoryContext;\n+import static io.airlift.units.DataSize.Unit.MEGABYTE;\n+import static java.util.Objects.requireNonNull;\n+import static java.util.concurrent.Executors.newSingleThreadScheduledExecutor;\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+import static java.util.concurrent.TimeUnit.SECONDS;\n+import static javax.ws.rs.core.MediaType.TEXT_PLAIN_TYPE;\n+\n+public class LocalQueryProvider\n+        implements QueryProvider\n+{\n+    private static final Logger log = Logger.get(LocalQueryProvider.class);\n+    private static final Duration MAX_WAIT_TIME = new Duration(1, SECONDS);\n+    private static final Ordering<Comparable<Duration>> WAIT_ORDERING = Ordering.natural().nullsLast();\n+\n+    private static final DataSize DEFAULT_TARGET_RESULT_SIZE = new DataSize(1, MEGABYTE);\n+    private static final DataSize MAX_TARGET_RESULT_SIZE = new DataSize(128, MEGABYTE);", "originalCommit": "47a34d776355161adbb36aed04bfacf237e15a0e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e4993d25d14cd92e5548b6100ce9e1847d97f42c", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/server/protocol/LocalQueryProvider.java b/presto-main/src/main/java/com/facebook/presto/server/protocol/LocalQueryProvider.java\nindex 8ebdf108bd..f7c9da2eb3 100644\n--- a/presto-main/src/main/java/com/facebook/presto/server/protocol/LocalQueryProvider.java\n+++ b/presto-main/src/main/java/com/facebook/presto/server/protocol/LocalQueryProvider.java\n\n@@ -23,9 +23,6 @@ import com.facebook.presto.operator.ExchangeClient;\n import com.facebook.presto.operator.ExchangeClientSupplier;\n import com.facebook.presto.server.ForStatementResource;\n import com.facebook.presto.spi.QueryId;\n-import com.google.common.collect.Ordering;\n-import io.airlift.units.DataSize;\n-import io.airlift.units.Duration;\n \n import javax.annotation.PostConstruct;\n import javax.annotation.PreDestroy;\n"}}, {"oid": "e4993d25d14cd92e5548b6100ce9e1847d97f42c", "url": "https://github.com/prestodb/presto/commit/e4993d25d14cd92e5548b6100ce9e1847d97f42c", "message": "Fetch results eagerly from coordinator\n\nBefore, the query results would only begin to be fetched once the client was\nredirected to the executing query endpoint.  This introduces latency and may\nnot be acceptable for very low latency use cases.", "committedDate": "2020-07-24T16:41:54Z", "type": "forcePushed"}, {"oid": "ed22ca237c53382d1fa6b182e25f6a85729b857f", "url": "https://github.com/prestodb/presto/commit/ed22ca237c53382d1fa6b182e25f6a85729b857f", "message": "Fetch results eagerly from coordinator\n\nBefore, the query results would only begin to be fetched once the client was\nredirected to the executing query endpoint.  This introduces latency and may\nnot be acceptable for very low latency use cases.", "committedDate": "2020-07-24T17:15:51Z", "type": "forcePushed"}, {"oid": "2e417da037ebb88114854d050234e73c0609807f", "url": "https://github.com/prestodb/presto/commit/2e417da037ebb88114854d050234e73c0609807f", "message": "Fetch results eagerly from coordinator\n\nBefore, the query results would only begin to be fetched once the client was\nredirected to the executing query endpoint.  This introduces latency and may\nnot be acceptable for very low latency use cases.", "committedDate": "2020-07-24T18:10:42Z", "type": "forcePushed"}, {"oid": "afbaa351b05b7cc4ceaeb3fd6d794068f1cee15f", "url": "https://github.com/prestodb/presto/commit/afbaa351b05b7cc4ceaeb3fd6d794068f1cee15f", "message": "Fetch results eagerly from coordinator\n\nBefore, the query results would only begin to be fetched once the client was\nredirected to the executing query endpoint.  This introduces latency and may\nnot be acceptable for very low latency use cases.", "committedDate": "2020-07-27T17:27:40Z", "type": "commit"}, {"oid": "afbaa351b05b7cc4ceaeb3fd6d794068f1cee15f", "url": "https://github.com/prestodb/presto/commit/afbaa351b05b7cc4ceaeb3fd6d794068f1cee15f", "message": "Fetch results eagerly from coordinator\n\nBefore, the query results would only begin to be fetched once the client was\nredirected to the executing query endpoint.  This introduces latency and may\nnot be acceptable for very low latency use cases.", "committedDate": "2020-07-27T17:27:40Z", "type": "forcePushed"}]}