{"pr_number": 15316, "pr_title": "Fix caching and case-sensitivity issues with enum type signatures", "pr_createdAt": "2020-10-15T21:43:15Z", "pr_url": "https://github.com/prestodb/presto/pull/15316", "timeline": [{"oid": "ee76b9b16a28a54afb0b4e4e9a30e0f02ac0530c", "url": "https://github.com/prestodb/presto/commit/ee76b9b16a28a54afb0b4e4e9a30e0f02ac0530c", "message": "Handle case-sensitive type signatures", "committedDate": "2020-10-16T04:23:48Z", "type": "forcePushed"}, {"oid": "27696d3264cc52075196c63b00a507f7ea6d73ab", "url": "https://github.com/prestodb/presto/commit/27696d3264cc52075196c63b00a507f7ea6d73ab", "message": "Handle case-sensitive type signatures", "committedDate": "2020-10-16T04:25:43Z", "type": "forcePushed"}, {"oid": "68228ddad1f3769f516d6a05e1f660b08ebb1584", "url": "https://github.com/prestodb/presto/commit/68228ddad1f3769f516d6a05e1f660b08ebb1584", "message": "Make varchar enum signatures case-insensitive", "committedDate": "2020-10-16T04:27:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgxODcxMQ==", "url": "https://github.com/prestodb/presto/pull/15316#discussion_r507818711", "bodyText": "why not to keep it in lower case?", "author": "arhimondr", "createdAt": "2020-10-19T14:53:30Z", "path": "presto-common/src/main/java/com/facebook/presto/common/type/TypeSignature.java", "diffHunk": "@@ -221,7 +222,10 @@ LongEnumMap getLongEnumMap()\n         VarcharEnumMap getVarcharEnumMap()\n         {\n             checkArgument(!isLongEnum, \"Invalid enum map format\");\n-            return new VarcharEnumMap(map);\n+            // Varchar enum values are base32-encoded so that they are case-insensitive, which is expected of TypeSigntures\n+            Base32 base32 = new Base32();\n+            return new VarcharEnumMap(map.entrySet().stream()\n+                    .collect(Collectors.toMap(Map.Entry::getKey, e -> new String(base32.decode(e.getValue().toUpperCase(ENGLISH))))));", "originalCommit": "68228ddad1f3769f516d6a05e1f660b08ebb1584", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg4NzEwMQ==", "url": "https://github.com/prestodb/presto/pull/15316#discussion_r507887101", "bodyText": "because the base32 decoder expects uppercase letters in its encoding", "author": "daniel-ohayon", "createdAt": "2020-10-19T16:25:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgxODcxMQ=="}], "type": "inlineReview", "revised_code": {"commit": "9de494b1a2ce39fea204cc7ab18468c067065ed5", "chunk": "diff --git a/presto-common/src/main/java/com/facebook/presto/common/type/TypeSignature.java b/presto-common/src/main/java/com/facebook/presto/common/type/TypeSignature.java\nindex 060bccb625..0ad899cfa2 100644\n--- a/presto-common/src/main/java/com/facebook/presto/common/type/TypeSignature.java\n+++ b/presto-common/src/main/java/com/facebook/presto/common/type/TypeSignature.java\n\n@@ -222,10 +221,7 @@ public class TypeSignature\n         VarcharEnumMap getVarcharEnumMap()\n         {\n             checkArgument(!isLongEnum, \"Invalid enum map format\");\n-            // Varchar enum values are base32-encoded so that they are case-insensitive, which is expected of TypeSigntures\n-            Base32 base32 = new Base32();\n-            return new VarcharEnumMap(map.entrySet().stream()\n-                    .collect(Collectors.toMap(Map.Entry::getKey, e -> new String(base32.decode(e.getValue().toUpperCase(ENGLISH))))));\n+            return new VarcharEnumMap(map);\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgyMTAyMg==", "url": "https://github.com/prestodb/presto/pull/15316#discussion_r507821022", "bodyText": "Why are only the values that are encoded with base32? Are the keys not prone to this problem?", "author": "arhimondr", "createdAt": "2020-10-19T14:56:24Z", "path": "presto-common/src/test/java/com/facebook/presto/common/type/TestTypeSignature.java", "diffHunk": "@@ -296,23 +296,23 @@ public void testIsCalculated()\n     public void testEnumSignature()\n     {\n         assertEquals(\n-                parseTypeSignature(\"test_enum(enum:varchar{\\\"test\\\" :\\\"\\\"\\\"\\\", \\\"hello\\\": \\\" \\\" , \\\"a\\\":\\\"}{{\\\" })\"),\n+                parseTypeSignature(\"test_enum(enum:varchar{\\\"test\\\" :\\\"EI======\\\", \\\"hello\\\": \\\"EA======\\\" , \\\"a\\\":\\\"PV5XW===\\\" })\"),", "originalCommit": "68228ddad1f3769f516d6a05e1f660b08ebb1584", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg4NjY0OA==", "url": "https://github.com/prestodb/presto/pull/15316#discussion_r507886648", "bodyText": "the keys must be case-insensitive because they can be used as qualified names (SELECT country.UK) which must be case-insensitive according to the SQL spec iiuc", "author": "daniel-ohayon", "createdAt": "2020-10-19T16:24:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgyMTAyMg=="}], "type": "inlineReview", "revised_code": {"commit": "9de494b1a2ce39fea204cc7ab18468c067065ed5", "chunk": "diff --git a/presto-common/src/test/java/com/facebook/presto/common/type/TestTypeSignature.java b/presto-common/src/test/java/com/facebook/presto/common/type/TestTypeSignature.java\nindex df654dcded..8dce48a338 100644\n--- a/presto-common/src/test/java/com/facebook/presto/common/type/TestTypeSignature.java\n+++ b/presto-common/src/test/java/com/facebook/presto/common/type/TestTypeSignature.java\n\n@@ -296,11 +296,11 @@ public class TestTypeSignature\n     public void testEnumSignature()\n     {\n         assertEquals(\n-                parseTypeSignature(\"test_enum(enum:varchar{\\\"test\\\" :\\\"EI======\\\", \\\"hello\\\": \\\"EA======\\\" , \\\"a\\\":\\\"PV5XW===\\\" })\"),\n+                parseTypeSignature(\"test_enum(enum:varchar{\\\"test\\\" :\\\"\\\"\\\"\\\", \\\"hello\\\": \\\" \\\" , \\\"a\\\":\\\"}{{\\\" })\"),\n                 new VarcharEnumType(\"test_enum\", new VarcharEnumMap(ImmutableMap.of(\"a\", \"}{{\", \"hello\", \" \", \"test\", \"\\\"\"))).getTypeSignature());\n \n         assertEquals(\n-                parseTypeSignature(\"test_enum(enum:varchar{\\\"my  key\\\" :\\\"4CSK5YFFQLQKJMXAUWG6BJFP\\\"})\"),\n+                parseTypeSignature(\"test_enum(enum:varchar{\\\"my  key\\\" :\\\"\u092e\u0942\u0932\u094d\u092f\\\"})\"),\n                 new VarcharEnumType(\"test_enum\", new VarcharEnumMap(ImmutableMap.of(\"my  key\", \"\u092e\u0942\u0932\u094d\u092f\"))).getTypeSignature());\n \n         assertEquals(\n"}}, {"oid": "70a371ea004630c113576ce418ab3d20f3630aba", "url": "https://github.com/prestodb/presto/commit/70a371ea004630c113576ce418ab3d20f3630aba", "message": "Use base32-encoding in enum type signatures", "committedDate": "2020-10-19T22:41:21Z", "type": "forcePushed"}, {"oid": "9de494b1a2ce39fea204cc7ab18468c067065ed5", "url": "https://github.com/prestodb/presto/commit/9de494b1a2ce39fea204cc7ab18468c067065ed5", "message": "Add hashCode to VarcharEnumType and LongEnumType", "committedDate": "2020-10-20T16:06:28Z", "type": "commit"}, {"oid": "da69fb398e71565195af99ec4a1219ae7957c588", "url": "https://github.com/prestodb/presto/commit/da69fb398e71565195af99ec4a1219ae7957c588", "message": "Handle enum literals in SqlToRowExpressionTranslator", "committedDate": "2020-10-20T16:06:28Z", "type": "commit"}, {"oid": "f72c2293cf837b616659f473d5cb98ad7ec79e6c", "url": "https://github.com/prestodb/presto/commit/f72c2293cf837b616659f473d5cb98ad7ec79e6c", "message": "Vendor in Base32 codec from apache.commons.codec", "committedDate": "2020-10-20T16:06:28Z", "type": "commit"}, {"oid": "19b5c29bf08b4fdb8039e6c90c73d6c79b4119f7", "url": "https://github.com/prestodb/presto/commit/19b5c29bf08b4fdb8039e6c90c73d6c79b4119f7", "message": "Use base32-encoding in enum type signatures", "committedDate": "2020-10-20T16:06:28Z", "type": "commit"}, {"oid": "e8a4b8815b288cd826bacec8b41d73e2ef3d7465", "url": "https://github.com/prestodb/presto/commit/e8a4b8815b288cd826bacec8b41d73e2ef3d7465", "message": "Add benchmarks for big enum signatures", "committedDate": "2020-10-20T16:39:43Z", "type": "commit"}, {"oid": "e8a4b8815b288cd826bacec8b41d73e2ef3d7465", "url": "https://github.com/prestodb/presto/commit/e8a4b8815b288cd826bacec8b41d73e2ef3d7465", "message": "Add benchmarks for big enum signatures", "committedDate": "2020-10-20T16:39:43Z", "type": "forcePushed"}]}