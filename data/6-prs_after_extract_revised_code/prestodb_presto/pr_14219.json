{"pr_number": 14219, "pr_title": "Add syntax support for external function", "pr_createdAt": "2020-03-05T22:29:19Z", "pr_url": "https://github.com/prestodb/presto/pull/14219", "timeline": [{"oid": "99d7327d85fd2a90ae09f25303556af3562e87bc", "url": "https://github.com/prestodb/presto/commit/99d7327d85fd2a90ae09f25303556af3562e87bc", "message": "Add syntax support for external function", "committedDate": "2020-03-06T01:40:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUyMTgzMA==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r390521830", "bodyText": "equals or compatible? For example return 0 will work for a double return type?", "author": "kaikalur", "createdAt": "2020-03-10T18:24:16Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/analyzer/StatementAnalyzer.java", "diffHunk": "@@ -580,14 +580,17 @@ protected Scope visitCreateFunction(CreateFunction node, Optional<Scope> scope)\n             Scope functionScope = Scope.builder()\n                     .withRelationType(RelationId.anonymous(), new RelationType(fields))\n                     .build();\n-            Type bodyType = analyzeExpression(node.getBody().getExpression(), functionScope).getExpressionTypes().get(NodeRef.of(node.getBody().getExpression()));\n-            if (!bodyType.equals(returnType)) {\n-                throw new SemanticException(TYPE_MISMATCH, node, \"Function implementation type '%s' does not match declared return type '%s'\", bodyType, returnType);\n-            }\n+            if (node.getBody().getReturnExpression().isPresent()) {\n+                Expression returnExpression = node.getBody().getReturnExpression().get();\n+                Type bodyType = analyzeExpression(returnExpression, functionScope).getExpressionTypes().get(NodeRef.of(returnExpression));\n+                if (!bodyType.equals(returnType)) {", "originalCommit": "99d7327d85fd2a90ae09f25303556af3562e87bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY4NTQwMQ==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r390685401", "bodyText": "Hmm, good point. This is only changed because of the indentation so the logic already existed. Currently the behavior is that if the function return type is double, you have to return a double. So you have to say RETURN double'0'. I agree this is quite inconvenient. This provide the benefit that we can rely on the defined return type of the function to be the actual type and not worrying about having to insert cast though.", "author": "rongrong", "createdAt": "2020-03-11T00:27:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUyMTgzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDc2NTYxNw==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r390765617", "bodyText": "I believe when I wrote the initial version, I check whether bodyType is coercible to returnType, but there were a comment to keep things simple for the first version. I think this could be nice feature to have, though not urgent.", "author": "caithagoras", "createdAt": "2020-03-11T06:23:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUyMTgzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc5NjkyNQ==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r391796925", "bodyText": "But if we have APIs to do it trivially why not - at least for implicit conversions where we don't need to cast?", "author": "kaikalur", "createdAt": "2020-03-12T17:58:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUyMTgzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg4MzQ4Mw==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r441883483", "bodyText": "Ping", "author": "kaikalur", "createdAt": "2020-06-17T23:15:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUyMTgzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg4NDM4Nw==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r441884387", "bodyText": "This is not really a relevant change for this PR. I can submit a separate PR for this.", "author": "rongrong", "createdAt": "2020-06-17T23:19:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUyMTgzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU2OTg0NQ==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r444569845", "bodyText": "ok", "author": "kaikalur", "createdAt": "2020-06-23T23:53:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUyMTgzMA=="}], "type": "inlineReview", "revised_code": {"commit": "cb5b77c0cd5797078c477cb3505c409753e9e696", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/sql/analyzer/StatementAnalyzer.java b/presto-main/src/main/java/com/facebook/presto/sql/analyzer/StatementAnalyzer.java\nindex f3587ad6ed..e0746baa4a 100644\n--- a/presto-main/src/main/java/com/facebook/presto/sql/analyzer/StatementAnalyzer.java\n+++ b/presto-main/src/main/java/com/facebook/presto/sql/analyzer/StatementAnalyzer.java\n\n@@ -580,8 +581,8 @@ class StatementAnalyzer\n             Scope functionScope = Scope.builder()\n                     .withRelationType(RelationId.anonymous(), new RelationType(fields))\n                     .build();\n-            if (node.getBody().getReturnExpression().isPresent()) {\n-                Expression returnExpression = node.getBody().getReturnExpression().get();\n+            if (node.getBody() instanceof Return) {\n+                Expression returnExpression = ((Return) node.getBody()).getExpression();\n                 Type bodyType = analyzeExpression(returnExpression, functionScope).getExpressionTypes().get(NodeRef.of(returnExpression));\n                 if (!bodyType.equals(returnType)) {\n                     throw new SemanticException(TYPE_MISMATCH, node, \"Function implementation type '%s' does not match declared return type '%s'\", bodyType, returnType);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE3MDUxNw==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r391170517", "bodyText": "RoutineBody is a Node, not a Statement. See comments below.", "author": "caithagoras", "createdAt": "2020-03-11T18:15:17Z", "path": "presto-parser/src/main/java/com/facebook/presto/sql/tree/RoutineBody.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.sql.tree;\n+\n+import com.google.common.collect.ImmutableList;\n+\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+public class RoutineBody\n+        extends Statement", "originalCommit": "99d7327d85fd2a90ae09f25303556af3562e87bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMyMDI2NA==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r391320264", "bodyText": "Oops, I think I just renamed the previous Return to this and didn't pay attention -_-", "author": "rongrong", "createdAt": "2020-03-11T23:07:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE3MDUxNw=="}], "type": "inlineReview", "revised_code": {"commit": "cb5b77c0cd5797078c477cb3505c409753e9e696", "chunk": "diff --git a/presto-parser/src/main/java/com/facebook/presto/sql/tree/RoutineBody.java b/presto-parser/src/main/java/com/facebook/presto/sql/tree/RoutineBody.java\nindex 47832ef360..e7b41129b1 100644\n--- a/presto-parser/src/main/java/com/facebook/presto/sql/tree/RoutineBody.java\n+++ b/presto-parser/src/main/java/com/facebook/presto/sql/tree/RoutineBody.java\n\n@@ -13,108 +13,13 @@\n  */\n package com.facebook.presto.sql.tree;\n \n-import com.google.common.collect.ImmutableList;\n-\n-import java.util.List;\n-import java.util.Objects;\n import java.util.Optional;\n \n-import static com.google.common.base.MoreObjects.toStringHelper;\n-import static com.google.common.base.Preconditions.checkArgument;\n-import static java.util.Objects.requireNonNull;\n-\n-public class RoutineBody\n-        extends Statement\n+public abstract class RoutineBody\n+        extends Node\n {\n-    private final Optional<Expression> returnExpression;\n-    private final Optional<ExternalBodyReference> externalBodyReference;\n-\n-    public RoutineBody(Expression returnExpression)\n-    {\n-        this(Optional.empty(), Optional.of(returnExpression), Optional.empty());\n-    }\n-\n-    public RoutineBody(ExternalBodyReference externalBodyReference)\n-    {\n-        this(Optional.empty(), Optional.empty(), Optional.of(externalBodyReference));\n-    }\n-\n-    public RoutineBody(NodeLocation location, Expression returnExpression)\n-    {\n-        this(Optional.of(location), Optional.of(returnExpression), Optional.empty());\n-    }\n-\n-    public RoutineBody(NodeLocation location, ExternalBodyReference externalBodyReference)\n-    {\n-        this(Optional.of(location), Optional.empty(), Optional.of(externalBodyReference));\n-    }\n-\n-    private RoutineBody(Optional<NodeLocation> location, Optional<Expression> returnExpression, Optional<ExternalBodyReference> externalBodyReference)\n+    public RoutineBody(Optional<NodeLocation> location)\n     {\n         super(location);\n-        checkArgument(\n-                (returnExpression.isPresent() && !externalBodyReference.isPresent()) || (!returnExpression.isPresent() && externalBodyReference.isPresent()),\n-                \"RoutineBody should either have a RETURN expression or an external body reference\");\n-        this.returnExpression = requireNonNull(returnExpression, \"returnExpression is null\");\n-        this.externalBodyReference = requireNonNull(externalBodyReference, \"externalBodyReference is null\");\n-    }\n-\n-    public Optional<Expression> getReturnExpression()\n-    {\n-        return returnExpression;\n-    }\n-\n-    public Optional<ExternalBodyReference> getExternalBodyReference()\n-    {\n-        return externalBodyReference;\n-    }\n-\n-    public boolean isExternal()\n-    {\n-        return externalBodyReference.isPresent();\n-    }\n-\n-    @Override\n-    public <R, C> R accept(AstVisitor<R, C> visitor, C context)\n-    {\n-        return visitor.visitRoutineBody(this, context);\n-    }\n-\n-    @Override\n-    public List<? extends Node> getChildren()\n-    {\n-        ImmutableList.Builder<Node> children = ImmutableList.builder();\n-        returnExpression.map(children::add);\n-        externalBodyReference.map(children::add);\n-        return children.build();\n-    }\n-\n-    @Override\n-    public int hashCode()\n-    {\n-        return Objects.hash(returnExpression, externalBodyReference);\n-    }\n-\n-    @Override\n-    public boolean equals(Object obj)\n-    {\n-        if (this == obj) {\n-            return true;\n-        }\n-        if ((obj == null) || (getClass() != obj.getClass())) {\n-            return false;\n-        }\n-        RoutineBody o = (RoutineBody) obj;\n-        return Objects.equals(returnExpression, o.returnExpression) &&\n-                Objects.equals(externalBodyReference, o.externalBodyReference);\n-    }\n-\n-    @Override\n-    public String toString()\n-    {\n-        return toStringHelper(this)\n-                .add(\"returnExpression\", returnExpression)\n-                .add(\"externalBodyReference\", externalBodyReference)\n-                .toString();\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE3Mzk1OQ==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r391173959", "bodyText": "Return statement is a first-class citizen as defined in the SQL-spec. It is a SQL control statement similar to Call. I think we'll still need it in this PR. See comments below.", "author": "caithagoras", "createdAt": "2020-03-11T18:20:49Z", "path": "presto-parser/src/main/java/com/facebook/presto/sql/tree/Return.java", "diffHunk": "@@ -1,89 +0,0 @@\n-/*\n- * Licensed under the Apache License, Version 2.0 (the \"License\");\n- * you may not use this file except in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- *     http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-package com.facebook.presto.sql.tree;\n-\n-import com.google.common.collect.ImmutableList;\n-\n-import java.util.List;\n-import java.util.Objects;\n-import java.util.Optional;\n-\n-import static com.google.common.base.MoreObjects.toStringHelper;\n-import static java.util.Objects.requireNonNull;\n-\n-public class Return", "originalCommit": "99d7327d85fd2a90ae09f25303556af3562e87bc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cb5b77c0cd5797078c477cb3505c409753e9e696", "chunk": "diff --git a/presto-parser/src/main/java/com/facebook/presto/sql/tree/Return.java b/presto-parser/src/main/java/com/facebook/presto/sql/tree/Return.java\nnew file mode 100644\nindex 0000000000..d7a758be68\n--- /dev/null\n+++ b/presto-parser/src/main/java/com/facebook/presto/sql/tree/Return.java\n\n@@ -0,0 +1,83 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.sql.tree;\n+\n+import com.google.common.collect.ImmutableList;\n+\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+import static java.util.Objects.requireNonNull;\n+\n+public class Return\n+        extends RoutineBody\n+{\n+    private final Expression expression;\n+\n+    public Return(Expression expression)\n+    {\n+        this(Optional.empty(), expression);\n+    }\n+\n+    public Return(NodeLocation location, Expression expression)\n+    {\n+        this(Optional.of(location), expression);\n+    }\n+\n+    private Return(Optional<NodeLocation> location, Expression expression)\n+    {\n+        super(location);\n+        this.expression = requireNonNull(expression, \"Expression is null\");\n+    }\n+\n+    public Expression getExpression()\n+    {\n+        return expression;\n+    }\n+\n+    @Override\n+    public List<Node> getChildren()\n+    {\n+        return ImmutableList.of(expression);\n+    }\n+\n+    @Override\n+    public int hashCode()\n+    {\n+        return Objects.hash(expression);\n+    }\n+\n+    @Override\n+    public boolean equals(Object obj)\n+    {\n+        if (this == obj) {\n+            return true;\n+        }\n+        if ((obj == null) || (getClass() != obj.getClass())) {\n+            return false;\n+        }\n+        Return o = (Return) obj;\n+        return Objects.equals(expression, o.expression);\n+    }\n+\n+    @Override\n+    public String toString()\n+    {\n+        return toStringHelper(this)\n+                .add(\"expression\", expression)\n+                .toString();\n+    }\n+}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE4MjgyNw==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r391182827", "bodyText": "Either a return expression (SQL routine spec) or an externalBodyReference should be specified as a routine body, but not both. Although constructor has enforced this, this is where inheritance should be used (similar to what we're doing with other parts of the AST).\nBy doing so, AstVisitor will have methods visitRoutineSpecification and visitExternalBodyReference, and if/else shouldn't be needed in many places.\npublic class RoutineBody extends Node {}\npublic class RoutineSpecification extends RoutineBody  {}\npublic class ExternalBodyReference extends RoutineBody  {}\n\npublic class RoutineSpecification {\n    private final Return return;  // Officially, this should be \"private final ProcedureStatement statement;\"\n}\nSimplification\nSince we're (1) not supporting rights clause, (2) only support Return in SQL routine specification, (3) not using Return in other cases, I'm ok to simplify this a bit by temporarily avoiding RoutineSpecification, and just do\npublic class Return extends RoutineBody;\nAlthough the structure I mentioned at the beginning is more locally correct and closer to SQL spec.\nSQL-2016 reference\n<routine body> ::=\n<SQL routine spec>\n| <external body reference>\n| <polymorphic table function body>\n\n<SQL routine spec>\n[ <rights clause> ] <SQL routine body>\n\n<SQL routine body> ::=\n   <SQL procedure statement>", "author": "caithagoras", "createdAt": "2020-03-11T18:36:27Z", "path": "presto-parser/src/main/java/com/facebook/presto/sql/tree/RoutineBody.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.sql.tree;\n+\n+import com.google.common.collect.ImmutableList;\n+\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+public class RoutineBody\n+        extends Statement\n+{\n+    private final Optional<Expression> returnExpression;\n+    private final Optional<ExternalBodyReference> externalBodyReference;", "originalCommit": "99d7327d85fd2a90ae09f25303556af3562e87bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI0ODMzNg==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r391248336", "bodyText": "An additional comment regarding the simplification, I said it is temporary because by doing\npublic class Return extends RoutineBody {}\nReturn is no longer a Statement, but only a Node. This is ok for now as we're not using the Statement aspect of a Return.", "author": "caithagoras", "createdAt": "2020-03-11T20:26:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE4MjgyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMyODk1Nw==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r391328957", "bodyText": "Gonna take the simplified version. Don't see much benefit for adding so many classes when we are not planning to add those functionalities any time soon. \ud83d\ude1b", "author": "rongrong", "createdAt": "2020-03-11T23:36:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE4MjgyNw=="}], "type": "inlineReview", "revised_code": {"commit": "cb5b77c0cd5797078c477cb3505c409753e9e696", "chunk": "diff --git a/presto-parser/src/main/java/com/facebook/presto/sql/tree/RoutineBody.java b/presto-parser/src/main/java/com/facebook/presto/sql/tree/RoutineBody.java\nindex 47832ef360..e7b41129b1 100644\n--- a/presto-parser/src/main/java/com/facebook/presto/sql/tree/RoutineBody.java\n+++ b/presto-parser/src/main/java/com/facebook/presto/sql/tree/RoutineBody.java\n\n@@ -13,108 +13,13 @@\n  */\n package com.facebook.presto.sql.tree;\n \n-import com.google.common.collect.ImmutableList;\n-\n-import java.util.List;\n-import java.util.Objects;\n import java.util.Optional;\n \n-import static com.google.common.base.MoreObjects.toStringHelper;\n-import static com.google.common.base.Preconditions.checkArgument;\n-import static java.util.Objects.requireNonNull;\n-\n-public class RoutineBody\n-        extends Statement\n+public abstract class RoutineBody\n+        extends Node\n {\n-    private final Optional<Expression> returnExpression;\n-    private final Optional<ExternalBodyReference> externalBodyReference;\n-\n-    public RoutineBody(Expression returnExpression)\n-    {\n-        this(Optional.empty(), Optional.of(returnExpression), Optional.empty());\n-    }\n-\n-    public RoutineBody(ExternalBodyReference externalBodyReference)\n-    {\n-        this(Optional.empty(), Optional.empty(), Optional.of(externalBodyReference));\n-    }\n-\n-    public RoutineBody(NodeLocation location, Expression returnExpression)\n-    {\n-        this(Optional.of(location), Optional.of(returnExpression), Optional.empty());\n-    }\n-\n-    public RoutineBody(NodeLocation location, ExternalBodyReference externalBodyReference)\n-    {\n-        this(Optional.of(location), Optional.empty(), Optional.of(externalBodyReference));\n-    }\n-\n-    private RoutineBody(Optional<NodeLocation> location, Optional<Expression> returnExpression, Optional<ExternalBodyReference> externalBodyReference)\n+    public RoutineBody(Optional<NodeLocation> location)\n     {\n         super(location);\n-        checkArgument(\n-                (returnExpression.isPresent() && !externalBodyReference.isPresent()) || (!returnExpression.isPresent() && externalBodyReference.isPresent()),\n-                \"RoutineBody should either have a RETURN expression or an external body reference\");\n-        this.returnExpression = requireNonNull(returnExpression, \"returnExpression is null\");\n-        this.externalBodyReference = requireNonNull(externalBodyReference, \"externalBodyReference is null\");\n-    }\n-\n-    public Optional<Expression> getReturnExpression()\n-    {\n-        return returnExpression;\n-    }\n-\n-    public Optional<ExternalBodyReference> getExternalBodyReference()\n-    {\n-        return externalBodyReference;\n-    }\n-\n-    public boolean isExternal()\n-    {\n-        return externalBodyReference.isPresent();\n-    }\n-\n-    @Override\n-    public <R, C> R accept(AstVisitor<R, C> visitor, C context)\n-    {\n-        return visitor.visitRoutineBody(this, context);\n-    }\n-\n-    @Override\n-    public List<? extends Node> getChildren()\n-    {\n-        ImmutableList.Builder<Node> children = ImmutableList.builder();\n-        returnExpression.map(children::add);\n-        externalBodyReference.map(children::add);\n-        return children.build();\n-    }\n-\n-    @Override\n-    public int hashCode()\n-    {\n-        return Objects.hash(returnExpression, externalBodyReference);\n-    }\n-\n-    @Override\n-    public boolean equals(Object obj)\n-    {\n-        if (this == obj) {\n-            return true;\n-        }\n-        if ((obj == null) || (getClass() != obj.getClass())) {\n-            return false;\n-        }\n-        RoutineBody o = (RoutineBody) obj;\n-        return Objects.equals(returnExpression, o.returnExpression) &&\n-                Objects.equals(externalBodyReference, o.externalBodyReference);\n-    }\n-\n-    @Override\n-    public String toString()\n-    {\n-        return toStringHelper(this)\n-                .add(\"returnExpression\", returnExpression)\n-                .add(\"externalBodyReference\", externalBodyReference)\n-                .toString();\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIyNDIwNQ==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r391224205", "bodyText": "As according to SQL-2016 11.60 9(i), pg. 1009\nAn <SQL-invoked routine> that specifies or implies LANGUAGE SQL is called an SQL routine;\nan <SQL-invoked routine> that does not specify LANGUAGE SQL is called an external routine.\n\nLet's add this additional check.", "author": "caithagoras", "createdAt": "2020-03-11T19:54:06Z", "path": "presto-parser/src/main/java/com/facebook/presto/sql/parser/AstBuilder.java", "diffHunk": "@@ -428,7 +429,7 @@ public Node visitCreateFunction(SqlBaseParser.CreateFunctionContext context)\n                 getType(context.returnType),\n                 comment,\n                 getRoutineCharacteristics(context.routineCharacteristics()),\n-                (Return) visit(context.routineBody()));\n+                (RoutineBody) visit(context.routineBody()));", "originalCommit": "99d7327d85fd2a90ae09f25303556af3562e87bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMzMjY4Ng==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r391332686", "bodyText": "It only says that it's called an external routine, but I don't think it defines how external routine needs to be handled. I also didn't find anything specific about whether external routine requires a <external body reference>. So I'm not sure what to check here. Also the <language name> defined in SQL spec is very old. It doesn't have the languages we definitely want to support in the future like 'JAVA', 'PYTHON', 'PHP' or 'JAVASCRIPT' etc. Some of these could be defined inline potentially, so I don't want to rule that out.", "author": "rongrong", "createdAt": "2020-03-11T23:48:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIyNDIwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ2NzQ2Nw==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r391467467", "bodyText": "Those 2 lines of spec basically means:\n\nLANGUAGE SQL <=> SQL Routine <=> must have SQL routine spec, cannot have external routine body.\nLANGUAGE not SQL <=> external routine <=> must have external routine body, cannot have SQL routine spec.\n\nDoes those 2 checks make sense?", "author": "caithagoras", "createdAt": "2020-03-12T08:36:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIyNDIwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc3NjA2MA==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r391776060", "bodyText": "That's not my understanding of the spec. And that's definitely not how other query engines that supports JS or LUA did it (they are not defined as external body reference). My understanding is literally, if the language is not SQL, is called external routine (which is a name that I didn't find any definition). I didn't find anything specify the relation ship between the name \"external routine\" and the spec <external body reference>. Would be great if you can point me to any documentation that made that association.", "author": "rongrong", "createdAt": "2020-03-12T17:24:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIyNDIwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTg3OTc4NQ==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r391879785", "bodyText": "11.60 Syntax Rules (1) pg. 1006:\nAn <SQL-invoked routine> specifies an SQL-invoked routine.\nLet R be the SQL-invoked routine specified by <SQL-invoked routine>.\n\n11.60 Syntax Rule (23)(a) pg. 1015\nIf R is an SQL routine, then:\na) <SQL routine spec> shall be specified.\n\n11.60 Syntax Rule (24)(a) pg. 1015\n24) If R is an external routine, then:\na) <SQL routine spec> shall not be specified.", "author": "caithagoras", "createdAt": "2020-03-12T20:35:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIyNDIwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk3OTExMw==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r391979113", "bodyText": "If you are specifically saying that if the language is not SQL there should be no RETURN xxx I think that makes sense (at least for now). I don't think anything that's not SQL should have a <external body reference> though, even though that's also true for now. Since SQL spec does not define languages like JS or PYTHON, we need to extend the spec to support this. I don't think they have to have an <external body reference>, though they could. We can choose to not go against SQL spec (not using RETURN definition) so that language SQL <=> RETURN expression holds.", "author": "rongrong", "createdAt": "2020-03-13T01:00:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIyNDIwNQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIyNTc1OA==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r391225758", "bodyText": "See comment in RoutineBody.java, separate visit method should be implemented and this if block would unnecessary.", "author": "caithagoras", "createdAt": "2020-03-11T19:55:43Z", "path": "presto-parser/src/main/java/com/facebook/presto/sql/parser/AstBuilder.java", "diffHunk": "@@ -452,13 +453,28 @@ public Node visitDropFunction(SqlBaseParser.DropFunctionContext context)\n     @Override\n     public Node visitRoutineBody(SqlBaseParser.RoutineBodyContext context)\n     {\n-        return visit(context.returnStatement());\n+        if (context.returnStatement() != null) {\n+            return visit(context.returnStatement());\n+        }\n+        return visit(context.externalBodyReference());", "originalCommit": "99d7327d85fd2a90ae09f25303556af3562e87bc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cb5b77c0cd5797078c477cb3505c409753e9e696", "chunk": "diff --git a/presto-parser/src/main/java/com/facebook/presto/sql/parser/AstBuilder.java b/presto-parser/src/main/java/com/facebook/presto/sql/parser/AstBuilder.java\nindex eba6fe7744..c4a68da816 100644\n--- a/presto-parser/src/main/java/com/facebook/presto/sql/parser/AstBuilder.java\n+++ b/presto-parser/src/main/java/com/facebook/presto/sql/parser/AstBuilder.java\n\n@@ -450,19 +451,10 @@ class AstBuilder\n         return new DropFunction(getLocation(context), getQualifiedName(context.qualifiedName()), parameterTypes, context.EXISTS() != null);\n     }\n \n-    @Override\n-    public Node visitRoutineBody(SqlBaseParser.RoutineBodyContext context)\n-    {\n-        if (context.returnStatement() != null) {\n-            return visit(context.returnStatement());\n-        }\n-        return visit(context.externalBodyReference());\n-    }\n-\n     @Override\n     public Node visitReturnStatement(SqlBaseParser.ReturnStatementContext context)\n     {\n-        return new RoutineBody((Expression) visit(context.expression()));\n+        return new Return((Expression) visit(context.expression()));\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIyOTQwMw==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r391229403", "bodyText": "We are allowing both identifier and string literal in the syntax, but we don't need to store them as is since we only care about the text. Instead, I think an Optional<String> name would be better, since the identifier/string literal are not used in an expression and hence no semantic difference.\nSee similar example in CallArgument.java and AstBuilder.visitNamedArgument", "author": "caithagoras", "createdAt": "2020-03-11T20:00:01Z", "path": "presto-parser/src/main/java/com/facebook/presto/sql/tree/ExternalBodyReference.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.sql.tree;\n+\n+import com.google.common.collect.ImmutableList;\n+\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+import static java.util.Objects.requireNonNull;\n+\n+public class ExternalBodyReference\n+        extends Node\n+{\n+    private final Optional<Identifier> identifier;\n+    private final Optional<StringLiteral> stringLiteral;", "originalCommit": "99d7327d85fd2a90ae09f25303556af3562e87bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMzMjk3Mw==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r391332973", "bodyText": "I kept them separate because otherwise we can't print out the original format in SqlFormatter.", "author": "rongrong", "createdAt": "2020-03-11T23:50:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIyOTQwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ2NTM2MA==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r391465360", "bodyText": "That's true, but do we need to keep the original format? For example\n\nSqlFormatter renders array_sort(a) as \"array_sort\"(a),\nMissing routine characteristics in Create Table are printed with default values.\nSo it does not look like we're promising syntactical equivalence with parsing + formatting.", "author": "caithagoras", "createdAt": "2020-03-12T08:31:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIyOTQwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc3MzE1NA==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r391773154", "bodyText": "Sure, but what's wrong with keeping both? What's the downside?", "author": "rongrong", "createdAt": "2020-03-12T17:19:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIyOTQwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY1MjAzMg==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r439652032", "bodyText": "Both have the same semantic meaning, so the remaining of the system don't care about whether the routine name was specified using StringLiteral or Identifier. This level of information should be encapsulated by the syntax layer and should be opaque to the users of the AST node. e.g. all that semantic analyzer, planner, execution cared about is \"give me the optional name of external routine\".\n\n\nThe class is not self-contained. From the caller perspective, there is nothing to guarantee that getIdentifier and getStringLiteral won't be both present. It requires additional checking at each caller. But again, this is less important than the first bullet point.\n\n\nWe don't name variables using their types - we give them descriptive names. In many places, we just call a StringLiteral value.", "author": "caithagoras", "createdAt": "2020-06-12T21:36:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIyOTQwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY2NDI2NA==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r439664264", "bodyText": "Also, you just allowed Language to be an arbitrary identifier. If we follow the same logic of keeping both, don't we want to do that for language as well? So that we can differentiate SQL against \"SQL\"?", "author": "caithagoras", "createdAt": "2020-06-12T22:19:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIyOTQwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY4NTM0Nw==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r439685347", "bodyText": "We probably should keep both for language if we want to be strict. I can do that if you insist. The difference is the keyword SQL is basically a special identifier, which string literal is not.\nI don't buy your argument. 1) String literals and identifiers have different semantic meaning. For this specific case it doesn't matter. But they are different semantic constructs. You can not change places where asking for one with the other. 2) The constructor already guarantees only one will be present. 3) Sure we can rename them.\nIf this really bothers you, I'm fine with only supporting string, or only supporting identifier.", "author": "rongrong", "createdAt": "2020-06-13T00:07:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIyOTQwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg5MTk3NQ==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r441891975", "bodyText": "Yeah - this is a weird one. I can't think of any other place where this situation happens. I think there should be only one \"child\" of type Node  for the tree node. And you can have an accessor that can give the value of the string literal back.", "author": "kaikalur", "createdAt": "2020-06-17T23:44:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIyOTQwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE5NTUwMA==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r445195500", "bodyText": "Changed this to only allow <identifier> for now. We will see whether there's a need to extend to StringLiteral in the future.", "author": "rongrong", "createdAt": "2020-06-24T21:58:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIyOTQwMw=="}], "type": "inlineReview", "revised_code": {"commit": "cb5b77c0cd5797078c477cb3505c409753e9e696", "chunk": "diff --git a/presto-parser/src/main/java/com/facebook/presto/sql/tree/ExternalBodyReference.java b/presto-parser/src/main/java/com/facebook/presto/sql/tree/ExternalBodyReference.java\nindex bf6f5335c0..1ba28740da 100644\n--- a/presto-parser/src/main/java/com/facebook/presto/sql/tree/ExternalBodyReference.java\n+++ b/presto-parser/src/main/java/com/facebook/presto/sql/tree/ExternalBodyReference.java\n\n@@ -23,7 +23,7 @@ import static com.google.common.base.MoreObjects.toStringHelper;\n import static java.util.Objects.requireNonNull;\n \n public class ExternalBodyReference\n-        extends Node\n+        extends RoutineBody\n {\n     private final Optional<Identifier> identifier;\n     private final Optional<StringLiteral> stringLiteral;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIzMzQ4NQ==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r391233485", "bodyText": "Remove public for methods annotated with @VisibleForTesting.", "author": "caithagoras", "createdAt": "2020-03-11T20:04:48Z", "path": "presto-main/src/main/java/com/facebook/presto/metadata/FunctionManager.java", "diffHunk": "@@ -169,6 +169,15 @@ public void loadFunctionNamespaceManager(\n         }\n     }\n \n+    @VisibleForTesting\n+    public void addTestFunctionNamespace(String catalogName, FunctionNamespaceManager functionNamespaceManager)", "originalCommit": "99d7327d85fd2a90ae09f25303556af3562e87bc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ad6ff34411abc5819ee83b067bfc1b825e2169e3", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/metadata/FunctionManager.java b/presto-main/src/main/java/com/facebook/presto/metadata/FunctionManager.java\nindex f9139a3308..4db7425fa5 100644\n--- a/presto-main/src/main/java/com/facebook/presto/metadata/FunctionManager.java\n+++ b/presto-main/src/main/java/com/facebook/presto/metadata/FunctionManager.java\n\n@@ -169,15 +169,6 @@ public class FunctionManager\n         }\n     }\n \n-    @VisibleForTesting\n-    public void addTestFunctionNamespace(String catalogName, FunctionNamespaceManager functionNamespaceManager)\n-    {\n-        transactionManager.registerFunctionNamespaceManager(catalogName, functionNamespaceManager);\n-        if (functionNamespaceManagers.putIfAbsent(catalogName, functionNamespaceManager) != null) {\n-            throw new IllegalArgumentException(format(\"Function namespace manager is already registered for catalog [%s]\", catalogName));\n-        }\n-    }\n-\n     public FunctionInvokerProvider getFunctionInvokerProvider()\n     {\n         return functionInvokerProvider;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIzMzc4Mw==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r391233783", "bodyText": "checkArgument?", "author": "caithagoras", "createdAt": "2020-03-11T20:05:07Z", "path": "presto-main/src/main/java/com/facebook/presto/metadata/FunctionManager.java", "diffHunk": "@@ -169,6 +169,15 @@ public void loadFunctionNamespaceManager(\n         }\n     }\n \n+    @VisibleForTesting\n+    public void addTestFunctionNamespace(String catalogName, FunctionNamespaceManager functionNamespaceManager)\n+    {\n+        transactionManager.registerFunctionNamespaceManager(catalogName, functionNamespaceManager);\n+        if (functionNamespaceManagers.putIfAbsent(catalogName, functionNamespaceManager) != null) {", "originalCommit": "99d7327d85fd2a90ae09f25303556af3562e87bc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ad6ff34411abc5819ee83b067bfc1b825e2169e3", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/metadata/FunctionManager.java b/presto-main/src/main/java/com/facebook/presto/metadata/FunctionManager.java\nindex f9139a3308..4db7425fa5 100644\n--- a/presto-main/src/main/java/com/facebook/presto/metadata/FunctionManager.java\n+++ b/presto-main/src/main/java/com/facebook/presto/metadata/FunctionManager.java\n\n@@ -169,15 +169,6 @@ public class FunctionManager\n         }\n     }\n \n-    @VisibleForTesting\n-    public void addTestFunctionNamespace(String catalogName, FunctionNamespaceManager functionNamespaceManager)\n-    {\n-        transactionManager.registerFunctionNamespaceManager(catalogName, functionNamespaceManager);\n-        if (functionNamespaceManagers.putIfAbsent(catalogName, functionNamespaceManager) != null) {\n-            throw new IllegalArgumentException(format(\"Function namespace manager is already registered for catalog [%s]\", catalogName));\n-        }\n-    }\n-\n     public FunctionInvokerProvider getFunctionInvokerProvider()\n     {\n         return functionInvokerProvider;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIzNjA4OQ==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r391236089", "bodyText": "Using a static map would be easier?", "author": "caithagoras", "createdAt": "2020-03-11T20:07:29Z", "path": "presto-spi/src/main/java/com/facebook/presto/spi/function/SqlInvokedFunction.java", "diffHunk": "@@ -141,7 +141,14 @@ public SqlFunctionId getFunctionId()\n \n     public FunctionImplementationType getFunctionImplementationType()\n     {\n-        return FunctionImplementationType.SQL;\n+        switch (routineCharacteristics.getLanguage()) {\n+            case SQL:\n+                return FunctionImplementationType.SQL;\n+            case JAVA:\n+                return FunctionImplementationType.THRIFT;\n+            default:\n+                throw new UnsupportedOperationException(format(\"Unsupported language %s\", routineCharacteristics.getLanguage()));\n+        }", "originalCommit": "99d7327d85fd2a90ae09f25303556af3562e87bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMyMTQwMw==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r391321403", "bodyText": "I found this easier to read (code is at the same place). If code needs to be duplicated then I think a static map makes more sense. Currently I think this is fine. We have many this type of case statements in the codebase.", "author": "rongrong", "createdAt": "2020-03-11T23:11:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIzNjA4OQ=="}], "type": "inlineReview", "revised_code": {"commit": "ad6ff34411abc5819ee83b067bfc1b825e2169e3", "chunk": "diff --git a/presto-spi/src/main/java/com/facebook/presto/spi/function/SqlInvokedFunction.java b/presto-spi/src/main/java/com/facebook/presto/spi/function/SqlInvokedFunction.java\nindex c0207f84d7..e398d0872f 100644\n--- a/presto-spi/src/main/java/com/facebook/presto/spi/function/SqlInvokedFunction.java\n+++ b/presto-spi/src/main/java/com/facebook/presto/spi/function/SqlInvokedFunction.java\n\n@@ -141,14 +143,10 @@ public class SqlInvokedFunction\n \n     public FunctionImplementationType getFunctionImplementationType()\n     {\n-        switch (routineCharacteristics.getLanguage()) {\n-            case SQL:\n-                return FunctionImplementationType.SQL;\n-            case JAVA:\n-                return FunctionImplementationType.THRIFT;\n-            default:\n-                throw new UnsupportedOperationException(format(\"Unsupported language %s\", routineCharacteristics.getLanguage()));\n+        if (routineCharacteristics.getLanguage().equals(SQL)) {\n+            return FunctionImplementationType.SQL;\n         }\n+        return FunctionImplementationType.THRIFT;\n     }\n \n     public SqlFunctionHandle getRequiredFunctionHandle()\n"}}, {"oid": "cb5b77c0cd5797078c477cb3505c409753e9e696", "url": "https://github.com/prestodb/presto/commit/cb5b77c0cd5797078c477cb3505c409753e9e696", "message": "Add syntax support for external function", "committedDate": "2020-03-12T00:55:26Z", "type": "forcePushed"}, {"oid": "ad6ff34411abc5819ee83b067bfc1b825e2169e3", "url": "https://github.com/prestodb/presto/commit/ad6ff34411abc5819ee83b067bfc1b825e2169e3", "message": "Add support for creating external function", "committedDate": "2020-06-11T02:31:01Z", "type": "forcePushed"}, {"oid": "a54e0a26ae78750c1e1d0f1ff1d07a16702598cd", "url": "https://github.com/prestodb/presto/commit/a54e0a26ae78750c1e1d0f1ff1d07a16702598cd", "message": "Add support for creating external function", "committedDate": "2020-06-11T22:26:14Z", "type": "forcePushed"}, {"oid": "91d6a8cb931fb1af8ba29bdb8435427c04e951e3", "url": "https://github.com/prestodb/presto/commit/91d6a8cb931fb1af8ba29bdb8435427c04e951e3", "message": "Add support for creating external function", "committedDate": "2020-06-12T01:42:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY0NDkyMQ==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r439644921", "bodyText": "We need test coverage for those cases, and also need to take a look at the spec what the expected behavior is:\n\nCREATE FUNCTION ... LANGUAGE SQL EXTERNAL\nCREATE FUNCTION ... LANGUAGE SQL EXTERNAL NAME\nCREATE FUNCTION ... LANGUAGE JAVA RETURN \n\nhttps://github.com/prestodb/presto/pull/14219/files#r391879785 may have some useful references to the spec.", "author": "caithagoras", "createdAt": "2020-06-12T21:14:10Z", "path": "presto-tests/src/test/java/com/facebook/presto/tests/TestSqlFunctions.java", "diffHunk": "@@ -97,6 +97,18 @@ public void testCreateFunctionInvalidSemantics()\n                 \".*CREATE FUNCTION body cannot contain aggregations, window functions or grouping operations:.*\");\n     }\n \n+    @Test\n+    public void testCreateFunctionExternal()\n+    {\n+        assertQuerySucceeds(\"CREATE FUNCTION testing.test.foo(x varchar) RETURNS varchar LANGUAGE JAVA EXTERNAL\");\n+        assertQuerySucceeds(\"CREATE FUNCTION testing.test.foo(x int) RETURNS bigint LANGUAGE JAVA EXTERNAL NAME foo_from_another_library\");\n+        assertQuerySucceeds(\"CREATE FUNCTION testing.test.foo(x bigint) RETURNS bigint LANGUAGE JAVA EXTERNAL NAME \\\"foo.from.another.library\\\"\");\n+        assertQuerySucceeds(\"CREATE FUNCTION testing.test.foo(x smallint) RETURNS bigint LANGUAGE JAVA EXTERNAL NAME 'foo.from.another.library'\");\n+        assertQuerySucceeds(\"CREATE FUNCTION testing.test.foo(x double) RETURNS double LANGUAGE \\\"JAVA\\\" EXTERNAL\");\n+\n+        assertQueryFails(\"CREATE FUNCTION testing.test.foo(x varchar) RETURNS varchar LANGUAGE UNSUPPORTED EXTERNAL\", \"Catalog testing does not support functions implemented in language UNSUPPORTED\");", "originalCommit": "91d6a8cb931fb1af8ba29bdb8435427c04e951e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY4MjMyNw==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r439682327", "bodyText": "I think the first 2 are valid syntax.", "author": "rongrong", "createdAt": "2020-06-12T23:49:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY0NDkyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwMTQ0OQ==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r441101449", "bodyText": "Sure, let's add the test cases then.", "author": "caithagoras", "createdAt": "2020-06-16T19:47:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY0NDkyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg4NjIwOA==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r441886208", "bodyText": "I think the third one is also valid syntax though it might not be valid semantically. The order of validation should be:\n\nwhether the function namespace allows create\nwhether the function namespace supports the provided language\nwhether the provided language in specified function namespace support the given function body\n\nWithout checking the capability of the specific function namespace, all above mentioned are valid syntax.", "author": "rongrong", "createdAt": "2020-06-17T23:25:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY0NDkyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg5MDA2OA==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r441890068", "bodyText": "Sure, that all make sense to me. My ask is to add those test cases here so that we can see the query are passing as expected. If there are any behavior changes in the future, the test will catch that.", "author": "caithagoras", "createdAt": "2020-06-17T23:37:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY0NDkyMQ=="}], "type": "inlineReview", "revised_code": {"commit": "a9d2a04e5ba79cd8ab047afaef933ba8db52da78", "chunk": "diff --git a/presto-tests/src/test/java/com/facebook/presto/tests/TestSqlFunctions.java b/presto-tests/src/test/java/com/facebook/presto/tests/TestSqlFunctions.java\nindex 10623da355..c35c59397f 100644\n--- a/presto-tests/src/test/java/com/facebook/presto/tests/TestSqlFunctions.java\n+++ b/presto-tests/src/test/java/com/facebook/presto/tests/TestSqlFunctions.java\n\n@@ -87,25 +87,30 @@ public class TestSqlFunctions\n     public void testCreateFunctionInvalidSemantics()\n     {\n         assertQueryFails(\n-                \"CREATE FUNCTION testing.default.tan (x int) RETURNS varchar COMMENT 'tangent trigonometric function' RETURN sin(x) / cos(x)\",\n+                \"CREATE FUNCTION testing.common.tan (x int) RETURNS varchar COMMENT 'tangent trigonometric function' RETURN sin(x) / cos(x)\",\n                 \"Function implementation type 'double' does not match declared return type 'varchar'\");\n         assertQueryFails(\n-                \"CREATE FUNCTION testing.default.tan (x int) RETURNS varchar COMMENT 'tangent trigonometric function' RETURN sin(y) / cos(y)\",\n+                \"CREATE FUNCTION testing.common.tan (x int) RETURNS varchar COMMENT 'tangent trigonometric function' RETURN sin(y) / cos(y)\",\n                 \".*Column 'y' cannot be resolved\");\n         assertQueryFails(\n-                \"CREATE FUNCTION testing.default.tan (x double) RETURNS double COMMENT 'tangent trigonometric function' RETURN sum(x)\",\n+                \"CREATE FUNCTION testing.common.tan (x double) RETURNS double COMMENT 'tangent trigonometric function' RETURN sum(x)\",\n                 \".*CREATE FUNCTION body cannot contain aggregations, window functions or grouping operations:.*\");\n     }\n \n     @Test\n-    public void testCreateFunctionExternal()\n+    public void testCreateFunction()\n     {\n+        assertQuerySucceeds(\"CREATE FUNCTION testing.test.tan (x int) RETURNS double RETURN sin(x) / cos(x)\");\n+        assertQuerySucceeds(\"CREATE FUNCTION testing.test.tan (x double) RETURNS double LANGUAGE JAVA RETURN sin(x) / cos(x)\");\n+\n+        // external function\n         assertQuerySucceeds(\"CREATE FUNCTION testing.test.foo(x varchar) RETURNS varchar LANGUAGE JAVA EXTERNAL\");\n+        assertQuerySucceeds(\"CREATE FUNCTION testing.test.foo(x varchar(3)) RETURNS varchar LANGUAGE SQL EXTERNAL\");\n         assertQuerySucceeds(\"CREATE FUNCTION testing.test.foo(x int) RETURNS bigint LANGUAGE JAVA EXTERNAL NAME foo_from_another_library\");\n         assertQuerySucceeds(\"CREATE FUNCTION testing.test.foo(x bigint) RETURNS bigint LANGUAGE JAVA EXTERNAL NAME \\\"foo.from.another.library\\\"\");\n         assertQuerySucceeds(\"CREATE FUNCTION testing.test.foo(x smallint) RETURNS bigint LANGUAGE JAVA EXTERNAL NAME 'foo.from.another.library'\");\n         assertQuerySucceeds(\"CREATE FUNCTION testing.test.foo(x double) RETURNS double LANGUAGE \\\"JAVA\\\" EXTERNAL\");\n-\n+        assertQueryFails(\"CREATE FUNCTION testing.test.foo(x varchar) RETURNS varchar LANGUAGE JAVA EXTERNAL NAME\", \".*mismatched input '<EOF>'. Expecting: <identifier>, <string>\");\n         assertQueryFails(\"CREATE FUNCTION testing.test.foo(x varchar) RETURNS varchar LANGUAGE UNSUPPORTED EXTERNAL\", \"Catalog testing does not support functions implemented in language UNSUPPORTED\");\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY0ODcxNA==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r439648714", "bodyText": "I guess the reason we are adding those annotation is that we want to serialize the enum, but a Language can just be mapped to a JSON scalar, instead of a JSON map with always one single key.\nWe can do that using @JsonValue. There're plenty of examples. e.g. TransactionId.java.", "author": "caithagoras", "createdAt": "2020-06-12T21:25:45Z", "path": "presto-spi/src/main/java/com/facebook/presto/spi/function/RoutineCharacteristics.java", "diffHunk": "@@ -28,9 +28,48 @@\n \n public class RoutineCharacteristics\n {\n-    public enum Language\n+    public static class Language\n     {\n-        SQL;\n+        public static final Language SQL = new Language(\"SQL\");\n+\n+        private final String language;\n+\n+        @JsonCreator\n+        public Language(@JsonProperty(\"language\") String language)", "originalCommit": "91d6a8cb931fb1af8ba29bdb8435427c04e951e3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a9d2a04e5ba79cd8ab047afaef933ba8db52da78", "chunk": "diff --git a/presto-spi/src/main/java/com/facebook/presto/spi/function/RoutineCharacteristics.java b/presto-spi/src/main/java/com/facebook/presto/spi/function/RoutineCharacteristics.java\nindex cf10be3ec5..80b049c170 100644\n--- a/presto-spi/src/main/java/com/facebook/presto/spi/function/RoutineCharacteristics.java\n+++ b/presto-spi/src/main/java/com/facebook/presto/spi/function/RoutineCharacteristics.java\n\n@@ -35,12 +36,12 @@ public class RoutineCharacteristics\n         private final String language;\n \n         @JsonCreator\n-        public Language(@JsonProperty(\"language\") String language)\n+        public Language(String language)\n         {\n             this.language = requireNonNull(language.toUpperCase());\n         }\n \n-        @JsonProperty\n+        @JsonValue\n         public String getLanguage()\n         {\n             return language;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY1OTk3MQ==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r439659971", "bodyText": "This doesn't seems to be related to syntax support, and I suggest to move this to engine: CreateFunctionTask.\nIf I'm a community user and admins of some Presto clusters, I would prefer less configuration parameters to set and tune.\ne.g. I want to use remote UDFs. I set up the UDF server, added the end points to the Presto engine config properties, and I already have function namespace manager setup from before. Why can't it \"just work\"? Can't the engine just figure out the support languages, like talking to the UDF server?\nIf engine and remote UDF server supports SQL, JAVA, JS, it is meaningless for me as an admin to configure the support language \"python\" anyway. So all I do here is mechanically set this configuration to match with whatever is available on the UDF server, because Presto requires me to?\nWell, for the first step, if the engine cannot yet automatically determine what languages the UDF server support, can we have engine level configuration instead? If user truely wants different supported languages on different function namespace managers, they can extend for their own FSM. If that's the case, we cannot even predict what user wants at this point. Maybe user wants a blacklist instead of a whitelist. Maybe they want a regex? Who knows?\nAlso, throw Exception if we're creating or executing functions with unsupported language, and I think it would creating a new error code to formalize this error path?", "author": "caithagoras", "createdAt": "2020-06-12T22:03:21Z", "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/SqlInvokedFunctionNamespaceManagerConfig.java", "diffHunk": "@@ -14,16 +14,25 @@\n package com.facebook.presto.functionNamespace;\n \n import com.facebook.airlift.configuration.Config;\n+import com.facebook.presto.spi.function.RoutineCharacteristics;\n+import com.google.common.base.Splitter;\n+import com.google.common.collect.ImmutableSet;\n import io.airlift.units.Duration;\n import io.airlift.units.MinDuration;\n \n+import java.util.Set;\n+\n+import static com.facebook.presto.spi.function.RoutineCharacteristics.Language.SQL;\n import static java.util.concurrent.TimeUnit.HOURS;\n import static java.util.concurrent.TimeUnit.MINUTES;\n \n public class SqlInvokedFunctionNamespaceManagerConfig\n {\n+    private static final Splitter LANGUAGE_SPLITTER = Splitter.on(',').omitEmptyStrings().trimResults();\n+\n     private Duration functionCacheExpiration = new Duration(5, MINUTES);\n     private Duration functionInstanceCacheExpiration = new Duration(8, HOURS);\n+    private Set<RoutineCharacteristics.Language> supportedFunctionLanguages = ImmutableSet.of(SQL);", "originalCommit": "91d6a8cb931fb1af8ba29bdb8435427c04e951e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY4MzkxMw==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r439683913", "bodyText": "The function namespace manager needs to configure which language it supports, together with how to invoke that type of functions. The execution of a function is in function namespace manager, so why the configuration should live in the engine? Just like if a specific function namespace manager manages a catalog.schema, so you would call that function namespace manager's createFunction when you create the function, you would call that function namespace manager's executeFunction when you invoke it. The function namespace manager also needs to configure the remote tier and protocol used to execute the function. I can't see why these logic should fit in the engine. You can have function namespace manager A which can support language L1, and L2, where for L1 it will execute the function in T1 and for L2 in T2, while having another function namespace manager supporting language L1 and L3 that runs them in T1' and T3. It's way easier to manage these in function namespace manager than in engine. Remote function is not something that will be able to work out of the box. You HAVE to setup a remote function server to run the functions. The function you introduce has tighter relationship to the UDF server and function metadata than to Presto engine.", "author": "rongrong", "createdAt": "2020-06-12T23:59:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY1OTk3MQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "a9d2a04e5ba79cd8ab047afaef933ba8db52da78", "url": "https://github.com/prestodb/presto/commit/a9d2a04e5ba79cd8ab047afaef933ba8db52da78", "message": "Add support for creating external function", "committedDate": "2020-06-23T23:47:56Z", "type": "forcePushed"}, {"oid": "7542fea4c4dd9bbd39d24e256a5db62596102a07", "url": "https://github.com/prestodb/presto/commit/7542fea4c4dd9bbd39d24e256a5db62596102a07", "message": "Add support for creating external function", "committedDate": "2020-06-24T21:54:06Z", "type": "forcePushed"}, {"oid": "7c7cf908b428e3d9bce4b79989f1a19e65b86c84", "url": "https://github.com/prestodb/presto/commit/7c7cf908b428e3d9bce4b79989f1a19e65b86c84", "message": "Add support for creating external function", "committedDate": "2020-06-24T21:54:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIwNDMxOQ==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r445204319", "bodyText": "Isn't an identifier required?", "author": "kaikalur", "createdAt": "2020-06-24T22:22:19Z", "path": "presto-parser/src/main/java/com/facebook/presto/sql/tree/ExternalBodyReference.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.sql.tree;\n+\n+import com.google.common.collect.ImmutableList;\n+\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import static com.google.common.base.MoreObjects.ToStringHelper;\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+import static java.util.Objects.requireNonNull;\n+\n+public class ExternalBodyReference\n+        extends RoutineBody\n+{\n+    private final Optional<Identifier> identifier;", "originalCommit": "7c7cf908b428e3d9bce4b79989f1a19e65b86c84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIwODM0Nw==", "url": "https://github.com/prestodb/presto/pull/14219#discussion_r445208347", "bodyText": "<external routine name> is optional for external functions. So this could be missing.", "author": "rongrong", "createdAt": "2020-06-24T22:33:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIwNDMxOQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "1ec90a897599896b4e4192341bcaaf7c87de6904", "url": "https://github.com/prestodb/presto/commit/1ec90a897599896b4e4192341bcaaf7c87de6904", "message": "Add support for creating external function", "committedDate": "2020-06-24T22:28:44Z", "type": "commit"}, {"oid": "1ec90a897599896b4e4192341bcaaf7c87de6904", "url": "https://github.com/prestodb/presto/commit/1ec90a897599896b4e4192341bcaaf7c87de6904", "message": "Add support for creating external function", "committedDate": "2020-06-24T22:28:44Z", "type": "forcePushed"}]}