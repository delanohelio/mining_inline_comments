{"pr_number": 15332, "pr_title": "Fix druid reading issue", "pr_createdAt": "2020-10-19T16:26:40Z", "pr_url": "https://github.com/prestodb/presto/pull/15332", "timeline": [{"oid": "8da28e0105fb8123011fa7dc2bc190e62632df85", "url": "https://github.com/prestodb/presto/commit/8da28e0105fb8123011fa7dc2bc190e62632df85", "message": "Fix druid reading issue", "committedDate": "2020-10-19T16:07:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc0NDU3NQ==", "url": "https://github.com/prestodb/presto/pull/15332#discussion_r508744575", "bodyText": "Sometimes the error message might be helpful.  But looks like each row is an json object now, we cannot use the if condition 'rootNode instanceof ObjectNode',  can we somehow keep the logic of extracting the error message?", "author": "beinan", "createdAt": "2020-10-20T18:23:49Z", "path": "presto-druid/src/main/java/com/facebook/presto/druid/DruidBrokerPageSource.java", "diffHunk": "@@ -123,17 +121,10 @@ public Page getNextPage()\n                 }\n                 else {\n                     JsonNode rootNode = OBJECT_MAPPER.readTree(readLine);\n-                    if (!(rootNode instanceof ArrayNode)) {\n-                        if (rootNode instanceof ObjectNode) {\n-                            throw new PrestoException(DRUID_BROKER_RESULT_ERROR, ((ObjectNode) rootNode).findValue(\"errorMessage\").asText());", "originalCommit": "8da28e0105fb8123011fa7dc2bc190e62632df85", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgwMzIxMA==", "url": "https://github.com/prestodb/presto/pull/15332#discussion_r508803210", "bodyText": "I have similar feeling with @beinan could we extract error message?", "author": "zhenxiao", "createdAt": "2020-10-20T20:02:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc0NDU3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTkyNDEwMA==", "url": "https://github.com/prestodb/presto/pull/15332#discussion_r509924100", "bodyText": "@beinan @zhenxiao\nI agree, how about checking if the error rootNode has errorMessage filed and column handles doesn't contain the field at the same time. If so, we raise the exception with the errorMessage.", "author": "adlymousa", "createdAt": "2020-10-22T07:01:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc0NDU3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM4MzI0Ng==", "url": "https://github.com/prestodb/presto/pull/15332#discussion_r510383246", "bodyText": "sure. go ahead", "author": "zhenxiao", "createdAt": "2020-10-22T18:49:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc0NDU3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA3MjkyOQ==", "url": "https://github.com/prestodb/presto/pull/15332#discussion_r511072929", "bodyText": "@beinan @zhenxiao\nI agree, how about checking if the error rootNode has errorMessage filed and column handles doesn't contain the field at the same time. If so, we raise the exception with the errorMessage.\n\nsounds good to me, it would be a good solution. Thanks!", "author": "beinan", "createdAt": "2020-10-23T18:38:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc0NDU3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "4390e42bbea338d3cbdf606ba65f255afc549916", "chunk": "diff --git a/presto-druid/src/main/java/com/facebook/presto/druid/DruidBrokerPageSource.java b/presto-druid/src/main/java/com/facebook/presto/druid/DruidBrokerPageSource.java\nindex 04e67f5fd6..41cc561061 100644\n--- a/presto-druid/src/main/java/com/facebook/presto/druid/DruidBrokerPageSource.java\n+++ b/presto-druid/src/main/java/com/facebook/presto/druid/DruidBrokerPageSource.java\n\n@@ -121,6 +124,9 @@ public class DruidBrokerPageSource\n                 }\n                 else {\n                     JsonNode rootNode = OBJECT_MAPPER.readTree(readLine);\n+                    if (rootNode.has(\"errorMessage\") && !columnHandlesHasErrorMessageField) {\n+                        throw new PrestoException(DRUID_BROKER_RESULT_ERROR, rootNode.findValue(\"errorMessage\").asText());\n+                    }\n                     for (int i = 0; i < columnHandles.size(); i++) {\n                         Type type = columnTypes.get(i);\n                         BlockBuilder blockBuilder = pageBuilder.getBlockBuilder(i);\n"}}, {"oid": "8da28e0105fb8123011fa7dc2bc190e62632df85", "url": "https://github.com/prestodb/presto/commit/8da28e0105fb8123011fa7dc2bc190e62632df85", "message": "Fix druid reading issue", "committedDate": "2020-10-19T16:07:43Z", "type": "forcePushed"}, {"oid": "4390e42bbea338d3cbdf606ba65f255afc549916", "url": "https://github.com/prestodb/presto/commit/4390e42bbea338d3cbdf606ba65f255afc549916", "message": "raise exception if returned from druid", "committedDate": "2020-10-24T21:07:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY0MzgxNQ==", "url": "https://github.com/prestodb/presto/pull/15332#discussion_r511643815", "bodyText": "do we need to keep columnHandlesHasErrorMessageField? how about we inline it in getNextPage()", "author": "zhenxiao", "createdAt": "2020-10-25T20:22:18Z", "path": "presto-druid/src/main/java/com/facebook/presto/druid/DruidBrokerPageSource.java", "diffHunk": "@@ -79,6 +78,8 @@ public DruidBrokerPageSource(\n                 .map(DruidColumnHandle::getColumnType)\n                 .collect(toImmutableList());\n         this.pageBuilder = new PageBuilder(this.columnTypes);\n+        this.columnHandlesHasErrorMessageField = columnHandles.stream().anyMatch(", "originalCommit": "4390e42bbea338d3cbdf606ba65f255afc549916", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9ab3b8b08f571199dd9391329877f1b2350dc917", "chunk": "diff --git a/presto-druid/src/main/java/com/facebook/presto/druid/DruidBrokerPageSource.java b/presto-druid/src/main/java/com/facebook/presto/druid/DruidBrokerPageSource.java\nindex 41cc561061..336abbd702 100644\n--- a/presto-druid/src/main/java/com/facebook/presto/druid/DruidBrokerPageSource.java\n+++ b/presto-druid/src/main/java/com/facebook/presto/druid/DruidBrokerPageSource.java\n\n@@ -78,8 +77,6 @@ public class DruidBrokerPageSource\n                 .map(DruidColumnHandle::getColumnType)\n                 .collect(toImmutableList());\n         this.pageBuilder = new PageBuilder(this.columnTypes);\n-        this.columnHandlesHasErrorMessageField = columnHandles.stream().anyMatch(\n-                handle -> ((DruidColumnHandle)handle).getColumnName().equals(\"errorMessage\"));\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY0Mzg0Nw==", "url": "https://github.com/prestodb/presto/pull/15332#discussion_r511643847", "bodyText": "inline columnHandlesHasErrorMessageField, instead of keeping a private member.", "author": "zhenxiao", "createdAt": "2020-10-25T20:22:46Z", "path": "presto-druid/src/main/java/com/facebook/presto/druid/DruidBrokerPageSource.java", "diffHunk": "@@ -123,17 +124,13 @@ public Page getNextPage()\n                 }\n                 else {\n                     JsonNode rootNode = OBJECT_MAPPER.readTree(readLine);\n-                    if (!(rootNode instanceof ArrayNode)) {\n-                        if (rootNode instanceof ObjectNode) {\n-                            throw new PrestoException(DRUID_BROKER_RESULT_ERROR, ((ObjectNode) rootNode).findValue(\"errorMessage\").asText());\n-                        }\n-                        throw new PrestoException(DRUID_BROKER_RESULT_ERROR, rootNode.toString());\n+                    if (rootNode.has(\"errorMessage\") && !columnHandlesHasErrorMessageField) {", "originalCommit": "4390e42bbea338d3cbdf606ba65f255afc549916", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "9ab3b8b08f571199dd9391329877f1b2350dc917", "url": "https://github.com/prestodb/presto/commit/9ab3b8b08f571199dd9391329877f1b2350dc917", "message": "inline columnHandlesHasErrorMessageField", "committedDate": "2020-10-25T22:34:29Z", "type": "commit"}]}