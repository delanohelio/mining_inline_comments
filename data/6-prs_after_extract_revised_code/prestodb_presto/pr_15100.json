{"pr_number": 15100, "pr_title": "Do not write buffered data when task is aborted", "pr_createdAt": "2020-09-01T01:09:13Z", "pr_url": "https://github.com/prestodb/presto/pull/15100", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0Mjk3Nw==", "url": "https://github.com/prestodb/presto/pull/15100#discussion_r481142977", "bodyText": "use compareAndSet() or getAndSet() to make this atomic\nif (closed.compareAndSet(false, true)) {\n     dataSink.close()\n}", "author": "rschlussel", "createdAt": "2020-09-01T13:37:05Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/pagefile/PageWriter.java", "diffHunk": "@@ -80,17 +79,27 @@ public void write(SerializedPage page)\n     public void close()\n             throws IOException\n     {\n-        if (closed) {\n+        if (closed.get()) {\n             return;\n         }\n-        closed = true;\n+        closed.set(true);\n         if (!bufferedPages.isEmpty()) {\n             flushStripe();\n         }\n         dataSink.write(ImmutableList.of(new PageFileFooterOutput(stripeOffsets, compressionCodec)));\n         dataSink.close();\n     }\n \n+    public void closeWithoutWrite()\n+            throws IOException\n+    {\n+        if (closed.get()) {", "originalCommit": "56c5a64d3ab0f0835880a66c0d2570c17465f40c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "dd168082b0e9102423d3ac2a001a14b0e885b6c3", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/pagefile/PageWriter.java b/presto-hive/src/main/java/com/facebook/presto/hive/pagefile/PageWriter.java\nindex 71e96011cf..d05249741c 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/pagefile/PageWriter.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/pagefile/PageWriter.java\n\n@@ -79,10 +79,9 @@ public class PageWriter\n     public void close()\n             throws IOException\n     {\n-        if (closed.get()) {\n+        if (!closed.compareAndSet(false, true)) {\n             return;\n         }\n-        closed.set(true);\n         if (!bufferedPages.isEmpty()) {\n             flushStripe();\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0MzIyOA==", "url": "https://github.com/prestodb/presto/pull/15100#discussion_r481143228", "bodyText": "useCompareAndSet or getAndSet to make this atomic", "author": "rschlussel", "createdAt": "2020-09-01T13:37:16Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/pagefile/PageWriter.java", "diffHunk": "@@ -80,17 +79,27 @@ public void write(SerializedPage page)\n     public void close()\n             throws IOException\n     {\n-        if (closed) {\n+        if (closed.get()) {", "originalCommit": "56c5a64d3ab0f0835880a66c0d2570c17465f40c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "dd168082b0e9102423d3ac2a001a14b0e885b6c3", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/pagefile/PageWriter.java b/presto-hive/src/main/java/com/facebook/presto/hive/pagefile/PageWriter.java\nindex 71e96011cf..d05249741c 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/pagefile/PageWriter.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/pagefile/PageWriter.java\n\n@@ -79,10 +79,9 @@ public class PageWriter\n     public void close()\n             throws IOException\n     {\n-        if (closed.get()) {\n+        if (!closed.compareAndSet(false, true)) {\n             return;\n         }\n-        closed.set(true);\n         if (!bufferedPages.isEmpty()) {\n             flushStripe();\n         }\n"}}, {"oid": "dd168082b0e9102423d3ac2a001a14b0e885b6c3", "url": "https://github.com/prestodb/presto/commit/dd168082b0e9102423d3ac2a001a14b0e885b6c3", "message": "Do not write buffered data when task is aborted\n\nThis will help to improve DataSinkscalability.", "committedDate": "2020-09-01T14:35:42Z", "type": "commit"}, {"oid": "dd168082b0e9102423d3ac2a001a14b0e885b6c3", "url": "https://github.com/prestodb/presto/commit/dd168082b0e9102423d3ac2a001a14b0e885b6c3", "message": "Do not write buffered data when task is aborted\n\nThis will help to improve DataSinkscalability.", "committedDate": "2020-09-01T14:35:42Z", "type": "forcePushed"}]}