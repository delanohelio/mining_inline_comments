{"pr_number": 14958, "pr_title": "Support skipping control in Verifier", "pr_createdAt": "2020-08-05T01:04:20Z", "pr_url": "https://github.com/prestodb/presto/pull/14958", "timeline": [{"oid": "f9909702f3ba09ad3928a8c5861223f84ad7c722", "url": "https://github.com/prestodb/presto/commit/f9909702f3ba09ad3928a8c5861223f84ad7c722", "message": "Support skipping control in Verifier", "committedDate": "2020-08-05T01:06:50Z", "type": "forcePushed"}, {"oid": "a63ef21c730b45f3d30a3811f8a424b01485e75a", "url": "https://github.com/prestodb/presto/commit/a63ef21c730b45f3d30a3811f8a424b01485e75a", "message": "Support skipping control in Verifier", "committedDate": "2020-08-05T01:20:22Z", "type": "forcePushed"}, {"oid": "2bfac9a2c5635536a4990bdecb2ff771ba128956", "url": "https://github.com/prestodb/presto/commit/2bfac9a2c5635536a4990bdecb2ff771ba128956", "message": "Support skipping control in Verifier", "committedDate": "2020-08-05T01:40:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ2MzYxMg==", "url": "https://github.com/prestodb/presto/pull/14958#discussion_r465463612", "bodyText": "nit: is the indentation suggested by Intellij?", "author": "wenleix", "createdAt": "2020-08-05T04:23:25Z", "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/event/VerifierQueryEvent.java", "diffHunk": "@@ -113,10 +114,12 @@ public static VerifierQueryEvent skipped(\n                 Optional.empty(),\n                 Optional.empty(),\n                 Optional.empty(),\n-                new QueryInfo(\n+                skipControl\n+                        ? Optional.empty()\n+                        : Optional.of(new QueryInfo(\n                         sourceQuery.getControlConfiguration().getCatalog(),", "originalCommit": "2bfac9a2c5635536a4990bdecb2ff771ba128956", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTkzMjE1MA==", "url": "https://github.com/prestodb/presto/pull/14958#discussion_r465932150", "bodyText": "It is", "author": "caithagoras", "createdAt": "2020-08-05T18:48:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ2MzYxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk0Nzc1Nw==", "url": "https://github.com/prestodb/presto/pull/14958#discussion_r465947757", "bodyText": "Resolved by moving ternary operator to the end of the line.", "author": "caithagoras", "createdAt": "2020-08-05T19:17:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ2MzYxMg=="}], "type": "inlineReview", "revised_code": {"commit": "f8b66e440f7da2fe97e1ecb65d54effceb976563", "chunk": "diff --git a/presto-verifier/src/main/java/com/facebook/presto/verifier/event/VerifierQueryEvent.java b/presto-verifier/src/main/java/com/facebook/presto/verifier/event/VerifierQueryEvent.java\nindex 2bb336d5c0..1b81c5832d 100644\n--- a/presto-verifier/src/main/java/com/facebook/presto/verifier/event/VerifierQueryEvent.java\n+++ b/presto-verifier/src/main/java/com/facebook/presto/verifier/event/VerifierQueryEvent.java\n\n@@ -114,12 +114,12 @@ public class VerifierQueryEvent\n                 Optional.empty(),\n                 Optional.empty(),\n                 Optional.empty(),\n-                skipControl\n-                        ? Optional.empty()\n-                        : Optional.of(new QueryInfo(\n-                        sourceQuery.getControlConfiguration().getCatalog(),\n-                        sourceQuery.getControlConfiguration().getSchema(),\n-                        sourceQuery.getControlQuery())),\n+                skipControl ?\n+                        Optional.empty() :\n+                        Optional.of(new QueryInfo(\n+                                sourceQuery.getControlConfiguration().getCatalog(),\n+                                sourceQuery.getControlConfiguration().getSchema(),\n+                                sourceQuery.getControlQuery())),\n                 new QueryInfo(\n                         sourceQuery.getTestConfiguration().getCatalog(),\n                         sourceQuery.getTestConfiguration().getSchema(),\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ2Mzg0Nw==", "url": "https://github.com/prestodb/presto/pull/14958#discussion_r465463847", "bodyText": "nit: unnecessary line break?", "author": "wenleix", "createdAt": "2020-08-05T04:24:22Z", "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/framework/AbstractVerification.java", "diffHunk": "@@ -176,22 +185,25 @@ public VerificationResult run()\n             testQueryContext.setState(QueryState.SUCCEEDED);\n \n             // Verify results\n-            matchResult = Optional.of(verify(controlQueryBundle, test.get(), controlChecksumQueryContext, testChecksumQueryContext));\n+            if (!skipControl) {\n+                matchResult = Optional.of(verify(control.get(), test.get(), controlChecksumQueryContext, testChecksumQueryContext));\n \n-            // Determinism analysis\n-            if (matchResult.get().isMismatchPossiblyCausedByNonDeterminism()) {\n-                determinismAnalysis = Optional.of(determinismAnalyzer.analyze(controlQueryBundle, matchResult.get().getControlChecksum(), determinismAnalysisDetails));\n+                // Determinism analysis\n+                if (matchResult.get().isMismatchPossiblyCausedByNonDeterminism()) {\n+                    determinismAnalysis = Optional.of(determinismAnalyzer.analyze(control.get(), matchResult.get().getControlChecksum(), determinismAnalysisDetails));\n+                }\n             }\n \n-            partialResult = Optional.of(concludeVerificationPartial(control, test, controlQueryContext, matchResult, determinismAnalysis, Optional.empty()));\n+            partialResult = Optional.of(concludeVerificationPartial(control, test, controlQueryContext, testQueryContext, matchResult, determinismAnalysis, Optional.empty()));\n         }\n-        catch (Throwable t) {\n+        catch (\n+                Throwable t) {", "originalCommit": "2bfac9a2c5635536a4990bdecb2ff771ba128956", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f8b66e440f7da2fe97e1ecb65d54effceb976563", "chunk": "diff --git a/presto-verifier/src/main/java/com/facebook/presto/verifier/framework/AbstractVerification.java b/presto-verifier/src/main/java/com/facebook/presto/verifier/framework/AbstractVerification.java\nindex 2df1f64547..3e1af666dd 100644\n--- a/presto-verifier/src/main/java/com/facebook/presto/verifier/framework/AbstractVerification.java\n+++ b/presto-verifier/src/main/java/com/facebook/presto/verifier/framework/AbstractVerification.java\n\n@@ -196,8 +196,7 @@ public abstract class AbstractVerification\n \n             partialResult = Optional.of(concludeVerificationPartial(control, test, controlQueryContext, testQueryContext, matchResult, determinismAnalysis, Optional.empty()));\n         }\n-        catch (\n-                Throwable t) {\n+        catch (Throwable t) {\n             if (exceptionClassifier.shouldResubmit(t)\n                     && verificationContext.getResubmissionCount() < verificationResubmissionLimit) {\n                 return new VerificationResult(this, true, Optional.empty());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ2NDI0MA==", "url": "https://github.com/prestodb/presto/pull/14958#discussion_r465464240", "bodyText": "nit: unnecessary empty line?", "author": "wenleix", "createdAt": "2020-08-05T04:25:51Z", "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/framework/AbstractVerification.java", "diffHunk": "@@ -204,18 +216,21 @@ public VerificationResult run()\n             }\n         }\n \n-        return concludeVerification(\n-                partialResult.get(),\n-                control,\n-                test,\n-                controlQueryContext,\n-                testQueryContext,\n-                matchResult,\n-                determinismAnalysis,\n-                controlChecksumQueryContext,\n-                testChecksumQueryContext,\n-                determinismAnalysisDetails.build(),\n-                throwable);\n+        return\n+\n+                concludeVerification(\n+                        partialResult.get(),\n+", "originalCommit": "2bfac9a2c5635536a4990bdecb2ff771ba128956", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f8b66e440f7da2fe97e1ecb65d54effceb976563", "chunk": "diff --git a/presto-verifier/src/main/java/com/facebook/presto/verifier/framework/AbstractVerification.java b/presto-verifier/src/main/java/com/facebook/presto/verifier/framework/AbstractVerification.java\nindex 2df1f64547..3e1af666dd 100644\n--- a/presto-verifier/src/main/java/com/facebook/presto/verifier/framework/AbstractVerification.java\n+++ b/presto-verifier/src/main/java/com/facebook/presto/verifier/framework/AbstractVerification.java\n\n@@ -220,7 +219,6 @@ public abstract class AbstractVerification\n \n                 concludeVerification(\n                         partialResult.get(),\n-\n                         control,\n                         test,\n                         controlQueryContext,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ2NTgxMw==", "url": "https://github.com/prestodb/presto/pull/14958#discussion_r465465813", "bodyText": "nit: the indentation is not easy to read now...One idea is\n: Optional.of(\n      buildQueryInfo(\n            sourceQuery.getControlConfiguration(),\n............\nBut that's just my personal way. Feel free to keep the current approach if you see fit.", "author": "wenleix", "createdAt": "2020-08-05T04:32:12Z", "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/framework/AbstractVerification.java", "diffHunk": "@@ -301,12 +319,14 @@ private VerificationResult concludeVerification(\n                         Optional.of(determinismAnalysisDetails) :\n                         Optional.empty(),\n                 partialResult.getResolveMessage(),\n-                buildQueryInfo(\n+                skipControl\n+                        ? Optional.empty()\n+                        : Optional.of(buildQueryInfo(\n                         sourceQuery.getControlConfiguration(),", "originalCommit": "2bfac9a2c5635536a4990bdecb2ff771ba128956", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTkzNjY0Mg==", "url": "https://github.com/prestodb/presto/pull/14958#discussion_r465936642", "bodyText": "Unfortunately IntelliJ auto-formats to the following if buildQueryInfo is on the next line:\nskipControl\n    ? Optional.empty()\n    : Optional.of(\n    buildQueryInfo(\n        sourceQuery.getControlConfiguration(),\n        sourceQuery.getControlQuery(),\n        controlChecksumQueryContext,\n        control,\n        controlQueryContext)),", "author": "caithagoras", "createdAt": "2020-08-05T18:56:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ2NTgxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk0NzIzMA==", "url": "https://github.com/prestodb/presto/pull/14958#discussion_r465947230", "bodyText": "Moving the ternary operator to the end of the line and indentation works better.", "author": "caithagoras", "createdAt": "2020-08-05T19:16:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ2NTgxMw=="}], "type": "inlineReview", "revised_code": {"commit": "f8b66e440f7da2fe97e1ecb65d54effceb976563", "chunk": "diff --git a/presto-verifier/src/main/java/com/facebook/presto/verifier/framework/AbstractVerification.java b/presto-verifier/src/main/java/com/facebook/presto/verifier/framework/AbstractVerification.java\nindex 2df1f64547..3e1af666dd 100644\n--- a/presto-verifier/src/main/java/com/facebook/presto/verifier/framework/AbstractVerification.java\n+++ b/presto-verifier/src/main/java/com/facebook/presto/verifier/framework/AbstractVerification.java\n\n@@ -319,14 +317,14 @@ public abstract class AbstractVerification\n                         Optional.of(determinismAnalysisDetails) :\n                         Optional.empty(),\n                 partialResult.getResolveMessage(),\n-                skipControl\n-                        ? Optional.empty()\n-                        : Optional.of(buildQueryInfo(\n-                        sourceQuery.getControlConfiguration(),\n-                        sourceQuery.getControlQuery(),\n-                        controlChecksumQueryContext,\n-                        control,\n-                        controlQueryContext)),\n+                skipControl ?\n+                        Optional.empty() :\n+                        Optional.of(buildQueryInfo(\n+                                sourceQuery.getControlConfiguration(),\n+                                sourceQuery.getControlQuery(),\n+                                controlChecksumQueryContext,\n+                                control,\n+                                controlQueryContext)),\n                 buildQueryInfo(\n                         sourceQuery.getTestConfiguration(),\n                         sourceQuery.getTestQuery(),\n"}}, {"oid": "f8b66e440f7da2fe97e1ecb65d54effceb976563", "url": "https://github.com/prestodb/presto/commit/f8b66e440f7da2fe97e1ecb65d54effceb976563", "message": "Support skipping control in Verifiert :", "committedDate": "2020-08-05T19:16:46Z", "type": "forcePushed"}, {"oid": "8ff84df4f158963e49b606254d10b71a1a2998e5", "url": "https://github.com/prestodb/presto/commit/8ff84df4f158963e49b606254d10b71a1a2998e5", "message": "Support skipping control in Verifier", "committedDate": "2020-08-05T19:18:19Z", "type": "commit"}, {"oid": "8ff84df4f158963e49b606254d10b71a1a2998e5", "url": "https://github.com/prestodb/presto/commit/8ff84df4f158963e49b606254d10b71a1a2998e5", "message": "Support skipping control in Verifier", "committedDate": "2020-08-05T19:18:19Z", "type": "forcePushed"}]}