{"pr_number": 14485, "pr_title": "Fix partitioned spatial joins with small spatial index", "pr_createdAt": "2020-05-05T22:20:27Z", "pr_url": "https://github.com/prestodb/presto/pull/14485", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTExOTU0MQ==", "url": "https://github.com/prestodb/presto/pull/14485#discussion_r421119541", "bodyText": "The implementation doesn't actually allow this yet", "author": "aweisberg", "createdAt": "2020-05-06T22:04:56Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/ExtractSpatialJoins.java", "diffHunk": "@@ -456,6 +460,41 @@ else if (alignment < 0) {\n                 kdbTree.map(KdbTreeUtils::toJson)));\n     }\n \n+    private static boolean isSphericalJoin(Metadata metadata, RowExpression firstArgument, RowExpression secondArgument)\n+    {\n+        Type sphericalGeographyType = metadata.getType(SPHERICAL_GEOGRAPHY_TYPE_SIGNATURE);\n+        return firstArgument.getType().equals(sphericalGeographyType) || secondArgument.getType().equals(sphericalGeographyType);\n+    }\n+\n+    private static boolean canPartitionSpatialJoin(JoinNode joinNode)\n+    {\n+        /*\n+         * A fundamental limitation in distributing joins (broadcast or partitioned)\n+         * is when a side is an outer join, and a row in that side is on more than one worker.\n+         * This is because you cannot determine if that row has no matches given the\n+         * local information (another worker may have found a match), so the worker\n+         * doesn't know whether to emit a NULL for the non-match.\n+         *\n+         * This can happen if:\n+         * 1. A side is broadcast, and it's OUTER on that side (including FULL).\n+         * 2. A side is partitioned, the object is extended (ie, not a Point),\n+         *    and it's OUTER on that side (including FULL).\n+         *\n+         * We assume that the right node is the build side.  The CBO is disabled\n+         * for spatial joins, so this should be a good assumption.  Then we have:\n+         * 1. INNER joins are OK.\n+         * 2. LEFT joins when the left node is a Point are OK.", "originalCommit": "3fcc79bf9f61200d7cef1ed8f9bdffbc83ff222a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "022badef3843f8317345b4bfa0f3be0d696527bb", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/ExtractSpatialJoins.java b/presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/ExtractSpatialJoins.java\nindex 00e3ff21fa..d3732f93ab 100644\n--- a/presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/ExtractSpatialJoins.java\n+++ b/presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/ExtractSpatialJoins.java\n\n@@ -469,10 +469,20 @@ public class ExtractSpatialJoins\n     private static boolean canPartitionSpatialJoin(JoinNode joinNode)\n     {\n         /*\n-         * A fundamental limitation in distributing joins (broadcast or partitioned)\n-         * is when a side is an outer join, and a row in that side is on more than one worker.\n-         * This is because you cannot determine if that row has no matches given the\n-         * local information (another worker may have found a match), so the worker\n+         * Unlike equijoins, partitioned spatial joins can send a row to more\n+         * than one join worker. Extended geometries (such as polygons) can\n+         * intersect more than one spatial partition, but points will be sent\n+         * to only one partition. For INNER joins, we only care about matches,\n+         * so this is acceptable.  In the case of extended geometries on both\n+         * probe and build side, we can disambiguate using the upper-left corner\n+         * of the intersection of the envelopes.  Only the worker whose\n+         * partition contains that point is responsible for the join.\n+         *\n+         * For OUTER joins we need to know if a row has not found a match.\n+         * If a row in an OUTER side is on more than one worker in a distributed\n+         * join (broadcast or partitioned), you cannot determine a non-match\n+         * using only local information.  Not matching on one worker does not\n+         * tell you if there isn't a match on another worker, so the worker\n          * doesn't know whether to emit a NULL for the non-match.\n          *\n          * This can happen if:\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTEyOTY5NA==", "url": "https://github.com/prestodb/presto/pull/14485#discussion_r421129694", "bodyText": "Comment is now wrong", "author": "aweisberg", "createdAt": "2020-05-06T22:30:15Z", "path": "presto-geospatial/src/main/java/com/facebook/presto/plugin/geospatial/SpatialPartitioningInternalAggregateFunction.java", "diffHunk": "@@ -101,7 +101,7 @@ public static void output(SpatialPartitioningState state, BlockBuilder out)\n         Rectangle envelope = state.getExtent();\n \n         // Add a small buffer on the right and upper sides", "originalCommit": "79a9c8a705b1c3875435759ec0b97c2783bdde28", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "022badef3843f8317345b4bfa0f3be0d696527bb", "chunk": "diff --git a/presto-geospatial/src/main/java/com/facebook/presto/plugin/geospatial/SpatialPartitioningInternalAggregateFunction.java b/presto-geospatial/src/main/java/com/facebook/presto/plugin/geospatial/SpatialPartitioningInternalAggregateFunction.java\nindex d2ccfe8f92..07eb2d4261 100644\n--- a/presto-geospatial/src/main/java/com/facebook/presto/plugin/geospatial/SpatialPartitioningInternalAggregateFunction.java\n+++ b/presto-geospatial/src/main/java/com/facebook/presto/plugin/geospatial/SpatialPartitioningInternalAggregateFunction.java\n\n@@ -101,7 +101,7 @@ public class SpatialPartitioningInternalAggregateFunction\n         Rectangle envelope = state.getExtent();\n \n         // Add a small buffer on the right and upper sides\n-        Rectangle paddedExtent = new Rectangle(envelope.getXMin(), envelope.getYMin(), envelope.getXMax(), envelope.getYMax());\n+        Rectangle paddedExtent = new Rectangle(envelope.getXMin(), envelope.getYMin(), Math.nextUp(envelope.getXMax()), Math.nextUp(envelope.getYMax()));\n \n         VARCHAR.writeString(out, KdbTreeUtils.toJson(buildKdbTree(maxItemsPerNode, paddedExtent, samples)));\n     }\n"}}, {"oid": "022badef3843f8317345b4bfa0f3be0d696527bb", "url": "https://github.com/prestodb/presto/commit/022badef3843f8317345b4bfa0f3be0d696527bb", "message": "Assign partition index to geometries outside of KdbTree\n\nCurrently, if a geometry is outside the bounding box of a KdbTree, it is\ndropped: it's assigned an empty partition index array, which is\nunnested, resulting in the row being dropped.  This can be an efficiency\nmeasure: if one side of the join is much smaller than the other, then\nthe bounds will drop many rows before they are sent to the join worker.\n\nHowever, if the bounds are less than both the build- and probe-side of\nthe join, then rows that would have matched in a non-partitioned join\nwill be dropped when you partition the join.  This makes the correctness\nof the partitioned join dependent on the partition chosen, which can\nlead to some surprising output changes that could be reasonably viewed\nas data loss.\n\nThis change adds a special partition index (-1) to any geometry that\nintersects the outside of the KdbTree: in effect, making one additional\n\"outside\" partition.  This trades a potential correctness issue for one\nof skew, that in the worst case will fail the query.  The user can then\nmake a more appropriate spatial partitioning.", "committedDate": "2020-05-17T14:07:14Z", "type": "forcePushed"}, {"oid": "309b201d8dcbae131946b293a84fec23b76d7f2a", "url": "https://github.com/prestodb/presto/commit/309b201d8dcbae131946b293a84fec23b76d7f2a", "message": "Assign partition index to geometries outside of KdbTree\n\nCurrently, if a geometry is outside the bounding box of a KdbTree, it is\ndropped: it's assigned an empty partition index array, which is\nunnested, resulting in the row being dropped.  This can be an efficiency\nmeasure: if one side of the join is much smaller than the other, then\nthe bounds will drop many rows before they are sent to the join worker.\n\nHowever, if the bounds are less than both the build- and probe-side of\nthe join, then rows that would have matched in a non-partitioned join\nwill be dropped when you partition the join.  This makes the correctness\nof the partitioned join dependent on the partition chosen, which can\nlead to some surprising output changes that could be reasonably viewed\nas data loss.\n\nThis commit changes the bounding box of the KdbTree to extend from\n-Infinity to +Infinity, so that all (non-empty) geometries will get\nat least one partition.\n\nAdditionally, make the internal intersection/containement checks for\neach KdbTree node use strict equality for upper/right borders, which\nmakes points intersect only one node.", "committedDate": "2020-06-02T13:06:09Z", "type": "forcePushed"}, {"oid": "bfb52c6f55a8a75cb87c5b5e79a4951535558b70", "url": "https://github.com/prestodb/presto/commit/bfb52c6f55a8a75cb87c5b5e79a4951535558b70", "message": "Assign partition index to geometries outside of KdbTree\n\nCurrently, if a geometry is outside the bounding box of a KdbTree, it is\ndropped: it's assigned an empty partition index array, which is\nunnested, resulting in the row being dropped.  This can be an efficiency\nmeasure: if one side of the join is much smaller than the other, then\nthe bounds will drop many rows before they are sent to the join worker.\n\nHowever, if the bounds are less than both the build- and probe-side of\nthe join, then rows that would have matched in a non-partitioned join\nwill be dropped when you partition the join.  This makes the correctness\nof the partitioned join dependent on the partition chosen, which can\nlead to some surprising output changes that could be reasonably viewed\nas data loss.\n\nThis commit changes the bounding box of the KdbTree to extend from\n-Infinity to +Infinity, so that all (non-empty) geometries will get\nat least one partition.\n\nAdditionally, make the internal intersection/containement checks for\neach KdbTree node use strict equality for upper/right borders, which\nmakes points intersect only one node.", "committedDate": "2020-06-02T15:22:02Z", "type": "forcePushed"}, {"oid": "c9f8ba18eba45f138f009f370705f79a49586e95", "url": "https://github.com/prestodb/presto/commit/c9f8ba18eba45f138f009f370705f79a49586e95", "message": "Assign partition index to geometries outside of KdbTree\n\nCurrently, if a geometry is outside the bounding box of a KdbTree, it is\ndropped: it's assigned an empty partition index array, which is\nunnested, resulting in the row being dropped.  This can be an efficiency\nmeasure: if one side of the join is much smaller than the other, then\nthe bounds will drop many rows before they are sent to the join worker.\n\nHowever, if the bounds are less than both the build- and probe-side of\nthe join, then rows that would have matched in a non-partitioned join\nwill be dropped when you partition the join.  This makes the correctness\nof the partitioned join dependent on the partition chosen, which can\nlead to some surprising output changes that could be reasonably viewed\nas data loss.\n\nThis commit changes the bounding box of the KdbTree to extend from\n-Infinity to +Infinity, so that all (non-empty) geometries will get\nat least one partition.\n\nAdditionally, make the internal intersection/containement checks for\neach KdbTree node use strict equality for upper/right borders, which\nmakes points intersect only one node.", "committedDate": "2020-06-10T14:44:37Z", "type": "forcePushed"}, {"oid": "bd88ff1b7c2868e9b6fb2c82e97501fb0fd91b44", "url": "https://github.com/prestodb/presto/commit/bd88ff1b7c2868e9b6fb2c82e97501fb0fd91b44", "message": "Improve spatial join tests\n\nThis commit adds more data to the spatial join tests, to test cases\nwhere geometries may be outside the range of those geometries used\nto build the spatial index.", "committedDate": "2020-07-06T15:35:42Z", "type": "forcePushed"}, {"oid": "1e250ef026fb98775b2ab2a2fb64534b704530e6", "url": "https://github.com/prestodb/presto/commit/1e250ef026fb98775b2ab2a2fb64534b704530e6", "message": "Improve spatial join tests\n\nThis commit adds more data to the spatial join tests, to test cases\nwhere geometries may be outside the range of those geometries used\nto build the spatial index.", "committedDate": "2020-07-18T11:16:37Z", "type": "forcePushed"}, {"oid": "5e5cf8b90d2d414a1d48210a2d49383f4e04f653", "url": "https://github.com/prestodb/presto/commit/5e5cf8b90d2d414a1d48210a2d49383f4e04f653", "message": "Improve spatial join tests\n\nThis commit adds more data to the spatial join tests, to test cases\nwhere geometries may be outside the range of those geometries used\nto build the spatial index.", "committedDate": "2020-07-18T11:30:19Z", "type": "forcePushed"}, {"oid": "b5128256a5fc0057c8acffb90e6b37f2026b2ba5", "url": "https://github.com/prestodb/presto/commit/b5128256a5fc0057c8acffb90e6b37f2026b2ba5", "message": "Assign partition index to geometries outside of KdbTree\n\nCurrently, if a geometry is outside the bounding box of a KdbTree, it is\ndropped: it's assigned an empty partition index array, which is\nunnested, resulting in the row being dropped.  This can be an efficiency\nmeasure: if one side of the join is much smaller than the other, then\nthe bounds will drop many rows before they are sent to the join worker.\n\nHowever, if the bounds are less than both the build- and probe-side of\nthe join, then rows that would have matched in a non-partitioned join\nwill be dropped when you partition the join.  This makes the correctness\nof the partitioned join dependent on the partition chosen, which can\nlead to some surprising output changes that could be reasonably viewed\nas data loss.\n\nThis commit changes the bounding box of the KdbTree to extend from\n-Infinity to +Infinity, so that all (non-empty) geometries will get\nat least one partition.", "committedDate": "2020-07-31T20:05:07Z", "type": "commit"}, {"oid": "b0df9cda03db9e10d062441c7cc87a5762bd480c", "url": "https://github.com/prestodb/presto/commit/b0df9cda03db9e10d062441c7cc87a5762bd480c", "message": "Improve spatial join tests\n\nThis commit adds more data to the spatial join tests, to test cases\nwhere geometries may be outside the range of those geometries used\nto build the spatial index.", "committedDate": "2020-07-31T20:05:07Z", "type": "commit"}, {"oid": "b0df9cda03db9e10d062441c7cc87a5762bd480c", "url": "https://github.com/prestodb/presto/commit/b0df9cda03db9e10d062441c7cc87a5762bd480c", "message": "Improve spatial join tests\n\nThis commit adds more data to the spatial join tests, to test cases\nwhere geometries may be outside the range of those geometries used\nto build the spatial index.", "committedDate": "2020-07-31T20:05:07Z", "type": "forcePushed"}]}