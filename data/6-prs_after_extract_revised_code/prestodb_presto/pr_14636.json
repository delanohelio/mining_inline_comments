{"pr_number": 14636, "pr_title": "Make TaskStatus Leaner", "pr_createdAt": "2020-06-11T07:14:19Z", "pr_url": "https://github.com/prestodb/presto/pull/14636", "timeline": [{"oid": "f7bd96787fd6ce5a925a8e404684e3f2ee278da4", "url": "https://github.com/prestodb/presto/commit/f7bd96787fd6ce5a925a8e404684e3f2ee278da4", "message": "Make TaskStatus Leaner\n\ntaskInstanceId field is currently represented as a UUID string which\ntakes up 72 bytes whereas representing them as two longs takes only\n16 bytes which is a 78% improvement.", "committedDate": "2020-06-11T17:09:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk1NjM5NQ==", "url": "https://github.com/prestodb/presto/pull/14636#discussion_r438956395", "bodyText": "I went with maintaining both the string representation and the UUID so that the existing code which uses the string representation continues to do so and whatever extra cost of calling UUID.toString each time getTaskInstanceId is called is avoided. If removing the string representation is deemed cleaner I can take this out.", "author": "ajaygeorge", "createdAt": "2020-06-11T17:38:33Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/SqlTask.java", "diffHunk": "@@ -71,6 +71,7 @@\n     private static final Logger log = Logger.get(SqlTask.class);\n \n     private final TaskId taskId;\n+    private final UUID taskInstanceUUID;\n     private final String taskInstanceId;", "originalCommit": "f7bd96787fd6ce5a925a8e404684e3f2ee278da4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8307c5e396487580ba59021d4b2d134a1a4ee0c0", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/execution/SqlTask.java b/presto-main/src/main/java/com/facebook/presto/execution/SqlTask.java\nindex e3304e06dc..3ccf35ca7e 100644\n--- a/presto-main/src/main/java/com/facebook/presto/execution/SqlTask.java\n+++ b/presto-main/src/main/java/com/facebook/presto/execution/SqlTask.java\n\n@@ -71,7 +71,8 @@ public class SqlTask\n     private static final Logger log = Logger.get(SqlTask.class);\n \n     private final TaskId taskId;\n-    private final UUID taskInstanceUUID;\n+    private final TaskInstanceId taskInstanceUUID;\n+    //TODO : Move the string representation as a non serializable field into TaskInstanceId\n     private final String taskInstanceId;\n     private final URI location;\n     private final String nodeId;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3NTM2Mg==", "url": "https://github.com/prestodb/presto/pull/14636#discussion_r438975362", "bodyText": "let's not abreviate, call it LeastSignificantBits", "author": "arhimondr", "createdAt": "2020-06-11T18:03:48Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskStatus.java", "diffHunk": "@@ -86,7 +88,8 @@ public TaskStatus(\n             @JsonProperty(\"fullGcCount\") long fullGcCount,\n             @JsonProperty(\"fullGcTimeInMillis\") long fullGcTimeInMillis)\n     {\n-        this.taskInstanceId = requireNonNull(taskInstanceId, \"taskInstanceId is null\");\n+        this.taskInstanceIdLsb = taskInstanceIdLsb;", "originalCommit": "f7bd96787fd6ce5a925a8e404684e3f2ee278da4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI5OTk4NA==", "url": "https://github.com/prestodb/presto/pull/14636#discussion_r441299984", "bodyText": "done", "author": "ajaygeorge", "createdAt": "2020-06-17T06:04:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3NTM2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "4e1edd262f46d4920828b9c2f66fb0b8a5cd74be", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/execution/TaskStatus.java b/presto-main/src/main/java/com/facebook/presto/execution/TaskStatus.java\nindex 6b66f481fe..d0e5527960 100644\n--- a/presto-main/src/main/java/com/facebook/presto/execution/TaskStatus.java\n+++ b/presto-main/src/main/java/com/facebook/presto/execution/TaskStatus.java\n\n@@ -88,9 +86,7 @@ public class TaskStatus\n             @JsonProperty(\"fullGcCount\") long fullGcCount,\n             @JsonProperty(\"fullGcTimeInMillis\") long fullGcTimeInMillis)\n     {\n-        this.taskInstanceIdLsb = taskInstanceIdLsb;\n-        this.taskInstanceIdMsb = taskInstanceIdMsb;\n-\n+        this.taskInstanceId = requireNonNull(taskInstanceId, \"taskInstanceId is null\");\n         checkState(version >= MIN_VERSION, \"version must be >= MIN_VERSION\");\n         this.version = version;\n         this.state = requireNonNull(state, \"state is null\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3OTc0Mw==", "url": "https://github.com/prestodb/presto/pull/14636#discussion_r438979743", "bodyText": "It's a little weird to have them both. It feels like a single part (one long) should have enough entropy. Should we simply switch to a single long?", "author": "arhimondr", "createdAt": "2020-06-11T18:11:43Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/SqlTask.java", "diffHunk": "@@ -123,7 +124,8 @@ private SqlTask(\n             DataSize maxBufferSize)\n     {\n         this.taskId = requireNonNull(taskId, \"taskId is null\");\n-        this.taskInstanceId = UUID.randomUUID().toString();\n+        this.taskInstanceUUID = UUID.randomUUID();", "originalCommit": "f7bd96787fd6ce5a925a8e404684e3f2ee278da4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk4MDM0NA==", "url": "https://github.com/prestodb/presto/pull/14636#discussion_r438980344", "bodyText": "I clicked \"approve\" by an incident. Let's discuss this first.", "author": "arhimondr", "createdAt": "2020-06-11T18:12:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3OTc0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTAyMTcwNQ==", "url": "https://github.com/prestodb/presto/pull/14636#discussion_r439021705", "bodyText": "Ideally, we should try to keep an object in wire and memory same/similar to avoid additional decoding. I suggest to use TaskInstanceId class everywhere that I described above.", "author": "cemcayiroglu", "createdAt": "2020-06-11T19:33:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3OTc0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTE1ODY5Ng==", "url": "https://github.com/prestodb/presto/pull/14636#discussion_r439158696", "bodyText": "It's a little weird to have them both. It feels like a single part (one long) should have enough entropy. Should we simply switch to a single long?\n\nBy switching to a single long we are effectively halving from where we are currently. I think for this effort we should be focusing on keeping the functionality as is. Let me know what you think.", "author": "ajaygeorge", "createdAt": "2020-06-12T01:23:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3OTc0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTUxNzE3MA==", "url": "https://github.com/prestodb/presto/pull/14636#discussion_r439517170", "bodyText": "I wonder why do we need to have it string. Why it cannot be simply long everywhere?", "author": "arhimondr", "createdAt": "2020-06-12T16:18:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3OTc0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk4MjAyNg==", "url": "https://github.com/prestodb/presto/pull/14636#discussion_r440982026", "bodyText": "I wonder why do we need to have it string. Why it cannot be simply long everywhere?\n\nMight not be a bad idea, I think I thought about this earlier but saw that SqlTaskManager's getTaskInstanceId returns a string and thought might be cleaner to keep everything SqlTask related as string instead of long. Maybe I can just wrap the long from SqlTask in String.valueOf and return in SqlTaskManager.", "author": "ajaygeorge", "createdAt": "2020-06-16T16:25:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3OTc0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk5MDMwNw==", "url": "https://github.com/prestodb/presto/pull/14636#discussion_r440990307", "bodyText": "Regarding going from UUID to one long, I had some more thought.\nI don't think we are halving the entropy. Let me know if the following logic makes sense.\nI think math would be something like with one long we have 2^64 combinations and with two longs we have 2^128 combinations. So we are losing a factor of 2^64 in entropy and not 2 by going from 2 longs to one long.\nA simpler way to think is comparing 2 bits and 4 bits. Even though the number of bits is double the combinations we can represent are 4 and 16 respectively, which makes for a factor of 4.", "author": "ajaygeorge", "createdAt": "2020-06-16T16:36:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3OTc0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI5OTg0Nw==", "url": "https://github.com/prestodb/presto/pull/14636#discussion_r441299847", "bodyText": "Keeping two longs as discussed offline to maintain parity with the existing code.", "author": "ajaygeorge", "createdAt": "2020-06-17T06:04:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3OTc0Mw=="}], "type": "inlineReview", "revised_code": {"commit": "8307c5e396487580ba59021d4b2d134a1a4ee0c0", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/execution/SqlTask.java b/presto-main/src/main/java/com/facebook/presto/execution/SqlTask.java\nindex e3304e06dc..3ccf35ca7e 100644\n--- a/presto-main/src/main/java/com/facebook/presto/execution/SqlTask.java\n+++ b/presto-main/src/main/java/com/facebook/presto/execution/SqlTask.java\n\n@@ -124,8 +125,9 @@ public class SqlTask\n             DataSize maxBufferSize)\n     {\n         this.taskId = requireNonNull(taskId, \"taskId is null\");\n-        this.taskInstanceUUID = UUID.randomUUID();\n-        this.taskInstanceId = taskInstanceUUID.toString();\n+        UUID uuid = UUID.randomUUID();\n+        this.taskInstanceUUID = new TaskInstanceId(uuid.getLeastSignificantBits(), uuid.getMostSignificantBits());\n+        this.taskInstanceId = uuid.toString();\n         this.location = requireNonNull(location, \"location is null\");\n         this.nodeId = requireNonNull(nodeId, \"nodeId is null\");\n         this.queryContext = requireNonNull(queryContext, \"queryContext is null\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTAxOTQ5OQ==", "url": "https://github.com/prestodb/presto/pull/14636#discussion_r439019499", "bodyText": "I think we should create a class to represent taskInstanceId  that  holds long taskInstanceIdLsb and long taskInstanceIdMsb. It may increase the overhead on JSON.", "author": "cemcayiroglu", "createdAt": "2020-06-11T19:28:37Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskStatus.java", "diffHunk": "@@ -70,7 +71,8 @@\n \n     @JsonCreator\n     public TaskStatus(\n-            @JsonProperty(\"taskInstanceId\") String taskInstanceId,\n+            @JsonProperty(\"taskInstanceIdLsb\") long taskInstanceIdLsb,\n+            @JsonProperty(\"taskInstanceIdMsb\") long taskInstanceIdMsb,", "originalCommit": "f7bd96787fd6ce5a925a8e404684e3f2ee278da4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTMwMDAyNw==", "url": "https://github.com/prestodb/presto/pull/14636#discussion_r441300027", "bodyText": "done", "author": "ajaygeorge", "createdAt": "2020-06-17T06:04:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTAxOTQ5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "4e1edd262f46d4920828b9c2f66fb0b8a5cd74be", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/execution/TaskStatus.java b/presto-main/src/main/java/com/facebook/presto/execution/TaskStatus.java\nindex 6b66f481fe..d0e5527960 100644\n--- a/presto-main/src/main/java/com/facebook/presto/execution/TaskStatus.java\n+++ b/presto-main/src/main/java/com/facebook/presto/execution/TaskStatus.java\n\n@@ -71,8 +70,7 @@ public class TaskStatus\n \n     @JsonCreator\n     public TaskStatus(\n-            @JsonProperty(\"taskInstanceIdLsb\") long taskInstanceIdLsb,\n-            @JsonProperty(\"taskInstanceIdMsb\") long taskInstanceIdMsb,\n+            @JsonProperty(\"taskInstanceId\") TaskInstanceId taskInstanceId,\n             @JsonProperty(\"version\") long version,\n             @JsonProperty(\"state\") TaskState state,\n             @JsonProperty(\"self\") URI self,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTAxOTk3Ng==", "url": "https://github.com/prestodb/presto/pull/14636#discussion_r439019976", "bodyText": "We can move this logic to the new TaskInstanceId.", "author": "cemcayiroglu", "createdAt": "2020-06-11T19:29:36Z", "path": "presto-main/src/main/java/com/facebook/presto/server/remotetask/ContinuousTaskStatusFetcher.java", "diffHunk": "@@ -230,7 +229,8 @@ void updateTaskStatus(TaskStatus newValue)\n         AtomicBoolean taskMismatch = new AtomicBoolean();\n         taskStatus.setIf(newValue, oldValue -> {\n             // did the task instance id change\n-            if (!isNullOrEmpty(oldValue.getTaskInstanceId()) && !oldValue.getTaskInstanceId().equals(newValue.getTaskInstanceId())) {\n+            boolean isOldValueEmpty = oldValue.getTaskInstanceIdLsb() == 0 && oldValue.getTaskInstanceIdMsb() == 0;", "originalCommit": "f7bd96787fd6ce5a925a8e404684e3f2ee278da4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTMwMDA2NA==", "url": "https://github.com/prestodb/presto/pull/14636#discussion_r441300064", "bodyText": "done", "author": "ajaygeorge", "createdAt": "2020-06-17T06:04:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTAxOTk3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "4e1edd262f46d4920828b9c2f66fb0b8a5cd74be", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/server/remotetask/ContinuousTaskStatusFetcher.java b/presto-main/src/main/java/com/facebook/presto/server/remotetask/ContinuousTaskStatusFetcher.java\nindex 8128cb93fb..84b8a08621 100644\n--- a/presto-main/src/main/java/com/facebook/presto/server/remotetask/ContinuousTaskStatusFetcher.java\n+++ b/presto-main/src/main/java/com/facebook/presto/server/remotetask/ContinuousTaskStatusFetcher.java\n\n@@ -229,8 +230,7 @@ class ContinuousTaskStatusFetcher\n         AtomicBoolean taskMismatch = new AtomicBoolean();\n         taskStatus.setIf(newValue, oldValue -> {\n             // did the task instance id change\n-            boolean isOldValueEmpty = oldValue.getTaskInstanceIdLsb() == 0 && oldValue.getTaskInstanceIdMsb() == 0;\n-            if (!isOldValueEmpty && !(oldValue.getTaskInstanceIdLsb() == newValue.getTaskInstanceIdLsb() && oldValue.getTaskInstanceIdMsb() == newValue.getTaskInstanceIdMsb())) {\n+            if (!isNullOrEmpty(oldValue.getTaskInstanceId()) && !oldValue.getTaskInstanceId().equals(newValue.getTaskInstanceId())) {\n                 taskMismatch.set(true);\n                 return false;\n             }\n"}}, {"oid": "4e1edd262f46d4920828b9c2f66fb0b8a5cd74be", "url": "https://github.com/prestodb/presto/commit/4e1edd262f46d4920828b9c2f66fb0b8a5cd74be", "message": "Make TaskStatus Leaner\n\ntaskInstanceId field is currently represented as a UUID string which\ntakes up 72 bytes whereas representing them as two longs takes only\n16 bytes which is a 78% improvement.", "committedDate": "2020-06-17T05:58:52Z", "type": "forcePushed"}, {"oid": "d4268bfa7b2a018ab00b8913bd4c5667c5b35821", "url": "https://github.com/prestodb/presto/commit/d4268bfa7b2a018ab00b8913bd4c5667c5b35821", "message": "Make TaskStatus Leaner\n\ntaskInstanceId field is currently represented as a UUID string which\ntakes up 72 bytes whereas representing them as two longs takes only\n16 bytes which is a 78% improvement.", "committedDate": "2020-06-17T06:07:48Z", "type": "forcePushed"}, {"oid": "18771607143e8667bb34a2f8ef3dcbc1e4183f8a", "url": "https://github.com/prestodb/presto/commit/18771607143e8667bb34a2f8ef3dcbc1e4183f8a", "message": "Make TaskStatus Leaner\n\ntaskInstanceId field is currently represented as a UUID string which\ntakes up 72 bytes whereas representing them as two longs takes only\n16 bytes which is a 78% improvement.", "committedDate": "2020-06-17T06:14:32Z", "type": "forcePushed"}, {"oid": "8307c5e396487580ba59021d4b2d134a1a4ee0c0", "url": "https://github.com/prestodb/presto/commit/8307c5e396487580ba59021d4b2d134a1a4ee0c0", "message": "Make TaskStatus Leaner\n\ntaskInstanceId field is currently represented as a UUID string which\ntakes up 72 bytes whereas representing them as two longs takes only\n16 bytes which is a 78% improvement.", "committedDate": "2020-06-17T06:53:45Z", "type": "forcePushed"}, {"oid": "96bb897fd7a1a14c94ec6dda9da510c5d85072e2", "url": "https://github.com/prestodb/presto/commit/96bb897fd7a1a14c94ec6dda9da510c5d85072e2", "message": "Make TaskStatus Leaner\n\ntaskInstanceId field is currently represented as a UUID string which\ntakes up 72 bytes whereas representing them as two longs takes only\n16 bytes which is a 78% improvement.", "committedDate": "2020-06-17T20:53:53Z", "type": "forcePushed"}, {"oid": "1de7000b7b38b6fe8a0587c5b3e38882fd77cb93", "url": "https://github.com/prestodb/presto/commit/1de7000b7b38b6fe8a0587c5b3e38882fd77cb93", "message": "Make TaskStatus Leaner\n\ntaskInstanceId field is currently represented as a UUID string which\ntakes up 72 bytes whereas representing them as two longs takes only\n16 bytes which is a 78% improvement.", "committedDate": "2020-06-17T21:14:43Z", "type": "commit"}, {"oid": "1de7000b7b38b6fe8a0587c5b3e38882fd77cb93", "url": "https://github.com/prestodb/presto/commit/1de7000b7b38b6fe8a0587c5b3e38882fd77cb93", "message": "Make TaskStatus Leaner\n\ntaskInstanceId field is currently represented as a UUID string which\ntakes up 72 bytes whereas representing them as two longs takes only\n16 bytes which is a 78% improvement.", "committedDate": "2020-06-17T21:14:43Z", "type": "forcePushed"}]}