{"pr_number": 14505, "pr_title": "Support cachable flag in CachingDirectoryLister", "pr_createdAt": "2020-05-08T23:29:13Z", "pr_url": "https://github.com/prestodb/presto/pull/14505", "timeline": [{"oid": "927b491a7190d8aa4cb2d5345d3490878f72705c", "url": "https://github.com/prestodb/presto/commit/927b491a7190d8aa4cb2d5345d3490878f72705c", "message": "Use java util Supplier in BackgroundHiveSplitLoader", "committedDate": "2020-05-08T22:47:52Z", "type": "commit"}, {"oid": "386c9241f474695423d3e25a5b7a06d44c46395b", "url": "https://github.com/prestodb/presto/commit/386c9241f474695423d3e25a5b7a06d44c46395b", "message": "Remove redundant requireNonNull", "committedDate": "2020-05-08T22:48:13Z", "type": "commit"}, {"oid": "e8500c9d28498c53bd4dae35a6e54ee590585ff9", "url": "https://github.com/prestodb/presto/commit/e8500c9d28498c53bd4dae35a6e54ee590585ff9", "message": "Use functional style for Optional handling", "committedDate": "2020-05-08T22:49:26Z", "type": "commit"}, {"oid": "54d59d34a3f73674b0a7266d8357ce220d5d1289", "url": "https://github.com/prestodb/presto/commit/54d59d34a3f73674b0a7266d8357ce220d5d1289", "message": "Support cachable flag in CachingDirectoryLister\n\nThis could provide more flexibility on whether a query should use\ncache or not. For example, we might not want ingestion query to\npollute cache, and only want cache to serve latency sensitive\nqueries.", "committedDate": "2020-05-08T23:55:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQyODc0Mg==", "url": "https://github.com/prestodb/presto/pull/14505#discussion_r422428742", "bodyText": "Do we wanna set the default value based on hiveClientConfig.getFileStatusCacheExpireAfterWrite/getFileStatusCacheMaxSize/getFileStatusCacheTables?", "author": "highker", "createdAt": "2020-05-09T00:22:28Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSessionProperties.java", "diffHunk": "@@ -444,6 +445,11 @@ public HiveSessionProperties(HiveClientConfig hiveClientConfig, OrcFileWriterCon\n                         FAIL_FAST_ON_INSERT_INTO_IMMUTABLE_PARTITIONS_ENABLED,\n                         \"Fail fast when trying to insert into an immutable partition. Increases load on the metastore\",\n                         hiveClientConfig.isFailFastOnInsertIntoImmutablePartitionsEnabled(),\n+                        false),\n+                booleanProperty(\n+                        USE_LIST_DIRECTORY_CACHE,\n+                        \"Use list directory cache if available when set to true\",\n+                        true,", "originalCommit": "54d59d34a3f73674b0a7266d8357ce220d5d1289", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzIwMDY1NQ==", "url": "https://github.com/prestodb/presto/pull/14505#discussion_r423200655", "bodyText": "Don't we want it to be backed by a config? Not sure what James is saying.", "author": "jainxrohit", "createdAt": "2020-05-11T17:27:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQyODc0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMxMDgwMQ==", "url": "https://github.com/prestodb/presto/pull/14505#discussion_r423310801", "bodyText": "This sounds reasonable, I'll add that.\n@jainxrohit : I think @highker is suggesting adding default value backed by a config, which is currently lacking :D", "author": "shixuan-fan", "createdAt": "2020-05-11T20:49:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQyODc0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMyMTk0Nw==", "url": "https://github.com/prestodb/presto/pull/14505#discussion_r423321947", "bodyText": "Changed default value to !hiveClientConfig.getFileStatusCacheTables().isEmpty()", "author": "shixuan-fan", "createdAt": "2020-05-11T21:10:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQyODc0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "bd1817574b0d4460523ccc977693cabf5c27925f", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveSessionProperties.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveSessionProperties.java\nindex 10efc1338b..7584536c3d 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HiveSessionProperties.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveSessionProperties.java\n\n@@ -449,7 +449,7 @@ public final class HiveSessionProperties\n                 booleanProperty(\n                         USE_LIST_DIRECTORY_CACHE,\n                         \"Use list directory cache if available when set to true\",\n-                        true,\n+                        !hiveClientConfig.getFileStatusCacheTables().isEmpty(),\n                         false));\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE4NjA4Mg==", "url": "https://github.com/prestodb/presto/pull/14505#discussion_r423186082", "bodyText": "nit: I find cacheable too generic, may be specify its for listDirectoryCache?", "author": "jainxrohit", "createdAt": "2020-05-11T17:02:54Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveDirectoryContext.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class HiveDirectoryContext\n+{\n+    private final NestedDirectoryPolicy nestedDirectoryPolicy;\n+    private final boolean cacheable;", "originalCommit": "54d59d34a3f73674b0a7266d8357ce220d5d1289", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMxMTI5NQ==", "url": "https://github.com/prestodb/presto/pull/14505#discussion_r423311295", "bodyText": "I'm a bit hesitated because it might be somewhat tautologic given the class name is already  HiveDirectoryContext. What do you think?", "author": "shixuan-fan", "createdAt": "2020-05-11T20:50:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE4NjA4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMyNTA0OA==", "url": "https://github.com/prestodb/presto/pull/14505#discussion_r423325048", "bodyText": "Not feeling strongly, but the name DirectoryContext, doesn't tell me that its for ListingDirectories.\nActually in future, I would like to see a generic context being used for all kinds of caching. With this change we would have got two contexts representing different caching information.", "author": "jainxrohit", "createdAt": "2020-05-11T21:16:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE4NjA4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM3Mjg0Nw==", "url": "https://github.com/prestodb/presto/pull/14505#discussion_r423372847", "bodyText": "I agree that consolidating to one context used for all kinds of caching is ideal. But there is also nuances between coordinator cache and worker cache, for whom we probably would still want some differentiation.\nCurrently the cacheable flag in HiveFileContext is determined by the node selection strategy, which is valid because file cache is on the workers, so it makes little sense to cache when there is no affinity. It does not feel natural to apply the same logic for listFiles, because it is coordinator-only caching, which means it is always hard affinity :P.\nLet me keep it as is to be consistent with HiveFileContext. We could revisit when we try to consolidate cache context :)", "author": "shixuan-fan", "createdAt": "2020-05-11T23:17:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE4NjA4Mg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "bd1817574b0d4460523ccc977693cabf5c27925f", "url": "https://github.com/prestodb/presto/commit/bd1817574b0d4460523ccc977693cabf5c27925f", "message": "Support cachable flag in CachingDirectoryLister\n\nThis could provide more flexibility on whether a query should use\ncache or not. For example, we might not want ingestion query to\npollute cache, and only want cache to serve latency sensitive\nqueries.", "committedDate": "2020-05-11T21:10:34Z", "type": "forcePushed"}, {"oid": "b80c17958cff93ac260c190ac1eb14339c33973e", "url": "https://github.com/prestodb/presto/commit/b80c17958cff93ac260c190ac1eb14339c33973e", "message": "Support cachable flag in CachingDirectoryLister\n\nThis could provide more flexibility on whether a query should use\ncache or not. For example, we might not want ingestion query to\npollute cache, and only want cache to serve latency sensitive\nqueries.", "committedDate": "2020-05-11T23:03:58Z", "type": "commit"}, {"oid": "b80c17958cff93ac260c190ac1eb14339c33973e", "url": "https://github.com/prestodb/presto/commit/b80c17958cff93ac260c190ac1eb14339c33973e", "message": "Support cachable flag in CachingDirectoryLister\n\nThis could provide more flexibility on whether a query should use\ncache or not. For example, we might not want ingestion query to\npollute cache, and only want cache to serve latency sensitive\nqueries.", "committedDate": "2020-05-11T23:03:58Z", "type": "forcePushed"}]}