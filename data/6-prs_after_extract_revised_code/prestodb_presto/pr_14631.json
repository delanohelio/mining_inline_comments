{"pr_number": 14631, "pr_title": "Support all bucketing types for hive temporary table", "pr_createdAt": "2020-06-10T11:53:11Z", "pr_url": "https://github.com/prestodb/presto/pull/14631", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODIzNzE2Ng==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r438237166", "bodyText": "Is Type json serializable?", "author": "arhimondr", "createdAt": "2020-06-10T16:01:49Z", "path": "presto-hive-metastore/src/main/java/com/facebook/presto/hive/HiveBucketProperty.java", "diffHunk": "@@ -34,16 +35,27 @@\n     private final List<String> bucketedBy;\n     private final int bucketCount;\n     private final List<SortingColumn> sortedBy;\n+    private final Optional<List<Type>> types;\n+\n+    public HiveBucketProperty(\n+            List<String> bucketedBy,\n+            int bucketCount,\n+            List<SortingColumn> sortedBy)\n+    {\n+        this(bucketedBy, bucketCount, sortedBy, Optional.empty());", "originalCommit": "a9f0275e084d245e14ea9f9bf6fc629598de5c70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI2Njg0Mw==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r438266843", "bodyText": "Yes, it is involved in TaskInfo update", "author": "viczhang861", "createdAt": "2020-06-10T16:45:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODIzNzE2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "57667dcf971abbfa794138a5b1427ee67409f615", "chunk": "diff --git a/presto-hive-metastore/src/main/java/com/facebook/presto/hive/HiveBucketProperty.java b/presto-hive-metastore/src/main/java/com/facebook/presto/hive/HiveBucketProperty.java\nindex 6e4112c434..11f86f25ac 100644\n--- a/presto-hive-metastore/src/main/java/com/facebook/presto/hive/HiveBucketProperty.java\n+++ b/presto-hive-metastore/src/main/java/com/facebook/presto/hive/HiveBucketProperty.java\n\n@@ -36,6 +36,7 @@ public class HiveBucketProperty\n     private final int bucketCount;\n     private final List<SortingColumn> sortedBy;\n     private final Optional<List<Type>> types;\n+    private final BucketingType bucketingType;\n \n     public HiveBucketProperty(\n             List<String> bucketedBy,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODIzNzg2OQ==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r438237869", "bodyText": "Can we reuse the implementation from InterpretedHashGeneration?", "author": "arhimondr", "createdAt": "2020-06-10T16:02:51Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketing.java", "diffHunk": "@@ -86,6 +92,17 @@ public static int getHiveBucket(int bucketCount, List<TypeInfo> types, Object[]\n         return (getBucketHashCode(types, values) & Integer.MAX_VALUE) % bucketCount;\n     }\n \n+    private static int getHashCode(List<Type> types, Page page, int position)", "originalCommit": "a9f0275e084d245e14ea9f9bf6fc629598de5c70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI4NzY4NQ==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r438287685", "bodyText": "No,  HiveBucketFunction uses Page with only bucket columns, InterpretedHashGeneration is used for the raw Page with both bucket column and other column", "author": "viczhang861", "createdAt": "2020-06-10T17:20:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODIzNzg2OQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI0MDM4Nw==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r438240387", "bodyText": "inputColumns has the information about the types. You can extract it from there.", "author": "arhimondr", "createdAt": "2020-06-10T16:06:38Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePageSink.java", "diffHunk": "@@ -143,10 +143,15 @@ public HivePageSink(\n             bucketColumns = bucketProperty.get().getBucketedBy().stream()\n                     .mapToInt(dataColumnNameToIdMap::get)\n                     .toArray();\n-            List<HiveType> bucketColumnTypes = bucketProperty.get().getBucketedBy().stream()\n-                    .map(dataColumnNameToTypeMap::get)\n-                    .collect(toList());\n-            bucketFunction = new HiveBucketFunction(bucketCount, bucketColumnTypes);\n+            if (bucketProperty.get().getTypes().isPresent()) {", "originalCommit": "a9f0275e084d245e14ea9f9bf6fc629598de5c70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI3MDAzMA==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r438270030", "bodyText": "inputColumns is of type HiveColumnHandle, which may be HIVE_BINARY type that we translated to, as a result,  original type is lost. I have tried to add type to HiveColumnHandle but there are many dependencies, it is better to use HiveBucketProperty", "author": "viczhang861", "createdAt": "2020-06-10T16:50:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI0MDM4Nw=="}], "type": "inlineReview", "revised_code": {"commit": "57667dcf971abbfa794138a5b1427ee67409f615", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HivePageSink.java b/presto-hive/src/main/java/com/facebook/presto/hive/HivePageSink.java\nindex dd3c65b822..5506686e9e 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HivePageSink.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HivePageSink.java\n\n@@ -143,14 +146,19 @@ public class HivePageSink\n             bucketColumns = bucketProperty.get().getBucketedBy().stream()\n                     .mapToInt(dataColumnNameToIdMap::get)\n                     .toArray();\n-            if (bucketProperty.get().getTypes().isPresent()) {\n-                bucketFunction = new HiveBucketFunction(bucketCount, Optional.empty(), bucketProperty.get().getTypes());\n-            }\n-            else {\n-                List<HiveType> bucketColumnHiveTypes = bucketProperty.get().getBucketedBy().stream()\n-                        .map(dataColumnNameToHiveTypeMap::get)\n-                        .collect(toList());\n-                bucketFunction = new HiveBucketFunction(bucketCount, bucketColumnHiveTypes);\n+            HiveBucketProperty.BucketingType bucketingType = bucketProperty.get().getBucketingType();\n+            switch (bucketingType) {\n+                case HIVETYPE:\n+                    List<HiveType> bucketColumnHiveTypes = bucketProperty.get().getBucketedBy().stream()\n+                            .map(dataColumnNameToHiveTypeMap::get)\n+                            .collect(toImmutableList());\n+                    bucketFunction = createHiveCompatibleBucketFunction(bucketCount, bucketColumnHiveTypes);\n+                    break;\n+                case PRESTOTYPE:\n+                    bucketFunction = createPrestoNativeBucketFunction(bucketCount, bucketProperty.get().getTypes().get());\n+                    break;\n+                default:\n+                    throw new IllegalStateException(format(\"Unsupported bucketing type %s\", bucketingType));\n             }\n         }\n         else {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI0MjE0Nw==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r438242147", "bodyText": "Let's not store the list of types here. Let's use a flag instead, say usePrestoHiveBucketFunction", "author": "arhimondr", "createdAt": "2020-06-10T16:08:30Z", "path": "presto-hive-metastore/src/main/java/com/facebook/presto/hive/HiveBucketProperty.java", "diffHunk": "@@ -34,16 +35,27 @@\n     private final List<String> bucketedBy;\n     private final int bucketCount;\n     private final List<SortingColumn> sortedBy;\n+    private final Optional<List<Type>> types;\n+\n+    public HiveBucketProperty(\n+            List<String> bucketedBy,\n+            int bucketCount,\n+            List<SortingColumn> sortedBy)\n+    {\n+        this(bucketedBy, bucketCount, sortedBy, Optional.empty());", "originalCommit": "a9f0275e084d245e14ea9f9bf6fc629598de5c70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI3NjM5NA==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r438276394", "bodyText": "Type is required to calculate bucket number, hash function requires type", "author": "viczhang861", "createdAt": "2020-06-10T17:01:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI0MjE0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "57667dcf971abbfa794138a5b1427ee67409f615", "chunk": "diff --git a/presto-hive-metastore/src/main/java/com/facebook/presto/hive/HiveBucketProperty.java b/presto-hive-metastore/src/main/java/com/facebook/presto/hive/HiveBucketProperty.java\nindex 6e4112c434..11f86f25ac 100644\n--- a/presto-hive-metastore/src/main/java/com/facebook/presto/hive/HiveBucketProperty.java\n+++ b/presto-hive-metastore/src/main/java/com/facebook/presto/hive/HiveBucketProperty.java\n\n@@ -36,6 +36,7 @@ public class HiveBucketProperty\n     private final int bucketCount;\n     private final List<SortingColumn> sortedBy;\n     private final Optional<List<Type>> types;\n+    private final BucketingType bucketingType;\n \n     public HiveBucketProperty(\n             List<String> bucketedBy,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI0MzUwOQ==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r438243509", "bodyText": "Let's make this constructor private and have to separate static factory method createHiveCompatibleBucketFunction, createPrestoNativeBucketFunction", "author": "arhimondr", "createdAt": "2020-06-10T16:09:59Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketFunction.java", "diffHunk": "@@ -13,34 +13,61 @@\n  */\n package com.facebook.presto.hive;\n \n+import com.facebook.presto.common.GenericInternalException;\n import com.facebook.presto.common.Page;\n+import com.facebook.presto.common.type.Type;\n import com.facebook.presto.spi.BucketFunction;\n import org.apache.hadoop.hive.serde2.typeinfo.TypeInfo;\n \n import java.util.List;\n+import java.util.Optional;\n import java.util.stream.Collectors;\n \n+import static com.facebook.presto.hive.HiveBucketing.getHiveBucket;\n import static com.google.common.base.MoreObjects.toStringHelper;\n+import static com.google.common.base.Preconditions.checkArgument;\n import static java.util.Objects.requireNonNull;\n \n public class HiveBucketFunction\n         implements BucketFunction\n {\n     private final int bucketCount;\n-    private final List<TypeInfo> typeInfos;\n+    private final Optional<List<TypeInfo>> typeInfos;\n+    private final Optional<List<Type>> types;\n \n-    public HiveBucketFunction(int bucketCount, List<HiveType> hiveTypes)\n+    public HiveBucketFunction(\n+            int bucketCount,\n+            List<HiveType> hiveTypes)\n     {\n+        this(bucketCount, Optional.of(hiveTypes), Optional.empty());\n+    }\n+\n+    public HiveBucketFunction(", "originalCommit": "a9f0275e084d245e14ea9f9bf6fc629598de5c70", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "57667dcf971abbfa794138a5b1427ee67409f615", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketFunction.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketFunction.java\nindex 1d6aa0b1f5..69526fcfcc 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketFunction.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketFunction.java\n\n@@ -13,7 +13,6 @@\n  */\n package com.facebook.presto.hive;\n \n-import com.facebook.presto.common.GenericInternalException;\n import com.facebook.presto.common.Page;\n import com.facebook.presto.common.type.Type;\n import com.facebook.presto.spi.BucketFunction;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI0NDIyMA==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r438244220", "bodyText": "Let's inline it. also hiveTypes is null", "author": "arhimondr", "createdAt": "2020-06-10T16:10:42Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketFunction.java", "diffHunk": "@@ -13,34 +13,61 @@\n  */\n package com.facebook.presto.hive;\n \n+import com.facebook.presto.common.GenericInternalException;\n import com.facebook.presto.common.Page;\n+import com.facebook.presto.common.type.Type;\n import com.facebook.presto.spi.BucketFunction;\n import org.apache.hadoop.hive.serde2.typeinfo.TypeInfo;\n \n import java.util.List;\n+import java.util.Optional;\n import java.util.stream.Collectors;\n \n+import static com.facebook.presto.hive.HiveBucketing.getHiveBucket;\n import static com.google.common.base.MoreObjects.toStringHelper;\n+import static com.google.common.base.Preconditions.checkArgument;\n import static java.util.Objects.requireNonNull;\n \n public class HiveBucketFunction\n         implements BucketFunction\n {\n     private final int bucketCount;\n-    private final List<TypeInfo> typeInfos;\n+    private final Optional<List<TypeInfo>> typeInfos;\n+    private final Optional<List<Type>> types;\n \n-    public HiveBucketFunction(int bucketCount, List<HiveType> hiveTypes)\n+    public HiveBucketFunction(\n+            int bucketCount,\n+            List<HiveType> hiveTypes)\n     {\n+        this(bucketCount, Optional.of(hiveTypes), Optional.empty());\n+    }\n+\n+    public HiveBucketFunction(\n+            int bucketCount,\n+            Optional<List<HiveType>> hiveTypes,\n+            Optional<List<Type>> types)\n+    {\n+        requireNonNull(types, \"hiveType is null\");", "originalCommit": "a9f0275e084d245e14ea9f9bf6fc629598de5c70", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "57667dcf971abbfa794138a5b1427ee67409f615", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketFunction.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketFunction.java\nindex 1d6aa0b1f5..69526fcfcc 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketFunction.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketFunction.java\n\n@@ -13,7 +13,6 @@\n  */\n package com.facebook.presto.hive;\n \n-import com.facebook.presto.common.GenericInternalException;\n import com.facebook.presto.common.Page;\n import com.facebook.presto.common.type.Type;\n import com.facebook.presto.spi.BucketFunction;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI0NDM4Mw==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r438244383", "bodyText": "toImmutableList", "author": "arhimondr", "createdAt": "2020-06-10T16:10:50Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketFunction.java", "diffHunk": "@@ -13,34 +13,61 @@\n  */\n package com.facebook.presto.hive;\n \n+import com.facebook.presto.common.GenericInternalException;\n import com.facebook.presto.common.Page;\n+import com.facebook.presto.common.type.Type;\n import com.facebook.presto.spi.BucketFunction;\n import org.apache.hadoop.hive.serde2.typeinfo.TypeInfo;\n \n import java.util.List;\n+import java.util.Optional;\n import java.util.stream.Collectors;\n \n+import static com.facebook.presto.hive.HiveBucketing.getHiveBucket;\n import static com.google.common.base.MoreObjects.toStringHelper;\n+import static com.google.common.base.Preconditions.checkArgument;\n import static java.util.Objects.requireNonNull;\n \n public class HiveBucketFunction\n         implements BucketFunction\n {\n     private final int bucketCount;\n-    private final List<TypeInfo> typeInfos;\n+    private final Optional<List<TypeInfo>> typeInfos;\n+    private final Optional<List<Type>> types;\n \n-    public HiveBucketFunction(int bucketCount, List<HiveType> hiveTypes)\n+    public HiveBucketFunction(\n+            int bucketCount,\n+            List<HiveType> hiveTypes)\n     {\n+        this(bucketCount, Optional.of(hiveTypes), Optional.empty());\n+    }\n+\n+    public HiveBucketFunction(\n+            int bucketCount,\n+            Optional<List<HiveType>> hiveTypes,\n+            Optional<List<Type>> types)\n+    {\n+        requireNonNull(types, \"hiveType is null\");\n+        this.types = requireNonNull(types, \"type is null\");\n+        checkArgument(hiveTypes.isPresent() || types.isPresent(), \"either hiveTypes or types should be present\");\n         this.bucketCount = bucketCount;\n-        this.typeInfos = requireNonNull(hiveTypes, \"hiveTypes is null\").stream()\n+        this.typeInfos = hiveTypes.map(list -> list.stream()\n                 .map(HiveType::getTypeInfo)\n-                .collect(Collectors.toList());\n+                .collect(Collectors.toList()));", "originalCommit": "a9f0275e084d245e14ea9f9bf6fc629598de5c70", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "57667dcf971abbfa794138a5b1427ee67409f615", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketFunction.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketFunction.java\nindex 1d6aa0b1f5..69526fcfcc 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketFunction.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketFunction.java\n\n@@ -13,7 +13,6 @@\n  */\n package com.facebook.presto.hive;\n \n-import com.facebook.presto.common.GenericInternalException;\n import com.facebook.presto.common.Page;\n import com.facebook.presto.common.type.Type;\n import com.facebook.presto.spi.BucketFunction;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI0NDU4Nw==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r438244587", "bodyText": "They also shouldn't be both present", "author": "arhimondr", "createdAt": "2020-06-10T16:11:04Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketFunction.java", "diffHunk": "@@ -13,34 +13,61 @@\n  */\n package com.facebook.presto.hive;\n \n+import com.facebook.presto.common.GenericInternalException;\n import com.facebook.presto.common.Page;\n+import com.facebook.presto.common.type.Type;\n import com.facebook.presto.spi.BucketFunction;\n import org.apache.hadoop.hive.serde2.typeinfo.TypeInfo;\n \n import java.util.List;\n+import java.util.Optional;\n import java.util.stream.Collectors;\n \n+import static com.facebook.presto.hive.HiveBucketing.getHiveBucket;\n import static com.google.common.base.MoreObjects.toStringHelper;\n+import static com.google.common.base.Preconditions.checkArgument;\n import static java.util.Objects.requireNonNull;\n \n public class HiveBucketFunction\n         implements BucketFunction\n {\n     private final int bucketCount;\n-    private final List<TypeInfo> typeInfos;\n+    private final Optional<List<TypeInfo>> typeInfos;\n+    private final Optional<List<Type>> types;\n \n-    public HiveBucketFunction(int bucketCount, List<HiveType> hiveTypes)\n+    public HiveBucketFunction(\n+            int bucketCount,\n+            List<HiveType> hiveTypes)\n     {\n+        this(bucketCount, Optional.of(hiveTypes), Optional.empty());\n+    }\n+\n+    public HiveBucketFunction(\n+            int bucketCount,\n+            Optional<List<HiveType>> hiveTypes,\n+            Optional<List<Type>> types)\n+    {\n+        requireNonNull(types, \"hiveType is null\");\n+        this.types = requireNonNull(types, \"type is null\");\n+        checkArgument(hiveTypes.isPresent() || types.isPresent(), \"either hiveTypes or types should be present\");", "originalCommit": "a9f0275e084d245e14ea9f9bf6fc629598de5c70", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "57667dcf971abbfa794138a5b1427ee67409f615", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketFunction.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketFunction.java\nindex 1d6aa0b1f5..69526fcfcc 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketFunction.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketFunction.java\n\n@@ -13,7 +13,6 @@\n  */\n package com.facebook.presto.hive;\n \n-import com.facebook.presto.common.GenericInternalException;\n import com.facebook.presto.common.Page;\n import com.facebook.presto.common.type.Type;\n import com.facebook.presto.spi.BucketFunction;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI0NTA5NQ==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r438245095", "bodyText": "VerifyException", "author": "arhimondr", "createdAt": "2020-06-10T16:11:34Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketFunction.java", "diffHunk": "@@ -13,34 +13,61 @@\n  */\n package com.facebook.presto.hive;\n \n+import com.facebook.presto.common.GenericInternalException;\n import com.facebook.presto.common.Page;\n+import com.facebook.presto.common.type.Type;\n import com.facebook.presto.spi.BucketFunction;\n import org.apache.hadoop.hive.serde2.typeinfo.TypeInfo;\n \n import java.util.List;\n+import java.util.Optional;\n import java.util.stream.Collectors;\n \n+import static com.facebook.presto.hive.HiveBucketing.getHiveBucket;\n import static com.google.common.base.MoreObjects.toStringHelper;\n+import static com.google.common.base.Preconditions.checkArgument;\n import static java.util.Objects.requireNonNull;\n \n public class HiveBucketFunction\n         implements BucketFunction\n {\n     private final int bucketCount;\n-    private final List<TypeInfo> typeInfos;\n+    private final Optional<List<TypeInfo>> typeInfos;\n+    private final Optional<List<Type>> types;\n \n-    public HiveBucketFunction(int bucketCount, List<HiveType> hiveTypes)\n+    public HiveBucketFunction(\n+            int bucketCount,\n+            List<HiveType> hiveTypes)\n     {\n+        this(bucketCount, Optional.of(hiveTypes), Optional.empty());\n+    }\n+\n+    public HiveBucketFunction(\n+            int bucketCount,\n+            Optional<List<HiveType>> hiveTypes,\n+            Optional<List<Type>> types)\n+    {\n+        requireNonNull(types, \"hiveType is null\");\n+        this.types = requireNonNull(types, \"type is null\");\n+        checkArgument(hiveTypes.isPresent() || types.isPresent(), \"either hiveTypes or types should be present\");\n         this.bucketCount = bucketCount;\n-        this.typeInfos = requireNonNull(hiveTypes, \"hiveTypes is null\").stream()\n+        this.typeInfos = hiveTypes.map(list -> list.stream()\n                 .map(HiveType::getTypeInfo)\n-                .collect(Collectors.toList());\n+                .collect(Collectors.toList()));\n     }\n \n     @Override\n     public int getBucket(Page page, int position)\n     {\n-        return HiveBucketing.getHiveBucket(bucketCount, typeInfos, page, position);\n+        if (typeInfos.isPresent()) {\n+            return getHiveBucket(bucketCount, typeInfos.get(), page, position);\n+        }\n+        else if (types.isPresent()) {\n+            return HiveBucketing.getBucket(bucketCount, types.get(), page, position);\n+        }\n+        else {\n+            throw new GenericInternalException(\"either hiveTypes or types should be present\");", "originalCommit": "a9f0275e084d245e14ea9f9bf6fc629598de5c70", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "57667dcf971abbfa794138a5b1427ee67409f615", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketFunction.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketFunction.java\nindex 1d6aa0b1f5..69526fcfcc 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketFunction.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketFunction.java\n\n@@ -13,7 +13,6 @@\n  */\n package com.facebook.presto.hive;\n \n-import com.facebook.presto.common.GenericInternalException;\n import com.facebook.presto.common.Page;\n import com.facebook.presto.common.type.Type;\n import com.facebook.presto.spi.BucketFunction;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI0NTcxNg==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r438245716", "bodyText": "This can use partitionChannelTypes", "author": "arhimondr", "createdAt": "2020-06-10T16:12:13Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveNodePartitioningProvider.java", "diffHunk": "@@ -49,8 +49,7 @@ public BucketFunction getBucketFunction(\n             int bucketCount)\n     {\n         HivePartitioningHandle handle = (HivePartitioningHandle) partitioningHandle;\n-        List<HiveType> hiveTypes = handle.getHiveTypes();\n-        return new HiveBucketFunction(bucketCount, hiveTypes);\n+        return new HiveBucketFunction(bucketCount, handle.getHiveTypes(), handle.getTypes());", "originalCommit": "a9f0275e084d245e14ea9f9bf6fc629598de5c70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI3MzQ2NA==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r438273464", "bodyText": "If we use partitionChannelTypes,  it means always usePrestoNativeBucketFunction is true, let's keep the behavior same as before.", "author": "viczhang861", "createdAt": "2020-06-10T16:56:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI0NTcxNg=="}], "type": "inlineReview", "revised_code": {"commit": "57667dcf971abbfa794138a5b1427ee67409f615", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveNodePartitioningProvider.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveNodePartitioningProvider.java\nindex 999b231a19..6049fb74db 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HiveNodePartitioningProvider.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveNodePartitioningProvider.java\n\n@@ -49,7 +51,15 @@ public class HiveNodePartitioningProvider\n             int bucketCount)\n     {\n         HivePartitioningHandle handle = (HivePartitioningHandle) partitioningHandle;\n-        return new HiveBucketFunction(bucketCount, handle.getHiveTypes(), handle.getTypes());\n+        HiveBucketProperty.BucketingType bucketingtype = handle.getBucketingType();\n+        switch (bucketingtype) {\n+            case PRESTOTYPE:\n+                return createPrestoNativeBucketFunction(bucketCount, handle.getTypes().get());\n+            case HIVETYPE:\n+                return createHiveCompatibleBucketFunction(bucketCount, handle.getHiveTypes().get());\n+            default:\n+                throw new IllegalStateException(format(\"Unsupported bucketing type %s\", bucketingtype));\n+        }\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI0NzI2Ng==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r438247266", "bodyText": "Why this change has to be changed?", "author": "arhimondr", "createdAt": "2020-06-10T16:14:21Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/PlanFragmenter.java", "diffHunk": "@@ -644,12 +643,11 @@ private TableScanNode createTemporaryTableScan(\n             TableLayoutResult selectedLayout = metadata.getLayout(session, tableHandle, Constraint.alwaysTrue(), Optional.of(outputColumnHandles));\n             verify(selectedLayout.getUnenforcedConstraint().equals(TupleDomain.all()), \"temporary table layout shouldn't enforce any constraints\");\n             verify(!selectedLayout.getLayout().getColumns().isPresent(), \"temporary table layout must provide all the columns\");\n-            TablePartitioning expectedPartitioning = new TablePartitioning(\n-                    expectedPartitioningMetadata.getPartitioningHandle(),\n-                    expectedPartitioningMetadata.getPartitionColumns().stream()\n-                            .map(columnHandles::get)\n-                            .collect(toImmutableList()));\n-            verify(selectedLayout.getLayout().getTablePartitioning().equals(Optional.of(expectedPartitioning)), \"invalid temporary table partitioning\");\n+            List<ColumnHandle> expectedPartitioningColumns = expectedPartitioningMetadata.getPartitionColumns().stream()\n+                    .map(columnHandles::get)\n+                    .collect(toImmutableList());\n+            verify(selectedLayout.getLayout().getTablePartitioning().get().getPartitioningColumns()", "originalCommit": "a9f0275e084d245e14ea9f9bf6fc629598de5c70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI4NTQ2NQ==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r438285465", "bodyText": "In HiveMetadata::getPartitioningHandleForExchange(ConnectorSession session, int partitionCount, List<Type> partitionTypes),  I think we rewrite HivePartitioningHandle to use Type instead of TypeInfo", "author": "viczhang861", "createdAt": "2020-06-10T17:17:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI0NzI2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "57667dcf971abbfa794138a5b1427ee67409f615", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/sql/planner/PlanFragmenter.java b/presto-main/src/main/java/com/facebook/presto/sql/planner/PlanFragmenter.java\nindex fda4d60441..c566b6589b 100644\n--- a/presto-main/src/main/java/com/facebook/presto/sql/planner/PlanFragmenter.java\n+++ b/presto-main/src/main/java/com/facebook/presto/sql/planner/PlanFragmenter.java\n\n@@ -643,11 +644,12 @@ public class PlanFragmenter\n             TableLayoutResult selectedLayout = metadata.getLayout(session, tableHandle, Constraint.alwaysTrue(), Optional.of(outputColumnHandles));\n             verify(selectedLayout.getUnenforcedConstraint().equals(TupleDomain.all()), \"temporary table layout shouldn't enforce any constraints\");\n             verify(!selectedLayout.getLayout().getColumns().isPresent(), \"temporary table layout must provide all the columns\");\n-            List<ColumnHandle> expectedPartitioningColumns = expectedPartitioningMetadata.getPartitionColumns().stream()\n-                    .map(columnHandles::get)\n-                    .collect(toImmutableList());\n-            verify(selectedLayout.getLayout().getTablePartitioning().get().getPartitioningColumns()\n-                    .equals(expectedPartitioningColumns), \"invalid temporary table partition columns\");\n+            TablePartitioning expectedPartitioning = new TablePartitioning(\n+                    expectedPartitioningMetadata.getPartitioningHandle(),\n+                    expectedPartitioningMetadata.getPartitionColumns().stream()\n+                            .map(columnHandles::get)\n+                            .collect(toImmutableList()));\n+            verify(selectedLayout.getLayout().getTablePartitioning().equals(Optional.of(expectedPartitioning)), \"invalid temporary table partitioning\");\n \n             Map<VariableReferenceExpression, ColumnHandle> assignments = outputVariables.stream()\n                     .collect(toImmutableMap(identity(), variable -> columnHandles.get(outputColumns.get(variable).getName())));\n"}}, {"oid": "57667dcf971abbfa794138a5b1427ee67409f615", "url": "https://github.com/prestodb/presto/commit/57667dcf971abbfa794138a5b1427ee67409f615", "message": "Support all types for hive temporary table bucketing", "committedDate": "2020-06-12T02:46:16Z", "type": "forcePushed"}, {"oid": "8f32be3d86121c7a7380503c8444d80dc5d250b3", "url": "https://github.com/prestodb/presto/commit/8f32be3d86121c7a7380503c8444d80dc5d250b3", "message": "Support all types for hive temporary table bucketing", "committedDate": "2020-06-12T08:20:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU0NTc1Ng==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r439545756", "bodyText": "Let's accept BucketingType as a parameter and check if types or hiveTypes are present based on the BucketingType.", "author": "arhimondr", "createdAt": "2020-06-12T17:16:20Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java", "diffHunk": "@@ -13,33 +13,65 @@\n  */\n package com.facebook.presto.hive;\n \n+import com.facebook.presto.common.type.Type;\n import com.facebook.presto.spi.connector.ConnectorPartitioningHandle;\n import com.fasterxml.jackson.annotation.JsonCreator;\n import com.fasterxml.jackson.annotation.JsonProperty;\n \n import java.util.List;\n import java.util.Objects;\n+import java.util.Optional;\n import java.util.OptionalInt;\n \n+import static com.facebook.presto.hive.HiveBucketProperty.BucketingType.HIVETYPE;\n+import static com.facebook.presto.hive.HiveBucketProperty.BucketingType.PRESTOTYPE;\n+import static com.google.common.base.Preconditions.checkArgument;\n import static java.lang.String.format;\n import static java.util.Objects.requireNonNull;\n \n public class HivePartitioningHandle\n         implements ConnectorPartitioningHandle\n {\n     private final int bucketCount;\n-    private final List<HiveType> hiveTypes;\n+    private final Optional<List<HiveType>> hiveTypes;\n+    private final Optional<List<Type>> types;\n     private final OptionalInt maxCompatibleBucketCount;\n+    private final HiveBucketProperty.BucketingType bucketingType;\n \n+    public static HivePartitioningHandle createPartitioningHandleWithHiveType(\n+            int bucketCount,\n+            List<HiveType> hiveTypes,\n+            OptionalInt maxCompatibleBucketCount)\n+    {\n+        return new HivePartitioningHandle(bucketCount, maxCompatibleBucketCount, Optional.of(hiveTypes), Optional.empty());\n+    }\n+\n+    public static HivePartitioningHandle createPartitioningHandleWithPrestoType(\n+            int bucketCount,\n+            List<Type> types,\n+            OptionalInt maxCompatibleBucketCount)\n+    {\n+        return new HivePartitioningHandle(bucketCount, maxCompatibleBucketCount, Optional.empty(), Optional.of(types));\n+    }\n+\n+    /**\n+     *  for json serialization only, don't use this method to create HivePartitioningHandle\n+     */\n     @JsonCreator\n     public HivePartitioningHandle(\n             @JsonProperty(\"bucketCount\") int bucketCount,\n-            @JsonProperty(\"hiveTypes\") List<HiveType> hiveTypes,\n-            @JsonProperty(\"maxCompatibleBucketCount\") OptionalInt maxCompatibleBucketCount)\n+            @JsonProperty(\"maxCompatibleBucketCount\") OptionalInt maxCompatibleBucketCount,\n+            @JsonProperty(\"hiveTypes\") Optional<List<HiveType>> hiveTypes,\n+            @JsonProperty(\"types\") Optional<List<Type>> types)", "originalCommit": "8f32be3d86121c7a7380503c8444d80dc5d250b3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "008ba566b6a25dbf83bc8161377af21caacff23c", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java b/presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java\nindex 06a7330db9..63387b7da2 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java\n\n@@ -23,8 +23,6 @@ import java.util.Objects;\n import java.util.Optional;\n import java.util.OptionalInt;\n \n-import static com.facebook.presto.hive.HiveBucketProperty.BucketingType.HIVETYPE;\n-import static com.facebook.presto.hive.HiveBucketProperty.BucketingType.PRESTOTYPE;\n import static com.google.common.base.Preconditions.checkArgument;\n import static java.lang.String.format;\n import static java.util.Objects.requireNonNull;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU0NjA2NA==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r439546064", "bodyText": "How about createHiveCompatiblePartitioningHandle", "author": "arhimondr", "createdAt": "2020-06-12T17:16:59Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java", "diffHunk": "@@ -13,33 +13,65 @@\n  */\n package com.facebook.presto.hive;\n \n+import com.facebook.presto.common.type.Type;\n import com.facebook.presto.spi.connector.ConnectorPartitioningHandle;\n import com.fasterxml.jackson.annotation.JsonCreator;\n import com.fasterxml.jackson.annotation.JsonProperty;\n \n import java.util.List;\n import java.util.Objects;\n+import java.util.Optional;\n import java.util.OptionalInt;\n \n+import static com.facebook.presto.hive.HiveBucketProperty.BucketingType.HIVETYPE;\n+import static com.facebook.presto.hive.HiveBucketProperty.BucketingType.PRESTOTYPE;\n+import static com.google.common.base.Preconditions.checkArgument;\n import static java.lang.String.format;\n import static java.util.Objects.requireNonNull;\n \n public class HivePartitioningHandle\n         implements ConnectorPartitioningHandle\n {\n     private final int bucketCount;\n-    private final List<HiveType> hiveTypes;\n+    private final Optional<List<HiveType>> hiveTypes;\n+    private final Optional<List<Type>> types;\n     private final OptionalInt maxCompatibleBucketCount;\n+    private final HiveBucketProperty.BucketingType bucketingType;\n \n+    public static HivePartitioningHandle createPartitioningHandleWithHiveType(", "originalCommit": "8f32be3d86121c7a7380503c8444d80dc5d250b3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "008ba566b6a25dbf83bc8161377af21caacff23c", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java b/presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java\nindex 06a7330db9..63387b7da2 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java\n\n@@ -23,8 +23,6 @@ import java.util.Objects;\n import java.util.Optional;\n import java.util.OptionalInt;\n \n-import static com.facebook.presto.hive.HiveBucketProperty.BucketingType.HIVETYPE;\n-import static com.facebook.presto.hive.HiveBucketProperty.BucketingType.PRESTOTYPE;\n import static com.google.common.base.Preconditions.checkArgument;\n import static java.lang.String.format;\n import static java.util.Objects.requireNonNull;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU0NjI1Mw==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r439546253", "bodyText": "createPrestoNativePartitioningHandle", "author": "arhimondr", "createdAt": "2020-06-12T17:17:20Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java", "diffHunk": "@@ -13,33 +13,65 @@\n  */\n package com.facebook.presto.hive;\n \n+import com.facebook.presto.common.type.Type;\n import com.facebook.presto.spi.connector.ConnectorPartitioningHandle;\n import com.fasterxml.jackson.annotation.JsonCreator;\n import com.fasterxml.jackson.annotation.JsonProperty;\n \n import java.util.List;\n import java.util.Objects;\n+import java.util.Optional;\n import java.util.OptionalInt;\n \n+import static com.facebook.presto.hive.HiveBucketProperty.BucketingType.HIVETYPE;\n+import static com.facebook.presto.hive.HiveBucketProperty.BucketingType.PRESTOTYPE;\n+import static com.google.common.base.Preconditions.checkArgument;\n import static java.lang.String.format;\n import static java.util.Objects.requireNonNull;\n \n public class HivePartitioningHandle\n         implements ConnectorPartitioningHandle\n {\n     private final int bucketCount;\n-    private final List<HiveType> hiveTypes;\n+    private final Optional<List<HiveType>> hiveTypes;\n+    private final Optional<List<Type>> types;\n     private final OptionalInt maxCompatibleBucketCount;\n+    private final HiveBucketProperty.BucketingType bucketingType;\n \n+    public static HivePartitioningHandle createPartitioningHandleWithHiveType(\n+            int bucketCount,\n+            List<HiveType> hiveTypes,\n+            OptionalInt maxCompatibleBucketCount)\n+    {\n+        return new HivePartitioningHandle(bucketCount, maxCompatibleBucketCount, Optional.of(hiveTypes), Optional.empty());\n+    }\n+\n+    public static HivePartitioningHandle createPartitioningHandleWithPrestoType(", "originalCommit": "8f32be3d86121c7a7380503c8444d80dc5d250b3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "008ba566b6a25dbf83bc8161377af21caacff23c", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java b/presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java\nindex 06a7330db9..63387b7da2 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java\n\n@@ -23,8 +23,6 @@ import java.util.Objects;\n import java.util.Optional;\n import java.util.OptionalInt;\n \n-import static com.facebook.presto.hive.HiveBucketProperty.BucketingType.HIVETYPE;\n-import static com.facebook.presto.hive.HiveBucketProperty.BucketingType.PRESTOTYPE;\n import static com.google.common.base.Preconditions.checkArgument;\n import static java.lang.String.format;\n import static java.util.Objects.requireNonNull;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU0NjcwMg==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r439546702", "bodyText": "Let's extract BucketingType into a standalone class. Let's call it BucketFunctionType.", "author": "arhimondr", "createdAt": "2020-06-12T17:18:16Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java", "diffHunk": "@@ -49,21 +81,33 @@ public int getBucketCount()\n     }\n \n     @JsonProperty\n-    public List<HiveType> getHiveTypes()\n+    public Optional<List<HiveType>> getHiveTypes()\n     {\n         return hiveTypes;\n     }\n \n+    @JsonProperty\n+    public Optional<List<Type>> getTypes()\n+    {\n+        return types;\n+    }\n+\n     @JsonProperty\n     public OptionalInt getMaxCompatibleBucketCount()\n     {\n         return maxCompatibleBucketCount;\n     }\n \n+    @JsonProperty\n+    public HiveBucketProperty.BucketingType getBucketingType()", "originalCommit": "8f32be3d86121c7a7380503c8444d80dc5d250b3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "008ba566b6a25dbf83bc8161377af21caacff23c", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java b/presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java\nindex 06a7330db9..63387b7da2 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java\n\n@@ -99,15 +108,19 @@ public class HivePartitioningHandle\n     }\n \n     @JsonProperty\n-    public HiveBucketProperty.BucketingType getBucketingType()\n+    public BucketFunctionType getBucketFunctionType()\n     {\n-        return bucketingType;\n+        return bucketFunctionType;\n     }\n \n     @Override\n     public String toString()\n     {\n-        return format(\"buckets=%s, hiveTypes=%s, types=%s, bucketingType=%s\", bucketCount, hiveTypes, types, bucketingType);\n+        return format(\n+                \"buckets=%s,\" + \"bucketFunctionType=%s,\" + \"types=%s\",\n+                bucketCount,\n+                bucketFunctionType,\n+                bucketFunctionType.equals(BucketFunctionType.HIVE_COMPATIBLE) ? hiveTypes.get() : types.get());\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU0NzU4Mg==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r439547582", "bodyText": "This is what is printed in the plan. In a current form it might be a little hard to read. How about we merge hiveTypes and types and print only one?\ne.g.:\nformat(\"bucketFunctionType=%s, buckets=%s, types=%s\", bucketingType, bucketCount, hiveTypes or types);", "author": "arhimondr", "createdAt": "2020-06-12T17:20:12Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java", "diffHunk": "@@ -49,21 +81,33 @@ public int getBucketCount()\n     }\n \n     @JsonProperty\n-    public List<HiveType> getHiveTypes()\n+    public Optional<List<HiveType>> getHiveTypes()\n     {\n         return hiveTypes;\n     }\n \n+    @JsonProperty\n+    public Optional<List<Type>> getTypes()\n+    {\n+        return types;\n+    }\n+\n     @JsonProperty\n     public OptionalInt getMaxCompatibleBucketCount()\n     {\n         return maxCompatibleBucketCount;\n     }\n \n+    @JsonProperty\n+    public HiveBucketProperty.BucketingType getBucketingType()\n+    {\n+        return bucketingType;\n+    }\n+\n     @Override\n     public String toString()\n     {\n-        return format(\"buckets=%s, hiveTypes=%s\", bucketCount, hiveTypes);\n+        return format(\"buckets=%s, hiveTypes=%s, types=%s, bucketingType=%s\", bucketCount, hiveTypes, types, bucketingType);", "originalCommit": "8f32be3d86121c7a7380503c8444d80dc5d250b3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "008ba566b6a25dbf83bc8161377af21caacff23c", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java b/presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java\nindex 06a7330db9..63387b7da2 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java\n\n@@ -99,15 +108,19 @@ public class HivePartitioningHandle\n     }\n \n     @JsonProperty\n-    public HiveBucketProperty.BucketingType getBucketingType()\n+    public BucketFunctionType getBucketFunctionType()\n     {\n-        return bucketingType;\n+        return bucketFunctionType;\n     }\n \n     @Override\n     public String toString()\n     {\n-        return format(\"buckets=%s, hiveTypes=%s, types=%s, bucketingType=%s\", bucketCount, hiveTypes, types, bucketingType);\n+        return format(\n+                \"buckets=%s,\" + \"bucketFunctionType=%s,\" + \"types=%s\",\n+                bucketCount,\n+                bucketFunctionType,\n+                bucketFunctionType.equals(BucketFunctionType.HIVE_COMPATIBLE) ? hiveTypes.get() : types.get());\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU0OTU1Nw==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r439549557", "bodyText": "Why do we have to create Hive compatible partitioning if partitionTypes is empty?", "author": "arhimondr", "createdAt": "2020-06-12T17:24:19Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -2217,14 +2240,12 @@ public ConnectorTableLayoutHandle getAlternativeLayoutHandle(ConnectorSession se\n     @Override\n     public ConnectorPartitioningHandle getPartitioningHandleForExchange(ConnectorSession session, int partitionCount, List<Type> partitionTypes)\n     {\n-        return new HivePartitioningHandle(\n-                partitionCount,\n-                partitionTypes.stream()\n-                        .map(type -> toHiveType(\n-                                typeTranslator,\n-                                translateHiveUnsupportedTypeForTemporaryTable(type, typeManager)))\n-                        .collect(toImmutableList()),\n-                OptionalInt.empty());\n+        if (!partitionTypes.isEmpty()) {\n+            return createPartitioningHandleWithPrestoType(partitionCount, partitionTypes, OptionalInt.empty());\n+        }\n+        else {\n+            return createPartitioningHandleWithHiveType(partitionCount, ImmutableList.of(), OptionalInt.empty());", "originalCommit": "8f32be3d86121c7a7380503c8444d80dc5d250b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYwMTI0OQ==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r439601249", "bodyText": "It doesn't matter which one to use when partition column is empty,  let me use Presto Native to make code simple.", "author": "viczhang861", "createdAt": "2020-06-12T19:19:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU0OTU1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "008ba566b6a25dbf83bc8161377af21caacff23c", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\nindex 36ce4bb6b5..bda19ac95d 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n\n@@ -2240,12 +2266,7 @@ public class HiveMetadata\n     @Override\n     public ConnectorPartitioningHandle getPartitioningHandleForExchange(ConnectorSession session, int partitionCount, List<Type> partitionTypes)\n     {\n-        if (!partitionTypes.isEmpty()) {\n-            return createPartitioningHandleWithPrestoType(partitionCount, partitionTypes, OptionalInt.empty());\n-        }\n-        else {\n-            return createPartitioningHandleWithHiveType(partitionCount, ImmutableList.of(), OptionalInt.empty());\n-        }\n+        return createPrestoNativePartitioningHandle(partitionCount, partitionTypes, OptionalInt.empty());\n     }\n \n     @VisibleForTesting\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU1MDc2NA==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r439550764", "bodyText": "Let's keep it compatible with native partitioning handle as well.\nPlease check if the partitioning handle type is the same and if the column types are the same as well.  Also it looks like it makes sense to keep the constructor public, so it is easier to change the maxCompatibleBucketCount without performing extra logic.", "author": "arhimondr", "createdAt": "2020-06-12T17:26:37Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -2142,9 +2165,9 @@ public ConnectorTableLayout getTableLayout(ConnectorSession session, ConnectorTa\n             return Optional.empty();\n         }\n \n-        return Optional.of(new HivePartitioningHandle(\n+        return Optional.of(createPartitioningHandleWithHiveType(", "originalCommit": "8f32be3d86121c7a7380503c8444d80dc5d250b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYwMDY4OA==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r439600688", "bodyText": "Good point, I forget to check column types consistency. This method is marked as deprecated but I think the code is still in use, right?", "author": "viczhang861", "createdAt": "2020-06-12T19:17:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU1MDc2NA=="}], "type": "inlineReview", "revised_code": {"commit": "008ba566b6a25dbf83bc8161377af21caacff23c", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\nindex 36ce4bb6b5..bda19ac95d 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n\n@@ -2165,10 +2174,21 @@ public class HiveMetadata\n             return Optional.empty();\n         }\n \n-        return Optional.of(createPartitioningHandleWithHiveType(\n-                smallerBucketCount,\n-                leftHandle.getHiveTypes().get(),\n-                maxCompatibleBucketCount));\n+        BucketFunctionType bucketFunctionType = leftHandle.getBucketFunctionType();\n+        switch (bucketFunctionType) {\n+            case HIVE_COMPATIBLE:\n+                return Optional.of(createHiveCompatiblePartitioningHandle(\n+                        smallerBucketCount,\n+                        leftHandle.getHiveTypes().get(),\n+                        maxCompatibleBucketCount));\n+            case PRESTO_NATIVE:\n+                return Optional.of(createPrestoNativePartitioningHandle(\n+                        smallerBucketCount,\n+                        leftHandle.getTypes().get(),\n+                        maxCompatibleBucketCount));\n+            default:\n+                throw new IllegalStateException(\"Unsupported bucket function type \" + bucketFunctionType);\n+        }\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU1MTA2OQ==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r439551069", "bodyText": "Same comments as for getCommonPartitioningHandle.", "author": "arhimondr", "createdAt": "2020-06-12T17:27:12Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -2188,7 +2211,7 @@ public ConnectorTableLayoutHandle getAlternativeLayoutHandle(ConnectorSession se\n         HiveBucketHandle bucketHandle = hiveLayoutHandle.getBucketHandle().get();\n         ImmutableList<HiveType> bucketTypes = bucketHandle.getColumns().stream().map(HiveColumnHandle::getHiveType).collect(toImmutableList());\n         checkArgument(\n-                hivePartitioningHandle.getHiveTypes().equals(bucketTypes),\n+                hivePartitioningHandle.getHiveTypes().get().equals(bucketTypes),", "originalCommit": "8f32be3d86121c7a7380503c8444d80dc5d250b3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "008ba566b6a25dbf83bc8161377af21caacff23c", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\nindex 36ce4bb6b5..bda19ac95d 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n\n@@ -2210,10 +2231,15 @@ public class HiveMetadata\n         checkArgument(hiveLayoutHandle.getBucketHandle().isPresent(), \"Hive connector only provides alternative layout for bucketed table\");\n         HiveBucketHandle bucketHandle = hiveLayoutHandle.getBucketHandle().get();\n         ImmutableList<HiveType> bucketTypes = bucketHandle.getColumns().stream().map(HiveColumnHandle::getHiveType).collect(toImmutableList());\n+        Optional<List<HiveType>> hiveTypes = hivePartitioningHandle.getHiveTypes();\n+        checkArgument(\n+                hivePartitioningHandle.getBucketFunctionType().equals(HIVE_COMPATIBLE) &&\n+                        hiveTypes.isPresent(),\n+                \"partitionColumns in HiveTableLayoutHandle must use a hive compatible bucket function\");\n         checkArgument(\n-                hivePartitioningHandle.getHiveTypes().get().equals(bucketTypes),\n+                hiveTypes.get().equals(bucketTypes),\n                 \"Types from the new PartitioningHandle (%s) does not match the TableLayoutHandle (%s)\",\n-                hivePartitioningHandle.getHiveTypes(),\n+                hiveTypes.get(),\n                 bucketTypes);\n         int largerBucketCount = Math.max(bucketHandle.getTableBucketCount(), hivePartitioningHandle.getBucketCount());\n         int smallerBucketCount = Math.min(bucketHandle.getTableBucketCount(), hivePartitioningHandle.getBucketCount());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU1MjIzNQ==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r439552235", "bodyText": "We never directly create temporary table. We always insert. Why the change to the getNewTableLayout is needed?", "author": "arhimondr", "createdAt": "2020-06-12T17:29:40Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -2355,17 +2376,33 @@ private static Domain buildColumnDomain(ColumnHandle column, List<HivePartition>\n             throw new PrestoException(NOT_SUPPORTED, \"Writing to bucketed sorted Hive tables is disabled\");\n         }\n \n+        HivePartitioningHandle hivePartitioningHandle;\n         List<String> bucketedBy = bucketProperty.get().getBucketedBy();\n-        Map<String, HiveType> hiveTypeMap = tableMetadata.getColumns().stream()\n-                .collect(toMap(ColumnMetadata::getName, column -> toHiveType(typeTranslator, column.getType())));\n-        return Optional.of(new ConnectorNewTableLayout(\n-                new HivePartitioningHandle(\n+\n+        HiveBucketProperty.BucketingType bucketingType = bucketProperty.get().getBucketingType();", "originalCommit": "8f32be3d86121c7a7380503c8444d80dc5d250b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYwNDU1OQ==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r439604559", "bodyText": "Then this is not needed, will remove.", "author": "viczhang861", "createdAt": "2020-06-12T19:27:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU1MjIzNQ=="}], "type": "inlineReview", "revised_code": {"commit": "008ba566b6a25dbf83bc8161377af21caacff23c", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\nindex 36ce4bb6b5..bda19ac95d 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n\n@@ -2372,37 +2393,23 @@ public class HiveMetadata\n         if (!bucketProperty.isPresent()) {\n             return Optional.empty();\n         }\n+        checkArgument(bucketProperty.get().getBucketFunctionType().equals(BucketFunctionType.HIVE_COMPATIBLE), \"Must be hive compatible bucket function type\");\n         if (!bucketProperty.get().getSortedBy().isEmpty() && !isSortedWritingEnabled(session)) {\n             throw new PrestoException(NOT_SUPPORTED, \"Writing to bucketed sorted Hive tables is disabled\");\n         }\n \n-        HivePartitioningHandle hivePartitioningHandle;\n         List<String> bucketedBy = bucketProperty.get().getBucketedBy();\n+        Map<String, HiveType> hiveTypeMap = tableMetadata.getColumns().stream()\n+                .collect(toMap(ColumnMetadata::getName, column -> toHiveType(typeTranslator, column.getType())));\n \n-        HiveBucketProperty.BucketingType bucketingType = bucketProperty.get().getBucketingType();\n-        OptionalInt maxCompatibleBucketCount = OptionalInt.of(bucketProperty.get().getBucketCount());\n-        switch (bucketingType) {\n-            case HIVETYPE:\n-                Map<String, HiveType> hiveTypeMap = tableMetadata.getColumns().stream()\n-                        .collect(toMap(ColumnMetadata::getName, column -> toHiveType(typeTranslator, column.getType())));\n-                hivePartitioningHandle = createPartitioningHandleWithHiveType(\n+        return Optional.of(new ConnectorNewTableLayout(\n+                createHiveCompatiblePartitioningHandle(\n                         bucketProperty.get().getBucketCount(),\n                         bucketedBy.stream()\n                                 .map(hiveTypeMap::get)\n                                 .collect(toImmutableList()),\n-                        maxCompatibleBucketCount);\n-                break;\n-            case PRESTOTYPE:\n-                hivePartitioningHandle = createPartitioningHandleWithPrestoType(\n-                        bucketProperty.get().getBucketCount(),\n-                        bucketProperty.get().getTypes().get(),\n-                        maxCompatibleBucketCount);\n-                break;\n-            default:\n-                throw new IllegalStateException(format(\"Unsupported bucketing type %s\", bucketingType));\n-        }\n-\n-        return Optional.of(new ConnectorNewTableLayout(hivePartitioningHandle, bucketedBy));\n+                        OptionalInt.of(bucketProperty.get().getBucketCount())),\n+                bucketedBy));\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU1MzE1Nw==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r439553157", "bodyText": "IllegalArgumentException", "author": "arhimondr", "createdAt": "2020-06-12T17:31:19Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveNodePartitioningProvider.java", "diffHunk": "@@ -49,8 +51,15 @@ public BucketFunction getBucketFunction(\n             int bucketCount)\n     {\n         HivePartitioningHandle handle = (HivePartitioningHandle) partitioningHandle;\n-        List<HiveType> hiveTypes = handle.getHiveTypes();\n-        return new HiveBucketFunction(bucketCount, hiveTypes);\n+        HiveBucketProperty.BucketingType bucketingtype = handle.getBucketingType();\n+        switch (bucketingtype) {\n+            case PRESTOTYPE:\n+                return createPrestoNativeBucketFunction(bucketCount, handle.getTypes().get());\n+            case HIVETYPE:\n+                return createHiveCompatibleBucketFunction(bucketCount, handle.getHiveTypes().get());\n+            default:\n+                throw new IllegalStateException(format(\"Unsupported bucketing type %s\", bucketingtype));", "originalCommit": "8f32be3d86121c7a7380503c8444d80dc5d250b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU1MzI5NA==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r439553294", "bodyText": "\"Unsupported bucketing type \" + bucketingtype", "author": "arhimondr", "createdAt": "2020-06-12T17:31:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU1MzE1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYwNjE0NA==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r439606144", "bodyText": "IllegalStateException makes more sense:  HivePartitioningHandle has an invalid BucketFunctionType", "author": "viczhang861", "createdAt": "2020-06-12T19:30:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU1MzE1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "008ba566b6a25dbf83bc8161377af21caacff23c", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveNodePartitioningProvider.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveNodePartitioningProvider.java\nindex 6049fb74db..d9c7abb62e 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HiveNodePartitioningProvider.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveNodePartitioningProvider.java\n\n@@ -51,14 +51,14 @@ public class HiveNodePartitioningProvider\n             int bucketCount)\n     {\n         HivePartitioningHandle handle = (HivePartitioningHandle) partitioningHandle;\n-        HiveBucketProperty.BucketingType bucketingtype = handle.getBucketingType();\n-        switch (bucketingtype) {\n-            case PRESTOTYPE:\n-                return createPrestoNativeBucketFunction(bucketCount, handle.getTypes().get());\n-            case HIVETYPE:\n+        BucketFunctionType bucketFunctionType = handle.getBucketFunctionType();\n+        switch (bucketFunctionType) {\n+            case HIVE_COMPATIBLE:\n                 return createHiveCompatibleBucketFunction(bucketCount, handle.getHiveTypes().get());\n+            case PRESTO_NATIVE:\n+                return createPrestoNativeBucketFunction(bucketCount, handle.getTypes().get());\n             default:\n-                throw new IllegalStateException(format(\"Unsupported bucketing type %s\", bucketingtype));\n+                throw new IllegalStateException(\"Unsupported bucket function type \" + bucketFunctionType);\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU1NDEyOA==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r439554128", "bodyText": "Let's set it explicitly as a constructor parameter. Lets check if the types is set if the bucketingType is prestonative", "author": "arhimondr", "createdAt": "2020-06-12T17:33:21Z", "path": "presto-hive-metastore/src/main/java/com/facebook/presto/hive/HiveBucketProperty.java", "diffHunk": "@@ -34,16 +36,42 @@\n     private final List<String> bucketedBy;\n     private final int bucketCount;\n     private final List<SortingColumn> sortedBy;\n+    private final Optional<List<Type>> types;\n+    private final BucketingType bucketingType;\n+\n+    public HiveBucketProperty(\n+            List<String> bucketedBy,\n+            int bucketCount,\n+            List<SortingColumn> sortedBy)\n+    {\n+        this(bucketedBy, bucketCount, sortedBy, Optional.empty());\n+    }\n \n     @JsonCreator\n     public HiveBucketProperty(\n             @JsonProperty(\"bucketedBy\") List<String> bucketedBy,\n             @JsonProperty(\"bucketCount\") int bucketCount,\n-            @JsonProperty(\"sortedBy\") List<SortingColumn> sortedBy)\n+            @JsonProperty(\"sortedBy\") List<SortingColumn> sortedBy,\n+            @JsonProperty(\"types\") Optional<List<Type>> types)\n     {\n         this.bucketedBy = ImmutableList.copyOf(requireNonNull(bucketedBy, \"bucketedBy is null\"));\n         this.bucketCount = bucketCount;\n         this.sortedBy = ImmutableList.copyOf(requireNonNull(sortedBy, \"sortedBy is null\"));\n+        this.types = requireNonNull(types, \"type is null\");\n+        if (types.isPresent()) {", "originalCommit": "8f32be3d86121c7a7380503c8444d80dc5d250b3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "008ba566b6a25dbf83bc8161377af21caacff23c", "chunk": "diff --git a/presto-hive-metastore/src/main/java/com/facebook/presto/hive/HiveBucketProperty.java b/presto-hive-metastore/src/main/java/com/facebook/presto/hive/HiveBucketProperty.java\nindex aa9bd03363..aabf818b7c 100644\n--- a/presto-hive-metastore/src/main/java/com/facebook/presto/hive/HiveBucketProperty.java\n+++ b/presto-hive-metastore/src/main/java/com/facebook/presto/hive/HiveBucketProperty.java\n\n@@ -36,15 +38,15 @@ public class HiveBucketProperty\n     private final List<String> bucketedBy;\n     private final int bucketCount;\n     private final List<SortingColumn> sortedBy;\n+    private final BucketFunctionType bucketFunctionType;\n     private final Optional<List<Type>> types;\n-    private final BucketingType bucketingType;\n \n     public HiveBucketProperty(\n             List<String> bucketedBy,\n             int bucketCount,\n             List<SortingColumn> sortedBy)\n     {\n-        this(bucketedBy, bucketCount, sortedBy, Optional.empty());\n+        this(bucketedBy, bucketCount, sortedBy, HIVE_COMPATIBLE, Optional.empty());\n     }\n \n     @JsonCreator\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU1NDQ3OA==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r439554478", "bodyText": "Let's extract it as a standalone class. Let's call it BucketFunctionType", "author": "arhimondr", "createdAt": "2020-06-12T17:34:06Z", "path": "presto-hive-metastore/src/main/java/com/facebook/presto/hive/HiveBucketProperty.java", "diffHunk": "@@ -34,16 +36,42 @@\n     private final List<String> bucketedBy;\n     private final int bucketCount;\n     private final List<SortingColumn> sortedBy;\n+    private final Optional<List<Type>> types;\n+    private final BucketingType bucketingType;\n+\n+    public HiveBucketProperty(\n+            List<String> bucketedBy,\n+            int bucketCount,\n+            List<SortingColumn> sortedBy)\n+    {\n+        this(bucketedBy, bucketCount, sortedBy, Optional.empty());\n+    }\n \n     @JsonCreator\n     public HiveBucketProperty(\n             @JsonProperty(\"bucketedBy\") List<String> bucketedBy,\n             @JsonProperty(\"bucketCount\") int bucketCount,\n-            @JsonProperty(\"sortedBy\") List<SortingColumn> sortedBy)\n+            @JsonProperty(\"sortedBy\") List<SortingColumn> sortedBy,\n+            @JsonProperty(\"types\") Optional<List<Type>> types)\n     {\n         this.bucketedBy = ImmutableList.copyOf(requireNonNull(bucketedBy, \"bucketedBy is null\"));\n         this.bucketCount = bucketCount;\n         this.sortedBy = ImmutableList.copyOf(requireNonNull(sortedBy, \"sortedBy is null\"));\n+        this.types = requireNonNull(types, \"type is null\");\n+        if (types.isPresent()) {\n+            bucketingType = BucketingType.PRESTOTYPE;\n+            checkArgument(types.get().size() > 0, \"types can not be empty if present\");\n+            checkArgument(types.get().size() == bucketedBy.size(), \"the sizes of bucketedBy and types should match\");\n+        }\n+        else {\n+            bucketingType = BucketingType.HIVETYPE;\n+        }\n+    }\n+\n+    public enum BucketingType", "originalCommit": "8f32be3d86121c7a7380503c8444d80dc5d250b3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "008ba566b6a25dbf83bc8161377af21caacff23c", "chunk": "diff --git a/presto-hive-metastore/src/main/java/com/facebook/presto/hive/HiveBucketProperty.java b/presto-hive-metastore/src/main/java/com/facebook/presto/hive/HiveBucketProperty.java\nindex aa9bd03363..aabf818b7c 100644\n--- a/presto-hive-metastore/src/main/java/com/facebook/presto/hive/HiveBucketProperty.java\n+++ b/presto-hive-metastore/src/main/java/com/facebook/presto/hive/HiveBucketProperty.java\n\n@@ -36,15 +38,15 @@ public class HiveBucketProperty\n     private final List<String> bucketedBy;\n     private final int bucketCount;\n     private final List<SortingColumn> sortedBy;\n+    private final BucketFunctionType bucketFunctionType;\n     private final Optional<List<Type>> types;\n-    private final BucketingType bucketingType;\n \n     public HiveBucketProperty(\n             List<String> bucketedBy,\n             int bucketCount,\n             List<SortingColumn> sortedBy)\n     {\n-        this(bucketedBy, bucketCount, sortedBy, Optional.empty());\n+        this(bucketedBy, bucketCount, sortedBy, HIVE_COMPATIBLE, Optional.empty());\n     }\n \n     @JsonCreator\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU1NDU4NQ==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r439554585", "bodyText": "HIVE_COMPATIBLE, PRESTO_NATIVE", "author": "arhimondr", "createdAt": "2020-06-12T17:34:20Z", "path": "presto-hive-metastore/src/main/java/com/facebook/presto/hive/HiveBucketProperty.java", "diffHunk": "@@ -34,16 +36,42 @@\n     private final List<String> bucketedBy;\n     private final int bucketCount;\n     private final List<SortingColumn> sortedBy;\n+    private final Optional<List<Type>> types;\n+    private final BucketingType bucketingType;\n+\n+    public HiveBucketProperty(\n+            List<String> bucketedBy,\n+            int bucketCount,\n+            List<SortingColumn> sortedBy)\n+    {\n+        this(bucketedBy, bucketCount, sortedBy, Optional.empty());\n+    }\n \n     @JsonCreator\n     public HiveBucketProperty(\n             @JsonProperty(\"bucketedBy\") List<String> bucketedBy,\n             @JsonProperty(\"bucketCount\") int bucketCount,\n-            @JsonProperty(\"sortedBy\") List<SortingColumn> sortedBy)\n+            @JsonProperty(\"sortedBy\") List<SortingColumn> sortedBy,\n+            @JsonProperty(\"types\") Optional<List<Type>> types)\n     {\n         this.bucketedBy = ImmutableList.copyOf(requireNonNull(bucketedBy, \"bucketedBy is null\"));\n         this.bucketCount = bucketCount;\n         this.sortedBy = ImmutableList.copyOf(requireNonNull(sortedBy, \"sortedBy is null\"));\n+        this.types = requireNonNull(types, \"type is null\");\n+        if (types.isPresent()) {\n+            bucketingType = BucketingType.PRESTOTYPE;\n+            checkArgument(types.get().size() > 0, \"types can not be empty if present\");\n+            checkArgument(types.get().size() == bucketedBy.size(), \"the sizes of bucketedBy and types should match\");\n+        }\n+        else {\n+            bucketingType = BucketingType.HIVETYPE;\n+        }\n+    }\n+\n+    public enum BucketingType\n+    {\n+        HIVETYPE,", "originalCommit": "8f32be3d86121c7a7380503c8444d80dc5d250b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYwNzI0MQ==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r439607241", "bodyText": "How about HIVE_TYPE and PRESTO_NATIVE?  COMP ATIBLE is a little confused , as there is no translation here.", "author": "viczhang861", "createdAt": "2020-06-12T19:33:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU1NDU4NQ=="}], "type": "inlineReview", "revised_code": {"commit": "008ba566b6a25dbf83bc8161377af21caacff23c", "chunk": "diff --git a/presto-hive-metastore/src/main/java/com/facebook/presto/hive/HiveBucketProperty.java b/presto-hive-metastore/src/main/java/com/facebook/presto/hive/HiveBucketProperty.java\nindex aa9bd03363..aabf818b7c 100644\n--- a/presto-hive-metastore/src/main/java/com/facebook/presto/hive/HiveBucketProperty.java\n+++ b/presto-hive-metastore/src/main/java/com/facebook/presto/hive/HiveBucketProperty.java\n\n@@ -36,15 +38,15 @@ public class HiveBucketProperty\n     private final List<String> bucketedBy;\n     private final int bucketCount;\n     private final List<SortingColumn> sortedBy;\n+    private final BucketFunctionType bucketFunctionType;\n     private final Optional<List<Type>> types;\n-    private final BucketingType bucketingType;\n \n     public HiveBucketProperty(\n             List<String> bucketedBy,\n             int bucketCount,\n             List<SortingColumn> sortedBy)\n     {\n-        this(bucketedBy, bucketCount, sortedBy, Optional.empty());\n+        this(bucketedBy, bucketCount, sortedBy, HIVE_COMPATIBLE, Optional.empty());\n     }\n \n     @JsonCreator\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU1NDk5Mg==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r439554992", "bodyText": "How strongly do we feel about keeping this constructor? How many places have to be refactored if we are to remove it?", "author": "arhimondr", "createdAt": "2020-06-12T17:35:12Z", "path": "presto-hive-metastore/src/main/java/com/facebook/presto/hive/HiveBucketProperty.java", "diffHunk": "@@ -34,16 +36,42 @@\n     private final List<String> bucketedBy;\n     private final int bucketCount;\n     private final List<SortingColumn> sortedBy;\n+    private final Optional<List<Type>> types;\n+    private final BucketingType bucketingType;\n+\n+    public HiveBucketProperty(", "originalCommit": "8f32be3d86121c7a7380503c8444d80dc5d250b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYwODQxOA==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r439608418", "bodyText": "More than 10 call sites,   since \"Optional<List> types\" is optional, keeping the old constructor has some benefits.", "author": "viczhang861", "createdAt": "2020-06-12T19:36:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU1NDk5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg1MTU0NQ==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r440851545", "bodyText": "Let's remove this constructor to be more explicit in the places where it is created.", "author": "arhimondr", "createdAt": "2020-06-16T13:31:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU1NDk5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTMwMjczNw==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r441302737", "bodyText": "Done", "author": "viczhang861", "createdAt": "2020-06-17T06:12:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU1NDk5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "008ba566b6a25dbf83bc8161377af21caacff23c", "chunk": "diff --git a/presto-hive-metastore/src/main/java/com/facebook/presto/hive/HiveBucketProperty.java b/presto-hive-metastore/src/main/java/com/facebook/presto/hive/HiveBucketProperty.java\nindex aa9bd03363..aabf818b7c 100644\n--- a/presto-hive-metastore/src/main/java/com/facebook/presto/hive/HiveBucketProperty.java\n+++ b/presto-hive-metastore/src/main/java/com/facebook/presto/hive/HiveBucketProperty.java\n\n@@ -36,15 +38,15 @@ public class HiveBucketProperty\n     private final List<String> bucketedBy;\n     private final int bucketCount;\n     private final List<SortingColumn> sortedBy;\n+    private final BucketFunctionType bucketFunctionType;\n     private final Optional<List<Type>> types;\n-    private final BucketingType bucketingType;\n \n     public HiveBucketProperty(\n             List<String> bucketedBy,\n             int bucketCount,\n             List<SortingColumn> sortedBy)\n     {\n-        this(bucketedBy, bucketCount, sortedBy, Optional.empty());\n+        this(bucketedBy, bucketCount, sortedBy, HIVE_COMPATIBLE, Optional.empty());\n     }\n \n     @JsonCreator\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU1NTM2Mw==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r439555363", "bodyText": "Same comments as for other classes. Let's pass bucketingType as a parameter, and let's validate if the hiveTypes and types are set accordingly.", "author": "arhimondr", "createdAt": "2020-06-12T17:35:59Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketFunction.java", "diffHunk": "@@ -14,33 +14,71 @@\n package com.facebook.presto.hive;\n \n import com.facebook.presto.common.Page;\n+import com.facebook.presto.common.type.Type;\n import com.facebook.presto.spi.BucketFunction;\n import org.apache.hadoop.hive.serde2.typeinfo.TypeInfo;\n \n import java.util.List;\n-import java.util.stream.Collectors;\n+import java.util.Optional;\n \n+import static com.facebook.presto.hive.HiveBucketProperty.BucketingType.HIVETYPE;\n+import static com.facebook.presto.hive.HiveBucketProperty.BucketingType.PRESTOTYPE;\n+import static com.facebook.presto.hive.HiveBucketing.getHiveBucket;\n import static com.google.common.base.MoreObjects.toStringHelper;\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static java.lang.String.format;\n import static java.util.Objects.requireNonNull;\n \n public class HiveBucketFunction\n         implements BucketFunction\n {\n     private final int bucketCount;\n-    private final List<TypeInfo> typeInfos;\n+    private final Optional<List<TypeInfo>> typeInfos;\n+    private final Optional<List<Type>> types;\n+    private final HiveBucketProperty.BucketingType bucketingType;\n \n-    public HiveBucketFunction(int bucketCount, List<HiveType> hiveTypes)\n+    public static HiveBucketFunction createHiveCompatibleBucketFunction(\n+            int bucketCount,\n+            List<HiveType> hiveTypes)\n+    {\n+        return new HiveBucketFunction(bucketCount, Optional.of(hiveTypes), Optional.empty());\n+    }\n+\n+    public static HiveBucketFunction createPrestoNativeBucketFunction(\n+            int bucketCount,\n+            List<Type> types)\n+    {\n+        return new HiveBucketFunction(bucketCount, Optional.empty(), Optional.of(types));\n+    }\n+\n+    private HiveBucketFunction(", "originalCommit": "8f32be3d86121c7a7380503c8444d80dc5d250b3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "008ba566b6a25dbf83bc8161377af21caacff23c", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketFunction.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketFunction.java\nindex 69526fcfcc..6bdb4d513b 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketFunction.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketFunction.java\n\n@@ -21,63 +21,63 @@ import org.apache.hadoop.hive.serde2.typeinfo.TypeInfo;\n import java.util.List;\n import java.util.Optional;\n \n-import static com.facebook.presto.hive.HiveBucketProperty.BucketingType.HIVETYPE;\n-import static com.facebook.presto.hive.HiveBucketProperty.BucketingType.PRESTOTYPE;\n+import static com.facebook.presto.hive.BucketFunctionType.HIVE_COMPATIBLE;\n+import static com.facebook.presto.hive.BucketFunctionType.PRESTO_NATIVE;\n import static com.facebook.presto.hive.HiveBucketing.getHiveBucket;\n import static com.google.common.base.MoreObjects.toStringHelper;\n import static com.google.common.base.Preconditions.checkArgument;\n import static com.google.common.collect.ImmutableList.toImmutableList;\n-import static java.lang.String.format;\n import static java.util.Objects.requireNonNull;\n \n public class HiveBucketFunction\n         implements BucketFunction\n {\n     private final int bucketCount;\n+    private final BucketFunctionType bucketFunctionType;\n     private final Optional<List<TypeInfo>> typeInfos;\n     private final Optional<List<Type>> types;\n-    private final HiveBucketProperty.BucketingType bucketingType;\n \n     public static HiveBucketFunction createHiveCompatibleBucketFunction(\n             int bucketCount,\n             List<HiveType> hiveTypes)\n     {\n-        return new HiveBucketFunction(bucketCount, Optional.of(hiveTypes), Optional.empty());\n+        return new HiveBucketFunction(bucketCount, HIVE_COMPATIBLE, Optional.of(hiveTypes), Optional.empty());\n     }\n \n     public static HiveBucketFunction createPrestoNativeBucketFunction(\n             int bucketCount,\n             List<Type> types)\n     {\n-        return new HiveBucketFunction(bucketCount, Optional.empty(), Optional.of(types));\n+        return new HiveBucketFunction(bucketCount, PRESTO_NATIVE, Optional.empty(), Optional.of(types));\n     }\n \n     private HiveBucketFunction(\n             int bucketCount,\n+            BucketFunctionType bucketFunctionType,\n             Optional<List<HiveType>> hiveTypes,\n             Optional<List<Type>> types)\n     {\n         this.bucketCount = bucketCount;\n-        this.types = requireNonNull(types, \"types is null\");\n-        checkArgument(hiveTypes.isPresent() && !types.isPresent() ||\n-                        !hiveTypes.isPresent() && types.isPresent(),\n-                \"should use exactly one type system between HiveType and presto Type\");\n-        bucketingType = hiveTypes.isPresent() ? HIVETYPE : PRESTOTYPE;\n+        this.bucketFunctionType = requireNonNull(bucketFunctionType, \"bucketFunctionType is null\");\n+        checkArgument(bucketFunctionType.equals(BucketFunctionType.HIVE_COMPATIBLE) && hiveTypes.isPresent() ||\n+                        bucketFunctionType.equals(BucketFunctionType.PRESTO_NATIVE) && types.isPresent(),\n+                \"The corresponding type list is not present for bucketFunctionType \" + bucketFunctionType);\n         this.typeInfos = hiveTypes.map(list -> list.stream()\n                 .map(HiveType::getTypeInfo)\n                 .collect(toImmutableList()));\n+        this.types = requireNonNull(types, \"types is null\");\n     }\n \n     @Override\n     public int getBucket(Page page, int position)\n     {\n-        switch (bucketingType) {\n-            case PRESTOTYPE:\n-                return HiveBucketing.getBucket(bucketCount, types.get(), page, position);\n-            case HIVETYPE:\n+        switch (bucketFunctionType) {\n+            case HIVE_COMPATIBLE:\n                 return getHiveBucket(bucketCount, typeInfos.get(), page, position);\n+            case PRESTO_NATIVE:\n+                return HiveBucketing.getBucket(bucketCount, types.get(), page, position);\n             default:\n-                throw new IllegalStateException(format(\"Unsupported bucketing type %s\", bucketingType));\n+                throw new IllegalStateException(\"Unsupported bucketing type \" + bucketFunctionType);\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU1NTgyNA==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r439555824", "bodyText": "Why do we need to use hive compatible bucket property if partitionColumns.isEmpty() || !partitioningHandle.getTypes().isPresent()?", "author": "arhimondr", "createdAt": "2020-06-12T17:36:56Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -859,7 +861,24 @@ public ConnectorTableHandle createTemporaryTable(ConnectorSession session, List<\n                         Sets.difference(ImmutableSet.copyOf(partitioning.getPartitionColumns()), allColumns)));\n             }\n             HivePartitioningHandle partitioningHandle = (HivePartitioningHandle) partitioning.getPartitioningHandle();\n-            return new HiveBucketProperty(partitioning.getPartitionColumns(), partitioningHandle.getBucketCount(), ImmutableList.of());\n+            List<String> partitionColumns = partitioning.getPartitionColumns();\n+            if (partitionColumns.isEmpty() || !partitioningHandle.getTypes().isPresent()) {\n+                return new HiveBucketProperty(", "originalCommit": "8f32be3d86121c7a7380503c8444d80dc5d250b3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "008ba566b6a25dbf83bc8161377af21caacff23c", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\nindex 36ce4bb6b5..bda19ac95d 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n\n@@ -862,22 +863,28 @@ public class HiveMetadata\n             }\n             HivePartitioningHandle partitioningHandle = (HivePartitioningHandle) partitioning.getPartitioningHandle();\n             List<String> partitionColumns = partitioning.getPartitionColumns();\n-            if (partitionColumns.isEmpty() || !partitioningHandle.getTypes().isPresent()) {\n-                return new HiveBucketProperty(\n-                        partitionColumns,\n-                        partitioningHandle.getBucketCount(),\n-                        ImmutableList.of());\n-            }\n-            else {\n-                Map<String, Type> columnNameToTypeMap = columns.stream()\n-                        .collect(toMap(ColumnMetadata::getName, ColumnMetadata::getType));\n-                return new HiveBucketProperty(\n-                        partitionColumns,\n-                        partitioningHandle.getBucketCount(),\n-                        ImmutableList.of(),\n-                        Optional.of(partitionColumns.stream()\n-                                .map(columnNameToTypeMap::get)\n-                                .collect(toImmutableList())));\n+            BucketFunctionType bucketFunctionType = partitioningHandle.getBucketFunctionType();\n+            switch (bucketFunctionType) {\n+                case HIVE_COMPATIBLE:\n+                    return new HiveBucketProperty(\n+                            partitionColumns,\n+                            partitioningHandle.getBucketCount(),\n+                            ImmutableList.of(),\n+                            HIVE_COMPATIBLE,\n+                            Optional.empty());\n+                case PRESTO_NATIVE:\n+                    Map<String, Type> columnNameToTypeMap = columns.stream()\n+                            .collect(toMap(ColumnMetadata::getName, ColumnMetadata::getType));\n+                    return new HiveBucketProperty(\n+                            partitionColumns,\n+                            partitioningHandle.getBucketCount(),\n+                            ImmutableList.of(),\n+                            PRESTO_NATIVE,\n+                            Optional.of(partitionColumns.stream()\n+                                    .map(columnNameToTypeMap::get)\n+                                    .collect(toImmutableList())));\n+                default:\n+                    throw new IllegalStateException(\"Unsupported bucket function type \" + bucketFunctionType);\n             }\n         });\n \n"}}, {"oid": "008ba566b6a25dbf83bc8161377af21caacff23c", "url": "https://github.com/prestodb/presto/commit/008ba566b6a25dbf83bc8161377af21caacff23c", "message": "Support all column types for hive temporary bucket table\n\nAdd PRESTO_NATIVE bucket function type to calculate bucket\nnumber for hive incompatible column types.", "committedDate": "2020-06-16T02:01:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgzODk0OA==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r440838948", "bodyText": "nit IllegalArgumentException", "author": "arhimondr", "createdAt": "2020-06-16T13:14:07Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveNodePartitioningProvider.java", "diffHunk": "@@ -49,8 +51,15 @@ public BucketFunction getBucketFunction(\n             int bucketCount)\n     {\n         HivePartitioningHandle handle = (HivePartitioningHandle) partitioningHandle;\n-        List<HiveType> hiveTypes = handle.getHiveTypes();\n-        return new HiveBucketFunction(bucketCount, hiveTypes);\n+        BucketFunctionType bucketFunctionType = handle.getBucketFunctionType();\n+        switch (bucketFunctionType) {\n+            case HIVE_COMPATIBLE:\n+                return createHiveCompatibleBucketFunction(bucketCount, handle.getHiveTypes().get());\n+            case PRESTO_NATIVE:\n+                return createPrestoNativeBucketFunction(bucketCount, handle.getTypes().get());\n+            default:\n+                throw new IllegalStateException(\"Unsupported bucket function type \" + bucketFunctionType);", "originalCommit": "008ba566b6a25dbf83bc8161377af21caacff23c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "320b02582f41a25353c6bb3bff0240eec4ed691a", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveNodePartitioningProvider.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveNodePartitioningProvider.java\nindex d9c7abb62e..62e6a1419f 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HiveNodePartitioningProvider.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveNodePartitioningProvider.java\n\n@@ -58,7 +58,7 @@ public class HiveNodePartitioningProvider\n             case PRESTO_NATIVE:\n                 return createPrestoNativeBucketFunction(bucketCount, handle.getTypes().get());\n             default:\n-                throw new IllegalStateException(\"Unsupported bucket function type \" + bucketFunctionType);\n+                throw new IllegalArgumentException(\"Unsupported bucket function type \" + bucketFunctionType);\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgzOTE3Ng==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r440839176", "bodyText": "nit IllegalArgumentException", "author": "arhimondr", "createdAt": "2020-06-16T13:14:31Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePageSink.java", "diffHunk": "@@ -143,10 +146,20 @@ public HivePageSink(\n             bucketColumns = bucketProperty.get().getBucketedBy().stream()\n                     .mapToInt(dataColumnNameToIdMap::get)\n                     .toArray();\n-            List<HiveType> bucketColumnTypes = bucketProperty.get().getBucketedBy().stream()\n-                    .map(dataColumnNameToTypeMap::get)\n-                    .collect(toList());\n-            bucketFunction = new HiveBucketFunction(bucketCount, bucketColumnTypes);\n+            BucketFunctionType bucketFunctionType = bucketProperty.get().getBucketFunctionType();\n+            switch (bucketFunctionType) {\n+                case HIVE_COMPATIBLE:\n+                    List<HiveType> bucketColumnHiveTypes = bucketProperty.get().getBucketedBy().stream()\n+                            .map(dataColumnNameToHiveTypeMap::get)\n+                            .collect(toImmutableList());\n+                    bucketFunction = createHiveCompatibleBucketFunction(bucketCount, bucketColumnHiveTypes);\n+                    break;\n+                case PRESTO_NATIVE:\n+                    bucketFunction = createPrestoNativeBucketFunction(bucketCount, bucketProperty.get().getTypes().get());\n+                    break;\n+                default:\n+                    throw new IllegalStateException(\"Unsupported bucket function type \" + bucketFunctionType);", "originalCommit": "008ba566b6a25dbf83bc8161377af21caacff23c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "320b02582f41a25353c6bb3bff0240eec4ed691a", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HivePageSink.java b/presto-hive/src/main/java/com/facebook/presto/hive/HivePageSink.java\nindex 325bd61f5e..973aed5375 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HivePageSink.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HivePageSink.java\n\n@@ -158,7 +158,7 @@ public class HivePageSink\n                     bucketFunction = createPrestoNativeBucketFunction(bucketCount, bucketProperty.get().getTypes().get());\n                     break;\n                 default:\n-                    throw new IllegalStateException(\"Unsupported bucket function type \" + bucketFunctionType);\n+                    throw new IllegalArgumentException(\"Unsupported bucket function type \" + bucketFunctionType);\n             }\n         }\n         else {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgzOTYwOQ==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r440839609", "bodyText": "nit: static import", "author": "arhimondr", "createdAt": "2020-06-16T13:15:07Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java", "diffHunk": "@@ -13,33 +13,74 @@\n  */\n package com.facebook.presto.hive;\n \n+import com.facebook.presto.common.type.Type;\n import com.facebook.presto.spi.connector.ConnectorPartitioningHandle;\n import com.fasterxml.jackson.annotation.JsonCreator;\n import com.fasterxml.jackson.annotation.JsonProperty;\n \n import java.util.List;\n import java.util.Objects;\n+import java.util.Optional;\n import java.util.OptionalInt;\n \n+import static com.google.common.base.Preconditions.checkArgument;\n import static java.lang.String.format;\n import static java.util.Objects.requireNonNull;\n \n public class HivePartitioningHandle\n         implements ConnectorPartitioningHandle\n {\n     private final int bucketCount;\n-    private final List<HiveType> hiveTypes;\n     private final OptionalInt maxCompatibleBucketCount;\n+    private final BucketFunctionType bucketFunctionType;\n+    private final Optional<List<HiveType>> hiveTypes;\n+    private final Optional<List<Type>> types;\n \n+    public static HivePartitioningHandle createHiveCompatiblePartitioningHandle(\n+            int bucketCount,\n+            List<HiveType> hiveTypes,\n+            OptionalInt maxCompatibleBucketCount)\n+    {\n+        return new HivePartitioningHandle(\n+                bucketCount,\n+                maxCompatibleBucketCount,\n+                BucketFunctionType.HIVE_COMPATIBLE,", "originalCommit": "008ba566b6a25dbf83bc8161377af21caacff23c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "320b02582f41a25353c6bb3bff0240eec4ed691a", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java b/presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java\nindex 63387b7da2..7deb7774f5 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java\n\n@@ -23,6 +23,8 @@ import java.util.Objects;\n import java.util.Optional;\n import java.util.OptionalInt;\n \n+import static com.facebook.presto.hive.BucketFunctionType.HIVE_COMPATIBLE;\n+import static com.facebook.presto.hive.BucketFunctionType.PRESTO_NATIVE;\n import static com.google.common.base.Preconditions.checkArgument;\n import static java.lang.String.format;\n import static java.util.Objects.requireNonNull;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgzOTY5Mg==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r440839692", "bodyText": "nit: static import", "author": "arhimondr", "createdAt": "2020-06-16T13:15:14Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java", "diffHunk": "@@ -13,33 +13,74 @@\n  */\n package com.facebook.presto.hive;\n \n+import com.facebook.presto.common.type.Type;\n import com.facebook.presto.spi.connector.ConnectorPartitioningHandle;\n import com.fasterxml.jackson.annotation.JsonCreator;\n import com.fasterxml.jackson.annotation.JsonProperty;\n \n import java.util.List;\n import java.util.Objects;\n+import java.util.Optional;\n import java.util.OptionalInt;\n \n+import static com.google.common.base.Preconditions.checkArgument;\n import static java.lang.String.format;\n import static java.util.Objects.requireNonNull;\n \n public class HivePartitioningHandle\n         implements ConnectorPartitioningHandle\n {\n     private final int bucketCount;\n-    private final List<HiveType> hiveTypes;\n     private final OptionalInt maxCompatibleBucketCount;\n+    private final BucketFunctionType bucketFunctionType;\n+    private final Optional<List<HiveType>> hiveTypes;\n+    private final Optional<List<Type>> types;\n \n+    public static HivePartitioningHandle createHiveCompatiblePartitioningHandle(\n+            int bucketCount,\n+            List<HiveType> hiveTypes,\n+            OptionalInt maxCompatibleBucketCount)\n+    {\n+        return new HivePartitioningHandle(\n+                bucketCount,\n+                maxCompatibleBucketCount,\n+                BucketFunctionType.HIVE_COMPATIBLE,\n+                Optional.of(hiveTypes),\n+                Optional.empty());\n+    }\n+\n+    public static HivePartitioningHandle createPrestoNativePartitioningHandle(\n+            int bucketCount,\n+            List<Type> types,\n+            OptionalInt maxCompatibleBucketCount)\n+    {\n+        return new HivePartitioningHandle(\n+                bucketCount,\n+                maxCompatibleBucketCount,\n+                BucketFunctionType.PRESTO_NATIVE,", "originalCommit": "008ba566b6a25dbf83bc8161377af21caacff23c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "320b02582f41a25353c6bb3bff0240eec4ed691a", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java b/presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java\nindex 63387b7da2..7deb7774f5 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java\n\n@@ -23,6 +23,8 @@ import java.util.Objects;\n import java.util.Optional;\n import java.util.OptionalInt;\n \n+import static com.facebook.presto.hive.BucketFunctionType.HIVE_COMPATIBLE;\n+import static com.facebook.presto.hive.BucketFunctionType.PRESTO_NATIVE;\n import static com.google.common.base.Preconditions.checkArgument;\n import static java.lang.String.format;\n import static java.util.Objects.requireNonNull;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg0MDMwMQ==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r440840301", "bodyText": "\"buckets=%s, bucketFunctionType=%s, types=%s\"", "author": "arhimondr", "createdAt": "2020-06-16T13:16:06Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java", "diffHunk": "@@ -49,21 +90,37 @@ public int getBucketCount()\n     }\n \n     @JsonProperty\n-    public List<HiveType> getHiveTypes()\n+    public Optional<List<HiveType>> getHiveTypes()\n     {\n         return hiveTypes;\n     }\n \n+    @JsonProperty\n+    public Optional<List<Type>> getTypes()\n+    {\n+        return types;\n+    }\n+\n     @JsonProperty\n     public OptionalInt getMaxCompatibleBucketCount()\n     {\n         return maxCompatibleBucketCount;\n     }\n \n+    @JsonProperty\n+    public BucketFunctionType getBucketFunctionType()\n+    {\n+        return bucketFunctionType;\n+    }\n+\n     @Override\n     public String toString()\n     {\n-        return format(\"buckets=%s, hiveTypes=%s\", bucketCount, hiveTypes);\n+        return format(\n+                \"buckets=%s,\" + \"bucketFunctionType=%s,\" + \"types=%s\",", "originalCommit": "008ba566b6a25dbf83bc8161377af21caacff23c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "320b02582f41a25353c6bb3bff0240eec4ed691a", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java b/presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java\nindex 63387b7da2..7deb7774f5 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java\n\n@@ -117,10 +119,10 @@ public class HivePartitioningHandle\n     public String toString()\n     {\n         return format(\n-                \"buckets=%s,\" + \"bucketFunctionType=%s,\" + \"types=%s\",\n+                \"buckets=%s, bucketFunctionType=%s, types=%s\",\n                 bucketCount,\n                 bucketFunctionType,\n-                bucketFunctionType.equals(BucketFunctionType.HIVE_COMPATIBLE) ? hiveTypes.get() : types.get());\n+                bucketFunctionType.equals(HIVE_COMPATIBLE) ? hiveTypes.get() : types.get());\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg0MDQ2NA==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r440840464", "bodyText": "static import", "author": "arhimondr", "createdAt": "2020-06-16T13:16:21Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java", "diffHunk": "@@ -49,21 +90,37 @@ public int getBucketCount()\n     }\n \n     @JsonProperty\n-    public List<HiveType> getHiveTypes()\n+    public Optional<List<HiveType>> getHiveTypes()\n     {\n         return hiveTypes;\n     }\n \n+    @JsonProperty\n+    public Optional<List<Type>> getTypes()\n+    {\n+        return types;\n+    }\n+\n     @JsonProperty\n     public OptionalInt getMaxCompatibleBucketCount()\n     {\n         return maxCompatibleBucketCount;\n     }\n \n+    @JsonProperty\n+    public BucketFunctionType getBucketFunctionType()\n+    {\n+        return bucketFunctionType;\n+    }\n+\n     @Override\n     public String toString()\n     {\n-        return format(\"buckets=%s, hiveTypes=%s\", bucketCount, hiveTypes);\n+        return format(\n+                \"buckets=%s,\" + \"bucketFunctionType=%s,\" + \"types=%s\",\n+                bucketCount,\n+                bucketFunctionType,\n+                bucketFunctionType.equals(BucketFunctionType.HIVE_COMPATIBLE) ? hiveTypes.get() : types.get());", "originalCommit": "008ba566b6a25dbf83bc8161377af21caacff23c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "320b02582f41a25353c6bb3bff0240eec4ed691a", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java b/presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java\nindex 63387b7da2..7deb7774f5 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HivePartitioningHandle.java\n\n@@ -117,10 +119,10 @@ public class HivePartitioningHandle\n     public String toString()\n     {\n         return format(\n-                \"buckets=%s,\" + \"bucketFunctionType=%s,\" + \"types=%s\",\n+                \"buckets=%s, bucketFunctionType=%s, types=%s\",\n                 bucketCount,\n                 bucketFunctionType,\n-                bucketFunctionType.equals(BucketFunctionType.HIVE_COMPATIBLE) ? hiveTypes.get() : types.get());\n+                bucketFunctionType.equals(HIVE_COMPATIBLE) ? hiveTypes.get() : types.get());\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg0MDkzOA==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r440840938", "bodyText": "IllegalArgumentException", "author": "arhimondr", "createdAt": "2020-06-16T13:17:03Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -859,7 +862,30 @@ public ConnectorTableHandle createTemporaryTable(ConnectorSession session, List<\n                         Sets.difference(ImmutableSet.copyOf(partitioning.getPartitionColumns()), allColumns)));\n             }\n             HivePartitioningHandle partitioningHandle = (HivePartitioningHandle) partitioning.getPartitioningHandle();\n-            return new HiveBucketProperty(partitioning.getPartitionColumns(), partitioningHandle.getBucketCount(), ImmutableList.of());\n+            List<String> partitionColumns = partitioning.getPartitionColumns();\n+            BucketFunctionType bucketFunctionType = partitioningHandle.getBucketFunctionType();\n+            switch (bucketFunctionType) {\n+                case HIVE_COMPATIBLE:\n+                    return new HiveBucketProperty(\n+                            partitionColumns,\n+                            partitioningHandle.getBucketCount(),\n+                            ImmutableList.of(),\n+                            HIVE_COMPATIBLE,\n+                            Optional.empty());\n+                case PRESTO_NATIVE:\n+                    Map<String, Type> columnNameToTypeMap = columns.stream()\n+                            .collect(toMap(ColumnMetadata::getName, ColumnMetadata::getType));\n+                    return new HiveBucketProperty(\n+                            partitionColumns,\n+                            partitioningHandle.getBucketCount(),\n+                            ImmutableList.of(),\n+                            PRESTO_NATIVE,\n+                            Optional.of(partitionColumns.stream()\n+                                    .map(columnNameToTypeMap::get)\n+                                    .collect(toImmutableList())));\n+                default:\n+                    throw new IllegalStateException(\"Unsupported bucket function type \" + bucketFunctionType);", "originalCommit": "008ba566b6a25dbf83bc8161377af21caacff23c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "320b02582f41a25353c6bb3bff0240eec4ed691a", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\nindex bda19ac95d..50dd4e2f78 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n\n@@ -884,7 +884,7 @@ public class HiveMetadata\n                                     .map(columnNameToTypeMap::get)\n                                     .collect(toImmutableList())));\n                 default:\n-                    throw new IllegalStateException(\"Unsupported bucket function type \" + bucketFunctionType);\n+                    throw new IllegalArgumentException(\"Unsupported bucket function type \" + bucketFunctionType);\n             }\n         });\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg2MDE0Mg==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r440860142", "bodyText": "Let's simply check that the bucketFunction type is the same, and that the types also match (similar like for the getCommonPartitioningHandle)", "author": "arhimondr", "createdAt": "2020-06-16T13:43:29Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -2187,10 +2231,15 @@ public ConnectorTableLayoutHandle getAlternativeLayoutHandle(ConnectorSession se\n         checkArgument(hiveLayoutHandle.getBucketHandle().isPresent(), \"Hive connector only provides alternative layout for bucketed table\");\n         HiveBucketHandle bucketHandle = hiveLayoutHandle.getBucketHandle().get();\n         ImmutableList<HiveType> bucketTypes = bucketHandle.getColumns().stream().map(HiveColumnHandle::getHiveType).collect(toImmutableList());\n+        Optional<List<HiveType>> hiveTypes = hivePartitioningHandle.getHiveTypes();", "originalCommit": "008ba566b6a25dbf83bc8161377af21caacff23c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDkzMDE2OQ==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r440930169", "bodyText": "This can only be HIVE_COMPATIBLE, see explanation checkArgument( hivePartitioningHandle.getBucketFunctionType().equals(HIVE_COMPATIBLE) && hiveTypes.isPresent(), \"partitionColumns in HiveTableLayoutHandle must use a hive compatible bucket function\");", "author": "viczhang861", "createdAt": "2020-06-16T15:14:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg2MDE0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA0NTE4MA==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r441045180", "bodyText": "As per discussion offline we decided to keep an assertion, as this method shouldn't be used for temporary tables", "author": "arhimondr", "createdAt": "2020-06-16T18:08:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg2MDE0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "445f7132e30e48cfcec31cc9605822eecc6add01", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\nindex bda19ac95d..679e4cc827 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n\n@@ -2233,9 +2224,9 @@ public class HiveMetadata\n         ImmutableList<HiveType> bucketTypes = bucketHandle.getColumns().stream().map(HiveColumnHandle::getHiveType).collect(toImmutableList());\n         Optional<List<HiveType>> hiveTypes = hivePartitioningHandle.getHiveTypes();\n         checkArgument(\n-                hivePartitioningHandle.getBucketFunctionType().equals(HIVE_COMPATIBLE) &&\n-                        hiveTypes.isPresent(),\n-                \"partitionColumns in HiveTableLayoutHandle must use a hive compatible bucket function\");\n+                hivePartitioningHandle.getBucketFunctionType().equals(HIVE_COMPATIBLE),\n+                \"bucketFunctionType is expected to be HIVE_COMPATIBLE, got: %s\",\n+                hivePartitioningHandle.getBucketFunctionType());\n         checkArgument(\n                 hiveTypes.get().equals(bucketTypes),\n                 \"Types from the new PartitioningHandle (%s) does not match the TableLayoutHandle (%s)\",\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg2MTg0OA==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r440861848", "bodyText": "Let's simply create the HivePartitioningHandle based on the actual HiveBucketProperty. We should assume the HiveBucketProperty is created right based on the ConnectorTableMetadata", "author": "arhimondr", "createdAt": "2020-06-16T13:45:41Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -2351,19 +2393,21 @@ private static Domain buildColumnDomain(ColumnHandle column, List<HivePartition>\n         if (!bucketProperty.isPresent()) {\n             return Optional.empty();\n         }\n+        checkArgument(bucketProperty.get().getBucketFunctionType().equals(BucketFunctionType.HIVE_COMPATIBLE), \"Must be hive compatible bucket function type\");", "originalCommit": "008ba566b6a25dbf83bc8161377af21caacff23c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDkzMzUxMQ==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r440933511", "bodyText": "We had a discussion earlier, getNewTableLayout is never used for temporary table, so I added a checkArgument and removed conditional creation of HivePartitioningHandle based on the actual HiveBucketProperty.", "author": "viczhang861", "createdAt": "2020-06-16T15:18:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg2MTg0OA=="}], "type": "inlineReview", "revised_code": {"commit": "445f7132e30e48cfcec31cc9605822eecc6add01", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\nindex bda19ac95d..679e4cc827 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n\n@@ -2393,7 +2384,9 @@ public class HiveMetadata\n         if (!bucketProperty.isPresent()) {\n             return Optional.empty();\n         }\n-        checkArgument(bucketProperty.get().getBucketFunctionType().equals(BucketFunctionType.HIVE_COMPATIBLE), \"Must be hive compatible bucket function type\");\n+        checkArgument(bucketProperty.get().getBucketFunctionType().equals(BucketFunctionType.HIVE_COMPATIBLE),\n+                \"bucketFunctionType is expected to be HIVE_COMPATIBLE, got: %s\",\n+                bucketProperty.get().getBucketFunctionType());\n         if (!bucketProperty.get().getSortedBy().isEmpty() && !isSortedWritingEnabled(session)) {\n             throw new PrestoException(NOT_SUPPORTED, \"Writing to bucketed sorted Hive tables is disabled\");\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg2MjUzOA==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r440862538", "bodyText": "Let's simply use a constructor here", "author": "arhimondr", "createdAt": "2020-06-16T13:46:33Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -2297,12 +2339,12 @@ private static Domain buildColumnDomain(ColumnHandle column, List<HivePartition>\n             throw new PrestoException(NOT_SUPPORTED, \"Writing to bucketed sorted Hive tables is disabled\");\n         }\n \n-        HivePartitioningHandle partitioningHandle = new HivePartitioningHandle(\n+        HivePartitioningHandle partitioningHandle = createHivePartitioningHandle(", "originalCommit": "008ba566b6a25dbf83bc8161377af21caacff23c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDkyOTA2Mg==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r440929062", "bodyText": "There are two places which create HivePartitioningHandle using HiveBucketHandle and HiveBucketProperty, a function is created to remove duplicated code.", "author": "viczhang861", "createdAt": "2020-06-16T15:12:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg2MjUzOA=="}], "type": "inlineReview", "revised_code": {"commit": "5217aa45e58861a5c1791f2f6fa0213f818b2426", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\nindex bda19ac95d..0660c3e391 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n\n@@ -2339,11 +2358,27 @@ public class HiveMetadata\n             throw new PrestoException(NOT_SUPPORTED, \"Writing to bucketed sorted Hive tables is disabled\");\n         }\n \n-        HivePartitioningHandle partitioningHandle = createHivePartitioningHandle(\n-                hiveBucketHandle.get().getTableBucketCount(),\n-                hiveBucketHandle.get(),\n-                Optional.of(bucketProperty),\n-                OptionalInt.of(hiveBucketHandle.get().getTableBucketCount()));\n+        HivePartitioningHandle partitioningHandle;\n+        int bucketCount = hiveBucketHandle.get().getTableBucketCount();\n+        OptionalInt maxCompatibleBucketCount = OptionalInt.of(bucketCount);\n+        switch (bucketProperty.getBucketFunctionType()) {\n+            case HIVE_COMPATIBLE:\n+                partitioningHandle = createHiveCompatiblePartitioningHandle(\n+                        bucketCount,\n+                        hiveBucketHandle.get().getColumns().stream()\n+                                .map(HiveColumnHandle::getHiveType)\n+                                .collect(toImmutableList()),\n+                        maxCompatibleBucketCount);\n+                break;\n+            case PRESTO_NATIVE:\n+                partitioningHandle = createPrestoNativePartitioningHandle(\n+                        bucketCount,\n+                        bucketProperty.getTypes().get(),\n+                        maxCompatibleBucketCount);\n+                break;\n+            default:\n+                throw new IllegalArgumentException(\"Unsupported bucket function type \" + bucketProperty.getBucketFunctionType());\n+        }\n \n         List<String> partitionColumns = hiveBucketHandle.get().getColumns().stream()\n                 .map(HiveColumnHandle::getName)\n"}}, {"oid": "320b02582f41a25353c6bb3bff0240eec4ed691a", "url": "https://github.com/prestodb/presto/commit/320b02582f41a25353c6bb3bff0240eec4ed691a", "message": "Refactor HiveBucketProperty constructor method\n\nExplicitly set BucketFunctionType to avoid that\nexpected types are missing.", "committedDate": "2020-06-17T02:03:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcxNDk0Mg==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r441714942", "bodyText": "I'm not sure how safe it to ignore. Let's add an assertion that the getBucketFunctionType().equals(HIVE_COMPATIBLE)", "author": "arhimondr", "createdAt": "2020-06-17T17:36:58Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketing.java", "diffHunk": "@@ -287,7 +305,8 @@ private static int hashBytes(int initialValue, Slice bytes)\n \n     public static Optional<HiveBucketFilter> getHiveBucketFilter(Table table, TupleDomain<ColumnHandle> effectivePredicate)\n     {\n-        if (!table.getStorage().getBucketProperty().isPresent()) {\n+        Optional<HiveBucketProperty> hiveBucketProperty = table.getStorage().getBucketProperty();\n+        if (!hiveBucketProperty.isPresent() || !hiveBucketProperty.get().getBucketFunctionType().equals(HIVE_COMPATIBLE)) {", "originalCommit": "7e955991e3e5ef07cebc131db15971c397ef60da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcxNTUzNw==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r441715537", "bodyText": "Actually it is already checked in getHiveBuckets. We can remove this assertion here.", "author": "arhimondr", "createdAt": "2020-06-17T17:37:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcxNDk0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTczMzQ5NQ==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r441733495", "bodyText": "This one is needed to return empty HiveBucketFilter:   ignore bucket pruning", "author": "viczhang861", "createdAt": "2020-06-17T18:08:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcxNDk0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc0NzEzNg==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r441747136", "bodyText": "I'm not sure if it is safe to ignore it. There shouldn't be any bucket pruning for temporary tables though.", "author": "arhimondr", "createdAt": "2020-06-17T18:32:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcxNDk0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc1ODk0Mw==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r441758943", "bodyText": "Since code path exist for bucketed temporary table : Optional<HiveBucketFilter> bucketFilter = shouldIgnoreTableBucketing ? Optional.empty() : getHiveBucketFilter(table, effectivePredicate);    Thus we cannot use assertion but should ignore.", "author": "viczhang861", "createdAt": "2020-06-17T18:50:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcxNDk0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc2MTQ2Mw==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r441761463", "bodyText": "Or add the check in call site: shouldIgnoreTableBucketing || bucket function type == PRESTO_NATIVE ? Optional.empty() : getHiveBucketFilter(table, effectivePredicate);\nSame thing, let's keep it inside.", "author": "viczhang861", "createdAt": "2020-06-17T18:53:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcxNDk0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk0MzIxMw==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r441943213", "bodyText": "It feels like this shortcut is not needed. Temporary tables are never filtered. Thus it seems like the method should return at if (!bindings.isPresent()) {, before reaching the getHiveBuckets(table, bindings.get()) that would fail if the hash function is not HIVE_COMPATIBLE", "author": "arhimondr", "createdAt": "2020-06-18T03:09:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcxNDk0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU1MzM4MQ==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r442553381", "bodyText": "bindings could be a non-empty Optional object for temporary table, test will fail if I revert this change. The shortcut has its value to avoid unneeded code path.", "author": "viczhang861", "createdAt": "2020-06-18T23:28:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcxNDk0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg3NjI2Nw==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r442876267", "bodyText": "Okay, I just checked the code, and it seems to be safe to skip bucket filter.\nLet's at least extract this condition into a separate branch and add a comment, e.g.:\nif (!hiveBucketProperty.isPresent()) {\n  return Optional.empty();\n}\nif(!hiveBucketProperty.get().getBucketFunctionType().equals(HIVE_COMPATIBLE)){\n  // bucket filtering is only supported for tables bucketed with HIVE_COMPATIBLE hash function\n  return Optional.empty();\n}", "author": "arhimondr", "createdAt": "2020-06-19T14:34:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcxNDk0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "177616ed61c94e17bb3ff7e86eb515d2acbb92df", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketing.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketing.java\nindex 87560fef69..17beb55e89 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketing.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketing.java\n\n@@ -305,8 +304,7 @@ public final class HiveBucketing\n \n     public static Optional<HiveBucketFilter> getHiveBucketFilter(Table table, TupleDomain<ColumnHandle> effectivePredicate)\n     {\n-        Optional<HiveBucketProperty> hiveBucketProperty = table.getStorage().getBucketProperty();\n-        if (!hiveBucketProperty.isPresent() || !hiveBucketProperty.get().getBucketFunctionType().equals(HIVE_COMPATIBLE)) {\n+        if (!table.getStorage().getBucketProperty().isPresent()) {\n             return Optional.empty();\n         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcxNzEzOQ==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r441717139", "bodyText": "hiveBucketProperty is only used by the getPartitionMetadata. We can pass the bucketHandle directly to that method to avoid this \"lossy\" conversion.", "author": "arhimondr", "createdAt": "2020-06-17T17:40:42Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -223,7 +225,14 @@ public ConnectorSplitSource getSplits(\n \n         Optional<HiveBucketProperty> hiveBucketProperty = Optional.empty();\n         if (bucketHandle.isPresent() && !bucketHandle.get().isVirtuallyBucketed()) {\n-            hiveBucketProperty = bucketHandle.map(HiveBucketHandle::toTableBucketProperty);\n+            hiveBucketProperty = bucketHandle.map(handle -> new HiveBucketProperty(", "originalCommit": "7e955991e3e5ef07cebc131db15971c397ef60da", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "445f7132e30e48cfcec31cc9605822eecc6add01", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java\nindex 6a045c7f93..78956c41f6 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java\n\n@@ -223,18 +222,7 @@ public class HiveSplitManager\n         // sort partitions\n         partitions = Ordering.natural().onResultOf(HivePartition::getPartitionId).reverse().sortedCopy(partitions);\n \n-        Optional<HiveBucketProperty> hiveBucketProperty = Optional.empty();\n-        if (bucketHandle.isPresent() && !bucketHandle.get().isVirtuallyBucketed()) {\n-            hiveBucketProperty = bucketHandle.map(handle -> new HiveBucketProperty(\n-                    handle.getColumns().stream()\n-                            .map(HiveColumnHandle::getName)\n-                            .collect(toList()),\n-                    handle.getTableBucketCount(),\n-                    ImmutableList.of(),\n-                    HIVE_COMPATIBLE,\n-                    Optional.empty()));\n-        }\n-        Iterable<HivePartitionMetadata> hivePartitions = getPartitionMetadata(metastore, table, tableName, partitions, hiveBucketProperty, session);\n+        Iterable<HivePartitionMetadata> hivePartitions = getPartitionMetadata(metastore, table, tableName, partitions, bucketHandle, session);\n \n         HiveSplitLoader hiveSplitLoader = new BackgroundHiveSplitLoader(\n                 table,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyMDk4OA==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r441720988", "bodyText": "Let's use the HivePartitioningHandle constructor directly here to avoid this switch. We are not changing the function, we simply replacing the bucket count. It's a little not intuitive to see another branching here.", "author": "arhimondr", "createdAt": "2020-06-17T17:47:14Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -2142,19 +2174,31 @@ public ConnectorTableLayout getTableLayout(ConnectorSession session, ConnectorTa\n             return Optional.empty();\n         }\n \n-        return Optional.of(new HivePartitioningHandle(\n-                smallerBucketCount,\n-                leftHandle.getHiveTypes(),\n-                maxCompatibleBucketCount));\n+        BucketFunctionType bucketFunctionType = leftHandle.getBucketFunctionType();\n+        switch (bucketFunctionType) {", "originalCommit": "7e955991e3e5ef07cebc131db15971c397ef60da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc2OTYyNA==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r441769624", "bodyText": "Ok, I will remove the restriction to not use HivePartitioningHandle constructor directly and and more checking in constructor.", "author": "viczhang861", "createdAt": "2020-06-17T19:02:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyMDk4OA=="}], "type": "inlineReview", "revised_code": {"commit": "445f7132e30e48cfcec31cc9605822eecc6add01", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\nindex 50dd4e2f78..679e4cc827 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n\n@@ -2174,21 +2174,12 @@ public class HiveMetadata\n             return Optional.empty();\n         }\n \n-        BucketFunctionType bucketFunctionType = leftHandle.getBucketFunctionType();\n-        switch (bucketFunctionType) {\n-            case HIVE_COMPATIBLE:\n-                return Optional.of(createHiveCompatiblePartitioningHandle(\n-                        smallerBucketCount,\n-                        leftHandle.getHiveTypes().get(),\n-                        maxCompatibleBucketCount));\n-            case PRESTO_NATIVE:\n-                return Optional.of(createPrestoNativePartitioningHandle(\n-                        smallerBucketCount,\n-                        leftHandle.getTypes().get(),\n-                        maxCompatibleBucketCount));\n-            default:\n-                throw new IllegalArgumentException(\"Unsupported bucket function type \" + bucketFunctionType);\n-        }\n+        return Optional.of(new HivePartitioningHandle(\n+                smallerBucketCount,\n+                maxCompatibleBucketCount,\n+                leftHandle.getBucketFunctionType(),\n+                leftHandle.getHiveTypes(),\n+                leftHandle.getTypes()));\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyMTQwNw==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r441721407", "bodyText": "hiveTypes.isPresent() is extra. It is checked in the HivePartitioningHandle constructor", "author": "arhimondr", "createdAt": "2020-06-17T17:47:58Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -2187,10 +2231,15 @@ public ConnectorTableLayoutHandle getAlternativeLayoutHandle(ConnectorSession se\n         checkArgument(hiveLayoutHandle.getBucketHandle().isPresent(), \"Hive connector only provides alternative layout for bucketed table\");\n         HiveBucketHandle bucketHandle = hiveLayoutHandle.getBucketHandle().get();\n         ImmutableList<HiveType> bucketTypes = bucketHandle.getColumns().stream().map(HiveColumnHandle::getHiveType).collect(toImmutableList());\n+        Optional<List<HiveType>> hiveTypes = hivePartitioningHandle.getHiveTypes();\n         checkArgument(\n-                hivePartitioningHandle.getHiveTypes().equals(bucketTypes),\n+                hivePartitioningHandle.getBucketFunctionType().equals(HIVE_COMPATIBLE) &&", "originalCommit": "7e955991e3e5ef07cebc131db15971c397ef60da", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "445f7132e30e48cfcec31cc9605822eecc6add01", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\nindex 50dd4e2f78..679e4cc827 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n\n@@ -2233,9 +2224,9 @@ public class HiveMetadata\n         ImmutableList<HiveType> bucketTypes = bucketHandle.getColumns().stream().map(HiveColumnHandle::getHiveType).collect(toImmutableList());\n         Optional<List<HiveType>> hiveTypes = hivePartitioningHandle.getHiveTypes();\n         checkArgument(\n-                hivePartitioningHandle.getBucketFunctionType().equals(HIVE_COMPATIBLE) &&\n-                        hiveTypes.isPresent(),\n-                \"partitionColumns in HiveTableLayoutHandle must use a hive compatible bucket function\");\n+                hivePartitioningHandle.getBucketFunctionType().equals(HIVE_COMPATIBLE),\n+                \"bucketFunctionType is expected to be HIVE_COMPATIBLE, got: %s\",\n+                hivePartitioningHandle.getBucketFunctionType());\n         checkArgument(\n                 hiveTypes.get().equals(bucketTypes),\n                 \"Types from the new PartitioningHandle (%s) does not match the TableLayoutHandle (%s)\",\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyMzk3OQ==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r441723979", "bodyText": "nit: \"bucketFunctionType is expected to be HIVE_COMPATIBLE, got: %s\", hivePartitioningHandle.getBucketFunctionType(),", "author": "arhimondr", "createdAt": "2020-06-17T17:52:18Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -2187,10 +2231,15 @@ public ConnectorTableLayoutHandle getAlternativeLayoutHandle(ConnectorSession se\n         checkArgument(hiveLayoutHandle.getBucketHandle().isPresent(), \"Hive connector only provides alternative layout for bucketed table\");\n         HiveBucketHandle bucketHandle = hiveLayoutHandle.getBucketHandle().get();\n         ImmutableList<HiveType> bucketTypes = bucketHandle.getColumns().stream().map(HiveColumnHandle::getHiveType).collect(toImmutableList());\n+        Optional<List<HiveType>> hiveTypes = hivePartitioningHandle.getHiveTypes();\n         checkArgument(\n-                hivePartitioningHandle.getHiveTypes().equals(bucketTypes),\n+                hivePartitioningHandle.getBucketFunctionType().equals(HIVE_COMPATIBLE) &&\n+                        hiveTypes.isPresent(),\n+                \"partitionColumns in HiveTableLayoutHandle must use a hive compatible bucket function\");", "originalCommit": "7e955991e3e5ef07cebc131db15971c397ef60da", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "445f7132e30e48cfcec31cc9605822eecc6add01", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\nindex 50dd4e2f78..679e4cc827 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n\n@@ -2233,9 +2224,9 @@ public class HiveMetadata\n         ImmutableList<HiveType> bucketTypes = bucketHandle.getColumns().stream().map(HiveColumnHandle::getHiveType).collect(toImmutableList());\n         Optional<List<HiveType>> hiveTypes = hivePartitioningHandle.getHiveTypes();\n         checkArgument(\n-                hivePartitioningHandle.getBucketFunctionType().equals(HIVE_COMPATIBLE) &&\n-                        hiveTypes.isPresent(),\n-                \"partitionColumns in HiveTableLayoutHandle must use a hive compatible bucket function\");\n+                hivePartitioningHandle.getBucketFunctionType().equals(HIVE_COMPATIBLE),\n+                \"bucketFunctionType is expected to be HIVE_COMPATIBLE, got: %s\",\n+                hivePartitioningHandle.getBucketFunctionType());\n         checkArgument(\n                 hiveTypes.get().equals(bucketTypes),\n                 \"Types from the new PartitioningHandle (%s) does not match the TableLayoutHandle (%s)\",\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyNDMyOQ==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r441724329", "bodyText": "nit: \"bucketFunctionType is expected to be HIVE_COMPATIBLE, got: %s\", bucketProperty.get().getBucketFunctionType()", "author": "arhimondr", "createdAt": "2020-06-17T17:52:50Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -2351,19 +2393,21 @@ private static Domain buildColumnDomain(ColumnHandle column, List<HivePartition>\n         if (!bucketProperty.isPresent()) {\n             return Optional.empty();\n         }\n+        checkArgument(bucketProperty.get().getBucketFunctionType().equals(BucketFunctionType.HIVE_COMPATIBLE), \"Must be hive compatible bucket function type\");", "originalCommit": "7e955991e3e5ef07cebc131db15971c397ef60da", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "445f7132e30e48cfcec31cc9605822eecc6add01", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\nindex 50dd4e2f78..679e4cc827 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n\n@@ -2393,7 +2384,9 @@ public class HiveMetadata\n         if (!bucketProperty.isPresent()) {\n             return Optional.empty();\n         }\n-        checkArgument(bucketProperty.get().getBucketFunctionType().equals(BucketFunctionType.HIVE_COMPATIBLE), \"Must be hive compatible bucket function type\");\n+        checkArgument(bucketProperty.get().getBucketFunctionType().equals(BucketFunctionType.HIVE_COMPATIBLE),\n+                \"bucketFunctionType is expected to be HIVE_COMPATIBLE, got: %s\",\n+                bucketProperty.get().getBucketFunctionType());\n         if (!bucketProperty.get().getSortedBy().isEmpty() && !isSortedWritingEnabled(session)) {\n             throw new PrestoException(NOT_SUPPORTED, \"Writing to bucketed sorted Hive tables is disabled\");\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyNzM2NQ==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r441727365", "bodyText": "This should always be present, let's make it non Optional", "author": "arhimondr", "createdAt": "2020-06-17T17:57:35Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -2559,6 +2603,27 @@ public void revokeTablePrivileges(ConnectorSession session, SchemaTableName sche\n         return toCompletableFuture(stagingFileCommitter.commitFiles(session, handle.getSchemaName(), handle.getTableName(), getPartitionUpdates(fragments)));\n     }\n \n+    private HivePartitioningHandle createHivePartitioningHandle(\n+            int bucketCount,\n+            HiveBucketHandle hiveBucketHandle,\n+            Optional<HiveBucketProperty> bucketProperty,", "originalCommit": "7e955991e3e5ef07cebc131db15971c397ef60da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTczNTYyMA==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r441735620", "bodyText": "I initially use non-optional, but there was failed test due to empty HiveBucketProperty", "author": "viczhang861", "createdAt": "2020-06-17T18:12:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyNzM2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc0Njc1OQ==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r441746759", "bodyText": "In what case the HiveBucketProperty is missing?", "author": "arhimondr", "createdAt": "2020-06-17T18:32:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyNzM2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc5MjY4MQ==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r441792681", "bodyText": "Here are some examples: https://api.travis-ci.com/v3/job/347805400/log.txt,   HiveBucketProperty is optional inside Storage class", "author": "viczhang861", "createdAt": "2020-06-17T19:47:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyNzM2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk0MjI4OQ==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r441942289", "bodyText": "Okay, now I understand. The bucketProperty will be missing only if the table is \"virtually bucketed\". Let's have a special case for that to make it explicit, otherwise it is very confusing.\nHonestly i don't really like this method. It is very confusing. It is very hard to understand in what cases  bucketProperty is present, why bucketCount, hiveBucketHandle and maxCompatibleBucketCount may have different bucket count, etc. I would recommend to inline this method. It will result in a couple of lines of duplicated code, but it should make things much clearer.", "author": "arhimondr", "createdAt": "2020-06-18T03:05:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyNzM2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU1Mzc1OA==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r442553758", "bodyText": "The constructor is inline now.", "author": "viczhang861", "createdAt": "2020-06-18T23:29:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyNzM2NQ=="}], "type": "inlineReview", "revised_code": {"commit": "5217aa45e58861a5c1791f2f6fa0213f818b2426", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\nindex 50dd4e2f78..0660c3e391 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n\n@@ -2603,27 +2640,6 @@ public class HiveMetadata\n         return toCompletableFuture(stagingFileCommitter.commitFiles(session, handle.getSchemaName(), handle.getTableName(), getPartitionUpdates(fragments)));\n     }\n \n-    private HivePartitioningHandle createHivePartitioningHandle(\n-            int bucketCount,\n-            HiveBucketHandle hiveBucketHandle,\n-            Optional<HiveBucketProperty> bucketProperty,\n-            OptionalInt maxCompatibleBucketCount)\n-    {\n-        if (bucketProperty.isPresent() &&\n-                bucketProperty.get().getBucketFunctionType().equals(PRESTO_NATIVE)) {\n-            return createPrestoNativePartitioningHandle(\n-                    bucketCount,\n-                    bucketProperty.get().getTypes().get(),\n-                    maxCompatibleBucketCount);\n-        }\n-        return createHiveCompatiblePartitioningHandle(\n-                bucketCount,\n-                hiveBucketHandle.getColumns().stream()\n-                        .map(HiveColumnHandle::getHiveType)\n-                        .collect(toImmutableList()),\n-                maxCompatibleBucketCount);\n-    }\n-\n     private List<GrantInfo> buildGrants(SchemaTableName tableName, PrestoPrincipal principal)\n     {\n         ImmutableList.Builder<GrantInfo> result = ImmutableList.builder();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyNzU0NA==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r441727544", "bodyText": "Let's use hiveBucketHandle.getBucketCount() instead of passing it with parameter", "author": "arhimondr", "createdAt": "2020-06-17T17:57:53Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -2559,6 +2603,27 @@ public void revokeTablePrivileges(ConnectorSession session, SchemaTableName sche\n         return toCompletableFuture(stagingFileCommitter.commitFiles(session, handle.getSchemaName(), handle.getTableName(), getPartitionUpdates(fragments)));\n     }\n \n+    private HivePartitioningHandle createHivePartitioningHandle(\n+            int bucketCount,", "originalCommit": "7e955991e3e5ef07cebc131db15971c397ef60da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc3MjkxNQ==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r441772915", "bodyText": "One place is using getReadBucketCount(), the other place is using getTotalBucketCount()", "author": "viczhang861", "createdAt": "2020-06-17T19:08:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyNzU0NA=="}], "type": "inlineReview", "revised_code": {"commit": "5217aa45e58861a5c1791f2f6fa0213f818b2426", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\nindex 50dd4e2f78..0660c3e391 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n\n@@ -2603,27 +2640,6 @@ public class HiveMetadata\n         return toCompletableFuture(stagingFileCommitter.commitFiles(session, handle.getSchemaName(), handle.getTableName(), getPartitionUpdates(fragments)));\n     }\n \n-    private HivePartitioningHandle createHivePartitioningHandle(\n-            int bucketCount,\n-            HiveBucketHandle hiveBucketHandle,\n-            Optional<HiveBucketProperty> bucketProperty,\n-            OptionalInt maxCompatibleBucketCount)\n-    {\n-        if (bucketProperty.isPresent() &&\n-                bucketProperty.get().getBucketFunctionType().equals(PRESTO_NATIVE)) {\n-            return createPrestoNativePartitioningHandle(\n-                    bucketCount,\n-                    bucketProperty.get().getTypes().get(),\n-                    maxCompatibleBucketCount);\n-        }\n-        return createHiveCompatiblePartitioningHandle(\n-                bucketCount,\n-                hiveBucketHandle.getColumns().stream()\n-                        .map(HiveColumnHandle::getHiveType)\n-                        .collect(toImmutableList()),\n-                maxCompatibleBucketCount);\n-    }\n-\n     private List<GrantInfo> buildGrants(SchemaTableName tableName, PrestoPrincipal principal)\n     {\n         ImmutableList.Builder<GrantInfo> result = ImmutableList.builder();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyNzc2Nw==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r441727767", "bodyText": "Let's have a switch, similar to other places", "author": "arhimondr", "createdAt": "2020-06-17T17:58:15Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -2559,6 +2603,27 @@ public void revokeTablePrivileges(ConnectorSession session, SchemaTableName sche\n         return toCompletableFuture(stagingFileCommitter.commitFiles(session, handle.getSchemaName(), handle.getTableName(), getPartitionUpdates(fragments)));\n     }\n \n+    private HivePartitioningHandle createHivePartitioningHandle(\n+            int bucketCount,\n+            HiveBucketHandle hiveBucketHandle,\n+            Optional<HiveBucketProperty> bucketProperty,\n+            OptionalInt maxCompatibleBucketCount)\n+    {\n+        if (bucketProperty.isPresent() &&\n+                bucketProperty.get().getBucketFunctionType().equals(PRESTO_NATIVE)) {", "originalCommit": "7e955991e3e5ef07cebc131db15971c397ef60da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc5ODkxMw==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r441798913", "bodyText": "Since bucketProperty could be empty,  this function is a little different from other places:  if hive bucker property exists and indicates to use PRESTO_NATIVE, then use it, otherwise,  use the old way.", "author": "viczhang861", "createdAt": "2020-06-17T19:58:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyNzc2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk0MjM3OA==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r441942378", "bodyText": "It feels like the bucketProperty should be empty only if the table is virtually bucketed. Let's have a special case for that.", "author": "arhimondr", "createdAt": "2020-06-18T03:05:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyNzc2Nw=="}], "type": "inlineReview", "revised_code": {"commit": "5217aa45e58861a5c1791f2f6fa0213f818b2426", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\nindex 50dd4e2f78..0660c3e391 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n\n@@ -2603,27 +2640,6 @@ public class HiveMetadata\n         return toCompletableFuture(stagingFileCommitter.commitFiles(session, handle.getSchemaName(), handle.getTableName(), getPartitionUpdates(fragments)));\n     }\n \n-    private HivePartitioningHandle createHivePartitioningHandle(\n-            int bucketCount,\n-            HiveBucketHandle hiveBucketHandle,\n-            Optional<HiveBucketProperty> bucketProperty,\n-            OptionalInt maxCompatibleBucketCount)\n-    {\n-        if (bucketProperty.isPresent() &&\n-                bucketProperty.get().getBucketFunctionType().equals(PRESTO_NATIVE)) {\n-            return createPrestoNativePartitioningHandle(\n-                    bucketCount,\n-                    bucketProperty.get().getTypes().get(),\n-                    maxCompatibleBucketCount);\n-        }\n-        return createHiveCompatiblePartitioningHandle(\n-                bucketCount,\n-                hiveBucketHandle.getColumns().stream()\n-                        .map(HiveColumnHandle::getHiveType)\n-                        .collect(toImmutableList()),\n-                maxCompatibleBucketCount);\n-    }\n-\n     private List<GrantInfo> buildGrants(SchemaTableName tableName, PrestoPrincipal principal)\n     {\n         ImmutableList.Builder<GrantInfo> result = ImmutableList.builder();\n"}}, {"oid": "445f7132e30e48cfcec31cc9605822eecc6add01", "url": "https://github.com/prestodb/presto/commit/445f7132e30e48cfcec31cc9605822eecc6add01", "message": "Ignore HiveBucketFilter for buckted temporary table\n\n - Preicate for bucket columns of materialized temporary table is\n   pushed down, no bucket needs to be filtered.\n - Avoid inconsistency for calculation of bucket number using TypeInfo\n   when bucket function type is not HIVE_COMPATIBLE.", "committedDate": "2020-06-17T19:40:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk0MzM4Mw==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r441943383", "bodyText": "nit: Expected bucketFunctionType to be HIVE_COMPATIBLE, got %s ...", "author": "arhimondr", "createdAt": "2020-06-18T03:09:49Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketing.java", "diffHunk": "@@ -324,7 +343,10 @@ private static int hashBytes(int initialValue, Slice bytes)\n \n     private static Optional<Set<Integer>> getHiveBuckets(Table table, Map<ColumnHandle, Set<NullableValue>> bindings)\n     {\n-        List<String> bucketColumns = table.getStorage().getBucketProperty().get().getBucketedBy();\n+        HiveBucketProperty hiveBucketProperty = table.getStorage().getBucketProperty().get();\n+        checkArgument(hiveBucketProperty.getBucketFunctionType().equals(HIVE_COMPATIBLE),\n+                \"Expect hive compatible bucket function type to calculate bucket number based on Hive TypeInfo\");", "originalCommit": "445f7132e30e48cfcec31cc9605822eecc6add01", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5217aa45e58861a5c1791f2f6fa0213f818b2426", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketing.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketing.java\nindex 87560fef69..9825a96c6f 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketing.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveBucketing.java\n\n@@ -343,9 +343,13 @@ public final class HiveBucketing\n \n     private static Optional<Set<Integer>> getHiveBuckets(Table table, Map<ColumnHandle, Set<NullableValue>> bindings)\n     {\n+        if (bindings.isEmpty()) {\n+            return Optional.empty();\n+        }\n         HiveBucketProperty hiveBucketProperty = table.getStorage().getBucketProperty().get();\n         checkArgument(hiveBucketProperty.getBucketFunctionType().equals(HIVE_COMPATIBLE),\n-                \"Expect hive compatible bucket function type to calculate bucket number based on Hive TypeInfo\");\n+                \"bucketFunctionType is expected to be HIVE_COMPATIBLE, got: %s\",\n+                hiveBucketProperty.getBucketFunctionType());\n         List<String> bucketColumns = hiveBucketProperty.getBucketedBy();\n         if (bucketColumns.isEmpty()) {\n             return Optional.empty();\n"}}, {"oid": "5217aa45e58861a5c1791f2f6fa0213f818b2426", "url": "https://github.com/prestodb/presto/commit/5217aa45e58861a5c1791f2f6fa0213f818b2426", "message": "Ignore HiveBucketFilter for buckted temporary table\n\n - Preicate for bucket columns of materialized temporary table is\n   pushed down, no bucket needs to be filtered.\n - Avoid inconsistency for calculation of bucket number using TypeInfo\n   when bucket function type is not HIVE_COMPATIBLE.\n - Early return in getHiveBuckets method when bindings is empty.", "committedDate": "2020-06-18T22:56:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg3MjQwNA==", "url": "https://github.com/prestodb/presto/pull/14631#discussion_r442872404", "bodyText": "nit: new IllegalArgumentException(\"bucketProperty is expected to be present\")", "author": "arhimondr", "createdAt": "2020-06-19T14:27:45Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -2074,16 +2100,48 @@ public ConnectorTableLayout getTableLayout(ConnectorSession session, ConnectorTa\n         // never ignore table bucketing for temporary tables as those are created such explicitly by the engine request\n         boolean bucketExecutionEnabled = table.getTableType().equals(TEMPORARY_TABLE) || isBucketExecutionEnabled(session);\n         if (bucketExecutionEnabled && hiveLayoutHandle.getBucketHandle().isPresent()) {\n-            tablePartitioning = hiveLayoutHandle.getBucketHandle().map(hiveBucketHandle -> new ConnectorTablePartitioning(\n-                    new HivePartitioningHandle(\n-                            hiveBucketHandle.getReadBucketCount(),\n-                            hiveBucketHandle.getColumns().stream()\n-                                    .map(HiveColumnHandle::getHiveType)\n-                                    .collect(Collectors.toList()),\n-                            OptionalInt.empty()),\n+            HiveBucketHandle hiveBucketHandle = hiveLayoutHandle.getBucketHandle().get();\n+            HivePartitioningHandle partitioningHandle;\n+            int bucketCount = hiveBucketHandle.getReadBucketCount();\n+            OptionalInt maxCompatibleBucketCount = OptionalInt.empty();\n+\n+            // Virtually bucketed table does not have table bucket property\n+            if (hiveBucketHandle.isVirtuallyBucketed()) {\n+                partitioningHandle = createHiveCompatiblePartitioningHandle(\n+                        bucketCount,\n+                        hiveBucketHandle.getColumns().stream()\n+                                .map(HiveColumnHandle::getHiveType)\n+                                .collect(toImmutableList()),\n+                        maxCompatibleBucketCount);\n+            }\n+            else {\n+                HiveBucketProperty bucketProperty = table.getStorage().getBucketProperty()\n+                        .orElseThrow(() -> new NoSuchElementException(\"Bucket property should be set\"));", "originalCommit": "5217aa45e58861a5c1791f2f6fa0213f818b2426", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "177616ed61c94e17bb3ff7e86eb515d2acbb92df", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\nindex 0660c3e391..1d96adc970 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n\n@@ -2116,7 +2116,7 @@ public class HiveMetadata\n             }\n             else {\n                 HiveBucketProperty bucketProperty = table.getStorage().getBucketProperty()\n-                        .orElseThrow(() -> new NoSuchElementException(\"Bucket property should be set\"));\n+                        .orElseThrow(() -> new IllegalArgumentException(\"bucketProperty is expected to be present\"));\n                 switch (bucketProperty.getBucketFunctionType()) {\n                     case HIVE_COMPATIBLE:\n                         partitioningHandle = createHiveCompatiblePartitioningHandle(\n"}}, {"oid": "177616ed61c94e17bb3ff7e86eb515d2acbb92df", "url": "https://github.com/prestodb/presto/commit/177616ed61c94e17bb3ff7e86eb515d2acbb92df", "message": "Support all column types for hive temporary bucket table\n\nAdd PRESTO_NATIVE bucket function type to calculate bucket\nnumber for hive incompatible column types.", "committedDate": "2020-06-19T16:57:09Z", "type": "commit"}, {"oid": "d96510c03fc7097e716cf01cbd4514bf95c708a1", "url": "https://github.com/prestodb/presto/commit/d96510c03fc7097e716cf01cbd4514bf95c708a1", "message": "Refactor HiveBucketProperty constructor method\n\nExplicitly set BucketFunctionType to avoid that\nexpected types are missing.", "committedDate": "2020-06-19T16:57:14Z", "type": "commit"}, {"oid": "81b83a3e87c7a383b899396a72c893df6a7e872e", "url": "https://github.com/prestodb/presto/commit/81b83a3e87c7a383b899396a72c893df6a7e872e", "message": "Refactor getPartitionMetadata method\n\nAvoid unnecessary conversion to HiveBucketProperty.", "committedDate": "2020-06-19T16:57:14Z", "type": "commit"}, {"oid": "353bc38ea7dcb695510443e83b2803ff36c0a513", "url": "https://github.com/prestodb/presto/commit/353bc38ea7dcb695510443e83b2803ff36c0a513", "message": "Ignore HiveBucketFilter for buckted temporary table\n\n - Preicate for bucket columns of materialized temporary table is\n   pushed down, no bucket needs to be filtered.\n - Avoid inconsistency for calculation of bucket number using TypeInfo\n   when bucket function type is not HIVE_COMPATIBLE.\n - Early return in getHiveBuckets method when bindings is empty.", "committedDate": "2020-06-19T16:59:09Z", "type": "commit"}, {"oid": "353bc38ea7dcb695510443e83b2803ff36c0a513", "url": "https://github.com/prestodb/presto/commit/353bc38ea7dcb695510443e83b2803ff36c0a513", "message": "Ignore HiveBucketFilter for buckted temporary table\n\n - Preicate for bucket columns of materialized temporary table is\n   pushed down, no bucket needs to be filtered.\n - Avoid inconsistency for calculation of bucket number using TypeInfo\n   when bucket function type is not HIVE_COMPATIBLE.\n - Early return in getHiveBuckets method when bindings is empty.", "committedDate": "2020-06-19T16:59:09Z", "type": "forcePushed"}]}