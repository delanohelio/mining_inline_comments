{"pr_number": 14632, "pr_title": "Add allowed roles for HTTP endpoints", "pr_createdAt": "2020-06-10T23:50:33Z", "pr_url": "https://github.com/prestodb/presto/pull/14632", "timeline": [{"oid": "7d20f280bc648006f16758d11f87e7f5282094f5", "url": "https://github.com/prestodb/presto/commit/7d20f280bc648006f16758d11f87e7f5282094f5", "message": "Specify roles for Jersey resources", "committedDate": "2020-06-12T16:24:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEzMzAzMQ==", "url": "https://github.com/prestodb/presto/pull/14632#discussion_r441133031", "bodyText": "Let's have static constants", "author": "arhimondr", "createdAt": "2020-06-16T20:48:47Z", "path": "presto-main/src/main/java/com/facebook/presto/dispatcher/QueuedStatementResource.java", "diffHunk": "@@ -82,6 +83,7 @@\n import static javax.ws.rs.core.Response.Status.NOT_FOUND;\n \n @Path(\"/\")\n+@RolesAllowed(\"user\")", "originalCommit": "7d20f280bc648006f16758d11f87e7f5282094f5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "18a6de4bacd841d189c394daa4a7c0dc1ac94f2a", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/dispatcher/QueuedStatementResource.java b/presto-main/src/main/java/com/facebook/presto/dispatcher/QueuedStatementResource.java\nindex 35bc02a4af..4ea0bc3ef7 100644\n--- a/presto-main/src/main/java/com/facebook/presto/dispatcher/QueuedStatementResource.java\n+++ b/presto-main/src/main/java/com/facebook/presto/dispatcher/QueuedStatementResource.java\n\n@@ -83,7 +84,7 @@ import static javax.ws.rs.core.Response.Status.BAD_REQUEST;\n import static javax.ws.rs.core.Response.Status.NOT_FOUND;\n \n @Path(\"/\")\n-@RolesAllowed(\"user\")\n+@RolesAllowed(RoleType.USER)\n public class QueuedStatementResource\n {\n     private static final Logger log = Logger.get(QueuedStatementResource.class);\n"}}, {"oid": "18a6de4bacd841d189c394daa4a7c0dc1ac94f2a", "url": "https://github.com/prestodb/presto/commit/18a6de4bacd841d189c394daa4a7c0dc1ac94f2a", "message": "Add static constants for RoleType", "committedDate": "2020-06-17T18:44:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc1NzI5Mg==", "url": "https://github.com/prestodb/presto/pull/14632#discussion_r441757292", "bodyText": "nit: prefer static imports", "author": "arhimondr", "createdAt": "2020-06-17T18:49:24Z", "path": "presto-main/src/main/java/com/facebook/presto/dispatcher/QueuedStatementResource.java", "diffHunk": "@@ -82,6 +84,7 @@\n import static javax.ws.rs.core.Response.Status.NOT_FOUND;\n \n @Path(\"/\")\n+@RolesAllowed(RoleType.USER)", "originalCommit": "18a6de4bacd841d189c394daa4a7c0dc1ac94f2a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2eed3bd6c27d22a4e7ba2a2d12ad7dd1c0fd27df", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/dispatcher/QueuedStatementResource.java b/presto-main/src/main/java/com/facebook/presto/dispatcher/QueuedStatementResource.java\nindex 4ea0bc3ef7..67093da07f 100644\n--- a/presto-main/src/main/java/com/facebook/presto/dispatcher/QueuedStatementResource.java\n+++ b/presto-main/src/main/java/com/facebook/presto/dispatcher/QueuedStatementResource.java\n\n@@ -84,7 +84,7 @@ import static javax.ws.rs.core.Response.Status.BAD_REQUEST;\n import static javax.ws.rs.core.Response.Status.NOT_FOUND;\n \n @Path(\"/\")\n-@RolesAllowed(RoleType.USER)\n+@RolesAllowed(USER)\n public class QueuedStatementResource\n {\n     private static final Logger log = Logger.get(QueuedStatementResource.class);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc2MTU3OQ==", "url": "https://github.com/prestodb/presto/pull/14632#discussion_r441761579", "bodyText": "I believe that we should move this class to presto-common package. @arhimondr - thoughts?", "author": "mayankgarg1990", "createdAt": "2020-06-17T18:53:17Z", "path": "presto-main/src/main/java/com/facebook/presto/server/security/RoleType.java", "diffHunk": "@@ -0,0 +1,10 @@\n+package com.facebook.presto.server.security;\n+\n+public final class RoleType", "originalCommit": "18a6de4bacd841d189c394daa4a7c0dc1ac94f2a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc3MTExNg==", "url": "https://github.com/prestodb/presto/pull/14632#discussion_r441771116", "bodyText": "Package com.facebook.presto.common.type seems like a fair option.", "author": "zacw7", "createdAt": "2020-06-17T19:05:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc2MTU3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk0NDc2OA==", "url": "https://github.com/prestodb/presto/pull/14632#discussion_r441944768", "bodyText": "If we really want to have authz for Presto proxy, then we should move it to presto-common. Importing presto-main to presto-proxy is definitely bad idea.", "author": "arhimondr", "createdAt": "2020-06-18T03:15:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc2MTU3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "fcdbc73ad2dff284f15616921fcf5bf4601355d2", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/server/security/RoleType.java b/presto-main/src/main/java/com/facebook/presto/server/security/RoleType.java\nindex 2e7a34597d..2d380cda7b 100644\n--- a/presto-main/src/main/java/com/facebook/presto/server/security/RoleType.java\n+++ b/presto-main/src/main/java/com/facebook/presto/server/security/RoleType.java\n\n@@ -1,3 +1,16 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n package com.facebook.presto.server.security;\n \n public final class RoleType\n"}}, {"oid": "2eed3bd6c27d22a4e7ba2a2d12ad7dd1c0fd27df", "url": "https://github.com/prestodb/presto/commit/2eed3bd6c27d22a4e7ba2a2d12ad7dd1c0fd27df", "message": "Add static constants for RoleType", "committedDate": "2020-06-17T19:00:04Z", "type": "forcePushed"}, {"oid": "af16a01022eac061fd6a5bfff224f5c179a101a2", "url": "https://github.com/prestodb/presto/commit/af16a01022eac061fd6a5bfff224f5c179a101a2", "message": "Add static constants for RoleType", "committedDate": "2020-06-17T19:02:08Z", "type": "forcePushed"}, {"oid": "fcdbc73ad2dff284f15616921fcf5bf4601355d2", "url": "https://github.com/prestodb/presto/commit/fcdbc73ad2dff284f15616921fcf5bf4601355d2", "message": "Remove authorization for ProxyResource", "committedDate": "2020-06-18T16:49:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyMTA3OQ==", "url": "https://github.com/prestodb/presto/pull/14632#discussion_r448321079", "bodyText": "This is used by the UI which is generally visible to everyone - should this be just ADMIN? I believe that we should add USER here as well. Thoughts @arhimondr ?", "author": "mayankgarg1990", "createdAt": "2020-07-01T12:14:34Z", "path": "presto-main/src/main/java/com/facebook/presto/server/ClusterStatsResource.java", "diffHunk": "@@ -22,17 +22,20 @@\n import com.fasterxml.jackson.annotation.JsonCreator;\n import com.fasterxml.jackson.annotation.JsonProperty;\n \n+import javax.annotation.security.RolesAllowed;\n import javax.inject.Inject;\n import javax.ws.rs.GET;\n import javax.ws.rs.Path;\n import javax.ws.rs.Produces;\n import javax.ws.rs.core.MediaType;\n import javax.ws.rs.core.Response;\n \n+import static com.facebook.presto.server.security.RoleType.ADMIN;\n import static java.util.Objects.requireNonNull;\n import static java.util.concurrent.TimeUnit.SECONDS;\n \n @Path(\"/v1/cluster\")\n+@RolesAllowed(ADMIN)", "originalCommit": "a8d428082bbd487406cef4b9575b6df0e7cdb5a3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7f90d67c5d8a13950327e28e8a62d449bae74674", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/server/ClusterStatsResource.java b/presto-main/src/main/java/com/facebook/presto/server/ClusterStatsResource.java\nindex 7ff99bae4c..e5ac97c613 100644\n--- a/presto-main/src/main/java/com/facebook/presto/server/ClusterStatsResource.java\n+++ b/presto-main/src/main/java/com/facebook/presto/server/ClusterStatsResource.java\n\n@@ -31,11 +31,12 @@ import javax.ws.rs.core.MediaType;\n import javax.ws.rs.core.Response;\n \n import static com.facebook.presto.server.security.RoleType.ADMIN;\n+import static com.facebook.presto.server.security.RoleType.USER;\n import static java.util.Objects.requireNonNull;\n import static java.util.concurrent.TimeUnit.SECONDS;\n \n @Path(\"/v1/cluster\")\n-@RolesAllowed(ADMIN)\n+@RolesAllowed({ADMIN, USER})\n public class ClusterStatsResource\n {\n     private final InternalNodeManager nodeManager;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyMjgzNA==", "url": "https://github.com/prestodb/presto/pull/14632#discussion_r448322834", "bodyText": "This can also be used in UIs to serve information - should we also open this up to users?", "author": "mayankgarg1990", "createdAt": "2020-07-01T12:18:02Z", "path": "presto-main/src/main/java/com/facebook/presto/server/QueryStateInfoResource.java", "diffHunk": "@@ -35,12 +36,14 @@\n import static com.facebook.presto.execution.QueryState.QUEUED;\n import static com.facebook.presto.server.QueryStateInfo.createQueryStateInfo;\n import static com.facebook.presto.server.QueryStateInfo.createQueuedQueryStateInfo;\n+import static com.facebook.presto.server.security.RoleType.ADMIN;\n import static com.google.common.base.Strings.isNullOrEmpty;\n import static com.google.common.collect.ImmutableList.toImmutableList;\n import static java.util.Objects.requireNonNull;\n import static javax.ws.rs.core.Response.Status.NOT_FOUND;\n \n @Path(\"/v1/queryState\")\n+@RolesAllowed(ADMIN)", "originalCommit": "a8d428082bbd487406cef4b9575b6df0e7cdb5a3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7f90d67c5d8a13950327e28e8a62d449bae74674", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/server/QueryStateInfoResource.java b/presto-main/src/main/java/com/facebook/presto/server/QueryStateInfoResource.java\nindex ec02fa0e63..0e319a95fb 100644\n--- a/presto-main/src/main/java/com/facebook/presto/server/QueryStateInfoResource.java\n+++ b/presto-main/src/main/java/com/facebook/presto/server/QueryStateInfoResource.java\n\n@@ -37,13 +37,14 @@ import static com.facebook.presto.execution.QueryState.QUEUED;\n import static com.facebook.presto.server.QueryStateInfo.createQueryStateInfo;\n import static com.facebook.presto.server.QueryStateInfo.createQueuedQueryStateInfo;\n import static com.facebook.presto.server.security.RoleType.ADMIN;\n+import static com.facebook.presto.server.security.RoleType.USER;\n import static com.google.common.base.Strings.isNullOrEmpty;\n import static com.google.common.collect.ImmutableList.toImmutableList;\n import static java.util.Objects.requireNonNull;\n import static javax.ws.rs.core.Response.Status.NOT_FOUND;\n \n @Path(\"/v1/queryState\")\n-@RolesAllowed(ADMIN)\n+@RolesAllowed({ADMIN, USER})\n public class QueryStateInfoResource\n {\n     private final DispatchManager dispatchManager;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyNTU0OA==", "url": "https://github.com/prestodb/presto/pull/14632#discussion_r448325548", "bodyText": "This is used in QueryResult to allow for users to cancel their query - we should make this USER", "author": "mayankgarg1990", "createdAt": "2020-07-01T12:23:27Z", "path": "presto-main/src/main/java/com/facebook/presto/server/StageResource.java", "diffHunk": "@@ -16,14 +16,17 @@\n import com.facebook.presto.execution.QueryManager;\n import com.facebook.presto.execution.StageId;\n \n+import javax.annotation.security.RolesAllowed;\n import javax.inject.Inject;\n import javax.ws.rs.DELETE;\n import javax.ws.rs.Path;\n import javax.ws.rs.PathParam;\n \n+import static com.facebook.presto.server.security.RoleType.ADMIN;\n import static java.util.Objects.requireNonNull;\n \n @Path(\"/v1/stage\")\n+@RolesAllowed(ADMIN)", "originalCommit": "a8d428082bbd487406cef4b9575b6df0e7cdb5a3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7f90d67c5d8a13950327e28e8a62d449bae74674", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/server/StageResource.java b/presto-main/src/main/java/com/facebook/presto/server/StageResource.java\nindex 2103c72d9b..2463f50fd1 100644\n--- a/presto-main/src/main/java/com/facebook/presto/server/StageResource.java\n+++ b/presto-main/src/main/java/com/facebook/presto/server/StageResource.java\n\n@@ -22,11 +22,11 @@ import javax.ws.rs.DELETE;\n import javax.ws.rs.Path;\n import javax.ws.rs.PathParam;\n \n-import static com.facebook.presto.server.security.RoleType.ADMIN;\n+import static com.facebook.presto.server.security.RoleType.USER;\n import static java.util.Objects.requireNonNull;\n \n @Path(\"/v1/stage\")\n-@RolesAllowed(ADMIN)\n+@RolesAllowed(USER)\n public class StageResource\n {\n     private final QueryManager queryManager;\n"}}, {"oid": "fbfbef74f0da07b4a221be2d12da25edbdf01dc1", "url": "https://github.com/prestodb/presto/commit/fbfbef74f0da07b4a221be2d12da25edbdf01dc1", "message": "Specify roles for Jetty servlet", "committedDate": "2020-07-01T22:26:45Z", "type": "forcePushed"}, {"oid": "7f90d67c5d8a13950327e28e8a62d449bae74674", "url": "https://github.com/prestodb/presto/commit/7f90d67c5d8a13950327e28e8a62d449bae74674", "message": "Specify allowed roles for HTTP endpoints", "committedDate": "2020-07-06T18:39:46Z", "type": "commit"}, {"oid": "7f90d67c5d8a13950327e28e8a62d449bae74674", "url": "https://github.com/prestodb/presto/commit/7f90d67c5d8a13950327e28e8a62d449bae74674", "message": "Specify allowed roles for HTTP endpoints", "committedDate": "2020-07-06T18:39:46Z", "type": "forcePushed"}]}