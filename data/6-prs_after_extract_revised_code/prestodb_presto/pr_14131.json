{"pr_number": 14131, "pr_title": "Use concurrent scheduler for timeout executor", "pr_createdAt": "2020-02-21T00:20:18Z", "pr_url": "https://github.com/prestodb/presto/pull/14131", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcwNjM4MA==", "url": "https://github.com/prestodb/presto/pull/14131#discussion_r382706380", "bodyText": "Number of threads and concurrency is not totally clear because usually those are these same thing. What is the documentation update associated with this change? Can we make it clearer both in the code and in the docs how this config should be used?\nAlso the fact that division takes place here https://github.com/prestodb/airlift/blob/master/concurrent/src/main/java/com/facebook/airlift/concurrent/ConcurrentScheduledExecutor.java#L77 and you might get less threads than you asked for is not intuitive.\nIdeally the config would be # of executors and # of threads per executor. I am guessing we did it this way to maintain compatibility with existing configuration?", "author": "aweisberg", "createdAt": "2020-02-21T17:21:06Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java", "diffHunk": "@@ -455,6 +456,19 @@ public TaskManagerConfig setHttpTimeoutThreads(int httpTimeoutThreads)\n         return this;\n     }\n \n+    @Min(1)\n+    public int getHttpTimeoutConcurrency()\n+    {\n+        return httpTimeoutConcurrency;\n+    }\n+\n+    @Config(\"task.http-timeout-concurrency\")", "originalCommit": "d1594a0d9d091c373e840f2b26c04ef9f5c498a7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjczMzkyMg==", "url": "https://github.com/prestodb/presto/pull/14131#discussion_r382733922", "bodyText": "@aweisberg : Try to press \"y\" on the Github source page to get commit id attached to the link ;) . Otherwise the link might expire once the file changed\nhttps://github.com/prestodb/airlift/blob/49d3830a5bee4804c91e3355d65c44267e4bde40/concurrent/src/main/java/com/facebook/airlift/concurrent/ConcurrentScheduledExecutor.java#L77", "author": "wenleix", "createdAt": "2020-02-21T18:21:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcwNjM4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjczNDQ4Nw==", "url": "https://github.com/prestodb/presto/pull/14131#discussion_r382734487", "bodyText": "I agree with @aweisberg . I also don't understand what's the difference between \"concurrency\" and \"threads\".\nOtherwise, the PR looks good :)", "author": "wenleix", "createdAt": "2020-02-21T18:23:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcwNjM4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc0NjIzMg==", "url": "https://github.com/prestodb/presto/pull/14131#discussion_r382746232", "bodyText": "I knew it was broken the moment I did it. And I was like... ahhh it will be right long enough for us to finish this. Thanks for the tip.", "author": "aweisberg", "createdAt": "2020-02-21T18:48:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcwNjM4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc3NjA0NA==", "url": "https://github.com/prestodb/presto/pull/14131#discussion_r382776044", "bodyText": "@aweisberg @wenleix  The naming and calculation of threads per executor follows convention in https://github.com/prestodb/airlift/blob/49d3830a5bee4804c91e3355d65c44267e4bde40/http-client/src/main/java/com/facebook/airlift/http/client/HttpClientConfig.java#L545-L565\nIt is OK to have minimum threads per pool * pool number < total threads limit.  Maximal threads in each pool is unchanged (default to Integer.MAX_VALUE).\nFor backward compatibility,  keep the concept of existing task.http-timeout-threads is desired . Users can optionally add new property task.http-timeout-concurrency for better scalability.\nExplanations of these properties are added inline.", "author": "viczhang861", "createdAt": "2020-02-21T19:53:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcwNjM4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzA4NTUyMA==", "url": "https://github.com/prestodb/presto/pull/14131#discussion_r383085520", "bodyText": "@viczhang861 : Thanks @viczhang861  for the explanation. LGTM.", "author": "wenleix", "createdAt": "2020-02-24T04:53:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcwNjM4MA=="}], "type": "inlineReview", "revised_code": {"commit": "4935c278d1ac8fb7bb56afee86cfc8646202f693", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java b/presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java\nindex f66f83a93c..a1a8a44866 100644\n--- a/presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java\n+++ b/presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java\n\n@@ -450,6 +450,7 @@ public class TaskManagerConfig\n     }\n \n     @Config(\"task.http-timeout-threads\")\n+    @ConfigDescription(\"Total number of timeout threads\")\n     public TaskManagerConfig setHttpTimeoutThreads(int httpTimeoutThreads)\n     {\n         this.httpTimeoutThreads = httpTimeoutThreads;\n"}}, {"oid": "4935c278d1ac8fb7bb56afee86cfc8646202f693", "url": "https://github.com/prestodb/presto/commit/4935c278d1ac8fb7bb56afee86cfc8646202f693", "message": "Use concurrent scheduler for timeout executor\n\nUse multiple thread pool (configured by task.http-timeout-concurrency)\nfor timeout thread and avoid contention during task scheduling.", "committedDate": "2020-02-21T19:40:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM0OTcwNg==", "url": "https://github.com/prestodb/presto/pull/14131#discussion_r383349706", "bodyText": "Total number of threads dedicated to run timeout handlers of http requests", "author": "arhimondr", "createdAt": "2020-02-24T15:54:41Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java", "diffHunk": "@@ -449,12 +450,27 @@ public int getHttpTimeoutThreads()\n     }\n \n     @Config(\"task.http-timeout-threads\")\n+    @ConfigDescription(\"Total number of timeout threads\")", "originalCommit": "4935c278d1ac8fb7bb56afee86cfc8646202f693", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ2MDI3Nw==", "url": "https://github.com/prestodb/presto/pull/14131#discussion_r383460277", "bodyText": "What I would say is\nTotal number of timeout threads across all timeout thread pools", "author": "aweisberg", "createdAt": "2020-02-24T19:15:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM0OTcwNg=="}], "type": "inlineReview", "revised_code": {"commit": "21f228181067052a180d317fc10a3706cdad16ab", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java b/presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java\nindex a1a8a44866..bc8e94bc4f 100644\n--- a/presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java\n+++ b/presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java\n\n@@ -450,7 +450,7 @@ public class TaskManagerConfig\n     }\n \n     @Config(\"task.http-timeout-threads\")\n-    @ConfigDescription(\"Total number of timeout threads\")\n+    @ConfigDescription(\"Total number of timeout threads across all timeout thread pools\")\n     public TaskManagerConfig setHttpTimeoutThreads(int httpTimeoutThreads)\n     {\n         this.httpTimeoutThreads = httpTimeoutThreads;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM1NTQ1OQ==", "url": "https://github.com/prestodb/presto/pull/14131#discussion_r383355459", "bodyText": "Maybe\nThe estimated number of timeout handlers being attached concurrently? Or something similar?\nBasically in the description we should express that those two properties are different, and are used to configure different concurrency level.\n\ntask.http-timeout-threads - number of threads that are processing timeout handlers\ntask.http-timeout-concurrency - estimated number of threads (or estimated thread congestion) when attaching timeout handlers", "author": "arhimondr", "createdAt": "2020-02-24T16:03:29Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java", "diffHunk": "@@ -449,12 +450,27 @@ public int getHttpTimeoutThreads()\n     }\n \n     @Config(\"task.http-timeout-threads\")\n+    @ConfigDescription(\"Total number of timeout threads\")\n     public TaskManagerConfig setHttpTimeoutThreads(int httpTimeoutThreads)\n     {\n         this.httpTimeoutThreads = httpTimeoutThreads;\n         return this;\n     }\n \n+    @Min(1)\n+    public int getHttpTimeoutConcurrency()\n+    {\n+        return httpTimeoutConcurrency;\n+    }\n+\n+    @Config(\"task.http-timeout-concurrency\")\n+    @ConfigDescription(\"Number of thread pool to divide threads configured by property task.http-timeout-threads\")", "originalCommit": "4935c278d1ac8fb7bb56afee86cfc8646202f693", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM3MzEyOA==", "url": "https://github.com/prestodb/presto/pull/14131#discussion_r383373128", "bodyText": "How about The maximal number of http request timeout handlers being attached concurrently ?", "author": "viczhang861", "createdAt": "2020-02-24T16:31:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM1NTQ1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM4MDk2Mg==", "url": "https://github.com/prestodb/presto/pull/14131#discussion_r383380962", "bodyText": "@aweisberg @wenleix ?", "author": "arhimondr", "createdAt": "2020-02-24T16:43:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM1NTQ1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ2MDg4NQ==", "url": "https://github.com/prestodb/presto/pull/14131#discussion_r383460885", "bodyText": "Number of thread pools to handle timeouts. Threads per pool is http-timeout-threads / http-timeout-concurrency", "author": "aweisberg", "createdAt": "2020-02-24T19:16:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM1NTQ1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU0NzIxMg==", "url": "https://github.com/prestodb/presto/pull/14131#discussion_r383547212", "bodyText": "Sounds good to me :).  I think these two configs are inherently complicated (inherited from airlift) so we probably just want to make sure it's well documented .", "author": "wenleix", "createdAt": "2020-02-24T22:16:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM1NTQ1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "21f228181067052a180d317fc10a3706cdad16ab", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java b/presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java\nindex a1a8a44866..bc8e94bc4f 100644\n--- a/presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java\n+++ b/presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java\n\n@@ -450,7 +450,7 @@ public class TaskManagerConfig\n     }\n \n     @Config(\"task.http-timeout-threads\")\n-    @ConfigDescription(\"Total number of timeout threads\")\n+    @ConfigDescription(\"Total number of timeout threads across all timeout thread pools\")\n     public TaskManagerConfig setHttpTimeoutThreads(int httpTimeoutThreads)\n     {\n         this.httpTimeoutThreads = httpTimeoutThreads;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM1NzM2OA==", "url": "https://github.com/prestodb/presto/pull/14131#discussion_r383357368", "bodyText": "The ScheduledExecutorService does not expose any JMX properties by itself. Instead some kind of ConcurrentScheduledExecutorMBean has to be implemented. The ConcurrentScheduledExecutorMBean should expose ConcurrentScheduledExecutor specific statistics, similar to how the ThreadPoolExecutorMBean exposes the stats for ThreadPoolExecutor.\nWe can do this as a follow up. As for now i would rather prefer the  timeoutExecutor to be completely removed. As since it is does not provide any MXBean stats keeping it here is only misleading.", "author": "arhimondr", "createdAt": "2020-02-24T16:06:33Z", "path": "presto-main/src/main/java/com/facebook/presto/server/AsyncHttpExecutionMBean.java", "diffHunk": "@@ -28,15 +28,15 @@\n public class AsyncHttpExecutionMBean\n {\n     private final ThreadPoolExecutorMBean responseExecutor;\n-    private final ThreadPoolExecutorMBean timeoutExecutor;\n+    private final ScheduledExecutorService timeoutExecutor;", "originalCommit": "4935c278d1ac8fb7bb56afee86cfc8646202f693", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU0NjczNQ==", "url": "https://github.com/prestodb/presto/pull/14131#discussion_r383546735", "bodyText": "Agreed. Sounds like a good follow-up :)", "author": "wenleix", "createdAt": "2020-02-24T22:15:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM1NzM2OA=="}], "type": "inlineReview", "revised_code": {"commit": "21f228181067052a180d317fc10a3706cdad16ab", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/server/AsyncHttpExecutionMBean.java b/presto-main/src/main/java/com/facebook/presto/server/AsyncHttpExecutionMBean.java\nindex 151dfc0c0e..7b2cab7806 100644\n--- a/presto-main/src/main/java/com/facebook/presto/server/AsyncHttpExecutionMBean.java\n+++ b/presto-main/src/main/java/com/facebook/presto/server/AsyncHttpExecutionMBean.java\n\n@@ -28,15 +28,11 @@ import static java.util.Objects.requireNonNull;\n public class AsyncHttpExecutionMBean\n {\n     private final ThreadPoolExecutorMBean responseExecutor;\n-    private final ScheduledExecutorService timeoutExecutor;\n \n     @Inject\n-    public AsyncHttpExecutionMBean(@ForAsyncRpc ExecutorService responseExecutor, @ForAsyncRpc ScheduledExecutorService timeoutExecutor)\n+    public AsyncHttpExecutionMBean(@ForAsyncRpc ExecutorService responseExecutor)\n     {\n-        requireNonNull(responseExecutor, \"responseExecutor is null\");\n-        requireNonNull(timeoutExecutor, \"timeoutExecutor is null\");\n-        this.responseExecutor = new ThreadPoolExecutorMBean((ThreadPoolExecutor) responseExecutor);\n-        this.timeoutExecutor = timeoutExecutor;\n+        this.responseExecutor = new ThreadPoolExecutorMBean((ThreadPoolExecutor) requireNonNull(responseExecutor, \"responseExecutor is null\"));\n     }\n \n     @Managed\n"}}, {"oid": "21f228181067052a180d317fc10a3706cdad16ab", "url": "https://github.com/prestodb/presto/commit/21f228181067052a180d317fc10a3706cdad16ab", "message": "Use concurrent scheduler for timeout executor\n\nUse multiple thread pool (configured by task.http-timeout-concurrency)\nfor timeout thread and avoid contention during task scheduling.", "committedDate": "2020-02-25T00:13:43Z", "type": "forcePushed"}, {"oid": "ac0851299f1f03394aa51be7c01851f3245d4dd8", "url": "https://github.com/prestodb/presto/commit/ac0851299f1f03394aa51be7c01851f3245d4dd8", "message": "Use concurrent scheduler for timeout executor\n\nUse multiple thread pool (configured by task.http-timeout-concurrency)\nfor timeout thread and avoid contention during task scheduling.", "committedDate": "2020-02-25T00:19:23Z", "type": "commit"}, {"oid": "ac0851299f1f03394aa51be7c01851f3245d4dd8", "url": "https://github.com/prestodb/presto/commit/ac0851299f1f03394aa51be7c01851f3245d4dd8", "message": "Use concurrent scheduler for timeout executor\n\nUse multiple thread pool (configured by task.http-timeout-concurrency)\nfor timeout thread and avoid contention during task scheduling.", "committedDate": "2020-02-25T00:19:23Z", "type": "forcePushed"}]}