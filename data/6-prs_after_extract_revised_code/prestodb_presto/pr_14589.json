{"pr_number": 14589, "pr_title": "Do not return MapBlock's hashtables in Optional", "pr_createdAt": "2020-05-29T07:32:25Z", "pr_url": "https://github.com/prestodb/presto/pull/14589", "timeline": [{"oid": "90db029e63c770082352a5ed5c0a5381dd8a4b4b", "url": "https://github.com/prestodb/presto/commit/90db029e63c770082352a5ed5c0a5381dd8a4b4b", "message": "Do not return MapBlock's hashtables in Optional\n\nIn recent production workload we observed large amount of memory\nallocation on the Optional objects when getting a MapBlock's hashtables.\nThis commit directly returns the hashtables in raw int array without\nwrapping it up with Optional.", "committedDate": "2020-05-29T09:44:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI2MTA1Mg==", "url": "https://github.com/prestodb/presto/pull/14589#discussion_r433261052", "bodyText": "nit: add @nullable here as well?", "author": "mbasmanova", "createdAt": "2020-06-01T14:17:15Z", "path": "presto-common/src/main/java/com/facebook/presto/common/block/ColumnarMap.java", "diffHunk": "@@ -217,9 +217,9 @@ public Type getKeyType()\n         return keyType;\n     }\n \n-    public Optional<int[]> getHashTables()\n+    public int[] getHashTables()", "originalCommit": "90db029e63c770082352a5ed5c0a5381dd8a4b4b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4bfcb89abf611471930ede17a1a701dde0c8e3a4", "chunk": "diff --git a/presto-common/src/main/java/com/facebook/presto/common/block/ColumnarMap.java b/presto-common/src/main/java/com/facebook/presto/common/block/ColumnarMap.java\nindex efe7223883..eba10171d6 100644\n--- a/presto-common/src/main/java/com/facebook/presto/common/block/ColumnarMap.java\n+++ b/presto-common/src/main/java/com/facebook/presto/common/block/ColumnarMap.java\n\n@@ -217,6 +217,7 @@ public class ColumnarMap\n         return keyType;\n     }\n \n+    @Nullable\n     public int[] getHashTables()\n     {\n         return hashTables;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI2MTMzMA==", "url": "https://github.com/prestodb/presto/pull/14589#discussion_r433261330", "bodyText": "nit: empty -> null here and in other places", "author": "mbasmanova", "createdAt": "2020-06-01T14:17:43Z", "path": "presto-common/src/main/java/com/facebook/presto/common/block/MapBlockBuilder.java", "diffHunk": "@@ -203,14 +203,14 @@ public BlockBuilder closeEntry()\n         int previousAggregatedEntryCount = offsets[positionCount - 1];\n         int aggregatedEntryCount = offsets[positionCount];\n         int entryCount = aggregatedEntryCount - previousAggregatedEntryCount;\n-        Optional<int[]> rawHashTables = hashTables.get();\n-        verify(rawHashTables.isPresent(), \"rawHashTables is empty\");\n+        int[] rawHashTables = hashTables.get();\n+        verify(rawHashTables != null, \"rawHashTables is empty\");", "originalCommit": "90db029e63c770082352a5ed5c0a5381dd8a4b4b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4bfcb89abf611471930ede17a1a701dde0c8e3a4", "chunk": "diff --git a/presto-common/src/main/java/com/facebook/presto/common/block/MapBlockBuilder.java b/presto-common/src/main/java/com/facebook/presto/common/block/MapBlockBuilder.java\nindex b2a4f88d06..3c04cb91b1 100644\n--- a/presto-common/src/main/java/com/facebook/presto/common/block/MapBlockBuilder.java\n+++ b/presto-common/src/main/java/com/facebook/presto/common/block/MapBlockBuilder.java\n\n@@ -204,7 +204,7 @@ public class MapBlockBuilder\n         int aggregatedEntryCount = offsets[positionCount];\n         int entryCount = aggregatedEntryCount - previousAggregatedEntryCount;\n         int[] rawHashTables = hashTables.get();\n-        verify(rawHashTables != null, \"rawHashTables is empty\");\n+        verify(rawHashTables != null, \"rawHashTables is null\");\n         buildHashTable(\n                 keyBlockBuilder,\n                 previousAggregatedEntryCount,\n"}}, {"oid": "4bfcb89abf611471930ede17a1a701dde0c8e3a4", "url": "https://github.com/prestodb/presto/commit/4bfcb89abf611471930ede17a1a701dde0c8e3a4", "message": "Do not return MapBlock's hashtables in Optional\n\nIn recent production workload we observed large amount of memory\nallocation on the Optional objects when getting a MapBlock's hashtables,\nand it resulted in high GC activities that could lead to reliability\nissues. This commit directly returns the hashtables in raw int array\nwithout wrapping it up with Optional.", "committedDate": "2020-06-02T04:29:41Z", "type": "commit"}, {"oid": "4bfcb89abf611471930ede17a1a701dde0c8e3a4", "url": "https://github.com/prestodb/presto/commit/4bfcb89abf611471930ede17a1a701dde0c8e3a4", "message": "Do not return MapBlock's hashtables in Optional\n\nIn recent production workload we observed large amount of memory\nallocation on the Optional objects when getting a MapBlock's hashtables,\nand it resulted in high GC activities that could lead to reliability\nissues. This commit directly returns the hashtables in raw int array\nwithout wrapping it up with Optional.", "committedDate": "2020-06-02T04:29:41Z", "type": "forcePushed"}]}