{"pr_number": 14101, "pr_title": "Remove forceLocalScheduling for hive connector", "pr_createdAt": "2020-02-14T03:32:26Z", "pr_url": "https://github.com/prestodb/presto/pull/14101", "timeline": [{"oid": "c3779c5e8d6d49d28bb97988cbf995f4dff9aab5", "url": "https://github.com/prestodb/presto/commit/c3779c5e8d6d49d28bb97988cbf995f4dff9aab5", "message": "Remove forceLocalScheduling for hive connector\n\nAs we already have NodeSelectionStrategy to indicate node selection affinity,\ndeprecate forceLocalScheduling.", "committedDate": "2020-02-14T04:29:34Z", "type": "forcePushed"}, {"oid": "90bd86a2ad03304c2ca9cf0023fcee7692270dbd", "url": "https://github.com/prestodb/presto/commit/90bd86a2ad03304c2ca9cf0023fcee7692270dbd", "message": "Remove forceLocalScheduling for hive connector\n\nAs we already have NodeSelectionStrategy to indicate node selection affinity,\ndeprecate forceLocalScheduling.", "committedDate": "2020-02-14T06:58:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMwMzE2MQ==", "url": "https://github.com/prestodb/presto/pull/14101#discussion_r379303161", "bodyText": "boolean forceLocalScheduling = nodeSelectionStrategy == HARD_AFFINITY", "author": "highker", "createdAt": "2020-02-14T08:30:51Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/util/InternalHiveSplitFactory.java", "diffHunk": "@@ -133,15 +130,11 @@ public InternalHiveSplitFactory(\n             return Optional.empty();\n         }\n \n-        boolean forceLocalScheduling = this.forceLocalScheduling;", "originalCommit": "90bd86a2ad03304c2ca9cf0023fcee7692270dbd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1d0dd121e20ec8e182c0f427ab603997fc333d54", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/util/InternalHiveSplitFactory.java b/presto-hive/src/main/java/com/facebook/presto/hive/util/InternalHiveSplitFactory.java\nindex 42348e6c29..2812c9cf4f 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/util/InternalHiveSplitFactory.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/util/InternalHiveSplitFactory.java\n\n@@ -130,11 +129,14 @@ public class InternalHiveSplitFactory\n             return Optional.empty();\n         }\n \n+        boolean forceLocalScheduling = this.nodeSelectionStrategy == HARD_AFFINITY;\n         // For empty files, some filesystem (e.g. LocalFileSystem) produce one empty block\n         // while others (e.g. hdfs.DistributedFileSystem) produces no block.\n         // Synthesize an empty block if one does not already exist.\n         if (fileSize == 0 && blockLocations.length == 0) {\n             blockLocations = new BlockLocation[] {new BlockLocation()};\n+            // Turn off force local scheduling because hosts list doesn't exist.\n+            forceLocalScheduling = false;\n         }\n \n         ImmutableList.Builder<InternalHiveBlock> blockBuilder = ImmutableList.builder();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMwMzE5MA==", "url": "https://github.com/prestodb/presto/pull/14101#discussion_r379303190", "bodyText": "keep", "author": "highker", "createdAt": "2020-02-14T08:30:56Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/util/InternalHiveSplitFactory.java", "diffHunk": "@@ -133,15 +130,11 @@ public InternalHiveSplitFactory(\n             return Optional.empty();\n         }\n \n-        boolean forceLocalScheduling = this.forceLocalScheduling;\n-\n         // For empty files, some filesystem (e.g. LocalFileSystem) produce one empty block\n         // while others (e.g. hdfs.DistributedFileSystem) produces no block.\n         // Synthesize an empty block if one does not already exist.\n         if (fileSize == 0 && blockLocations.length == 0) {\n             blockLocations = new BlockLocation[] {new BlockLocation()};\n-            // Turn off force local scheduling because hosts list doesn't exist.", "originalCommit": "90bd86a2ad03304c2ca9cf0023fcee7692270dbd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1d0dd121e20ec8e182c0f427ab603997fc333d54", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/util/InternalHiveSplitFactory.java b/presto-hive/src/main/java/com/facebook/presto/hive/util/InternalHiveSplitFactory.java\nindex 42348e6c29..2812c9cf4f 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/util/InternalHiveSplitFactory.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/util/InternalHiveSplitFactory.java\n\n@@ -130,11 +129,14 @@ public class InternalHiveSplitFactory\n             return Optional.empty();\n         }\n \n+        boolean forceLocalScheduling = this.nodeSelectionStrategy == HARD_AFFINITY;\n         // For empty files, some filesystem (e.g. LocalFileSystem) produce one empty block\n         // while others (e.g. hdfs.DistributedFileSystem) produces no block.\n         // Synthesize an empty block if one does not already exist.\n         if (fileSize == 0 && blockLocations.length == 0) {\n             blockLocations = new BlockLocation[] {new BlockLocation()};\n+            // Turn off force local scheduling because hosts list doesn't exist.\n+            forceLocalScheduling = false;\n         }\n \n         ImmutableList.Builder<InternalHiveBlock> blockBuilder = ImmutableList.builder();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMwMzI0Nw==", "url": "https://github.com/prestodb/presto/pull/14101#discussion_r379303247", "bodyText": "keep", "author": "highker", "createdAt": "2020-02-14T08:31:03Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/util/InternalHiveSplitFactory.java", "diffHunk": "@@ -159,7 +152,7 @@ public InternalHiveSplitFactory(\n             }\n \n             List<HostAddress> addresses = getHostAddresses(blockLocation);\n-            if (!needsHostAddresses(forceLocalScheduling, addresses)) {", "originalCommit": "90bd86a2ad03304c2ca9cf0023fcee7692270dbd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1d0dd121e20ec8e182c0f427ab603997fc333d54", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/util/InternalHiveSplitFactory.java b/presto-hive/src/main/java/com/facebook/presto/hive/util/InternalHiveSplitFactory.java\nindex 42348e6c29..2812c9cf4f 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/util/InternalHiveSplitFactory.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/util/InternalHiveSplitFactory.java\n\n@@ -152,7 +154,7 @@ public class InternalHiveSplitFactory\n             }\n \n             List<HostAddress> addresses = getHostAddresses(blockLocation);\n-            if (!needsHostAddresses(nodeSelectionStrategy, addresses)) {\n+            if (!needsHostAddresses(forceLocalScheduling, addresses)) {\n                 addresses = ImmutableList.of();\n             }\n             blockBuilder.add(new InternalHiveBlock(blockEnd, addresses));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMwMzI2Ng==", "url": "https://github.com/prestodb/presto/pull/14101#discussion_r379303266", "bodyText": "keep", "author": "highker", "createdAt": "2020-02-14T08:31:07Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/util/InternalHiveSplitFactory.java", "diffHunk": "@@ -170,7 +163,7 @@ public InternalHiveSplitFactory(\n         if (!splittable) {\n             // not splittable, use the hosts from the first block if it exists\n             List<HostAddress> addresses = blocks.get(0).getAddresses();\n-            if (!needsHostAddresses(forceLocalScheduling, addresses)) {", "originalCommit": "90bd86a2ad03304c2ca9cf0023fcee7692270dbd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1d0dd121e20ec8e182c0f427ab603997fc333d54", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/util/InternalHiveSplitFactory.java b/presto-hive/src/main/java/com/facebook/presto/hive/util/InternalHiveSplitFactory.java\nindex 42348e6c29..2812c9cf4f 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/util/InternalHiveSplitFactory.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/util/InternalHiveSplitFactory.java\n\n@@ -163,7 +165,7 @@ public class InternalHiveSplitFactory\n         if (!splittable) {\n             // not splittable, use the hosts from the first block if it exists\n             List<HostAddress> addresses = blocks.get(0).getAddresses();\n-            if (!needsHostAddresses(nodeSelectionStrategy, addresses)) {\n+            if (!needsHostAddresses(forceLocalScheduling, addresses)) {\n                 addresses = ImmutableList.of();\n             }\n             blocks = ImmutableList.of(new InternalHiveBlock(start + length, addresses));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMwMzM5OQ==", "url": "https://github.com/prestodb/presto/pull/14101#discussion_r379303399", "bodyText": "keep", "author": "highker", "createdAt": "2020-02-14T08:31:26Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/util/InternalHiveSplitFactory.java", "diffHunk": "@@ -186,16 +179,15 @@ public InternalHiveSplitFactory(\n                 readBucketNumber,\n                 tableBucketNumber,\n                 splittable,\n-                forceLocalScheduling && allBlocksHaveRealAddress(blocks),\n                 (nodeSelectionStrategy == HARD_AFFINITY && !allBlocksHaveRealAddress(blocks)) ? NO_PREFERENCE : nodeSelectionStrategy,\n                 s3SelectPushdownEnabled && S3SelectPushdown.isCompressionCodecSupported(inputFormat, path),\n                 partitionInfo,\n                 extraFileInfo));\n     }\n \n-    private boolean needsHostAddresses(boolean forceLocalScheduling, List<HostAddress> addresses)", "originalCommit": "90bd86a2ad03304c2ca9cf0023fcee7692270dbd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1d0dd121e20ec8e182c0f427ab603997fc333d54", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/util/InternalHiveSplitFactory.java b/presto-hive/src/main/java/com/facebook/presto/hive/util/InternalHiveSplitFactory.java\nindex 42348e6c29..2812c9cf4f 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/util/InternalHiveSplitFactory.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/util/InternalHiveSplitFactory.java\n\n@@ -179,15 +181,15 @@ public class InternalHiveSplitFactory\n                 readBucketNumber,\n                 tableBucketNumber,\n                 splittable,\n-                (nodeSelectionStrategy == HARD_AFFINITY && !allBlocksHaveRealAddress(blocks)) ? NO_PREFERENCE : nodeSelectionStrategy,\n+                forceLocalScheduling && allBlocksHaveRealAddress(blocks) ? HARD_AFFINITY : nodeSelectionStrategy,\n                 s3SelectPushdownEnabled && S3SelectPushdown.isCompressionCodecSupported(inputFormat, path),\n                 partitionInfo,\n                 extraFileInfo));\n     }\n \n-    private boolean needsHostAddresses(NodeSelectionStrategy nodeSelectionStrategy, List<HostAddress> addresses)\n+    private boolean needsHostAddresses(boolean forceLocalScheduling, List<HostAddress> addresses)\n     {\n-        return schedulerUsesHostAddresses || (nodeSelectionStrategy == HARD_AFFINITY && hasRealAddress(addresses));\n+        return schedulerUsesHostAddresses || (forceLocalScheduling && hasRealAddress(addresses));\n     }\n \n     private static void checkBlocks(List<InternalHiveBlock> blocks, long start, long length)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMwNzI1Ng==", "url": "https://github.com/prestodb/presto/pull/14101#discussion_r379307256", "bodyText": "I think this should be\nforceLocalScheduling && allBlocksHaveRealAddress(blocks) && nodeSelectionStrategy == HARD_AFFINITY ? HARD_AFFINITY : nodeSelectionStrategy\nBecause forceLocalScheduling can be turned off", "author": "highker", "createdAt": "2020-02-14T08:41:43Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/util/InternalHiveSplitFactory.java", "diffHunk": "@@ -186,16 +179,15 @@ public InternalHiveSplitFactory(\n                 readBucketNumber,\n                 tableBucketNumber,\n                 splittable,\n-                forceLocalScheduling && allBlocksHaveRealAddress(blocks),\n                 (nodeSelectionStrategy == HARD_AFFINITY && !allBlocksHaveRealAddress(blocks)) ? NO_PREFERENCE : nodeSelectionStrategy,", "originalCommit": "90bd86a2ad03304c2ca9cf0023fcee7692270dbd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1d0dd121e20ec8e182c0f427ab603997fc333d54", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/util/InternalHiveSplitFactory.java b/presto-hive/src/main/java/com/facebook/presto/hive/util/InternalHiveSplitFactory.java\nindex 42348e6c29..2812c9cf4f 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/util/InternalHiveSplitFactory.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/util/InternalHiveSplitFactory.java\n\n@@ -179,15 +181,15 @@ public class InternalHiveSplitFactory\n                 readBucketNumber,\n                 tableBucketNumber,\n                 splittable,\n-                (nodeSelectionStrategy == HARD_AFFINITY && !allBlocksHaveRealAddress(blocks)) ? NO_PREFERENCE : nodeSelectionStrategy,\n+                forceLocalScheduling && allBlocksHaveRealAddress(blocks) ? HARD_AFFINITY : nodeSelectionStrategy,\n                 s3SelectPushdownEnabled && S3SelectPushdown.isCompressionCodecSupported(inputFormat, path),\n                 partitionInfo,\n                 extraFileInfo));\n     }\n \n-    private boolean needsHostAddresses(NodeSelectionStrategy nodeSelectionStrategy, List<HostAddress> addresses)\n+    private boolean needsHostAddresses(boolean forceLocalScheduling, List<HostAddress> addresses)\n     {\n-        return schedulerUsesHostAddresses || (nodeSelectionStrategy == HARD_AFFINITY && hasRealAddress(addresses));\n+        return schedulerUsesHostAddresses || (forceLocalScheduling && hasRealAddress(addresses));\n     }\n \n     private static void checkBlocks(List<InternalHiveBlock> blocks, long start, long length)\n"}}, {"oid": "4f7510798d5e9d870e5da7b42a22637e036215f6", "url": "https://github.com/prestodb/presto/commit/4f7510798d5e9d870e5da7b42a22637e036215f6", "message": "Remove forceLocalScheduling for hive connector\n\nAs we already have NodeSelectionStrategy to indicate node selection affinity,\ndeprecate forceLocalScheduling.", "committedDate": "2020-02-14T18:38:24Z", "type": "forcePushed"}, {"oid": "1d0dd121e20ec8e182c0f427ab603997fc333d54", "url": "https://github.com/prestodb/presto/commit/1d0dd121e20ec8e182c0f427ab603997fc333d54", "message": "Remove forceLocalScheduling for hive connector\n\nAs we already have NodeSelectionStrategy to indicate node selection affinity,\ndeprecate forceLocalScheduling.", "committedDate": "2020-02-14T19:09:02Z", "type": "commit"}, {"oid": "1d0dd121e20ec8e182c0f427ab603997fc333d54", "url": "https://github.com/prestodb/presto/commit/1d0dd121e20ec8e182c0f427ab603997fc333d54", "message": "Remove forceLocalScheduling for hive connector\n\nAs we already have NodeSelectionStrategy to indicate node selection affinity,\ndeprecate forceLocalScheduling.", "committedDate": "2020-02-14T19:09:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzMTIzOA==", "url": "https://github.com/prestodb/presto/pull/14101#discussion_r379631238", "bodyText": "You need && nodeSelectionStrategy == HARD_AFFINITY", "author": "highker", "createdAt": "2020-02-14T20:31:14Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/util/InternalHiveSplitFactory.java", "diffHunk": "@@ -186,8 +181,7 @@ public InternalHiveSplitFactory(\n                 readBucketNumber,\n                 tableBucketNumber,\n                 splittable,\n-                forceLocalScheduling && allBlocksHaveRealAddress(blocks),\n-                (nodeSelectionStrategy == HARD_AFFINITY && !allBlocksHaveRealAddress(blocks)) ? NO_PREFERENCE : nodeSelectionStrategy,\n+                forceLocalScheduling && allBlocksHaveRealAddress(blocks) ? HARD_AFFINITY : nodeSelectionStrategy,", "originalCommit": "1d0dd121e20ec8e182c0f427ab603997fc333d54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzMjcyMg==", "url": "https://github.com/prestodb/presto/pull/14101#discussion_r379632722", "bodyText": "You need && nodeSelectionStrategy == HARD_AFFINITY\n\nIDE indicates that It's actually redundant and it is", "author": "kewang1024", "createdAt": "2020-02-14T20:35:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzMTIzOA=="}], "type": "inlineReview", "revised_code": null}]}