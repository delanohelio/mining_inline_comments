{"pr_number": 14595, "pr_title": "Fix Verifier failure when session properties contains execution time", "pr_createdAt": "2020-06-01T20:36:05Z", "pr_url": "https://github.com/prestodb/presto/pull/14595", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ4ODIzMg==", "url": "https://github.com/prestodb/presto/pull/14595#discussion_r433488232", "bodyText": "@caithagoras It is possible that a query would run with a timeout that's a lot larger than getTimeout(queryStage). Is this OK? Why? Perhaps, add a comment here.", "author": "mbasmanova", "createdAt": "2020-06-01T21:02:21Z", "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/prestoaction/JdbcPrestoAction.java", "diffHunk": "@@ -144,10 +144,8 @@ private PrestoConnection getConnection(QueryStage queryStage)\n             // Do nothing\n         }\n \n-        Map<String, String> sessionProperties = ImmutableMap.<String, String>builder()\n-                .putAll(queryConfiguration.getSessionProperties())\n-                .put(QUERY_MAX_EXECUTION_TIME, getTimeout(queryStage).toString())\n-                .build();\n+        Map<String, String> sessionProperties = new HashMap<>(queryConfiguration.getSessionProperties());\n+        sessionProperties.put(QUERY_MAX_EXECUTION_TIME, getTimeout(queryStage).toString());", "originalCommit": "86243515110681c1249ece1327ec9789bc7400b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUyOTcyMQ==", "url": "https://github.com/prestodb/presto/pull/14595#discussion_r433529721", "bodyText": "Added comment.\nAdd or override query max execution time to enforce the timeout.\n\nFrom this PrestoAction class's perspective, it only cares about its contract, that is, run a given query or fail if the query execution time exceeds the given timeout.\nFrom the verification perspective, a long-running query will fail on the control, which will be skipped, excluded from our consideration.", "author": "caithagoras", "createdAt": "2020-06-01T22:49:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ4ODIzMg=="}], "type": "inlineReview", "revised_code": {"commit": "385c8b1e42a1118b9f2251f4a3f4560d073702b4", "chunk": "diff --git a/presto-verifier/src/main/java/com/facebook/presto/verifier/prestoaction/JdbcPrestoAction.java b/presto-verifier/src/main/java/com/facebook/presto/verifier/prestoaction/JdbcPrestoAction.java\nindex cce82ee183..108f7aa61b 100644\n--- a/presto-verifier/src/main/java/com/facebook/presto/verifier/prestoaction/JdbcPrestoAction.java\n+++ b/presto-verifier/src/main/java/com/facebook/presto/verifier/prestoaction/JdbcPrestoAction.java\n\n@@ -145,6 +145,8 @@ public class JdbcPrestoAction\n         }\n \n         Map<String, String> sessionProperties = new HashMap<>(queryConfiguration.getSessionProperties());\n+\n+        // Add or override query max execution time to enforce the timeout.\n         sessionProperties.put(QUERY_MAX_EXECUTION_TIME, getTimeout(queryStage).toString());\n         for (Entry<String, String> entry : sessionProperties.entrySet()) {\n             connection.setSessionProperty(entry.getKey(), entry.getValue());\n"}}, {"oid": "385c8b1e42a1118b9f2251f4a3f4560d073702b4", "url": "https://github.com/prestodb/presto/commit/385c8b1e42a1118b9f2251f4a3f4560d073702b4", "message": "Fix Verifier failure when session properties contains execution time", "committedDate": "2020-06-01T22:44:50Z", "type": "forcePushed"}, {"oid": "96d29561b792fd1953efc05fb21153f08f623225", "url": "https://github.com/prestodb/presto/commit/96d29561b792fd1953efc05fb21153f08f623225", "message": "Fix Verifier failure when session properties contains execution time", "committedDate": "2020-06-02T20:06:52Z", "type": "commit"}, {"oid": "96d29561b792fd1953efc05fb21153f08f623225", "url": "https://github.com/prestodb/presto/commit/96d29561b792fd1953efc05fb21153f08f623225", "message": "Fix Verifier failure when session properties contains execution time", "committedDate": "2020-06-02T20:06:52Z", "type": "forcePushed"}]}