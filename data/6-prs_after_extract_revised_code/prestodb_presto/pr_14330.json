{"pr_number": 14330, "pr_title": "Report failure to compile pushed down filter as COMPILE_ERROR", "pr_createdAt": "2020-04-03T07:30:20Z", "pr_url": "https://github.com/prestodb/presto/pull/14330", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjgxNzUzOA==", "url": "https://github.com/prestodb/presto/pull/14330#discussion_r402817538", "bodyText": "Use separate catch block instead of checking exception class:\n        catch (UncheckedExecutionException e) {\n            if (e.getCause() instanceof PrestoException) {\n                throw (PrestoException) e.getCause();\n            }\n            throw new PrestoException(HIVE_CANNOT_OPEN_SPLIT, splitError(e, path, start, length), e);\n        }\n        catch (BlockMissingException e) {\n            throw new PrestoException(HIVE_MISSING_DATA, splitError(e, path, start, length), e);\n        }\n        catch (PrestoException e) {\n            throw e;\n        }\n        catch (Exception e) {\n            throw new PrestoException(HIVE_CANNOT_OPEN_SPLIT, splitError(e, path, start, length), e);\n        }\n        finally {\n            try {\n                orcDataSource.close();\n            }\n            catch (IOException ignored) {\n            }  \n        }", "author": "mbasmanova", "createdAt": "2020-04-03T08:13:36Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/orc/OrcSelectivePageSourceFactory.java", "diffHunk": "@@ -398,6 +399,9 @@ public static OrcSelectivePageSource createOrcPageSource(\n             }\n             catch (IOException ignored) {\n             }\n+            if (e.getClass().getName().equals(UncheckedExecutionException.class.getName()) && e.getCause() instanceof PrestoException) {", "originalCommit": "2bb05bc8794a479a4cf22b9d188957f0db768440", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE1MTI4Mw==", "url": "https://github.com/prestodb/presto/pull/14330#discussion_r403151283", "bodyText": "Catching UncheckedExecutionException doesn't seem to work here unfortunately :( I think because the thrown exception's class and UncheckedExecutionException class are loaded by different classloaders. That is why even a simple check like e instanceOf UncheckedExecutionException doesn't work and we may just have to stick to a class name check.\nJust to be sure I tried this on a verifier cluster and it throws the HIVE_CANNOT_OPEN_SPLIT error like before since it doesn't enter the catch (UncheckedExecutionException e) { block. (Can share the link and logs in chat if you are interested)", "author": "sujay-jain", "createdAt": "2020-04-03T17:03:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjgxNzUzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE1ODk2MA==", "url": "https://github.com/prestodb/presto/pull/14330#discussion_r403158960", "bodyText": "And I'm curious about closing the orcDataSource. Doing this in a finally block will close it even in cases when there's no exception, and at a cusrory glance it seems like callers of this function could still use it..\nUnrelated to this PR but should we be closing the orcDataSource in OrcSelecticePageSource#close() method instead? here", "author": "sujay-jain", "createdAt": "2020-04-03T17:12:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjgxNzUzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE2NjA1Nw==", "url": "https://github.com/prestodb/presto/pull/14330#discussion_r403166057", "bodyText": "@sujay-jain Thanks for explaining. Makes sense. For the benefit of future readers, would you add a comment explaining why you are comparing exception class manually?", "author": "mbasmanova", "createdAt": "2020-04-03T17:20:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjgxNzUzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzY2MjgxNg==", "url": "https://github.com/prestodb/presto/pull/14330#discussion_r403662816", "bodyText": "And I'm curious about closing the orcDataSource. Doing this in a finally block will close it even in cases when there's no exception, and at a cusrory glance it seems like callers of this function could still use it..\nUnrelated to this PR but should we be closing the orcDataSource in OrcSelecticePageSource#close() method instead? here\n\n@sujay-jain OrcDataSource is closed in AbstractOrcRecordReader.java L380", "author": "bhhari", "createdAt": "2020-04-05T07:39:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjgxNzUzOA=="}], "type": "inlineReview", "revised_code": {"commit": "8729c0a71eb6039f556b5899510c12ac2d8e2a7f", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/orc/OrcSelectivePageSourceFactory.java b/presto-hive/src/main/java/com/facebook/presto/hive/orc/OrcSelectivePageSourceFactory.java\nindex 990545d347..d2cf0cfa4e 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/orc/OrcSelectivePageSourceFactory.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/orc/OrcSelectivePageSourceFactory.java\n\n@@ -399,6 +399,7 @@ public class OrcSelectivePageSourceFactory\n             }\n             catch (IOException ignored) {\n             }\n+            // instanceof check does not work here since e and UncheckedExecutionException are loaded by different classloaders\n             if (e.getClass().getName().equals(UncheckedExecutionException.class.getName()) && e.getCause() instanceof PrestoException) {\n                 throw (PrestoException) e.getCause();\n             }\n"}}, {"oid": "a7ad263ad3c8ab236ee40c2dd9c7ec6e8e1e6089", "url": "https://github.com/prestodb/presto/commit/a7ad263ad3c8ab236ee40c2dd9c7ec6e8e1e6089", "message": "Report failure to compile pushed down filter as COMPILE_ERROR\n\nBefore this change this error was  reported as STORAGE_ERROR:\nError opening Hive split.", "committedDate": "2020-04-03T16:57:33Z", "type": "forcePushed"}, {"oid": "8729c0a71eb6039f556b5899510c12ac2d8e2a7f", "url": "https://github.com/prestodb/presto/commit/8729c0a71eb6039f556b5899510c12ac2d8e2a7f", "message": "Report failure to compile pushed down filter as COMPILE_ERROR\n\nBefore this change this error was  reported as STORAGE_ERROR:\nError opening Hive split.", "committedDate": "2020-04-03T17:52:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzY2MTE4OA==", "url": "https://github.com/prestodb/presto/pull/14330#discussion_r403661188", "bodyText": "also talk about why .class comparison does not work either, can be something like\ninstanceof and class comparison do not work as they are loaded by different class loaders.", "author": "bhhari", "createdAt": "2020-04-05T07:23:14Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/orc/OrcSelectivePageSourceFactory.java", "diffHunk": "@@ -398,6 +399,10 @@ public static OrcSelectivePageSource createOrcPageSource(\n             }\n             catch (IOException ignored) {\n             }\n+            // instanceof check does not work here since e and UncheckedExecutionException are loaded by different classloaders", "originalCommit": "8729c0a71eb6039f556b5899510c12ac2d8e2a7f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "aff0a359845c744284ca95ccf8bda14d89a69673", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/orc/OrcSelectivePageSourceFactory.java b/presto-hive/src/main/java/com/facebook/presto/hive/orc/OrcSelectivePageSourceFactory.java\nindex d2cf0cfa4e..565f0bd1a0 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/orc/OrcSelectivePageSourceFactory.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/orc/OrcSelectivePageSourceFactory.java\n\n@@ -399,7 +399,7 @@ public class OrcSelectivePageSourceFactory\n             }\n             catch (IOException ignored) {\n             }\n-            // instanceof check does not work here since e and UncheckedExecutionException are loaded by different classloaders\n+            // instanceof and class comparison do not work here since they are loaded by different class loaders.\n             if (e.getClass().getName().equals(UncheckedExecutionException.class.getName()) && e.getCause() instanceof PrestoException) {\n                 throw (PrestoException) e.getCause();\n             }\n"}}, {"oid": "aff0a359845c744284ca95ccf8bda14d89a69673", "url": "https://github.com/prestodb/presto/commit/aff0a359845c744284ca95ccf8bda14d89a69673", "message": "Report failure to compile pushed down filter as COMPILE_ERROR\n\nBefore this change this error was  reported as STORAGE_ERROR:\nError opening Hive split.", "committedDate": "2020-04-06T18:25:11Z", "type": "forcePushed"}, {"oid": "6deae797d208722dee3a5ae32de8b356bbc1176f", "url": "https://github.com/prestodb/presto/commit/6deae797d208722dee3a5ae32de8b356bbc1176f", "message": "Report failure to compile pushed down filter as COMPILE_ERROR\n\nBefore this change this error was  reported as STORAGE_ERROR:\nError opening Hive split.", "committedDate": "2020-04-06T21:32:54Z", "type": "commit"}, {"oid": "6deae797d208722dee3a5ae32de8b356bbc1176f", "url": "https://github.com/prestodb/presto/commit/6deae797d208722dee3a5ae32de8b356bbc1176f", "message": "Report failure to compile pushed down filter as COMPILE_ERROR\n\nBefore this change this error was  reported as STORAGE_ERROR:\nError opening Hive split.", "committedDate": "2020-04-06T21:32:54Z", "type": "forcePushed"}]}