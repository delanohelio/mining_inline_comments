{"pr_number": 15304, "pr_title": "Handle cases when flat map doesn't have dummy encoding for sequence 0", "pr_createdAt": "2020-10-12T23:55:15Z", "pr_url": "https://github.com/prestodb/presto/pull/15304", "timeline": [{"oid": "034a9baf752dafb7cfc6959f162392680c99d2ff", "url": "https://github.com/prestodb/presto/commit/034a9baf752dafb7cfc6959f162392680c99d2ff", "message": "make sure Optional.empty() is set for regular columns", "committedDate": "2020-10-13T04:56:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY5ODg5Mg==", "url": "https://github.com/prestodb/presto/pull/15304#discussion_r503698892", "bodyText": "the columnEncoding sequence 0 if present, should be the first value, so the if check can be moved outside the for loop.\nsequence0 can be assigned to the one if one exists, or a dummy DWRF_DIRECT encoding can be created, so that the below code does not need to switch on sequence0 != null.", "author": "arunthirupathi", "createdAt": "2020-10-13T06:36:08Z", "path": "presto-orc/src/main/java/com/facebook/presto/orc/metadata/DwrfMetadataReader.java", "diffHunk": "@@ -200,20 +200,29 @@ private static DwrfSequenceEncoding toSequenceEncoding(OrcType type, DwrfProto.C\n                         columnEncoding.getDictionarySize()));\n     }\n \n-    private static Optional<SortedMap<Integer, DwrfSequenceEncoding>> toAdditionalSequenceEncodings(List<DwrfProto.ColumnEncoding> columnEncodings, OrcType type)\n+    private static ColumnEncoding toColumnEncoding(OrcType type, List<DwrfProto.ColumnEncoding> columnEncodings)\n     {\n-        if (columnEncodings.size() == 1) {\n-            return Optional.empty();\n+        DwrfProto.ColumnEncoding sequence0 = null;\n+        ImmutableSortedMap.Builder<Integer, DwrfSequenceEncoding> builder = ImmutableSortedMap.naturalOrder();\n+        for (DwrfProto.ColumnEncoding columnEncoding : columnEncodings) {\n+            if (columnEncoding.getSequence() == 0) {", "originalCommit": "034a9baf752dafb7cfc6959f162392680c99d2ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA3NjMyMw==", "url": "https://github.com/prestodb/presto/pull/15304#discussion_r504076323", "bodyText": "even though sequence 0 is indeed the first one in columnEncodings in current implementation, the spec doesn't guarantee order", "author": "zzhao0", "createdAt": "2020-10-13T16:06:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY5ODg5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "5d63e3eeb404880a4b6e6353a534b0a4aa687069", "chunk": "diff --git a/presto-orc/src/main/java/com/facebook/presto/orc/metadata/DwrfMetadataReader.java b/presto-orc/src/main/java/com/facebook/presto/orc/metadata/DwrfMetadataReader.java\nindex 82ec65cc11..d05d58529a 100644\n--- a/presto-orc/src/main/java/com/facebook/presto/orc/metadata/DwrfMetadataReader.java\n+++ b/presto-orc/src/main/java/com/facebook/presto/orc/metadata/DwrfMetadataReader.java\n\n@@ -214,14 +214,14 @@ public class DwrfMetadataReader\n         }\n \n         SortedMap<Integer, DwrfSequenceEncoding> nonZeroSequences = builder.build();\n-        Optional<SortedMap<Integer, DwrfSequenceEncoding>> additionalSequenceEncodings =\n+        Optional<SortedMap<Integer, DwrfSequenceEncoding>> nonZeroEncodingsOptional =\n                 nonZeroSequences.isEmpty() ? Optional.empty() : Optional.of(nonZeroSequences);\n         if (sequence0 != null) {\n-            return new ColumnEncoding(toColumnEncodingKind(type.getOrcTypeKind(), sequence0.getKind()), sequence0.getDictionarySize(), additionalSequenceEncodings);\n+            return new ColumnEncoding(toColumnEncodingKind(type.getOrcTypeKind(), sequence0.getKind()), sequence0.getDictionarySize(), nonZeroEncodingsOptional);\n         }\n         else {\n             // This is the case when value node of FLAT_MAP doesn't have encoding for sequence 0\n-            return new ColumnEncoding(ColumnEncodingKind.DWRF_DIRECT, 0, additionalSequenceEncodings);\n+            return new ColumnEncoding(ColumnEncodingKind.DWRF_DIRECT, 0, nonZeroEncodingsOptional);\n         }\n     }\n \n"}}, {"oid": "246f5d286a39221f859bc267d9089b516824a731", "url": "https://github.com/prestodb/presto/commit/246f5d286a39221f859bc267d9089b516824a731", "message": "Handle cases when flat map doesn't have dummy encoding for sequence 0", "committedDate": "2020-10-13T18:07:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcyMDQzNg==", "url": "https://github.com/prestodb/presto/pull/15304#discussion_r504720436", "bodyText": "additionalSequenceEncodings name is confusing; the value is just nonZeroSequences wrapped into an Optional; Is it important to use Optional.empty() when nonZeroSequences is empty? Why can't we always use Optional.of(nonZeroSequences)? If that's possible, then additionalSequenceEncodings variable can be removed and Optional.of(nonZeroSequences) can be used in its place.", "author": "mbasmanova", "createdAt": "2020-10-14T14:24:19Z", "path": "presto-orc/src/main/java/com/facebook/presto/orc/metadata/DwrfMetadataReader.java", "diffHunk": "@@ -200,20 +200,29 @@ private static DwrfSequenceEncoding toSequenceEncoding(OrcType type, DwrfProto.C\n                         columnEncoding.getDictionarySize()));\n     }\n \n-    private static Optional<SortedMap<Integer, DwrfSequenceEncoding>> toAdditionalSequenceEncodings(List<DwrfProto.ColumnEncoding> columnEncodings, OrcType type)\n+    private static ColumnEncoding toColumnEncoding(OrcType type, List<DwrfProto.ColumnEncoding> columnEncodings)\n     {\n-        if (columnEncodings.size() == 1) {\n-            return Optional.empty();\n+        DwrfProto.ColumnEncoding sequence0 = null;\n+        ImmutableSortedMap.Builder<Integer, DwrfSequenceEncoding> builder = ImmutableSortedMap.naturalOrder();\n+        for (DwrfProto.ColumnEncoding columnEncoding : columnEncodings) {\n+            if (columnEncoding.getSequence() == 0) {\n+                sequence0 = columnEncoding;\n+            }\n+            else {\n+                builder.put(columnEncoding.getSequence(), toSequenceEncoding(type, columnEncoding));\n+            }\n         }\n \n-        ImmutableSortedMap.Builder<Integer, DwrfSequenceEncoding> additionalSequenceEncodings = ImmutableSortedMap.<Integer, DwrfSequenceEncoding>naturalOrder();\n-\n-        for (int i = 1; i < columnEncodings.size(); i++) {\n-            DwrfProto.ColumnEncoding columnEncoding = columnEncodings.get(i);\n-            additionalSequenceEncodings.put(columnEncoding.getSequence(), toSequenceEncoding(type, columnEncoding));\n+        SortedMap<Integer, DwrfSequenceEncoding> nonZeroSequences = builder.build();\n+        Optional<SortedMap<Integer, DwrfSequenceEncoding>> additionalSequenceEncodings =", "originalCommit": "246f5d286a39221f859bc267d9089b516824a731", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc3MjI4Ng==", "url": "https://github.com/prestodb/presto/pull/15304#discussion_r504772286", "bodyText": "I'm not sure if Optional.empty() is necessary. From looking at the code, it doesn't matter for now. However, grep told me there are places where it relies on Optional.isPresent(), so I attempted to maintain the existing behavior (ie. in the common case when there is only sequence 0 for a node, make additionalSequenceEncodings Optional.empty())", "author": "zzhao0", "createdAt": "2020-10-14T15:29:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcyMDQzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc3NTI2Nw==", "url": "https://github.com/prestodb/presto/pull/15304#discussion_r504775267", "bodyText": "@zzhao0 I'm fine keeping this logic if it is needed, but then we need a better name for additionalSequenceEncodings. It is confusing to use different terms \"non-zero\" and \"additional\" for essentially the same thing. How about, nonZeroEncodingsOptional?", "author": "mbasmanova", "createdAt": "2020-10-14T15:33:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcyMDQzNg=="}], "type": "inlineReview", "revised_code": {"commit": "5d63e3eeb404880a4b6e6353a534b0a4aa687069", "chunk": "diff --git a/presto-orc/src/main/java/com/facebook/presto/orc/metadata/DwrfMetadataReader.java b/presto-orc/src/main/java/com/facebook/presto/orc/metadata/DwrfMetadataReader.java\nindex 82ec65cc11..d05d58529a 100644\n--- a/presto-orc/src/main/java/com/facebook/presto/orc/metadata/DwrfMetadataReader.java\n+++ b/presto-orc/src/main/java/com/facebook/presto/orc/metadata/DwrfMetadataReader.java\n\n@@ -214,14 +214,14 @@ public class DwrfMetadataReader\n         }\n \n         SortedMap<Integer, DwrfSequenceEncoding> nonZeroSequences = builder.build();\n-        Optional<SortedMap<Integer, DwrfSequenceEncoding>> additionalSequenceEncodings =\n+        Optional<SortedMap<Integer, DwrfSequenceEncoding>> nonZeroEncodingsOptional =\n                 nonZeroSequences.isEmpty() ? Optional.empty() : Optional.of(nonZeroSequences);\n         if (sequence0 != null) {\n-            return new ColumnEncoding(toColumnEncodingKind(type.getOrcTypeKind(), sequence0.getKind()), sequence0.getDictionarySize(), additionalSequenceEncodings);\n+            return new ColumnEncoding(toColumnEncodingKind(type.getOrcTypeKind(), sequence0.getKind()), sequence0.getDictionarySize(), nonZeroEncodingsOptional);\n         }\n         else {\n             // This is the case when value node of FLAT_MAP doesn't have encoding for sequence 0\n-            return new ColumnEncoding(ColumnEncodingKind.DWRF_DIRECT, 0, additionalSequenceEncodings);\n+            return new ColumnEncoding(ColumnEncodingKind.DWRF_DIRECT, 0, nonZeroEncodingsOptional);\n         }\n     }\n \n"}}, {"oid": "5d63e3eeb404880a4b6e6353a534b0a4aa687069", "url": "https://github.com/prestodb/presto/commit/5d63e3eeb404880a4b6e6353a534b0a4aa687069", "message": "Handle cases when flat map doesn't have dummy encoding for sequence 0", "committedDate": "2020-10-14T16:08:50Z", "type": "commit"}, {"oid": "5d63e3eeb404880a4b6e6353a534b0a4aa687069", "url": "https://github.com/prestodb/presto/commit/5d63e3eeb404880a4b6e6353a534b0a4aa687069", "message": "Handle cases when flat map doesn't have dummy encoding for sequence 0", "committedDate": "2020-10-14T16:08:50Z", "type": "forcePushed"}]}