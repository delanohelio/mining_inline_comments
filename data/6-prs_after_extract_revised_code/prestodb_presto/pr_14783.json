{"pr_number": 14783, "pr_title": "Fix #14693: support TRUNCATE function for DOUBLE and REAL", "pr_createdAt": "2020-07-06T06:28:26Z", "pr_url": "https://github.com/prestodb/presto/pull/14783", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU0NTEzMA==", "url": "https://github.com/prestodb/presto/pull/14783#discussion_r452545130", "bodyText": "I would put this into a new test case, let's call it testTruncateWithPrecision", "author": "tdcmeehan", "createdAt": "2020-07-09T23:33:45Z", "path": "presto-main/src/test/java/com/facebook/presto/operator/scalar/TestMathFunctions.java", "diffHunk": "@@ -268,6 +268,27 @@ public void testTruncate()\n         assertFunction(\"truncate(DECIMAL '1234567890123456789012.999')\", createDecimalType(22, 0), SqlDecimal.of(\"1234567890123456789012\"));\n         assertFunction(\"truncate(DECIMAL '-1234567890123456789012.999')\", createDecimalType(22, 0), SqlDecimal.of(\"-1234567890123456789012\"));\n \n+        // TRUNCATE DOUBLE -> DOUBLE", "originalCommit": "7ea31d849cf1e9143ac21cbb108c357e98a07964", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzIyMTk3Nw==", "url": "https://github.com/prestodb/presto/pull/14783#discussion_r453221977", "bodyText": "sure will do, thanks", "author": "fgwang7w", "createdAt": "2020-07-11T18:32:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU0NTEzMA=="}], "type": "inlineReview", "revised_code": {"commit": "70e0638a29d87c5560f2085435a808602bdec307", "chunk": "diff --git a/presto-main/src/test/java/com/facebook/presto/operator/scalar/TestMathFunctions.java b/presto-main/src/test/java/com/facebook/presto/operator/scalar/TestMathFunctions.java\nindex 5cafaec54e..c2e8e48355 100644\n--- a/presto-main/src/test/java/com/facebook/presto/operator/scalar/TestMathFunctions.java\n+++ b/presto-main/src/test/java/com/facebook/presto/operator/scalar/TestMathFunctions.java\n\n@@ -268,27 +268,6 @@ public class TestMathFunctions\n         assertFunction(\"truncate(DECIMAL '1234567890123456789012.999')\", createDecimalType(22, 0), SqlDecimal.of(\"1234567890123456789012\"));\n         assertFunction(\"truncate(DECIMAL '-1234567890123456789012.999')\", createDecimalType(22, 0), SqlDecimal.of(\"-1234567890123456789012\"));\n \n-        // TRUNCATE DOUBLE -> DOUBLE\n-        assertFunction(\"truncate(nan(),-1)\", DOUBLE, Double.NaN);\n-        assertFunction(\"truncate(DOUBLE '17.1', -1)\", DOUBLE, 10.0);\n-        assertFunction(\"truncate(DOUBLE '1234.56', 1)\", DOUBLE, 1234.5);\n-        assertFunction(\"truncate(DOUBLE '1234.56', 0)\", DOUBLE, 1234.0);\n-        assertFunction(\"truncate(DOUBLE '-1234.56', 0)\", DOUBLE, -1234.0);\n-        assertFunction(\"truncate(DOUBLE '-1234.56', -500)\", DOUBLE, 0.0);\n-        assertFunction(\"truncate(DOUBLE '1234.567', 2)\", DOUBLE, 1234.56);\n-        assertFunction(\"truncate(DOUBLE '1234.567', 2)\", DOUBLE, 1234.56);\n-        assertFunction(\"truncate(DOUBLE '\" + Double.MAX_VALUE + \"', -408)\", DOUBLE, 0.0);\n-        assertFunction(\"truncate(DOUBLE '\" + -Double.MAX_VALUE / 10 + \"', 408)\", DOUBLE, -Double.MAX_VALUE / 10);\n-        assertFunction(\"truncate(DOUBLE '\" + (double) Long.MAX_VALUE + \"', -15)\", DOUBLE, 9.223E18);\n-\n-        // TRUNCATE REAL -> REAL\n-        assertFunction(\"truncate(REAL '12.333', 0)\", REAL, 12.0f);\n-        assertFunction(\"truncate(REAL '-12.333', 0)\", REAL, -12.0f);\n-        assertFunction(\"truncate(REAL '12.333', -500)\", REAL, 0.0f);\n-        assertFunction(\"truncate(REAL '3.40287e37', -35)\", REAL, 3.4E37f);\n-        assertFunction(\"truncate(REAL '3.40287e37', -488)\", REAL, 0.0f);\n-        assertFunction(\"truncate(REAL '\" + (float) Long.MAX_VALUE + \"', -15)\", REAL, 9.223E18f);\n-\n         // TRUNCATE_N short DECIMAL -> short DECIMAL\n         assertFunction(\"truncate(DECIMAL '1234', 1)\", createDecimalType(4, 0), SqlDecimal.of(\"1234\"));\n         assertFunction(\"truncate(DECIMAL '1234', -1)\", createDecimalType(4, 0), SqlDecimal.of(\"1230\"));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU0NTUwOQ==", "url": "https://github.com/prestodb/presto/pull/14783#discussion_r452545509", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return floatToRawIntBits(new BigDecimal(Float.toString(numBitsToFloats)).setScale((int) decimals, BigDecimal.ROUND_DOWN).floatValue());\n          \n          \n            \n                    return floatToRawIntBits(new BigDecimal(numBitsToFloats).setScale((int) decimals, BigDecimal.ROUND_DOWN).floatValue());\n          \n      \n    \n    \n  \n\nAny reason why this had to be converted to a string?  The test cases pass with the above.", "author": "tdcmeehan", "createdAt": "2020-07-09T23:34:58Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/scalar/MathFunctions.java", "diffHunk": "@@ -327,6 +331,69 @@ public static long truncate(@SqlType(StandardTypes.REAL) long num)\n         return floatToRawIntBits((float) (Math.signum(numInFloat) * Math.floor(Math.abs(numInFloat))));\n     }\n \n+    @Description(\"truncate to double by dropping digits after decimal point\")\n+    @ScalarFunction\n+    @SqlType(StandardTypes.DOUBLE)\n+    public static double truncate(@SqlType(StandardTypes.DOUBLE) double num, @SqlType(StandardTypes.BIGINT) long decimals)\n+    {\n+        if (Double.isNaN(num) || Double.isInfinite(num)) {\n+            // compatible with truncate(DOUBLE)\n+            return num;\n+        }\n+        if (decimals == 0) {\n+            if (num >= 0) {\n+                return Math.floor(num);\n+            }\n+            else {\n+                return Math.ceil(num);\n+            }\n+        }\n+\n+        if (decimals < 0) {\n+            if (decimals < -NUMBER_LENGTH) {\n+                decimals = -NUMBER_LENGTH;\n+            }\n+        }\n+        else {\n+            if (decimals >= NUMBER_LENGTH) {\n+                decimals = NUMBER_LENGTH;\n+            }\n+        }\n+        return BigDecimal.valueOf(num).setScale((int) decimals, BigDecimal.ROUND_DOWN).doubleValue();\n+    }\n+\n+    @Description(\"truncate to float by dropping digits after decimal point\")\n+    @ScalarFunction\n+    @SqlType(StandardTypes.REAL)\n+    public static long truncate(@SqlType(StandardTypes.REAL) long num, @SqlType(StandardTypes.BIGINT) long decimals)\n+    {\n+        float numBitsToFloats = intBitsToFloat((int) num);\n+        if (Float.isNaN(numBitsToFloats) || Float.isInfinite(numBitsToFloats)) {\n+            // compatible with truncate(REAL)\n+            return num;\n+        }\n+        if (decimals == 0) {\n+            if (numBitsToFloats >= 0) {\n+                return floatToRawIntBits((float) Math.floor(numBitsToFloats));\n+            }\n+            else {\n+                return floatToRawIntBits((float) Math.ceil(numBitsToFloats));\n+            }\n+        }\n+\n+        if (decimals < 0) {\n+            if (decimals < -NUMBER_LENGTH) {\n+                decimals = -NUMBER_LENGTH;\n+            }\n+        }\n+        else {\n+            if (decimals >= NUMBER_LENGTH) {\n+                decimals = NUMBER_LENGTH;\n+            }\n+        }\n+        return floatToRawIntBits(new BigDecimal(Float.toString(numBitsToFloats)).setScale((int) decimals, BigDecimal.ROUND_DOWN).floatValue());", "originalCommit": "7ea31d849cf1e9143ac21cbb108c357e98a07964", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzIzMjk0OA==", "url": "https://github.com/prestodb/presto/pull/14783#discussion_r453232948", "bodyText": "BigDecimal takes type of DOUBLE not FLOAT so use String as a safe cast value to return.", "author": "fgwang7w", "createdAt": "2020-07-11T20:41:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU0NTUwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "70e0638a29d87c5560f2085435a808602bdec307", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/operator/scalar/MathFunctions.java b/presto-main/src/main/java/com/facebook/presto/operator/scalar/MathFunctions.java\nindex d546d0f51d..9d8ec4a3f9 100644\n--- a/presto-main/src/main/java/com/facebook/presto/operator/scalar/MathFunctions.java\n+++ b/presto-main/src/main/java/com/facebook/presto/operator/scalar/MathFunctions.java\n\n@@ -334,7 +334,7 @@ public final class MathFunctions\n     @Description(\"truncate to double by dropping digits after decimal point\")\n     @ScalarFunction\n     @SqlType(StandardTypes.DOUBLE)\n-    public static double truncate(@SqlType(StandardTypes.DOUBLE) double num, @SqlType(StandardTypes.BIGINT) long decimals)\n+    public static double truncate(@SqlType(StandardTypes.DOUBLE) double num, @SqlType(StandardTypes.INTEGER) long decimals)\n     {\n         if (Double.isNaN(num) || Double.isInfinite(num)) {\n             // compatible with truncate(DOUBLE)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU0NjY2MQ==", "url": "https://github.com/prestodb/presto/pull/14783#discussion_r452546661", "bodyText": "How about MAX_DECIMAL_PLACES?", "author": "tdcmeehan", "createdAt": "2020-07-09T23:38:25Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/scalar/MathFunctions.java", "diffHunk": "@@ -66,6 +67,9 @@\n {\n     public static final SqlScalarFunction DECIMAL_MOD_FUNCTION = decimalModFunction();\n \n+    // double's precision not exceed this limit\n+    private static final int NUMBER_LENGTH = 400;", "originalCommit": "7ea31d849cf1e9143ac21cbb108c357e98a07964", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzIzMjk5Mw==", "url": "https://github.com/prestodb/presto/pull/14783#discussion_r453232993", "bodyText": "sure, fixed", "author": "fgwang7w", "createdAt": "2020-07-11T20:42:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU0NjY2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "70e0638a29d87c5560f2085435a808602bdec307", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/operator/scalar/MathFunctions.java b/presto-main/src/main/java/com/facebook/presto/operator/scalar/MathFunctions.java\nindex d546d0f51d..9d8ec4a3f9 100644\n--- a/presto-main/src/main/java/com/facebook/presto/operator/scalar/MathFunctions.java\n+++ b/presto-main/src/main/java/com/facebook/presto/operator/scalar/MathFunctions.java\n\n@@ -68,7 +68,7 @@ public final class MathFunctions\n     public static final SqlScalarFunction DECIMAL_MOD_FUNCTION = decimalModFunction();\n \n     // double's precision not exceed this limit\n-    private static final int NUMBER_LENGTH = 400;\n+    private static final int MAX_DECIMAL_PLACES = 400;\n \n     private static final Slice[] DECIMAL_HALF_UNSCALED_FOR_SCALE;\n     private static final Slice[] DECIMAL_ALMOST_HALF_UNSCALED_FOR_SCALE;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU0OTMyMg==", "url": "https://github.com/prestodb/presto/pull/14783#discussion_r452549322", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (decimals < 0) {\n          \n          \n            \n                        if (decimals < -NUMBER_LENGTH) {\n          \n          \n            \n                            decimals = -NUMBER_LENGTH;\n          \n          \n            \n                        }\n          \n          \n            \n                    }\n          \n          \n            \n                    else {\n          \n          \n            \n                        if (decimals >= NUMBER_LENGTH) {\n          \n          \n            \n                            decimals = NUMBER_LENGTH;\n          \n          \n            \n                        }\n          \n          \n            \n                    }\n          \n          \n            \n                    decimals = Math.max(Math.min(decimals, NUMBER_LENGTH), -NUMBER_LENGTH);", "author": "tdcmeehan", "createdAt": "2020-07-09T23:47:25Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/scalar/MathFunctions.java", "diffHunk": "@@ -327,6 +331,69 @@ public static long truncate(@SqlType(StandardTypes.REAL) long num)\n         return floatToRawIntBits((float) (Math.signum(numInFloat) * Math.floor(Math.abs(numInFloat))));\n     }\n \n+    @Description(\"truncate to double by dropping digits after decimal point\")\n+    @ScalarFunction\n+    @SqlType(StandardTypes.DOUBLE)\n+    public static double truncate(@SqlType(StandardTypes.DOUBLE) double num, @SqlType(StandardTypes.BIGINT) long decimals)\n+    {\n+        if (Double.isNaN(num) || Double.isInfinite(num)) {\n+            // compatible with truncate(DOUBLE)\n+            return num;\n+        }\n+        if (decimals == 0) {\n+            if (num >= 0) {\n+                return Math.floor(num);\n+            }\n+            else {\n+                return Math.ceil(num);\n+            }\n+        }\n+\n+        if (decimals < 0) {\n+            if (decimals < -NUMBER_LENGTH) {\n+                decimals = -NUMBER_LENGTH;\n+            }\n+        }\n+        else {\n+            if (decimals >= NUMBER_LENGTH) {\n+                decimals = NUMBER_LENGTH;\n+            }\n+        }\n+        return BigDecimal.valueOf(num).setScale((int) decimals, BigDecimal.ROUND_DOWN).doubleValue();\n+    }\n+\n+    @Description(\"truncate to float by dropping digits after decimal point\")\n+    @ScalarFunction\n+    @SqlType(StandardTypes.REAL)\n+    public static long truncate(@SqlType(StandardTypes.REAL) long num, @SqlType(StandardTypes.BIGINT) long decimals)\n+    {\n+        float numBitsToFloats = intBitsToFloat((int) num);\n+        if (Float.isNaN(numBitsToFloats) || Float.isInfinite(numBitsToFloats)) {\n+            // compatible with truncate(REAL)\n+            return num;\n+        }\n+        if (decimals == 0) {\n+            if (numBitsToFloats >= 0) {\n+                return floatToRawIntBits((float) Math.floor(numBitsToFloats));\n+            }\n+            else {\n+                return floatToRawIntBits((float) Math.ceil(numBitsToFloats));\n+            }\n+        }\n+\n+        if (decimals < 0) {\n+            if (decimals < -NUMBER_LENGTH) {\n+                decimals = -NUMBER_LENGTH;\n+            }\n+        }\n+        else {\n+            if (decimals >= NUMBER_LENGTH) {\n+                decimals = NUMBER_LENGTH;\n+            }\n+        }", "originalCommit": "7ea31d849cf1e9143ac21cbb108c357e98a07964", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzIzMzA5Mg==", "url": "https://github.com/prestodb/presto/pull/14783#discussion_r453233092", "bodyText": "sounds good, thanks", "author": "fgwang7w", "createdAt": "2020-07-11T20:43:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU0OTMyMg=="}], "type": "inlineReview", "revised_code": {"commit": "70e0638a29d87c5560f2085435a808602bdec307", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/operator/scalar/MathFunctions.java b/presto-main/src/main/java/com/facebook/presto/operator/scalar/MathFunctions.java\nindex d546d0f51d..9d8ec4a3f9 100644\n--- a/presto-main/src/main/java/com/facebook/presto/operator/scalar/MathFunctions.java\n+++ b/presto-main/src/main/java/com/facebook/presto/operator/scalar/MathFunctions.java\n\n@@ -334,7 +334,7 @@ public final class MathFunctions\n     @Description(\"truncate to double by dropping digits after decimal point\")\n     @ScalarFunction\n     @SqlType(StandardTypes.DOUBLE)\n-    public static double truncate(@SqlType(StandardTypes.DOUBLE) double num, @SqlType(StandardTypes.BIGINT) long decimals)\n+    public static double truncate(@SqlType(StandardTypes.DOUBLE) double num, @SqlType(StandardTypes.INTEGER) long decimals)\n     {\n         if (Double.isNaN(num) || Double.isInfinite(num)) {\n             // compatible with truncate(DOUBLE)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU0OTQ0Mw==", "url": "https://github.com/prestodb/presto/pull/14783#discussion_r452549443", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (decimals < 0) {\n          \n          \n            \n                        if (decimals < -NUMBER_LENGTH) {\n          \n          \n            \n                            decimals = -NUMBER_LENGTH;\n          \n          \n            \n                        }\n          \n          \n            \n                    }\n          \n          \n            \n                    else {\n          \n          \n            \n                        if (decimals >= NUMBER_LENGTH) {\n          \n          \n            \n                            decimals = NUMBER_LENGTH;\n          \n          \n            \n                        }\n          \n          \n            \n                    }\n          \n          \n            \n                    decimals = Math.max(Math.min(decimals, NUMBER_LENGTH), -NUMBER_LENGTH);", "author": "tdcmeehan", "createdAt": "2020-07-09T23:47:49Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/scalar/MathFunctions.java", "diffHunk": "@@ -327,6 +331,69 @@ public static long truncate(@SqlType(StandardTypes.REAL) long num)\n         return floatToRawIntBits((float) (Math.signum(numInFloat) * Math.floor(Math.abs(numInFloat))));\n     }\n \n+    @Description(\"truncate to double by dropping digits after decimal point\")\n+    @ScalarFunction\n+    @SqlType(StandardTypes.DOUBLE)\n+    public static double truncate(@SqlType(StandardTypes.DOUBLE) double num, @SqlType(StandardTypes.BIGINT) long decimals)\n+    {\n+        if (Double.isNaN(num) || Double.isInfinite(num)) {\n+            // compatible with truncate(DOUBLE)\n+            return num;\n+        }\n+        if (decimals == 0) {\n+            if (num >= 0) {\n+                return Math.floor(num);\n+            }\n+            else {\n+                return Math.ceil(num);\n+            }\n+        }\n+\n+        if (decimals < 0) {\n+            if (decimals < -NUMBER_LENGTH) {\n+                decimals = -NUMBER_LENGTH;\n+            }\n+        }\n+        else {\n+            if (decimals >= NUMBER_LENGTH) {\n+                decimals = NUMBER_LENGTH;\n+            }\n+        }", "originalCommit": "7ea31d849cf1e9143ac21cbb108c357e98a07964", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "70e0638a29d87c5560f2085435a808602bdec307", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/operator/scalar/MathFunctions.java b/presto-main/src/main/java/com/facebook/presto/operator/scalar/MathFunctions.java\nindex d546d0f51d..9d8ec4a3f9 100644\n--- a/presto-main/src/main/java/com/facebook/presto/operator/scalar/MathFunctions.java\n+++ b/presto-main/src/main/java/com/facebook/presto/operator/scalar/MathFunctions.java\n\n@@ -334,7 +334,7 @@ public final class MathFunctions\n     @Description(\"truncate to double by dropping digits after decimal point\")\n     @ScalarFunction\n     @SqlType(StandardTypes.DOUBLE)\n-    public static double truncate(@SqlType(StandardTypes.DOUBLE) double num, @SqlType(StandardTypes.BIGINT) long decimals)\n+    public static double truncate(@SqlType(StandardTypes.DOUBLE) double num, @SqlType(StandardTypes.INTEGER) long decimals)\n     {\n         if (Double.isNaN(num) || Double.isInfinite(num)) {\n             // compatible with truncate(DOUBLE)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU0OTY4Ng==", "url": "https://github.com/prestodb/presto/pull/14783#discussion_r452549686", "bodyText": "Let's add some test cases for infinity and NaN.", "author": "tdcmeehan", "createdAt": "2020-07-09T23:48:43Z", "path": "presto-main/src/test/java/com/facebook/presto/operator/scalar/TestMathFunctions.java", "diffHunk": "@@ -268,6 +268,27 @@ public void testTruncate()\n         assertFunction(\"truncate(DECIMAL '1234567890123456789012.999')\", createDecimalType(22, 0), SqlDecimal.of(\"1234567890123456789012\"));\n         assertFunction(\"truncate(DECIMAL '-1234567890123456789012.999')\", createDecimalType(22, 0), SqlDecimal.of(\"-1234567890123456789012\"));\n \n+        // TRUNCATE DOUBLE -> DOUBLE\n+        assertFunction(\"truncate(nan(),-1)\", DOUBLE, Double.NaN);\n+        assertFunction(\"truncate(DOUBLE '17.1', -1)\", DOUBLE, 10.0);\n+        assertFunction(\"truncate(DOUBLE '1234.56', 1)\", DOUBLE, 1234.5);\n+        assertFunction(\"truncate(DOUBLE '1234.56', 0)\", DOUBLE, 1234.0);\n+        assertFunction(\"truncate(DOUBLE '-1234.56', 0)\", DOUBLE, -1234.0);\n+        assertFunction(\"truncate(DOUBLE '-1234.56', -500)\", DOUBLE, 0.0);\n+        assertFunction(\"truncate(DOUBLE '1234.567', 2)\", DOUBLE, 1234.56);\n+        assertFunction(\"truncate(DOUBLE '1234.567', 2)\", DOUBLE, 1234.56);\n+        assertFunction(\"truncate(DOUBLE '\" + Double.MAX_VALUE + \"', -408)\", DOUBLE, 0.0);\n+        assertFunction(\"truncate(DOUBLE '\" + -Double.MAX_VALUE / 10 + \"', 408)\", DOUBLE, -Double.MAX_VALUE / 10);\n+        assertFunction(\"truncate(DOUBLE '\" + (double) Long.MAX_VALUE + \"', -15)\", DOUBLE, 9.223E18);\n+\n+        // TRUNCATE REAL -> REAL\n+        assertFunction(\"truncate(REAL '12.333', 0)\", REAL, 12.0f);\n+        assertFunction(\"truncate(REAL '-12.333', 0)\", REAL, -12.0f);\n+        assertFunction(\"truncate(REAL '12.333', -500)\", REAL, 0.0f);\n+        assertFunction(\"truncate(REAL '3.40287e37', -35)\", REAL, 3.4E37f);\n+        assertFunction(\"truncate(REAL '3.40287e37', -488)\", REAL, 0.0f);\n+        assertFunction(\"truncate(REAL '\" + (float) Long.MAX_VALUE + \"', -15)\", REAL, 9.223E18f);", "originalCommit": "7ea31d849cf1e9143ac21cbb108c357e98a07964", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzIzMzgzNQ==", "url": "https://github.com/prestodb/presto/pull/14783#discussion_r453233835", "bodyText": "infinity and NaN cases may land up in DOUBLE case, testcases added", "author": "fgwang7w", "createdAt": "2020-07-11T20:52:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU0OTY4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "70e0638a29d87c5560f2085435a808602bdec307", "chunk": "diff --git a/presto-main/src/test/java/com/facebook/presto/operator/scalar/TestMathFunctions.java b/presto-main/src/test/java/com/facebook/presto/operator/scalar/TestMathFunctions.java\nindex 5cafaec54e..c2e8e48355 100644\n--- a/presto-main/src/test/java/com/facebook/presto/operator/scalar/TestMathFunctions.java\n+++ b/presto-main/src/test/java/com/facebook/presto/operator/scalar/TestMathFunctions.java\n\n@@ -268,27 +268,6 @@ public class TestMathFunctions\n         assertFunction(\"truncate(DECIMAL '1234567890123456789012.999')\", createDecimalType(22, 0), SqlDecimal.of(\"1234567890123456789012\"));\n         assertFunction(\"truncate(DECIMAL '-1234567890123456789012.999')\", createDecimalType(22, 0), SqlDecimal.of(\"-1234567890123456789012\"));\n \n-        // TRUNCATE DOUBLE -> DOUBLE\n-        assertFunction(\"truncate(nan(),-1)\", DOUBLE, Double.NaN);\n-        assertFunction(\"truncate(DOUBLE '17.1', -1)\", DOUBLE, 10.0);\n-        assertFunction(\"truncate(DOUBLE '1234.56', 1)\", DOUBLE, 1234.5);\n-        assertFunction(\"truncate(DOUBLE '1234.56', 0)\", DOUBLE, 1234.0);\n-        assertFunction(\"truncate(DOUBLE '-1234.56', 0)\", DOUBLE, -1234.0);\n-        assertFunction(\"truncate(DOUBLE '-1234.56', -500)\", DOUBLE, 0.0);\n-        assertFunction(\"truncate(DOUBLE '1234.567', 2)\", DOUBLE, 1234.56);\n-        assertFunction(\"truncate(DOUBLE '1234.567', 2)\", DOUBLE, 1234.56);\n-        assertFunction(\"truncate(DOUBLE '\" + Double.MAX_VALUE + \"', -408)\", DOUBLE, 0.0);\n-        assertFunction(\"truncate(DOUBLE '\" + -Double.MAX_VALUE / 10 + \"', 408)\", DOUBLE, -Double.MAX_VALUE / 10);\n-        assertFunction(\"truncate(DOUBLE '\" + (double) Long.MAX_VALUE + \"', -15)\", DOUBLE, 9.223E18);\n-\n-        // TRUNCATE REAL -> REAL\n-        assertFunction(\"truncate(REAL '12.333', 0)\", REAL, 12.0f);\n-        assertFunction(\"truncate(REAL '-12.333', 0)\", REAL, -12.0f);\n-        assertFunction(\"truncate(REAL '12.333', -500)\", REAL, 0.0f);\n-        assertFunction(\"truncate(REAL '3.40287e37', -35)\", REAL, 3.4E37f);\n-        assertFunction(\"truncate(REAL '3.40287e37', -488)\", REAL, 0.0f);\n-        assertFunction(\"truncate(REAL '\" + (float) Long.MAX_VALUE + \"', -15)\", REAL, 9.223E18f);\n-\n         // TRUNCATE_N short DECIMAL -> short DECIMAL\n         assertFunction(\"truncate(DECIMAL '1234', 1)\", createDecimalType(4, 0), SqlDecimal.of(\"1234\"));\n         assertFunction(\"truncate(DECIMAL '1234', -1)\", createDecimalType(4, 0), SqlDecimal.of(\"1230\"));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU1MDM0Mg==", "url": "https://github.com/prestodb/presto/pull/14783#discussion_r452550342", "bodyText": "We should probably change the type to be INTEGER since we're downcasting to int below.  Actually, why not make this TINYINT (max range is [-127, 128])?  If that's not sufficient precision, we could make it SMALLINT (range > 400) and safely downcast.", "author": "tdcmeehan", "createdAt": "2020-07-09T23:50:49Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/scalar/MathFunctions.java", "diffHunk": "@@ -327,6 +331,69 @@ public static long truncate(@SqlType(StandardTypes.REAL) long num)\n         return floatToRawIntBits((float) (Math.signum(numInFloat) * Math.floor(Math.abs(numInFloat))));\n     }\n \n+    @Description(\"truncate to double by dropping digits after decimal point\")\n+    @ScalarFunction\n+    @SqlType(StandardTypes.DOUBLE)\n+    public static double truncate(@SqlType(StandardTypes.DOUBLE) double num, @SqlType(StandardTypes.BIGINT) long decimals)", "originalCommit": "7ea31d849cf1e9143ac21cbb108c357e98a07964", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzIzNjQ5MQ==", "url": "https://github.com/prestodb/presto/pull/14783#discussion_r453236491", "bodyText": "are you referring to the type for decimals?it may not be sufficient to use TINYINT because truncate precision could have a long decimal precision. I  switch toINTEGER for now", "author": "fgwang7w", "createdAt": "2020-07-11T21:23:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU1MDM0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "70e0638a29d87c5560f2085435a808602bdec307", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/operator/scalar/MathFunctions.java b/presto-main/src/main/java/com/facebook/presto/operator/scalar/MathFunctions.java\nindex d546d0f51d..9d8ec4a3f9 100644\n--- a/presto-main/src/main/java/com/facebook/presto/operator/scalar/MathFunctions.java\n+++ b/presto-main/src/main/java/com/facebook/presto/operator/scalar/MathFunctions.java\n\n@@ -334,7 +334,7 @@ public final class MathFunctions\n     @Description(\"truncate to double by dropping digits after decimal point\")\n     @ScalarFunction\n     @SqlType(StandardTypes.DOUBLE)\n-    public static double truncate(@SqlType(StandardTypes.DOUBLE) double num, @SqlType(StandardTypes.BIGINT) long decimals)\n+    public static double truncate(@SqlType(StandardTypes.DOUBLE) double num, @SqlType(StandardTypes.INTEGER) long decimals)\n     {\n         if (Double.isNaN(num) || Double.isInfinite(num)) {\n             // compatible with truncate(DOUBLE)\n"}}, {"oid": "70e0638a29d87c5560f2085435a808602bdec307", "url": "https://github.com/prestodb/presto/commit/70e0638a29d87c5560f2085435a808602bdec307", "message": "Fix #14693: support TRUNCATE function for DOUBLE and REAL", "committedDate": "2020-07-11T21:26:33Z", "type": "forcePushed"}, {"oid": "1219318254ff21811d507497a4d811085087f028", "url": "https://github.com/prestodb/presto/commit/1219318254ff21811d507497a4d811085087f028", "message": "Fix #14693: support TRUNCATE function for DOUBLE and REAL", "committedDate": "2020-07-12T01:45:50Z", "type": "forcePushed"}, {"oid": "d9d578c198d6b5cdefbd7a64661924e8b5ba031f", "url": "https://github.com/prestodb/presto/commit/d9d578c198d6b5cdefbd7a64661924e8b5ba031f", "message": "Add support for TRUNCATE function for DOUBLE and REAL", "committedDate": "2020-07-21T06:55:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU5OTAxMA==", "url": "https://github.com/prestodb/presto/pull/14783#discussion_r462599010", "bodyText": "If there's a limit for decimal point, I think we should be explicit about it and mention in description and in documentation. We should probably also fail the query if an out-of-range number is given, rather than silently changing the behavior.", "author": "rongrong", "createdAt": "2020-07-29T21:26:08Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/scalar/MathFunctions.java", "diffHunk": "@@ -327,6 +331,51 @@ public static long truncate(@SqlType(StandardTypes.REAL) long num)\n         return floatToRawIntBits((float) (Math.signum(numInFloat) * Math.floor(Math.abs(numInFloat))));\n     }\n \n+    @Description(\"truncate to double by dropping digits after decimal point\")", "originalCommit": "d9d578c198d6b5cdefbd7a64661924e8b5ba031f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYxMDczNQ==", "url": "https://github.com/prestodb/presto/pull/14783#discussion_r462610735", "bodyText": "Though if the limit is actually limitation of double then this behavior is fine. But in that case I think we also don't have to special handle the max?", "author": "rongrong", "createdAt": "2020-07-29T21:51:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU5OTAxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIyNTQ0NA==", "url": "https://github.com/prestodb/presto/pull/14783#discussion_r463225444", "bodyText": "Thanks for the review. Are you suggesting to document the max number of precision for double type in alignment with MAX_DECIMAL_PLACES value? Yes the limit only handles the double/real type behavior. If the max limit reaches/exceeded, the outcome should be either 0.0 or negative value. I have 2 tests covered that:\nassertFunction(\"truncate(DOUBLE '\" + Double.MAX_VALUE + \"', -408)\", DOUBLE, 0.0); assertFunction(\"truncate(DOUBLE '\" + -Double.MAX_VALUE / 10 + \"', 408)\", DOUBLE, -Double.MAX_VALUE / 10); \nIs this what you were thinking to cover? @rongrong", "author": "fgwang7w", "createdAt": "2020-07-30T19:35:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU5OTAxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzMwNzgwMw==", "url": "https://github.com/prestodb/presto/pull/14783#discussion_r473307803", "bodyText": "I mean add this to the rst file. Maybe also add it to the function description. So people know the maximum value for decimals should be within 400. Also document the behavior if the provided decimal is larger than 400. Why do we choose 400 as the max digit though? What's the logic behind this?", "author": "rongrong", "createdAt": "2020-08-19T20:45:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU5OTAxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU0MzI1MQ==", "url": "https://github.com/prestodb/presto/pull/14783#discussion_r473543251", "bodyText": "Actually I double-checked the oracle doc which indicates that the scale of the decimal points ranges from -84 to 127. I will change 400 to 127 to align with oracle's behavior and document it in rst file.", "author": "fgwang7w", "createdAt": "2020-08-20T02:19:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU5OTAxMA=="}], "type": "inlineReview", "revised_code": {"commit": "900b1044c48650c9c9417b5ee35b68c85220dd53", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/operator/scalar/MathFunctions.java b/presto-main/src/main/java/com/facebook/presto/operator/scalar/MathFunctions.java\nindex 9d8ec4a3f9..c6f6c05dd0 100644\n--- a/presto-main/src/main/java/com/facebook/presto/operator/scalar/MathFunctions.java\n+++ b/presto-main/src/main/java/com/facebook/presto/operator/scalar/MathFunctions.java\n\n@@ -349,7 +346,6 @@ public final class MathFunctions\n             }\n         }\n \n-        decimals = Math.max(Math.min(decimals, MAX_DECIMAL_PLACES), -MAX_DECIMAL_PLACES);\n         return BigDecimal.valueOf(num).setScale((int) decimals, BigDecimal.ROUND_DOWN).doubleValue();\n     }\n \n"}}, {"oid": "58587329ef56c524df3705e945b7e1243642ff7d", "url": "https://github.com/prestodb/presto/commit/58587329ef56c524df3705e945b7e1243642ff7d", "message": "Add support for TRUNCATE function for DOUBLE and REAL", "committedDate": "2020-08-20T02:21:00Z", "type": "forcePushed"}, {"oid": "4685a6cec5d9f260ace304cd197ecae347bf3a5e", "url": "https://github.com/prestodb/presto/commit/4685a6cec5d9f260ace304cd197ecae347bf3a5e", "message": "Add support for TRUNCATE function for DOUBLE and REAL", "committedDate": "2020-08-20T02:42:54Z", "type": "forcePushed"}, {"oid": "900b1044c48650c9c9417b5ee35b68c85220dd53", "url": "https://github.com/prestodb/presto/commit/900b1044c48650c9c9417b5ee35b68c85220dd53", "message": "Add support for TRUNCATE function for DOUBLE and REAL", "committedDate": "2020-08-20T02:47:04Z", "type": "forcePushed"}, {"oid": "ae4dd656a1ba4ed3ab3dc9df314b9271b0fe2eab", "url": "https://github.com/prestodb/presto/commit/ae4dd656a1ba4ed3ab3dc9df314b9271b0fe2eab", "message": "Add support for TRUNCATE function for DOUBLE and REAL", "committedDate": "2020-08-20T02:56:53Z", "type": "commit"}, {"oid": "ae4dd656a1ba4ed3ab3dc9df314b9271b0fe2eab", "url": "https://github.com/prestodb/presto/commit/ae4dd656a1ba4ed3ab3dc9df314b9271b0fe2eab", "message": "Add support for TRUNCATE function for DOUBLE and REAL", "committedDate": "2020-08-20T02:56:53Z", "type": "forcePushed"}]}