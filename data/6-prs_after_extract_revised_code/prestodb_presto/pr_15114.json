{"pr_number": 15114, "pr_title": "Add waitForMinimumCoordinators to ClusterSizeMonitor", "pr_createdAt": "2020-09-03T00:08:55Z", "pr_url": "https://github.com/prestodb/presto/pull/15114", "timeline": [{"oid": "1854f3097cc49dfffcec0f9541169a683f6371d8", "url": "https://github.com/prestodb/presto/commit/1854f3097cc49dfffcec0f9541169a683f6371d8", "message": "Add waitForMinimumCoordinators to ClusterSizeMonitor", "committedDate": "2020-09-03T03:00:41Z", "type": "forcePushed"}, {"oid": "6c3473c9b211264b85b06d41b0020042d6d9b746", "url": "https://github.com/prestodb/presto/commit/6c3473c9b211264b85b06d41b0020042d6d9b746", "message": "Add waitForMinimumCoordinators to ClusterSizeMonitor", "committedDate": "2020-09-03T04:50:45Z", "type": "forcePushed"}, {"oid": "4a63573a082669bf7d2e57aa51380e24df21902c", "url": "https://github.com/prestodb/presto/commit/4a63573a082669bf7d2e57aa51380e24df21902c", "message": "Add waitForMinimumCoordinators to ClusterSizeMonitor", "committedDate": "2020-09-03T04:54:44Z", "type": "forcePushed"}, {"oid": "21f362aa6e483b0afdff2a4a9bb6f7dbf3a1c95d", "url": "https://github.com/prestodb/presto/commit/21f362aa6e483b0afdff2a4a9bb6f7dbf3a1c95d", "message": "Add waitForMinimumCoordinators to ClusterSizeMonitor", "committedDate": "2020-09-03T21:22:28Z", "type": "forcePushed"}, {"oid": "a980859f6a49d2add84ca9427e3d59e60c8a8178", "url": "https://github.com/prestodb/presto/commit/a980859f6a49d2add84ca9427e3d59e60c8a8178", "message": "Add waitForMinimumCoordinators to ClusterSizeMonitor", "committedDate": "2020-09-05T20:11:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA4MTkyNg==", "url": "https://github.com/prestodb/presto/pull/15114#discussion_r486081926", "bodyText": "requireNonNull for queryManager, any reason not doing it here?", "author": "swapsmagic", "createdAt": "2020-09-10T05:53:29Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java", "diffHunk": "@@ -66,20 +73,27 @@ public ClusterSizeMonitor(InternalNodeManager nodeManager, NodeSchedulerConfig n\n                 nodeManager,\n                 requireNonNull(nodeSchedulerConfig, \"nodeSchedulerConfig is null\").isIncludeCoordinator(),\n                 requireNonNull(queryManagerConfig, \"queryManagerConfig is null\").getRequiredWorkers(),\n-                queryManagerConfig.getRequiredWorkersMaxWait());\n+                queryManagerConfig.getRequiredWorkersMaxWait(),", "originalCommit": "a980859f6a49d2add84ca9427e3d59e60c8a8178", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjU5ODg2MA==", "url": "https://github.com/prestodb/presto/pull/15114#discussion_r486598860", "bodyText": "We do it above.  Can remove the check below.", "author": "tdcmeehan", "createdAt": "2020-09-10T19:58:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA4MTkyNg=="}], "type": "inlineReview", "revised_code": {"commit": "13f939e5bd5af139c04a5befbadb7378b693d702", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java b/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java\nindex 929916fea3..6e6b98f03f 100644\n--- a/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java\n+++ b/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java\n\n@@ -74,7 +75,7 @@ public class ClusterSizeMonitor\n                 requireNonNull(nodeSchedulerConfig, \"nodeSchedulerConfig is null\").isIncludeCoordinator(),\n                 requireNonNull(queryManagerConfig, \"queryManagerConfig is null\").getRequiredWorkers(),\n                 queryManagerConfig.getRequiredWorkersMaxWait(),\n-                requireNonNull(queryManagerConfig, \"queryManagerConfig is null\").getRequiredCoordinators(),\n+                queryManagerConfig.getRequiredCoordinators(),\n                 queryManagerConfig.getRequiredCoordinatorsMaxWait());\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA4MjA5Mw==", "url": "https://github.com/prestodb/presto/pull/15114#discussion_r486082093", "bodyText": "ditto", "author": "swapsmagic", "createdAt": "2020-09-10T05:54:05Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java", "diffHunk": "@@ -66,20 +73,27 @@ public ClusterSizeMonitor(InternalNodeManager nodeManager, NodeSchedulerConfig n\n                 nodeManager,\n                 requireNonNull(nodeSchedulerConfig, \"nodeSchedulerConfig is null\").isIncludeCoordinator(),\n                 requireNonNull(queryManagerConfig, \"queryManagerConfig is null\").getRequiredWorkers(),\n-                queryManagerConfig.getRequiredWorkersMaxWait());\n+                queryManagerConfig.getRequiredWorkersMaxWait(),\n+                requireNonNull(queryManagerConfig, \"queryManagerConfig is null\").getRequiredCoordinators(),\n+                queryManagerConfig.getRequiredCoordinatorsMaxWait());", "originalCommit": "a980859f6a49d2add84ca9427e3d59e60c8a8178", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "13f939e5bd5af139c04a5befbadb7378b693d702", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java b/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java\nindex 929916fea3..6e6b98f03f 100644\n--- a/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java\n+++ b/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java\n\n@@ -74,7 +75,7 @@ public class ClusterSizeMonitor\n                 requireNonNull(nodeSchedulerConfig, \"nodeSchedulerConfig is null\").isIncludeCoordinator(),\n                 requireNonNull(queryManagerConfig, \"queryManagerConfig is null\").getRequiredWorkers(),\n                 queryManagerConfig.getRequiredWorkersMaxWait(),\n-                requireNonNull(queryManagerConfig, \"queryManagerConfig is null\").getRequiredCoordinators(),\n+                queryManagerConfig.getRequiredCoordinators(),\n                 queryManagerConfig.getRequiredCoordinatorsMaxWait());\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA4Mjc2MQ==", "url": "https://github.com/prestodb/presto/pull/15114#discussion_r486082761", "bodyText": "coordinatorMaxWait seems a reasonable name here and also aligns with other arguments.", "author": "swapsmagic", "createdAt": "2020-09-10T05:56:05Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java", "diffHunk": "@@ -66,20 +73,27 @@ public ClusterSizeMonitor(InternalNodeManager nodeManager, NodeSchedulerConfig n\n                 nodeManager,\n                 requireNonNull(nodeSchedulerConfig, \"nodeSchedulerConfig is null\").isIncludeCoordinator(),\n                 requireNonNull(queryManagerConfig, \"queryManagerConfig is null\").getRequiredWorkers(),\n-                queryManagerConfig.getRequiredWorkersMaxWait());\n+                queryManagerConfig.getRequiredWorkersMaxWait(),\n+                requireNonNull(queryManagerConfig, \"queryManagerConfig is null\").getRequiredCoordinators(),\n+                queryManagerConfig.getRequiredCoordinatorsMaxWait());\n     }\n \n     public ClusterSizeMonitor(\n             InternalNodeManager nodeManager,\n             boolean includeCoordinator,\n             int executionMinCount,\n-            Duration executionMaxWait)\n+            Duration executionMaxWait,\n+            int minCoordinatorCount,\n+            Duration maxCoordinatorWait)", "originalCommit": "a980859f6a49d2add84ca9427e3d59e60c8a8178", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY5NjY0NA==", "url": "https://github.com/prestodb/presto/pull/15114#discussion_r486696644", "bodyText": "The inverted wording of the original annoyed me, but I can make them consistent.", "author": "tdcmeehan", "createdAt": "2020-09-10T23:57:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA4Mjc2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "13f939e5bd5af139c04a5befbadb7378b693d702", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java b/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java\nindex 929916fea3..6e6b98f03f 100644\n--- a/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java\n+++ b/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java\n\n@@ -74,7 +75,7 @@ public class ClusterSizeMonitor\n                 requireNonNull(nodeSchedulerConfig, \"nodeSchedulerConfig is null\").isIncludeCoordinator(),\n                 requireNonNull(queryManagerConfig, \"queryManagerConfig is null\").getRequiredWorkers(),\n                 queryManagerConfig.getRequiredWorkersMaxWait(),\n-                requireNonNull(queryManagerConfig, \"queryManagerConfig is null\").getRequiredCoordinators(),\n+                queryManagerConfig.getRequiredCoordinators(),\n                 queryManagerConfig.getRequiredCoordinatorsMaxWait());\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA4MzU2NA==", "url": "https://github.com/prestodb/presto/pull/15114#discussion_r486083564", "bodyText": "looks like we need two method one for removing workerSizeFutures and one for removing coordinatorSizeFutures.", "author": "swapsmagic", "createdAt": "2020-09-10T05:58:32Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java", "diffHunk": "@@ -131,22 +145,62 @@ public void stop()\n         return future;\n     }\n \n+    public synchronized ListenableFuture<?> waitForMinimumCoordinators()\n+    {\n+        if (currentCoordinatorCount >= minCoordinatorCount) {\n+            return immediateFuture(null);\n+        }\n+\n+        SettableFuture<?> future = SettableFuture.create();\n+        coordinatorSizeFutures.add(future);\n+\n+        // if future does not finish in wait period, complete with an exception\n+        ScheduledFuture<?> timeoutTask = executor.schedule(\n+                () -> {\n+                    synchronized (this) {\n+                        future.setException(new PrestoException(\n+                                GENERIC_INSUFFICIENT_RESOURCES,\n+                                format(\"Insufficient active coordinator nodes. Waited %s for at least %s coordinators, but only %s coordinators are active\", executionMaxWait, 2, currentCoordinatorCount)));\n+                    }\n+                },\n+                maxCoordinatorWait.toMillis(),\n+                MILLISECONDS);\n+\n+        // remove future if finished (e.g., canceled, timed out)\n+        future.addListener(() -> {\n+            timeoutTask.cancel(true);\n+            removeFuture(future);\n+        }, executor);\n+\n+        return future;\n+    }\n+\n     private synchronized void removeFuture(SettableFuture<?> future)", "originalCommit": "a980859f6a49d2add84ca9427e3d59e60c8a8178", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY5NTg5Mw==", "url": "https://github.com/prestodb/presto/pull/15114#discussion_r486695893", "bodyText": "Good catch, thanks.", "author": "tdcmeehan", "createdAt": "2020-09-10T23:55:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA4MzU2NA=="}], "type": "inlineReview", "revised_code": {"commit": "13f939e5bd5af139c04a5befbadb7378b693d702", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java b/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java\nindex 929916fea3..6e6b98f03f 100644\n--- a/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java\n+++ b/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java\n\n@@ -139,7 +140,7 @@ public class ClusterSizeMonitor\n         // remove future if finished (e.g., canceled, timed out)\n         future.addListener(() -> {\n             timeoutTask.cancel(true);\n-            removeFuture(future);\n+            removeWorkerFuture(future);\n         }, executor);\n \n         return future;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA4MzY1Mw==", "url": "https://github.com/prestodb/presto/pull/15114#discussion_r486083653", "bodyText": "this will remove this future from workerSizeFutures where it's not present.", "author": "swapsmagic", "createdAt": "2020-09-10T05:58:49Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java", "diffHunk": "@@ -131,22 +145,62 @@ public void stop()\n         return future;\n     }\n \n+    public synchronized ListenableFuture<?> waitForMinimumCoordinators()\n+    {\n+        if (currentCoordinatorCount >= minCoordinatorCount) {\n+            return immediateFuture(null);\n+        }\n+\n+        SettableFuture<?> future = SettableFuture.create();\n+        coordinatorSizeFutures.add(future);\n+\n+        // if future does not finish in wait period, complete with an exception\n+        ScheduledFuture<?> timeoutTask = executor.schedule(\n+                () -> {\n+                    synchronized (this) {\n+                        future.setException(new PrestoException(\n+                                GENERIC_INSUFFICIENT_RESOURCES,\n+                                format(\"Insufficient active coordinator nodes. Waited %s for at least %s coordinators, but only %s coordinators are active\", executionMaxWait, 2, currentCoordinatorCount)));\n+                    }\n+                },\n+                maxCoordinatorWait.toMillis(),\n+                MILLISECONDS);\n+\n+        // remove future if finished (e.g., canceled, timed out)\n+        future.addListener(() -> {\n+            timeoutTask.cancel(true);\n+            removeFuture(future);", "originalCommit": "a980859f6a49d2add84ca9427e3d59e60c8a8178", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "13f939e5bd5af139c04a5befbadb7378b693d702", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java b/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java\nindex 929916fea3..6e6b98f03f 100644\n--- a/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java\n+++ b/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java\n\n@@ -139,7 +140,7 @@ public class ClusterSizeMonitor\n         // remove future if finished (e.g., canceled, timed out)\n         future.addListener(() -> {\n             timeoutTask.cancel(true);\n-            removeFuture(future);\n+            removeWorkerFuture(future);\n         }, executor);\n \n         return future;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA4NTQ2Ng==", "url": "https://github.com/prestodb/presto/pull/15114#discussion_r486085466", "bodyText": "Any specific reason to not use the getActiveNodes and getActiveCoordinator methods here instead and again calculating it?", "author": "swapsmagic", "createdAt": "2020-09-10T06:04:20Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java", "diffHunk": "@@ -131,22 +145,62 @@ public void stop()\n         return future;\n     }\n \n+    public synchronized ListenableFuture<?> waitForMinimumCoordinators()\n+    {\n+        if (currentCoordinatorCount >= minCoordinatorCount) {\n+            return immediateFuture(null);\n+        }\n+\n+        SettableFuture<?> future = SettableFuture.create();\n+        coordinatorSizeFutures.add(future);\n+\n+        // if future does not finish in wait period, complete with an exception\n+        ScheduledFuture<?> timeoutTask = executor.schedule(\n+                () -> {\n+                    synchronized (this) {\n+                        future.setException(new PrestoException(\n+                                GENERIC_INSUFFICIENT_RESOURCES,\n+                                format(\"Insufficient active coordinator nodes. Waited %s for at least %s coordinators, but only %s coordinators are active\", executionMaxWait, 2, currentCoordinatorCount)));\n+                    }\n+                },\n+                maxCoordinatorWait.toMillis(),\n+                MILLISECONDS);\n+\n+        // remove future if finished (e.g., canceled, timed out)\n+        future.addListener(() -> {\n+            timeoutTask.cancel(true);\n+            removeFuture(future);\n+        }, executor);\n+\n+        return future;\n+    }\n+\n     private synchronized void removeFuture(SettableFuture<?> future)\n     {\n-        futures.remove(future);\n+        workerSizeFutures.remove(future);\n     }\n \n     private synchronized void updateAllNodes(AllNodes allNodes)\n     {\n-        if (includeCoordinator) {\n-            currentCount = allNodes.getActiveNodes().size();\n-        }\n-        else {\n-            currentCount = Sets.difference(allNodes.getActiveNodes(), allNodes.getActiveCoordinators()).size();\n-        }\n+        currentCount = 0;\n+        currentCoordinatorCount = 0;\n+        allNodes.getActiveNodes().forEach(node -> {", "originalCommit": "a980859f6a49d2add84ca9427e3d59e60c8a8178", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY5NTQ5NQ==", "url": "https://github.com/prestodb/presto/pull/15114#discussion_r486695495", "bodyText": "That's a good point, thanks.", "author": "tdcmeehan", "createdAt": "2020-09-10T23:53:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA4NTQ2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "13f939e5bd5af139c04a5befbadb7378b693d702", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java b/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java\nindex 929916fea3..6e6b98f03f 100644\n--- a/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java\n+++ b/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java\n\n@@ -139,7 +140,7 @@ public class ClusterSizeMonitor\n         // remove future if finished (e.g., canceled, timed out)\n         future.addListener(() -> {\n             timeoutTask.cancel(true);\n-            removeFuture(future);\n+            removeWorkerFuture(future);\n         }, executor);\n \n         return future;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA4NjgyMg==", "url": "https://github.com/prestodb/presto/pull/15114#discussion_r486086822", "bodyText": "Not sure how important it is, but if the cluster doesn't have enough coordinator and workers, we should always return not enough coordinator error. With current implementation if could be either one (not enough coordinator/not enough worker) of the error that we return and the behavior is not consistent.\nIf we can guarantee that somehow, that would be great.", "author": "swapsmagic", "createdAt": "2020-09-10T06:08:18Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java", "diffHunk": "@@ -131,22 +145,62 @@ public void stop()\n         return future;\n     }\n \n+    public synchronized ListenableFuture<?> waitForMinimumCoordinators()\n+    {\n+        if (currentCoordinatorCount >= minCoordinatorCount) {\n+            return immediateFuture(null);\n+        }\n+\n+        SettableFuture<?> future = SettableFuture.create();\n+        coordinatorSizeFutures.add(future);\n+\n+        // if future does not finish in wait period, complete with an exception\n+        ScheduledFuture<?> timeoutTask = executor.schedule(\n+                () -> {\n+                    synchronized (this) {\n+                        future.setException(new PrestoException(\n+                                GENERIC_INSUFFICIENT_RESOURCES,\n+                                format(\"Insufficient active coordinator nodes. Waited %s for at least %s coordinators, but only %s coordinators are active\", executionMaxWait, 2, currentCoordinatorCount)));\n+                    }\n+                },\n+                maxCoordinatorWait.toMillis(),\n+                MILLISECONDS);\n+\n+        // remove future if finished (e.g., canceled, timed out)\n+        future.addListener(() -> {\n+            timeoutTask.cancel(true);\n+            removeFuture(future);\n+        }, executor);\n+\n+        return future;\n+    }\n+\n     private synchronized void removeFuture(SettableFuture<?> future)\n     {\n-        futures.remove(future);\n+        workerSizeFutures.remove(future);\n     }\n \n     private synchronized void updateAllNodes(AllNodes allNodes)\n     {\n-        if (includeCoordinator) {\n-            currentCount = allNodes.getActiveNodes().size();\n-        }\n-        else {\n-            currentCount = Sets.difference(allNodes.getActiveNodes(), allNodes.getActiveCoordinators()).size();\n-        }\n+        currentCount = 0;\n+        currentCoordinatorCount = 0;\n+        allNodes.getActiveNodes().forEach(node -> {\n+            if (node.isCoordinator()) {\n+                currentCoordinatorCount += 1;\n+                if (!includeCoordinator) {\n+                    return;\n+                }\n+            }\n+            currentCount += 1;\n+        });\n         if (currentCount >= executionMinCount) {", "originalCommit": "a980859f6a49d2add84ca9427e3d59e60c8a8178", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY5NjI0Nw==", "url": "https://github.com/prestodb/presto/pull/15114#discussion_r486696247", "bodyText": "We already have this behavior, because one will wait for one or the other via the waitForMinimumWorkers or waitForMinimumCoordinators methods.", "author": "tdcmeehan", "createdAt": "2020-09-10T23:56:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA4NjgyMg=="}], "type": "inlineReview", "revised_code": {"commit": "13f939e5bd5af139c04a5befbadb7378b693d702", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java b/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java\nindex 929916fea3..6e6b98f03f 100644\n--- a/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java\n+++ b/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java\n\n@@ -139,7 +140,7 @@ public class ClusterSizeMonitor\n         // remove future if finished (e.g., canceled, timed out)\n         future.addListener(() -> {\n             timeoutTask.cancel(true);\n-            removeFuture(future);\n+            removeWorkerFuture(future);\n         }, executor);\n \n         return future;\n"}}, {"oid": "13f939e5bd5af139c04a5befbadb7378b693d702", "url": "https://github.com/prestodb/presto/commit/13f939e5bd5af139c04a5befbadb7378b693d702", "message": "Add waitForMinimumCoordinators to ClusterSizeMonitor", "committedDate": "2020-09-11T00:05:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI2NDI1OQ==", "url": "https://github.com/prestodb/presto/pull/15114#discussion_r487264259", "bodyText": "should we rename this to currentWorkerCount to make it clearer?", "author": "mayankgarg1990", "createdAt": "2020-09-11T20:04:25Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java", "diffHunk": "@@ -57,7 +59,13 @@\n     private int currentCount;", "originalCommit": "13f939e5bd5af139c04a5befbadb7378b693d702", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI4MTcwNg==", "url": "https://github.com/prestodb/presto/pull/15114#discussion_r487281706", "bodyText": "Sure.", "author": "tdcmeehan", "createdAt": "2020-09-11T20:43:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI2NDI1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "d62c34afb588ba58b30e948e6bf6f5fea70ac765", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java b/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java\nindex 6e6b98f03f..f0ebf4b1c3 100644\n--- a/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java\n+++ b/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java\n\n@@ -56,7 +56,7 @@ public class ClusterSizeMonitor\n     private final Consumer<AllNodes> listener = this::updateAllNodes;\n \n     @GuardedBy(\"this\")\n-    private int currentCount;\n+    private int currentWorkerCount;\n \n     @GuardedBy(\"this\")\n     private int currentCoordinatorCount;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI3MDM2MA==", "url": "https://github.com/prestodb/presto/pull/15114#discussion_r487270360", "bodyText": "instead of having 2 different functions - do you feel we should have a single function waitForMinimumNodes() (or some better name) which takes into account both workers and coordinators? Also, this PR does not use this function yet, will this be followed up in a separate PR? If yes, I am curious why?", "author": "mayankgarg1990", "createdAt": "2020-09-11T20:18:42Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java", "diffHunk": "@@ -125,15 +140,50 @@ public void stop()\n         // remove future if finished (e.g., canceled, timed out)\n         future.addListener(() -> {\n             timeoutTask.cancel(true);\n-            removeFuture(future);\n+            removeWorkerFuture(future);\n         }, executor);\n \n         return future;\n     }\n \n-    private synchronized void removeFuture(SettableFuture<?> future)\n+    public synchronized ListenableFuture<?> waitForMinimumCoordinators()", "originalCommit": "13f939e5bd5af139c04a5befbadb7378b693d702", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI4MTYwOQ==", "url": "https://github.com/prestodb/presto/pull/15114#discussion_r487281609", "bodyText": "I would prefer to wait for them separately so we could have an accurate message indicating the resource problem (insufficient coordinators/insufficient workers).\nYou can see how it fits together in the Extract from reference in the PR description.  I'm putting these out as small PRs to make it easy to review thoroughly.", "author": "tdcmeehan", "createdAt": "2020-09-11T20:43:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI3MDM2MA=="}], "type": "inlineReview", "revised_code": {"commit": "d62c34afb588ba58b30e948e6bf6f5fea70ac765", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java b/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java\nindex 6e6b98f03f..f0ebf4b1c3 100644\n--- a/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java\n+++ b/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java\n\n@@ -189,13 +189,13 @@ public class ClusterSizeMonitor\n     private synchronized void updateAllNodes(AllNodes allNodes)\n     {\n         if (includeCoordinator) {\n-            currentCount = allNodes.getActiveNodes().size();\n+            currentWorkerCount = allNodes.getActiveNodes().size();\n         }\n         else {\n-            currentCount = Sets.difference(allNodes.getActiveNodes(), allNodes.getActiveCoordinators()).size();\n+            currentWorkerCount = Sets.difference(allNodes.getActiveNodes(), allNodes.getActiveCoordinators()).size();\n         }\n         currentCoordinatorCount = allNodes.getActiveCoordinators().size();\n-        if (currentCount >= executionMinCount) {\n+        if (currentWorkerCount >= workerMinCount) {\n             ImmutableList<SettableFuture<?>> listeners = ImmutableList.copyOf(workerSizeFutures);\n             workerSizeFutures.clear();\n             executor.submit(() -> listeners.forEach(listener -> listener.set(null)));\n"}}, {"oid": "d62c34afb588ba58b30e948e6bf6f5fea70ac765", "url": "https://github.com/prestodb/presto/commit/d62c34afb588ba58b30e948e6bf6f5fea70ac765", "message": "Add waitForMinimumCoordinators to ClusterSizeMonitor", "committedDate": "2020-09-11T22:46:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODA2NzQxMQ==", "url": "https://github.com/prestodb/presto/pull/15114#discussion_r488067411", "bodyText": "List<SettableFuture<?>>", "author": "highker", "createdAt": "2020-09-14T16:31:46Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java", "diffHunk": "@@ -125,28 +140,69 @@ public void stop()\n         // remove future if finished (e.g., canceled, timed out)\n         future.addListener(() -> {\n             timeoutTask.cancel(true);\n-            removeFuture(future);\n+            removeWorkerFuture(future);\n         }, executor);\n \n         return future;\n     }\n \n-    private synchronized void removeFuture(SettableFuture<?> future)\n+    public synchronized ListenableFuture<?> waitForMinimumCoordinators()\n     {\n-        futures.remove(future);\n+        if (currentCoordinatorCount >= coordinatorMinCount) {\n+            return immediateFuture(null);\n+        }\n+\n+        SettableFuture<?> future = SettableFuture.create();\n+        coordinatorSizeFutures.add(future);\n+\n+        // if future does not finish in wait period, complete with an exception\n+        ScheduledFuture<?> timeoutTask = executor.schedule(\n+                () -> {\n+                    synchronized (this) {\n+                        future.setException(new PrestoException(\n+                                GENERIC_INSUFFICIENT_RESOURCES,\n+                                format(\"Insufficient active coordinator nodes. Waited %s for at least %s coordinators, but only %s coordinators are active\", executionMaxWait, 2, currentCoordinatorCount)));\n+                    }\n+                },\n+                coordinatorMaxWait.toMillis(),\n+                MILLISECONDS);\n+\n+        // remove future if finished (e.g., canceled, timed out)\n+        future.addListener(() -> {\n+            timeoutTask.cancel(true);\n+            removeCoordinatorFuture(future);\n+        }, executor);\n+\n+        return future;\n+    }\n+\n+    private synchronized void removeWorkerFuture(SettableFuture<?> future)\n+    {\n+        workerSizeFutures.remove(future);\n+    }\n+\n+    private synchronized void removeCoordinatorFuture(SettableFuture<?> future)\n+    {\n+        coordinatorSizeFutures.remove(future);\n     }\n \n     private synchronized void updateAllNodes(AllNodes allNodes)\n     {\n         if (includeCoordinator) {\n-            currentCount = allNodes.getActiveNodes().size();\n+            currentWorkerCount = allNodes.getActiveNodes().size();\n         }\n         else {\n-            currentCount = Sets.difference(allNodes.getActiveNodes(), allNodes.getActiveCoordinators()).size();\n+            currentWorkerCount = Sets.difference(allNodes.getActiveNodes(), allNodes.getActiveCoordinators()).size();\n+        }\n+        currentCoordinatorCount = allNodes.getActiveCoordinators().size();\n+        if (currentWorkerCount >= workerMinCount) {\n+            ImmutableList<SettableFuture<?>> listeners = ImmutableList.copyOf(workerSizeFutures);\n+            workerSizeFutures.clear();\n+            executor.submit(() -> listeners.forEach(listener -> listener.set(null)));\n         }\n-        if (currentCount >= executionMinCount) {\n-            ImmutableList<SettableFuture<?>> listeners = ImmutableList.copyOf(futures);\n-            futures.clear();\n+        if (currentCoordinatorCount >= coordinatorMinCount) {\n+            ImmutableList<SettableFuture<?>> listeners = ImmutableList.copyOf(coordinatorSizeFutures);", "originalCommit": "d62c34afb588ba58b30e948e6bf6f5fea70ac765", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "446be0cfc20ffc36cfaf7fb91f431b4b1a8f879e", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java b/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java\nindex f0ebf4b1c3..fb2efdae15 100644\n--- a/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java\n+++ b/presto-main/src/main/java/com/facebook/presto/execution/ClusterSizeMonitor.java\n\n@@ -196,12 +196,12 @@ public class ClusterSizeMonitor\n         }\n         currentCoordinatorCount = allNodes.getActiveCoordinators().size();\n         if (currentWorkerCount >= workerMinCount) {\n-            ImmutableList<SettableFuture<?>> listeners = ImmutableList.copyOf(workerSizeFutures);\n+            List<SettableFuture<?>> listeners = ImmutableList.copyOf(workerSizeFutures);\n             workerSizeFutures.clear();\n             executor.submit(() -> listeners.forEach(listener -> listener.set(null)));\n         }\n         if (currentCoordinatorCount >= coordinatorMinCount) {\n-            ImmutableList<SettableFuture<?>> listeners = ImmutableList.copyOf(coordinatorSizeFutures);\n+            List<SettableFuture<?>> listeners = ImmutableList.copyOf(coordinatorSizeFutures);\n             coordinatorSizeFutures.clear();\n             executor.submit(() -> listeners.forEach(listener -> listener.set(null)));\n         }\n"}}, {"oid": "446be0cfc20ffc36cfaf7fb91f431b4b1a8f879e", "url": "https://github.com/prestodb/presto/commit/446be0cfc20ffc36cfaf7fb91f431b4b1a8f879e", "message": "Add waitForMinimumCoordinators to ClusterSizeMonitor", "committedDate": "2020-09-15T21:55:42Z", "type": "commit"}, {"oid": "446be0cfc20ffc36cfaf7fb91f431b4b1a8f879e", "url": "https://github.com/prestodb/presto/commit/446be0cfc20ffc36cfaf7fb91f431b4b1a8f879e", "message": "Add waitForMinimumCoordinators to ClusterSizeMonitor", "committedDate": "2020-09-15T21:55:42Z", "type": "forcePushed"}]}