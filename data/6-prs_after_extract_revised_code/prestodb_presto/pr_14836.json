{"pr_number": 14836, "pr_title": "Implement ORDER BY spilling", "pr_createdAt": "2020-07-13T22:39:07Z", "pr_url": "https://github.com/prestodb/presto/pull/14836", "timeline": [{"oid": "b5ba14420f8299181c88925d5caf9465567ff99a", "url": "https://github.com/prestodb/presto/commit/b5ba14420f8299181c88925d5caf9465567ff99a", "message": "Extract order by queries tests to separate class\nCherry-pick of https://github.com/prestosql/presto/commit/94b4d0a42f8c86b95b6c3664c5cd83b6eab7297a Co-authored-by: Karol Sobczak <karol.sobczak@karolsobczak.com>", "committedDate": "2020-07-13T23:30:31Z", "type": "forcePushed"}, {"oid": "fbb49765c6ebb152726b14dffb7acaebfe5156a4", "url": "https://github.com/prestodb/presto/commit/fbb49765c6ebb152726b14dffb7acaebfe5156a4", "message": "Extract order by queries tests to separate class\nCherry-pick of https://github.com/prestosql/presto/commit/94b4d0a42f8c86b95b6c3664c5cd83b6eab7297a Co-authored-by: Karol Sobczak <karol.sobczak@karolsobczak.com>", "committedDate": "2020-07-13T23:31:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjczOTU5OA==", "url": "https://github.com/prestodb/presto/pull/14836#discussion_r456739598", "bodyText": "The entire commit \"Add feature toggle for ORDER BY spill\" doesn't seem to be necessary given the existing join spilling is buggy. So the legacy spilling doesn't work anyway. No need to use another guard.", "author": "highker", "createdAt": "2020-07-18T02:49:40Z", "path": "presto-main/src/main/java/com/facebook/presto/SystemSessionProperties.java", "diffHunk": "@@ -113,6 +113,7 @@\n     public static final String FAST_INEQUALITY_JOINS = \"fast_inequality_joins\";\n     public static final String QUERY_PRIORITY = \"query_priority\";\n     public static final String SPILL_ENABLED = \"spill_enabled\";\n+    public static final String SPILL_ORDER_BY = \"spill_order_by\";", "originalCommit": "2d0a5a40091558f28ccaf42304aeccf0cc88a342", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "155efc31477748123999c3f5ad261314ffce30e5", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/SystemSessionProperties.java b/presto-main/src/main/java/com/facebook/presto/SystemSessionProperties.java\nindex 559fa23896..4de87180cf 100644\n--- a/presto-main/src/main/java/com/facebook/presto/SystemSessionProperties.java\n+++ b/presto-main/src/main/java/com/facebook/presto/SystemSessionProperties.java\n\n@@ -113,7 +113,6 @@ public final class SystemSessionProperties\n     public static final String FAST_INEQUALITY_JOINS = \"fast_inequality_joins\";\n     public static final String QUERY_PRIORITY = \"query_priority\";\n     public static final String SPILL_ENABLED = \"spill_enabled\";\n-    public static final String SPILL_ORDER_BY = \"spill_order_by\";\n     public static final String AGGREGATION_OPERATOR_UNSPILL_MEMORY_LIMIT = \"aggregation_operator_unspill_memory_limit\";\n     public static final String OPTIMIZE_DISTINCT_AGGREGATIONS = \"optimize_mixed_distinct_aggregations\";\n     public static final String LEGACY_ROW_FIELD_ORDINAL_ACCESS = \"legacy_row_field_ordinal_access\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc0MDcxMw==", "url": "https://github.com/prestodb/presto/pull/14836#discussion_r456740713", "bodyText": "i++", "author": "highker", "createdAt": "2020-07-18T03:03:57Z", "path": "presto-main/src/test/java/com/facebook/presto/operator/TestOrderByOperator.java", "diffHunk": "@@ -41,44 +43,91 @@\n import static com.facebook.presto.common.type.DoubleType.DOUBLE;\n import static com.facebook.presto.common.type.VarcharType.VARCHAR;\n import static com.facebook.presto.operator.OperatorAssertion.assertOperatorEquals;\n+import static com.facebook.presto.operator.OperatorAssertion.toMaterializedResult;\n import static com.facebook.presto.operator.OperatorAssertion.toPages;\n import static com.facebook.presto.testing.MaterializedResult.resultBuilder;\n import static com.facebook.presto.testing.TestingTaskContext.createTaskContext;\n+import static io.airlift.units.DataSize.succinctBytes;\n+import static java.lang.String.format;\n import static java.util.concurrent.Executors.newCachedThreadPool;\n import static java.util.concurrent.Executors.newScheduledThreadPool;\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.assertTrue;\n \n @Test(singleThreaded = true)\n public class TestOrderByOperator\n {\n     private ExecutorService executor;\n     private ScheduledExecutorService scheduledExecutor;\n-    private DriverContext driverContext;\n+    private DummySpillerFactory spillerFactory;\n \n     @DataProvider\n     public static Object[][] spillEnabled()\n     {\n-        return new Object[][] {{false}, {true}};\n+        return new Object[][] {\n+                {false, false, 0},\n+                {true, false, 8},\n+                {true, true, 8},\n+                {true, false, 0},\n+                {true, true, 0}};\n     }\n \n     @BeforeMethod\n     public void setUp()\n     {\n         executor = newCachedThreadPool(daemonThreadsNamed(\"test-executor-%s\"));\n         scheduledExecutor = newScheduledThreadPool(2, daemonThreadsNamed(\"test-scheduledExecutor-%s\"));\n-        driverContext = createTaskContext(executor, scheduledExecutor, TEST_SESSION)\n-                .addPipelineContext(0, true, true, false)\n-                .addDriverContext();\n+        spillerFactory = new DummySpillerFactory();\n     }\n \n     @AfterMethod\n     public void tearDown()\n     {\n         executor.shutdownNow();\n         scheduledExecutor.shutdownNow();\n+        spillerFactory = null;\n     }\n \n     @Test(dataProvider = \"spillEnabled\")\n-    public void testSingleFieldKey(boolean spillEnabled)\n+    public void testMultipleOutputPages(boolean spillEnabled, boolean revokeMemoryWhenAddingPages, long memoryLimit)\n+    {\n+        // make operator produce multiple pages during finish phase\n+        int numberOfRows = 80_000;\n+        List<Page> input = rowPagesBuilder(BIGINT, DOUBLE)\n+                .addSequencePage(numberOfRows, 0, 0)\n+                .build();\n+\n+        OrderByOperatorFactory operatorFactory = new OrderByOperatorFactory(\n+                0,\n+                new PlanNodeId(\"test\"),\n+                ImmutableList.of(BIGINT, DOUBLE),\n+                ImmutableList.of(1),\n+                10,\n+                ImmutableList.of(0),\n+                ImmutableList.of(DESC_NULLS_LAST),\n+                new PagesIndex.TestingFactory(false),\n+                spillEnabled,\n+                Optional.of(spillerFactory),\n+                new OrderingCompiler());\n+\n+        DriverContext driverContext = createDriverContext(memoryLimit);\n+        MaterializedResult.Builder expectedBuilder = resultBuilder(driverContext.getSession(), DOUBLE);\n+        for (int i = 0; i < numberOfRows; ++i) {", "originalCommit": "44e5153db0cb439a59bd483774022a418990fef8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "155efc31477748123999c3f5ad261314ffce30e5", "chunk": "diff --git a/presto-main/src/test/java/com/facebook/presto/operator/TestOrderByOperator.java b/presto-main/src/test/java/com/facebook/presto/operator/TestOrderByOperator.java\nindex 7c0c8ff4a3..447af457c0 100644\n--- a/presto-main/src/test/java/com/facebook/presto/operator/TestOrderByOperator.java\n+++ b/presto-main/src/test/java/com/facebook/presto/operator/TestOrderByOperator.java\n\n@@ -52,7 +52,6 @@ import static java.lang.String.format;\n import static java.util.concurrent.Executors.newCachedThreadPool;\n import static java.util.concurrent.Executors.newScheduledThreadPool;\n import static org.testng.Assert.assertEquals;\n-import static org.testng.Assert.assertTrue;\n \n @Test(singleThreaded = true)\n public class TestOrderByOperator\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc0MDcyOA==", "url": "https://github.com/prestodb/presto/pull/14836#discussion_r456740728", "bodyText": "assertEquals", "author": "highker", "createdAt": "2020-07-18T03:04:28Z", "path": "presto-main/src/test/java/com/facebook/presto/operator/TestOrderByOperator.java", "diffHunk": "@@ -41,44 +43,91 @@\n import static com.facebook.presto.common.type.DoubleType.DOUBLE;\n import static com.facebook.presto.common.type.VarcharType.VARCHAR;\n import static com.facebook.presto.operator.OperatorAssertion.assertOperatorEquals;\n+import static com.facebook.presto.operator.OperatorAssertion.toMaterializedResult;\n import static com.facebook.presto.operator.OperatorAssertion.toPages;\n import static com.facebook.presto.testing.MaterializedResult.resultBuilder;\n import static com.facebook.presto.testing.TestingTaskContext.createTaskContext;\n+import static io.airlift.units.DataSize.succinctBytes;\n+import static java.lang.String.format;\n import static java.util.concurrent.Executors.newCachedThreadPool;\n import static java.util.concurrent.Executors.newScheduledThreadPool;\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.assertTrue;\n \n @Test(singleThreaded = true)\n public class TestOrderByOperator\n {\n     private ExecutorService executor;\n     private ScheduledExecutorService scheduledExecutor;\n-    private DriverContext driverContext;\n+    private DummySpillerFactory spillerFactory;\n \n     @DataProvider\n     public static Object[][] spillEnabled()\n     {\n-        return new Object[][] {{false}, {true}};\n+        return new Object[][] {\n+                {false, false, 0},\n+                {true, false, 8},\n+                {true, true, 8},\n+                {true, false, 0},\n+                {true, true, 0}};\n     }\n \n     @BeforeMethod\n     public void setUp()\n     {\n         executor = newCachedThreadPool(daemonThreadsNamed(\"test-executor-%s\"));\n         scheduledExecutor = newScheduledThreadPool(2, daemonThreadsNamed(\"test-scheduledExecutor-%s\"));\n-        driverContext = createTaskContext(executor, scheduledExecutor, TEST_SESSION)\n-                .addPipelineContext(0, true, true, false)\n-                .addDriverContext();\n+        spillerFactory = new DummySpillerFactory();\n     }\n \n     @AfterMethod\n     public void tearDown()\n     {\n         executor.shutdownNow();\n         scheduledExecutor.shutdownNow();\n+        spillerFactory = null;\n     }\n \n     @Test(dataProvider = \"spillEnabled\")\n-    public void testSingleFieldKey(boolean spillEnabled)\n+    public void testMultipleOutputPages(boolean spillEnabled, boolean revokeMemoryWhenAddingPages, long memoryLimit)\n+    {\n+        // make operator produce multiple pages during finish phase\n+        int numberOfRows = 80_000;\n+        List<Page> input = rowPagesBuilder(BIGINT, DOUBLE)\n+                .addSequencePage(numberOfRows, 0, 0)\n+                .build();\n+\n+        OrderByOperatorFactory operatorFactory = new OrderByOperatorFactory(\n+                0,\n+                new PlanNodeId(\"test\"),\n+                ImmutableList.of(BIGINT, DOUBLE),\n+                ImmutableList.of(1),\n+                10,\n+                ImmutableList.of(0),\n+                ImmutableList.of(DESC_NULLS_LAST),\n+                new PagesIndex.TestingFactory(false),\n+                spillEnabled,\n+                Optional.of(spillerFactory),\n+                new OrderingCompiler());\n+\n+        DriverContext driverContext = createDriverContext(memoryLimit);\n+        MaterializedResult.Builder expectedBuilder = resultBuilder(driverContext.getSession(), DOUBLE);\n+        for (int i = 0; i < numberOfRows; ++i) {\n+            expectedBuilder.row((double) numberOfRows - i - 1);\n+        }\n+        MaterializedResult expected = expectedBuilder.build();\n+\n+        List<Page> pages = toPages(operatorFactory, driverContext, input, revokeMemoryWhenAddingPages);\n+        assertGreaterThan(pages.size(), 1, \"Expected more than one output page\");\n+\n+        MaterializedResult actual = toMaterializedResult(driverContext.getSession(), expected.getTypes(), pages);\n+        assertEquals(actual.getMaterializedRows(), expected.getMaterializedRows());\n+\n+        assertTrue(spillEnabled == (spillerFactory.getSpillsCount() > 0), format(\"Spill state mismatch. Expected spill: %s, spill count: %s\", spillEnabled, spillerFactory.getSpillsCount()));", "originalCommit": "44e5153db0cb439a59bd483774022a418990fef8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "155efc31477748123999c3f5ad261314ffce30e5", "chunk": "diff --git a/presto-main/src/test/java/com/facebook/presto/operator/TestOrderByOperator.java b/presto-main/src/test/java/com/facebook/presto/operator/TestOrderByOperator.java\nindex 7c0c8ff4a3..447af457c0 100644\n--- a/presto-main/src/test/java/com/facebook/presto/operator/TestOrderByOperator.java\n+++ b/presto-main/src/test/java/com/facebook/presto/operator/TestOrderByOperator.java\n\n@@ -52,7 +52,6 @@ import static java.lang.String.format;\n import static java.util.concurrent.Executors.newCachedThreadPool;\n import static java.util.concurrent.Executors.newScheduledThreadPool;\n import static org.testng.Assert.assertEquals;\n-import static org.testng.Assert.assertTrue;\n \n @Test(singleThreaded = true)\n public class TestOrderByOperator\n"}}, {"oid": "155efc31477748123999c3f5ad261314ffce30e5", "url": "https://github.com/prestodb/presto/commit/155efc31477748123999c3f5ad261314ffce30e5", "message": "Extract order by queries tests to separate class\nCherry-pick of https://github.com/prestosql/presto/commit/94b4d0a42f8c86b95b6c3664c5cd83b6eab7297a Co-authored-by: Karol Sobczak <karol.sobczak@karolsobczak.com>", "committedDate": "2020-07-22T21:32:42Z", "type": "forcePushed"}, {"oid": "11e84aeaead1aa8dff19b467deebe952cfdefdc5", "url": "https://github.com/prestodb/presto/commit/11e84aeaead1aa8dff19b467deebe952cfdefdc5", "message": "Extract order by queries tests to separate class\n\nCherry-pick of https://github.com/prestosql/presto/commit/94b4d0a42f8c86b95b6c3664c5cd83b6eab7297a\n\nCo-authored-by: Karol Sobczak <karol.sobczak@karolsobczak.com>", "committedDate": "2020-07-22T21:38:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTExNTM5NQ==", "url": "https://github.com/prestodb/presto/pull/14836#discussion_r459115395", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertEquals(spillEnabled, spillerFactory.getSpillsCount() > 0, format(\"Spill state mismatch. Expected spill: %s, spill count: %s\", spillEnabled, spillerFactory.getSpillsCount()))\n          \n          \n            \n                    ;\n          \n          \n            \n                    assertEquals(spillEnabled, spillerFactory.getSpillsCount() > 0, format(\"Spill state mismatch. Expected spill: %s, spill count: %s\", spillEnabled, spillerFactory.getSpillsCount()));", "author": "tdcmeehan", "createdAt": "2020-07-22T22:18:12Z", "path": "presto-main/src/test/java/com/facebook/presto/operator/TestOrderByOperator.java", "diffHunk": "@@ -41,44 +43,91 @@\n import static com.facebook.presto.common.type.DoubleType.DOUBLE;\n import static com.facebook.presto.common.type.VarcharType.VARCHAR;\n import static com.facebook.presto.operator.OperatorAssertion.assertOperatorEquals;\n+import static com.facebook.presto.operator.OperatorAssertion.toMaterializedResult;\n import static com.facebook.presto.operator.OperatorAssertion.toPages;\n import static com.facebook.presto.testing.MaterializedResult.resultBuilder;\n import static com.facebook.presto.testing.TestingTaskContext.createTaskContext;\n+import static io.airlift.units.DataSize.succinctBytes;\n+import static java.lang.String.format;\n import static java.util.concurrent.Executors.newCachedThreadPool;\n import static java.util.concurrent.Executors.newScheduledThreadPool;\n+import static org.testng.Assert.assertEquals;\n \n @Test(singleThreaded = true)\n public class TestOrderByOperator\n {\n     private ExecutorService executor;\n     private ScheduledExecutorService scheduledExecutor;\n-    private DriverContext driverContext;\n+    private DummySpillerFactory spillerFactory;\n \n     @DataProvider\n     public static Object[][] spillEnabled()\n     {\n-        return new Object[][] {{false}, {true}};\n+        return new Object[][] {\n+                {false, false, 0},\n+                {true, false, 8},\n+                {true, true, 8},\n+                {true, false, 0},\n+                {true, true, 0}};\n     }\n \n     @BeforeMethod\n     public void setUp()\n     {\n         executor = newCachedThreadPool(daemonThreadsNamed(\"test-executor-%s\"));\n         scheduledExecutor = newScheduledThreadPool(2, daemonThreadsNamed(\"test-scheduledExecutor-%s\"));\n-        driverContext = createTaskContext(executor, scheduledExecutor, TEST_SESSION)\n-                .addPipelineContext(0, true, true, false)\n-                .addDriverContext();\n+        spillerFactory = new DummySpillerFactory();\n     }\n \n     @AfterMethod\n     public void tearDown()\n     {\n         executor.shutdownNow();\n         scheduledExecutor.shutdownNow();\n+        spillerFactory = null;\n     }\n \n     @Test(dataProvider = \"spillEnabled\")\n-    public void testSingleFieldKey(boolean spillEnabled)\n+    public void testMultipleOutputPages(boolean spillEnabled, boolean revokeMemoryWhenAddingPages, long memoryLimit)\n+    {\n+        // make operator produce multiple pages during finish phase\n+        int numberOfRows = 80_000;\n+        List<Page> input = rowPagesBuilder(BIGINT, DOUBLE)\n+                .addSequencePage(numberOfRows, 0, 0)\n+                .build();\n+\n+        OrderByOperatorFactory operatorFactory = new OrderByOperatorFactory(\n+                0,\n+                new PlanNodeId(\"test\"),\n+                ImmutableList.of(BIGINT, DOUBLE),\n+                ImmutableList.of(1),\n+                10,\n+                ImmutableList.of(0),\n+                ImmutableList.of(DESC_NULLS_LAST),\n+                new PagesIndex.TestingFactory(false),\n+                spillEnabled,\n+                Optional.of(spillerFactory),\n+                new OrderingCompiler());\n+\n+        DriverContext driverContext = createDriverContext(memoryLimit);\n+        MaterializedResult.Builder expectedBuilder = resultBuilder(driverContext.getSession(), DOUBLE);\n+        for (int i = 0; i < numberOfRows; i++) {\n+            expectedBuilder.row((double) numberOfRows - i - 1);\n+        }\n+        MaterializedResult expected = expectedBuilder.build();\n+\n+        List<Page> pages = toPages(operatorFactory, driverContext, input, revokeMemoryWhenAddingPages);\n+        assertGreaterThan(pages.size(), 1, \"Expected more than one output page\");\n+\n+        MaterializedResult actual = toMaterializedResult(driverContext.getSession(), expected.getTypes(), pages);\n+        assertEquals(actual.getMaterializedRows(), expected.getMaterializedRows());\n+\n+        assertEquals(spillEnabled, spillerFactory.getSpillsCount() > 0, format(\"Spill state mismatch. Expected spill: %s, spill count: %s\", spillEnabled, spillerFactory.getSpillsCount()))\n+        ;", "originalCommit": "216455e336e1490d68346f58dc97dc0de8297acf", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d46f4827e3557cd9c391387d3d3f973ed465d646", "chunk": "diff --git a/presto-main/src/test/java/com/facebook/presto/operator/TestOrderByOperator.java b/presto-main/src/test/java/com/facebook/presto/operator/TestOrderByOperator.java\nindex 447af457c0..74cd44555d 100644\n--- a/presto-main/src/test/java/com/facebook/presto/operator/TestOrderByOperator.java\n+++ b/presto-main/src/test/java/com/facebook/presto/operator/TestOrderByOperator.java\n\n@@ -122,8 +122,10 @@ public class TestOrderByOperator\n         MaterializedResult actual = toMaterializedResult(driverContext.getSession(), expected.getTypes(), pages);\n         assertEquals(actual.getMaterializedRows(), expected.getMaterializedRows());\n \n-        assertEquals(spillEnabled, spillerFactory.getSpillsCount() > 0, format(\"Spill state mismatch. Expected spill: %s, spill count: %s\", spillEnabled, spillerFactory.getSpillsCount()))\n-        ;\n+        assertEquals(\n+                spillEnabled,\n+                spillerFactory.getSpillsCount() > 0,\n+                format(\"Spill state mismatch. Expected spill: %s, spill count: %s\", spillEnabled, spillerFactory.getSpillsCount()));\n     }\n \n     @Test(dataProvider = \"spillEnabled\")\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTExNjY3OQ==", "url": "https://github.com/prestodb/presto/pull/14836#discussion_r459116679", "bodyText": "Should this be squashed with Add Spill To Disk for ORDER BY?", "author": "tdcmeehan", "createdAt": "2020-07-22T22:21:08Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/OrderByOperator.java", "diffHunk": "@@ -380,5 +380,6 @@ public void close()\n     {\n         pageIndex.clear();\n         sortedPages = null;\n+        spiller.ifPresent(Spiller::close);", "originalCommit": "3fff9b1e02e40327099ca1d4e6882870993218a7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYyNTMwNQ==", "url": "https://github.com/prestodb/presto/pull/14836#discussion_r459625305", "bodyText": "I added this as a separate commit since it was a bug fixed in a later commit. However, that later commit also fixes the equivalent bug for window spilling. So, to make it explicit I just created a new commit. Can either squash this or leave it, no opinion on this.", "author": "sachdevs", "createdAt": "2020-07-23T17:51:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTExNjY3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "f2e6a83f4829388609da69997a97065748f01819", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/operator/OrderByOperator.java b/presto-main/src/main/java/com/facebook/presto/operator/OrderByOperator.java\nindex c6419288f7..550893717f 100644\n--- a/presto-main/src/main/java/com/facebook/presto/operator/OrderByOperator.java\n+++ b/presto-main/src/main/java/com/facebook/presto/operator/OrderByOperator.java\n\n@@ -253,133 +169,53 @@ public class OrderByOperator\n     {\n         checkState(state == State.NEEDS_INPUT, \"Operator is already finishing\");\n         requireNonNull(page, \"page is null\");\n-        checkSuccess(spillInProgress, \"spilling failed\");\n \n         pageIndex.addPage(page);\n-        updateMemoryUsage();\n+\n+        if (!localUserMemoryContext.trySetBytes(pageIndex.getEstimatedSize().toBytes())) {\n+            pageIndex.compact();\n+            localUserMemoryContext.setBytes(pageIndex.getEstimatedSize().toBytes());\n+        }\n     }\n \n     @Override\n     public Page getOutput()\n     {\n-        checkSuccess(spillInProgress, \"spilling failed\");\n         if (state != State.HAS_OUTPUT) {\n             return null;\n         }\n \n-        verify(sortedPages != null, \"sortedPages is null\");\n-        if (!sortedPages.hasNext()) {\n+        if (currentPosition >= pageIndex.getPositionCount()) {\n             state = State.FINISHED;\n             return null;\n         }\n \n-        Optional<Page> next = sortedPages.next();\n-        if (!next.isPresent()) {\n-            return null;\n-        }\n-        Page nextPage = next.get();\n-        Block[] blocks = new Block[outputChannels.length];\n-        for (int i = 0; i < outputChannels.length; i++) {\n-            blocks[i] = nextPage.getBlock(outputChannels[i]);\n-        }\n-        return new Page(nextPage.getPositionCount(), blocks);\n-    }\n-\n-    @Override\n-    public ListenableFuture<?> startMemoryRevoke()\n-    {\n-        verify(state == State.NEEDS_INPUT || revocableMemoryContext.getBytes() == 0, \"Cannot spill in state: %s\", state);\n-        return spillToDisk();\n-    }\n+        // iterate through the positions sequentially until we have one full page\n+        pageBuilder.reset();\n+        currentPosition = pageIndex.buildPage(currentPosition, outputChannels, pageBuilder);\n \n-    private ListenableFuture<?> spillToDisk()\n-    {\n-        checkSuccess(spillInProgress, \"spilling failed\");\n-\n-        if (revocableMemoryContext.getBytes() == 0) {\n-            verify(pageIndex.getPositionCount() == 0 || state == State.HAS_OUTPUT);\n-            finishMemoryRevoke = () -> {};\n-            return immediateFuture(null);\n-        }\n-\n-        // TODO try pageIndex.compact(); before spilling, as in com.facebook.presto.operator.HashBuilderOperator.startMemoryRevoke\n-\n-        if (!spiller.isPresent()) {\n-            spiller = Optional.of(spillerFactory.get().create(\n-                    sourceTypes,\n-                    operatorContext.getSpillContext(),\n-                    operatorContext.newAggregateSystemMemoryContext()));\n+        // output the page if we have any data\n+        if (pageBuilder.isEmpty()) {\n+            state = State.FINISHED;\n+            return null;\n         }\n \n-        pageIndex.sort(sortChannels, sortOrder);\n-        spillInProgress = spiller.get().spill(pageIndex.getSortedPages());\n-        finishMemoryRevoke = () -> {\n-            pageIndex.clear();\n-            updateMemoryUsage();\n-        };\n-\n-        return spillInProgress;\n+        Page page = pageBuilder.build();\n+        return page;\n     }\n \n     @Override\n-    public void finishMemoryRevoke()\n-    {\n-        finishMemoryRevoke.run();\n-        finishMemoryRevoke = () -> {};\n-    }\n-\n-    private List<WorkProcessor<Page>> getSpilledPages()\n-    {\n-        if (!spiller.isPresent()) {\n-            return ImmutableList.of();\n-        }\n-\n-        return spiller.get().getSpills().stream()\n-                .map(WorkProcessor::fromIterator)\n-                .collect(toImmutableList());\n-    }\n-\n-    private WorkProcessor<Page> mergeSpilledAndMemoryPages(List<WorkProcessor<Page>> spilledPages, Iterator<Page> sortedPagesIndex)\n+    public void close()\n     {\n-        List<WorkProcessor<Page>> sortedStreams = ImmutableList.<WorkProcessor<Page>>builder()\n-                .addAll(spilledPages)\n-                .add(WorkProcessor.fromIterator(sortedPagesIndex))\n-                .build();\n-\n-        return mergeSortedPages(\n-                sortedStreams,\n-                orderingCompiler.compilePageWithPositionComparator(sourceTypes, sortChannels, sortOrder),\n-                sourceTypes,\n-                operatorContext.aggregateUserMemoryContext(),\n-                operatorContext.getDriverContext().getYieldSignal());\n+        pageIndex.clear();\n     }\n \n-    private void updateMemoryUsage()\n+    private static List<Type> toTypes(List<? extends Type> sourceTypes, List<Integer> outputChannels)\n     {\n-        if (spillEnabled && state == State.NEEDS_INPUT) {\n-            if (pageIndex.getPositionCount() == 0) {\n-                localUserMemoryContext.setBytes(pageIndex.getEstimatedSize().toBytes());\n-                revocableMemoryContext.setBytes(0L);\n-            }\n-            else {\n-                localUserMemoryContext.setBytes(0);\n-                revocableMemoryContext.setBytes(pageIndex.getEstimatedSize().toBytes());\n-            }\n-        }\n-        else {\n-            revocableMemoryContext.setBytes(0);\n-            if (!localUserMemoryContext.trySetBytes(pageIndex.getEstimatedSize().toBytes())) {\n-                pageIndex.compact();\n-                localUserMemoryContext.setBytes(pageIndex.getEstimatedSize().toBytes());\n-            }\n+        ImmutableList.Builder<Type> types = ImmutableList.builder();\n+        for (int channel : outputChannels) {\n+            types.add(sourceTypes.get(channel));\n         }\n-    }\n-\n-    @Override\n-    public void close()\n-    {\n-        pageIndex.clear();\n-        sortedPages = null;\n-        spiller.ifPresent(Spiller::close);\n+        return types.build();\n     }\n }\n"}}, {"oid": "d46f4827e3557cd9c391387d3d3f973ed465d646", "url": "https://github.com/prestodb/presto/commit/d46f4827e3557cd9c391387d3d3f973ed465d646", "message": "Close spiller on Operator#close for ORDER BY spilling", "committedDate": "2020-07-23T18:16:17Z", "type": "forcePushed"}, {"oid": "f2e6a83f4829388609da69997a97065748f01819", "url": "https://github.com/prestodb/presto/commit/f2e6a83f4829388609da69997a97065748f01819", "message": "Revoke memory after initial output page has been produced in tests\n\nCherry-pick of https://github.com/prestosql/presto/commit/0a9b8047f36fd22fd33193d1a9e3fea4e88efb4b\n\nCo-authored-by: Karol Sobczak <karol.sobczak@karolsobczak.com>", "committedDate": "2020-07-23T20:24:47Z", "type": "commit"}, {"oid": "80890daea7f0528c99bc7e90bc31c0708eaa449d", "url": "https://github.com/prestodb/presto/commit/80890daea7f0528c99bc7e90bc31c0708eaa449d", "message": "Allow memory revoke only during operator finish phase\n\nCherry-pick of https://github.com/prestosql/presto/commit/5fef5aa58626286d2952a2008ee8598232cd954c\n\nCo-authored-by: Karol Sobczak <karol.sobczak@karolsobczak.com>", "committedDate": "2020-07-23T20:24:47Z", "type": "commit"}, {"oid": "df4ae85b0dd0118713b7bf768efc26a5f2c58e28", "url": "https://github.com/prestodb/presto/commit/df4ae85b0dd0118713b7bf768efc26a5f2c58e28", "message": "Produce more than single page in testHashAggregation\n\nCherry-pick of https://github.com/prestosql/presto/commit/e69b66863126e8a82c62f5538d12a032a66dd662\n\nCo-authored-by: Karol Sobczak <karol.sobczak@karolsobczak.com>", "committedDate": "2020-07-23T20:24:47Z", "type": "commit"}, {"oid": "9aa39fb4893a71c7ac2f2070e987d8f389918ee2", "url": "https://github.com/prestodb/presto/commit/9aa39fb4893a71c7ac2f2070e987d8f389918ee2", "message": "Extract DummySpillerFactory from TestHashAggregationOperator\n\nCherry-pick of https://github.com/prestosql/presto/commit/f01067ba9dda7f4a1bbcabcaf901b3c008969207\n\nCo-authored-by: Atri Sharma <atri@linux.com>", "committedDate": "2020-07-23T20:24:47Z", "type": "commit"}, {"oid": "3af951b6a96b219164f5b67aac1366d7615cb83e", "url": "https://github.com/prestodb/presto/commit/3af951b6a96b219164f5b67aac1366d7615cb83e", "message": "Use WorkProcessor in OrderByOperator\n\nCherry-pick of https://github.com/prestosql/presto/commit/e7d8dd5e7035520d1dbb7990803b51383cc11aae\n\nCo-authored-by: Piotr Findeisen <piotr.findeisen@gmail.com>", "committedDate": "2020-07-23T20:24:47Z", "type": "commit"}, {"oid": "e24359d19908df10d879164f4f64a3ee1e4a50ab", "url": "https://github.com/prestodb/presto/commit/e24359d19908df10d879164f4f64a3ee1e4a50ab", "message": "Add Spill To Disk for ORDER BY\nORDER BY currently will error out if the data being processed exceeds\nquery memory limit. This commit introduces paging from disk and ensures\nthat ORDER BY is limited only by the amount of disk present.\n\nCherry-pick of https://github.com/prestosql/presto/commit/24868b3481a974f3e068197d9c432788de9ddacb\n\nCo-authored-by: Piotr Findeisen <piotr.findeisen@gmail.com>", "committedDate": "2020-07-23T20:24:47Z", "type": "commit"}, {"oid": "52adeba9d527dce64ceeabeac3e4ac1dc5c642d7", "url": "https://github.com/prestodb/presto/commit/52adeba9d527dce64ceeabeac3e4ac1dc5c642d7", "message": "Use OrderingCompiler in OrderBy spilling\n\nCherry-pick of https://github.com/prestosql/presto/commit/472fb5ad36cb0e0fea0a2cf5f90e598b28ce01fe\n\nCo-authored-by: Karol Sobczak <karol.sobczak@karolsobczak.com>", "committedDate": "2020-07-23T20:24:47Z", "type": "commit"}, {"oid": "28962d5b23751ee4289698876c01c333fb5255e4", "url": "https://github.com/prestodb/presto/commit/28962d5b23751ee4289698876c01c333fb5255e4", "message": "Convert revocable memory to user memory on OrderBy finish\n\nCherry-pick of https://github.com/prestosql/presto/commit/d35e5fb834ef93ccadea5bf76739ab9e814e5eac\n\nCo-authored-by: Karol Sobczak <karol.sobczak@karolsobczak.com>", "committedDate": "2020-07-23T20:24:48Z", "type": "commit"}, {"oid": "1dc65c617652f0fd9bd2cd101fbeafd4d63a097b", "url": "https://github.com/prestodb/presto/commit/1dc65c617652f0fd9bd2cd101fbeafd4d63a097b", "message": "Extract order by queries tests to separate class\n\nCherry-pick of https://github.com/prestosql/presto/commit/94b4d0a42f8c86b95b6c3664c5cd83b6eab7297a\n\nCo-authored-by: Karol Sobczak <karol.sobczak@karolsobczak.com>", "committedDate": "2020-07-23T20:24:48Z", "type": "commit"}, {"oid": "13db5e5b137e06d6bee7081b8bd760b02040381e", "url": "https://github.com/prestodb/presto/commit/13db5e5b137e06d6bee7081b8bd760b02040381e", "message": "Close spiller on Operator#close for ORDER BY spilling", "committedDate": "2020-07-23T20:24:48Z", "type": "commit"}, {"oid": "13db5e5b137e06d6bee7081b8bd760b02040381e", "url": "https://github.com/prestodb/presto/commit/13db5e5b137e06d6bee7081b8bd760b02040381e", "message": "Close spiller on Operator#close for ORDER BY spilling", "committedDate": "2020-07-23T20:24:48Z", "type": "forcePushed"}]}