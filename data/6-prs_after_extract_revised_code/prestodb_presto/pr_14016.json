{"pr_number": 14016, "pr_title": "Add task memory related session properties ", "pr_createdAt": "2020-01-27T15:00:30Z", "pr_url": "https://github.com/prestodb/presto/pull/14016", "timeline": [{"oid": "fa0526cc86c1203038ae8f03ee47150a5bc92c8e", "url": "https://github.com/prestodb/presto/commit/fa0526cc86c1203038ae8f03ee47150a5bc92c8e", "message": "Add query_max_task_memory and query_max_total_task_memory session properties", "committedDate": "2020-01-27T16:18:34Z", "type": "forcePushed"}, {"oid": "67c3e9ae498c26c487fa1315ec8708b2f648fde0", "url": "https://github.com/prestodb/presto/commit/67c3e9ae498c26c487fa1315ec8708b2f648fde0", "message": "Add query_max_task_memory and query_max_total_task_memory session properties", "committedDate": "2020-01-27T20:04:42Z", "type": "forcePushed"}, {"oid": "85c62da18851aab989dfc5b3687435fc3d734a4a", "url": "https://github.com/prestodb/presto/commit/85c62da18851aab989dfc5b3687435fc3d734a4a", "message": "Add task memory related session properties\n\nAdd query_max_task_memory and query_max_total_task_memory session properties", "committedDate": "2020-01-27T20:33:58Z", "type": "forcePushed"}, {"oid": "9b4dc187f8b8d08ff26da74e45ef10619ab2516a", "url": "https://github.com/prestodb/presto/commit/9b4dc187f8b8d08ff26da74e45ef10619ab2516a", "message": "Add task memory related session properties\n\nAdd query_max_task_memory and query_max_total_task_memory session\nproperties", "committedDate": "2020-01-27T20:38:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg0ODU4Ng==", "url": "https://github.com/prestodb/presto/pull/14016#discussion_r371848586", "bodyText": "static import both", "author": "arhimondr", "createdAt": "2020-01-28T14:50:58Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/SqlTaskManager.java", "diffHunk": "@@ -377,6 +378,12 @@ public TaskInfo updateTask(\n             // TODO: This should have been done when the QueryContext was created. However, the session isn't available at that point.\n             queryContexts.getUnchecked(taskId.getQueryId()).setResourceOvercommit();\n         }\n+        else {\n+            queryContexts.getUnchecked(\n+                    taskId.getQueryId()).setMemoryLimits(\n+                    SystemSessionProperties.getQueryMaxTaskMemory(session),", "originalCommit": "9b4dc187f8b8d08ff26da74e45ef10619ab2516a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5e16e152821f037c23c7159ae640ed410d4913da", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/execution/SqlTaskManager.java b/presto-main/src/main/java/com/facebook/presto/execution/SqlTaskManager.java\nindex 05c275aafd..cc823a7f74 100644\n--- a/presto-main/src/main/java/com/facebook/presto/execution/SqlTaskManager.java\n+++ b/presto-main/src/main/java/com/facebook/presto/execution/SqlTaskManager.java\n\n@@ -381,8 +382,8 @@ public class SqlTaskManager\n         else {\n             queryContexts.getUnchecked(\n                     taskId.getQueryId()).setMemoryLimits(\n-                    SystemSessionProperties.getQueryMaxTaskMemory(session),\n-                    SystemSessionProperties.getQueryMaxTotalTaskMemory(session));\n+                    getQueryMaxTaskMemory(session),\n+                    getQueryMaxTotalTaskMemory(session));\n         }\n \n         SqlTask sqlTask = tasks.getUnchecked(taskId);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg0OTU1Mg==", "url": "https://github.com/prestodb/presto/pull/14016#discussion_r371849552", "bodyText": "Ideally the memory limits should be set when the QueryContext is created. Fundamentally it is never created when the session is not available. Setting it here is confusing, and potentially error prone, as the memory limits could be lost in a hypothetical situation when updateTask is never called.\nIt feels like the entire SqlTaskManager has to be refactored. The TaskContext / QueryContext should be aware of the session at the moment of creation.\nAdditionaly the ResourceOvercommit feature should probably be removed (CC: @nezihyigitbasi ?)", "author": "arhimondr", "createdAt": "2020-01-28T14:52:26Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/SqlTaskManager.java", "diffHunk": "@@ -377,6 +378,12 @@ public TaskInfo updateTask(\n             // TODO: This should have been done when the QueryContext was created. However, the session isn't available at that point.\n             queryContexts.getUnchecked(taskId.getQueryId()).setResourceOvercommit();\n         }\n+        else {\n+            queryContexts.getUnchecked(\n+                    taskId.getQueryId()).setMemoryLimits(", "originalCommit": "9b4dc187f8b8d08ff26da74e45ef10619ab2516a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk1NDUzMw==", "url": "https://github.com/prestodb/presto/pull/14016#discussion_r371954533", "bodyText": "Yeah I noticed that pain point. It took a while to arrive at updateTask and see that I was not the first person to have this issue.\nI didn't want to change it because I assumed the design is such that it can be retrieved before updateTask is called for a reason. All you need is a taskId.", "author": "aweisberg", "createdAt": "2020-01-28T17:40:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg0OTU1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "5e16e152821f037c23c7159ae640ed410d4913da", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/execution/SqlTaskManager.java b/presto-main/src/main/java/com/facebook/presto/execution/SqlTaskManager.java\nindex 05c275aafd..cc823a7f74 100644\n--- a/presto-main/src/main/java/com/facebook/presto/execution/SqlTaskManager.java\n+++ b/presto-main/src/main/java/com/facebook/presto/execution/SqlTaskManager.java\n\n@@ -381,8 +382,8 @@ public class SqlTaskManager\n         else {\n             queryContexts.getUnchecked(\n                     taskId.getQueryId()).setMemoryLimits(\n-                    SystemSessionProperties.getQueryMaxTaskMemory(session),\n-                    SystemSessionProperties.getQueryMaxTotalTaskMemory(session));\n+                    getQueryMaxTaskMemory(session),\n+                    getQueryMaxTotalTaskMemory(session));\n         }\n \n         SqlTask sqlTask = tasks.getUnchecked(taskId);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg1ODkwNw==", "url": "https://github.com/prestodb/presto/pull/14016#discussion_r371858907", "bodyText": "wrap new QueryManagerConfig().\nWe prefer either one of the style\ndoSomethign(parameter1, parameter2)\n\nor\ndoSomethign(\n  parameter1, \n  parameter2)\n\nWe are trying to avoid the\ndoSomethign(parameter1, \n  parameter2)\n\nstyle across the codebase", "author": "arhimondr", "createdAt": "2020-01-28T15:06:51Z", "path": "presto-main/src/main/java/com/facebook/presto/testing/LocalQueryRunner.java", "diffHunk": "@@ -334,7 +335,11 @@ private LocalQueryRunner(Session defaultSession, FeaturesConfig featuresConfig,\n                 featuresConfig,\n                 typeRegistry,\n                 blockEncodingManager,\n-                new SessionPropertyManager(new SystemSessionProperties(new QueryManagerConfig(), new TaskManagerConfig(), new MemoryManagerConfig(), featuresConfig)),\n+                new SessionPropertyManager(new SystemSessionProperties(new QueryManagerConfig(),", "originalCommit": "9b4dc187f8b8d08ff26da74e45ef10619ab2516a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5b9d5deb4a6070936aaf2bd1e11a0e739ef67222", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/testing/LocalQueryRunner.java b/presto-main/src/main/java/com/facebook/presto/testing/LocalQueryRunner.java\nindex 98d59eaa31..63fb9af98e 100644\n--- a/presto-main/src/main/java/com/facebook/presto/testing/LocalQueryRunner.java\n+++ b/presto-main/src/main/java/com/facebook/presto/testing/LocalQueryRunner.java\n\n@@ -335,11 +335,13 @@ public class LocalQueryRunner\n                 featuresConfig,\n                 typeRegistry,\n                 blockEncodingManager,\n-                new SessionPropertyManager(new SystemSessionProperties(new QueryManagerConfig(),\n-                                                                       new TaskManagerConfig(),\n-                                                                       new MemoryManagerConfig(),\n-                                                                       featuresConfig,\n-                                                                       new NodeMemoryConfig())),\n+                new SessionPropertyManager(\n+                        new SystemSessionProperties(\n+                                new QueryManagerConfig(),\n+                                new TaskManagerConfig(),\n+                                new MemoryManagerConfig(),\n+                                featuresConfig,\n+                                new NodeMemoryConfig())),\n                 new SchemaPropertyManager(),\n                 new TablePropertyManager(),\n                 new ColumnPropertyManager(),\n"}}, {"oid": "5e16e152821f037c23c7159ae640ed410d4913da", "url": "https://github.com/prestodb/presto/commit/5e16e152821f037c23c7159ae640ed410d4913da", "message": "Add task memory related session properties\n\nAdd query_max_task_memory and query_max_total_task_memory session\nproperties", "committedDate": "2020-01-28T17:21:15Z", "type": "forcePushed"}, {"oid": "5b9d5deb4a6070936aaf2bd1e11a0e739ef67222", "url": "https://github.com/prestodb/presto/commit/5b9d5deb4a6070936aaf2bd1e11a0e739ef67222", "message": "Add task memory related session properties\n\nAdd query_max_task_memory and query_max_total_task_memory session\nproperties", "committedDate": "2020-01-28T17:43:06Z", "type": "forcePushed"}, {"oid": "49288801db526dddc4b3f4d39b5a53c15018498a", "url": "https://github.com/prestodb/presto/commit/49288801db526dddc4b3f4d39b5a53c15018498a", "message": "Add task memory related session properties\n\nAdd query_max_task_memory and query_max_total_task_memory session\nproperties", "committedDate": "2020-01-28T23:14:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjEyNTE2Mw==", "url": "https://github.com/prestodb/presto/pull/14016#discussion_r372125163", "bodyText": "do we want to mention task here? or just\nMaximum amount of total (user + system) memory a query can use", "author": "swapsmagic", "createdAt": "2020-01-28T23:57:09Z", "path": "presto-main/src/main/java/com/facebook/presto/SystemSessionProperties.java", "diffHunk": "@@ -352,6 +365,15 @@ public SystemSessionProperties(\n                         true,\n                         value -> DataSize.valueOf((String) value),\n                         DataSize::toString),\n+                new PropertyMetadata<>(\n+                        QUERY_MAX_TOTAL_MEMORY_PER_NODE,\n+                        \"Maximum amount of total (user + system) task memory a query can use\",", "originalCommit": "49288801db526dddc4b3f4d39b5a53c15018498a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU3NDkwMw==", "url": "https://github.com/prestodb/presto/pull/14016#discussion_r372574903", "bodyText": "Yes otherwise the description makes it seem like this a distributed memory setting.", "author": "aweisberg", "createdAt": "2020-01-29T19:07:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjEyNTE2Mw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "dc97d4d86b57d7e681a05a2fc1702a79bdaa6b12", "url": "https://github.com/prestodb/presto/commit/dc97d4d86b57d7e681a05a2fc1702a79bdaa6b12", "message": "Add task memory related session properties\n\nAdd query_max_task_memory and query_max_total_task_memory session\nproperties", "committedDate": "2020-01-29T21:28:01Z", "type": "forcePushed"}, {"oid": "cd50167f321f1e89f1c928e4a14f235ec36d038b", "url": "https://github.com/prestodb/presto/commit/cd50167f321f1e89f1c928e4a14f235ec36d038b", "message": "Add task memory related session properties\n\nAdd query_max_task_memory and query_max_total_task_memory session\nproperties", "committedDate": "2020-01-29T21:30:45Z", "type": "commit"}, {"oid": "cd50167f321f1e89f1c928e4a14f235ec36d038b", "url": "https://github.com/prestodb/presto/commit/cd50167f321f1e89f1c928e4a14f235ec36d038b", "message": "Add task memory related session properties\n\nAdd query_max_task_memory and query_max_total_task_memory session\nproperties", "committedDate": "2020-01-29T21:30:45Z", "type": "forcePushed"}]}