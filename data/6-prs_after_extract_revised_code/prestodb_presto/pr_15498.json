{"pr_number": 15498, "pr_title": "Handle nulls properly in flatmap reader", "pr_createdAt": "2020-12-03T21:50:00Z", "pr_url": "https://github.com/prestodb/presto/pull/15498", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcyMDQ2NQ==", "url": "https://github.com/prestodb/presto/pull/15498#discussion_r535720465", "bodyText": "Just for my understanding, I believe this is the real bug. But inMapVectors[i] is already null as it was just allocated in the top so this code is no-op,so this entire code is removed.", "author": "arunthirupathi", "createdAt": "2020-12-03T23:25:30Z", "path": "presto-orc/src/main/java/com/facebook/presto/orc/reader/MapFlatBatchStreamReader.java", "diffHunk": "@@ -158,13 +158,7 @@ public Block readBlock()\n         else {\n             nullVector = new boolean[nextBatchSize];\n             int nullValues = presentStream.getUnsetBits(nextBatchSize, nullVector);\n-            if (nullValues == nextBatchSize) {\n-                for (int i = 0; i < inMapStreams.size(); i++) {\n-                    inMapVectors[i] = null;\n-                    totalMapEntries += nextBatchSize;", "originalCommit": "7503d3c63001d2184e81055d742ec7ceeb4d155f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc2OTQ4Mg==", "url": "https://github.com/prestodb/presto/pull/15498#discussion_r535769482", "bodyText": "exactly", "author": "zzhao0", "createdAt": "2020-12-04T01:31:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcyMDQ2NQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTczMDg4MA==", "url": "https://github.com/prestodb/presto/pull/15498#discussion_r535730880", "bodyText": "typo: everyflat -> every flat", "author": "mbasmanova", "createdAt": "2020-12-03T23:49:39Z", "path": "presto-orc/src/test/java/com/facebook/presto/orc/TestMapFlatBatchStreamReader.java", "diffHunk": "@@ -314,6 +315,17 @@ public void testWithAllNulls()\n                 ExpectedValuesBuilder.get(Function.identity()).setNullRowsFrequency(ALL));\n     }\n \n+    @Test\n+    public void testWithAllNullsExceptFirst()\n+            throws Exception\n+    {\n+        // A test case where everyflat map is null except the first one", "originalCommit": "7503d3c63001d2184e81055d742ec7ceeb4d155f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8ecd890135216a50ac738f1468421d7ebdc325c3", "chunk": "diff --git a/presto-orc/src/test/java/com/facebook/presto/orc/TestMapFlatBatchStreamReader.java b/presto-orc/src/test/java/com/facebook/presto/orc/TestMapFlatBatchStreamReader.java\nindex b75dde35b7..268272d568 100644\n--- a/presto-orc/src/test/java/com/facebook/presto/orc/TestMapFlatBatchStreamReader.java\n+++ b/presto-orc/src/test/java/com/facebook/presto/orc/TestMapFlatBatchStreamReader.java\n\n@@ -319,7 +319,7 @@ public class TestMapFlatBatchStreamReader\n     public void testWithAllNullsExceptFirst()\n             throws Exception\n     {\n-        // A test case where everyflat map is null except the first one\n+        // A test case where every flat map is null except the first one\n         runTest(\n                 \"test_flat_map/flat_map_all_null_maps_except_first.dwrf\",\n                 IntegerType.INTEGER,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTczMTA1Mg==", "url": "https://github.com/prestodb/presto/pull/15498#discussion_r535731052", "bodyText": "typo: everyflat -> every flat", "author": "mbasmanova", "createdAt": "2020-12-03T23:50:04Z", "path": "presto-orc/src/test/java/com/facebook/presto/orc/TestMapFlatSelectiveStreamReader.java", "diffHunk": "@@ -313,6 +314,17 @@ public void testWithAllNulls()\n                 ExpectedValuesBuilder.get(Function.identity()).setNullRowsFrequency(ALL));\n     }\n \n+    @Test\n+    public void testWithAllNullsExceptFirst()\n+            throws Exception\n+    {\n+        // A test case where everyflat map is null except the first one", "originalCommit": "7503d3c63001d2184e81055d742ec7ceeb4d155f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8ecd890135216a50ac738f1468421d7ebdc325c3", "chunk": "diff --git a/presto-orc/src/test/java/com/facebook/presto/orc/TestMapFlatSelectiveStreamReader.java b/presto-orc/src/test/java/com/facebook/presto/orc/TestMapFlatSelectiveStreamReader.java\nindex 23c6ee5b4d..30693b3ff0 100644\n--- a/presto-orc/src/test/java/com/facebook/presto/orc/TestMapFlatSelectiveStreamReader.java\n+++ b/presto-orc/src/test/java/com/facebook/presto/orc/TestMapFlatSelectiveStreamReader.java\n\n@@ -318,7 +318,7 @@ public class TestMapFlatSelectiveStreamReader\n     public void testWithAllNullsExceptFirst()\n             throws Exception\n     {\n-        // A test case where everyflat map is null except the first one\n+        // A test case where every flat map is null except the first one\n         runTest(\n                 \"test_flat_map/flat_map_all_null_maps_except_first.dwrf\",\n                 IntegerType.INTEGER,\n"}}, {"oid": "8ecd890135216a50ac738f1468421d7ebdc325c3", "url": "https://github.com/prestodb/presto/commit/8ecd890135216a50ac738f1468421d7ebdc325c3", "message": "handle nulls properly in flatmap reader", "committedDate": "2020-12-04T03:52:58Z", "type": "commit"}, {"oid": "8ecd890135216a50ac738f1468421d7ebdc325c3", "url": "https://github.com/prestodb/presto/commit/8ecd890135216a50ac738f1468421d7ebdc325c3", "message": "handle nulls properly in flatmap reader", "committedDate": "2020-12-04T03:52:58Z", "type": "forcePushed"}]}