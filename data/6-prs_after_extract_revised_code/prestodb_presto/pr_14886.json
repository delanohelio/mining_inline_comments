{"pr_number": 14886, "pr_title": "Unify grouped execution properties", "pr_createdAt": "2020-07-24T17:55:11Z", "pr_url": "https://github.com/prestodb/presto/pull/14886", "timeline": [{"oid": "7d3eaa50f02e0f6fa6328f84086bda35fef7164a", "url": "https://github.com/prestodb/presto/commit/7d3eaa50f02e0f6fa6328f84086bda35fef7164a", "message": "Unify grouped execution properties\n\nAdd grouped-execution-enabled property to replace\ngrouped-execution-for-aggregation-enabled,\ngrouped-execution-for-join-enabled,\ngrouped-execution-for-eligible-tablescans-enabled.  These other\nproperties will be removed in a future release.", "committedDate": "2020-07-27T15:43:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk5NDUyNg==", "url": "https://github.com/prestodb/presto/pull/14886#discussion_r460994526", "bodyText": "Personally I would prefer to disable the grouped execution for local query runner explicitly (or at least explicitly check for the forceSinceNode flag).", "author": "arhimondr", "createdAt": "2020-07-27T15:56:04Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/PlanFragmenter.java", "diffHunk": "@@ -248,7 +248,7 @@ private SubPlan analyzeGroupedExecution(Session session, SubPlan subPlan, boolea\n     {\n         PlanFragment fragment = subPlan.getFragment();\n         GroupedExecutionProperties properties = fragment.getRoot().accept(new GroupedExecutionTagger(session, metadata, nodePartitioningManager), null);\n-        if (properties.isSubTreeUseful()) {\n+        if (properties.isSubTreeUseful() && !(fragment.getPartitioning().getConnectorHandle() instanceof SystemPartitioningHandle)) {", "originalCommit": "7d3eaa50f02e0f6fa6328f84086bda35fef7164a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAwNTI4Mw==", "url": "https://github.com/prestodb/presto/pull/14886#discussion_r461005283", "bodyText": "updated to check the forceSingleNode flag", "author": "rschlussel", "createdAt": "2020-07-27T16:12:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk5NDUyNg=="}], "type": "inlineReview", "revised_code": {"commit": "5e9a2fd7f039fbbd732feacbaedbcabe785d41dd", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/sql/planner/PlanFragmenter.java b/presto-main/src/main/java/com/facebook/presto/sql/planner/PlanFragmenter.java\nindex 3b86c53f18..a0a965f40b 100644\n--- a/presto-main/src/main/java/com/facebook/presto/sql/planner/PlanFragmenter.java\n+++ b/presto-main/src/main/java/com/facebook/presto/sql/planner/PlanFragmenter.java\n\n@@ -248,7 +251,7 @@ public class PlanFragmenter\n     {\n         PlanFragment fragment = subPlan.getFragment();\n         GroupedExecutionProperties properties = fragment.getRoot().accept(new GroupedExecutionTagger(session, metadata, nodePartitioningManager), null);\n-        if (properties.isSubTreeUseful() && !(fragment.getPartitioning().getConnectorHandle() instanceof SystemPartitioningHandle)) {\n+        if (properties.isSubTreeUseful()) {\n             boolean preferDynamic = fragment.getRemoteSourceNodes().stream().allMatch(node -> node.getExchangeType() == REPLICATE)\n                     && isDynamicScheduleForGroupedExecution(session);\n             BucketNodeMap bucketNodeMap = nodePartitioningManager.getBucketNodeMap(session, fragment.getPartitioning(), preferDynamic);\n"}}, {"oid": "5e9a2fd7f039fbbd732feacbaedbcabe785d41dd", "url": "https://github.com/prestodb/presto/commit/5e9a2fd7f039fbbd732feacbaedbcabe785d41dd", "message": "Don't try grouped execution for forceSingleNode\n\nGrouped execution is not supported for SystemPartitioningHandles, and\nwill fail gettting the bucket node map. forceSingleNode uses\nSystemPartitioningHandle.SINGLE_DISTRIBUTION as the partitioning.", "committedDate": "2020-07-27T16:03:51Z", "type": "commit"}, {"oid": "c210f1e384f5980e2b4251f32f9d62f2ee709b7e", "url": "https://github.com/prestodb/presto/commit/c210f1e384f5980e2b4251f32f9d62f2ee709b7e", "message": "Enable grouped execution by default", "committedDate": "2020-07-27T16:03:51Z", "type": "commit"}, {"oid": "9ff7709248d881b38778dea7e2b59d6b59215a5f", "url": "https://github.com/prestodb/presto/commit/9ff7709248d881b38778dea7e2b59d6b59215a5f", "message": "Unify grouped execution properties\n\nAdd grouped-execution-enabled property to replace\ngrouped-execution-for-aggregation-enabled,\ngrouped-execution-for-join-enabled,\ngrouped-execution-for-eligible-tablescans-enabled.  These other\nproperties will be removed in a future release.", "committedDate": "2020-07-27T16:03:51Z", "type": "commit"}, {"oid": "9ff7709248d881b38778dea7e2b59d6b59215a5f", "url": "https://github.com/prestodb/presto/commit/9ff7709248d881b38778dea7e2b59d6b59215a5f", "message": "Unify grouped execution properties\n\nAdd grouped-execution-enabled property to replace\ngrouped-execution-for-aggregation-enabled,\ngrouped-execution-for-join-enabled,\ngrouped-execution-for-eligible-tablescans-enabled.  These other\nproperties will be removed in a future release.", "committedDate": "2020-07-27T16:03:51Z", "type": "forcePushed"}]}