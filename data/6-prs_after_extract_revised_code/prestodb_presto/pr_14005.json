{"pr_number": 14005, "pr_title": "Move PushdownSubfields below logical optimization", "pr_createdAt": "2020-01-23T21:50:55Z", "pr_url": "https://github.com/prestodb/presto/pull/14005", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM4Mjc4OA==", "url": "https://github.com/prestodb/presto/pull/14005#discussion_r370382788", "bodyText": "This is the main function that was kind of rewritten. The rest of the file's logic was essentially untouched in this refactor. This implementation is nearly identical to SubfieldExtractor.toSubfield in presto-hive as the functionality is identical from my understanding of the old code.", "author": "sachdevs", "createdAt": "2020-01-23T22:12:35Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/PushdownSubfields.java", "diffHunk": "@@ -478,48 +476,66 @@ private static String getColumnName(Session session, Metadata metadata, TableHan\n             return metadata.getColumnMetadata(session, tableHandle, columnHandle).getName();\n         }\n \n-        private static Optional<Subfield> toSubfield(Node expression)\n+        private static Optional<Subfield> toSubfield(\n+                RowExpression expression,\n+                StandardFunctionResolution functionResolution,\n+                ExpressionOptimizer expressionOptimizer,\n+                ConnectorSession connectorSession)\n         {\n             ImmutableList.Builder<Subfield.PathElement> elements = ImmutableList.builder();\n             while (true) {\n-                if (expression instanceof SymbolReference) {\n-                    return Optional.of(new Subfield(((SymbolReference) expression).getName(), elements.build().reverse()));\n+                if (expression instanceof VariableReferenceExpression) {\n+                    return Optional.of(new Subfield(((VariableReferenceExpression) expression).getName(), elements.build().reverse()));\n                 }\n \n-                if (expression instanceof DereferenceExpression) {\n-                    DereferenceExpression dereference = (DereferenceExpression) expression;\n-                    elements.add(nestedField(dereference.getField().getValue()));\n-                    expression = dereference.getBase();\n-                }\n-                else if (expression instanceof SubscriptExpression) {\n-                    SubscriptExpression subscript = (SubscriptExpression) expression;\n-                    Expression index = subscript.getIndex();\n-                    if (index instanceof Cast) {\n-                        index = ((Cast) index).getExpression();\n-                    }\n-                    if (index instanceof LongLiteral) {\n-                        elements.add(new Subfield.LongSubscript(((LongLiteral) index).getValue()));\n-                    }\n-                    else if (index instanceof StringLiteral) {\n-                        elements.add(new Subfield.StringSubscript(((StringLiteral) index).getValue()));\n+                if (expression instanceof SpecialFormExpression && ((SpecialFormExpression) expression).getForm() == DEREFERENCE) {\n+                    SpecialFormExpression dereference = (SpecialFormExpression) expression;\n+                    RowExpression base = dereference.getArguments().get(0);\n+                    RowType baseType = (RowType) base.getType();\n+\n+                    RowExpression indexExpression = expressionOptimizer.optimize(\n+                            dereference.getArguments().get(1),\n+                            ExpressionOptimizer.Level.OPTIMIZED,\n+                            connectorSession);\n+\n+                    if (indexExpression instanceof ConstantExpression) {\n+                        Object index = ((ConstantExpression) indexExpression).getValue();\n+                        if (index instanceof Number) {\n+                            Optional<String> fieldName = baseType.getFields().get(((Number) index).intValue()).getName();\n+                            if (fieldName.isPresent()) {\n+                                elements.add(nestedField(fieldName.get()));\n+                                expression = base;\n+                                continue;\n+                            }\n+                        }", "originalCommit": "cf6181546718c7f8d96dc36492ad223e33d49d45", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM4MzY5Nw==", "url": "https://github.com/prestodb/presto/pull/14005#discussion_r370383697", "bodyText": "This class has also been modified significantly since we do not have such fine granularity visits for RowExpressions. Hence, on \"default\" visits, we simply visit the RowExpression's children.", "author": "sachdevs", "createdAt": "2020-01-23T22:14:52Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/PushdownSubfields.java", "diffHunk": "@@ -529,47 +545,60 @@ private static NestedField nestedField(String name)\n         }\n \n         private static final class SubfieldExtractor\n-                extends DefaultExpressionTraversalVisitor<Void, Context>\n+                extends DefaultRowExpressionTraversalVisitor<Context>\n         {\n-            private final TypeProvider typeProvider;\n+            private final StandardFunctionResolution functionResolution;\n+            private final ExpressionOptimizer expressionOptimizer;\n+            private final ConnectorSession connectorSession;\n \n-            private SubfieldExtractor(TypeProvider typeProvider)\n+            private SubfieldExtractor(StandardFunctionResolution functionResolution, ExpressionOptimizer expressionOptimizer, ConnectorSession connectorSession)", "originalCommit": "cf6181546718c7f8d96dc36492ad223e33d49d45", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQ0NTQzOQ==", "url": "https://github.com/prestodb/presto/pull/14005#discussion_r370445439", "bodyText": "checkState", "author": "highker", "createdAt": "2020-01-24T02:00:02Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/PushdownSubfields.java", "diffHunk": "@@ -140,14 +140,14 @@ public PlanNode visitAggregation(AggregationNode node, RewriteContext<Context> c\n                 // Allow sub-field pruning to pass through the arbitrary() aggregation\n                 QualifiedFunctionName aggregateName = metadata.getFunctionManager().getFunctionMetadata(aggregation.getCall().getFunctionHandle()).getName();\n                 if (ARBITRARY_AGGREGATE_FUNCTION.equals(aggregateName)) {\n-                    SymbolReference argument = (SymbolReference) castToExpression(aggregation.getArguments().get(0));\n-                    context.get().addAssignment(variable, new VariableReferenceExpression(argument.getName(), types.get(argument)));\n+                    checkArgument(aggregation.getArguments().get(0) instanceof VariableReferenceExpression);", "originalCommit": "cf6181546718c7f8d96dc36492ad223e33d49d45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc4NTYwNQ==", "url": "https://github.com/prestodb/presto/pull/14005#discussion_r370785605", "bodyText": "oops", "author": "sachdevs", "createdAt": "2020-01-24T18:47:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQ0NTQzOQ=="}], "type": "inlineReview", "revised_code": {"commit": "0b2dd4f3925d48ddedd6899ee62df350e810b569", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/PushdownSubfields.java b/presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/PushdownSubfields.java\nindex edc7fb0563..562aed729e 100644\n--- a/presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/PushdownSubfields.java\n+++ b/presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/PushdownSubfields.java\n\n@@ -140,7 +140,7 @@ public class PushdownSubfields\n                 // Allow sub-field pruning to pass through the arbitrary() aggregation\n                 QualifiedFunctionName aggregateName = metadata.getFunctionManager().getFunctionMetadata(aggregation.getCall().getFunctionHandle()).getName();\n                 if (ARBITRARY_AGGREGATE_FUNCTION.equals(aggregateName)) {\n-                    checkArgument(aggregation.getArguments().get(0) instanceof VariableReferenceExpression);\n+                    checkState(aggregation.getArguments().get(0) instanceof VariableReferenceExpression);\n                     context.get().addAssignment(variable, (VariableReferenceExpression) aggregation.getArguments().get(0));\n                 }\n                 else {\n"}}, {"oid": "0b2dd4f3925d48ddedd6899ee62df350e810b569", "url": "https://github.com/prestodb/presto/commit/0b2dd4f3925d48ddedd6899ee62df350e810b569", "message": "Move PushdownSubfields below logical optimization", "committedDate": "2020-01-24T18:49:00Z", "type": "commit"}, {"oid": "0b2dd4f3925d48ddedd6899ee62df350e810b569", "url": "https://github.com/prestodb/presto/commit/0b2dd4f3925d48ddedd6899ee62df350e810b569", "message": "Move PushdownSubfields below logical optimization", "committedDate": "2020-01-24T18:49:00Z", "type": "forcePushed"}]}