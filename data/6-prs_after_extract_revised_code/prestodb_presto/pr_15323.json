{"pr_number": 15323, "pr_title": "Add peak node total memory to statistics", "pr_createdAt": "2020-10-16T22:19:25Z", "pr_url": "https://github.com/prestodb/presto/pull/15323", "timeline": [{"oid": "7423fe40dbebcb8a9ecc9d1da9530f3c6a338198", "url": "https://github.com/prestodb/presto/commit/7423fe40dbebcb8a9ecc9d1da9530f3c6a338198", "message": "Add peak node total memory to statistics", "committedDate": "2020-10-21T20:25:24Z", "type": "forcePushed"}, {"oid": "0b293c79a176424fcf1580bc371811b0853a76bc", "url": "https://github.com/prestodb/presto/commit/0b293c79a176424fcf1580bc371811b0853a76bc", "message": "Only fetch memory reservation when needed", "committedDate": "2020-10-27T15:05:50Z", "type": "commit"}, {"oid": "3c62eb9fbd80875a665140a2b777b3a7db322c87", "url": "https://github.com/prestodb/presto/commit/3c62eb9fbd80875a665140a2b777b3a7db322c87", "message": "Add peak node total memory to statistics", "committedDate": "2020-10-27T15:05:50Z", "type": "forcePushed"}, {"oid": "9032d0f6ee4504bc53adfdcc76d0196ac8ee3d66", "url": "https://github.com/prestodb/presto/commit/9032d0f6ee4504bc53adfdcc76d0196ac8ee3d66", "message": "Add peak node total memory to statistics", "committedDate": "2020-10-27T15:11:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgwNjc1OA==", "url": "https://github.com/prestodb/presto/pull/15323#discussion_r512806758", "bodyText": "what's this?", "author": "wenleix", "createdAt": "2020-10-27T15:45:36Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/QueryStateMachine.java", "diffHunk": "@@ -111,6 +111,8 @@\n \n     private final AtomicLong peakTaskUserMemory = new AtomicLong();\n     private final AtomicLong peakTaskTotalMemory = new AtomicLong();\n+    // TODO populate this value", "originalCommit": "9032d0f6ee4504bc53adfdcc76d0196ac8ee3d66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgyMjU5MA==", "url": "https://github.com/prestodb/presto/pull/15323#discussion_r512822590", "bodyText": "Didn't push an updated version of this. I populated it with the task statistics.", "author": "aweisberg", "createdAt": "2020-10-27T16:03:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgwNjc1OA=="}], "type": "inlineReview", "revised_code": {"commit": "a3bb95df0a2aa94488b85236b15c9ec283e4bfe7", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/execution/QueryStateMachine.java b/presto-main/src/main/java/com/facebook/presto/execution/QueryStateMachine.java\nindex b2874d48b4..ab4305cd9e 100644\n--- a/presto-main/src/main/java/com/facebook/presto/execution/QueryStateMachine.java\n+++ b/presto-main/src/main/java/com/facebook/presto/execution/QueryStateMachine.java\n\n@@ -111,7 +111,6 @@ public class QueryStateMachine\n \n     private final AtomicLong peakTaskUserMemory = new AtomicLong();\n     private final AtomicLong peakTaskTotalMemory = new AtomicLong();\n-    // TODO populate this value\n     private final AtomicLong peakNodeTotalMemory = new AtomicLong();\n \n     private final AtomicInteger currentRunningTaskCount = new AtomicInteger();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgwNzEzMg==", "url": "https://github.com/prestodb/presto/pull/15323#discussion_r512807132", "bodyText": "nit: one parameter per line", "author": "wenleix", "createdAt": "2020-10-27T15:46:01Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/QueryStateMachine.java", "diffHunk": "@@ -302,14 +309,15 @@ public WarningCollector getWarningCollector()\n         return warningCollector;\n     }\n \n-    public void updateMemoryUsage(long deltaUserMemoryInBytes, long deltaTotalMemoryInBytes, long taskUserMemoryInBytes, long taskTotalMemoryInBytes)\n+    public void updateMemoryUsage(long deltaUserMemoryInBytes, long deltaTotalMemoryInBytes, long taskUserMemoryInBytes, long taskTotalMemoryInBytes, long peakNodeTotalMemoryInBytes)", "originalCommit": "9032d0f6ee4504bc53adfdcc76d0196ac8ee3d66", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f10011116af0a99ae1615f99ee5bf8cb133e12a8", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/execution/QueryStateMachine.java b/presto-main/src/main/java/com/facebook/presto/execution/QueryStateMachine.java\nindex b2874d48b4..1ffc85b88a 100644\n--- a/presto-main/src/main/java/com/facebook/presto/execution/QueryStateMachine.java\n+++ b/presto-main/src/main/java/com/facebook/presto/execution/QueryStateMachine.java\n\n@@ -309,7 +308,12 @@ public class QueryStateMachine\n         return warningCollector;\n     }\n \n-    public void updateMemoryUsage(long deltaUserMemoryInBytes, long deltaTotalMemoryInBytes, long taskUserMemoryInBytes, long taskTotalMemoryInBytes, long peakNodeTotalMemoryInBytes)\n+    public void updateMemoryUsage(\n+            long deltaUserMemoryInBytes,\n+            long deltaTotalMemoryInBytes,\n+            long taskUserMemoryInBytes,\n+            long taskTotalMemoryInBytes,\n+            long peakNodeTotalMemoryInBytes)\n     {\n         currentUserMemory.addAndGet(deltaUserMemoryInBytes);\n         currentTotalMemory.addAndGet(deltaTotalMemoryInBytes);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgwOTU1Nw==", "url": "https://github.com/prestodb/presto/pull/15323#discussion_r512809557", "bodyText": "nit: what about using totalMemory  as variable name and also use it in line 424?", "author": "wenleix", "createdAt": "2020-10-27T15:48:42Z", "path": "presto-main/src/main/java/com/facebook/presto/memory/QueryContext.java", "diffHunk": "@@ -413,9 +420,11 @@ private void enforceUserMemoryLimit(long allocated, long delta, long maxMemory)\n     @GuardedBy(\"this\")\n     private void enforceTotalMemoryLimit(long allocated, long delta, long maxMemory)\n     {\n+        long newTotal = allocated + delta;", "originalCommit": "9032d0f6ee4504bc53adfdcc76d0196ac8ee3d66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzAzNTA2MA==", "url": "https://github.com/prestodb/presto/pull/15323#discussion_r513035060", "bodyText": "Oops, I meant to reuse it. Will rename it.", "author": "aweisberg", "createdAt": "2020-10-27T21:11:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgwOTU1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "f10011116af0a99ae1615f99ee5bf8cb133e12a8", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/memory/QueryContext.java b/presto-main/src/main/java/com/facebook/presto/memory/QueryContext.java\nindex 3e48461e99..182a6262b1 100644\n--- a/presto-main/src/main/java/com/facebook/presto/memory/QueryContext.java\n+++ b/presto-main/src/main/java/com/facebook/presto/memory/QueryContext.java\n\n@@ -420,11 +420,11 @@ public class QueryContext\n     @GuardedBy(\"this\")\n     private void enforceTotalMemoryLimit(long allocated, long delta, long maxMemory)\n     {\n-        long newTotal = allocated + delta;\n-        if (allocated + delta > maxMemory) {\n+        long totalMemory = allocated + delta;\n+        peakNodeTotalMemory = Math.max(totalMemory, peakNodeTotalMemory);\n+        if (totalMemory > maxMemory) {\n             throw exceededLocalTotalMemoryLimit(succinctBytes(maxMemory), getAdditionalFailureInfo(allocated, delta));\n         }\n-        peakNodeTotalMemory = Math.max(newTotal, peakNodeTotalMemory);\n     }\n \n     @GuardedBy(\"this\")\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgxMDE0Mw==", "url": "https://github.com/prestodb/presto/pull/15323#discussion_r512810143", "bodyText": "Wondering if this could be done before line 424? -- no strong opinion.", "author": "wenleix", "createdAt": "2020-10-27T15:49:14Z", "path": "presto-main/src/main/java/com/facebook/presto/memory/QueryContext.java", "diffHunk": "@@ -413,9 +420,11 @@ private void enforceUserMemoryLimit(long allocated, long delta, long maxMemory)\n     @GuardedBy(\"this\")\n     private void enforceTotalMemoryLimit(long allocated, long delta, long maxMemory)\n     {\n+        long newTotal = allocated + delta;\n         if (allocated + delta > maxMemory) {\n             throw exceededLocalTotalMemoryLimit(succinctBytes(maxMemory), getAdditionalFailureInfo(allocated, delta));\n         }\n+        peakNodeTotalMemory = Math.max(newTotal, peakNodeTotalMemory);", "originalCommit": "9032d0f6ee4504bc53adfdcc76d0196ac8ee3d66", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f10011116af0a99ae1615f99ee5bf8cb133e12a8", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/memory/QueryContext.java b/presto-main/src/main/java/com/facebook/presto/memory/QueryContext.java\nindex 3e48461e99..182a6262b1 100644\n--- a/presto-main/src/main/java/com/facebook/presto/memory/QueryContext.java\n+++ b/presto-main/src/main/java/com/facebook/presto/memory/QueryContext.java\n\n@@ -420,11 +420,11 @@ public class QueryContext\n     @GuardedBy(\"this\")\n     private void enforceTotalMemoryLimit(long allocated, long delta, long maxMemory)\n     {\n-        long newTotal = allocated + delta;\n-        if (allocated + delta > maxMemory) {\n+        long totalMemory = allocated + delta;\n+        peakNodeTotalMemory = Math.max(totalMemory, peakNodeTotalMemory);\n+        if (totalMemory > maxMemory) {\n             throw exceededLocalTotalMemoryLimit(succinctBytes(maxMemory), getAdditionalFailureInfo(allocated, delta));\n         }\n-        peakNodeTotalMemory = Math.max(newTotal, peakNodeTotalMemory);\n     }\n \n     @GuardedBy(\"this\")\n"}}, {"oid": "a3bb95df0a2aa94488b85236b15c9ec283e4bfe7", "url": "https://github.com/prestodb/presto/commit/a3bb95df0a2aa94488b85236b15c9ec283e4bfe7", "message": "Add peak node total memory to statistics", "committedDate": "2020-10-27T16:02:48Z", "type": "forcePushed"}, {"oid": "f69ddd32a01bc6e6fd9668a2314236149e935fef", "url": "https://github.com/prestodb/presto/commit/f69ddd32a01bc6e6fd9668a2314236149e935fef", "message": "Add peak node total memory to statistics", "committedDate": "2020-10-27T17:01:09Z", "type": "forcePushed"}, {"oid": "37a1da6c3540f82f4d888c9d2bf81b799befee08", "url": "https://github.com/prestodb/presto/commit/37a1da6c3540f82f4d888c9d2bf81b799befee08", "message": "Add peak node total memory to statistics", "committedDate": "2020-10-27T17:58:26Z", "type": "forcePushed"}, {"oid": "f10011116af0a99ae1615f99ee5bf8cb133e12a8", "url": "https://github.com/prestodb/presto/commit/f10011116af0a99ae1615f99ee5bf8cb133e12a8", "message": "Add peak node total memory to statistics", "committedDate": "2020-10-27T21:12:18Z", "type": "forcePushed"}, {"oid": "8b496ada6b4cdf1a92a7cff134f49be8a99becf1", "url": "https://github.com/prestodb/presto/commit/8b496ada6b4cdf1a92a7cff134f49be8a99becf1", "message": "Add peak node total memory to statistics", "committedDate": "2020-10-27T22:43:02Z", "type": "commit"}, {"oid": "8b496ada6b4cdf1a92a7cff134f49be8a99becf1", "url": "https://github.com/prestodb/presto/commit/8b496ada6b4cdf1a92a7cff134f49be8a99becf1", "message": "Add peak node total memory to statistics", "committedDate": "2020-10-27T22:43:02Z", "type": "forcePushed"}]}