{"pr_number": 15093, "pr_title": "Adding multivalued column support in Pinot connector", "pr_createdAt": "2020-08-27T23:49:02Z", "pr_url": "https://github.com/prestodb/presto/pull/15093", "timeline": [{"oid": "8f1b7f31b11198fea1388adee82b58d6124b39bb", "url": "https://github.com/prestodb/presto/commit/8f1b7f31b11198fea1388adee82b58d6124b39bb", "message": "Adding multivalued column support in Pinot connector", "committedDate": "2020-08-28T00:19:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc2NTI1MA==", "url": "https://github.com/prestodb/presto/pull/15093#discussion_r478765250", "bodyText": "nit: Else if perhaps ? I also think type and blockbuilder cannot be null by the time we get to this function.", "author": "agrawaldevesh", "createdAt": "2020-08-28T00:26:05Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotBrokerPageSourceBase.java", "diffHunk": "@@ -110,6 +112,30 @@ private static Double parseDouble(String value)\n         }\n     }\n \n+    protected void setValue(Type type, BlockBuilder blockBuilder, JsonNode value)\n+    {\n+        if (type == null || blockBuilder == null) {", "originalCommit": "8f1b7f31b11198fea1388adee82b58d6124b39bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc4MjM3Nw==", "url": "https://github.com/prestodb/presto/pull/15093#discussion_r478782377", "bodyText": "This block builder null check is inherited from the primitive  setValue which was being called directly and now is being called via this one. Do you think this check can be removed since i don't see a requiredNonNull check in the hierarchy?   They are directly being supplied from pagebuilder", "author": "dharakk", "createdAt": "2020-08-28T01:33:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc2NTI1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc5MjQ3Mw==", "url": "https://github.com/prestodb/presto/pull/15093#discussion_r478792473", "bodyText": "I see, so remove the null check from the primitive setValue one ? now that it is handled here by its caller ?\nAlso, what does it mean if type or blockbuilder are null ? Is that a bug or perhaps it means that an output column-field has to be skipped ? I recall we do that for when creating the PQL query with some hidden column-values (like grouping without aggregation case for example in broker PQL path)", "author": "agrawaldevesh", "createdAt": "2020-08-28T02:14:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc2NTI1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc5NDUwNQ==", "url": "https://github.com/prestodb/presto/pull/15093#discussion_r478794505", "bodyText": "I see, so remove the null check from the primitive setValue one ? now that it is handled here by its caller ?\n\nGood point, the primitive setValue is also being called directly at the moment to set the group-by field value. I am not sure if an array column can be in group-by. @fx19880617 It'd be great if you can clarify.\n\nAlso, what does it mean if type or blockbuilder are null ? Is that a bug or perhaps it means that an output column-field has to be skipped ? I recall we do that for when creating the PQL query with some hidden column-values (like grouping without aggregation case for example in broker PQL path)\n\nHmm I think even for  hidden column we set types and hidden columns wouldn't have to be added to blockbuilders? since we actually do not add them to output variables? It might makes sense to remove this check.", "author": "dharakk", "createdAt": "2020-08-28T02:22:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc2NTI1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc5NTY1NA==", "url": "https://github.com/prestodb/presto/pull/15093#discussion_r478795654", "bodyText": "Hmm, Good point @dharakk ... If an array column cannot be a group by key then we might have to fail the query during pinot pql/sql generation phase :-). I feel that we should just go ahead and forbid that, it kind of does not make much sense to group by on an array (or atleast the semantics are open to interpretation).\nAlso, if you think that type and blockBuilder can never be null, should we put a requireNonNull instead of removing the check ? :-P ?", "author": "agrawaldevesh", "createdAt": "2020-08-28T02:27:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc2NTI1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY5NjAwMQ==", "url": "https://github.com/prestodb/presto/pull/15093#discussion_r482696001", "bodyText": "^^^^ ping", "author": "agrawaldevesh", "createdAt": "2020-09-03T04:27:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc2NTI1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjcyMjQ3NQ==", "url": "https://github.com/prestodb/presto/pull/15093#discussion_r482722475", "bodyText": "type is coming from PinotColumnHandle and can't be null because there is requiredNonNull for type there. Although for blockBuilder i think we should keep it because they are made in PageBuilder and also there is indeed a hidden column check where for negative columnIndex we pass in null value (Although I am not sure if we would ever encounter it).", "author": "dharakk", "createdAt": "2020-09-03T06:00:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc2NTI1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjcyNDA4Mw==", "url": "https://github.com/prestodb/presto/pull/15093#discussion_r482724083", "bodyText": "Also added a check to prevent an array column becoming a groupby column", "author": "dharakk", "createdAt": "2020-09-03T06:05:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc2NTI1MA=="}], "type": "inlineReview", "revised_code": {"commit": "d772b91492da81a29b7076601a6768e79b22709d", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotBrokerPageSourceBase.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotBrokerPageSourceBase.java\nindex 2022466aaf..6e127973e6 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotBrokerPageSourceBase.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotBrokerPageSourceBase.java\n\n@@ -114,7 +114,7 @@ public abstract class PinotBrokerPageSourceBase\n \n     protected void setValue(Type type, BlockBuilder blockBuilder, JsonNode value)\n     {\n-        if (type == null || blockBuilder == null) {\n+        if (blockBuilder == null) {\n             return;\n         }\n         if (value == null) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc2NTM2MA==", "url": "https://github.com/prestodb/presto/pull/15093#discussion_r478765360", "bodyText": "Do we support nested types ? if not, lets somehow explicitly forbid it ? ie arrays inside of arrays.", "author": "agrawaldevesh", "createdAt": "2020-08-28T00:26:29Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotBrokerPageSourceBase.java", "diffHunk": "@@ -110,6 +112,30 @@ private static Double parseDouble(String value)\n         }\n     }\n \n+    protected void setValue(Type type, BlockBuilder blockBuilder, JsonNode value)\n+    {\n+        if (type == null || blockBuilder == null) {\n+            return;\n+        }\n+        if (value == null) {\n+            blockBuilder.appendNull();\n+            return;\n+        }\n+        if (type instanceof ArrayType) {\n+            checkState(value.isArray());\n+\n+            BlockBuilder childBuilder = blockBuilder.beginBlockEntry();\n+            ArrayNode arrayNode = (ArrayNode) value;\n+            for (int i = 0; i < arrayNode.size(); i++) {\n+                setValue(((ArrayType) type).getElementType(), childBuilder, asText(arrayNode.get(i)));", "originalCommit": "8f1b7f31b11198fea1388adee82b58d6124b39bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc2Nzg2OA==", "url": "https://github.com/prestodb/presto/pull/15093#discussion_r478767868", "bodyText": "no we don't support nested arrays and it is forbidden by the existing condition within the setValue of primitive types,\n if (!(type instanceof FixedWidthType) && !(type instanceof VarcharType)) {\n            throw new PinotException(PINOT_UNSUPPORTED_COLUMN_TYPE, Optional.empty(), \"type '\" + type + \"' not supported\");\n        }", "author": "dharakk", "createdAt": "2020-08-28T00:36:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc2NTM2MA=="}], "type": "inlineReview", "revised_code": {"commit": "d772b91492da81a29b7076601a6768e79b22709d", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotBrokerPageSourceBase.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotBrokerPageSourceBase.java\nindex 2022466aaf..6e127973e6 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotBrokerPageSourceBase.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotBrokerPageSourceBase.java\n\n@@ -114,7 +114,7 @@ public abstract class PinotBrokerPageSourceBase\n \n     protected void setValue(Type type, BlockBuilder blockBuilder, JsonNode value)\n     {\n-        if (type == null || blockBuilder == null) {\n+        if (blockBuilder == null) {\n             return;\n         }\n         if (value == null) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc2NTY2OA==", "url": "https://github.com/prestodb/presto/pull/15093#discussion_r478765668", "bodyText": "I couldn't figure out how this change to TypeManager is related. It is definitely a good change and avoids duplicating framework level information.", "author": "agrawaldevesh", "createdAt": "2020-08-28T00:27:36Z", "path": "presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/MetadataUtil.java", "diffHunk": "@@ -53,29 +49,25 @@ private MetadataUtil()\n     public static final class TestingTypeDeserializer\n             extends FromStringDeserializer<Type>\n     {\n-        private final Map<String, Type> types = ImmutableMap.of(\n-                StandardTypes.BOOLEAN, BOOLEAN,\n-                StandardTypes.BIGINT, BIGINT,\n-                StandardTypes.INTEGER, INTEGER,\n-                StandardTypes.DOUBLE, DOUBLE,\n-                StandardTypes.VARCHAR, VARCHAR);\n+        private final TypeManager typeManager;", "originalCommit": "8f1b7f31b11198fea1388adee82b58d6124b39bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc2ODM3OQ==", "url": "https://github.com/prestodb/presto/pull/15093#discussion_r478768379", "bodyText": "This change is to json serialize/deserialize array type in the PinotColumnHandle\nThe type gets serialized via toString() but while deserializing it we are only looking at primitive types here and using typemanager allows us to deserialize all types, i.e. array(varchar) , array(bigint) and so on.", "author": "dharakk", "createdAt": "2020-08-28T00:38:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc2NTY2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc3MTE3OA==", "url": "https://github.com/prestodb/presto/pull/15093#discussion_r478771178", "bodyText": "Got it. Its a testing only change so shouldn't matter much, but this would accept a wider set of types like Maps, nested arrays etc, more so than what the connector can currently take in. Thanks for explaining !", "author": "agrawaldevesh", "createdAt": "2020-08-28T00:50:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc2NTY2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc5MzIxMA==", "url": "https://github.com/prestodb/presto/pull/15093#discussion_r478793210", "bodyText": "Actually we may need this beyond testing, in the coordinator-worker model to pass column handles as json.", "author": "dharakk", "createdAt": "2020-08-28T02:17:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc2NTY2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc5NjE3NQ==", "url": "https://github.com/prestodb/presto/pull/15093#discussion_r478796175", "bodyText": "Yeah good point: We should test this PR in the explicitly different coordinator-worker mode (ie regular mode) too. (The current MetadataUtil is test only apparently)\nAlso what about arrays and the PinotSegmentPageSource ?", "author": "agrawaldevesh", "createdAt": "2020-08-28T02:29:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc2NTY2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY1MzQ2OA==", "url": "https://github.com/prestodb/presto/pull/15093#discussion_r482653468", "bodyText": "Added an implementation for PinotSegmentPageSource I believe the existing tests cover this change too, looking at rest of the comments.", "author": "dharakk", "createdAt": "2020-09-03T02:17:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc2NTY2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY5NTc0MQ==", "url": "https://github.com/prestodb/presto/pull/15093#discussion_r482695741", "bodyText": "Hmm. I don't see any new tests in this PR about the segment page source multi-value support. How come the existing tests cover it ? IntelliJ\"s run with code coverage is your friend :-P", "author": "agrawaldevesh", "createdAt": "2020-09-03T04:26:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc2NTY2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjcyMzE2NA==", "url": "https://github.com/prestodb/presto/pull/15093#discussion_r482723164", "bodyText": "Actually all the new lines are covered out of the box in the coverage report as we have an all data types check here: https://github.com/prestodb/presto/blob/master/presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/TestPinotSegmentPageSource.java#L372\nAlthough I don't really understand the hashcode check.", "author": "dharakk", "createdAt": "2020-09-03T06:02:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc2NTY2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc3ODE2OA==", "url": "https://github.com/prestodb/presto/pull/15093#discussion_r482778168", "bodyText": "Added an equality check for array values", "author": "dharakk", "createdAt": "2020-09-03T07:50:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc2NTY2OA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc2NjAwNg==", "url": "https://github.com/prestodb/presto/pull/15093#discussion_r478766006", "bodyText": "Should this be in a separate test ? Like testJsonRoundTripWithArrays ?", "author": "agrawaldevesh", "createdAt": "2020-08-28T00:28:59Z", "path": "presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/TestPinotColumnHandle.java", "diffHunk": "@@ -26,13 +27,18 @@\n public class TestPinotColumnHandle\n {\n     private final PinotColumnHandle columnHandle = new PinotColumnHandle(\"columnName\", VARCHAR, REGULAR);\n+    private final PinotColumnHandle arrayColumnHandle = new PinotColumnHandle(\"arrayColumn\", new ArrayType(VARCHAR), REGULAR);\n \n     @Test\n     public void testJsonRoundTrip()\n     {\n         String json = COLUMN_CODEC.toJson(columnHandle);\n         PinotColumnHandle copy = COLUMN_CODEC.fromJson(json);\n         assertEquals(copy, columnHandle);", "originalCommit": "8f1b7f31b11198fea1388adee82b58d6124b39bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY1Mjg4NA==", "url": "https://github.com/prestodb/presto/pull/15093#discussion_r482652884", "bodyText": "done", "author": "dharakk", "createdAt": "2020-09-03T02:17:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc2NjAwNg=="}], "type": "inlineReview", "revised_code": {"commit": "90e8cd6c82467c0f7cb0715fa8a53b4b20de86fd", "chunk": "diff --git a/presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/TestPinotColumnHandle.java b/presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/TestPinotColumnHandle.java\nindex fc857cc4ed..6ea815348a 100644\n--- a/presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/TestPinotColumnHandle.java\n+++ b/presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/TestPinotColumnHandle.java\n\n@@ -35,9 +35,13 @@ public class TestPinotColumnHandle\n         String json = COLUMN_CODEC.toJson(columnHandle);\n         PinotColumnHandle copy = COLUMN_CODEC.fromJson(json);\n         assertEquals(copy, columnHandle);\n+    }\n \n-        json = COLUMN_CODEC.toJson(arrayColumnHandle);\n-        copy = COLUMN_CODEC.fromJson(json);\n+    @Test\n+    public void testJsonRoundTripWithArrays()\n+    {\n+        String json = COLUMN_CODEC.toJson(arrayColumnHandle);\n+        PinotColumnHandle copy = COLUMN_CODEC.fromJson(json);\n         assertEquals(copy, arrayColumnHandle);\n     }\n \n"}}, {"oid": "90e8cd6c82467c0f7cb0715fa8a53b4b20de86fd", "url": "https://github.com/prestodb/presto/commit/90e8cd6c82467c0f7cb0715fa8a53b4b20de86fd", "message": "Adding multivalued column support in Pinot connector", "committedDate": "2020-09-03T02:14:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY5MzQxMA==", "url": "https://github.com/prestodb/presto/pull/15093#discussion_r482693410", "bodyText": "Just confirming: This should be writeLong instead of writeInt ? Perhaps add a comment as to why.", "author": "agrawaldevesh", "createdAt": "2020-09-03T04:17:04Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSource.java", "diffHunk": "@@ -295,6 +300,66 @@ else if (javaType.equals(Slice.class)) {\n         }\n     }\n \n+    private void writeArrayBlock(BlockBuilder blockBuilder, Type columnType, int columnIndex)\n+    {\n+        for (int rowIndex = 0; rowIndex < currentDataTable.getDataTable().getNumberOfRows(); rowIndex++) {\n+            ColumnDataType columnPinotType = currentDataTable.getDataTable().getDataSchema().getColumnDataType(columnIndex);\n+            Type columnPrestoType = ((ArrayType) columnType).getElementType();\n+            BlockBuilder childBuilder = blockBuilder.beginBlockEntry();\n+            switch (columnPinotType) {\n+                case INT_ARRAY:\n+                    int[] intArray = currentDataTable.getDataTable().getIntArray(rowIndex, columnIndex);\n+                    for (int i = 0; i < intArray.length; i++) {\n+                        columnPrestoType.writeLong(childBuilder, intArray[i]);", "originalCommit": "90e8cd6c82467c0f7cb0715fa8a53b4b20de86fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjcyMzg2Mw==", "url": "https://github.com/prestodb/presto/pull/15093#discussion_r482723863", "bodyText": "both the numeric types handle the writeLong method and handle it accordingly. So whatever the type instance will handle or throw exception accordingly. Adding a comment (missed in this iteration)", "author": "dharakk", "createdAt": "2020-09-03T06:04:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY5MzQxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjcyNDQxMw==", "url": "https://github.com/prestodb/presto/pull/15093#discussion_r482724413", "bodyText": "Example: https://github.com/prestodb/presto/blob/master/presto-common/src/main/java/com/facebook/presto/common/type/IntegerType.java#L45", "author": "dharakk", "createdAt": "2020-09-03T06:06:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY5MzQxMA=="}], "type": "inlineReview", "revised_code": {"commit": "d772b91492da81a29b7076601a6768e79b22709d", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSource.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSource.java\nindex 58a7225aa8..17074262f9 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSource.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSource.java\n\n@@ -323,12 +323,14 @@ public class PinotSegmentPageSource\n                     break;\n                 case FLOAT_ARRAY:\n                     float[] floatArray = currentDataTable.getDataTable().getFloatArray(rowIndex, columnIndex);\n-                    for (int i = 0; i < floatArray.length; i++) {\n-                        if (columnPrestoType.getJavaType().equals(long.class)) {\n+                    if (columnPrestoType.getJavaType().equals(long.class)) {\n+                        for (int i = 0; i < floatArray.length; i++) {\n                             columnPrestoType.writeLong(childBuilder, (long) floatArray[i]);\n                             completedBytes += Long.BYTES;\n                         }\n-                        else {\n+                    }\n+                    else {\n+                        for (int i = 0; i < floatArray.length; i++) {\n                             columnPrestoType.writeDouble(childBuilder, floatArray[i]);\n                             completedBytes += Double.BYTES;\n                         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY5NTE4OA==", "url": "https://github.com/prestodb/presto/pull/15093#discussion_r482695188", "bodyText": "My OCD tells me we should hoist the condition outside the loop :-)", "author": "agrawaldevesh", "createdAt": "2020-09-03T04:24:21Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSource.java", "diffHunk": "@@ -295,6 +300,66 @@ else if (javaType.equals(Slice.class)) {\n         }\n     }\n \n+    private void writeArrayBlock(BlockBuilder blockBuilder, Type columnType, int columnIndex)\n+    {\n+        for (int rowIndex = 0; rowIndex < currentDataTable.getDataTable().getNumberOfRows(); rowIndex++) {\n+            ColumnDataType columnPinotType = currentDataTable.getDataTable().getDataSchema().getColumnDataType(columnIndex);\n+            Type columnPrestoType = ((ArrayType) columnType).getElementType();\n+            BlockBuilder childBuilder = blockBuilder.beginBlockEntry();\n+            switch (columnPinotType) {\n+                case INT_ARRAY:\n+                    int[] intArray = currentDataTable.getDataTable().getIntArray(rowIndex, columnIndex);\n+                    for (int i = 0; i < intArray.length; i++) {\n+                        columnPrestoType.writeLong(childBuilder, intArray[i]);\n+                        completedBytes += Long.BYTES;\n+                    }\n+                    break;\n+                case LONG_ARRAY:\n+                    long[] longArray = currentDataTable.getDataTable().getLongArray(rowIndex, columnIndex);\n+                    for (int i = 0; i < longArray.length; i++) {\n+                        columnPrestoType.writeLong(childBuilder, longArray[i]);\n+                        completedBytes += Long.BYTES;\n+                    }\n+                    break;\n+                case FLOAT_ARRAY:\n+                    float[] floatArray = currentDataTable.getDataTable().getFloatArray(rowIndex, columnIndex);\n+                    for (int i = 0; i < floatArray.length; i++) {\n+                        if (columnPrestoType.getJavaType().equals(long.class)) {", "originalCommit": "90e8cd6c82467c0f7cb0715fa8a53b4b20de86fd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d772b91492da81a29b7076601a6768e79b22709d", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSource.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSource.java\nindex 58a7225aa8..17074262f9 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSource.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSource.java\n\n@@ -323,12 +323,14 @@ public class PinotSegmentPageSource\n                     break;\n                 case FLOAT_ARRAY:\n                     float[] floatArray = currentDataTable.getDataTable().getFloatArray(rowIndex, columnIndex);\n-                    for (int i = 0; i < floatArray.length; i++) {\n-                        if (columnPrestoType.getJavaType().equals(long.class)) {\n+                    if (columnPrestoType.getJavaType().equals(long.class)) {\n+                        for (int i = 0; i < floatArray.length; i++) {\n                             columnPrestoType.writeLong(childBuilder, (long) floatArray[i]);\n                             completedBytes += Long.BYTES;\n                         }\n-                        else {\n+                    }\n+                    else {\n+                        for (int i = 0; i < floatArray.length; i++) {\n                             columnPrestoType.writeDouble(childBuilder, floatArray[i]);\n                             completedBytes += Double.BYTES;\n                         }\n"}}, {"oid": "d772b91492da81a29b7076601a6768e79b22709d", "url": "https://github.com/prestodb/presto/commit/d772b91492da81a29b7076601a6768e79b22709d", "message": "Adding multivalued column support in Pinot connector", "committedDate": "2020-09-03T05:56:27Z", "type": "forcePushed"}, {"oid": "78bb844385615c875f1c05a177cc50550d32e125", "url": "https://github.com/prestodb/presto/commit/78bb844385615c875f1c05a177cc50550d32e125", "message": "Adding multivalued column support in Pinot connector", "committedDate": "2020-09-03T07:50:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzEwMzUyNg==", "url": "https://github.com/prestodb/presto/pull/15093#discussion_r483103526", "bodyText": "super nit: Should this be a plain java comment ? Thanks for adding the comments !.", "author": "agrawaldevesh", "createdAt": "2020-09-03T16:22:43Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSource.java", "diffHunk": "@@ -295,6 +300,82 @@ else if (javaType.equals(Slice.class)) {\n         }\n     }\n \n+    private void writeArrayBlock(BlockBuilder blockBuilder, Type columnType, int columnIndex)\n+    {\n+        for (int rowIndex = 0; rowIndex < currentDataTable.getDataTable().getNumberOfRows(); rowIndex++) {\n+            ColumnDataType columnPinotType = currentDataTable.getDataTable().getDataSchema().getColumnDataType(columnIndex);\n+            Type columnPrestoType = ((ArrayType) columnType).getElementType();\n+            BlockBuilder childBuilder = blockBuilder.beginBlockEntry();\n+            switch (columnPinotType) {\n+                case INT_ARRAY:\n+                    int[] intArray = currentDataTable.getDataTable().getIntArray(rowIndex, columnIndex);\n+                    for (int i = 0; i < intArray.length; i++) {\n+                        /**", "originalCommit": "78bb844385615c875f1c05a177cc50550d32e125", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6d1eb7cc270912dbed9eb25290b230b5f572c7e6", "chunk": "diff --git a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSource.java b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSource.java\nindex 4999c55b78..3f368cbfac 100644\n--- a/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSource.java\n+++ b/presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSource.java\n\n@@ -310,10 +310,8 @@ public class PinotSegmentPageSource\n                 case INT_ARRAY:\n                     int[] intArray = currentDataTable.getDataTable().getIntArray(rowIndex, columnIndex);\n                     for (int i = 0; i < intArray.length; i++) {\n-                        /**\n-                         * Both the numeric types implement a writeLong method which write if the bounds for\n-                         * the type allows else throw exception.\n-                         */\n+                        // Both the numeric types implement a writeLong method which write if the bounds for\n+                        // the type allows else throw exception.\n                         columnPrestoType.writeLong(childBuilder, intArray[i]);\n                         completedBytes += Long.BYTES;\n                     }\n"}}, {"oid": "6d1eb7cc270912dbed9eb25290b230b5f572c7e6", "url": "https://github.com/prestodb/presto/commit/6d1eb7cc270912dbed9eb25290b230b5f572c7e6", "message": "Adding multivalued column support in Pinot connector", "committedDate": "2020-09-10T21:44:28Z", "type": "commit"}, {"oid": "6d1eb7cc270912dbed9eb25290b230b5f572c7e6", "url": "https://github.com/prestodb/presto/commit/6d1eb7cc270912dbed9eb25290b230b5f572c7e6", "message": "Adding multivalued column support in Pinot connector", "committedDate": "2020-09-10T21:44:28Z", "type": "forcePushed"}]}