{"pr_number": 14292, "pr_title": "Move SerializedPage to SPI", "pr_createdAt": "2020-03-25T07:35:00Z", "pr_url": "https://github.com/prestodb/presto/pull/14292", "timeline": [{"oid": "f99624d60c8047d52564d9bd45c4faf204963bbf", "url": "https://github.com/prestodb/presto/commit/f99624d60c8047d52564d9bd45c4faf204963bbf", "message": "Move BlockSerdeUtil to SPI", "committedDate": "2020-03-25T04:07:10Z", "type": "commit"}, {"oid": "7d20cda675ffb8833e58c92185304c7fcfd92421", "url": "https://github.com/prestodb/presto/commit/7d20cda675ffb8833e58c92185304c7fcfd92421", "message": "Move PageCodecMarker to SPI", "committedDate": "2020-03-25T05:11:57Z", "type": "commit"}, {"oid": "c1910b43d202f4ab9e6628450fa17f724c75657c", "url": "https://github.com/prestodb/presto/commit/c1910b43d202f4ab9e6628450fa17f724c75657c", "message": "Remove guava dependency from SerializedPage", "committedDate": "2020-03-25T05:46:22Z", "type": "commit"}, {"oid": "ab23f55f2ae49191100063dd98698b1260a8b54c", "url": "https://github.com/prestodb/presto/commit/ab23f55f2ae49191100063dd98698b1260a8b54c", "message": "Move SerializedPage to SPI", "committedDate": "2020-03-25T07:31:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODAyMzQzOA==", "url": "https://github.com/prestodb/presto/pull/14292#discussion_r398023438", "bodyText": "I would throw something like AssertionError, to assure it is never caught.", "author": "arhimondr", "createdAt": "2020-03-25T17:08:28Z", "path": "presto-spi/src/main/java/com/facebook/presto/spi/block/BlockSerdeUtil.java", "diffHunk": "@@ -11,21 +11,29 @@\n  * See the License for the specific language governing permissions and\n  * limitations under the License.\n  */\n-package com.facebook.presto.block;\n+package com.facebook.presto.spi.block;\n \n-import com.facebook.presto.spi.block.Block;\n-import com.facebook.presto.spi.block.BlockEncodingSerde;\n+import com.facebook.presto.spi.PrestoException;\n import io.airlift.slice.Slice;\n import io.airlift.slice.SliceInput;\n import io.airlift.slice.SliceOutput;\n \n import java.lang.invoke.MethodHandle;\n+import java.lang.invoke.MethodHandles;\n \n-import static com.facebook.presto.util.Reflection.methodHandle;\n+import static com.facebook.presto.spi.StandardErrorCode.GENERIC_INTERNAL_ERROR;\n \n public final class BlockSerdeUtil\n {\n-    public static final MethodHandle READ_BLOCK = methodHandle(BlockSerdeUtil.class, \"readBlock\", BlockEncodingSerde.class, Slice.class);\n+    public static final MethodHandle READ_BLOCK;\n+    static {\n+        try {\n+            READ_BLOCK = MethodHandles.lookup().unreflect(BlockSerdeUtil.class.getMethod(\"readBlock\", BlockEncodingSerde.class, Slice.class));\n+        }\n+        catch (IllegalAccessException | NoSuchMethodException e) {\n+            throw new PrestoException(GENERIC_INTERNAL_ERROR, e);", "originalCommit": "ab23f55f2ae49191100063dd98698b1260a8b54c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODAzMjQyMA==", "url": "https://github.com/prestodb/presto/pull/14292#discussion_r398032420", "bodyText": "I keep the logics unchanged as before,  just remove the dependency.", "author": "viczhang861", "createdAt": "2020-03-25T17:20:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODAyMzQzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODIxODkwOQ==", "url": "https://github.com/prestodb/presto/pull/14292#discussion_r398218909", "bodyText": "Curious: why need to use static code block here ( instead of keeping the previous static variable initialization ?)", "author": "wenleix", "createdAt": "2020-03-25T22:52:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODAyMzQzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODIzMjExOQ==", "url": "https://github.com/prestodb/presto/pull/14292#discussion_r398232119", "bodyText": "Curious: why need to use static code block here ( instead of keeping the previous static variable initialization ?)\n\nTo avoid dependency,  the previous static initialization uses a function from package com.facebook.presto.util.Reflection inpresto-main", "author": "viczhang861", "createdAt": "2020-03-25T23:29:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODAyMzQzOA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODAyMzk3MA==", "url": "https://github.com/prestodb/presto/pull/14292#discussion_r398023970", "bodyText": "Why to replace toString with the equals and hashCode pair?", "author": "arhimondr", "createdAt": "2020-03-25T17:09:10Z", "path": "presto-spi/src/main/java/com/facebook/presto/spi/page/SerializedPage.java", "diffHunk": "@@ -84,13 +85,31 @@ public Slice getSlice()\n     }\n \n     @Override\n-    public String toString()\n+    public boolean equals(Object o)", "originalCommit": "ab23f55f2ae49191100063dd98698b1260a8b54c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODAyOTQ3Ng==", "url": "https://github.com/prestodb/presto/pull/14292#discussion_r398029476", "bodyText": "toString() is not used, removed to avoid using guava\nequals() and hashCode() is actually missing in test and should be added, for example,  BufferResult::equals() would be wrong without SerializedPage::equals()", "author": "viczhang861", "createdAt": "2020-03-25T17:16:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODAyMzk3MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODIxOTU1OA==", "url": "https://github.com/prestodb/presto/pull/14292#discussion_r398219558", "bodyText": "equals and hashCode didn't exist in SerializedPage previously , right?", "author": "wenleix", "createdAt": "2020-03-25T22:53:56Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/buffer/SerializedPage.java", "diffHunk": "@@ -85,13 +85,31 @@ public Slice getSlice()\n     }\n \n     @Override\n-    public String toString()\n+    public boolean equals(Object o)", "originalCommit": "c1910b43d202f4ab9e6628450fa17f724c75657c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODIzMjM5Mw==", "url": "https://github.com/prestodb/presto/pull/14292#discussion_r398232393", "bodyText": "equals and hashCode didn't exist in SerializedPage previously , right?\n\nRight", "author": "viczhang861", "createdAt": "2020-03-25T23:30:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODIxOTU1OA=="}], "type": "inlineReview", "revised_code": null}]}