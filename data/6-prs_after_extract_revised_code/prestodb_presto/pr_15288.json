{"pr_number": 15288, "pr_title": "S3 assume iam role", "pr_createdAt": "2020-10-08T09:03:23Z", "pr_url": "https://github.com/prestodb/presto/pull/15288", "timeline": [{"oid": "ab6b6b6684d273795c15ad738cfb5bafaaf99ceb", "url": "https://github.com/prestodb/presto/commit/ab6b6b6684d273795c15ad738cfb5bafaaf99ceb", "message": "bump aws-sdk to 1.11.697\nNeeded for EKS presto deployments - EKS feature to grant IAM to K8s service account", "committedDate": "2020-10-08T06:24:38Z", "type": "commit"}, {"oid": "add9947433037e8fd349e795da5cfea3d5c9967d", "url": "https://github.com/prestodb/presto/commit/add9947433037e8fd349e795da5cfea3d5c9967d", "message": "Allow PrestoS3FileSystem and GlueHiveMetastore to assume an aws role\n\nExtracted from: https://github.com/prestodb/presto/pull/10864\n\nCo-authored-by: albert-franzi <albert.franzi@schibsted.com>", "committedDate": "2020-10-08T08:06:12Z", "type": "commit"}, {"oid": "13d16401b6b0d5c8926dde3fa45d683e9a852b8b", "url": "https://github.com/prestodb/presto/commit/13d16401b6b0d5c8926dde3fa45d683e9a852b8b", "message": "Changed default hive.s3.use-instance-credentials to false so users can select whether to use instance creds or iam assume role", "committedDate": "2020-10-08T10:45:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk5MzQ4Ng==", "url": "https://github.com/prestodb/presto/pull/15288#discussion_r501993486", "bodyText": "s/this.s3IamRole/s3IamRole/g", "author": "zhenxiao", "createdAt": "2020-10-08T20:29:21Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/s3/PrestoS3FileSystem.java", "diffHunk": "@@ -210,6 +213,9 @@ public void initialize(URI uri, Configuration conf)\n         this.isPathStyleAccess = conf.getBoolean(S3_PATH_STYLE_ACCESS, defaults.isS3PathStyleAccess());\n         this.useInstanceCredentials = conf.getBoolean(S3_USE_INSTANCE_CREDENTIALS, defaults.isS3UseInstanceCredentials());\n         this.pinS3ClientToCurrentRegion = conf.getBoolean(S3_PIN_CLIENT_TO_CURRENT_REGION, defaults.isPinS3ClientToCurrentRegion());\n+        this.s3IamRole = conf.get(S3_IAM_ROLE, defaults.getS3IamRole());\n+        verify(!(useInstanceCredentials && this.s3IamRole != null),", "originalCommit": "add9947433037e8fd349e795da5cfea3d5c9967d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI2NzQ1NA==", "url": "https://github.com/prestodb/presto/pull/15288#discussion_r502267454", "bodyText": "addressed this.", "author": "ashishtadose", "createdAt": "2020-10-09T08:22:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk5MzQ4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "90ebcf670085265ae803231e034ea6713b6a9508", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/s3/PrestoS3FileSystem.java b/presto-hive/src/main/java/com/facebook/presto/hive/s3/PrestoS3FileSystem.java\nindex 0032761db8..60d35c2ff7 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/s3/PrestoS3FileSystem.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/s3/PrestoS3FileSystem.java\n\n@@ -214,7 +214,7 @@ public class PrestoS3FileSystem\n         this.useInstanceCredentials = conf.getBoolean(S3_USE_INSTANCE_CREDENTIALS, defaults.isS3UseInstanceCredentials());\n         this.pinS3ClientToCurrentRegion = conf.getBoolean(S3_PIN_CLIENT_TO_CURRENT_REGION, defaults.isPinS3ClientToCurrentRegion());\n         this.s3IamRole = conf.get(S3_IAM_ROLE, defaults.getS3IamRole());\n-        verify(!(useInstanceCredentials && this.s3IamRole != null),\n+        verify(!(useInstanceCredentials && conf.get(S3_IAM_ROLE) != null),\n                 \"Invalid configuration: either use instance credentials or specify an iam role\");\n         verify((pinS3ClientToCurrentRegion && conf.get(S3_ENDPOINT) == null) || !pinS3ClientToCurrentRegion,\n                 \"Invalid configuration: either endpoint can be set or S3 client can be pinned to the current region\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk5NDA0Ng==", "url": "https://github.com/prestodb/presto/pull/15288#discussion_r501994046", "bodyText": "same for this.s3IamRole\nshall we have a roleSessionName , instead of using presto-session?", "author": "zhenxiao", "createdAt": "2020-10-08T20:30:22Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/s3/PrestoS3FileSystem.java", "diffHunk": "@@ -794,6 +800,10 @@ private AWSCredentialsProvider createAwsCredentialsProvider(URI uri, Configurati\n             return InstanceProfileCredentialsProvider.getInstance();\n         }\n \n+        if (s3IamRole != null) {\n+            return new STSAssumeRoleSessionCredentialsProvider.Builder(this.s3IamRole, \"presto-session\").build();", "originalCommit": "add9947433037e8fd349e795da5cfea3d5c9967d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk5NjE1OA==", "url": "https://github.com/prestodb/presto/pull/15288#discussion_r501996158", "bodyText": "following https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRole.html\ndo you think it will be valuable to specify maybe something like \"presto - \" + uri as the roleSessionName here instead of presto-session to also have the accessed uri as part of the role name?", "author": "zhenxiao", "createdAt": "2020-10-08T20:34:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk5NDA0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI3MDAxNA==", "url": "https://github.com/prestodb/presto/pull/15288#discussion_r502270014", "bodyText": "Agree.. would be good for audit. changed to \"presto-\" + uri", "author": "ashishtadose", "createdAt": "2020-10-09T08:27:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk5NDA0Ng=="}], "type": "inlineReview", "revised_code": {"commit": "90ebcf670085265ae803231e034ea6713b6a9508", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/s3/PrestoS3FileSystem.java b/presto-hive/src/main/java/com/facebook/presto/hive/s3/PrestoS3FileSystem.java\nindex 0032761db8..60d35c2ff7 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/s3/PrestoS3FileSystem.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/s3/PrestoS3FileSystem.java\n\n@@ -801,7 +801,7 @@ public class PrestoS3FileSystem\n         }\n \n         if (s3IamRole != null) {\n-            return new STSAssumeRoleSessionCredentialsProvider.Builder(this.s3IamRole, \"presto-session\").build();\n+            return new STSAssumeRoleSessionCredentialsProvider.Builder(s3IamRole, \"presto-\" + uri).build();\n         }\n \n         String providerClass = conf.get(S3_CREDENTIALS_PROVIDER);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk5NTAzMA==", "url": "https://github.com/prestodb/presto/pull/15288#discussion_r501995030", "bodyText": "shall we have a roleSessionName  instead of using presto-session?", "author": "zhenxiao", "createdAt": "2020-10-08T20:32:18Z", "path": "presto-hive-metastore/src/main/java/com/facebook/presto/hive/metastore/glue/GlueHiveMetastore.java", "diffHunk": "@@ -191,6 +193,13 @@ else if (config.getPinGlueClientToCurrentRegion()) {\n             }\n         }\n \n+        if (config.getIamRole().isPresent()) {\n+            AWSCredentialsProvider credentialsProvider = new STSAssumeRoleSessionCredentialsProvider\n+                    .Builder(config.getIamRole().get(), \"presto-session\")", "originalCommit": "add9947433037e8fd349e795da5cfea3d5c9967d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI2ODUyNA==", "url": "https://github.com/prestodb/presto/pull/15288#discussion_r502268524", "bodyText": "addressed. you meant  roleSessionName string as session name instead of presto-session", "author": "ashishtadose", "createdAt": "2020-10-09T08:24:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk5NTAzMA=="}], "type": "inlineReview", "revised_code": {"commit": "90ebcf670085265ae803231e034ea6713b6a9508", "chunk": "diff --git a/presto-hive-metastore/src/main/java/com/facebook/presto/hive/metastore/glue/GlueHiveMetastore.java b/presto-hive-metastore/src/main/java/com/facebook/presto/hive/metastore/glue/GlueHiveMetastore.java\nindex daab37ab56..fce0b7e0d6 100644\n--- a/presto-hive-metastore/src/main/java/com/facebook/presto/hive/metastore/glue/GlueHiveMetastore.java\n+++ b/presto-hive-metastore/src/main/java/com/facebook/presto/hive/metastore/glue/GlueHiveMetastore.java\n\n@@ -195,7 +195,7 @@ public class GlueHiveMetastore\n \n         if (config.getIamRole().isPresent()) {\n             AWSCredentialsProvider credentialsProvider = new STSAssumeRoleSessionCredentialsProvider\n-                    .Builder(config.getIamRole().get(), \"presto-session\")\n+                    .Builder(config.getIamRole().get(), \"roleSessionName\")\n                     .build();\n             asyncGlueClientBuilder.setCredentials(credentialsProvider);\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk5NjkxOQ==", "url": "https://github.com/prestodb/presto/pull/15288#discussion_r501996919", "bodyText": "am not sure about changing the default value. @highker what do you think?", "author": "zhenxiao", "createdAt": "2020-10-08T20:36:00Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/s3/HiveS3Config.java", "diffHunk": "@@ -37,7 +37,7 @@\n     private String s3Endpoint;\n     private PrestoS3SignerType s3SignerType;\n     private boolean s3PathStyleAccess;\n-    private boolean s3UseInstanceCredentials = true;", "originalCommit": "13d16401b6b0d5c8926dde3fa45d683e9a852b8b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI3NDk5MQ==", "url": "https://github.com/prestodb/presto/pull/15288#discussion_r502274991", "bodyText": "This is needed as IAM role configuration will not take effect with the current flow for creating AWS cred provider PrestoS3FileSystem.createAwsCredentialsProvider\nOptional<AWSCredentials> credentials = getAwsCredentials(uri, conf);\n        if (credentials.isPresent()) {\n            return new AWSStaticCredentialsProvider(credentials.get());\n        }\n        if (useInstanceCredentials) {\n            return InstanceProfileCredentialsProvider.getInstance();\n        }\n\n        if (s3IamRole != null) {\n            return new STSAssumeRoleSessionCredentialsProvider.Builder(s3IamRole, \"presto-\" + uri).build();\n        }", "author": "ashishtadose", "createdAt": "2020-10-09T08:36:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk5NjkxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY0MzgxNQ==", "url": "https://github.com/prestodb/presto/pull/15288#discussion_r502643815", "bodyText": "get it.", "author": "zhenxiao", "createdAt": "2020-10-09T19:56:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk5NjkxOQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "90ebcf670085265ae803231e034ea6713b6a9508", "url": "https://github.com/prestodb/presto/commit/90ebcf670085265ae803231e034ea6713b6a9508", "message": "Allow PrestoS3FileSystem and GlueHiveMetastore to assume an aws role\n\nExtracted from: https://github.com/prestodb/presto/pull/10864\n\nCo-authored-by: albert-franzi <albert.franzi@schibsted.com>", "committedDate": "2020-10-09T08:20:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY0NDc2Mg==", "url": "https://github.com/prestodb/presto/pull/15288#discussion_r502644762", "bodyText": "shall we keep both testInstanceCredentials and testAssumeRoleCredentials?", "author": "zhenxiao", "createdAt": "2020-10-09T19:59:20Z", "path": "presto-hive/src/test/java/com/facebook/presto/hive/s3/TestPrestoS3FileSystem.java", "diffHunk": "@@ -145,15 +146,16 @@ public void testEndpointWithPinToCurrentRegionConfiguration()\n     }\n \n     @Test\n-    public void testInstanceCredentialsEnabled()\n+    public void testAssumeRoleCredentials()", "originalCommit": "90ebcf670085265ae803231e034ea6713b6a9508", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI3NTY1NQ==", "url": "https://github.com/prestodb/presto/pull/15288#discussion_r503275655", "bodyText": "yes, we can.. addressed it.", "author": "ashishtadose", "createdAt": "2020-10-12T12:54:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY0NDc2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "c03ae12cdee96a53446641eb75e639e9b71c4871", "chunk": "diff --git a/presto-hive/src/test/java/com/facebook/presto/hive/s3/TestPrestoS3FileSystem.java b/presto-hive/src/test/java/com/facebook/presto/hive/s3/TestPrestoS3FileSystem.java\nindex 471c18b27e..e10cd30089 100644\n--- a/presto-hive/src/test/java/com/facebook/presto/hive/s3/TestPrestoS3FileSystem.java\n+++ b/presto-hive/src/test/java/com/facebook/presto/hive/s3/TestPrestoS3FileSystem.java\n\n@@ -159,6 +160,19 @@ public class TestPrestoS3FileSystem\n         }\n     }\n \n+    @Test\n+    public void testInstanceCredentialsEnabled()\n+            throws Exception\n+    {\n+        Configuration config = new Configuration();\n+        // instance credentials are disabled by default\n+\n+        try (PrestoS3FileSystem fs = new PrestoS3FileSystem()) {\n+            fs.initialize(new URI(\"s3n://test-bucket/\"), config);\n+            assertFalse(getAwsCredentialsProvider(fs).getClass().isInstance(InstanceProfileCredentialsProvider.class) );\n+        }\n+    }\n+\n     @Test\n     public void testDefaultCredentials()\n             throws Exception\n"}}, {"oid": "c03ae12cdee96a53446641eb75e639e9b71c4871", "url": "https://github.com/prestodb/presto/commit/c03ae12cdee96a53446641eb75e639e9b71c4871", "message": "Allow PrestoS3FileSystem and GlueHiveMetastore to assume an aws role\n\nExtracted from: https://github.com/prestodb/presto/pull/10864\n\nCo-authored-by: albert-franzi <albert.franzi@schibsted.com>", "committedDate": "2020-10-12T09:33:18Z", "type": "forcePushed"}, {"oid": "596e869f9f78e83f1fa7bf1d7512c9b1add905bc", "url": "https://github.com/prestodb/presto/commit/596e869f9f78e83f1fa7bf1d7512c9b1add905bc", "message": "Allow PrestoS3FileSystem and GlueHiveMetastore to assume an aws role\n\nExtracted from: https://github.com/prestodb/presto/pull/10864\n\nCo-authored-by: albert-franzi <albert.franzi@schibsted.com>", "committedDate": "2020-10-12T11:02:48Z", "type": "commit"}, {"oid": "596e869f9f78e83f1fa7bf1d7512c9b1add905bc", "url": "https://github.com/prestodb/presto/commit/596e869f9f78e83f1fa7bf1d7512c9b1add905bc", "message": "Allow PrestoS3FileSystem and GlueHiveMetastore to assume an aws role\n\nExtracted from: https://github.com/prestodb/presto/pull/10864\n\nCo-authored-by: albert-franzi <albert.franzi@schibsted.com>", "committedDate": "2020-10-12T11:02:48Z", "type": "forcePushed"}]}