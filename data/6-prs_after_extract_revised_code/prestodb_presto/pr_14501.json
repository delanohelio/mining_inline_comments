{"pr_number": 14501, "pr_title": "Beinan/druid hdfs bug fixing", "pr_createdAt": "2020-05-08T18:17:10Z", "pr_url": "https://github.com/prestodb/presto/pull/14501", "timeline": [{"oid": "43fbc514f4c9b0ae8d2bd54023697c542d5bb657", "url": "https://github.com/prestodb/presto/commit/43fbc514f4c9b0ae8d2bd54023697c542d5bb657", "message": "Add unit test case for druid.hadoop.config.resources", "committedDate": "2020-05-08T20:44:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ2NDg4OA==", "url": "https://github.com/prestodb/presto/pull/14501#discussion_r422464888", "bodyText": "s/hadoopResourceConfigFiles/hadoopConfiguration/g", "author": "zhenxiao", "createdAt": "2020-05-09T07:39:41Z", "path": "presto-druid/src/main/java/com/facebook/presto/druid/DruidConfig.java", "diffHunk": "@@ -15,15 +15,20 @@\n \n import com.facebook.airlift.configuration.Config;\n import com.facebook.airlift.configuration.ConfigDescription;\n+import com.google.common.base.Splitter;\n+import com.google.common.collect.ImmutableList;\n \n import javax.validation.constraints.NotNull;\n \n+import java.util.List;\n+\n public class DruidConfig\n {\n     private String coordinatorUrl;\n     private String brokerUrl;\n     private String schema = \"druid\";\n     private boolean pushdown;\n+    private List<String> hadoopResourceConfigFiles = ImmutableList.of();", "originalCommit": "d51ff3998c4a6d870b5ddfb29d06e3b14b6bb6a1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8ba1e98309fa56c8bc9d0dfab6014c1b33f041fd", "chunk": "diff --git a/presto-druid/src/main/java/com/facebook/presto/druid/DruidConfig.java b/presto-druid/src/main/java/com/facebook/presto/druid/DruidConfig.java\nindex ec1872d364..9e9cdd4d95 100644\n--- a/presto-druid/src/main/java/com/facebook/presto/druid/DruidConfig.java\n+++ b/presto-druid/src/main/java/com/facebook/presto/druid/DruidConfig.java\n\n@@ -28,7 +28,7 @@ public class DruidConfig\n     private String brokerUrl;\n     private String schema = \"druid\";\n     private boolean pushdown;\n-    private List<String> hadoopResourceConfigFiles = ImmutableList.of();\n+    private List<String> hadoopConfiguration = ImmutableList.of();\n \n     @NotNull\n     public String getDruidCoordinatorUrl()\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ2NTAwOQ==", "url": "https://github.com/prestodb/presto/pull/14501#discussion_r422465009", "bodyText": "getHadoopConfiguration", "author": "zhenxiao", "createdAt": "2020-05-09T07:40:51Z", "path": "presto-druid/src/main/java/com/facebook/presto/druid/DruidConfig.java", "diffHunk": "@@ -79,4 +84,23 @@ public DruidConfig setComputePushdownEnabled(boolean pushdown)\n         this.pushdown = pushdown;\n         return this;\n     }\n+\n+    @NotNull\n+    public List<String> getHadoopResourceConfigFiles()", "originalCommit": "d51ff3998c4a6d870b5ddfb29d06e3b14b6bb6a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ3NTc3Mg==", "url": "https://github.com/prestodb/presto/pull/14501#discussion_r423475772", "bodyText": "done", "author": "beinan", "createdAt": "2020-05-12T05:47:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ2NTAwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "8448d4b9da39713ab398aab613de4cc61f6da258", "chunk": "diff --git a/presto-druid/src/main/java/com/facebook/presto/druid/DruidConfig.java b/presto-druid/src/main/java/com/facebook/presto/druid/DruidConfig.java\nindex ec1872d364..ea253672d7 100644\n--- a/presto-druid/src/main/java/com/facebook/presto/druid/DruidConfig.java\n+++ b/presto-druid/src/main/java/com/facebook/presto/druid/DruidConfig.java\n\n@@ -94,13 +94,17 @@ public class DruidConfig\n     @Config(\"druid.hadoop.config.resources\")\n     public DruidConfig setHadoopResourceConfigFiles(String files)\n     {\n-        this.hadoopResourceConfigFiles = Splitter.on(',').trimResults().omitEmptyStrings().splitToList(files);\n+        if (files != null) {\n+            this.hadoopResourceConfigFiles = Splitter.on(',').trimResults().omitEmptyStrings().splitToList(files);\n+        }\n         return this;\n     }\n \n     public DruidConfig setHadoopResourceConfigFiles(List<String> files)\n     {\n-        this.hadoopResourceConfigFiles = ImmutableList.copyOf(files);\n+        if (files != null) {\n+            this.hadoopResourceConfigFiles = ImmutableList.copyOf(files);\n+        }\n         return this;\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ2NTExMQ==", "url": "https://github.com/prestodb/presto/pull/14501#discussion_r422465111", "bodyText": "add a comment? what is OTHER?", "author": "zhenxiao", "createdAt": "2020-05-09T07:42:10Z", "path": "presto-druid/src/main/java/com/facebook/presto/druid/DruidMetadata.java", "diffHunk": "@@ -147,6 +147,7 @@ private static Type getType(String type)\n     {\n         switch (type.toUpperCase()) {\n             case \"VARCHAR\":\n+            case \"OTHER\":", "originalCommit": "c107fce2eee3b71bdba3e158127ba17b807451ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ3NTc0OQ==", "url": "https://github.com/prestodb/presto/pull/14501#discussion_r423475749", "bodyText": "added", "author": "beinan", "createdAt": "2020-05-12T05:47:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ2NTExMQ=="}], "type": "inlineReview", "revised_code": {"commit": "835fa303365e7da065292217fac70eff07294cd9", "chunk": "diff --git a/presto-druid/src/main/java/com/facebook/presto/druid/DruidMetadata.java b/presto-druid/src/main/java/com/facebook/presto/druid/DruidMetadata.java\nindex 99b6336600..6bfc9a00a7 100644\n--- a/presto-druid/src/main/java/com/facebook/presto/druid/DruidMetadata.java\n+++ b/presto-druid/src/main/java/com/facebook/presto/druid/DruidMetadata.java\n\n@@ -147,7 +147,6 @@ public class DruidMetadata\n     {\n         switch (type.toUpperCase()) {\n             case \"VARCHAR\":\n-            case \"OTHER\":\n                 return VARCHAR;\n             case \"BIGINT\":\n                 return BIGINT;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ2NTI3NA==", "url": "https://github.com/prestodb/presto/pull/14501#discussion_r422465274", "bodyText": "why ((String) null)?", "author": "zhenxiao", "createdAt": "2020-05-09T07:44:00Z", "path": "presto-druid/src/test/java/com/facebook/presto/druid/TestDruidConfig.java", "diffHunk": "@@ -28,10 +29,11 @@\n     public void testDefaults()\n     {\n         assertRecordedDefaults(recordDefaults(DruidConfig.class)\n-                    .setDruidBrokerUrl(null)\n-                    .setDruidCoordinatorUrl(null)\n-                    .setDruidSchema(\"druid\")\n-                    .setComputePushdownEnabled(false));\n+                .setDruidBrokerUrl(null)\n+                .setDruidCoordinatorUrl(null)\n+                .setDruidSchema(\"druid\")\n+                .setComputePushdownEnabled(false)\n+                .setHadoopResourceConfigFiles((String) null));", "originalCommit": "43fbc514f4c9b0ae8d2bd54023697c542d5bb657", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ3MzQzMA==", "url": "https://github.com/prestodb/presto/pull/14501#discussion_r423473430", "bodyText": "Because there is another setter as below:\n    public DruidConfig setHadoopConfiguration(List<String> files) { if (files != null) { this.hadoopConfiguration = ImmutableList.copyOf(files); } return this; }\nWe need to provide to type explicitly.    Remove the redundant setter above, can we?   I just follow the pattern in presto-hive's config", "author": "beinan", "createdAt": "2020-05-12T05:39:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ2NTI3NA=="}], "type": "inlineReview", "revised_code": {"commit": "835fa303365e7da065292217fac70eff07294cd9", "chunk": "diff --git a/presto-druid/src/test/java/com/facebook/presto/druid/TestDruidConfig.java b/presto-druid/src/test/java/com/facebook/presto/druid/TestDruidConfig.java\nindex 51cc4040bc..c4cfc00e3d 100644\n--- a/presto-druid/src/test/java/com/facebook/presto/druid/TestDruidConfig.java\n+++ b/presto-druid/src/test/java/com/facebook/presto/druid/TestDruidConfig.java\n\n@@ -29,11 +28,10 @@ public class TestDruidConfig\n     public void testDefaults()\n     {\n         assertRecordedDefaults(recordDefaults(DruidConfig.class)\n-                .setDruidBrokerUrl(null)\n-                .setDruidCoordinatorUrl(null)\n-                .setDruidSchema(\"druid\")\n-                .setComputePushdownEnabled(false)\n-                .setHadoopResourceConfigFiles((String) null));\n+                    .setDruidBrokerUrl(null)\n+                    .setDruidCoordinatorUrl(null)\n+                    .setDruidSchema(\"druid\")\n+                    .setComputePushdownEnabled(false));\n     }\n \n     @Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ5OTQ0OA==", "url": "https://github.com/prestodb/presto/pull/14501#discussion_r423499448", "bodyText": "comment in a new line:\n// hyperUnique, approxHistogram Druid column types", "author": "zhenxiao", "createdAt": "2020-05-12T06:49:25Z", "path": "presto-druid/src/main/java/com/facebook/presto/druid/DruidMetadata.java", "diffHunk": "@@ -147,7 +147,7 @@ private static Type getType(String type)\n     {\n         switch (type.toUpperCase()) {\n             case \"VARCHAR\":\n-            case \"OTHER\":\n+            case \"OTHER\": //May represent various Druid column types such as hyperUnique, approxHistogram, etc", "originalCommit": "a13b194bc6b0a15aef1209a8238d435762d2a3d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAyNzQyMg==", "url": "https://github.com/prestodb/presto/pull/14501#discussion_r424027422", "bodyText": "done", "author": "beinan", "createdAt": "2020-05-12T20:54:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ5OTQ0OA=="}], "type": "inlineReview", "revised_code": {"commit": "835fa303365e7da065292217fac70eff07294cd9", "chunk": "diff --git a/presto-druid/src/main/java/com/facebook/presto/druid/DruidMetadata.java b/presto-druid/src/main/java/com/facebook/presto/druid/DruidMetadata.java\nindex 557ee6fdd7..6bfc9a00a7 100644\n--- a/presto-druid/src/main/java/com/facebook/presto/druid/DruidMetadata.java\n+++ b/presto-druid/src/main/java/com/facebook/presto/druid/DruidMetadata.java\n\n@@ -147,7 +147,6 @@ public class DruidMetadata\n     {\n         switch (type.toUpperCase()) {\n             case \"VARCHAR\":\n-            case \"OTHER\": //May represent various Druid column types such as hyperUnique, approxHistogram, etc\n                 return VARCHAR;\n             case \"BIGINT\":\n                 return BIGINT;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUwNDY1NQ==", "url": "https://github.com/prestodb/presto/pull/14501#discussion_r423504655", "bodyText": "get it. could the following work?\nsetHadoopConfiguration(\"\")", "author": "zhenxiao", "createdAt": "2020-05-12T07:00:29Z", "path": "presto-druid/src/test/java/com/facebook/presto/druid/TestDruidConfig.java", "diffHunk": "@@ -28,10 +29,11 @@\n     public void testDefaults()\n     {\n         assertRecordedDefaults(recordDefaults(DruidConfig.class)\n-                    .setDruidBrokerUrl(null)\n-                    .setDruidCoordinatorUrl(null)\n-                    .setDruidSchema(\"druid\")\n-                    .setComputePushdownEnabled(false));\n+                .setDruidBrokerUrl(null)\n+                .setDruidCoordinatorUrl(null)\n+                .setDruidSchema(\"druid\")\n+                .setComputePushdownEnabled(false)\n+                .setHadoopConfiguration((String) null));", "originalCommit": "a13b194bc6b0a15aef1209a8238d435762d2a3d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAyNzYwNg==", "url": "https://github.com/prestodb/presto/pull/14501#discussion_r424027606", "bodyText": "I changed it to \"\" as you said, the the tests worked.\nBut it might not be identical with null value,  I think if some user forgot to put this configuration entry,  it would passed a null rather than a \"\" string.", "author": "beinan", "createdAt": "2020-05-12T20:54:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUwNDY1NQ=="}], "type": "inlineReview", "revised_code": {"commit": "835fa303365e7da065292217fac70eff07294cd9", "chunk": "diff --git a/presto-druid/src/test/java/com/facebook/presto/druid/TestDruidConfig.java b/presto-druid/src/test/java/com/facebook/presto/druid/TestDruidConfig.java\nindex 9d5f9a1629..c4cfc00e3d 100644\n--- a/presto-druid/src/test/java/com/facebook/presto/druid/TestDruidConfig.java\n+++ b/presto-druid/src/test/java/com/facebook/presto/druid/TestDruidConfig.java\n\n@@ -29,11 +28,10 @@ public class TestDruidConfig\n     public void testDefaults()\n     {\n         assertRecordedDefaults(recordDefaults(DruidConfig.class)\n-                .setDruidBrokerUrl(null)\n-                .setDruidCoordinatorUrl(null)\n-                .setDruidSchema(\"druid\")\n-                .setComputePushdownEnabled(false)\n-                .setHadoopConfiguration((String) null));\n+                    .setDruidBrokerUrl(null)\n+                    .setDruidCoordinatorUrl(null)\n+                    .setDruidSchema(\"druid\")\n+                    .setComputePushdownEnabled(false));\n     }\n \n     @Test\n"}}, {"oid": "835fa303365e7da065292217fac70eff07294cd9", "url": "https://github.com/prestodb/presto/commit/835fa303365e7da065292217fac70eff07294cd9", "message": "Add configuration for hdfs config resources", "committedDate": "2020-05-12T20:51:28Z", "type": "commit"}, {"oid": "ce8ea9c2cae62aaf00ef411981c7d817e5f84c32", "url": "https://github.com/prestodb/presto/commit/ce8ea9c2cae62aaf00ef411981c7d817e5f84c32", "message": "Add dependency of fastutil for Druid HDFS file parsing", "committedDate": "2020-05-12T20:51:28Z", "type": "commit"}, {"oid": "cd535343b9d84cbe512b899971d0296c402b597e", "url": "https://github.com/prestodb/presto/commit/cd535343b9d84cbe512b899971d0296c402b597e", "message": "Support query columns with 'Other' type", "committedDate": "2020-05-12T20:51:29Z", "type": "commit"}, {"oid": "1334a916c2bae31f4626182473f4456159c72c13", "url": "https://github.com/prestodb/presto/commit/1334a916c2bae31f4626182473f4456159c72c13", "message": "Add the problematical file path to the presto exception message", "committedDate": "2020-05-12T20:51:29Z", "type": "commit"}, {"oid": "8e5fe890db17868ae059fc6532cb7d6ea699ed29", "url": "https://github.com/prestodb/presto/commit/8e5fe890db17868ae059fc6532cb7d6ea699ed29", "message": "Add presto-druid into presto-product-test config properties", "committedDate": "2020-05-12T20:51:29Z", "type": "commit"}, {"oid": "40d04a9676da777ae47046c620608d0c4b7309e1", "url": "https://github.com/prestodb/presto/commit/40d04a9676da777ae47046c620608d0c4b7309e1", "message": "Exclude transitive dependency to fix build error", "committedDate": "2020-05-12T20:51:30Z", "type": "commit"}, {"oid": "8448d4b9da39713ab398aab613de4cc61f6da258", "url": "https://github.com/prestodb/presto/commit/8448d4b9da39713ab398aab613de4cc61f6da258", "message": "Add unit test case for druid.hadoop.config.resources", "committedDate": "2020-05-12T20:51:30Z", "type": "commit"}, {"oid": "8ba1e98309fa56c8bc9d0dfab6014c1b33f041fd", "url": "https://github.com/prestodb/presto/commit/8ba1e98309fa56c8bc9d0dfab6014c1b33f041fd", "message": "Refactoring and fixing code review issues", "committedDate": "2020-05-12T20:51:30Z", "type": "commit"}, {"oid": "8ba1e98309fa56c8bc9d0dfab6014c1b33f041fd", "url": "https://github.com/prestodb/presto/commit/8ba1e98309fa56c8bc9d0dfab6014c1b33f041fd", "message": "Refactoring and fixing code review issues", "committedDate": "2020-05-12T20:51:30Z", "type": "forcePushed"}]}