{"pr_number": 14985, "pr_title": "Thrift udf api", "pr_createdAt": "2020-08-06T20:08:41Z", "pr_url": "https://github.com/prestodb/presto/pull/14985", "timeline": [{"oid": "7ed8be79252824b3eacc23169fb30249edc6e9ba", "url": "https://github.com/prestodb/presto/commit/7ed8be79252824b3eacc23169fb30249edc6e9ba", "message": "Refactor presto-thrift-connector-api\n\n* Rename to presto-thrift-api\n* Have separate package for datatypes, valuesets and connector", "committedDate": "2020-08-06T20:03:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY1OTk0NA==", "url": "https://github.com/prestodb/presto/pull/14985#discussion_r466659944", "bodyText": "Why not just @ThriftMethod without (\"prestoInvokeUdf\")", "author": "caithagoras", "createdAt": "2020-08-06T20:12:58Z", "path": "presto-thrift-api/src/main/java/com/facebook/presto/thrift/api/udf/PrestoThriftUdfService.java", "diffHunk": "@@ -0,0 +1,30 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.thrift.api.udf;\n+\n+import com.facebook.drift.TException;\n+import com.facebook.drift.annotations.ThriftField;\n+import com.facebook.drift.annotations.ThriftMethod;\n+import com.facebook.drift.annotations.ThriftService;\n+import com.google.common.util.concurrent.ListenableFuture;\n+\n+@ThriftService(value = \"presto-udf\", idlName = \"PrestoThriftUdfService\")\n+public interface PrestoThriftUdfService\n+{\n+    @ThriftMethod(\"prestoInvokeUdf\")", "originalCommit": "4a8e66fb6eb7da4c36f717690fe39a0b478cfac7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b5cf7b161f01f03d8dde08846103fb2cb80ea97a", "chunk": "diff --git a/presto-thrift-api/src/main/java/com/facebook/presto/thrift/api/udf/PrestoThriftUdfService.java b/presto-thrift-api/src/main/java/com/facebook/presto/thrift/api/udf/PrestoThriftUdfService.java\nindex e8be1530d4..90f09998f1 100644\n--- a/presto-thrift-api/src/main/java/com/facebook/presto/thrift/api/udf/PrestoThriftUdfService.java\n+++ b/presto-thrift-api/src/main/java/com/facebook/presto/thrift/api/udf/PrestoThriftUdfService.java\n\n@@ -15,16 +15,18 @@ package com.facebook.presto.thrift.api.udf;\n \n import com.facebook.drift.TException;\n import com.facebook.drift.annotations.ThriftField;\n+import com.facebook.drift.annotations.ThriftId;\n import com.facebook.drift.annotations.ThriftMethod;\n import com.facebook.drift.annotations.ThriftService;\n import com.google.common.util.concurrent.ListenableFuture;\n \n-@ThriftService(value = \"presto-udf\", idlName = \"PrestoThriftUdfService\")\n+@ThriftService(value = \"udf-service\", idlName = \"ThriftUdfService\")\n public interface PrestoThriftUdfService\n {\n-    @ThriftMethod(\"prestoInvokeUdf\")\n+    @ThriftMethod\n     ListenableFuture<PrestoThriftUdfResult> invokeUdf(\n-            @ThriftField(name = \"functionHandle\") PrestoThriftFunctionHandle functionHandle,\n-            @ThriftField(name = \"inputs\") PrestoThriftUdfPage inputs)\n-            throws PrestoThriftUdfServiceException, TException;\n+            @ThriftField PrestoThriftFunctionHandle functionHandle,\n+            @ThriftField PrestoThriftUdfPage inputs)\n+            throws TException,\n+            @ThriftId(1) PrestoThriftUdfServiceException;\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY2MDA5Nw==", "url": "https://github.com/prestodb/presto/pull/14985#discussion_r466660097", "bodyText": "(name = ) is unnecessary IIUC.", "author": "caithagoras", "createdAt": "2020-08-06T20:13:16Z", "path": "presto-thrift-api/src/main/java/com/facebook/presto/thrift/api/udf/PrestoThriftUdfService.java", "diffHunk": "@@ -0,0 +1,30 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.thrift.api.udf;\n+\n+import com.facebook.drift.TException;\n+import com.facebook.drift.annotations.ThriftField;\n+import com.facebook.drift.annotations.ThriftMethod;\n+import com.facebook.drift.annotations.ThriftService;\n+import com.google.common.util.concurrent.ListenableFuture;\n+\n+@ThriftService(value = \"presto-udf\", idlName = \"PrestoThriftUdfService\")\n+public interface PrestoThriftUdfService\n+{\n+    @ThriftMethod(\"prestoInvokeUdf\")\n+    ListenableFuture<PrestoThriftUdfResult> invokeUdf(\n+            @ThriftField(name = \"functionHandle\") PrestoThriftFunctionHandle functionHandle,\n+            @ThriftField(name = \"inputs\") PrestoThriftUdfPage inputs)", "originalCommit": "4a8e66fb6eb7da4c36f717690fe39a0b478cfac7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b5cf7b161f01f03d8dde08846103fb2cb80ea97a", "chunk": "diff --git a/presto-thrift-api/src/main/java/com/facebook/presto/thrift/api/udf/PrestoThriftUdfService.java b/presto-thrift-api/src/main/java/com/facebook/presto/thrift/api/udf/PrestoThriftUdfService.java\nindex e8be1530d4..90f09998f1 100644\n--- a/presto-thrift-api/src/main/java/com/facebook/presto/thrift/api/udf/PrestoThriftUdfService.java\n+++ b/presto-thrift-api/src/main/java/com/facebook/presto/thrift/api/udf/PrestoThriftUdfService.java\n\n@@ -15,16 +15,18 @@ package com.facebook.presto.thrift.api.udf;\n \n import com.facebook.drift.TException;\n import com.facebook.drift.annotations.ThriftField;\n+import com.facebook.drift.annotations.ThriftId;\n import com.facebook.drift.annotations.ThriftMethod;\n import com.facebook.drift.annotations.ThriftService;\n import com.google.common.util.concurrent.ListenableFuture;\n \n-@ThriftService(value = \"presto-udf\", idlName = \"PrestoThriftUdfService\")\n+@ThriftService(value = \"udf-service\", idlName = \"ThriftUdfService\")\n public interface PrestoThriftUdfService\n {\n-    @ThriftMethod(\"prestoInvokeUdf\")\n+    @ThriftMethod\n     ListenableFuture<PrestoThriftUdfResult> invokeUdf(\n-            @ThriftField(name = \"functionHandle\") PrestoThriftFunctionHandle functionHandle,\n-            @ThriftField(name = \"inputs\") PrestoThriftUdfPage inputs)\n-            throws PrestoThriftUdfServiceException, TException;\n+            @ThriftField PrestoThriftFunctionHandle functionHandle,\n+            @ThriftField PrestoThriftUdfPage inputs)\n+            throws TException,\n+            @ThriftId(1) PrestoThriftUdfServiceException;\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY2MDU0Mw==", "url": "https://github.com/prestodb/presto/pull/14985#discussion_r466660543", "bodyText": "Usually we do\nthrows TException,\n@ThriftId(1) PrestoThriftUdfServiceException;", "author": "caithagoras", "createdAt": "2020-08-06T20:14:11Z", "path": "presto-thrift-api/src/main/java/com/facebook/presto/thrift/api/udf/PrestoThriftUdfService.java", "diffHunk": "@@ -0,0 +1,30 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.thrift.api.udf;\n+\n+import com.facebook.drift.TException;\n+import com.facebook.drift.annotations.ThriftField;\n+import com.facebook.drift.annotations.ThriftMethod;\n+import com.facebook.drift.annotations.ThriftService;\n+import com.google.common.util.concurrent.ListenableFuture;\n+\n+@ThriftService(value = \"presto-udf\", idlName = \"PrestoThriftUdfService\")\n+public interface PrestoThriftUdfService\n+{\n+    @ThriftMethod(\"prestoInvokeUdf\")\n+    ListenableFuture<PrestoThriftUdfResult> invokeUdf(\n+            @ThriftField(name = \"functionHandle\") PrestoThriftFunctionHandle functionHandle,\n+            @ThriftField(name = \"inputs\") PrestoThriftUdfPage inputs)\n+            throws PrestoThriftUdfServiceException, TException;", "originalCommit": "4a8e66fb6eb7da4c36f717690fe39a0b478cfac7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b5cf7b161f01f03d8dde08846103fb2cb80ea97a", "chunk": "diff --git a/presto-thrift-api/src/main/java/com/facebook/presto/thrift/api/udf/PrestoThriftUdfService.java b/presto-thrift-api/src/main/java/com/facebook/presto/thrift/api/udf/PrestoThriftUdfService.java\nindex e8be1530d4..90f09998f1 100644\n--- a/presto-thrift-api/src/main/java/com/facebook/presto/thrift/api/udf/PrestoThriftUdfService.java\n+++ b/presto-thrift-api/src/main/java/com/facebook/presto/thrift/api/udf/PrestoThriftUdfService.java\n\n@@ -15,16 +15,18 @@ package com.facebook.presto.thrift.api.udf;\n \n import com.facebook.drift.TException;\n import com.facebook.drift.annotations.ThriftField;\n+import com.facebook.drift.annotations.ThriftId;\n import com.facebook.drift.annotations.ThriftMethod;\n import com.facebook.drift.annotations.ThriftService;\n import com.google.common.util.concurrent.ListenableFuture;\n \n-@ThriftService(value = \"presto-udf\", idlName = \"PrestoThriftUdfService\")\n+@ThriftService(value = \"udf-service\", idlName = \"ThriftUdfService\")\n public interface PrestoThriftUdfService\n {\n-    @ThriftMethod(\"prestoInvokeUdf\")\n+    @ThriftMethod\n     ListenableFuture<PrestoThriftUdfResult> invokeUdf(\n-            @ThriftField(name = \"functionHandle\") PrestoThriftFunctionHandle functionHandle,\n-            @ThriftField(name = \"inputs\") PrestoThriftUdfPage inputs)\n-            throws PrestoThriftUdfServiceException, TException;\n+            @ThriftField PrestoThriftFunctionHandle functionHandle,\n+            @ThriftField PrestoThriftUdfPage inputs)\n+            throws TException,\n+            @ThriftId(1) PrestoThriftUdfServiceException;\n }\n"}}, {"oid": "b5cf7b161f01f03d8dde08846103fb2cb80ea97a", "url": "https://github.com/prestodb/presto/commit/b5cf7b161f01f03d8dde08846103fb2cb80ea97a", "message": "Introduce Thrift UDF service APIs", "committedDate": "2020-08-06T20:36:37Z", "type": "forcePushed"}, {"oid": "a3efad9f03b24e66e50049a1cce55c3160adb392", "url": "https://github.com/prestodb/presto/commit/a3efad9f03b24e66e50049a1cce55c3160adb392", "message": "Introduce Thrift UDF service APIs", "committedDate": "2020-08-06T20:57:38Z", "type": "commit"}, {"oid": "a3efad9f03b24e66e50049a1cce55c3160adb392", "url": "https://github.com/prestodb/presto/commit/a3efad9f03b24e66e50049a1cce55c3160adb392", "message": "Introduce Thrift UDF service APIs", "committedDate": "2020-08-06T20:57:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY4MzU4MQ==", "url": "https://github.com/prestodb/presto/pull/14985#discussion_r466683581", "bodyText": "Let's use Optional instead of @Nullable.", "author": "caithagoras", "createdAt": "2020-08-06T21:00:31Z", "path": "presto-thrift-api/src/main/java/com/facebook/presto/thrift/api/udf/ThriftUdfPage.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.thrift.api.udf;\n+\n+import com.facebook.drift.annotations.ThriftConstructor;\n+import com.facebook.drift.annotations.ThriftField;\n+import com.facebook.drift.annotations.ThriftStruct;\n+import com.facebook.presto.thrift.api.datatypes.PrestoThriftBlock;\n+\n+import javax.annotation.Nullable;\n+\n+import java.util.List;\n+import java.util.Objects;\n+\n+import static com.facebook.drift.annotations.ThriftField.Requiredness.OPTIONAL;\n+import static com.facebook.presto.thrift.api.udf.ThriftUdfPageFormat.PRESTO_THRIFT;\n+\n+@ThriftStruct(\"UdfPage\")\n+public class ThriftUdfPage\n+{\n+    private final ThriftUdfPageFormat pageFormat;\n+    private final List<PrestoThriftBlock> thriftBlocks;\n+\n+    @ThriftConstructor\n+    public ThriftUdfPage(\n+            ThriftUdfPageFormat pageFormat,\n+            @Nullable List<PrestoThriftBlock> thriftBlocks)", "originalCommit": "a3efad9f03b24e66e50049a1cce55c3160adb392", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjcxNDM4Ng==", "url": "https://github.com/prestodb/presto/pull/14985#discussion_r466714386", "bodyText": "Are they going to be translated to the same thrift idl?", "author": "rongrong", "createdAt": "2020-08-06T22:14:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY4MzU4MQ=="}], "type": "inlineReview", "revised_code": null}]}