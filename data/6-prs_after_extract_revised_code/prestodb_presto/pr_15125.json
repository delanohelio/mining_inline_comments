{"pr_number": 15125, "pr_title": "Remove getFileStatus on openFile with Alluxio Cache", "pr_createdAt": "2020-09-04T20:14:30Z", "pr_url": "https://github.com/prestodb/presto/pull/15125", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgyNzQ4NA==", "url": "https://github.com/prestodb/presto/pull/15125#discussion_r483827484", "bodyText": "Move fileSize after extraFileInfo\nMake the type OptionalLong rather than -1 to denote unknown", "author": "highker", "createdAt": "2020-09-04T20:16:55Z", "path": "presto-hive-common/src/main/java/com/facebook/presto/hive/HiveFileContext.java", "diffHunk": "@@ -20,17 +20,20 @@\n \n public class HiveFileContext\n {\n-    public static final HiveFileContext DEFAULT_HIVE_FILE_CONTEXT = new HiveFileContext(true, NO_CACHE_CONSTRAINTS, Optional.empty());\n+    public static final long UNKNOWN_LENGTH = -1;\n+    public static final HiveFileContext DEFAULT_HIVE_FILE_CONTEXT = new HiveFileContext(true, NO_CACHE_CONSTRAINTS, Optional.empty(), UNKNOWN_LENGTH);\n \n     private final boolean cacheable;\n     private final CacheQuota cacheQuota;\n+    private final long fileSize;", "originalCommit": "6fdd35c3a065344bf3a0c932e76fb689614af3a2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5d7cdc10200a1ea276462b11f25c10ee10746f1f", "chunk": "diff --git a/presto-hive-common/src/main/java/com/facebook/presto/hive/HiveFileContext.java b/presto-hive-common/src/main/java/com/facebook/presto/hive/HiveFileContext.java\nindex 2d5673dab9..f39d168817 100644\n--- a/presto-hive-common/src/main/java/com/facebook/presto/hive/HiveFileContext.java\n+++ b/presto-hive-common/src/main/java/com/facebook/presto/hive/HiveFileContext.java\n\n@@ -21,19 +21,19 @@ import static java.util.Objects.requireNonNull;\n public class HiveFileContext\n {\n     public static final long UNKNOWN_LENGTH = -1;\n-    public static final HiveFileContext DEFAULT_HIVE_FILE_CONTEXT = new HiveFileContext(true, NO_CACHE_CONSTRAINTS, Optional.empty(), UNKNOWN_LENGTH);\n+    public static final HiveFileContext DEFAULT_HIVE_FILE_CONTEXT = new HiveFileContext(true, NO_CACHE_CONSTRAINTS, Optional.empty(), Optional.empty());\n \n     private final boolean cacheable;\n     private final CacheQuota cacheQuota;\n-    private final long fileSize;\n     private final Optional<ExtraHiveFileInfo<?>> extraFileInfo;\n+    private final Optional<Long> fileSize;\n \n-    public HiveFileContext(boolean cacheable, CacheQuota cacheQuota, Optional<ExtraHiveFileInfo<?>> extraFileInfo, long fileSize)\n+    public HiveFileContext(boolean cacheable, CacheQuota cacheQuota, Optional<ExtraHiveFileInfo<?>> extraFileInfo, Optional<Long> fileSize)\n     {\n         this.cacheable = cacheable;\n         this.cacheQuota = requireNonNull(cacheQuota, \"cacheQuota is null\");\n         this.extraFileInfo = requireNonNull(extraFileInfo, \"extraFileInfo is null\");\n-        this.fileSize = fileSize;\n+        this.fileSize = requireNonNull(fileSize, \"fileSize is null\");\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgyNzc5Mg==", "url": "https://github.com/prestodb/presto/pull/15125#discussion_r483827792", "bodyText": "remove", "author": "highker", "createdAt": "2020-09-04T20:17:49Z", "path": "presto-hive-common/src/main/java/com/facebook/presto/hive/HiveFileContext.java", "diffHunk": "@@ -20,17 +20,20 @@\n \n public class HiveFileContext\n {\n-    public static final HiveFileContext DEFAULT_HIVE_FILE_CONTEXT = new HiveFileContext(true, NO_CACHE_CONSTRAINTS, Optional.empty());\n+    public static final long UNKNOWN_LENGTH = -1;", "originalCommit": "6fdd35c3a065344bf3a0c932e76fb689614af3a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgzNzcxNg==", "url": "https://github.com/prestodb/presto/pull/15125#discussion_r483837716", "bodyText": "done", "author": "apc999", "createdAt": "2020-09-04T20:47:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgyNzc5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "5d7cdc10200a1ea276462b11f25c10ee10746f1f", "chunk": "diff --git a/presto-hive-common/src/main/java/com/facebook/presto/hive/HiveFileContext.java b/presto-hive-common/src/main/java/com/facebook/presto/hive/HiveFileContext.java\nindex 2d5673dab9..f39d168817 100644\n--- a/presto-hive-common/src/main/java/com/facebook/presto/hive/HiveFileContext.java\n+++ b/presto-hive-common/src/main/java/com/facebook/presto/hive/HiveFileContext.java\n\n@@ -21,19 +21,19 @@ import static java.util.Objects.requireNonNull;\n public class HiveFileContext\n {\n     public static final long UNKNOWN_LENGTH = -1;\n-    public static final HiveFileContext DEFAULT_HIVE_FILE_CONTEXT = new HiveFileContext(true, NO_CACHE_CONSTRAINTS, Optional.empty(), UNKNOWN_LENGTH);\n+    public static final HiveFileContext DEFAULT_HIVE_FILE_CONTEXT = new HiveFileContext(true, NO_CACHE_CONSTRAINTS, Optional.empty(), Optional.empty());\n \n     private final boolean cacheable;\n     private final CacheQuota cacheQuota;\n-    private final long fileSize;\n     private final Optional<ExtraHiveFileInfo<?>> extraFileInfo;\n+    private final Optional<Long> fileSize;\n \n-    public HiveFileContext(boolean cacheable, CacheQuota cacheQuota, Optional<ExtraHiveFileInfo<?>> extraFileInfo, long fileSize)\n+    public HiveFileContext(boolean cacheable, CacheQuota cacheQuota, Optional<ExtraHiveFileInfo<?>> extraFileInfo, Optional<Long> fileSize)\n     {\n         this.cacheable = cacheable;\n         this.cacheQuota = requireNonNull(cacheQuota, \"cacheQuota is null\");\n         this.extraFileInfo = requireNonNull(extraFileInfo, \"extraFileInfo is null\");\n-        this.fileSize = fileSize;\n+        this.fileSize = requireNonNull(fileSize, \"fileSize is null\");\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgyNzgzNQ==", "url": "https://github.com/prestodb/presto/pull/15125#discussion_r483827835", "bodyText": "remove", "author": "highker", "createdAt": "2020-09-04T20:17:57Z", "path": "presto-hive-common/src/main/java/com/facebook/presto/hive/HiveFileContext.java", "diffHunk": "@@ -54,6 +57,14 @@ public CacheQuota getCacheQuota()\n         return extraFileInfo;\n     }\n \n+    /**\n+     * file length in bytes or -1 if it is unknown\n+     */", "originalCommit": "6fdd35c3a065344bf3a0c932e76fb689614af3a2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5d7cdc10200a1ea276462b11f25c10ee10746f1f", "chunk": "diff --git a/presto-hive-common/src/main/java/com/facebook/presto/hive/HiveFileContext.java b/presto-hive-common/src/main/java/com/facebook/presto/hive/HiveFileContext.java\nindex 2d5673dab9..f39d168817 100644\n--- a/presto-hive-common/src/main/java/com/facebook/presto/hive/HiveFileContext.java\n+++ b/presto-hive-common/src/main/java/com/facebook/presto/hive/HiveFileContext.java\n\n@@ -57,10 +57,7 @@ public class HiveFileContext\n         return extraFileInfo;\n     }\n \n-    /**\n-     * file length in bytes or -1 if it is unknown\n-     */\n-    public long getFileSize()\n+    public Optional<Long> getFileSize()\n     {\n         return fileSize;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgyODQxMA==", "url": "https://github.com/prestodb/presto/pull/15125#discussion_r483828410", "bodyText": "FileInfo info = new FileInfo().setFileIdentifier(md5().hashString(path.toString(), UTF_8).toString())\n                    .setPath(path.toString())\n                    .setFolder(false)\n                    .setLength(hiveFileContext.getFileSize());", "author": "highker", "createdAt": "2020-09-04T20:19:55Z", "path": "presto-cache/src/main/java/com/facebook/presto/cache/alluxio/AlluxioCachingFileSystem.java", "diffHunk": "@@ -56,9 +59,16 @@ public FSDataInputStream openFile(Path path, HiveFileContext hiveFileContext)\n             throws Exception\n     {\n         if (hiveFileContext.isCacheable()) {\n-            FileStatus fileStatus = dataTier.getFileStatus(path);\n+            // FilePath is a unique identifier for a file, however it can be a long string\n+            // hence using md5 hash of the file path as the identifier in the cache.\n+            // We don't set fileId because fileId is Alluxio specific\n+            FileInfo info = new FileInfo();\n+            info.setFileIdentifier(md5().hashString(path.toString(), UTF_8).toString())\n+                    .setPath(path.toString())\n+                    .setFolder(false)\n+                    .setLength(hiveFileContext.getFileSize());", "originalCommit": "6fdd35c3a065344bf3a0c932e76fb689614af3a2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5d7cdc10200a1ea276462b11f25c10ee10746f1f", "chunk": "diff --git a/presto-cache/src/main/java/com/facebook/presto/cache/alluxio/AlluxioCachingFileSystem.java b/presto-cache/src/main/java/com/facebook/presto/cache/alluxio/AlluxioCachingFileSystem.java\nindex 4852b2225f..966d038144 100644\n--- a/presto-cache/src/main/java/com/facebook/presto/cache/alluxio/AlluxioCachingFileSystem.java\n+++ b/presto-cache/src/main/java/com/facebook/presto/cache/alluxio/AlluxioCachingFileSystem.java\n\n@@ -58,15 +58,15 @@ public class AlluxioCachingFileSystem\n     public FSDataInputStream openFile(Path path, HiveFileContext hiveFileContext)\n             throws Exception\n     {\n-        if (hiveFileContext.isCacheable()) {\n+        // Using Alluxio caching requires knowing file size for now\n+        if (hiveFileContext.isCacheable() && hiveFileContext.getFileSize().isPresent()) {\n             // FilePath is a unique identifier for a file, however it can be a long string\n             // hence using md5 hash of the file path as the identifier in the cache.\n             // We don't set fileId because fileId is Alluxio specific\n-            FileInfo info = new FileInfo();\n-            info.setFileIdentifier(md5().hashString(path.toString(), UTF_8).toString())\n+            FileInfo info = new FileInfo().setFileIdentifier(md5().hashString(path.toString(), UTF_8).toString())\n                     .setPath(path.toString())\n                     .setFolder(false)\n-                    .setLength(hiveFileContext.getFileSize());\n+                    .setLength(hiveFileContext.getFileSize().get());\n             // URIStatus is the mechanism to pass the hiveFileContext to the source filesystem\n             AlluxioURIStatus alluxioURIStatus = new AlluxioURIStatus(info, hiveFileContext);\n             FSDataInputStream cachingInputStream = localCacheFileSystem.open(alluxioURIStatus, BUFFER_SIZE);\n"}}, {"oid": "5d7cdc10200a1ea276462b11f25c10ee10746f1f", "url": "https://github.com/prestodb/presto/commit/5d7cdc10200a1ea276462b11f25c10ee10746f1f", "message": "Remove getFileStatus on openFile with Alluxio Cache", "committedDate": "2020-09-04T20:46:48Z", "type": "forcePushed"}, {"oid": "163b5c56f02064aa3a9aedfdce54f13ed99749e9", "url": "https://github.com/prestodb/presto/commit/163b5c56f02064aa3a9aedfdce54f13ed99749e9", "message": "Remove getFileStatus on openFile with Alluxio Cache", "committedDate": "2020-09-04T20:47:31Z", "type": "forcePushed"}, {"oid": "4e64aae70c18ef1ead90844fbe26f3417c9eeb73", "url": "https://github.com/prestodb/presto/commit/4e64aae70c18ef1ead90844fbe26f3417c9eeb73", "message": "Remove getFileStatus on openFile with Alluxio Cache", "committedDate": "2020-09-05T00:30:46Z", "type": "commit"}, {"oid": "4e64aae70c18ef1ead90844fbe26f3417c9eeb73", "url": "https://github.com/prestodb/presto/commit/4e64aae70c18ef1ead90844fbe26f3417c9eeb73", "message": "Remove getFileStatus on openFile with Alluxio Cache", "committedDate": "2020-09-05T00:30:46Z", "type": "forcePushed"}]}