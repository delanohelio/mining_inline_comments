{"pr_number": 14116, "pr_title": "Create empty blocks when there is a mismatch in struct schema", "pr_createdAt": "2020-02-18T21:26:02Z", "pr_url": "https://github.com/prestodb/presto/pull/14116", "timeline": [{"oid": "0b52d478ae3bafbcf6e801118bb6fd3273806bbe", "url": "https://github.com/prestodb/presto/commit/0b52d478ae3bafbcf6e801118bb6fd3273806bbe", "message": "Create empty blocks when there is a mismatch in struct schema", "committedDate": "2020-02-18T21:26:38Z", "type": "forcePushed"}, {"oid": "fb20f6d44cbf76d112b9a849b2e77f51fd45ee7a", "url": "https://github.com/prestodb/presto/commit/fb20f6d44cbf76d112b9a849b2e77f51fd45ee7a", "message": "Create empty blocks when there is a mismatch in struct schema", "committedDate": "2020-02-19T01:12:42Z", "type": "forcePushed"}, {"oid": "1336b991302d5a170eb8eb3bdff871bf540ad0a8", "url": "https://github.com/prestodb/presto/commit/1336b991302d5a170eb8eb3bdff871bf540ad0a8", "message": "Create empty blocks when there is a mismatch in struct schema", "committedDate": "2020-02-19T01:19:19Z", "type": "forcePushed"}, {"oid": "b389b02f85cdf8de14c1298e3ad9b6d6c2116f8f", "url": "https://github.com/prestodb/presto/commit/b389b02f85cdf8de14c1298e3ad9b6d6c2116f8f", "message": "Create empty blocks when there is a mismatch in struct schema", "committedDate": "2020-02-19T01:20:45Z", "type": "forcePushed"}, {"oid": "b46847fcd7e4f3a846f6247a1f420d7131a662f6", "url": "https://github.com/prestodb/presto/commit/b46847fcd7e4f3a846f6247a1f420d7131a662f6", "message": "Create empty blocks when there is a mismatch in struct schema", "committedDate": "2020-02-19T21:26:14Z", "type": "forcePushed"}, {"oid": "5a2c9aa869825f4737ca7e29aed4202fee869079", "url": "https://github.com/prestodb/presto/commit/5a2c9aa869825f4737ca7e29aed4202fee869079", "message": "Create empty blocks when there is a mismatch in struct schema", "committedDate": "2020-02-19T23:21:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTcxMjc0Mw==", "url": "https://github.com/prestodb/presto/pull/14116#discussion_r381712743", "bodyText": "Is there any reason for making an instance of MissingFieldStreamReader if output type is missing? I think not. If so, let's change the constructor to take Type (not Optional) and add requireNotNull.", "author": "mbasmanova", "createdAt": "2020-02-20T03:31:25Z", "path": "presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java", "diffHunk": "@@ -751,4 +766,78 @@ public long getRetainedSizeInBytes()\n             return INSTANCE_SIZE + sizeOf(outputPositions);\n         }\n     }\n+\n+    private static final class MissingFieldStreamReader\n+            implements SelectiveStreamReader\n+    {\n+        private static final int INSTANCE_SIZE = ClassLayout.parseClass(MissingFieldStreamReader.class).instanceSize();\n+        private final Type outputType;\n+        private int[] outputPositions;\n+        private int outputPositionCount;\n+\n+        MissingFieldStreamReader(Optional<Type> type)\n+        {\n+            this.outputType = type.isPresent() ? type.get() : null;", "originalCommit": "5a2c9aa869825f4737ca7e29aed4202fee869079", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "07f6f22edee7c5b60e6167cdc26deb9cd9ee4c7b", "chunk": "diff --git a/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java b/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java\nindex fe4439cbf2..40478a4a83 100644\n--- a/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java\n+++ b/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java\n\n@@ -775,9 +775,10 @@ public class StructSelectiveStreamReader\n         private int[] outputPositions;\n         private int outputPositionCount;\n \n-        MissingFieldStreamReader(Optional<Type> type)\n+        MissingFieldStreamReader(Type type)\n         {\n-            this.outputType = type.isPresent() ? type.get() : null;\n+            requireNonNull(type, \"type is required\");\n+            this.outputType = type;\n         }\n \n         @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTcxMzEzMQ==", "url": "https://github.com/prestodb/presto/pull/14116#discussion_r381713131", "bodyText": "Is this every used? Can it be implemented to throw NotImplementedException? Then, outputPositions variable can be removed and getRetainedSizeInBytes can become empty.", "author": "mbasmanova", "createdAt": "2020-02-20T03:32:17Z", "path": "presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java", "diffHunk": "@@ -751,4 +766,78 @@ public long getRetainedSizeInBytes()\n             return INSTANCE_SIZE + sizeOf(outputPositions);\n         }\n     }\n+\n+    private static final class MissingFieldStreamReader\n+            implements SelectiveStreamReader\n+    {\n+        private static final int INSTANCE_SIZE = ClassLayout.parseClass(MissingFieldStreamReader.class).instanceSize();\n+        private final Type outputType;\n+        private int[] outputPositions;\n+        private int outputPositionCount;\n+\n+        MissingFieldStreamReader(Optional<Type> type)\n+        {\n+            this.outputType = type.isPresent() ? type.get() : null;\n+        }\n+\n+        @Override\n+        public int read(int offset, int[] positions, int positionCount)\n+        {\n+            outputPositions = initializeOutputPositions(outputPositions, positions, positionCount);\n+            outputPositionCount = positionCount;\n+            return outputPositionCount;\n+        }\n+\n+        @Override\n+        public int[] getReadPositions()", "originalCommit": "5a2c9aa869825f4737ca7e29aed4202fee869079", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIwNzAyMA==", "url": "https://github.com/prestodb/presto/pull/14116#discussion_r382207020", "bodyText": "This method is called for all the fields, so we will need it", "author": "bhhari", "createdAt": "2020-02-20T19:21:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTcxMzEzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "07f6f22edee7c5b60e6167cdc26deb9cd9ee4c7b", "chunk": "diff --git a/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java b/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java\nindex fe4439cbf2..40478a4a83 100644\n--- a/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java\n+++ b/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java\n\n@@ -775,9 +775,10 @@ public class StructSelectiveStreamReader\n         private int[] outputPositions;\n         private int outputPositionCount;\n \n-        MissingFieldStreamReader(Optional<Type> type)\n+        MissingFieldStreamReader(Type type)\n         {\n-            this.outputType = type.isPresent() ? type.get() : null;\n+            requireNonNull(type, \"type is required\");\n+            this.outputType = type;\n         }\n \n         @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTcxMzQ1Mg==", "url": "https://github.com/prestodb/presto/pull/14116#discussion_r381713452", "bodyText": "use Optional.ofNullable", "author": "mbasmanova", "createdAt": "2020-02-20T03:32:57Z", "path": "presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java", "diffHunk": "@@ -143,34 +147,45 @@ public StructSelectiveStreamReader(\n                 .map(Subfield.NestedField::getName)\n                 .collect(toImmutableSet());\n \n-        if (!checkMissingFieldFilters(nestedStreams, filters)) {\n+        if (!checkMissingFieldFilters(nestedStreams.values(), filters)) {\n             this.missingFieldFilterIsFalse = true;\n             this.nestedReaders = ImmutableMap.of();\n             this.orderedNestedReaders = new SelectiveStreamReader[0];\n         }\n         else if (outputRequired || !fieldsWithFilters.isEmpty()) {\n             ImmutableMap.Builder<String, SelectiveStreamReader> nestedReaders = ImmutableMap.builder();\n-            for (int i = 0; i < nestedStreams.size(); i++) {\n-                StreamDescriptor nestedStream = nestedStreams.get(i);\n-                String fieldName = nestedStream.getFieldName().toLowerCase(Locale.ENGLISH);\n-                Optional<Type> fieldOutputType = nestedTypes.isPresent() ? Optional.of(nestedTypes.get().get(i)) : Optional.empty();\n+            Map<String, Field> nestedTypes = outputType.isPresent() ? ((RowType) this.outputType).getFields().stream()\n+                    .collect(toImmutableMap((f) -> f.getName()\n+                            .orElseThrow(() -> new IllegalArgumentException(\n+                                    \"ROW type does not have field names declared: \" + this.outputType))\n+                            .toLowerCase(Locale.ENGLISH), Function.identity()))\n+                    : ImmutableMap.of();\n+            Set<String> structFields = outputType.isPresent() ? nestedTypes.keySet() : nestedStreams.keySet();\n+            for (String fieldName : structFields) {\n+                StreamDescriptor nestedStream = nestedStreams.get(fieldName);\n                 boolean requiredField = requiredFields.map(names -> names.containsKey(fieldName)).orElse(outputRequired);\n+                Optional<Type> fieldOutputType = nestedTypes.get(fieldName) != null ? Optional.of(nestedTypes.get(fieldName).getType()) : Optional.empty();", "originalCommit": "5a2c9aa869825f4737ca7e29aed4202fee869079", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMyMjA2MA==", "url": "https://github.com/prestodb/presto/pull/14116#discussion_r382322060", "bodyText": "the Optional.empty is based on nestedTypes containing the fieldName, if its present then I m retrieving the subfield type. nestesTypes.get(field).geType", "author": "bhhari", "createdAt": "2020-02-20T23:43:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTcxMzQ1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM0NzkxMQ==", "url": "https://github.com/prestodb/presto/pull/14116#discussion_r382347911", "bodyText": "Optional.ofNullable(nestedTypes.get(fieldName)).map(Field::getType)", "author": "mbasmanova", "createdAt": "2020-02-21T01:12:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTcxMzQ1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "07f6f22edee7c5b60e6167cdc26deb9cd9ee4c7b", "chunk": "diff --git a/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java b/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java\nindex fe4439cbf2..40478a4a83 100644\n--- a/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java\n+++ b/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java\n\n@@ -155,7 +155,7 @@ public class StructSelectiveStreamReader\n         else if (outputRequired || !fieldsWithFilters.isEmpty()) {\n             ImmutableMap.Builder<String, SelectiveStreamReader> nestedReaders = ImmutableMap.builder();\n             Map<String, Field> nestedTypes = outputType.isPresent() ? ((RowType) this.outputType).getFields().stream()\n-                    .collect(toImmutableMap((f) -> f.getName()\n+                    .collect(toImmutableMap(field -> field.getName()\n                             .orElseThrow(() -> new IllegalArgumentException(\n                                     \"ROW type does not have field names declared: \" + this.outputType))\n                             .toLowerCase(Locale.ENGLISH), Function.identity()))\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTcxNDEyMQ==", "url": "https://github.com/prestodb/presto/pull/14116#discussion_r381714121", "bodyText": "f -> field\nremove parenthesis around f: (f) -> field", "author": "mbasmanova", "createdAt": "2020-02-20T03:34:15Z", "path": "presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java", "diffHunk": "@@ -143,34 +147,45 @@ public StructSelectiveStreamReader(\n                 .map(Subfield.NestedField::getName)\n                 .collect(toImmutableSet());\n \n-        if (!checkMissingFieldFilters(nestedStreams, filters)) {\n+        if (!checkMissingFieldFilters(nestedStreams.values(), filters)) {\n             this.missingFieldFilterIsFalse = true;\n             this.nestedReaders = ImmutableMap.of();\n             this.orderedNestedReaders = new SelectiveStreamReader[0];\n         }\n         else if (outputRequired || !fieldsWithFilters.isEmpty()) {\n             ImmutableMap.Builder<String, SelectiveStreamReader> nestedReaders = ImmutableMap.builder();\n-            for (int i = 0; i < nestedStreams.size(); i++) {\n-                StreamDescriptor nestedStream = nestedStreams.get(i);\n-                String fieldName = nestedStream.getFieldName().toLowerCase(Locale.ENGLISH);\n-                Optional<Type> fieldOutputType = nestedTypes.isPresent() ? Optional.of(nestedTypes.get().get(i)) : Optional.empty();\n+            Map<String, Field> nestedTypes = outputType.isPresent() ? ((RowType) this.outputType).getFields().stream()\n+                    .collect(toImmutableMap((f) -> f.getName()", "originalCommit": "5a2c9aa869825f4737ca7e29aed4202fee869079", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "07f6f22edee7c5b60e6167cdc26deb9cd9ee4c7b", "chunk": "diff --git a/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java b/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java\nindex fe4439cbf2..40478a4a83 100644\n--- a/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java\n+++ b/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java\n\n@@ -155,7 +155,7 @@ public class StructSelectiveStreamReader\n         else if (outputRequired || !fieldsWithFilters.isEmpty()) {\n             ImmutableMap.Builder<String, SelectiveStreamReader> nestedReaders = ImmutableMap.builder();\n             Map<String, Field> nestedTypes = outputType.isPresent() ? ((RowType) this.outputType).getFields().stream()\n-                    .collect(toImmutableMap((f) -> f.getName()\n+                    .collect(toImmutableMap(field -> field.getName()\n                             .orElseThrow(() -> new IllegalArgumentException(\n                                     \"ROW type does not have field names declared: \" + this.outputType))\n                             .toLowerCase(Locale.ENGLISH), Function.identity()))\n"}}, {"oid": "07f6f22edee7c5b60e6167cdc26deb9cd9ee4c7b", "url": "https://github.com/prestodb/presto/commit/07f6f22edee7c5b60e6167cdc26deb9cd9ee4c7b", "message": "Create empty blocks when there is a mismatch in struct schema", "committedDate": "2020-02-20T23:12:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM0NTc0OA==", "url": "https://github.com/prestodb/presto/pull/14116#discussion_r382345748", "bodyText": "Thanks for adding a test. I have some suggestions to make the test a little easier to read.\n\nCREATE and INSERT queries can be combined using CREATE TABLE AS SELECT (CTAS)\nfilePathOld -> oldFilePath\nfilePathNew -> newFilePath\ngetSinglePath -> getOnlyPath to match Guava naming\nMaterializedResult -> assertQuery\n\n        getQueryRunner().execute(\"CREATE TABLE test_struct(x) AS SELECT CAST(ROW(1, 2) AS ROW(a int, b int)) AS x\");\n        getQueryRunner().execute(\"CREATE TABLE test_struct_add_column(x) AS SELECT CAST(ROW(1, 2, 3) AS ROW(a int, b int, c int)) AS x\");\n        Path oldFilePath = getOnlyPath(\"test_struct\");\n        Path newDirectoryPath = getOnlyPath(\"test_struct_add_column\").getParent();\n        Files.move(oldFilePath, Paths.get(newDirectoryPath.toString(), \"old_file\"), ATOMIC_MOVE);\n\n        assertQuery(\"SELECT * FROM test_struct_add_column\", \"SELECT (1, 2, 3) UNION ALL SELECT (1, 2, null)\");", "author": "mbasmanova", "createdAt": "2020-02-21T01:03:39Z", "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHivePushdownFilterQueries.java", "diffHunk": "@@ -864,6 +872,25 @@ public void testSchemaEvolution()\n         assertUpdate(\"DROP TABLE test_schema_evolution\");\n     }\n \n+    @Test\n+    public void testStructSchemaEvolution()\n+            throws IOException\n+    {\n+        assertUpdate(\"CREATE TABLE struct_test(field0 ROW(a int, b int))\");", "originalCommit": "07f6f22edee7c5b60e6167cdc26deb9cd9ee4c7b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "97d0a35c50a5ba673ed9851f684c34888e296e5f", "chunk": "diff --git a/presto-hive/src/test/java/com/facebook/presto/hive/TestHivePushdownFilterQueries.java b/presto-hive/src/test/java/com/facebook/presto/hive/TestHivePushdownFilterQueries.java\nindex 4d8f56955a..f0ad1563d9 100644\n--- a/presto-hive/src/test/java/com/facebook/presto/hive/TestHivePushdownFilterQueries.java\n+++ b/presto-hive/src/test/java/com/facebook/presto/hive/TestHivePushdownFilterQueries.java\n\n@@ -876,19 +869,12 @@ public class TestHivePushdownFilterQueries\n     public void testStructSchemaEvolution()\n             throws IOException\n     {\n-        assertUpdate(\"CREATE TABLE struct_test(field0 ROW(a int, b int))\");\n-        assertUpdate(\"INSERT INTO struct_test SELECT ROW(1,2)\", 1);\n-        assertUpdate(\"CREATE TABLE struct_test_evolution(field0 ROW(a int, b int, c int))\");\n-        assertUpdate(\"INSERT INTO struct_test_evolution SELECT ROW(1,2,3)\", 1);\n-        Path filePathOld = getSinglePath(\"struct_test\");\n-        Path filePathNew = getSinglePath(\"struct_test_evolution\");\n-        Files.move(filePathOld, Paths.get(filePathNew.getParent().toString(), \"oldfile\"), ATOMIC_MOVE);\n-\n-        MaterializedResult materializedResult = computeActual(\"SELECT * FROM struct_test_evolution\");\n-        assertEquals(materializedResult.getRowCount(), 2);\n-        List<Object> rows = materializedResult.getMaterializedRows().stream().map(row -> (row.getField(0))).collect(Collectors.toList());\n-        List<Integer> values = rows.stream().map(list -> (Integer) ((List) list).get(2)).collect(Collectors.toList());\n-        assertTrue(values.containsAll(Lists.newArrayList(null, 3)));\n+        getQueryRunner().execute(\"CREATE TABLE test_struct(x) AS SELECT CAST(ROW(1, 2) AS ROW(a int, b int)) AS x\");\n+        getQueryRunner().execute(\"CREATE TABLE test_struct_add_column(x) AS SELECT CAST(ROW(1, 2, 3) AS ROW(a int, b int, c int)) AS x\");\n+        Path oldFilePath = getSinglePath(\"test_struct\");\n+        Path newDirectoryPath = getSinglePath(\"test_struct_add_column\").getParent();\n+        Files.move(oldFilePath, Paths.get(newDirectoryPath.toString(), \"old_file\"), ATOMIC_MOVE);\n+        assertQuery(\"SELECT * FROM test_struct_add_column\", \"SELECT (1, 2, 3) UNION ALL SELECT (1, 2, null)\");\n     }\n \n     @Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM0NjAzNg==", "url": "https://github.com/prestodb/presto/pull/14116#discussion_r382346036", "bodyText": "static import TestMapFlatSelectiveStreamReader.ExpectedValuesBuilder.Frequency.SOME", "author": "mbasmanova", "createdAt": "2020-02-21T01:04:40Z", "path": "presto-orc/src/test/java/com/facebook/presto/orc/TestMapFlatSelectiveStreamReader.java", "diffHunk": "@@ -275,8 +287,8 @@ public void testStructWithNull()\n         runTest(\n                 \"test_flat_map/flat_map_struct_with_null.dwrf\",\n                 INTEGER,\n-                rowType(INTEGER, INTEGER, INTEGER),\n-                ExpectedValuesBuilder.get(Function.identity(), TestMapFlatSelectiveStreamReader::intToList).setNullValuesFrequency(SOME));\n+                STRUCT_TYPE,\n+                ExpectedValuesBuilder.get(Function.identity(), TestMapFlatSelectiveStreamReader::intToList).setNullValuesFrequency(TestMapFlatSelectiveStreamReader.ExpectedValuesBuilder.Frequency.SOME));", "originalCommit": "07f6f22edee7c5b60e6167cdc26deb9cd9ee4c7b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "97d0a35c50a5ba673ed9851f684c34888e296e5f", "chunk": "diff --git a/presto-orc/src/test/java/com/facebook/presto/orc/TestMapFlatSelectiveStreamReader.java b/presto-orc/src/test/java/com/facebook/presto/orc/TestMapFlatSelectiveStreamReader.java\nindex 00411eb363..121cd0467a 100644\n--- a/presto-orc/src/test/java/com/facebook/presto/orc/TestMapFlatSelectiveStreamReader.java\n+++ b/presto-orc/src/test/java/com/facebook/presto/orc/TestMapFlatSelectiveStreamReader.java\n\n@@ -288,7 +288,7 @@ public class TestMapFlatSelectiveStreamReader\n                 \"test_flat_map/flat_map_struct_with_null.dwrf\",\n                 INTEGER,\n                 STRUCT_TYPE,\n-                ExpectedValuesBuilder.get(Function.identity(), TestMapFlatSelectiveStreamReader::intToList).setNullValuesFrequency(TestMapFlatSelectiveStreamReader.ExpectedValuesBuilder.Frequency.SOME));\n+                ExpectedValuesBuilder.get(Function.identity(), TestMapFlatSelectiveStreamReader::intToList).setNullValuesFrequency(SOME));\n     }\n \n     // Some of the maps are null\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM0Njc1Mg==", "url": "https://github.com/prestodb/presto/pull/14116#discussion_r382346752", "bodyText": "return createNullBlock(outputType, positionCount);", "author": "mbasmanova", "createdAt": "2020-02-21T01:07:25Z", "path": "presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java", "diffHunk": "@@ -751,4 +766,79 @@ public long getRetainedSizeInBytes()\n             return INSTANCE_SIZE + sizeOf(outputPositions);\n         }\n     }\n+\n+    private static final class MissingFieldStreamReader\n+            implements SelectiveStreamReader\n+    {\n+        private static final int INSTANCE_SIZE = ClassLayout.parseClass(MissingFieldStreamReader.class).instanceSize();\n+        private final Type outputType;\n+        private int[] outputPositions;\n+        private int outputPositionCount;\n+\n+        MissingFieldStreamReader(Type type)\n+        {\n+            requireNonNull(type, \"type is required\");\n+            this.outputType = type;\n+        }\n+\n+        @Override\n+        public int read(int offset, int[] positions, int positionCount)\n+        {\n+            outputPositions = initializeOutputPositions(outputPositions, positions, positionCount);\n+            outputPositionCount = positionCount;\n+            return outputPositionCount;\n+        }\n+\n+        @Override\n+        public int[] getReadPositions()\n+        {\n+            return outputPositions;\n+        }\n+\n+        @Override\n+        public Block getBlock(int[] positions, int positionCount)\n+        {\n+            checkState(outputType != null, \"This stream reader produces null block \");\n+            return RunLengthEncodedBlock.create(outputType, null, positionCount);", "originalCommit": "07f6f22edee7c5b60e6167cdc26deb9cd9ee4c7b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "97d0a35c50a5ba673ed9851f684c34888e296e5f", "chunk": "diff --git a/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java b/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java\nindex 40478a4a83..4ab98df049 100644\n--- a/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java\n+++ b/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java\n\n@@ -773,20 +773,17 @@ public class StructSelectiveStreamReader\n         private static final int INSTANCE_SIZE = ClassLayout.parseClass(MissingFieldStreamReader.class).instanceSize();\n         private final Type outputType;\n         private int[] outputPositions;\n-        private int outputPositionCount;\n \n         MissingFieldStreamReader(Type type)\n         {\n-            requireNonNull(type, \"type is required\");\n-            this.outputType = type;\n+            this.outputType = requireNonNull(type, \"type is required\");\n         }\n \n         @Override\n         public int read(int offset, int[] positions, int positionCount)\n         {\n             outputPositions = initializeOutputPositions(outputPositions, positions, positionCount);\n-            outputPositionCount = positionCount;\n-            return outputPositionCount;\n+            return positionCount;\n         }\n \n         @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM0Njc4NA==", "url": "https://github.com/prestodb/presto/pull/14116#discussion_r382346784", "bodyText": "return ClosingBlockLease.newLease(createNullBlock(outputType, positionCount));", "author": "mbasmanova", "createdAt": "2020-02-21T01:07:34Z", "path": "presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java", "diffHunk": "@@ -751,4 +766,79 @@ public long getRetainedSizeInBytes()\n             return INSTANCE_SIZE + sizeOf(outputPositions);\n         }\n     }\n+\n+    private static final class MissingFieldStreamReader\n+            implements SelectiveStreamReader\n+    {\n+        private static final int INSTANCE_SIZE = ClassLayout.parseClass(MissingFieldStreamReader.class).instanceSize();\n+        private final Type outputType;\n+        private int[] outputPositions;\n+        private int outputPositionCount;\n+\n+        MissingFieldStreamReader(Type type)\n+        {\n+            requireNonNull(type, \"type is required\");\n+            this.outputType = type;\n+        }\n+\n+        @Override\n+        public int read(int offset, int[] positions, int positionCount)\n+        {\n+            outputPositions = initializeOutputPositions(outputPositions, positions, positionCount);\n+            outputPositionCount = positionCount;\n+            return outputPositionCount;\n+        }\n+\n+        @Override\n+        public int[] getReadPositions()\n+        {\n+            return outputPositions;\n+        }\n+\n+        @Override\n+        public Block getBlock(int[] positions, int positionCount)\n+        {\n+            checkState(outputType != null, \"This stream reader produces null block \");\n+            return RunLengthEncodedBlock.create(outputType, null, positionCount);\n+        }\n+\n+        @Override\n+        public BlockLease getBlockView(int[] positions, int positionCount)\n+        {\n+            checkState(outputType != null, \"This stream reader produces null block\");\n+            return ClosingBlockLease.newLease(RunLengthEncodedBlock.create(outputType, null, positionCount));", "originalCommit": "07f6f22edee7c5b60e6167cdc26deb9cd9ee4c7b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "97d0a35c50a5ba673ed9851f684c34888e296e5f", "chunk": "diff --git a/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java b/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java\nindex 40478a4a83..4ab98df049 100644\n--- a/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java\n+++ b/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java\n\n@@ -773,20 +773,17 @@ public class StructSelectiveStreamReader\n         private static final int INSTANCE_SIZE = ClassLayout.parseClass(MissingFieldStreamReader.class).instanceSize();\n         private final Type outputType;\n         private int[] outputPositions;\n-        private int outputPositionCount;\n \n         MissingFieldStreamReader(Type type)\n         {\n-            requireNonNull(type, \"type is required\");\n-            this.outputType = type;\n+            this.outputType = requireNonNull(type, \"type is required\");\n         }\n \n         @Override\n         public int read(int offset, int[] positions, int positionCount)\n         {\n             outputPositions = initializeOutputPositions(outputPositions, positions, positionCount);\n-            outputPositionCount = positionCount;\n-            return outputPositionCount;\n+            return positionCount;\n         }\n \n         @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM0NjkyOQ==", "url": "https://github.com/prestodb/presto/pull/14116#discussion_r382346929", "bodyText": "This check can never fail. Remove.", "author": "mbasmanova", "createdAt": "2020-02-21T01:08:11Z", "path": "presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java", "diffHunk": "@@ -751,4 +766,79 @@ public long getRetainedSizeInBytes()\n             return INSTANCE_SIZE + sizeOf(outputPositions);\n         }\n     }\n+\n+    private static final class MissingFieldStreamReader\n+            implements SelectiveStreamReader\n+    {\n+        private static final int INSTANCE_SIZE = ClassLayout.parseClass(MissingFieldStreamReader.class).instanceSize();\n+        private final Type outputType;\n+        private int[] outputPositions;\n+        private int outputPositionCount;\n+\n+        MissingFieldStreamReader(Type type)\n+        {\n+            requireNonNull(type, \"type is required\");\n+            this.outputType = type;\n+        }\n+\n+        @Override\n+        public int read(int offset, int[] positions, int positionCount)\n+        {\n+            outputPositions = initializeOutputPositions(outputPositions, positions, positionCount);\n+            outputPositionCount = positionCount;\n+            return outputPositionCount;\n+        }\n+\n+        @Override\n+        public int[] getReadPositions()\n+        {\n+            return outputPositions;\n+        }\n+\n+        @Override\n+        public Block getBlock(int[] positions, int positionCount)\n+        {\n+            checkState(outputType != null, \"This stream reader produces null block \");", "originalCommit": "07f6f22edee7c5b60e6167cdc26deb9cd9ee4c7b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "97d0a35c50a5ba673ed9851f684c34888e296e5f", "chunk": "diff --git a/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java b/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java\nindex 40478a4a83..4ab98df049 100644\n--- a/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java\n+++ b/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java\n\n@@ -773,20 +773,17 @@ public class StructSelectiveStreamReader\n         private static final int INSTANCE_SIZE = ClassLayout.parseClass(MissingFieldStreamReader.class).instanceSize();\n         private final Type outputType;\n         private int[] outputPositions;\n-        private int outputPositionCount;\n \n         MissingFieldStreamReader(Type type)\n         {\n-            requireNonNull(type, \"type is required\");\n-            this.outputType = type;\n+            this.outputType = requireNonNull(type, \"type is required\");\n         }\n \n         @Override\n         public int read(int offset, int[] positions, int positionCount)\n         {\n             outputPositions = initializeOutputPositions(outputPositions, positions, positionCount);\n-            outputPositionCount = positionCount;\n-            return outputPositionCount;\n+            return positionCount;\n         }\n \n         @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM0NzA0Mw==", "url": "https://github.com/prestodb/presto/pull/14116#discussion_r382347043", "bodyText": "combine with assignment\nthis.outputType = requireNonNull(type, \"type is required\");", "author": "mbasmanova", "createdAt": "2020-02-21T01:08:38Z", "path": "presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java", "diffHunk": "@@ -751,4 +766,79 @@ public long getRetainedSizeInBytes()\n             return INSTANCE_SIZE + sizeOf(outputPositions);\n         }\n     }\n+\n+    private static final class MissingFieldStreamReader\n+            implements SelectiveStreamReader\n+    {\n+        private static final int INSTANCE_SIZE = ClassLayout.parseClass(MissingFieldStreamReader.class).instanceSize();\n+        private final Type outputType;\n+        private int[] outputPositions;\n+        private int outputPositionCount;\n+\n+        MissingFieldStreamReader(Type type)\n+        {\n+            requireNonNull(type, \"type is required\");", "originalCommit": "07f6f22edee7c5b60e6167cdc26deb9cd9ee4c7b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "97d0a35c50a5ba673ed9851f684c34888e296e5f", "chunk": "diff --git a/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java b/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java\nindex 40478a4a83..4ab98df049 100644\n--- a/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java\n+++ b/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java\n\n@@ -773,20 +773,17 @@ public class StructSelectiveStreamReader\n         private static final int INSTANCE_SIZE = ClassLayout.parseClass(MissingFieldStreamReader.class).instanceSize();\n         private final Type outputType;\n         private int[] outputPositions;\n-        private int outputPositionCount;\n \n         MissingFieldStreamReader(Type type)\n         {\n-            requireNonNull(type, \"type is required\");\n-            this.outputType = type;\n+            this.outputType = requireNonNull(type, \"type is required\");\n         }\n \n         @Override\n         public int read(int offset, int[] positions, int positionCount)\n         {\n             outputPositions = initializeOutputPositions(outputPositions, positions, positionCount);\n-            outputPositionCount = positionCount;\n-            return outputPositionCount;\n+            return positionCount;\n         }\n \n         @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM0NzIxMw==", "url": "https://github.com/prestodb/presto/pull/14116#discussion_r382347213", "bodyText": "This check can never fail. Remove.", "author": "mbasmanova", "createdAt": "2020-02-21T01:09:19Z", "path": "presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java", "diffHunk": "@@ -751,4 +766,79 @@ public long getRetainedSizeInBytes()\n             return INSTANCE_SIZE + sizeOf(outputPositions);\n         }\n     }\n+\n+    private static final class MissingFieldStreamReader\n+            implements SelectiveStreamReader\n+    {\n+        private static final int INSTANCE_SIZE = ClassLayout.parseClass(MissingFieldStreamReader.class).instanceSize();\n+        private final Type outputType;\n+        private int[] outputPositions;\n+        private int outputPositionCount;\n+\n+        MissingFieldStreamReader(Type type)\n+        {\n+            requireNonNull(type, \"type is required\");\n+            this.outputType = type;\n+        }\n+\n+        @Override\n+        public int read(int offset, int[] positions, int positionCount)\n+        {\n+            outputPositions = initializeOutputPositions(outputPositions, positions, positionCount);\n+            outputPositionCount = positionCount;\n+            return outputPositionCount;\n+        }\n+\n+        @Override\n+        public int[] getReadPositions()\n+        {\n+            return outputPositions;\n+        }\n+\n+        @Override\n+        public Block getBlock(int[] positions, int positionCount)\n+        {\n+            checkState(outputType != null, \"This stream reader produces null block \");\n+            return RunLengthEncodedBlock.create(outputType, null, positionCount);\n+        }\n+\n+        @Override\n+        public BlockLease getBlockView(int[] positions, int positionCount)\n+        {\n+            checkState(outputType != null, \"This stream reader produces null block\");", "originalCommit": "07f6f22edee7c5b60e6167cdc26deb9cd9ee4c7b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "97d0a35c50a5ba673ed9851f684c34888e296e5f", "chunk": "diff --git a/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java b/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java\nindex 40478a4a83..4ab98df049 100644\n--- a/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java\n+++ b/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java\n\n@@ -773,20 +773,17 @@ public class StructSelectiveStreamReader\n         private static final int INSTANCE_SIZE = ClassLayout.parseClass(MissingFieldStreamReader.class).instanceSize();\n         private final Type outputType;\n         private int[] outputPositions;\n-        private int outputPositionCount;\n \n         MissingFieldStreamReader(Type type)\n         {\n-            requireNonNull(type, \"type is required\");\n-            this.outputType = type;\n+            this.outputType = requireNonNull(type, \"type is required\");\n         }\n \n         @Override\n         public int read(int offset, int[] positions, int positionCount)\n         {\n             outputPositions = initializeOutputPositions(outputPositions, positions, positionCount);\n-            outputPositionCount = positionCount;\n-            return outputPositionCount;\n+            return positionCount;\n         }\n \n         @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM0NzQxNg==", "url": "https://github.com/prestodb/presto/pull/14116#discussion_r382347416", "bodyText": "outputPositionCount variable is not used; remove it\nreturn positionCount;", "author": "mbasmanova", "createdAt": "2020-02-21T01:10:18Z", "path": "presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java", "diffHunk": "@@ -751,4 +766,79 @@ public long getRetainedSizeInBytes()\n             return INSTANCE_SIZE + sizeOf(outputPositions);\n         }\n     }\n+\n+    private static final class MissingFieldStreamReader\n+            implements SelectiveStreamReader\n+    {\n+        private static final int INSTANCE_SIZE = ClassLayout.parseClass(MissingFieldStreamReader.class).instanceSize();\n+        private final Type outputType;\n+        private int[] outputPositions;\n+        private int outputPositionCount;\n+\n+        MissingFieldStreamReader(Type type)\n+        {\n+            requireNonNull(type, \"type is required\");\n+            this.outputType = type;\n+        }\n+\n+        @Override\n+        public int read(int offset, int[] positions, int positionCount)\n+        {\n+            outputPositions = initializeOutputPositions(outputPositions, positions, positionCount);\n+            outputPositionCount = positionCount;", "originalCommit": "07f6f22edee7c5b60e6167cdc26deb9cd9ee4c7b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "97d0a35c50a5ba673ed9851f684c34888e296e5f", "chunk": "diff --git a/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java b/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java\nindex 40478a4a83..4ab98df049 100644\n--- a/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java\n+++ b/presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java\n\n@@ -773,20 +773,17 @@ public class StructSelectiveStreamReader\n         private static final int INSTANCE_SIZE = ClassLayout.parseClass(MissingFieldStreamReader.class).instanceSize();\n         private final Type outputType;\n         private int[] outputPositions;\n-        private int outputPositionCount;\n \n         MissingFieldStreamReader(Type type)\n         {\n-            requireNonNull(type, \"type is required\");\n-            this.outputType = type;\n+            this.outputType = requireNonNull(type, \"type is required\");\n         }\n \n         @Override\n         public int read(int offset, int[] positions, int positionCount)\n         {\n             outputPositions = initializeOutputPositions(outputPositions, positions, positionCount);\n-            outputPositionCount = positionCount;\n-            return outputPositionCount;\n+            return positionCount;\n         }\n \n         @Override\n"}}, {"oid": "97d0a35c50a5ba673ed9851f684c34888e296e5f", "url": "https://github.com/prestodb/presto/commit/97d0a35c50a5ba673ed9851f684c34888e296e5f", "message": "Create empty blocks when there is a mismatch in struct schema", "committedDate": "2020-02-21T20:51:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgwMDg2NA==", "url": "https://github.com/prestodb/presto/pull/14116#discussion_r382800864", "bodyText": "nit: getOnlyPath might be a better name - https://guava.dev/releases/20.0/api/docs/com/google/common/collect/Iterables.html#getOnlyElement-java.lang.Iterable-T-", "author": "mbasmanova", "createdAt": "2020-02-21T20:54:10Z", "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHivePushdownFilterQueries.java", "diffHunk": "@@ -1055,6 +1068,12 @@ private Path getPartitionDirectory(String tableName, String partitionClause)\n         return Paths.get(filePath).getParent();\n     }\n \n+\n+    private Path getSinglePath(String tableName) {", "originalCommit": "97d0a35c50a5ba673ed9851f684c34888e296e5f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4af47df84b5052b5f52973c944090a83770dd16e", "chunk": "diff --git a/presto-hive/src/test/java/com/facebook/presto/hive/TestHivePushdownFilterQueries.java b/presto-hive/src/test/java/com/facebook/presto/hive/TestHivePushdownFilterQueries.java\nindex f0ad1563d9..5d636bec4a 100644\n--- a/presto-hive/src/test/java/com/facebook/presto/hive/TestHivePushdownFilterQueries.java\n+++ b/presto-hive/src/test/java/com/facebook/presto/hive/TestHivePushdownFilterQueries.java\n\n@@ -1069,7 +1069,7 @@ public class TestHivePushdownFilterQueries\n     }\n \n \n-    private Path getSinglePath(String tableName) {\n+    private Path getOnlyPath(String tableName) {\n        return Paths.get(((String) computeActual(noPushdownFilter(getSession()), format(\"SELECT \\\"$path\\\" FROM %s LIMIT 1\", tableName)).getOnlyValue())\n                 .replace(\"file:\", \"\"));\n     }\n"}}, {"oid": "4af47df84b5052b5f52973c944090a83770dd16e", "url": "https://github.com/prestodb/presto/commit/4af47df84b5052b5f52973c944090a83770dd16e", "message": "Create empty blocks when there is a mismatch in struct schema", "committedDate": "2020-02-21T21:27:01Z", "type": "forcePushed"}, {"oid": "d32f597d0552ca1150ef89f09ff36504d967115f", "url": "https://github.com/prestodb/presto/commit/d32f597d0552ca1150ef89f09ff36504d967115f", "message": "Create empty blocks when there is a mismatch in struct schema", "committedDate": "2020-02-21T23:14:38Z", "type": "commit"}, {"oid": "d32f597d0552ca1150ef89f09ff36504d967115f", "url": "https://github.com/prestodb/presto/commit/d32f597d0552ca1150ef89f09ff36504d967115f", "message": "Create empty blocks when there is a mismatch in struct schema", "committedDate": "2020-02-21T23:14:38Z", "type": "forcePushed"}]}