{"pr_number": 15296, "pr_title": "Minor improvements for partitioned output buffers and operator", "pr_createdAt": "2020-10-09T18:18:39Z", "pr_url": "https://github.com/prestodb/presto/pull/15296", "timeline": [{"oid": "2d22f2ff49f95451a3ffa0beb42cf00fffea98b5", "url": "https://github.com/prestodb/presto/commit/2d22f2ff49f95451a3ffa0beb42cf00fffea98b5", "message": "Minor improvements for partitioned output buffers and operator\n\n- Adds fast path for partitioning without constant arguments\n- Simplify iterating through PartitionedOutputBuffer pages to one\npass\n- Use known-size builders where possible", "committedDate": "2020-10-09T18:28:33Z", "type": "forcePushed"}, {"oid": "4d51eea16fac26caf061e51674257855aa362687", "url": "https://github.com/prestodb/presto/commit/4d51eea16fac26caf061e51674257855aa362687", "message": "Minor improvements for partitioned output buffers and operator\n\n- Adds fast path for partitioning without constant arguments\n- Simplify iterating through PartitionedOutputBuffer pages to one\npass\n- Use known-size builders where possible", "committedDate": "2020-10-09T18:43:23Z", "type": "forcePushed"}, {"oid": "7c6afb6d847f3b849cd0f0cb2e82f203db94d1a7", "url": "https://github.com/prestodb/presto/commit/7c6afb6d847f3b849cd0f0cb2e82f203db94d1a7", "message": "Minor improvements for partitioned output buffers and operator\n\n- Adds fast path for partitioning without constant arguments\n- Simplify iterating through PartitionedOutputBuffer pages to one\npass\n- Use known-size builders where possible", "committedDate": "2020-10-09T19:00:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk2Mjc4NA==", "url": "https://github.com/prestodb/presto/pull/15296#discussion_r505962784", "bodyText": "Can we rename split to splittedPages? It's easy to get confused on the wordsplit with Presto splits", "author": "yingsu00", "createdAt": "2020-10-16T01:24:48Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/repartition/PartitionedOutputOperator.java", "diffHunk": "@@ -419,15 +444,21 @@ public void flush(boolean force)\n \n                     operatorContext.recordOutput(pagePartition.getSizeInBytes(), pagePartition.getPositionCount());\n \n-                    List<SerializedPage> serializedPages = splitPage(pagePartition, DEFAULT_MAX_PAGE_SIZE_IN_BYTES).stream()\n-                            .map(serde::serialize)\n-                            .collect(toImmutableList());\n-\n-                    outputBuffer.enqueue(operatorContext.getDriverContext().getLifespan(), partition, serializedPages);\n+                    outputBuffer.enqueue(operatorContext.getDriverContext().getLifespan(), partition, splitAndSerializePage(pagePartition));\n                     pagesAdded.incrementAndGet();\n                     rowsAdded.addAndGet(pagePartition.getPositionCount());\n                 }\n             }\n         }\n+\n+        private List<SerializedPage> splitAndSerializePage(Page pagePartition)\n+        {\n+            List<Page> split = splitPage(pagePartition, DEFAULT_MAX_PAGE_SIZE_IN_BYTES);", "originalCommit": "7c6afb6d847f3b849cd0f0cb2e82f203db94d1a7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMyMTEzNA==", "url": "https://github.com/prestodb/presto/pull/15296#discussion_r506321134", "bodyText": "Sure, renamed.", "author": "pettyjamesm", "createdAt": "2020-10-16T11:33:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk2Mjc4NA=="}], "type": "inlineReview", "revised_code": {"commit": "01196dbf7b4f3875f70bf03541764e9ebb5df580", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/operator/repartition/PartitionedOutputOperator.java b/presto-main/src/main/java/com/facebook/presto/operator/repartition/PartitionedOutputOperator.java\nindex b81441f5db..3a8e724184 100644\n--- a/presto-main/src/main/java/com/facebook/presto/operator/repartition/PartitionedOutputOperator.java\n+++ b/presto-main/src/main/java/com/facebook/presto/operator/repartition/PartitionedOutputOperator.java\n\n@@ -453,9 +453,9 @@ public class PartitionedOutputOperator\n \n         private List<SerializedPage> splitAndSerializePage(Page pagePartition)\n         {\n-            List<Page> split = splitPage(pagePartition, DEFAULT_MAX_PAGE_SIZE_IN_BYTES);\n-            ImmutableList.Builder<SerializedPage> builder = ImmutableList.builderWithExpectedSize(split.size());\n-            for (Page p : split) {\n+            List<Page> pagesFromSplitting = splitPage(pagePartition, DEFAULT_MAX_PAGE_SIZE_IN_BYTES);\n+            ImmutableList.Builder<SerializedPage> builder = ImmutableList.builderWithExpectedSize(pagesFromSplitting.size());\n+            for (Page p : pagesFromSplitting) {\n                 builder.add(serde.serialize(p));\n             }\n             return builder.build();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk2MzA4MA==", "url": "https://github.com/prestodb/presto/pull/15296#discussion_r505963080", "bodyText": "Wonder if you could add the same optimization to OptimizedPartitionedOutputOperator?", "author": "yingsu00", "createdAt": "2020-10-16T01:25:22Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/repartition/PartitionedOutputOperator.java", "diffHunk": "@@ -385,14 +405,19 @@ public void partitionPage(Page page)\n \n         private Page getPartitionFunctionArguments(Page page)\n         {\n-            Block[] blocks = new Block[partitionChannels.size()];\n+            // Fast path for no constants\n+            if (partitionConstantBlocks == null) {", "originalCommit": "7c6afb6d847f3b849cd0f0cb2e82f203db94d1a7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMyMTM5NA==", "url": "https://github.com/prestodb/presto/pull/15296#discussion_r506321394", "bodyText": "Didn't realize OptimizedPartitionedOutputOperator existed, added the same change there.", "author": "pettyjamesm", "createdAt": "2020-10-16T11:33:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk2MzA4MA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "01196dbf7b4f3875f70bf03541764e9ebb5df580", "url": "https://github.com/prestodb/presto/commit/01196dbf7b4f3875f70bf03541764e9ebb5df580", "message": "Minor improvements for partitioned output buffers and operator\n\n- Adds fast path for partitioning without constant arguments\n- Simplify iterating through PartitionedOutputBuffer pages to one\npass\n- Use known-size builders where possible", "committedDate": "2020-10-16T11:16:09Z", "type": "forcePushed"}, {"oid": "460d6ce32dc20bbb5062107b6dc9d841ffa2886e", "url": "https://github.com/prestodb/presto/commit/460d6ce32dc20bbb5062107b6dc9d841ffa2886e", "message": "Minor improvements for partitioned output buffers and operator\n\n- Adds fast path for partitioning without constant arguments\n- Simplify iterating through PartitionedOutputBuffer pages to one\npass\n- Use known-size builders where possible", "committedDate": "2020-10-16T11:33:03Z", "type": "commit"}, {"oid": "460d6ce32dc20bbb5062107b6dc9d841ffa2886e", "url": "https://github.com/prestodb/presto/commit/460d6ce32dc20bbb5062107b6dc9d841ffa2886e", "message": "Minor improvements for partitioned output buffers and operator\n\n- Adds fast path for partitioning without constant arguments\n- Simplify iterating through PartitionedOutputBuffer pages to one\npass\n- Use known-size builders where possible", "committedDate": "2020-10-16T11:33:03Z", "type": "forcePushed"}]}