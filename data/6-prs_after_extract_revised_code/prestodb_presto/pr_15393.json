{"pr_number": 15393, "pr_title": "Make query result HTTP response compression configurable", "pr_createdAt": "2020-11-03T22:14:10Z", "pr_url": "https://github.com/prestodb/presto/pull/15393", "timeline": [{"oid": "eee98d45dc0070cbdbd43d3d295092251b72ebff", "url": "https://github.com/prestodb/presto/commit/eee98d45dc0070cbdbd43d3d295092251b72ebff", "message": "Make query result HTTP compression server configurable\n\nAllows configuring HTTP response compression for the query results\nendpoints at the server level, regardless of client configuration.", "committedDate": "2020-11-04T16:03:37Z", "type": "forcePushed"}, {"oid": "8731ada1fa220b5dfb2ede0e9c05de142270b227", "url": "https://github.com/prestodb/presto/commit/8731ada1fa220b5dfb2ede0e9c05de142270b227", "message": "Make query result HTTP compression server configurable\n\nAllows configuring HTTP response compression for the query results\nendpoints at the server level, regardless of client configuration.", "committedDate": "2020-11-16T15:01:37Z", "type": "forcePushed"}, {"oid": "46d990c2c01faa7e492e07f2a05942d8608bb6a6", "url": "https://github.com/prestodb/presto/commit/46d990c2c01faa7e492e07f2a05942d8608bb6a6", "message": "Make query result HTTP compression server configurable\n\nAllows configuring HTTP response compression for the query results\nendpoints at the server level, regardless of client configuration.", "committedDate": "2020-11-16T16:05:22Z", "type": "forcePushed"}, {"oid": "a6f5f5b385288ddaacd318b96cf9250f9cf125d1", "url": "https://github.com/prestodb/presto/commit/a6f5f5b385288ddaacd318b96cf9250f9cf125d1", "message": "Make query result HTTP compression server configurable\n\nAllows configuring HTTP response compression for the query results\nendpoints at the server level, regardless of client configuration.", "committedDate": "2020-11-19T19:23:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAwMTIyNQ==", "url": "https://github.com/prestodb/presto/pull/15393#discussion_r528001225", "bodyText": "Can we instead use compressionEnabled? Disabled would incur one more flip in mind :)", "author": "shixuan-fan", "createdAt": "2020-11-20T22:19:13Z", "path": "presto-client/src/main/java/com/facebook/presto/client/ClientSession.java", "diffHunk": "@@ -51,6 +51,7 @@\n     private final Map<String, String> extraCredentials;\n     private final String transactionId;\n     private final Duration clientRequestTimeout;\n+    private final boolean compressionDisabled;", "originalCommit": "a6f5f5b385288ddaacd318b96cf9250f9cf125d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAwMzU2NA==", "url": "https://github.com/prestodb/presto/pull/15393#discussion_r528003564", "bodyText": "The phrasing is a little weird, but the mechanism here doesn't actually let you force compression- only disable compression. Same thing with the server side logic. Default negotiation happens inside of jetty around the client Accept-Encoding header and server's chosen mime-type and Content-Encoding headers.", "author": "pettyjamesm", "createdAt": "2020-11-20T22:26:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAwMTIyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAyNzc4Nw==", "url": "https://github.com/prestodb/presto/pull/15393#discussion_r528027787", "bodyText": "I see. But we could probably just flip the boolean when it is used? I'm just worried this might be error-prone.", "author": "shixuan-fan", "createdAt": "2020-11-20T23:45:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAwMTIyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAzMDA3Mg==", "url": "https://github.com/prestodb/presto/pull/15393#discussion_r528030072", "bodyText": "In general I\u2019m worried about the impression that \u201cenabled\u201d will give. To me, that sounds like the client has ultimate control of the decision when in fact, they do not. The client only as the option to opt-out of compression.", "author": "pettyjamesm", "createdAt": "2020-11-20T23:55:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAwMTIyNQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAwMjE1Ng==", "url": "https://github.com/prestodb/presto/pull/15393#discussion_r528002156", "bodyText": "I understand that we are trying to reduce duplicate code, but passing compressionEnabled  to withCompressionEnabled is a bit weird and sounds like this should be done outside.", "author": "shixuan-fan", "createdAt": "2020-11-20T22:21:44Z", "path": "presto-main/src/main/java/com/facebook/presto/server/protocol/QueuedStatementResource.java", "diffHunk": "@@ -380,7 +392,7 @@ public synchronized QueryResults getInitialQueryResults(UriInfo uriInfo, String\n                             uriInfo,\n                             xForwardedProto,\n                             DispatchInfo.queued(NO_DURATION, NO_DURATION));\n-                    return immediateFuture(Response.ok(queryResults).build());\n+                    return immediateFuture(withCompressionEnabled(Response.ok(queryResults), compressionEnabled).build());", "originalCommit": "a6f5f5b385288ddaacd318b96cf9250f9cf125d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAwNDUyOQ==", "url": "https://github.com/prestodb/presto/pull/15393#discussion_r528004529", "bodyText": "Maybe: withCompressionConfiguration(Response.Builder builder, boolean compressionDisabled) ?", "author": "pettyjamesm", "createdAt": "2020-11-20T22:28:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAwMjE1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAyNzgwMw==", "url": "https://github.com/prestodb/presto/pull/15393#discussion_r528027803", "bodyText": "Yeah that seems better :D", "author": "shixuan-fan", "createdAt": "2020-11-20T23:45:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAwMjE1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "27bf9be72be26cfe9ad9d6a07a51a407ee19a305", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/server/protocol/QueuedStatementResource.java b/presto-main/src/main/java/com/facebook/presto/server/protocol/QueuedStatementResource.java\nindex 6fc2b291e0..cf8d4be544 100644\n--- a/presto-main/src/main/java/com/facebook/presto/server/protocol/QueuedStatementResource.java\n+++ b/presto-main/src/main/java/com/facebook/presto/server/protocol/QueuedStatementResource.java\n\n@@ -392,7 +380,7 @@ public class QueuedStatementResource\n                             uriInfo,\n                             xForwardedProto,\n                             DispatchInfo.queued(NO_DURATION, NO_DURATION));\n-                    return immediateFuture(withCompressionEnabled(Response.ok(queryResults), compressionEnabled).build());\n+                    return immediateFuture(Response.ok(queryResults).build());\n                 }\n             }\n \n"}}, {"oid": "27bf9be72be26cfe9ad9d6a07a51a407ee19a305", "url": "https://github.com/prestodb/presto/commit/27bf9be72be26cfe9ad9d6a07a51a407ee19a305", "message": "Make query result HTTP compression client configurable\n\nBy default, presto will GZIP query result JSON payloads sent to the\nclient. However, especially when the client is connected to the\ncoordinator over localhost, the added overhead of compressing the\nresponse and then uncompressing it on the client is a losing\nproposition.\n\nFor queries that are bound only by result processing throughput (eg:\nSELECT * FROM <large table>) execution time can reduced by 20-50%\nwhen submitted over a localhost connection with compression disabled.", "committedDate": "2020-11-23T14:09:11Z", "type": "commit"}, {"oid": "33afb0cb732894a1c25e9c19bf855f381ab52a61", "url": "https://github.com/prestodb/presto/commit/33afb0cb732894a1c25e9c19bf855f381ab52a61", "message": "Make query result HTTP compression server configurable\n\nAllows configuring HTTP response compression for the query results\nendpoints at the server level, regardless of client configuration.", "committedDate": "2020-11-23T14:14:03Z", "type": "commit"}, {"oid": "33afb0cb732894a1c25e9c19bf855f381ab52a61", "url": "https://github.com/prestodb/presto/commit/33afb0cb732894a1c25e9c19bf855f381ab52a61", "message": "Make query result HTTP compression server configurable\n\nAllows configuring HTTP response compression for the query results\nendpoints at the server level, regardless of client configuration.", "committedDate": "2020-11-23T14:14:03Z", "type": "forcePushed"}]}