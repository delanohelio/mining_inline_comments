{"pr_number": 14176, "pr_title": "Improve determinism analysis of queries with top-level LIMIT clause", "pr_createdAt": "2020-02-28T01:54:04Z", "pr_url": "https://github.com/prestodb/presto/pull/14176", "timeline": [{"oid": "dcbac5f01cb6934f1bb3b8d044f44bb601fa15a4", "url": "https://github.com/prestodb/presto/commit/dcbac5f01cb6934f1bb3b8d044f44bb601fa15a4", "message": "Fix and improve performance for limit query determinism analysis\n\n- Do not run analysis for queries with LIMIT ALL clause\n- If row count is less than the limit and row count has changed,\n  FAILED_DATA_CHANGED should be the conclusion instead of\n  NON_DETERMINISTIC.\n- Use a LIMIT n+1 query instead of a query without LIMIT clause.", "committedDate": "2020-02-28T01:55:23Z", "type": "forcePushed"}, {"oid": "2d79dd15a88a08f135824fa00734667f5743ca1c", "url": "https://github.com/prestodb/presto/commit/2d79dd15a88a08f135824fa00734667f5743ca1c", "message": "Fix and improve performance for limit query determinism analysis\n\n- Do not run analysis for queries with LIMIT ALL clause\n- If row count is less than the limit and row count has changed,\n  FAILED_DATA_CHANGED should be the conclusion instead of\n  NON_DETERMINISTIC.\n- Use a LIMIT n+1 query instead of a query without LIMIT clause.", "committedDate": "2020-02-28T02:54:46Z", "type": "forcePushed"}, {"oid": "7943e09894206cdea8dbec0d96632776aed653a1", "url": "https://github.com/prestodb/presto/commit/7943e09894206cdea8dbec0d96632776aed653a1", "message": "Fix and improve performance for limit query determinism analysis\n\n- Do not run analysis for queries with LIMIT ALL clause\n- If row count is less than the limit and row count has changed,\n  FAILED_DATA_CHANGED should be the conclusion instead of\n  NON_DETERMINISTIC.\n- Use a LIMIT n+1 query instead of a query without LIMIT clause.", "committedDate": "2020-02-28T06:11:33Z", "type": "forcePushed"}, {"oid": "42062c906187e255d792aaab6650869679e7a728", "url": "https://github.com/prestodb/presto/commit/42062c906187e255d792aaab6650869679e7a728", "message": "Fix and improve performance for limit query determinism analysis\n\n- Do not run analysis for queries with LIMIT ALL clause\n- If row count is less than the limit and row count has changed,\n  FAILED_DATA_CHANGED should be the conclusion instead of\n  NON_DETERMINISTIC.\n- Use a LIMIT n+1 query instead of a query without LIMIT clause.", "committedDate": "2020-02-28T06:13:59Z", "type": "forcePushed"}, {"oid": "9eec1819e1661dda18d1f426ffb45f0dbfb29c3f", "url": "https://github.com/prestodb/presto/commit/9eec1819e1661dda18d1f426ffb45f0dbfb29c3f", "message": "Fix and improve performance for limit query determinism analysis\n\n- Do not run analysis for queries with LIMIT ALL clause\n- If row count is less than the limit and row count has changed,\n  FAILED_DATA_CHANGED should be the conclusion instead of\n  NON_DETERMINISTIC.\n- Use a LIMIT n+1 query instead of a query without LIMIT clause.", "committedDate": "2020-02-28T06:16:23Z", "type": "forcePushed"}, {"oid": "af06b58ffd007eead6414af47396303307731b3b", "url": "https://github.com/prestodb/presto/commit/af06b58ffd007eead6414af47396303307731b3b", "message": "Restructure LimitQueryDeterminismAnalyzer", "committedDate": "2020-02-28T06:18:30Z", "type": "forcePushed"}, {"oid": "e8b9c5d3c05e64d6208af5506cee84941010ee19", "url": "https://github.com/prestodb/presto/commit/e8b9c5d3c05e64d6208af5506cee84941010ee19", "message": "Support determinism analysis for ORDER BY LIMIT queries", "committedDate": "2020-02-28T07:48:45Z", "type": "forcePushed"}, {"oid": "b492938308478a6b3783fd2822c7b43e30a500f8", "url": "https://github.com/prestodb/presto/commit/b492938308478a6b3783fd2822c7b43e30a500f8", "message": "Support determinism analysis for ORDER BY LIMIT queries", "committedDate": "2020-02-28T07:57:57Z", "type": "forcePushed"}, {"oid": "ade7bd8873e7bebb853e359b369f95b3c9ba0792", "url": "https://github.com/prestodb/presto/commit/ade7bd8873e7bebb853e359b369f95b3c9ba0792", "message": "Support determinism analysis for ORDER BY LIMIT queries", "committedDate": "2020-02-28T08:32:01Z", "type": "forcePushed"}, {"oid": "9abd37d7498247e8c795be8acafc2444644a789f", "url": "https://github.com/prestodb/presto/commit/9abd37d7498247e8c795be8acafc2444644a789f", "message": "Fix and improve performance for limit query determinism analysis\n\n- Do not run analysis for queries with LIMIT ALL clause\n- If row count is less than the limit and row count has changed,\n  FAILED_DATA_CHANGED should be the conclusion instead of\n  NON_DETERMINISTIC.\n- Use a LIMIT n+1 query instead of a query without LIMIT clause.", "committedDate": "2020-02-28T07:57:56Z", "type": "forcePushed"}, {"oid": "7a55630cdf50561657dae9ffc30c110533c1ba61", "url": "https://github.com/prestodb/presto/commit/7a55630cdf50561657dae9ffc30c110533c1ba61", "message": "Fix and improve performance for limit query determinism analysis\n\n- Do not run analysis for queries with LIMIT ALL clause\n- If row count is less than the limit and row count has changed,\n  FAILED_DATA_CHANGED should be the conclusion instead of\n  NON_DETERMINISTIC.\n- Use a LIMIT n+1 query instead of a query without LIMIT clause.", "committedDate": "2020-02-28T08:33:41Z", "type": "forcePushed"}, {"oid": "6bd1d7eee241c576eb9e39ed75ffb0bbadcec396", "url": "https://github.com/prestodb/presto/commit/6bd1d7eee241c576eb9e39ed75ffb0bbadcec396", "message": "Fix and improve performance for limit query determinism analysis\n\n- Do not run analysis for queries with LIMIT ALL clause\n- If row count is less than the limit and row count has changed,\n  FAILED_DATA_CHANGED should be the conclusion instead of\n  NON_DETERMINISTIC.\n- Use a LIMIT n + 1 query instead of a query without LIMIT clause,\n  which is more efficient and less likely to fail.", "committedDate": "2020-02-28T08:37:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTYwNDczMA==", "url": "https://github.com/prestodb/presto/pull/14176#discussion_r385604730", "bodyText": "nit: check that rowCount > 0", "author": "mbasmanova", "createdAt": "2020-02-28T09:59:21Z", "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/framework/LimitQueryDeterminismAnalyzer.java", "diffHunk": "@@ -45,26 +45,37 @@\n     private final PrestoAction prestoAction;\n     private final boolean enabled;\n \n-    public LimitQueryDeterminismAnalyzer(PrestoAction prestoAction, boolean enabled)\n+    private final Statement statement;\n+    private final long rowCount;\n+    private final VerificationContext verificationContext;\n+\n+    public LimitQueryDeterminismAnalyzer(\n+            PrestoAction prestoAction,\n+            boolean enabled,\n+            Statement statement,\n+            long rowCount,\n+            VerificationContext verificationContext)\n     {\n         this.prestoAction = requireNonNull(prestoAction, \"prestoAction is null\");\n         this.enabled = enabled;\n+        this.statement = requireNonNull(statement, \"statement is null\");\n+        this.rowCount = rowCount;", "originalCommit": "a2f984fd6fdc0cdf063d5de1cff6908711ebe17a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "aa7673911e018ed835bff91cf778bc106ee658ef", "chunk": "diff --git a/presto-verifier/src/main/java/com/facebook/presto/verifier/framework/LimitQueryDeterminismAnalyzer.java b/presto-verifier/src/main/java/com/facebook/presto/verifier/framework/LimitQueryDeterminismAnalyzer.java\nindex c58d6f3d3b..a3be6f497d 100644\n--- a/presto-verifier/src/main/java/com/facebook/presto/verifier/framework/LimitQueryDeterminismAnalyzer.java\n+++ b/presto-verifier/src/main/java/com/facebook/presto/verifier/framework/LimitQueryDeterminismAnalyzer.java\n\n@@ -59,6 +60,7 @@ public class LimitQueryDeterminismAnalyzer\n         this.prestoAction = requireNonNull(prestoAction, \"prestoAction is null\");\n         this.enabled = enabled;\n         this.statement = requireNonNull(statement, \"statement is null\");\n+        checkArgument(rowCount >= 0, \"rowCount is negative: %s\", rowCount);\n         this.rowCount = rowCount;\n         this.verificationContext = requireNonNull(verificationContext, \"verificationContext is null\");\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTYwNjIxOA==", "url": "https://github.com/prestodb/presto/pull/14176#discussion_r385606218", "bodyText": "nit: move Pattern.compile(\"all\", CASE_INSENSITIVE) into a static variable to avoid re-compiling on each call", "author": "mbasmanova", "createdAt": "2020-02-28T10:02:12Z", "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/framework/LimitQueryDeterminismAnalyzer.java", "diffHunk": "@@ -135,29 +148,34 @@ private LimitQueryDeterminismAnalysis analyzeQuerySpecification(Optional<With> w\n                         querySpecification.getGroupBy(),\n                         querySpecification.getHaving(),\n                         Optional.empty(),\n-                        Optional.empty()),\n+                        newLimit),\n                 Optional.empty(),\n                 Optional.empty());\n-        return analyzeLimitNoOrderBy(queryNoLimit);\n+        return analyzeLimitNoOrderBy(newLimitQuery, limit);\n     }\n \n-    private LimitQueryDeterminismAnalysis analyzeLimitNoOrderBy(Query queryNoLimit)\n+    private LimitQueryDeterminismAnalysis analyzeLimitNoOrderBy(Query newLimitQuery, long limit)\n     {\n         Query rowCountQuery = simpleQuery(\n                 new Select(false, ImmutableList.of(new SingleColumn(new FunctionCall(QualifiedName.of(\"count\"), ImmutableList.of(new LongLiteral(\"1\")))))),\n-                new TableSubquery(queryNoLimit));\n+                new TableSubquery(newLimitQuery));\n \n         QueryResult<Long> result = callWithQueryStatsConsumer(\n                 () -> prestoAction.execute(rowCountQuery, DETERMINISM_ANALYSIS, resultSet -> resultSet.getLong(1)),\n                 stats -> verificationContext.setLimitQueryAnalysisQueryId(stats.getQueryId()));\n \n         long rowCountNoLimit = getOnlyElement(result.getResults());\n-        if (rowCountNoLimit > rowCount) {\n-            return NON_DETERMINISTIC;\n-        }\n         if (rowCountNoLimit == rowCount) {\n             return DETERMINISTIC;\n         }\n+        if (rowCount >= limit && rowCountNoLimit > rowCount) {\n+            return NON_DETERMINISTIC;\n+        }\n         return FAILED_DATA_CHANGED;\n     }\n+\n+    private static boolean isLimitAll(String limitClause)\n+    {\n+        return Pattern.compile(\"all\", CASE_INSENSITIVE).matcher(limitClause).matches();", "originalCommit": "6bd1d7eee241c576eb9e39ed75ffb0bbadcec396", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkyOTA0OA==", "url": "https://github.com/prestodb/presto/pull/14176#discussion_r385929048", "bodyText": "Replaced with a simpler implementation:\nlimitClause.toLowerCase(ENGLISH).equals(\"all\");", "author": "caithagoras", "createdAt": "2020-02-28T21:24:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTYwNjIxOA=="}], "type": "inlineReview", "revised_code": {"commit": "aa7673911e018ed835bff91cf778bc106ee658ef", "chunk": "diff --git a/presto-verifier/src/main/java/com/facebook/presto/verifier/framework/LimitQueryDeterminismAnalyzer.java b/presto-verifier/src/main/java/com/facebook/presto/verifier/framework/LimitQueryDeterminismAnalyzer.java\nindex 915fa1c2f5..a3be6f497d 100644\n--- a/presto-verifier/src/main/java/com/facebook/presto/verifier/framework/LimitQueryDeterminismAnalyzer.java\n+++ b/presto-verifier/src/main/java/com/facebook/presto/verifier/framework/LimitQueryDeterminismAnalyzer.java\n\n@@ -148,34 +137,29 @@ public class LimitQueryDeterminismAnalyzer\n                         querySpecification.getGroupBy(),\n                         querySpecification.getHaving(),\n                         Optional.empty(),\n-                        newLimit),\n+                        Optional.empty()),\n                 Optional.empty(),\n                 Optional.empty());\n-        return analyzeLimitNoOrderBy(newLimitQuery, limit);\n+        return analyzeLimitNoOrderBy(queryNoLimit);\n     }\n \n-    private LimitQueryDeterminismAnalysis analyzeLimitNoOrderBy(Query newLimitQuery, long limit)\n+    private LimitQueryDeterminismAnalysis analyzeLimitNoOrderBy(Query queryNoLimit)\n     {\n         Query rowCountQuery = simpleQuery(\n                 new Select(false, ImmutableList.of(new SingleColumn(new FunctionCall(QualifiedName.of(\"count\"), ImmutableList.of(new LongLiteral(\"1\")))))),\n-                new TableSubquery(newLimitQuery));\n+                new TableSubquery(queryNoLimit));\n \n         QueryResult<Long> result = callWithQueryStatsConsumer(\n                 () -> prestoAction.execute(rowCountQuery, DETERMINISM_ANALYSIS, resultSet -> resultSet.getLong(1)),\n                 stats -> verificationContext.setLimitQueryAnalysisQueryId(stats.getQueryId()));\n \n         long rowCountNoLimit = getOnlyElement(result.getResults());\n+        if (rowCountNoLimit > rowCount) {\n+            return NON_DETERMINISTIC;\n+        }\n         if (rowCountNoLimit == rowCount) {\n             return DETERMINISTIC;\n         }\n-        if (rowCount >= limit && rowCountNoLimit > rowCount) {\n-            return NON_DETERMINISTIC;\n-        }\n         return FAILED_DATA_CHANGED;\n     }\n-\n-    private static boolean isLimitAll(String limitClause)\n-    {\n-        return Pattern.compile(\"all\", CASE_INSENSITIVE).matcher(limitClause).matches();\n-    }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTYwNzA5OA==", "url": "https://github.com/prestodb/presto/pull/14176#discussion_r385607098", "bodyText": "nit: perhaps, rename rowCountNoLimit to avoid suggesting that the query had no limit, but rather a higher limit\nrowCountHigherLimit", "author": "mbasmanova", "createdAt": "2020-02-28T10:03:56Z", "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/framework/LimitQueryDeterminismAnalyzer.java", "diffHunk": "@@ -135,29 +148,34 @@ private LimitQueryDeterminismAnalysis analyzeQuerySpecification(Optional<With> w\n                         querySpecification.getGroupBy(),\n                         querySpecification.getHaving(),\n                         Optional.empty(),\n-                        Optional.empty()),\n+                        newLimit),\n                 Optional.empty(),\n                 Optional.empty());\n-        return analyzeLimitNoOrderBy(queryNoLimit);\n+        return analyzeLimitNoOrderBy(newLimitQuery, limit);\n     }\n \n-    private LimitQueryDeterminismAnalysis analyzeLimitNoOrderBy(Query queryNoLimit)\n+    private LimitQueryDeterminismAnalysis analyzeLimitNoOrderBy(Query newLimitQuery, long limit)\n     {\n         Query rowCountQuery = simpleQuery(\n                 new Select(false, ImmutableList.of(new SingleColumn(new FunctionCall(QualifiedName.of(\"count\"), ImmutableList.of(new LongLiteral(\"1\")))))),\n-                new TableSubquery(queryNoLimit));\n+                new TableSubquery(newLimitQuery));\n \n         QueryResult<Long> result = callWithQueryStatsConsumer(\n                 () -> prestoAction.execute(rowCountQuery, DETERMINISM_ANALYSIS, resultSet -> resultSet.getLong(1)),\n                 stats -> verificationContext.setLimitQueryAnalysisQueryId(stats.getQueryId()));\n \n         long rowCountNoLimit = getOnlyElement(result.getResults());", "originalCommit": "6bd1d7eee241c576eb9e39ed75ffb0bbadcec396", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "aa7673911e018ed835bff91cf778bc106ee658ef", "chunk": "diff --git a/presto-verifier/src/main/java/com/facebook/presto/verifier/framework/LimitQueryDeterminismAnalyzer.java b/presto-verifier/src/main/java/com/facebook/presto/verifier/framework/LimitQueryDeterminismAnalyzer.java\nindex 915fa1c2f5..a3be6f497d 100644\n--- a/presto-verifier/src/main/java/com/facebook/presto/verifier/framework/LimitQueryDeterminismAnalyzer.java\n+++ b/presto-verifier/src/main/java/com/facebook/presto/verifier/framework/LimitQueryDeterminismAnalyzer.java\n\n@@ -148,34 +137,29 @@ public class LimitQueryDeterminismAnalyzer\n                         querySpecification.getGroupBy(),\n                         querySpecification.getHaving(),\n                         Optional.empty(),\n-                        newLimit),\n+                        Optional.empty()),\n                 Optional.empty(),\n                 Optional.empty());\n-        return analyzeLimitNoOrderBy(newLimitQuery, limit);\n+        return analyzeLimitNoOrderBy(queryNoLimit);\n     }\n \n-    private LimitQueryDeterminismAnalysis analyzeLimitNoOrderBy(Query newLimitQuery, long limit)\n+    private LimitQueryDeterminismAnalysis analyzeLimitNoOrderBy(Query queryNoLimit)\n     {\n         Query rowCountQuery = simpleQuery(\n                 new Select(false, ImmutableList.of(new SingleColumn(new FunctionCall(QualifiedName.of(\"count\"), ImmutableList.of(new LongLiteral(\"1\")))))),\n-                new TableSubquery(newLimitQuery));\n+                new TableSubquery(queryNoLimit));\n \n         QueryResult<Long> result = callWithQueryStatsConsumer(\n                 () -> prestoAction.execute(rowCountQuery, DETERMINISM_ANALYSIS, resultSet -> resultSet.getLong(1)),\n                 stats -> verificationContext.setLimitQueryAnalysisQueryId(stats.getQueryId()));\n \n         long rowCountNoLimit = getOnlyElement(result.getResults());\n+        if (rowCountNoLimit > rowCount) {\n+            return NON_DETERMINISTIC;\n+        }\n         if (rowCountNoLimit == rowCount) {\n             return DETERMINISTIC;\n         }\n-        if (rowCount >= limit && rowCountNoLimit > rowCount) {\n-            return NON_DETERMINISTIC;\n-        }\n         return FAILED_DATA_CHANGED;\n     }\n-\n-    private static boolean isLimitAll(String limitClause)\n-    {\n-        return Pattern.compile(\"all\", CASE_INSENSITIVE).matcher(limitClause).matches();\n-    }\n }\n"}}, {"oid": "aa7673911e018ed835bff91cf778bc106ee658ef", "url": "https://github.com/prestodb/presto/commit/aa7673911e018ed835bff91cf778bc106ee658ef", "message": "Restructure LimitQueryDeterminismAnalyzer\n\n- Break handling of Query and QuerySpecification into two methods.\n- Decouple test methods by removing shared fields.\n- Rename test methods.", "committedDate": "2020-02-28T21:26:11Z", "type": "commit"}, {"oid": "caaa14f80fd840779140c591b79ddcb8f2402498", "url": "https://github.com/prestodb/presto/commit/caaa14f80fd840779140c591b79ddcb8f2402498", "message": "Fix and improve performance for limit query determinism analysis\n\n- Do not run analysis for queries with LIMIT ALL clause\n- If row count is less than the limit and row count has changed,\n  FAILED_DATA_CHANGED should be the conclusion instead of\n  NON_DETERMINISTIC.\n- Use a LIMIT n + 1 query instead of a query without LIMIT clause,\n  which is more efficient and less likely to fail.", "committedDate": "2020-02-28T21:26:12Z", "type": "forcePushed"}, {"oid": "dd5ea75f1d70c14f23b404546335242ff0b2c89d", "url": "https://github.com/prestodb/presto/commit/dd5ea75f1d70c14f23b404546335242ff0b2c89d", "message": "Fix and improve performance for limit query determinism analysis\n\n- Do not run analysis for queries with LIMIT ALL clause\n- If row count is less than the limit and row count has changed,\n  FAILED_DATA_CHANGED should be the conclusion instead of\n  NON_DETERMINISTIC.\n- Use a LIMIT n + 1 query instead of a query without LIMIT clause,\n  which is more efficient and less likely to fail.", "committedDate": "2020-02-28T21:34:29Z", "type": "forcePushed"}, {"oid": "8095175160872d41564b7b5dde07a614ad59918a", "url": "https://github.com/prestodb/presto/commit/8095175160872d41564b7b5dde07a614ad59918a", "message": "Fix and improve performance for limit query determinism analysis\n\n- Do not run analysis for queries with LIMIT ALL clause\n- If row count is less than the limit and row count has changed,\n  FAILED_DATA_CHANGED should be the conclusion instead of\n  NON_DETERMINISTIC.\n- Use a LIMIT n + 1 query instead of a query without LIMIT clause,\n  which is more efficient and less likely to fail.", "committedDate": "2020-02-28T22:31:52Z", "type": "commit"}, {"oid": "8095175160872d41564b7b5dde07a614ad59918a", "url": "https://github.com/prestodb/presto/commit/8095175160872d41564b7b5dde07a614ad59918a", "message": "Fix and improve performance for limit query determinism analysis\n\n- Do not run analysis for queries with LIMIT ALL clause\n- If row count is less than the limit and row count has changed,\n  FAILED_DATA_CHANGED should be the conclusion instead of\n  NON_DETERMINISTIC.\n- Use a LIMIT n + 1 query instead of a query without LIMIT clause,\n  which is more efficient and less likely to fail.", "committedDate": "2020-02-28T22:31:52Z", "type": "forcePushed"}]}