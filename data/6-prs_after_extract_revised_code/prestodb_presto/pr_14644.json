{"pr_number": 14644, "pr_title": "Fix SingleMapBlock.seekKeyExact bug", "pr_createdAt": "2020-06-12T08:35:08Z", "pr_url": "https://github.com/prestodb/presto/pull/14644", "timeline": [{"oid": "3daa42418fe8db4c3af96aa342860be768b121f4", "url": "https://github.com/prestodb/presto/commit/3daa42418fe8db4c3af96aa342860be768b121f4", "message": "Fix SingleMapBlock.seekKeyExact bug\n\nWhen seeking map key of Slice type, we need to compare the bytes value\nin the key block to the key value. When the current position in the\nkey block is shorter than the key's length, it could return wrong\nresults or IndexOutOfBoundsException. This commit fixes this issue.", "committedDate": "2020-06-12T21:15:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY1MDA5MQ==", "url": "https://github.com/prestodb/presto/pull/14644#discussion_r439650091", "bodyText": "@yingsu00 I don't think I understand how this works. Would you clarify? Perhaps, a unit tests would be easier to understand. What is the very long string here for?", "author": "mbasmanova", "createdAt": "2020-06-12T21:30:04Z", "path": "presto-tests/src/main/java/com/facebook/presto/tests/AbstractTestQueries.java", "diffHunk": "@@ -312,6 +312,11 @@ public void testMapSubscript()\n         assertQuery(\"SELECT map(array['a'], array['aa'])['a']\", \"SELECT 'aa'\");\n         assertQuery(\"SELECT map(array[array[1,1]], array['a'])[array[1,1]]\", \"SELECT 'a'\");\n         assertQuery(\"SELECT map(array[(1,2)], array['a'])[(1,2)]\", \"SELECT 'a'\");\n+\n+        // Force the last value in the key BlockBuilder to the end of the internal Slice, so that searching for longer key values can be tested.\n+        // 'idv_fail' and 'request_fail' has the same hash value.\n+        assertQuery(\"SELECT map(array['0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456', 'idv_fail'], array['aa', 'bb'])['request_fail']\", \"SELECT NULL\");", "originalCommit": "3daa42418fe8db4c3af96aa342860be768b121f4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "59f9529079e9f1d624eab1ac0dac5a83134fad36", "chunk": "diff --git a/presto-tests/src/main/java/com/facebook/presto/tests/AbstractTestQueries.java b/presto-tests/src/main/java/com/facebook/presto/tests/AbstractTestQueries.java\nindex 5735332548..1307bf80bc 100644\n--- a/presto-tests/src/main/java/com/facebook/presto/tests/AbstractTestQueries.java\n+++ b/presto-tests/src/main/java/com/facebook/presto/tests/AbstractTestQueries.java\n\n@@ -312,11 +312,6 @@ public abstract class AbstractTestQueries\n         assertQuery(\"SELECT map(array['a'], array['aa'])['a']\", \"SELECT 'aa'\");\n         assertQuery(\"SELECT map(array[array[1,1]], array['a'])[array[1,1]]\", \"SELECT 'a'\");\n         assertQuery(\"SELECT map(array[(1,2)], array['a'])[(1,2)]\", \"SELECT 'a'\");\n-\n-        // Force the last value in the key BlockBuilder to the end of the internal Slice, so that searching for longer key values can be tested.\n-        // 'idv_fail' and 'request_fail' has the same hash value.\n-        assertQuery(\"SELECT map(array['0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456', 'idv_fail'], array['aa', 'bb'])['request_fail']\", \"SELECT NULL\");\n-        assertQuery(\"SELECT map(array['0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456', 'idv_fail'], array['aa', 'bb'])['idv_fail']\", \"SELECT 'bb'\");\n     }\n \n     @Test\n"}}, {"oid": "59f9529079e9f1d624eab1ac0dac5a83134fad36", "url": "https://github.com/prestodb/presto/commit/59f9529079e9f1d624eab1ac0dac5a83134fad36", "message": "Change BlockBuilder's expectedEntries to be the number of values", "committedDate": "2020-06-13T04:08:59Z", "type": "commit"}, {"oid": "0a18cbc0f86f30fd125cfe42c01eb02bfbe8af2e", "url": "https://github.com/prestodb/presto/commit/0a18cbc0f86f30fd125cfe42c01eb02bfbe8af2e", "message": "Fix SingleMapBlock.seekKeyExact bug\n\nWhen seeking map key of Slice type, we need to compare the bytes value\nin the key block to the key value. When the current position in the\nkey block is shorter than the key's length, it could return wrong\nresults or IndexOutOfBoundsException. This commit fixes this issue.", "committedDate": "2020-06-13T09:45:35Z", "type": "commit"}, {"oid": "0a18cbc0f86f30fd125cfe42c01eb02bfbe8af2e", "url": "https://github.com/prestodb/presto/commit/0a18cbc0f86f30fd125cfe42c01eb02bfbe8af2e", "message": "Fix SingleMapBlock.seekKeyExact bug\n\nWhen seeking map key of Slice type, we need to compare the bytes value\nin the key block to the key value. When the current position in the\nkey block is shorter than the key's length, it could return wrong\nresults or IndexOutOfBoundsException. This commit fixes this issue.", "committedDate": "2020-06-13T09:45:35Z", "type": "forcePushed"}]}