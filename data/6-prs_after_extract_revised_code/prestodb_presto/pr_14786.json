{"pr_number": 14786, "pr_title": "Implement additional serialization methods for Spark shuffle", "pr_createdAt": "2020-07-06T17:58:21Z", "pr_url": "https://github.com/prestodb/presto/pull/14786", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE0NzYxNw==", "url": "https://github.com/prestodb/presto/pull/14786#discussion_r451147617", "bodyText": "nit: should this have @Override?", "author": "wenleix", "createdAt": "2020-07-07T21:15:15Z", "path": "presto-spark-classloader-interface/src/main/java/com/facebook/presto/spark/classloader_interface/PrestoSparkShuffleSerializer.java", "diffHunk": "@@ -78,6 +83,14 @@ public DeserializationStream deserializeStream(InputStream inputStream)\n             throw new UnsupportedOperationException(\"this method is never used by shuffle\");\n         }\n \n+        public <T> T deserialize(byte[] array, int offset, int length, ClassTag<T> classTag)", "originalCommit": "8a3571d55d04115b82cb1448bffbf8688f24a343", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk0OTA1MA==", "url": "https://github.com/prestodb/presto/pull/14786#discussion_r451949050", "bodyText": "Unfortunately this method is not defined in the interface (in the opensource version)", "author": "arhimondr", "createdAt": "2020-07-09T03:55:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE0NzYxNw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE0ODE3Nw==", "url": "https://github.com/prestodb/presto/pull/14786#discussion_r451148177", "bodyText": "curious: when the PrestoSparkMutableRow will be backed by ByteBuffer and when it will be backed by byte[]? -- maybe add a comment to explain it?", "author": "wenleix", "createdAt": "2020-07-07T21:16:23Z", "path": "presto-spark-base/src/main/java/com/facebook/presto/spark/execution/PrestoSparkMutableRowPageInput.java", "diffHunk": "@@ -96,8 +96,16 @@ public Page getNextPage()\n                 Iterator<Tuple2<MutablePartitionId, PrestoSparkMutableRow>> currentIterator = rowIterators.get(currentIteratorIndex);\n                 if (currentIterator.hasNext()) {\n                     PrestoSparkMutableRow row = currentIterator.next()._2;\n-                    ByteBuffer buffer = row.getBuffer();\n-                    output.writeBytes(buffer.array(), buffer.arrayOffset() + buffer.position(), buffer.remaining());\n+                    if (row.getBuffer() != null) {", "originalCommit": "8a3571d55d04115b82cb1448bffbf8688f24a343", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk0OTE5OA==", "url": "https://github.com/prestodb/presto/pull/14786#discussion_r451949198", "bodyText": "I will be backed by byte[] only when deserialized with public <T> T deserialize(byte[] array, int offset, int length, ClassTag<T> classTag)", "author": "arhimondr", "createdAt": "2020-07-09T03:55:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE0ODE3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk1MjUxNw==", "url": "https://github.com/prestodb/presto/pull/14786#discussion_r451952517", "bodyText": "Added more comments", "author": "arhimondr", "createdAt": "2020-07-09T04:09:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE0ODE3Nw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE0ODcxMg==", "url": "https://github.com/prestodb/presto/pull/14786#discussion_r451148712", "bodyText": "when the mutable row is backed by ByteBuffer, will length be set correctly?", "author": "wenleix", "createdAt": "2020-07-07T21:17:22Z", "path": "presto-spark-classloader-interface/src/main/java/com/facebook/presto/spark/classloader_interface/PrestoSparkMutableRow.java", "diffHunk": "@@ -38,6 +43,39 @@ public void setBuffer(ByteBuffer buffer)\n         this.buffer = buffer;\n     }\n \n+    public byte[] getArray()\n+    {\n+        return array;\n+    }\n+\n+    public PrestoSparkMutableRow setArray(byte[] array)\n+    {\n+        this.array = array;\n+        return this;\n+    }\n+\n+    public int getOffset()\n+    {\n+        return offset;\n+    }\n+\n+    public PrestoSparkMutableRow setOffset(int offset)\n+    {\n+        this.offset = offset;\n+        return this;\n+    }\n+\n+    public int getLength()\n+    {\n+        return length;", "originalCommit": "8a3571d55d04115b82cb1448bffbf8688f24a343", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk0OTMwNA==", "url": "https://github.com/prestodb/presto/pull/14786#discussion_r451949304", "bodyText": "No. offset is length is set only when it is backed by the byte[]", "author": "arhimondr", "createdAt": "2020-07-09T03:55:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE0ODcxMg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "f21fcbfc167bad7eaf76d16f2cf178c7fe131dc4", "url": "https://github.com/prestodb/presto/commit/f21fcbfc167bad7eaf76d16f2cf178c7fe131dc4", "message": "Implement additional serialization methods for Spark shuffle", "committedDate": "2020-07-09T04:02:18Z", "type": "commit"}, {"oid": "f21fcbfc167bad7eaf76d16f2cf178c7fe131dc4", "url": "https://github.com/prestodb/presto/commit/f21fcbfc167bad7eaf76d16f2cf178c7fe131dc4", "message": "Implement additional serialization methods for Spark shuffle", "committedDate": "2020-07-09T04:02:18Z", "type": "forcePushed"}]}