{"pr_number": 15444, "pr_title": "Add UDF to map enum value to key", "pr_createdAt": "2020-11-17T00:39:56Z", "pr_url": "https://github.com/prestodb/presto/pull/15444", "timeline": [{"oid": "d5128f2e660d2ffdff9f6e221451b113d1f3f7b9", "url": "https://github.com/prestodb/presto/commit/d5128f2e660d2ffdff9f6e221451b113d1f3f7b9", "message": "Add UDF to map enum value to key", "committedDate": "2020-11-17T17:02:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQxODAzMQ==", "url": "https://github.com/prestodb/presto/pull/15444#discussion_r526418031", "bodyText": "If you want to further improve the performance, we can make this map lazily instantiated. Add an AtomicBoolean to mark whether the map is instantiated, and create it on first call of getKeyForValue. That way, if the query doesn't need it, you don't need to create this.", "author": "rongrong", "createdAt": "2020-11-18T21:02:06Z", "path": "presto-common/src/main/java/com/facebook/presto/common/type/LongEnumType.java", "diffHunk": "@@ -72,12 +80,15 @@ public String getDisplayName()\n     public static class LongEnumMap\n     {\n         private final Map<String, Long> enumMap;\n+        private final Map<Long, String> flippedEnumMap;\n \n         @JsonCreator\n         public LongEnumMap(@JsonProperty(\"enumMap\") Map<String, Long> enumMap)\n         {\n             validateEnumMap(enumMap);\n             this.enumMap = normalizeEnumMap(enumMap);\n+            this.flippedEnumMap = this.enumMap.entrySet().stream()", "originalCommit": "d5128f2e660d2ffdff9f6e221451b113d1f3f7b9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a377190c7bf4193740ce6dfe448c5c7a0ded6d41", "chunk": "diff --git a/presto-common/src/main/java/com/facebook/presto/common/type/LongEnumType.java b/presto-common/src/main/java/com/facebook/presto/common/type/LongEnumType.java\nindex aa39d19144..dc39cbe9d5 100644\n--- a/presto-common/src/main/java/com/facebook/presto/common/type/LongEnumType.java\n+++ b/presto-common/src/main/java/com/facebook/presto/common/type/LongEnumType.java\n\n@@ -80,15 +81,15 @@ public class LongEnumType\n     public static class LongEnumMap\n     {\n         private final Map<String, Long> enumMap;\n-        private final Map<Long, String> flippedEnumMap;\n+        private Map<Long, String> flippedEnumMap;\n+        private final AtomicBoolean isFlippedEnumComputed = new AtomicBoolean();\n \n         @JsonCreator\n         public LongEnumMap(@JsonProperty(\"enumMap\") Map<String, Long> enumMap)\n         {\n             validateEnumMap(enumMap);\n             this.enumMap = normalizeEnumMap(enumMap);\n-            this.flippedEnumMap = this.enumMap.entrySet().stream()\n-                    .collect(toMap(Map.Entry::getValue, Map.Entry::getKey));\n+            this.flippedEnumMap = null;\n         }\n \n         @JsonProperty\n"}}, {"oid": "a377190c7bf4193740ce6dfe448c5c7a0ded6d41", "url": "https://github.com/prestodb/presto/commit/a377190c7bf4193740ce6dfe448c5c7a0ded6d41", "message": "Add UDF to map enum value to key", "committedDate": "2020-11-19T04:15:21Z", "type": "commit"}, {"oid": "a377190c7bf4193740ce6dfe448c5c7a0ded6d41", "url": "https://github.com/prestodb/presto/commit/a377190c7bf4193740ce6dfe448c5c7a0ded6d41", "message": "Add UDF to map enum value to key", "committedDate": "2020-11-19T04:15:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA2OTgzMw==", "url": "https://github.com/prestodb/presto/pull/15444#discussion_r527069833", "bodyText": "You can simply use the existing guava feature.\nprivate Supplier<Map<Long, String>> flippedEnumMap = Supplier.memorize(this::getKeyForValue);\naccording to its Javadoc\n\nReturns a supplier which caches the instance retrieved during the first call to {@code get()} and returns that value on subsequent calls to {@code get()}", "author": "caithagoras", "createdAt": "2020-11-19T17:30:39Z", "path": "presto-common/src/main/java/com/facebook/presto/common/type/LongEnumType.java", "diffHunk": "@@ -72,12 +81,15 @@ public String getDisplayName()\n     public static class LongEnumMap\n     {\n         private final Map<String, Long> enumMap;\n+        private Map<Long, String> flippedEnumMap;\n+        private final AtomicBoolean isFlippedEnumComputed = new AtomicBoolean();", "originalCommit": "a377190c7bf4193740ce6dfe448c5c7a0ded6d41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzIxNTM1OA==", "url": "https://github.com/prestodb/presto/pull/15444#discussion_r527215358", "bodyText": "same problem there \u2013 guava isn't a runtime dependency of presto-common", "author": "daniel-ohayon", "createdAt": "2020-11-19T21:36:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA2OTgzMw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA3MzU5Nw==", "url": "https://github.com/prestodb/presto/pull/15444#discussion_r527073597", "bodyText": "Have we considered using a BiMap? e.g. ImmutableBiMap.", "author": "caithagoras", "createdAt": "2020-11-19T17:36:26Z", "path": "presto-common/src/main/java/com/facebook/presto/common/type/LongEnumType.java", "diffHunk": "@@ -72,12 +81,15 @@ public String getDisplayName()\n     public static class LongEnumMap\n     {\n         private final Map<String, Long> enumMap;\n+        private Map<Long, String> flippedEnumMap;", "originalCommit": "a377190c7bf4193740ce6dfe448c5c7a0ded6d41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzIxMzQ5MA==", "url": "https://github.com/prestodb/presto/pull/15444#discussion_r527213490", "bodyText": "I tried that but that requires adding a maven dependency, and since this code lives in presto-common, that is not desirable", "author": "daniel-ohayon", "createdAt": "2020-11-19T21:34:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA3MzU5Nw=="}], "type": "inlineReview", "revised_code": null}]}