{"pr_number": 15563, "pr_title": "Introduce UserDefinedType", "pr_createdAt": "2020-12-28T19:37:34Z", "pr_url": "https://github.com/prestodb/presto/pull/15563", "timeline": [{"oid": "778544c9379d07a8e168bbb9613751b53020a0a2", "url": "https://github.com/prestodb/presto/commit/778544c9379d07a8e168bbb9613751b53020a0a2", "message": "Introduce SemanticType\n\nExternal dynamic types supported through FunctionNamespaceManager should only\nmanage semantic types because the external system cannot provide block level\nAPIs. Introduce the concept of SemanticType and only expose this to\nFunctionNamespaceManager.\n\nSemanticType is named type that's based on an actual physical type. We use\nTypeSignature to represent the physical type. It should be verified that\nthis TypeSignature represents a static type.", "committedDate": "2020-12-28T22:27:12Z", "type": "forcePushed"}, {"oid": "ada75697f3cc93f54317160fc3c15d97ad2f661d", "url": "https://github.com/prestodb/presto/commit/ada75697f3cc93f54317160fc3c15d97ad2f661d", "message": "Introduce SemanticType\n\nExternal dynamic types supported through FunctionNamespaceManager should only\nmanage semantic types because the external system cannot provide block level\nAPIs. Introduce the concept of SemanticType and only expose this to\nFunctionNamespaceManager.\n\nSemanticType is named type that's based on an actual physical type. We use\nTypeSignature to represent the physical type. It should be verified that\nthis TypeSignature represents a static type.", "committedDate": "2020-12-28T22:29:51Z", "type": "forcePushed"}, {"oid": "1d99bdac40cc211e75f15cb55e06dd1a527d2506", "url": "https://github.com/prestodb/presto/commit/1d99bdac40cc211e75f15cb55e06dd1a527d2506", "message": "Introduce SemanticType\n\nExternal dynamic types supported through FunctionNamespaceManager should only\nmanage semantic types because the external system cannot provide block level\nAPIs. Introduce the concept of SemanticType and only expose this to\nFunctionNamespaceManager.\n\nSemanticType is named type that's based on an actual physical type. We use\nTypeSignature to represent the physical type. It should be verified that\nthis TypeSignature represents a static type.\n\nWe also changed the format of enum type signature from\n`typename(enum:type{enum_map})` to `enumtype(typename{enum_map})` so enum types\ncan behave the same way as other builtin parametric types that's fully managed\nby BuiltInTypeAndFunctionNamespaceManager.", "committedDate": "2020-12-30T23:00:12Z", "type": "forcePushed"}, {"oid": "8b10ac847fc321149cfb43b1d7b51e1289359b0c", "url": "https://github.com/prestodb/presto/commit/8b10ac847fc321149cfb43b1d7b51e1289359b0c", "message": "Rename LongEnumType to BigintEnumType\n\nChange the type name to be more consistent with the standard type names\nbecause the type name could show up in user-facing error messages.", "committedDate": "2020-12-30T23:23:04Z", "type": "forcePushed"}, {"oid": "140703d4824b34746f484a9334c053bcf286097b", "url": "https://github.com/prestodb/presto/commit/140703d4824b34746f484a9334c053bcf286097b", "message": "Rename LongEnumType to BigintEnumType\n\nChange the type name to be more consistent with the standard type names\nbecause the type name could show up in user-facing error messages.", "committedDate": "2020-12-30T23:33:06Z", "type": "forcePushed"}, {"oid": "3074bdfbd2610817a184e8555f86eeb21651851f", "url": "https://github.com/prestodb/presto/commit/3074bdfbd2610817a184e8555f86eeb21651851f", "message": "Rename LongEnumType to BigintEnumType\n\nChange the type name to be more consistent with the standard type names\nbecause the type name could show up in user-facing error messages.", "committedDate": "2020-12-31T00:25:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDUwNzgyOQ==", "url": "https://github.com/prestodb/presto/pull/15563#discussion_r550507829", "bodyText": "since it's really just a type + a name, should we call this a NamedType instead?\n(semantic implies that it's a type that contains info about the meaning of your data, but you could have a  semantic type that is anonymous)", "author": "daniel-ohayon", "createdAt": "2020-12-31T15:44:02Z", "path": "presto-common/src/main/java/com/facebook/presto/common/type/SemanticType.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.common.type;\n+\n+import com.facebook.presto.common.QualifiedObjectName;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class SemanticType", "originalCommit": "954d1a280209d2ff92bc83b472dc7b923661a137", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDUxMTAyMQ==", "url": "https://github.com/prestodb/presto/pull/15563#discussion_r550511021", "bodyText": "another thought: this looks a lot like an early version of what the SQL2016 spec calls a \"distinct type\"\n\"The definition of a distinct type specifies its name and the name of its source type.\" (section 4.7.2)", "author": "daniel-ohayon", "createdAt": "2020-12-31T15:58:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDUwNzgyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDUxMjIzMA==", "url": "https://github.com/prestodb/presto/pull/15563#discussion_r550512230", "bodyText": "if we ever wanted to support \"opaque alias types\" like\nKilogram as bigint and gram as bigint\nsuch that\nCAST(5 as kilogram) = cast(3 as gram)\n\nis a type-checking error, would this design allow for that?", "author": "daniel-ohayon", "createdAt": "2020-12-31T15:59:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDUwNzgyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTUyNDY1MQ==", "url": "https://github.com/prestodb/presto/pull/15563#discussion_r551524651", "bodyText": "Ya I thought about calling it NamedType instead. It kinda depends on whether we want to make this specific to external types, or change this to be something more fundamentally used in parser (BIGINT the physical type can also have a corresponding semantic type BIGINT).", "author": "rongrong", "createdAt": "2021-01-04T19:36:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDUwNzgyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "63096db1c1c5a469228ad0e09ff8e1db62ba5102", "chunk": "diff --git a/presto-common/src/main/java/com/facebook/presto/common/type/SemanticType.java b/presto-common/src/main/java/com/facebook/presto/common/type/UserDefinedType.java\nsimilarity index 73%\nrename from presto-common/src/main/java/com/facebook/presto/common/type/SemanticType.java\nrename to presto-common/src/main/java/com/facebook/presto/common/type/UserDefinedType.java\nindex 6eb379a958..f7a5932dd6 100644\n--- a/presto-common/src/main/java/com/facebook/presto/common/type/SemanticType.java\n+++ b/presto-common/src/main/java/com/facebook/presto/common/type/UserDefinedType.java\n\n@@ -17,24 +17,24 @@ import com.facebook.presto.common.QualifiedObjectName;\n \n import static java.util.Objects.requireNonNull;\n \n-public class SemanticType\n+public class UserDefinedType\n {\n     private final QualifiedObjectName name;\n-    private final TypeSignature physicalType;\n+    private final TypeSignature representation;\n \n-    public SemanticType(QualifiedObjectName name, TypeSignature physicalType)\n+    public UserDefinedType(QualifiedObjectName name, TypeSignature representation)\n     {\n         this.name = requireNonNull(name, \"name is null\");\n-        this.physicalType = requireNonNull(physicalType, \"physicalType is null\");\n+        this.representation = requireNonNull(representation, \"representation is null\");\n     }\n \n-    public QualifiedObjectName getSemanticTypeName()\n+    public QualifiedObjectName getUserDefinedTypeName()\n     {\n         return name;\n     }\n \n     public TypeSignature getPhysicalTypeSignature()\n     {\n-        return physicalType;\n+        return representation;\n     }\n }\n"}}, {"oid": "63096db1c1c5a469228ad0e09ff8e1db62ba5102", "url": "https://github.com/prestodb/presto/commit/63096db1c1c5a469228ad0e09ff8e1db62ba5102", "message": "Rename LongEnumType to BigintEnumType\n\nChange the type name to be more consistent with the standard type names\nbecause the type name could show up in user-facing error messages.", "committedDate": "2021-01-06T19:55:28Z", "type": "forcePushed"}, {"oid": "b63372ff174a78da5691ddf6d69f601a98112af2", "url": "https://github.com/prestodb/presto/commit/b63372ff174a78da5691ddf6d69f601a98112af2", "message": "Rename LongEnumType to BigintEnumType\n\nChange the type name to be more consistent with the standard type names\nbecause the type name could show up in user-facing error messages.", "committedDate": "2021-01-06T20:42:58Z", "type": "forcePushed"}, {"oid": "5601d76c4cd0c16a1fffd577b05d4664449251d3", "url": "https://github.com/prestodb/presto/commit/5601d76c4cd0c16a1fffd577b05d4664449251d3", "message": "Rename LongEnumType to BigintEnumType\n\nChange the type name to be more consistent with the standard type names\nbecause the type name could show up in user-facing error messages.", "committedDate": "2021-01-06T20:50:39Z", "type": "forcePushed"}, {"oid": "4f24c041bbcadc2a845b43d38bbef04fc89da27e", "url": "https://github.com/prestodb/presto/commit/4f24c041bbcadc2a845b43d38bbef04fc89da27e", "message": "Rename LongEnumType to BigintEnumType\n\nChange the type name to be more consistent with the standard type names\nbecause the type name could show up in user-facing error messages.", "committedDate": "2021-01-06T20:53:24Z", "type": "forcePushed"}, {"oid": "9ffa4452ac12e643fe36608dc82f8cb444d262a1", "url": "https://github.com/prestodb/presto/commit/9ffa4452ac12e643fe36608dc82f8cb444d262a1", "message": "Add array_intersect SQL function that accepts array of array\n\narray_intersect(array<array<bigint>>) -> array<bigint>\narray_intersect(array<array<double>>) -> array<double>", "committedDate": "2021-01-08T03:04:52Z", "type": "forcePushed"}, {"oid": "07006481764d6b1f348615e7c3c960b6dfb31f2e", "url": "https://github.com/prestodb/presto/commit/07006481764d6b1f348615e7c3c960b6dfb31f2e", "message": "Rename LongEnumType to BigintEnumType\n\nChange the type name to be more consistent with the standard type names\nbecause the type name could show up in user-facing error messages.", "committedDate": "2021-01-08T03:04:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDE4NTk5NQ==", "url": "https://github.com/prestodb/presto/pull/15563#discussion_r554185995", "bodyText": "Maybe I don't have the full picture. Why is this changed from start to end?", "author": "caithagoras", "createdAt": "2021-01-08T20:54:30Z", "path": "presto-common/src/main/java/com/facebook/presto/common/type/TypeSignature.java", "diffHunk": "@@ -252,7 +260,7 @@ VarcharEnumMap getVarcharEnumMap()\n         Set<Integer> indices = new HashSet<>();\n         Matcher enumMatcher = ENUM_PREFIX.matcher(signature);\n         while (enumMatcher.find()) {\n-            indices.add(enumMatcher.start());\n+            indices.add(enumMatcher.end());", "originalCommit": "365f5df443e2357574ee86fe3e57c81a5e8a4dc9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDE4ODM0Ng==", "url": "https://github.com/prestodb/presto/pull/15563#discussion_r554188346", "bodyText": "The enum signature format is changed from typename(enum:type{enum_map}) to\nenumtype(typename{enum_map})", "author": "rongrong", "createdAt": "2021-01-08T20:59:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDE4NTk5NQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "66e0b80a6239a5cc383831449452de367272ae39", "url": "https://github.com/prestodb/presto/commit/66e0b80a6239a5cc383831449452de367272ae39", "message": "Rename LongEnumType to BigintEnumType\n\nChange the type name to be more consistent with the standard type names\nbecause the type name could show up in user-facing error messages.", "committedDate": "2021-01-12T00:07:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTk0MjUwMA==", "url": "https://github.com/prestodb/presto/pull/15563#discussion_r555942500", "bodyText": "Is case sensitivity taken care of here?", "author": "kaikalur", "createdAt": "2021-01-12T17:19:55Z", "path": "presto-common/src/main/java/com/facebook/presto/common/type/BigintEnumType.java", "diffHunk": "@@ -157,7 +162,7 @@ public boolean equals(Object o)\n             return false;\n         }\n \n-        LongEnumType other = (LongEnumType) o;\n+        BigintEnumType other = (BigintEnumType) o;\n \n         return Objects.equals(getTypeSignature().getBase(), other.getTypeSignature().getBase())\n                 && Objects.equals(getEnumMap(), other.getEnumMap());", "originalCommit": "66e0b80a6239a5cc383831449452de367272ae39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzAwMDkyMg==", "url": "https://github.com/prestodb/presto/pull/15563#discussion_r557000922", "bodyText": "Hmm, the enum mapping should be case sensitive. The type name probably should not.", "author": "rongrong", "createdAt": "2021-01-14T02:17:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTk0MjUwMA=="}], "type": "inlineReview", "revised_code": {"commit": "c3e69ae2bb0a7bd7a22e883417b991cd89b17e8a", "chunk": "diff --git a/presto-common/src/main/java/com/facebook/presto/common/type/BigintEnumType.java b/presto-common/src/main/java/com/facebook/presto/common/type/LongEnumType.java\nsimilarity index 85%\nrename from presto-common/src/main/java/com/facebook/presto/common/type/BigintEnumType.java\nrename to presto-common/src/main/java/com/facebook/presto/common/type/LongEnumType.java\nindex c5ece9663c..507bbf0010 100644\n--- a/presto-common/src/main/java/com/facebook/presto/common/type/BigintEnumType.java\n+++ b/presto-common/src/main/java/com/facebook/presto/common/type/LongEnumType.java\n\n@@ -162,7 +158,7 @@ public class BigintEnumType\n             return false;\n         }\n \n-        BigintEnumType other = (BigintEnumType) o;\n+        LongEnumType other = (LongEnumType) o;\n \n         return Objects.equals(getTypeSignature().getBase(), other.getTypeSignature().getBase())\n                 && Objects.equals(getEnumMap(), other.getEnumMap());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTk0MzY2Mw==", "url": "https://github.com/prestodb/presto/pull/15563#discussion_r555943663", "bodyText": "Is this user visible? The names are a bit odd. Not sure if  enum will work better", "author": "kaikalur", "createdAt": "2021-01-12T17:21:43Z", "path": "presto-common/src/main/java/com/facebook/presto/common/type/StandardTypes.java", "diffHunk": "@@ -45,6 +45,8 @@\n     public static final String IPPREFIX = \"ipprefix\";\n     public static final String GEOMETRY = \"Geometry\";\n     public static final String BING_TILE = \"BingTile\";\n+    public static final String BIGINT_ENUM = \"BigintEnum\";\n+    public static final String VARCHAR_ENUM = \"VarcharEnum\";", "originalCommit": "66e0b80a6239a5cc383831449452de367272ae39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njk5OTkzNA==", "url": "https://github.com/prestodb/presto/pull/15563#discussion_r556999934", "bodyText": "There are 2 types of enums and they cannot be both of type \"enum\". This would be visible in error messages and plans. If you have better suggestions I'm all ears.", "author": "rongrong", "createdAt": "2021-01-14T02:14:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTk0MzY2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "c3e69ae2bb0a7bd7a22e883417b991cd89b17e8a", "chunk": "diff --git a/presto-common/src/main/java/com/facebook/presto/common/type/StandardTypes.java b/presto-common/src/main/java/com/facebook/presto/common/type/StandardTypes.java\nindex d8902062f3..335d9f1c48 100644\n--- a/presto-common/src/main/java/com/facebook/presto/common/type/StandardTypes.java\n+++ b/presto-common/src/main/java/com/facebook/presto/common/type/StandardTypes.java\n\n@@ -45,7 +45,7 @@ public final class StandardTypes\n     public static final String IPPREFIX = \"ipprefix\";\n     public static final String GEOMETRY = \"Geometry\";\n     public static final String BING_TILE = \"BingTile\";\n-    public static final String BIGINT_ENUM = \"BigintEnum\";\n+    public static final String LONG_ENUM = \"LongEnum\";\n     public static final String VARCHAR_ENUM = \"VarcharEnum\";\n \n     private StandardTypes() {}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTk0NDA5MQ==", "url": "https://github.com/prestodb/presto/pull/15563#discussion_r555944091", "bodyText": "Why ENGLISH?", "author": "kaikalur", "createdAt": "2021-01-12T17:22:22Z", "path": "presto-common/src/main/java/com/facebook/presto/common/type/TypeSignature.java", "diffHunk": "@@ -219,31 +222,36 @@ else if (c == ',') {\n     private static class EnumMapParsingData\n     {\n         final int mapEndIndex;\n+        private final String typeName;\n         private final Map<String, String> map;\n-        final boolean isLongEnum;\n+        private final boolean isBigintEnum;\n \n-        EnumMapParsingData(int mapEndIndex, Map<String, String> map, boolean isLongEnum)\n+        EnumMapParsingData(int mapEndIndex, String typeName, Map<String, String> map, boolean isBigintEnum)\n         {\n             this.mapEndIndex = mapEndIndex;\n+            this.typeName = typeName;\n             this.map = map;\n-            this.isLongEnum = isLongEnum;\n+            this.isBigintEnum = isBigintEnum;\n         }\n \n         LongEnumMap getLongEnumMap()\n         {\n-            checkArgument(isLongEnum, \"Invalid enum map format\");\n+            checkArgument(isBigintEnum, \"Invalid enum map format\");\n             return new LongEnumMap(\n+                    typeName,\n                     map.entrySet().stream()\n                             .collect(Collectors.toMap(Map.Entry::getKey, e -> Long.parseLong(e.getValue()))));\n         }\n \n         VarcharEnumMap getVarcharEnumMap()\n         {\n-            checkArgument(!isLongEnum, \"Invalid enum map format\");\n+            checkArgument(!isBigintEnum, \"Invalid enum map format\");\n             // Varchar enum values are base32-encoded so that they are case-insensitive, which is expected of TypeSigntures\n             Base32 base32 = new Base32();\n-            return new VarcharEnumMap(map.entrySet().stream()\n-                    .collect(Collectors.toMap(Map.Entry::getKey, e -> new String(base32.decode(e.getValue().toUpperCase(ENGLISH))))));\n+            return new VarcharEnumMap(\n+                    typeName,\n+                    map.entrySet().stream()\n+                            .collect(Collectors.toMap(Map.Entry::getKey, e -> new String(base32.decode(e.getValue().toUpperCase(ENGLISH))))));", "originalCommit": "66e0b80a6239a5cc383831449452de367272ae39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njk5OTU1MQ==", "url": "https://github.com/prestodb/presto/pull/15563#discussion_r556999551", "bodyText": "I don't know... That's what's used in code in similar situations. It's no longer recommended to not providing a locale.", "author": "rongrong", "createdAt": "2021-01-14T02:13:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTk0NDA5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "c3e69ae2bb0a7bd7a22e883417b991cd89b17e8a", "chunk": "diff --git a/presto-common/src/main/java/com/facebook/presto/common/type/TypeSignature.java b/presto-common/src/main/java/com/facebook/presto/common/type/TypeSignature.java\nindex c767298f42..8392b27e6d 100644\n--- a/presto-common/src/main/java/com/facebook/presto/common/type/TypeSignature.java\n+++ b/presto-common/src/main/java/com/facebook/presto/common/type/TypeSignature.java\n\n@@ -224,19 +224,19 @@ public class TypeSignature\n         final int mapEndIndex;\n         private final String typeName;\n         private final Map<String, String> map;\n-        private final boolean isBigintEnum;\n+        private final boolean isLongEnum;\n \n-        EnumMapParsingData(int mapEndIndex, String typeName, Map<String, String> map, boolean isBigintEnum)\n+        EnumMapParsingData(int mapEndIndex, String typeName, Map<String, String> map, boolean isLongEnum)\n         {\n             this.mapEndIndex = mapEndIndex;\n             this.typeName = typeName;\n             this.map = map;\n-            this.isBigintEnum = isBigintEnum;\n+            this.isLongEnum = isLongEnum;\n         }\n \n         LongEnumMap getLongEnumMap()\n         {\n-            checkArgument(isBigintEnum, \"Invalid enum map format\");\n+            checkArgument(isLongEnum, \"Invalid enum map format\");\n             return new LongEnumMap(\n                     typeName,\n                     map.entrySet().stream()\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTk0NDcyOA==", "url": "https://github.com/prestodb/presto/pull/15563#discussion_r555944728", "bodyText": "Is the signature already case normalized?", "author": "kaikalur", "createdAt": "2021-01-12T17:23:20Z", "path": "presto-common/src/main/java/com/facebook/presto/common/type/TypeSignature.java", "diffHunk": "@@ -273,13 +281,14 @@ VarcharEnumMap getVarcharEnumMap()\n     private static EnumMapParsingData parseEnumMap(String signature, int startIndex)\n     {\n         EnumMapParsingState state = EnumMapParsingState.EXPECT_KEY;\n-        boolean isLongEnum = signature.substring(startIndex).trim().toLowerCase(ENGLISH).startsWith(LONG_ENUM_PREFIX);\n-        int openBracketIndex = startIndex + (isLongEnum ? LONG_ENUM_PREFIX.length() : VARCHAR_ENUM_PREFIX.length()) + 1;\n+        boolean isBigintEnum = signature.startsWith(BIGINT_ENUM_PREFIX, startIndex - BIGINT_ENUM_PREFIX.length() - 1);", "originalCommit": "66e0b80a6239a5cc383831449452de367272ae39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njk5OTMzMg==", "url": "https://github.com/prestodb/presto/pull/15563#discussion_r556999332", "bodyText": "Yes, the caller normalized the signature before calling. There are tests cases to test this as well.", "author": "rongrong", "createdAt": "2021-01-14T02:12:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTk0NDcyOA=="}], "type": "inlineReview", "revised_code": {"commit": "c3e69ae2bb0a7bd7a22e883417b991cd89b17e8a", "chunk": "diff --git a/presto-common/src/main/java/com/facebook/presto/common/type/TypeSignature.java b/presto-common/src/main/java/com/facebook/presto/common/type/TypeSignature.java\nindex c767298f42..8392b27e6d 100644\n--- a/presto-common/src/main/java/com/facebook/presto/common/type/TypeSignature.java\n+++ b/presto-common/src/main/java/com/facebook/presto/common/type/TypeSignature.java\n\n@@ -281,7 +281,7 @@ public class TypeSignature\n     private static EnumMapParsingData parseEnumMap(String signature, int startIndex)\n     {\n         EnumMapParsingState state = EnumMapParsingState.EXPECT_KEY;\n-        boolean isBigintEnum = signature.startsWith(BIGINT_ENUM_PREFIX, startIndex - BIGINT_ENUM_PREFIX.length() - 1);\n+        boolean isLongEnum = signature.startsWith(LONG_ENUM_PREFIX, startIndex - LONG_ENUM_PREFIX.length() - 1);\n         int openBracketIndex = signature.indexOf(\"{\", startIndex);\n         String typeName = signature.substring(startIndex, openBracketIndex);\n         String key = null;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTk0NTUwMg==", "url": "https://github.com/prestodb/presto/pull/15563#discussion_r555945502", "bodyText": "Why qualified? Can it be just a simple id?", "author": "kaikalur", "createdAt": "2021-01-12T17:24:30Z", "path": "presto-common/src/main/java/com/facebook/presto/common/type/UserDefinedType.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.common.type;\n+\n+import com.facebook.presto.common.QualifiedObjectName;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class UserDefinedType\n+{\n+    private final QualifiedObjectName name;", "originalCommit": "66e0b80a6239a5cc383831449452de367272ae39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njk5OTAzNg==", "url": "https://github.com/prestodb/presto/pull/15563#discussion_r556999036", "bodyText": "No, all external types are managed by FunctionNamespaceManager, which manages catalogs. This is also aligned with the spec as <schema-resolved user-defined type name>.", "author": "rongrong", "createdAt": "2021-01-14T02:11:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTk0NTUwMg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTk0NzcxMw==", "url": "https://github.com/prestodb/presto/pull/15563#discussion_r555947713", "bodyText": "What is a \"static type\"?", "author": "kaikalur", "createdAt": "2021-01-12T17:27:43Z", "path": "presto-main/src/main/java/com/facebook/presto/metadata/FunctionAndTypeManager.java", "diffHunk": "@@ -199,18 +191,16 @@ public Type getType(TypeSignature signature)\n             if (type.isPresent()) {\n                 return type.get();\n             }\n-            try {\n-                return parametricTypeCache.getUnchecked(signature);\n-            }\n-            catch (UncheckedExecutionException e) {\n-                throwIfUnchecked(e.getCause());\n-                throw new RuntimeException(e.getCause());\n-            }\n         }\n \n         Optional<FunctionNamespaceManager<?>> functionNamespaceManager = getServingFunctionNamespaceManager(signature.getTypeSignatureBase());\n         checkArgument(functionNamespaceManager.isPresent(), \"Cannot find function namespace for type '%s'\", signature.getBase());\n-        return instantiateParametricType(signature, functionNamespaceManager.get());\n+        Optional<UserDefinedType> userDefinedType = functionNamespaceManager.get().getUserDefinedType(signature.getTypeSignatureBase().getQualifiedObjectName());\n+        if (!userDefinedType.isPresent()) {\n+            throw new IllegalArgumentException(\"Unknown type \" + signature);\n+        }\n+        checkArgument(userDefinedType.get().getPhysicalTypeSignature().getTypeSignatureBase().isStandardType(), \"UserDefinedType must be based on static types.\");\n+        return getType(userDefinedType.get().getPhysicalTypeSignature());", "originalCommit": "66e0b80a6239a5cc383831449452de367272ae39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njk5ODMxNQ==", "url": "https://github.com/prestodb/presto/pull/15563#discussion_r556998315", "bodyText": "Built in types / types that's defined in code thus cannot be changed. Do you have a better name for them? I can use \"standard types\", which is sort of true. At least they are all defined in StandardTypes.java. Though they are not really the \"standard type\" in the spec.", "author": "rongrong", "createdAt": "2021-01-14T02:08:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTk0NzcxMw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "f5f9c004cc66a000f98af3b5bc631176fba9b676", "url": "https://github.com/prestodb/presto/commit/f5f9c004cc66a000f98af3b5bc631176fba9b676", "message": "Rename LongEnumType to BigintEnumType\n\nChange the type name to be more consistent with the standard type names\nbecause the type name could show up in user-facing error messages.", "committedDate": "2021-01-14T04:13:08Z", "type": "forcePushed"}, {"oid": "20b63c6e149ab3fca53377b1ab2ded3edfba65ce", "url": "https://github.com/prestodb/presto/commit/20b63c6e149ab3fca53377b1ab2ded3edfba65ce", "message": "Rename LongEnumType to BigintEnumType\n\nChange the type name to be more consistent with the standard type names\nbecause the type name could show up in user-facing error messages.", "committedDate": "2021-01-20T23:47:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTQ0NTEwMQ==", "url": "https://github.com/prestodb/presto/pull/15563#discussion_r561445101", "bodyText": "Is the order the same as the user given? That might be good.", "author": "kaikalur", "createdAt": "2021-01-21T00:59:49Z", "path": "presto-common/src/main/java/com/facebook/presto/common/type/LongEnumType.java", "diffHunk": "@@ -114,25 +123,22 @@ public boolean equals(Object o)\n \n             LongEnumMap other = (LongEnumMap) o;\n \n-            return Objects.equals(this.enumMap, other.enumMap);\n+            return Objects.equals(typeName, other.typeName) && Objects.equals(enumMap, other.enumMap);\n         }\n \n         @Override\n         public String toString()\n         {\n-            return \"enum:bigint{\"\n-                    + enumMap.entrySet()\n-                    .stream()\n+            return format(\"%s{%s}\", typeName, enumMap.entrySet().stream()", "originalCommit": "f91639d87cddb531f812798c6d6b1dc942c533fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTUwMTk0Mw==", "url": "https://github.com/prestodb/presto/pull/15563#discussion_r561501943", "bodyText": "Depending on how it's stored at the source it might or might not be possible to have the order as \"user given\". Since we are implementing it as map, that's not really possible. I don't want to make this like a map block that's too complicated. \ud83d\ude02", "author": "rongrong", "createdAt": "2021-01-21T02:35:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTQ0NTEwMQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "c3e69ae2bb0a7bd7a22e883417b991cd89b17e8a", "url": "https://github.com/prestodb/presto/commit/c3e69ae2bb0a7bd7a22e883417b991cd89b17e8a", "message": "Introduce UserDefinedType\n\nIntroduce the concept of UserDefinedType as spedified in spec16. User defined\ntypes are managed by FunctionNamespaceManager.\n\nThe spec has more metadata specified for user defined types but we currently\nonly add\n```\n<user-defined type definition> ::= CREATE TYPE <user-defined type body>\n<user-defined type body> ::= <schema-resolved user-defined type name>\n    [ AS <representation> ]\n<representation> ::=\n    <predefined type>\n  | <collection type>\n  | <member list>\n```\nFor <representation>, we use TypeSignature to represent all options above.\n\nEnum type signature format is changed from `typename(enum:type{enum_map})` to\n`enumtype(typename{enum_map})` so enum types can behave the same way as other\nbuiltin parametric types that's fully managed by\nBuiltInTypeAndFunctionNamespaceManager.", "committedDate": "2021-01-21T02:36:51Z", "type": "commit"}, {"oid": "f569008a2b2d5bf11457b165867d3349feac2d31", "url": "https://github.com/prestodb/presto/commit/f569008a2b2d5bf11457b165867d3349feac2d31", "message": "Rename LongEnumType to BigintEnumType\n\nChange the type name to be more consistent with the standard type names\nbecause the type name could show up in user-facing error messages.", "committedDate": "2021-01-21T02:36:56Z", "type": "commit"}, {"oid": "f569008a2b2d5bf11457b165867d3349feac2d31", "url": "https://github.com/prestodb/presto/commit/f569008a2b2d5bf11457b165867d3349feac2d31", "message": "Rename LongEnumType to BigintEnumType\n\nChange the type name to be more consistent with the standard type names\nbecause the type name could show up in user-facing error messages.", "committedDate": "2021-01-21T02:36:56Z", "type": "forcePushed"}]}