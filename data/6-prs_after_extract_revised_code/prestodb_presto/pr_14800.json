{"pr_number": 14800, "pr_title": "Partition filtering warning", "pr_createdAt": "2020-07-07T18:30:46Z", "pr_url": "https://github.com/prestodb/presto/pull/14800", "timeline": [{"oid": "1a491198eb49d201578eb2f19567e56ad10fbca3", "url": "https://github.com/prestodb/presto/commit/1a491198eb49d201578eb2f19567e56ad10fbca3", "message": "Support for checking partition key filter coverage", "committedDate": "2020-07-07T18:47:27Z", "type": "forcePushed"}, {"oid": "ae670504c1eed352edff7fcc682d64e1b6745147", "url": "https://github.com/prestodb/presto/commit/ae670504c1eed352edff7fcc682d64e1b6745147", "message": "Warn on configured unfiltered partitions", "committedDate": "2020-07-07T18:39:48Z", "type": "forcePushed"}, {"oid": "e81e1323387d468a4e425ea7b8744aa40527e1ca", "url": "https://github.com/prestodb/presto/commit/e81e1323387d468a4e425ea7b8744aa40527e1ca", "message": "Warn on configured unfiltered partitions", "committedDate": "2020-07-07T19:20:10Z", "type": "forcePushed"}, {"oid": "2d278dfde7dc74e5f25ca9bc24701f5479c50b3e", "url": "https://github.com/prestodb/presto/commit/2d278dfde7dc74e5f25ca9bc24701f5479c50b3e", "message": "Warn on configured unfiltered partitions", "committedDate": "2020-07-07T19:26:47Z", "type": "forcePushed"}, {"oid": "a5d5488ada1e63b173ee5fe1f6d44b4ddcad5214", "url": "https://github.com/prestodb/presto/commit/a5d5488ada1e63b173ee5fe1f6d44b4ddcad5214", "message": "Warn on configured unfiltered partitions", "committedDate": "2020-07-07T19:48:44Z", "type": "forcePushed"}, {"oid": "cccbc1bcc8c56100218d4558fc32edbb19d37d78", "url": "https://github.com/prestodb/presto/commit/cccbc1bcc8c56100218d4558fc32edbb19d37d78", "message": "Warn on configured unfiltered partitions", "committedDate": "2020-07-07T19:50:27Z", "type": "forcePushed"}, {"oid": "f6e38d299a9bdb3afe6ff6723d990fc2bc31ba1f", "url": "https://github.com/prestodb/presto/commit/f6e38d299a9bdb3afe6ff6723d990fc2bc31ba1f", "message": "Warn on configured unfiltered partitions", "committedDate": "2020-07-07T20:08:26Z", "type": "forcePushed"}, {"oid": "94acd743b4954d20664e3d4709f30b9bb8c5df8e", "url": "https://github.com/prestodb/presto/commit/94acd743b4954d20664e3d4709f30b9bb8c5df8e", "message": "Warn on configured unfiltered partitions", "committedDate": "2020-07-07T21:50:52Z", "type": "forcePushed"}, {"oid": "e8c8ca7d2a63fd77df763657832dd643e36c3200", "url": "https://github.com/prestodb/presto/commit/e8c8ca7d2a63fd77df763657832dd643e36c3200", "message": "Warn on configured unfiltered partitions", "committedDate": "2020-07-07T22:08:19Z", "type": "forcePushed"}, {"oid": "acbfd58226e01c4818417ae17c0d96aa941907ea", "url": "https://github.com/prestodb/presto/commit/acbfd58226e01c4818417ae17c0d96aa941907ea", "message": "Warn on configured unfiltered partitions", "committedDate": "2020-07-07T22:16:25Z", "type": "forcePushed"}, {"oid": "861301c5fe4ecc6d46e4ad6171fbe5080a17f630", "url": "https://github.com/prestodb/presto/commit/861301c5fe4ecc6d46e4ad6171fbe5080a17f630", "message": "Warn on configured unfiltered partitions", "committedDate": "2020-07-08T15:04:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ2MzIwOQ==", "url": "https://github.com/prestodb/presto/pull/14800#discussion_r452463209", "bodyText": "We usually keep the type from getter method consistent to the setter method.\nWhat about return String here and do the JSON parse in WarnOnScanWithoutPartitionPredicate ?", "author": "wenleix", "createdAt": "2020-07-09T20:12:15Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/analyzer/FeaturesConfig.java", "diffHunk": "@@ -1290,4 +1295,22 @@ public FeaturesConfig setOptimizeNullsInJoin(boolean optimizeNullsInJoin)\n         this.optimizeNullsInJoin = optimizeNullsInJoin;\n         return this;\n     }\n+\n+    public List<List<String>> getPartitionKeysToWarnOnNoFiltering()", "originalCommit": "861301c5fe4ecc6d46e4ad6171fbe5080a17f630", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ3MDAwNw==", "url": "https://github.com/prestodb/presto/pull/14800#discussion_r452470007", "bodyText": "Having a List<List<>> for configuration looks too complicated ..\nAs discussed offline, let's focus on simple use case. The semantic can be:\nHere is a list of common partitioned columns.  If the table is partitioned on any of these columns, \nwe expect the query need to have filter on at least one of those partitioned columns.\n\nAnd in most companies in Bay Area, this will just be set to [ds] .", "author": "wenleix", "createdAt": "2020-07-09T20:25:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ2MzIwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "c0d439115d8a0b7e558101b78ea91aa3423de0f8", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/sql/analyzer/FeaturesConfig.java b/presto-main/src/main/java/com/facebook/presto/sql/analyzer/FeaturesConfig.java\nindex 10417fb3eb..3bd3c6bbd2 100644\n--- a/presto-main/src/main/java/com/facebook/presto/sql/analyzer/FeaturesConfig.java\n+++ b/presto-main/src/main/java/com/facebook/presto/sql/analyzer/FeaturesConfig.java\n\n@@ -1296,21 +1293,15 @@ public class FeaturesConfig\n         return this;\n     }\n \n-    public List<List<String>> getPartitionKeysToWarnOnNoFiltering()\n+    public List<String> getPartitionColumnsToWarnOnNoFiltering()\n     {\n-        ObjectMapper objectMapper = new ObjectMapper();\n-        try {\n-            return objectMapper.readValue(partitionKeysToWarnOnNoFiltering, new TypeReference<List<List<String>>>() {});\n-        }\n-        catch (IOException e) {\n-            throw new RuntimeException(e);\n-        }\n+        return partitionColumnsToWarnOnNoFiltering;\n     }\n \n-    @Config(\"partition-keys-to-warn-on-no-filtering\")\n-    public FeaturesConfig setPartitionKeysToWarnOnNoFiltering(String partitionKeysToWarnOnNoFiltering)\n+    @Config(\"partition-columns-to-warn-on-no-filtering\")\n+    public FeaturesConfig setPartitionColumnsToWarnOnNoFiltering(List<String> partitionColumnsToWarnOnNoFiltering)\n     {\n-        this.partitionKeysToWarnOnNoFiltering = partitionKeysToWarnOnNoFiltering;\n+        this.partitionColumnsToWarnOnNoFiltering = partitionColumnsToWarnOnNoFiltering;\n         return this;\n     }\n }\n"}}, {"oid": "c0d439115d8a0b7e558101b78ea91aa3423de0f8", "url": "https://github.com/prestodb/presto/commit/c0d439115d8a0b7e558101b78ea91aa3423de0f8", "message": "Warn on configured unfiltered partitions", "committedDate": "2020-07-09T23:34:03Z", "type": "forcePushed"}, {"oid": "a6ac0bc7679d8a66aad40491e90d83ae11f2f972", "url": "https://github.com/prestodb/presto/commit/a6ac0bc7679d8a66aad40491e90d83ae11f2f972", "message": "Warn on configured unfiltered partitions", "committedDate": "2020-07-10T00:13:24Z", "type": "forcePushed"}, {"oid": "758bcb2786ce5017b28fcddcf4b0fd5f3b05f158", "url": "https://github.com/prestodb/presto/commit/758bcb2786ce5017b28fcddcf4b0fd5f3b05f158", "message": "Warn on configured unfiltered partitions", "committedDate": "2020-07-10T00:15:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3MjA3Mw==", "url": "https://github.com/prestodb/presto/pull/14800#discussion_r453072073", "bodyText": "nit: I think we usually do toImmutableList() and toImmutableSet() whenever feasible.\nAlso I personally prefer to put new lines for stream APIs, e.g.\n            List<String> partitionKey = tableHandle.getPartitionColumns().stream()\n                    .map(HiveColumnHandle::getName)\n                    .collect(toImmutableList());", "author": "wenleix", "createdAt": "2020-07-10T20:53:20Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -3030,6 +3034,19 @@ public void commit()\n         metastore.commit();\n     }\n \n+    @Override\n+    public PartitioningFilterCoverage getPartitioningFilterCoverage(ConnectorTableLayoutHandle connectorTableLayoutHandle, Set<String> relevantPartitionColumns)\n+    {\n+        HiveTableLayoutHandle tableHandle = (HiveTableLayoutHandle) connectorTableLayoutHandle;\n+        List<String> partitionKey = tableHandle.getPartitionColumns().stream().map(HiveColumnHandle::getName).collect(toList());", "originalCommit": "7595fcbcb85d59dd6b1f73e9b29d177f532f12a7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3NTU1MQ==", "url": "https://github.com/prestodb/presto/pull/14800#discussion_r453075551", "bodyText": "Actually I think we don't need this partitionKey anymore (we can directly compute relevantColumns )", "author": "wenleix", "createdAt": "2020-07-10T21:01:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3MjA3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "28ad7cd073e1e3bb4783420bc597548f163e9f01", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\nindex d31ebfa674..1fcc72a27f 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n\n@@ -3035,16 +3035,18 @@ public class HiveMetadata\n     }\n \n     @Override\n-    public PartitioningFilterCoverage getPartitioningFilterCoverage(ConnectorTableLayoutHandle connectorTableLayoutHandle, Set<String> relevantPartitionColumns)\n+    public TableLayoutFilterCoverage getTableLayoutFilterCoverage(ConnectorTableLayoutHandle connectorTableLayoutHandle, Set<String> relevantPartitionColumns)\n     {\n         HiveTableLayoutHandle tableHandle = (HiveTableLayoutHandle) connectorTableLayoutHandle;\n-        List<String> partitionKey = tableHandle.getPartitionColumns().stream().map(HiveColumnHandle::getName).collect(toList());\n-        Set<String> relevantColumns = partitionKey.stream().filter(relevantPartitionColumns::contains).collect(toSet());\n+        Set<String> relevantColumns = tableHandle.getPartitionColumns().stream()\n+                .map(HiveColumnHandle::getName)\n+                .filter(relevantPartitionColumns::contains)\n+                .collect(toImmutableSet());\n         if (relevantColumns.isEmpty()) {\n-            return UNKNOWN;\n+            return NOT_APPLICABLE;\n         }\n \n-        return Sets.intersection(tableHandle.getPredicateColumns().keySet(), relevantColumns).isEmpty() ? NONE : PARTIAL;\n+        return Sets.intersection(tableHandle.getPredicateColumns().keySet(), relevantColumns).isEmpty() ? NOT_COVERED : COVERED;\n     }\n \n     public static Optional<SchemaTableName> getSourceTableNameFromSystemTable(SchemaTableName tableName)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3MjEwNQ==", "url": "https://github.com/prestodb/presto/pull/14800#discussion_r453072105", "bodyText": "ditto", "author": "wenleix", "createdAt": "2020-07-10T20:53:25Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -3030,6 +3034,19 @@ public void commit()\n         metastore.commit();\n     }\n \n+    @Override\n+    public PartitioningFilterCoverage getPartitioningFilterCoverage(ConnectorTableLayoutHandle connectorTableLayoutHandle, Set<String> relevantPartitionColumns)\n+    {\n+        HiveTableLayoutHandle tableHandle = (HiveTableLayoutHandle) connectorTableLayoutHandle;\n+        List<String> partitionKey = tableHandle.getPartitionColumns().stream().map(HiveColumnHandle::getName).collect(toList());\n+        Set<String> relevantColumns = partitionKey.stream().filter(relevantPartitionColumns::contains).collect(toSet());", "originalCommit": "7595fcbcb85d59dd6b1f73e9b29d177f532f12a7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "28ad7cd073e1e3bb4783420bc597548f163e9f01", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\nindex d31ebfa674..1fcc72a27f 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n\n@@ -3035,16 +3035,18 @@ public class HiveMetadata\n     }\n \n     @Override\n-    public PartitioningFilterCoverage getPartitioningFilterCoverage(ConnectorTableLayoutHandle connectorTableLayoutHandle, Set<String> relevantPartitionColumns)\n+    public TableLayoutFilterCoverage getTableLayoutFilterCoverage(ConnectorTableLayoutHandle connectorTableLayoutHandle, Set<String> relevantPartitionColumns)\n     {\n         HiveTableLayoutHandle tableHandle = (HiveTableLayoutHandle) connectorTableLayoutHandle;\n-        List<String> partitionKey = tableHandle.getPartitionColumns().stream().map(HiveColumnHandle::getName).collect(toList());\n-        Set<String> relevantColumns = partitionKey.stream().filter(relevantPartitionColumns::contains).collect(toSet());\n+        Set<String> relevantColumns = tableHandle.getPartitionColumns().stream()\n+                .map(HiveColumnHandle::getName)\n+                .filter(relevantPartitionColumns::contains)\n+                .collect(toImmutableSet());\n         if (relevantColumns.isEmpty()) {\n-            return UNKNOWN;\n+            return NOT_APPLICABLE;\n         }\n \n-        return Sets.intersection(tableHandle.getPredicateColumns().keySet(), relevantColumns).isEmpty() ? NONE : PARTIAL;\n+        return Sets.intersection(tableHandle.getPredicateColumns().keySet(), relevantColumns).isEmpty() ? NOT_COVERED : COVERED;\n     }\n \n     public static Optional<SchemaTableName> getSourceTableNameFromSystemTable(SchemaTableName tableName)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3MzQxMA==", "url": "https://github.com/prestodb/presto/pull/14800#discussion_r453073410", "bodyText": "Note Hive partition is not a \"partitioning\" at engine level. Presto engine \"partitioning\" corresponds to Hive bucket.  Hive partition filter is modeled as table layout selection in Presto today :(\nWhat about TableLayoutFilterCoverage?  cc @rschlussel", "author": "wenleix", "createdAt": "2020-07-10T20:56:44Z", "path": "presto-spi/src/main/java/com/facebook/presto/spi/PartitioningFilterCoverage.java", "diffHunk": "@@ -0,0 +1,28 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.spi;\n+\n+/**\n+ * Result indicating whether a set of filters on partition columns retricts the range of values\n+ * on the columns\n+ */\n+public enum PartitioningFilterCoverage", "originalCommit": "7595fcbcb85d59dd6b1f73e9b29d177f532f12a7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA4MDI0MQ==", "url": "https://github.com/prestodb/presto/pull/14800#discussion_r453080241", "bodyText": "Yes, I prefer TableLayoutFilterCoverage", "author": "rschlussel", "createdAt": "2020-07-10T21:14:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3MzQxMA=="}], "type": "inlineReview", "revised_code": {"commit": "28ad7cd073e1e3bb4783420bc597548f163e9f01", "chunk": "diff --git a/presto-spi/src/main/java/com/facebook/presto/spi/PartitioningFilterCoverage.java b/presto-spi/src/main/java/com/facebook/presto/spi/TableLayoutFilterCoverage.java\nsimilarity index 90%\nrename from presto-spi/src/main/java/com/facebook/presto/spi/PartitioningFilterCoverage.java\nrename to presto-spi/src/main/java/com/facebook/presto/spi/TableLayoutFilterCoverage.java\nindex f4744c1f04..5231d0861c 100644\n--- a/presto-spi/src/main/java/com/facebook/presto/spi/PartitioningFilterCoverage.java\n+++ b/presto-spi/src/main/java/com/facebook/presto/spi/TableLayoutFilterCoverage.java\n\n@@ -17,12 +17,12 @@ package com.facebook.presto.spi;\n  * Result indicating whether a set of filters on partition columns retricts the range of values\n  * on the columns\n  */\n-public enum PartitioningFilterCoverage\n+public enum TableLayoutFilterCoverage\n {\n     // No columns are restricted\n-    NONE,\n+    NOT_COVERED,\n     // Unknown, not checked, or inapplicable\n-    UNKNOWN,\n+    NOT_APPLICABLE,\n     // At least some columns are restricted\n-    PARTIAL\n+    COVERED\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3Mzg1NA==", "url": "https://github.com/prestodb/presto/pull/14800#discussion_r453073854", "bodyText": "nit: PARTIAL is a bit vague. The purpose of this class is to provide Three-valued logic right? (True, False, Null). What about just put them as True, False and Unknown?", "author": "wenleix", "createdAt": "2020-07-10T20:57:46Z", "path": "presto-spi/src/main/java/com/facebook/presto/spi/PartitioningFilterCoverage.java", "diffHunk": "@@ -0,0 +1,28 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.spi;\n+\n+/**\n+ * Result indicating whether a set of filters on partition columns retricts the range of values\n+ * on the columns\n+ */\n+public enum PartitioningFilterCoverage\n+{\n+    // No columns are restricted\n+    NONE,\n+    // Unknown, not checked, or inapplicable\n+    UNKNOWN,\n+    // At least some columns are restricted\n+    PARTIAL", "originalCommit": "7595fcbcb85d59dd6b1f73e9b29d177f532f12a7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "28ad7cd073e1e3bb4783420bc597548f163e9f01", "chunk": "diff --git a/presto-spi/src/main/java/com/facebook/presto/spi/PartitioningFilterCoverage.java b/presto-spi/src/main/java/com/facebook/presto/spi/TableLayoutFilterCoverage.java\nsimilarity index 90%\nrename from presto-spi/src/main/java/com/facebook/presto/spi/PartitioningFilterCoverage.java\nrename to presto-spi/src/main/java/com/facebook/presto/spi/TableLayoutFilterCoverage.java\nindex f4744c1f04..5231d0861c 100644\n--- a/presto-spi/src/main/java/com/facebook/presto/spi/PartitioningFilterCoverage.java\n+++ b/presto-spi/src/main/java/com/facebook/presto/spi/TableLayoutFilterCoverage.java\n\n@@ -17,12 +17,12 @@ package com.facebook.presto.spi;\n  * Result indicating whether a set of filters on partition columns retricts the range of values\n  * on the columns\n  */\n-public enum PartitioningFilterCoverage\n+public enum TableLayoutFilterCoverage\n {\n     // No columns are restricted\n-    NONE,\n+    NOT_COVERED,\n     // Unknown, not checked, or inapplicable\n-    UNKNOWN,\n+    NOT_APPLICABLE,\n     // At least some columns are restricted\n-    PARTIAL\n+    COVERED\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3NDM0NA==", "url": "https://github.com/prestodb/presto/pull/14800#discussion_r453074344", "bodyText": "similarly, what about table-layout-filter-columns-to-warn-on-no-filtering? cc @rschlussel", "author": "wenleix", "createdAt": "2020-07-10T20:58:51Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/analyzer/FeaturesConfig.java", "diffHunk": "@@ -1290,4 +1292,16 @@ public FeaturesConfig setOptimizeNullsInJoin(boolean optimizeNullsInJoin)\n         this.optimizeNullsInJoin = optimizeNullsInJoin;\n         return this;\n     }\n+\n+    public List<String> getPartitionColumnsToWarnOnNoFiltering()\n+    {\n+        return partitionColumnsToWarnOnNoFiltering;\n+    }\n+\n+    @Config(\"partition-columns-to-warn-on-no-filtering\")", "originalCommit": "758bcb2786ce5017b28fcddcf4b0fd5f3b05f158", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3NzYyNQ==", "url": "https://github.com/prestodb/presto/pull/14800#discussion_r453077625", "bodyText": "I would call this: warn-on-no-table-layout-filter", "author": "rschlussel", "createdAt": "2020-07-10T21:07:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3NDM0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgyMTQ2Ng==", "url": "https://github.com/prestodb/presto/pull/14800#discussion_r453821466", "bodyText": "Does table layout mean anything at all to the end user? I think that is mixing up implementation details with user visible concepts?", "author": "aweisberg", "createdAt": "2020-07-13T17:44:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3NDM0NA=="}], "type": "inlineReview", "revised_code": {"commit": "28ad7cd073e1e3bb4783420bc597548f163e9f01", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/sql/analyzer/FeaturesConfig.java b/presto-main/src/main/java/com/facebook/presto/sql/analyzer/FeaturesConfig.java\nindex 3bd3c6bbd2..0889d4bf48 100644\n--- a/presto-main/src/main/java/com/facebook/presto/sql/analyzer/FeaturesConfig.java\n+++ b/presto-main/src/main/java/com/facebook/presto/sql/analyzer/FeaturesConfig.java\n\n@@ -1293,15 +1293,15 @@ public class FeaturesConfig\n         return this;\n     }\n \n-    public List<String> getPartitionColumnsToWarnOnNoFiltering()\n+    public List<String> getWarnOnNoTableLayoutFilter()\n     {\n-        return partitionColumnsToWarnOnNoFiltering;\n+        return warnOnNoTableLayoutFilter;\n     }\n \n-    @Config(\"partition-columns-to-warn-on-no-filtering\")\n-    public FeaturesConfig setPartitionColumnsToWarnOnNoFiltering(List<String> partitionColumnsToWarnOnNoFiltering)\n+    @Config(\"warn-on-no-table-layout-filter\")\n+    public FeaturesConfig setWarnOnNoTableLayoutFilter(List<String> warnOnNoTableLayoutFilter)\n     {\n-        this.partitionColumnsToWarnOnNoFiltering = partitionColumnsToWarnOnNoFiltering;\n+        this.warnOnNoTableLayoutFilter = warnOnNoTableLayoutFilter;\n         return this;\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3NDU0Mg==", "url": "https://github.com/prestodb/presto/pull/14800#discussion_r453074542", "bodyText": "nit: I am not a big fan of Yoda conditions.", "author": "wenleix", "createdAt": "2020-07-10T20:59:21Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/sanity/WarnOnScanWithoutPartitionPredicate.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.sql.planner.sanity;\n+\n+import com.facebook.presto.Session;\n+import com.facebook.presto.execution.warnings.WarningCollector;\n+import com.facebook.presto.metadata.Metadata;\n+import com.facebook.presto.spi.PartitioningFilterCoverage;\n+import com.facebook.presto.spi.PrestoWarning;\n+import com.facebook.presto.spi.TableHandle;\n+import com.facebook.presto.spi.plan.PlanNode;\n+import com.facebook.presto.spi.plan.TableScanNode;\n+import com.facebook.presto.sql.analyzer.FeaturesConfig;\n+import com.facebook.presto.sql.parser.SqlParser;\n+import com.facebook.presto.sql.planner.TypeProvider;\n+import com.google.common.collect.ImmutableSet;\n+\n+import java.util.Set;\n+\n+import static com.facebook.presto.spi.PartitioningFilterCoverage.NONE;\n+import static com.facebook.presto.spi.StandardWarningCode.PERFORMANCE_WARNING;\n+import static com.facebook.presto.sql.planner.optimizations.PlanNodeSearcher.searchFrom;\n+\n+public final class WarnOnScanWithoutPartitionPredicate\n+        implements PlanChecker.Checker\n+{\n+    private final Set<String> partitionKeysToWarnOnNoFiltering;\n+\n+    WarnOnScanWithoutPartitionPredicate(FeaturesConfig featuresConfig)\n+    {\n+        partitionKeysToWarnOnNoFiltering = ImmutableSet.copyOf(featuresConfig.getPartitionColumnsToWarnOnNoFiltering());\n+    }\n+\n+    @Override\n+    public void validate(PlanNode plan, Session session, Metadata metadata, SqlParser sqlParser, TypeProvider types, WarningCollector warningCollector)\n+    {\n+        for (TableScanNode scan : searchFrom(plan)\n+                .where(TableScanNode.class::isInstance)\n+                .<TableScanNode>findAll()) {\n+            TableHandle tableHandle = scan.getTable();\n+            PartitioningFilterCoverage partitioningFilterCoverage = metadata.getPartitioningFilterCoverage(session, tableHandle, partitionKeysToWarnOnNoFiltering);\n+            if (NONE == partitioningFilterCoverage) {", "originalCommit": "758bcb2786ce5017b28fcddcf4b0fd5f3b05f158", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "28ad7cd073e1e3bb4783420bc597548f163e9f01", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/sql/planner/sanity/WarnOnScanWithoutPartitionPredicate.java b/presto-main/src/main/java/com/facebook/presto/sql/planner/sanity/WarnOnScanWithoutPartitionPredicate.java\nindex a0be14fbf0..5b9f6a9467 100644\n--- a/presto-main/src/main/java/com/facebook/presto/sql/planner/sanity/WarnOnScanWithoutPartitionPredicate.java\n+++ b/presto-main/src/main/java/com/facebook/presto/sql/planner/sanity/WarnOnScanWithoutPartitionPredicate.java\n\n@@ -16,7 +16,7 @@ package com.facebook.presto.sql.planner.sanity;\n import com.facebook.presto.Session;\n import com.facebook.presto.execution.warnings.WarningCollector;\n import com.facebook.presto.metadata.Metadata;\n-import com.facebook.presto.spi.PartitioningFilterCoverage;\n+import com.facebook.presto.spi.TableLayoutFilterCoverage;\n import com.facebook.presto.spi.PrestoWarning;\n import com.facebook.presto.spi.TableHandle;\n import com.facebook.presto.spi.plan.PlanNode;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3ODE0Mw==", "url": "https://github.com/prestodb/presto/pull/14800#discussion_r453078143", "bodyText": "nit: This line's getting long. it's probably about time to split this into one line per-argument.", "author": "rschlussel", "createdAt": "2020-07-10T21:08:43Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/analyzer/QueryExplainer.java", "diffHunk": "@@ -188,7 +194,7 @@ public Plan getLogicalPlan(Session session, Statement statement, List<Expression\n         // analyze statement\n         Analysis analysis = analyze(session, statement, parameters, warningCollector);\n         // plan statement\n-        LogicalPlanner logicalPlanner = new LogicalPlanner(true, session, planOptimizers, idAllocator, metadata, sqlParser, statsCalculator, costCalculator, warningCollector);\n+        LogicalPlanner logicalPlanner = new LogicalPlanner(true, session, planOptimizers, idAllocator, metadata, sqlParser, statsCalculator, costCalculator, warningCollector, planChecker);", "originalCommit": "758bcb2786ce5017b28fcddcf4b0fd5f3b05f158", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "28ad7cd073e1e3bb4783420bc597548f163e9f01", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/sql/analyzer/QueryExplainer.java b/presto-main/src/main/java/com/facebook/presto/sql/analyzer/QueryExplainer.java\nindex e4e9c6ea0a..2693418552 100644\n--- a/presto-main/src/main/java/com/facebook/presto/sql/analyzer/QueryExplainer.java\n+++ b/presto-main/src/main/java/com/facebook/presto/sql/analyzer/QueryExplainer.java\n\n@@ -194,7 +194,17 @@ public class QueryExplainer\n         // analyze statement\n         Analysis analysis = analyze(session, statement, parameters, warningCollector);\n         // plan statement\n-        LogicalPlanner logicalPlanner = new LogicalPlanner(true, session, planOptimizers, idAllocator, metadata, sqlParser, statsCalculator, costCalculator, warningCollector, planChecker);\n+        LogicalPlanner logicalPlanner = new LogicalPlanner(\n+                true,\n+                session,\n+                planOptimizers,\n+                idAllocator,\n+                metadata,\n+                sqlParser,\n+                statsCalculator,\n+                costCalculator,\n+                warningCollector,\n+                planChecker);\n         return logicalPlanner.plan(analysis);\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzEwNTI0OQ==", "url": "https://github.com/prestodb/presto/pull/14800#discussion_r453105249", "bodyText": "hmm... this basically says \"the table is not partitioned; or it's not partitioned on known columns (e.g. ds)\".\nReturning UNKNOWN for this is a bit weird. Because we know there is no violation / concern for sure. But I also don't have a good suggestions.\nSee if @rschlussel has any thought about how the enum values in PartitioningFilterCoverage should be . Otherwise, I am fine to keep it as is :)", "author": "wenleix", "createdAt": "2020-07-10T22:29:24Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -3030,6 +3034,19 @@ public void commit()\n         metastore.commit();\n     }\n \n+    @Override\n+    public PartitioningFilterCoverage getPartitioningFilterCoverage(ConnectorTableLayoutHandle connectorTableLayoutHandle, Set<String> relevantPartitionColumns)\n+    {\n+        HiveTableLayoutHandle tableHandle = (HiveTableLayoutHandle) connectorTableLayoutHandle;\n+        List<String> partitionKey = tableHandle.getPartitionColumns().stream().map(HiveColumnHandle::getName).collect(toList());\n+        Set<String> relevantColumns = partitionKey.stream().filter(relevantPartitionColumns::contains).collect(toSet());\n+        if (relevantColumns.isEmpty()) {\n+            return UNKNOWN;", "originalCommit": "7595fcbcb85d59dd6b1f73e9b29d177f532f12a7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgzMTA0MQ==", "url": "https://github.com/prestodb/presto/pull/14800#discussion_r453831041", "bodyText": "Unknown is pulling double duty as both unknown (not implemented by the connector) and not applicable (we know it's fine).\nWe could add a fourth value, the question is does that make the API easier to consume when there is nothing that leverages the distinction between unknown and not applicable.", "author": "aweisberg", "createdAt": "2020-07-13T18:00:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzEwNTI0OQ=="}], "type": "inlineReview", "revised_code": {"commit": "28ad7cd073e1e3bb4783420bc597548f163e9f01", "chunk": "diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\nindex d31ebfa674..1fcc72a27f 100644\n--- a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n+++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java\n\n@@ -3035,16 +3035,18 @@ public class HiveMetadata\n     }\n \n     @Override\n-    public PartitioningFilterCoverage getPartitioningFilterCoverage(ConnectorTableLayoutHandle connectorTableLayoutHandle, Set<String> relevantPartitionColumns)\n+    public TableLayoutFilterCoverage getTableLayoutFilterCoverage(ConnectorTableLayoutHandle connectorTableLayoutHandle, Set<String> relevantPartitionColumns)\n     {\n         HiveTableLayoutHandle tableHandle = (HiveTableLayoutHandle) connectorTableLayoutHandle;\n-        List<String> partitionKey = tableHandle.getPartitionColumns().stream().map(HiveColumnHandle::getName).collect(toList());\n-        Set<String> relevantColumns = partitionKey.stream().filter(relevantPartitionColumns::contains).collect(toSet());\n+        Set<String> relevantColumns = tableHandle.getPartitionColumns().stream()\n+                .map(HiveColumnHandle::getName)\n+                .filter(relevantPartitionColumns::contains)\n+                .collect(toImmutableSet());\n         if (relevantColumns.isEmpty()) {\n-            return UNKNOWN;\n+            return NOT_APPLICABLE;\n         }\n \n-        return Sets.intersection(tableHandle.getPredicateColumns().keySet(), relevantColumns).isEmpty() ? NONE : PARTIAL;\n+        return Sets.intersection(tableHandle.getPredicateColumns().keySet(), relevantColumns).isEmpty() ? NOT_COVERED : COVERED;\n     }\n \n     public static Optional<SchemaTableName> getSourceTableNameFromSystemTable(SchemaTableName tableName)\n"}}, {"oid": "28ad7cd073e1e3bb4783420bc597548f163e9f01", "url": "https://github.com/prestodb/presto/commit/28ad7cd073e1e3bb4783420bc597548f163e9f01", "message": "Warn on configured unfiltered partitions", "committedDate": "2020-07-13T21:56:07Z", "type": "forcePushed"}, {"oid": "f920de5c7015f53c68b5ef0bbe8bcc8aec9678ba", "url": "https://github.com/prestodb/presto/commit/f920de5c7015f53c68b5ef0bbe8bcc8aec9678ba", "message": "Warn on configured unfiltered partitions", "committedDate": "2020-07-13T21:57:07Z", "type": "forcePushed"}, {"oid": "5161f186527182bc88437422e55a1ed9cfa21d0f", "url": "https://github.com/prestodb/presto/commit/5161f186527182bc88437422e55a1ed9cfa21d0f", "message": "Warn on configured unfiltered partitions", "committedDate": "2020-07-14T15:11:02Z", "type": "forcePushed"}, {"oid": "7e6856661548152d33183a7aaff2f1822e062f1d", "url": "https://github.com/prestodb/presto/commit/7e6856661548152d33183a7aaff2f1822e062f1d", "message": "Warn on configured unfiltered partitions", "committedDate": "2020-07-14T15:18:47Z", "type": "forcePushed"}, {"oid": "770deb6d38e8e2c4c7eb7e70fbd47d0e2b12f3ad", "url": "https://github.com/prestodb/presto/commit/770deb6d38e8e2c4c7eb7e70fbd47d0e2b12f3ad", "message": "Warn on configured unfiltered partitions", "committedDate": "2020-07-14T15:21:06Z", "type": "forcePushed"}, {"oid": "31034ff866c4f25d107f16032b950914b58acf5d", "url": "https://github.com/prestodb/presto/commit/31034ff866c4f25d107f16032b950914b58acf5d", "message": "Warn on configured unfiltered partitions", "committedDate": "2020-07-14T17:52:14Z", "type": "forcePushed"}, {"oid": "8094b011cc950ec039ab88d3f480b544076143a1", "url": "https://github.com/prestodb/presto/commit/8094b011cc950ec039ab88d3f480b544076143a1", "message": "Rename PlanSanityChecker to PlanChecker", "committedDate": "2020-07-14T22:12:52Z", "type": "commit"}, {"oid": "8c884480ccb04409e633c7d90bcb3f32ed3b312d", "url": "https://github.com/prestodb/presto/commit/8c884480ccb04409e633c7d90bcb3f32ed3b312d", "message": "Support for checking partition key filter coverage", "committedDate": "2020-07-14T22:12:52Z", "type": "commit"}, {"oid": "7c88cf1adff4406c923e147bcdc133c75c8b2e61", "url": "https://github.com/prestodb/presto/commit/7c88cf1adff4406c923e147bcdc133c75c8b2e61", "message": "Warn on configured unfiltered partitions", "committedDate": "2020-07-14T22:13:31Z", "type": "forcePushed"}, {"oid": "f16789811512455552fecfdc338970daf083d327", "url": "https://github.com/prestodb/presto/commit/f16789811512455552fecfdc338970daf083d327", "message": "Warn on configured unfiltered partitions", "committedDate": "2020-07-14T22:43:03Z", "type": "commit"}, {"oid": "f16789811512455552fecfdc338970daf083d327", "url": "https://github.com/prestodb/presto/commit/f16789811512455552fecfdc338970daf083d327", "message": "Warn on configured unfiltered partitions", "committedDate": "2020-07-14T22:43:03Z", "type": "forcePushed"}]}