{"pr_number": 14650, "pr_title": "Fix header handling in Presto Proxy", "pr_createdAt": "2020-06-15T05:54:56Z", "pr_url": "https://github.com/prestodb/presto/pull/14650", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI3NDU1Nw==", "url": "https://github.com/prestodb/presto/pull/14650#discussion_r440274557", "bodyText": "Can you explain how this test verifies the header changes?", "author": "swapsmagic", "createdAt": "2020-06-15T15:49:51Z", "path": "presto-proxy/src/test/java/com/facebook/presto/proxy/TestProxyServer.java", "diffHunk": "@@ -142,6 +142,26 @@ public void testQuery()\n         }\n     }\n \n+    @Test\n+    public void testSetSession()", "originalCommit": "1461913ec01992044ec56250b982bf86476dbfb3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI4OTY4NA==", "url": "https://github.com/prestodb/presto/pull/14650#discussion_r440289684", "bodyText": "Headers are returned from the coordinator via the X-Presto-Set-Session header.  These headers are erroneously being serialized to String as Collection<String>, which caused them to be sent back from the coordinator as [query_max_stage_count=10] (singleton collection).  This test proves that the issue is fixed because we do not fail the query due to invalid session property name.", "author": "tdcmeehan", "createdAt": "2020-06-15T16:12:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI3NDU1Nw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI3ODE3NQ==", "url": "https://github.com/prestodb/presto/pull/14650#discussion_r441278175", "bodyText": "Would  response.getHeaders().forEach((headerName, value) work? Just remove asMap().", "author": "cemcayiroglu", "createdAt": "2020-06-17T04:48:16Z", "path": "presto-proxy/src/main/java/com/facebook/presto/proxy/ProxyResource.java", "diffHunk": "@@ -296,10 +296,10 @@ private static boolean isPrestoHeader(String name)\n \n     private static Response responseWithHeaders(ResponseBuilder builder, ProxyResponse response)\n     {\n-        response.getHeaders().asMap().forEach((headerName, value) -> {\n+        response.getHeaders().asMap().forEach((headerName, values) -> {", "originalCommit": "1461913ec01992044ec56250b982bf86476dbfb3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY5MDgwNw==", "url": "https://github.com/prestodb/presto/pull/14650#discussion_r441690807", "bodyText": "That works.", "author": "tdcmeehan", "createdAt": "2020-06-17T16:56:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI3ODE3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "af2ac73b4ab16e35d704372c4b34015e950b9110", "chunk": "diff --git a/presto-proxy/src/main/java/com/facebook/presto/proxy/ProxyResource.java b/presto-proxy/src/main/java/com/facebook/presto/proxy/ProxyResource.java\nindex 95f59d57ba..f1bc7896c0 100644\n--- a/presto-proxy/src/main/java/com/facebook/presto/proxy/ProxyResource.java\n+++ b/presto-proxy/src/main/java/com/facebook/presto/proxy/ProxyResource.java\n\n@@ -296,10 +284,10 @@ public class ProxyResource\n \n     private static Response responseWithHeaders(ResponseBuilder builder, ProxyResponse response)\n     {\n-        response.getHeaders().asMap().forEach((headerName, values) -> {\n+        response.getHeaders().forEach((headerName, value) -> {\n             String name = headerName.toString();\n             if (isPrestoHeader(name) || name.equalsIgnoreCase(SET_COOKIE)) {\n-                values.forEach(value -> builder.header(name, value));\n+                builder.header(name, value);\n             }\n         });\n         return builder.build();\n"}}, {"oid": "af2ac73b4ab16e35d704372c4b34015e950b9110", "url": "https://github.com/prestodb/presto/commit/af2ac73b4ab16e35d704372c4b34015e950b9110", "message": "Fix header handling in Presto Proxy", "committedDate": "2020-06-17T16:55:06Z", "type": "commit"}, {"oid": "af2ac73b4ab16e35d704372c4b34015e950b9110", "url": "https://github.com/prestodb/presto/commit/af2ac73b4ab16e35d704372c4b34015e950b9110", "message": "Fix header handling in Presto Proxy", "committedDate": "2020-06-17T16:55:06Z", "type": "forcePushed"}]}