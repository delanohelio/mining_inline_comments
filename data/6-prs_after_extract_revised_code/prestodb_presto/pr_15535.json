{"pr_number": 15535, "pr_title": "Add PrestoThriftPage", "pr_createdAt": "2020-12-16T23:33:37Z", "pr_url": "https://github.com/prestodb/presto/pull/15535", "timeline": [{"oid": "2e83abe570c265f6ebeb3bca8e7073e9324b861b", "url": "https://github.com/prestodb/presto/commit/2e83abe570c265f6ebeb3bca8e7073e9324b861b", "message": "Add PrestoThriftPage\n\nWrap List<PrestoThriftBlock> with positionCount so we can handle\nfunctions taking no arguments.", "committedDate": "2020-12-17T01:43:16Z", "type": "commit"}, {"oid": "2e83abe570c265f6ebeb3bca8e7073e9324b861b", "url": "https://github.com/prestodb/presto/commit/2e83abe570c265f6ebeb3bca8e7073e9324b861b", "message": "Add PrestoThriftPage\n\nWrap List<PrestoThriftBlock> with positionCount so we can handle\nfunctions taking no arguments.", "committedDate": "2020-12-17T01:43:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI5MzA4MA==", "url": "https://github.com/prestodb/presto/pull/15535#discussion_r545293080", "bodyText": "Since this is an example to help people write their own UDF service, maybe we should show a working case for no-arg UDFs, since there might be some confusion on how to properly handle it? It's not obvious what needs to be done for that situation. For example, need to write back results equal to number of input rows, etc.", "author": "prithvip", "createdAt": "2020-12-17T18:03:15Z", "path": "presto-thrift-testing-udf-server/src/main/java/com/facebook/presto/udf/thrift/EchoFirstInputThriftUdfService.java", "diffHunk": "@@ -50,7 +51,11 @@ public EchoFirstInputThriftUdfService(BlockEncodingSerde blockEncodingSerde)\n         ThriftUdfPage result;\n         switch (inputs.getPageFormat()) {\n             case PRESTO_THRIFT:\n-                result = thriftPage(ImmutableList.of(inputs.getThriftBlocks().get(0)));\n+                PrestoThriftPage thriftPage = inputs.getThriftPage();\n+                if (thriftPage.getThriftBlocks().isEmpty()) {\n+                    throw new UnsupportedOperationException(\"No input to echo\");", "originalCommit": "2e83abe570c265f6ebeb3bca8e7073e9324b861b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMwMjY4MA==", "url": "https://github.com/prestodb/presto/pull/15535#discussion_r545302680", "bodyText": "I think we should model this as a ThriftUnion, since it is an either/or with ThriftSerializedPage vs PrestoThriftPage. Clients won't have to write guard code to check to make sure that one of these is non-empty, and it would clarify the API.", "author": "prithvip", "createdAt": "2020-12-17T18:18:37Z", "path": "presto-thrift-api/src/main/java/com/facebook/presto/thrift/api/udf/ThriftUdfPage.java", "diffHunk": "@@ -54,9 +52,9 @@ public ThriftUdfPageFormat getPageFormat()\n \n     @Nullable\n     @ThriftField(value = 2, requiredness = OPTIONAL)", "originalCommit": "2e83abe570c265f6ebeb3bca8e7073e9324b861b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM4ODkzNA==", "url": "https://github.com/prestodb/presto/pull/15535#discussion_r545388934", "bodyText": "The problem is that we Java doesn't have that so there's not really a natural way to do it. The Thrift connector API also just used this model, which is why I did this too. But I agree with you on principal.", "author": "rongrong", "createdAt": "2020-12-17T20:39:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMwMjY4MA=="}], "type": "inlineReview", "revised_code": null}]}