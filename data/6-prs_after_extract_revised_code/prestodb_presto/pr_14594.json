{"pr_number": 14594, "pr_title": "Making Node Status Service Optional", "pr_createdAt": "2020-06-01T14:34:58Z", "pr_url": "https://github.com/prestodb/presto/pull/14594", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxMzgzOA==", "url": "https://github.com/prestodb/presto/pull/14594#discussion_r433513838", "bodyText": "can you clarify why do we need currentNode.getNodeIdentifier().compareTo(...)?", "author": "mayankgarg1990", "createdAt": "2020-06-01T22:01:20Z", "path": "presto-main/src/main/java/com/facebook/presto/metadata/DiscoveryNodeManager.java", "diffHunk": "@@ -230,7 +230,7 @@ private synchronized void refreshNodesInternal()\n         // TODO: make it a whitelist (a failure-detecting service selector) and maybe build in support for injecting this in airlift\n         Set<ServiceDescriptor> services = serviceSelector.selectAllServices().stream()\n                 .filter(service -> !failureDetector.getFailed().contains(service))\n-                .filter(service -> nodeStatusService.isAllowed(service.getNodeId()))\n+                .filter(service -> !nodeStatusService.isPresent() || nodeStatusService.get().isAllowed(service.getNodeId()) || currentNode.getNodeIdentifier().compareTo(service.getNodeId()) == 0)", "originalCommit": "f225123f0df76a37bffabda690588a97650b0fd4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU1NzI3NQ==", "url": "https://github.com/prestodb/presto/pull/14594#discussion_r433557275", "bodyText": "Given coordinator won't be part of the worker tier, putting this comparison will count coordinator host as well here.", "author": "swapsmagic", "createdAt": "2020-06-02T00:27:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxMzgzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU1Nzc3NQ==", "url": "https://github.com/prestodb/presto/pull/14594#discussion_r433557775", "bodyText": "Can you add a comment for this - it is not obvious by the look of it", "author": "mayankgarg1990", "createdAt": "2020-06-02T00:29:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxMzgzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQxNTAwMQ==", "url": "https://github.com/prestodb/presto/pull/14594#discussion_r438415001", "bodyText": "Sorry I don't understand this logic. It's comparing whether current node is the same as service. What's the relationship between this and coordinator? There is an isCoordinator method if you want to check for coordinator right? And why nodeStatusService cannot handle both coordinators and workers?", "author": "rongrong", "createdAt": "2020-06-10T21:20:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxMzgzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQyMjY2Mg==", "url": "https://github.com/prestodb/presto/pull/14594#discussion_r438422662", "bodyText": "DiscoveryNodeManager runs on coordinator, and our current implementation we only look for workers status through NodeStatusService. Given it's same machine where coordinator runs and this logic is for coordinator to find the active nodes, we let the same host check and let coordinator to join the active node pool.\nDidn't realize that isCoordinator method can serve the purpose, i can replace this with isCoordinator() method call instead.", "author": "swapsmagic", "createdAt": "2020-06-10T21:38:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxMzgzOA=="}], "type": "inlineReview", "revised_code": {"commit": "234899521db8b1cc7f4a9197880f56435e08cbe9", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/metadata/DiscoveryNodeManager.java b/presto-main/src/main/java/com/facebook/presto/metadata/DiscoveryNodeManager.java\nindex 0d5f7f04ea..23d533cec3 100644\n--- a/presto-main/src/main/java/com/facebook/presto/metadata/DiscoveryNodeManager.java\n+++ b/presto-main/src/main/java/com/facebook/presto/metadata/DiscoveryNodeManager.java\n\n@@ -230,6 +230,7 @@ public final class DiscoveryNodeManager\n         // TODO: make it a whitelist (a failure-detecting service selector) and maybe build in support for injecting this in airlift\n         Set<ServiceDescriptor> services = serviceSelector.selectAllServices().stream()\n                 .filter(service -> !failureDetector.getFailed().contains(service))\n+                // Allowing coordinator node in the list of services, even if it's not allowed by nodeStatusService with currentNode check\n                 .filter(service -> !nodeStatusService.isPresent() || nodeStatusService.get().isAllowed(service.getNodeId()) || currentNode.getNodeIdentifier().compareTo(service.getNodeId()) == 0)\n                 .collect(toImmutableSet());\n \n"}}, {"oid": "234899521db8b1cc7f4a9197880f56435e08cbe9", "url": "https://github.com/prestodb/presto/commit/234899521db8b1cc7f4a9197880f56435e08cbe9", "message": "Making Node Status Service Optional\n\nAllowing Node Status service to optional. Specific implemenation can be injected using newOptionalBinder.setInstance", "committedDate": "2020-06-02T01:26:42Z", "type": "forcePushed"}, {"oid": "ec81ea2bdec0a86b7b1fea9c6122aa7834df4548", "url": "https://github.com/prestodb/presto/commit/ec81ea2bdec0a86b7b1fea9c6122aa7834df4548", "message": "Making Node Status Service Optional\n\nAllowing Node Status service to optional. Specific implemenation can be injected using newOptionalBinder.setInstance", "committedDate": "2020-06-02T23:03:42Z", "type": "forcePushed"}, {"oid": "b93bcb4eacfcac43bd00e6900cdd1b3a276fe9fd", "url": "https://github.com/prestodb/presto/commit/b93bcb4eacfcac43bd00e6900cdd1b3a276fe9fd", "message": "Making Node Status Service Optional\n\nAllowing Node Status service to optional. Specific implemenation can be injected using newOptionalBinder.setInstance", "committedDate": "2020-06-10T10:51:47Z", "type": "forcePushed"}, {"oid": "ef6a651b40022ff52d942f8d9fd329132df6ed93", "url": "https://github.com/prestodb/presto/commit/ef6a651b40022ff52d942f8d9fd329132df6ed93", "message": "Making Node Status Service Optional\n\nAllowing Node Status service to optional. Specific implemenation can be injected using newOptionalBinder.setInstance", "committedDate": "2020-06-10T22:00:00Z", "type": "commit"}, {"oid": "ef6a651b40022ff52d942f8d9fd329132df6ed93", "url": "https://github.com/prestodb/presto/commit/ef6a651b40022ff52d942f8d9fd329132df6ed93", "message": "Making Node Status Service Optional\n\nAllowing Node Status service to optional. Specific implemenation can be injected using newOptionalBinder.setInstance", "committedDate": "2020-06-10T22:00:00Z", "type": "forcePushed"}]}