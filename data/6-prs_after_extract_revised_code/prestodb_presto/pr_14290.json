{"pr_number": 14290, "pr_title": "Move RemoteSplit URI construction from coordinator to worker", "pr_createdAt": "2020-03-24T23:13:09Z", "pr_url": "https://github.com/prestodb/presto/pull/14290", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUyMTQ4NA==", "url": "https://github.com/prestodb/presto/pull/14290#discussion_r397521484", "bodyText": "what are other string options except ASCII String? :P", "author": "wenleix", "createdAt": "2020-03-24T23:25:26Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/SqlStageExecution.java", "diffHunk": "@@ -542,7 +541,7 @@ public void recordGetSplitTime(long start)\n     private static Split createRemoteSplitFor(TaskId taskId, URI remoteSourceTaskLocation, TaskId remoteSourceTaskId)\n     {\n         // Fetch the results from the buffer assigned to the task based on id\n-        URI splitLocation = uriBuilderFrom(remoteSourceTaskLocation).appendPath(\"results\").appendPath(String.valueOf(taskId.getId())).build();\n+        String splitLocation = remoteSourceTaskLocation.toASCIIString() + \"/results/\" + taskId.getId();", "originalCommit": "e2d15f92364f09048e087ef76a4e2a90fe4a8484", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk4NTQ4OA==", "url": "https://github.com/prestodb/presto/pull/14290#discussion_r397985488", "bodyText": "It has a toString as well. The only difference is that toASCIIString will also encode the result string when there is non-ASCII character in the string. Do you have a preference? :)", "author": "shixuan-fan", "createdAt": "2020-03-25T16:17:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUyMTQ4NA=="}], "type": "inlineReview", "revised_code": {"commit": "c9bc0595db616568199086bc0d2b15243d1f848d", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/execution/SqlStageExecution.java b/presto-main/src/main/java/com/facebook/presto/execution/SqlStageExecution.java\nindex 4102b2a474..ec0f3c0e4d 100644\n--- a/presto-main/src/main/java/com/facebook/presto/execution/SqlStageExecution.java\n+++ b/presto-main/src/main/java/com/facebook/presto/execution/SqlStageExecution.java\n\n@@ -542,7 +542,7 @@ public final class SqlStageExecution\n     {\n         // Fetch the results from the buffer assigned to the task based on id\n         String splitLocation = remoteSourceTaskLocation.toASCIIString() + \"/results/\" + taskId.getId();\n-        return new Split(REMOTE_CONNECTOR_ID, new RemoteTransactionHandle(), new RemoteSplit(splitLocation, remoteSourceTaskId));\n+        return new Split(REMOTE_CONNECTOR_ID, new RemoteTransactionHandle(), new RemoteSplit(new Location(splitLocation), remoteSourceTaskId));\n     }\n \n     private void updateTaskStatus(TaskStatus taskStatus)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUyMTM5MQ==", "url": "https://github.com/prestodb/presto/pull/14290#discussion_r397521391", "bodyText": "Do we wanna create an abstraction called Location rather than using raw string? I'm thinking to replace the URI interfaces in LocationFactory all with Location.", "author": "highker", "createdAt": "2020-03-24T23:25:11Z", "path": "presto-main/src/main/java/com/facebook/presto/split/RemoteSplit.java", "diffHunk": "@@ -31,18 +30,18 @@\n public class RemoteSplit\n         implements ConnectorSplit\n {\n-    private final URI location;\n+    private final String location;", "originalCommit": "e2d15f92364f09048e087ef76a4e2a90fe4a8484", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c9bc0595db616568199086bc0d2b15243d1f848d", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/split/RemoteSplit.java b/presto-main/src/main/java/com/facebook/presto/split/RemoteSplit.java\nindex 1ffcf61966..2a479c6892 100644\n--- a/presto-main/src/main/java/com/facebook/presto/split/RemoteSplit.java\n+++ b/presto-main/src/main/java/com/facebook/presto/split/RemoteSplit.java\n\n@@ -30,18 +31,18 @@ import static java.util.Objects.requireNonNull;\n public class RemoteSplit\n         implements ConnectorSplit\n {\n-    private final String location;\n+    private final Location location;\n     private final TaskId remoteSourceTaskId;\n \n     @JsonCreator\n-    public RemoteSplit(@JsonProperty(\"location\") String location, @JsonProperty(\"remoteSourceTaskId\") TaskId remoteSourceTaskId)\n+    public RemoteSplit(@JsonProperty(\"location\") Location location, @JsonProperty(\"remoteSourceTaskId\") TaskId remoteSourceTaskId)\n     {\n         this.location = requireNonNull(location, \"location is null\");\n         this.remoteSourceTaskId = requireNonNull(remoteSourceTaskId, \"remoteSourceTaskId is null\");\n     }\n \n     @JsonProperty\n-    public String getLocation()\n+    public Location getLocation()\n     {\n         return location;\n     }\n"}}, {"oid": "c9bc0595db616568199086bc0d2b15243d1f848d", "url": "https://github.com/prestodb/presto/commit/c9bc0595db616568199086bc0d2b15243d1f848d", "message": "Move RemoteSplit URI construction from coordinator to worker\n\nCoordinator could spend ~200ms to construct the URIs in a single\nthread, which does not seem necessary and could be done in workers.", "committedDate": "2020-03-25T16:23:23Z", "type": "forcePushed"}, {"oid": "c2a77d309cabadf16bc6e28d20452a1f1c4942e7", "url": "https://github.com/prestodb/presto/commit/c2a77d309cabadf16bc6e28d20452a1f1c4942e7", "message": "Move RemoteSplit URI construction from coordinator to worker\n\nCoordinator could spend ~200ms to construct the URIs in a single\nthread, which does not seem necessary and could be done in workers.", "committedDate": "2020-03-25T16:25:38Z", "type": "forcePushed"}, {"oid": "122c4c7a847964ffe8aee9bd2206322cd86c5008", "url": "https://github.com/prestodb/presto/commit/122c4c7a847964ffe8aee9bd2206322cd86c5008", "message": "Move RemoteSplit URI construction from coordinator to worker\n\nCoordinator could spend ~200ms to construct the URIs in a single\nthread, which does not seem necessary and could be done in workers.", "committedDate": "2020-03-25T16:47:48Z", "type": "commit"}, {"oid": "122c4c7a847964ffe8aee9bd2206322cd86c5008", "url": "https://github.com/prestodb/presto/commit/122c4c7a847964ffe8aee9bd2206322cd86c5008", "message": "Move RemoteSplit URI construction from coordinator to worker\n\nCoordinator could spend ~200ms to construct the URIs in a single\nthread, which does not seem necessary and could be done in workers.", "committedDate": "2020-03-25T16:47:48Z", "type": "forcePushed"}]}