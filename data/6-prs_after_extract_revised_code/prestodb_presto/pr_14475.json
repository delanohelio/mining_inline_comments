{"pr_number": 14475, "pr_title": "FastutilSetHelper ObjectStrategy#equals result can be null.", "pr_createdAt": "2020-05-04T21:30:14Z", "pr_url": "https://github.com/prestodb/presto/pull/14475", "timeline": [{"oid": "95aad6a8cb6eacb2e0eee6e5c7ff9292acd3ab89", "url": "https://github.com/prestodb/presto/commit/95aad6a8cb6eacb2e0eee6e5c7ff9292acd3ab89", "message": "FastutilSetHelper ObjectStrategy equals result can be null.", "committedDate": "2020-05-04T22:42:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc3ODM3OQ==", "url": "https://github.com/prestodb/presto/pull/14475#discussion_r419778379", "bodyText": "generate the ROW(1,%s)", "author": "bhhari", "createdAt": "2020-05-04T23:01:59Z", "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHivePushdownFilterQueries.java", "diffHunk": "@@ -337,6 +337,17 @@ public void testFloats()\n         assertFilterProject(\"reals[1] > 0.01\", \"count(*)\");\n     }\n \n+    @Test\n+    public void testInComplexTypes()\n+    {\n+          String query = \"select * from (values('a'), (null)) as t (name) where ROW('1', name) IN ( ROW('1','2'), ROW('1','3'), \" +", "originalCommit": "95aad6a8cb6eacb2e0eee6e5c7ff9292acd3ab89", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a4a541df1a378f8c3c42e2bcec004963de937e66", "chunk": "diff --git a/presto-hive/src/test/java/com/facebook/presto/hive/TestHivePushdownFilterQueries.java b/presto-hive/src/test/java/com/facebook/presto/hive/TestHivePushdownFilterQueries.java\nindex 866a55ea6e..f73c38553a 100644\n--- a/presto-hive/src/test/java/com/facebook/presto/hive/TestHivePushdownFilterQueries.java\n+++ b/presto-hive/src/test/java/com/facebook/presto/hive/TestHivePushdownFilterQueries.java\n\n@@ -340,12 +340,14 @@ public class TestHivePushdownFilterQueries\n     @Test\n     public void testInComplexTypes()\n     {\n-          String query = \"select * from (values('a'), (null)) as t (name) where ROW('1', name) IN ( ROW('1','2'), ROW('1','3'), \" +\n-                    \"ROW('1','4'), ROW('1','5'), ROW('1','6'), ROW('1','7'), ROW('1','8'), ROW('1','9'), ROW('1','17'), ROW('1','16'), ROW('1','15'), \" +\n-                    \"ROW('1','14'), ROW('1','13'), ROW('1','12'), ROW('1','11'), ROW('1','10'), ROW('1','22'), ROW('1','23'), ROW('1','24'), ROW('1','25'),\" +\n-                    \" ROW('1','26'), ROW('1','27'), ROW('1','28'), ROW('1','29'), ROW('1','30'), ROW('1','31'), ROW('1','32'),ROW('1','33'), ROW('1','34'), \" +\n-                    \"ROW('1','35'),ROW('1', name), ROW('2',name), ROW('3',name))\";\n-          assertQueryUsingH2Cte(query);\n+        StringBuilder query = new StringBuilder(\"select * from (values('a'), (null)) as t (name) where ROW('1', name) IN ( \");\n+\n+        for (int i = 2; i < 32; i++) {\n+            query.append(String.format(\"ROW('1','%s'), \", i));\n+        }\n+        query.append(\"ROW('1', name), ROW('2',name), ROW('3',name))\");\n+\n+        assertQuerySucceeds(query.toString());\n     }\n \n     @Test\n"}}, {"oid": "a4a541df1a378f8c3c42e2bcec004963de937e66", "url": "https://github.com/prestodb/presto/commit/a4a541df1a378f8c3c42e2bcec004963de937e66", "message": "FastutilSetHelper ObjectStrategy equals result can be null.", "committedDate": "2020-05-05T00:19:00Z", "type": "forcePushed"}, {"oid": "5f72b87b3cbbeae1645ce553df3026d099ee42d5", "url": "https://github.com/prestodb/presto/commit/5f72b87b3cbbeae1645ce553df3026d099ee42d5", "message": "FastutilSetHelper ObjectStrategy equals result can be null.", "committedDate": "2020-05-05T16:06:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTEzMjk4NQ==", "url": "https://github.com/prestodb/presto/pull/14475#discussion_r421132985", "bodyText": "Please add this test case as well to make sure that correct answer (NULL) is returned.\n        StringBuilder query = new StringBuilder(\"select ROW(null_value) IN ( \");\n        for (int i = 0; i < 32; i++) {\n            query.append(String.format(\"ROW(%s), \", i));\n        }\n        query.append(\"ROW(32)) \");\n        query.append(\"FROM (values(null)) as t (null_value)\");\n        assertQuery(query.toString(), \"SELECT NULL\");\n\nThe ROW(NULL) IN (ROW(0), ...)  creates a collision required to get the equals path executed.\nAlso I would suggest moving this test to AbstractTestQueries, as there's nothing Hive specific about it.\nAlso please add a comment describing what kind of black magic are we doing here.", "author": "arhimondr", "createdAt": "2020-05-06T22:39:22Z", "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHivePushdownFilterQueries.java", "diffHunk": "@@ -337,6 +337,19 @@ public void testFloats()\n         assertFilterProject(\"reals[1] > 0.01\", \"count(*)\");\n     }\n \n+    @Test\n+    public void testInComplexTypes()", "originalCommit": "5f72b87b3cbbeae1645ce553df3026d099ee42d5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "96322404ad428892ac025f73141d0b0c9d9634be", "chunk": "diff --git a/presto-hive/src/test/java/com/facebook/presto/hive/TestHivePushdownFilterQueries.java b/presto-hive/src/test/java/com/facebook/presto/hive/TestHivePushdownFilterQueries.java\nindex f73c38553a..c849f0e415 100644\n--- a/presto-hive/src/test/java/com/facebook/presto/hive/TestHivePushdownFilterQueries.java\n+++ b/presto-hive/src/test/java/com/facebook/presto/hive/TestHivePushdownFilterQueries.java\n\n@@ -337,19 +337,6 @@ public class TestHivePushdownFilterQueries\n         assertFilterProject(\"reals[1] > 0.01\", \"count(*)\");\n     }\n \n-    @Test\n-    public void testInComplexTypes()\n-    {\n-        StringBuilder query = new StringBuilder(\"select * from (values('a'), (null)) as t (name) where ROW('1', name) IN ( \");\n-\n-        for (int i = 2; i < 32; i++) {\n-            query.append(String.format(\"ROW('1','%s'), \", i));\n-        }\n-        query.append(\"ROW('1', name), ROW('2',name), ROW('3',name))\");\n-\n-        assertQuerySucceeds(query.toString());\n-    }\n-\n     @Test\n     public void testMaps()\n     {\n"}}, {"oid": "96322404ad428892ac025f73141d0b0c9d9634be", "url": "https://github.com/prestodb/presto/commit/96322404ad428892ac025f73141d0b0c9d9634be", "message": "FastutilSetHelper ObjectStrategy equals result can be null.", "committedDate": "2020-05-06T23:32:14Z", "type": "commit"}, {"oid": "96322404ad428892ac025f73141d0b0c9d9634be", "url": "https://github.com/prestodb/presto/commit/96322404ad428892ac025f73141d0b0c9d9634be", "message": "FastutilSetHelper ObjectStrategy equals result can be null.", "committedDate": "2020-05-06T23:32:14Z", "type": "forcePushed"}]}