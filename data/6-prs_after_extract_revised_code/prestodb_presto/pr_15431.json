{"pr_number": 15431, "pr_title": "Support different concurrency", "pr_createdAt": "2020-11-12T16:14:38Z", "pr_url": "https://github.com/prestodb/presto/pull/15431", "timeline": [{"oid": "bd035077ed50dd66e57d9251f60198774836214b", "url": "https://github.com/prestodb/presto/commit/bd035077ed50dd66e57d9251f60198774836214b", "message": "Support different concurrency settings for table writer\n\nIf TableWriter input is fixed distributed (e.g.: aggregation or join)\nthe actual aggregation or join concurrency will be set to the\ntable writer concurrency", "committedDate": "2020-11-12T16:13:12Z", "type": "commit"}, {"oid": "d621c1d76077f5a0b87c4e345dc3d2b7a9ccc030", "url": "https://github.com/prestodb/presto/commit/d621c1d76077f5a0b87c4e345dc3d2b7a9ccc030", "message": "Prefer default parallelism to avoid adding extra local exchange\n\nFor partitioned writes the shuffle is added unconditionally. There's\nno reason to additionally prefer the fixed streams.", "committedDate": "2020-11-12T16:13:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ4MDg1MQ==", "url": "https://github.com/prestodb/presto/pull/15431#discussion_r522480851", "bodyText": "can this be if (taskWriterCount >= taskConcurrency) ?", "author": "viczhang861", "createdAt": "2020-11-12T22:47:27Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/AddLocalExchanges.java", "diffHunk": "@@ -508,21 +508,45 @@ public PlanWithProperties visitTableWriter(TableWriterNode originalTableWriterNo\n             PlanWithProperties tableWriter;\n \n             if (!originalTableWriterNode.getTablePartitioningScheme().isPresent()) {\n-                tableWriter = planAndEnforceChildren(\n-                        new TableWriterNode(\n-                                originalTableWriterNode.getId(),\n-                                originalTableWriterNode.getSource(),\n-                                originalTableWriterNode.getTarget(),\n-                                variableAllocator.newVariable(\"partialrowcount\", BIGINT),\n-                                variableAllocator.newVariable(\"partialfragments\", VARBINARY),\n-                                variableAllocator.newVariable(\"partialcontext\", VARBINARY),\n-                                originalTableWriterNode.getColumns(),\n-                                originalTableWriterNode.getColumnNames(),\n-                                originalTableWriterNode.getTablePartitioningScheme(),\n-                                originalTableWriterNode.getPreferredShufflePartitioningScheme(),\n-                                statisticAggregations.map(StatisticAggregations.Parts::getPartialAggregation)),\n-                        fixedParallelism(),\n-                        fixedParallelism());\n+                int taskWriterCount = getTaskWriterCount(session);\n+                int taskConcurrency = getTaskConcurrency(session);\n+                if (taskWriterCount == taskConcurrency) {", "originalCommit": "bd035077ed50dd66e57d9251f60198774836214b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ1OTkxNg==", "url": "https://github.com/prestodb/presto/pull/15431#discussion_r524459916", "bodyText": "No. We want to allow taskWriterCount  and taskConcurrency  to be set independently. It should be allowed to set higher taskWriterCount  than taskConcurrency .", "author": "arhimondr", "createdAt": "2020-11-16T17:50:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ4MDg1MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ5NzM2NA==", "url": "https://github.com/prestodb/presto/pull/15431#discussion_r522497364", "bodyText": "Could you explain why it is fixedParallelism() currently? I am trying to understand the difference for  public enum StreamDistribution { SINGLE, MULTIPLE, FIXED }", "author": "viczhang861", "createdAt": "2020-11-12T23:20:59Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/AddLocalExchanges.java", "diffHunk": "@@ -508,21 +508,45 @@ public PlanWithProperties visitTableWriter(TableWriterNode originalTableWriterNo\n             PlanWithProperties tableWriter;\n \n             if (!originalTableWriterNode.getTablePartitioningScheme().isPresent()) {\n-                tableWriter = planAndEnforceChildren(\n-                        new TableWriterNode(\n-                                originalTableWriterNode.getId(),\n-                                originalTableWriterNode.getSource(),\n-                                originalTableWriterNode.getTarget(),\n-                                variableAllocator.newVariable(\"partialrowcount\", BIGINT),\n-                                variableAllocator.newVariable(\"partialfragments\", VARBINARY),\n-                                variableAllocator.newVariable(\"partialcontext\", VARBINARY),\n-                                originalTableWriterNode.getColumns(),\n-                                originalTableWriterNode.getColumnNames(),\n-                                originalTableWriterNode.getTablePartitioningScheme(),\n-                                originalTableWriterNode.getPreferredShufflePartitioningScheme(),\n-                                statisticAggregations.map(StatisticAggregations.Parts::getPartialAggregation)),\n-                        fixedParallelism(),\n-                        fixedParallelism());\n+                int taskWriterCount = getTaskWriterCount(session);\n+                int taskConcurrency = getTaskConcurrency(session);\n+                if (taskWriterCount == taskConcurrency) {\n+                    tableWriter = planAndEnforceChildren(\n+                            new TableWriterNode(\n+                                    originalTableWriterNode.getId(),\n+                                    originalTableWriterNode.getSource(),\n+                                    originalTableWriterNode.getTarget(),\n+                                    variableAllocator.newVariable(\"partialrowcount\", BIGINT),\n+                                    variableAllocator.newVariable(\"partialfragments\", VARBINARY),\n+                                    variableAllocator.newVariable(\"partialcontext\", VARBINARY),\n+                                    originalTableWriterNode.getColumns(),\n+                                    originalTableWriterNode.getColumnNames(),\n+                                    originalTableWriterNode.getTablePartitioningScheme(),\n+                                    originalTableWriterNode.getPreferredShufflePartitioningScheme(),\n+                                    statisticAggregations.map(StatisticAggregations.Parts::getPartialAggregation)),\n+                            fixedParallelism(),", "originalCommit": "bd035077ed50dd66e57d9251f60198774836214b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ2MTYzMg==", "url": "https://github.com/prestodb/presto/pull/15431#discussion_r524461632", "bodyText": "SINGLE - single operator instance is required (e.g.: OrderByOperator, TopNOperator, TableCommitOperator, etc.)\nFIXED - fixed number of operator instances is required (e.g.: HashAggregationOperator, WindowOperator, etc)\nMULTIPLE - there's no requirement for the number of operator instances (e.g.: ScanFiterProject Operator).\n\n\nCould you explain why it is fixedParallelism() currently?\n\nWe request fixed parallelism to ensure that the number of TableWriterOperators is fixed for a given task, so it produces a fixed number of output files.", "author": "arhimondr", "createdAt": "2020-11-16T17:52:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ5NzM2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDgzODY3OA==", "url": "https://github.com/prestodb/presto/pull/15431#discussion_r524838678", "bodyText": "Thanks for explanation.", "author": "viczhang861", "createdAt": "2020-11-17T02:09:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ5NzM2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg5MjEyMg==", "url": "https://github.com/prestodb/presto/pull/15431#discussion_r524892122", "bodyText": "@arhimondr :\n\nMULTIPLE - there's no requirement for the number of operator instances (e.g.: ScanFiterProject Operator).\n\nSo essentially there will be one driver per each split?", "author": "wenleix", "createdAt": "2020-11-17T05:26:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ5NzM2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDUxNDU5MA==", "url": "https://github.com/prestodb/presto/pull/15431#discussion_r540514590", "bodyText": "So essentially there will be one driver per each split?\n\nYeah. And the number of divers run in parallel for scan is controlled by a different set of properties (e.g.: task.max-drivers-per-task)", "author": "arhimondr", "createdAt": "2020-12-10T21:36:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ5NzM2NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg5NTAzMQ==", "url": "https://github.com/prestodb/presto/pull/15431#discussion_r524895031", "bodyText": "What's the difference between fixedParallelism() and defaultParallelism?\nAlso from the commit message\n\nFor partitioned writes the shuffle is added unconditionally.\n\nCurious what does it mean by \"partitioned writes\"? Do you mean the table write input is fixed distribution? (e.g. following aggregation or join)", "author": "wenleix", "createdAt": "2020-11-17T05:36:26Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/AddLocalExchanges.java", "diffHunk": "@@ -549,7 +549,7 @@ public PlanWithProperties visitTableWriter(TableWriterNode originalTableWriterNo\n                 }\n             }\n             else {\n-                PlanWithProperties source = originalTableWriterNode.getSource().accept(this, fixedParallelism());\n+                PlanWithProperties source = originalTableWriterNode.getSource().accept(this, defaultParallelism(session));", "originalCommit": "d621c1d76077f5a0b87c4e345dc3d2b7a9ccc030", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg5NTgxMg==", "url": "https://github.com/prestodb/presto/pull/15431#discussion_r524895812", "bodyText": "Just to double check: this is more about avoiding unnecessary local exchange, right?", "author": "wenleix", "createdAt": "2020-11-17T05:39:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg5NTAzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDUxNzI5Mg==", "url": "https://github.com/prestodb/presto/pull/15431#discussion_r540517292", "bodyText": "What's the difference between fixedParallelism() and defaultParallelism?\n\nThe difference is subtle. fixedParallelism() - FIXED distribution is preferred. defaultParallelism - parallel distribution is preferred (either MULTIPLE or FIXED). Since we are adding a local exchange unconditionally it doesn't make sense to request FIXED.\n\nCurious what does it mean by \"partitioned writes\"? Do you mean the table write input is fixed distribution? (e.g. following aggregation or join)\n\npartitioned writes is when you write into a bucketed table. For bucketed tables a hash based exchange is added unconditionally for correctness.\n\nJust to double check: this is more about avoiding unnecessary local exchange, right?\n\nYeah, since we are adding an exchange on top unconditionally, we don't want the exchange to be added when planning the upstream node", "author": "arhimondr", "createdAt": "2020-12-10T21:41:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg5NTAzMQ=="}], "type": "inlineReview", "revised_code": null}]}