{"pr_number": 14439, "pr_title": "Pre-calculate nested positions array size in BlockEncodingBuffer", "pr_createdAt": "2020-04-26T02:08:21Z", "pr_url": "https://github.com/prestodb/presto/pull/14439", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk1MTk1Ng==", "url": "https://github.com/prestodb/presto/pull/14439#discussion_r415951956", "bodyText": "@yingsu00 perhaps, a cleaner design would be valuesBuffers.ensureCapacity(offsets[positionCount])", "author": "mbasmanova", "createdAt": "2020-04-27T16:14:41Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/repartition/ArrayBlockEncodingBuffer.java", "diffHunk": "@@ -259,17 +259,13 @@ private void populateNestedPositions(ColumnarArray columnarArray)\n         int[] positions = getPositions();\n \n         for (int i = 0; i < positionCount; i++) {\n-            int position = positions[i];\n-            int beginOffset = columnarArray.getOffset(position);\n-            int endOffset = columnarArray.getOffset(position + 1);\n-            int length = endOffset - beginOffset;\n+            offsets[i + 1] = offsets[i] + columnarArray.getLength(positions[i]);\n+        }\n \n-            offsets[i + 1] = offsets[i] + length;\n+        valuesBuffers.setPositions(ensureCapacity(valuesBuffers.getPositions(), offsets[positionCount], SMALL, NONE, bufferAllocator));", "originalCommit": "3a8b6053f3d9d15965b28367d8a6236e47448a6b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjI1OTU3Nw==", "url": "https://github.com/prestodb/presto/pull/14439#discussion_r416259577", "bodyText": "@mbasmanova Hi Masha, thanks for the suggestion. I actually thought of this approach before, but was hesitant to use it because the buffers inside the BlockEncodingBuffer is better to be hidden within the class. By using valuesBuffers.ensureCapacity(offsets[positionCount]), the caller(user) has to know what int[] or byte[] buffers are inside each of the BlockEncodingBuffer and we may have to identify which buffer to ensureCapacity on, e.g.  valuesBuffers.ensurePositionsCapacity() or valuesBuffers.ensureOffsetsCapacity(), or valuesBuffers.ensureCapacity(bufferType, capacity). On the other hand, I think adding a setPositions method is fair since we already had getPositions. What do you think? Do you strongly recommend to use  valuesBuffers.ensureCapacity(offsets[positionCount])?", "author": "yingsu00", "createdAt": "2020-04-28T01:23:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk1MTk1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjI2MDU5Nw==", "url": "https://github.com/prestodb/presto/pull/14439#discussion_r416260597", "bodyText": "@yingsu00 It is generally better to avoid having setters in classes other than POJOs, hence, my preference is to create narrow mutators.", "author": "mbasmanova", "createdAt": "2020-04-28T01:26:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk1MTk1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk2MzUyMg==", "url": "https://github.com/prestodb/presto/pull/14439#discussion_r416963522", "bodyText": "@mbasmanova ok, so I will add the valuesBuffers.ensureOffsetsCapacity(capacity) method to AbstractBlockEncodingBuffer. Does that sounds good?", "author": "yingsu00", "createdAt": "2020-04-28T22:32:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk1MTk1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk4OTA5Mw==", "url": "https://github.com/prestodb/presto/pull/14439#discussion_r416989093", "bodyText": "@yingsu00 Shouldn't it be ensurePositionsCapacity to match appendPositionRange? The contract would be that the caller should call ensurePositionsCapacity for the total number of positions that will be appended using appendPositionRange.", "author": "mbasmanova", "createdAt": "2020-04-28T23:42:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk1MTk1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "a3190c01e38d3e9a131170b8f085e826a9289161", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/operator/repartition/ArrayBlockEncodingBuffer.java b/presto-main/src/main/java/com/facebook/presto/operator/repartition/ArrayBlockEncodingBuffer.java\nindex cd6761b13d..eaa33995e2 100644\n--- a/presto-main/src/main/java/com/facebook/presto/operator/repartition/ArrayBlockEncodingBuffer.java\n+++ b/presto-main/src/main/java/com/facebook/presto/operator/repartition/ArrayBlockEncodingBuffer.java\n\n@@ -262,7 +262,7 @@ public class ArrayBlockEncodingBuffer\n             offsets[i + 1] = offsets[i] + columnarArray.getLength(positions[i]);\n         }\n \n-        valuesBuffers.setPositions(ensureCapacity(valuesBuffers.getPositions(), offsets[positionCount], SMALL, NONE, bufferAllocator));\n+        valuesBuffers.ensurePositionsCapacity(offsets[positionCount]);\n \n         for (int i = 0; i < positionCount; i++) {\n             valuesBuffers.appendPositionRange(columnarArray.getOffset(positions[i]), offsets[i + 1] - offsets[i]);\n"}}, {"oid": "a3190c01e38d3e9a131170b8f085e826a9289161", "url": "https://github.com/prestodb/presto/commit/a3190c01e38d3e9a131170b8f085e826a9289161", "message": "Pre-calculate nested positions array size in BlockEncodingBuffer\n\nThe positions array for nested BlockEncodingBuffer used to be grown on\nthe fly. This uses extra CPU and makes the positions array larger than\nrequired because the growth factor was 2.0. This commit pre-calculates\nthe nested positions array size, allocate the memory in one shot, then\npopulate the positions.", "committedDate": "2020-04-29T02:54:34Z", "type": "forcePushed"}, {"oid": "9da85e9c80c32311ba25c34ff50d80d8a755b872", "url": "https://github.com/prestodb/presto/commit/9da85e9c80c32311ba25c34ff50d80d8a755b872", "message": "Pre-calculate nested positions array size in BlockEncodingBuffer\n\nThe positions array for nested BlockEncodingBuffer used to be grown on\nthe fly. This uses extra CPU and makes the positions array larger than\nrequired because the growth factor was 2.0. This commit pre-calculates\nthe nested positions array size, allocate the memory in one shot, then\npopulate the positions.", "committedDate": "2020-05-01T00:20:10Z", "type": "commit"}, {"oid": "9da85e9c80c32311ba25c34ff50d80d8a755b872", "url": "https://github.com/prestodb/presto/commit/9da85e9c80c32311ba25c34ff50d80d8a755b872", "message": "Pre-calculate nested positions array size in BlockEncodingBuffer\n\nThe positions array for nested BlockEncodingBuffer used to be grown on\nthe fly. This uses extra CPU and makes the positions array larger than\nrequired because the growth factor was 2.0. This commit pre-calculates\nthe nested positions array size, allocate the memory in one shot, then\npopulate the positions.", "committedDate": "2020-05-01T00:20:10Z", "type": "forcePushed"}]}