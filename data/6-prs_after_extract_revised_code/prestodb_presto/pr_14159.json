{"pr_number": 14159, "pr_title": "Minor refactor of array_position", "pr_createdAt": "2020-02-25T22:34:48Z", "pr_url": "https://github.com/prestodb/presto/pull/14159", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDE4MDc0NQ==", "url": "https://github.com/prestodb/presto/pull/14159#discussion_r384180745", "bodyText": "Maybe something like array_position does not support elements of complex types that contain null? In theory T can be a map or a row.", "author": "arhimondr", "createdAt": "2020-02-25T23:04:52Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/scalar/ArrayPositionFunction.java", "diffHunk": "@@ -158,7 +159,9 @@ public static long arrayPosition(\n                 Object arrayValue = type.getObject(array, i);\n                 try {\n                     Boolean result = (Boolean) equalMethodHandle.invoke(arrayValue, element);\n-                    checkNotIndeterminate(result);\n+                    if (result == null) {\n+                        throw new PrestoException(NOT_SUPPORTED, \"array_position does not support element of array type that contains null\");", "originalCommit": "ad5295eeae4b05e26488302706cd850ecc7e1442", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d610addd3440258f2d39051140f7fcc2a1afcfdb", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/operator/scalar/ArrayPositionFunction.java b/presto-main/src/main/java/com/facebook/presto/operator/scalar/ArrayPositionFunction.java\nindex 94363ebeeb..c4011edb3d 100644\n--- a/presto-main/src/main/java/com/facebook/presto/operator/scalar/ArrayPositionFunction.java\n+++ b/presto-main/src/main/java/com/facebook/presto/operator/scalar/ArrayPositionFunction.java\n\n@@ -160,7 +160,7 @@ public final class ArrayPositionFunction\n                 try {\n                     Boolean result = (Boolean) equalMethodHandle.invoke(arrayValue, element);\n                     if (result == null) {\n-                        throw new PrestoException(NOT_SUPPORTED, \"array_position does not support element of array type that contains null\");\n+                        throw new PrestoException(NOT_SUPPORTED, \"array_position does not support elements of complex types that contain null\");\n                     }\n                     if (result) {\n                         return i + 1; // result is 1-based (instead of 0)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDE4MTYyMw==", "url": "https://github.com/prestodb/presto/pull/14159#discussion_r384181623", "bodyText": "nit: This check rather looks like an assertion. No matter what arguments are passed to this function the equals function should never return null, as the null case is explicitly checked before. For such assertions usually verify is preferred. (same for others).", "author": "arhimondr", "createdAt": "2020-02-25T23:07:17Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/scalar/ArrayPositionFunction.java", "diffHunk": "@@ -131,7 +132,7 @@ public static long arrayPosition(\n                 Slice arrayValue = type.getSlice(array, i);\n                 try {\n                     Boolean result = (Boolean) equalMethodHandle.invokeExact(arrayValue, element);\n-                    checkNotIndeterminate(result);\n+                    checkArgument(result != null, \"Array element should not be nulll\");", "originalCommit": "ad5295eeae4b05e26488302706cd850ecc7e1442", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDIwMDQyMQ==", "url": "https://github.com/prestodb/presto/pull/14159#discussion_r384200421", "bodyText": "IntelliJ would give warning on if (result) about null pointer exception when using verify. It's slightly annoying to look at but that's fine I suppose.", "author": "rongrong", "createdAt": "2020-02-25T23:59:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDE4MTYyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDUxNTU3NQ==", "url": "https://github.com/prestodb/presto/pull/14159#discussion_r384515575", "bodyText": "It is interesting why Intellij understands checkArgument but doesn't undestand verify =\\", "author": "arhimondr", "createdAt": "2020-02-26T14:12:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDE4MTYyMw=="}], "type": "inlineReview", "revised_code": {"commit": "d610addd3440258f2d39051140f7fcc2a1afcfdb", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/operator/scalar/ArrayPositionFunction.java b/presto-main/src/main/java/com/facebook/presto/operator/scalar/ArrayPositionFunction.java\nindex 94363ebeeb..c4011edb3d 100644\n--- a/presto-main/src/main/java/com/facebook/presto/operator/scalar/ArrayPositionFunction.java\n+++ b/presto-main/src/main/java/com/facebook/presto/operator/scalar/ArrayPositionFunction.java\n\n@@ -132,7 +132,7 @@ public final class ArrayPositionFunction\n                 Slice arrayValue = type.getSlice(array, i);\n                 try {\n                     Boolean result = (Boolean) equalMethodHandle.invokeExact(arrayValue, element);\n-                    checkArgument(result != null, \"Array element should not be nulll\");\n+                    verify(result != null, \"Array element should not be nul\");\n                     if (result) {\n                         return i + 1; // result is 1-based (instead of 0)\n                     }\n"}}, {"oid": "d610addd3440258f2d39051140f7fcc2a1afcfdb", "url": "https://github.com/prestodb/presto/commit/d610addd3440258f2d39051140f7fcc2a1afcfdb", "message": "Minor refactor of array_position\n\n* Remove redundant logic to check null on equal method invocation\n* Clarify error message", "committedDate": "2020-02-25T23:59:57Z", "type": "commit"}, {"oid": "d610addd3440258f2d39051140f7fcc2a1afcfdb", "url": "https://github.com/prestodb/presto/commit/d610addd3440258f2d39051140f7fcc2a1afcfdb", "message": "Minor refactor of array_position\n\n* Remove redundant logic to check null on equal method invocation\n* Clarify error message", "committedDate": "2020-02-25T23:59:57Z", "type": "forcePushed"}]}