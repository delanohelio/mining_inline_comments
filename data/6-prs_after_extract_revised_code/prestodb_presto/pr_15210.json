{"pr_number": 15210, "pr_title": "Report peak task memory in Presto-on-Spark", "pr_createdAt": "2020-09-22T21:28:30Z", "pr_url": "https://github.com/prestodb/presto/pull/15210", "timeline": [{"oid": "d0d38fd312a7f5fc7714bc89514b094fcffd1aa6", "url": "https://github.com/prestodb/presto/commit/d0d38fd312a7f5fc7714bc89514b094fcffd1aa6", "message": "Update peak memory in TaskContext for Presto-on-Spark task\n\nThe peak memory stats in TaskContext only get updated when\nTaskContext::getTaskStats(). Presto-on-Spark doesn't pull task stats\nactively so it needs to be updated explicitly.", "committedDate": "2020-09-22T23:09:37Z", "type": "forcePushed"}, {"oid": "112306ba775cffefaa516e49e7487d5a490bde3d", "url": "https://github.com/prestodb/presto/commit/112306ba775cffefaa516e49e7487d5a490bde3d", "message": "Update peak memory in TaskContext for Presto-on-Spark task\n\nThe peak memory stats in TaskContext only get updated when\nTaskContext::getTaskStats(). Presto-on-Spark doesn't pull task stats\nactively so it needs to be updated explicitly.", "committedDate": "2020-09-22T23:12:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg3NDQ3OA==", "url": "https://github.com/prestodb/presto/pull/15210#discussion_r493874478", "bodyText": "We can also make taskContext itself to refresh the peak memory usage periodically. What do you think? @arhimondr , @tdcmeehan ?", "author": "wenleix", "createdAt": "2020-09-23T20:27:07Z", "path": "presto-spark-base/src/main/java/com/facebook/presto/spark/execution/PrestoSparkTaskExecution.java", "diffHunk": "@@ -138,6 +141,9 @@ public PrestoSparkTaskExecution(\n                 \"Fragment is partitioned, but not all partitioned drivers were found\");\n \n         taskHandle = createTaskHandle(taskStateMachine, taskContext, localExecutionPlan, taskExecutor);\n+\n+        requireNonNull(memoryUpdateExecutor, \"memoryUpdateExecutorService is null\");\n+        memoryUpdateExecutor.schedule(taskContext::updatePeakMemory, 5, SECONDS);", "originalCommit": "112306ba775cffefaa516e49e7487d5a490bde3d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg3NzM2MQ==", "url": "https://github.com/prestodb/presto/pull/15210#discussion_r493877361", "bodyText": "How does it work in Presto classic? How is it getting refreshed?", "author": "arhimondr", "createdAt": "2020-09-23T20:32:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg3NDQ3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg4NDA0MQ==", "url": "https://github.com/prestodb/presto/pull/15210#discussion_r493884041", "bodyText": "From what I can tell, there's many ways it could be updated, but primarily it's done by TaskInfoFetcher calling into the tasks, which will call:\nTaskResource#getTaskInfo -> SqlTaskManager#getTaskInfo -> SqlTask#getTaskInfo -> SqlTask#createTaskInfo -> SqlTask#getTaskStats -> TaskContext#getTaskStats\nThe default interval there is 1s, but it could be quicker if the TaskStatus changes state before then (e.g. finishes).  I'm guessing here, there is nothing polling the info/status, hence the need to schedule this update from within the task?\nAlso, would it be inaccurate if the status transitions before the memoryUpdateExecutor executes its next update?  For example upon failure.", "author": "tdcmeehan", "createdAt": "2020-09-23T20:45:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg3NDQ3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg4ODkyNA==", "url": "https://github.com/prestodb/presto/pull/15210#discussion_r493888924", "bodyText": "I think the idea before was the stats were refreshed whenever there is a heartbeat from coordinator to worker/task.  Is there such a heartbeat in PoS we can piggy back off of?", "author": "tdcmeehan", "createdAt": "2020-09-23T20:54:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg3NDQ3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg5MDc1NA==", "url": "https://github.com/prestodb/presto/pull/15210#discussion_r493890754", "bodyText": "@arhimondr :\n\nHow does it work in Presto classic? How is it getting refreshed?\n\nThe peak memory stats in TaskContext only get updated when\nTaskContext::getTaskStats(). Presto-on-Spark doesn't pull task stats\nactively so it needs to be updated explicitly.", "author": "wenleix", "createdAt": "2020-09-23T20:57:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg3NDQ3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg5MTM4NQ==", "url": "https://github.com/prestodb/presto/pull/15210#discussion_r493891385", "bodyText": "@tdcmeehan  :\n\nI'm guessing here, there is nothing polling the info/status, hence the need to schedule this update from within the task?\n\nExactly.", "author": "wenleix", "createdAt": "2020-09-23T20:58:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg3NDQ3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg5MjUwNQ==", "url": "https://github.com/prestodb/presto/pull/15210#discussion_r493892505", "bodyText": "If that's the case, could we add a listener to taskStateMachine, and just update the stats when the state changes (as I presume nothing is looking at the stats in-between state transitions?)", "author": "tdcmeehan", "createdAt": "2020-09-23T21:01:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg3NDQ3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzkwNTg5Nw==", "url": "https://github.com/prestodb/presto/pull/15210#discussion_r493905897", "bodyText": "@tdcmeehan : But peak memory only goes up and down when state is RUNNING right?", "author": "wenleix", "createdAt": "2020-09-23T21:28:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg3NDQ3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM1MzgwNg==", "url": "https://github.com/prestodb/presto/pull/15210#discussion_r494353806", "bodyText": "It feels like it is reasonable to add an explicit updatePeakMemory method to the TaskContext and call it periodically. Given it is not needed for classic Presto i would keep the responsibility of periodically calling it on Presto on Spark code.", "author": "arhimondr", "createdAt": "2020-09-24T14:13:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg3NDQ3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ0NDAyMA==", "url": "https://github.com/prestodb/presto/pull/15210#discussion_r494444020", "bodyText": "@arhimondr : Agreed. That's why i did it in this way.\nAlthough I think make TaskContext do periodically update peak memory is not a bad idea (today in Presto classic it relies on periodic \"pull\" to get updated)... but i will leave as future disucssion/work", "author": "wenleix", "createdAt": "2020-09-24T16:14:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg3NDQ3OA=="}], "type": "inlineReview", "revised_code": {"commit": "5fd635befaf579009083082e5c414d765f915231", "chunk": "diff --git a/presto-spark-base/src/main/java/com/facebook/presto/spark/execution/PrestoSparkTaskExecution.java b/presto-spark-base/src/main/java/com/facebook/presto/spark/execution/PrestoSparkTaskExecution.java\nindex ee19a1bdac..e6609b0903 100644\n--- a/presto-spark-base/src/main/java/com/facebook/presto/spark/execution/PrestoSparkTaskExecution.java\n+++ b/presto-spark-base/src/main/java/com/facebook/presto/spark/execution/PrestoSparkTaskExecution.java\n\n@@ -141,9 +138,6 @@ public class PrestoSparkTaskExecution\n                 \"Fragment is partitioned, but not all partitioned drivers were found\");\n \n         taskHandle = createTaskHandle(taskStateMachine, taskContext, localExecutionPlan, taskExecutor);\n-\n-        requireNonNull(memoryUpdateExecutor, \"memoryUpdateExecutorService is null\");\n-        memoryUpdateExecutor.schedule(taskContext::updatePeakMemory, 5, SECONDS);\n     }\n \n     // this is a separate method to ensure that the `this` reference is not leaked during construction\n"}}, {"oid": "5fd635befaf579009083082e5c414d765f915231", "url": "https://github.com/prestodb/presto/commit/5fd635befaf579009083082e5c414d765f915231", "message": "Add comment to SerializedTaskInfo", "committedDate": "2020-09-24T23:28:28Z", "type": "commit"}, {"oid": "881b48fae16edf05188fe77f6af4ee312294529a", "url": "https://github.com/prestodb/presto/commit/881b48fae16edf05188fe77f6af4ee312294529a", "message": "Add peak task user memory to TaskStats", "committedDate": "2020-09-24T23:28:28Z", "type": "commit"}, {"oid": "8aa803f2f7e0870415b0f1d1b789539d95063b4e", "url": "https://github.com/prestodb/presto/commit/8aa803f2f7e0870415b0f1d1b789539d95063b4e", "message": "Minor tweak in Presto-on-Spark peak task user memory report", "committedDate": "2020-09-24T23:28:28Z", "type": "commit"}, {"oid": "a9d444e7909622749a9015b2efcc5039eaf8c136", "url": "https://github.com/prestodb/presto/commit/a9d444e7909622749a9015b2efcc5039eaf8c136", "message": "Update peak memory in TaskContext for Presto-on-Spark task\n\nThe peak memory stats in TaskContext only get updated when\nTaskContext::getTaskStats(). Presto-on-Spark doesn't pull task stats\nactively so it needs to be updated explicitly.", "committedDate": "2020-09-25T05:26:15Z", "type": "commit"}, {"oid": "a9d444e7909622749a9015b2efcc5039eaf8c136", "url": "https://github.com/prestodb/presto/commit/a9d444e7909622749a9015b2efcc5039eaf8c136", "message": "Update peak memory in TaskContext for Presto-on-Spark task\n\nThe peak memory stats in TaskContext only get updated when\nTaskContext::getTaskStats(). Presto-on-Spark doesn't pull task stats\nactively so it needs to be updated explicitly.", "committedDate": "2020-09-25T05:26:15Z", "type": "forcePushed"}]}