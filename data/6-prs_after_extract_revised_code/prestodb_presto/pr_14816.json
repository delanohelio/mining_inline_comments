{"pr_number": 14816, "pr_title": "Include scheduling stats of bucketed table to NodeSelectionStats", "pr_createdAt": "2020-07-09T06:11:27Z", "pr_url": "https://github.com/prestodb/presto/pull/14816", "timeline": [{"oid": "9fa80a460dcf46b5d5ffc9c931a3859c5d4e2c4a", "url": "https://github.com/prestodb/presto/commit/9fa80a460dcf46b5d5ffc9c931a3859c5d4e2c4a", "message": "Include scheduling stats of bucketed table to NodeSelectionStats\n\nPreviously we only took scheduling for unbucketed situation into\nconsideration for NodeSelectionStats, which is not sufficient.\nNow add scheduling stats for bucketed table to NodeSelectionStats\nas well.", "committedDate": "2020-07-09T17:21:44Z", "type": "forcePushed"}, {"oid": "3da4f50e8323c14330e70c7ee4d32927637efb97", "url": "https://github.com/prestodb/presto/commit/3da4f50e8323c14330e70c7ee4d32927637efb97", "message": "Include scheduling stats of bucketed table to NodeSelectionStats\n\nPreviously we only took scheduling for unbucketed situation into\nconsideration for NodeSelectionStats, which is not sufficient.\nNow add scheduling stats for bucketed table to NodeSelectionStats\nas well.", "committedDate": "2020-07-09T19:19:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzAwNTk0NA==", "url": "https://github.com/prestodb/presto/pull/14816#discussion_r453005944", "bodyText": "nit: \"nodeSelectionStats is null\"", "author": "shixuan-fan", "createdAt": "2020-07-10T18:29:42Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/scheduler/nodeSelection/TopologyAwareNodeSelector.java", "diffHunk": "@@ -85,6 +87,7 @@ public TopologyAwareNodeSelector(\n             NetworkLocationCache networkLocationCache)\n     {\n         this.nodeManager = requireNonNull(nodeManager, \"nodeManager is null\");\n+        this.nodeSelectionStats = requireNonNull(nodeSelectionStats, \"nodeSelectionStats\");", "originalCommit": "3da4f50e8323c14330e70c7ee4d32927637efb97", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0cdcb1715974865c844e38bc658587ce105bd904", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/execution/scheduler/nodeSelection/TopologyAwareNodeSelector.java b/presto-main/src/main/java/com/facebook/presto/execution/scheduler/nodeSelection/TopologyAwareNodeSelector.java\nindex 96169505c4..f168f86b29 100644\n--- a/presto-main/src/main/java/com/facebook/presto/execution/scheduler/nodeSelection/TopologyAwareNodeSelector.java\n+++ b/presto-main/src/main/java/com/facebook/presto/execution/scheduler/nodeSelection/TopologyAwareNodeSelector.java\n\n@@ -87,7 +87,7 @@ public class TopologyAwareNodeSelector\n             NetworkLocationCache networkLocationCache)\n     {\n         this.nodeManager = requireNonNull(nodeManager, \"nodeManager is null\");\n-        this.nodeSelectionStats = requireNonNull(nodeSelectionStats, \"nodeSelectionStats\");\n+        this.nodeSelectionStats = requireNonNull(nodeSelectionStats, \"nodeSelectionStats is null\");\n         this.nodeTaskMap = requireNonNull(nodeTaskMap, \"nodeTaskMap is null\");\n         this.includeCoordinator = includeCoordinator;\n         this.nodeMap = new AtomicReference<>(nodeMap);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzAwNjc4OQ==", "url": "https://github.com/prestodb/presto/pull/14816#discussion_r453006789", "bodyText": "Sorry if it is mentioned before, does bucketed table node selection have non-primary preferred node?", "author": "shixuan-fan", "createdAt": "2020-07-10T18:31:29Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/scheduler/NodeScheduler.java", "diffHunk": "@@ -308,6 +310,10 @@ public static SplitPlacementResult selectDistributionNodes(\n                     assignmentStats.getQueuedSplitCountForStage(node) < maxPendingSplitsPerTask) {\n                 if (isCacheable) {\n                     split = new Split(split.getConnectorId(), split.getTransactionHandle(), split.getConnectorSplit(), split.getLifespan(), new SplitContext(true));\n+                    nodeSelectionStats.incrementBucketedPreferredNodeSelectedCount();", "originalCommit": "3da4f50e8323c14330e70c7ee4d32927637efb97", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzAwOTU5OA==", "url": "https://github.com/prestodb/presto/pull/14816#discussion_r453009598", "bodyText": "Good question, actually we don't have that for bucketed table node selection; Just primary and non-preferred", "author": "kewang1024", "createdAt": "2020-07-10T18:37:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzAwNjc4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3MTYyMQ==", "url": "https://github.com/prestodb/presto/pull/14816#discussion_r453071621", "bodyText": "Is it necessary for us to separate bucketed from unbucketed? Can we merge them into existing stats?", "author": "shixuan-fan", "createdAt": "2020-07-10T20:52:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzAwNjc4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzEwMjE2OA==", "url": "https://github.com/prestodb/presto/pull/14816#discussion_r453102168", "bodyText": "yeah, I also thought about that at first, then I feel it would be confusing since unbucketed situation has three status and bucketed has two; thus add those two for easy debugging when we have mixed situation", "author": "kewang1024", "createdAt": "2020-07-10T22:18:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzAwNjc4OQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "0cdcb1715974865c844e38bc658587ce105bd904", "url": "https://github.com/prestodb/presto/commit/0cdcb1715974865c844e38bc658587ce105bd904", "message": "Include scheduling stats of bucketed table to NodeSelectionStats\n\nPreviously we only took scheduling for unbucketed situation into\nconsideration for NodeSelectionStats, which is not sufficient.\nNow add scheduling stats for bucketed table to NodeSelectionStats\nas well.", "committedDate": "2020-07-10T18:38:58Z", "type": "commit"}, {"oid": "0cdcb1715974865c844e38bc658587ce105bd904", "url": "https://github.com/prestodb/presto/commit/0cdcb1715974865c844e38bc658587ce105bd904", "message": "Include scheduling stats of bucketed table to NodeSelectionStats\n\nPreviously we only took scheduling for unbucketed situation into\nconsideration for NodeSelectionStats, which is not sufficient.\nNow add scheduling stats for bucketed table to NodeSelectionStats\nas well.", "committedDate": "2020-07-10T18:38:58Z", "type": "forcePushed"}]}