{"pr_number": 14606, "pr_title": "Create warning for COUNT(DISTINCT) to use approx_distinct", "pr_createdAt": "2020-06-04T06:58:29Z", "pr_url": "https://github.com/prestodb/presto/pull/14606", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY3MzAwNA==", "url": "https://github.com/prestodb/presto/pull/14606#discussion_r435673004", "bodyText": "COUNT is an aggregation function so you can add this check in the following block. And let's use standard libraries to check for function FunctionResolution.isCountFunction.", "author": "rongrong", "createdAt": "2020-06-05T03:38:38Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/analyzer/AggregationAnalyzer.java", "diffHunk": "@@ -314,6 +322,7 @@ protected Boolean visitInPredicate(InPredicate node, Void context)\n         @Override\n         protected Boolean visitFunctionCall(FunctionCall node, Void context)\n         {\n+            warnIfDistinctCount(node);", "originalCommit": "74998eec9904348c00c9b160c93ea15acb148047", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "23dfdc8cc9608af556e281726a5baf0bba89db53", "chunk": "diff --git a/presto-main/src/main/java/com/facebook/presto/sql/analyzer/AggregationAnalyzer.java b/presto-main/src/main/java/com/facebook/presto/sql/analyzer/AggregationAnalyzer.java\nindex b785be902f..e33a565eb5 100644\n--- a/presto-main/src/main/java/com/facebook/presto/sql/analyzer/AggregationAnalyzer.java\n+++ b/presto-main/src/main/java/com/facebook/presto/sql/analyzer/AggregationAnalyzer.java\n\n@@ -322,8 +325,12 @@ class AggregationAnalyzer\n         @Override\n         protected Boolean visitFunctionCall(FunctionCall node, Void context)\n         {\n-            warnIfDistinctCount(node);\n             if (metadata.getFunctionManager().getFunctionMetadata(analysis.getFunctionHandle(node)).getFunctionKind() == AGGREGATE) {\n+                if (functionResolution.isCountFunction(analysis.getFunctionHandle(node)) && node.isDistinct()) {\n+                    warningCollector.add(new PrestoWarning(\n+                            PERFORMANCE_WARNING,\n+                            \"COUNT(DISTINCT xxx) can be a very expensive operation when the cardinality is high for xxx. In most scenarios, using approx_distinct instead would be enough\"));\n+                }\n                 if (!node.getWindow().isPresent()) {\n                     List<FunctionCall> aggregateFunctions = extractAggregateFunctions(analysis.getFunctionHandles(), node.getArguments(), metadata.getFunctionManager());\n                     List<FunctionCall> windowFunctions = extractWindowFunctions(node.getArguments());\n"}}, {"oid": "23dfdc8cc9608af556e281726a5baf0bba89db53", "url": "https://github.com/prestodb/presto/commit/23dfdc8cc9608af556e281726a5baf0bba89db53", "message": "Create warning for COUNT(DISTINCT) to use approx_distinct", "committedDate": "2020-06-05T04:22:41Z", "type": "forcePushed"}, {"oid": "8095e6c807e8b31d14ac2b54ddf81613d2e510ea", "url": "https://github.com/prestodb/presto/commit/8095e6c807e8b31d14ac2b54ddf81613d2e510ea", "message": "Create warning for COUNT(DISTINCT) to use approx_distinct due to performance savings", "committedDate": "2020-06-08T19:21:06Z", "type": "forcePushed"}, {"oid": "f331a5d486ea83d5375f4822816764d63012fd53", "url": "https://github.com/prestodb/presto/commit/f331a5d486ea83d5375f4822816764d63012fd53", "message": "Create warning for COUNT(DISTINCT) to use approx_distinct due to performance savings", "committedDate": "2020-06-08T23:52:56Z", "type": "forcePushed"}, {"oid": "be4a8cd8a91cd1c4870e4fbbb3171fb6645bfecc", "url": "https://github.com/prestodb/presto/commit/be4a8cd8a91cd1c4870e4fbbb3171fb6645bfecc", "message": "Create warning for COUNT(DISTINCT) to use approx_distinct", "committedDate": "2020-06-08T23:55:38Z", "type": "forcePushed"}, {"oid": "f6ed76db7fbdfd62590db4bd9acf32a55665e0dd", "url": "https://github.com/prestodb/presto/commit/f6ed76db7fbdfd62590db4bd9acf32a55665e0dd", "message": "Create warning for COUNT(DISTINCT) to use approx_distinct for performance benefits", "committedDate": "2020-06-09T03:00:39Z", "type": "commit"}, {"oid": "f6ed76db7fbdfd62590db4bd9acf32a55665e0dd", "url": "https://github.com/prestodb/presto/commit/f6ed76db7fbdfd62590db4bd9acf32a55665e0dd", "message": "Create warning for COUNT(DISTINCT) to use approx_distinct for performance benefits", "committedDate": "2020-06-09T03:00:39Z", "type": "forcePushed"}]}