{"pr_number": 13922, "pr_title": "Improve error handling for geometry deserialization edge cases", "pr_createdAt": "2020-01-03T18:49:19Z", "pr_url": "https://github.com/prestodb/presto/pull/13922", "timeline": [{"oid": "58d5d39cb936a03430db4a97319838b8b431ad29", "url": "https://github.com/prestodb/presto/commit/58d5d39cb936a03430db4a97319838b8b431ad29", "message": "Capture geometry deserialization failures\n\nCertain geometries could be constructed (via GeometryFromText), but\ncould not be deserialized: it raised non-PrestoException exceptions that\nbubbled up as non-catchable GenericInternalExceptions.  This is a bad\nuser experience!  This change catches those and raise catchable\nPrestoExceptions.", "committedDate": "2020-01-08T16:34:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDM5MjQ5MQ==", "url": "https://github.com/prestodb/presto/pull/13922#discussion_r364392491", "bodyText": "Is this error path tested exercised by any test? Looks like deserialize catches the GeometryException and wraps it so is this necessary?", "author": "aweisberg", "createdAt": "2020-01-08T19:03:01Z", "path": "presto-geospatial/src/main/java/com/facebook/presto/plugin/geospatial/GeometryType.java", "diffHunk": "@@ -83,6 +86,11 @@ public Object getObjectValue(ConnectorSession session, Block block, int position\n             return null;\n         }\n         Slice slice = block.getSlice(position, 0, block.getSliceLength(position));\n-        return deserialize(slice).asText();\n+        try {", "originalCommit": "58d5d39cb936a03430db4a97319838b8b431ad29", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7ba109f08540567edccd7111368adb5484a7bb37", "chunk": "diff --git a/presto-geospatial/src/main/java/com/facebook/presto/plugin/geospatial/GeometryType.java b/presto-geospatial/src/main/java/com/facebook/presto/plugin/geospatial/GeometryType.java\nindex d4f0aac6b8..724f855382 100644\n--- a/presto-geospatial/src/main/java/com/facebook/presto/plugin/geospatial/GeometryType.java\n+++ b/presto-geospatial/src/main/java/com/facebook/presto/plugin/geospatial/GeometryType.java\n\n@@ -86,11 +83,6 @@ public class GeometryType\n             return null;\n         }\n         Slice slice = block.getSlice(position, 0, block.getSliceLength(position));\n-        try {\n-            return deserialize(slice).asText();\n-        }\n-        catch (GeometryException e) {\n-            throw new PrestoException(INVALID_FUNCTION_ARGUMENT, e.getMessage(), e);\n-        }\n+        return deserialize(slice).asText();\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQwMjEyOA==", "url": "https://github.com/prestodb/presto/pull/13922#discussion_r364402128", "bodyText": "When I ran TestGeometrySerialization I didn't see this exercised in the debugger.", "author": "aweisberg", "createdAt": "2020-01-08T19:24:40Z", "path": "presto-geospatial-toolkit/src/main/java/com/facebook/presto/geospatial/serde/EsriGeometrySerde.java", "diffHunk": "@@ -171,7 +174,12 @@ public static OGCGeometry deserialize(Slice shape)\n         verify(input.available() > 0);\n         int length = input.available() - 1;\n         GeometrySerializationType type = GeometrySerializationType.getForCode(input.readByte());\n-        return readGeometry(input, shape, type, length);\n+        try {\n+            return readGeometry(input, shape, type, length);\n+        }\n+        catch (GeometryException e) {\n+            throw new PrestoException(INVALID_FUNCTION_ARGUMENT, e.getMessage(), e);", "originalCommit": "58d5d39cb936a03430db4a97319838b8b431ad29", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7ba109f08540567edccd7111368adb5484a7bb37", "chunk": "diff --git a/presto-geospatial-toolkit/src/main/java/com/facebook/presto/geospatial/serde/EsriGeometrySerde.java b/presto-geospatial-toolkit/src/main/java/com/facebook/presto/geospatial/serde/EsriGeometrySerde.java\nindex 3dc1d3e06e..536c81089b 100644\n--- a/presto-geospatial-toolkit/src/main/java/com/facebook/presto/geospatial/serde/EsriGeometrySerde.java\n+++ b/presto-geospatial-toolkit/src/main/java/com/facebook/presto/geospatial/serde/EsriGeometrySerde.java\n\n@@ -174,12 +171,7 @@ public class EsriGeometrySerde\n         verify(input.available() > 0);\n         int length = input.available() - 1;\n         GeometrySerializationType type = GeometrySerializationType.getForCode(input.readByte());\n-        try {\n-            return readGeometry(input, shape, type, length);\n-        }\n-        catch (GeometryException e) {\n-            throw new PrestoException(INVALID_FUNCTION_ARGUMENT, e.getMessage(), e);\n-        }\n+        return readGeometry(input, shape, type, length);\n     }\n \n     private static OGCGeometry readGeometry(BasicSliceInput input, Slice inputSlice, GeometrySerializationType type, int length)\n"}}, {"oid": "7ba109f08540567edccd7111368adb5484a7bb37", "url": "https://github.com/prestodb/presto/commit/7ba109f08540567edccd7111368adb5484a7bb37", "message": "Capture geometry deserialization failures\n\nCertain geometries could be constructed (via GeometryFromText), but\ncould not be deserialized: it raised non-PrestoException exceptions that\nbubbled up as non-catchable GenericInternalExceptions.  This is a bad\nuser experience!  This change catches those and raise catchable\nPrestoExceptions.", "committedDate": "2020-01-08T20:21:12Z", "type": "forcePushed"}, {"oid": "58d5d39cb936a03430db4a97319838b8b431ad29", "url": "https://github.com/prestodb/presto/commit/58d5d39cb936a03430db4a97319838b8b431ad29", "message": "Capture geometry deserialization failures\n\nCertain geometries could be constructed (via GeometryFromText), but\ncould not be deserialized: it raised non-PrestoException exceptions that\nbubbled up as non-catchable GenericInternalExceptions.  This is a bad\nuser experience!  This change catches those and raise catchable\nPrestoExceptions.", "committedDate": "2020-01-08T16:34:37Z", "type": "forcePushed"}, {"oid": "155871f93e34f0f06a46729e441f3d5076e4b122", "url": "https://github.com/prestodb/presto/commit/155871f93e34f0f06a46729e441f3d5076e4b122", "message": "Use helper method jtsGeometryFromWkt", "committedDate": "2020-01-09T21:30:34Z", "type": "commit"}, {"oid": "28b3d8eba67952e70244c66ec9fd006a6a68bb69", "url": "https://github.com/prestodb/presto/commit/28b3d8eba67952e70244c66ec9fd006a6a68bb69", "message": "Capture geometry deserialization failures\n\nCertain geometries could be constructed (via GeometryFromText), but\ncould not be deserialized: it raised non-PrestoException exceptions that\nbubbled up as non-catchable GenericInternalExceptions.  This is a bad\nuser experience!  This change catches those and raise catchable\nPrestoExceptions.", "committedDate": "2020-01-09T21:30:34Z", "type": "commit"}, {"oid": "28b3d8eba67952e70244c66ec9fd006a6a68bb69", "url": "https://github.com/prestodb/presto/commit/28b3d8eba67952e70244c66ec9fd006a6a68bb69", "message": "Capture geometry deserialization failures\n\nCertain geometries could be constructed (via GeometryFromText), but\ncould not be deserialized: it raised non-PrestoException exceptions that\nbubbled up as non-catchable GenericInternalExceptions.  This is a bad\nuser experience!  This change catches those and raise catchable\nPrestoExceptions.", "committedDate": "2020-01-09T21:30:34Z", "type": "forcePushed"}]}