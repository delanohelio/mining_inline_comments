{"pr_number": 14146, "pr_title": "A quick and dirty fix of CTAS failures: unable to rename from viewfs", "pr_createdAt": "2020-02-23T06:48:58Z", "pr_url": "https://github.com/prestodb/presto/pull/14146", "timeline": [{"oid": "dba9aef8a2cae8d0d535c82ea76e24c54bd25524", "url": "https://github.com/prestodb/presto/commit/dba9aef8a2cae8d0d535c82ea76e24c54bd25524", "message": "fix CTAS failures when using viewfs", "committedDate": "2020-08-24T21:28:54Z", "type": "commit"}, {"oid": "03e5b7ecc4e13066e3ef1217f00329622f2e574a", "url": "https://github.com/prestodb/presto/commit/03e5b7ecc4e13066e3ef1217f00329622f2e574a", "message": "Create temporary root folder if it does not exist.\nAdd unit test for the creating temporary folder", "committedDate": "2020-08-25T02:00:18Z", "type": "forcePushed"}, {"oid": "2ba6c154c4c2c9ee843ace53bcedcdc8e0a5ab66", "url": "https://github.com/prestodb/presto/commit/2ba6c154c4c2c9ee843ace53bcedcdc8e0a5ab66", "message": "Create temporary root folder if it does not exist.\nAdd unit test for the creating temporary folder", "committedDate": "2020-08-25T04:04:58Z", "type": "forcePushed"}, {"oid": "57c1be4837e0373e1e9b6b31beb60de5e5f4b453", "url": "https://github.com/prestodb/presto/commit/57c1be4837e0373e1e9b6b31beb60de5e5f4b453", "message": "Create temporary root folder if it does not exist and add unit test for creating temporary folder", "committedDate": "2020-08-25T04:12:55Z", "type": "forcePushed"}, {"oid": "4eae741c7a165d196b6bee3af285f6643b8209dc", "url": "https://github.com/prestodb/presto/commit/4eae741c7a165d196b6bee3af285f6643b8209dc", "message": "Create temporary root folder when it does not exist and add unit test", "committedDate": "2020-08-25T06:27:21Z", "type": "commit"}, {"oid": "4eae741c7a165d196b6bee3af285f6643b8209dc", "url": "https://github.com/prestodb/presto/commit/4eae741c7a165d196b6bee3af285f6643b8209dc", "message": "Create temporary root folder when it does not exist and add unit test", "committedDate": "2020-08-25T06:27:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY3NDA5Mg==", "url": "https://github.com/prestodb/presto/pull/14146#discussion_r476674092", "bodyText": "do we need this line?", "author": "zhenxiao", "createdAt": "2020-08-25T19:05:21Z", "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHiveWriteUtils.java", "diffHunk": "@@ -13,18 +13,25 @@\n  */\n package com.facebook.presto.hive;\n \n+import com.google.common.io.Files;\n import org.apache.hadoop.fs.Path;\n import org.testng.annotations.Test;\n \n+import java.util.UUID;\n+\n+import static com.facebook.presto.hive.HiveTestUtils.SESSION;\n import static com.facebook.presto.hive.HiveTestUtils.createTestHdfsEnvironment;\n+import static com.facebook.presto.hive.HiveWriteUtils.createTemporaryPath;\n import static com.facebook.presto.hive.HiveWriteUtils.isS3FileSystem;\n import static com.facebook.presto.hive.HiveWriteUtils.isViewFileSystem;\n-import static com.facebook.presto.testing.TestingConnectorSession.SESSION;\n+import static org.testng.Assert.assertEquals;\n import static org.testng.Assert.assertFalse;\n import static org.testng.Assert.assertTrue;\n+import static org.testng.Assert.fail;\n \n public class TestHiveWriteUtils\n {\n+    //HdfsContext CONTEXT = new HdfsContext(new ConnectorIdentity(\"test\", Optional.empty(), Optional.empty()));", "originalCommit": "4eae741c7a165d196b6bee3af285f6643b8209dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjcyNzEwOA==", "url": "https://github.com/prestodb/presto/pull/14146#discussion_r476727108", "bodyText": "removed", "author": "beinan", "createdAt": "2020-08-25T20:46:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY3NDA5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "7f4fc12f8a2833e8a58d89f17193ce7f1ba95d01", "chunk": "diff --git a/presto-hive/src/test/java/com/facebook/presto/hive/TestHiveWriteUtils.java b/presto-hive/src/test/java/com/facebook/presto/hive/TestHiveWriteUtils.java\nindex 3d9d19e0f1..7f847ab1f7 100644\n--- a/presto-hive/src/test/java/com/facebook/presto/hive/TestHiveWriteUtils.java\n+++ b/presto-hive/src/test/java/com/facebook/presto/hive/TestHiveWriteUtils.java\n\n@@ -17,6 +17,7 @@ import com.google.common.io.Files;\n import org.apache.hadoop.fs.Path;\n import org.testng.annotations.Test;\n \n+import java.io.File;\n import java.util.UUID;\n \n import static com.facebook.presto.hive.HiveTestUtils.SESSION;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY3NjY1MA==", "url": "https://github.com/prestodb/presto/pull/14146#discussion_r476676650", "bodyText": "could we have testcases for both targetPath exist and not exist?", "author": "zhenxiao", "createdAt": "2020-08-25T19:10:16Z", "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHiveWriteUtils.java", "diffHunk": "@@ -48,4 +55,39 @@ public void testIsViewFileSystem()\n         assertTrue(isViewFileSystem(CONTEXT, hdfsEnvironment, viewfsPath));\n         assertFalse(isViewFileSystem(CONTEXT, hdfsEnvironment, nonViewfsPath));\n     }\n+\n+    @Test void testCreateTemporaryPathOnViewFS()\n+    {\n+        HdfsEnvironment hdfsEnvironment = createTestHdfsEnvironment(new HiveClientConfig(), new MetastoreClientConfig());\n+        Path viewfsPath = new Path(\"viewfs://ns-default/test-dir\");\n+\n+        // ViewFS check requires the mount point config\n+        hdfsEnvironment.getConfiguration(CONTEXT, viewfsPath).set(\"fs.viewfs.mounttable.ns-default.link./test-dir\", \"file://\" + Files.createTempDir());\n+\n+        Path temporaryPath = createTemporaryPath(SESSION, CONTEXT, hdfsEnvironment, viewfsPath);\n+\n+        assertEquals(temporaryPath.getParent().toString(), \"viewfs://ns-default/test-dir/.hive-staging\");", "originalCommit": "4eae741c7a165d196b6bee3af285f6643b8209dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjcyNzIwMQ==", "url": "https://github.com/prestodb/presto/pull/14146#discussion_r476727201", "bodyText": "test cases added", "author": "beinan", "createdAt": "2020-08-25T20:47:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY3NjY1MA=="}], "type": "inlineReview", "revised_code": {"commit": "7f4fc12f8a2833e8a58d89f17193ce7f1ba95d01", "chunk": "diff --git a/presto-hive/src/test/java/com/facebook/presto/hive/TestHiveWriteUtils.java b/presto-hive/src/test/java/com/facebook/presto/hive/TestHiveWriteUtils.java\nindex 3d9d19e0f1..7f847ab1f7 100644\n--- a/presto-hive/src/test/java/com/facebook/presto/hive/TestHiveWriteUtils.java\n+++ b/presto-hive/src/test/java/com/facebook/presto/hive/TestHiveWriteUtils.java\n\n@@ -61,9 +61,11 @@ public class TestHiveWriteUtils\n         HdfsEnvironment hdfsEnvironment = createTestHdfsEnvironment(new HiveClientConfig(), new MetastoreClientConfig());\n         Path viewfsPath = new Path(\"viewfs://ns-default/test-dir\");\n \n-        // ViewFS check requires the mount point config\n-        hdfsEnvironment.getConfiguration(CONTEXT, viewfsPath).set(\"fs.viewfs.mounttable.ns-default.link./test-dir\", \"file://\" + Files.createTempDir());\n+        File storageDir = Files.createTempDir();\n+        // ViewFS check requires the mount point config, using system temporary folder as the storage\n+        hdfsEnvironment.getConfiguration(CONTEXT, viewfsPath).set(\"fs.viewfs.mounttable.ns-default.link./test-dir\", \"file://\" + storageDir);\n \n+        //Make temporary folder under an existing data folder without staging folder \".hive-staging\"\n         Path temporaryPath = createTemporaryPath(SESSION, CONTEXT, hdfsEnvironment, viewfsPath);\n \n         assertEquals(temporaryPath.getParent().toString(), \"viewfs://ns-default/test-dir/.hive-staging\");\n"}}, {"oid": "7f4fc12f8a2833e8a58d89f17193ce7f1ba95d01", "url": "https://github.com/prestodb/presto/commit/7f4fc12f8a2833e8a58d89f17193ce7f1ba95d01", "message": "Add test cases for making temp dir under both exist and non-exist folder", "committedDate": "2020-08-25T20:45:57Z", "type": "commit"}]}