{"pr_number": 1943, "pr_title": "Simplify entire edges on import instead of just pillar nodes", "pr_createdAt": "2020-03-03T01:19:30Z", "pr_url": "https://github.com/graphhopper/graphhopper/pull/1943", "timeline": [{"oid": "b04d9987eaa1208e3e207a78f11265eb22a51f51", "url": "https://github.com/graphhopper/graphhopper/commit/b04d9987eaa1208e3e207a78f11265eb22a51f51", "message": "initial fix", "committedDate": "2020-03-02T11:04:57Z", "type": "commit"}, {"oid": "ba36cafa108cb48d24dcd892ff810eb587cda6db", "url": "https://github.com/graphhopper/graphhopper/commit/ba36cafa108cb48d24dcd892ff810eb587cda6db", "message": "update integration tests", "committedDate": "2020-03-02T13:07:55Z", "type": "commit"}, {"oid": "57f740ffd4159a464c262a92b72481b5382ebd9b", "url": "https://github.com/graphhopper/graphhopper/commit/57f740ffd4159a464c262a92b72481b5382ebd9b", "message": "fix tests", "committedDate": "2020-03-03T01:06:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc0ODg2OA==", "url": "https://github.com/graphhopper/graphhopper/pull/1943#discussion_r386748868", "bodyText": "instruction 4 that went away was \"continue onto Margarethenstra\u00dfe\"", "author": "msbarry", "createdAt": "2020-03-03T01:22:31Z", "path": "reader-osm/src/test/java/com/graphhopper/GraphHopperIT.java", "diffHunk": "@@ -968,15 +968,15 @@ public void testKremsCyclewayInstructionsWithWayTypeInfo() {\n \n         assertEquals(\"turn right onto Pfarrplatz\", il.get(2).getTurnDescription(tr));\n         assertEquals(\"turn right onto Margarethenstra\u00dfe\", il.get(3).getTurnDescription(tr));\n-        assertEquals(\"keep left onto Hoher Markt\", il.get(5).getTurnDescription(tr));\n-        assertEquals(\"turn right onto Wegscheid\", il.get(7).getTurnDescription(tr));\n-        assertEquals(\"turn right onto Ringstra\u00dfe, L73\", il.get(9).getTurnDescription(tr));\n-        assertEquals(\"keep left onto Eyblparkstra\u00dfe\", il.get(10).getTurnDescription(tr));\n-        assertEquals(\"keep left onto Austra\u00dfe\", il.get(11).getTurnDescription(tr));\n-        assertEquals(\"keep left onto Rechte Kremszeile\", il.get(12).getTurnDescription(tr));\n+        assertEquals(\"keep left onto Hoher Markt\", il.get(4).getTurnDescription(tr));", "originalCommit": "57f740ffd4159a464c262a92b72481b5382ebd9b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc0OTU3Mw==", "url": "https://github.com/graphhopper/graphhopper/pull/1943#discussion_r386749573", "bodyText": "these changes are probably because by forcing simplification to always keep the closest pillar node to each tower node, we had been getting a bit more resolution on the angles into and out of each intersection.", "author": "msbarry", "createdAt": "2020-03-03T01:25:03Z", "path": "reader-osm/src/test/java/com/graphhopper/GraphHopperIT.java", "diffHunk": "@@ -575,12 +575,12 @@ public void testMonacoVia() {\n \n         PathWrapper arsp = rsp.getBest();\n         assertEquals(6875.2, arsp.getDistance(), .1);\n-        assertEquals(171, arsp.getPoints().getSize());\n+        assertEquals(170, arsp.getPoints().getSize());\n \n         InstructionList il = arsp.getInstructions();\n         assertEquals(30, il.size());\n         assertEquals(\"continue onto Avenue des Guelfes\", il.get(0).getTurnDescription(tr));\n-        assertEquals(\"continue onto Avenue des Papalins\", il.get(1).getTurnDescription(tr));\n+        assertEquals(\"turn slight left onto Avenue des Papalins\", il.get(1).getTurnDescription(tr));", "originalCommit": "57f740ffd4159a464c262a92b72481b5382ebd9b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "4f08a471dad184e3a7ab3c82b8a4f72b18f7b6cc", "url": "https://github.com/graphhopper/graphhopper/commit/4f08a471dad184e3a7ab3c82b8a4f72b18f7b6cc", "message": "tweak", "committedDate": "2020-03-03T11:15:08Z", "type": "commit"}, {"oid": "e7a400193defa4cadaf35f376269263385b0d5dd", "url": "https://github.com/graphhopper/graphhopper/commit/e7a400193defa4cadaf35f376269263385b0d5dd", "message": "move endpoint removal into douglas peucker", "committedDate": "2020-03-04T00:50:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM4Mzc2Ng==", "url": "https://github.com/graphhopper/graphhopper/pull/1943#discussion_r387383766", "bodyText": "at first I was creating a shallow copy excluding first and last points, but then I tried this approach of removing the first and last point as part of simplification and it was consistently faster than the shallow copy approach on a medium size ~1GB extract (US northeast)", "author": "msbarry", "createdAt": "2020-03-04T00:55:15Z", "path": "reader-osm/src/main/java/com/graphhopper/reader/osm/OSMReader.java", "diffHunk": "@@ -720,12 +694,15 @@ EdgeIteratorState addEdge(int fromIndex, int toIndex, PointList pointList, IntsR\n \n         EdgeIteratorState iter = graph.edge(fromIndex, toIndex).setDistance(towerNodeDistance).setFlags(flags);\n \n-        if (nodes > 2) {\n+        if (pointList.size() > 2) {\n             if (doSimplify)\n-                simplifyAlgo.simplify(pillarNodes);\n+                simplifyAlgo.simplifyExcludeFirstLast(pointList);\n \n-            iter.setWayGeometry(pillarNodes);\n+            // If the entire way is just the first and last point, do not waste space storing an empty way geometry\n+            if (!pointList.isEmpty())\n+                iter.setWayGeometry(pointList);", "originalCommit": "e7a400193defa4cadaf35f376269263385b0d5dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM5OTczMg==", "url": "https://github.com/graphhopper/graphhopper/pull/1943#discussion_r387399732", "bodyText": "alright, looks like that wasn't safe because it needs to remove first and last point whether you simplify or not.", "author": "msbarry", "createdAt": "2020-03-04T01:26:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM4Mzc2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "5e44949e45890a53039051be0d5e97193f97561e", "chunk": "diff --git a/reader-osm/src/main/java/com/graphhopper/reader/osm/OSMReader.java b/reader-osm/src/main/java/com/graphhopper/reader/osm/OSMReader.java\nindex ccfa7eec3..8035d89a6 100644\n--- a/reader-osm/src/main/java/com/graphhopper/reader/osm/OSMReader.java\n+++ b/reader-osm/src/main/java/com/graphhopper/reader/osm/OSMReader.java\n\n@@ -694,14 +694,12 @@ public class OSMReader implements DataReader, TurnCostParser.ExternalInternalMap\n \n         EdgeIteratorState iter = graph.edge(fromIndex, toIndex).setDistance(towerNodeDistance).setFlags(flags);\n \n-        if (pointList.size() > 2) {\n-            if (doSimplify)\n-                simplifyAlgo.simplifyExcludeFirstLast(pointList);\n+        if (doSimplify && pointList.size() > 2)\n+            simplifyAlgo.simplify(pointList);\n \n-            // If the entire way is just the first and last point, do not waste space storing an empty way geometry\n-            if (!pointList.isEmpty())\n-                iter.setWayGeometry(pointList);\n-        }\n+        // If the entire way is just the first and last point, do not waste space storing an empty way geometry\n+        if (pointList.size() > 2)\n+            iter.setWayGeometry(pointList.shallowCopy(1, pointList.size() - 1, false));\n \n         storeOsmWayID(iter.getEdge(), wayOsmId);\n         return iter;\n"}}, {"oid": "5e44949e45890a53039051be0d5e97193f97561e", "url": "https://github.com/graphhopper/graphhopper/commit/5e44949e45890a53039051be0d5e97193f97561e", "message": "Revert \"move endpoint removal into douglas peucker\"\n\nThis reverts commit e7a400193defa4cadaf35f376269263385b0d5dd.", "committedDate": "2020-03-04T01:24:59Z", "type": "commit"}, {"oid": "d601eda3d4d87ed65383fb892333ee0bc665dd1c", "url": "https://github.com/graphhopper/graphhopper/commit/d601eda3d4d87ed65383fb892333ee0bc665dd1c", "message": "Merge branch 'master' into simplify-whole-edge", "committedDate": "2020-03-05T01:33:37Z", "type": "commit"}, {"oid": "208f0e3575126ddc79f315329c6e51aef83bee22", "url": "https://github.com/graphhopper/graphhopper/commit/208f0e3575126ddc79f315329c6e51aef83bee22", "message": "Merge branch 'master' into simplify-whole-edge", "committedDate": "2020-03-10T12:49:14Z", "type": "commit"}]}