{"pr_number": 1958, "pr_title": "Move ProfileResolver out of GraphHopper class", "pr_createdAt": "2020-03-17T19:13:49Z", "pr_url": "https://github.com/graphhopper/graphhopper/pull/1958", "timeline": [{"oid": "1f890aaa6422fca1d3ae8ca21360700a4f913167", "url": "https://github.com/graphhopper/graphhopper/commit/1f890aaa6422fca1d3ae8ca21360700a4f913167", "message": "Throw error if request has weighting or vehicle, use profile parameter instead, many tests failing", "committedDate": "2020-03-17T17:56:51Z", "type": "commit"}, {"oid": "b461512ac649c3e00150be8e01b0d3f5bdb31950", "url": "https://github.com/graphhopper/graphhopper/commit/b461512ac649c3e00150be8e01b0d3f5bdb31950", "message": "Fix some of the failing tests", "committedDate": "2020-03-17T17:57:18Z", "type": "commit"}, {"oid": "aeffb348a94c0cec553062f380921f04571fef46", "url": "https://github.com/graphhopper/graphhopper/commit/aeffb348a94c0cec553062f380921f04571fef46", "message": "Add a few more checks", "committedDate": "2020-03-17T17:57:23Z", "type": "commit"}, {"oid": "a0211608b839f9afe6c898181487b565f3a458f6", "url": "https://github.com/graphhopper/graphhopper/commit/a0211608b839f9afe6c898181487b565f3a458f6", "message": "Move profile resolver from GraphHopper to Route/Isochrone/SPTResource, use profiles for non-prepared too", "committedDate": "2020-03-17T17:57:27Z", "type": "commit"}, {"oid": "4267ea57ebdb6079591a0ec3016a6333892dbb32", "url": "https://github.com/graphhopper/graphhopper/commit/4267ea57ebdb6079591a0ec3016a6333892dbb32", "message": "Minor", "committedDate": "2020-03-17T17:57:30Z", "type": "commit"}, {"oid": "aedcc4da1c2718f8bbf8c5937d5e93165cf794ab", "url": "https://github.com/graphhopper/graphhopper/commit/aedcc4da1c2718f8bbf8c5937d5e93165cf794ab", "message": "Add/move some profile resolving tests", "committedDate": "2020-03-17T17:57:33Z", "type": "commit"}, {"oid": "9a43eef8c5895a78a288a7819a097854d68d0131", "url": "https://github.com/graphhopper/graphhopper/commit/9a43eef8c5895a78a288a7819a097854d68d0131", "message": "Minor fixes", "committedDate": "2020-03-17T17:57:54Z", "type": "commit"}, {"oid": "8d1eedaab93807499d94af08873f5fc225ae9b2a", "url": "https://github.com/graphhopper/graphhopper/commit/8d1eedaab93807499d94af08873f5fc225ae9b2a", "message": "Fix test", "committedDate": "2020-03-17T18:04:20Z", "type": "commit"}, {"oid": "e3e628b48c9b1541f2d860812dffda40dc8f5704", "url": "https://github.com/graphhopper/graphhopper/commit/e3e628b48c9b1541f2d860812dffda40dc8f5704", "message": "Remove vehicle/weighting parameters in measurement", "committedDate": "2020-03-17T18:16:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkxMTY3OQ==", "url": "https://github.com/graphhopper/graphhopper/pull/1958#discussion_r393911679", "bodyText": "I think we discussed this in #1859 already: We'll def. remove vehicle+weighting from the HintsMap, but maybe in a follow-up PR? Since the profile parameter will be required it makes sense to keep it as a separate field?", "author": "easbar", "createdAt": "2020-03-17T19:14:56Z", "path": "api/src/main/java/com/graphhopper/GHRequest.java", "diffHunk": "@@ -34,6 +34,9 @@\n  */\n public class GHRequest {\n     private List<GHPoint> points;\n+    // todonow: keep this here or put it into hints, and even more important: can we remove vehicle+weighting from\n+    // hints?\n+    private String profile = \"\";", "originalCommit": "e3e628b48c9b1541f2d860812dffda40dc8f5704", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDI1NDE3OA==", "url": "https://github.com/graphhopper/graphhopper/pull/1958#discussion_r394254178", "bodyText": "Yes, I would also use it here and remove weighting and vehicle in a later PR", "author": "karussell", "createdAt": "2020-03-18T10:45:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkxMTY3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "757cc1d9af0e6a44b8c40a4f4644d34c54dc3083", "chunk": "diff --git a/api/src/main/java/com/graphhopper/GHRequest.java b/api/src/main/java/com/graphhopper/GHRequest.java\nindex 2d9c50d1b..1e228d0ea 100644\n--- a/api/src/main/java/com/graphhopper/GHRequest.java\n+++ b/api/src/main/java/com/graphhopper/GHRequest.java\n\n@@ -34,7 +34,7 @@ import java.util.Locale;\n  */\n public class GHRequest {\n     private List<GHPoint> points;\n-    // todonow: keep this here or put it into hints, and even more important: can we remove vehicle+weighting from\n+    // todo #1934: keep this here or put it into hints, and even more important: remove vehicle+weighting from\n     // hints?\n     private String profile = \"\";\n     private final HintsMap hints = new HintsMap();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkxMjU5OQ==", "url": "https://github.com/graphhopper/graphhopper/pull/1958#discussion_r393912599", "bodyText": "There are a few odd cases where we do not use GraphHopper for routing (like NearestResource) so these do not necessarily require profiles. Not sure, to me this seems rather the exception so I am checking the existence of at least one profile here. Once we do #1901 we can move this check into GraphHopperRouter's constructor for example.", "author": "easbar", "createdAt": "2020-03-17T19:16:39Z", "path": "core/src/main/java/com/graphhopper/GraphHopper.java", "diffHunk": "@@ -824,6 +809,9 @@ public boolean load(String graphHopperFolder) {\n     }\n \n     private void checkProfilesConsistency() {\n+        if (profilesByName.isEmpty()) {", "originalCommit": "e3e628b48c9b1541f2d860812dffda40dc8f5704", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "116a864d3469036d872bdfd2d5e60f34e79b7502", "chunk": "diff --git a/core/src/main/java/com/graphhopper/GraphHopper.java b/core/src/main/java/com/graphhopper/GraphHopper.java\nindex bd6bf2a40..864fcc8db 100644\n--- a/core/src/main/java/com/graphhopper/GraphHopper.java\n+++ b/core/src/main/java/com/graphhopper/GraphHopper.java\n\n@@ -809,6 +809,8 @@ public class GraphHopper implements GraphHopperAPI {\n     }\n \n     private void checkProfilesConsistency() {\n+        // todo: strictly speaking no profiles are needed, e.g. when we only use the location index, but this is rather\n+        // the exception. we can move this check closer to the code that actually requires profiles after #1901\n         if (profilesByName.isEmpty()) {\n             throw new IllegalArgumentException(\"No routing profiles have been specified, you need to configure at least one\");\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkxMzc0Nw==", "url": "https://github.com/graphhopper/graphhopper/pull/1958#discussion_r393913747", "bodyText": "This is about the 'merging' feature where some properties are set right in the profile (like distance_factor), but they might be overwritten per request. The problem is that this does not work with CH (and only some special cases work for LM), so I am a bit unsure where to put these checks. They cannot really go into createWeighting (where the merging will happen?!), because in this method we do not 'know' whether the weighting is created for CH or not...", "author": "easbar", "createdAt": "2020-03-17T19:18:58Z", "path": "core/src/main/java/com/graphhopper/GraphHopper.java", "diffHunk": "@@ -1029,6 +1010,17 @@ public GHResponse route(GHRequest request) {\n         Lock readLock = readWriteLock.readLock();\n         readLock.lock();\n         try {\n+            if (!request.getVehicle().isEmpty())\n+                throw new IllegalArgumentException(\"GHRequest may no longer contain a vehicle, use the profile parameter instead, see #todonow\");\n+            if (!request.getWeighting().isEmpty())\n+                throw new IllegalArgumentException(\"GHRequest may no longer contain a weighting, use the profile parameter instead, see #todonow\");\n+            if (!request.getHints().get(Routing.TURN_COSTS, \"\").isEmpty())\n+                throw new IllegalArgumentException(\"GHRequest may no longer contain the turn_costs=true/false parameter, use the profile parameter instead, see #todonow\");\n+            // todonow: maybe still allow something like running a (non CH) profile edge-based or not (if no turn costs or something)?, also see traversal mode below\n+            if (!request.getHints().get(Routing.EDGE_BASED, \"\").isEmpty())\n+                throw new IllegalArgumentException(\"GHRequest may no longer contain the edge_based=true/false parameter, use the profile parameter instead, see #todonow\");\n+            // todonow: do not allow things like short_fastest.distance_factor or u_turn_costs unless CH is disabled and only under certain conditions for LM", "originalCommit": "e3e628b48c9b1541f2d860812dffda40dc8f5704", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI1NjUzNQ==", "url": "https://github.com/graphhopper/graphhopper/pull/1958#discussion_r395256535", "bodyText": "for now we are just blindly merging the hints, later we will add these kind of checks here to be more strict", "author": "easbar", "createdAt": "2020-03-19T19:06:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkxMzc0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "c9c7e361edeef8f7b711ca5480ab85eadbee3fdc", "chunk": "diff --git a/core/src/main/java/com/graphhopper/GraphHopper.java b/core/src/main/java/com/graphhopper/GraphHopper.java\nindex bd6bf2a40..0e7dc9eb9 100644\n--- a/core/src/main/java/com/graphhopper/GraphHopper.java\n+++ b/core/src/main/java/com/graphhopper/GraphHopper.java\n\n@@ -1014,10 +1014,10 @@ public class GraphHopper implements GraphHopperAPI {\n                 throw new IllegalArgumentException(\"GHRequest may no longer contain a vehicle, use the profile parameter instead, see #todonow\");\n             if (!request.getWeighting().isEmpty())\n                 throw new IllegalArgumentException(\"GHRequest may no longer contain a weighting, use the profile parameter instead, see #todonow\");\n-            if (!request.getHints().get(Routing.TURN_COSTS, \"\").isEmpty())\n+            if (request.getHints().has(Routing.TURN_COSTS))\n                 throw new IllegalArgumentException(\"GHRequest may no longer contain the turn_costs=true/false parameter, use the profile parameter instead, see #todonow\");\n             // todonow: maybe still allow something like running a (non CH) profile edge-based or not (if no turn costs or something)?, also see traversal mode below\n-            if (!request.getHints().get(Routing.EDGE_BASED, \"\").isEmpty())\n+            if (request.getHints().has(Routing.EDGE_BASED))\n                 throw new IllegalArgumentException(\"GHRequest may no longer contain the edge_based=true/false parameter, use the profile parameter instead, see #todonow\");\n             // todonow: do not allow things like short_fastest.distance_factor or u_turn_costs unless CH is disabled and only under certain conditions for LM\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkxNDU5MA==", "url": "https://github.com/graphhopper/graphhopper/pull/1958#discussion_r393914590", "bodyText": "Maybe we can do this later, see #1702.", "author": "easbar", "createdAt": "2020-03-17T19:20:39Z", "path": "core/src/main/java/com/graphhopper/GraphHopper.java", "diffHunk": "@@ -1055,10 +1047,17 @@ public GHResponse route(GHRequest request) {\n             // For example see #734\n             checkIfPointsAreInBounds(points);\n \n-            ProfileConfig profile = resolveProfile(hints);\n+            if (Helper.isEmpty(request.getProfile())) {\n+                throw new IllegalArgumentException(\"You need to specify a profile to perform a routing request\");\n+            }\n+            ProfileConfig profile = profilesByName.get(request.getProfile());\n+            if (profile == null) {\n+                throw new IllegalArgumentException(\"The requested profile '\" + request.getProfile() + \"' does not exist\");\n+            }\n             if (!profile.isTurnCosts() && !request.getCurbsides().isEmpty())\n                 throw new IllegalArgumentException(\"To make use of the \" + CURBSIDE + \" parameter you need to use a profile that supports turn costs\");\n \n+            // todonow: should we be able to control this using the edge_based parameter?", "originalCommit": "e3e628b48c9b1541f2d860812dffda40dc8f5704", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "13c02eaf81eec8b85a4d34b19b742ec310af4745", "chunk": "diff --git a/core/src/main/java/com/graphhopper/GraphHopper.java b/core/src/main/java/com/graphhopper/GraphHopper.java\nindex bd6bf2a40..25c300947 100644\n--- a/core/src/main/java/com/graphhopper/GraphHopper.java\n+++ b/core/src/main/java/com/graphhopper/GraphHopper.java\n\n@@ -1048,7 +1048,7 @@ public class GraphHopper implements GraphHopperAPI {\n             checkIfPointsAreInBounds(points);\n \n             if (Helper.isEmpty(request.getProfile())) {\n-                throw new IllegalArgumentException(\"You need to specify a profile to perform a routing request\");\n+                throw new IllegalArgumentException(\"You need to specify a profile to perform a routing request, see #todonow\");\n             }\n             ProfileConfig profile = profilesByName.get(request.getProfile());\n             if (profile == null) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkxNTk4MA==", "url": "https://github.com/graphhopper/graphhopper/pull/1958#discussion_r393915980", "bodyText": "Since we are now selecting a CHProfileConfig instead of a CHProfile we can deal with the case of multiple edge-based profiles with different u_turn_costs again (c.f. #1949). This should also help to get rid of Weighting#getFlagEncoder in the long run.", "author": "easbar", "createdAt": "2020-03-17T19:23:24Z", "path": "core/src/main/java/com/graphhopper/routing/ProfileResolver.java", "diffHunk": "@@ -18,118 +18,125 @@\n \n package com.graphhopper.routing;\n \n+import com.graphhopper.config.CHProfileConfig;\n+import com.graphhopper.config.LMProfileConfig;\n import com.graphhopper.config.ProfileConfig;\n-import com.graphhopper.routing.lm.LMProfile;\n import com.graphhopper.routing.util.EncodingManager;\n import com.graphhopper.routing.util.FlagEncoder;\n import com.graphhopper.routing.util.HintsMap;\n-import com.graphhopper.storage.CHProfile;\n+import com.graphhopper.util.PMap;\n import com.graphhopper.util.Parameters;\n \n import java.util.ArrayList;\n+import java.util.HashMap;\n import java.util.List;\n+import java.util.Map;\n \n import static com.graphhopper.routing.weighting.Weighting.INFINITE_U_TURN_COSTS;\n \n public class ProfileResolver {\n-\n-    public ProfileConfig resolveProfile(EncodingManager encodingManager, List<CHProfile> chProfiles, List<LMProfile> lmProfiles, HintsMap hints) {\n-        // default handling\n-        String vehicle = hints.getVehicle();\n-        if (vehicle.isEmpty()) {\n-            vehicle = getDefaultVehicle(encodingManager).toString();\n+    private final EncodingManager encodingManager;\n+    private final List<ProfileConfig> profiles;\n+    private final List<ProfileConfig> chProfiles;\n+    private final List<ProfileConfig> lmProfiles;\n+\n+    public ProfileResolver(EncodingManager encodingManager, List<ProfileConfig> profiles, List<CHProfileConfig> chProfiles, List<LMProfileConfig> lmProfiles) {\n+        this.encodingManager = encodingManager;\n+        this.profiles = profiles;\n+        Map<String, ProfileConfig> profilesByName = new HashMap<>(profiles.size());\n+        for (ProfileConfig p : profiles) {\n+            profilesByName.put(p.getName(), p);\n         }\n-        String weighting = hints.getWeighting();\n-        if (weighting.isEmpty()) {\n-            weighting = \"fastest\";\n+        if (profilesByName.size() != profiles.size()) {\n+            throw new IllegalStateException(\"Profiles must have distinct names\");\n+        }\n+        this.chProfiles = new ArrayList<>();\n+        for (CHProfileConfig p : chProfiles) {\n+            ProfileConfig profile = profilesByName.get(p.getProfile());\n+            if (profile == null) {\n+                throw new IllegalStateException(\"There is no profile for CH preparation '\" + p.getProfile() + \"'\");\n+            }\n+            this.chProfiles.add(profile);\n+        }\n+        this.lmProfiles = new ArrayList<>();\n+        for (LMProfileConfig p : lmProfiles) {\n+            ProfileConfig profile = profilesByName.get(p.getProfile());\n+            if (profile == null) {\n+                throw new IllegalStateException(\"There is no profile for LM preparation '\" + p.getProfile() + \"'\");\n+            }\n+            this.lmProfiles.add(profile);\n         }\n-        if (!encodingManager.hasEncoder(vehicle))\n-            throw new IllegalArgumentException(\"Vehicle not supported: \" + vehicle + \". Supported are: \" + encodingManager.toString());\n-\n-        FlagEncoder encoder = encodingManager.getEncoder(vehicle);\n-        // we use turn costs if the encoder supports it *unless* the edge_based parameter is set explicitly\n-        boolean turnCosts = encoder.supportsTurnCosts();\n-        if (hints.has(Parameters.Routing.EDGE_BASED))\n-            turnCosts = hints.getBool(Parameters.Routing.EDGE_BASED, false);\n-        if (turnCosts && !encoder.supportsTurnCosts())\n-            throw new IllegalArgumentException(\"You need to set up a turn cost storage to make use of edge_based=true, e.g. use car|turn_costs=true\");\n-\n-        String profileName = resolveProfileName(chProfiles, lmProfiles, hints);\n-\n-        return new ProfileConfig(profileName)\n-                .setVehicle(vehicle)\n-                .setWeighting(weighting)\n-                .setTurnCosts(turnCosts);\n     }\n \n-    private String resolveProfileName(List<CHProfile> chProfiles, List<LMProfile> lmProfiles, HintsMap hints) {\n+    public ProfileConfig resolveProfile(HintsMap hints) {\n         boolean disableCH = hints.getBool(Parameters.CH.DISABLE, false);\n         boolean disableLM = hints.getBool(Parameters.Landmark.DISABLE, false);\n \n-        String profileName;\n+        String vehicle = hints.getVehicle();\n+        if (!vehicle.isEmpty() && !encodingManager.hasEncoder(hints.getVehicle()))\n+            throw new IllegalArgumentException(\"Vehicle not supported: \" + vehicle + \". Supported are: \" + encodingManager.toString() +\n+                    \" You should consider using the profile parameter instead of specifying a vehicle, see #todonow\");\n+\n+        // unless CH/LM are disabled we select the profile based on the given request hints and the available preparations\n         if (!chProfiles.isEmpty() && !disableCH) {\n-            profileName = selectCHProfile(chProfiles, hints).getName();\n+            return selectProfileCH(hints);\n         } else if (!lmProfiles.isEmpty() && !disableLM) {\n-            profileName = selectLMProfile(lmProfiles, hints).getName();\n+            return selectProfileLM(hints);\n         } else {\n-            // todonow: here we will instead select one of the existing profiles\n-            profileName = \"unprepared_profile\";\n+            return selectProfileUnprepared(hints);\n         }\n-        return profileName;\n     }\n \n     /**\n-     * @param chProfiles the CH profiles to choose from\n-     * @param hintsMap   a map used to describe the CH profile that shall be selected\n-     * @throws IllegalArgumentException if no CH profile could be selected for the given parameters\n+     * @param hintsMap a map used to describe the profile that shall be selected\n+     * @throws IllegalArgumentException if no profile supporting CH could be selected for the given parameters\n      */\n-    public CHProfile selectCHProfile(List<CHProfile> chProfiles, HintsMap hintsMap) {\n-        int numMatchingEdgeBased = 0;\n-        List<CHProfile> matchingProfiles = new ArrayList<>();\n-        for (CHProfile p : chProfiles) {\n+    public ProfileConfig selectProfileCH(HintsMap hintsMap) {\n+        List<ProfileConfig> matchingProfiles = new ArrayList<>();\n+        for (ProfileConfig p : chProfiles) {\n             if (!chProfileMatchesHints(p, hintsMap))\n                 continue;\n             matchingProfiles.add(p);\n-            if (p.isEdgeBased()) {\n-                numMatchingEdgeBased++;\n-            }\n         }\n \n         Boolean edgeBased = getEdgeBased(hintsMap);\n         Integer uTurnCosts = getUTurnCosts(hintsMap);\n         if (matchingProfiles.isEmpty()) {\n-            throw new IllegalArgumentException(\"Cannot find matching CH profile for your request. Please check your parameters.\" +\n+            throw new IllegalArgumentException(\"Cannot find matching profile that supports CH for your request. Please check your parameters.\" +\n                     \"\\nYou can try disabling CH using \" + Parameters.CH.DISABLE + \"=true\" +\n-                    \"\\nrequested:  \" + getCHRequestAsString(hintsMap, edgeBased, uTurnCosts) + \"\\navailable: \" + chProfiles);\n+                    \"\\nrequested:  \" + getCHRequestAsString(hintsMap, edgeBased, uTurnCosts) + \"\\navailable: \" + chProfilesAsString(chProfiles));\n         } else if (matchingProfiles.size() == 1) {\n             return matchingProfiles.get(0);\n         } else {\n-            // special case: prefer edge-based over node-based if these are the only two options\n-            CHProfile match1 = matchingProfiles.get(0);\n-            CHProfile match2 = matchingProfiles.get(1);\n+            // special case: prefer profile with turn costs over one without turn costs if both are available and there\n+            // aren't any other options\n+            ProfileConfig match1 = matchingProfiles.get(0);\n+            ProfileConfig match2 = matchingProfiles.get(1);\n             if (edgeBased == null && matchingProfiles.size() == 2 &&\n-                    match1.getWeighting().getName().equals(match2.getWeighting().getName()) &&\n-                    match1.getWeighting().getFlagEncoder().toString().equals(match2.getWeighting().getFlagEncoder().toString()) &&\n-                    match1.isEdgeBased() != match2.isEdgeBased()) {\n-                return match1.isEdgeBased() ? match1 : match2;\n+                    match1.getWeighting().equals(match2.getWeighting()) &&\n+                    match1.getVehicle().equals(match2.getVehicle()) &&\n+                    match1.isTurnCosts() != match2.isTurnCosts()) {\n+                return match1.isTurnCosts() ? match1 : match2;\n             }\n-            // special case: error if multiple edge-based matches. to differentiate between these it will be required\n-            // to explicitly set the profile parameter.\n-            if (numMatchingEdgeBased > 1 && numMatchingEdgeBased == matchingProfiles.size()) {\n-                throw new IllegalArgumentException(\"There are multiple edge-based CH profiles matching your request. You need to\" +\n-                        \" specify the profile you want to use explicitly, see here: https://github.com/graphhopper/graphhopper/pull/1934.\");\n-            } else {\n-                throw new IllegalArgumentException(\"There are multiple CH profiles matching your request. Use the `weighting`,`vehicle`,`edge_based` and/or `u_turn_costs` parameters to be more specific.\" +\n-                        \"\\nYou can also try disabling CH altogether using \" + Parameters.CH.DISABLE + \"=true\" +\n-                        \"\\nrequested:  \" + getCHRequestAsString(hintsMap, edgeBased, uTurnCosts) + \"\\nmatched:   \" + matchingProfiles + \"\\navailable: \" + chProfiles);\n+            throw new IllegalArgumentException(\"There are multiple CH profiles matching your request. Use the `weighting`,`vehicle`,`edge_based` and/or `u_turn_costs` parameters to be more specific or better use the `profile` parameter to explicitly choose a profile.\" +\n+                    \"\\nYou can also try disabling CH altogether using \" + Parameters.CH.DISABLE + \"=true\" +\n+                    \"\\nrequested:  \" + getCHRequestAsString(hintsMap, edgeBased, uTurnCosts) + \"\\nmatched:   \" + chProfilesAsString(matchingProfiles) + \"\\navailable: \" + chProfilesAsString(chProfiles));\n \n-            }\n         }\n     }\n \n-    public LMProfile selectLMProfile(List<LMProfile> lmProfiles, HintsMap hintsMap) {\n-        List<LMProfile> matchingProfiles = new ArrayList<>();\n-        for (LMProfile p : lmProfiles) {\n+    protected boolean chProfileMatchesHints(ProfileConfig p, HintsMap hintsMap) {\n+        Boolean edgeBased = getEdgeBased(hintsMap);\n+        Integer uTurnCosts = getUTurnCosts(hintsMap);\n+        return (edgeBased == null || p.isTurnCosts() == edgeBased) &&\n+                (uTurnCosts == null || uTurnCosts.equals(getUTurnCosts(p.getHints()))) &&", "originalCommit": "e3e628b48c9b1541f2d860812dffda40dc8f5704", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "37519748a73aa900a354a8a4f6752fdca182ce43", "chunk": "diff --git a/core/src/main/java/com/graphhopper/routing/ProfileResolver.java b/core/src/main/java/com/graphhopper/routing/ProfileResolver.java\nindex 89aa55f27..e9e05a0ed 100644\n--- a/core/src/main/java/com/graphhopper/routing/ProfileResolver.java\n+++ b/core/src/main/java/com/graphhopper/routing/ProfileResolver.java\n\n@@ -34,6 +34,14 @@ import java.util.Map;\n \n import static com.graphhopper.routing.weighting.Weighting.INFINITE_U_TURN_COSTS;\n \n+/**\n+ * Before the `profile` parameter was introduced in #todonow the cost-function used for route calculations could be\n+ * specified by setting the vehicle, weighting and a turn_costs flag. This class does the conversion between these\n+ * legacy parameters and the corresponding profile. To resolve a profile we consider both the request parameters as\n+ * well as the available LM/CH preparations.\n+ * Note that this class is meant to be only used for the top-most web layer, while the GH engine should only deal with\n+ * the profile parameter.\n+ */\n public class ProfileResolver {\n     private final EncodingManager encodingManager;\n     private final List<ProfileConfig> profiles;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkxODkyNQ==", "url": "https://github.com/graphhopper/graphhopper/pull/1958#discussion_r393918925", "bodyText": "Here I thought the measurements are running only for one vehicle anyway (and if we want to test others we might as well start the measurement again for the other vehicle), so it makes sense to keep the vehicle as a class variable (just like weighting) rather than pass it with every querysetting?", "author": "easbar", "createdAt": "2020-03-17T19:28:57Z", "path": "tools/src/main/java/com/graphhopper/tools/Measurement.java", "diffHunk": "@@ -73,6 +75,7 @@\n     private final Map<String, Object> properties = new TreeMap<>();\n     private long seed;\n     private int maxNode;\n+    private String vehicle;", "originalCommit": "e3e628b48c9b1541f2d860812dffda40dc8f5704", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTU2MTc0MQ==", "url": "https://github.com/graphhopper/graphhopper/pull/1958#discussion_r395561741", "bodyText": "In the CustomWeighting branch I already use profile and then I do not want the vehicle in the request:  https://github.com/graphhopper/graphhopper/pull/1841/files#diff-cd749cc545f8b84137c2b75b2d174b72 but probably this can be still done somehow.", "author": "karussell", "createdAt": "2020-03-20T10:55:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkxODkyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTU2NTk5MQ==", "url": "https://github.com/graphhopper/graphhopper/pull/1958#discussion_r395565991", "bodyText": "Ok yes vehicle and weihgting should be mostly removed from measurement and only profile should be left then?", "author": "easbar", "createdAt": "2020-03-20T11:04:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkxODkyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTU3ODA2Nw==", "url": "https://github.com/graphhopper/graphhopper/pull/1958#discussion_r395578067", "bodyText": "Yes, but let's do this later :)", "author": "karussell", "createdAt": "2020-03-20T11:30:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkxODkyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjczMTMyMg==", "url": "https://github.com/graphhopper/graphhopper/pull/1958#discussion_r396731322", "bodyText": "There isn't really anything to do. vehicle&weighting are only used to create the profile initially.", "author": "easbar", "createdAt": "2020-03-23T20:18:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkxODkyNQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "13c02eaf81eec8b85a4d34b19b742ec310af4745", "url": "https://github.com/graphhopper/graphhopper/commit/13c02eaf81eec8b85a4d34b19b742ec310af4745", "message": "Add todo to respect profile parameter later", "committedDate": "2020-03-17T19:46:34Z", "type": "commit"}, {"oid": "18d117a58a282e572b5c5346ce9e19cf2ccf56fa", "url": "https://github.com/graphhopper/graphhopper/commit/18d117a58a282e572b5c5346ce9e19cf2ccf56fa", "message": "Add integration test for edge_based/turn_costs parameters", "committedDate": "2020-03-17T21:48:36Z", "type": "commit"}, {"oid": "2c9760476a0bc9ad9b31ba10f99c9ab33fd8339c", "url": "https://github.com/graphhopper/graphhopper/commit/2c9760476a0bc9ad9b31ba10f99c9ab33fd8339c", "message": "Fix formatting in Measurement.java", "committedDate": "2020-03-17T22:39:40Z", "type": "commit"}, {"oid": "ff555589b0b41f0206e7355553afb0bf0e774206", "url": "https://github.com/graphhopper/graphhopper/commit/ff555589b0b41f0206e7355553afb0bf0e774206", "message": "Fix measurement: Add LM profiles with and without turncosts.", "committedDate": "2020-03-17T22:49:12Z", "type": "commit"}, {"oid": "37519748a73aa900a354a8a4f6752fdca182ce43", "url": "https://github.com/graphhopper/graphhopper/commit/37519748a73aa900a354a8a4f6752fdca182ce43", "message": "Add javadocs for ProfileResolver", "committedDate": "2020-03-17T22:57:14Z", "type": "commit"}, {"oid": "c9c7e361edeef8f7b711ca5480ab85eadbee3fdc", "url": "https://github.com/graphhopper/graphhopper/commit/c9c7e361edeef8f7b711ca5480ab85eadbee3fdc", "message": "Replace hints.get(EDGE_BASED, \"\") with hints.has(EDGE_BASED)", "committedDate": "2020-03-18T11:16:36Z", "type": "commit"}, {"oid": "798177a51a14e2ae1473215ef53d6057764ab637", "url": "https://github.com/graphhopper/graphhopper/commit/798177a51a14e2ae1473215ef53d6057764ab637", "message": "Merge branch 'master' into profile_parameter2\n\n# Conflicts:\n#\tcore/src/main/java/com/graphhopper/routing/ProfileResolver.java\n#\tcore/src/test/java/com/graphhopper/routing/RoutingAlgorithmIT.java\n#\treader-osm/src/test/java/com/graphhopper/GraphHopperIT.java\n#\treader-osm/src/test/java/com/graphhopper/reader/osm/GraphHopperOSMTest.java\n#\ttools/src/main/java/com/graphhopper/tools/CHMeasurement.java\n#\ttools/src/main/java/com/graphhopper/tools/Measurement.java\n#\tweb-bundle/src/main/java/com/graphhopper/resources/IsochroneResource.java\n#\tweb-bundle/src/main/java/com/graphhopper/resources/SPTResource.java", "committedDate": "2020-03-19T07:48:01Z", "type": "commit"}, {"oid": "96fec5702e7f8f4997d57c59753f985cafebb3f2", "url": "https://github.com/graphhopper/graphhopper/commit/96fec5702e7f8f4997d57c59753f985cafebb3f2", "message": "Fixes after merge", "committedDate": "2020-03-19T08:28:44Z", "type": "commit"}, {"oid": "12f06fb4cc423d125144ef75207946967b4ac704", "url": "https://github.com/graphhopper/graphhopper/commit/12f06fb4cc423d125144ef75207946967b4ac704", "message": "Update api-doc", "committedDate": "2020-03-19T10:46:25Z", "type": "commit"}, {"oid": "7a0844b405d9b84fe9602d7561f85d1c89ba50bb", "url": "https://github.com/graphhopper/graphhopper/commit/7a0844b405d9b84fe9602d7561f85d1c89ba50bb", "message": "minor", "committedDate": "2020-03-19T11:18:12Z", "type": "commit"}, {"oid": "df15f83ea8c151c9bf445db122d3836736b47691", "url": "https://github.com/graphhopper/graphhopper/commit/df15f83ea8c151c9bf445db122d3836736b47691", "message": "Strictly separate profiles with/without turn costs also for LM", "committedDate": "2020-03-19T13:23:21Z", "type": "commit"}, {"oid": "8d57c539045fd5715a20506e3c808e5bac2c72d6", "url": "https://github.com/graphhopper/graphhopper/commit/8d57c539045fd5715a20506e3c808e5bac2c72d6", "message": "Update todos", "committedDate": "2020-03-19T13:26:52Z", "type": "commit"}, {"oid": "757cc1d9af0e6a44b8c40a4f4644d34c54dc3083", "url": "https://github.com/graphhopper/graphhopper/commit/757cc1d9af0e6a44b8c40a4f4644d34c54dc3083", "message": "Update issue references and todos", "committedDate": "2020-03-19T13:39:14Z", "type": "commit"}, {"oid": "4c770ec7bbd6ae703b8b95de81ad7be7e2705b3c", "url": "https://github.com/graphhopper/graphhopper/commit/4c770ec7bbd6ae703b8b95de81ad7be7e2705b3c", "message": "Merge profile hints with request hints before creating the weighting.", "committedDate": "2020-03-19T14:54:24Z", "type": "commit"}, {"oid": "cb7b451a81da94ff232d3881ad760cba5f29f272", "url": "https://github.com/graphhopper/graphhopper/commit/cb7b451a81da94ff232d3881ad760cba5f29f272", "message": "prepare merge", "committedDate": "2020-03-19T15:23:59Z", "type": "commit"}, {"oid": "409cad20ea4da4f886fdaf2715cb65d707c1c591", "url": "https://github.com/graphhopper/graphhopper/commit/409cad20ea4da4f886fdaf2715cb65d707c1c591", "message": "Merge branch 'master' into profile_parameter2\n\n# Conflicts:\n#\tcore/src/main/java/com/graphhopper/routing/ProfileResolver.java\n#\treader-gtfs/src/test/java/com/graphhopper/AnotherAgencyIT.java\n#\treader-gtfs/src/test/java/com/graphhopper/ExtendedRouteTypeIT.java\n#\treader-gtfs/src/test/java/com/graphhopper/GraphHopperGtfsIT.java\n#\treader-gtfs/src/test/java/com/graphhopper/GraphHopperMultimodalIT.java\n#\treader-gtfs/src/test/java/com/graphhopper/RealtimeIT.java\n#\treader-osm/src/test/java/com/graphhopper/GraphHopperIT.java\n#\treader-osm/src/test/java/com/graphhopper/reader/osm/GraphHopperOSMTest.java\n#\tweb/src/test/java/com/graphhopper/http/SpatialRulesTest.java\n#\tweb/src/test/java/com/graphhopper/http/resources/ChangeGraphResourceTest.java\n#\tweb/src/test/java/com/graphhopper/http/resources/GtfsTest.java\n#\tweb/src/test/java/com/graphhopper/http/resources/I18nResourceTest.java\n#\tweb/src/test/java/com/graphhopper/http/resources/IsochroneResourceTest.java\n#\tweb/src/test/java/com/graphhopper/http/resources/MvtResourceTest.java\n#\tweb/src/test/java/com/graphhopper/http/resources/NearestResourceTest.java\n#\tweb/src/test/java/com/graphhopper/http/resources/NearestResourceWithEleTest.java\n#\tweb/src/test/java/com/graphhopper/http/resources/PtIsochroneTest.java\n#\tweb/src/test/java/com/graphhopper/http/resources/RouteResourceWithEleTest.java\n#\tweb/src/test/java/com/graphhopper/http/resources/SPTResourceTest.java", "committedDate": "2020-03-19T18:31:36Z", "type": "commit"}, {"oid": "95d5ed278308efe90ddb9e78e50bca817172cb6b", "url": "https://github.com/graphhopper/graphhopper/commit/95d5ed278308efe90ddb9e78e50bca817172cb6b", "message": "minor", "committedDate": "2020-03-19T18:59:00Z", "type": "commit"}, {"oid": "e774c1cb8d2beaf009e65ee6d3e9f828f95f94ea", "url": "https://github.com/graphhopper/graphhopper/commit/e774c1cb8d2beaf009e65ee6d3e9f828f95f94ea", "message": "Fix test after merging master", "committedDate": "2020-03-19T19:08:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ2MjkwMQ==", "url": "https://github.com/graphhopper/graphhopper/pull/1958#discussion_r395462901", "bodyText": "These are (the very simple) rules how we merge the profile hints with the request hints. The only thing I am wondering now is how we do this for block_area? Shall we do this in a similar way (use hints from profile and overwrite with request hints)? Do we need this here or is it ok to only create block areas from request hints (not the profile) here, and add this in #1776? Its still a bit unfortunate that we do not do the block_area stuff inside createWeighting. Now it looks all we are missing to do this in createWeighting are the points?", "author": "easbar", "createdAt": "2020-03-20T06:59:34Z", "path": "core/src/main/java/com/graphhopper/GraphHopper.java", "diffHunk": "@@ -1350,13 +1349,20 @@ public DefaultWeightingFactory(EncodingManager encodingManager, GraphHopperStora\n             this.ghStorage = ghStorage;\n         }\n \n-        public Weighting createWeighting(ProfileConfig profile, PMap hints) {\n+        public Weighting createWeighting(ProfileConfig profile, PMap requestHints) {\n+            // Merge profile hints with request hints, the request hints take precedence.\n+            // Note that so far we do not check if overwriting the profile hints actually works with the preparation\n+            // for LM/CH. Later we should also limit the number of parameters that can be used to modify the profile.\n+            PMap hints = new PMap();\n+            hints.putAll(profile.getHints());\n+            hints.putAll(requestHints);", "originalCommit": "e774c1cb8d2beaf009e65ee6d3e9f828f95f94ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTU2MDIyOQ==", "url": "https://github.com/graphhopper/graphhopper/pull/1958#discussion_r395560229", "bodyText": "The only thing I am wondering now is how we do this for block_area?\n\nHmmh, we would need to add it to the list of shapes\n\nDo we need this here or is it ok to only create block areas from request hints (not the profile) here\n\nI would postpone this and properly support this in CustomWeighting.\n\nNow it looks all we are missing to do this in createWeighting are the points\n\nYeah, although we only need this because of the is-in-area check which we could keep out of the Weighting creation somehow.", "author": "karussell", "createdAt": "2020-03-20T10:52:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ2MjkwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "116a864d3469036d872bdfd2d5e60f34e79b7502", "chunk": "diff --git a/core/src/main/java/com/graphhopper/GraphHopper.java b/core/src/main/java/com/graphhopper/GraphHopper.java\nindex 8adeaac7f..864fcc8db 100644\n--- a/core/src/main/java/com/graphhopper/GraphHopper.java\n+++ b/core/src/main/java/com/graphhopper/GraphHopper.java\n\n@@ -1353,6 +1355,8 @@ public class GraphHopper implements GraphHopperAPI {\n             // Merge profile hints with request hints, the request hints take precedence.\n             // Note that so far we do not check if overwriting the profile hints actually works with the preparation\n             // for LM/CH. Later we should also limit the number of parameters that can be used to modify the profile.\n+            // todo: since we are not dealing with block_area here yet we cannot really apply any merging rules\n+            // for it, see discussion here: https://github.com/graphhopper/graphhopper/pull/1958#discussion_r395462901\n             PMap hints = new PMap();\n             hints.putAll(profile.getHints());\n             hints.putAll(requestHints);\n"}}, {"oid": "8696944fa8f40831cd8e57dd1d5244b185790d77", "url": "https://github.com/graphhopper/graphhopper/commit/8696944fa8f40831cd8e57dd1d5244b185790d77", "message": "Merge branch 'master' into profile_parameter2", "committedDate": "2020-03-20T08:47:07Z", "type": "commit"}, {"oid": "ac9280f1a0bc68ad6adc731b7c38feee69b027b2", "url": "https://github.com/graphhopper/graphhopper/commit/ac9280f1a0bc68ad6adc731b7c38feee69b027b2", "message": "Merge branch 'master' into profile_parameter2\n\n# Conflicts:\n#\tcore/src/main/java/com/graphhopper/routing/ProfileResolver.java\n#\ttools/src/main/java/com/graphhopper/tools/Measurement.java", "committedDate": "2020-03-21T09:20:47Z", "type": "commit"}, {"oid": "1427822c756f8713bcec9f20210a453ec827032a", "url": "https://github.com/graphhopper/graphhopper/commit/1427822c756f8713bcec9f20210a453ec827032a", "message": "Adjust after merging master, but test still fails", "committedDate": "2020-03-23T10:17:05Z", "type": "commit"}, {"oid": "00c74ab6546e2ad963010ce0aa4fdf38b555475e", "url": "https://github.com/graphhopper/graphhopper/commit/00c74ab6546e2ad963010ce0aa4fdf38b555475e", "message": "Pick another test from master", "committedDate": "2020-03-23T10:28:41Z", "type": "commit"}, {"oid": "48c997bbaaad14cce2f71155adb891e4e7e94905", "url": "https://github.com/graphhopper/graphhopper/commit/48c997bbaaad14cce2f71155adb891e4e7e94905", "message": "Pick recent changes from master, remove default_vehicle=encoders[0] rule", "committedDate": "2020-03-23T12:50:26Z", "type": "commit"}, {"oid": "4d60cfbe89150b4dc1512d5cf978a844d66a2168", "url": "https://github.com/graphhopper/graphhopper/commit/4d60cfbe89150b4dc1512d5cf978a844d66a2168", "message": "Remove default vehicle for GET requests from RouteResource", "committedDate": "2020-03-23T12:51:01Z", "type": "commit"}, {"oid": "f3c63e95de3ddffe3f0e793c574949b692fad23f", "url": "https://github.com/graphhopper/graphhopper/commit/f3c63e95de3ddffe3f0e793c574949b692fad23f", "message": "Update profile selection test", "committedDate": "2020-03-23T12:59:04Z", "type": "commit"}, {"oid": "e55c94d68c3dab030656ac671d52176d40ba05f5", "url": "https://github.com/graphhopper/graphhopper/commit/e55c94d68c3dab030656ac671d52176d40ba05f5", "message": "Merge branch 'master' into profile_parameter2\n\n# Conflicts:\n#\tcore/src/main/java/com/graphhopper/routing/ProfileResolver.java\n#\tweb/src/test/java/com/graphhopper/http/resources/RouteResourceProfileSelectionTest.java", "committedDate": "2020-03-23T12:59:57Z", "type": "commit"}, {"oid": "50116c55c02363a62942c42154ed164e3bdb6cb9", "url": "https://github.com/graphhopper/graphhopper/commit/50116c55c02363a62942c42154ed164e3bdb6cb9", "message": "Remove todos", "committedDate": "2020-03-23T13:06:20Z", "type": "commit"}, {"oid": "019beb44208b8cdb6e83b5f9e19afc933dd13bdf", "url": "https://github.com/graphhopper/graphhopper/commit/019beb44208b8cdb6e83b5f9e19afc933dd13bdf", "message": "Some minor cleanups", "committedDate": "2020-03-23T18:44:33Z", "type": "commit"}, {"oid": "116a864d3469036d872bdfd2d5e60f34e79b7502", "url": "https://github.com/graphhopper/graphhopper/commit/116a864d3469036d872bdfd2d5e60f34e79b7502", "message": "Add comments", "committedDate": "2020-03-23T20:34:50Z", "type": "commit"}]}