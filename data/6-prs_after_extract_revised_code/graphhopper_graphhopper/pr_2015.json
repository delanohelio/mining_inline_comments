{"pr_number": 2015, "pr_title": "Move max_weight into priority and more refactorings", "pr_createdAt": "2020-04-23T22:03:11Z", "pr_url": "https://github.com/graphhopper/graphhopper/pull/2015", "timeline": [{"oid": "6314b022dbdb14f736565b46b8b4043aca542854", "url": "https://github.com/graphhopper/graphhopper/commit/6314b022dbdb14f736565b46b8b4043aca542854", "message": "initial range", "committedDate": "2020-04-23T19:16:59Z", "type": "commit"}, {"oid": "3ee1aa966da4e8c55b34ee9dcc5d8e1e7e68b1c1", "url": "https://github.com/graphhopper/graphhopper/commit/3ee1aa966da4e8c55b34ee9dcc5d8e1e7e68b1c1", "message": "refactoring; implement catch-all key * instead of prefer factor bigger than 1", "committedDate": "2020-04-23T21:57:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE1NDk2NA==", "url": "https://github.com/graphhopper/graphhopper/pull/2015#discussion_r414154964", "bodyText": "This is a global catch-all across encoded values so it is still here :)", "author": "karussell", "createdAt": "2020-04-23T22:04:45Z", "path": "api/src/main/java/com/graphhopper/routing/util/CustomModel.java", "diffHunk": "@@ -34,7 +34,7 @@\n \n     static double DEFAULT_D_I = 70;\n     // optional:\n-    private Double maxSpeedFallback, vehicleWeight, vehicleWidth, vehicleHeight, vehicleLength;\n+    private Double maxSpeedFallback;", "originalCommit": "3ee1aa966da4e8c55b34ee9dcc5d8e1e7e68b1c1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE1NTM4Mg==", "url": "https://github.com/graphhopper/graphhopper/pull/2015#discussion_r414155382", "bodyText": "boolean encoded values are now like enum and decimal types...", "author": "karussell", "createdAt": "2020-04-23T22:05:34Z", "path": "core/src/main/java/com/graphhopper/routing/weighting/custom/BooleanToValueEntry.java", "diffHunk": "@@ -20,18 +20,59 @@\n import com.graphhopper.routing.profiles.BooleanEncodedValue;\n import com.graphhopper.util.EdgeIteratorState;\n \n+import java.util.Map;\n+\n+import static com.graphhopper.routing.weighting.custom.EnumToValueEntry.getReturnValue;\n+\n final class BooleanToValueEntry implements EdgeToValueEntry {\n     private final BooleanEncodedValue bev;\n     private final double value, elseValue;\n \n-    public BooleanToValueEntry(BooleanEncodedValue bev, double value, double elseValue) {\n+    private BooleanToValueEntry(BooleanEncodedValue bev, double value, double elseValue) {\n         this.bev = bev;\n         this.value = value;\n         this.elseValue = elseValue;\n     }\n \n+    /**\n+     * Example map:\n+     * <pre>\n+     * get_off_bike:\n+     *   true: 0.4\n+     *   false: 0.9 // optional and default is 1, equivalent to \"*\": 0.9\n+     * </pre>\n+     */\n+    static EdgeToValueEntry create(String name, BooleanEncodedValue encodedValue, Map<Object, Object> map,", "originalCommit": "3ee1aa966da4e8c55b34ee9dcc5d8e1e7e68b1c1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1da02717deb31b9fdec2dc7d5a669298242ad634", "chunk": "diff --git a/core/src/main/java/com/graphhopper/routing/weighting/custom/BooleanToValueEntry.java b/core/src/main/java/com/graphhopper/routing/weighting/custom/BooleanToValueEntry.java\nindex 1b27194ce..863dcdf60 100644\n--- a/core/src/main/java/com/graphhopper/routing/weighting/custom/BooleanToValueEntry.java\n+++ b/core/src/main/java/com/graphhopper/routing/weighting/custom/BooleanToValueEntry.java\n\n@@ -22,6 +22,7 @@ import com.graphhopper.util.EdgeIteratorState;\n \n import java.util.Map;\n \n+import static com.graphhopper.routing.weighting.custom.CustomWeighting.CATCH_ALL;\n import static com.graphhopper.routing.weighting.custom.EnumToValueEntry.getReturnValue;\n \n final class BooleanToValueEntry implements EdgeToValueEntry {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE1NTY1Mw==", "url": "https://github.com/graphhopper/graphhopper/pull/2015#discussion_r414155653", "bodyText": "This is a bit ugly. If we set the custom model via Java API I think it should not be required to set a file (?)", "author": "karussell", "createdAt": "2020-04-23T22:06:10Z", "path": "core/src/main/java/com/graphhopper/routing/weighting/custom/CustomProfileConfig.java", "diffHunk": "@@ -18,6 +18,7 @@ public CustomProfileConfig(String name) {\n \n     public CustomProfileConfig setCustomModel(CustomModel customModel) {\n         getHints().putObject(CustomModel.KEY, customModel);\n+        getHints().putObject(\"custom_model_file\", \"empty\");", "originalCommit": "3ee1aa966da4e8c55b34ee9dcc5d8e1e7e68b1c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDM0NzI0OA==", "url": "https://github.com/graphhopper/graphhopper/pull/2015#discussion_r414347248", "bodyText": "Ah ok I see", "author": "easbar", "createdAt": "2020-04-24T07:11:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE1NTY1Mw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE1NjgyNg==", "url": "https://github.com/graphhopper/graphhopper/pull/2015#discussion_r414156826", "bodyText": "We can now live without being able to \"prefer\" secondary roads explicitly ... but one more entry is necessary.", "author": "karussell", "createdAt": "2020-04-23T22:08:36Z", "path": "web/src/test/java/com/graphhopper/http/resources/CustomWeightingRouteResourceLMTest.java", "diffHunk": "@@ -97,7 +97,8 @@ public void testCustomWeighting() {\n                 \"profile: car_custom\\n\" +\n                 \"priority:\\n\" +\n                 \"  road_class:\\n\" +\n-                \"    secondary: 2\\n\";\n+                \"    secondary: 1\\n\" +\n+                \"    '*': 0.5\\n\";", "originalCommit": "3ee1aa966da4e8c55b34ee9dcc5d8e1e7e68b1c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDM1Mjc3Mg==", "url": "https://github.com/graphhopper/graphhopper/pull/2015#discussion_r414352772", "bodyText": "Yes its a bit more verbose now, but also for me everything is a lot more clear now.", "author": "easbar", "createdAt": "2020-04-24T07:21:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE1NjgyNg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "1da02717deb31b9fdec2dc7d5a669298242ad634", "url": "https://github.com/graphhopper/graphhopper/commit/1da02717deb31b9fdec2dc7d5a669298242ad634", "message": "fix test case", "committedDate": "2020-04-23T22:15:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDM0NDA4NQ==", "url": "https://github.com/graphhopper/graphhopper/pull/2015#discussion_r414344085", "bodyText": "very minor use # to comment in yml", "author": "easbar", "createdAt": "2020-04-24T07:05:10Z", "path": "core/src/main/java/com/graphhopper/routing/weighting/custom/BooleanToValueEntry.java", "diffHunk": "@@ -20,18 +20,60 @@\n import com.graphhopper.routing.profiles.BooleanEncodedValue;\n import com.graphhopper.util.EdgeIteratorState;\n \n+import java.util.Map;\n+\n+import static com.graphhopper.routing.weighting.custom.CustomWeighting.CATCH_ALL;\n+import static com.graphhopper.routing.weighting.custom.EnumToValueEntry.getReturnValue;\n+\n final class BooleanToValueEntry implements EdgeToValueEntry {\n     private final BooleanEncodedValue bev;\n     private final double value, elseValue;\n \n-    public BooleanToValueEntry(BooleanEncodedValue bev, double value, double elseValue) {\n+    private BooleanToValueEntry(BooleanEncodedValue bev, double value, double elseValue) {\n         this.bev = bev;\n         this.value = value;\n         this.elseValue = elseValue;\n     }\n \n+    /**\n+     * Example map:\n+     * <pre>\n+     * get_off_bike:\n+     *   true: 0.4\n+     *   false: 0.9 // optional and default is 1, equivalent to \"*\": 0.9\n+     * </pre>", "originalCommit": "1da02717deb31b9fdec2dc7d5a669298242ad634", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "64bf9753ff598933e439757e2b14195104d2d281", "chunk": "diff --git a/core/src/main/java/com/graphhopper/routing/weighting/custom/BooleanToValueEntry.java b/core/src/main/java/com/graphhopper/routing/weighting/custom/BooleanToValueEntry.java\nindex 863dcdf60..73dd940f3 100644\n--- a/core/src/main/java/com/graphhopper/routing/weighting/custom/BooleanToValueEntry.java\n+++ b/core/src/main/java/com/graphhopper/routing/weighting/custom/BooleanToValueEntry.java\n\n@@ -40,7 +40,7 @@ final class BooleanToValueEntry implements EdgeToValueEntry {\n      * <pre>\n      * get_off_bike:\n      *   true: 0.4\n-     *   false: 0.9 // optional and default is 1, equivalent to \"*\": 0.9\n+     *   false: 0.9 # optional and default is 1, equivalent to \"*\": 0.9\n      * </pre>\n      */\n     static EdgeToValueEntry create(String name, BooleanEncodedValue encodedValue, Map<Object, Object> map,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDM0NTQyMA==", "url": "https://github.com/graphhopper/graphhopper/pull/2015#discussion_r414345420", "bodyText": "should we really allow the key to be of type boolean. hm well that is what it is , but all the other keys are strings so this would be a bit more consistent?", "author": "easbar", "createdAt": "2020-04-24T07:07:37Z", "path": "core/src/main/java/com/graphhopper/routing/weighting/custom/BooleanToValueEntry.java", "diffHunk": "@@ -20,18 +20,60 @@\n import com.graphhopper.routing.profiles.BooleanEncodedValue;\n import com.graphhopper.util.EdgeIteratorState;\n \n+import java.util.Map;\n+\n+import static com.graphhopper.routing.weighting.custom.CustomWeighting.CATCH_ALL;\n+import static com.graphhopper.routing.weighting.custom.EnumToValueEntry.getReturnValue;\n+\n final class BooleanToValueEntry implements EdgeToValueEntry {\n     private final BooleanEncodedValue bev;\n     private final double value, elseValue;\n \n-    public BooleanToValueEntry(BooleanEncodedValue bev, double value, double elseValue) {\n+    private BooleanToValueEntry(BooleanEncodedValue bev, double value, double elseValue) {\n         this.bev = bev;\n         this.value = value;\n         this.elseValue = elseValue;\n     }\n \n+    /**\n+     * Example map:\n+     * <pre>\n+     * get_off_bike:\n+     *   true: 0.4\n+     *   false: 0.9 // optional and default is 1, equivalent to \"*\": 0.9\n+     * </pre>\n+     */\n+    static EdgeToValueEntry create(String name, BooleanEncodedValue encodedValue, Map<Object, Object> map,\n+                                   double defaultValue, double minValue, double maxValue) {\n+        if (map.isEmpty())\n+            throw new IllegalArgumentException(\"Empty map for \" + name);\n+\n+        if (map.containsKey(CATCH_ALL) && (map.containsKey(\"false\") || map.containsKey(false)))", "originalCommit": "1da02717deb31b9fdec2dc7d5a669298242ad634", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ0MjAxMQ==", "url": "https://github.com/graphhopper/graphhopper/pull/2015#discussion_r414442011", "bodyText": "I'm not sure and tbh I have not even tested this (I'll do!) but the big problem could be that people do not quote the false like they do not need to quote the motorway.", "author": "karussell", "createdAt": "2020-04-24T09:43:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDM0NTQyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ0MzA0NQ==", "url": "https://github.com/graphhopper/graphhopper/pull/2015#discussion_r414443045", "bodyText": "Ah thats true I forgot you do not have to explicitly quote string parameters without special chars like motorway either", "author": "easbar", "createdAt": "2020-04-24T09:45:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDM0NTQyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ1NzgxOQ==", "url": "https://github.com/graphhopper/graphhopper/pull/2015#discussion_r414457819", "bodyText": "Turns out jackson forces the keys to be string even if you specify it like just false and not \"false\" in the yaml. So this is indeed not necessary.", "author": "karussell", "createdAt": "2020-04-24T10:09:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDM0NTQyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ2MDczMQ==", "url": "https://github.com/graphhopper/graphhopper/pull/2015#discussion_r414460731", "bodyText": "Ok good then :) Btw can we then delete this branch? Github allows removing the branches (so they do not show up anymore, but its even possible to restore them). Maybe there is even a default setting for github to delete branches after they are merged from a PR?", "author": "easbar", "createdAt": "2020-04-24T10:13:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDM0NTQyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ3NzI0OQ==", "url": "https://github.com/graphhopper/graphhopper/pull/2015#discussion_r414477249", "bodyText": "Done :) !\n\nMaybe there is even a default setting for github to delete branches after they are merged from a PR?\n\nDid not find something like this yet", "author": "karussell", "createdAt": "2020-04-24T10:41:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDM0NTQyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ3ODU3MQ==", "url": "https://github.com/graphhopper/graphhopper/pull/2015#discussion_r414478571", "bodyText": "Ah, or is it this:\n\nAfter pull requests are merged, you can have head branches deleted automatically.\nAutomatically delete head branches\nDeleted branches will still be able to be restored.", "author": "karussell", "createdAt": "2020-04-24T10:44:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDM0NTQyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ4MDg4MQ==", "url": "https://github.com/graphhopper/graphhopper/pull/2015#discussion_r414480881", "bodyText": "Have enabled it for now :)", "author": "karussell", "createdAt": "2020-04-24T10:48:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDM0NTQyMA=="}], "type": "inlineReview", "revised_code": {"commit": "64bf9753ff598933e439757e2b14195104d2d281", "chunk": "diff --git a/core/src/main/java/com/graphhopper/routing/weighting/custom/BooleanToValueEntry.java b/core/src/main/java/com/graphhopper/routing/weighting/custom/BooleanToValueEntry.java\nindex 863dcdf60..73dd940f3 100644\n--- a/core/src/main/java/com/graphhopper/routing/weighting/custom/BooleanToValueEntry.java\n+++ b/core/src/main/java/com/graphhopper/routing/weighting/custom/BooleanToValueEntry.java\n\n@@ -40,7 +40,7 @@ final class BooleanToValueEntry implements EdgeToValueEntry {\n      * <pre>\n      * get_off_bike:\n      *   true: 0.4\n-     *   false: 0.9 // optional and default is 1, equivalent to \"*\": 0.9\n+     *   false: 0.9 # optional and default is 1, equivalent to \"*\": 0.9\n      * </pre>\n      */\n     static EdgeToValueEntry create(String name, BooleanEncodedValue encodedValue, Map<Object, Object> map,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDM0ODQ4Mw==", "url": "https://github.com/graphhopper/graphhopper/pull/2015#discussion_r414348483", "bodyText": "Thats very nice we have these create methods now rather than doing it in speed/priorityCalculator's constructor", "author": "easbar", "createdAt": "2020-04-24T07:13:32Z", "path": "core/src/main/java/com/graphhopper/routing/weighting/custom/EnumToValueEntry.java", "diffHunk": "@@ -38,6 +41,66 @@ public double getValue(EdgeIteratorState iter, boolean reverse) {\n         return values[enumOrdinal];\n     }\n \n+    /**\n+     * Example map:\n+     * <pre>\n+     * road_class:\n+     *   motorway: 0.4\n+     *   \"*\": 0.9      # optional and default is 1\n+     * </pre>\n+     */\n+    static EnumToValueEntry create(String name, EnumEncodedValue enumEncodedValue, Map<Object, Object> map,", "originalCommit": "1da02717deb31b9fdec2dc7d5a669298242ad634", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "28ad20f60c46bcda23622798713f924d62bcfb7b", "chunk": "diff --git a/core/src/main/java/com/graphhopper/routing/weighting/custom/EnumToValueEntry.java b/core/src/main/java/com/graphhopper/routing/weighting/custom/EnumToValueEntry.java\nindex d01242f76..29ec6b8d0 100644\n--- a/core/src/main/java/com/graphhopper/routing/weighting/custom/EnumToValueEntry.java\n+++ b/core/src/main/java/com/graphhopper/routing/weighting/custom/EnumToValueEntry.java\n\n@@ -49,7 +49,7 @@ final class EnumToValueEntry implements EdgeToValueEntry {\n      *   \"*\": 0.9      # optional and default is 1\n      * </pre>\n      */\n-    static EnumToValueEntry create(String name, EnumEncodedValue enumEncodedValue, Map<Object, Object> map,\n+    static EnumToValueEntry create(String name, EnumEncodedValue enumEncodedValue, Map<String, Object> map,\n                                    double defaultValue, double minValue, double maxValue) {\n         Enum[] enumValues = enumEncodedValue.getValues();\n         if (map.isEmpty())\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDM0OTE5OA==", "url": "https://github.com/graphhopper/graphhopper/pull/2015#discussion_r414349198", "bodyText": "nice this got a lot more readable", "author": "easbar", "createdAt": "2020-04-24T07:14:54Z", "path": "core/src/main/java/com/graphhopper/routing/weighting/custom/PriorityCalculator.java", "diffHunk": "@@ -24,112 +24,53 @@\n import org.locationtech.jts.geom.prep.PreparedGeometryFactory;\n \n import java.util.ArrayList;\n-import java.util.Arrays;\n import java.util.List;\n import java.util.Map;\n \n final class PriorityCalculator {\n     private final List<EdgeToValueEntry> priorityList = new ArrayList<>();\n \n     public PriorityCalculator(CustomModel customModel, EncodedValueLookup lookup) {\n-        add(lookup, customModel.getVehicleWeight(), \"vehicle_weight\", MaxWeight.KEY);\n-        add(lookup, customModel.getVehicleWidth(), \"vehicle_width\", MaxWidth.KEY);\n-        add(lookup, customModel.getVehicleHeight(), \"vehicle_height\", MaxHeight.KEY);\n-        add(lookup, customModel.getVehicleLength(), \"vehicle_length\", MaxLength.KEY);\n-\n         for (Map.Entry<String, Object> entry : customModel.getPriority().entrySet()) {\n             String key = entry.getKey();\n+            String priorityKey = \"priority.\" + key;\n             Object value = entry.getValue();\n-\n-            if (value == null) {\n+            if (value == null)\n                 throw new IllegalArgumentException(\"Missing value for \" + key + \" in 'priority'\");\n-            } else if (value instanceof Number) {\n-                if (key.startsWith(GeoToValueEntry.AREA_PREFIX)) {\n-                    Geometry geometry = GeoToValueEntry.pickGeometry(customModel, key);\n-                    priorityList.add(new GeoToValueEntry(new PreparedGeometryFactory().create(geometry), ((Number) value).doubleValue(), 1));\n+\n+            if (key.startsWith(GeoToValueEntry.AREA_PREFIX)) {", "originalCommit": "1da02717deb31b9fdec2dc7d5a669298242ad634", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "64bf9753ff598933e439757e2b14195104d2d281", "chunk": "diff --git a/core/src/main/java/com/graphhopper/routing/weighting/custom/PriorityCalculator.java b/core/src/main/java/com/graphhopper/routing/weighting/custom/PriorityCalculator.java\nindex 91ac170ff..db1e44a88 100644\n--- a/core/src/main/java/com/graphhopper/routing/weighting/custom/PriorityCalculator.java\n+++ b/core/src/main/java/com/graphhopper/routing/weighting/custom/PriorityCalculator.java\n\n@@ -47,21 +47,22 @@ final class PriorityCalculator {\n             } else {\n                 if (!(value instanceof Map))\n                     throw new IllegalArgumentException(priorityKey + \": non-root entries requires a map but was: \" + value.getClass().getSimpleName());\n+                final double defaultPriority = 1, minPriority = 0, maxPriority = 1;\n                 EncodedValue encodedValue = getEV(lookup, \"priority\", key);\n                 if (encodedValue instanceof EnumEncodedValue) {\n                     priorityList.add(EnumToValueEntry.create(priorityKey, (EnumEncodedValue) encodedValue,\n-                            (Map) value, 1, 0, 1));\n+                            (Map) value, defaultPriority, minPriority, maxPriority));\n                 } else if (encodedValue instanceof DecimalEncodedValue) {\n                     priorityList.add(DecimalToValueEntry.create(priorityKey, (DecimalEncodedValue) encodedValue,\n-                            (Map) value, 1, 0, 1));\n+                            (Map) value, defaultPriority, minPriority, maxPriority));\n                 } else if (encodedValue instanceof BooleanEncodedValue) {\n                     priorityList.add(BooleanToValueEntry.create(priorityKey, (BooleanEncodedValue) encodedValue,\n-                            (Map) value, 1, 0, 1));\n+                            (Map) value, defaultPriority, minPriority, maxPriority));\n                 } else if (encodedValue instanceof IntEncodedValue) {\n                     // TODO NOW\n                 } else {\n-                    throw new IllegalArgumentException(\"encoded value class '\" + encodedValue.getClass().getSimpleName()\n-                            + \"' not supported. For '\" + key + \"' specified in 'priority'.\");\n+                    throw new IllegalArgumentException(\"The encoded value '\" + key + \"' used in 'priority' is of type \"\n+                            + encodedValue.getClass().getSimpleName() + \", but only types enum, decimal and boolean are supported.\");\n                 }\n             }\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDM1MDAyOQ==", "url": "https://github.com/graphhopper/graphhopper/pull/2015#discussion_r414350029", "bodyText": "maybe use final double defaultPriority=1; final double minPriority=0; final double maxPriority=1; for readability and to indicate its always the same", "author": "easbar", "createdAt": "2020-04-24T07:16:19Z", "path": "core/src/main/java/com/graphhopper/routing/weighting/custom/PriorityCalculator.java", "diffHunk": "@@ -24,112 +24,53 @@\n import org.locationtech.jts.geom.prep.PreparedGeometryFactory;\n \n import java.util.ArrayList;\n-import java.util.Arrays;\n import java.util.List;\n import java.util.Map;\n \n final class PriorityCalculator {\n     private final List<EdgeToValueEntry> priorityList = new ArrayList<>();\n \n     public PriorityCalculator(CustomModel customModel, EncodedValueLookup lookup) {\n-        add(lookup, customModel.getVehicleWeight(), \"vehicle_weight\", MaxWeight.KEY);\n-        add(lookup, customModel.getVehicleWidth(), \"vehicle_width\", MaxWidth.KEY);\n-        add(lookup, customModel.getVehicleHeight(), \"vehicle_height\", MaxHeight.KEY);\n-        add(lookup, customModel.getVehicleLength(), \"vehicle_length\", MaxLength.KEY);\n-\n         for (Map.Entry<String, Object> entry : customModel.getPriority().entrySet()) {\n             String key = entry.getKey();\n+            String priorityKey = \"priority.\" + key;\n             Object value = entry.getValue();\n-\n-            if (value == null) {\n+            if (value == null)\n                 throw new IllegalArgumentException(\"Missing value for \" + key + \" in 'priority'\");\n-            } else if (value instanceof Number) {\n-                if (key.startsWith(GeoToValueEntry.AREA_PREFIX)) {\n-                    Geometry geometry = GeoToValueEntry.pickGeometry(customModel, key);\n-                    priorityList.add(new GeoToValueEntry(new PreparedGeometryFactory().create(geometry), ((Number) value).doubleValue(), 1));\n+\n+            if (key.startsWith(GeoToValueEntry.AREA_PREFIX)) {\n+                if (!(value instanceof Number))\n+                    throw new IllegalArgumentException(priorityKey + \": area entry requires number value but was: \" + value.getClass().getSimpleName());\n+                Geometry geometry = GeoToValueEntry.pickGeometry(customModel, key);\n+                priorityList.add(GeoToValueEntry.create(priorityKey, new PreparedGeometryFactory().create(geometry),\n+                        (Number) value, 1, 0, 1));", "originalCommit": "1da02717deb31b9fdec2dc7d5a669298242ad634", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "64bf9753ff598933e439757e2b14195104d2d281", "chunk": "diff --git a/core/src/main/java/com/graphhopper/routing/weighting/custom/PriorityCalculator.java b/core/src/main/java/com/graphhopper/routing/weighting/custom/PriorityCalculator.java\nindex 91ac170ff..db1e44a88 100644\n--- a/core/src/main/java/com/graphhopper/routing/weighting/custom/PriorityCalculator.java\n+++ b/core/src/main/java/com/graphhopper/routing/weighting/custom/PriorityCalculator.java\n\n@@ -47,21 +47,22 @@ final class PriorityCalculator {\n             } else {\n                 if (!(value instanceof Map))\n                     throw new IllegalArgumentException(priorityKey + \": non-root entries requires a map but was: \" + value.getClass().getSimpleName());\n+                final double defaultPriority = 1, minPriority = 0, maxPriority = 1;\n                 EncodedValue encodedValue = getEV(lookup, \"priority\", key);\n                 if (encodedValue instanceof EnumEncodedValue) {\n                     priorityList.add(EnumToValueEntry.create(priorityKey, (EnumEncodedValue) encodedValue,\n-                            (Map) value, 1, 0, 1));\n+                            (Map) value, defaultPriority, minPriority, maxPriority));\n                 } else if (encodedValue instanceof DecimalEncodedValue) {\n                     priorityList.add(DecimalToValueEntry.create(priorityKey, (DecimalEncodedValue) encodedValue,\n-                            (Map) value, 1, 0, 1));\n+                            (Map) value, defaultPriority, minPriority, maxPriority));\n                 } else if (encodedValue instanceof BooleanEncodedValue) {\n                     priorityList.add(BooleanToValueEntry.create(priorityKey, (BooleanEncodedValue) encodedValue,\n-                            (Map) value, 1, 0, 1));\n+                            (Map) value, defaultPriority, minPriority, maxPriority));\n                 } else if (encodedValue instanceof IntEncodedValue) {\n                     // TODO NOW\n                 } else {\n-                    throw new IllegalArgumentException(\"encoded value class '\" + encodedValue.getClass().getSimpleName()\n-                            + \"' not supported. For '\" + key + \"' specified in 'priority'.\");\n+                    throw new IllegalArgumentException(\"The encoded value '\" + key + \"' used in 'priority' is of type \"\n+                            + encodedValue.getClass().getSimpleName() + \", but only types enum, decimal and boolean are supported.\");\n                 }\n             }\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDM1MTE2MA==", "url": "https://github.com/graphhopper/graphhopper/pull/2015#discussion_r414351160", "bodyText": "This could be a bit more user friendly: The encoded value 'key' used in 'priority' is of type X, but only A,B&C are allowed?", "author": "easbar", "createdAt": "2020-04-24T07:18:32Z", "path": "core/src/main/java/com/graphhopper/routing/weighting/custom/PriorityCalculator.java", "diffHunk": "@@ -24,112 +24,53 @@\n import org.locationtech.jts.geom.prep.PreparedGeometryFactory;\n \n import java.util.ArrayList;\n-import java.util.Arrays;\n import java.util.List;\n import java.util.Map;\n \n final class PriorityCalculator {\n     private final List<EdgeToValueEntry> priorityList = new ArrayList<>();\n \n     public PriorityCalculator(CustomModel customModel, EncodedValueLookup lookup) {\n-        add(lookup, customModel.getVehicleWeight(), \"vehicle_weight\", MaxWeight.KEY);\n-        add(lookup, customModel.getVehicleWidth(), \"vehicle_width\", MaxWidth.KEY);\n-        add(lookup, customModel.getVehicleHeight(), \"vehicle_height\", MaxHeight.KEY);\n-        add(lookup, customModel.getVehicleLength(), \"vehicle_length\", MaxLength.KEY);\n-\n         for (Map.Entry<String, Object> entry : customModel.getPriority().entrySet()) {\n             String key = entry.getKey();\n+            String priorityKey = \"priority.\" + key;\n             Object value = entry.getValue();\n-\n-            if (value == null) {\n+            if (value == null)\n                 throw new IllegalArgumentException(\"Missing value for \" + key + \" in 'priority'\");\n-            } else if (value instanceof Number) {\n-                if (key.startsWith(GeoToValueEntry.AREA_PREFIX)) {\n-                    Geometry geometry = GeoToValueEntry.pickGeometry(customModel, key);\n-                    priorityList.add(new GeoToValueEntry(new PreparedGeometryFactory().create(geometry), ((Number) value).doubleValue(), 1));\n+\n+            if (key.startsWith(GeoToValueEntry.AREA_PREFIX)) {\n+                if (!(value instanceof Number))\n+                    throw new IllegalArgumentException(priorityKey + \": area entry requires number value but was: \" + value.getClass().getSimpleName());\n+                Geometry geometry = GeoToValueEntry.pickGeometry(customModel, key);\n+                priorityList.add(GeoToValueEntry.create(priorityKey, new PreparedGeometryFactory().create(geometry),\n+                        (Number) value, 1, 0, 1));\n+            } else {\n+                if (!(value instanceof Map))\n+                    throw new IllegalArgumentException(priorityKey + \": non-root entries requires a map but was: \" + value.getClass().getSimpleName());\n+                EncodedValue encodedValue = getEV(lookup, \"priority\", key);\n+                if (encodedValue instanceof EnumEncodedValue) {\n+                    priorityList.add(EnumToValueEntry.create(priorityKey, (EnumEncodedValue) encodedValue,\n+                            (Map) value, 1, 0, 1));\n+                } else if (encodedValue instanceof DecimalEncodedValue) {\n+                    priorityList.add(DecimalToValueEntry.create(priorityKey, (DecimalEncodedValue) encodedValue,\n+                            (Map) value, 1, 0, 1));\n+                } else if (encodedValue instanceof BooleanEncodedValue) {\n+                    priorityList.add(BooleanToValueEntry.create(priorityKey, (BooleanEncodedValue) encodedValue,\n+                            (Map) value, 1, 0, 1));\n+                } else if (encodedValue instanceof IntEncodedValue) {\n+                    // TODO NOW\n                 } else {\n-                    BooleanEncodedValue encodedValue = getEV(lookup, \"priority\", key, BooleanEncodedValue.class);\n-                    priorityList.add(new BooleanToValueEntry(encodedValue, ((Number) value).doubleValue(), 1));\n+                    throw new IllegalArgumentException(\"encoded value class '\" + encodedValue.getClass().getSimpleName()", "originalCommit": "1da02717deb31b9fdec2dc7d5a669298242ad634", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "64bf9753ff598933e439757e2b14195104d2d281", "chunk": "diff --git a/core/src/main/java/com/graphhopper/routing/weighting/custom/PriorityCalculator.java b/core/src/main/java/com/graphhopper/routing/weighting/custom/PriorityCalculator.java\nindex 91ac170ff..db1e44a88 100644\n--- a/core/src/main/java/com/graphhopper/routing/weighting/custom/PriorityCalculator.java\n+++ b/core/src/main/java/com/graphhopper/routing/weighting/custom/PriorityCalculator.java\n\n@@ -47,21 +47,22 @@ final class PriorityCalculator {\n             } else {\n                 if (!(value instanceof Map))\n                     throw new IllegalArgumentException(priorityKey + \": non-root entries requires a map but was: \" + value.getClass().getSimpleName());\n+                final double defaultPriority = 1, minPriority = 0, maxPriority = 1;\n                 EncodedValue encodedValue = getEV(lookup, \"priority\", key);\n                 if (encodedValue instanceof EnumEncodedValue) {\n                     priorityList.add(EnumToValueEntry.create(priorityKey, (EnumEncodedValue) encodedValue,\n-                            (Map) value, 1, 0, 1));\n+                            (Map) value, defaultPriority, minPriority, maxPriority));\n                 } else if (encodedValue instanceof DecimalEncodedValue) {\n                     priorityList.add(DecimalToValueEntry.create(priorityKey, (DecimalEncodedValue) encodedValue,\n-                            (Map) value, 1, 0, 1));\n+                            (Map) value, defaultPriority, minPriority, maxPriority));\n                 } else if (encodedValue instanceof BooleanEncodedValue) {\n                     priorityList.add(BooleanToValueEntry.create(priorityKey, (BooleanEncodedValue) encodedValue,\n-                            (Map) value, 1, 0, 1));\n+                            (Map) value, defaultPriority, minPriority, maxPriority));\n                 } else if (encodedValue instanceof IntEncodedValue) {\n                     // TODO NOW\n                 } else {\n-                    throw new IllegalArgumentException(\"encoded value class '\" + encodedValue.getClass().getSimpleName()\n-                            + \"' not supported. For '\" + key + \"' specified in 'priority'.\");\n+                    throw new IllegalArgumentException(\"The encoded value '\" + key + \"' used in 'priority' is of type \"\n+                            + encodedValue.getClass().getSimpleName() + \", but only types enum, decimal and boolean are supported.\");\n                 }\n             }\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDM1MjEzMA==", "url": "https://github.com/graphhopper/graphhopper/pull/2015#discussion_r414352130", "bodyText": "same comments as for prio calculator i guess", "author": "easbar", "createdAt": "2020-04-24T07:20:17Z", "path": "core/src/main/java/com/graphhopper/routing/weighting/custom/SpeedCalculator.java", "diffHunk": "@@ -52,52 +48,72 @@ public SpeedCalculator(final double maxSpeed, CustomModel customModel, DecimalEn\n         // use max_speed to lower speed for the specified conditions\n         for (Map.Entry<String, Object> entry : customModel.getMaxSpeed().entrySet()) {\n             String key = entry.getKey();\n+            String maxSpeedKey = \"max_speed.\" + key;", "originalCommit": "1da02717deb31b9fdec2dc7d5a669298242ad634", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "64bf9753ff598933e439757e2b14195104d2d281", "chunk": "diff --git a/core/src/main/java/com/graphhopper/routing/weighting/custom/SpeedCalculator.java b/core/src/main/java/com/graphhopper/routing/weighting/custom/SpeedCalculator.java\nindex be9ddbe05..8ffe41885 100644\n--- a/core/src/main/java/com/graphhopper/routing/weighting/custom/SpeedCalculator.java\n+++ b/core/src/main/java/com/graphhopper/routing/weighting/custom/SpeedCalculator.java\n\n@@ -62,21 +62,22 @@ final class SpeedCalculator {\n             } else {\n                 if (!(value instanceof Map))\n                     throw new IllegalArgumentException(maxSpeedKey + \": non-root entries requires a map but was: \" + value.getClass().getSimpleName());\n+                final double defaultMaxSpeed = maxSpeed, minMaxSpeed = 0, maxMaxSpeed = maxSpeed;\n                 EncodedValue encodedValue = getEV(lookup, \"max_speed\", key);\n                 if (encodedValue instanceof EnumEncodedValue) {\n                     maxSpeedList.add(EnumToValueEntry.create(maxSpeedKey, (EnumEncodedValue) encodedValue,\n-                            (Map) value, maxSpeed, 0, maxSpeed));\n+                            (Map) value, defaultMaxSpeed, minMaxSpeed, maxMaxSpeed));\n                 } else if (encodedValue instanceof DecimalEncodedValue) {\n                     maxSpeedList.add(DecimalToValueEntry.create(maxSpeedKey, (DecimalEncodedValue) encodedValue,\n-                            (Map) value, maxSpeed, 0, maxSpeed));\n+                            (Map) value, defaultMaxSpeed, minMaxSpeed, maxMaxSpeed));\n                 } else if (encodedValue instanceof BooleanEncodedValue) {\n                     maxSpeedList.add(BooleanToValueEntry.create(maxSpeedKey, (BooleanEncodedValue) encodedValue,\n-                            (Map) value, maxSpeed, 0, maxSpeed));\n+                            (Map) value, defaultMaxSpeed, minMaxSpeed, maxMaxSpeed));\n                 } else if (encodedValue instanceof IntEncodedValue) {\n                     // TODO\n                 } else {\n-                    throw new IllegalArgumentException(\"encoded value class '\" + encodedValue.getClass().getSimpleName()\n-                            + \"' not supported. For '\" + key + \"' specified in 'max_speed'.\");\n+                    throw new IllegalArgumentException(\"The encoded value '\" + key + \"' used in 'max_speed' is of type \"\n+                            + encodedValue.getClass().getSimpleName() + \", but only types enum, decimal and boolean are supported.\");\n                 }\n             }\n         }\n"}}, {"oid": "64bf9753ff598933e439757e2b14195104d2d281", "url": "https://github.com/graphhopper/graphhopper/commit/64bf9753ff598933e439757e2b14195104d2d281", "message": "include changes from review", "committedDate": "2020-04-24T10:00:48Z", "type": "commit"}, {"oid": "28ad20f60c46bcda23622798713f924d62bcfb7b", "url": "https://github.com/graphhopper/graphhopper/commit/28ad20f60c46bcda23622798713f924d62bcfb7b", "message": "no need to consider boolean keys", "committedDate": "2020-04-24T10:10:09Z", "type": "commit"}]}