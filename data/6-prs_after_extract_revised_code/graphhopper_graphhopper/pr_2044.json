{"pr_number": 2044, "pr_title": "Use edge-based subnetwork removal if turn costs are enabled", "pr_createdAt": "2020-05-21T08:14:19Z", "pr_url": "https://github.com/graphhopper/graphhopper/pull/2044", "timeline": [{"oid": "5aec2d552b6d6668d80cc1039535943dec95e1b2", "url": "https://github.com/graphhopper/graphhopper/commit/5aec2d552b6d6668d80cc1039535943dec95e1b2", "message": "Use edge-based Tarjan for subnetwork removal when encoder supports turn costs", "committedDate": "2020-05-20T08:47:08Z", "type": "commit"}, {"oid": "8c985941146abcf24dcf52cb08d1f79c94bc913b", "url": "https://github.com/graphhopper/graphhopper/commit/8c985941146abcf24dcf52cb08d1f79c94bc913b", "message": "Fix problem with one-ways", "committedDate": "2020-05-20T21:10:02Z", "type": "commit"}, {"oid": "38a82e60c2fdb963be8998a69e1e20e170073d93", "url": "https://github.com/graphhopper/graphhopper/commit/38a82e60c2fdb963be8998a69e1e20e170073d93", "message": "Merge branch 'master' into edge_based_subnetworks", "committedDate": "2020-05-21T07:39:02Z", "type": "commit"}, {"oid": "d38ba5b2a87717be58ba3125a803acf2967fcf13", "url": "https://github.com/graphhopper/graphhopper/commit/d38ba5b2a87717be58ba3125a803acf2967fcf13", "message": "Fix docs", "committedDate": "2020-05-21T07:55:53Z", "type": "commit"}, {"oid": "e635dc4a6f4b056eab582a5bebb8a464f569327a", "url": "https://github.com/graphhopper/graphhopper/commit/e635dc4a6f4b056eab582a5bebb8a464f569327a", "message": "Fix typo", "committedDate": "2020-05-21T07:56:54Z", "type": "commit"}, {"oid": "0e26b682dbe62418cd524c832241aa661e897892", "url": "https://github.com/graphhopper/graphhopper/commit/0e26b682dbe62418cd524c832241aa661e897892", "message": "Fix logs", "committedDate": "2020-05-21T08:33:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUxMjgyMg==", "url": "https://github.com/graphhopper/graphhopper/pull/2044#discussion_r428512822", "bodyText": "I made this depend on the encoder, so it might happen that we have multiple profiles (some with and some without turn costs) that use the same encoder (the same access flags) and so we also use the edge-based subnetwork removal for the profiles without turn costs. This means we might remove some subnetworks that are not accessible if we included turn costs also for profiles that ignore turn costs anyway. But this does not seem to be a big problem to me. The (more general) alternative would be running the subnetwork removal per profile, but then we also need access flags per profile. Or maybe no access flags at all but this is another story so I went with the simple solution here. The other extreme would be always using the edge-based subnetwork removal (to make things more simple).", "author": "easbar", "createdAt": "2020-05-21T08:19:33Z", "path": "core/src/main/java/com/graphhopper/GraphHopper.java", "diffHunk": "@@ -1334,15 +1335,28 @@ protected void loadOrPrepareLM(boolean closeEarly) {\n      * Internal method to clean up the graph.\n      */\n     protected void cleanUp() {\n-        int prevNodeCount = ghStorage.getNodes();\n-        PrepareRoutingSubnetworks preparation = new PrepareRoutingSubnetworks(ghStorage, encodingManager.fetchEdgeEncoders());\n+        PrepareRoutingSubnetworks preparation = new PrepareRoutingSubnetworks(ghStorage, buildSubnetworkRemovalJobs());\n         preparation.setMinNetworkSize(minNetworkSize);\n         preparation.doWork();\n-        int currNodeCount = ghStorage.getNodes();\n-        logger.info(\"edges: \" + Helper.nf(ghStorage.getEdges()) + \", nodes \" + Helper.nf(currNodeCount)\n-                + \", there were \" + Helper.nf(preparation.getMaxSubnetworks())\n-                + \" subnetworks. removed them => \" + Helper.nf(prevNodeCount - currNodeCount)\n-                + \" less nodes\");\n+        logger.info(\"nodes: \" + Helper.nf(ghStorage.getNodes()) + \", edges: \" + Helper.nf(ghStorage.getEdges()));\n+    }\n+\n+    private List<PrepareJob> buildSubnetworkRemovalJobs() {\n+        List<FlagEncoder> encoders = encodingManager.fetchEdgeEncoders();\n+        List<PrepareJob> jobs = new ArrayList<>();\n+        for (FlagEncoder encoder : encoders) {\n+            // for encoders with turn costs we do an edge-based subnetwork removal, because they *might* be used with\n+            // a profile with turn_costs=true", "originalCommit": "e635dc4a6f4b056eab582a5bebb8a464f569327a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUxMzgwMA==", "url": "https://github.com/graphhopper/graphhopper/pull/2044#discussion_r428513800", "bodyText": "We could make this more consistent and also count the number of nodes for edge-based subnetwork removal, but I am not sure if its worth it. For edge-based subnetwork search we only get the edge keys of the components and would have to collect the set of nodes adjacent to these edges to find out how many nodes a component has.", "author": "easbar", "createdAt": "2020-05-21T08:21:45Z", "path": "core/src/main/java/com/graphhopper/routing/subnetwork/PrepareRoutingSubnetworks.java", "diffHunk": "@@ -38,29 +36,31 @@\n /**\n  * Removes nodes/edges which are not part of the 'main' network(s). I.e. mostly nodes with no edges at all but\n  * also small subnetworks which could be bugs in OSM data or 'islands' or indicate otherwise disconnected areas\n- * e.g. via barriers or one way problems - see #86.\n- * <p>\n+ * e.g. via barriers or one way problems - see #86. Subnetworks are removed by disabling access to the corresponding\n+ * edges for a given access encoded value. It is important to search for strongly connected components here (i.e.\n+ * consider that the graph is directed). For example, small areas like parking lots are sometimes connected to the whole\n+ * network through a single one-way road (a mapping error) and have to be removed because otherwise the routing fails\n+ * when starting from such a parking lot.\n  *\n  * @author Peter Karich\n  * @author easbar\n  */\n public class PrepareRoutingSubnetworks {\n     private final Logger logger = LoggerFactory.getLogger(getClass());\n     private final GraphHopperStorage ghStorage;\n-    private final List<FlagEncoder> encoders;\n-    private final List<BooleanEncodedValue> accessEncList;\n+    private final List<PrepareJob> prepareJobs;\n     private int minNetworkSize = 200;\n-    private int subnetworks = -1;\n \n-    public PrepareRoutingSubnetworks(GraphHopperStorage ghStorage, List<FlagEncoder> encoders) {\n+    public PrepareRoutingSubnetworks(GraphHopperStorage ghStorage, List<PrepareJob> prepareJobs) {\n         this.ghStorage = ghStorage;\n-        this.encoders = encoders;\n-        this.accessEncList = new ArrayList<>();\n-        for (FlagEncoder flagEncoder : encoders) {\n-            accessEncList.add(flagEncoder.getAccessEnc());\n-        }\n+        this.prepareJobs = prepareJobs;\n     }\n \n+    /**\n+     * The subnetwork removal removes components with less than {@link #minNetworkSize} nodes from the graph if it is\n+     * run node-based. For edge-based subnetwork removal it removes components with less than 2*{@link #minNetworkSize}\n+     * (directed) edges.\n+     */", "originalCommit": "e635dc4a6f4b056eab582a5bebb8a464f569327a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "518e9af9aae901391f9845e35ef83a07b2309385", "url": "https://github.com/graphhopper/graphhopper/commit/518e9af9aae901391f9845e35ef83a07b2309385", "message": "Add missing test map", "committedDate": "2020-05-21T08:44:22Z", "type": "commit"}]}