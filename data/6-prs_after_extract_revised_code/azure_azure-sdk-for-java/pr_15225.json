{"pr_number": 15225, "pr_title": "Optimizing scheduling of the AcquireTask completion callbacks", "pr_createdAt": "2020-09-15T18:27:55Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/15225", "timeline": [{"oid": "966a2024a44c52cb126c4b63a9a47a0c15cf0c04", "url": "https://github.com/Azure/azure-sdk-for-java/commit/966a2024a44c52cb126c4b63a9a47a0c15cf0c04", "message": "rntbd improvements", "committedDate": "2020-09-13T06:34:34Z", "type": "commit"}, {"oid": "d2d586efd129b5b76a68766cc51c84727a93b4ec", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d2d586efd129b5b76a68766cc51c84727a93b4ec", "message": "fixed latency issue and a race condition on close", "committedDate": "2020-09-13T18:43:51Z", "type": "commit"}, {"oid": "9c8ff08638ad0b705b4db2949fe4b0b87b9683c3", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9c8ff08638ad0b705b4db2949fe4b0b87b9683c3", "message": "fixed race condition in connection management resulting in creating more connections, fixed a infinite loop issue", "committedDate": "2020-09-14T01:54:23Z", "type": "commit"}, {"oid": "beb5fef10c2a3489f5a4ed28359936703de12df6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/beb5fef10c2a3489f5a4ed28359936703de12df6", "message": "fixed compilation warning", "committedDate": "2020-09-14T01:58:21Z", "type": "commit"}, {"oid": "2330f9d09f994ac1f1612bbd1e69eefc1e047b7a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2330f9d09f994ac1f1612bbd1e69eefc1e047b7a", "message": "ensure the channel is servicable", "committedDate": "2020-09-14T02:37:30Z", "type": "commit"}, {"oid": "065b4929f13b0f5f8ce61387faa68a1f29d2d54d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/065b4929f13b0f5f8ce61387faa68a1f29d2d54d", "message": "increase monitoring period", "committedDate": "2020-09-14T02:39:30Z", "type": "commit"}, {"oid": "4385fa967c5886c126329563885a611d42f748de", "url": "https://github.com/Azure/azure-sdk-for-java/commit/4385fa967c5886c126329563885a611d42f748de", "message": "removed info debug logs", "committedDate": "2020-09-14T02:43:53Z", "type": "commit"}, {"oid": "6a23badb7a9f86f7d5f158053322203549674606", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6a23badb7a9f86f7d5f158053322203549674606", "message": "cleanup", "committedDate": "2020-09-14T04:37:21Z", "type": "commit"}, {"oid": "e8a1e50363c62aa37e2b9d17689444d5cd932bd8", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e8a1e50363c62aa37e2b9d17689444d5cd932bd8", "message": "update condition", "committedDate": "2020-09-14T05:00:15Z", "type": "commit"}, {"oid": "05ac2e23020cffa4dcd9fc8a1b975084151e4842", "url": "https://github.com/Azure/azure-sdk-for-java/commit/05ac2e23020cffa4dcd9fc8a1b975084151e4842", "message": "Reacting to code review comments", "committedDate": "2020-09-14T14:45:08Z", "type": "commit"}, {"oid": "1757a02530c54281794416b121d26ad92f1d502b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1757a02530c54281794416b121d26ad92f1d502b", "message": "Merge branch 'master' into users/moderakh/20200912T2019-rntbd-fixes", "committedDate": "2020-09-14T15:01:38Z", "type": "commit"}, {"oid": "d3d199264101350194f742c12ef632d044fff4e5", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d3d199264101350194f742c12ef632d044fff4e5", "message": "Merge branch 'users/moderakh/20200912T2019-rntbd-fixes' of https://github.com/moderakh/azure-sdk-for-java into users/fabianm/RntbdMetricsToDiagnostics", "committedDate": "2020-09-14T15:06:04Z", "type": "commit"}, {"oid": "08879489d58638a7e4ca4cc4bb77184b8c16cdeb", "url": "https://github.com/Azure/azure-sdk-for-java/commit/08879489d58638a7e4ca4cc4bb77184b8c16cdeb", "message": "Merge pull request #1 from FabianMeiswinkel/users/fabianm/RntbdMetricsToDiagnostics\n\nUsers/fabianm/rntbd metrics to diagnostics", "committedDate": "2020-09-14T15:18:04Z", "type": "commit"}, {"oid": "342d085195ab2354aef241dfc07ea1ad1d47f863", "url": "https://github.com/Azure/azure-sdk-for-java/commit/342d085195ab2354aef241dfc07ea1ad1d47f863", "message": "improved queue pending task monitoring, fixed spotbug complain", "committedDate": "2020-09-14T16:14:42Z", "type": "commit"}, {"oid": "04f020a2f70984e9fc520d09e450d63bf6c695c6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/04f020a2f70984e9fc520d09e450d63bf6c695c6", "message": "Defense in-depth against releaseChannel race condition", "committedDate": "2020-09-14T18:24:55Z", "type": "commit"}, {"oid": "d611df90c1a689865cd5f6e69579aeddff438adc", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d611df90c1a689865cd5f6e69579aeddff438adc", "message": "Merge pull request #3 from FabianMeiswinkel/users/fabianm/RntbdMetricsToDiagnostics\n\n Defense in-depth against race condition if releaseChannel would be called concurrently for the same channel instance", "committedDate": "2020-09-14T18:31:05Z", "type": "commit"}, {"oid": "cf2a6c297c6213555d3f898ac5bbdb71eaf6f9fd", "url": "https://github.com/Azure/azure-sdk-for-java/commit/cf2a6c297c6213555d3f898ac5bbdb71eaf6f9fd", "message": "cancels pending acquisition tasks which are expired", "committedDate": "2020-09-15T02:11:00Z", "type": "commit"}, {"oid": "b251d07038e86ddb4f697eed8ef07d1a5b4b5f31", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b251d07038e86ddb4f697eed8ef07d1a5b4b5f31", "message": "cancels pending acquisition tasks which are expired", "committedDate": "2020-09-15T02:12:09Z", "type": "commit"}, {"oid": "9fab1c4a3493e220e5a51c87fb891696813cd15b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9fab1c4a3493e220e5a51c87fb891696813cd15b", "message": "Merge pull request #4 from moderakh/users/moderakh/20200913T1219-rntbd-fixes\n\nUsers/moderakh/20200913 t1219 rntbd fixes", "committedDate": "2020-09-15T02:30:57Z", "type": "commit"}, {"oid": "c0fc71c987acd3057f4de13ca7664404ef071d4e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c0fc71c987acd3057f4de13ca7664404ef071d4e", "message": "Fixing compiler warnings", "committedDate": "2020-09-15T03:20:06Z", "type": "commit"}, {"oid": "ac6a984d77a66bd7c2033d096de8b28fe89a26e3", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ac6a984d77a66bd7c2033d096de8b28fe89a26e3", "message": "Merge pull request #6 from FabianMeiswinkel/users/fabianm/RntbdMetricsToDiagnostics\n\nFixing compiler warnings", "committedDate": "2020-09-15T03:29:47Z", "type": "commit"}, {"oid": "fa91cf47ef383a33b0f2df3d33b9ea54a702fdf2", "url": "https://github.com/Azure/azure-sdk-for-java/commit/fa91cf47ef383a33b0f2df3d33b9ea54a702fdf2", "message": "Fixing SpotBug warning", "committedDate": "2020-09-15T04:40:46Z", "type": "commit"}, {"oid": "8c585e0649e0efd81b2fa0ba0d5df225424e245c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8c585e0649e0efd81b2fa0ba0d5df225424e245c", "message": "Merge pull request #7 from FabianMeiswinkel/users/fabianm/RntbdMetricsToDiagnostics\n\nFixing SpotBug warning", "committedDate": "2020-09-15T04:42:58Z", "type": "commit"}, {"oid": "90aeea4274006e7025684c2465fa5c0f156a2242", "url": "https://github.com/Azure/azure-sdk-for-java/commit/90aeea4274006e7025684c2465fa5c0f156a2242", "message": "Fixing build issue", "committedDate": "2020-09-15T05:14:50Z", "type": "commit"}, {"oid": "b5d184bcf3752f6fc2fdbee94eacb88d9466ed4d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b5d184bcf3752f6fc2fdbee94eacb88d9466ed4d", "message": "Merge pull request #8 from FabianMeiswinkel/users/fabianm/RntbdMetricsToDiagnostics\n\nFixing build issue", "committedDate": "2020-09-15T05:18:14Z", "type": "commit"}, {"oid": "ee0696a9ae4b885bf115d602ca301a860637ddd0", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ee0696a9ae4b885bf115d602ca301a860637ddd0", "message": "Fixing SpotBug issue", "committedDate": "2020-09-15T05:42:02Z", "type": "commit"}, {"oid": "0aaa7f208ea46b86e348cf11a032aa30b8eb88a7", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0aaa7f208ea46b86e348cf11a032aa30b8eb88a7", "message": "Merge pull request #9 from FabianMeiswinkel/users/fabianm/RntbdMetricsToDiagnostics\n\nFixing SpotBug issue", "committedDate": "2020-09-15T05:44:54Z", "type": "commit"}, {"oid": "b490f055b879e024134840ea94397cf46a973d07", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b490f055b879e024134840ea94397cf46a973d07", "message": "Moving AcquireTask completion callbacks away from the  channel pool executor's event loop", "committedDate": "2020-09-15T15:16:03Z", "type": "commit"}, {"oid": "094472e5e65e95740121ed30f9ddcf3cb2910f0b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/094472e5e65e95740121ed30f9ddcf3cb2910f0b", "message": "Further iterating on the scheduling for AcuireTask completions", "committedDate": "2020-09-15T17:21:27Z", "type": "commit"}, {"oid": "a18033dc2a4e516e53f8ca629c9805e87da1f3b2", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a18033dc2a4e516e53f8ca629c9805e87da1f3b2", "message": "Cleanup", "committedDate": "2020-09-15T17:42:48Z", "type": "commit"}, {"oid": "d9be0f5eaa0110c5f4a9551a616bfe9537963a55", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d9be0f5eaa0110c5f4a9551a616bfe9537963a55", "message": "Stop ignoring maxRequest limit", "committedDate": "2020-09-15T18:05:05Z", "type": "commit"}, {"oid": "51136dd1f76dc8f2e5b28146e839a9b60a6e2626", "url": "https://github.com/Azure/azure-sdk-for-java/commit/51136dd1f76dc8f2e5b28146e839a9b60a6e2626", "message": "Merge branch 'master' of https://github.com/Azure/azure-sdk-for-java into users/fabianm/AcquisitionTaskSchedulingFix", "committedDate": "2020-09-15T18:26:30Z", "type": "commit"}, {"oid": "92edadeb61d7bdff5c6725d5f9a5acb79442366d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/92edadeb61d7bdff5c6725d5f9a5acb79442366d", "message": "Missed porting one change when resolving merge conflicts", "committedDate": "2020-09-15T18:36:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg4NjY4MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15225#discussion_r488886681", "bodyText": "why don't we need ignoreMaxRequestLimit anymore?", "author": "moderakh", "createdAt": "2020-09-15T18:46:14Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdClientChannelPool.java", "diffHunk": "@@ -860,26 +861,52 @@ private void ensureInEventLoop() {\n      *\n      * @return {@code true} if the given {@link Channel channel} is serviceable; {@code false} otherwise.\n      */\n-    private boolean isChannelServiceable(final Channel channel, boolean ignoreMaxRequestLimit) {", "originalCommit": "92edadeb61d7bdff5c6725d5f9a5acb79442366d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg5MjA2MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15225#discussion_r488892061", "bodyText": "Annie borught up a good point that in the fallback-else-path we were incorrectly ignoring maxPendingRequestCount - when reeenforicng it all places passed in false anywhere (except in the high load factor part - where we pick the available channel with the least number of requests (but also should only do it if < maxPendingRequests)", "author": "FabianMeiswinkel", "createdAt": "2020-09-15T18:53:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg4NjY4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg5MjMyNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15225#discussion_r488892327", "bodyText": "Bottom-line - no place should be ignoring maxPendingRequests", "author": "FabianMeiswinkel", "createdAt": "2020-09-15T18:53:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg4NjY4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkxNTQ3OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15225#discussion_r488915479", "bodyText": "Closed offline", "author": "kirankumarkolli", "createdAt": "2020-09-15T19:27:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg4NjY4MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg4Njk1OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15225#discussion_r488886959", "bodyText": "why don't we need ignoreMaxRequestPerChannel anymore?", "author": "moderakh", "createdAt": "2020-09-15T18:46:46Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdRequestManager.java", "diffHunk": "@@ -548,10 +546,10 @@ boolean hasRntbdContext() {\n         return this.contextFuture.getNow(null) != null;\n     }\n \n-    boolean isServiceable(final int demand, boolean ignoreMaxRequestPerChannel) {\n+    boolean isServiceable(final int demand) {", "originalCommit": "92edadeb61d7bdff5c6725d5f9a5acb79442366d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkwNjY2OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15225#discussion_r488906669", "bodyText": "Discussed offline - not needed anymore.", "author": "FabianMeiswinkel", "createdAt": "2020-09-15T19:14:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg4Njk1OQ=="}], "type": "inlineReview", "revised_code": null}]}