{"pr_number": 17231, "pr_title": "Fixes issue where it would try to autocomplete/abandon messages that were already settled", "pr_createdAt": "2020-11-05T18:21:54Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/17231", "timeline": [{"oid": "24676bfb23f94e454e8c203e70a22c0560072856", "url": "https://github.com/Azure/azure-sdk-for-java/commit/24676bfb23f94e454e8c203e70a22c0560072856", "message": "Follow with .NET in not throwing error when RECEIVE_AND_DELETE mode is used and AutoComplete.", "committedDate": "2020-11-03T00:33:42Z", "type": "commit"}, {"oid": "d36fe080d748ae6a4d939faf4eccc95051b54da1", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d36fe080d748ae6a4d939faf4eccc95051b54da1", "message": "Add package private isSettled to message.", "committedDate": "2020-11-03T00:34:15Z", "type": "commit"}, {"oid": "dea6241f646dc3be2aa035a778d1c427b6c081e0", "url": "https://github.com/Azure/azure-sdk-for-java/commit/dea6241f646dc3be2aa035a778d1c427b6c081e0", "message": "Adding logic to set isSettled in client receiver and utilise it in AutoComplete.", "committedDate": "2020-11-03T00:36:44Z", "type": "commit"}, {"oid": "917ebaeabd8ba1a099f860e01f62210aa967cd18", "url": "https://github.com/Azure/azure-sdk-for-java/commit/917ebaeabd8ba1a099f860e01f62210aa967cd18", "message": "Cancelling upstream on error.", "committedDate": "2020-11-05T18:09:47Z", "type": "commit"}, {"oid": "dbe2551feef5526682e450fbfd646677638ef1cd", "url": "https://github.com/Azure/azure-sdk-for-java/commit/dbe2551feef5526682e450fbfd646677638ef1cd", "message": "Remove unneeded publish.", "committedDate": "2020-11-05T18:11:11Z", "type": "commit"}, {"oid": "3a4f06d076831c82174607856102319a08b4cd38", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3a4f06d076831c82174607856102319a08b4cd38", "message": "Adding AutoComplete cancellation tests.", "committedDate": "2020-11-05T18:17:36Z", "type": "commit"}, {"oid": "ff69cf8c09b57266bb215bb2b4d290af2997938b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ff69cf8c09b57266bb215bb2b4d290af2997938b", "message": "Check for disposed before waiting for semaphore.", "committedDate": "2020-11-05T18:45:25Z", "type": "commit"}, {"oid": "f2b09eb5aacc267836f778732777313cf5806aaf", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f2b09eb5aacc267836f778732777313cf5806aaf", "message": "Merge branch 'master' of https://github.com/Azure/azure-sdk-for-java into issue-17071", "committedDate": "2020-11-05T18:49:13Z", "type": "commit"}, {"oid": "53672ee6eb9f47dcd6d12f7c4a9b72cf4b4866a2", "url": "https://github.com/Azure/azure-sdk-for-java/commit/53672ee6eb9f47dcd6d12f7c4a9b72cf4b4866a2", "message": "Fix test.", "committedDate": "2020-11-05T18:51:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM3NTE5Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17231#discussion_r518375192", "bodyText": "Do we need argument. ? Shouldn't this always set it to true", "author": "hemanttanwar", "createdAt": "2020-11-05T21:20:36Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceivedMessage.java", "diffHunk": "@@ -508,12 +523,12 @@ void setEnqueuedTime(OffsetDateTime enqueuedTime) {\n     }\n \n     /**\n-     * Sets the subject for the message.\n+     * Sets whether the message has been settled.\n      *\n-     * @param subject The subject to set.\n+     * @param isSettled True if the message has been settled and false otherwise.\n      */\n-    void setSubject(String subject) {\n-        amqpAnnotatedMessage.getProperties().setSubject(subject);\n+    void setIsSettled(boolean isSettled) {\n+        this.isSettled = isSettled;", "originalCommit": "53672ee6eb9f47dcd6d12f7c4a9b72cf4b4866a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM5NDk4NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17231#discussion_r518394984", "bodyText": "Resolved", "author": "conniey", "createdAt": "2020-11-05T21:59:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM3NTE5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "2f95dfa7123b408c8c134f9f9f39d850801edd08", "chunk": "diff --git a/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceivedMessage.java b/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceivedMessage.java\nindex ea32fdc81a6..74c6df584c8 100644\n--- a/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceivedMessage.java\n+++ b/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceivedMessage.java\n\n@@ -525,10 +525,9 @@ public final class ServiceBusReceivedMessage {\n     /**\n      * Sets whether the message has been settled.\n      *\n-     * @param isSettled True if the message has been settled and false otherwise.\n      */\n-    void setIsSettled(boolean isSettled) {\n-        this.isSettled = isSettled;\n+    void setIsSettled() {\n+        this.isSettled = true;\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM3OTUyMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17231#discussion_r518379523", "bodyText": "If the message is already settled, we should throw error with message something like The message has either been deleted or already settled \nCheck line item 2 on this.\nhttps://microsoft.sharepoint.com/teams/AzureDeveloperExperience/_layouts/15/Doc.aspx?sourcedoc={41b0af1e-8da3-4d88-b296-9b616c3e7b6b}&action=edit&wd=target%28Design.one%7C14d18aa9-3941-cf4d-b2fa-4b211ac30733%2FException%5C%2FError%20handling%7Ce696adb4-72c6-4a64-85fb-1d187557099b%2F%29&wdorigin=703", "author": "hemanttanwar", "createdAt": "2020-11-05T21:29:01Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClient.java", "diffHunk": "@@ -1001,16 +1005,18 @@ private boolean isManagementToken(String lockToken) {\n                 logger.info(\"{}: Management node Update completed. Disposition: {}. Lock: {}.\",\n                     entityPath, dispositionStatus, lockToken);\n \n+                message.setIsSettled(true);", "originalCommit": "53672ee6eb9f47dcd6d12f7c4a9b72cf4b4866a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM5NTA5Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17231#discussion_r518395092", "bodyText": "Throwing error message now.", "author": "conniey", "createdAt": "2020-11-05T21:59:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM3OTUyMw=="}], "type": "inlineReview", "revised_code": {"commit": "2f95dfa7123b408c8c134f9f9f39d850801edd08", "chunk": "diff --git a/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClient.java b/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClient.java\nindex bb0aa5446d3..8efa5993343 100644\n--- a/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClient.java\n+++ b/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClient.java\n\n@@ -1005,7 +1008,7 @@ public final class ServiceBusReceiverAsyncClient implements AutoCloseable {\n                 logger.info(\"{}: Management node Update completed. Disposition: {}. Lock: {}.\",\n                     entityPath, dispositionStatus, lockToken);\n \n-                message.setIsSettled(true);\n+                message.setIsSettled();\n                 managementNodeLocks.remove(lockToken);\n                 renewalContainer.remove(lockToken);\n             }));\n"}}, {"oid": "2f95dfa7123b408c8c134f9f9f39d850801edd08", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2f95dfa7123b408c8c134f9f9f39d850801edd08", "message": "Set isSettled to true. Add error message.", "committedDate": "2020-11-05T21:58:48Z", "type": "commit"}]}