{"pr_number": 16197, "pr_title": "MiscellaneousChangeForRntbd", "pr_createdAt": "2020-10-12T18:21:05Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/16197", "timeline": [{"oid": "850e718a09967a02e7390688bcca08885c7a96c3", "url": "https://github.com/Azure/azure-sdk-for-java/commit/850e718a09967a02e7390688bcca08885c7a96c3", "message": "ConnectionStateListener change", "committedDate": "2020-10-06T15:30:43Z", "type": "commit"}, {"oid": "49b62d6ef3d36ed3b3e0a56d5366ef3ac7fe0a4a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/49b62d6ef3d36ed3b3e0a56d5366ef3ac7fe0a4a", "message": "clean", "committedDate": "2020-10-06T17:31:45Z", "type": "commit"}, {"oid": "c38d31c4ec7c5251cfabb9fb5f281c58b99baad8", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c38d31c4ec7c5251cfabb9fb5f281c58b99baad8", "message": "fix", "committedDate": "2020-10-06T18:27:18Z", "type": "commit"}, {"oid": "116d4c238dff9cdd6fb0456a4ad82fab5e5aa82a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/116d4c238dff9cdd6fb0456a4ad82fab5e5aa82a", "message": "resolve comments", "committedDate": "2020-10-06T19:02:13Z", "type": "commit"}, {"oid": "1a8bcccacfb0528d426ae1adc3c2557ee622c78b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1a8bcccacfb0528d426ae1adc3c2557ee622c78b", "message": "Merge branch 'master' into ConnectionStateListener", "committedDate": "2020-10-09T19:46:59Z", "type": "commit"}, {"oid": "8d353fdf1a1e6501dc0eb0198837756372dc90dc", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8d353fdf1a1e6501dc0eb0198837756372dc90dc", "message": "Merge branch 'master' into ConnectionStateListenerSplit", "committedDate": "2020-10-12T16:49:08Z", "type": "commit"}, {"oid": "be1512532374ab85eb46e977c70eb646ba6482ec", "url": "https://github.com/Azure/azure-sdk-for-java/commit/be1512532374ab85eb46e977c70eb646ba6482ec", "message": "revert back ConnectionStateListener", "committedDate": "2020-10-12T17:36:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ2MjYxMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16197#discussion_r503462611", "bodyText": "\"It is reported, just not stored as a value\" (copied from the original PR).\nThis will not change the rntbd timeline diagnostics. After this change:\n\"serializationDiagnosticsContext\":{\"serializationDiagnosticsList\":[{\"serializationType\":\"ITEM_SERIALIZATION\",\"startTimeUTC\":\"22 Sep 2020 17:40:59.239\",\"endTimeUTC\":\"22 Sep 2020 17:40:59.239\",\"durationInMicroSec\":0},{\"serializationType\":\"PARTITION_KEY_FETCH_SERIALIZATION\",\"startTimeUTC\":\"22 Sep 2020 17:40:59.317\",\"endTimeUTC\":\"22 Sep 2020 17:40:59.323\",\"durationInMicroSec\":5998}]},\"gatewayStatistics\":null,\"systemInformation\":{\"usedMemory\":\"60586 KB\",\"availableMemory\":\"8309590 KB\",\"systemCpuLoad\":\"(2020-09-22T17:40:58.729927700Z 20.1%)\"}}", "author": "xinlian12", "createdAt": "2020-10-12T18:21:41Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/RequestTimeline.java", "diffHunk": "@@ -151,19 +151,17 @@ public String toString() {\n         return RntbdObjectMapper.toString(this);\n     }\n \n-    @JsonPropertyOrder({ \"name\", \"startTimeUTC\", \"durationInMicroSec\" })\n+    @JsonPropertyOrder({ \"name\", \"startTimeUTC\" })\n     public static final class Event {\n \n         @JsonIgnore\n         private final Duration duration;\n \n-        @JsonSerialize(using = ToStringSerializer.class)\n-        private final long durationInMicroSec;", "originalCommit": "be1512532374ab85eb46e977c70eb646ba6482ec", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "9f418ba312a8d2d07c70b13680b28f933e707d77", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9f418ba312a8d2d07c70b13680b28f933e707d77", "message": "fix", "committedDate": "2020-10-12T18:23:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ2Mzg3NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16197#discussion_r503463874", "bodyText": "This is removed because no where is using it.", "author": "xinlian12", "createdAt": "2020-10-12T18:24:39Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RntbdTransportClient.java", "diffHunk": "@@ -327,9 +364,6 @@ private void throwIfClosed() {\n         @JsonProperty()\n         private final Duration receiveHangDetectionTime;\n \n-        @JsonProperty()\n-        private final Duration requestExpiryInterval;", "originalCommit": "9f418ba312a8d2d07c70b13680b28f933e707d77", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "1665ab1f2a74e153f598493d6b2afa80b66d4a5e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1665ab1f2a74e153f598493d6b2afa80b66d4a5e", "message": "revert", "committedDate": "2020-10-13T00:59:06Z", "type": "commit"}, {"oid": "88de52c2fea1a6ee1b62bbd22ca507dcc4f8ee09", "url": "https://github.com/Azure/azure-sdk-for-java/commit/88de52c2fea1a6ee1b62bbd22ca507dcc4f8ee09", "message": "Merge and resolve conflicts", "committedDate": "2020-10-22T22:38:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ5OTczNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16197#discussion_r510499735", "bodyText": "I think we should remove these, since DirectConnectionConfig already provides the APIs now. This was before the public APIs and was only used through JVM options.\nOr if we want to keep these configurations, we should update them to the correct values - like maxChannelsPerEndpoint, maxRequestsPerChannel, idleEndpointTimeout, etc.", "author": "kushagraThapar", "createdAt": "2020-10-22T22:46:11Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RntbdTransportClient.java", "diffHunk": "@@ -566,7 +599,6 @@ public String toString() {\n          *   \"maxRequestsPerChannel\": 30,\n          *   \"maxConcurrentRequestsPerEndpointOverride\": 500,\n          *   \"receiveHangDetectionTime\": \"PT1M5S\",\n-         *   \"requestExpiryInterval\": \"PT5S\",", "originalCommit": "88de52c2fea1a6ee1b62bbd22ca507dcc4f8ee09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUzMDgwMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16197#discussion_r510530802", "bodyText": "hmm, I think this comments are more about giving different ways how you can using the JVM options and setup the values. I feel it has been very useful when doing tests.\nSo for now, I left the comments to be the way it is today, but update the values to be consistent with the default values.", "author": "xinlian12", "createdAt": "2020-10-23T00:23:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ5OTczNQ=="}], "type": "inlineReview", "revised_code": {"commit": "ba6a55cd10ba052353b8ed6d3892bacbed8b2435", "chunk": "diff --git a/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RntbdTransportClient.java b/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RntbdTransportClient.java\nindex 2917a3fa110..8c2535c7726 100644\n--- a/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RntbdTransportClient.java\n+++ b/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RntbdTransportClient.java\n\n@@ -590,17 +590,17 @@ public final class RntbdTransportClient extends TransportClient {\n          * <pre>{@code RntbdTransportClient.class.getClassLoader().getResourceAsStream(\"azure.cosmos.directTcp.defaultOptions.json\")}</pre>\n          * <p>Example: <pre>{@code {\n          *   \"bufferPageSize\": 8192,\n-         *   \"connectionEndpointRediscoveryEnabled\": true,\n-         *   \"connectTimeout\": \"PT1M\",\n+         *   \"connectionEndpointRediscoveryEnabled\": false,\n+         *   \"connectTimeout\": \"PT5S\",\n          *   \"idleChannelTimeout\": \"PT0S\",\n-         *   \"idleEndpointTimeout\": \"PT1M10S\",\n+         *   \"idleEndpointTimeout\": \"PT1H\",\n          *   \"maxBufferCapacity\": 8388608,\n-         *   \"maxChannelsPerEndpoint\": 10,\n+         *   \"maxChannelsPerEndpoint\": 130,\n          *   \"maxRequestsPerChannel\": 30,\n-         *   \"maxConcurrentRequestsPerEndpointOverride\": 500,\n+         *   \"maxConcurrentRequestsPerEndpointOverride\": -1,\n          *   \"receiveHangDetectionTime\": \"PT1M5S\",\n          *   \"requestTimeout\": \"PT5S\",\n-         *   \"requestTimerResolution\": \"PT0.5S\",\n+         *   \"requestTimerResolution\": \"PT100MS\",\n          *   \"sendHangDetectionTime\": \"PT10S\",\n          *   \"shutdownTimeout\": \"PT15S\",\n          *   \"threadCount\": 16\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUwMDEzNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16197#discussion_r510500137", "bodyText": "What is the reason behind this change ?", "author": "kushagraThapar", "createdAt": "2020-10-22T22:47:25Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdRequestManager.java", "diffHunk": "@@ -527,7 +527,7 @@ public void write(final ChannelHandlerContext context, final Object message, fin\n \n         if (message == RntbdHealthCheckRequest.MESSAGE) {\n \n-            context.write(RntbdHealthCheckRequest.MESSAGE, promise).addListener(completed -> {\n+            context.writeAndFlush(RntbdHealthCheckRequest.MESSAGE, promise).addListener(completed -> {", "originalCommit": "88de52c2fea1a6ee1b62bbd22ca507dcc4f8ee09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUwMjIwMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16197#discussion_r510502201", "bodyText": "It is not a required change. But generally write is only queue the message but not really send through wire, writeAndFlush will help flush the message further down the pipeline, so I think it makes sense to keep this change.\nBut I am also open to exclude this change for now and may have a PR in future separately for this", "author": "xinlian12", "createdAt": "2020-10-22T22:53:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUwMDEzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUwMzQ3OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16197#discussion_r510503478", "bodyText": "In any case, there is one more context.write we should make sure to flush that one as well.\nIf we want to change it, do you know when were we doing the flush in just write case ?", "author": "kushagraThapar", "createdAt": "2020-10-22T22:57:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUwMDEzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUxMzI5Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16197#discussion_r510513297", "bodyText": "This potentially can be a perf impacting change.\nIf we decide to include this we should study the impact of this on both latency and throughput. I think the following studies would be needed:\n\nboth latency and throughput using the normal benchmark flow (when saturating max load)\nboth latency and throughput on sparse workload (https://github.com/Azure/azure-sdk-for-java/blob/master/sdk/cosmos/azure-cosmos-benchmark/src/main/java/com/azure/cosmos/benchmark/Configuration.java#L144)", "author": "moderakh", "createdAt": "2020-10-22T23:30:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUwMDEzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUyNTY1NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16197#discussion_r510525654", "bodyText": "I agree, If we want to change it, we should understand how the flushing was working so far and why we want to change it ?\nBecause I remember in my past conversations with David, flushing immediately had some downsides as well. I can't remember the exact downsides, may be they are not present any more. But a perf check would help us figure it out.", "author": "kushagraThapar", "createdAt": "2020-10-23T00:03:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUwMDEzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUyOTc5Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16197#discussion_r510529793", "bodyText": "@kushagraThapar My current understanding is that, when we call write, the message will be queued in the out buffer, but it is not for sure that the message will be written to the socket. Netty will decide when to flush the message out, so that is why we do not have to call flush in our code.\n@moderakh  Yea, make sense, and those are good tests to do for this change.\n@kushagraThapar  @moderakh  I think I will revert this change for now, so this PR only contains style/renaming change,  and I will have a separate PR for this change and to investigate more about it.", "author": "xinlian12", "createdAt": "2020-10-23T00:19:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUwMDEzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUzODkxNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16197#discussion_r510538914", "bodyText": "Makes sense @xinlian12 , thanks.", "author": "kushagraThapar", "createdAt": "2020-10-23T00:58:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUwMDEzNw=="}], "type": "inlineReview", "revised_code": {"commit": "ba6a55cd10ba052353b8ed6d3892bacbed8b2435", "chunk": "diff --git a/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdRequestManager.java b/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdRequestManager.java\nindex 78107bd35f2..be08b66e893 100644\n--- a/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdRequestManager.java\n+++ b/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdRequestManager.java\n\n@@ -527,7 +527,7 @@ public final class RntbdRequestManager implements ChannelHandler, ChannelInbound\n \n         if (message == RntbdHealthCheckRequest.MESSAGE) {\n \n-            context.writeAndFlush(RntbdHealthCheckRequest.MESSAGE, promise).addListener(completed -> {\n+            context.write(RntbdHealthCheckRequest.MESSAGE, promise).addListener(completed -> {\n                 if (completed.isSuccess()) {\n                     this.timestamps.channelPingCompleted();\n                 }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUxMTk3OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16197#discussion_r510511978", "bodyText": "this adds IdleStateHandler before SSLHandler. Is is intentional?\nThe old code had IdleStateHandler after SSLHandler.", "author": "moderakh", "createdAt": "2020-10-22T23:26:03Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdClientChannelHandler.java", "diffHunk": "@@ -114,9 +113,14 @@ protected void initChannel(final Channel channel) {\n         }\n \n         pipeline.addFirst(\n-            // TODO (DANOBLE) Log an issue with netty\n-            // Initialize sslHandler with jdkCompatibilityMode = true for openssl context.\n-            new SslHandler(this.config.sslContext().newEngine(channel.alloc())),\n+            // Initialize sslHandler with jdkCompatibilityMode = true for OpenSSL context\n+            // TODO Log an issue with netty for clarification on the design of this constructor and the\n+            //  semantic differences between the JDK and OpenSSL implementations\n+            new SslHandler(this.config.sslContext().newEngine(channel.alloc())));\n+\n+        final long idleConnectionTimerResolutionInNanos = config.idleConnectionTimerResolutionInNanos();\n+\n+        pipeline.addFirst(", "originalCommit": "88de52c2fea1a6ee1b62bbd22ca507dcc4f8ee09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUyNTMxMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16197#discussion_r510525313", "bodyText": "I believe SSLHandler should be the very first one in the pipeline, no ?", "author": "kushagraThapar", "createdAt": "2020-10-23T00:02:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUxMTk3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUyNzQyMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16197#discussion_r510527422", "bodyText": "good catch, I do not thinkthat is the intent here, reverted back.", "author": "xinlian12", "createdAt": "2020-10-23T00:10:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUxMTk3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA1MDcwMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16197#discussion_r512050701", "bodyText": "@kushagraThapar  yup, SSLHandler is the very first one in the pipeline today, but after the change, IdleStateHandler will be the first one, so did not think that is the intent. Has reverted the change back.\nThanks~", "author": "xinlian12", "createdAt": "2020-10-26T15:28:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUxMTk3OA=="}], "type": "inlineReview", "revised_code": {"commit": "ba6a55cd10ba052353b8ed6d3892bacbed8b2435", "chunk": "diff --git a/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdClientChannelHandler.java b/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdClientChannelHandler.java\nindex be701b37ab1..a016ec4c0a9 100644\n--- a/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdClientChannelHandler.java\n+++ b/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdClientChannelHandler.java\n\n@@ -113,14 +114,9 @@ public class RntbdClientChannelHandler extends ChannelInitializer<Channel> imple\n         }\n \n         pipeline.addFirst(\n-            // Initialize sslHandler with jdkCompatibilityMode = true for OpenSSL context\n-            // TODO Log an issue with netty for clarification on the design of this constructor and the\n-            //  semantic differences between the JDK and OpenSSL implementations\n-            new SslHandler(this.config.sslContext().newEngine(channel.alloc())));\n-\n-        final long idleConnectionTimerResolutionInNanos = config.idleConnectionTimerResolutionInNanos();\n-\n-        pipeline.addFirst(\n+            // TODO (DANOBLE) Log an issue with netty\n+            // Initialize sslHandler with jdkCompatibilityMode = true for openssl context.\n+            new SslHandler(this.config.sslContext().newEngine(channel.alloc())),\n             new IdleStateHandler(\n                 idleConnectionTimerResolutionInNanos,\n                 idleConnectionTimerResolutionInNanos,\n"}}, {"oid": "ba6a55cd10ba052353b8ed6d3892bacbed8b2435", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ba6a55cd10ba052353b8ed6d3892bacbed8b2435", "message": "resolve comments", "committedDate": "2020-10-23T00:11:21Z", "type": "commit"}]}