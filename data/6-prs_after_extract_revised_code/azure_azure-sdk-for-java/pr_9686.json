{"pr_number": 9686, "pr_title": "Adding support for auto create and auto delete test container", "pr_createdAt": "2020-03-30T15:51:37Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/9686", "timeline": [{"oid": "6ca2070a9e036e9e4860687c579abdc5809c384c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6ca2070a9e036e9e4860687c579abdc5809c384c", "message": "adding support for createIfNotExist for db and container , aslo deleting container at the last", "committedDate": "2020-03-30T15:45:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMxMTE0Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9686#discussion_r400311146", "bodyText": "this is the default partition-key if the collection does not exist. But if the collection exist the partition-key path could be different and that's ok. right?\nSo could you please change the naming to DEFAULT_PARTITION_KEY_PATH", "author": "moderakh", "createdAt": "2020-03-30T16:04:30Z", "path": "sdk/cosmos/azure-cosmos-benchmark/src/main/java/com/azure/cosmos/benchmark/Configuration.java", "diffHunk": "@@ -32,6 +32,7 @@\n \n class Configuration {\n \n+    final static String PARTITION_KEY = \"/pk\";", "originalCommit": "6ca2070a9e036e9e4860687c579abdc5809c384c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA4MzIzMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9686#discussion_r401083231", "bodyText": "done", "author": "simplynaveen20", "createdAt": "2020-03-31T17:20:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMxMTE0Ng=="}], "type": "inlineReview", "revised_code": {"commit": "fb08736630e05d428e7a2d612b71a0cff8db711f", "chunk": "diff --git a/sdk/cosmos/azure-cosmos-benchmark/src/main/java/com/azure/cosmos/benchmark/Configuration.java b/sdk/cosmos/azure-cosmos-benchmark/src/main/java/com/azure/cosmos/benchmark/Configuration.java\nindex 33fafba4133..a60af126260 100644\n--- a/sdk/cosmos/azure-cosmos-benchmark/src/main/java/com/azure/cosmos/benchmark/Configuration.java\n+++ b/sdk/cosmos/azure-cosmos-benchmark/src/main/java/com/azure/cosmos/benchmark/Configuration.java\n\n@@ -32,7 +32,7 @@ import java.util.Arrays;\n \n class Configuration {\n \n-    final static String PARTITION_KEY = \"/pk\";\n+    final static String DEFAULT_PARTITION_KEY = \"/pk\";\n     private final static int DEFAULT_GRAPHITE_SERVER_PORT = 2003;\n     private MeterRegistry azureMonitorMeterRegistry;\n     private MeterRegistry graphiteMeterRegistry;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMxNTY5Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9686#discussion_r400315693", "bodyText": "In our testing subscriptions we can't create a collection with 1M throughput upfront. The workaround we have is to create a collection with 100K throughput and then scale up. Now with this auto deleting collection it means we have to do this manual process everytime.\nwe don't want to always delete the collection. We should have a config option called autoCollectionCreateEnabled when present we should attempt to\n\ncreate collection if not exist\ndelete the collection\n\nwhen autoCollectionCreateEnabled=false we shouldn't attempt to create or delete the collection, and if the collection doesn't exist we should fail.", "author": "moderakh", "createdAt": "2020-03-30T16:10:55Z", "path": "sdk/cosmos/azure-cosmos-benchmark/src/main/java/com/azure/cosmos/benchmark/AsyncBenchmark.java", "diffHunk": "@@ -130,6 +134,8 @@ protected void init() {\n     }\n \n     void shutdown() {\n+        cosmosAsyncContainer.delete().block();", "originalCommit": "6ca2070a9e036e9e4860687c579abdc5809c384c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA4NDM0MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9686#discussion_r401084340", "bodyText": "Please check current design , it is more seem less in respect to customer expectation , code will only create resource if it is not present , and only delete newly created resource and not the existing", "author": "simplynaveen20", "createdAt": "2020-03-31T17:21:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMxNTY5Mw=="}], "type": "inlineReview", "revised_code": {"commit": "fb08736630e05d428e7a2d612b71a0cff8db711f", "chunk": "diff --git a/sdk/cosmos/azure-cosmos-benchmark/src/main/java/com/azure/cosmos/benchmark/AsyncBenchmark.java b/sdk/cosmos/azure-cosmos-benchmark/src/main/java/com/azure/cosmos/benchmark/AsyncBenchmark.java\nindex 8fba0b9e5ca..af183f81475 100644\n--- a/sdk/cosmos/azure-cosmos-benchmark/src/main/java/com/azure/cosmos/benchmark/AsyncBenchmark.java\n+++ b/sdk/cosmos/azure-cosmos-benchmark/src/main/java/com/azure/cosmos/benchmark/AsyncBenchmark.java\n\n@@ -134,8 +159,14 @@ abstract class AsyncBenchmark<T> {\n     }\n \n     void shutdown() {\n-        cosmosAsyncContainer.delete().block();\n-        logger.info(\"Deleted test container {}\" , this.configuration.getCollectionId());\n+        if (this.databaseCreated) {\n+            cosmosAsyncDatabase.delete().block();\n+            logger.info(\"Deleted temporary database {} created for this test\", this.configuration.getDatabaseId());\n+        } else if (this.collectionCreated) {\n+            cosmosAsyncContainer.delete().block();\n+            logger.info(\"Deleted temporary collection {} created for this test\", this.configuration.getCollectionId());\n+        }\n+\n         cosmosClient.close();\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM1Mjg1Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9686#discussion_r400352853", "bodyText": "if the application deletes it should create too.\nwhen a user runs an application, the user expects to either 1.  application handles the collection creation/deletion 2. the user provides the collection and the app doesn't create nor deletes.", "author": "moderakh", "createdAt": "2020-03-30T17:06:21Z", "path": "sdk/cosmos/azure-cosmos-benchmark/src/main/java/com/azure/cosmos/benchmark/AsynReadWithMultipleClients.java", "diffHunk": "@@ -227,33 +212,29 @@ private void createClients() {\n                         .connectionReuseAcrossClientsEnabled(true)\n                         .buildAsyncClient();\n                     List<PojoizedJson> docsToRead = new ArrayList<>();\n-                    if (!configuration.isDeleteCollections()) {\n-                        CosmosAsyncDatabase cosmosAsyncDatabase = asyncClient.createDatabaseIfNotExists(this.configuration.getDatabaseId()).block().getDatabase();\n-                        CosmosAsyncContainer cosmosAsyncContainer =\n-                            cosmosAsyncDatabase.createContainerIfNotExists(configuration.getCollectionId(), PARTITION_KEY, configuration.getThroughput()).block().getContainer();\n-                        String partitionKey = cosmosAsyncContainer.read().block().getProperties().getPartitionKeyDefinition()\n-                            .getPaths().iterator().next().split(\"/\")[1];\n-                        String dataFieldValue = RandomStringUtils.randomAlphabetic(this.configuration.getDocumentDataFieldSize());\n-                        ArrayList<Flux<PojoizedJson>> createDocumentObservables = new ArrayList<>();\n-\n-                        for (int i = 0; i < this.configuration.getNumberOfPreCreatedDocuments(); i++) {\n-                            String uuid = UUID.randomUUID().toString();\n-                            com.azure.cosmos.benchmark.PojoizedJson newDoc = generateDocument(uuid, dataFieldValue, partitionKey);\n-\n-                            Flux<PojoizedJson> obs = cosmosAsyncContainer.createItem(newDoc).map(resp -> {\n-                                    com.azure.cosmos.benchmark.PojoizedJson x =\n-                                        resp.getItem();\n-                                    return x;\n-                                }\n-                            ).flux();\n-                            createDocumentObservables.add(obs);\n-                        }\n-                        docsToRead = Flux.merge(Flux.fromIterable(createDocumentObservables), 100).collectList().block();\n-\n-                        logger.info(\"Client have been initialized with data created for host {}\", hostAndKey[0]);\n-                    } else {\n-                        logger.info(\"Client have been initialized with host {}\", hostAndKey[0]);\n+                    CosmosAsyncDatabase cosmosAsyncDatabase = asyncClient.createDatabaseIfNotExists(this.configuration.getDatabaseId()).block().getDatabase();\n+                    CosmosAsyncContainer cosmosAsyncContainer =\n+                        cosmosAsyncDatabase.createContainerIfNotExists(configuration.getCollectionId(), Configuration.PARTITION_KEY, configuration.getThroughput()).block().getContainer();", "originalCommit": "6ca2070a9e036e9e4860687c579abdc5809c384c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA4NDI2MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9686#discussion_r401084260", "bodyText": "Please check current design , it is more seem less in respect to customer expectation , code will only create resource if it is not present , and only delete newly created resource and not the existing", "author": "simplynaveen20", "createdAt": "2020-03-31T17:21:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM1Mjg1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "fb08736630e05d428e7a2d612b71a0cff8db711f", "chunk": "diff --git a/sdk/cosmos/azure-cosmos-benchmark/src/main/java/com/azure/cosmos/benchmark/AsynReadWithMultipleClients.java b/sdk/cosmos/azure-cosmos-benchmark/src/main/java/com/azure/cosmos/benchmark/AsynReadWithMultipleClients.java\nindex d72c10e196d..0eac6da07b4 100644\n--- a/sdk/cosmos/azure-cosmos-benchmark/src/main/java/com/azure/cosmos/benchmark/AsynReadWithMultipleClients.java\n+++ b/sdk/cosmos/azure-cosmos-benchmark/src/main/java/com/azure/cosmos/benchmark/AsynReadWithMultipleClients.java\n\n@@ -212,9 +228,37 @@ public class AsynReadWithMultipleClients<T> {\n                         .connectionReuseAcrossClientsEnabled(true)\n                         .buildAsyncClient();\n                     List<PojoizedJson> docsToRead = new ArrayList<>();\n-                    CosmosAsyncDatabase cosmosAsyncDatabase = asyncClient.createDatabaseIfNotExists(this.configuration.getDatabaseId()).block().getDatabase();\n-                    CosmosAsyncContainer cosmosAsyncContainer =\n-                        cosmosAsyncDatabase.createContainerIfNotExists(configuration.getCollectionId(), Configuration.PARTITION_KEY, configuration.getThroughput()).block().getContainer();\n+                    CosmosAsyncDatabase cosmosAsyncDatabase = null;\n+                    CosmosAsyncContainer cosmosAsyncContainer = null;\n+                    boolean databaseCreated = false;\n+                    try {\n+                        cosmosAsyncDatabase = asyncClient.getDatabase(this.configuration.getDatabaseId()).read().block().getDatabase();\n+                    } catch (CosmosClientException e) {\n+                        if (e.getStatusCode() == HttpConstants.StatusCodes.NOTFOUND) {\n+                            cosmosAsyncDatabase = asyncClient.createDatabase(this.configuration.getDatabaseId()).block().getDatabase();\n+                            logger.info(\"Database {} is created for this test on host {}\", this.configuration.getDatabaseId(), endpoint);\n+                            databaseCreated = true;\n+                            databaseListToClear.add(cosmosAsyncDatabase);\n+                        } else {\n+                            throw e;\n+                        }\n+                    }\n+\n+                    try {\n+                        cosmosAsyncContainer = cosmosAsyncDatabase.getContainer(this.configuration.getCollectionId()).read().block().getContainer();\n+                    } catch (CosmosClientException e) {\n+                        if (e.getStatusCode() == HttpConstants.StatusCodes.NOTFOUND) {\n+                            cosmosAsyncContainer =\n+                                cosmosAsyncDatabase.createContainer(this.configuration.getCollectionId(), Configuration.DEFAULT_PARTITION_KEY, this.configuration.getThroughput()).block().getContainer();\n+                            logger.info(\"Collection {} is created for this test on host {}\", this.configuration.getCollectionId(), endpoint);\n+                            if(!databaseCreated) {\n+                                collectionListToClear.add(cosmosAsyncContainer);\n+                            }\n+                        } else {\n+                            throw e;\n+                        }\n+                    }\n+\n                     String partitionKey = cosmosAsyncContainer.read().block().getProperties().getPartitionKeyDefinition()\n                         .getPaths().iterator().next().split(\"/\")[1];\n                     String dataFieldValue = RandomStringUtils.randomAlphabetic(this.configuration.getDocumentDataFieldSize());\n"}}, {"oid": "fb08736630e05d428e7a2d612b71a0cff8db711f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/fb08736630e05d428e7a2d612b71a0cff8db711f", "message": "deleting resources if created", "committedDate": "2020-03-31T17:14:45Z", "type": "commit"}, {"oid": "37c55d66984cd44d728e542197b89b4856709244", "url": "https://github.com/Azure/azure-sdk-for-java/commit/37c55d66984cd44d728e542197b89b4856709244", "message": "string constant text change", "committedDate": "2020-03-31T17:19:53Z", "type": "commit"}]}