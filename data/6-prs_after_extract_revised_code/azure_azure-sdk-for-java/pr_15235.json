{"pr_number": 15235, "pr_title": "Fix send span to encapsulate multiple retries and use shared context", "pr_createdAt": "2020-09-15T22:19:46Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/15235", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTAzMTE3MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15235#discussion_r489031170", "bodyText": "Do we have a ClientConstants in SB to put this?", "author": "samvaity", "createdAt": "2020-09-15T22:29:42Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusSenderAsyncClient.java", "diffHunk": "@@ -74,6 +75,9 @@\n      */\n     static final int MAX_MESSAGE_LENGTH_BYTES = 256 * 1024;\n     private static final String TRANSACTION_LINK_NAME = \"coordinator\";\n+    // Please see <a href=https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/azure-services-resource-providers>here</a>\n+    // for more information on Azure resource provider namespaces.\n+    private static final String AZ_TRACING_NAMESPACE_VALUE = \"Microsoft.ServiceBus\";", "originalCommit": "6b363cb22e33d5645fb7dac2eae7fae5d2f03a18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTA0MjY3MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15235#discussion_r489042670", "bodyText": "This can live here for now if it is the only place it is used.", "author": "conniey", "createdAt": "2020-09-15T22:44:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTAzMTE3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTA0MzQ0Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15235#discussion_r489043442", "bodyText": "If you execute Ctrl+N, then Constants, you'll find ServiceBusConstants.", "author": "conniey", "createdAt": "2020-09-15T22:45:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTAzMTE3MA=="}], "type": "inlineReview", "revised_code": {"commit": "a972ab41cdc3c8ff974392eaa6610d36b56e2853", "chunk": "diff --git a/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusSenderAsyncClient.java b/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusSenderAsyncClient.java\nindex 97b0d0641f6..d5503712634 100644\n--- a/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusSenderAsyncClient.java\n+++ b/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusSenderAsyncClient.java\n\n@@ -80,6 +80,7 @@ public final class ServiceBusSenderAsyncClient implements AutoCloseable {\n     private static final String AZ_TRACING_NAMESPACE_VALUE = \"Microsoft.ServiceBus\";\n \n     private static final CreateBatchOptions DEFAULT_BATCH_OPTIONS =  new CreateBatchOptions();\n+    private static final String SERVICE_BASE_NAME = \"ServiceBus.\";\n \n     private final ClientLogger logger = new ClientLogger(ServiceBusSenderAsyncClient.class);\n     private final AtomicReference<String> linkName = new AtomicReference<>();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTAzMjU0Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15235#discussion_r489032542", "bodyText": "For the entityPath and hostName values, do we want to update the ServiceBusSenderAsyncClient or we should be able to retrieve it some other way?", "author": "samvaity", "createdAt": "2020-09-15T22:31:28Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusSenderAsyncClient.java", "diffHunk": "@@ -495,17 +499,19 @@ public void close() {\n             messages.add(message);\n         }\n \n-        final Context finalSharedContext = sharedContext != null ? sharedContext : Context.NONE;\n+        if (isTracingEnabled) {\n+            final Context finalSharedContext = sharedContext == null\n+                ? Context.NONE\n+                : sharedContext\n+                    .addData(ENTITY_PATH_KEY, \"entityPath\")\n+                    .addData(HOST_NAME_KEY, \"hostName\")", "originalCommit": "6b363cb22e33d5645fb7dac2eae7fae5d2f03a18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTA0MjQ3MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15235#discussion_r489042470", "bodyText": "There is an entityName you can use for entityPath. I'm sure fullyqualifedDomainName is also exposed in this class.", "author": "conniey", "createdAt": "2020-09-15T22:44:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTAzMjU0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "a972ab41cdc3c8ff974392eaa6610d36b56e2853", "chunk": "diff --git a/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusSenderAsyncClient.java b/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusSenderAsyncClient.java\nindex 97b0d0641f6..d5503712634 100644\n--- a/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusSenderAsyncClient.java\n+++ b/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusSenderAsyncClient.java\n\n@@ -503,11 +505,11 @@ public final class ServiceBusSenderAsyncClient implements AutoCloseable {\n             final Context finalSharedContext = sharedContext == null\n                 ? Context.NONE\n                 : sharedContext\n-                    .addData(ENTITY_PATH_KEY, \"entityPath\")\n-                    .addData(HOST_NAME_KEY, \"hostName\")\n+                    .addData(ENTITY_PATH_KEY, entityName)\n+                    .addData(HOST_NAME_KEY, connectionProcessor.getFullyQualifiedNamespace())\n                     .addData(AZ_TRACING_NAMESPACE_KEY, AZ_TRACING_NAMESPACE_VALUE);\n             // Start send span and store updated context\n-            parentContext.set(tracerProvider.startSpan(finalSharedContext, ProcessKind.SEND));\n+            parentContext.set(tracerProvider.startSpan(AZ_TRACING_SERVICE_NAME, finalSharedContext, ProcessKind.SEND));\n         }\n \n         return withRetry(\n"}}, {"oid": "f99589d2244e83a698936edd89a52ab66fa42e3e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f99589d2244e83a698936edd89a52ab66fa42e3e", "message": "Fix send span multiple send attempts", "committedDate": "2020-09-15T22:34:59Z", "type": "forcePushed"}, {"oid": "a972ab41cdc3c8ff974392eaa6610d36b56e2853", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a972ab41cdc3c8ff974392eaa6610d36b56e2853", "message": "update service name and add tests", "committedDate": "2020-09-22T08:05:42Z", "type": "forcePushed"}, {"oid": "c5e34691a8bb3e184c972f4515f956a05b05f66f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c5e34691a8bb3e184c972f4515f956a05b05f66f", "message": "update service name and add tests", "committedDate": "2020-09-22T20:46:25Z", "type": "forcePushed"}, {"oid": "fbf62d9e7adda63db373c39d3437e5101cf53cc0", "url": "https://github.com/Azure/azure-sdk-for-java/commit/fbf62d9e7adda63db373c39d3437e5101cf53cc0", "message": "add eventhub changes", "committedDate": "2020-09-23T01:19:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA4ODcxNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15235#discussion_r495088716", "bodyText": "Does this break Event Hubs?", "author": "conniey", "createdAt": "2020-09-25T16:06:36Z", "path": "sdk/core/azure-core-amqp/src/main/java/com/azure/core/amqp/implementation/TracerProvider.java", "diffHunk": "@@ -33,17 +33,18 @@ public boolean isEnabled() {\n      * new span will be added as a child, otherwise the span will be created and added to the context and any downstream\n      * start calls will use the created span as the parent.\n      *\n+     * @param serviceBaseName the service name to be appended to the span name.\n      * @param context Additional metadata that is passed through the call stack.\n      * @param processKind the invoking process type.\n      * @return An updated context object.\n      */\n-    public Context startSpan(Context context, ProcessKind processKind) {\n+    public Context startSpan(String serviceBaseName, Context context, ProcessKind processKind) {", "originalCommit": "fbf62d9e7adda63db373c39d3437e5101cf53cc0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEyMTg5NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15235#discussion_r495121895", "bodyText": "I updated Eventhubs too in this PR. It should be implementation details.", "author": "samvaity", "createdAt": "2020-09-25T17:08:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA4ODcxNg=="}], "type": "inlineReview", "revised_code": {"commit": "a9f36e8bcc565ab3869744ee19a1962e2249e173", "chunk": "diff --git a/sdk/core/azure-core-amqp/src/main/java/com/azure/core/amqp/implementation/TracerProvider.java b/sdk/core/azure-core-amqp/src/main/java/com/azure/core/amqp/implementation/TracerProvider.java\nindex 295c531dec5..b181712d40e 100644\n--- a/sdk/core/azure-core-amqp/src/main/java/com/azure/core/amqp/implementation/TracerProvider.java\n+++ b/sdk/core/azure-core-amqp/src/main/java/com/azure/core/amqp/implementation/TracerProvider.java\n\n@@ -33,18 +33,17 @@ public class TracerProvider {\n      * new span will be added as a child, otherwise the span will be created and added to the context and any downstream\n      * start calls will use the created span as the parent.\n      *\n-     * @param serviceBaseName the service name to be appended to the span name.\n      * @param context Additional metadata that is passed through the call stack.\n      * @param processKind the invoking process type.\n      * @return An updated context object.\n      */\n-    public Context startSpan(String serviceBaseName, Context context, ProcessKind processKind) {\n+    public Context startSpan(Context context, ProcessKind processKind) {\n         if (tracer == null) {\n             return context;\n         }\n         Objects.requireNonNull(context, \"'context' cannot be null.\");\n         Objects.requireNonNull(processKind, \"'processKind' cannot be null.\");\n-        String spanName = getSpanName(serviceBaseName, processKind);\n+        String spanName = getSpanName(processKind);\n \n         return tracer.start(spanName, context, processKind);\n     }\n"}}, {"oid": "a9f36e8bcc565ab3869744ee19a1962e2249e173", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a9f36e8bcc565ab3869744ee19a1962e2249e173", "message": "Fix send span multiple send attempts", "committedDate": "2020-10-08T00:37:41Z", "type": "commit"}, {"oid": "0768e043480cafffdec2b81d1996a49a5b3a4917", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0768e043480cafffdec2b81d1996a49a5b3a4917", "message": "update service name and add tests", "committedDate": "2020-10-08T00:42:15Z", "type": "commit"}, {"oid": "8b56f25d51300b79dd304940a13cbfd0ff20e892", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8b56f25d51300b79dd304940a13cbfd0ff20e892", "message": "remove duplicate dependency", "committedDate": "2020-10-08T00:43:31Z", "type": "commit"}, {"oid": "bb69eadf39dd06207b1a38dd5d8cdb09dda47be8", "url": "https://github.com/Azure/azure-sdk-for-java/commit/bb69eadf39dd06207b1a38dd5d8cdb09dda47be8", "message": "add eventhub changes", "committedDate": "2020-10-08T00:43:51Z", "type": "commit"}, {"oid": "bb69eadf39dd06207b1a38dd5d8cdb09dda47be8", "url": "https://github.com/Azure/azure-sdk-for-java/commit/bb69eadf39dd06207b1a38dd5d8cdb09dda47be8", "message": "add eventhub changes", "committedDate": "2020-10-08T00:43:51Z", "type": "forcePushed"}, {"oid": "c3db5bad6617e553ec1db0fbea729bc59cea3c84", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c3db5bad6617e553ec1db0fbea729bc59cea3c84", "message": "rebase conflict", "committedDate": "2020-10-08T00:46:06Z", "type": "commit"}]}