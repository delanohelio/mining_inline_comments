{"pr_number": 11501, "pr_title": "Cosmos: *Properties related code and doc changes", "pr_createdAt": "2020-05-28T07:56:46Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/11501", "timeline": [{"oid": "ddd237454f0459e94545e549eb44cf2b6121a985", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ddd237454f0459e94545e549eb44cf2b6121a985", "message": "Update documentation for getting the request charges of a Cosmos operation.", "committedDate": "2020-05-28T06:26:26Z", "type": "commit"}, {"oid": "585c227ce5d3b939d94449fe6bfc28e4552130cc", "url": "https://github.com/Azure/azure-sdk-for-java/commit/585c227ce5d3b939d94449fe6bfc28e4552130cc", "message": "Update getResourceId() to be package private (it was public).\nUpdate *Properties for Cosmos scripts to package private; add constructor that takes id and body. Update respective tests.", "committedDate": "2020-05-28T07:51:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkzOTExOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11501#discussion_r431939118", "bodyText": "We are replacing getResourceId() -> with getId()\nCan you please make sure these tests pass ?\nHere and everywhere else in your changes ?", "author": "kushagraThapar", "createdAt": "2020-05-28T15:46:21Z", "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/rx/UserQueryTest.java", "diffHunk": "@@ -86,7 +86,7 @@ public void queryAllUsers() throws Exception {\n \n         FeedResponseListValidator<CosmosUserProperties> validator = new FeedResponseListValidator.Builder<CosmosUserProperties>()\n                 .totalSize(expectedUsers.size())\n-                .exactlyContainsInAnyOrder(expectedUsers.stream().map(d -> d.getResourceId()).collect(Collectors.toList()))\n+                .exactlyContainsInAnyOrder(expectedUsers.stream().map(CosmosUserProperties::getId).collect(Collectors.toList()))", "originalCommit": "585c227ce5d3b939d94449fe6bfc28e4552130cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk0MjU5NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11501#discussion_r431942595", "bodyText": "Please don't replace this in the tests. ResourceId is a unique value, however id may not necessary be unique.\nTo access package private getResource you can use BridgeInternal if needed. please roll back these changes.", "author": "moderakh", "createdAt": "2020-05-28T15:51:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkzOTExOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk3Mjc0Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11501#discussion_r431972747", "bodyText": "So basically what this comes to is that UUID.randomUUID().toString() does not generate unique IDs??? If yes than we have a bigger problem through the whole test bed.", "author": "milismsft", "createdAt": "2020-05-28T16:36:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkzOTExOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk4MjAyMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11501#discussion_r431982022", "bodyText": "Milis, are you taking into account that ID may not necessarily be unique across multiple partitions?", "author": "moderakh", "createdAt": "2020-05-28T16:51:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkzOTExOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjAwMzU4NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11501#discussion_r432003584", "bodyText": "The IDs for all those tests are generated using the API I just mentioned; they pretty much should be unique as they come out from it. The second thing is that there are no partition setting that are applicable to databases, containers, container scripts for instance. All these tests use the IDs to count the results (see Reactor collect() call following them).\nSo unless we have a special test that create a batch of documents and they all inserted in two or more sets with different partition key values, we should be fine.\nI'm running the full set of tests; that should give us the validation we need, right?", "author": "milismsft", "createdAt": "2020-05-28T17:27:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkzOTExOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjAxMDk5OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11501#discussion_r432010998", "bodyText": "@milismsft  as the goal of the PR is to change the public api, I suggest we don't change how tests work. If you have thought on improving the tests please consider anything other than public api change outside of the PR for public api change.\nas a pattern we rely on resourceId to ensure we cover having same id across multiple partition scenario.", "author": "moderakh", "createdAt": "2020-05-28T17:40:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkzOTExOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjAzNzYyNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11501#discussion_r432037627", "bodyText": "FeedResponseListValidator.exactlyContainsInAnyOrder uses resourceId internally for validation.\nnow on your side you are passing Id and on the other side it compares against resoruceId, I suspect the tests will fail. if you don't want to go with BridgeInternal approach for non-partitioned resources please use FeedResponseListValidator.containsExactlyIds and please make sure the tests after this change pass.", "author": "moderakh", "createdAt": "2020-05-28T18:29:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkzOTExOA=="}], "type": "inlineReview", "revised_code": {"commit": "111d538104ff64529d796b8b00f1a1723ff09711", "chunk": "diff --git a/sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/rx/UserQueryTest.java b/sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/rx/UserQueryTest.java\nindex afe36930f3..558534ea27 100644\n--- a/sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/rx/UserQueryTest.java\n+++ b/sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/rx/UserQueryTest.java\n\n@@ -86,7 +86,7 @@ public class UserQueryTest extends TestSuiteBase {\n \n         FeedResponseListValidator<CosmosUserProperties> validator = new FeedResponseListValidator.Builder<CosmosUserProperties>()\n                 .totalSize(expectedUsers.size())\n-                .exactlyContainsInAnyOrder(expectedUsers.stream().map(CosmosUserProperties::getId).collect(Collectors.toList()))\n+                .containsExactlyIds(expectedUsers.stream().map(CosmosUserProperties::getId).collect(Collectors.toList()))\n                 .numberOfPages(expectedPageSize)\n                 .pageSatisfy(0, new FeedResponseValidator.Builder<CosmosUserProperties>()\n                         .requestChargeGreaterThanOrEqualTo(1.0).build())\n"}}, {"oid": "111d538104ff64529d796b8b00f1a1723ff09711", "url": "https://github.com/Azure/azure-sdk-for-java/commit/111d538104ff64529d796b8b00f1a1723ff09711", "message": "Fix test validation; replace exactlyContainsInAnyOrder() call with containsExactlyIds().\nThe respective resoures are not partitioned resources (users, container scripts), and therefore we do not need to validate against the RID of them.", "committedDate": "2020-05-28T18:57:57Z", "type": "commit"}, {"oid": "cc282d6e1a72e0c9f2f9badc266eee1af14cdb9d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/cc282d6e1a72e0c9f2f9badc266eee1af14cdb9d", "message": "missed one refactoring for the test changes.", "committedDate": "2020-05-28T19:07:22Z", "type": "commit"}, {"oid": "10dfff4e5917000eb93dcab7f0c6b6c487ea6995", "url": "https://github.com/Azure/azure-sdk-for-java/commit/10dfff4e5917000eb93dcab7f0c6b6c487ea6995", "message": "Merge branch 'master' into milismsft-doc-updates2\n\n# Conflicts:\n#\tsdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/rx/UserDefinedFunctionCrudTest.java", "committedDate": "2020-05-28T20:32:11Z", "type": "commit"}, {"oid": "b33f2311c3d04d450b80c71213cf29c66fcece39", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b33f2311c3d04d450b80c71213cf29c66fcece39", "message": "Added new validator, exactlyContainsIdsInAnyOrder() and this to check results instead of exactlyContainsInAnyOrder() or containsExactlyIds() which also check the order of the IDs in addition to the exact content.", "committedDate": "2020-05-29T02:00:16Z", "type": "commit"}]}