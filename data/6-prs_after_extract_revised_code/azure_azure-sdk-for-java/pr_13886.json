{"pr_number": 13886, "pr_title": "Updated Autocomplete Tests to Share Index", "pr_createdAt": "2020-08-07T22:08:54Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/13886", "timeline": [{"oid": "638d18d19ee5b6710d44d46b1bc26c373391b06e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/638d18d19ee5b6710d44d46b1bc26c373391b06e", "message": "Updated autocomplete tests to share a single index instance as they are read only tests", "committedDate": "2020-08-07T21:42:54Z", "type": "commit"}, {"oid": "8f3a0a5c6592e98419e047ad26f32d03fb2702ab", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8f3a0a5c6592e98419e047ad26f32d03fb2702ab", "message": "Update session records", "committedDate": "2020-08-07T22:08:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzMxNzk5MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13886#discussion_r467317990", "bodyText": "Why can't we change the name directly in hotel json file but to modify here after serialization?\nThere are two other test classes which have the similar structure, SuggestSyncTests and SearchSyncTest.", "author": "sima-zhu", "createdAt": "2020-08-07T22:50:43Z", "path": "sdk/search/azure-search-documents/src/test/java/com/azure/search/documents/AutocompleteSyncTests.java", "diffHunk": "@@ -23,20 +41,59 @@\n \n public class AutocompleteSyncTests extends SearchTestBase {\n     private static final String HOTELS_DATA_JSON = \"HotelsDataArray.json\";\n+    private static final String INDEX_NAME = \"azsearch-autocomplete-shared-instance\";\n \n+    private static SearchIndexClient searchIndexClient;\n     private SearchClient client;\n \n-    @Override\n-    protected void beforeTest() {\n-        super.beforeTest();\n \n-        client = getSearchClientBuilder(createHotelIndex()).buildClient();\n-        uploadDocumentsJson(client, HOTELS_DATA_JSON);\n+\n+    @BeforeAll\n+    public static void setupClass() {\n+        TestBase.setupClass();\n+\n+        if (TEST_MODE == TestMode.PLAYBACK) {\n+            return;\n+        }\n+\n+        Reader indexData = new InputStreamReader(Objects.requireNonNull(AutocompleteSyncTests.class\n+            .getClassLoader()\n+            .getResourceAsStream(HOTELS_TESTS_INDEX_DATA_JSON)));\n+\n+        try {\n+            SearchIndex index = new ObjectMapper().readValue(indexData, SearchIndex.class);\n+\n+            Field searchIndexName = index.getClass().getDeclaredField(\"name\");\n+            AccessController.doPrivileged((PrivilegedAction<Object>) () -> {\n+                searchIndexName.setAccessible(true);\n+                return null;\n+            });\n+\n+            searchIndexName.set(index, INDEX_NAME);", "originalCommit": "8f3a0a5c6592e98419e047ad26f32d03fb2702ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzMzMjY0NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13886#discussion_r467332645", "bodyText": "Updated Search and Suggest test which are able to share an instance. The name is changed using reflection as many tests use this file so it won't be safe to make it a global name.", "author": "alzimmermsft", "createdAt": "2020-08-08T00:01:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzMxNzk5MA=="}], "type": "inlineReview", "revised_code": {"commit": "75608a280fb3f008114fcc179c7e5a23bd434cf6", "chunk": "diff --git a/sdk/search/azure-search-documents/src/test/java/com/azure/search/documents/AutocompleteSyncTests.java b/sdk/search/azure-search-documents/src/test/java/com/azure/search/documents/AutocompleteSyncTests.java\nindex be27e8a8ba2..721abfb60d5 100644\n--- a/sdk/search/azure-search-documents/src/test/java/com/azure/search/documents/AutocompleteSyncTests.java\n+++ b/sdk/search/azure-search-documents/src/test/java/com/azure/search/documents/AutocompleteSyncTests.java\n\n@@ -2,40 +2,27 @@\n // Licensed under the MIT License.\n package com.azure.search.documents;\n \n-import com.azure.core.credential.AzureKeyCredential;\n-import com.azure.core.http.policy.ExponentialBackoff;\n-import com.azure.core.http.policy.RetryPolicy;\n import com.azure.core.http.rest.PagedIterableBase;\n import com.azure.core.test.TestBase;\n import com.azure.core.test.TestMode;\n import com.azure.core.util.Context;\n import com.azure.search.documents.indexes.SearchIndexClient;\n-import com.azure.search.documents.indexes.SearchIndexClientBuilder;\n-import com.azure.search.documents.indexes.models.SearchIndex;\n import com.azure.search.documents.models.AutocompleteItem;\n import com.azure.search.documents.models.AutocompleteMode;\n import com.azure.search.documents.models.AutocompleteOptions;\n import com.azure.search.documents.util.AutocompletePagedResponse;\n-import com.fasterxml.jackson.databind.ObjectMapper;\n import org.junit.jupiter.api.AfterAll;\n import org.junit.jupiter.api.BeforeAll;\n import org.junit.jupiter.api.Test;\n \n-import java.io.InputStreamReader;\n-import java.io.Reader;\n-import java.lang.reflect.Field;\n import java.net.HttpURLConnection;\n-import java.security.AccessController;\n-import java.security.PrivilegedAction;\n-import java.time.Duration;\n import java.util.Arrays;\n import java.util.Collections;\n import java.util.Iterator;\n import java.util.List;\n-import java.util.Objects;\n \n import static com.azure.search.documents.TestHelpers.assertHttpResponseException;\n-import static com.azure.search.documents.TestHelpers.uploadDocumentsJson;\n+import static com.azure.search.documents.TestHelpers.setupSharedIndex;\n import static org.junit.jupiter.api.Assertions.assertEquals;\n import static org.junit.jupiter.api.Assertions.assertFalse;\n \n"}}, {"oid": "c7b31dab225b95116b6c356e659415fe41b0e396", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c7b31dab225b95116b6c356e659415fe41b0e396", "message": "Merge branch 'master' into AzSearch_AutocompleteTestsShareIndex", "committedDate": "2020-08-07T22:57:55Z", "type": "commit"}, {"oid": "75608a280fb3f008114fcc179c7e5a23bd434cf6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/75608a280fb3f008114fcc179c7e5a23bd434cf6", "message": "Updated Search and Suggest tests to use a shared index when possible", "committedDate": "2020-08-08T00:00:14Z", "type": "commit"}]}