{"pr_number": 14891, "pr_title": "mgmt support azure-resourcemanager-cdn", "pr_createdAt": "2020-09-08T05:24:28Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/14891", "timeline": [{"oid": "6a5b23ea72a662a7ee08aa0444d4da815989b002", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6a5b23ea72a662a7ee08aa0444d4da815989b002", "message": "copy cdn from azure-libraries-for-java", "committedDate": "2020-09-07T08:17:31Z", "type": "commit"}, {"oid": "bd9da5fba5154a3e05344ae5374537c8b6e7019b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/bd9da5fba5154a3e05344ae5374537c8b6e7019b", "message": "restructure cdn before generating code", "committedDate": "2020-09-07T08:29:07Z", "type": "commit"}, {"oid": "93c339e9ee18c702f45bc3113be0fccb8e68fb25", "url": "https://github.com/Azure/azure-sdk-for-java/commit/93c339e9ee18c702f45bc3113be0fccb8e68fb25", "message": "update versioning", "committedDate": "2020-09-07T08:29:36Z", "type": "commit"}, {"oid": "a49ebea04a8c4eee44e900cddab2b938c5126cab", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a49ebea04a8c4eee44e900cddab2b938c5126cab", "message": "update api-specs", "committedDate": "2020-09-07T08:30:19Z", "type": "commit"}, {"oid": "e8008330bb5fb9e0c711ce8cc562c4c99bf9a424", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e8008330bb5fb9e0c711ce8cc562c4c99bf9a424", "message": "generate cdn", "committedDate": "2020-09-07T08:33:27Z", "type": "commit"}, {"oid": "165d4b9c4338af8b41f38ddfbd6975d41f7d6b3e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/165d4b9c4338af8b41f38ddfbd6975d41f7d6b3e", "message": "manual change for naming conflict by generated code", "committedDate": "2020-09-08T05:14:49Z", "type": "commit"}, {"oid": "1e6d4027a23e44c07c2d6346adba2de81e353eac", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1e6d4027a23e44c07c2d6346adba2de81e353eac", "message": "fix compile errors", "committedDate": "2020-09-08T05:15:20Z", "type": "commit"}, {"oid": "eabb497cf1a90d14e5f8ebc3b7061239bbe2bbb6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/eabb497cf1a90d14e5f8ebc3b7061239bbe2bbb6", "message": "move client and builder into fluent package", "committedDate": "2020-09-08T05:24:10Z", "type": "commit"}, {"oid": "2b6507a465e18d541f14cb95c247b1e624c250dd", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2b6507a465e18d541f14cb95c247b1e624c250dd", "message": "add tests and samples for cdn", "committedDate": "2020-09-11T04:43:25Z", "type": "commit"}, {"oid": "d3529134b62bbaf14d83ae2ade9f596d7094bc27", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d3529134b62bbaf14d83ae2ade9f596d7094bc27", "message": "regenerate cdn after updating generator", "committedDate": "2020-09-11T04:48:57Z", "type": "commit"}, {"oid": "afec02ad4a3e90d49d5368c09d7d04df4a2fef1e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/afec02ad4a3e90d49d5368c09d7d04df4a2fef1e", "message": "manual fix", "committedDate": "2020-09-11T04:51:41Z", "type": "commit"}, {"oid": "fb13cf339477fc4c59da0fba040917dc666255f3", "url": "https://github.com/Azure/azure-sdk-for-java/commit/fb13cf339477fc4c59da0fba040917dc666255f3", "message": "Merge branch 'master' into add-mgmt-cdn", "committedDate": "2020-09-11T04:53:20Z", "type": "commit"}, {"oid": "2f9f365f2762fa2dfe04938d0c6b5ca9e2015a57", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2f9f365f2762fa2dfe04938d0c6b5ca9e2015a57", "message": "update test dependency", "committedDate": "2020-09-11T04:54:55Z", "type": "commit"}, {"oid": "c5651b512a315fbf9fea61fb5da3b302a16e5998", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c5651b512a315fbf9fea61fb5da3b302a16e5998", "message": "Merge branch 'master' into add-mgmt-cdn", "committedDate": "2020-09-15T03:25:11Z", "type": "commit"}, {"oid": "609479069ef07e170427e4b77218d32718bc3f76", "url": "https://github.com/Azure/azure-sdk-for-java/commit/609479069ef07e170427e4b77218d32718bc3f76", "message": "mgmt cdn add live only test and update ci.yml", "committedDate": "2020-09-15T07:26:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQ5NTg4NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14891#discussion_r488495884", "bodyText": "If no order needed, use Flux.mergeDelayError", "author": "ChenTanyi", "createdAt": "2020-09-15T08:48:12Z", "path": "sdk/resourcemanager/azure-resourcemanager-cdn/src/main/java/com/azure/resourcemanager/cdn/implementation/CdnEndpointImpl.java", "diffHunk": "@@ -134,25 +132,34 @@ public String id() {\n                 this.name(),\n                 endpointUpdateParameters);\n \n-        Mono<CustomDomainInner> customDomainTask = Flux.fromIterable(this.deletedCustomDomainList)\n+        Flux<CustomDomainInner> customDomainCreateTask = Flux.fromIterable(this.customDomainList)\n+            .flatMapDelayError(itemToCreate -> this.parent().manager().inner().getCustomDomains().createAsync(\n+                this.parent().resourceGroupName(),\n+                this.parent().name(),\n+                this.name(),\n+                self.parent().manager().sdkContext().randomResourceName(\"CustomDomain\", 50),\n+                itemToCreate.hostname()\n+            ), 32, 32);\n+\n+        Flux<CustomDomainInner> customDomainDeleteTask = Flux.fromIterable(this.deletedCustomDomainList)\n             .flatMapDelayError(itemToDelete -> this.parent().manager().inner().getCustomDomains().deleteAsync(\n                 this.parent().resourceGroupName(),\n                 this.parent().name(),\n                 this.name(),\n                 itemToDelete.name()\n-            ), 32, 32)\n-            .last();\n+            ), 32, 32);\n \n-        return Flux.zip(originUpdateTask, endpointUpdateTask, customDomainTask)\n-            .last()\n-            .map(objects -> {\n-                self.setInner(objects.getT2());\n+        Flux<CustomDomainInner> customDomainTask = Flux.concat(customDomainCreateTask, customDomainDeleteTask);", "originalCommit": "2b6507a465e18d541f14cb95c247b1e624c250dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4MTcwMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14891#discussion_r490781702", "bodyText": "The concern to have concat came from Azure/azure-libraries-for-net#891. For safe, I just concat the custom domain tasks. For tasks of different resources, we can use merge.", "author": "xseeseesee", "createdAt": "2020-09-18T08:19:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQ5NTg4NA=="}], "type": "inlineReview", "revised_code": {"commit": "95aaf0e4c7f5d60c1fc6e07d54ab8499db745448", "chunk": "diff --git a/sdk/resourcemanager/azure-resourcemanager-cdn/src/main/java/com/azure/resourcemanager/cdn/implementation/CdnEndpointImpl.java b/sdk/resourcemanager/azure-resourcemanager-cdn/src/main/java/com/azure/resourcemanager/cdn/implementation/CdnEndpointImpl.java\nindex 9b9b233a775..b401ab57a33 100644\n--- a/sdk/resourcemanager/azure-resourcemanager-cdn/src/main/java/com/azure/resourcemanager/cdn/implementation/CdnEndpointImpl.java\n+++ b/sdk/resourcemanager/azure-resourcemanager-cdn/src/main/java/com/azure/resourcemanager/cdn/implementation/CdnEndpointImpl.java\n\n@@ -119,12 +118,13 @@ class CdnEndpointImpl\n                 .withHttpPort(originInner.httpPort())\n                 .withHttpsPort(originInner.httpsPort());\n \n-        Mono<OriginInner> originUpdateTask = this.parent().manager().inner().getOrigins().updateAsync(\n+        Mono<EndpointInner> originUpdateTask = this.parent().manager().inner().getOrigins().updateAsync(\n                 this.parent().resourceGroupName(),\n                 this.parent().name(),\n                 this.name(),\n                 originInner.name(),\n-                originUpdateParameters);\n+                originUpdateParameters)\n+            .then(Mono.empty());\n \n         Mono<EndpointInner> endpointUpdateTask = this.parent().manager().inner().getEndpoints().updateAsync(\n                 this.parent().resourceGroupName(),\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQ5NjQ4Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14891#discussion_r488496482", "bodyText": "If no order needed, use Flux.mergeDelayError(customDomainTask.then(), originUpdateTask.then(), endpointUpdateTask), for parallel", "author": "ChenTanyi", "createdAt": "2020-09-15T08:49:09Z", "path": "sdk/resourcemanager/azure-resourcemanager-cdn/src/main/java/com/azure/resourcemanager/cdn/implementation/CdnEndpointImpl.java", "diffHunk": "@@ -134,25 +132,34 @@ public String id() {\n                 this.name(),\n                 endpointUpdateParameters);\n \n-        Mono<CustomDomainInner> customDomainTask = Flux.fromIterable(this.deletedCustomDomainList)\n+        Flux<CustomDomainInner> customDomainCreateTask = Flux.fromIterable(this.customDomainList)\n+            .flatMapDelayError(itemToCreate -> this.parent().manager().inner().getCustomDomains().createAsync(\n+                this.parent().resourceGroupName(),\n+                this.parent().name(),\n+                this.name(),\n+                self.parent().manager().sdkContext().randomResourceName(\"CustomDomain\", 50),\n+                itemToCreate.hostname()\n+            ), 32, 32);\n+\n+        Flux<CustomDomainInner> customDomainDeleteTask = Flux.fromIterable(this.deletedCustomDomainList)\n             .flatMapDelayError(itemToDelete -> this.parent().manager().inner().getCustomDomains().deleteAsync(\n                 this.parent().resourceGroupName(),\n                 this.parent().name(),\n                 this.name(),\n                 itemToDelete.name()\n-            ), 32, 32)\n-            .last();\n+            ), 32, 32);\n \n-        return Flux.zip(originUpdateTask, endpointUpdateTask, customDomainTask)\n-            .last()\n-            .map(objects -> {\n-                self.setInner(objects.getT2());\n+        Flux<CustomDomainInner> customDomainTask = Flux.concat(customDomainCreateTask, customDomainDeleteTask);\n+\n+        return customDomainTask.then(originUpdateTask).then(endpointUpdateTask)", "originalCommit": "2b6507a465e18d541f14cb95c247b1e624c250dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgxMTE3MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14891#discussion_r490811170", "bodyText": "Updated.", "author": "xseeseesee", "createdAt": "2020-09-18T09:11:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQ5NjQ4Mg=="}], "type": "inlineReview", "revised_code": {"commit": "95aaf0e4c7f5d60c1fc6e07d54ab8499db745448", "chunk": "diff --git a/sdk/resourcemanager/azure-resourcemanager-cdn/src/main/java/com/azure/resourcemanager/cdn/implementation/CdnEndpointImpl.java b/sdk/resourcemanager/azure-resourcemanager-cdn/src/main/java/com/azure/resourcemanager/cdn/implementation/CdnEndpointImpl.java\nindex 9b9b233a775..b401ab57a33 100644\n--- a/sdk/resourcemanager/azure-resourcemanager-cdn/src/main/java/com/azure/resourcemanager/cdn/implementation/CdnEndpointImpl.java\n+++ b/sdk/resourcemanager/azure-resourcemanager-cdn/src/main/java/com/azure/resourcemanager/cdn/implementation/CdnEndpointImpl.java\n\n@@ -119,12 +118,13 @@ class CdnEndpointImpl\n                 .withHttpPort(originInner.httpPort())\n                 .withHttpsPort(originInner.httpsPort());\n \n-        Mono<OriginInner> originUpdateTask = this.parent().manager().inner().getOrigins().updateAsync(\n+        Mono<EndpointInner> originUpdateTask = this.parent().manager().inner().getOrigins().updateAsync(\n                 this.parent().resourceGroupName(),\n                 this.parent().name(),\n                 this.name(),\n                 originInner.name(),\n-                originUpdateParameters);\n+                originUpdateParameters)\n+            .then(Mono.empty());\n \n         Mono<EndpointInner> endpointUpdateTask = this.parent().manager().inner().getEndpoints().updateAsync(\n                 this.parent().resourceGroupName(),\n"}}, {"oid": "95aaf0e4c7f5d60c1fc6e07d54ab8499db745448", "url": "https://github.com/Azure/azure-sdk-for-java/commit/95aaf0e4c7f5d60c1fc6e07d54ab8499db745448", "message": "update cdn endpoint updateResourceAsync", "committedDate": "2020-09-18T09:00:49Z", "type": "commit"}, {"oid": "30c0775d5ac862d934282a4439e42d9c9256553c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/30c0775d5ac862d934282a4439e42d9c9256553c", "message": "regenerate code", "committedDate": "2020-09-18T09:06:26Z", "type": "commit"}, {"oid": "3d502b80dbe27fe2621f0eb542c797375058b6e4", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3d502b80dbe27fe2621f0eb542c797375058b6e4", "message": "remove azure-resourcemanager-test", "committedDate": "2020-09-18T09:10:40Z", "type": "commit"}, {"oid": "700ee1230300a3c7416ab635355b2620f4b4e90a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/700ee1230300a3c7416ab635355b2620f4b4e90a", "message": "clear customDomainList after cdn endpoint update", "committedDate": "2020-09-18T09:23:28Z", "type": "commit"}]}