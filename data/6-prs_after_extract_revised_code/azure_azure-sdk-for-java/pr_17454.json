{"pr_number": 17454, "pr_title": "[Service Bus] Client validation improvements for cross-language consistency", "pr_createdAt": "2020-11-10T21:13:04Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/17454", "timeline": [{"oid": "ec8f66aeb23bfe1751703cc8e44edc5c3a5cc220", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ec8f66aeb23bfe1751703cc8e44edc5c3a5cc220", "message": "Adding in error message to explicitly check for a lock token and throw if it's null (catches people accidentally trying to complete peeked messages).", "committedDate": "2020-11-09T22:46:33Z", "type": "commit"}, {"oid": "cfe7dcbabb7957d4f5eb590e1510f3370a2719f6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/cfe7dcbabb7957d4f5eb590e1510f3370a2719f6", "message": "* Throw if the user passes in a null sequence of messages when calling receiveDeferredMessages().\n* Return an empty Flux if the user passes an empty list of deferred messages.", "committedDate": "2020-11-10T00:17:41Z", "type": "commit"}, {"oid": "897069857ba0688216986e035b27c2681cb4a807", "url": "https://github.com/Azure/azure-sdk-for-java/commit/897069857ba0688216986e035b27c2681cb4a807", "message": "* Check the length of the session ID, partitionKey, and message ID to make sure they don't exceed 128 characters (when they do it causes general validation on the service bus side to fail and it's not helpful to pinpoint _why_)", "committedDate": "2020-11-10T01:21:46Z", "type": "commit"}, {"oid": "1710154ea37719abe8a62e42d9df8b750bab2771", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1710154ea37719abe8a62e42d9df8b750bab2771", "message": "* Add in checks if the user accidentally tries to set different values for session ID and partition key.", "committedDate": "2020-11-10T01:41:38Z", "type": "commit"}, {"oid": "5bcb0e31443492b0c400d73633ed554e8570c404", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5bcb0e31443492b0c400d73633ed554e8570c404", "message": "Make the message consistent with .net", "committedDate": "2020-11-10T01:52:03Z", "type": "commit"}, {"oid": "709bbbb9297a38ca4c75ed3a5c8b47fe11b5665d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/709bbbb9297a38ca4c75ed3a5c8b47fe11b5665d", "message": "* Adding in tests for ServiceBusMessage checks\n* (Fixing a few stray comments that said \"Act\" when they probably meant \"Arrange\")", "committedDate": "2020-11-10T19:12:32Z", "type": "commit"}, {"oid": "dbbe8cee77039c2d5a3de348c228fef63d3d690b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/dbbe8cee77039c2d5a3de348c228fef63d3d690b", "message": "* Adding tests to validate changes to getDeferredMessages()", "committedDate": "2020-11-10T19:46:41Z", "type": "commit"}, {"oid": "a19c91e135488f5b4e7b8318acb38fbc27ec4e89", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a19c91e135488f5b4e7b8318acb38fbc27ec4e89", "message": "* Fixing problem where I was throwing the exception directly rather than returning it through the Flux.\n* Adding in test to make sure we throw a reasonable error when the user tries to complete a peeked message.", "committedDate": "2020-11-10T21:07:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg4NTY5Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17454#discussion_r520885692", "bodyText": "Since you are adding validation, I would add a @throws to say what runtime exceptions are thrown.", "author": "conniey", "createdAt": "2020-11-10T21:29:56Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusMessage.java", "diffHunk": "@@ -267,6 +271,7 @@ public String getMessageId() {\n      * @return The updated {@link ServiceBusMessage}.\n      */", "originalCommit": "a19c91e135488f5b4e7b8318acb38fbc27ec4e89", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk0NDg4Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17454#discussion_r520944887", "bodyText": "Added.", "author": "richardpark-msft", "createdAt": "2020-11-10T23:42:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg4NTY5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "7a21748afd6bcf3b0fe4acdf309739cc431146b1", "chunk": "diff --git a/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusMessage.java b/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusMessage.java\nindex 61f80a40231..77b55229773 100644\n--- a/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusMessage.java\n+++ b/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusMessage.java\n\n@@ -269,6 +269,7 @@ public class ServiceBusMessage {\n      * @param messageId to be set.\n      *\n      * @return The updated {@link ServiceBusMessage}.\n+     * @throws IllegalArgumentException if {@code messageId} is too long.\n      */\n     public ServiceBusMessage setMessageId(String messageId) {\n         checkIdLength(\"messageId\", messageId, MAX_MESSAGE_ID_LENGTH);\n"}}, {"oid": "7a21748afd6bcf3b0fe4acdf309739cc431146b1", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7a21748afd6bcf3b0fe4acdf309739cc431146b1", "message": "* Adding in @throws clauses per Connie's feedback\n* Fixing a long line", "committedDate": "2020-11-10T22:31:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkxMzE5MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17454#discussion_r520913190", "bodyText": "We can add this in java doc for all the settlement operation (for ex complete, abandon.. etc ) in the client\n@throws UnsupportedOperationException section.", "author": "hemanttanwar", "createdAt": "2020-11-10T22:25:10Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClient.java", "diffHunk": "@@ -987,6 +986,11 @@ private boolean isManagementToken(String lockToken) {\n         } else if (message.isSettled()) {\n             return Mono.error(logger.logExceptionAsError(\n                 new IllegalArgumentException(\"The message has either been deleted or already settled.\")));\n+        } else if (message.getLockToken() == null) {\n+            // message must be a peeked message (or somehow they created a message w/o a lock token)\n+            return Mono.error(\n+                logger.logExceptionAsError(new UnsupportedOperationException(\"This operation is not supported for peeked messages. Only messages received using receiveMessages() or receiveMessagesWithContext() in PEEK_LOCK mode can be settled.\"))", "originalCommit": "a19c91e135488f5b4e7b8318acb38fbc27ec4e89", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk0NDgxMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17454#discussion_r520944813", "bodyText": "Added.", "author": "richardpark-msft", "createdAt": "2020-11-10T23:42:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkxMzE5MA=="}], "type": "inlineReview", "revised_code": {"commit": "b635395a29ba844f80bb488dee1f9ced9c3d5499", "chunk": "diff --git a/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClient.java b/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClient.java\nindex 3cb5cc8dce9..aed8e19765c 100644\n--- a/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClient.java\n+++ b/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClient.java\n\n@@ -988,8 +989,11 @@ public final class ServiceBusReceiverAsyncClient implements AutoCloseable {\n                 new IllegalArgumentException(\"The message has either been deleted or already settled.\")));\n         } else if (message.getLockToken() == null) {\n             // message must be a peeked message (or somehow they created a message w/o a lock token)\n+            final String errorMessage = \"This operation is not supported for peeked messages. \" +\n+                \"Only messages received using receiveMessages() or receiveMessagesWithContext() \" +\n+                \"in PEEK_LOCK mode can be settled.\";\n             return Mono.error(\n-                logger.logExceptionAsError(new UnsupportedOperationException(\"This operation is not supported for peeked messages. Only messages received using receiveMessages() or receiveMessagesWithContext() in PEEK_LOCK mode can be settled.\"))\n+                logger.logExceptionAsError(new UnsupportedOperationException(errorMessage))\n             );\n         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkxNzgxNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17454#discussion_r520917814", "bodyText": "We might want to put in receiveDeferredMessages API  (which take in Iterable<Long> sequenceNumbers  ) in sync and async client that empty list will complete the flux without sending to service bus .", "author": "hemanttanwar", "createdAt": "2020-11-10T22:35:27Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/ManagementChannel.java", "diffHunk": "@@ -189,7 +189,17 @@\n      */\n     @Override\n     public Flux<ServiceBusReceivedMessage> receiveDeferredMessages(ReceiveMode receiveMode, String sessionId,\n-        String associatedLinkName, Iterable<Long> sequenceNumbers) {\n+                                                                   String associatedLinkName, Iterable<Long> sequenceNumbers) {\n+        if (sequenceNumbers == null) {\n+            return fluxError(logger, new NullPointerException(\"'sequenceNumbers' cannot be null\"));\n+        }\n+\n+        final List<Long> numbers = new ArrayList<>();\n+        sequenceNumbers.forEach(s -> numbers.add(s));\n+\n+        if (numbers.isEmpty()) {\n+            return Flux.empty();", "originalCommit": "a19c91e135488f5b4e7b8318acb38fbc27ec4e89", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk0MTMxNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17454#discussion_r520941314", "bodyText": "Thinking about this a bit more - are we sure that's something that needs documenting? We're no longer treating it as an error condition so this just seems to fall under normal operating conditions.", "author": "richardpark-msft", "createdAt": "2020-11-10T23:33:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkxNzgxNA=="}], "type": "inlineReview", "revised_code": {"commit": "04c18e2e36cc48758b73fe1498434b6c11b00a9f", "chunk": "diff --git a/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/ManagementChannel.java b/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/ManagementChannel.java\nindex ef055e38715..2b7f55eb4e9 100644\n--- a/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/ManagementChannel.java\n+++ b/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/ManagementChannel.java\n\n@@ -188,8 +188,10 @@ public class ManagementChannel implements ServiceBusManagementNode {\n      * {@inheritDoc}\n      */\n     @Override\n-    public Flux<ServiceBusReceivedMessage> receiveDeferredMessages(ReceiveMode receiveMode, String sessionId,\n-                                                                   String associatedLinkName, Iterable<Long> sequenceNumbers) {\n+    public Flux<ServiceBusReceivedMessage> receiveDeferredMessages(ReceiveMode receiveMode,\n+                                                                   String sessionId,\n+                                                                   String associatedLinkName,\n+                                                                   Iterable<Long> sequenceNumbers) {\n         if (sequenceNumbers == null) {\n             return fluxError(logger, new NullPointerException(\"'sequenceNumbers' cannot be null\"));\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkxODc1Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17454#discussion_r520918752", "bodyText": "This is done by intellij for you, without you knowing . This should have 4 spaces before  int .  I see few more places like this.", "author": "hemanttanwar", "createdAt": "2020-11-10T22:37:30Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/ManagementChannel.java", "diffHunk": "@@ -291,7 +298,7 @@\n      */\n     @Override\n     public Flux<Long> schedule(List<ServiceBusMessage> messages, OffsetDateTime scheduledEnqueueTime,\n-        int maxLinkSize, String associatedLinkName, ServiceBusTransactionContext transactionContext) {\n+                               int maxLinkSize, String associatedLinkName, ServiceBusTransactionContext transactionContext) {", "originalCommit": "a19c91e135488f5b4e7b8318acb38fbc27ec4e89", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkzNTcxMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17454#discussion_r520935712", "bodyText": "Gah, will fix :|", "author": "richardpark-msft", "createdAt": "2020-11-10T23:18:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkxODc1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk0NDc0Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17454#discussion_r520944746", "bodyText": "Fixed.", "author": "richardpark-msft", "createdAt": "2020-11-10T23:42:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkxODc1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "c85d5b253bbbe7a87d8a22c751fded58ffe9ebcc", "chunk": "diff --git a/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/ManagementChannel.java b/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/ManagementChannel.java\nindex ef055e38715..fbbeb8fa073 100644\n--- a/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/ManagementChannel.java\n+++ b/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/ManagementChannel.java\n\n@@ -298,7 +298,7 @@ public class ManagementChannel implements ServiceBusManagementNode {\n      */\n     @Override\n     public Flux<Long> schedule(List<ServiceBusMessage> messages, OffsetDateTime scheduledEnqueueTime,\n-                               int maxLinkSize, String associatedLinkName, ServiceBusTransactionContext transactionContext) {\n+        int maxLinkSize, String associatedLinkName, ServiceBusTransactionContext transactionContext) {\n \n         return isAuthorized(OPERATION_SCHEDULE_MESSAGE).thenMany(createChannel.flatMap(channel -> {\n \n"}}, {"oid": "04c18e2e36cc48758b73fe1498434b6c11b00a9f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/04c18e2e36cc48758b73fe1498434b6c11b00a9f", "message": "Fixing some more style issues.", "committedDate": "2020-11-10T22:43:32Z", "type": "commit"}, {"oid": "b635395a29ba844f80bb488dee1f9ced9c3d5499", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b635395a29ba844f80bb488dee1f9ced9c3d5499", "message": "Fixing some more line length issues", "committedDate": "2020-11-10T22:50:25Z", "type": "commit"}, {"oid": "bc339d5bb4f078bf4e12e6950fdd3550cc8bd384", "url": "https://github.com/Azure/azure-sdk-for-java/commit/bc339d5bb4f078bf4e12e6950fdd3550cc8bd384", "message": "Fixing long lines", "committedDate": "2020-11-10T23:03:21Z", "type": "commit"}, {"oid": "28cb72b1555196ee6f1fcd466f52edf8e86e90f2", "url": "https://github.com/Azure/azure-sdk-for-java/commit/28cb72b1555196ee6f1fcd466f52edf8e86e90f2", "message": "Fixing imports that I inadvertantly collapsed in IntelliJ", "committedDate": "2020-11-10T23:11:04Z", "type": "commit"}, {"oid": "c85d5b253bbbe7a87d8a22c751fded58ffe9ebcc", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c85d5b253bbbe7a87d8a22c751fded58ffe9ebcc", "message": "Undoing some of my inadvertant formatting changes", "committedDate": "2020-11-10T23:16:23Z", "type": "commit"}, {"oid": "3195b7530316cf01fb8b2868cea71994a9316f5f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3195b7530316cf01fb8b2868cea71994a9316f5f", "message": "Updating @throws doc comments to include they can also throw if the message itself was received from peekMessage.", "committedDate": "2020-11-10T23:32:02Z", "type": "commit"}, {"oid": "97c5613e8f9679efe56640da0a4d19b0aff78ca4", "url": "https://github.com/Azure/azure-sdk-for-java/commit/97c5613e8f9679efe56640da0a4d19b0aff78ca4", "message": "Thou shalt not use 'var'!", "committedDate": "2020-11-10T23:35:11Z", "type": "commit"}, {"oid": "c02d996d7f3b7d85c040a7861442068599d35a5b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c02d996d7f3b7d85c040a7861442068599d35a5b", "message": "Fixing a missing import from when I tried to revert formatting changes.", "committedDate": "2020-11-10T23:40:54Z", "type": "commit"}, {"oid": "0944f11021110a3c1c2e039bd9df60aabd2124f7", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0944f11021110a3c1c2e039bd9df60aabd2124f7", "message": "Whoops, did not mean to strip out the type there.", "committedDate": "2020-11-10T23:47:42Z", "type": "commit"}, {"oid": "964fcbb009812fb7c061783326e373d972ca16a9", "url": "https://github.com/Azure/azure-sdk-for-java/commit/964fcbb009812fb7c061783326e373d972ca16a9", "message": "cancelScheduledMessages should also no-op with an empty array parameter.", "committedDate": "2020-11-11T01:32:22Z", "type": "commit"}]}