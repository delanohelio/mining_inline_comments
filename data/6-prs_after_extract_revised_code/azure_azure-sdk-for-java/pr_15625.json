{"pr_number": 15625, "pr_title": "Added support to set BlobParallelUploadOptions.computeMd5 so the service can perform an md5 verification.", "pr_createdAt": "2020-09-24T19:24:16Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/15625", "timeline": [{"oid": "91c9deae0366822a9aaf411efc411c32d5056517", "url": "https://github.com/Azure/azure-sdk-for-java/commit/91c9deae0366822a9aaf411efc411c32d5056517", "message": "Added tests for buffered upload compute md5. Need to add tests for encrypted client", "committedDate": "2020-09-24T17:48:43Z", "type": "commit"}, {"oid": "44e82bdd5e37a6bfe154ad2100e28b25bf37ffaa", "url": "https://github.com/Azure/azure-sdk-for-java/commit/44e82bdd5e37a6bfe154ad2100e28b25bf37ffaa", "message": "Added tests to cryptography", "committedDate": "2020-09-24T19:20:19Z", "type": "commit"}, {"oid": "2ddb6d4ddeb931582dbc636273dd3282413b9584", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2ddb6d4ddeb931582dbc636273dd3282413b9584", "message": "Merge branch 'master' into storage/calculatemd5", "committedDate": "2020-09-24T19:22:14Z", "type": "commit"}, {"oid": "5dcaa857a37c18bd30d2bf0609e2e87a6d8910fa", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5dcaa857a37c18bd30d2bf0609e2e87a6d8910fa", "message": "Added common changelog", "committedDate": "2020-09-24T19:26:15Z", "type": "commit"}, {"oid": "73c8a6c48530eca0336fd32a55471f200c41dc07", "url": "https://github.com/Azure/azure-sdk-for-java/commit/73c8a6c48530eca0336fd32a55471f200c41dc07", "message": "indents", "committedDate": "2020-09-24T19:59:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYyNTI5NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15625#discussion_r494625295", "bodyText": "This is the only part of the code that I'm iffy about. Like wrapping the ProgressReporter and stuff looks a little unclean. I could just make a method maybe and make it look a little better.", "author": "gapra-msft", "createdAt": "2020-09-24T21:37:26Z", "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/BlobAsyncClient.java", "diffHunk": "@@ -429,14 +429,16 @@ private SpecializedBlobClientBuilder prepareBuilder() {\n             Function<Flux<ByteBuffer>, Mono<Response<BlockBlobItem>>> uploadInChunksFunction = (stream) ->\n                 uploadInChunks(blockBlobAsyncClient, stream, validatedParallelTransferOptions,\n                     options.getHeaders(), options.getMetadata(), options.getTags(),\n-                    options.getTier(), validatedRequestConditions);\n+                    options.getTier(), validatedRequestConditions, options.isComputeMd5());\n \n             BiFunction<Flux<ByteBuffer>, Long, Mono<Response<BlockBlobItem>>> uploadFullBlobMethod =\n-                (stream, length) -> blockBlobAsyncClient.uploadWithResponse(new BlockBlobSimpleUploadOptions(\n-                    ProgressReporter.addProgressReporting(stream,\n-                        validatedParallelTransferOptions.getProgressReceiver()), length)\n+                (stream, length) -> UploadUtils.computeMd5(ProgressReporter.addProgressReporting(stream,", "originalCommit": "73c8a6c48530eca0336fd32a55471f200c41dc07", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8d900dec3e1756e0e34865ff1705db20da22699b", "chunk": "diff --git a/sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/BlobAsyncClient.java b/sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/BlobAsyncClient.java\nindex db85dbbbcee..96bb8bbd546 100644\n--- a/sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/BlobAsyncClient.java\n+++ b/sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/BlobAsyncClient.java\n\n@@ -419,39 +419,57 @@ public class BlobAsyncClient extends BlobAsyncClientBase {\n         try {\n             StorageImplUtils.assertNotNull(\"options\", options);\n \n-            BlobRequestConditions validatedRequestConditions = options.getRequestConditions() == null\n-                ? new BlobRequestConditions() : options.getRequestConditions();\n-            final ParallelTransferOptions validatedParallelTransferOptions =\n+            final ParallelTransferOptions parallelTransferOptions =\n                 ModelHelper.populateAndApplyDefaults(options.getParallelTransferOptions());\n+            final BlobHttpHeaders headers = options.getHeaders();\n+            final Map<String, String> metadata = options.getMetadata();\n+            final Map<String, String> tags = options.getTags();\n+            final AccessTier tier = options.getTier();\n+            final BlobRequestConditions requestConditions = options.getRequestConditions() == null\n+                ? new BlobRequestConditions() : options.getRequestConditions();\n+            final boolean computeMd5 = options.isComputeMd5();\n \n             BlockBlobAsyncClient blockBlobAsyncClient = getBlockBlobAsyncClient();\n \n             Function<Flux<ByteBuffer>, Mono<Response<BlockBlobItem>>> uploadInChunksFunction = (stream) ->\n-                uploadInChunks(blockBlobAsyncClient, stream, validatedParallelTransferOptions,\n-                    options.getHeaders(), options.getMetadata(), options.getTags(),\n-                    options.getTier(), validatedRequestConditions, options.isComputeMd5());\n-\n-            BiFunction<Flux<ByteBuffer>, Long, Mono<Response<BlockBlobItem>>> uploadFullBlobMethod =\n-                (stream, length) -> UploadUtils.computeMd5(ProgressReporter.addProgressReporting(stream,\n-                    validatedParallelTransferOptions.getProgressReceiver()), options.isComputeMd5(), logger)\n-                    .flatMap(fluxMd5Wrapper -> blockBlobAsyncClient.uploadWithResponse(new BlockBlobSimpleUploadOptions(\n-                    fluxMd5Wrapper.getData(), length)\n-                    .setHeaders(options.getHeaders()).setMetadata(options.getMetadata()).setTags(options.getTags())\n-                    .setTier(options.getTier()).setRequestConditions(options.getRequestConditions())\n-                        .setContentMd5(fluxMd5Wrapper.getMd5())));\n+                uploadInChunks(blockBlobAsyncClient, stream, parallelTransferOptions, headers, metadata, tags,\n+                    tier, requestConditions, computeMd5);\n+\n+            BiFunction<Flux<ByteBuffer>, Long, Mono<Response<BlockBlobItem>>> uploadFullBlobFunction =\n+                (stream, length) -> uploadFullBlob(blockBlobAsyncClient, stream, length, parallelTransferOptions,\n+                    headers, metadata, tags, tier, requestConditions, computeMd5);\n \n             Flux<ByteBuffer> data = options.getDataFlux() == null ? Utility.convertStreamToByteBuffer(\n                 options.getDataStream(), options.getLength(),\n                 // We can only buffer up to max int due to restrictions in ByteBuffer.\n-                (int) Math.min(Integer.MAX_VALUE, validatedParallelTransferOptions.getBlockSizeLong()))\n+                (int) Math.min(Integer.MAX_VALUE, parallelTransferOptions.getBlockSizeLong()))\n                 : options.getDataFlux();\n-            return UploadUtils.uploadFullOrChunked(data, ModelHelper.wrapBlobOptions(validatedParallelTransferOptions),\n-                uploadInChunksFunction, uploadFullBlobMethod);\n+            return UploadUtils.uploadFullOrChunked(data, ModelHelper.wrapBlobOptions(parallelTransferOptions),\n+                uploadInChunksFunction, uploadFullBlobFunction);\n         } catch (RuntimeException ex) {\n             return monoError(logger, ex);\n         }\n     }\n \n+    private Mono<Response<BlockBlobItem>> uploadFullBlob(BlockBlobAsyncClient blockBlobAsyncClient,\n+        Flux<ByteBuffer> data, long length, ParallelTransferOptions parallelTransferOptions, BlobHttpHeaders headers,\n+        Map<String, String> metadata, Map<String, String> tags, AccessTier tier,\n+        BlobRequestConditions requestConditions, boolean computeMd5) {\n+        // Report progress as necessary.\n+        Flux<ByteBuffer> progressData = ProgressReporter.addProgressReporting(data,\n+            parallelTransferOptions.getProgressReceiver());\n+\n+        return UploadUtils.computeMd5(progressData, computeMd5, logger)\n+            .map(fluxMd5Wrapper -> new BlockBlobSimpleUploadOptions(fluxMd5Wrapper.getData(), length)\n+                .setHeaders(headers)\n+                .setMetadata(metadata)\n+                .setTags(tags)\n+                .setTier(tier)\n+                .setRequestConditions(requestConditions)\n+                .setContentMd5(fluxMd5Wrapper.getMd5()))\n+            .flatMap(blockBlobAsyncClient::uploadWithResponse);\n+    }\n+\n     private Mono<Response<BlockBlobItem>> uploadInChunks(BlockBlobAsyncClient blockBlobAsyncClient,\n         Flux<ByteBuffer> data, ParallelTransferOptions parallelTransferOptions, BlobHttpHeaders headers,\n         Map<String, String> metadata, Map<String, String> tags, AccessTier tier,\n"}}, {"oid": "8d900dec3e1756e0e34865ff1705db20da22699b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8d900dec3e1756e0e34865ff1705db20da22699b", "message": "Added method for uploadFullBlob", "committedDate": "2020-09-24T22:59:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY1NzcwOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15625#discussion_r494657708", "bodyText": "Rename to computeMd5", "author": "gapra-msft", "createdAt": "2020-09-24T23:06:00Z", "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/options/BlobParallelUploadOptions.java", "diffHunk": "@@ -214,6 +215,25 @@ public BlobParallelUploadOptions setRequestConditions(BlobRequestConditions requ\n         return this;\n     }\n \n+    /**\n+     * @return Whether or not the library should calculate the md5 and send it for the service to verify.\n+     */\n+    public boolean isComputeMd5() {\n+        return computeMd5;\n+    }\n+\n+    /**\n+     * Sets the calculateAndVerifyMd5 property.", "originalCommit": "8d900dec3e1756e0e34865ff1705db20da22699b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2a549baa45dc9acaec88bc548bf464d8387beddf", "chunk": "diff --git a/sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/options/BlobParallelUploadOptions.java b/sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/options/BlobParallelUploadOptions.java\nindex 95d24cff0dd..19d37d72a89 100644\n--- a/sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/options/BlobParallelUploadOptions.java\n+++ b/sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/options/BlobParallelUploadOptions.java\n\n@@ -223,7 +223,7 @@ public class BlobParallelUploadOptions {\n     }\n \n     /**\n-     * Sets the calculateAndVerifyMd5 property.\n+     * Sets the computeMd5 property.\n      *\n      * @param computeMd5 Whether or not the library should calculate the md5 and send it for the service to\n      * verify.\n"}}, {"oid": "2a549baa45dc9acaec88bc548bf464d8387beddf", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2a549baa45dc9acaec88bc548bf464d8387beddf", "message": "Added comments", "committedDate": "2020-09-25T18:39:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA5MzA0Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15625#discussion_r496093042", "bodyText": "CoreUtils.clone should handle this.", "author": "alzimmermsft", "createdAt": "2020-09-28T16:48:39Z", "path": "sdk/storage/azure-storage-common/src/main/java/com/azure/storage/common/implementation/UploadUtils.java", "diffHunk": "@@ -142,4 +147,48 @@ public static void uploadFileCleanup(AsynchronousFileChannel channel, ClientLogg\n             throw logger.logExceptionAsError(new UncheckedIOException(e));\n         }\n     }\n+\n+    /**\n+     * Computes the md5 of the data and wraps it with the data.\n+     *\n+     * @param data The data.\n+     * @param computeMd5 Whether or not to compute the md5.\n+     * @param logger Logger to log errors.\n+     * @return The data wrapped with its md5.\n+     */\n+    public static Mono<FluxMd5Wrapper> computeMd5(Flux<ByteBuffer> data, boolean computeMd5, ClientLogger logger) {\n+        if (computeMd5) {\n+            try {\n+                return data.reduce(MessageDigest.getInstance(\"MD5\"), (digest, buffer) -> {\n+                    int position = buffer.position();\n+                    byte[] bytes = FluxUtil.byteBufferToArray(buffer);\n+                    digest.update(bytes, 0, bytes.length);\n+                    buffer.position(position);\n+                    return digest;\n+                }).map(messageDigest -> new FluxMd5Wrapper(data, messageDigest.digest()));\n+            } catch (NoSuchAlgorithmException e) {\n+                return monoError(logger, new RuntimeException(e));\n+            }\n+        } else {\n+            return Mono.just(new FluxMd5Wrapper(data, null));\n+        }\n+    }\n+\n+    public static class FluxMd5Wrapper {\n+        private final Flux<ByteBuffer> data;\n+        private final byte[] md5;\n+\n+        FluxMd5Wrapper(Flux<ByteBuffer> data, byte[] md5) {\n+            this.data = data;\n+            this.md5 = md5 == null ? null : md5.clone();", "originalCommit": "2a549baa45dc9acaec88bc548bf464d8387beddf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA5NzAxMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15625#discussion_r496097010", "bodyText": "fixed.", "author": "gapra-msft", "createdAt": "2020-09-28T16:55:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA5MzA0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "9adf3122074e80de6fd59eefe41342c96dac6cc4", "chunk": "diff --git a/sdk/storage/azure-storage-common/src/main/java/com/azure/storage/common/implementation/UploadUtils.java b/sdk/storage/azure-storage-common/src/main/java/com/azure/storage/common/implementation/UploadUtils.java\nindex aec93cb0b59..f7bd085bacb 100644\n--- a/sdk/storage/azure-storage-common/src/main/java/com/azure/storage/common/implementation/UploadUtils.java\n+++ b/sdk/storage/azure-storage-common/src/main/java/com/azure/storage/common/implementation/UploadUtils.java\n\n@@ -180,7 +181,7 @@ public class UploadUtils {\n \n         FluxMd5Wrapper(Flux<ByteBuffer> data, byte[] md5) {\n             this.data = data;\n-            this.md5 = md5 == null ? null : md5.clone();\n+            this.md5 = CoreUtils.clone(md5);\n         }\n \n         public Flux<ByteBuffer> getData() {\n"}}, {"oid": "9adf3122074e80de6fd59eefe41342c96dac6cc4", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9adf3122074e80de6fd59eefe41342c96dac6cc4", "message": "Fixed minor comment", "committedDate": "2020-09-28T16:55:10Z", "type": "commit"}, {"oid": "d76cd656cc0322b2683a6e20a10597238cc569ab", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d76cd656cc0322b2683a6e20a10597238cc569ab", "message": "Merge branch 'master' into storage/calculatemd5", "committedDate": "2020-09-28T17:10:41Z", "type": "commit"}]}