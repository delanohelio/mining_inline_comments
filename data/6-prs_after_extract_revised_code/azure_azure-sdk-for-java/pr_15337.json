{"pr_number": 15337, "pr_title": "Stop onErrorDropped events from leaking into default Reactor Hook", "pr_createdAt": "2020-09-17T19:39:25Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/15337", "timeline": [{"oid": "2363921078f6a50c461ccacd3a810a95e7c886c9", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2363921078f6a50c461ccacd3a810a95e7c886c9", "message": "Stop onErrorDropped events from leaking into default Reactor Hook\n\nThere is a race condition between cancellation (via Reactor timeout) and completing the request in the Rntbd stack (via error/request timeout or successfully) which right now results in onErrorDropped events being raised to the default Reactor Hook. This results in ERROR level logging - functionally it is harmless (we do proper clean-up and functionally it is expected that the cancellation takes precedence and we ignore any subsequent success/transport exception). To avoid confusing customers I have injected a local hook now that will just log these errors with a DEBUG level - hopefully that will reduce the noise level for customers and stop causing confusion.", "committedDate": "2020-09-17T19:38:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUyMDY5OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15337#discussion_r490520698", "bodyText": "should this be <= ?", "author": "xinlian12", "createdAt": "2020-09-17T19:48:25Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdClientChannelPool.java", "diffHunk": "@@ -1470,33 +1470,27 @@ public final void run() {\n             long currentNanoTime = System.nanoTime();\n \n             while (true) {\n-                try {\n-                    AcquireListener removedTask = this.pool.pendingAcquisitions.poll();\n-                    if (removedTask == null) {\n-                        // queue is empty\n-                        break;\n-                    }\n+                AcquireListener removedTask = this.pool.pendingAcquisitions.poll();\n+                if (removedTask == null) {\n+                    // queue is empty\n+                    break;\n+                }\n \n-                    long expiryTime = removedTask.getAcquisitionTimeoutInNanos();\n+                long expiryTime = removedTask.getAcquisitionTimeoutInNanos();\n \n-                    // Compare nanoTime as described in the System.nanoTime documentation\n-                    // See:\n-                    // * https://docs.oracle.com/javase/7/docs/api/java/lang/System.html#nanoTime()\n-                    // * https://github.com/netty/netty/issues/3705\n-                    if (expiryTime - currentNanoTime < 0) {\n-                        this.onTimeout(removedTask);\n-                    } else {\n-                        if (!this.pool.pendingAcquisitions.offer(removedTask)) {\n-                            logger.error(\"Unexpected failure when returning the removed task\"\n-                                    + \" to pending acquisition queue. current size [{}]\",\n-                                this.pool.pendingAcquisitions.size());\n-                        }\n-                        break;\n+                // Compare nanoTime as described in the System.nanoTime documentation\n+                // See:\n+                // * https://docs.oracle.com/javase/7/docs/api/java/lang/System.html#nanoTime()\n+                // * https://github.com/netty/netty/issues/3705\n+                if (expiryTime - currentNanoTime < 0) {", "originalCommit": "2363921078f6a50c461ccacd3a810a95e7c886c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU0MDcxNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15337#discussion_r490540716", "bodyText": "Fixed", "author": "FabianMeiswinkel", "createdAt": "2020-09-17T20:25:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUyMDY5OA=="}], "type": "inlineReview", "revised_code": {"commit": "b1bbe24701d5e39c744512fa735fce7f6f8f2653", "chunk": "diff --git a/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdClientChannelPool.java b/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdClientChannelPool.java\nindex 000f98aa74a..4bde1d0c79d 100644\n--- a/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdClientChannelPool.java\n+++ b/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdClientChannelPool.java\n\n@@ -1482,7 +1482,7 @@ public final class RntbdClientChannelPool implements ChannelPool {\n                 // See:\n                 // * https://docs.oracle.com/javase/7/docs/api/java/lang/System.html#nanoTime()\n                 // * https://github.com/netty/netty/issues/3705\n-                if (expiryTime - currentNanoTime < 0) {\n+                if (expiryTime - currentNanoTime <= 0) {\n                     this.onTimeout(removedTask);\n                 } else {\n                     if (!this.pool.pendingAcquisitions.offer(removedTask)) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUyMzA4Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15337#discussion_r490523086", "bodyText": "I think my biggest question is: if we can not offer this task back, what would happen for this task? we did not fail it or retry, so any possibility it will stuck somewhere?\nPriorityBlockingQueue will never return false for the offer method, then I guess it should be fine here?", "author": "xinlian12", "createdAt": "2020-09-17T19:52:17Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdClientChannelPool.java", "diffHunk": "@@ -1470,33 +1470,27 @@ public final void run() {\n             long currentNanoTime = System.nanoTime();\n \n             while (true) {\n-                try {\n-                    AcquireListener removedTask = this.pool.pendingAcquisitions.poll();\n-                    if (removedTask == null) {\n-                        // queue is empty\n-                        break;\n-                    }\n+                AcquireListener removedTask = this.pool.pendingAcquisitions.poll();\n+                if (removedTask == null) {\n+                    // queue is empty\n+                    break;\n+                }\n \n-                    long expiryTime = removedTask.getAcquisitionTimeoutInNanos();\n+                long expiryTime = removedTask.getAcquisitionTimeoutInNanos();\n \n-                    // Compare nanoTime as described in the System.nanoTime documentation\n-                    // See:\n-                    // * https://docs.oracle.com/javase/7/docs/api/java/lang/System.html#nanoTime()\n-                    // * https://github.com/netty/netty/issues/3705\n-                    if (expiryTime - currentNanoTime < 0) {\n-                        this.onTimeout(removedTask);\n-                    } else {\n-                        if (!this.pool.pendingAcquisitions.offer(removedTask)) {\n-                            logger.error(\"Unexpected failure when returning the removed task\"\n-                                    + \" to pending acquisition queue. current size [{}]\",\n-                                this.pool.pendingAcquisitions.size());\n-                        }\n-                        break;\n+                // Compare nanoTime as described in the System.nanoTime documentation\n+                // See:\n+                // * https://docs.oracle.com/javase/7/docs/api/java/lang/System.html#nanoTime()\n+                // * https://github.com/netty/netty/issues/3705\n+                if (expiryTime - currentNanoTime < 0) {\n+                    this.onTimeout(removedTask);\n+                } else {\n+                    if (!this.pool.pendingAcquisitions.offer(removedTask)) {", "originalCommit": "2363921078f6a50c461ccacd3a810a95e7c886c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU0MTAyMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15337#discussion_r490541023", "bodyText": "Yes - it is fine. the queue has unlimited capcity", "author": "FabianMeiswinkel", "createdAt": "2020-09-17T20:25:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUyMzA4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU0MTM5Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15337#discussion_r490541396", "bodyText": "I mean limited only by resource constraints - and since admission control is in place there is no issue.", "author": "FabianMeiswinkel", "createdAt": "2020-09-17T20:26:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUyMzA4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU1ODM1Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15337#discussion_r490558356", "bodyText": "got it, thanks for the explanation~", "author": "xinlian12", "createdAt": "2020-09-17T20:58:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUyMzA4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "b1bbe24701d5e39c744512fa735fce7f6f8f2653", "chunk": "diff --git a/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdClientChannelPool.java b/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdClientChannelPool.java\nindex 000f98aa74a..4bde1d0c79d 100644\n--- a/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdClientChannelPool.java\n+++ b/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdClientChannelPool.java\n\n@@ -1482,7 +1482,7 @@ public final class RntbdClientChannelPool implements ChannelPool {\n                 // See:\n                 // * https://docs.oracle.com/javase/7/docs/api/java/lang/System.html#nanoTime()\n                 // * https://github.com/netty/netty/issues/3705\n-                if (expiryTime - currentNanoTime < 0) {\n+                if (expiryTime - currentNanoTime <= 0) {\n                     this.onTimeout(removedTask);\n                 } else {\n                     if (!this.pool.pendingAcquisitions.offer(removedTask)) {\n"}}, {"oid": "a2fefb3828dc28c21f0a891006ded23aaf29bf32", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a2fefb3828dc28c21f0a891006ded23aaf29bf32", "message": "Reacting to code review feedback", "committedDate": "2020-09-17T20:08:37Z", "type": "commit"}, {"oid": "b1bbe24701d5e39c744512fa735fce7f6f8f2653", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b1bbe24701d5e39c744512fa735fce7f6f8f2653", "message": "Avoiding that we expire 1 ns too late :-)", "committedDate": "2020-09-17T20:24:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYxMzAwOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15337#discussion_r490613008", "bodyText": "NIT : This should be final", "author": "kushagraThapar", "createdAt": "2020-09-17T23:17:02Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RntbdTransportClient.java", "diffHunk": "@@ -128,6 +151,8 @@ public long id() {\n         final RntbdEndpoint endpoint = this.endpointProvider.get(address);\n         final RntbdRequestRecord record = endpoint.request(requestArgs);\n \n+        Context reactorContext = Context.of(KEY_ON_ERROR_DROPPED, onErrorDropHookWithReduceLogLevel);", "originalCommit": "b1bbe24701d5e39c744512fa735fce7f6f8f2653", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDkzNTk5Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15337#discussion_r490935997", "bodyText": "Fixed", "author": "FabianMeiswinkel", "createdAt": "2020-09-18T13:07:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYxMzAwOA=="}], "type": "inlineReview", "revised_code": {"commit": "10b686ac895ddd6e4e961048aa56a676e29e1642", "chunk": "diff --git a/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RntbdTransportClient.java b/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RntbdTransportClient.java\nindex fee6d7c9ba8..5703ffd4112 100644\n--- a/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RntbdTransportClient.java\n+++ b/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RntbdTransportClient.java\n\n@@ -151,7 +151,7 @@ public final class RntbdTransportClient extends TransportClient {\n         final RntbdEndpoint endpoint = this.endpointProvider.get(address);\n         final RntbdRequestRecord record = endpoint.request(requestArgs);\n \n-        Context reactorContext = Context.of(KEY_ON_ERROR_DROPPED, onErrorDropHookWithReduceLogLevel);\n+        final Context reactorContext = Context.of(KEY_ON_ERROR_DROPPED, onErrorDropHookWithReduceLogLevel);\n \n         final Mono<StoreResponse> result = Mono.fromFuture(record.whenComplete((response, throwable) -> {\n \n"}}, {"oid": "10b686ac895ddd6e4e961048aa56a676e29e1642", "url": "https://github.com/Azure/azure-sdk-for-java/commit/10b686ac895ddd6e4e961048aa56a676e29e1642", "message": "Making reactorContext final", "committedDate": "2020-09-18T12:29:09Z", "type": "commit"}, {"oid": "013482b6e2a561f05e68d652778eb689031f52fd", "url": "https://github.com/Azure/azure-sdk-for-java/commit/013482b6e2a561f05e68d652778eb689031f52fd", "message": "Merge branch 'master' of https://github.com/Azure/azure-sdk-for-java into users/fabianm/onErrorDroppedFix", "committedDate": "2020-09-18T13:05:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA2ODIzNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15337#discussion_r491068236", "bodyText": "@FabianMeiswinkel Is this a feature of Reactor, if so is it documented somewhere? It's interesting.", "author": "allenhumphreys", "createdAt": "2020-09-18T16:41:15Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RntbdTransportClient.java", "diffHunk": "@@ -58,6 +61,26 @@\n     private static final AtomicLong instanceCount = new AtomicLong();\n     private static final Logger logger = LoggerFactory.getLogger(RntbdTransportClient.class);\n \n+    /**\n+     * A key that can be used to store a sequence-specific {@link Hooks#onErrorDropped(Consumer)}\n+     * hook in a {@link Context}, as a {@link Consumer Consumer&lt;Throwable&gt;}.\n+     */\n+    private static final String KEY_ON_ERROR_DROPPED = \"reactor.onErrorDropped.local\";", "originalCommit": "013482b6e2a561f05e68d652778eb689031f52fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA4NDIwMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15337#discussion_r491084203", "bodyText": "Yes - it is a Reactor feature - but I found it via source code inspection. This is the commit in which it was added: reactor/reactor-core@b576f7f", "author": "FabianMeiswinkel", "createdAt": "2020-09-18T17:13:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA2ODIzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA4NTc5Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15337#discussion_r491085792", "bodyText": "The best features are always undocumented! My next question is why didn't you use Operators.KEY_ON_ERROR_DROPPED and/or provide a link to how it works? :-)", "author": "allenhumphreys", "createdAt": "2020-09-18T17:16:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA2ODIzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA5NDQ2NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15337#discussion_r491094465", "bodyText": "Hooks.KEY_ON_ERROR_DROPPED is package internal. But fair point about comment. Will add it.", "author": "FabianMeiswinkel", "createdAt": "2020-09-18T17:34:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA2ODIzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA5NjU5NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15337#discussion_r491096594", "bodyText": "#15365", "author": "FabianMeiswinkel", "createdAt": "2020-09-18T17:38:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA2ODIzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA5NzcxMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15337#discussion_r491097713", "bodyText": "Ah! In the commit you posted they were public, but the actual source now is in Hooks and yes internal, I get it now! Thanks for adding the comment :-)", "author": "allenhumphreys", "createdAt": "2020-09-18T17:40:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA2ODIzNg=="}], "type": "inlineReview", "revised_code": null}]}