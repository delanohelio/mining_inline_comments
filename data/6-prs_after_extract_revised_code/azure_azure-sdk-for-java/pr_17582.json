{"pr_number": 17582, "pr_title": "Add HttpClientOptions", "pr_createdAt": "2020-11-13T22:43:40Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/17582", "timeline": [{"oid": "7e0135284af9ae7449cbe615488138d14d937f26", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7e0135284af9ae7449cbe615488138d14d937f26", "message": "Add HttpClientOptions to allow general configuration of HttpClients when using an HttpClientProvider to create an instance", "committedDate": "2020-11-13T22:41:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI3MzUwMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17582#discussion_r523273501", "bodyText": "If I understand correctly ClientOptions::responseTimeout is not applicable for OkHttp right?", "author": "anuchandy", "createdAt": "2020-11-13T22:52:08Z", "path": "sdk/core/azure-core-http-okhttp/src/main/java/com/azure/core/http/okhttp/implementation/OkHttpClientProvider.java", "diffHunk": "@@ -13,4 +14,18 @@\n     public HttpClient createInstance() {\n         return new OkHttpAsyncHttpClientBuilder().build();\n     }\n+\n+    @Override\n+    public HttpClient createInstance(HttpClientOptions clientOptions) {\n+        OkHttpAsyncHttpClientBuilder builder = new OkHttpAsyncHttpClientBuilder();\n+\n+        if (clientOptions != null) {\n+            builder = builder.proxy(clientOptions.getProxyOptions())\n+                .configuration(clientOptions.getConfiguration())\n+                .writeTimeout(clientOptions.getWriteTimeout())\n+                .readTimeout(clientOptions.getReadTimeout());", "originalCommit": "7e0135284af9ae7449cbe615488138d14d937f26", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI4NTYxNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17582#discussion_r523285616", "bodyText": "Correct, OkHttp doesn't have an explicit API to set the timeout period for receiving a response for a request.", "author": "alzimmermsft", "createdAt": "2020-11-13T23:36:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI3MzUwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "1d5e97032b26aee3ef119a1a66997a130597c685", "chunk": "diff --git a/sdk/core/azure-core-http-okhttp/src/main/java/com/azure/core/http/okhttp/implementation/OkHttpClientProvider.java b/sdk/core/azure-core-http-okhttp/src/main/java/com/azure/core/http/okhttp/implementation/OkHttpClientProvider.java\ndeleted file mode 100644\nindex 17832f156fc..00000000000\n--- a/sdk/core/azure-core-http-okhttp/src/main/java/com/azure/core/http/okhttp/implementation/OkHttpClientProvider.java\n+++ /dev/null\n\n@@ -1,31 +0,0 @@\n-// Copyright (c) Microsoft Corporation. All rights reserved.\n-// Licensed under the MIT License.\n-\n-package com.azure.core.http.okhttp.implementation;\n-\n-import com.azure.core.http.HttpClient;\n-import com.azure.core.http.HttpClientOptions;\n-import com.azure.core.http.HttpClientProvider;\n-import com.azure.core.http.okhttp.OkHttpAsyncHttpClientBuilder;\n-\n-public class OkHttpClientProvider implements HttpClientProvider {\n-\n-    @Override\n-    public HttpClient createInstance() {\n-        return new OkHttpAsyncHttpClientBuilder().build();\n-    }\n-\n-    @Override\n-    public HttpClient createInstance(HttpClientOptions clientOptions) {\n-        OkHttpAsyncHttpClientBuilder builder = new OkHttpAsyncHttpClientBuilder();\n-\n-        if (clientOptions != null) {\n-            builder = builder.proxy(clientOptions.getProxyOptions())\n-                .configuration(clientOptions.getConfiguration())\n-                .writeTimeout(clientOptions.getWriteTimeout())\n-                .readTimeout(clientOptions.getReadTimeout());\n-        }\n-\n-        return builder.build();\n-    }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDU1Mjc0MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17582#discussion_r524552741", "bodyText": "Do we need a new type here? We already have ClientOptions which also is used for configuring client-specific settings.  There are pros and cons to using ClientOptions vs creating new HttpClientOptions.\nUsing ClientOptions:\nPros:\n\nClientOptions is already GA'd and is wired on to many client builders. So, adding a new configuration to ClientOptions will require no further changes to client builders in terms of API.\nUser has to learn about just one ClientOptions type\n\nCons:\n\nClientOptions is used for both AMQP and HTTP clients. So, some of the configurations in HTTP client options may not apply for AMQP services\n\nUsing HttpClientOptions:\nPros:\n\nContains only configurations applicable to HTTP-based services\n\nCons:\n\nRequires updating client builders of all services to add a new option to set HttpClientOptions\nUsers will see two setters: clientOptions(ClientOptions clientOptions) and httpClientOptions(HttpClientOptions httpClientOptions)", "author": "srnagar", "createdAt": "2020-11-16T20:29:29Z", "path": "sdk/core/azure-core/src/main/java/com/azure/core/http/HttpClientOptions.java", "diffHunk": "@@ -0,0 +1,161 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.http;\n+\n+import com.azure.core.util.Configuration;\n+\n+import java.time.Duration;\n+\n+/**\n+ * General configuration options for {@link HttpClient HttpClients}.TableEntity\n+ */\n+public class HttpClientOptions {", "originalCommit": "7e0135284af9ae7449cbe615488138d14d937f26", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2af3e4cd45cdaab7d8a00063d0c720916cdd3b81", "chunk": "diff --git a/sdk/core/azure-core/src/main/java/com/azure/core/http/HttpClientOptions.java b/sdk/core/azure-core/src/main/java/com/azure/core/http/HttpClientOptions.java\ndeleted file mode 100644\nindex 5827a9ee9c5..00000000000\n--- a/sdk/core/azure-core/src/main/java/com/azure/core/http/HttpClientOptions.java\n+++ /dev/null\n\n@@ -1,161 +0,0 @@\n-// Copyright (c) Microsoft Corporation. All rights reserved.\n-// Licensed under the MIT License.\n-\n-package com.azure.core.http;\n-\n-import com.azure.core.util.Configuration;\n-\n-import java.time.Duration;\n-\n-/**\n- * General configuration options for {@link HttpClient HttpClients}.TableEntity\n- */\n-public class HttpClientOptions {\n-    private static final Duration MINIMUM_TIMEOUT = Duration.ofMillis(1);\n-    private static final Duration DEFAULT_TIMEOUT = Duration.ofSeconds(60);\n-    private static final Duration NO_TIMEOUT = Duration.ZERO;\n-\n-    private ProxyOptions proxyOptions;\n-    private Configuration configuration;\n-    private Duration writeTimeout;\n-    private Duration responseTimeout;\n-    private Duration readTimeout;\n-\n-    /**\n-     * Sets the {@link ProxyOptions proxy options} that the {@link HttpClient} will use.\n-     *\n-     * @param proxyOptions The proxy options to use.\n-     * @return The update HttpClientOptions object.\n-     */\n-    public HttpClientOptions setProxyOptions(ProxyOptions proxyOptions) {\n-        this.proxyOptions = proxyOptions;\n-        return this;\n-    }\n-\n-    /**\n-     * Gets the {@link ProxyOptions proxy options} that the {@link HttpClient} will use.\n-     *\n-     * @return The proxy options to use.\n-     */\n-    public ProxyOptions getProxyOptions() {\n-        return proxyOptions;\n-    }\n-\n-    /**\n-     * Sets the configuration store that the {@link HttpClient} will use.\n-     *\n-     * @param configuration The configuration store to use.\n-     * @return The updated HttpClientOptions object.\n-     */\n-    public HttpClientOptions setConfiguration(Configuration configuration) {\n-        this.configuration = configuration;\n-        return this;\n-    }\n-\n-    /**\n-     * Gets the configuration store that the {@link HttpClient} will use.\n-     *\n-     * @return The configuration store to use.\n-     */\n-    public Configuration getConfiguration() {\n-        return configuration;\n-    }\n-\n-    /**\n-     * Sets the write timeout for a request to be sent.\n-     * <p>\n-     * The write timeout does not apply to the entire request but to each emission being sent over the wire. For example\n-     * a request body which emits {@code 10} {@code 8KB} buffers will trigger {@code 10} write operations, the outbound\n-     * buffer will be periodically checked to determine if it is still draining.\n-     * <p>\n-     * If {@code writeTimeout} is {@code null} a 60 second timeout will be used, if it is a {@link Duration} less than\n-     * or equal to zero then no write timeout will be applied. When applying the timeout the greater of one millisecond\n-     * and the value of {@code writeTimeout} will be used.\n-     *\n-     * @param writeTimeout Write operation timeout duration.\n-     * @return The updated HttpClientOptions object.\n-     */\n-    public HttpClientOptions setWriteTimeout(Duration writeTimeout) {\n-        this.writeTimeout = writeTimeout;\n-        return this;\n-    }\n-\n-    /**\n-     * Gets the write timeout for a request to be sent.\n-     *\n-     * @return The write timeout of a request to be sent.\n-     */\n-    public Duration getWriteTimeout() {\n-        return getTimeout(writeTimeout);\n-    }\n-\n-    /**\n-     * Sets the response timeout duration used when waiting for a server to reply.\n-     * <p>\n-     * The response timeout begins once the request write completes and finishes once the first response read is\n-     * triggered when the server response is received.\n-     * <p>\n-     * If {@code responseTimeout} is {@code null} a 60 second timeout will be used, if it is a {@link Duration} less\n-     * than or equal to zero then no timeout will be applied to the response. When applying the timeout the greater of\n-     * one millisecond and the value of {@code responseTimeout} will be used.\n-     *\n-     * @param responseTimeout Response timeout duration.\n-     * @return The updated HttpClientOptions object.\n-     */\n-    public HttpClientOptions responseTimeout(Duration responseTimeout) {\n-        this.responseTimeout = responseTimeout;\n-        return this;\n-    }\n-\n-    /**\n-     * Gets the response timeout duration used when waiting for a server to reply.\n-     *\n-     * @return The response timeout duration.\n-     */\n-    public Duration getResponseTimeout() {\n-        return getTimeout(responseTimeout);\n-    }\n-\n-    /**\n-     * Sets the read timeout duration used when reading the server response.\n-     * <p>\n-     * The read timeout begins once the first response read is triggered after the server response is received. This\n-     * timeout triggers periodically but won't fire its operation if another read operation has completed between when\n-     * the timeout is triggered and completes.\n-     * <p>\n-     * If {@code readTimeout} is {@code null} a 60 second timeout will be used, if it is a {@link Duration} less than or\n-     * equal to zero then no timeout period will be applied to response read. When applying the timeout the greater of\n-     * one millisecond and the value of {@code readTimeout} will be used.\n-     *\n-     * @param readTimeout Read timeout duration.\n-     * @return The updated HttpClientOptions object.\n-     */\n-    public HttpClientOptions readTimeout(Duration readTimeout) {\n-        this.readTimeout = readTimeout;\n-        return this;\n-    }\n-\n-    /**\n-     * Gets the read timeout duration used when reading the server response.\n-     *\n-     * @return The read timeout duration.\n-     */\n-    public Duration getReadTimeout() {\n-        return getTimeout(readTimeout);\n-    }\n-\n-    private static Duration getTimeout(Duration timeout) {\n-        // Timeout is null, use the 60 second default.\n-        if (timeout == null) {\n-            return DEFAULT_TIMEOUT;\n-        }\n-\n-        // Timeout is less than or equal to zero, return no timeout.\n-        if (timeout.isZero() || timeout.isNegative()) {\n-            return NO_TIMEOUT;\n-        }\n-\n-        // Return the maximum of the timeout period and the minimum allowed timeout period.\n-        return timeout.compareTo(MINIMUM_TIMEOUT) > 0 ? timeout : MINIMUM_TIMEOUT;\n-    }\n-}\n"}}, {"oid": "aa45fdf9dda2faf1fa8de17db8329196a3df8156", "url": "https://github.com/Azure/azure-sdk-for-java/commit/aa45fdf9dda2faf1fa8de17db8329196a3df8156", "message": "Merge branch 'master' into AzCore_HttpClientOptions", "committedDate": "2021-01-13T17:47:44Z", "type": "commit"}, {"oid": "2af3e4cd45cdaab7d8a00063d0c720916cdd3b81", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2af3e4cd45cdaab7d8a00063d0c720916cdd3b81", "message": "Update HttpClientOptions to extend ClientOptions, passing ClientOptions to more locations, documentation updates", "committedDate": "2021-01-13T19:14:14Z", "type": "commit"}, {"oid": "1d5e97032b26aee3ef119a1a66997a130597c685", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1d5e97032b26aee3ef119a1a66997a130597c685", "message": "Fix merge conflicts", "committedDate": "2021-01-13T19:33:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njc3OTIyNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17582#discussion_r556779227", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @return The update HttpClientOptions object.\n          \n          \n            \n                 * @return The updated HttpClientOptions object.", "author": "srnagar", "createdAt": "2021-01-13T19:35:14Z", "path": "sdk/core/azure-core/src/main/java/com/azure/core/util/HttpClientOptions.java", "diffHunk": "@@ -0,0 +1,176 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.util;\n+\n+import com.azure.core.http.HttpClient;\n+import com.azure.core.http.ProxyOptions;\n+\n+import java.time.Duration;\n+\n+/**\n+ * General configuration options for {@link HttpClient HttpClients}.\n+ */\n+public class HttpClientOptions extends ClientOptions {\n+    private static final Duration MINIMUM_TIMEOUT = Duration.ofMillis(1);\n+    private static final Duration DEFAULT_TIMEOUT = Duration.ofSeconds(60);\n+    private static final Duration NO_TIMEOUT = Duration.ZERO;\n+\n+    private ProxyOptions proxyOptions;\n+    private Configuration configuration;\n+    private Duration writeTimeout;\n+    private Duration responseTimeout;\n+    private Duration readTimeout;\n+\n+    @Override\n+    public HttpClientOptions setApplicationId(String applicationId) {\n+        super.setApplicationId(applicationId);\n+\n+        return this;\n+    }\n+\n+    @Override\n+    public HttpClientOptions setHeaders(Iterable<Header> headers) {\n+        super.setHeaders(headers);\n+\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the {@link ProxyOptions proxy options} that the {@link HttpClient} will use.\n+     *\n+     * @param proxyOptions The proxy options to use.\n+     * @return The update HttpClientOptions object.", "originalCommit": "1d5e97032b26aee3ef119a1a66997a130597c685", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1bf6bcb546c924860e2f0ed4872e2fd152968bc1", "chunk": "diff --git a/sdk/core/azure-core/src/main/java/com/azure/core/util/HttpClientOptions.java b/sdk/core/azure-core/src/main/java/com/azure/core/util/HttpClientOptions.java\nindex 60c6d8980b5..e4bd6108cfd 100644\n--- a/sdk/core/azure-core/src/main/java/com/azure/core/util/HttpClientOptions.java\n+++ b/sdk/core/azure-core/src/main/java/com/azure/core/util/HttpClientOptions.java\n\n@@ -11,7 +11,7 @@ import java.time.Duration;\n /**\n  * General configuration options for {@link HttpClient HttpClients}.\n  */\n-public class HttpClientOptions extends ClientOptions {\n+public final class HttpClientOptions extends ClientOptions {\n     private static final Duration MINIMUM_TIMEOUT = Duration.ofMillis(1);\n     private static final Duration DEFAULT_TIMEOUT = Duration.ofSeconds(60);\n     private static final Duration NO_TIMEOUT = Duration.ZERO;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njc4MTQxNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17582#discussion_r556781414", "bodyText": "How about moving the codesnippets into a package like com.azure.core.docs.*? This will keep the samples clean for the user to find runnable code samples.", "author": "srnagar", "createdAt": "2021-01-13T19:39:09Z", "path": "sdk/core/azure-core/src/samples/java/com/azure/core/http/HttpPipelineBuilderJavaDocCodeSnippets.java", "diffHunk": "@@ -0,0 +1,26 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.http;", "originalCommit": "1d5e97032b26aee3ef119a1a66997a130597c685", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njc4NDgzMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17582#discussion_r556784830", "bodyText": "This sounds like a good location, let's do this in another PR.\nShould we make this a standard convention? Ex. in AppConfiguration they'll use com.azure.data.appconfiguration.docs.*", "author": "alzimmermsft", "createdAt": "2021-01-13T19:45:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njc4MTQxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njc4OTQ1NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17582#discussion_r556789454", "bodyText": "Yeah, this should be a standard convention for all client libraries.", "author": "srnagar", "createdAt": "2021-01-13T19:53:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njc4MTQxNA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njc4MTYyNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17582#discussion_r556781625", "bodyText": "Make this final.", "author": "srnagar", "createdAt": "2021-01-13T19:39:34Z", "path": "sdk/core/azure-core/src/main/java/com/azure/core/util/HttpClientOptions.java", "diffHunk": "@@ -0,0 +1,176 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.util;\n+\n+import com.azure.core.http.HttpClient;\n+import com.azure.core.http.ProxyOptions;\n+\n+import java.time.Duration;\n+\n+/**\n+ * General configuration options for {@link HttpClient HttpClients}.\n+ */\n+public class HttpClientOptions extends ClientOptions {", "originalCommit": "1d5e97032b26aee3ef119a1a66997a130597c685", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1bf6bcb546c924860e2f0ed4872e2fd152968bc1", "chunk": "diff --git a/sdk/core/azure-core/src/main/java/com/azure/core/util/HttpClientOptions.java b/sdk/core/azure-core/src/main/java/com/azure/core/util/HttpClientOptions.java\nindex 60c6d8980b5..e4bd6108cfd 100644\n--- a/sdk/core/azure-core/src/main/java/com/azure/core/util/HttpClientOptions.java\n+++ b/sdk/core/azure-core/src/main/java/com/azure/core/util/HttpClientOptions.java\n\n@@ -11,7 +11,7 @@ import java.time.Duration;\n /**\n  * General configuration options for {@link HttpClient HttpClients}.\n  */\n-public class HttpClientOptions extends ClientOptions {\n+public final class HttpClientOptions extends ClientOptions {\n     private static final Duration MINIMUM_TIMEOUT = Duration.ofMillis(1);\n     private static final Duration DEFAULT_TIMEOUT = Duration.ofSeconds(60);\n     private static final Duration NO_TIMEOUT = Duration.ZERO;\n"}}, {"oid": "1bf6bcb546c924860e2f0ed4872e2fd152968bc1", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1bf6bcb546c924860e2f0ed4872e2fd152968bc1", "message": "Changes based on review", "committedDate": "2021-01-13T19:50:26Z", "type": "commit"}]}