{"pr_number": 14744, "pr_title": "Add digital twin lifecycle sample", "pr_createdAt": "2020-09-02T20:19:12Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/14744", "timeline": [{"oid": "81835bd9ce9dab2d44ea00aa97b60e31ecd7f42d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/81835bd9ce9dab2d44ea00aa97b60e31ecd7f42d", "message": "samples(adt): Add digital twin lifecycle sample", "committedDate": "2020-09-02T22:43:25Z", "type": "commit"}, {"oid": "81835bd9ce9dab2d44ea00aa97b60e31ecd7f42d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/81835bd9ce9dab2d44ea00aa97b60e31ecd7f42d", "message": "samples(adt): Add digital twin lifecycle sample", "committedDate": "2020-09-02T22:43:25Z", "type": "forcePushed"}, {"oid": "8728cb3aabb28da12c8684e5994a5e0db828a1a1", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8728cb3aabb28da12c8684e5994a5e0db828a1a1", "message": "typo", "committedDate": "2020-09-02T22:58:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjU4NzU1NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14744#discussion_r482587554", "bodyText": "This runnable is executed when the flux completes successfully.", "author": "abhipsaMisra", "createdAt": "2020-09-02T23:12:12Z", "path": "sdk/digitaltwins/azure-digitaltwins-core/src/samples/java/com/azure/digitaltwins/core/DigitalTwinsLifecycleSample.java", "diffHunk": "@@ -72,21 +97,71 @@ public static void deleteTwins() throws IOException, InterruptedException {\n         System.out.println(\"DELETE DIGITAL TWINS\");\n         Map<String, String> twins = FileHelper.loadAllFilesInPath(TwinsPath);\n         final Semaphore deleteTwinsSemaphore = new Semaphore(0);\n+        final Semaphore deleteRelationshipsSemaphore = new Semaphore(0);\n \n-        // Call APIs to delete the twins. For each async operation, once the operation is completed successfully, a semaphore is released.\n+        // Call APIs to clean up any pre-existing resources that might be referenced by this sample. If digital twin does not exist, ignore.\n         twins\n-            .forEach((twinId, twinContent) -> client.deleteDigitalTwin(twinId)\n-                .doOnSuccess(aVoid -> System.out.println(\"Deleted digital twin: \" + twinId))\n-                .doOnError(throwable -> {\n-                    // If digital twin does not exist, ignore.\n-                    if (!(throwable instanceof ErrorResponseException) || !((ErrorResponseException) throwable).getValue().getError().getCode().equals(\"DigitalTwinNotFound\")) {\n-                        System.err.println(\"Could not delete digital twin \" + twinId + \" due to \" + throwable);\n+            .forEach((twinId, twinContent) -> {\n+                // Call APIs to delete all relationships.\n+                client.listRelationships(twinId, BasicRelationship.class)\n+                    .doOnComplete(deleteRelationshipsSemaphore::release)", "originalCommit": "8728cb3aabb28da12c8684e5994a5e0db828a1a1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1c80e03c0ce62972eb4f461e8cd35652f6178317", "chunk": "diff --git a/sdk/digitaltwins/azure-digitaltwins-core/src/samples/java/com/azure/digitaltwins/core/DigitalTwinsLifecycleSample.java b/sdk/digitaltwins/azure-digitaltwins-core/src/samples/java/com/azure/digitaltwins/core/DigitalTwinsLifecycleAsyncSample.java\nsimilarity index 91%\nrename from sdk/digitaltwins/azure-digitaltwins-core/src/samples/java/com/azure/digitaltwins/core/DigitalTwinsLifecycleSample.java\nrename to sdk/digitaltwins/azure-digitaltwins-core/src/samples/java/com/azure/digitaltwins/core/DigitalTwinsLifecycleAsyncSample.java\nindex b181866b846..fffe45c6200 100644\n--- a/sdk/digitaltwins/azure-digitaltwins-core/src/samples/java/com/azure/digitaltwins/core/DigitalTwinsLifecycleSample.java\n+++ b/sdk/digitaltwins/azure-digitaltwins-core/src/samples/java/com/azure/digitaltwins/core/DigitalTwinsLifecycleAsyncSample.java\n\n@@ -93,6 +92,11 @@ public class DigitalTwinsLifecycleSample {\n         createTwins();\n     }\n \n+    /**\n+     * Delete a twin, and any relationships it might have.\n+     * @throws IOException If an I/O error is thrown when accessing the starting file.\n+     * @throws InterruptedException If the current thread is interrupted while waiting to acquire permits on a semaphore.\n+     */\n     public static void deleteTwins() throws IOException, InterruptedException {\n         System.out.println(\"DELETE DIGITAL TWINS\");\n         Map<String, String> twins = FileHelper.loadAllFilesInPath(TwinsPath);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjU4ODA3MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14744#discussion_r482588070", "bodyText": "This function is executed when the flux completes with an error", "author": "abhipsaMisra", "createdAt": "2020-09-02T23:12:59Z", "path": "sdk/digitaltwins/azure-digitaltwins-core/src/samples/java/com/azure/digitaltwins/core/DigitalTwinsLifecycleSample.java", "diffHunk": "@@ -72,21 +97,71 @@ public static void deleteTwins() throws IOException, InterruptedException {\n         System.out.println(\"DELETE DIGITAL TWINS\");\n         Map<String, String> twins = FileHelper.loadAllFilesInPath(TwinsPath);\n         final Semaphore deleteTwinsSemaphore = new Semaphore(0);\n+        final Semaphore deleteRelationshipsSemaphore = new Semaphore(0);\n \n-        // Call APIs to delete the twins. For each async operation, once the operation is completed successfully, a semaphore is released.\n+        // Call APIs to clean up any pre-existing resources that might be referenced by this sample. If digital twin does not exist, ignore.\n         twins\n-            .forEach((twinId, twinContent) -> client.deleteDigitalTwin(twinId)\n-                .doOnSuccess(aVoid -> System.out.println(\"Deleted digital twin: \" + twinId))\n-                .doOnError(throwable -> {\n-                    // If digital twin does not exist, ignore.\n-                    if (!(throwable instanceof ErrorResponseException) || !((ErrorResponseException) throwable).getValue().getError().getCode().equals(\"DigitalTwinNotFound\")) {\n-                        System.err.println(\"Could not delete digital twin \" + twinId + \" due to \" + throwable);\n+            .forEach((twinId, twinContent) -> {\n+                // Call APIs to delete all relationships.\n+                client.listRelationships(twinId, BasicRelationship.class)\n+                    .doOnComplete(deleteRelationshipsSemaphore::release)\n+                    .doOnError(throwable -> {", "originalCommit": "8728cb3aabb28da12c8684e5994a5e0db828a1a1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1c80e03c0ce62972eb4f461e8cd35652f6178317", "chunk": "diff --git a/sdk/digitaltwins/azure-digitaltwins-core/src/samples/java/com/azure/digitaltwins/core/DigitalTwinsLifecycleSample.java b/sdk/digitaltwins/azure-digitaltwins-core/src/samples/java/com/azure/digitaltwins/core/DigitalTwinsLifecycleAsyncSample.java\nsimilarity index 91%\nrename from sdk/digitaltwins/azure-digitaltwins-core/src/samples/java/com/azure/digitaltwins/core/DigitalTwinsLifecycleSample.java\nrename to sdk/digitaltwins/azure-digitaltwins-core/src/samples/java/com/azure/digitaltwins/core/DigitalTwinsLifecycleAsyncSample.java\nindex b181866b846..fffe45c6200 100644\n--- a/sdk/digitaltwins/azure-digitaltwins-core/src/samples/java/com/azure/digitaltwins/core/DigitalTwinsLifecycleSample.java\n+++ b/sdk/digitaltwins/azure-digitaltwins-core/src/samples/java/com/azure/digitaltwins/core/DigitalTwinsLifecycleAsyncSample.java\n\n@@ -93,6 +92,11 @@ public class DigitalTwinsLifecycleSample {\n         createTwins();\n     }\n \n+    /**\n+     * Delete a twin, and any relationships it might have.\n+     * @throws IOException If an I/O error is thrown when accessing the starting file.\n+     * @throws InterruptedException If the current thread is interrupted while waiting to acquire permits on a semaphore.\n+     */\n     public static void deleteTwins() throws IOException, InterruptedException {\n         System.out.println(\"DELETE DIGITAL TWINS\");\n         Map<String, String> twins = FileHelper.loadAllFilesInPath(TwinsPath);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjU4Nzc3OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14744#discussion_r482587778", "bodyText": "I think we should have an Async Suffix in the file name to indicate that we are using Async APIs for this sample.", "author": "azabbasi", "createdAt": "2020-09-02T23:12:32Z", "path": "sdk/digitaltwins/azure-digitaltwins-core/src/samples/java/com/azure/digitaltwins/core/DigitalTwinsLifecycleSample.java", "diffHunk": "@@ -6,7 +6,9 @@\n import com.azure.core.http.policy.HttpLogDetailLevel;", "originalCommit": "8728cb3aabb28da12c8684e5994a5e0db828a1a1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "1c80e03c0ce62972eb4f461e8cd35652f6178317", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1c80e03c0ce62972eb4f461e8cd35652f6178317", "message": "cr comments", "committedDate": "2020-09-02T23:29:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjYwMjUwNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14744#discussion_r482602506", "bodyText": "To understand why do we need semaphore here? Do we have some limitations for parallel operations?", "author": "bikamani", "createdAt": "2020-09-02T23:43:17Z", "path": "sdk/digitaltwins/azure-digitaltwins-core/src/samples/java/com/azure/digitaltwins/core/DigitalTwinsLifecycleAsyncSample.java", "diffHunk": "@@ -0,0 +1,195 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.digitaltwins.core;\n+\n+import com.azure.core.http.policy.HttpLogDetailLevel;\n+import com.azure.core.http.policy.HttpLogOptions;\n+import com.azure.digitaltwins.core.implementation.models.ErrorResponseException;\n+import com.azure.digitaltwins.core.implementation.serialization.BasicRelationship;\n+import com.azure.identity.ClientSecretCredentialBuilder;\n+import org.apache.http.HttpStatus;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Map;\n+import java.util.concurrent.Semaphore;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * This sample creates all the models in \\DTDL\\Models folder in the ADT service instance and creates the corresponding twins in \\DTDL\\DigitalTwins folder.\n+ * The Diagram for the Hospital model looks like this:\n+ *\n+ *          +------------+\n+ *          |  Building  +-----isEquippedWith-----+\n+ *          +------------+                        |\n+ *                |                               v\n+ *               has                           +-----+\n+ *                |                            | HVAC|\n+ *                v                            +-----+\n+ *          +------------+                        |\n+ *          |   Floor    +<--controlsTemperature--+\n+ *          +------------+\n+ *                |\n+ *             contains\n+ *                |\n+ *                v\n+ *          +------------+                 +-----------------+\n+ *          |   Room     |-with component->| WifiAccessPoint |\n+ *          +------------+                 +-----------------+\n+ *\n+ */\n+public class DigitalTwinsLifecycleAsyncSample {\n+    private static final String tenantId = System.getenv(\"TENANT_ID\");\n+    private static final String clientId = System.getenv(\"CLIENT_ID\");\n+    private static final String clientSecret = System.getenv(\"CLIENT_SECRET\");\n+    private static final String endpoint = System.getenv(\"DIGITAL_TWINS_ENDPOINT\");\n+\n+    private static final int MaxWaitTimeAsyncOperationsInSeconds = 10;\n+\n+    private static final URL DtdlDirectoryUrl = DigitalTwinsLifecycleAsyncSample.class.getClassLoader().getResource(\"DTDL\");\n+    private static final Path DtDlDirectoryPath;\n+    private static final Path TwinsPath;\n+    private static final Path ModelsPath;\n+    private static final Path RelationshipsPath;\n+\n+    private static final DigitalTwinsAsyncClient client;\n+\n+    static {\n+        try {\n+            assert DtdlDirectoryUrl != null;\n+            DtDlDirectoryPath = Paths.get(DtdlDirectoryUrl.toURI());\n+        } catch (URISyntaxException e) {\n+            throw new RuntimeException(\"Unable to convert the DTDL directory URL to URI\", e);\n+        }\n+        TwinsPath = Paths.get(DtDlDirectoryPath.toString(), \"DigitalTwins\");\n+        ModelsPath = Paths.get(DtDlDirectoryPath.toString(), \"Models\");\n+        RelationshipsPath = Paths.get(DtDlDirectoryPath.toString(), \"Relationships\");\n+\n+        client = new DigitalTwinsClientBuilder()\n+            .tokenCredential(\n+                new ClientSecretCredentialBuilder()\n+                    .tenantId(tenantId)\n+                    .clientId(clientId)\n+                    .clientSecret(clientSecret)\n+                    .build()\n+            )\n+            .endpoint(endpoint)\n+            .httpLogOptions(\n+                new HttpLogOptions()\n+                    .setLogLevel(HttpLogDetailLevel.NONE))\n+            .buildAsyncClient();\n+    }\n+\n+    public static void main(String[] args) throws IOException, InterruptedException {\n+        // Ensure existing twins with the same name are deleted first\n+        deleteTwins();\n+\n+        // Create twin counterparts for all the models\n+        createTwins();\n+    }\n+\n+    /**\n+     * Delete a twin, and any relationships it might have.\n+     * @throws IOException If an I/O error is thrown when accessing the starting file.\n+     * @throws InterruptedException If the current thread is interrupted while waiting to acquire permits on a semaphore.\n+     */\n+    public static void deleteTwins() throws IOException, InterruptedException {\n+        System.out.println(\"DELETE DIGITAL TWINS\");\n+        Map<String, String> twins = FileHelper.loadAllFilesInPath(TwinsPath);\n+        final Semaphore deleteTwinsSemaphore = new Semaphore(0);\n+        final Semaphore deleteRelationshipsSemaphore = new Semaphore(0);\n+\n+        // Call APIs to clean up any pre-existing resources that might be referenced by this sample. If digital twin does not exist, ignore.\n+        twins\n+            .forEach((twinId, twinContent) -> {\n+                // Call APIs to delete all relationships.\n+                client.listRelationships(twinId, BasicRelationship.class)\n+                    .doOnComplete(deleteRelationshipsSemaphore::release)\n+                    .doOnError(throwable -> {\n+                        if (throwable instanceof ErrorResponseException && ((ErrorResponseException) throwable).getResponse().getStatusCode() == HttpStatus.SC_NOT_FOUND) {\n+                            deleteRelationshipsSemaphore.release();\n+                        } else {\n+                            System.err.println(\"List relationships error: \" + throwable);\n+                        }\n+                    })\n+                    .subscribe(\n+                        relationship -> client.deleteRelationship(twinId, relationship.getId())\n+                            .subscribe(\n+                                aVoid -> System.out.println(\"Found and deleted relationship: \" + relationship.getId()),\n+                                throwable -> System.err.println(\"Delete relationship error: \" + throwable)\n+                            ));\n+\n+                // Call APIs to delete any incoming relationships.\n+                client.listIncomingRelationships(twinId)\n+                    .doOnComplete(deleteRelationshipsSemaphore::release)\n+                    .doOnError(throwable -> {\n+                        if (throwable instanceof ErrorResponseException && ((ErrorResponseException) throwable).getResponse().getStatusCode() == HttpStatus.SC_NOT_FOUND) {\n+                            deleteRelationshipsSemaphore.release();\n+                        } else {\n+                            System.err.println(\"List incoming relationships error: \" + throwable);\n+                        }\n+                    })\n+                    .subscribe(\n+                        incomingRelationship -> client.deleteRelationship(incomingRelationship.getSourceId(), incomingRelationship.getRelationshipId())\n+                            .subscribe(\n+                                aVoid -> System.out.println(\"Found and deleted incoming relationship: \" + incomingRelationship.getRelationshipId()),\n+                                throwable -> System.err.println(\"Delete incoming relationship error: \" + throwable)\n+                            ));\n+\n+                try {\n+                    // Verify that the list relationships and list incoming relationships async operations have completed.\n+                    if (deleteRelationshipsSemaphore.tryAcquire(2, MaxWaitTimeAsyncOperationsInSeconds, TimeUnit.SECONDS)) {\n+                        // Now the digital twin should be safe to delete\n+\n+                        // Call APIs to delete the twins.\n+                        client.deleteDigitalTwin(twinId)\n+                            .doOnSuccess(aVoid -> {\n+                                System.out.println(\"Deleted digital twin: \" + twinId);\n+                                deleteTwinsSemaphore.release();\n+                            })\n+                            .doOnError(throwable -> {\n+                                if (throwable instanceof ErrorResponseException && ((ErrorResponseException) throwable).getResponse().getStatusCode() == HttpStatus.SC_NOT_FOUND) {\n+                                    deleteTwinsSemaphore.release();\n+                                } else {\n+                                    System.err.println(\"Could not delete digital twin \" + twinId + \" due to \" + throwable);\n+                                }\n+                            })\n+                            .subscribe();\n+                    }\n+                } catch (InterruptedException e) {\n+                    throw new RuntimeException(\"Could not cleanup the pre-existing resources: \", e);\n+                }\n+            });\n+\n+        // Verify that a semaphore has been released for each delete async operation, signifying that the async call has completed successfully..\n+        boolean created = deleteTwinsSemaphore.tryAcquire(twins.size(), MaxWaitTimeAsyncOperationsInSeconds, TimeUnit.SECONDS);\n+        System.out.println(\"Twins deleted: \" + created);\n+    }\n+\n+    /**\n+     * Creates all twins specified in the DTDL->DigitalTwins directory.\n+     * @throws IOException If an I/O error is thrown when accessing the starting file.\n+     * @throws InterruptedException If the current thread is interrupted while waiting to acquire permits on a semaphore.\n+     */\n+    public static void createTwins() throws IOException, InterruptedException {\n+        System.out.println(\"CREATE DIGITAL TWINS\");\n+        Map<String, String> twins = FileHelper.loadAllFilesInPath(TwinsPath);\n+        final Semaphore createTwinsSemaphore = new Semaphore(0);", "originalCommit": "1c80e03c0ce62972eb4f461e8cd35652f6178317", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjYwNTEwMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14744#discussion_r482605101", "bodyText": "No, not really. The semaphore is to ensure that we do not exit before the async operation has completed. We start all async operations and then release the semaphore only once the async call has completed.\nThat way, the subsequent operations are executed after the previous call has completed -> similar to doing a await on a Task.", "author": "abhipsaMisra", "createdAt": "2020-09-02T23:51:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjYwMjUwNg=="}], "type": "inlineReview", "revised_code": null}]}