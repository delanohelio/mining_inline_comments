{"pr_number": 13492, "pr_title": "Use TypeReference<T> in ObjectSerializer and JsonSerializer Interfaces", "pr_createdAt": "2020-07-24T17:42:39Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/13492", "timeline": [{"oid": "263b6446427a6d3411c20d9c0e62eebfbe03bee0", "url": "https://github.com/Azure/azure-sdk-for-java/commit/263b6446427a6d3411c20d9c0e62eebfbe03bee0", "message": "Use Type<T> in serializer interface", "committedDate": "2020-07-24T17:39:36Z", "type": "commit"}, {"oid": "d205f95589b6e68a8839cbb15ec682139a8128d2", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d205f95589b6e68a8839cbb15ec682139a8128d2", "message": "Rename Type<T> to TypeReference<T> to differentiate it from Java's Type", "committedDate": "2020-07-24T20:50:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg4MTM3NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13492#discussion_r461881374", "bodyText": "Why is this abstract?", "author": "srnagar", "createdAt": "2020-07-28T21:10:09Z", "path": "sdk/core/azure-core-experimental/src/main/java/com/azure/core/experimental/serializer/TypeReference.java", "diffHunk": "@@ -0,0 +1,42 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.experimental.serializer;\n+\n+import com.azure.core.util.logging.ClientLogger;\n+\n+import java.lang.reflect.ParameterizedType;\n+\n+/**\n+ * This class represents a generic Java type, retaining information about generics.\n+ *\n+ * @param <T> The type being represented.\n+ */\n+public abstract class TypeReference<T> {", "originalCommit": "d205f95589b6e68a8839cbb15ec682139a8128d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTkyNTk4OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13492#discussion_r461925988", "bodyText": "This is abstract to leverage functionality of the Java type system. If this we a concrete class we would have access to the T type as the generic super class would be Object. But if this is abstract and the only way to use it is with anonymous, or concrete, sub classes the generic super type would be the T value a user expected.", "author": "alzimmermsft", "createdAt": "2020-07-28T22:19:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg4MTM3NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg4MjAyOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13492#discussion_r461882029", "bodyText": "This serves the purpose. The only thing is that the user will now have to learn about TypeReference but since this is going to be used mainly client library developers, I am not too worried about this.", "author": "srnagar", "createdAt": "2020-07-28T21:11:24Z", "path": "sdk/core/azure-core-experimental/src/main/java/com/azure/core/experimental/serializer/JsonSerializer.java", "diffHunk": "@@ -16,22 +16,22 @@\n      * Reads a JSON stream into its object representation.\n      *\n      * @param stream JSON stream.\n-     * @param clazz {@link Class} representing the object.\n+     * @param typeReference {@link TypeReference} representing the object.\n      * @param <T> Type of the object.\n      * @return The object represented by the deserialized JSON stream.\n      */\n     @Override\n-    <T> Mono<T> deserialize(InputStream stream, Class<T> clazz);\n+    <T> Mono<T> deserialize(InputStream stream, TypeReference<T> typeReference);", "originalCommit": "d205f95589b6e68a8839cbb15ec682139a8128d2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg4MzEzMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13492#discussion_r461883131", "bodyText": "Can we avoid creating a new instance for same type here and also have a way to minimize duplicate instances when used by the user? Maybe have a static map of known types and vend those TypeReference instances if one exists or create one if it doesnt?", "author": "srnagar", "createdAt": "2020-07-28T21:13:38Z", "path": "sdk/core/azure-core-serializer-avro-apache/src/test/java/com/azure/core/serializer/avro/apache/ApacheAvroSerializerTests.java", "diffHunk": "@@ -54,61 +55,56 @@ private static ApacheAvroSerializer getSerializer(String schema) {\n \n     @ParameterizedTest\n     @MethodSource(\"deserializePrimitiveTypesSupplier\")\n-    public <T> void deserializePrimitiveTypes(InputStream avro, String schema, Class<T> clazz, T expected) {\n-        StepVerifier.create(getSerializer(schema).deserialize(avro, clazz))\n-            .assertNext(actual -> {\n-                assertTrue(clazz.isAssignableFrom(actual.getClass()));\n-                assertEquals(expected, actual);\n-            })\n+    public <T> void deserializePrimitiveTypes(InputStream avro, String schema, TypeReference<T> type, T expected) {\n+        StepVerifier.create(getSerializer(schema).deserialize(avro, type))\n+            .assertNext(actual -> assertEquals(expected, actual))\n             .verifyComplete();\n     }\n \n     private static Stream<Arguments> deserializePrimitiveTypesSupplier() {\n         return Stream.of(\n-            Arguments.of(streamCreator(0), schemaCreator(\"boolean\"), Boolean.class, false),\n-            Arguments.of(streamCreator(1), schemaCreator(\"boolean\"), Boolean.class, true),\n+            Arguments.of(streamCreator(0), schemaCreator(\"boolean\"), new TypeReference<Boolean>() { }, false),\n+            Arguments.of(streamCreator(1), schemaCreator(\"boolean\"), new TypeReference<Boolean>() { }, true),", "originalCommit": "d205f95589b6e68a8839cbb15ec682139a8128d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg4NzI4Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13492#discussion_r461887282", "bodyText": "Basically create a backing map of static references for common built-in Java types such as Boolean, Integer, Map<String, Object>, etc?", "author": "alzimmermsft", "createdAt": "2020-07-28T21:21:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg4MzEzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg5MDkwNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13492#discussion_r461890904", "bodyText": "Yeah, basically, support these built-in types out of the box and for custom types, lazily add to the backing map.", "author": "srnagar", "createdAt": "2020-07-28T21:29:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg4MzEzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTkyNjk4Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13492#discussion_r461926983", "bodyText": "The best I can think of would be an API such as this.\n<T> TypeReference<T> createInstance(Class<T> clazz);\nWith a static cache of Map<Class<T>, TypeReference<T>>. This won't be able to handle ParameterizedType.\nIs this something we would need to GA this feature or could we add it later?", "author": "alzimmermsft", "createdAt": "2020-07-28T22:22:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg4MzEzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTkyNzg0Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13492#discussion_r461927843", "bodyText": "Adding this after GA would lead to 2 different ways of creating an instance of TypeReference - ctor and static method. So, we have to finalize this before GA.", "author": "srnagar", "createdAt": "2020-07-28T22:24:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg4MzEzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTkzMTE5MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13492#discussion_r461931191", "bodyText": "I would stick with using constructor as this matches patterns used in other similar concepts.", "author": "alzimmermsft", "createdAt": "2020-07-28T22:33:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg4MzEzMQ=="}], "type": "inlineReview", "revised_code": null}]}