{"pr_number": 17738, "pr_title": "[Service Bus] Shutdown scheduler before closing client", "pr_createdAt": "2020-11-20T22:53:23Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/17738", "timeline": [{"oid": "3d37ff132892dfdc03cc46b53bc4f7098c8558a4", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3d37ff132892dfdc03cc46b53bc4f7098c8558a4", "message": "Shutdown scheduler before closing client", "committedDate": "2020-11-20T22:49:56Z", "type": "commit"}, {"oid": "4e2a67cf67e502080f0e03cd71b84f5527f9714e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/4e2a67cf67e502080f0e03cd71b84f5527f9714e", "message": "Change equality check", "committedDate": "2020-11-20T23:12:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAyMTc5Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17738#discussion_r528021792", "bodyText": "Do we throw an exception or let let the processor client to continue receive if start() is called after close()?", "author": "YijunXieMS", "createdAt": "2020-11-20T23:23:27Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusProcessorClient.java", "diffHunk": "@@ -116,20 +117,21 @@\n      * a new set of sessions will be processed.\n      */\n     public synchronized void start() {\n-        if (isRunning.getAndSet(true)) {\n+        if (isRunning.getAndSet(true) && !isClosed.getAndSet(false)) {", "originalCommit": "4e2a67cf67e502080f0e03cd71b84f5527f9714e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAyNDQyNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17738#discussion_r528024425", "bodyText": "We should allow calling start again after close is called.", "author": "srnagar", "createdAt": "2020-11-20T23:33:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAyMTc5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "00640e8cbff89304fcb1be53125a886bc497050a", "chunk": "diff --git a/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusProcessorClient.java b/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusProcessorClient.java\nindex c27ea2fd42b..5518c67e754 100644\n--- a/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusProcessorClient.java\n+++ b/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusProcessorClient.java\n\n@@ -117,10 +116,18 @@ public final class ServiceBusProcessorClient implements AutoCloseable {\n      * a new set of sessions will be processed.\n      */\n     public synchronized void start() {\n-        if (isRunning.getAndSet(true) && !isClosed.getAndSet(false)) {\n+        if (isRunning.getAndSet(true)) {\n             logger.info(\"Processor is already running\");\n             return;\n         }\n+\n+        if (asyncClient.get() == null) {\n+            ServiceBusReceiverAsyncClient newReceiverClient = this.receiverBuilder == null\n+                ? this.sessionReceiverBuilder.buildAsyncClientForProcessor()\n+                : this.receiverBuilder.buildAsyncClient();\n+            asyncClient.set(newReceiverClient);\n+        }\n+\n         receiveMessages();\n \n         // Start an executor to periodically check if the client's connection is active\n"}}, {"oid": "00640e8cbff89304fcb1be53125a886bc497050a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/00640e8cbff89304fcb1be53125a886bc497050a", "message": "Refactored close logic", "committedDate": "2020-11-20T23:30:00Z", "type": "commit"}]}