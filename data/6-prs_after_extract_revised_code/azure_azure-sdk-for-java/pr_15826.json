{"pr_number": 15826, "pr_title": "mgmt, keyvault refactor, avoid GET when list keys/secrets", "pr_createdAt": "2020-09-30T06:03:42Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/15826", "timeline": [{"oid": "d9f8170656190fb87fd1244d306dd14c0205f76e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d9f8170656190fb87fd1244d306dd14c0205f76e", "message": "avoid GET when list keys", "committedDate": "2020-09-30T05:37:15Z", "type": "commit"}, {"oid": "abbabf6002347e710e3cf914eb6ee6560fd0267d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/abbabf6002347e710e3cf914eb6ee6560fd0267d", "message": "avoid GET when list secrets", "committedDate": "2020-09-30T05:51:11Z", "type": "commit"}, {"oid": "7f65041eb834e8aa131da21fee0d63789ee954aa", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7f65041eb834e8aa131da21fee0d63789ee954aa", "message": "nit", "committedDate": "2020-09-30T05:55:36Z", "type": "commit"}, {"oid": "b7f9c6059bd24ce81b5fe795a0f2bc63c337e973", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b7f9c6059bd24ce81b5fe795a0f2bc63c337e973", "message": "bug fix", "committedDate": "2020-09-30T05:57:56Z", "type": "commit"}, {"oid": "84f807543467b052f320fe7eb1fe852683f16501", "url": "https://github.com/Azure/azure-sdk-for-java/commit/84f807543467b052f320fe7eb1fe852683f16501", "message": "bug fix", "committedDate": "2020-09-30T06:02:55Z", "type": "commit"}, {"oid": "0c3f04be03497a0a15ab1446f628f75030d0ab26", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0c3f04be03497a0a15ab1446f628f75030d0ab26", "message": "minor improvement and changelog", "committedDate": "2020-09-30T06:12:06Z", "type": "commit"}, {"oid": "a4f8c7638e1786817165be93df44be455ef7674a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a4f8c7638e1786817165be93df44be455ef7674a", "message": "fix spotbugs", "committedDate": "2020-09-30T06:41:01Z", "type": "commit"}, {"oid": "4abe34fdd6df15b07eee9d82a3119b67ff28fd33", "url": "https://github.com/Azure/azure-sdk-for-java/commit/4abe34fdd6df15b07eee9d82a3119b67ff28fd33", "message": "minor update on changelog", "committedDate": "2020-09-30T06:54:18Z", "type": "commit"}, {"oid": "0ddcaf46a4227c5106a771f22f297a1aef3db545", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0ddcaf46a4227c5106a771f22f297a1aef3db545", "message": "refactor", "committedDate": "2020-09-30T07:00:28Z", "type": "commit"}, {"oid": "a04eca0403a016d7f6c9a46a292448c430108633", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a04eca0403a016d7f6c9a46a292448c430108633", "message": "update changelog", "committedDate": "2020-09-30T07:04:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM1NDI5NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15826#discussion_r497354295", "bodyText": "@xccc-msft\nNow that I've removed the per-item GET request, and added the enabled method, I believe I can let customer handle this case.\nCustomer should be able to check enabled method return, and then decide whether to do a getValue or not.", "author": "weidongxu-microsoft", "createdAt": "2020-09-30T09:01:23Z", "path": "sdk/resourcemanager/azure-resourcemanager-keyvault/src/main/java/com/azure/resourcemanager/keyvault/implementation/SecretImpl.java", "diffHunk": "@@ -76,24 +98,20 @@ public boolean managed() {\n         return vault\n             .secretClient()\n             .listPropertiesOfSecretVersions(name())\n-            .flatMap(p -> {\n-                if (p.isEnabled()) {\n-                    return vault.secretClient().getSecret(p.getName(), p.getVersion());\n-                } else {\n-                    return Mono.just(new KeyVaultSecret(p.getName(), null).setProperties(p));\n-                }\n-            })", "originalCommit": "a04eca0403a016d7f6c9a46a292448c430108633", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE2NjkxNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15826#discussion_r502166916", "bodyText": "The change looks good. One question is for the secret version. When the customer want to get value for enabled secret, I think .getSecret(name, version) should have version param passed too. Not sure if I missed any part, but it seems it alwarys pass NULL as per your changes.", "author": "xseeseesee", "createdAt": "2020-10-09T03:38:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM1NDI5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "f7a1187f4b75224003762621c4b453c300ca6d41", "chunk": "diff --git a/sdk/resourcemanager/azure-resourcemanager-keyvault/src/main/java/com/azure/resourcemanager/keyvault/implementation/SecretImpl.java b/sdk/resourcemanager/azure-resourcemanager-keyvault/src/main/java/com/azure/resourcemanager/keyvault/implementation/SecretImpl.java\nindex 2f3986a4ecd..a5f6d6cb83e 100644\n--- a/sdk/resourcemanager/azure-resourcemanager-keyvault/src/main/java/com/azure/resourcemanager/keyvault/implementation/SecretImpl.java\n+++ b/sdk/resourcemanager/azure-resourcemanager-keyvault/src/main/java/com/azure/resourcemanager/keyvault/implementation/SecretImpl.java\n\n@@ -103,7 +103,7 @@ class SecretImpl extends CreatableUpdatableImpl<Secret, SecretProperties, Secret\n \n     @Override\n     protected Mono<SecretProperties> getInnerAsync() {\n-        return vault.secretClient().getSecret(name(), null).map(secret -> {\n+        return vault.secretClient().getSecret(name(), innerModel().getVersion()).map(secret -> {\n             this.secretValue = secret.getValue();\n             return secret.getProperties();\n         });\n"}}, {"oid": "35e85a12b1f83dbc7a6ba1c91235b1416f48a44b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/35e85a12b1f83dbc7a6ba1c91235b1416f48a44b", "message": "Merge branch 'master' into mgmt_keyvault-refactor", "committedDate": "2020-10-09T02:25:31Z", "type": "commit"}, {"oid": "f7a1187f4b75224003762621c4b453c300ca6d41", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f7a1187f4b75224003762621c4b453c300ca6d41", "message": "add version parameter to getSecret", "committedDate": "2020-10-09T05:24:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE5NjA4MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15826#discussion_r502196081", "bodyText": "Get the version param fixed.", "author": "weidongxu-microsoft", "createdAt": "2020-10-09T05:25:40Z", "path": "sdk/resourcemanager/azure-resourcemanager-keyvault/src/main/java/com/azure/resourcemanager/keyvault/implementation/SecretImpl.java", "diffHunk": "@@ -76,24 +98,20 @@ public boolean managed() {\n         return vault\n             .secretClient()\n             .listPropertiesOfSecretVersions(name())\n-            .flatMap(p -> {\n-                if (p.isEnabled()) {\n-                    return vault.secretClient().getSecret(p.getName(), p.getVersion());\n-                } else {\n-                    return Mono.just(new KeyVaultSecret(p.getName(), null).setProperties(p));\n-                }\n-            })\n             .map(this::wrapModel);\n     }\n \n     @Override\n-    protected Mono<KeyVaultSecret> getInnerAsync() {\n-        return vault.secretClient().getSecret(name(), null);\n+    protected Mono<SecretProperties> getInnerAsync() {\n+        return vault.secretClient().getSecret(name(), innerModel().getVersion()).map(secret -> {", "originalCommit": "f7a1187f4b75224003762621c4b453c300ca6d41", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "206b52aa9bfb94fd47fce382df4542f3c31cb5a9", "url": "https://github.com/Azure/azure-sdk-for-java/commit/206b52aa9bfb94fd47fce382df4542f3c31cb5a9", "message": "set value to null if secret is disabled", "committedDate": "2020-10-09T05:39:28Z", "type": "commit"}]}