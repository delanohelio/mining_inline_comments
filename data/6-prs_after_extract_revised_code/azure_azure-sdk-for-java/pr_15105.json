{"pr_number": 15105, "pr_title": "Add the Ability to Position HttpPipelinePolicies in Client Builders", "pr_createdAt": "2020-09-11T16:32:39Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/15105", "timeline": [{"oid": "4e9f63618a65e9cdf96ea1ed715d64d40cd7ca35", "url": "https://github.com/Azure/azure-sdk-for-java/commit/4e9f63618a65e9cdf96ea1ed715d64d40cd7ca35", "message": "Added HttpPipelinePosition which indicates where in the policy set an HttpPipelinePolicy will be placed when using a client builder", "committedDate": "2020-09-11T16:31:29Z", "type": "commit"}, {"oid": "77d1f99b635c373e0d3f0fd7e9446395ab2abf3c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/77d1f99b635c373e0d3f0fd7e9446395ab2abf3c", "message": "Updated AppConfiguration to use unreleased azure-core-test", "committedDate": "2020-09-14T16:48:41Z", "type": "commit"}, {"oid": "73753aaf8460458883d3480d9120f486dcc1e09d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/73753aaf8460458883d3480d9120f486dcc1e09d", "message": "Merged in master", "committedDate": "2020-09-14T16:51:33Z", "type": "commit"}, {"oid": "b8b2f1a1f50df63b7a11497d0083d56d229c7f43", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b8b2f1a1f50df63b7a11497d0083d56d229c7f43", "message": "Resolve testing issues by using unreleased version of azure-core", "committedDate": "2020-09-14T18:31:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTA4ODAwMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15105#discussion_r489088002", "bodyText": "Add a default implementation for getHttpPipelinePosition(), this will default to PER_RETRY.", "author": "alzimmermsft", "createdAt": "2020-09-16T00:16:13Z", "path": "sdk/core/azure-core/src/main/java/com/azure/core/http/policy/HttpPipelinePolicy.java", "diffHunk": "@@ -17,9 +17,9 @@\n @FunctionalInterface\n public interface HttpPipelinePolicy {\n     /**\n-     * Process provided request context and invokes the next policy.\n+     * Processes provided request context and invokes the next policy.\n      *\n-     * @param context request context\n+     * @param context The request context.\n      * @param next The next policy to invoke.\n      * @return A publisher that initiates the request upon subscription and emits a response on completion.\n      */", "originalCommit": "b8b2f1a1f50df63b7a11497d0083d56d229c7f43", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5433cddba92a40446463731633a0b65d3c6956c8", "chunk": "diff --git a/sdk/core/azure-core/src/main/java/com/azure/core/http/policy/HttpPipelinePolicy.java b/sdk/core/azure-core/src/main/java/com/azure/core/http/policy/HttpPipelinePolicy.java\nindex 4bac7c2e772..ea2cc88a5f0 100644\n--- a/sdk/core/azure-core/src/main/java/com/azure/core/http/policy/HttpPipelinePolicy.java\n+++ b/sdk/core/azure-core/src/main/java/com/azure/core/http/policy/HttpPipelinePolicy.java\n\n@@ -24,4 +25,15 @@ public interface HttpPipelinePolicy {\n      * @return A publisher that initiates the request upon subscription and emits a response on completion.\n      */\n     Mono<HttpResponse> process(HttpPipelineCallContext context, HttpPipelineNextPolicy next);\n+\n+    /**\n+     * Gets the position to place the policy.\n+     * <p>\n+     * By default pipeline policies are positioned {@link HttpPipelinePosition#PER_RETRY}.\n+     *\n+     * @return The position to place the policy.\n+     */\n+    default HttpPipelinePosition getPipelinePosition() {\n+        return HttpPipelinePosition.PER_RETRY;\n+    }\n }\n"}}, {"oid": "5433cddba92a40446463731633a0b65d3c6956c8", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5433cddba92a40446463731633a0b65d3c6956c8", "message": "Merged in master, added getter for HttpPipelinePosition to HttpPipelinePolicy", "committedDate": "2020-09-16T16:12:32Z", "type": "commit"}, {"oid": "a94522b5e05ea644696aa077003e638152021466", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a94522b5e05ea644696aa077003e638152021466", "message": "Merge branch 'master' into AzCore_AddPipelinePolicyPosition", "committedDate": "2020-09-21T20:50:10Z", "type": "commit"}, {"oid": "a011ebd5e4392b61bf9576b39f5e4f1ea2481364", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a011ebd5e4392b61bf9576b39f5e4f1ea2481364", "message": "Remove client builder overload", "committedDate": "2020-09-21T21:26:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM3NTExOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15105#discussion_r492375118", "bodyText": "I thought @JonathanGiles  suggested creating a separate interface PositionalHttpPipelinePolicy extends HttpPipelinePolicy", "author": "srnagar", "createdAt": "2020-09-21T22:11:51Z", "path": "sdk/core/azure-core/src/main/java/com/azure/core/http/policy/HttpPipelinePolicy.java", "diffHunk": "@@ -17,11 +18,22 @@\n @FunctionalInterface\n public interface HttpPipelinePolicy {\n     /**\n-     * Process provided request context and invokes the next policy.\n+     * Processes provided request context and invokes the next policy.\n      *\n-     * @param context request context\n+     * @param context The request context.\n      * @param next The next policy to invoke.\n      * @return A publisher that initiates the request upon subscription and emits a response on completion.\n      */\n     Mono<HttpResponse> process(HttpPipelineCallContext context, HttpPipelineNextPolicy next);\n+\n+    /**\n+     * Gets the position to place the policy.\n+     * <p>\n+     * By default pipeline policies are positioned {@link HttpPipelinePosition#PER_RETRY}.\n+     *\n+     * @return The position to place the policy.\n+     */\n+    default HttpPipelinePosition getPipelinePosition() {", "originalCommit": "a011ebd5e4392b61bf9576b39f5e4f1ea2481364", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzcxMTQ4Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15105#discussion_r493711486", "bodyText": "Discussed offline, going with the default method on the interface as adding a sub-interface would require most HttpPipelinePolicy instance to be updated to implement the new interface.", "author": "alzimmermsft", "createdAt": "2020-09-23T16:02:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM3NTExOA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "2a45f39ca005c86e2945bf06ddb63bef49ed326d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2a45f39ca005c86e2945bf06ddb63bef49ed326d", "message": "Remove duplicate version entry", "committedDate": "2020-09-21T23:01:34Z", "type": "commit"}, {"oid": "ff0907a9bf8b41694786a6df0e6ddd63e1af9154", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ff0907a9bf8b41694786a6df0e6ddd63e1af9154", "message": "Merge in master", "committedDate": "2020-09-23T18:08:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk0OTA4Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15105#discussion_r493949086", "bodyText": "Should we call this pipeline \"position\" or should we name this as HttpPolicyEvaluationStrategy? Since this doesn't define the position but defines if this policy needs to be evaluated just once per call or evaluated for every retry attempt.", "author": "srnagar", "createdAt": "2020-09-23T23:17:32Z", "path": "sdk/core/azure-core/src/main/java/com/azure/core/http/HttpPipelinePosition.java", "diffHunk": "@@ -0,0 +1,25 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.http;\n+\n+import com.azure.core.http.policy.HttpPipelinePolicy;\n+import com.azure.core.http.policy.RetryPolicy;\n+\n+/**\n+ * Indicates the position in an {@link HttpPipeline} to place an {@link HttpPipelinePolicy}.\n+ */\n+public enum HttpPipelinePosition {", "originalCommit": "ff0907a9bf8b41694786a6df0e6ddd63e1af9154", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ1MzkwMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15105#discussion_r494453903", "bodyText": "Both would work in the scenario where we added FIRST and LAST as additional options (HttpPipelinePosition.FIRST, HttpPolicyEvaluationStrategy.FIRST). But, given this is a simple enum I would stick with HttpPipelinePosition, that way we can save HttpPolicyEvaluationStrategy for a more complex scenario (similar to RetryStrategy).", "author": "alzimmermsft", "createdAt": "2020-09-24T16:29:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk0OTA4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ4Mzc4NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15105#discussion_r494483785", "bodyText": "Makes sense. Let's keep the current name then!", "author": "srnagar", "createdAt": "2020-09-24T17:18:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk0OTA4Ng=="}], "type": "inlineReview", "revised_code": null}]}