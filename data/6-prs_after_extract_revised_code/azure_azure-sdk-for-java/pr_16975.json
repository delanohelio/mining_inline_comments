{"pr_number": 16975, "pr_title": "Fix digital twins client not deserializing date times correctly", "pr_createdAt": "2020-10-29T22:18:31Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/16975", "timeline": [{"oid": "6d8e5a644354913c8cbd89982a2511ffcf32ce75", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6d8e5a644354913c8cbd89982a2511ffcf32ce75", "message": "Fix digital twins client not deserializing date times correctly\n\nAlso fix BasicDigitalTwinMetadata to use the DigitalTwinPropertyMetadata class", "committedDate": "2020-10-29T22:15:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYwMTA5OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16975#discussion_r514601098", "bodyText": "The issue was that we used a different mapper in our convenience layer than we did in our generated layer. The generated layer one (from jacksonAdapter.serializer()) has a lot of useful modules registered already, including a module for parsing of date times. By simply using the generated layer's adapter in this layer as well, this issue is solved", "author": "timtay-microsoft", "createdAt": "2020-10-29T22:21:26Z", "path": "sdk/digitaltwins/azure-digitaltwins-core/src/main/java/com/azure/digitaltwins/core/DigitalTwinsAsyncClient.java", "diffHunk": "@@ -53,17 +54,18 @@\n @ServiceClient(builder = DigitalTwinsClientBuilder.class, isAsync = true)\n public final class DigitalTwinsAsyncClient {\n     private static final ClientLogger logger = new ClientLogger(DigitalTwinsAsyncClient.class);\n-    private static final ObjectMapper mapper = new ObjectMapper();\n+    private static ObjectMapper mapper;\n     private final DigitalTwinsServiceVersion serviceVersion;\n     private final AzureDigitalTwinsAPIImpl protocolLayer;\n     private static final Boolean includeModelDefinitionOnGet = true;\n     private final JsonSerializer serializer;\n \n     DigitalTwinsAsyncClient(String serviceEndpoint, HttpPipeline pipeline, DigitalTwinsServiceVersion serviceVersion, JsonSerializer jsonSerializer) {\n         final SimpleModule stringModule = new SimpleModule(\"String Serializer\");\n-        stringModule.addSerializer(new DigitalTwinsStringSerializer(String.class, mapper));\n \n         JacksonAdapter jacksonAdapter = new JacksonAdapter();\n+        mapper = jacksonAdapter.serializer(); // Use the same mapper in this layer that the generated layer will use\n+        stringModule.addSerializer(new DigitalTwinsStringSerializer(String.class, mapper));", "originalCommit": "6d8e5a644354913c8cbd89982a2511ffcf32ce75", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYwMTQ1NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16975#discussion_r514601454", "bodyText": "Note that this mapper is not to be confused with the custom serializer that users can provide. If the user provides a custom serializer, then this mapper won't be used in the convenience layer", "author": "timtay-microsoft", "createdAt": "2020-10-29T22:22:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYwMTA5OA=="}], "type": "inlineReview", "revised_code": {"commit": "88df5824d155dbe0b7353d966e266039c3200f69", "chunk": "diff --git a/sdk/digitaltwins/azure-digitaltwins-core/src/main/java/com/azure/digitaltwins/core/DigitalTwinsAsyncClient.java b/sdk/digitaltwins/azure-digitaltwins-core/src/main/java/com/azure/digitaltwins/core/DigitalTwinsAsyncClient.java\nindex 709df7065d1..e445ab52a94 100644\n--- a/sdk/digitaltwins/azure-digitaltwins-core/src/main/java/com/azure/digitaltwins/core/DigitalTwinsAsyncClient.java\n+++ b/sdk/digitaltwins/azure-digitaltwins-core/src/main/java/com/azure/digitaltwins/core/DigitalTwinsAsyncClient.java\n\n@@ -54,7 +54,7 @@ import static com.azure.core.util.FluxUtil.withContext;\n @ServiceClient(builder = DigitalTwinsClientBuilder.class, isAsync = true)\n public final class DigitalTwinsAsyncClient {\n     private static final ClientLogger logger = new ClientLogger(DigitalTwinsAsyncClient.class);\n-    private static ObjectMapper mapper;\n+    private ObjectMapper mapper;\n     private final DigitalTwinsServiceVersion serviceVersion;\n     private final AzureDigitalTwinsAPIImpl protocolLayer;\n     private static final Boolean includeModelDefinitionOnGet = true;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYwMjU2OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16975#discussion_r514602568", "bodyText": "This is the module that was missing from our default mapper in the digital twins client. We get this module for free when we construct the JacksonAdapter and call .serializer() on that jacksonAdapter. We need to explicitly use it here, though", "author": "timtay-microsoft", "createdAt": "2020-10-29T22:25:22Z", "path": "sdk/digitaltwins/azure-digitaltwins-core/src/samples/java/com/azure/digitaltwins/core/ComponentSyncSamples.java", "diffHunk": "@@ -46,6 +51,10 @@ public static void main(String[] args) throws IOException {\n                     .setLogLevel(parsedArguments.getHttpLogDetailLevel()))\n             .buildClient();\n \n+        // This mapper gets used to deserialize a digital twin that has a date time within a property metadata, so it\n+        // needs to have this module in order to correctly deserialize that date time\n+        mapper.registerModule(new JavaTimeModule());", "originalCommit": "6d8e5a644354913c8cbd89982a2511ffcf32ce75", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "88df5824d155dbe0b7353d966e266039c3200f69", "url": "https://github.com/Azure/azure-sdk-for-java/commit/88df5824d155dbe0b7353d966e266039c3200f69", "message": "fixup", "committedDate": "2020-10-29T22:34:57Z", "type": "commit"}, {"oid": "8f21ef76d78deade59960bb51841b12ae6130307", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8f21ef76d78deade59960bb51841b12ae6130307", "message": "fixup", "committedDate": "2020-10-29T22:54:29Z", "type": "commit"}, {"oid": "a4973e80ee946d484680622f1d69ee53555068a8", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a4973e80ee946d484680622f1d69ee53555068a8", "message": "Revert \"fixup\"\n\nThis reverts commit 8f21ef76d78deade59960bb51841b12ae6130307.", "committedDate": "2020-10-29T23:01:21Z", "type": "commit"}, {"oid": "fdfdb832f6614e7b8e2d4c4eee041c5227df3b1e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/fdfdb832f6614e7b8e2d4c4eee041c5227df3b1e", "message": "fixup", "committedDate": "2020-10-29T23:05:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYyNDc3OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16975#discussion_r514624779", "bodyText": "Do we still need this string serializer? Are there any APIs that still operate on Strings? I thought we got rid of all those, and everything was objects now.", "author": "abhipsaMisra", "createdAt": "2020-10-29T23:29:13Z", "path": "sdk/digitaltwins/azure-digitaltwins-core/src/main/java/com/azure/digitaltwins/core/DigitalTwinsAsyncClient.java", "diffHunk": "@@ -53,17 +54,18 @@\n @ServiceClient(builder = DigitalTwinsClientBuilder.class, isAsync = true)\n public final class DigitalTwinsAsyncClient {\n     private static final ClientLogger logger = new ClientLogger(DigitalTwinsAsyncClient.class);\n-    private static final ObjectMapper mapper = new ObjectMapper();\n+    private ObjectMapper mapper;\n     private final DigitalTwinsServiceVersion serviceVersion;\n     private final AzureDigitalTwinsAPIImpl protocolLayer;\n     private static final Boolean includeModelDefinitionOnGet = true;\n     private final JsonSerializer serializer;\n \n     DigitalTwinsAsyncClient(String serviceEndpoint, HttpPipeline pipeline, DigitalTwinsServiceVersion serviceVersion, JsonSerializer jsonSerializer) {\n         final SimpleModule stringModule = new SimpleModule(\"String Serializer\");\n-        stringModule.addSerializer(new DigitalTwinsStringSerializer(String.class, mapper));\n \n         JacksonAdapter jacksonAdapter = new JacksonAdapter();\n+        mapper = jacksonAdapter.serializer(); // Use the same mapper in this layer that the generated layer will use\n+        stringModule.addSerializer(new DigitalTwinsStringSerializer(String.class, mapper));", "originalCommit": "fdfdb832f6614e7b8e2d4c4eee041c5227df3b1e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYyNTc3Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16975#discussion_r514625776", "bodyText": "That was the plan back when we were going to force APIs to take in a <T extends IDigitalTwin>, but those plans fell through, so we're back to supporting strings again. It would be more work to remove them at this point then I think it would be worth", "author": "timtay-microsoft", "createdAt": "2020-10-29T23:32:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYyNDc3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYyNjMyMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16975#discussion_r514626322", "bodyText": "Got it, so now we are back to the original state where we support <T> as String as input for these APIs.", "author": "abhipsaMisra", "createdAt": "2020-10-29T23:34:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYyNDc3OQ=="}], "type": "inlineReview", "revised_code": null}]}