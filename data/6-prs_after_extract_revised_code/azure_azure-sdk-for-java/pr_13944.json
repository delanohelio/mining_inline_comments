{"pr_number": 13944, "pr_title": "add @GeneratedValue annotation that can be used to autogenerate Id value on insert", "pr_createdAt": "2020-08-10T20:00:24Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/13944", "timeline": [{"oid": "e0bbb4b58bc66e2f17d439e8407d55fe1e151392", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e0bbb4b58bc66e2f17d439e8407d55fe1e151392", "message": "add @GeneratedValue annotation that can be used to autogenerate Id value on insert", "committedDate": "2020-08-10T19:46:27Z", "type": "commit"}, {"oid": "dc3a8bcd7c5987c6149492aa04e50192cc6add27", "url": "https://github.com/Azure/azure-sdk-for-java/commit/dc3a8bcd7c5987c6149492aa04e50192cc6add27", "message": "minor cleanup", "committedDate": "2020-08-10T19:52:08Z", "type": "commit"}, {"oid": "0d6e8210392ad6cac3872f775b70b70f69cb0ca5", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0d6e8210392ad6cac3872f775b70b70f69cb0ca5", "message": "fix checkstyle issues", "committedDate": "2020-08-10T19:57:55Z", "type": "commit"}, {"oid": "6aab6aae818d363e840d3ec00231bddafd0fc292", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6aab6aae818d363e840d3ec00231bddafd0fc292", "message": "fix style issues in integration test", "committedDate": "2020-08-10T21:14:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI3Njk3Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13944#discussion_r468276973", "bodyText": "I remember we had an issue with UUID generation in activityId causing long pauses due to lack of real randomness entropy.\nDo other spring plugin use auto generated UUID? I wonder if we should use fast uuid generation for this (similar to activityId in the SDK)", "author": "moderakh", "createdAt": "2020-08-11T01:36:57Z", "path": "sdk/cosmos/azure-spring-data-cosmos-core/src/main/java/com/azure/spring/data/cosmos/core/CosmosTemplate.java", "diffHunk": "@@ -189,6 +193,14 @@ public void setApplicationContext(ApplicationContext applicationContext) throws\n         return toDomainObject(domainType, response.getItem());\n     }\n \n+    @SuppressWarnings(\"unchecked\")\n+    private <T> void generateIdIfNullAndAutoGenerationEnabled(T originalItem, Class<?> type) {\n+        CosmosEntityInformation<?, ?> entityInfo = CosmosEntityInformation.getInstance(type);\n+        if (entityInfo.shouldGenerateId() && ReflectionUtils.getField(entityInfo.getIdField(), originalItem) == null) {\n+            ReflectionUtils.setField(entityInfo.getIdField(), originalItem, UUID.randomUUID().toString());", "originalCommit": "6aab6aae818d363e840d3ec00231bddafd0fc292", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMwNjk4OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13944#discussion_r468306989", "bodyText": "@moderakh - can you please point to the code where we auto generate activity id in the SDK code, may be we can implement something similar in spring if it helps with the performance.", "author": "kushagraThapar", "createdAt": "2020-08-11T03:35:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI3Njk3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMxMTc0NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13944#discussion_r468311744", "bodyText": "https://github.com/Azure/azure-sdk-for-java/blob/master/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/Utils.java#L438-L440", "author": "moderakh", "createdAt": "2020-08-11T03:55:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI3Njk3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMxNTExMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13944#discussion_r468315113", "bodyText": "Thanks for the code @moderakh , however the above TimeBasedUUIDGenerator is being brought in by uuid external dependency which is currently in the banned dependency list.\nI also checked our V2 async code, and we use the randomUUID generator to generate UUIDs.\nIn my opinion, it is not worth going through internal shading process for this. What are your thoughts?", "author": "kushagraThapar", "createdAt": "2020-08-11T04:10:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI3Njk3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMxODMzMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13944#discussion_r468318330", "bodyText": "One suggestion, write a for loop with UUID.randomUUID() and measure the time for each UUID generation, if the time looks good then go with UUID.randomUUID()\nint start = System.currentMillis();\nfor (int i = 0; i < 1_000_000; i++) {\n  UUID.randomUUID();\n}\nint end = System.currentMillis();\nSystem.out.println(end - start);\npreferably run this on a linux VM where you don't have mouse movements, etc, as those generate random entropy which is used by /dev/random which is used by UUID.randomUUID()", "author": "moderakh", "createdAt": "2020-08-11T04:23:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI3Njk3Mw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMxOTMwMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13944#discussion_r468319300", "bodyText": "what happens if a field of non String type is annotated with @ GeneratedValue do we support that? or do we error out?", "author": "moderakh", "createdAt": "2020-08-11T04:28:07Z", "path": "sdk/cosmos/azure-spring-data-cosmos-test/src/test/java/com/azure/spring/data/cosmos/domain/GenIdEntity.java", "diffHunk": "@@ -0,0 +1,70 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.spring.data.cosmos.domain;\n+\n+import com.azure.spring.data.cosmos.core.mapping.GeneratedValue;\n+import org.springframework.data.annotation.Id;\n+\n+import java.util.Objects;\n+\n+public class GenIdEntity {\n+\n+    @Id\n+    @GeneratedValue", "originalCommit": "6aab6aae818d363e840d3ec00231bddafd0fc292", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODczMzA5Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13944#discussion_r468733097", "bodyText": "We error it out that @GeneratedValue can only be used on a string id.", "author": "kushagraThapar", "createdAt": "2020-08-11T17:06:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMxOTMwMA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "3f01e14b29239fa4e416f43ae3aae90279a51892", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3f01e14b29239fa4e416f43ae3aae90279a51892", "message": "update README with feature description", "committedDate": "2020-08-11T16:42:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcyNTY5NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13944#discussion_r468725694", "bodyText": "Please add Microsoft headers to this file.", "author": "kushagraThapar", "createdAt": "2020-08-11T16:54:00Z", "path": "sdk/cosmos/azure-spring-data-cosmos-core/src/samples/java/com/azure/cosmos/GeneratedIdEntity.java", "diffHunk": "@@ -0,0 +1,12 @@\n+package com.azure.cosmos;", "originalCommit": "3f01e14b29239fa4e416f43ae3aae90279a51892", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODczMzE1Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13944#discussion_r468733153", "bodyText": "fixed", "author": "Blackbaud-EricSlater", "createdAt": "2020-08-11T17:06:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcyNTY5NA=="}], "type": "inlineReview", "revised_code": {"commit": "b8acb3d31fe653b27b7a058e8f0638a9643ce623", "chunk": "diff --git a/sdk/cosmos/azure-spring-data-cosmos-core/src/samples/java/com/azure/cosmos/GeneratedIdEntity.java b/sdk/cosmos/azure-spring-data-cosmos-core/src/samples/java/com/azure/cosmos/GeneratedIdEntity.java\nindex 5eeacb779bf..46edfccfc3f 100644\n--- a/sdk/cosmos/azure-spring-data-cosmos-core/src/samples/java/com/azure/cosmos/GeneratedIdEntity.java\n+++ b/sdk/cosmos/azure-spring-data-cosmos-core/src/samples/java/com/azure/cosmos/GeneratedIdEntity.java\n\n@@ -1,3 +1,5 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n package com.azure.cosmos;\n \n import com.azure.spring.data.cosmos.core.mapping.GeneratedValue;\n"}}, {"oid": "b8acb3d31fe653b27b7a058e8f0638a9643ce623", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b8acb3d31fe653b27b7a058e8f0638a9643ce623", "message": "add missing copyright header", "committedDate": "2020-08-11T17:06:05Z", "type": "commit"}, {"oid": "df77eb3fcc3f6227b4b66f076295be83ddb98cab", "url": "https://github.com/Azure/azure-sdk-for-java/commit/df77eb3fcc3f6227b4b66f076295be83ddb98cab", "message": "fix line nums in readme", "committedDate": "2020-08-11T19:47:53Z", "type": "commit"}, {"oid": "badc913cb0fe2ed284141da9e99e0460aa19c558", "url": "https://github.com/Azure/azure-sdk-for-java/commit/badc913cb0fe2ed284141da9e99e0460aa19c558", "message": "fix checkstyle issues", "committedDate": "2020-08-11T21:21:38Z", "type": "commit"}]}