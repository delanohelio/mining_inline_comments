{"pr_number": 9724, "pr_title": "Modified BlobOutputStream to wait on a condition variable until transfer is complete instead of polling", "pr_createdAt": "2020-03-31T21:25:54Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/9724", "timeline": [{"oid": "4083bb2dfc5528c8ee33d96ed16e569c3691c6f6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/4083bb2dfc5528c8ee33d96ed16e569c3691c6f6", "message": "changed polling to waiting on condition variables", "committedDate": "2020-03-31T21:24:06Z", "type": "commit"}, {"oid": "754e3a5a49cb59edb28010816f30e0632dbd5eb7", "url": "https://github.com/Azure/azure-sdk-for-java/commit/754e3a5a49cb59edb28010816f30e0632dbd5eb7", "message": "added changelog entry", "committedDate": "2020-03-31T21:24:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIyNTEzMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9724#discussion_r401225133", "bodyText": "What am i supposed to do here?", "author": "gapra-msft", "createdAt": "2020-03-31T21:26:15Z", "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/specialized/BlobOutputStream.java", "diffHunk": "@@ -183,14 +196,16 @@ void commit() {\n             sink.complete();\n \n             // Need to wait until the uploadTask completes\n+            lock.lock();\n             while (!complete) {\n                 try {\n-                    Thread.sleep(100L);\n+                    transferComplete.await();\n                 } catch (InterruptedException e) {\n-                    // Does this need to be caught by logger?\n-                    e.printStackTrace();\n+                    this.lastError = new IOException(e.getMessage());", "originalCommit": "754e3a5a49cb59edb28010816f30e0632dbd5eb7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1902a9f6c979f1bbfda3e4a1b5c4a62d9cfaa055", "chunk": "diff --git a/sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/specialized/BlobOutputStream.java b/sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/specialized/BlobOutputStream.java\nindex 813c76ef0c7..c818149ec23 100644\n--- a/sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/specialized/BlobOutputStream.java\n+++ b/sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/specialized/BlobOutputStream.java\n\n@@ -202,6 +208,7 @@ public abstract class BlobOutputStream extends StorageOutputStream {\n                     transferComplete.await();\n                 } catch (InterruptedException e) {\n                     this.lastError = new IOException(e.getMessage());\n+                    lock.unlock();\n                 }\n             }\n             lock.unlock();\n"}}, {"oid": "1902a9f6c979f1bbfda3e4a1b5c4a62d9cfaa055", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1902a9f6c979f1bbfda3e4a1b5c4a62d9cfaa055", "message": "release lock on exception", "committedDate": "2020-03-31T21:50:28Z", "type": "commit"}, {"oid": "872e2d190bdfb4d352d4841ab48a80a7e829cf30", "url": "https://github.com/Azure/azure-sdk-for-java/commit/872e2d190bdfb4d352d4841ab48a80a7e829cf30", "message": "removed unnecessary catch", "committedDate": "2020-03-31T22:21:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc2OTk2Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9724#discussion_r401769966", "bodyText": "Should I try catch the entire block on the lock and unlock if a generic exception is caught? Or do yall think CI is catching a false positive?", "author": "gapra-msft", "createdAt": "2020-04-01T17:01:51Z", "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/specialized/BlobOutputStream.java", "diffHunk": "@@ -174,7 +182,12 @@ private BlockBlobOutputStream(final BlobAsyncClient client,\n                     this.lastError = new IOException(e);\n                     return Mono.empty();\n                 })\n-                .doOnTerminate(() -> complete = true)\n+                .doOnTerminate(() -> {\n+                    lock.lock();\n+                    complete = true;\n+                    transferComplete.signal();", "originalCommit": "872e2d190bdfb4d352d4841ab48a80a7e829cf30", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5ca2a7b5536cf29f58093d25c2b4d34d234af997", "chunk": "diff --git a/sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/specialized/BlobOutputStream.java b/sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/specialized/BlobOutputStream.java\nindex ee77a5bb7e8..4d53e04f350 100644\n--- a/sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/specialized/BlobOutputStream.java\n+++ b/sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/specialized/BlobOutputStream.java\n\n@@ -184,28 +184,32 @@ public abstract class BlobOutputStream extends StorageOutputStream {\n                 })\n                 .doOnTerminate(() -> {\n                     lock.lock();\n-                    complete = true;\n-                    transferComplete.signal();\n-                    lock.unlock();\n+                    try {\n+                        complete = true;\n+                        transferComplete.signal();\n+                    } finally {\n+                        lock.unlock();\n+                    }\n                 })\n                 .subscribe();\n         }\n \n         @Override\n         void commit() {\n-            sink.complete();\n \n             // Need to wait until the uploadTask completes\n             lock.lock();\n-            while (!complete) {\n-                try {\n+            sink.complete(); /* Allow upload task to try to complete. */\n+            try {\n+                while (!complete) {\n                     transferComplete.await();\n-                } catch (InterruptedException e) {\n-                    this.lastError = new IOException(e.getMessage());\n-                    lock.unlock();\n                 }\n+            } catch (InterruptedException e) {\n+                this.lastError = new IOException(e.getMessage());\n+            } finally {\n+                lock.unlock();\n             }\n-            lock.unlock();\n+\n \n         }\n \n"}}, {"oid": "5ca2a7b5536cf29f58093d25c2b4d34d234af997", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5ca2a7b5536cf29f58093d25c2b4d34d234af997", "message": "added finally blocks", "committedDate": "2020-04-01T17:46:28Z", "type": "commit"}, {"oid": "ce2ceec8564c467c69ac85c095f053c8eff8ff4b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ce2ceec8564c467c69ac85c095f053c8eff8ff4b", "message": "added more stuff into finally", "committedDate": "2020-04-01T18:26:25Z", "type": "commit"}, {"oid": "154243af972832c54ce7977c97740ff56cc819ba", "url": "https://github.com/Azure/azure-sdk-for-java/commit/154243af972832c54ce7977c97740ff56cc819ba", "message": "Merge branch 'master' into storage/blobOutputStreamPolling", "committedDate": "2020-04-03T17:39:11Z", "type": "commit"}]}