{"pr_number": 10468, "pr_title": "Addressing leak in KeyVaultCredentailPolicy.", "pr_createdAt": "2020-04-23T21:06:35Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/10468", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDEzMjExMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10468#discussion_r414132113", "bodyText": "Should this throwable be logged as warning?", "author": "srnagar", "createdAt": "2020-04-23T21:20:17Z", "path": "sdk/keyvault/azure-security-keyvault-secrets/src/main/java/com/azure/security/keyvault/secrets/implementation/KeyVaultCredentialPolicy.java", "diffHunk": "@@ -52,8 +52,20 @@ public KeyVaultCredentialPolicy(TokenCredential credential) {\n             return Mono.error(new RuntimeException(\"Token credentials require a URL using the HTTPS protocol scheme\"));\n         }\n         return next.clone().process()\n-            // Ignore body\n-            .doOnNext(HttpResponse::close)\n+            .doOnNext(httpResponse -> {\n+                // KV follows challenge based auth. Currently every service\n+                // call hit the endpoint for challenge and then resend the\n+                // request with token. The challenge response body is not\n+                // consumed, not draining/closing the body will result in leak.\n+                // Ref: https://github.com/Azure/azure-sdk-for-java/issues/7934\n+                try {\n+                    httpResponse.getBody().subscribe().dispose();\n+                } catch (Throwable ignored) {", "originalCommit": "5ed702a781bddca0d9ac7b1f7416bd7e18f8319f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDEzODU0NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10468#discussion_r414138545", "bodyText": "yes, we should, will update the PR. It's not throwing now but I put it as a safeguard to ensure this version of key vault lib works with the future version of reactor-netty HTTP client when it gets addressed in the core level.", "author": "anuchandy", "createdAt": "2020-04-23T21:32:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDEzMjExMw=="}], "type": "inlineReview", "revised_code": {"commit": "ac0538f345a5d7aec6bd3e6cdf2d1fbf5aba8ef0", "chunk": "diff --git a/sdk/keyvault/azure-security-keyvault-secrets/src/main/java/com/azure/security/keyvault/secrets/implementation/KeyVaultCredentialPolicy.java b/sdk/keyvault/azure-security-keyvault-secrets/src/main/java/com/azure/security/keyvault/secrets/implementation/KeyVaultCredentialPolicy.java\nindex ba800d2256c..ddf4c1c267c 100644\n--- a/sdk/keyvault/azure-security-keyvault-secrets/src/main/java/com/azure/security/keyvault/secrets/implementation/KeyVaultCredentialPolicy.java\n+++ b/sdk/keyvault/azure-security-keyvault-secrets/src/main/java/com/azure/security/keyvault/secrets/implementation/KeyVaultCredentialPolicy.java\n\n@@ -58,9 +60,11 @@ public final class KeyVaultCredentialPolicy implements HttpPipelinePolicy {\n                 // request with token. The challenge response body is not\n                 // consumed, not draining/closing the body will result in leak.\n                 // Ref: https://github.com/Azure/azure-sdk-for-java/issues/7934\n+                //      https://github.com/Azure/azure-sdk-for-java/issues/10467\n                 try {\n                     httpResponse.getBody().subscribe().dispose();\n-                } catch (Throwable ignored) {\n+                } catch (RuntimeException ignored) {\n+                    logger.logExceptionAsWarning(ignored);\n                 }\n                 // The ReactorNettyHttpResponse::close() should be sufficient\n                 // and should take care similar body disposal but looks like that\n"}}, {"oid": "ac0538f345a5d7aec6bd3e6cdf2d1fbf5aba8ef0", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ac0538f345a5d7aec6bd3e6cdf2d1fbf5aba8ef0", "message": "Addressing leak in KeyVaultCredentailPolicy.", "committedDate": "2020-04-23T22:44:47Z", "type": "commit"}, {"oid": "ac0538f345a5d7aec6bd3e6cdf2d1fbf5aba8ef0", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ac0538f345a5d7aec6bd3e6cdf2d1fbf5aba8ef0", "message": "Addressing leak in KeyVaultCredentailPolicy.", "committedDate": "2020-04-23T22:44:47Z", "type": "forcePushed"}]}