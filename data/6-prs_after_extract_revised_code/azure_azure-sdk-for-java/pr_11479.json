{"pr_number": 11479, "pr_title": "Merged CosmosAsyncStoredProcedureResponse and CosmosStoredProcedureResponse types", "pr_createdAt": "2020-05-27T19:58:50Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/11479", "timeline": [{"oid": "3f433a4425761816a7a30223491aa9db369d97c6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3f433a4425761816a7a30223491aa9db369d97c6", "message": "Merged CosmosAsyncStoredProcedureResponse and CosmosStoredProcedureResponse types", "committedDate": "2020-05-27T19:58:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQxMDU1OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11479#discussion_r431410558", "bodyText": "the args indentation should be the same.", "author": "moderakh", "createdAt": "2020-05-27T20:04:12Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/ModelBridgeInternal.java", "diffHunk": "@@ -104,16 +103,16 @@ public static CosmosAsyncPermissionResponse createCosmosAsyncPermissionResponse(\n     }\n \n     @Warning(value = INTERNAL_USE_ONLY_WARNING)\n-    public static CosmosAsyncStoredProcedureResponse createCosmosAsyncStoredProcedureResponse(ResourceResponse<StoredProcedure> response,\n-                                                                                              CosmosAsyncContainer cosmosContainer) {\n-        return new CosmosAsyncStoredProcedureResponse(response, cosmosContainer);\n+    public static CosmosStoredProcedureResponse createCosmosStoredProcedureResponse(ResourceResponse<StoredProcedure> response,\n+                                                                                         CosmosAsyncContainer cosmosContainer) {", "originalCommit": "3f433a4425761816a7a30223491aa9db369d97c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ2OTU2OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11479#discussion_r431469568", "bodyText": "Done.", "author": "kushagraThapar", "createdAt": "2020-05-27T22:05:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQxMDU1OA=="}], "type": "inlineReview", "revised_code": {"commit": "c3f107787323feaf323b357c2cd1c1e53f7d3115", "chunk": "diff --git a/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/ModelBridgeInternal.java b/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/ModelBridgeInternal.java\nindex e7a67c2741f..dfec00ada67 100644\n--- a/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/ModelBridgeInternal.java\n+++ b/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/ModelBridgeInternal.java\n\n@@ -103,15 +103,12 @@ public final class ModelBridgeInternal {\n     }\n \n     @Warning(value = INTERNAL_USE_ONLY_WARNING)\n-    public static CosmosStoredProcedureResponse createCosmosStoredProcedureResponse(ResourceResponse<StoredProcedure> response,\n-                                                                                         CosmosAsyncContainer cosmosContainer) {\n+    public static CosmosStoredProcedureResponse createCosmosStoredProcedureResponse(ResourceResponse<StoredProcedure> response) {\n         return new CosmosStoredProcedureResponse(response);\n     }\n \n     @Warning(value = INTERNAL_USE_ONLY_WARNING)\n-    public static CosmosStoredProcedureResponse createCosmosStoredProcedureResponse(StoredProcedureResponse response,\n-                                                                                         CosmosAsyncContainer cosmosContainer,\n-                                                                                         String storedProcedureId) {\n+    public static CosmosStoredProcedureResponse createCosmosStoredProcedureResponse(StoredProcedureResponse response) {\n         return new CosmosStoredProcedureResponse(response);\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQxMDU5NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11479#discussion_r431410594", "bodyText": "the args indentation should be the same.", "author": "moderakh", "createdAt": "2020-05-27T20:04:17Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/ModelBridgeInternal.java", "diffHunk": "@@ -104,16 +103,16 @@ public static CosmosAsyncPermissionResponse createCosmosAsyncPermissionResponse(\n     }\n \n     @Warning(value = INTERNAL_USE_ONLY_WARNING)\n-    public static CosmosAsyncStoredProcedureResponse createCosmosAsyncStoredProcedureResponse(ResourceResponse<StoredProcedure> response,\n-                                                                                              CosmosAsyncContainer cosmosContainer) {\n-        return new CosmosAsyncStoredProcedureResponse(response, cosmosContainer);\n+    public static CosmosStoredProcedureResponse createCosmosStoredProcedureResponse(ResourceResponse<StoredProcedure> response,\n+                                                                                         CosmosAsyncContainer cosmosContainer) {\n+        return new CosmosStoredProcedureResponse(response);\n     }\n \n     @Warning(value = INTERNAL_USE_ONLY_WARNING)\n-    public static CosmosAsyncStoredProcedureResponse createCosmosAsyncStoredProcedureResponse(StoredProcedureResponse response,\n-                                                                                              CosmosAsyncContainer cosmosContainer,\n-                                                                                              String storedProcedureId) {\n-        return new CosmosAsyncStoredProcedureResponse(response, cosmosContainer, storedProcedureId);\n+    public static CosmosStoredProcedureResponse createCosmosStoredProcedureResponse(StoredProcedureResponse response,\n+                                                                                         CosmosAsyncContainer cosmosContainer,", "originalCommit": "3f433a4425761816a7a30223491aa9db369d97c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ2OTU5Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11479#discussion_r431469592", "bodyText": "Done.", "author": "kushagraThapar", "createdAt": "2020-05-27T22:05:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQxMDU5NA=="}], "type": "inlineReview", "revised_code": {"commit": "c3f107787323feaf323b357c2cd1c1e53f7d3115", "chunk": "diff --git a/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/ModelBridgeInternal.java b/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/ModelBridgeInternal.java\nindex e7a67c2741f..dfec00ada67 100644\n--- a/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/ModelBridgeInternal.java\n+++ b/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/ModelBridgeInternal.java\n\n@@ -103,15 +103,12 @@ public final class ModelBridgeInternal {\n     }\n \n     @Warning(value = INTERNAL_USE_ONLY_WARNING)\n-    public static CosmosStoredProcedureResponse createCosmosStoredProcedureResponse(ResourceResponse<StoredProcedure> response,\n-                                                                                         CosmosAsyncContainer cosmosContainer) {\n+    public static CosmosStoredProcedureResponse createCosmosStoredProcedureResponse(ResourceResponse<StoredProcedure> response) {\n         return new CosmosStoredProcedureResponse(response);\n     }\n \n     @Warning(value = INTERNAL_USE_ONLY_WARNING)\n-    public static CosmosStoredProcedureResponse createCosmosStoredProcedureResponse(StoredProcedureResponse response,\n-                                                                                         CosmosAsyncContainer cosmosContainer,\n-                                                                                         String storedProcedureId) {\n+    public static CosmosStoredProcedureResponse createCosmosStoredProcedureResponse(StoredProcedureResponse response) {\n         return new CosmosStoredProcedureResponse(response);\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQxMTg1Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11479#discussion_r431411857", "bodyText": "This passes async version to the constructor of the sync version. This should be required only by implementation not public api right?\nI think the constructor should be package private.", "author": "moderakh", "createdAt": "2020-05-27T20:06:54Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosStoredProcedure.java", "diffHunk": "@@ -14,20 +14,16 @@\n  */\n public class CosmosStoredProcedure {\n     private final String id;\n-    private final CosmosContainer container;\n     private final CosmosAsyncStoredProcedure storedProcedure;\n \n     /**\n      * Instantiates a new Cosmos sync stored procedure.\n      *\n      * @param id the id\n-     * @param container the container\n      * @param storedProcedure the stored procedure\n      */\n-    public CosmosStoredProcedure(String id, CosmosContainer container, CosmosAsyncStoredProcedure storedProcedure) {\n-\n+    public CosmosStoredProcedure(String id, CosmosAsyncStoredProcedure storedProcedure) {", "originalCommit": "3f433a4425761816a7a30223491aa9db369d97c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ2OTY0OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11479#discussion_r431469648", "bodyText": "Changed to package-private.", "author": "kushagraThapar", "createdAt": "2020-05-27T22:05:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQxMTg1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "c3f107787323feaf323b357c2cd1c1e53f7d3115", "chunk": "diff --git a/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosStoredProcedure.java b/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosStoredProcedure.java\nindex c0f3f7f6f9a..a91863d87c0 100644\n--- a/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosStoredProcedure.java\n+++ b/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosStoredProcedure.java\n\n@@ -22,7 +22,7 @@ public class CosmosStoredProcedure {\n      * @param id the id\n      * @param storedProcedure the stored procedure\n      */\n-    public CosmosStoredProcedure(String id, CosmosAsyncStoredProcedure storedProcedure) {\n+    CosmosStoredProcedure(String id, CosmosAsyncStoredProcedure storedProcedure) {\n         this.id = id;\n         this.storedProcedure = storedProcedure;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQxMjU4NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11479#discussion_r431412584", "bodyText": "why isn't this needed anymore? in the absence of this method does the code throw the valid type of exception (if any failure)?", "author": "moderakh", "createdAt": "2020-05-27T20:08:29Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosScripts.java", "diffHunk": "@@ -236,42 +230,6 @@ public CosmosTrigger getTrigger(String id) {\n                                  asyncScripts.getTrigger(id));\n     }\n \n-    /**\n-     * Map stored procedure response and block cosmos sync stored procedure response.\n-     *\n-     * @param storedProcedureResponseMono the stored procedure response mono\n-     * @return the cosmos sync stored procedure response\n-     */\n-    CosmosStoredProcedureResponse mapStoredProcedureResponseAndBlock(", "originalCommit": "3f433a4425761816a7a30223491aa9db369d97c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ2OTgzMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11479#discussion_r431469833", "bodyText": "It will still throw the valid exception type. That was just wrapping the exception to CosmosException, which is what originally gets thrown by async APIs.", "author": "kushagraThapar", "createdAt": "2020-05-27T22:06:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQxMjU4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ5NzQzMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11479#discussion_r431497432", "bodyText": "do we have tests to validate that?", "author": "moderakh", "createdAt": "2020-05-27T23:22:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQxMjU4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ5OTUxNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11479#discussion_r431499516", "bodyText": "I reverted the change in the latest iteration to make sure we are consistent with exceptions across the SDK. Thanks for bringing this up.\nWill also add tests to check the exception type.", "author": "kushagraThapar", "createdAt": "2020-05-27T23:29:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQxMjU4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ5OTU2Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11479#discussion_r431499566", "bodyText": "In another follow up PR.", "author": "kushagraThapar", "createdAt": "2020-05-27T23:29:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQxMjU4NA=="}], "type": "inlineReview", "revised_code": {"commit": "5365f846ff63d75f12367c2beade69ef3d07a4b0", "chunk": "diff --git a/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosScripts.java b/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosScripts.java\nindex 91cc49de056..8d46bbc8ca3 100644\n--- a/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosScripts.java\n+++ b/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosScripts.java\n\n@@ -230,6 +235,26 @@ public class CosmosScripts {\n                                  asyncScripts.getTrigger(id));\n     }\n \n+    /**\n+     * Map stored procedure response and block cosmos sync stored procedure response.\n+     *\n+     * @param storedProcedureResponseMono the stored procedure response mono\n+     * @return the cosmos sync stored procedure response\n+     */\n+    CosmosStoredProcedureResponse mapStoredProcedureResponseAndBlock(\n+        Mono<CosmosStoredProcedureResponse> storedProcedureResponseMono) {\n+        try {\n+            return storedProcedureResponseMono.block();\n+        } catch (Exception ex) {\n+            final Throwable throwable = Exceptions.unwrap(ex);\n+            if (throwable instanceof CosmosException) {\n+                throw (CosmosException) throwable;\n+            } else {\n+                throw ex;\n+            }\n+        }\n+    }\n+\n     /**\n      * Map udf response and block cosmos sync user defined function response.\n      *\n"}}, {"oid": "c3f107787323feaf323b357c2cd1c1e53f7d3115", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c3f107787323feaf323b357c2cd1c1e53f7d3115", "message": "Removed unused arguments from APIs for cosmos stored procedure response", "committedDate": "2020-05-27T22:05:03Z", "type": "commit"}, {"oid": "5365f846ff63d75f12367c2beade69ef3d07a4b0", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5365f846ff63d75f12367c2beade69ef3d07a4b0", "message": "Reverted change for exception handling for stored procedure response", "committedDate": "2020-05-27T23:28:54Z", "type": "commit"}]}