{"pr_number": 9863, "pr_title": "Support for receiving events in batches in processor client", "pr_createdAt": "2020-04-04T03:13:59Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/9863", "timeline": [{"oid": "2700c314a3fc2c95878f970e712be153fd8dbcbe", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2700c314a3fc2c95878f970e712be153fd8dbcbe", "message": "Support for receiving events in batches in processor client", "committedDate": "2020-04-04T03:10:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ4NzcyMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9863#discussion_r403487722", "bodyText": "What happens if they set Duration.ZERO? Would we try the window timeout approach?", "author": "conniey", "createdAt": "2020-04-04T16:20:25Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/PartitionPumpManager.java", "diffHunk": "@@ -146,17 +160,38 @@ void startPartitionPump(PartitionOwnership claimedOwnership, Checkpoint checkpoi\n                 .createConsumer(claimedOwnership.getConsumerGroup(), EventHubClientBuilder.DEFAULT_PREFETCH_COUNT);\n \n             partitionPumps.put(claimedOwnership.getPartitionId(), eventHubConsumer);\n-            eventHubConsumer\n-                .receiveFromPartition(claimedOwnership.getPartitionId(), startFromEventPosition, receiveOptions)\n-                .subscribe(partitionEvent -> processEvent(partitionContext, partitionProcessor, eventHubConsumer,\n-                    partitionEvent),\n-                    /* EventHubConsumer receive() returned an error */\n-                    ex -> handleError(claimedOwnership, eventHubConsumer, partitionProcessor, ex, partitionContext),\n-                    () -> {\n-                        partitionProcessor.close(new CloseContext(partitionContext,\n-                            CloseReason.EVENT_PROCESSOR_SHUTDOWN));\n-                        cleanup(claimedOwnership, eventHubConsumer);\n-                    });\n+            if (maxWaitTime != null) {", "originalCommit": "2700c314a3fc2c95878f970e712be153fd8dbcbe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzUyNDM0Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9863#discussion_r403524347", "bodyText": "Added validation to check that duration is not zero and also switched to window timeout as that seems like the more suited operator here.", "author": "srnagar", "createdAt": "2020-04-04T21:32:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ4NzcyMg=="}], "type": "inlineReview", "revised_code": {"commit": "523ae1b3aedb6a05d01c6ef16704cb291f0c118b", "chunk": "diff --git a/sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/PartitionPumpManager.java b/sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/PartitionPumpManager.java\nindex f9213b01bc8..eb4839be64e 100644\n--- a/sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/PartitionPumpManager.java\n+++ b/sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/PartitionPumpManager.java\n\n@@ -163,7 +164,8 @@ class PartitionPumpManager {\n             if (maxWaitTime != null) {\n                 eventHubConsumer\n                     .receiveFromPartition(claimedOwnership.getPartitionId(), startFromEventPosition, receiveOptions)\n-                    .bufferTimeout(maxBatchSize, maxWaitTime)\n+                    .windowTimeout(maxBatchSize, maxWaitTime)\n+                    .flatMap(Flux::collectList)\n                     .subscribe(partitionEventBatch -> {\n                             processEventBatch(partitionContext, partitionProcessor,\n                                 eventHubConsumer, partitionEventBatch);\n"}}, {"oid": "523ae1b3aedb6a05d01c6ef16704cb291f0c118b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/523ae1b3aedb6a05d01c6ef16704cb291f0c118b", "message": "Code snippets and unit tests", "committedDate": "2020-04-04T21:31:06Z", "type": "commit"}, {"oid": "4625abc8d177cc926a5166aee14ec355119dec3d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/4625abc8d177cc926a5166aee14ec355119dec3d", "message": "Fix checkstyle", "committedDate": "2020-04-05T23:56:19Z", "type": "commit"}, {"oid": "2015fdd4c043bc041cf110d8d997cc756c0c7839", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2015fdd4c043bc041cf110d8d997cc756c0c7839", "message": "Fix spotbugs", "committedDate": "2020-04-06T04:43:11Z", "type": "commit"}]}