{"pr_number": 8762, "pr_title": "Add Azure Cli credentials to Identity", "pr_createdAt": "2020-03-05T16:44:26Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/8762", "timeline": [{"oid": "7af8824d488e7ceaebb7d8eee482caadf163d9df", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7af8824d488e7ceaebb7d8eee482caadf163d9df", "message": "Add CliCredential (#6842)", "committedDate": "2020-03-02T18:29:02Z", "type": "commit"}, {"oid": "b5f0b7474782ae4b7eab50302a4d90e6e97a8ebb", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b5f0b7474782ae4b7eab50302a4d90e6e97a8ebb", "message": "add safe working directory + checkstyle and spotbugs fixes", "committedDate": "2020-03-05T06:32:18Z", "type": "commit"}, {"oid": "0abd6c93e242ff4fb30951da0a7453b34eea3c99", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0abd6c93e242ff4fb30951da0a7453b34eea3c99", "message": "redact cli token in error output", "committedDate": "2020-03-05T16:24:00Z", "type": "commit"}, {"oid": "6b3d1385e71e31dfc0caca1eb0b929ca3788e35f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6b3d1385e71e31dfc0caca1eb0b929ca3788e35f", "message": "Merge remote-tracking branch 'upstream/master' into cli_credentials", "committedDate": "2020-03-05T16:40:14Z", "type": "commit"}, {"oid": "99fe46bcde837dd3dd3dfd2aa90ab8f6c4bca650", "url": "https://github.com/Azure/azure-sdk-for-java/commit/99fe46bcde837dd3dd3dfd2aa90ab8f6c4bca650", "message": "update identity client", "committedDate": "2020-03-05T16:49:30Z", "type": "commit"}, {"oid": "4599f5dee06ba61509f5e95e9a6c27bfdd6736d4", "url": "https://github.com/Azure/azure-sdk-for-java/commit/4599f5dee06ba61509f5e95e9a6c27bfdd6736d4", "message": "update credential", "committedDate": "2020-03-09T05:16:49Z", "type": "commit"}, {"oid": "b357a43b6996e61bef0be9383d2bbfb724faa476", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b357a43b6996e61bef0be9383d2bbfb724faa476", "message": "add safe working dir logic", "committedDate": "2020-03-09T21:24:49Z", "type": "commit"}, {"oid": "5f5c2fea9179475fc035d1ef120a553a1cf2b7c8", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5f5c2fea9179475fc035d1ef120a553a1cf2b7c8", "message": "Merge remote-tracking branch 'upstream/master' into cli_credentials", "committedDate": "2020-03-09T22:23:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk5Nzc2Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8762#discussion_r389997767", "bodyText": "Here we need to validate the scope passed in doesn't contain any characters which could cause us to execute something unintended. See https://github.com/Azure/azure-sdk-for-net/blob/23cc9455cf501d6a65ce8faaedb27242b27c3b51/sdk/identity/Azure.Identity/src/ScopeUtilities.cs#L46-L54", "author": "schaabs", "createdAt": "2020-03-09T22:32:25Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/IdentityClient.java", "diffHunk": "@@ -122,6 +140,97 @@\n         }\n     }\n \n+    /**\n+     * Asynchronously acquire a token from Active Directory with Azure CLI.\n+     *\n+     * @param request the details of the token request\n+     * @return a Publisher that emits an AccessToken\n+     */\n+    public Mono<AccessToken> authenticateWithAzureCli(TokenRequestContext request) {\n+        String azCommand = \"az account get-access-token --output json --resource \";\n+\n+        StringBuilder command = new StringBuilder();\n+        command.append(azCommand);\n+        String scopes = ScopeUtil.scopesToResource(request.getScopes());\n+        command.append(scopes);", "originalCommit": "5f5c2fea9179475fc035d1ef120a553a1cf2b7c8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c97468642cf93c200e4800a440a4db77388dc4f1", "chunk": "diff --git a/sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/IdentityClient.java b/sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/IdentityClient.java\nindex 34fc26ec97d..e8121f7263b 100644\n--- a/sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/IdentityClient.java\n+++ b/sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/IdentityClient.java\n\n@@ -151,7 +151,15 @@ public class IdentityClient {\n \n         StringBuilder command = new StringBuilder();\n         command.append(azCommand);\n+\n         String scopes = ScopeUtil.scopesToResource(request.getScopes());\n+\n+        try {\n+            ScopeUtil.validateScope(scopes);\n+        } catch (IllegalArgumentException ex) {\n+            return Mono.error(logger.logExceptionAsError(ex));\n+        }\n+\n         command.append(scopes);\n     \n         AccessToken token = null;\n"}}, {"oid": "c97468642cf93c200e4800a440a4db77388dc4f1", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c97468642cf93c200e4800a440a4db77388dc4f1", "message": "add scope validation", "committedDate": "2020-03-10T00:16:40Z", "type": "commit"}, {"oid": "570701c552ac2933a0527a7f7001116ac49856f3", "url": "https://github.com/Azure/azure-sdk-for-java/commit/570701c552ac2933a0527a7f7001116ac49856f3", "message": "Merge remote-tracking branch 'upstream/master' into cli_credentials", "committedDate": "2020-03-10T15:17:30Z", "type": "commit"}, {"oid": "98cc23a85eca23e90614787a9d1b724032b5a281", "url": "https://github.com/Azure/azure-sdk-for-java/commit/98cc23a85eca23e90614787a9d1b724032b5a281", "message": "update changelog", "committedDate": "2020-03-10T15:25:45Z", "type": "commit"}, {"oid": "8ca7bb109ad707ea10529d0a78e2935f8a22b633", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8ca7bb109ad707ea10529d0a78e2935f8a22b633", "message": "update logic", "committedDate": "2020-03-10T15:36:35Z", "type": "commit"}]}