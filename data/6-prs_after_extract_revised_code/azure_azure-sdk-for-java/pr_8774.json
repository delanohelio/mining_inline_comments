{"pr_number": 8774, "pr_title": "Reliable download fix", "pr_createdAt": "2020-03-06T00:15:17Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/8774", "timeline": [{"oid": "6318b992ccec1bc8255f0bc4d88d223cf31f5981", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6318b992ccec1bc8255f0bc4d88d223cf31f5981", "message": "Fixed a bug in reliable download and added support for timeout exception", "committedDate": "2020-03-04T23:17:29Z", "type": "commit"}, {"oid": "3c20b9474f188c99153e1aec702e28e23d94a666", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3c20b9474f188c99153e1aec702e28e23d94a666", "message": "Added timeouts to reliable download stream", "committedDate": "2020-03-05T23:50:24Z", "type": "commit"}, {"oid": "3601af0145328f41dfb93e458b3cdf03beda1287", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3601af0145328f41dfb93e458b3cdf03beda1287", "message": "Minor updates", "committedDate": "2020-03-06T00:14:57Z", "type": "commit"}, {"oid": "bf6928a58b7789403545cbea21c0aee5211e9abe", "url": "https://github.com/Azure/azure-sdk-for-java/commit/bf6928a58b7789403545cbea21c0aee5211e9abe", "message": "Checkstyle", "committedDate": "2020-03-06T00:45:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcyNjM1MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8774#discussion_r388726351", "bodyText": "So the retryCount is global for the Download not per read() invocation?", "author": "anuchandy", "createdAt": "2020-03-06T06:02:17Z", "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/specialized/ReliableDownload.java", "diffHunk": "@@ -67,15 +70,16 @@ BlobDownloadHeaders getDeserializedHeaders() {\n         add 1 before calling into tryContinueFlux, we set the initial value to -1.\n          */\n         Flux<ByteBuffer> value = (options.getMaxRetryRequests() == 0)\n-            ? rawResponse.getValue()\n+            ? rawResponse.getValue().timeout(TIMEOUT_VALUE)\n             : applyReliableDownload(rawResponse.getValue(), -1, options);\n \n         return value.switchIfEmpty(Flux.just(ByteBuffer.wrap(new byte[0])));\n     }\n \n     private Flux<ByteBuffer> tryContinueFlux(Throwable t, int retryCount, DownloadRetryOptions options) {\n-        // If all the errors are exhausted, return this error to the user.\n-        if (retryCount > options.getMaxRetryRequests() || !(t instanceof IOException)) {\n+        // If all the errors are exhausted or the error is not retryable, return this error to the user.\n+        if (retryCount >= options.getMaxRetryRequests()", "originalCommit": "bf6928a58b7789403545cbea21c0aee5211e9abe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTAyNzMxNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8774#discussion_r389027314", "bodyText": "It is as I've coded it here. I picked this a little bit arbitrarily. Since this was easier/faster and both of us seemed a little unsure that one option was strictly better than the other, I figured sticking with the existing plan would make it more likely to be ready to ship next week. We also see these stale streams pretty rarely, and I think even one retry per download operation is enough in the vast vast majority of cases. If you feel strongly that resetting the count on each successful item is better or if we see some Timeouts still trickling through, I can update it in a later release.", "author": "rickle-msft", "createdAt": "2020-03-06T17:03:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcyNjM1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA0OTc5OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8774#discussion_r389049798", "bodyText": "sounds good.", "author": "anuchandy", "createdAt": "2020-03-06T17:46:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcyNjM1MQ=="}], "type": "inlineReview", "revised_code": null}]}