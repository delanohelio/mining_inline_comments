{"pr_number": 16893, "pr_title": "Fixed bug where BlobInputStream would not etag lock", "pr_createdAt": "2020-10-27T20:03:25Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/16893", "timeline": [{"oid": "3b9192f61fc7c1788cc4a48e02f38baf34fb56eb", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3b9192f61fc7c1788cc4a48e02f38baf34fb56eb", "message": "Fixed bug where BlobInputStream would not etag lock", "committedDate": "2020-10-27T20:02:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzAxNDU5Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16893#discussion_r513014596", "bodyText": "I think we should also check that there aren't existing etag conditions. If they pass in an old etag that they want to target, and we just got a new one possibly after some updates, we might not be reading the version they requested.", "author": "rickle-msft", "createdAt": "2020-10-27T20:38:19Z", "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/specialized/BlobClientBase.java", "diffHunk": "@@ -247,11 +247,18 @@ public final BlobInputStream openInputStream(BlobRange range, BlobRequestConditi\n      */\n     public BlobInputStream openInputStream(BlobInputStreamOptions options) {\n         options = options == null ? new BlobInputStreamOptions() : options;\n+\n+        BlobProperties properties = getProperties();\n+\n         BlobRange range = options.getRange() == null ? new BlobRange(0) : options.getRange();\n         int chunkSize = options.getBlockSize() == null ? 4 * Constants.MB : options.getBlockSize();\n \n+        BlobRequestConditions requestConditions = options.getRequestConditions() == null\n+            ? new BlobRequestConditions() : options.getRequestConditions();\n+        requestConditions.setIfMatch(properties.getETag());", "originalCommit": "3b9192f61fc7c1788cc4a48e02f38baf34fb56eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzAxNTE1Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16893#discussion_r513015153", "bodyText": "Yeah makes sense", "author": "gapra-msft", "createdAt": "2020-10-27T20:39:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzAxNDU5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzAxNjM3MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16893#discussion_r513016370", "bodyText": "Fixed.", "author": "gapra-msft", "createdAt": "2020-10-27T20:41:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzAxNDU5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "d64d60f2f76fc16891f0365f34820ef3d8142a93", "chunk": "diff --git a/sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/specialized/BlobClientBase.java b/sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/specialized/BlobClientBase.java\nindex 7ccd190b7bc..274bb004671 100644\n--- a/sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/specialized/BlobClientBase.java\n+++ b/sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/specialized/BlobClientBase.java\n\n@@ -255,7 +255,10 @@ public class BlobClientBase {\n \n         BlobRequestConditions requestConditions = options.getRequestConditions() == null\n             ? new BlobRequestConditions() : options.getRequestConditions();\n-        requestConditions.setIfMatch(properties.getETag());\n+        // Target the user specified version by default. If not provided, target the latest version.\n+        if (requestConditions.getIfMatch() == null) {\n+            requestConditions.setIfMatch(properties.getETag());\n+        }\n \n         return new BlobInputStream(client, range.getOffset(), range.getCount(), chunkSize,\n             requestConditions, properties);\n"}}, {"oid": "d64d60f2f76fc16891f0365f34820ef3d8142a93", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d64d60f2f76fc16891f0365f34820ef3d8142a93", "message": "Only set if match if not already set", "committedDate": "2020-10-27T20:41:09Z", "type": "commit"}]}