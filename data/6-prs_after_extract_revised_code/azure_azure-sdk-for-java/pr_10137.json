{"pr_number": 10137, "pr_title": "Fixed the failure of search nightly CI build", "pr_createdAt": "2020-04-13T17:40:58Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/10137", "timeline": [{"oid": "331d69658989989abc38766039814570f2e52da8", "url": "https://github.com/Azure/azure-sdk-for-java/commit/331d69658989989abc38766039814570f2e52da8", "message": "Fixed the failure of aggregate report", "committedDate": "2020-04-13T17:42:02Z", "type": "commit"}, {"oid": "331d69658989989abc38766039814570f2e52da8", "url": "https://github.com/Azure/azure-sdk-for-java/commit/331d69658989989abc38766039814570f2e52da8", "message": "Fixed the failure of aggregate report", "committedDate": "2020-04-13T17:42:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY0NzYzNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10137#discussion_r407647636", "bodyText": "You'll want to move this into the getBodyAsString overload without parameters, nothing I've found in Azure Core leverages the Charset overload.", "author": "alzimmermsft", "createdAt": "2020-04-13T18:47:26Z", "path": "sdk/core/azure-core-test/src/main/java/com/azure/core/test/http/MockHttpResponse.java", "diffHunk": "@@ -182,7 +182,7 @@ public HttpHeaders getHeaders() {\n \n         return bodyBytes == null\n                 ? Mono.empty()\n-                : Mono.just(new String(bodyBytes, charset));\n+                : Mono.just(CoreUtils.bomAwareToString(bodyBytes, getHeaderValue(\"Content-Type\")));", "originalCommit": "331d69658989989abc38766039814570f2e52da8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY0ODUyMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10137#discussion_r407648522", "bodyText": "public Mono<String> getBodyAsString() {\n  return (bodyBytes == null)\n    ? Mono.empty()\n    : Mono.just(CoreUtils.bomAwareToString(bodyBytes, getHeaderValue(\"Content-Type\"));\n}", "author": "alzimmermsft", "createdAt": "2020-04-13T18:48:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY0NzYzNg=="}], "type": "inlineReview", "revised_code": {"commit": "32ace2dcbde31204c592ba836dd8150f184561f3", "chunk": "diff --git a/sdk/core/azure-core-test/src/main/java/com/azure/core/test/http/MockHttpResponse.java b/sdk/core/azure-core-test/src/main/java/com/azure/core/test/http/MockHttpResponse.java\nindex 8449a4aaf4e..11e8060e009 100644\n--- a/sdk/core/azure-core-test/src/main/java/com/azure/core/test/http/MockHttpResponse.java\n+++ b/sdk/core/azure-core-test/src/main/java/com/azure/core/test/http/MockHttpResponse.java\n\n@@ -182,7 +184,7 @@ public class MockHttpResponse extends HttpResponse {\n \n         return bodyBytes == null\n                 ? Mono.empty()\n-                : Mono.just(CoreUtils.bomAwareToString(bodyBytes, getHeaderValue(\"Content-Type\")));\n+                : Mono.just(new String(bodyBytes, charset));\n     }\n \n     /**\n"}}, {"oid": "32ace2dcbde31204c592ba836dd8150f184561f3", "url": "https://github.com/Azure/azure-sdk-for-java/commit/32ace2dcbde31204c592ba836dd8150f184561f3", "message": "Addressed feeback", "committedDate": "2020-04-13T18:53:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY5MzU4MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10137#discussion_r407693581", "bodyText": "If create succeeded, then you can break out of the do-while loop.", "author": "srnagar", "createdAt": "2020-04-13T20:14:08Z", "path": "sdk/search/azure-search-documents/src/test/java/com/azure/search/documents/test/environment/setup/AzureSearchResources.java", "diffHunk": "@@ -114,13 +115,21 @@ public void createService(TestResourceNamer testResourceNamer) {\n         System.out.println(\"Creating Azure Cognitive Search service: \" + searchServiceName);\n         int recreateCount = 0;\n         do {\n-            searchService = azure.searchServices()\n-                .define(searchServiceName)\n-                .withRegion(location)\n-                .withExistingResourceGroup(resourceGroup)\n-                .withFreeSku()\n-                .create();\n-            recreateCount += 1;\n+            try {\n+                searchService = azure.searchServices()\n+                    .define(searchServiceName)\n+                    .withRegion(location)\n+                    .withExistingResourceGroup(resourceGroup)\n+                    .withFreeSku()\n+                    .create();", "originalCommit": "32ace2dcbde31204c592ba836dd8150f184561f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzcxMTkzMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10137#discussion_r407711931", "bodyText": "The management plane does not provide us the status of creation. I have to ping the service to confirm. The newly added code is to avoid failure of creating on already exists account.", "author": "sima-zhu", "createdAt": "2020-04-13T20:48:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY5MzU4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI2ODA3Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10137#discussion_r408268076", "bodyText": "Could we check the status of the SearchService object?", "author": "alzimmermsft", "createdAt": "2020-04-14T16:22:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY5MzU4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI3ODQ4MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10137#discussion_r408278481", "bodyText": "Just checked over the API. Find the status one this time. Missing from the initial investigation.\nWill try to switch to status() checking", "author": "sima-zhu", "createdAt": "2020-04-14T16:37:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY5MzU4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODMxODMwNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10137#discussion_r408318307", "bodyText": "I have tried the API they provided. Seems not that stable as service ping. In order to make our live tests more stable. I decided to switch back to ping machenism.", "author": "sima-zhu", "createdAt": "2020-04-14T17:40:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY5MzU4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODMxODQzMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10137#discussion_r408318433", "bodyText": "https://dev.azure.com/azure-sdk/internal/_build/results?buildId=356026&view=results", "author": "sima-zhu", "createdAt": "2020-04-14T17:40:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY5MzU4MQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "58e4429cca100b73ea96688652c634365170f232", "url": "https://github.com/Azure/azure-sdk-for-java/commit/58e4429cca100b73ea96688652c634365170f232", "message": "Merge branch 'master' of https://github.com/Azure/azure-sdk-for-java into ci_build", "committedDate": "2020-04-13T21:02:08Z", "type": "commit"}, {"oid": "89a7efda6a5f3a1ea5000ccebe8925c4fa5cb01f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/89a7efda6a5f3a1ea5000ccebe8925c4fa5cb01f", "message": "More changes", "committedDate": "2020-04-13T21:10:04Z", "type": "commit"}, {"oid": "b823970e7f52b9a136e18aef8f401daf3272773c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b823970e7f52b9a136e18aef8f401daf3272773c", "message": "Reverted back as the test has passed", "committedDate": "2020-04-13T21:31:15Z", "type": "commit"}, {"oid": "b823970e7f52b9a136e18aef8f401daf3272773c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b823970e7f52b9a136e18aef8f401daf3272773c", "message": "Reverted back as the test has passed", "committedDate": "2020-04-13T21:31:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODMzMDIyMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10137#discussion_r408330223", "bodyText": "We should add some delay between each retry instead of retrying with no delay.", "author": "srnagar", "createdAt": "2020-04-14T17:59:24Z", "path": "sdk/search/azure-search-documents/src/test/java/com/azure/search/documents/test/environment/setup/AzureSearchResources.java", "diffHunk": "@@ -114,13 +115,21 @@ public void createService(TestResourceNamer testResourceNamer) {\n         System.out.println(\"Creating Azure Cognitive Search service: \" + searchServiceName);\n         int recreateCount = 0;\n         do {\n-            searchService = azure.searchServices()\n-                .define(searchServiceName)\n-                .withRegion(location)\n-                .withExistingResourceGroup(resourceGroup)\n-                .withFreeSku()\n-                .create();\n-            recreateCount += 1;\n+            try {\n+                searchService = azure.searchServices()", "originalCommit": "b823970e7f52b9a136e18aef8f401daf3272773c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODMzMTI2MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10137#discussion_r408331260", "bodyText": "There is delay of 30 seconds on every .create() operation.\nPut it in shouldRetry() helper.", "author": "sima-zhu", "createdAt": "2020-04-14T18:01:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODMzMDIyMw=="}], "type": "inlineReview", "revised_code": null}]}