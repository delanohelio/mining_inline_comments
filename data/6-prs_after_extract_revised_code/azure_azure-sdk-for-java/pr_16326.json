{"pr_number": 16326, "pr_title": "Multiple fixes", "pr_createdAt": "2020-10-15T00:00:37Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/16326", "timeline": [{"oid": "3b85e2e57be81c41791bb1a6e4a3618cf5cb1d8a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3b85e2e57be81c41791bb1a6e4a3618cf5cb1d8a", "message": "This PR fixes multiple issues\n- Singlepartition queries going to gateway instead of directMode in directMode\n- readMany not working in gateway Mode\n- QueryMetricsUtils failing to parse request charge in a non US locale", "committedDate": "2020-10-14T23:26:25Z", "type": "commit"}, {"oid": "5f8697576fe7e72c5a2f0222afc468f31db61e76", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5f8697576fe7e72c5a2f0222afc468f31db61e76", "message": "Refactor the fix", "committedDate": "2020-10-14T23:51:31Z", "type": "commit"}, {"oid": "69193dad82997ef9d3f2c7d01395968d07cc9ffb", "url": "https://github.com/Azure/azure-sdk-for-java/commit/69193dad82997ef9d3f2c7d01395968d07cc9ffb", "message": "Cleanup", "committedDate": "2020-10-14T23:57:56Z", "type": "commit"}, {"oid": "5111ce5fc01fd1a9d448f6759d4cf27915da46cd", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5111ce5fc01fd1a9d448f6759d4cf27915da46cd", "message": "Cleanup", "committedDate": "2020-10-14T23:59:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA5MjM3Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16326#discussion_r505092377", "bodyText": "NIT line break after &&", "author": "FabianMeiswinkel", "createdAt": "2020-10-15T00:16:31Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/RxDocumentClientImpl.java", "diffHunk": "@@ -3566,7 +3567,8 @@ private RxStoreModel getStoreProxy(RxDocumentServiceRequest request) {\n         } else {\n             if ((request.getOperationType() == OperationType.Query || request.getOperationType() == OperationType.SqlQuery) &&\n                     Utils.isCollectionChild(request.getResourceType())) {\n-                if (request.getPartitionKeyRangeIdentity() == null) {\n+                // Go to gateway only if there is no partition key range or partition key set. This should be very rare\n+                if (request.getPartitionKeyRangeIdentity() == null && request.getHeaders().get(HttpConstants.HttpHeaders.PARTITION_KEY) == null) {", "originalCommit": "5111ce5fc01fd1a9d448f6759d4cf27915da46cd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc0NjQwMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16326#discussion_r505746400", "bodyText": "done", "author": "mbhaskar", "createdAt": "2020-10-15T18:15:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA5MjM3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "b6f494bb66ef2ba0c3b70fc3f2e428caa3e8c963", "chunk": "diff --git a/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/RxDocumentClientImpl.java b/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/RxDocumentClientImpl.java\nindex 4d84d4c1671..f660042362e 100644\n--- a/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/RxDocumentClientImpl.java\n+++ b/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/RxDocumentClientImpl.java\n\n@@ -3567,8 +3567,9 @@ public class RxDocumentClientImpl implements AsyncDocumentClient, IAuthorization\n         } else {\n             if ((request.getOperationType() == OperationType.Query || request.getOperationType() == OperationType.SqlQuery) &&\n                     Utils.isCollectionChild(request.getResourceType())) {\n-                // Go to gateway only if there is no partition key range or partition key set. This should be very rare\n-                if (request.getPartitionKeyRangeIdentity() == null && request.getHeaders().get(HttpConstants.HttpHeaders.PARTITION_KEY) == null) {\n+                // Go to gateway only when partition key range and partition key are not set. This should be very rare\n+                if (request.getPartitionKeyRangeIdentity() == null &&\n+                        request.getHeaders().get(HttpConstants.HttpHeaders.PARTITION_KEY) == null) {\n                     return this.gatewayProxy;\n                 }\n             }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA5NDQ4Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16326#discussion_r505094483", "bodyText": "Just to double-check my understanding is correct - instead of changing the place where we were Parsing the Double you decided to normalize the locale here because for all other content where we parse floating point numbers the content is created by our backend and we own the locale/formatting, correct?", "author": "FabianMeiswinkel", "createdAt": "2020-10-15T00:24:02Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/DocumentProducer.java", "diffHunk": "@@ -65,7 +66,10 @@\n         void populatePartitionedQueryMetrics() {\n             String queryMetricsDelimitedString = pageResult.getResponseHeaders().get(HttpConstants.HttpHeaders.QUERY_METRICS);\n             if (!StringUtils.isEmpty(queryMetricsDelimitedString)) {\n-                queryMetricsDelimitedString += String.format(\";%s=%.2f\", QueryMetricsConstants.RequestCharge, pageResult.getRequestCharge());\n+                queryMetricsDelimitedString += String.format(Locale.ROOT,\n+                                                             \";%s=%.2f\",\n+                                                             QueryMetricsConstants.RequestCharge,", "originalCommit": "5111ce5fc01fd1a9d448f6759d4cf27915da46cd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTEwMTAxNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16326#discussion_r505101014", "bodyText": "Thats correct Fabian", "author": "mbhaskar", "createdAt": "2020-10-15T00:48:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA5NDQ4Mw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "b6f494bb66ef2ba0c3b70fc3f2e428caa3e8c963", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b6f494bb66ef2ba0c3b70fc3f2e428caa3e8c963", "message": "Cleanup", "committedDate": "2020-10-15T18:14:53Z", "type": "commit"}, {"oid": "a40aa071f7bbfb01388f5ebd4d268ec7fd5f2c65", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a40aa071f7bbfb01388f5ebd4d268ec7fd5f2c65", "message": "Fixing failing test. Since one of the test changes the locale, that might have caused the string format in ParallelDocumentQueryTest to use different locale and fail parsing.", "committedDate": "2020-10-15T20:55:29Z", "type": "commit"}]}