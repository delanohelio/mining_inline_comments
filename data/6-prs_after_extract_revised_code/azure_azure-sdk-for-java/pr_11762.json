{"pr_number": 11762, "pr_title": "Cosmos: CFP and Permission fixes and code refactoring", "pr_createdAt": "2020-06-04T04:07:41Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/11762", "timeline": [{"oid": "b657936e7807fa96913b2c2ac736ad97224f8e74", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b657936e7807fa96913b2c2ac736ad97224f8e74", "message": "Add checks on the lease container client context to ensure that content response on write is enabled and warn if consistency level is lesser than SESSION.", "committedDate": "2020-06-03T09:04:46Z", "type": "commit"}, {"oid": "306bd5d8c4912f9f4a02c413e89601fb29079dc1", "url": "https://github.com/Azure/azure-sdk-for-java/commit/306bd5d8c4912f9f4a02c413e89601fb29079dc1", "message": "Update Cosmos permission properties and replace setResourceLink() APIs. Added APIs require passing the container name and optionally the child resource for which the permissions will be granted.", "committedDate": "2020-06-04T04:04:08Z", "type": "commit"}, {"oid": "b147bda12301a301599e256495815f9d44f69694", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b147bda12301a301599e256495815f9d44f69694", "message": "Fix for spot-bug issue and extend create test to capture the new permission properties APIs.", "committedDate": "2020-06-04T16:23:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTM5MzY2Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11762#discussion_r435393662", "bodyText": "All of these instance variables should be private", "author": "kushagraThapar", "createdAt": "2020-06-04T16:33:35Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/CosmosPermissionProperties.java", "diffHunk": "@@ -15,26 +17,36 @@\n public final class CosmosPermissionProperties {\n \n     private Permission permission;\n-    static List<CosmosPermissionProperties> getFromV2Results(List<Permission> results) {\n-        return results.stream().map(permission -> new CosmosPermissionProperties(permission.toJson()))\n-                   .collect(Collectors.toList());\n-    }\n+    String databaseName;\n+    String resourceToken;\n+\n+    String permissionName;\n+    String containerName;\n+    String resourceName;\n+    CosmosContainerChildResourceKind resourceKind;\n+    PermissionMode permissionMode;\n+    PartitionKey resourcePartitionKey;", "originalCommit": "b147bda12301a301599e256495815f9d44f69694", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ0NjYzNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11762#discussion_r435446637", "bodyText": "Fixed", "author": "milismsft", "createdAt": "2020-06-04T18:01:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTM5MzY2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "6964c0ba7252f99334210a73863f5f40ac9eeb56", "chunk": "diff --git a/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/CosmosPermissionProperties.java b/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/CosmosPermissionProperties.java\nindex 0c7559ca1e..fb996b655d 100644\n--- a/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/CosmosPermissionProperties.java\n+++ b/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/CosmosPermissionProperties.java\n\n@@ -17,15 +18,15 @@ import java.util.stream.Collectors;\n public final class CosmosPermissionProperties {\n \n     private Permission permission;\n-    String databaseName;\n-    String resourceToken;\n+    private String databaseName;\n+    private String resourceToken;\n \n-    String permissionName;\n-    String containerName;\n-    String resourceName;\n-    CosmosContainerChildResourceKind resourceKind;\n-    PermissionMode permissionMode;\n-    PartitionKey resourcePartitionKey;\n+    private String permissionName;\n+    private String containerName;\n+    private String resourceName;\n+    private ContainerChildResourceType resourceKind;\n+    private PermissionMode permissionMode;\n+    private PartitionKey resourcePartitionKey;\n \n     /**\n      * Initialize a permission object.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQwOTkzNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11762#discussion_r435409936", "bodyText": "I thought we need to throw error in this case, as CFP will not work in consistency below SESSION, no ?", "author": "kushagraThapar", "createdAt": "2020-06-04T16:59:43Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/changefeed/implementation/ChangeFeedProcessorBuilderImpl.java", "diffHunk": "@@ -308,16 +312,26 @@ public ChangeFeedProcessorBuilderImpl withCollectionResourceId(String collection\n     /**\n      * Sets an existing {@link CosmosAsyncContainer} to be used to read from the leases collection.\n      *\n-     * @param leaseDocumentClient the instance of {@link CosmosAsyncContainer} to use.\n+     * @param leaseClient the instance of {@link CosmosAsyncContainer} to use.\n      * @return current Builder.\n      */\n     @Override\n-    public ChangeFeedProcessorBuilderImpl leaseContainer(CosmosAsyncContainer leaseDocumentClient) {\n-        if (leaseDocumentClient == null) {\n-            throw new IllegalArgumentException(\"leaseContextClient\");\n+    public ChangeFeedProcessorBuilderImpl leaseContainer(CosmosAsyncContainer leaseClient) {\n+        if (leaseClient == null) {\n+            throw new IllegalArgumentException(\"leaseClient\");\n+        }\n+\n+        if (!getContextClient(leaseClient).isContentResponseOnWriteEnabled()) {\n+            throw new IllegalArgumentException(\"leaseClient: content response on write setting must be enabled\");\n+        }\n+\n+        ConsistencyLevel consistencyLevel = getContextClient(leaseClient).getConsistencyLevel();\n+        if (consistencyLevel == ConsistencyLevel.CONSISTENT_PREFIX || consistencyLevel == ConsistencyLevel.EVENTUAL) {\n+            logger.warn(\"leaseClient consistency level setting are less then expected which is SESSION\");", "originalCommit": "b147bda12301a301599e256495815f9d44f69694", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQyMzAwNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11762#discussion_r435423005", "bodyText": "I think we should fail on these cases, logs may go unnoticed by user", "author": "moderakh", "createdAt": "2020-06-04T17:22:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQwOTkzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ2MzU4Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11762#discussion_r435463582", "bodyText": "The CFP should continue to work with lesser than SESSION consistency level; the downside of it is that lease documents might not be updated in a timely fashion by the current CFP instance in certain conditions which at worst can lead to documents being seen more than once. SESSION or better will help avoid that because once the lease document is written, the CFP instance will have it right away in most scenarios across all its workers.", "author": "milismsft", "createdAt": "2020-06-04T18:27:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQwOTkzNg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQxMzkwNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11762#discussion_r435413906", "bodyText": "We have ResourceType and CosmosResourceType.\nShould we rename this to ContainerChildResourceType ?\n@kirankumarkolli  @moderakh  thoughts ?", "author": "kushagraThapar", "createdAt": "2020-06-04T17:06:28Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/CosmosContainerChildResourceKind.java", "diffHunk": "@@ -0,0 +1,37 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos.models;\n+\n+/**\n+ * Specifies the kind of resource that has a Cosmos container as parent resource.\n+ */\n+public enum CosmosContainerChildResourceKind {", "originalCommit": "b147bda12301a301599e256495815f9d44f69694", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQyMjI1NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11762#discussion_r435422254", "bodyText": "The naming seems a bit odd to me. why can't we use the existing CosmosResourceType?", "author": "moderakh", "createdAt": "2020-06-04T17:20:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQxMzkwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ0NzgyMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11762#discussion_r435447822", "bodyText": "CosmosResourceType is \"implementation\" and it also includes more resource types than what is applicable to creating a Permission object.\nI renamed the class however to ContainerChildResourceType.", "author": "milismsft", "createdAt": "2020-06-04T18:03:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQxMzkwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTYwMDgyNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11762#discussion_r435600826", "bodyText": "@kirankumarkolli please comment on the naming.", "author": "moderakh", "createdAt": "2020-06-04T23:09:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQxMzkwNg=="}], "type": "inlineReview", "revised_code": {"commit": "6964c0ba7252f99334210a73863f5f40ac9eeb56", "chunk": "diff --git a/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/CosmosContainerChildResourceKind.java b/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/ContainerChildResourceType.java\nsimilarity index 89%\nrename from sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/CosmosContainerChildResourceKind.java\nrename to sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/ContainerChildResourceType.java\nindex 98bc338d87..bb47cbc5b4 100644\n--- a/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/CosmosContainerChildResourceKind.java\n+++ b/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/ContainerChildResourceType.java\n\n@@ -6,7 +6,7 @@ package com.azure.cosmos.models;\n /**\n  * Specifies the kind of resource that has a Cosmos container as parent resource.\n  */\n-public enum CosmosContainerChildResourceKind {\n+public enum ContainerChildResourceType {\n     /**\n      * Represents an item resource that is created in a Cosmos container.\n      */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQxNDczMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11762#discussion_r435414732", "bodyText": "Is the reason for this is because permission can only be initialized when we get response from backend?", "author": "kushagraThapar", "createdAt": "2020-06-04T17:07:53Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/CosmosPermissionProperties.java", "diffHunk": "@@ -15,26 +17,36 @@\n public final class CosmosPermissionProperties {\n \n     private Permission permission;\n-    static List<CosmosPermissionProperties> getFromV2Results(List<Permission> results) {\n-        return results.stream().map(permission -> new CosmosPermissionProperties(permission.toJson()))\n-                   .collect(Collectors.toList());\n-    }\n+    String databaseName;\n+    String resourceToken;\n+\n+    String permissionName;\n+    String containerName;\n+    String resourceName;\n+    CosmosContainerChildResourceKind resourceKind;\n+    PermissionMode permissionMode;\n+    PartitionKey resourcePartitionKey;\n \n     /**\n      * Initialize a permission object.\n      */\n     public CosmosPermissionProperties() {\n-        this.permission = new Permission();", "originalCommit": "b147bda12301a301599e256495815f9d44f69694", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ0OTU3Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11762#discussion_r435449573", "bodyText": "that is why it was removed... the permission local member can only be created via the JSON related constructor.\nEmpty constructor is still required for create ops scenario.", "author": "milismsft", "createdAt": "2020-06-04T18:06:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQxNDczMg=="}], "type": "inlineReview", "revised_code": {"commit": "6964c0ba7252f99334210a73863f5f40ac9eeb56", "chunk": "diff --git a/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/CosmosPermissionProperties.java b/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/CosmosPermissionProperties.java\nindex 0c7559ca1e..fb996b655d 100644\n--- a/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/CosmosPermissionProperties.java\n+++ b/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/CosmosPermissionProperties.java\n\n@@ -17,15 +18,15 @@ import java.util.stream.Collectors;\n public final class CosmosPermissionProperties {\n \n     private Permission permission;\n-    String databaseName;\n-    String resourceToken;\n+    private String databaseName;\n+    private String resourceToken;\n \n-    String permissionName;\n-    String containerName;\n-    String resourceName;\n-    CosmosContainerChildResourceKind resourceKind;\n-    PermissionMode permissionMode;\n-    PartitionKey resourcePartitionKey;\n+    private String permissionName;\n+    private String containerName;\n+    private String resourceName;\n+    private ContainerChildResourceType resourceKind;\n+    private PermissionMode permissionMode;\n+    private PartitionKey resourcePartitionKey;\n \n     /**\n      * Initialize a permission object.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQyNDExOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11762#discussion_r435424118", "bodyText": "please use StringUtils.split instead of String.split\nString.split uses regex and is not performant", "author": "moderakh", "createdAt": "2020-06-04T17:24:08Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/CosmosPermissionProperties.java", "diffHunk": "@@ -45,25 +57,102 @@ public CosmosPermissionProperties setId(String id) {\n      */\n     CosmosPermissionProperties(String jsonString) {\n         this.permission = new Permission(jsonString);\n+        this.permissionName = permission.getId();\n+        this.permissionMode = permission.getPermissionMode();\n+        this.resourcePartitionKey = permission.getResourcePartitionKey();\n+        this.resourceToken = permission.getToken();\n+\n+        String[] parts = Utils.trimBeginningAndEndingSlashes(permission.getResourceLink()).split(\"/\");", "originalCommit": "b147bda12301a301599e256495815f9d44f69694", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ2NDAyOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11762#discussion_r435464028", "bodyText": "Fixed", "author": "milismsft", "createdAt": "2020-06-04T18:28:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQyNDExOA=="}], "type": "inlineReview", "revised_code": {"commit": "6964c0ba7252f99334210a73863f5f40ac9eeb56", "chunk": "diff --git a/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/CosmosPermissionProperties.java b/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/CosmosPermissionProperties.java\nindex 0c7559ca1e..fb996b655d 100644\n--- a/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/CosmosPermissionProperties.java\n+++ b/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/CosmosPermissionProperties.java\n\n@@ -62,7 +63,7 @@ public final class CosmosPermissionProperties {\n         this.resourcePartitionKey = permission.getResourcePartitionKey();\n         this.resourceToken = permission.getToken();\n \n-        String[] parts = Utils.trimBeginningAndEndingSlashes(permission.getResourceLink()).split(\"/\");\n+        String[] parts = StringUtils.split(Utils.trimBeginningAndEndingSlashes(permission.getResourceLink()), \"/\");\n \n         if (parts.length < 4) {\n             throw new IllegalArgumentException(\"jsonString\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQyNjc4MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11762#discussion_r435426780", "bodyText": "this is called setContainerName but in the test .setContainerName(\"AQAAAJ0fgTc=\") uses portion of the selflink.\nSo is this the container name or just a portion of the selflink?", "author": "moderakh", "createdAt": "2020-06-04T17:28:19Z", "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/rx/PermissionCrudTest.java", "diffHunk": "@@ -44,15 +45,18 @@ public void createPermission() throws Exception {\n         CosmosPermissionProperties permissionSettings = new CosmosPermissionProperties()\n                 .setId(UUID.randomUUID().toString())\n                 .setPermissionMode(PermissionMode.READ)\n-                .setResourceLink(\"dbs/AQAAAA==/colls/AQAAAJ0fgTc=\");\n+                .setContainerName(\"AQAAAJ0fgTc=\")", "originalCommit": "b147bda12301a301599e256495815f9d44f69694", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ1MTE3Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11762#discussion_r435451176", "bodyText": "it's the container name... I will make a change to make it more obvious; initially I did not want to mess with the test used/expected values.", "author": "milismsft", "createdAt": "2020-06-04T18:09:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQyNjc4MA=="}], "type": "inlineReview", "revised_code": {"commit": "6964c0ba7252f99334210a73863f5f40ac9eeb56", "chunk": "diff --git a/sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/rx/PermissionCrudTest.java b/sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/rx/PermissionCrudTest.java\nindex d4caa81103..f0357325c9 100644\n--- a/sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/rx/PermissionCrudTest.java\n+++ b/sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/rx/PermissionCrudTest.java\n\n@@ -45,8 +45,8 @@ public class PermissionCrudTest extends TestSuiteBase {\n         CosmosPermissionProperties permissionSettings = new CosmosPermissionProperties()\n                 .setId(UUID.randomUUID().toString())\n                 .setPermissionMode(PermissionMode.READ)\n-                .setContainerName(\"AQAAAJ0fgTc=\")\n-                .setResourcePath(CosmosContainerChildResourceKind.ITEM, \"doc1\");\n+                .setContainerName(\"myContainer\")\n+                .setResourcePath(ContainerChildResourceType.ITEM, \"doc1\");\n \n         Mono<CosmosPermissionResponse> createObservable = createdUser.createPermission(permissionSettings, null);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQyNzc1NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11762#discussion_r435427754", "bodyText": "this is called containerName but in the test .setContainerName(\"AQAAAJ0fgTc=\") uses portion of the selflink.\nSo is this the container name or just a portion of the selflink?", "author": "moderakh", "createdAt": "2020-06-04T17:30:00Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/CosmosPermissionProperties.java", "diffHunk": "@@ -45,25 +57,102 @@ public CosmosPermissionProperties setId(String id) {\n      */\n     CosmosPermissionProperties(String jsonString) {\n         this.permission = new Permission(jsonString);\n+        this.permissionName = permission.getId();\n+        this.permissionMode = permission.getPermissionMode();\n+        this.resourcePartitionKey = permission.getResourcePartitionKey();\n+        this.resourceToken = permission.getToken();\n+\n+        String[] parts = Utils.trimBeginningAndEndingSlashes(permission.getResourceLink()).split(\"/\");\n+\n+        if (parts.length < 4) {\n+            throw new IllegalArgumentException(\"jsonString\");\n+        }\n+\n+        this.databaseName = parts[1];\n+        this.containerName = parts[3];\n+\n+        if (parts.length >= 6) {\n+            this.resourceName = parts[5];\n+\n+            if (Paths.DOCUMENTS_PATH_SEGMENT.equalsIgnoreCase(parts[4])) {\n+                this.resourceKind = CosmosContainerChildResourceKind.ITEM;\n+            } else if (Paths.STORED_PROCEDURES_PATH_SEGMENT.equalsIgnoreCase(parts[4])) {\n+                this.resourceKind = CosmosContainerChildResourceKind.STORED_PROCEDURE;\n+            } else if (Paths.USER_DEFINED_FUNCTIONS_PATH_SEGMENT.equalsIgnoreCase(parts[4])) {\n+                this.resourceKind = CosmosContainerChildResourceKind.USER_DEFINED_FUNCTION;\n+            } else if (Paths.TRIGGERS_PATH_SEGMENT.equalsIgnoreCase(parts[4])) {\n+                this.resourceKind = CosmosContainerChildResourceKind.TRIGGER;\n+            } else {\n+                throw new IllegalArgumentException(\"jsonString\");\n+            }\n+        }\n     }\n \n     /**\n-     * Gets the self-link of resource to which the permission applies.\n+     * Sets the name of the Cosmos container as the parent resource which is associated with this permission object.\n      *\n-     * @return the resource link.\n+     * @param containerName the name of the Cosmos container representing the parent resource.\n+     * @return the current {@link CosmosPermissionProperties} object.\n      */\n-    public String getResourceLink() {\n-        return this.permission.getResourceLink();\n+    public CosmosPermissionProperties setContainerName(String containerName) {\n+        this.containerName = containerName;\n+\n+        // Following is required by permission replace (PUT) scenario.\n+        if (this.permission != null) {\n+            this.permission.setResourceLink(this.databaseName);\n+            this.resourceToken = null;\n+        }\n+\n+        return this;\n     }\n \n     /**\n-     * Sets the self-link of resource to which the permission applies.\n+     * Gets the name of the Cosmos container as the parent resource which is associated with this permission object.\n      *\n-     * @param resourceLink the resource link.\n-     * @return the current {@link CosmosPermissionProperties} object\n+     * @return the name of the Cosmos container representing the parent resource.\n+     */\n+    public String getContainerName() {", "originalCommit": "b147bda12301a301599e256495815f9d44f69694", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6964c0ba7252f99334210a73863f5f40ac9eeb56", "chunk": "diff --git a/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/CosmosPermissionProperties.java b/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/CosmosPermissionProperties.java\nindex 0c7559ca1e..fb996b655d 100644\n--- a/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/CosmosPermissionProperties.java\n+++ b/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/CosmosPermissionProperties.java\n\n@@ -62,7 +63,7 @@ public final class CosmosPermissionProperties {\n         this.resourcePartitionKey = permission.getResourcePartitionKey();\n         this.resourceToken = permission.getToken();\n \n-        String[] parts = Utils.trimBeginningAndEndingSlashes(permission.getResourceLink()).split(\"/\");\n+        String[] parts = StringUtils.split(Utils.trimBeginningAndEndingSlashes(permission.getResourceLink()), \"/\");\n \n         if (parts.length < 4) {\n             throw new IllegalArgumentException(\"jsonString\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQyODI4Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11762#discussion_r435428283", "bodyText": "this is called withPermissionContainerName but in the test . withPermissionContainerName(\"AQAAAJ0fgTc=\") uses portion of the selflink.\nSo is this the container name or just a portion of the selflink?\nditto", "author": "moderakh", "createdAt": "2020-06-04T17:30:52Z", "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/rx/PermissionCrudTest.java", "diffHunk": "@@ -76,7 +80,7 @@ public void readPermission() throws Exception {\n         CosmosResponseValidator<CosmosPermissionResponse> validator = new CosmosResponseValidator.Builder<CosmosPermissionResponse>()\n                 .withId(permissionSettings.getId())\n                 .withPermissionMode(PermissionMode.READ)\n-                .withPermissionResourceLink(\"dbs/AQAAAA==/colls/AQAAAJ0fgTc=\")\n+                .withPermissionContainerName(\"AQAAAJ0fgTc=\")", "originalCommit": "b147bda12301a301599e256495815f9d44f69694", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6964c0ba7252f99334210a73863f5f40ac9eeb56", "chunk": "diff --git a/sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/rx/PermissionCrudTest.java b/sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/rx/PermissionCrudTest.java\nindex d4caa81103..f0357325c9 100644\n--- a/sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/rx/PermissionCrudTest.java\n+++ b/sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/rx/PermissionCrudTest.java\n\n@@ -80,7 +80,7 @@ public class PermissionCrudTest extends TestSuiteBase {\n         CosmosResponseValidator<CosmosPermissionResponse> validator = new CosmosResponseValidator.Builder<CosmosPermissionResponse>()\n                 .withId(permissionSettings.getId())\n                 .withPermissionMode(PermissionMode.READ)\n-                .withPermissionContainerName(\"AQAAAJ0fgTc=\")\n+                .withPermissionContainerName(\"myContainer\")\n                 .notNullEtag()\n                 .build();\n         validateSuccess(readObservable, validator);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQzMDE5NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11762#discussion_r435430195", "bodyText": "can the logic in Utils be used to avoid redoing similar logic here?", "author": "moderakh", "createdAt": "2020-06-04T17:33:59Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/CosmosPermissionProperties.java", "diffHunk": "@@ -93,63 +189,138 @@ public CosmosPermissionProperties setPermissionMode(PermissionMode permissionMod\n      * @return the partition key.\n      */\n     public PartitionKey getResourcePartitionKey() {\n-        return this.permission.getResourcePartitionKey();\n+        return this.resourcePartitionKey;\n     }\n \n     /**\n      * Sets the resource partition key associated with this permission object.\n      *\n      * @param partitionKey the partition key.\n-     * @return the current {@link CosmosPermissionProperties} object\n+     * @return the current {@link CosmosPermissionProperties} object.\n      */\n     public CosmosPermissionProperties setResourcePartitionKey(PartitionKey partitionKey) {\n-        this.permission.setResourcePartitionKey(partitionKey);\n+        this.resourcePartitionKey = partitionKey;\n+\n+        // Following is required by permission replace (PUT) scenario.\n+        if (this.permission != null) {\n+            this.permission.setResourcePartitionKey(partitionKey);\n+            this.resourceToken = null;\n+        }\n+\n         return this;\n     }\n \n     Resource getResource() {\n         return this.permission;\n     }\n \n+    String getResourcePath(String databaseName) {", "originalCommit": "b147bda12301a301599e256495815f9d44f69694", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ1MjMxMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11762#discussion_r435452313", "bodyText": "I could not find any... there are Utils APIs that do some of the splitting for a resource path, not applicable for this case though.", "author": "milismsft", "createdAt": "2020-06-04T18:11:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQzMDE5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTYwMjQ1Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11762#discussion_r435602452", "bodyText": "How about\nPathHelper#generatePathForNameBased()\nhttps://github.com/Azure/azure-sdk-for-java/blob/master/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/PathsHelper.java#L30\nThere are other useful methods there too. can they be used instead of duplicating the logic?", "author": "moderakh", "createdAt": "2020-06-04T23:14:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQzMDE5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTYyODg5MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11762#discussion_r435628891", "bodyText": "generatePathForNameBased(0 an be used to a certain degree but it requires multiple calls and passing it the Resource argument which is not currently available. IMHO the code will look a lot messier and hard to understand.\nFor the constant/hardcoded names we already used the predefined final strings; we do similar things in Utils for certain type of resources. I think the current implementation has the right balance and it's easy to check what the expected results should look like in case of debugging.", "author": "milismsft", "createdAt": "2020-06-05T00:32:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQzMDE5NQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "6964c0ba7252f99334210a73863f5f40ac9eeb56", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6964c0ba7252f99334210a73863f5f40ac9eeb56", "message": "Updates based on PR feedback.", "committedDate": "2020-06-04T18:13:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTYwMTE1Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11762#discussion_r435601157", "bodyText": "I think this is intended to have jsonString not \"jsonString\" ?", "author": "moderakh", "createdAt": "2020-06-04T23:10:36Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/models/CosmosPermissionProperties.java", "diffHunk": "@@ -45,25 +57,102 @@ public CosmosPermissionProperties setId(String id) {\n      */\n     CosmosPermissionProperties(String jsonString) {\n         this.permission = new Permission(jsonString);\n+        this.permissionName = permission.getId();\n+        this.permissionMode = permission.getPermissionMode();\n+        this.resourcePartitionKey = permission.getResourcePartitionKey();\n+        this.resourceToken = permission.getToken();\n+\n+        String[] parts = Utils.trimBeginningAndEndingSlashes(permission.getResourceLink()).split(\"/\");\n+\n+        if (parts.length < 4) {\n+            throw new IllegalArgumentException(\"jsonString\");\n+        }\n+\n+        this.databaseName = parts[1];\n+        this.containerName = parts[3];\n+\n+        if (parts.length >= 6) {\n+            this.resourceName = parts[5];\n+\n+            if (Paths.DOCUMENTS_PATH_SEGMENT.equalsIgnoreCase(parts[4])) {\n+                this.resourceKind = CosmosContainerChildResourceKind.ITEM;\n+            } else if (Paths.STORED_PROCEDURES_PATH_SEGMENT.equalsIgnoreCase(parts[4])) {\n+                this.resourceKind = CosmosContainerChildResourceKind.STORED_PROCEDURE;\n+            } else if (Paths.USER_DEFINED_FUNCTIONS_PATH_SEGMENT.equalsIgnoreCase(parts[4])) {\n+                this.resourceKind = CosmosContainerChildResourceKind.USER_DEFINED_FUNCTION;\n+            } else if (Paths.TRIGGERS_PATH_SEGMENT.equalsIgnoreCase(parts[4])) {\n+                this.resourceKind = CosmosContainerChildResourceKind.TRIGGER;\n+            } else {\n+                throw new IllegalArgumentException(\"jsonString\");", "originalCommit": "b147bda12301a301599e256495815f9d44f69694", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTYyOTM4OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11762#discussion_r435629388", "bodyText": "\"jsonString\" is the name of the argument, not the content...", "author": "milismsft", "createdAt": "2020-06-05T00:34:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTYwMTE1Nw=="}], "type": "inlineReview", "revised_code": null}]}